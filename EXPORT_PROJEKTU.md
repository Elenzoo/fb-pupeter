# üì¶ EXPORT PROJEKTU: FB_Watcher

**Root:** `C:\Projekty vs\FB_Watcher`  
**Wygenerowano:** `2026-01-21T20:47:54.106Z`  
**Liczba plik√≥w:** `144`  
**Max rozmiar pliku:** `2000000 B`  

## üß≠ Spis tre≈õci
- [package.json](#≈õcie≈ºka-packagejson)
- [.env](#≈õcie≈ºka-env)
- [config/links.js](#≈õcie≈ºka-config-linksjs)
- [config/links.json](#≈õcie≈ºka-config-linksjson)
- [DEBUG_EXPORT/src/config.js](#≈õcie≈ºka-debugexport-src-configjs)
- [export_chat_context/03__config.js](#≈õcie≈ºka-exportchatcontext-03configjs)
- [export_fb_watcher/config.js](#≈õcie≈ºka-exportfbwatcher-configjs)
- [src/config.js](#≈õcie≈ºka-src-configjs)
- [src/panel/web/postcss.config.js](#≈õcie≈ºka-src-panel-web-postcssconfigjs)
- [src/panel/web/tailwind.config.js](#≈õcie≈ºka-src-panel-web-tailwindconfigjs)
- [src/panel/web/tsconfig.json](#≈õcie≈ºka-src-panel-web-tsconfigjson)
- [src/panel/web/vite.config.ts](#≈õcie≈ºka-src-panel-web-viteconfigts)
- [src/db/cache.js](#≈õcie≈ºka-src-db-cachejs)
- [src/fb/checkpoint.js](#≈õcie≈ºka-src-fb-checkpointjs)
- [src/fb/comments.js](#≈õcie≈ºka-src-fb-commentsjs)
- [src/fb/cookies.js](#≈õcie≈ºka-src-fb-cookiesjs)
- [src/fb/expandButtons.js](#≈õcie≈ºka-src-fb-expandbuttonsjs)
- [src/fb/legacy/comments.legacy.js](#≈õcie≈ºka-src-fb-legacy-commentslegacyjs)
- [src/fb/login.js](#≈õcie≈ºka-src-fb-loginjs)
- [src/fb/scroll.js](#≈õcie≈ºka-src-fb-scrolljs)
- [src/fb/ui/index.js](#≈õcie≈ºka-src-fb-ui-indexjs)
- [src/fb/ui/photo.js](#≈õcie≈ºka-src-fb-ui-photojs)
- [src/fb/ui/post.js](#≈õcie≈ºka-src-fb-ui-postjs)
- [src/fb/ui/videos.js](#≈õcie≈ºka-src-fb-ui-videosjs)
- [src/fb/ui/watch.js](#≈õcie≈ºka-src-fb-ui-watchjs)
- [src/fb/uiCommentInfo.js](#≈õcie≈ºka-src-fb-uicommentinfojs)
- [src/index.js](#≈õcie≈ºka-src-indexjs)
- [src/panel/api.js](#≈õcie≈ºka-src-panel-apijs)
- [src/panel/panel-entry.cjs](#≈õcie≈ºka-src-panel-panel-entrycjs)
- [src/panel/ui/app.js](#≈õcie≈ºka-src-panel-ui-appjs)
- [src/panel/ui/index.html](#≈õcie≈ºka-src-panel-ui-indexhtml)
- [src/panel/web/index.html](#≈õcie≈ºka-src-panel-web-indexhtml)
- [src/panel/web/package.json](#≈õcie≈ºka-src-panel-web-packagejson)
- [src/panel/web/src/App.tsx](#≈õcie≈ºka-src-panel-web-src-apptsx)
- [src/panel/web/src/components/layout/DashboardLayout.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-dashboardlayouttsx)
- [src/panel/web/src/components/layout/Header.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-headertsx)
- [src/panel/web/src/components/layout/MobileNav.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-mobilenavtsx)
- [src/panel/web/src/components/layout/Sidebar.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-sidebartsx)
- [src/panel/web/src/components/ui/badge.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-badgetsx)
- [src/panel/web/src/components/ui/button.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-buttontsx)
- [src/panel/web/src/components/ui/card.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-cardtsx)
- [src/panel/web/src/components/ui/checkbox.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-checkboxtsx)
- [src/panel/web/src/components/ui/dialog.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-dialogtsx)
- [src/panel/web/src/components/ui/input.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-inputtsx)
- [src/panel/web/src/components/ui/label.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-labeltsx)
- [src/panel/web/src/components/ui/separator.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-separatortsx)
- [src/panel/web/src/components/ui/switch.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-switchtsx)
- [src/panel/web/src/components/ui/table.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabletsx)
- [src/panel/web/src/components/ui/tabs.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabstsx)
- [src/panel/web/src/components/ui/textarea.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-textareatsx)
- [src/panel/web/src/hooks/useApi.ts](#≈õcie≈ºka-src-panel-web-src-hooks-useapits)
- [src/panel/web/src/hooks/useAuth.tsx](#≈õcie≈ºka-src-panel-web-src-hooks-useauthtsx)
- [src/panel/web/src/hooks/useLogs.ts](#≈õcie≈ºka-src-panel-web-src-hooks-uselogsts)
- [src/panel/web/src/index.css](#≈õcie≈ºka-src-panel-web-src-indexcss)
- [src/panel/web/src/lib/api.ts](#≈õcie≈ºka-src-panel-web-src-lib-apits)
- [src/panel/web/src/lib/types.ts](#≈õcie≈ºka-src-panel-web-src-lib-typests)
- [src/panel/web/src/lib/utils.ts](#≈õcie≈ºka-src-panel-web-src-lib-utilsts)
- [src/panel/web/src/main.tsx](#≈õcie≈ºka-src-panel-web-src-maintsx)
- [src/panel/web/src/pages/Campaigns.tsx](#≈õcie≈ºka-src-panel-web-src-pages-campaignstsx)
- [src/panel/web/src/pages/Cookies.tsx](#≈õcie≈ºka-src-panel-web-src-pages-cookiestsx)
- [src/panel/web/src/pages/Dashboard.tsx](#≈õcie≈ºka-src-panel-web-src-pages-dashboardtsx)
- [src/panel/web/src/pages/Discoveries.tsx](#≈õcie≈ºka-src-panel-web-src-pages-discoveriestsx)
- [src/panel/web/src/pages/Logs.tsx](#≈õcie≈ºka-src-panel-web-src-pages-logstsx)
- [src/panel/web/src/pages/Settings.tsx](#≈õcie≈ºka-src-panel-web-src-pages-settingstsx)
- [src/panel/web/src/pages/Sources.tsx](#≈õcie≈ºka-src-panel-web-src-pages-sourcestsx)
- [src/panel/web/src/pages/Watched.tsx](#≈õcie≈ºka-src-panel-web-src-pages-watchedtsx)
- [src/panel/web/src/vite-env.d.ts](#≈õcie≈ºka-src-panel-web-src-vite-envdts)
- [src/telegram.js](#≈õcie≈ºka-src-telegramjs)
- [src/utils/logger.js](#≈õcie≈ºka-src-utils-loggerjs)
- [src/utils/mouse.js](#≈õcie≈ºka-src-utils-mousejs)
- [src/utils/navigation.js](#≈õcie≈ºka-src-utils-navigationjs)
- [src/utils/sleep.js](#≈õcie≈ºka-src-utils-sleepjs)
- [src/utils/time.js](#≈õcie≈ºka-src-utils-timejs)
- [src/watcher.js](#≈õcie≈ºka-src-watcherjs)
- [DEBUG_EXPORT/src/panel/api.js](#≈õcie≈ºka-debugexport-src-panel-apijs)
- [DEBUG_EXPORT/src/panel/panel-entry.cjs](#≈õcie≈ºka-debugexport-src-panel-panel-entrycjs)
- [DEBUG_EXPORT/src/panel/ui/app.js](#≈õcie≈ºka-debugexport-src-panel-ui-appjs)
- [DEBUG_EXPORT/src/panel/ui/index.html](#≈õcie≈ºka-debugexport-src-panel-ui-indexhtml)
- [export_fb_watcher/panel-entry.cjs](#≈õcie≈ºka-exportfbwatcher-panel-entrycjs)
- [CLAUDE.md](#≈õcie≈ºka-claudemd)
- [cookies.json](#≈õcie≈ºka-cookiesjson)
- [data/backup_cookies/cookies_1.json](#≈õcie≈ºka-data-backupcookies-cookies1json)
- [data/backup_cookies/cookies_2.json](#≈õcie≈ºka-data-backupcookies-cookies2json)
- [data/backup_cookies/cookies_3.json](#≈õcie≈ºka-data-backupcookies-cookies3json)
- [data/backup_cookies/cookies_4.json](#≈õcie≈ºka-data-backupcookies-cookies4json)
- [data/comments-cache.json](#≈õcie≈ºka-data-comments-cachejson)
- [data/posts.json](#≈õcie≈ºka-data-postsjson)
- [DEBUG_EXPORT/.env](#≈õcie≈ºka-debugexport-env)
- [DEBUG_EXPORT/package.json](#≈õcie≈ºka-debugexport-packagejson)
- [DEBUG_EXPORT/src/index.js](#≈õcie≈ºka-debugexport-src-indexjs)
- [DEBUG_EXPORT/src/watcher.js](#≈õcie≈ºka-debugexport-src-watcherjs)
- [DEBUG_EXPORT/src/webhook.js](#≈õcie≈ºka-debugexport-src-webhookjs)
- [debug-login.mjs](#≈õcie≈ºka-debug-loginmjs)
- [export_chat_context/01__index.js](#≈õcie≈ºka-exportchatcontext-01indexjs)
- [export_chat_context/02__watcher.js](#≈õcie≈ºka-exportchatcontext-02watcherjs)
- [export_chat_context/04__telegram.js](#≈õcie≈ºka-exportchatcontext-04telegramjs)
- [export_chat_context/05__webhook.js](#≈õcie≈ºka-exportchatcontext-05webhookjs)
- [export_chat_context/06__comments.js](#≈õcie≈ºka-exportchatcontext-06commentsjs)
- [export_chat_context/07__scroll.js](#≈õcie≈ºka-exportchatcontext-07scrolljs)
- [export_chat_context/08__login.js](#≈õcie≈ºka-exportchatcontext-08loginjs)
- [export_chat_context/09__cookies.js](#≈õcie≈ºka-exportchatcontext-09cookiesjs)
- [export_chat_context/10__expandButtons.js](#≈õcie≈ºka-exportchatcontext-10expandbuttonsjs)
- [export_chat_context/11__index.js](#≈õcie≈ºka-exportchatcontext-11indexjs)
- [export_chat_context/12__post.js](#≈õcie≈ºka-exportchatcontext-12postjs)
- [export_chat_context/13__photo.js](#≈õcie≈ºka-exportchatcontext-13photojs)
- [export_chat_context/14__watch.js](#≈õcie≈ºka-exportchatcontext-14watchjs)
- [export_chat_context/15__videos.js](#≈õcie≈ºka-exportchatcontext-15videosjs)
- [export_chat_context/16__navigation.js](#≈õcie≈ºka-exportchatcontext-16navigationjs)
- [export_chat_context/17__sleep.js](#≈õcie≈ºka-exportchatcontext-17sleepjs)
- [export_chat_context/18__api.js](#≈õcie≈ºka-exportchatcontext-18apijs)
- [export_chat_context/19__index.html](#≈õcie≈ºka-exportchatcontext-19indexhtml)
- [export_chat_context/20__app.js](#≈õcie≈ºka-exportchatcontext-20appjs)
- [export_fb_watcher/.env](#≈õcie≈ºka-exportfbwatcher-env)
- [export_fb_watcher/api.js](#≈õcie≈ºka-exportfbwatcher-apijs)
- [export_fb_watcher/app.js](#≈õcie≈ºka-exportfbwatcher-appjs)
- [export_fb_watcher/cache.js](#≈õcie≈ºka-exportfbwatcher-cachejs)
- [export_fb_watcher/comments-cache.json](#≈õcie≈ºka-exportfbwatcher-comments-cachejson)
- [export_fb_watcher/comments.js](#≈õcie≈ºka-exportfbwatcher-commentsjs)
- [export_fb_watcher/comments.legacy.js](#≈õcie≈ºka-exportfbwatcher-commentslegacyjs)
- [export_fb_watcher/cookies.js](#≈õcie≈ºka-exportfbwatcher-cookiesjs)
- [export_fb_watcher/cookies.json](#≈õcie≈ºka-exportfbwatcher-cookiesjson)
- [export_fb_watcher/expandButtons.js](#≈õcie≈ºka-exportfbwatcher-expandbuttonsjs)
- [export_fb_watcher/export_files.js](#≈õcie≈ºka-exportfbwatcher-exportfilesjs)
- [export_fb_watcher/index.html](#≈õcie≈ºka-exportfbwatcher-indexhtml)
- [export_fb_watcher/index.js](#≈õcie≈ºka-exportfbwatcher-indexjs)
- [export_fb_watcher/links.js](#≈õcie≈ºka-exportfbwatcher-linksjs)
- [export_fb_watcher/links.json](#≈õcie≈ºka-exportfbwatcher-linksjson)
- [export_fb_watcher/login.js](#≈õcie≈ºka-exportfbwatcher-loginjs)
- [export_fb_watcher/navigation.js](#≈õcie≈ºka-exportfbwatcher-navigationjs)
- [export_fb_watcher/package.json](#≈õcie≈ºka-exportfbwatcher-packagejson)
- [export_fb_watcher/photo.js](#≈õcie≈ºka-exportfbwatcher-photojs)
- [export_fb_watcher/post.js](#≈õcie≈ºka-exportfbwatcher-postjs)
- [export_fb_watcher/scroll.js](#≈õcie≈ºka-exportfbwatcher-scrolljs)
- [export_fb_watcher/sleep.js](#≈õcie≈ºka-exportfbwatcher-sleepjs)
- [export_fb_watcher/uicommentinfo.js](#≈õcie≈ºka-exportfbwatcher-uicommentinfojs)
- [export_fb_watcher/videos.js](#≈õcie≈ºka-exportfbwatcher-videosjs)
- [export_fb_watcher/watch.js](#≈õcie≈ºka-exportfbwatcher-watchjs)
- [export_fb_watcher/watcher.js](#≈õcie≈ºka-exportfbwatcher-watcherjs)
- [export_fb_watcher/webhook.js](#≈õcie≈ºka-exportfbwatcher-webhookjs)
- [export_files.js](#≈õcie≈ºka-exportfilesjs)
- [Rozwoj.md](#≈õcie≈ºka-rozwojmd)
- [scripts/generate-cookies.js](#≈õcie≈ºka-scripts-generate-cookiesjs)
- [test-telegram.mjs](#≈õcie≈ºka-test-telegrammjs)
- [tools/export-project-to-md.js](#≈õcie≈ºka-tools-export-project-to-mdjs)

---

### üìÑ ≈öcie≈ºka: `package.json`
**Typ:** JSON  
**Opis:** Metadane projektu i zale≈ºno≈õci (npm).  

```json
 1 | {
 2 |   "name": "fb_puppeteer",
 3 |   "version": "1.0.0",
 4 |   "description": "Watcher komentarzy FB + webhook do Make",
 5 |   "main": "src/index.js",
 6 |   "type": "module",
 7 |   "scripts": {
 8 |     "start": "node src/index.js",
 9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs",
11 |     "panel:web:install": "cd src/panel/web && npm install",
12 |     "panel:web:dev": "cd src/panel/web && npm run dev",
13 |     "panel:web:build": "cd src/panel/web && npm run build"
14 |   },
15 |   "keywords": [],
16 |   "author": "",
17 |   "license": "ISC",
18 |   "dependencies": {
19 |     "axios": "^1.13.2",
20 |     "dotenv": "^17.2.3",
21 |     "puppeteer": "^24.31.0",
22 |     "puppeteer-extra": "^3.3.6",
23 |     "puppeteer-extra-plugin-recaptcha": "^3.6.8",
24 |     "puppeteer-extra-plugin-stealth": "^2.11.2"
25 |   },
26 |   "devDependencies": {
27 |     "@yao-pkg/pkg": "^6.11.0",
28 |     "esbuild": "^0.27.2",
29 |     "nexe": "^5.0.0-beta.4",
30 |     "pkg": "^5.8.1"
31 |   },
32 |   "pkg": {
33 |     "assets": [
34 |       "src/panel/api.js",
35 |       "src/panel/**/*.js",
36 |       ".env",
37 |       "data/**/*"
38 |     ]
39 |   }
40 | }
41 | 
```

---

### üìÑ ≈öcie≈ºka: `.env`
**Typ:** ENV  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```dotenv
 1 | # === FB WATCHER ===
 2 | FB_EMAIL=fbwatcher1@gmail.com
 3 | FB_PASSWORD=FbWatcher123!
 4 | 
 5 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
 6 | CHECK_INTERVAL_MS=60000
 7 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
 8 | 
 9 | # cookies
10 | COOKIES_READ_ONLY=false
11 | 
12 | # puppeteer
13 | HEADLESS_BROWSER=true
14 | USE_UI_HANDLERS=true
15 | INCLUDE_REPLIES=false
16 | 
17 | # runtime
18 | NODE_ENV=production
19 | TZ=Europe/Warsaw
20 | 
21 | # logi: silent | production | dev | debug
22 | LOG_LEVEL=production
23 | 
24 | # ≈õcie≈ºki serwerowe (produkcja Linux)
25 | # PROJECT_DIR=/opt/fb-watcher
26 | # POSTS_FILE=/opt/fb-watcher/data/posts.json
27 | 
28 | # lokalne testy (Windows)
29 | PROJECT_DIR=C:/Projekty vs/FB_Watcher
30 | 
31 | # === POSTS Z REMOTE API (lokalny watcher ‚Üê panel na serwerze) ===
32 | # Ustaw adres IP/domenƒô serwera gdzie dzia≈Ça panel
33 | POSTS_API_URL=http://162.55.188.103:3180/api/posts
34 | POSTS_API_TOKEN=fbw_3c9e8a2d7f4b1a6c9d5e0f8a2b7c4e9d1f6a0b5c8e2d9a4f7
35 | 
36 | # === PANEL ===
37 | PANEL_TOKEN=TEST_TOKEN_123
38 | PANEL_PORT=3180
39 | PANEL_BIND=0.0.0.0
40 | 
41 | # === PM2 ===
42 | PM2_APP=fbwatcher
43 | PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log
44 | PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log
45 | 
46 | # === TELEGRAM (2 boty) ===
47 | 
48 | # Tw√≥j bot + Tw√≥j prywatny chat
49 | TELEGRAM_BOT_TOKEN_OWNER=8561327207:AAHgjWbwCNtPGJSa5pwVcP2mMJm9T_bh6HM
50 | TELEGRAM_CHAT_ID_OWNER=6774389439
51 | 
52 | # Bot klienta + prywatny chat klienta
53 | TELEGRAM_BOT_TOKEN_CLIENT=8504080014:AAHoxXLDe90hIP4efHouoKX4pb7kXSwDgS8
54 | TELEGRAM_CHAT_ID_CLIENT=7081837522
55 | 
56 | # prze≈ÇƒÖczniki
57 | TELEGRAM_SEND_TO_OWNER=1
58 | TELEGRAM_SEND_TO_CLIENT=0
59 | 
60 | # formatowanie
61 | TELEGRAM_USE_PHOTO=1
62 | TELEGRAM_DISABLE_WEB_PAGE_PREVIEW=1
63 | 
64 | # alerty z log√≥w
65 | TG_ALERTS_ENABLED=1
66 | TG_ALERTS_COOLDOWN_SEC=120
67 | TG_ALERTS_MAXLEN=3500
68 | 
69 | 
70 | FAST_MODE=true
71 | 
72 | # === 2CAPTCHA ===
73 | CAPTCHA_API_KEY=bc82e530a13e72887acbbdfd9cc0fdee
```

---

### üìÑ ≈öcie≈ºka: `config/links.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/config/links.js
  2 | import fs from "fs";
  3 | import path from "path";
  4 | 
  5 | // Je≈õli masz Node <18, odkomentuj te dwie linijki:
  6 | // import fetch from "node-fetch";
  7 | // global.fetch = fetch;
  8 | 
  9 | const LINKS_SHEET_URL = process.env.LINKS_SHEET_URL;
 10 | const LOCAL_FILE = path.join(process.cwd(), "config", "links.json");
 11 | 
 12 | let linksCache = [];
 13 | let lastHash = null;
 14 | 
 15 | /* ============================================
 16 |    Prost y "hash" listy link√≥w
 17 |    ============================================ */
 18 | function calcHash(urls) {
 19 |   return urls.join("|");
 20 | }
 21 | 
 22 | /* ============================================
 23 |    Wczytanie lokalnego pliku JSON
 24 |    ============================================ */
 25 | function loadLinksFromLocalFile() {
 26 |   try {
 27 |     const raw = fs.readFileSync(LOCAL_FILE, "utf8");
 28 |     const data = JSON.parse(raw);
 29 | 
 30 |     if (Array.isArray(data.links)) {
 31 |       const cleaned = data.links
 32 |         .filter((u) => typeof u === "string")
 33 |         .map((u) => u.trim())
 34 |         .filter((u) => u.startsWith("http"));
 35 | 
 36 |       console.log("[CFG] Za≈Çadowane linki z lokalnego pliku:", cleaned);
 37 |       return cleaned;
 38 |     }
 39 | 
 40 |     console.warn("[CFG] Lokalny links.json nie zawiera poprawnego pola 'links'");
 41 |     return [];
 42 |   } catch (err) {
 43 |     console.warn("[CFG] Brak / b≈ÇƒÖd wczytywania links.json:", err.message);
 44 |     return [];
 45 |   }
 46 | }
 47 | 
 48 | /* ============================================
 49 |    Parser CSV z Sheetsa
 50 |    ============================================ */
 51 | function parseCsv(text) {
 52 |   const hasSemicolon = text.includes(";");
 53 |   const delimiter = hasSemicolon ? ";" : ",";
 54 | 
 55 |   const lines = text
 56 |     .split(/\r?\n/)
 57 |     .map((l) => l.trim())
 58 |     .filter(Boolean);
 59 | 
 60 |   if (!lines.length) {
 61 |     return [];
 62 |   }
 63 | 
 64 |   const header = lines[0].split(delimiter).map((h) => h.trim().toLowerCase());
 65 | 
 66 |   const idxActive = header.indexOf("active");
 67 |   const idxUrl = header.indexOf("url");
 68 | 
 69 |   if (idxUrl === -1) {
 70 |     console.warn("[CFG] W CSV nie znaleziono kolumny 'url'");
 71 |     return [];
 72 |   }
 73 | 
 74 |   const rows = [];
 75 | 
 76 |   for (let i = 1; i < lines.length; i++) {
 77 |     const cols = lines[i].split(delimiter).map((c) => c.trim());
 78 | 
 79 |     const url = cols[idxUrl] || "";
 80 |     if (!url || !url.startsWith("http")) continue;
 81 | 
 82 |     let active = true;
 83 | 
 84 |     if (idxActive !== -1) {
 85 |       const val = (cols[idxActive] || "").toLowerCase();
 86 |       active = val === "true" || val === "1" || val === "yes" || val === "y";
 87 |     }
 88 | 
 89 |     if (!active) continue;
 90 | 
 91 |     rows.push(url);
 92 |   }
 93 | 
 94 |   return rows;
 95 | }
 96 | 
 97 | /* ============================================
 98 |    Pobranie link√≥w z Sheeta lub lokalnie
 99 |    ============================================ */
100 | async function fetchLinks() {
101 |   if (!LINKS_SHEET_URL) {
102 |     console.warn("[CFG] Brak LINKS_SHEET_URL w .env ‚Äì u≈ºywam lokalnego pliku");
103 |     return loadLinksFromLocalFile();
104 |   }
105 | 
106 |   try {
107 |     console.log("[CFG] Pobieram linki z Google Sheeta...");
108 |     const res = await fetch(LINKS_SHEET_URL);
109 | 
110 |     if (!res.ok) {
111 |       console.warn("[CFG] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
112 |       return loadLinksFromLocalFile();
113 |     }
114 | 
115 |     const text = await res.text();
116 |     const urls = parseCsv(text);
117 |     const unique = [...new Set(urls)];
118 | 
119 |     // backup
120 |     const payload = { links: unique };
121 |     fs.mkdirSync(path.dirname(LOCAL_FILE), { recursive: true });
122 |     fs.writeFileSync(LOCAL_FILE, JSON.stringify(payload, null, 2), "utf8");
123 |     console.log("[CFG] Zapisano backup do links.json");
124 | 
125 |     return unique;
126 |   } catch (err) {
127 |     console.error("[CFG] B≈ÇƒÖd przy pobieraniu link√≥w z Sheeta:", err.message);
128 |     console.warn("[CFG] Pr√≥ba u≈ºycia lokalnego links.json jako fallback");
129 |     return loadLinksFromLocalFile();
130 |   }
131 | }
132 | 
133 | /* ============================================
134 |    Reload z por√≥wnaniem hashy
135 |    ============================================ */
136 | async function reloadLinks() {
137 |   const urls = await fetchLinks();
138 |   const hash = calcHash(urls);
139 | 
140 |   if (hash === lastHash) {
141 |     console.log("[CFG] Linki bez zmian (hash taki sam)");
142 |     return;
143 |   }
144 | 
145 |   lastHash = hash;
146 |   linksCache = urls;
147 | 
148 |   console.log("[CFG] Zaktualizowane linki:", linksCache);
149 | }
150 | 
151 | /* ============================================
152 |    API eksportowane dla reszty programu
153 |    ============================================ */
154 | export async function initLinks(autoRefreshMs = 0) {
155 |   await reloadLinks(); // pierwszy load
156 | 
157 |   if (autoRefreshMs > 0) {
158 |     console.log(
159 |       `[CFG] Auto-refresh link√≥w co ${Math.round(autoRefreshMs / 1000)}s`
160 |     );
161 | 
162 |     setInterval(() => {
163 |       reloadLinks().catch((err) =>
164 |         console.error("[CFG] B≈ÇƒÖd przy auto-refresh link√≥w:", err.message)
165 |       );
166 |     }, autoRefreshMs);
167 |   }
168 | }
169 | 
170 | export function getLinks() {
171 |   return linksCache;
172 | }
173 | 
```

---

### üìÑ ≈öcie≈ºka: `config/links.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
1 | {
2 |   "links": [
3 |     "https://www.facebook.com/post1",
4 |     "https://www.facebook.com/post2"
5 |   ]
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 10 | /**
 11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 12 |  * Np.:
 13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 15 |  */
 16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 17 | 
 18 | /**
 19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 20 |  * Np. domy≈õlnie co 5 minut.
 21 |  */
 22 | const POSTS_REFRESH_MS = Number(
 23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 24 | );
 25 | 
 26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 27 | /**
 28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 32 |  */
 33 | 
 34 | function getPostsFromEnv() {
 35 |   const raw = process.env.FB_POST_URLS || "";
 36 |   const urls = raw
 37 |     .split(",")
 38 |     .map((s) => s.trim())
 39 |     .filter(Boolean);
 40 | 
 41 |   return urls.map((url, index) => ({
 42 |     id: `post${index + 1}`,
 43 |     url,
 44 |   }));
 45 | }
 46 | 
 47 | function getPostLabelsFromEnv(posts) {
 48 |   const raw = process.env.FB_POST_LABELS || "";
 49 |   const labels = raw.split(",").map((s) => s.trim());
 50 | 
 51 |   const map = {};
 52 |   posts.forEach((post, idx) => {
 53 |     map[post.id] = labels[idx] || post.id;
 54 |   });
 55 |   return map;
 56 | }
 57 | 
 58 | const POSTS = getPostsFromEnv();
 59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 60 | 
 61 | /**
 62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 64 |  * dop√≥ki nie dodasz post√≥w w panelu.
 65 |  */
 66 | if (!POSTS.length && !POSTS_SHEET_URL) {
 67 |   console.warn(
 68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 69 |   );
 70 | }
 71 | 
 72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 73 | 
 74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 75 | const EXPAND_COMMENTS =
 76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 77 | 
 78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 80 | const USE_UI_HANDLERS =
 81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 82 | 
 83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 85 | const INCLUDE_REPLIES =
 86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
 87 | 
 88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
 89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
 90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
 91 | 
 92 | export {
 93 |   // stary system ‚Äì optional
 94 |   POSTS,
 95 |   POST_LABELS,
 96 | 
 97 |   // u≈ºywane przez watcher.js / comments.js
 98 |   EXPAND_COMMENTS,
 99 |   USE_UI_HANDLERS,
100 |   INCLUDE_REPLIES,
101 |   CHECK_INTERVAL_MS,
102 | 
103 |   // ≈∫r√≥d≈Ça post√≥w
104 |   POSTS_JSON_PATH,
105 |   POSTS_SHEET_URL,
106 |   POSTS_REFRESH_MS,
107 | };
108 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/03__config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 10 | /**
 11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 12 |  * Np.:
 13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 15 |  */
 16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 17 | 
 18 | /**
 19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 20 |  * Np. domy≈õlnie co 5 minut.
 21 |  */
 22 | const POSTS_REFRESH_MS = Number(
 23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 24 | );
 25 | 
 26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 27 | /**
 28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 32 |  */
 33 | 
 34 | function getPostsFromEnv() {
 35 |   const raw = process.env.FB_POST_URLS || "";
 36 |   const urls = raw
 37 |     .split(",")
 38 |     .map((s) => s.trim())
 39 |     .filter(Boolean);
 40 | 
 41 |   return urls.map((url, index) => ({
 42 |     id: `post${index + 1}`,
 43 |     url,
 44 |   }));
 45 | }
 46 | 
 47 | function getPostLabelsFromEnv(posts) {
 48 |   const raw = process.env.FB_POST_LABELS || "";
 49 |   const labels = raw.split(",").map((s) => s.trim());
 50 | 
 51 |   const map = {};
 52 |   posts.forEach((post, idx) => {
 53 |     map[post.id] = labels[idx] || post.id;
 54 |   });
 55 |   return map;
 56 | }
 57 | 
 58 | const POSTS = getPostsFromEnv();
 59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 60 | 
 61 | /**
 62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 64 |  * dop√≥ki nie dodasz post√≥w w panelu.
 65 |  */
 66 | if (!POSTS.length && !POSTS_SHEET_URL) {
 67 |   console.warn(
 68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 69 |   );
 70 | }
 71 | 
 72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 73 | 
 74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 75 | const EXPAND_COMMENTS =
 76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 77 | 
 78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 80 | const USE_UI_HANDLERS =
 81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 82 | 
 83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 85 | const INCLUDE_REPLIES =
 86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
 87 | 
 88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
 89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
 90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
 91 | 
 92 | export {
 93 |   // stary system ‚Äì optional
 94 |   POSTS,
 95 |   POST_LABELS,
 96 | 
 97 |   // u≈ºywane przez watcher.js / comments.js
 98 |   EXPAND_COMMENTS,
 99 |   USE_UI_HANDLERS,
100 |   INCLUDE_REPLIES,
101 |   CHECK_INTERVAL_MS,
102 | 
103 |   // ≈∫r√≥d≈Ça post√≥w
104 |   POSTS_JSON_PATH,
105 |   POSTS_SHEET_URL,
106 |   POSTS_REFRESH_MS,
107 | };
108 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 10 | /**
 11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 12 |  * Np.:
 13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 15 |  */
 16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 17 | 
 18 | /**
 19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 20 |  * Np. domy≈õlnie co 5 minut.
 21 |  */
 22 | const POSTS_REFRESH_MS = Number(
 23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 24 | );
 25 | 
 26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 27 | /**
 28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 32 |  */
 33 | 
 34 | function getPostsFromEnv() {
 35 |   const raw = process.env.FB_POST_URLS || "";
 36 |   const urls = raw
 37 |     .split(",")
 38 |     .map((s) => s.trim())
 39 |     .filter(Boolean);
 40 | 
 41 |   return urls.map((url, index) => ({
 42 |     id: `post${index + 1}`,
 43 |     url,
 44 |   }));
 45 | }
 46 | 
 47 | function getPostLabelsFromEnv(posts) {
 48 |   const raw = process.env.FB_POST_LABELS || "";
 49 |   const labels = raw.split(",").map((s) => s.trim());
 50 | 
 51 |   const map = {};
 52 |   posts.forEach((post, idx) => {
 53 |     map[post.id] = labels[idx] || post.id;
 54 |   });
 55 |   return map;
 56 | }
 57 | 
 58 | const POSTS = getPostsFromEnv();
 59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 60 | 
 61 | /**
 62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 64 |  * dop√≥ki nie dodasz post√≥w w panelu.
 65 |  */
 66 | if (!POSTS.length && !POSTS_SHEET_URL) {
 67 |   console.warn(
 68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 69 |   );
 70 | }
 71 | 
 72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 73 | 
 74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 75 | const EXPAND_COMMENTS =
 76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 77 | 
 78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 80 | const USE_UI_HANDLERS =
 81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 82 | 
 83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 85 | const INCLUDE_REPLIES =
 86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
 87 | 
 88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
 89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
 90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
 91 | 
 92 | export {
 93 |   // stary system ‚Äì optional
 94 |   POSTS,
 95 |   POST_LABELS,
 96 | 
 97 |   // u≈ºywane przez watcher.js / comments.js
 98 |   EXPAND_COMMENTS,
 99 |   USE_UI_HANDLERS,
100 |   INCLUDE_REPLIES,
101 |   CHECK_INTERVAL_MS,
102 | 
103 |   // ≈∫r√≥d≈Ça post√≥w
104 |   POSTS_JSON_PATH,
105 |   POSTS_SHEET_URL,
106 |   POSTS_REFRESH_MS,
107 | };
108 | 
```

---

### üìÑ ≈öcie≈ºka: `src/config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== PANEL API ‚Äì ZDALNE POSTY ==================== */
 10 | /**
 11 |  * POSTS_API_URL ‚Äì URL do API panelu (endpoint GET /api/posts)
 12 |  * Np.: POSTS_API_URL=http://twoj-serwer:3180/api/posts
 13 |  * Je≈õli ustawione, watcher pobiera posty z panelu przez HTTP (priorytet nad plikiem i Sheets)
 14 |  */
 15 | const POSTS_API_URL = (process.env.POSTS_API_URL || "").trim();
 16 | 
 17 | /**
 18 |  * POSTS_API_TOKEN ‚Äì Bearer token do autoryzacji API panelu
 19 |  * Musi byƒá taki sam jak PANEL_TOKEN na serwerze
 20 |  */
 21 | const POSTS_API_TOKEN = (process.env.POSTS_API_TOKEN || "").trim();
 22 | 
 23 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 24 | /**
 25 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 26 |  * Np.:
 27 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 28 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 29 |  */
 30 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 31 | 
 32 | /**
 33 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 34 |  * Np. domy≈õlnie co 5 minut.
 35 |  */
 36 | const POSTS_REFRESH_MS = Number(
 37 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 38 | );
 39 | 
 40 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 41 | /**
 42 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 43 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 44 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 45 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 46 |  */
 47 | 
 48 | function getPostsFromEnv() {
 49 |   const raw = process.env.FB_POST_URLS || "";
 50 |   const urls = raw
 51 |     .split(",")
 52 |     .map((s) => s.trim())
 53 |     .filter(Boolean);
 54 | 
 55 |   return urls.map((url, index) => ({
 56 |     id: `post${index + 1}`,
 57 |     url,
 58 |   }));
 59 | }
 60 | 
 61 | function getPostLabelsFromEnv(posts) {
 62 |   const raw = process.env.FB_POST_LABELS || "";
 63 |   const labels = raw.split(",").map((s) => s.trim());
 64 | 
 65 |   const map = {};
 66 |   posts.forEach((post, idx) => {
 67 |     map[post.id] = labels[idx] || post.id;
 68 |   });
 69 |   return map;
 70 | }
 71 | 
 72 | const POSTS = getPostsFromEnv();
 73 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 74 | 
 75 | /**
 76 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 77 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 78 |  * dop√≥ki nie dodasz post√≥w w panelu.
 79 |  */
 80 | if (!POSTS.length && !POSTS_SHEET_URL) {
 81 |   console.warn(
 82 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 83 |   );
 84 | }
 85 | 
 86 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 87 | 
 88 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 89 | const EXPAND_COMMENTS =
 90 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 91 | 
 92 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 93 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 94 | const USE_UI_HANDLERS =
 95 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 96 | 
 97 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 98 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 99 | const INCLUDE_REPLIES =
100 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
101 | 
102 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
103 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
104 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
105 | 
106 | // FAST_MODE: szybki tryb - sortowanie "Najnowsze", bez loadAllComments
107 | // FAST_MODE=true w≈ÇƒÖcza, domy≈õlnie false (stabilny tryb dedup)
108 | const FAST_MODE = process.env.FAST_MODE === "true";
109 | 
110 | // FAST_MAX_AGE_MIN: limit wieku komentarzy w FAST_MODE (minuty)
111 | // Komentarze starsze ni≈º limit ‚Üí skip posta (je≈õli sort=Najnowsze)
112 | const FAST_MAX_AGE_MIN = Number(process.env.FAST_MAX_AGE_MIN || 180);
113 | 
114 | /* ==================== LOGOWANIE ==================== */
115 | /**
116 |  * LOG_LEVEL ‚Äì poziom szczeg√≥≈Çowo≈õci log√≥w:
117 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
118 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny, do pracy na serwerze)
119 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings (do pracy przy kodzie)
120 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info (hard debug)
121 |  *
122 |  * LOG_TIMESTAMPS ‚Äì czy dodawaƒá [HH:MM:SS] prefix (domy≈õlnie true)
123 |  * LOG_COLORS ‚Äì czy kolorowaƒá logi w konsoli (domy≈õlnie true)
124 |  */
125 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
126 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
127 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
128 | 
129 | /* ==================== CAPTCHA SOLVER ==================== */
130 | /**
131 |  * CAPTCHA_API_KEY ‚Äì klucz API do 2Captcha
132 |  * U≈ºywany do automatycznego rozwiƒÖzywania captcha przy logowaniu
133 |  */
134 | const CAPTCHA_API_KEY = (process.env.CAPTCHA_API_KEY || "").trim();
135 | 
136 | /**
137 |  * CAPTCHA_ENABLED ‚Äì czy w≈ÇƒÖczyƒá automatyczne rozwiƒÖzywanie captcha
138 |  * Domy≈õlnie: true je≈õli CAPTCHA_API_KEY jest ustawiony
139 |  */
140 | const CAPTCHA_ENABLED = process.env.CAPTCHA_ENABLED !== "false" && !!CAPTCHA_API_KEY;
141 | 
142 | /* ==================== REMOTE DEBUG ==================== */
143 | /**
144 |  * REMOTE_DEBUG_PORT ‚Äì port do zdalnego debugowania Chrome
145 |  * Gdy ustawiony, mo≈ºesz pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
146 |  * i widzieƒá/kontrolowaƒá przeglƒÖdarkƒô na ≈ºywo (2FA, checkpoint)
147 |  *
148 |  * U≈ºycie:
149 |  *   1. REMOTE_DEBUG_PORT=9222 node src/index.js
150 |  *   2. SSH tunel: ssh -L 9222:localhost:9222 user@server
151 |  *   3. W Chrome: chrome://inspect ‚Üí Configure ‚Üí localhost:9222
152 |  */
153 | const REMOTE_DEBUG_PORT = Number(process.env.REMOTE_DEBUG_PORT || 0);
154 | 
155 | /* ==================== HUMAN BEHAVIOR MODE ==================== */
156 | /**
157 |  * HUMAN_MODE ‚Äì w≈ÇƒÖcza symulacjƒô zachowa≈Ñ cz≈Çowieka
158 |  * - Wolniejsze wpisywanie (~120ms/znak zamiast 35ms)
159 |  * - Losowa kolejno≈õƒá post√≥w
160 |  * - Pauzy miƒôdzy postami (3-8 sekund)
161 |  * Domy≈õlnie: true
162 |  */
163 | const HUMAN_MODE = process.env.HUMAN_MODE !== "false";
164 | 
165 | /**
166 |  * PROXY_URL ‚Äì URL do proxy HTTP/SOCKS5
167 |  * Format: http://user:pass@host:port lub socks5://host:port
168 |  * Zalecane: residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
169 |  */
170 | const PROXY_URL = (process.env.PROXY_URL || "").trim();
171 | 
172 | export {
173 |   // stary system ‚Äì optional
174 |   POSTS,
175 |   POST_LABELS,
176 | 
177 |   // u≈ºywane przez watcher.js / comments.js
178 |   EXPAND_COMMENTS,
179 |   USE_UI_HANDLERS,
180 |   INCLUDE_REPLIES,
181 |   CHECK_INTERVAL_MS,
182 | 
183 |   // FAST_MODE
184 |   FAST_MODE,
185 |   FAST_MAX_AGE_MIN,
186 | 
187 |   // ≈∫r√≥d≈Ça post√≥w
188 |   POSTS_JSON_PATH,
189 |   POSTS_SHEET_URL,
190 |   POSTS_REFRESH_MS,
191 |   POSTS_API_URL,
192 |   POSTS_API_TOKEN,
193 | 
194 |   // logowanie
195 |   LOG_LEVEL,
196 |   LOG_TIMESTAMPS,
197 |   LOG_COLORS,
198 | 
199 |   // captcha solver
200 |   CAPTCHA_API_KEY,
201 |   CAPTCHA_ENABLED,
202 | 
203 |   // remote debug
204 |   REMOTE_DEBUG_PORT,
205 | 
206 |   // human behavior mode
207 |   HUMAN_MODE,
208 |   PROXY_URL,
209 | };
210 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/postcss.config.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
1 | export default {
2 |   plugins: {
3 |     tailwindcss: {},
4 |     autoprefixer: {},
5 |   },
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/tailwind.config.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
 1 | /** @type {import('tailwindcss').Config} */
 2 | export default {
 3 |   darkMode: 'class',
 4 |   content: [
 5 |     './index.html',
 6 |     './src/**/*.{js,ts,jsx,tsx}',
 7 |   ],
 8 |   theme: {
 9 |     extend: {
10 |       colors: {
11 |         border: 'hsl(var(--border))',
12 |         input: 'hsl(var(--input))',
13 |         ring: 'hsl(var(--ring))',
14 |         background: 'hsl(var(--background))',
15 |         foreground: 'hsl(var(--foreground))',
16 |         primary: {
17 |           DEFAULT: 'hsl(var(--primary))',
18 |           foreground: 'hsl(var(--primary-foreground))',
19 |         },
20 |         secondary: {
21 |           DEFAULT: 'hsl(var(--secondary))',
22 |           foreground: 'hsl(var(--secondary-foreground))',
23 |         },
24 |         destructive: {
25 |           DEFAULT: 'hsl(var(--destructive))',
26 |           foreground: 'hsl(var(--destructive-foreground))',
27 |         },
28 |         muted: {
29 |           DEFAULT: 'hsl(var(--muted))',
30 |           foreground: 'hsl(var(--muted-foreground))',
31 |         },
32 |         accent: {
33 |           DEFAULT: 'hsl(var(--accent))',
34 |           foreground: 'hsl(var(--accent-foreground))',
35 |         },
36 |         popover: {
37 |           DEFAULT: 'hsl(var(--popover))',
38 |           foreground: 'hsl(var(--popover-foreground))',
39 |         },
40 |         card: {
41 |           DEFAULT: 'hsl(var(--card))',
42 |           foreground: 'hsl(var(--card-foreground))',
43 |         },
44 |       },
45 |       borderRadius: {
46 |         lg: 'var(--radius)',
47 |         md: 'calc(var(--radius) - 2px)',
48 |         sm: 'calc(var(--radius) - 4px)',
49 |       },
50 |     },
51 |   },
52 |   plugins: [],
53 | }
54 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/tsconfig.json`
**Typ:** JSON  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```json
 1 | {
 2 |   "compilerOptions": {
 3 |     "target": "ES2020",
 4 |     "useDefineForClassFields": true,
 5 |     "lib": ["ES2020", "DOM", "DOM.Iterable"],
 6 |     "module": "ESNext",
 7 |     "skipLibCheck": true,
 8 | 
 9 |     "moduleResolution": "bundler",
10 |     "allowImportingTsExtensions": true,
11 |     "isolatedModules": true,
12 |     "moduleDetection": "force",
13 |     "noEmit": true,
14 |     "jsx": "react-jsx",
15 | 
16 |     "strict": true,
17 |     "noUnusedLocals": true,
18 |     "noUnusedParameters": true,
19 |     "noFallthroughCasesInSwitch": true,
20 |     "noUncheckedSideEffectImports": true,
21 | 
22 |     "baseUrl": ".",
23 |     "paths": {
24 |       "@/*": ["./src/*"]
25 |     }
26 |   },
27 |   "include": ["src"]
28 | }
29 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/vite.config.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
 1 | import { defineConfig } from 'vite'
 2 | import react from '@vitejs/plugin-react'
 3 | import path from 'path'
 4 | 
 5 | export default defineConfig({
 6 |   plugins: [react()],
 7 |   base: '/new/',
 8 |   resolve: {
 9 |     alias: {
10 |       '@': path.resolve(__dirname, './src'),
11 |     },
12 |   },
13 |   server: {
14 |     port: 5173,
15 |     proxy: {
16 |       '/api': {
17 |         target: 'http://localhost:3180',
18 |         changeOrigin: true,
19 |       },
20 |     },
21 |   },
22 |   build: {
23 |     outDir: 'dist',
24 |     emptyOutDir: true,
25 |   },
26 | })
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/db/cache.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/db/cache.js
  2 | import fs from "fs";
  3 | import path from "path";
  4 | import log from "../utils/logger.js";
  5 | 
  6 | const DATA_DIR = "./data";
  7 | const FILE = path.join(DATA_DIR, "comments-cache.json");
  8 | 
  9 | /**
 10 |  * Upewnia siƒô, ≈ºe istnieje katalog ./data
 11 |  */
 12 | function ensureDir() {
 13 |   if (!fs.existsSync(DATA_DIR)) {
 14 |     fs.mkdirSync(DATA_DIR, { recursive: true });
 15 |   }
 16 | }
 17 | 
 18 | export function loadCache() {
 19 |   try {
 20 |     ensureDir();
 21 |     if (!fs.existsSync(FILE)) return {};
 22 |     const raw = fs.readFileSync(FILE, "utf8");
 23 |     if (!raw.trim()) return {};
 24 |     return JSON.parse(raw);
 25 |   } catch (e) {
 26 |     log.warn("CACHE", `B≈ÇƒÖd ≈Çadowania: ${e.message}`);
 27 | 
 28 |     // Pr√≥ba odczytu backup je≈õli g≈Ç√≥wny plik uszkodzony
 29 |     const backupFile = FILE + ".backup";
 30 |     if (fs.existsSync(backupFile)) {
 31 |       try {
 32 |         const backupRaw = fs.readFileSync(backupFile, "utf8");
 33 |         if (backupRaw.trim()) {
 34 |           log.warn("CACHE", "Odtworzono z backup");
 35 |           return JSON.parse(backupRaw);
 36 |         }
 37 |       } catch (backupErr) {
 38 |         log.warn("CACHE", `B≈ÇƒÖd odczytu backup: ${backupErr.message}`);
 39 |       }
 40 |     }
 41 | 
 42 |     return {};
 43 |   }
 44 | }
 45 | 
 46 | /**
 47 |  * Atomic write - zapisuje do pliku tymczasowego, potem rename.
 48 |  * Zapobiega uszkodzeniu cache przy przerwaniu procesu.
 49 |  */
 50 | export function saveCache(cache) {
 51 |   try {
 52 |     ensureDir();
 53 | 
 54 |     const tmpFile = path.join(DATA_DIR, `.comments-cache.${Date.now()}.tmp`);
 55 |     const content = JSON.stringify(cache, null, 2);
 56 | 
 57 |     // 1. Zapisz do pliku tymczasowego
 58 |     fs.writeFileSync(tmpFile, content, "utf8");
 59 | 
 60 |     // 2. Utw√≥rz backup aktualnego pliku (je≈õli istnieje)
 61 |     if (fs.existsSync(FILE)) {
 62 |       try {
 63 |         fs.copyFileSync(FILE, FILE + ".backup");
 64 |       } catch {
 65 |         // Ignoruj b≈ÇƒÖd backup - nie krytyczny
 66 |       }
 67 |     }
 68 | 
 69 |     // 3. Atomic rename (atomowa operacja na wiƒôkszo≈õci system√≥w plik√≥w)
 70 |     fs.renameSync(tmpFile, FILE);
 71 | 
 72 |   } catch (e) {
 73 |     log.warn("CACHE", `B≈ÇƒÖd zapisu: ${e.message}`);
 74 | 
 75 |     // Spr√≥buj usunƒÖƒá plik tmp je≈õli zosta≈Ç
 76 |     try {
 77 |       const tmpPattern = path.join(DATA_DIR, ".comments-cache.*.tmp");
 78 |       const files = fs.readdirSync(DATA_DIR);
 79 |       for (const f of files) {
 80 |         if (f.startsWith(".comments-cache.") && f.endsWith(".tmp")) {
 81 |           fs.unlinkSync(path.join(DATA_DIR, f));
 82 |         }
 83 |       }
 84 |     } catch {
 85 |       // Ignoruj b≈Çƒôdy cleanup
 86 |     }
 87 |   }
 88 | }
 89 | 
 90 | /**
 91 |  * Zwraca rozmiar cache w bajtach (dla monitoringu)
 92 |  */
 93 | export function getCacheSize() {
 94 |   try {
 95 |     if (!fs.existsSync(FILE)) return 0;
 96 |     const stats = fs.statSync(FILE);
 97 |     return stats.size;
 98 |   } catch {
 99 |     return 0;
100 |   }
101 | }
102 | 
103 | /**
104 |  * Zwraca liczbƒô wpis√≥w w cache (dla monitoringu)
105 |  */
106 | export function getCacheEntryCount() {
107 |   try {
108 |     if (!fs.existsSync(FILE)) return 0;
109 |     const raw = fs.readFileSync(FILE, "utf8");
110 |     if (!raw.trim()) return 0;
111 |     const data = JSON.parse(raw);
112 |     return Object.keys(data).length;
113 |   } catch {
114 |     return 0;
115 |   }
116 | }
117 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/checkpoint.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/checkpoint.js
  2 | import log from "../utils/logger.js";
  3 | 
  4 | /**
  5 |  * Wykrywanie i obs≈Çuga checkpoint√≥w/2FA Facebooka
  6 |  */
  7 | 
  8 | // URL patterns wskazujƒÖce na checkpoint/2FA
  9 | const CHECKPOINT_URL_PATTERNS = [
 10 |   "/checkpoint/",
 11 |   "/two_factor/",
 12 |   "/login/identify",
 13 |   "/recover/initiate",
 14 |   "/login/device-based/",
 15 |   "/checkpoint/block/",
 16 |   "/checkpoint/601/",
 17 | ];
 18 | 
 19 | // DOM selektory wskazujƒÖce na checkpoint/2FA
 20 | const CHECKPOINT_DOM_SELECTORS = [
 21 |   // 2FA
 22 |   'input[name="approvals_code"]',
 23 |   'input[autocomplete="one-time-code"]',
 24 |   'form[id*="two_factor"]',
 25 |   // Checkpoint
 26 |   '[data-testid="checkpoint_container"]',
 27 |   'form[action*="checkpoint"]',
 28 |   // Weryfikacja konta
 29 |   'input[name="captcha_response"]',
 30 |   '[role="dialog"][aria-label*="weryfikacja"]',
 31 |   '[role="dialog"][aria-label*="verification"]',
 32 |   // Podejrzana aktywno≈õƒá
 33 |   'div[data-testid="login_challenge"]',
 34 | ];
 35 | 
 36 | // Teksty wskazujƒÖce na checkpoint (polskie i angielskie)
 37 | const CHECKPOINT_TEXT_PATTERNS = [
 38 |   "wprowad≈∫ kod",
 39 |   "enter code",
 40 |   "two-factor",
 41 |   "dwuetapow",
 42 |   "weryfikacja",
 43 |   "verification required",
 44 |   "suspicious activity",
 45 |   "podejrzana aktywno≈õƒá",
 46 |   "confirm your identity",
 47 |   "potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá",
 48 |   "potwierd≈∫, ≈ºe to ty",
 49 |   "we need to confirm",
 50 |   "security check",
 51 |   "sprawdzenie zabezpiecze≈Ñ",
 52 |   "account verification",
 53 |   "weryfikacja konta",
 54 |   "enter the code",
 55 |   "wpisz kod",
 56 |   "approve your login",
 57 |   "zatwierd≈∫ logowanie",
 58 | ];
 59 | 
 60 | /**
 61 |  * Sprawdza czy URL wskazuje na checkpoint
 62 |  */
 63 | function isCheckpointUrl(url) {
 64 |   if (!url) return false;
 65 |   const lower = url.toLowerCase();
 66 |   return CHECKPOINT_URL_PATTERNS.some((p) => lower.includes(p));
 67 | }
 68 | 
 69 | /**
 70 |  * Sprawdza czy strona zawiera elementy checkpoint/2FA
 71 |  */
 72 | async function hasCheckpointElements(page) {
 73 |   try {
 74 |     const result = await page.evaluate((selectors) => {
 75 |       for (const sel of selectors) {
 76 |         if (document.querySelector(sel)) return true;
 77 |       }
 78 |       return false;
 79 |     }, CHECKPOINT_DOM_SELECTORS);
 80 |     return result;
 81 |   } catch {
 82 |     return false;
 83 |   }
 84 | }
 85 | 
 86 | /**
 87 |  * Sprawdza czy strona zawiera tekst wskazujƒÖcy na checkpoint
 88 |  */
 89 | async function hasCheckpointText(page) {
 90 |   try {
 91 |     const result = await page.evaluate((patterns) => {
 92 |       const bodyText = (document.body?.innerText || "").toLowerCase();
 93 |       return patterns.some((p) => bodyText.includes(p.toLowerCase()));
 94 |     }, CHECKPOINT_TEXT_PATTERNS);
 95 |     return result;
 96 |   } catch {
 97 |     return false;
 98 |   }
 99 | }
100 | 
101 | /**
102 |  * G≈Ç√≥wna funkcja wykrywania checkpoint
103 |  * @param {Page} page - Puppeteer page
104 |  * @returns {Promise<boolean>} - true je≈õli wykryto checkpoint
105 |  */
106 | async function isCheckpoint(page) {
107 |   try {
108 |     const url = page.url();
109 | 
110 |     // 1. Sprawd≈∫ URL
111 |     if (isCheckpointUrl(url)) {
112 |       log.dev("CHECKPOINT", `Wykryto checkpoint w URL: ${url}`);
113 |       return true;
114 |     }
115 | 
116 |     // 2. Sprawd≈∫ elementy DOM
117 |     const hasElements = await hasCheckpointElements(page);
118 |     if (hasElements) {
119 |       log.dev("CHECKPOINT", "Wykryto elementy checkpoint w DOM");
120 |       return true;
121 |     }
122 | 
123 |     // 3. Sprawd≈∫ tekst strony (tylko je≈õli nie jeste≈õmy zalogowani)
124 |     // Unikamy false positive na normalnych stronach
125 |     const hasText = await hasCheckpointText(page);
126 |     if (hasText) {
127 |       // Dodatkowa weryfikacja - czy to nie normalna strona FB?
128 |       const isNormalPage = await page.evaluate(() => {
129 |         // Szukamy element√≥w normalnej strony FB
130 |         const hasNewsFeed = !!document.querySelector('[role="feed"]');
131 |         const hasSearch = !!document.querySelector('input[aria-label*="Szukaj"], input[placeholder*="Szukaj"]');
132 |         return hasNewsFeed || hasSearch;
133 |       });
134 | 
135 |       if (!isNormalPage) {
136 |         log.dev("CHECKPOINT", "Wykryto tekst checkpoint na stronie");
137 |         return true;
138 |       }
139 |     }
140 | 
141 |     return false;
142 |   } catch (err) {
143 |     log.debug("CHECKPOINT", `B≈ÇƒÖd detekcji: ${err?.message}`);
144 |     return false;
145 |   }
146 | }
147 | 
148 | /**
149 |  * Okre≈õla typ checkpoint
150 |  * @param {Page} page - Puppeteer page
151 |  * @returns {Promise<string>} - typ checkpoint
152 |  */
153 | async function getCheckpointType(page) {
154 |   try {
155 |     const url = page.url();
156 | 
157 |     if (url.includes("/two_factor/")) return "2FA";
158 |     if (url.includes("/checkpoint/block/")) return "BLOCKED";
159 |     if (url.includes("/checkpoint/")) return "CHECKPOINT";
160 |     if (url.includes("/login/identify")) return "IDENTIFY";
161 |     if (url.includes("/recover/")) return "RECOVERY";
162 | 
163 |     const has2faInput = await page
164 |       .evaluate(() => {
165 |         return !!(
166 |           document.querySelector('input[name="approvals_code"]') ||
167 |           document.querySelector('input[autocomplete="one-time-code"]')
168 |         );
169 |       })
170 |       .catch(() => false);
171 | 
172 |     if (has2faInput) return "2FA";
173 | 
174 |     return "UNKNOWN";
175 |   } catch {
176 |     return "UNKNOWN";
177 |   }
178 | }
179 | 
180 | export { isCheckpoint, getCheckpointType, isCheckpointUrl };
181 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/comments.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/comments.js
  2 | import { EXPAND_COMMENTS } from "../config.js";
  3 | import { sleepRandom, humanDelay } from "../utils/sleep.js";
  4 | import { scrollPost } from "./scroll.js";
  5 | import { acceptCookies, saveCookies } from "./cookies.js";
  6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
  7 | import { clickOneExpandButton } from "./expandButtons.js";
  8 | import { safeGoto } from "../utils/navigation.js";
  9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
 10 | import log from "../utils/logger.js";
 11 | 
 12 | import * as uiPhoto from "./ui/photo.js";
 13 | import * as uiPost from "./ui/post.js";
 14 | import * as uiVideos from "./ui/videos.js";
 15 | import * as uiWatch from "./ui/watch.js";
 16 | 
 17 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 18 |   ? Number(process.env.NAV_TIMEOUT_MS)
 19 |   : 90000;
 20 | 
 21 | /* ============================================================
 22 |    ===================== UI ROUTER ============================
 23 |    ============================================================ */
 24 | 
 25 | function pickUiHandler(url) {
 26 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
 27 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
 28 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
 29 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
 30 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
 31 |   return null;
 32 | }
 33 | 
 34 | function resolveFastFlag(url, opts, ui) {
 35 |   const wantFast = Boolean(opts && opts.fast);
 36 |   if (!wantFast) return false;
 37 |   // Minimalny zakres FAST: tylko UI "post" (permalink/story/posts)
 38 |   if (!ui || ui.type !== "post") return false;
 39 |   return true;
 40 | }
 41 | 
 42 | /* ============================================================
 43 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
 44 |    ============================================================ */
 45 | 
 46 | async function openCommentsMenu(page) {
 47 |   const r = await page.evaluate(() => {
 48 |     const norm = (s) =>
 49 |       String(s || "")
 50 |         .replace(/\u00a0/g, " ")
 51 |         .replace(/\s+/g, " ")
 52 |         .trim()
 53 |         .toLowerCase();
 54 | 
 55 |     function getLabel(el) {
 56 |       return el.getAttribute?.("aria-label") || el.textContent || "";
 57 |     }
 58 | 
 59 |     if (document.querySelector("div[role='menu']"))
 60 |       return { ok: true, state: "menu-already-open" };
 61 | 
 62 |     const els = Array.from(
 63 |       document.querySelectorAll(
 64 |         "button,div[role='button'],span[role='button'],a[role='button']"
 65 |       )
 66 |     );
 67 | 
 68 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
 69 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
 70 |     const btn = els.find((el) => {
 71 |       const t = norm(getLabel(el));
 72 |       return (
 73 |         t === "najtrafniejsze" ||
 74 |         t === "most relevant" ||
 75 |         t === "wszystkie komentarze" ||
 76 |         t === "all comments" ||
 77 |         t === "najnowsze" ||
 78 |         t === "newest" ||
 79 |         t === "poka≈º wszystkie" ||
 80 |         t === "show all" ||
 81 |         t === "wy≈õwietl wszystkie" ||
 82 |         t === "view all"
 83 |       );
 84 |     });
 85 | 
 86 |     if (!btn) return { ok: false, reason: "no-trigger" };
 87 | 
 88 |     try {
 89 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
 90 |     } catch {}
 91 | 
 92 |     try {
 93 |       btn.click();
 94 |       return { ok: true, state: "clicked-trigger" };
 95 |     } catch {
 96 |       return { ok: false, reason: "click-failed" };
 97 |     }
 98 |   });
 99 | 
100 |   return r?.ok === true;
101 | }
102 | 
103 | async function clickMenuOptionByPrefix(page, prefixes) {
104 |   return page.evaluate(
105 |     (prefixes) => {
106 |       const norm = (s) =>
107 |         String(s || "")
108 |           .replace(/\u00a0/g, " ")
109 |           .replace(/\s+/g, " ")
110 |           .trim()
111 |           .toLowerCase();
112 | 
113 |       const menu =
114 |         document.querySelector("div[role='menu']") ||
115 |         document.querySelector("div[role='dialog']");
116 |       if (!menu) return { ok: false, reason: "no-menu" };
117 | 
118 |       const items = Array.from(
119 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
120 |       );
121 | 
122 |       const opt = items.find((el) => {
123 |         const t = norm(el.textContent);
124 |         return prefixes.some((p) => t.startsWith(p));
125 |       });
126 | 
127 |       if (!opt) return { ok: false, reason: "no-opt" };
128 | 
129 |       try {
130 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
131 |       } catch {}
132 | 
133 |       try {
134 |         opt.click();
135 |         return { ok: true };
136 |       } catch {
137 |         return { ok: false, reason: "click-failed" };
138 |       }
139 |     },
140 |     prefixes
141 |   );
142 | }
143 | 
144 | async function switchCommentsFilterToAllLegacy(page) {
145 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Wszystkie komentarze'...");
146 | 
147 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
148 |     await humanDelay(200, 0.3); // Human: pauza przed otwarciem menu
149 |     const opened = await openCommentsMenu(page);
150 |     if (opened) await humanDelay(500, 0.3); // Human: czekaj na animacjƒô menu
151 |   }
152 | 
153 |   const picked = await clickMenuOptionByPrefix(page, [
154 |     "wszystkie komentarze",
155 |     "all comments",
156 |     "poka≈º wszystkie",
157 |     "show all",
158 |     "wy≈õwietl wszystkie",
159 |     "view all",
160 |   ]);
161 | 
162 |   if (picked?.ok) {
163 |     await humanDelay(400, 0.3);
164 |     await page
165 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
166 |         timeout: 2500,
167 |       })
168 |       .catch(() => {});
169 |     log.dev("FILTER", "Ustawiono 'Wszystkie komentarze'");
170 |     return true;
171 |   }
172 | 
173 |   log.dev("FILTER", "Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze'");
174 |   return false;
175 | }
176 | 
177 | /* ============================================================
178 |    =======  FAST_MODE: SORTOWANIE "NAJNOWSZE"  =================
179 |    ============================================================ */
180 | 
181 | export async function switchCommentsFilterToNewest(page, url = null) {
182 |   const finalUrl = url || page.url();
183 |   const ui = pickUiHandler(finalUrl);
184 | 
185 |   // Dla UI "post" u≈ºywamy scope-aware wersji
186 |   if (ui?.type === "post" && typeof uiPost.switchCommentsFilterToNewestScoped === "function") {
187 |     log.dev("FILTER", "UI ‚Üí post switchCommentsFilterToNewestScoped");
188 |     return uiPost.switchCommentsFilterToNewestScoped(page);
189 |   }
190 | 
191 |   // Dla UI "videos" u≈ºywamy scope-aware wersji
192 |   if (ui?.type === "videos" && typeof uiVideos.switchCommentsFilterToNewestScoped === "function") {
193 |     log.dev("FILTER", "UI ‚Üí videos switchCommentsFilterToNewestScoped");
194 |     return uiVideos.switchCommentsFilterToNewestScoped(page);
195 |   }
196 | 
197 |   // Legacy/fallback dla innych UI
198 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Najnowsze' (legacy)...");
199 | 
200 |   // Otw√≥rz menu je≈õli zamkniƒôte
201 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
202 |     const opened = await openCommentsMenu(page);
203 |     if (!opened) {
204 |       log.dev("FILTER", "Nie uda≈Ço siƒô otworzyƒá menu sortowania");
205 |       return { ok: false, reason: "menu-not-opened" };
206 |     }
207 |     await humanDelay(400, 0.3);
208 |   }
209 | 
210 |   // Kliknij "Najnowsze" / "Newest"
211 |   const picked = await clickMenuOptionByPrefix(page, [
212 |     "najnowsze",
213 |     "newest",
214 |     "od najnowszych",
215 |     "most recent",
216 |   ]);
217 | 
218 |   if (picked?.ok) {
219 |     await humanDelay(400, 0.3);
220 |     await page
221 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
222 |         timeout: 2500,
223 |       })
224 |       .catch(() => {});
225 |     log.dev("FILTER", "Ustawiono 'Najnowsze'");
226 |     return { ok: true };
227 |   }
228 | 
229 |   log.dev("FILTER", "Nie uda≈Ço siƒô wybraƒá 'Najnowsze'");
230 |   return { ok: false, reason: picked?.reason || "option-not-found" };
231 | }
232 | 
233 | /* ============================================================
234 |    ===================  EXPAND (LEGACY)  =======================
235 |    ============================================================ */
236 | 
237 | export async function expandAllComments(page) {
238 |   if (!EXPAND_COMMENTS) return 0;
239 | 
240 |   let clicks = 0;
241 |   for (let i = 0; i < 30; i++) {
242 |     const didClick = await clickOneExpandButton(page);
243 |     if (!didClick) break;
244 |     clicks++;
245 |     await humanDelay(700, 0.3);
246 |   }
247 |   return clicks;
248 | }
249 | 
250 | /* ============================================================
251 |    ===================  LICZNIK KOMENTARZY  ====================
252 |    ============================================================ */
253 | 
254 | async function getCommentCountLegacy(page) {
255 |   const ui = await getUiCommentInfo(page).catch(() => null);
256 | 
257 |   const uiCandidates = [
258 |     ui?.comments,
259 |     ui?.count,
260 |     ui?.commentCount,
261 |     ui?.commentsCount,
262 |     ui?.totalComments,
263 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
264 | 
265 |   if (uiCandidates.length) {
266 |     const best = Math.max(...uiCandidates);
267 |     log.debug("EXTRACT", "UI count", {
268 |       best,
269 |       candidates: uiCandidates,
270 |       source: ui?.source || "ui",
271 |       raw: ui?.raw || null,
272 |       viewType: ui?.viewType || null,
273 |     });
274 |     return best;
275 |   }
276 | 
277 |   const uiLoose = await page
278 |     .evaluate(() => {
279 |       const texts = [];
280 |       const pushText = (t) => {
281 |         if (!t) return;
282 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
283 |         if (s) texts.push(s);
284 |       };
285 | 
286 |       const els = Array.from(
287 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
288 |       );
289 |       for (const el of els) {
290 |         pushText(el.getAttribute?.("aria-label"));
291 |         pushText(el.textContent);
292 |       }
293 | 
294 |       const nums = [];
295 |       for (const t of texts) {
296 |         const low = t.toLowerCase();
297 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
298 |         if (m) nums.push(Number(m[1]));
299 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
300 |         if (m) nums.push(Number(m[1]));
301 |       }
302 | 
303 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
304 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
305 |     })
306 |     .catch(() => ({ count: null, sample: [] }));
307 | 
308 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
309 |     log.debug("EXTRACT", `UI-loose count: ${uiLoose.count}`);
310 |     return uiLoose.count;
311 |   }
312 | 
313 |   if (ui) {
314 |     log.debug("EXTRACT", "UI object (no number)", { keys: Object.keys(ui) });
315 |   } else {
316 |     log.debug("EXTRACT", "UI object: null");
317 |   }
318 | 
319 |   const anchors = await page.evaluate(() => {
320 |     const as = Array.from(
321 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
322 |     );
323 |     const ids = new Set();
324 |     for (const a of as) {
325 |       try {
326 |         const u = new URL(a.href);
327 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
328 |         if (raw) ids.add(raw);
329 |       } catch {}
330 |     }
331 |     return ids.size;
332 |   });
333 | 
334 |   if (anchors > 0) log.debug("EXTRACT", `Anchors-fallback: ${anchors}`);
335 |   return anchors > 0 ? anchors : null;
336 | }
337 | 
338 | /* ============================================================
339 |    ===================  EKSTRAKCJA KOMENTARZY  =================
340 |    ============================================================ */
341 | 
342 | async function extractCommentsFromDOM(page) {
343 |   const data = await page.evaluate(() => {
344 |     function extractCommentIdRaw(url) {
345 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
346 |       return m ? decodeURIComponent(m[1]) : null;
347 |     }
348 | 
349 |     function safeAtob(input) {
350 |       try {
351 |         let s = String(input || "");
352 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
353 |         while (s.length % 4) s += "=";
354 |         return atob(s);
355 |       } catch {
356 |         return null;
357 |       }
358 |     }
359 | 
360 |     function idNumFromRaw(idRaw) {
361 |       if (!idRaw) return null;
362 |       const s = String(idRaw).trim();
363 |       if (/^\d+$/.test(s)) return s;
364 | 
365 |       const dec = safeAtob(s);
366 |       if (dec) {
367 |         const m = String(dec).match(/(\d{6,})\s*$/);
368 |         if (m) return m[1];
369 |       }
370 |       const m2 = s.match(/_(\d+)\b/);
371 |       return m2 ? m2[1] : null;
372 |     }
373 | 
374 |     function normalizeTime(text) {
375 |       if (!text) return null;
376 | 
377 |       const t = String(text)
378 |         .toLowerCase()
379 |         .replace(/\u00a0/g, " ")
380 |         .replace(/\s+/g, " ")
381 |         .trim();
382 | 
383 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
384 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
385 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
386 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
387 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
388 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
389 | 
390 |       return null;
391 |     }
392 | 
393 |     function findTimeAround(linkEl, fallbackNode) {
394 |       const root =
395 |         linkEl?.closest?.("div[role='article']") ||
396 |         linkEl?.closest?.("div[aria-label]") ||
397 |         linkEl?.closest?.("div") ||
398 |         fallbackNode;
399 | 
400 |       if (!root) return null;
401 | 
402 |       const els = root.querySelectorAll("a, abbr, span");
403 |       for (const el of els) {
404 |         const aria = el.getAttribute?.("aria-label");
405 |         const t1 = normalizeTime(aria);
406 |         if (t1) return t1;
407 | 
408 |         const txt = el.textContent?.trim();
409 |         const t2 = normalizeTime(txt);
410 |         if (t2) return t2;
411 |       }
412 |       return null;
413 |     }
414 | 
415 |     const nodes = Array.from(
416 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
417 |     );
418 | 
419 |     const extracted = nodes
420 |       .map((node, idx) => {
421 |         const author = node.querySelector("a[role=\"link\"] span span")?.textContent?.trim() || null;
422 |         const text = node.querySelector("div[dir=\"auto\"]")?.textContent?.trim() || null;
423 | 
424 |         const linkEl = node.querySelector("a[href*=\"reply_comment_id\"]") ||
425 |           node.querySelector("a[href*=\"comment_id\"]") ||
426 |           node.querySelector("a[role=\"link\"]");
427 | 
428 |         const href = linkEl?.getAttribute("href") || null;
429 |         const permalink = href
430 |           ? href.startsWith("http")
431 |             ? href
432 |             : `https://www.facebook.com${href}`
433 |           : null;
434 | 
435 |         const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
436 |         const id = id_raw ? String(id_raw).trim() : null;
437 |         const id_num = id_raw ? idNumFromRaw(id_raw) : null;
438 |         const time = findTimeAround(linkEl, node);
439 | 
440 |         if (!author || !text || !id) return null;
441 | 
442 |         return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
443 |       })
444 |       .filter(Boolean);
445 | 
446 |     return extracted;
447 |   });
448 | 
449 |   return Array.isArray(data) ? data : [];
450 | }
451 | 
452 | /* ============================================================
453 |    ===================  PREPARE / LOAD (LEGACY)  ===============
454 |    ============================================================ */
455 | 
456 | async function prepareLegacy(page, url) {
457 |   const ok = await safeGoto(page, url, "comments", {
458 |     waitUntil: "networkidle2",
459 |     timeout: NAV_TIMEOUT_MS,
460 |   });
461 | 
462 |   if (!ok) throw new Error("safeGoto-failed");
463 | 
464 |   const currentUrl = page.url();
465 |   if (currentUrl.includes("/login")) {
466 |     log.dev("LOGIN", "/login redirect ‚Üí fbLogin()");
467 |     await fbLogin(page);
468 |     await sleepRandom(3000, 4500);
469 | 
470 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
471 |     log.dev("LOGIN", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
472 | 
473 |     if (loggedAfterLogin) {
474 |       await safeGoto(page, url, "comments", {
475 |         waitUntil: "networkidle2",
476 |         timeout: NAV_TIMEOUT_MS,
477 |       });
478 |     }
479 |   }
480 | 
481 |   await acceptCookies(page, "post-initial");
482 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
483 |   await sleepRandom(900, 1400);
484 |   await acceptCookies(page, "post");
485 | 
486 |   try {
487 |     const logged = await checkIfLogged(page).catch(() => false);
488 |     if (logged) await saveCookies(page);
489 |   } catch {}
490 | 
491 |   await scrollPost(page, 140).catch(() => {});
492 |   await sleepRandom(500, 800);
493 | 
494 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
495 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
496 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
497 |   await humanDelay(400, 0.3);
498 | }
499 | 
500 | async function loadAllCommentsLegacy(page, opts = {}) {
501 |   if (!EXPAND_COMMENTS) return;
502 | 
503 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
504 | 
505 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
506 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
507 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
508 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
509 | 
510 |   log.dev("EXTRACT", "Load start", { expected });
511 | 
512 |   function uniqAnchorCountEval() {
513 |     return page.evaluate(() => {
514 |       const as = Array.from(
515 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
516 |       );
517 |       const ids = new Set();
518 |       for (const a of as) {
519 |         const href = a.getAttribute("href") || "";
520 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
521 |         if (m && m[1]) ids.add(m[1]);
522 |       }
523 |       return ids.size;
524 |     });
525 |   }
526 | 
527 |   function commentNodesCountEval() {
528 |     return page.evaluate(() => {
529 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
530 |       return nodes ? nodes.length : 0;
531 |     });
532 |   }
533 | 
534 |   function hasMoreButtonsEval() {
535 |     return page.evaluate(() => {
536 |       const norm = (s) =>
537 |         String(s || "")
538 |           .replace(/\u00a0/g, " ")
539 |           .replace(/\s+/g, " ")
540 |           .trim()
541 |           .toLowerCase();
542 | 
543 |       const btns = Array.from(
544 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
545 |       );
546 |       return btns.some((b) => {
547 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
548 |         return (
549 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
550 |           t.includes("zobacz wiƒôcej komentarzy") ||
551 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
552 |           t.includes("more comments") ||
553 |           t.includes("view more comments") ||
554 |           t.includes("view previous comments") ||
555 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
556 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
557 |           t.includes("more replies") ||
558 |           t.includes("view more replies")
559 |         );
560 |       });
561 |     });
562 |   }
563 | 
564 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
565 |   let nodes = await commentNodesCountEval().catch(() => 0);
566 | 
567 |   let stable = 0;
568 |   let noProgress = 0;
569 | 
570 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
571 |     let clicks = 0;
572 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
573 |       const did = await clickOneExpandButton(page).catch(() => false);
574 |       if (!did) break;
575 |       clicks++;
576 |       await humanDelay(400, 0.3);
577 |     }
578 | 
579 |     await scrollPost(page, 220).catch(() => {});
580 |     await sleepRandom(400, 700);
581 | 
582 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
583 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
584 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
585 | 
586 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
587 | 
588 |     if (progressed) {
589 |       anchors = nextAnchors;
590 |       nodes = nextNodes;
591 |       stable = 0;
592 |       noProgress = 0;
593 |     } else {
594 |       stable++;
595 |       noProgress++;
596 |     }
597 | 
598 |     log.debug("EXTRACT", `Round ${round}`, {
599 |       anchors: `${anchors}‚Üí${nextAnchors}`,
600 |       nodes: `${nodes}‚Üí${nextNodes}`,
601 |       clicks,
602 |       stable: `${stable}/${STABLE_ROUNDS}`,
603 |       moreBtns,
604 |     });
605 | 
606 |     const stableEnough = stable >= STABLE_ROUNDS;
607 | 
608 |     if (!moreBtns && stableEnough) {
609 |       log.dev("EXTRACT", "Stop: no more buttons + stable");
610 |       break;
611 |     }
612 | 
613 |     const reachedExpected =
614 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
615 |     if (reachedExpected && stableEnough && !moreBtns) {
616 |       log.dev("EXTRACT", "Stop: expected reached + stable");
617 |       break;
618 |     }
619 | 
620 |     if (stableEnough && moreBtns) {
621 |       log.debug("EXTRACT", "Rescue: stable but buttons ‚Üí deep scroll");
622 |       await scrollPost(page, 520).catch(() => {});
623 |       await sleepRandom(1000, 1600);
624 |       stable = 0;
625 |       continue;
626 |     }
627 | 
628 |     if (noProgress >= MAX_NO_PROGRESS) {
629 |       if (moreBtns) {
630 |         log.debug("EXTRACT", "Last-rescue: no-progress but buttons ‚Üí deep scroll");
631 |         await scrollPost(page, 650).catch(() => {});
632 |         await sleepRandom(1400, 1900);
633 |         stable = 0;
634 |         noProgress = 0;
635 |         continue;
636 |       }
637 | 
638 |       log.dev("EXTRACT", "Stop: too many no-progress rounds");
639 |       break;
640 |     }
641 | 
642 |     anchors = nextAnchors;
643 |     nodes = nextNodes;
644 |   }
645 | 
646 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
647 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
648 |   log.dev("EXTRACT", `Load done: ${finalAnchors} anchors, ${finalNodes} nodes`);
649 | }
650 | 
651 | /* ============================================================
652 |    ===================  PUBLIC API (ROUTED)  ===================
653 |    ============================================================ */
654 | 
655 | export async function prepare(page, url) {
656 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
657 |   const ui = pickUiHandler(url);
658 |   const fast = resolveFastFlag(url, opts, ui);
659 | 
660 |   if (ui?.prepare) {
661 |     log.dev("NAV", `UI ‚Üí ${ui.type || "unknown"} prepare`, { fast });
662 |     return ui.prepare(page, url, { ...(opts || {}), fast });
663 |   }
664 | 
665 |   log.dev("NAV", "UI ‚Üí legacy prepare");
666 |   return prepareLegacy(page, url);
667 | }
668 | 
669 | export async function getCommentCount(page, url) {
670 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
671 |   const finalUrl = url || page.url();
672 |   const ui = pickUiHandler(finalUrl);
673 |   const fast = resolveFastFlag(finalUrl, opts, ui);
674 | 
675 |   if (ui?.getCommentCount) {
676 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} getCommentCount`);
677 |     return ui.getCommentCount(page, finalUrl, { ...(opts || {}), fast });
678 |   }
679 | 
680 |   log.debug("EXTRACT", "UI ‚Üí legacy getCommentCount");
681 |   return getCommentCountLegacy(page);
682 | }
683 | 
684 | export async function loadAllComments(page, opts = {}, url = null) {
685 |   if (!EXPAND_COMMENTS) return;
686 | 
687 |   const finalUrl = url || page.url();
688 |   const ui = pickUiHandler(finalUrl);
689 |   const fast = resolveFastFlag(finalUrl, opts, ui);
690 | 
691 |   if (ui?.loadAllComments) {
692 |     log.dev("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} loadAllComments`);
693 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal, ...(opts || {}), fast });
694 |   }
695 | 
696 |   log.dev("EXTRACT", "UI ‚Üí legacy loadAllComments");
697 |   return loadAllCommentsLegacy(page, opts);
698 | }
699 | 
700 | export async function extractCommentsData(page, url = null) {
701 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
702 |   const finalUrl = url || page.url();
703 |   const ui = pickUiHandler(finalUrl);
704 |   const fast = resolveFastFlag(finalUrl, opts, ui);
705 | 
706 |   const getPostRef = (u) => {
707 |     if (!u) return null;
708 |     try {
709 |       const x = new URL(u);
710 | 
711 |       // permalink.php?story_fbid=...
712 |       const story = x.searchParams.get("story_fbid");
713 |       if (story) return `story_fbid:${story}`;
714 | 
715 |       // /.../posts/<id>  |  /.../videos/<id>  |  /.../photos/<id>
716 |       const parts = x.pathname.split("/").filter(Boolean);
717 |       for (let i = 0; i < parts.length - 1; i++) {
718 |         const k = parts[i];
719 |         if (k === "posts" || k === "videos" || k === "photos" || k === "reels") {
720 |           const v = parts[i + 1];
721 |           if (v) return `${k}:${v}`;
722 |         }
723 |       }
724 | 
725 |       // fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)
726 |       return null;
727 |     } catch (e) {
728 |       return null;
729 |     }
730 |   };
731 | 
732 |   const postRef = getPostRef(finalUrl);
733 | 
734 |   const filterByRef = (arr) => {
735 |     if (!Array.isArray(arr)) return [];
736 |     if (!postRef) return arr;
737 | 
738 |     let dropped = 0;
739 |     const out = [];
740 |     let sampleLogged = 0;
741 | 
742 |     // kontekst: do czego porownujemy
743 |     log.debug("DEDUP", `Context: want=${postRef || "null"}`);
744 | 
745 |     for (const c of arr) {
746 |       const permalink = c && typeof c === "object" ? c.permalink || null : null;
747 |       const cref = permalink ? getPostRef(permalink) : null;
748 | 
749 |       // pokaz 3 pierwsze permalink->cref
750 |       if (sampleLogged < 3 && permalink) {
751 |         log.debug("DEDUP", `Sample: cref=${cref || "null"}`);
752 |         sampleLogged += 1;
753 |       }
754 | 
755 |       if (cref && cref !== postRef) {
756 |         dropped += 1;
757 |         continue;
758 |       }
759 |       if (c && typeof c === "object") c.postRef = postRef;
760 |       out.push(c);
761 |     }
762 | 
763 |     if (dropped > 0) {
764 |       log.debug("DEDUP", `Dropped ${dropped} (ref mismatch)`);
765 |     }
766 | 
767 |     if (arr.length > 0 && out.length === 0 && dropped === arr.length) {
768 |       out._dedupAllDropped = true;
769 |       log.warn("DEDUP", `All ${arr.length} dropped (ref mismatch)`);
770 |     }
771 | 
772 |     return out;
773 |   };
774 | 
775 |   if (ui?.extractComments) {
776 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} extractComments`);
777 |     const out = await ui.extractComments(page, finalUrl, { ...(opts || {}), fast });
778 |     return filterByRef(out);
779 |   }
780 | 
781 |   const out = await extractCommentsFromDOM(page);
782 |   return filterByRef(out);
783 | }
784 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/cookies.js
  2 | import fs from "fs/promises";
  3 | import path from "path";
  4 | import { sleepRandom } from "../utils/sleep.js";
  5 | import log from "../utils/logger.js";
  6 | 
  7 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
  8 | const COOKIES_READ_ONLY =
  9 |   String(process.env.COOKIES_READ_ONLY || "")
 10 |     .trim()
 11 |     .toLowerCase() === "true";
 12 | 
 13 | log.debug("COOKIES", `COOKIES_READ_ONLY=${COOKIES_READ_ONLY}`, { raw: process.env.COOKIES_READ_ONLY });
 14 | 
 15 | 
 16 | /**
 17 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
 18 |  */
 19 | async function loadCookies(page) {
 20 |   try {
 21 |     const raw = await fs.readFile("cookies.json", "utf8");
 22 |     const cookies = JSON.parse(raw);
 23 | 
 24 |     if (Array.isArray(cookies) && cookies.length) {
 25 |       await page.setCookie(...cookies);
 26 |       log.dev("COOKIES", `Za≈Çadowano ${cookies.length} cookies z pliku`);
 27 |     } else {
 28 |       log.dev("COOKIES", "cookies.json istnieje, ale nie zawiera poprawnej tablicy");
 29 |     }
 30 |   } catch (err) {
 31 |     log.dev("COOKIES", `Brak cookies.json lub b≈ÇƒÖd odczytu: ${err?.message || err}`);
 32 |   }
 33 | }
 34 | 
 35 | /**
 36 |  * Atomic write dla plik√≥w JSON - zapisuje do tmp, potem rename
 37 |  * @param {string} targetPath - docelowa ≈õcie≈ºka pliku
 38 |  * @param {string} content - zawarto≈õƒá do zapisania
 39 |  */
 40 | async function atomicWriteFile(targetPath, content) {
 41 |   const dir = path.dirname(targetPath);
 42 |   const basename = path.basename(targetPath, ".json");
 43 |   const tmpFile = path.join(dir, `.${basename}.${Date.now()}.tmp`);
 44 | 
 45 |   // 1. Zapisz do pliku tymczasowego
 46 |   await fs.writeFile(tmpFile, content, "utf8");
 47 | 
 48 |   // 2. Atomic rename
 49 |   await fs.rename(tmpFile, targetPath);
 50 | }
 51 | 
 52 | /**
 53 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
 54 |  * U≈ºywa atomic write dla bezpiecze≈Ñstwa.
 55 |  */
 56 | async function saveCookies(page) {
 57 |   if (COOKIES_READ_ONLY) {
 58 |     log.debug("COOKIES", "COOKIES_READ_ONLY=true ‚Äì pomijam zapis");
 59 |     return;
 60 |   }
 61 | 
 62 |   try {
 63 |     const cookies = await page.cookies();
 64 |     const content = JSON.stringify(cookies, null, 2);
 65 | 
 66 |     await atomicWriteFile("cookies.json", content);
 67 | 
 68 |     log.dev("COOKIES", `Zapisano ${cookies.length} cookies do pliku`);
 69 |   } catch (e) {
 70 |     log.warn("COOKIES", `B≈ÇƒÖd zapisu cookies.json: ${e?.message || e}`);
 71 | 
 72 |     // Cleanup tmp files
 73 |     try {
 74 |       const files = await fs.readdir(".");
 75 |       for (const f of files) {
 76 |         if (f.startsWith(".cookies.") && f.endsWith(".tmp")) {
 77 |           await fs.unlink(f);
 78 |         }
 79 |       }
 80 |     } catch {
 81 |       // Ignoruj b≈Çƒôdy cleanup
 82 |     }
 83 |   }
 84 | }
 85 | 
 86 | 
 87 | 
 88 | /**
 89 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
 90 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
 91 |  */
 92 | async function acceptCookies(page, label = "global") {
 93 |   try {
 94 |     // chwila na pojawienie siƒô popupu
 95 |     await sleepRandom(800, 1500);
 96 | 
 97 |     const result = await page.evaluate(() => {
 98 |       const wanted = [
 99 |         "zezw√≥l na wszystkie pliki cookie",
100 |         "zezw√≥l na wszystkie pliki",
101 |         "akceptuj wszystkie pliki cookie",
102 |         "akceptuj wszystkie",
103 |         "allow all cookies",
104 |         "accept all cookies",
105 |         "accept essential and optional cookies",
106 |         "tylko niezbƒôdne pliki cookie",
107 |         "odrzuƒá opcjonalne pliki cookie",
108 |       ].map((t) => t.toLowerCase());
109 | 
110 |       const buttons = Array.from(
111 |         document.querySelectorAll("button, [role='button']")
112 |       );
113 | 
114 |       let clicked = false;
115 |       const texts = [];
116 | 
117 |       for (const btn of buttons) {
118 |         const txt = (btn.innerText || btn.textContent || "").trim();
119 |         if (!txt) continue;
120 | 
121 |         const low = txt.toLowerCase();
122 |         texts.push(txt);
123 | 
124 |         if (wanted.some((w) => low.includes(w))) {
125 |           btn.click();
126 |           clicked = true;
127 |           break;
128 |         }
129 |       }
130 | 
131 |       return { clicked, texts };
132 |     });
133 | 
134 |     if (result.clicked) {
135 |       log.debug("COOKIES", `[${label}] Klikniƒôto akceptacjƒô cookies`);
136 |       await sleepRandom(1500, 2500);
137 |     } else {
138 |       log.debug("COOKIES", `[${label}] Nie znaleziono przycisku cookies`, { texts: result.texts?.slice(0, 5) });
139 |     }
140 |   } catch (err) {
141 |     log.debug("COOKIES", `[${label}] B≈ÇƒÖd popupu: ${err?.message || err}`);
142 |   }
143 | }
144 | 
145 | export {
146 |   loadCookies,
147 |   saveCookies,
148 |   acceptCookies,
149 | };
150 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/expandButtons.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/expandButtons.js
  2 | // Centralny ‚Äûbutton classifier" dla wszystkich przycisk√≥w typu:
  3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments"
  4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies"
  5 | // - ‚ÄûZobacz wiƒôcej / See more" (bez ‚ÄûZobacz t≈Çumaczenie").
  6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
  7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
  8 | 
  9 | import { INCLUDE_REPLIES } from "../config.js";
 10 | import { humanDelay } from "../utils/sleep.js";
 11 | import log from "../utils/logger.js";
 12 | 
 13 | async function clickOneExpandButton(page) {
 14 |   // Human behavior: ma≈Çe op√≥≈∫nienie przed szukaniem przycisku
 15 |   await humanDelay(150, 0.4);
 16 | 
 17 |   const res = await page.evaluate((includeReplies) => {
 18 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 19 |       location.href
 20 |     );
 21 |     const isWatchView = /\/watch\//i.test(location.href);
 22 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
 23 | 
 24 |     function getPostRoot() {
 25 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 26 |       const postDialog = dialogs.find((dlg) => {
 27 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 28 |         if (!text) return false;
 29 |         const hasCommentWord =
 30 |           text.includes("komentarz") || text.includes("comment");
 31 |         const hasActions =
 32 |           text.includes("lubiƒô to") ||
 33 |           text.includes("komentarz") ||
 34 |           text.includes("udostƒôpnij") ||
 35 |           text.includes("napisz komentarz") ||
 36 |           text.includes("comment");
 37 |         const looksLikeNotifications =
 38 |           text.startsWith("powiadomienia") &&
 39 |           text.includes("wszystkie") &&
 40 |           text.includes("nieprzeczytane");
 41 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 42 |       });
 43 |       if (postDialog) return postDialog;
 44 |       const main = document.querySelector("div[role='main']");
 45 |       if (main) {
 46 |         const article = main.querySelector("article");
 47 |         return article || main;
 48 |       }
 49 |       return document.body;
 50 |     }
 51 | 
 52 |     function isVisible(el) {
 53 |       if (!el) return false;
 54 |       const style = window.getComputedStyle(el);
 55 |       if (!style) return false;
 56 |       if (style.display === "none" || style.visibility === "hidden") return false;
 57 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
 58 |       if (style.pointerEvents === "none") return false;
 59 |       const rect = el.getBoundingClientRect();
 60 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
 61 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
 62 |       return true;
 63 |     }
 64 | 
 65 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
 66 |     const root =
 67 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
 68 |     // (widok /watch/ jest traktowany jak video)
 69 | 
 70 |     const buttons = Array.from(
 71 |       root.querySelectorAll(
 72 |         "button, a, div[role='button'], span[role='button']"
 73 |       )
 74 |     );
 75 | 
 76 |     function classifyButton(raw) {
 77 |       const text = raw.toLowerCase();
 78 |       const hasCommentWord =
 79 |         text.includes("komentarz") ||
 80 |         text.includes("comments") ||
 81 |         text.includes("comment");
 82 |       const hasReplyWord =
 83 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
 84 |         text.includes("reply") ||
 85 |         text.includes("replies") ||
 86 |         text.includes("repl");
 87 |       const hasMoreWord =
 88 |         text.includes("wy≈õwietl") ||
 89 |         text.includes("zobacz") ||
 90 |         text.includes("poka≈º") ||
 91 |         text.includes("view") ||
 92 |         text.includes("show") ||
 93 |         text.includes("see") ||
 94 |         text.includes("wszystkie") ||
 95 |         text.includes("all") ||
 96 |         text.includes("previous");
 97 |       const hasTranslationWord =
 98 |         text.includes("t≈Çumaczenie") || text.includes("translation");
 99 |       if (hasTranslationWord) return null;
100 |       if (
101 |         text === "komentarz" ||
102 |         text === "comment" ||
103 |         text === "lubiƒô to" ||
104 |         text === "lubiƒô to!" ||
105 |         text === "like" ||
106 |         text === "odpowiedz" ||
107 |         text === "reply"
108 |       ) {
109 |         return null;
110 |       }
111 |       if (
112 |         hasCommentWord &&
113 |         hasMoreWord &&
114 |         (text.includes("wiƒôcej") ||
115 |           text.includes("more") ||
116 |           text.includes("poprzednie") ||
117 |           text.includes("previous"))
118 |       ) {
119 |         return { kind: "more-comments", priority: 3 };
120 |       }
121 | 
122 |       // ‚úÖ ON/OFF odpowiedzi
123 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
124 |         return { kind: "more-replies", priority: 2 };
125 |       }
126 | 
127 |       if (
128 |         text === "zobacz wiƒôcej" ||
129 |         text === "see more" ||
130 |         text.startsWith("zobacz wiƒôcej ") ||
131 |         text.startsWith("see more ")
132 |       ) {
133 |         return { kind: "see-more-text", priority: 1 };
134 |       }
135 |       return null;
136 |     }
137 | 
138 |     const candidates = [];
139 | 
140 |     for (const el of buttons) {
141 |       if (!isVisible(el)) continue;
142 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
143 |       if (!raw) continue;
144 |       const cls = classifyButton(raw);
145 |       if (!cls) continue;
146 |       const rect = el.getBoundingClientRect();
147 |       candidates.push({
148 |         el,
149 |         kind: cls.kind,
150 |         priority: cls.priority,
151 |         top: rect.top,
152 |         text: raw,
153 |       });
154 |     }
155 | 
156 |     if (!candidates.length) {
157 |       return { clicked: false };
158 |     }
159 | 
160 |     candidates.sort((a, b) => {
161 |       if (a.priority !== b.priority) return b.priority - a.priority;
162 |       return a.top - b.top;
163 |     });
164 | 
165 |     const chosen = candidates[0];
166 |     try {
167 |       chosen.el.click();
168 |       return {
169 |         clicked: true,
170 |         kind: chosen.kind,
171 |         text: chosen.text,
172 |       };
173 |     } catch (e) {
174 |       return { clicked: false };
175 |     }
176 |   }, INCLUDE_REPLIES);
177 | 
178 |   if (res && res.clicked) {
179 |     log.debug("EXPAND", `Klik '${res.text}' (${res.kind})`);
180 |     // Human behavior: op√≥≈∫nienie po klikniƒôciu (czekaj na reakcjƒô UI)
181 |     await humanDelay(400, 0.3);
182 |   }
183 |   return !!(res && res.clicked);
184 | }
185 | 
186 | export { clickOneExpandButton };
187 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/legacy/comments.legacy.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
   1 | // src/fb/comments.js
   2 | // src/fb/legacy/comments.legacy.js
   3 | import { EXPAND_COMMENTS } from "../../config.js";
   4 | import { sleepRandom } from "../../utils/sleep.js";
   5 | import { safeGoto } from "../../utils/navigation.js";
   6 | 
   7 | import { scrollPost } from "../scroll.js";
   8 | import { acceptCookies, saveCookies } from "../cookies.js";
   9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  10 | import { clickOneExpandButton } from "../expandButtons.js";
  11 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  12 | 
  13 | 
  14 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
  15 |   ? Number(process.env.NAV_TIMEOUT_MS)
  16 |   : 90000; // by≈Ço 60000, podbijamy do 90s
  17 | 
  18 | let firstPostPauseDone = false;
  19 | /* ============================================================
  20 |    =======  PRZE≈ÅƒÑCZANIE FILTRA ‚ÄûWSZYSTKIE KOMENTARZE‚Äù  ========
  21 |    ============================================================ */
  22 | 
  23 | async function switchCommentsFilterToAll(page) {
  24 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
  25 | 
  26 |   // 1) je≈õli menu ju≈º jest otwarte ‚Äì nie klikamy ponownie, tylko pr√≥bujemy wybraƒá opcjƒô "Wszystkie komentarze" z istniejƒÖcego menu
  27 |   const menuAlreadyOpen = await page.evaluate(() => {
  28 |     return !!document.querySelector("div[role='menu']");
  29 |   });
  30 | 
  31 |   if (menuAlreadyOpen) {
  32 |     console.log("[FB][filter] Menu filtra ju≈º otwarte ‚Äì pr√≥bujƒô wybraƒá opcjƒô.");
  33 | 
  34 |     const menuResult = await clickAllCommentsInMenu(page);
  35 |     if (menuResult.clicked) {
  36 |       console.log("[FB][filter] Wybrano 'Wszystkie komentarze' z otwartego menu.");
  37 |       return true;
  38 |     }
  39 |     console.log("[FB][filter] Menu otwarte, ale nie ma opcji 'Wszystkie komentarze'.");
  40 |     return false;
  41 |   }
  42 | 
  43 |   // 2) spr√≥buj znale≈∫ƒá bie≈ºƒÖcy przycisk filtra i sprawdziƒá, co jest ustawione
  44 |   const pre = await page.evaluate(() => {
  45 |     const els = Array.from(
  46 |       document.querySelectorAll("div[role='button'], span[role='button']")
  47 |     );
  48 |     let filterEl = null;
  49 |     let labelText = "";
  50 |     for (const el of els) {
  51 |       const t = (el.textContent || "").trim();
  52 |       if (!t) continue;
  53 |       const low = t.toLowerCase();
  54 |       if (
  55 |         low === "najtrafniejsze" ||
  56 |         low === "most relevant" ||
  57 |         low === "wszystkie komentarze" ||
  58 |         low === "all comments"
  59 |       ) {
  60 |         filterEl = el;
  61 |         labelText = low;
  62 |         break;
  63 |       }
  64 |     }
  65 |     if (!filterEl) {
  66 |       return { state: "not-found" };
  67 |     }
  68 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
  69 |       return { state: "already-all" };
  70 |     }
  71 |     filterEl.click();
  72 |     return { state: "clicked-filter" };
  73 |   });
  74 | 
  75 |   if (pre.state === "not-found") {
  76 |     console.log("[FB][filter] Nie znaleziono przycisku filtra komentarzy.");
  77 |     return false;
  78 |   }
  79 |   if (pre.state === "already-all") {
  80 |     console.log("[FB][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' ‚Äì pomijam.");
  81 |     return true;
  82 |   }
  83 |   if (pre.state === "clicked-filter") {
  84 |     await sleepRandom(400, 800);
  85 |     const menuResult = await clickAllCommentsInMenu(page);
  86 |     if (!menuResult.clicked && menuResult.noMenu) {
  87 |       // fallback: mo≈ºe filtr prze≈ÇƒÖcza siƒô bez menu ‚Äì sprawdzamy label jeszcze raz
  88 |       const afterLabelIsAll = await page.evaluate(() => {
  89 |         const els = Array.from(
  90 |           document.querySelectorAll("div[role='button'], span[role='button']")
  91 |         );
  92 |         const btn = els.find((el) => {
  93 |           const t = (el.textContent || "").trim().toLowerCase();
  94 |           return t === "wszystkie komentarze" || t === "all comments";
  95 |         });
  96 |         return !!btn;
  97 |       });
  98 |       if (afterLabelIsAll) {
  99 |         console.log(
 100 |           "[FB][filter] Po klikniƒôciu filtr prze≈ÇƒÖczy≈Ç siƒô bez menu na 'Wszystkie komentarze'."
 101 |         );
 102 |         return true;
 103 |       }
 104 |       console.log(
 105 |         "[FB][filter] Klikniƒôto filtr, ale nie pojawi≈Ço siƒô menu i label nie jest 'Wszystkie komentarze'."
 106 |       );
 107 |       return false;
 108 |     }
 109 |     if (!menuResult.clicked && !menuResult.noMenu) {
 110 |       console.log("[FB][filter] Menu filtra jest, ale brak opcji 'Wszystkie komentarze'.");
 111 |       return false;
 112 |     }
 113 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze'.");
 114 |     return true;
 115 |   }
 116 |   console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);
 117 |   return false;
 118 | }
 119 | 
 120 | async function clickShowAllCommentsIfPresent(page) {
 121 |   console.log("[FB][show-all] Pr√≥ba klikniƒôcia 'Poka≈º wszystkie' (aria-label)‚Ä¶");
 122 | 
 123 |   try {
 124 |     const clicked = await page.evaluate(() => {
 125 |       // Je≈õli filtr ju≈º jest, to znaczy ≈ºe "Poka≈º wszystkie" zosta≈Ço klikniƒôte / niepotrzebne
 126 |       const bodyText = (document.body.innerText || "").toLowerCase();
 127 |       if (
 128 |         bodyText.includes("najtrafniejsze") ||
 129 |         bodyText.includes("najnowsze") ||
 130 |         bodyText.includes("wszystkie komentarze") ||
 131 |         bodyText.includes("all comments") ||
 132 |         bodyText.includes("ukryj komentarze") ||
 133 |         bodyText.includes("hide comments")
 134 |       ) {
 135 |         return false;
 136 |       }
 137 |       const selectors = [
 138 |         "div[aria-label='Poka≈º wszystkie'][role='button']",
 139 |         "div[aria-label='Wy≈õwietl wszystkie'][role='button']",
 140 |         "div[aria-label='Show all'][role='button']",
 141 |         "div[aria-label='View all'][role='button']",
 142 |       ];
 143 |       let el = null;
 144 |       for (const sel of selectors) {
 145 |         el = document.querySelector(sel);
 146 |         if (el) break;
 147 |       }
 148 |       if (!el) return false;
 149 |       try {
 150 |         el.scrollIntoView({ block: "center", inline: "nearest" });
 151 |       } catch (e) {
 152 |         // scrollIntoView nie musi siƒô udaƒá
 153 |       }
 154 |       if (typeof el.click === "function") {
 155 |         el.click();
 156 |         return true;
 157 |       }
 158 |       return false;
 159 |     });
 160 |     if (!clicked) {
 161 |       console.log(
 162 |         "[FB][show-all] Nie znaleziono aria-label='Poka≈º wszystkie' albo filtr ju≈º widoczny ‚Äì pomijam."
 163 |       );
 164 |       return false;
 165 |     }
 166 |     console.log("[FB][show-all] Klikniƒôto 'Poka≈º wszystkie' (aria-label).");
 167 |     await sleepRandom(900, 1600);
 168 |     return true;
 169 |   } catch (err) {
 170 |     console.log(
 171 |       "[FB][show-all] B≈ÇƒÖd podczas klikania 'Poka≈º wszystkie':",
 172 |       err?.message || err
 173 |     );
 174 |     return false;
 175 |   }
 176 | }
 177 | import fs from 'fs';
 178 | 
 179 | async function extractCommentsFromDOM(page) {
 180 |   const data = await page.evaluate(() => {
 181 |     function extractCommentId(url) {
 182 |       const match = url?.match(/comment_id=([^&]+)/);
 183 |       return match ? decodeURIComponent(match[1]) : null;
 184 |     }
 185 | 
 186 |     // Mapa commentId -> time
 187 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 188 |     const idToTimeMap = {};
 189 | 
 190 |     for (let i = 0; i < allLinks.length; i++) {
 191 |       const link = allLinks[i];
 192 |       const href = link.getAttribute('href') || '';
 193 |       const id = extractCommentId(href);
 194 | 
 195 |       if (id) {
 196 |         // Szukamy nastƒôpnego linka z tekstem typu "1 godz.", "2 dni" itd.
 197 |         for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
 198 |           const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
 199 |           if (timeText && /^\d+\s?(min|godz|sek|dni|tyg)/.test(timeText)) {
 200 |             idToTimeMap[id] = timeText;
 201 |             break;
 202 |           }
 203 |         }
 204 |       }
 205 |     }
 206 | 
 207 |     const commentNodes = Array.from(
 208 |       document.querySelectorAll('div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k')
 209 |     );
 210 | 
 211 |     const extracted = commentNodes.map((node) => {
 212 |       try {
 213 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim();
 214 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim();
 215 |         const linkEl = node.querySelector('a[role="link"]');
 216 |         const href = linkEl?.getAttribute('href');
 217 |         const permalink = href?.startsWith('http') ? href : `https://www.facebook.com${href}`;
 218 |         const id = extractCommentId(permalink) || null;
 219 | 
 220 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
 221 | 
 222 |         if (!author || !text) return null;
 223 | 
 224 |         return { id, author, text, permalink, time };
 225 |       } catch (err) {
 226 |         return null;
 227 |       }
 228 |     }).filter(Boolean);
 229 | 
 230 |     return extracted;
 231 |   });
 232 | 
 233 |   console.log('[FB] extractCommentsFromDOM ‚Äì wyciƒÖgniƒôto komentarzy:', data.length);
 234 |   console.log('[DBG] Komentarze:', JSON.stringify(data, null, 2));
 235 | 
 236 |   return data;
 237 | }
 238 | 
 239 | 
 240 | 
 241 | 
 242 | /* ============================================================
 243 |    =========== POST ROOT (DIALOG / MAIN / FALLBACK) ============
 244 |    ============================================================ */
 245 | 
 246 | async function clickAllCommentsInMenu(page) {
 247 |   const result = await page.evaluate(() => {
 248 |     const menu =
 249 |       document.querySelector("div[role='menu']") ||
 250 |       document.querySelector("div[role='dialog']");
 251 |     if (!menu) {
 252 |       return { clicked: false, noMenu: true };
 253 |     }
 254 |     const items = Array.from(
 255 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 256 |     );
 257 |     const opt = items.find((el) => {
 258 |       const t = (el.textContent || "").trim().toLowerCase();
 259 |       return (
 260 |         t.startsWith("wszystkie komentarze") ||
 261 |         t.startsWith("all comments")
 262 |       );
 263 |     });
 264 |     if (!opt) {
 265 |       return { clicked: false, noMenu: false };
 266 |     }
 267 |     opt.click();
 268 |     setTimeout(() => {
 269 |       try {
 270 |         document.body.click();
 271 |       } catch {}
 272 |     }, 50);
 273 |     return { clicked: true, noMenu: false };
 274 |   });
 275 |   if (result.clicked) {
 276 |     await sleepRandom(300, 600);
 277 |     await page
 278 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 279 |         timeout: 2000,
 280 |       })
 281 |       .catch(() => {});
 282 |   }
 283 |   return result;
 284 | }
 285 | 
 286 | /* ============================================================
 287 |    ===== POMOCNICZE: LICZENIE ID KOMENTARZY ====================
 288 |    ============================================================ */
 289 | 
 290 | function postRootScript() {
 291 |   return `
 292 |     function getPostRoot() {
 293 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 294 |       const postDialog = dialogs.find((dlg) => {
 295 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 296 |         if (!text) return false;
 297 |         const hasCommentWord =
 298 |           text.includes("komentarz") || text.includes("comment");
 299 |         const hasActions =
 300 |           text.includes("lubiƒô to") ||
 301 |           text.includes("komentarz") ||
 302 |           text.includes("udostƒôpnij") ||
 303 |           text.includes("napisz komentarz") ||
 304 |           text.includes("comment");
 305 |         const looksLikeNotifications =
 306 |           text.startsWith("powiadomienia") &&
 307 |           text.includes("wszystkie") &&
 308 |           text.includes("nieprzeczytane");
 309 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 310 |       });
 311 |       if (postDialog) return postDialog;
 312 |       const main = document.querySelector("div[role='main']");
 313 |       if (main) {
 314 |         const article = main.querySelector("article");
 315 |         return article || main;
 316 |       }
 317 |       return document.body;
 318 |     }
 319 |   `;
 320 | }
 321 | 
 322 | async function getCurrentCommentAnchorCount(page) {
 323 |   const count = await page.evaluate(() => {
 324 |     const anchors = Array.from(
 325 |       document.querySelectorAll(
 326 |         "a[href*='comment_id'], a[href*='reply_comment_id']"
 327 |       )
 328 |     );
 329 |     const ids = new Set();
 330 |     for (const a of anchors) {
 331 |       try {
 332 |         const url = new URL(a.href);
 333 |         const cid = url.searchParams.get("comment_id");
 334 |         const rid = url.searchParams.get("reply_comment_id");
 335 |         let raw = rid || cid;
 336 |         if (!raw) continue;
 337 |         if (!/^\d+$/.test(raw)) {
 338 |           try {
 339 |             const dec = atob(raw);
 340 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 341 |             if (m) raw = m[2];
 342 |           } catch {}
 343 |         }
 344 |         if (raw) ids.add(raw);
 345 |       } catch {}
 346 |     }
 347 |     return ids.size;
 348 |   });
 349 |   return count || 0;
 350 | }
 351 | 
 352 | /* ============================================================
 353 |    ======= SCROLL W OBRƒòBIE POSTA (DIALOG/MAIN/FALLBACK) =======
 354 |    ============================================================ */
 355 | 
 356 | async function scrollWithinPost(page, label, factor = 0.3) {
 357 |   const info = await page.evaluate(
 358 |     (factorArg, labelArg, postRootCode) => {
 359 |       const href = location.href;
 360 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 361 |         href
 362 |       );
 363 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 364 |       // wstrzykujemy funkcjƒô getPostRoot
 365 |       // eslint-disable-next-line no-eval
 366 |       eval(postRootCode);
 367 |       // @ts-ignore
 368 |       const rootFn =
 369 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 370 |       function pushIfScrollable(list, el, labelName) {
 371 |         if (!el) return;
 372 |         const style = window.getComputedStyle(el);
 373 |         if (!style) return;
 374 |         const oy = style.overflowY;
 375 |         const clientH = el.clientHeight || 0;
 376 |         const scrollH = el.scrollHeight || 0;
 377 |         const delta = scrollH - clientH;
 378 |         if (
 379 |           clientH > 0 &&
 380 |           delta > 10 &&
 381 |           (oy === "auto" ||
 382 |             oy === "scroll" ||
 383 |             oy === "overlay" ||
 384 |             oy === "hidden")
 385 |         ) {
 386 |           list.push({ el, label: labelName, delta });
 387 |         }
 388 |       }
 389 |       let container = null;
 390 |       let containerType = null;
 391 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 392 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 393 |       if (cached) {
 394 |         container = cached;
 395 |         containerType = "cached-comments";
 396 |       }
 397 |       // ===== PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy "oficjalny" panel komentarzy =====
 398 |       if (!container && (isPhotoView || isVideoView)) {
 399 |         const moreCommentsBtn = Array.from(
 400 |           document.querySelectorAll(
 401 |             "button, div[role='button'], span[role='button']"
 402 |           )
 403 |         ).find((el) => {
 404 |           const t = (el.textContent || "").toLowerCase();
 405 |           return (
 406 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 407 |             t.includes("zobacz wiƒôcej komentarzy") ||
 408 |             t.includes("view more comments") ||
 409 |             t.includes("view previous comments")
 410 |           );
 411 |         });
 412 |         if (moreCommentsBtn) {
 413 |           let p = moreCommentsBtn.parentElement;
 414 |           while (p && p !== document.body && p !== document.documentElement) {
 415 |             const style = window.getComputedStyle(p);
 416 |             const oy = style.overflowY;
 417 |             const ch = p.clientHeight || 0;
 418 |             const sh = p.scrollHeight || 0;
 419 |             const delta = sh - ch;
 420 |             if (
 421 |               ch > 0 &&
 422 |               delta > 10 &&
 423 |               (oy === "auto" ||
 424 |                 oy === "scroll" ||
 425 |                 oy === "overlay" ||
 426 |                 oy === "hidden")
 427 |             ) {
 428 |               container = p;
 429 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 430 |               break;
 431 |             }
 432 |             p = p.parentElement;
 433 |           }
 434 |         }
 435 |         // VIDEO ‚Äì dodatkowa pr√≥ba: po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 436 |         if (!container && isVideoView) {
 437 |           const commentsHeader = Array.from(
 438 |             document.querySelectorAll("div, span")
 439 |           ).find((el) => {
 440 |             const t = (el.textContent || "").toLowerCase();
 441 |             return (
 442 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 443 |               (t.includes("comments") && t.includes("most relevant")) ||
 444 |               t.trim() === "komentarze" ||
 445 |               t.trim() === "comments"
 446 |             );
 447 |           });
 448 |           if (commentsHeader) {
 449 |             let p = commentsHeader.parentElement;
 450 |             while (p && p !== document.body && p !== document.documentElement) {
 451 |               const style = window.getComputedStyle(p);
 452 |               const oy = style.overflowY;
 453 |               const ch = p.clientHeight || 0;
 454 |               const sh = p.scrollHeight || 0;
 455 |               const delta = sh - ch;
 456 |               if (
 457 |                 ch > 0 &&
 458 |                 delta > 10 &&
 459 |                 (oy === "auto" ||
 460 |                   oy === "scroll" ||
 461 |                   oy === "overlay" ||
 462 |                   oy === "hidden")
 463 |               ) {
 464 |                 container = p;
 465 |                 containerType = "video-comments-header";
 466 |                 break;
 467 |               }
 468 |               p = p.parentElement;
 469 |             }
 470 |           }
 471 |         }
 472 |         // dodatkowy fallback na VIDEO ‚Äì po polu "Napisz komentarz..."
 473 |         if (!container && isVideoView) {
 474 |           const commentBox = Array.from(
 475 |             document.querySelectorAll("div[role='textbox'], textarea")
 476 |           ).find((el) => {
 477 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 478 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 479 |             const txt = (el.textContent || "").toLowerCase();
 480 |             const needles = [
 481 |               "napisz komentarz",
 482 |               "write a comment",
 483 |               "escribe un comentario",
 484 |               "schreibe einen kommentar",
 485 |             ];
 486 |             return needles.some((n) =>
 487 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 488 |             );
 489 |           });
 490 |           if (commentBox) {
 491 |             let p = commentBox.parentElement;
 492 |             while (p && p !== document.body && p !== document.documentElement) {
 493 |               const style = window.getComputedStyle(p);
 494 |               const oy = style.overflowY;
 495 |               const ch = p.clientHeight || 0;
 496 |               const sh = p.scrollHeight || 0;
 497 |               const delta = sh - ch;
 498 |               if (
 499 |                 ch > 0 &&
 500 |                 delta > 10 &&
 501 |                 (oy === "auto" ||
 502 |                   oy === "scroll" ||
 503 |                   oy === "overlay" ||
 504 |                   oy === "hidden")
 505 |               ) {
 506 |                 container = p;
 507 |                 containerType = "video-comments-textbox";
 508 |                 break;
 509 |               }
 510 |               p = p.parentElement;
 511 |             }
 512 |           }
 513 |         }
 514 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì nie ruszamy okna
 515 |         if (isVideoView && !container) {
 516 |           const cur = window.scrollY || 0;
 517 |           return {
 518 |             before: cur,
 519 |             after: cur,
 520 |             container: "video-no-scroll",
 521 |             label: labelArg,
 522 |           };
 523 |         }
 524 |       }
 525 |       // ===== Standardowa heurystyka (permalink / photo fallback) =====
 526 |       if (!container) {
 527 |         const root = rootFn() || document.body;
 528 |         const candidates = [];
 529 |         pushIfScrollable(candidates, root, "root");
 530 |         const dialog =
 531 |           root.closest("div[role='dialog']") ||
 532 |           document.querySelector("div[role='dialog']");
 533 |         if (dialog) {
 534 |           pushIfScrollable(candidates, dialog, "dialog");
 535 |         }
 536 |         const scope = dialog || root;
 537 |         const blocks = Array.from(
 538 |           scope.querySelectorAll("div, section, main, article")
 539 |         );
 540 |         for (const el of blocks) {
 541 |           pushIfScrollable(candidates, el, "auto");
 542 |         }
 543 |         let best = null;
 544 |         for (const c of candidates) {
 545 |           if (!best || c.delta > best.delta) best = c;
 546 |         }
 547 |         if (best) {
 548 |           container = best.el;
 549 |           containerType = best.label;
 550 |         } else {
 551 |           container =
 552 |             document.scrollingElement ||
 553 |             document.documentElement ||
 554 |             document.body;
 555 |           const delta =
 556 |             (container.scrollHeight || 0) - (container.clientHeight || 0);
 557 |           if (delta <= 0) {
 558 |             const cur = container.scrollTop || window.scrollY || 0;
 559 |             return {
 560 |               before: cur,
 561 |               after: cur,
 562 |               container: "window-no-scroll",
 563 |               label: labelArg,
 564 |             };
 565 |           }
 566 |           containerType = "window";
 567 |         }
 568 |       }
 569 |       // Zapamiƒôtujemy kontener komentarzy (≈ºeby kolejne wywo≈Çania go u≈ºy≈Çy)
 570 |       if (container) {
 571 |         const isRootContainer =
 572 |           container === document.body ||
 573 |           container === document.documentElement ||
 574 |           container === document.scrollingElement;
 575 |         if (!isRootContainer) {
 576 |           try {
 577 |             container.setAttribute("data-fbwatcher-comments", "1");
 578 |           } catch {}
 579 |         }
 580 |       }
 581 |       const isWindowContainer =
 582 |         container === document.body ||
 583 |         container === document.documentElement ||
 584 |         container === document.scrollingElement;
 585 |       // na watch nie scrollujemy okna, tylko panel komentarzy
 586 |       if (isVideoView && isWindowContainer) {
 587 |         const cur = window.scrollY || 0;
 588 |         return {
 589 |           before: cur,
 590 |           after: cur,
 591 |           container: "video-window-blocked",
 592 |           label: labelArg,
 593 |         };
 594 |       }
 595 |       const before = isWindowContainer
 596 |         ? window.scrollY || 0
 597 |         : container.scrollTop || 0;
 598 |       const maxScroll =
 599 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 600 |       if (maxScroll <= 0) {
 601 |         return {
 602 |           before,
 603 |           after: before,
 604 |           container: (containerType || "unknown") + "-no-scroll",
 605 |           label: labelArg,
 606 |         };
 607 |       }
 608 |       const factor = factorArg || 0.3;
 609 |       const sign = factor < 0 ? -1 : 1;
 610 |       const magnitude = Math.min(Math.abs(factor), 1);
 611 |       const baseStep =
 612 |         (container.clientHeight || window.innerHeight || 600) * magnitude;
 613 |       // na VIDEO robimy mniejszy krok, ≈ºeby nie przeskakiwaƒá przycisk√≥w
 614 |       let step = Math.max(30, Math.min(baseStep, isVideoView ? 180 : 220));
 615 |       let target;
 616 |       if (sign < 0) {
 617 |         target = Math.max(0, before - step);
 618 |       } else {
 619 |         target = Math.min(maxScroll, before + step);
 620 |       }
 621 |       if (isWindowContainer) {
 622 |         window.scrollTo(0, target);
 623 |       } else {
 624 |         container.scrollTop = target;
 625 |       }
 626 |       const after = isWindowContainer
 627 |         ? window.scrollY || 0
 628 |         : container.scrollTop || 0;
 629 |       return {
 630 |         before,
 631 |         after,
 632 |         container: containerType || "unknown",
 633 |         label: labelArg,
 634 |       };
 635 |     },
 636 |     factor,
 637 |     label,
 638 |     postRootScript()
 639 |   );
 640 |   return info;
 641 | }
 642 | 
 643 | /* ============================================================
 644 |    ======= DOCIƒÑGNIƒòCIE DO ABSOLUTNEGO DO≈ÅU KOMENTARZY =========
 645 |    ============================================================ */
 646 | 
 647 | async function scrollToAbsoluteBottom(page, label = "bottom") {
 648 |   const info = await page.evaluate(
 649 |     (labelArg, postRootCode) => {
 650 |       const href = location.href;
 651 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 652 |         href
 653 |       );
 654 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 655 |       // wstrzykujemy funkcjƒô getPostRoot
 656 |       // eslint-disable-next-line no-eval
 657 |       eval(postRootCode);
 658 |       // @ts-ignore
 659 |       const rootFn =
 660 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 661 |       function pushIfScrollable(list, el, labelName) {
 662 |         if (!el) return;
 663 |         const style = window.getComputedStyle(el);
 664 |         if (!style) return;
 665 |         const oy = style.overflowY;
 666 |         const clientH = el.clientHeight || 0;
 667 |         const scrollH = el.scrollHeight || 0;
 668 |         const delta = scrollH - clientH;
 669 |         if (
 670 |           clientH > 0 &&
 671 |           delta > 10 &&
 672 |           (oy === "auto" ||
 673 |             oy === "scroll" ||
 674 |             oy === "overlay" ||
 675 |             oy === "hidden")
 676 |         ) {
 677 |           list.push({ el, label: labelName, delta });
 678 |         }
 679 |       }
 680 |       let container = null;
 681 |       let containerType = null;
 682 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 683 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 684 |       if (cached) {
 685 |         container = cached;
 686 |         containerType = "cached-comments";
 687 |       }
 688 |       // PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy znale≈∫ƒá panel komentarzy
 689 |       if (!container && (isPhotoView || isVideoView)) {
 690 |         const moreCommentsBtn = Array.from(
 691 |           document.querySelectorAll(
 692 |             "button, div[role='button'], span[role='button']"
 693 |           )
 694 |         ).find((el) => {
 695 |           const t = (el.textContent || "").toLowerCase();
 696 |           return (
 697 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 698 |             t.includes("zobacz wiƒôcej komentarzy") ||
 699 |             t.includes("view more comments") ||
 700 |             t.includes("view previous comments")
 701 |           );
 702 |         });
 703 |         if (moreCommentsBtn) {
 704 |           let p = moreCommentsBtn.parentElement;
 705 |           while (p && p !== document.body && p !== document.documentElement) {
 706 |             const style = window.getComputedStyle(p);
 707 |             const oy = style.overflowY;
 708 |             const ch = p.clientHeight || 0;
 709 |             const sh = p.scrollHeight || 0;
 710 |             const delta = sh - ch;
 711 |             if (
 712 |               ch > 0 &&
 713 |               delta > 10 &&
 714 |               (oy === "auto" || oy === "scroll" || oy === "overlay" || oy === "hidden")
 715 |             ) {
 716 |               container = p;
 717 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 718 |               break;
 719 |             }
 720 |             p = p.parentElement;
 721 |           }
 722 |         }
 723 |         // dodatkowa pr√≥ba po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 724 |         if (!container && isVideoView) {
 725 |           const commentsHeader = Array.from(
 726 |             document.querySelectorAll("div, span")
 727 |           ).find((el) => {
 728 |             const t = (el.textContent || "").toLowerCase();
 729 |             return (
 730 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 731 |               (t.includes("comments") && t.includes("most relevant")) ||
 732 |               t.trim() === "komentarze" ||
 733 |               t.trim() === "comments"
 734 |             );
 735 |           });
 736 |           if (commentsHeader) {
 737 |             let p = commentsHeader.parentElement;
 738 |             while (p && p !== document.body && p !== document.documentElement) {
 739 |               const style = window.getComputedStyle(p);
 740 |               const oy = style.overflowY;
 741 |               const ch = p.clientHeight || 0;
 742 |               const sh = p.scrollHeight || 0;
 743 |               const delta = sh - ch;
 744 |               if (
 745 |                 ch > 0 &&
 746 |                 delta > 10 &&
 747 |                 (oy === "auto" ||
 748 |                   oy === "scroll" ||
 749 |                   oy === "overlay" ||
 750 |                   oy === "hidden")
 751 |               ) {
 752 |                 container = p;
 753 |                 containerType = "video-comments-header";
 754 |                 break;
 755 |               }
 756 |               p = p.parentElement;
 757 |             }
 758 |           }
 759 |         }
 760 |         // NOWY FALLBACK ‚Äì po polu "Napisz komentarz..."
 761 |         if (!container) {
 762 |           const commentBox = Array.from(
 763 |             document.querySelectorAll("div[role='textbox'], textarea")
 764 |           ).find((el) => {
 765 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 766 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 767 |             const txt = (el.textContent || "").toLowerCase();
 768 |             const needles = [
 769 |               "napisz komentarz",
 770 |               "write a comment",
 771 |               "escribe un comentario",
 772 |               "schreibe einen kommentar",
 773 |             ];
 774 |             return needles.some((n) =>
 775 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 776 |             );
 777 |           });
 778 |           if (commentBox) {
 779 |             let p = commentBox.parentElement;
 780 |             while (p && p !== document.body && p !== document.documentElement) {
 781 |               const style = window.getComputedStyle(p);
 782 |               const oy = style.overflowY;
 783 |               const ch = p.clientHeight || 0;
 784 |               const sh = p.scrollHeight || 0;
 785 |               const delta = sh - ch;
 786 |               if (
 787 |                 ch > 0 &&
 788 |                 delta > 10 &&
 789 |                 (oy === "auto" ||
 790 |                   oy === "scroll" ||
 791 |                   oy === "overlay" ||
 792 |                   oy === "hidden")
 793 |               ) {
 794 |                 container = p;
 795 |                 containerType = isPhotoView
 796 |                   ? "photo-comments-textbox"
 797 |                   : "video-comments-textbox";
 798 |                 break;
 799 |               }
 800 |               p = p.parentElement;
 801 |             }
 802 |           }
 803 |         }
 804 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì dajemy spok√≥j
 805 |         if (isVideoView && !container) {
 806 |           const cur = window.scrollY || 0;
 807 |           return {
 808 |             label: labelArg,
 809 |             container: "video-no-scroll",
 810 |             steps: 0,
 811 |             final: cur,
 812 |             maxScroll: 0,
 813 |             atBottom: true,
 814 |           };
 815 |         }
 816 |       }
 817 |       // Standardowa heurystyka (permalink / photo fallback)
 818 |       if (!container) {
 819 |         const root = rootFn() || document.body;
 820 |         const candidates = [];
 821 |         pushIfScrollable(candidates, root, "root");
 822 |         const dialog =
 823 |           root.closest("div[role='dialog']") ||
 824 |           document.querySelector("div[role='dialog']");
 825 |         if (dialog) {
 826 |           pushIfScrollable(candidates, dialog, "dialog");
 827 |         }
 828 |         const scope = dialog || root;
 829 |         const blocks = Array.from(
 830 |           scope.querySelectorAll("div, section, main, article")
 831 |         );
 832 |         for (const el of blocks) {
 833 |           pushIfScrollable(candidates, el, "auto");
 834 |         }
 835 |         let best = null;
 836 |         for (const c of candidates) {
 837 |           if (!best || c.delta > best.delta) {
 838 |             best = c;
 839 |           }
 840 |         }
 841 |         if (best) {
 842 |           container = best.el;
 843 |           containerType = best.label;
 844 |         } else {
 845 |           container =
 846 |             document.scrollingElement ||
 847 |             document.documentElement ||
 848 |             document.body;
 849 |           containerType = "window";
 850 |         }
 851 |       }
 852 |       // Zapamiƒôtaj kontener komentarzy (je≈õli to nie jest globalne okno)
 853 |       if (container) {
 854 |         const isRootContainer =
 855 |           container === document.body ||
 856 |           container === document.documentElement ||
 857 |           container === document.scrollingElement;
 858 |         if (!isRootContainer) {
 859 |           try {
 860 |             container.setAttribute("data-fbwatcher-comments", "1");
 861 |           } catch {}
 862 |         }
 863 |       }
 864 |       const isWindowContainer =
 865 |         container === document.body ||
 866 |         container === document.documentElement ||
 867 |         container === document.scrollingElement;
 868 |       // na watch nie ruszamy globalnego scrolla je≈õli nie mamy innego kontenera
 869 |       if (isVideoView && isWindowContainer) {
 870 |         const cur = window.scrollY || 0;
 871 |         return {
 872 |           label: labelArg,
 873 |           container: "video-window-blocked",
 874 |           steps: 0,
 875 |           final: cur,
 876 |           maxScroll: 0,
 877 |           atBottom: true,
 878 |         };
 879 |       }
 880 |       let steps = 0;
 881 |       const maxSteps = 160;
 882 |       let lastPos = isWindowContainer
 883 |         ? window.scrollY || 0
 884 |         : container.scrollTop || 0;
 885 |       while (steps < maxSteps) {
 886 |         steps++;
 887 |         const maxScroll =
 888 |           (container.scrollHeight || 0) - (container.clientHeight || 0);
 889 |         const pos = isWindowContainer
 890 |           ? window.scrollY || 0
 891 |           : container.scrollTop || 0;
 892 |         // ju≈º na dole
 893 |         if (maxScroll <= 0 || pos >= maxScroll - 2) {
 894 |           return {
 895 |             label: labelArg,
 896 |             container: containerType || "unknown",
 897 |             steps,
 898 |             final: pos,
 899 |             maxScroll,
 900 |             atBottom: true,
 901 |           };
 902 |         }
 903 |         const baseStep =
 904 |           (container.clientHeight || window.innerHeight || 600) * 0.9;
 905 |         const step = Math.max(60, Math.min(baseStep, maxScroll - pos));
 906 |         if (isWindowContainer) {
 907 |           window.scrollTo(0, pos + step);
 908 |         } else {
 909 |           container.scrollTop = pos + step;
 910 |         }
 911 |         const afterPos = isWindowContainer
 912 |           ? window.scrollY || 0
 913 |           : container.scrollTop || 0;
 914 |         // brak ruchu mimo pr√≥by ‚Äì uznajemy ≈ºe jeste≈õmy na dole
 915 |         if (afterPos === lastPos) {
 916 |           return {
 917 |             label: labelArg,
 918 |             container: containerType || "unknown",
 919 |             steps,
 920 |             final: afterPos,
 921 |             maxScroll,
 922 |             atBottom: true,
 923 |           };
 924 |         }
 925 |         lastPos = afterPos;
 926 |       }
 927 |       const maxScrollFinal =
 928 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 929 |       const finalPos = isWindowContainer
 930 |         ? window.scrollY || 0
 931 |         : container.scrollTop || 0;
 932 |       return {
 933 |         label: labelArg,
 934 |         container: containerType || "unknown",
 935 |         steps,
 936 |         final: finalPos,
 937 |         maxScroll: maxScrollFinal,
 938 |         atBottom: finalPos >= maxScrollFinal - 2,
 939 |       };
 940 |     },
 941 |     label,
 942 |     postRootScript()
 943 |   );
 944 |   return info;
 945 | }
 946 | 
 947 | /* ============================================================
 948 |    ===================== VIDEO ‚Äì AUTO PAUSE ====================
 949 |    ============================================================ */
 950 | 
 951 | async function pauseVideoIfAny(page) {
 952 |   try {
 953 |     await page.evaluate(() => {
 954 |       const vids = Array.from(document.querySelectorAll("video"));
 955 |       for (const v of vids) {
 956 |         try {
 957 |           v.autoplay = false;
 958 |           v.removeAttribute("autoplay");
 959 |           v.muted = true;
 960 |           v.pause();
 961 |           if (!isNaN(v.currentTime) && v.currentTime === 0) {
 962 |             v.currentTime = 0.01;
 963 |           }
 964 |         } catch (e) {}
 965 |       }
 966 |     });
 967 |     console.log("[FB] Video pause: zatrzymano wszystkie <video>.");
 968 |   } catch (e) {
 969 |     console.log("[FB] Video pause ‚Äì b≈ÇƒÖd:", e?.message || e);
 970 |   }
 971 | }
 972 | 
 973 | /* ============================================================
 974 |    ======= BRUTALNA DO≈ªYNKA ‚Äì LOAD MORE NA DOLE ================
 975 |    ============================================================ */
 976 | 
 977 | async function clickAllLoadMoreAtBottom(page, view, maxClicks = 300) {
 978 |   // Brutalna do≈ºynka na dole ‚Äì bez scrolla, tylko to, co widaƒá
 979 |   return await page.evaluate(({ isVideo, max }) => {
 980 |     function normalize(text) {
 981 |       return (text || "").toLowerCase().replace(/\s+/g, " ").trim();
 982 |     }
 983 |     function findCommentsRoot() {
 984 |       // Dla watch/reel FB czƒôsto siedzi w g≈Ç√≥wnej kolumnie
 985 |       const main = document.querySelector("div[role='main']");
 986 |       if (!main) return document.body;
 987 |       const article = main.querySelector("article");
 988 |       if (article) return article;
 989 |       return main;
 990 |     }
 991 |     const root = findCommentsRoot();
 992 |     if (!root) return 0;
 993 |     let clicks = 0;
 994 |     for (let i = 0; i < max; i++) {
 995 |       const candidates = Array.from(
 996 |         root.querySelectorAll(
 997 |           "button,div[role='button'],span[role='button'],a[role='button']"
 998 |         )
 999 |       );
1000 |       const btn = candidates.find((el) => {
1001 |         const t = normalize(el.textContent);
1002 |         if (!t) return false;
1003 |         if (t.startsWith("wy≈õwietl wiƒôcej komentarzy")) return true;
1004 |         if (t === "poka≈º wiƒôcej odpowiedzi") return true;
1005 |         if (/^wy≈õwietl wszystkie \d+ odpowiedzi$/.test(t)) return true;
1006 |         if (t === "wy≈õwietl 1 odpowied≈∫") return true;
1007 |         if (/odpowiedzi$/.test(t) && /odpowiedzi/.test(t) && t.includes("odpowiedzia≈Ç")) {
1008 |           return true;
1009 |         }
1010 |         return false;
1011 |       });
1012 |       if (!btn) break;
1013 |       const rect = btn.getBoundingClientRect();
1014 |       if (rect.bottom < 0 || rect.top > window.innerHeight) break;
1015 |       btn.click();
1016 |       clicks++;
1017 |     }
1018 |     return clicks;
1019 |   }, { isVideo: !!view.isVideo, max: maxClicks });
1020 | }
1021 | 
1022 | /* ============================================================
1023 |    ======= AGRESYWNE DO≈ÅADOWANIE WSZYSTKICH KOMENTARZY =========
1024 |    ============================================================ */
1025 | 
1026 | async function ensureAllCommentsLoaded(page, expectedTotal = null) {
1027 |   // expectedTotal tylko do log√≥w ‚Äì NIE jest twardym warunkiem stopu
1028 |   const hasTarget = typeof expectedTotal === "number" && expectedTotal > 0;
1029 |   const view = await page.evaluate(() => {
1030 |     const href = location.href;
1031 |     const isWatch = href.includes("/watch/");
1032 |     const isVideo = isWatch || /\/watch\/|\/videos\/|[\?&]v=/i.test(href); // üëà dodane /videos/
1033 |     const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
1034 |       href
1035 |     );
1036 |     return { href, isWatch, isVideo, isPhoto };
1037 |   });
1038 |   console.log(
1039 |     "[FB] ensureAllCommentsLoaded ‚Äì start",
1040 |     hasTarget ? `(target=${expectedTotal})` : "(bez targetu)",
1041 |     "| view:",
1042 |     view
1043 |   );
1044 |   const MAX_ROUNDS = view.isVideo ? 1500 : 2500;
1045 |   const MAX_NO_PROGRESS = 10; // ile rund bez progresu zanim uznamy, ≈ºe koniec
1046 |   let noProgressRounds = 0;
1047 |   let roundsDone = 0;
1048 |   let lastAnchors = 0;
1049 |   let breakReason = "max-rounds";
1050 |   // helper ‚Äì czy na stronie sƒÖ jeszcze przyciski load-more/replies
1051 |   async function hasLoadMoreButtons() {
1052 |     return await page.evaluate(() => {
1053 |       const phrases = [
1054 |         "wy≈õwietl wiƒôcej komentarzy",
1055 |         "wy≈õwietl wszystkie",
1056 |         "wy≈õwietl wszystkie odpowiedzi",
1057 |         "wy≈õwietl odpowiedzi",
1058 |         "zobacz wiƒôcej komentarzy",
1059 |         "view more comments",
1060 |         "view more replies",
1061 |         "see more comments",
1062 |         "see more replies",
1063 |       ];
1064 |       const btns = Array.from(
1065 |         document.querySelectorAll("button, div[role='button'], span[role='button'], a")
1066 |       );
1067 |       return btns.some((el) => {
1068 |         const txt = (el.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
1069 |         if (!txt) return false;
1070 |         return phrases.some((p) => txt.includes(p));
1071 |       });
1072 |     });
1073 |   }
1074 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
1075 |     const beforeAnchors = await getCurrentCommentAnchorCount(page);
1076 |     // scrollujemy TYLKO przez scrollWithinPost ‚Äì on ogarnia kontener komentarzy
1077 |     const scrollInfo = await scrollWithinPost(
1078 |       page,
1079 |       `round-${round}`,
1080 |       view.isVideo ? 0.18 : 0.25
1081 |     );
1082 |     const clicks = await expandAllComments(page);
1083 |     const afterAnchors = await getCurrentCommentAnchorCount(page);
1084 |     const moreButtons = await hasLoadMoreButtons();
1085 |     const scrolled = scrollInfo.after !== scrollInfo.before;
1086 |     const progressed =
1087 |       scrolled || clicks > 0 || afterAnchors > beforeAnchors;
1088 |     if (progressed) {
1089 |       noProgressRounds = 0;
1090 |       lastAnchors = afterAnchors;
1091 |     } else {
1092 |       noProgressRounds++;
1093 |     }
1094 |     roundsDone = round;
1095 |     if (round === 1 || round % 25 === 0 || round > MAX_ROUNDS - 5) {
1096 |       console.log(
1097 |         `[FB] ensureAllCommentsLoaded ‚Äì round ${round} ` +
1098 |           `container=${scrollInfo.container} ` +
1099 |           `scrollTop: ${scrollInfo.before} ‚Üí ${scrollInfo.after} ` +
1100 |           `anchors: ${beforeAnchors} ‚Üí ${afterAnchors} ` +
1101 |           `clicks=${clicks} noProgress=${noProgressRounds} moreButtons=${moreButtons}`
1102 |       );
1103 |     }
1104 |     if (hasTarget && afterAnchors >= expectedTotal && !moreButtons) {
1105 |       breakReason = "target-reached-no-buttons";
1106 |       break;
1107 |     }
1108 |     if (!moreButtons && noProgressRounds >= MAX_NO_PROGRESS) {
1109 |       breakReason = "no-buttons-no-progress";
1110 |       break;
1111 |     }
1112 |     if (noProgressRounds >= MAX_NO_PROGRESS * 2) {
1113 |       breakReason = "hard-no-progress";
1114 |       break;
1115 |     }
1116 |     await sleepRandom(250, 600);
1117 |   }
1118 |   console.log(
1119 |     "[FB] ensureAllCommentsLoaded ‚Äì g≈Ç√≥wna pƒôtla:",
1120 |     `reason=${breakReason}, rounds=${roundsDone}, anchors=${lastAnchors}${
1121 |       hasTarget ? `/target=${expectedTotal}` : ""
1122 |     }`
1123 |   );
1124 |   // Runda kontrolna w g√≥rƒô ‚Äì domykamy expandy ‚Äûu g√≥ry‚Äù
1125 |   try {
1126 |     let ctrlReason = "max-ctrl-rounds";
1127 |     for (let i = 1; i <= 200; i++) {
1128 |       const up = await scrollWithinPost(page, `ctrl-up-${i}`, -0.55);
1129 |       const clicked = await clickOneExpandButton(page);
1130 |       await sleepRandom(160, 320);
1131 |       if (up.after === 0) {
1132 |         ctrlReason = "top-reached";
1133 |         break;
1134 |       }
1135 |       if (up.after === up.before && !clicked) {
1136 |         ctrlReason = "no-move-no-click";
1137 |         break;
1138 |       }
1139 |     }
1140 |     console.log("[FB] ensureAllCommentsLoaded ‚Äì runda kontrolna:", ctrlReason);
1141 |   } catch (e) {
1142 |     console.log(
1143 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd w rundzie kontrolnej:",
1144 |       e?.message || e
1145 |     );
1146 |   }
1147 |   let bottomClicks = 0;
1148 |   let lastBottomPos = null;
1149 |   let stableRounds = 0;
1150 |   try {
1151 |     for (let i = 1; i <= 400; i++) {
1152 |       const info = await scrollWithinPost(
1153 |         page,
1154 |         `final-bottom-${i}`,
1155 |         view.isVideo ? 0.6 : 0.8
1156 |       );
1157 |       if (lastBottomPos === info.after) {
1158 |         stableRounds++;
1159 |       } else {
1160 |         stableRounds = 0;
1161 |       }
1162 |       lastBottomPos = info.after;
1163 |       if (i === 1 || i % 50 === 0) {
1164 |         console.log(
1165 |           `[FB] ensureAllCommentsLoaded ‚Äì final-bottom step ${i}: container=${info.container}, ` +
1166 |             `scrollTop: ${info.before} ‚Üí ${info.after}`
1167 |         );
1168 |       }
1169 |       if (stableRounds >= 3) break;
1170 |       await sleepRandom(120, 260);
1171 |     }
1172 |     const bottomExpand = await expandAllComments(page);
1173 |     const extraClicks = await clickAllLoadMoreAtBottom(page, view, 300);
1174 |     bottomClicks = bottomExpand + extraClicks;
1175 |     if (bottomClicks > 0) {
1176 |       console.log(
1177 |         `[FB] ensureAllCommentsLoaded ‚Äì bottom pass: expand=${bottomExpand}, extra=${extraClicks}, total=${bottomClicks}`
1178 |       );
1179 |       await sleepRandom(700, 1300);
1180 |     }
1181 |   } catch (e) {
1182 |     console.log(
1183 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd przy final bottom:",
1184 |       e?.message || e
1185 |     );
1186 |   }
1187 |   const finalAnchors = await getCurrentCommentAnchorCount(page);
1188 |   console.log(
1189 |     "[FB] ensureAllCommentsLoaded ‚Äì koniec. anchors=",
1190 |     finalAnchors,
1191 |     "bottomClicks=",
1192 |     bottomClicks
1193 |   );
1194 | }
1195 | 
1196 | /* ============================================================
1197 |    ==================== WIƒòCEJ KOMENTARZY (VIDEO) ===============
1198 |    ============================================================ */
1199 | 
1200 | async function clickMoreCommentsButtonsVideo(page, maxLoops = 80) {
1201 |   console.log(
1202 |     "[FB][more-comments] Start klikania 'Wy≈õwietl wiƒôcej komentarzy / odpowiedzi' (video)‚Ä¶"
1203 |   );
1204 |   for (let i = 0; i < maxLoops; i++) {
1205 |     const result = await page.evaluate(() => {
1206 |       const norm = (s) =>
1207 |         (s || "")
1208 |           .replace(/\s+/g, " ")
1209 |           .trim()
1210 |           .toLowerCase();
1211 |       function getPostRoot() {
1212 |         // 1) overlay z postem / video
1213 |         const dialogs = Array.from(
1214 |           document.querySelectorAll("div[role='dialog']")
1215 |         );
1216 |         for (const dlg of dialogs) {
1217 |           const txt = (dlg.innerText || dlg.textContent || "").toLowerCase();
1218 |           if (!txt) continue;
1219 |           if (
1220 |             txt.includes("komentarz") ||
1221 |             txt.includes("comments") ||
1222 |             txt.includes("napisz komentarz")
1223 |           ) {
1224 |             const art = dlg.querySelector("article");
1225 |             return art || dlg;
1226 |           }
1227 |         }
1228 |         // 2) strona "Filmy" ‚Äì g≈Ç√≥wny artyku≈Ç
1229 |         const main = document.querySelector("main");
1230 |         if (main) {
1231 |           const art = main.querySelector("article");
1232 |           if (art) return art;
1233 |           return main;
1234 |         }
1235 |         // 3) fallback
1236 |         return document.body || document;
1237 |       }
1238 |       const root = getPostRoot();
1239 |       const MORE_COMMENTS_LABELS = [
1240 |         "wy≈õwietl wiƒôcej komentarzy",
1241 |         "zobacz wiƒôcej komentarzy",
1242 |         "view more comments",
1243 |         "view previous comments",
1244 |         "see more comments",
1245 |       ];
1246 |       const REPLY_LABELS = [
1247 |         "wy≈õwietl wiƒôcej odpowiedzi",
1248 |         "zobacz wiƒôcej odpowiedzi",
1249 |         "view more replies",
1250 |         "see more replies",
1251 |       ];
1252 |       const els = Array.from(
1253 |         root.querySelectorAll(
1254 |           "button, div[role='button'], span[role='button'], span"
1255 |         )
1256 |       );
1257 |       let target = null;
1258 |       let kind = null;
1259 |       // 1) priorytet: "Wy≈õwietl wiƒôcej komentarzy"
1260 |       for (const el of els) {
1261 |         const txt = norm(el.textContent);
1262 |         if (!txt) continue;
1263 |         if (MORE_COMMENTS_LABELS.includes(txt)) {
1264 |           const rect = el.getBoundingClientRect();
1265 |           if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1266 |           target = el;
1267 |           kind = "comments";
1268 |           break;
1269 |         }
1270 |       }
1271 |       // 2) je≈õli nie ma "wiƒôcej komentarzy" ‚Äì szukamy "wiƒôcej/X odpowiedzi"
1272 |       if (!target) {
1273 |         for (const el of els) {
1274 |           const txt = norm(el.textContent);
1275 |           if (!txt) continue;
1276 |           if (REPLY_LABELS.includes(txt)) {
1277 |             const rect = el.getBoundingClientRect();
1278 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1279 |             target = el;
1280 |             kind = "replies";
1281 |             break;
1282 |           }
1283 |           if (
1284 |             /(^|\s)\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(txt) ||
1285 |             (txt.includes(" replies") && /\d+/.test(txt))
1286 |           ) {
1287 |             const rect = el.getBoundingClientRect();
1288 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1289 |             target = el;
1290 |             kind = "replies";
1291 |             break;
1292 |           }
1293 |         }
1294 |       }
1295 |       if (!target) {
1296 |         return { clicked: false, kind: null };
1297 |       }
1298 |       try {
1299 |         target.scrollIntoView({ block: "center", inline: "nearest" });
1300 |       } catch (e) {
1301 |         // ignorujemy
1302 |       }
1303 |       if (typeof target.click === "function") {
1304 |         target.click();
1305 |         return { clicked: true, kind };
1306 |       }
1307 |       return { clicked: false, kind: null };
1308 |     });
1309 |     if (!result || !result.clicked) {
1310 |       if (i === 0) {
1311 |         console.log(
1312 |           "[FB][more-comments] Brak przycisk√≥w 'wiƒôcej komentarzy/odpowiedzi' ‚Äì nic nie klikam."
1313 |         );
1314 |       } else {
1315 |         console.log(
1316 |           `[FB][more-comments] Brak kolejnych przycisk√≥w ‚Äì zako≈Ñczono po ${i} klikniƒôciach.`
1317 |         );
1318 |       }
1319 |       break;
1320 |     }
1321 |     const what =
1322 |       result.kind === "replies"
1323 |         ? "wiƒôcej odpowiedzi / X odpowiedzi"
1324 |         : "wiƒôcej komentarzy";
1325 |     console.log(
1326 |       `[FB][more-comments] Klikniƒôto '${what}' (iteracja ${i + 1}/${maxLoops}).`
1327 |     );
1328 |     await sleepRandom(900, 1600);
1329 |     try {
1330 |       await scrollWithinPost(page, `video-more-${i + 1}`, 0.18);
1331 |     } catch (e) {
1332 |       console.log(
1333 |         "[FB][more-comments] scrollWithinPost(video) ‚Äì b≈ÇƒÖd:",
1334 |         e?.message || e
1335 |       );
1336 |     }
1337 |     await sleepRandom(800, 1400);
1338 |   }
1339 |   console.log(
1340 |     `[FB][more-comments] Zako≈Ñczono sekwencjƒô video (maxLoops=${maxLoops}).`
1341 |   );
1342 | }
1343 | 
1344 | /* ============================================================
1345 |    ================= SEKWENCYJNY SPACER (VIDEO) =================
1346 |    ============================================================ */
1347 | 
1348 | async function walkVideoCommentsSequential(page, maxCycles = 40) {
1349 |   console.log("[FB][video-walk] start ‚Äì sekwencyjny spacer po komentarzach (VIDEO)‚Ä¶");
1350 | 
1351 |   let noProgressStreak = 0;
1352 | 
1353 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
1354 |     const result = await page.evaluate(() => {
1355 |       const norm = (s) =>
1356 |         String(s || "")
1357 |           .replace(/\u00a0/g, " ")
1358 |           .replace(/\s+/g, " ")
1359 |           .trim()
1360 |           .toLowerCase();
1361 | 
1362 |       const isVisible = (el) => {
1363 |         if (!el) return false;
1364 |         const st = window.getComputedStyle(el);
1365 |         if (!st) return true;
1366 |         if (st.display === "none" || st.visibility === "hidden") return false;
1367 |         return true;
1368 |       };
1369 | 
1370 |       function getLabel(el) {
1371 |         if (!el) return "";
1372 |         const a = el.getAttribute?.("aria-label");
1373 |         if (a) return a;
1374 |         return el.textContent || "";
1375 |       }
1376 | 
1377 |       function findClickable(el, maxUp = 8) {
1378 |         let cur = el;
1379 |         for (let i = 0; i < maxUp && cur; i++) {
1380 |           const role = cur.getAttribute?.("role");
1381 |           const tag = (cur.tagName || "").toLowerCase();
1382 |           if (tag === "button" || tag === "a" || role === "button") return cur;
1383 |           cur = cur.parentElement;
1384 |         }
1385 |         return el; // fallback
1386 |       }
1387 | 
1388 |       function getPostRoot() {
1389 |         // 1) dialog / overlay (czƒôste przy video)
1390 |         const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
1391 |         for (const dlg of dialogs) {
1392 |           const txt = norm(dlg.innerText || dlg.textContent);
1393 |           if (!txt) continue;
1394 |           if (txt.includes("komentarz") || txt.includes("comments") || txt.includes("napisz komentarz")) {
1395 |             const art = dlg.querySelector("article");
1396 |             return art || dlg;
1397 |           }
1398 |         }
1399 | 
1400 |         // 2) klasyczny main
1401 |         const main = document.querySelector("main, div[role='main']");
1402 |         if (main) {
1403 |           const art = main.querySelector("article");
1404 |           return art || main;
1405 |         }
1406 | 
1407 |         return document.body || document.documentElement;
1408 |       }
1409 | 
1410 |       // REALNY test scrollowalno≈õci: pr√≥bujemy ruszyƒá scrollTop i sprawdzamy czy siƒô zmieni≈Ç.
1411 |       function canScrollByTest(el) {
1412 |         try {
1413 |           if (!el) return false;
1414 |           const h = el.clientHeight || 0;
1415 |           const sh = el.scrollHeight || 0;
1416 |           if (sh <= h + 40) return false;
1417 | 
1418 |           const before = el.scrollTop ?? 0;
1419 |           el.scrollTop = before + 50;
1420 |           const after = el.scrollTop ?? before;
1421 | 
1422 |           // przywr√≥ƒá (≈ºeby nie rozje≈ºd≈ºaƒá)
1423 |           el.scrollTop = before;
1424 | 
1425 |           return after !== before;
1426 |         } catch (e) {
1427 |           return false;
1428 |         }
1429 |       }
1430 | 
1431 |       function getCommentsContainerSmart(root) {
1432 |   // cache kontenera miƒôdzy cyklami (FB czƒôsto rerenderuje, ale referencja zwykle ≈ºyje chwilƒô)
1433 |   function isInDom(el) {
1434 |     try {
1435 |       return !!el && document.contains(el);
1436 |     } catch (e) {
1437 |       return false;
1438 |     }
1439 |   }
1440 | 
1441 |   function canScrollByTest(el) {
1442 |     try {
1443 |       if (!el) return false;
1444 |       const h = el.clientHeight || 0;
1445 |       const sh = el.scrollHeight || 0;
1446 |       if (sh <= h + 40) return false;
1447 | 
1448 |       const before = el.scrollTop ?? 0;
1449 |       el.scrollTop = before + 50;
1450 |       const after = el.scrollTop ?? before;
1451 |       el.scrollTop = before;
1452 | 
1453 |       return after !== before;
1454 |     } catch (e) {
1455 |       return false;
1456 |     }
1457 |   }
1458 | 
1459 |   // 0) spr√≥buj u≈ºyƒá ostatniego dobrego kontenera
1460 |   const cached = window.__FBW_VIDEO_COMMENTS_CONTAINER;
1461 |   if (isInDom(cached) && canScrollByTest(cached)) {
1462 |     return cached;
1463 |   }
1464 | 
1465 |   // 1) normalne szukanie
1466 |   const scopes = [root, document.body, document.documentElement].filter(Boolean);
1467 | 
1468 |   let best = null;
1469 |   let bestScore = -1;
1470 | 
1471 |   for (const scope of scopes) {
1472 |     const divs = Array.from(scope.querySelectorAll("div"))
1473 |       .filter(isVisible)
1474 |       .slice(0, 16000);
1475 | 
1476 |     for (const el of divs) {
1477 |       if (!canScrollByTest(el)) continue;
1478 | 
1479 |       const h = el.clientHeight || 0;
1480 |       const sh = el.scrollHeight || 0;
1481 |       const delta = sh - h;
1482 | 
1483 |       const t = norm(el.innerText || "");
1484 |       const hasCommentWords =
1485 |         t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
1486 | 
1487 |       const score = delta + (hasCommentWords ? 9000 : 0);
1488 | 
1489 |       if (score > bestScore) {
1490 |         bestScore = score;
1491 |         best = el;
1492 |       }
1493 |     }
1494 | 
1495 |     if (best) break;
1496 |   }
1497 | 
1498 |   // 2) cache
1499 |   if (best) {
1500 |     window.__FBW_VIDEO_COMMENTS_CONTAINER = best;
1501 |     return best;
1502 |   }
1503 | 
1504 |   return document.scrollingElement || document.documentElement || root;
1505 | }
1506 | 
1507 | 
1508 |       function clickMoreCommentsOnce(scope) {
1509 |         const LABELS = [
1510 |           "wy≈õwietl wiƒôcej komentarzy",
1511 |           "zobacz wiƒôcej komentarzy",
1512 |           "view more comments",
1513 |           "see more comments",
1514 |           "show more comments",
1515 |         ];
1516 | 
1517 |         const nodes = Array.from(
1518 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1519 |         )
1520 |           .filter(isVisible)
1521 |           .slice(0, 30000);
1522 | 
1523 |         for (const el of nodes) {
1524 |           const txt = norm(getLabel(el));
1525 |           if (!txt) continue;
1526 | 
1527 |           const hit = LABELS.some((w) => txt.includes(w));
1528 |           if (!hit) continue;
1529 | 
1530 |           const btn = findClickable(el);
1531 | 
1532 |           try {
1533 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1534 |           } catch (e) {}
1535 | 
1536 |           try {
1537 |             btn.click();
1538 |             return true;
1539 |           } catch (e) {}
1540 |         }
1541 |         return false;
1542 |       }
1543 | 
1544 |       function expandReplies(scope, limit = 35) {
1545 |         const nodes = Array.from(
1546 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1547 |         )
1548 |           .filter(isVisible)
1549 |           .slice(0, 40000);
1550 | 
1551 |         let clicked = 0;
1552 | 
1553 |         for (const el of nodes) {
1554 |           const txt = norm(getLabel(el));
1555 |           if (!txt) continue;
1556 | 
1557 |           const isMoreReplies =
1558 |             txt.includes("wiƒôcej odpowiedzi") ||
1559 |             txt.includes("more replies") ||
1560 |             txt.includes("view previous replies") ||
1561 |             txt.includes("zobacz odpowiedzi") ||
1562 |             txt.includes("show replies");
1563 | 
1564 |           // ≈Çapie ‚Äú12 odpowiedzi‚Äù, ale te≈º warianty z dodatkami
1565 |           const isCountReplies = /\b\d+\s+(odpowied≈∫|odpowiedzi|repl(y|ies))\b/.test(txt);
1566 | 
1567 |           if (!isMoreReplies && !isCountReplies) continue;
1568 | 
1569 |           const btn = findClickable(el);
1570 | 
1571 |           try {
1572 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1573 |           } catch (e) {}
1574 | 
1575 |           try {
1576 |             btn.click();
1577 |             clicked++;
1578 |             if (clicked >= limit) break;
1579 |           } catch (e) {}
1580 |         }
1581 | 
1582 |         return clicked;
1583 |       }
1584 | 
1585 |       function scrollSomewhere(container) {
1586 |         const beforeC = container?.scrollTop ?? 0;
1587 |         const beforeW = window.scrollY ?? 0;
1588 | 
1589 |         const step = Math.max(300, (container?.clientHeight || 0) * 0.8, 700);
1590 | 
1591 |         // 1) pr√≥buj na kontenerze
1592 |         try {
1593 |           if (container && typeof container.scrollTop === "number") {
1594 |             container.scrollTop = Math.min(beforeC + step, container.scrollHeight || beforeC + step);
1595 |           }
1596 |         } catch (e) {}
1597 | 
1598 |         const afterC = container?.scrollTop ?? beforeC;
1599 | 
1600 |         // 2) jak nie ruszy≈Ço ‚Äì pr√≥buj window
1601 |         if (afterC === beforeC) {
1602 |           try {
1603 |             window.scrollBy(0, step);
1604 |           } catch (e) {}
1605 |         }
1606 | 
1607 |         const afterW = window.scrollY ?? beforeW;
1608 | 
1609 |         return {
1610 |           beforeC,
1611 |           afterC,
1612 |           beforeW,
1613 |           afterW,
1614 |           scrolled: afterC !== beforeC || afterW !== beforeW,
1615 |         };
1616 |       }
1617 | 
1618 |       const root = getPostRoot();
1619 |       const container = getCommentsContainerSmart(root);
1620 | 
1621 |       // WA≈ªNE: na video czƒôsto ‚Äúwiƒôcej komentarzy‚Äù jest poza root ‚Üí szukamy i w body
1622 |       let clickedMore = clickMoreCommentsOnce(root);
1623 |       if (!clickedMore) clickedMore = clickMoreCommentsOnce(document.body);
1624 | 
1625 |       // ‚Äú12 odpowiedzi‚Äù te≈º potrafi byƒá poza root
1626 |       const repliesClickedRoot = expandReplies(root, 35);
1627 |       const repliesClickedBody = expandReplies(document.body, Math.max(0, 35 - repliesClickedRoot));
1628 |       const repliesClicked = repliesClickedRoot + repliesClickedBody;
1629 | 
1630 |       const scrollRes = scrollSomewhere(container);
1631 | 
1632 |       const hasButtons = clickedMore || repliesClicked > 0;
1633 | 
1634 |       return {
1635 |         clickedMore,
1636 |         repliesClicked,
1637 |         scrolled: scrollRes.scrolled,
1638 |         hasButtons,
1639 |         dbg: {
1640 |           beforeC: scrollRes.beforeC,
1641 |           afterC: scrollRes.afterC,
1642 |           beforeW: scrollRes.beforeW,
1643 |           afterW: scrollRes.afterW,
1644 |           containerTag: container?.tagName || null,
1645 |         },
1646 |       };
1647 |     });
1648 | 
1649 |     console.log(
1650 |       `[FB][video-walk] cycle ${cycle}: more=${result.clickedMore}, replies=${result.repliesClicked}, scrolled=${result.scrolled} | dbg=${JSON.stringify(result.dbg)}`
1651 |     );
1652 | 
1653 |     // Stop dopiero po 3 pustych cyklach (FB czƒôsto ≈Çaduje leniwie)
1654 |     if (!result.hasButtons && !result.scrolled) {
1655 |       noProgressStreak++;
1656 |       console.log(`[FB][video-walk] no-progress streak = ${noProgressStreak}/3`);
1657 |       if (noProgressStreak >= 3) {
1658 |         console.log("[FB][video-walk] stop ‚Äì 3x brak przycisk√≥w i brak scrolla.");
1659 |         break;
1660 |       }
1661 |     } else {
1662 |       noProgressStreak = 0;
1663 |     }
1664 | 
1665 |     await sleepRandom(1200, 2000);
1666 |   }
1667 | 
1668 |   console.log("[FB][video-walk] koniec spaceru po komentarzach VIDEO.");
1669 | }
1670 | 
1671 | 
1672 | 
1673 | /* ============================================================
1674 |    ==================== LICZBA KOMENTARZY ======================
1675 |    ============================================================ */
1676 | 
1677 | async function getCommentCount(page, postUrl) {
1678 |   console.log(`[FB] Otwieranie posta: ${postUrl}`);
1679 |   const ok = await safeGoto(page, postUrl, "post", {
1680 |     waitUntil: "networkidle2",
1681 |     timeout: NAV_TIMEOUT_MS,
1682 |   });
1683 |   if (!ok) {
1684 |     throw new Error("safeGoto-failed");
1685 |   }
1686 |   let currentUrl = page.url();
1687 |   if (currentUrl.includes("/login")) {
1688 |     console.log(
1689 |       "[FB] Zamiast posta wylƒÖdowa≈Çem na /login?next=... ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1690 |     );
1691 |     await fbLogin(page);
1692 |     await sleepRandom(3000, 4500);
1693 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
1694 |     console.log(
1695 |       "[FB] Stan sesji po fbLogin() z /login:",
1696 |       loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1697 |     );
1698 |     if (loggedAfterLogin) {
1699 |       await safeGoto(page, postUrl, "post", {
1700 |         waitUntil: "networkidle2",
1701 |         timeout: NAV_TIMEOUT_MS,
1702 |       });
1703 |     } else {
1704 |       console.log(
1705 |         "[FB] Po fbLogin() z /login nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1706 |       );
1707 |     }
1708 |   }
1709 |   await acceptCookies(page, "post-initial");
1710 |   let loggedOnPost = false;
1711 |   try {
1712 |     loggedOnPost = await checkIfLogged(page);
1713 |   } catch (e) {
1714 |     console.log(
1715 |       "[FB] checkIfLogged na widoku posta ‚Äì b≈ÇƒÖd:",
1716 |       e?.message || e
1717 |     );
1718 |   }
1719 |   if (!loggedOnPost) {
1720 |     console.log(
1721 |       "[FB] Na widoku posta brak aktywnej sesji (np. pasek 'Zaloguj siƒô') ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1722 |     );
1723 |     await fbLogin(page);
1724 |     await sleepRandom(3000, 4500);
1725 |     const loggedAfterFbLogin = await checkIfLogged(page).catch(() => false);
1726 |     console.log(
1727 |       "[FB] Stan sesji po fbLogin() z widoku posta:",
1728 |       loggedAfterFbLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1729 |     );
1730 |     if (loggedAfterFbLogin) {
1731 |       console.log(
1732 |         "[FB] Po fbLogin() wykryto zalogowanego u≈ºytkownika ‚Äì ponownie otwieram posta."
1733 |       );
1734 |       await safeGoto(page, postUrl, "post", {
1735 |         waitUntil: "networkidle2",
1736 |         timeout: NAV_TIMEOUT_MS,
1737 |       });
1738 |       await acceptCookies(page, "post-initial");
1739 |     } else {
1740 |       console.log(
1741 |         "[FB] Po fbLogin() nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1742 |       );
1743 |     }
1744 |   }
1745 |   await ensureLoggedInOnPostOverlay(page);
1746 |   await sleepRandom(3000, 4500);
1747 |   await acceptCookies(page, "post");
1748 |   try {
1749 |     const loggedAfterPostOverlay = await checkIfLogged(page);
1750 |     if (loggedAfterPostOverlay) {
1751 |       console.log(
1752 |         "[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."
1753 |       );
1754 |       await saveCookies(page);
1755 |     } else {
1756 |       console.log(
1757 |         "[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."
1758 |       );
1759 |     }
1760 |   } catch (e) {
1761 |     console.log(
1762 |       "[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",
1763 |       e?.message || e
1764 |     );
1765 |   }
1766 |   await sleepRandom(1500, 2500);
1767 |   const isWatchView = postUrl.includes("/watch/");
1768 |   const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(postUrl);
1769 |   const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(postUrl);
1770 |   console.log(
1771 |     "[FB] getCommentCount ‚Äì view type:",
1772 |     isWatchView ? "WATCH" : isVideoView ? "VIDEO" : isPhotoView ? "PHOTO" : "POST"
1773 |   );
1774 |   if (isVideoView) {
1775 |     await pauseVideoIfAny(page);
1776 |     await clickShowAllCommentsIfPresent(page);
1777 |   }
1778 |   if (!isVideoView) {
1779 |     await scrollPost(page, 200);
1780 |     await sleepRandom(800, 1200);
1781 |   }
1782 |   try {
1783 |     const okFilter = await switchCommentsFilterToAll(page);
1784 |     console.log(
1785 |       "[FB] Pierwsza pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1786 |       okFilter
1787 |     );
1788 |     if (okFilter) await sleepRandom(1200, 2000);
1789 |   } catch (e) {
1790 |     console.log(
1791 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",
1792 |       e.message
1793 |     );
1794 |   }
1795 |   if (isVideoView) {
1796 |     await pauseVideoIfAny(page);
1797 |   }
1798 |   const uiInfo = await getUiCommentInfo(page);
1799 |   console.log("[DBG] Comments debug (skr√≥cone):", {
1800 |     source: uiInfo?.source,
1801 |     raw: uiInfo?.raw,
1802 |     viewType: uiInfo?.viewType,
1803 |     comments: uiInfo?.comments,
1804 |   });
1805 |   let expectedTotal = null;
1806 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
1807 |     expectedTotal = uiInfo.comments;
1808 |   }
1809 |   if (isVideoView) {
1810 |     await clickMoreCommentsButtonsVideo(page);
1811 |   }
1812 |   if (isVideoView) {
1813 |     await walkVideoCommentsSequential(page, expectedTotal || null);
1814 |   } else {
1815 |     await ensureAllCommentsLoaded(page, expectedTotal);
1816 |   }
1817 |   try {
1818 |     const ok2 = await switchCommentsFilterToAll(page);
1819 |     console.log(
1820 |       "[FB] Druga pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1821 |       ok2
1822 |     );
1823 |     if (ok2) await sleepRandom(800, 1500);
1824 |   } catch (e) {
1825 |     console.log(
1826 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",
1827 |       e.message
1828 |     );
1829 |   }
1830 |   const fallback = await page.evaluate(() => {
1831 |     const root = document;
1832 |     const anchors = Array.from(
1833 |       root.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
1834 |     );
1835 |     const ids = new Set();
1836 |     for (const a of anchors) {
1837 |       try {
1838 |         const url = new URL(a.href);
1839 |         const cid = url.searchParams.get("comment_id");
1840 |         const rid = url.searchParams.get("reply_comment_id");
1841 |         let raw = rid || cid;
1842 |         if (!raw) continue;
1843 |         if (!/^\d+$/.test(raw)) {
1844 |           try {
1845 |             const dec = atob(raw);
1846 |             const m = dec.match(/:(\d+)_([0-9]+)/);
1847 |             if (m) raw = m[2];
1848 |           } catch {}
1849 |         }
1850 |         if (raw) ids.add(raw);
1851 |       } catch {}
1852 |     }
1853 |     return { count: ids.size };
1854 |   });
1855 |   console.log("[FB] Fallback ‚Äì anchor IDs:", fallback.count);
1856 |   let finalNum = uiInfo?.comments ?? null;
1857 |   if (fallback.count > 0) {
1858 |     if (finalNum == null || finalNum === 0) {
1859 |       finalNum = fallback.count;
1860 |       console.log(
1861 |         "[FB] UI puste/0 ‚Äì u≈ºywam anchor√≥w jako ≈∫r√≥d≈Ça.",
1862 |         `anchor=${fallback.count}`
1863 |       );
1864 |     } else {
1865 |       const diff = finalNum - fallback.count;
1866 |       if (diff > 5) {
1867 |         console.log(
1868 |           "[FB] UI >> anchory ‚Äì czƒô≈õƒá komentarzy niedostƒôpna, u≈ºywam anchor√≥w.",
1869 |           `ui=${finalNum}, anchor=${fallback.count}`
1870 |         );
1871 |         finalNum = fallback.count;
1872 |       } else if (fallback.count > finalNum) {
1873 |         console.log(
1874 |           "[FB] Anchory > UI ‚Äì u≈ºywam anchor√≥w jako bazowej liczby.",
1875 |           `ui=${finalNum}, anchor=${fallback.count}`
1876 |         );
1877 |         finalNum = fallback.count;
1878 |       } else {
1879 |         console.log(
1880 |           "[FB] UI ~= anchory ‚Äì zostawiam UI jako ≈∫r√≥d≈Ço.",
1881 |           `ui=${finalNum}, anchor=${fallback.count}`
1882 |         );
1883 |       }
1884 |     }
1885 |   } else {
1886 |     console.log("[FB] Anchory=0 ‚Äì opieram siƒô wy≈ÇƒÖcznie na UI:", finalNum);
1887 |   }
1888 |   if (finalNum != null) {
1889 |     console.log("[FB] Liczba komentarzy (final):", finalNum);
1890 |     return finalNum;
1891 |   }
1892 |   console.log("[FB] Brak liczby komentarzy w UI i brak anchor√≥w, zwracam 0.");
1893 |   return 0;
1894 | }
1895 | 
1896 | /* ============================================================
1897 |    ================= ROZWIJANIE KOMENTARZY ====================
1898 |    ============================================================ */
1899 | 
1900 | async function expandAllComments(page) {
1901 |   if (!EXPAND_COMMENTS) {
1902 |     console.log("[FB] EXPAND_COMMENTS=false ‚Üí pomijam rozwijanie.");
1903 |     return 0;
1904 |   }
1905 |   let clicks = 0;
1906 |   for (let i = 0; i < 30; i++) {
1907 |     const didClick = await clickOneExpandButton(page);
1908 |     if (!didClick) break;
1909 |     clicks++;
1910 |     await sleepRandom(900, 1600);
1911 |   }
1912 |   return clicks;
1913 | }
1914 | 
1915 | export async function extractCommentsData(page) {
1916 |   try {
1917 |     const comments = await extractCommentsFromDOM(page);
1918 |     return comments;
1919 |   } catch (err) {
1920 |     console.error('[FB] extractCommentsData ‚Äì b≈ÇƒÖd:', err.message);
1921 |     return [];
1922 |   }
1923 | }
1924 | 
1925 | export { getCommentCount, expandAllComments,  };
1926 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/login.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
   1 | // src/fb/login.js
   2 | import { sleepRandom, humanType } from "../utils/sleep.js";
   3 | import log from "../utils/logger.js";
   4 | import { CAPTCHA_ENABLED, CAPTCHA_API_KEY } from "../config.js";
   5 | 
   6 | /**
   7 |  * Diagnozuje typ captcha na stronie
   8 |  * @param {import('puppeteer').Page} page
   9 |  * @returns {Promise<{type: string, details: object}>}
  10 |  */
  11 | async function diagnoseCaptchaType(page) {
  12 |   log.prod("CAPTCHA", "=== DIAGNOSTYKA TYPU CAPTCHA ===");
  13 | 
  14 |   const frames = page.frames();
  15 |   log.prod("CAPTCHA", `Liczba frames: ${frames.length}`);
  16 | 
  17 |   const diagnosis = {
  18 |     type: "unknown",
  19 |     details: {
  20 |       frames: [],
  21 |       pageIndicators: [],
  22 |       sitekey: null,
  23 |       publicKey: null,
  24 |     }
  25 |   };
  26 | 
  27 |   // Sprawd≈∫ wszystkie frames
  28 |   for (const frame of frames) {
  29 |     try {
  30 |       const url = frame.url();
  31 |       if (!url || url === "about:blank") continue;
  32 | 
  33 |       const frameInfo = { url: url.substring(0, 120) };
  34 | 
  35 |       // FunCaptcha / Arkose Labs
  36 |       if (url.includes("arkoselabs") || url.includes("funcaptcha")) {
  37 |         diagnosis.type = "funcaptcha";
  38 |         frameInfo.type = "funcaptcha";
  39 | 
  40 |         // WyciƒÖgnij public key z URL
  41 |         const pkMatch = url.match(/[?&]pk=([^&]+)/);
  42 |         if (pkMatch) {
  43 |           diagnosis.details.publicKey = pkMatch[1];
  44 |           frameInfo.publicKey = pkMatch[1];
  45 |         }
  46 |       }
  47 |       // reCAPTCHA
  48 |       else if (url.includes("recaptcha") || url.includes("google.com/recaptcha")) {
  49 |         diagnosis.type = diagnosis.type === "unknown" ? "recaptcha" : diagnosis.type;
  50 |         frameInfo.type = "recaptcha";
  51 | 
  52 |         if (url.includes("/enterprise/")) {
  53 |           frameInfo.enterprise = true;
  54 |         }
  55 | 
  56 |         const keyMatch = url.match(/[?&]k=([^&]+)/);
  57 |         if (keyMatch) {
  58 |           diagnosis.details.sitekey = keyMatch[1];
  59 |           frameInfo.sitekey = keyMatch[1];
  60 |         }
  61 |       }
  62 |       // hCaptcha
  63 |       else if (url.includes("hcaptcha")) {
  64 |         diagnosis.type = diagnosis.type === "unknown" ? "hcaptcha" : diagnosis.type;
  65 |         frameInfo.type = "hcaptcha";
  66 |       }
  67 | 
  68 |       if (frameInfo.type) {
  69 |         diagnosis.details.frames.push(frameInfo);
  70 |         log.prod("CAPTCHA", `Frame: ${frameInfo.type} - ${url.substring(0, 80)}...`);
  71 |       }
  72 |     } catch {
  73 |       // Ignoruj b≈Çƒôdy
  74 |     }
  75 |   }
  76 | 
  77 |   // Sprawd≈∫ elementy na g≈Ç√≥wnej stronie + u≈ºyj skryptu 2Captcha do wykrywania reCAPTCHA
  78 |   const pageCheck = await page.evaluate(() => {
  79 |     const indicators = [];
  80 | 
  81 |     // FunCaptcha / Arkose Labs
  82 |     if (document.querySelector('#FunCaptcha, [data-callback*="funcaptcha"], iframe[src*="arkoselabs"]')) {
  83 |       indicators.push("funcaptcha_element");
  84 |     }
  85 | 
  86 |     // Szukaj enforcement script (Arkose)
  87 |     const scripts = Array.from(document.querySelectorAll('script[src]'));
  88 |     for (const s of scripts) {
  89 |       if (s.src.includes('arkoselabs') || s.src.includes('funcaptcha')) {
  90 |         indicators.push(`arkose_script: ${s.src.substring(0, 60)}`);
  91 |       }
  92 |     }
  93 | 
  94 |     // Szukaj data-callback z arkose
  95 |     const arkoseDiv = document.querySelector('[data-callback]');
  96 |     if (arkoseDiv) {
  97 |       indicators.push(`data-callback: ${arkoseDiv.getAttribute('data-callback')}`);
  98 |     }
  99 | 
 100 |     // reCAPTCHA - element na stronie
 101 |     if (document.querySelector('.g-recaptcha, [data-sitekey]')) {
 102 |       indicators.push("recaptcha_element");
 103 |       const sitekey = document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey');
 104 |       if (sitekey) indicators.push(`sitekey: ${sitekey.substring(0, 20)}...`);
 105 |     }
 106 | 
 107 |     // === SKRYPT 2CAPTCHA - wykrywanie reCAPTCHA clients ===
 108 |     // eslint-disable-next-line camelcase
 109 |     if (typeof ___grecaptcha_cfg !== 'undefined') {
 110 |       try {
 111 |         // eslint-disable-next-line camelcase, no-undef
 112 |         const clients = Object.entries(___grecaptcha_cfg.clients).map(([cid, client]) => {
 113 |           const data = { id: cid, version: cid >= 10000 ? 'V3' : 'V2' };
 114 |           const objects = Object.entries(client).filter(([_, value]) => value && typeof value === 'object');
 115 | 
 116 |           objects.forEach(([toplevelKey, toplevel]) => {
 117 |             const found = Object.entries(toplevel).find(([_, value]) => (
 118 |               value && typeof value === 'object' && 'sitekey' in value && 'size' in value
 119 |             ));
 120 | 
 121 |             if (typeof toplevel === 'object' && toplevel instanceof HTMLElement && toplevel['tagName'] === 'DIV') {
 122 |               data.pageurl = toplevel.baseURI;
 123 |             }
 124 | 
 125 |             if (found) {
 126 |               const [sublevelKey, sublevel] = found;
 127 |               data.sitekey = sublevel.sitekey;
 128 |               const callbackKey = data.version === 'V2' ? 'callback' : 'promise-callback';
 129 |               const callback = sublevel[callbackKey];
 130 |               if (callback) {
 131 |                 const keys = [cid, toplevelKey, sublevelKey, callbackKey].map((key) => `['${key}']`).join('');
 132 |                 data.callback = `___grecaptcha_cfg.clients${keys}`;
 133 |               }
 134 |             }
 135 |           });
 136 |           return data;
 137 |         });
 138 | 
 139 |         if (clients.length > 0) {
 140 |           indicators.push(`grecaptcha_clients: ${JSON.stringify(clients)}`);
 141 |         }
 142 |       } catch (e) {
 143 |         indicators.push(`grecaptcha_error: ${e.message}`);
 144 |       }
 145 |     }
 146 | 
 147 |     // Tekst na stronie
 148 |     const bodyText = (document.body?.innerText || '').toLowerCase();
 149 |     if (bodyText.includes('arkose') || bodyText.includes('funcaptcha')) {
 150 |       indicators.push("arkose_text");
 151 |     }
 152 | 
 153 |     return indicators;
 154 |   });
 155 | 
 156 |   diagnosis.details.pageIndicators = pageCheck;
 157 |   if (pageCheck.length > 0) {
 158 |     log.prod("CAPTCHA", `Wska≈∫niki na stronie: ${pageCheck.join(', ')}`);
 159 |   }
 160 | 
 161 |   // Je≈õli znaleziono funcaptcha, ustaw typ
 162 |   if (pageCheck.some(i => i.includes("funcaptcha") || i.includes("arkose"))) {
 163 |     diagnosis.type = "funcaptcha";
 164 |   }
 165 | 
 166 |   // Parsuj dane z grecaptcha_clients (skrypt 2Captcha)
 167 |   const grecaptchaMatch = pageCheck.find(i => i.startsWith("grecaptcha_clients:"));
 168 |   if (grecaptchaMatch) {
 169 |     try {
 170 |       const jsonStr = grecaptchaMatch.replace("grecaptcha_clients: ", "");
 171 |       const clients = JSON.parse(jsonStr);
 172 |       if (clients.length > 0) {
 173 |         diagnosis.type = "recaptcha";
 174 |         diagnosis.details.grecaptchaClients = clients;
 175 |         // U≈ºyj pierwszego klienta z sitekey
 176 |         const clientWithSitekey = clients.find(c => c.sitekey);
 177 |         if (clientWithSitekey) {
 178 |           diagnosis.details.sitekey = clientWithSitekey.sitekey;
 179 |           diagnosis.details.callback = clientWithSitekey.callback;
 180 |           diagnosis.details.version = clientWithSitekey.version;
 181 |           log.prod("CAPTCHA", `Znaleziono reCAPTCHA ${clientWithSitekey.version} przez ___grecaptcha_cfg`);
 182 |           log.prod("CAPTCHA", `Sitekey: ${clientWithSitekey.sitekey?.substring(0, 20)}...`);
 183 |           if (clientWithSitekey.callback) {
 184 |             log.prod("CAPTCHA", `Callback: ${clientWithSitekey.callback}`);
 185 |           }
 186 |         }
 187 |       }
 188 |     } catch (e) {
 189 |       log.debug("CAPTCHA", `B≈ÇƒÖd parsowania grecaptcha_clients: ${e.message}`);
 190 |     }
 191 |   }
 192 | 
 193 |   log.prod("CAPTCHA", `=== WYKRYTY TYP: ${diagnosis.type.toUpperCase()} ===`);
 194 | 
 195 |   return diagnosis;
 196 | }
 197 | 
 198 | /**
 199 |  * RozwiƒÖzuje FunCaptcha/Arkose Labs przez 2Captcha API
 200 |  * @param {string} publicKey - klucz publiczny Arkose (parametr pk= z URL)
 201 |  * @param {string} pageUrl - URL strony z captcha
 202 |  * @param {string} surl - opcjonalny service URL
 203 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 204 |  */
 205 | async function solveFunCaptchaViaApi(publicKey, pageUrl, surl = null) {
 206 |   if (!CAPTCHA_API_KEY || !publicKey) {
 207 |     return { ok: false, error: "missing_params" };
 208 |   }
 209 | 
 210 |   log.prod("CAPTCHA", `Wysy≈Çam FunCaptcha do 2Captcha (publicKey: ${publicKey.substring(0, 15)}...)`);
 211 | 
 212 |   try {
 213 |     const createTaskPayload = {
 214 |       clientKey: CAPTCHA_API_KEY,
 215 |       task: {
 216 |         type: "FunCaptchaTaskProxyless",
 217 |         websiteURL: pageUrl,
 218 |         websitePublicKey: publicKey,
 219 |       },
 220 |     };
 221 | 
 222 |     // Dodaj service URL je≈õli podany
 223 |     if (surl) {
 224 |       createTaskPayload.task.funcaptchaApiJSSubdomain = surl;
 225 |     }
 226 | 
 227 |     log.debug("CAPTCHA", `Payload: ${JSON.stringify(createTaskPayload).substring(0, 200)}`);
 228 | 
 229 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 230 |       method: "POST",
 231 |       headers: { "Content-Type": "application/json" },
 232 |       body: JSON.stringify(createTaskPayload),
 233 |     });
 234 |     const createData = await createRes.json();
 235 | 
 236 |     if (createData.errorId !== 0) {
 237 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 238 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 239 |     }
 240 | 
 241 |     const taskId = createData.taskId;
 242 |     log.dev("CAPTCHA", `FunCaptcha Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 243 | 
 244 |     // Polling - max 180 sekund
 245 |     const maxAttempts = 36;
 246 |     for (let i = 0; i < maxAttempts; i++) {
 247 |       await new Promise(r => setTimeout(r, 5000));
 248 | 
 249 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 250 |         method: "POST",
 251 |         headers: { "Content-Type": "application/json" },
 252 |         body: JSON.stringify({
 253 |           clientKey: CAPTCHA_API_KEY,
 254 |           taskId: taskId,
 255 |         }),
 256 |       });
 257 |       const resultData = await resultRes.json();
 258 | 
 259 |       if (resultData.errorId !== 0) {
 260 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 261 |         return { ok: false, error: resultData.errorCode };
 262 |       }
 263 | 
 264 |       if (resultData.status === "ready") {
 265 |         const token = resultData.solution?.token;
 266 |         if (token) {
 267 |           log.success("CAPTCHA", `FunCaptcha rozwiƒÖzana! (pr√≥ba ${i + 1})`);
 268 |           return { ok: true, token };
 269 |         }
 270 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi FunCaptcha");
 271 |         return { ok: false, error: "no_token" };
 272 |       }
 273 | 
 274 |       log.debug("CAPTCHA", `Czekam na FunCaptcha... (${i + 1}/${maxAttempts})`);
 275 |     }
 276 | 
 277 |     return { ok: false, error: "timeout" };
 278 |   } catch (err) {
 279 |     log.error("CAPTCHA", `B≈ÇƒÖd FunCaptcha API: ${err?.message}`);
 280 |     return { ok: false, error: err?.message };
 281 |   }
 282 | }
 283 | 
 284 | /**
 285 |  * RozwiƒÖzuje reCAPTCHA Enterprise przez API v2 2Captcha (createTask)
 286 |  * @param {string} sitekey - klucz witryny reCAPTCHA (parametr k= z URL)
 287 |  * @param {string} pageUrl - URL strony z captcha
 288 |  * @param {object} options - dodatkowe opcje
 289 |  * @param {boolean} options.isInvisible - czy to invisible captcha (domy≈õlnie false)
 290 |  * @param {boolean} options.isEnterprise - czy to Enterprise captcha (domy≈õlnie true)
 291 |  * @param {string} options.dataS - parametr data-s ze strony (dla Enterprise)
 292 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 293 |  */
 294 | async function solveRecaptchaViaApi(sitekey, pageUrl, options = {}) {
 295 |   const { isInvisible = false, isEnterprise = true, dataS = null } = options;
 296 | 
 297 |   if (!CAPTCHA_API_KEY || !sitekey) {
 298 |     return { ok: false, error: "missing_params" };
 299 |   }
 300 | 
 301 |   log.prod("CAPTCHA", `Wysy≈Çam do 2Captcha API v2 (sitekey: ${sitekey.substring(0, 10)}..., enterprise: ${isEnterprise}, dataS: ${dataS ? 'tak' : 'nie'})`);
 302 | 
 303 |   try {
 304 |     // 1. Wy≈õlij zadanie do 2Captcha (API v2)
 305 |     const taskType = isEnterprise
 306 |       ? "RecaptchaV2EnterpriseTaskProxyless"
 307 |       : "RecaptchaV2TaskProxyless";
 308 | 
 309 |     const createTaskPayload = {
 310 |       clientKey: CAPTCHA_API_KEY,
 311 |       task: {
 312 |         type: taskType,
 313 |         websiteURL: pageUrl,
 314 |         websiteKey: sitekey,
 315 |         isInvisible: isInvisible,
 316 |         // FB u≈ºywa w≈Çasnej domeny dla reCAPTCHA
 317 |         apiDomain: "www.recaptcha.net",
 318 |       },
 319 |     };
 320 | 
 321 |     // Dodaj enterprisePayload je≈õli mamy data-s
 322 |     if (isEnterprise && dataS) {
 323 |       createTaskPayload.task.enterprisePayload = { s: dataS };
 324 |       log.debug("CAPTCHA", `Dodano enterprisePayload.s: ${dataS.substring(0, 30)}...`);
 325 |     }
 326 | 
 327 |     log.debug("CAPTCHA", `Typ zadania: ${taskType}`);
 328 | 
 329 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 330 |       method: "POST",
 331 |       headers: { "Content-Type": "application/json" },
 332 |       body: JSON.stringify(createTaskPayload),
 333 |     });
 334 |     const createData = await createRes.json();
 335 | 
 336 |     if (createData.errorId !== 0) {
 337 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 338 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 339 |     }
 340 | 
 341 |     const taskId = createData.taskId;
 342 |     log.dev("CAPTCHA", `Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 343 | 
 344 |     // 2. Polling - czekaj na rozwiƒÖzanie (max 180 sekund dla Enterprise)
 345 |     const maxAttempts = 36; // 36 * 5s = 180s
 346 |     for (let i = 0; i < maxAttempts; i++) {
 347 |       await new Promise(r => setTimeout(r, 5000)); // czekaj 5 sekund
 348 | 
 349 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 350 |         method: "POST",
 351 |         headers: { "Content-Type": "application/json" },
 352 |         body: JSON.stringify({
 353 |           clientKey: CAPTCHA_API_KEY,
 354 |           taskId: taskId,
 355 |         }),
 356 |       });
 357 |       const resultData = await resultRes.json();
 358 | 
 359 |       if (resultData.errorId !== 0) {
 360 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 361 |         return { ok: false, error: resultData.errorCode };
 362 |       }
 363 | 
 364 |       if (resultData.status === "ready") {
 365 |         const token = resultData.solution?.gRecaptchaResponse;
 366 |         if (token) {
 367 |           log.success("CAPTCHA", `RozwiƒÖzano! (pr√≥ba ${i + 1})`);
 368 |           return { ok: true, token };
 369 |         }
 370 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi");
 371 |         return { ok: false, error: "no_token" };
 372 |       }
 373 | 
 374 |       log.debug("CAPTCHA", `Czekam... (${i + 1}/${maxAttempts})`);
 375 |     }
 376 | 
 377 |     return { ok: false, error: "timeout" };
 378 |   } catch (err) {
 379 |     log.error("CAPTCHA", `B≈ÇƒÖd API: ${err?.message}`);
 380 |     return { ok: false, error: err?.message };
 381 |   }
 382 | }
 383 | 
 384 | /**
 385 |  * RozwiƒÖzuje reCAPTCHA z siatkƒÖ obrazk√≥w przez GridTask (2Captcha)
 386 |  * Zamiast generowaƒá token, klika fizycznie w kwadraty wskazane przez pracownik√≥w.
 387 |  *
 388 |  * @param {Page} page - Puppeteer page
 389 |  * @returns {Promise<{ok: boolean, clicked?: number[], error?: string}>}
 390 |  */
 391 | async function solveGridCaptcha(page) {
 392 |   if (!CAPTCHA_API_KEY) {
 393 |     return { ok: false, error: "missing_api_key" };
 394 |   }
 395 | 
 396 |   log.prod("CAPTCHA", "=== GRID CAPTCHA SOLVER ===");
 397 | 
 398 |   try {
 399 |     // 1. Znajd≈∫ iframe z siatkƒÖ obrazk√≥w (bframe)
 400 |     const frames = page.frames();
 401 |     let gridFrame = null;
 402 |     let gridFrameUrl = null;
 403 | 
 404 |     for (const frame of frames) {
 405 |       const url = frame.url();
 406 |       if (url.includes('recaptcha') && url.includes('bframe')) {
 407 |         gridFrame = frame;
 408 |         gridFrameUrl = url;
 409 |         log.dev("CAPTCHA", `Znaleziono bframe: ${url.substring(0, 80)}...`);
 410 |         break;
 411 |       }
 412 |     }
 413 | 
 414 |     if (!gridFrame) {
 415 |       log.warn("CAPTCHA", "Nie znaleziono iframe z siatkƒÖ obrazk√≥w");
 416 |       return { ok: false, error: "no_grid_frame" };
 417 |     }
 418 | 
 419 |     // 2. Poczekaj na za≈Çadowanie siatki
 420 |     await sleepRandom(1500, 2500);
 421 | 
 422 |     // 3. WyciƒÖgnij instrukcjƒô (np. "Wybierz wszystkie kwadraty z przej≈õciami dla pieszych")
 423 |     let instruction = "";
 424 |     try {
 425 |       instruction = await gridFrame.evaluate(() => {
 426 |         // Szukaj instrukcji w r√≥≈ºnych miejscach
 427 |         const selectors = [
 428 |           '.rc-imageselect-desc-wrapper',
 429 |           '.rc-imageselect-desc',
 430 |           '.rc-imageselect-instructions',
 431 |           'strong',
 432 |           '.rc-imageselect-desc-no-canonical'
 433 |         ];
 434 |         for (const sel of selectors) {
 435 |           const el = document.querySelector(sel);
 436 |           if (el && el.textContent.trim()) {
 437 |             return el.textContent.trim();
 438 |           }
 439 |         }
 440 |         return "";
 441 |       });
 442 |       log.prod("CAPTCHA", `Instrukcja: "${instruction.substring(0, 60)}..."`);
 443 |     } catch (err) {
 444 |       log.warn("CAPTCHA", `Nie mo≈ºna wyciƒÖgnƒÖƒá instrukcji: ${err?.message}`);
 445 |     }
 446 | 
 447 |     // Przet≈Çumacz instrukcjƒô na angielski dla 2Captcha (pracownicy lepiej rozumiejƒÖ)
 448 |     const instructionEn = translateInstruction(instruction);
 449 |     log.dev("CAPTCHA", `Instrukcja EN: "${instructionEn}"`);
 450 | 
 451 |     // 4. Zr√≥b screenshot siatki obrazk√≥w
 452 |     let screenshotBase64 = null;
 453 |     try {
 454 |       // Znajd≈∫ element z siatkƒÖ
 455 |       const gridElement = await gridFrame.$('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44, .rc-imageselect');
 456 | 
 457 |       if (gridElement) {
 458 |         const screenshotBuffer = await gridElement.screenshot({ encoding: 'base64' });
 459 |         screenshotBase64 = screenshotBuffer;
 460 |         log.prod("CAPTCHA", `Screenshot siatki: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 461 |       } else {
 462 |         // Fallback - screenshot ca≈Çego iframe
 463 |         const frameElement = await page.$('iframe[src*="bframe"]');
 464 |         if (frameElement) {
 465 |           const screenshotBuffer = await frameElement.screenshot({ encoding: 'base64' });
 466 |           screenshotBase64 = screenshotBuffer;
 467 |           log.prod("CAPTCHA", `Screenshot iframe: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 468 |         }
 469 |       }
 470 |     } catch (err) {
 471 |       log.error("CAPTCHA", `B≈ÇƒÖd screenshot: ${err?.message}`);
 472 |       return { ok: false, error: "screenshot_failed" };
 473 |     }
 474 | 
 475 |     if (!screenshotBase64) {
 476 |       return { ok: false, error: "no_screenshot" };
 477 |     }
 478 | 
 479 |     // 5. Sprawd≈∫ rozmiar siatki (3x3 lub 4x4)
 480 |     let gridSize = "3x3";
 481 |     try {
 482 |       gridSize = await gridFrame.evaluate(() => {
 483 |         if (document.querySelector('.rc-imageselect-table-44')) return "4x4";
 484 |         if (document.querySelector('.rc-imageselect-table-33')) return "3x3";
 485 |         // Policz kwadraty
 486 |         const tiles = document.querySelectorAll('.rc-imageselect-tile');
 487 |         if (tiles.length === 16) return "4x4";
 488 |         return "3x3";
 489 |       });
 490 |       log.dev("CAPTCHA", `Rozmiar siatki: ${gridSize}`);
 491 |     } catch {}
 492 | 
 493 |     // 6. Wy≈õlij do 2Captcha GridTask
 494 |     log.prod("CAPTCHA", "Wysy≈Çam GridTask do 2Captcha...");
 495 | 
 496 |     const createTaskPayload = {
 497 |       clientKey: CAPTCHA_API_KEY,
 498 |       task: {
 499 |         type: "GridTask",
 500 |         body: screenshotBase64,
 501 |         comment: instructionEn || "Select all squares that match the description",
 502 |         rows: gridSize === "4x4" ? 4 : 3,
 503 |         columns: gridSize === "4x4" ? 4 : 3,
 504 |       },
 505 |     };
 506 | 
 507 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 508 |       method: "POST",
 509 |       headers: { "Content-Type": "application/json" },
 510 |       body: JSON.stringify(createTaskPayload),
 511 |     });
 512 |     const createData = await createRes.json();
 513 | 
 514 |     if (createData.errorId !== 0) {
 515 |       log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${createData.errorCode} - ${createData.errorDescription}`);
 516 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 517 |     }
 518 | 
 519 |     const taskId = createData.taskId;
 520 |     log.dev("CAPTCHA", `GridTask ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 521 | 
 522 |     // 7. Polling - czekaj na rozwiƒÖzanie (max 120 sekund)
 523 |     const maxAttempts = 24; // 24 * 5s = 120s
 524 |     let clickIndices = [];
 525 | 
 526 |     for (let i = 0; i < maxAttempts; i++) {
 527 |       await new Promise(r => setTimeout(r, 5000));
 528 | 
 529 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 530 |         method: "POST",
 531 |         headers: { "Content-Type": "application/json" },
 532 |         body: JSON.stringify({
 533 |           clientKey: CAPTCHA_API_KEY,
 534 |           taskId: taskId,
 535 |         }),
 536 |       });
 537 |       const resultData = await resultRes.json();
 538 | 
 539 |       if (resultData.errorId !== 0) {
 540 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 541 |         return { ok: false, error: resultData.errorCode };
 542 |       }
 543 | 
 544 |       if (resultData.status === "ready") {
 545 |         clickIndices = resultData.solution?.click || [];
 546 |         log.success("CAPTCHA", `GridTask rozwiƒÖzany! Kwadraty: [${clickIndices.join(', ')}]`);
 547 |         break;
 548 |       }
 549 | 
 550 |       log.debug("CAPTCHA", `Czekam na GridTask... (${i + 1}/${maxAttempts})`);
 551 |     }
 552 | 
 553 |     if (!clickIndices.length) {
 554 |       log.warn("CAPTCHA", "Brak kwadrat√≥w do klikniƒôcia (mo≈ºe 'Pomi≈Ñ'?)");
 555 |       // Mo≈ºe trzeba kliknƒÖƒá "Pomi≈Ñ" je≈õli nie ma pasujƒÖcych obrazk√≥w
 556 |       try {
 557 |         const skipBtn = await gridFrame.$('.rc-imageselect-incorrect-response, button:has-text("Pomi≈Ñ"), button:has-text("Skip")');
 558 |         if (skipBtn) {
 559 |           await skipBtn.click();
 560 |           await sleepRandom(1000, 2000);
 561 |           return { ok: true, clicked: [], skipped: true };
 562 |         }
 563 |       } catch {}
 564 |       return { ok: false, error: "no_tiles_to_click" };
 565 |     }
 566 | 
 567 |     // 8. Kliknij wskazane kwadraty
 568 |     log.prod("CAPTCHA", `Klikam ${clickIndices.length} kwadrat√≥w...`);
 569 | 
 570 |     for (const index of clickIndices) {
 571 |       try {
 572 |         // Indeksy z 2Captcha sƒÖ 1-based (1 = g√≥rny lewy)
 573 |         const tileIndex = index - 1; // konwertuj na 0-based
 574 | 
 575 |         const clicked = await gridFrame.evaluate((idx) => {
 576 |           const tiles = document.querySelectorAll('.rc-imageselect-tile');
 577 |           if (tiles[idx]) {
 578 |             tiles[idx].click();
 579 |             return true;
 580 |           }
 581 |           // Alternatywny selektor
 582 |           const cells = document.querySelectorAll('td.rc-imageselect-tile');
 583 |           if (cells[idx]) {
 584 |             cells[idx].click();
 585 |             return true;
 586 |           }
 587 |           return false;
 588 |         }, tileIndex);
 589 | 
 590 |         if (clicked) {
 591 |           log.dev("CAPTCHA", `Klikniƒôto kwadrat ${index}`);
 592 |         } else {
 593 |           log.warn("CAPTCHA", `Nie znaleziono kwadratu ${index}`);
 594 |         }
 595 | 
 596 |         // Kr√≥tka pauza miƒôdzy klikniƒôciami (human-like)
 597 |         await sleepRandom(200, 500);
 598 |       } catch (err) {
 599 |         log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia kwadratu ${index}: ${err?.message}`);
 600 |       }
 601 |     }
 602 | 
 603 |     // 9. Kliknij przycisk "Sprawd≈∫" / "Verify"
 604 |     await sleepRandom(500, 1000);
 605 | 
 606 |     try {
 607 |       const verifyBtn = await gridFrame.$('#recaptcha-verify-button, .rc-button-default, button[id*="verify"]');
 608 |       if (verifyBtn) {
 609 |         log.prod("CAPTCHA", "Klikam 'Sprawd≈∫'...");
 610 |         await verifyBtn.click();
 611 |         await sleepRandom(2000, 3000);
 612 |       }
 613 |     } catch (err) {
 614 |       log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia Verify: ${err?.message}`);
 615 |     }
 616 | 
 617 |     return { ok: true, clicked: clickIndices };
 618 | 
 619 |   } catch (err) {
 620 |     log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${err?.message}`);
 621 |     return { ok: false, error: err?.message };
 622 |   }
 623 | }
 624 | 
 625 | /**
 626 |  * T≈Çumaczy polskƒÖ instrukcjƒô reCAPTCHA na angielski
 627 |  */
 628 | function translateInstruction(pl) {
 629 |   const translations = {
 630 |     "przej≈õciami dla pieszych": "crosswalks",
 631 |     "przej≈õcia dla pieszych": "crosswalks",
 632 |     "sygnalizatorami ≈õwietlnymi": "traffic lights",
 633 |     "sygnalizatory ≈õwietlne": "traffic lights",
 634 |     "≈õwiat≈Çami": "traffic lights",
 635 |     "samochodami": "cars",
 636 |     "samochody": "cars",
 637 |     "autobusami": "buses",
 638 |     "autobusy": "buses",
 639 |     "motocyklami": "motorcycles",
 640 |     "motocykle": "motorcycles",
 641 |     "rowerami": "bicycles",
 642 |     "rowery": "bicycles",
 643 |     "hydrantami": "fire hydrants",
 644 |     "hydranty": "fire hydrants",
 645 |     "mostami": "bridges",
 646 |     "mosty": "bridges",
 647 |     "schodami": "stairs",
 648 |     "schody": "stairs",
 649 |     "g√≥rami": "mountains",
 650 |     "g√≥ry": "mountains",
 651 |     "palmami": "palm trees",
 652 |     "palmy": "palm trees",
 653 |     "≈Çodziami": "boats",
 654 |     "≈Çodzie": "boats",
 655 |     "taks√≥wkami": "taxis",
 656 |     "taks√≥wki": "taxis",
 657 |     "chimneys": "chimneys",
 658 |     "kominami": "chimneys",
 659 |     "kominy": "chimneys",
 660 |     "parking meters": "parking meters",
 661 |     "parkomatami": "parking meters",
 662 |     "parkomaty": "parking meters",
 663 |   };
 664 | 
 665 |   let en = pl.toLowerCase();
 666 | 
 667 |   // Zamie≈Ñ polskie frazy na angielskie
 668 |   for (const [plPhrase, enPhrase] of Object.entries(translations)) {
 669 |     if (en.includes(plPhrase.toLowerCase())) {
 670 |       return `Select all squares with ${enPhrase}`;
 671 |     }
 672 |   }
 673 | 
 674 |   // Je≈õli nie znaleziono t≈Çumaczenia, zwr√≥ƒá oryginalnƒÖ instrukcjƒô
 675 |   return pl || "Select all matching images";
 676 | }
 677 | 
 678 | /**
 679 |  * Sprawdza czy pojawi≈Ça siƒô siatka obrazk√≥w (po klikniƒôciu checkboxa)
 680 |  */
 681 | async function hasImageGrid(page) {
 682 |   try {
 683 |     const frames = page.frames();
 684 |     for (const frame of frames) {
 685 |       if (frame.url().includes('recaptcha') && frame.url().includes('bframe')) {
 686 |         // Sprawd≈∫ czy siatka jest widoczna
 687 |         const hasGrid = await frame.evaluate(() => {
 688 |           const grid = document.querySelector('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44');
 689 |           return grid && grid.offsetHeight > 0;
 690 |         }).catch(() => false);
 691 | 
 692 |         if (hasGrid) {
 693 |           return true;
 694 |         }
 695 |       }
 696 |     }
 697 |     return false;
 698 |   } catch {
 699 |     return false;
 700 |   }
 701 | }
 702 | 
 703 | /**
 704 |  * FB login helpers ‚Äì PRO (NO COOLDOWN)
 705 |  *
 706 |  * Najwa≈ºniejsze:
 707 |  * - G≈Ç√≥wne logowanie: https://www.facebook.com/login.php?next=<postUrl>
 708 |  * - Best-effort (zero throw, zero crashy)
 709 |  * - Dwa tryby:
 710 |  *    1) login.php?next (najstabilniejsze)
 711 |  *    2) fallback: loginViaVisibleForm (overlay / r√≥≈ºne layouty)
 712 |  *
 713 |  * Kompatybilno≈õƒá:
 714 |  * - eksportujemy te≈º clickByText, acceptLoginCookies, loginViaVisibleForm (jak w wersji lokalnej)
 715 |  */
 716 | 
 717 | function norm(s) {
 718 |   return String(s || "")
 719 |     .replace(/\u00a0/g, " ")
 720 |     .replace(/\s+/g, " ")
 721 |     .trim();
 722 | }
 723 | 
 724 | /**
 725 |  * Cookies popup ‚Äì wersja "mark + click" (jak lokalnie), ale best-effort.
 726 |  */
 727 | async function acceptLoginCookies(page) {
 728 |   try {
 729 |     log.debug("LOGIN", "Szukam popupu cookies...");
 730 | 
 731 |     await sleepRandom(300, 900);
 732 | 
 733 |     const found = await page.evaluate(() => {
 734 |       const wanted = [
 735 |         "Zezw√≥l na wszystkie pliki cookie",
 736 |         "Zezw√≥l na wszystkie pliki",
 737 |         "Allow all cookies",
 738 |         "Accept all cookies",
 739 |         "Akceptuj wszystkie",
 740 |         "Odrzuƒá opcjonalne pliki cookie",
 741 |         "Odrzuc opcjonalne pliki cookie",
 742 |       ].map((t) => t.toLowerCase());
 743 | 
 744 |       const buttons = Array.from(
 745 |         document.querySelectorAll("button, [role='button']")
 746 |       );
 747 | 
 748 |       for (const btn of buttons) {
 749 |         const txt = (btn.innerText || btn.textContent || "").trim();
 750 |         if (!txt) continue;
 751 |         const low = txt.toLowerCase();
 752 | 
 753 |         if (wanted.some((w) => low.includes(w))) {
 754 |           btn.setAttribute("data-fb-cookie-btn", "1");
 755 |           return true;
 756 |         }
 757 |       }
 758 | 
 759 |       return false;
 760 |     });
 761 | 
 762 |     if (!found) {
 763 |       return false;
 764 |     }
 765 | 
 766 |     await page
 767 |       .click('[data-fb-cookie-btn="1"]')
 768 |       .catch(() => {});
 769 | 
 770 |     log.debug("LOGIN", "Klikniƒôto cookies popup");
 771 | 
 772 |     await sleepRandom(600, 1200);
 773 |     return true;
 774 |   } catch (err) {
 775 |     log.debug("LOGIN", `B≈ÇƒÖd cookies popup: ${err?.message || err}`);
 776 |     return false;
 777 |   }
 778 | }
 779 | 
 780 | /**
 781 |  * Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).
 782 |  */
 783 | async function acceptCookiesIfPresent(page) {
 784 |   try {
 785 |     await sleepRandom(250, 650);
 786 | 
 787 |     const clicked = await page.evaluate(() => {
 788 |       const wanted = [
 789 |         "Zezw√≤l na wszystkie pliki cookie",
 790 |         "Zezw√≥l na wszystkie pliki cookie",
 791 |         "Zezw√≤l na wszystkie pliki",
 792 |         "Zezw√≥l na wszystkie pliki",
 793 |         "Allow all cookies",
 794 |         "Accept all cookies",
 795 |         "Akceptuj wszystkie",
 796 |       ].map((x) => x.toLowerCase());
 797 | 
 798 |       const btns = Array.from(
 799 |         document.querySelectorAll("button, [role='button']")
 800 |       );
 801 | 
 802 |       for (const b of btns) {
 803 |         const t = (b.innerText || b.textContent || "").trim();
 804 |         if (!t) continue;
 805 |         const low = t.toLowerCase();
 806 |         if (wanted.some((w) => low.includes(w))) {
 807 |           b.click();
 808 |           return true;
 809 |         }
 810 |       }
 811 |       return false;
 812 |     });
 813 | 
 814 |     if (clicked) {
 815 |       log.debug("LOGIN", "Klikniƒôto accept cookies (fallback)");
 816 |       await sleepRandom(500, 1100);
 817 |     }
 818 |     return !!clicked;
 819 |   } catch {
 820 |     return false;
 821 |   }
 822 | }
 823 | 
 824 | /**
 825 |  * Helper: kliknij przycisk submit po rozwiƒÖzaniu captcha
 826 |  */
 827 | async function clickSubmitButton(page) {
 828 |   // Rozszerzone selektory dla FB two_step_verification
 829 |   const submitSelectors = [
 830 |     // FB specyficzne
 831 |     'div[aria-label="Kontynuuj"]',
 832 |     'div[aria-label="Continue"]',
 833 |     'span[dir="auto"]:has-text("Kontynuuj")',
 834 |     // Standardowe
 835 |     'button[type="submit"]',
 836 |     'input[type="submit"]',
 837 |     'button[name="submit"]',
 838 |     'div[role="button"][tabindex="0"]',
 839 |     'button:not([type])',
 840 |     '[data-testid="royal_login_button"]',
 841 |   ];
 842 | 
 843 |   let submitBtn = null;
 844 |   for (const sel of submitSelectors) {
 845 |     try {
 846 |       submitBtn = await page.$(sel);
 847 |       if (submitBtn) {
 848 |         log.debug("CAPTCHA", `Znaleziono przycisk: ${sel}`);
 849 |         break;
 850 |       }
 851 |     } catch {}
 852 |   }
 853 | 
 854 |   // Fallback - szukaj przycisku po tek≈õcie (rozszerzone dla FB)
 855 |   if (!submitBtn) {
 856 |     log.debug("CAPTCHA", "Szukam przycisku po tek≈õcie...");
 857 | 
 858 |     // Diagnostyka - poka≈º wszystkie klikalne elementy
 859 |     const buttons = await page.evaluate(() => {
 860 |       const els = Array.from(document.querySelectorAll(
 861 |         'button, div[role="button"], a[role="button"], span[role="button"], div[tabindex="0"]'
 862 |       ));
 863 |       return els.slice(0, 15).map(el => ({
 864 |         tag: el.tagName,
 865 |         text: (el.innerText || '').substring(0, 50).trim(),
 866 |         role: el.getAttribute('role'),
 867 |         ariaLabel: el.getAttribute('aria-label'),
 868 |       })).filter(x => x.text || x.ariaLabel);
 869 |     });
 870 |     log.debug("CAPTCHA", `Dostƒôpne przyciski: ${JSON.stringify(buttons, null, 2)}`);
 871 | 
 872 |     submitBtn = await page.evaluateHandle(() => {
 873 |       // Szukaj we wszystkich mo≈ºliwych elementach
 874 |       const allElements = Array.from(document.querySelectorAll(
 875 |         'button, div[role="button"], a[role="button"], span[role="button"], ' +
 876 |         'div[tabindex="0"], span[tabindex="0"], a[tabindex="0"]'
 877 |       ));
 878 | 
 879 |       const texts = [
 880 |         'kontynuuj', 'continue', 'submit', 'dalej', 'wy≈õlij', 'potwierd≈∫',
 881 |         'prze≈õlij', 'zatwierd≈∫', 'weryfikuj', 'verify', 'next', 'ok'
 882 |       ];
 883 | 
 884 |       for (const el of allElements) {
 885 |         const t = (el.innerText || el.textContent || '').toLowerCase().trim();
 886 |         if (!t) continue;
 887 | 
 888 |         // Szukaj dok≈Çadnego dopasowania lub zawierania
 889 |         if (texts.some(x => t === x || t.includes(x))) {
 890 |           console.log('[Submit] Znaleziono:', t, el.tagName);
 891 |           return el;
 892 |         }
 893 |       }
 894 | 
 895 |       // Ostatnia szansa - szukaj niebieskiego przycisku FB (primary button)
 896 |       const primaryBtn = document.querySelector(
 897 |         'div[style*="background-color: rgb(24, 119, 242)"], ' +
 898 |         'div[class*="primary"], ' +
 899 |         'div[class*="layerConfirm"]'
 900 |       );
 901 |       if (primaryBtn) {
 902 |         console.log('[Submit] Znaleziono primary button');
 903 |         return primaryBtn;
 904 |       }
 905 | 
 906 |       return null;
 907 |     });
 908 | 
 909 |     if (submitBtn?.asElement()) {
 910 |       submitBtn = submitBtn.asElement();
 911 |     } else {
 912 |       submitBtn = null;
 913 |     }
 914 |   }
 915 | 
 916 |   if (submitBtn) {
 917 |     log.prod("CAPTCHA", "Klikam przycisk submit...");
 918 |     await submitBtn.click();
 919 |     await sleepRandom(1000, 2000);
 920 |     await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
 921 |     await sleepRandom(2000, 3000);
 922 |   } else {
 923 |     // Spr√≥buj kliknƒÖƒá w ≈õrodek ekranu gdzie zwykle jest przycisk
 924 |     log.warn("CAPTCHA", "Nie znaleziono przycisku - pr√≥bujƒô Tab + Enter");
 925 |     await page.keyboard.press('Tab');
 926 |     await sleepRandom(300, 500);
 927 |     await page.keyboard.press('Tab');
 928 |     await sleepRandom(300, 500);
 929 |     await page.keyboard.press('Enter');
 930 |     await sleepRandom(3000, 4000);
 931 |   }
 932 | }
 933 | 
 934 | /**
 935 |  * Pomocnik: wpisz login/has≈Ço + kliknij login. Best-effort.
 936 |  */
 937 | async function fillLoginFormBestEffort(page) {
 938 |   const email = process.env.FB_EMAIL || "";
 939 |   const password = process.env.FB_PASSWORD || "";
 940 | 
 941 |   if (!email || !password) {
 942 |     log.dev("LOGIN", "Brak FB_EMAIL / FB_PASSWORD ‚Äì pomijam");
 943 |     return false;
 944 |   }
 945 | 
 946 |   const emailSel = [
 947 |     "input#email",
 948 |     "input[name='email']",
 949 |     "input[name='email_or_phone']",
 950 |     "input[type='text']",
 951 |   ].join(",");
 952 | 
 953 |   const passSel = [
 954 |     "input#pass",
 955 |     "input[name='pass']",
 956 |     "input[type='password']",
 957 |   ].join(",");
 958 | 
 959 |   const emailInput = await page.$(emailSel).catch(() => null);
 960 |   const passInput = await page.$(passSel).catch(() => null);
 961 | 
 962 |   if (!emailInput || !passInput) {
 963 |     log.debug("LOGIN", "Brak p√≥l email/has≈Ço na stronie");
 964 |     return false;
 965 |   }
 966 | 
 967 |   log.dev("LOGIN", "Wpisujƒô email i has≈Ço (human-like typing)...");
 968 | 
 969 |   await emailInput.click({ clickCount: 3 }).catch(() => {});
 970 |   await page.keyboard.press("Backspace").catch(() => {});
 971 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 972 |   await humanType(emailInput, email, page).catch(() => {});
 973 | 
 974 |   await passInput.click({ clickCount: 3 }).catch(() => {});
 975 |   await page.keyboard.press("Backspace").catch(() => {});
 976 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 977 |   await humanType(passInput, password, page).catch(() => {});
 978 | 
 979 |   const loginButton =
 980 |     (await page.$('button[name="login"]')) ||
 981 |     (await page.$('button[type="submit"]')) ||
 982 |     (await page.$('div[role="button"][tabindex="0"]')) ||
 983 |     (await page.$("button")) ||
 984 |     null;
 985 | 
 986 |   if (!loginButton) {
 987 |     log.debug("LOGIN", "Brak przycisku logowania");
 988 |     return false;
 989 |   }
 990 | 
 991 |   log.dev("LOGIN", "Klikam logowanie...");
 992 | 
 993 |   await Promise.all([
 994 |     loginButton.click().catch(() => {}),
 995 |     page
 996 |       .waitForNavigation({ waitUntil: "networkidle2", timeout: 60000 })
 997 |       .catch(() => {}),
 998 |   ]);
 999 | 
1000 |   await sleepRandom(1400, 2400);
1001 | 
1002 |   // Sprawd≈∫ URL - czy jeste≈õmy na stronie 2FA/weryfikacji
1003 |   const currentUrl = page.url();
1004 |   log.dev("LOGIN", `URL po logowaniu: ${currentUrl.substring(0, 80)}...`);
1005 | 
1006 |   // Je≈õli jeste≈õmy na stronie weryfikacji, spr√≥buj rozwiƒÖzaƒá captcha
1007 |   if (currentUrl.includes('two_step_verification') ||
1008 |       currentUrl.includes('checkpoint') ||
1009 |       currentUrl.includes('authentication')) {
1010 |     log.prod("LOGIN", "Wykryto stronƒô weryfikacji - pr√≥bujƒô rozwiƒÖzaƒá captcha...");
1011 | 
1012 |     // Poczekaj na za≈Çadowanie element√≥w
1013 |     await sleepRandom(4000, 6000);
1014 | 
1015 |     // NOWA DIAGNOSTYKA - wykryj typ captcha
1016 |     const diagnosis = await diagnoseCaptchaType(page);
1017 | 
1018 |     if (!CAPTCHA_ENABLED) {
1019 |       log.warn("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
1020 |       await sleepRandom(1000, 2000);
1021 |       return true;
1022 |     }
1023 | 
1024 |     let apiResult = { ok: false };
1025 | 
1026 |     // === FUNCAPTCHA / ARKOSE LABS ===
1027 |     if (diagnosis.type === "funcaptcha" && diagnosis.details.publicKey) {
1028 |       log.prod("CAPTCHA", "U≈ºywam solvera FunCaptcha...");
1029 | 
1030 |       const maxRetries = 2;
1031 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
1032 |         log.prod("CAPTCHA", `FunCaptcha pr√≥ba ${attempt}/${maxRetries}...`);
1033 | 
1034 |         apiResult = await solveFunCaptchaViaApi(
1035 |           diagnosis.details.publicKey,
1036 |           currentUrl
1037 |         );
1038 | 
1039 |         if (apiResult.ok) break;
1040 | 
1041 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
1042 |           log.warn("CAPTCHA", "FunCaptcha nierozwiƒÖzywalna - od≈õwie≈ºam...");
1043 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
1044 |           await sleepRandom(3000, 5000);
1045 |           // Po reload ponownie zdiagnozuj
1046 |           const newDiag = await diagnoseCaptchaType(page);
1047 |           if (newDiag.details.publicKey) {
1048 |             diagnosis.details.publicKey = newDiag.details.publicKey;
1049 |           }
1050 |         } else if (apiResult.error) {
1051 |           break;
1052 |         }
1053 |       }
1054 | 
1055 |       if (apiResult.ok && apiResult.token) {
1056 |         log.success("CAPTCHA", "Otrzymano token FunCaptcha!");
1057 | 
1058 |         // Wstrzyknij token FunCaptcha
1059 |         try {
1060 |           const injected = await page.evaluate((token) => {
1061 |             let success = false;
1062 | 
1063 |             // FunCaptcha callback - r√≥≈ºne warianty
1064 |             const callbacks = [
1065 |               () => window.ArkoseEnforcement?.setSessionToken?.(token),
1066 |               () => window.fc_callback?.(token),
1067 |               () => window.funcaptchaCallback?.(token),
1068 |               () => window.onFunCaptchaSuccess?.(token),
1069 |               // Szukaj ukrytego inputa
1070 |               () => {
1071 |                 const input = document.querySelector('input[name="fc-token"], input[name="verification_token"]');
1072 |                 if (input) {
1073 |                   input.value = token;
1074 |                   success = true;
1075 |                 }
1076 |               },
1077 |               // Wywo≈Çaj event submit
1078 |               () => {
1079 |                 const form = document.querySelector('form');
1080 |                 if (form) {
1081 |                   const hiddenInput = document.createElement('input');
1082 |                   hiddenInput.type = 'hidden';
1083 |                   hiddenInput.name = 'fc-token';
1084 |                   hiddenInput.value = token;
1085 |                   form.appendChild(hiddenInput);
1086 |                   success = true;
1087 |                 }
1088 |               },
1089 |             ];
1090 | 
1091 |             for (const tryCallback of callbacks) {
1092 |               try {
1093 |                 tryCallback();
1094 |               } catch {}
1095 |             }
1096 | 
1097 |             return success;
1098 |           }, apiResult.token);
1099 | 
1100 |           log.dev("CAPTCHA", `Token FunCaptcha wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
1101 |           await sleepRandom(1500, 2500);
1102 | 
1103 |           // Kliknij przycisk submit
1104 |           await clickSubmitButton(page);
1105 |           return true;
1106 |         } catch (err) {
1107 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu FunCaptcha: ${err?.message}`);
1108 |         }
1109 |       }
1110 |     }
1111 |     // === RECAPTCHA ===
1112 |     else if (diagnosis.type === "recaptcha" && diagnosis.details.sitekey) {
1113 |       log.prod("CAPTCHA", "U≈ºywam solvera reCAPTCHA...");
1114 | 
1115 |       // Sprawd≈∫ czy Enterprise
1116 |       const isEnterprise = diagnosis.details.frames.some(f => f.enterprise);
1117 | 
1118 |       // KROK 1: Kliknij checkbox "Nie jestem robotem" je≈õli istnieje
1119 |       try {
1120 |         const frames = page.frames();
1121 |         for (const frame of frames) {
1122 |           if (frame.url().includes('recaptcha') && frame.url().includes('anchor')) {
1123 |             log.prod("CAPTCHA", "Szukam checkboxa reCAPTCHA...");
1124 |             const checkbox = await frame.$('.recaptcha-checkbox-border, .recaptcha-checkbox, #recaptcha-anchor');
1125 |             if (checkbox) {
1126 |               log.prod("CAPTCHA", "Klikam checkbox 'Nie jestem robotem'...");
1127 |               await checkbox.click();
1128 |               await sleepRandom(2000, 3000);
1129 |               break;
1130 |             }
1131 |           }
1132 |         }
1133 |       } catch (err) {
1134 |         log.debug("CAPTCHA", `B≈ÇƒÖd klikniƒôcia checkboxa: ${err?.message}`);
1135 |       }
1136 | 
1137 |       // KROK 2: Sprawd≈∫ czy pojawi≈Ça siƒô siatka obrazk√≥w
1138 |       await sleepRandom(1000, 2000);
1139 |       const gridDetected = await hasImageGrid(page);
1140 | 
1141 |       if (gridDetected) {
1142 |         log.prod("CAPTCHA", "Wykryto siatkƒô obrazk√≥w - u≈ºywam GridTask...");
1143 | 
1144 |         // Pr√≥by rozwiƒÖzania przez GridTask (FB czƒôsto wymaga 4-6 rund)
1145 |         const maxGridRetries = 6;
1146 |         for (let gridAttempt = 1; gridAttempt <= maxGridRetries; gridAttempt++) {
1147 |           log.prod("CAPTCHA", `GridTask pr√≥ba ${gridAttempt}/${maxGridRetries}...`);
1148 | 
1149 |           const gridResult = await solveGridCaptcha(page);
1150 | 
1151 |           if (gridResult.ok) {
1152 |             log.success("CAPTCHA", `GridTask sukces! Klikniƒôto: [${gridResult.clicked?.join(', ') || 'pominiƒôto'}]`);
1153 | 
1154 |             // Sprawd≈∫ czy captcha zniknƒô≈Ça (sukces)
1155 |             await sleepRandom(2000, 3000);
1156 |             const stillHasGrid = await hasImageGrid(page);
1157 | 
1158 |             if (!stillHasGrid) {
1159 |               log.success("CAPTCHA", "Siatka zniknƒô≈Ça - captcha rozwiƒÖzana!");
1160 |               // Kliknij submit je≈õli trzeba
1161 |               await clickSubmitButton(page);
1162 |               return true;
1163 |             } else {
1164 |               log.warn("CAPTCHA", "Siatka nadal widoczna - pr√≥bujƒô ponownie...");
1165 |               // Mo≈ºe pojawi≈Ça siƒô nowa siatka - kontynuuj
1166 |             }
1167 |           } else {
1168 |             log.warn("CAPTCHA", `GridTask b≈ÇƒÖd: ${gridResult.error}`);
1169 | 
1170 |             if (gridResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && gridAttempt < maxGridRetries) {
1171 |               // Kliknij "Nowy obrazek" je≈õli dostƒôpny
1172 |               try {
1173 |                 const frames = page.frames();
1174 |                 for (const frame of frames) {
1175 |                   if (frame.url().includes('bframe')) {
1176 |                     const newImageBtn = await frame.$('#recaptcha-reload-button, .rc-button-reload');
1177 |                     if (newImageBtn) {
1178 |                       log.prod("CAPTCHA", "Klikam 'Nowy obrazek'...");
1179 |                       await newImageBtn.click();
1180 |                       await sleepRandom(2000, 3000);
1181 |                     }
1182 |                     break;
1183 |                   }
1184 |                 }
1185 |               } catch {}
1186 |             }
1187 |           }
1188 |         }
1189 | 
1190 |         // GridTask nie zadzia≈Ça≈Ç - fallback do token method
1191 |         log.warn("CAPTCHA", "GridTask wyczerpany - pr√≥bujƒô metodƒô tokenowƒÖ...");
1192 |       }
1193 | 
1194 |       // KROK 3 (fallback): Metoda tokenowa (dla przypadk√≥w bez siatki lub gdy GridTask nie zadzia≈Ça≈Ç)
1195 |       // WyciƒÖgnij data-s
1196 |       let dataS = null;
1197 |       try {
1198 |         dataS = await page.evaluate(() => {
1199 |           const recaptchaDiv = document.querySelector('.g-recaptcha, [data-sitekey], #recaptcha');
1200 |           if (recaptchaDiv?.dataset?.s) return recaptchaDiv.dataset.s;
1201 |           const iframes = document.querySelectorAll('iframe[src*="recaptcha"]');
1202 |           for (const iframe of iframes) {
1203 |             const match = (iframe.src || '').match(/[?&]s=([^&]+)/);
1204 |             if (match) return decodeURIComponent(match[1]);
1205 |           }
1206 |           return null;
1207 |         });
1208 |       } catch {}
1209 | 
1210 |       const maxRetries = 2;
1211 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
1212 |         log.prod("CAPTCHA", `reCAPTCHA pr√≥ba ${attempt}/${maxRetries}...`);
1213 | 
1214 |         apiResult = await solveRecaptchaViaApi(diagnosis.details.sitekey, currentUrl, {
1215 |           isEnterprise,
1216 |           isInvisible: false,
1217 |           dataS,
1218 |         });
1219 | 
1220 |         if (apiResult.ok) break;
1221 | 
1222 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
1223 |           log.warn("CAPTCHA", "reCAPTCHA nierozwiƒÖzywalna - od≈õwie≈ºam...");
1224 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
1225 |           await sleepRandom(3000, 5000);
1226 |         } else if (apiResult.error) {
1227 |           break;
1228 |         }
1229 |       }
1230 | 
1231 |       if (apiResult.ok && apiResult.token) {
1232 |         log.success("CAPTCHA", "Otrzymano token reCAPTCHA!");
1233 | 
1234 |         // Wstrzyknij token reCAPTCHA - u≈ºyj wykrytego callbacka je≈õli dostƒôpny
1235 |         const callbackPath = diagnosis.details.callback;
1236 |         try {
1237 |           const injected = await page.evaluate((token, cbPath) => {
1238 |             let success = false;
1239 | 
1240 |             // 1. Ustaw warto≈õƒá w textarea
1241 |             const textareas = document.querySelectorAll(
1242 |               'textarea[name="g-recaptcha-response"], #g-recaptcha-response'
1243 |             );
1244 |             textareas.forEach(ta => {
1245 |               ta.value = token;
1246 |               ta.innerHTML = token;
1247 |               success = true;
1248 |             });
1249 | 
1250 |             // 2. Wywo≈Çaj callback wykryty przez skrypt 2Captcha
1251 |             if (cbPath) {
1252 |               try {
1253 |                 // cbPath ma format: ___grecaptcha_cfg.clients['0']['X']['Y']['callback']
1254 |                 const callback = eval(cbPath);
1255 |                 if (typeof callback === 'function') {
1256 |                   callback(token);
1257 |                   success = true;
1258 |                   console.log('[2Captcha] Callback wywo≈Çany:', cbPath);
1259 |                 }
1260 |               } catch (e) {
1261 |                 console.log('[2Captcha] B≈ÇƒÖd callbacka:', e.message);
1262 |               }
1263 |             }
1264 | 
1265 |             // 3. Fallback - standardowe callbacki
1266 |             try { window.onCaptchaSuccess?.(token); } catch {}
1267 |             try { window.captchaCallback?.(token); } catch {}
1268 | 
1269 |             // 4. Szukaj callbacku w ___grecaptcha_cfg (g≈Çƒôboko)
1270 |             try {
1271 |               const cfg = window.___grecaptcha_cfg;
1272 |               if (cfg?.clients) {
1273 |                 for (const [cid, client] of Object.entries(cfg.clients)) {
1274 |                   for (const [key, obj] of Object.entries(client)) {
1275 |                     if (obj && typeof obj === 'object') {
1276 |                       for (const [subkey, subobj] of Object.entries(obj)) {
1277 |                         if (subobj && typeof subobj === 'object') {
1278 |                           if (typeof subobj.callback === 'function') {
1279 |                             subobj.callback(token);
1280 |                             success = true;
1281 |                             console.log('[2Captcha] Callback znaleziony w:', cid, key, subkey);
1282 |                           }
1283 |                         }
1284 |                       }
1285 |                     }
1286 |                   }
1287 |                 }
1288 |               }
1289 |             } catch {}
1290 | 
1291 |             return success;
1292 |           }, apiResult.token, callbackPath);
1293 | 
1294 |           log.dev("CAPTCHA", `Token reCAPTCHA wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
1295 |           await sleepRandom(1500, 2500);
1296 | 
1297 |           // Kliknij przycisk submit
1298 |           await clickSubmitButton(page);
1299 |           return true;
1300 |         } catch (err) {
1301 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu reCAPTCHA: ${err?.message}`);
1302 |         }
1303 |       }
1304 |     }
1305 |     // === NIEZNANY TYP ===
1306 |     else {
1307 |       log.warn("CAPTCHA", `Nieobs≈Çugiwany typ captcha: ${diagnosis.type}`);
1308 |       log.prod("CAPTCHA", "Szczeg√≥≈Çy diagnozy:", JSON.stringify(diagnosis.details, null, 2));
1309 |     }
1310 | 
1311 |     await sleepRandom(1000, 2000);
1312 |   }
1313 | 
1314 |   // Standardowe sprawdzenie captcha
1315 |   const captchaResult = await solveCaptchaIfPresent(page);
1316 |   if (captchaResult.solved) {
1317 |     log.success("LOGIN", "Captcha rozwiƒÖzana po logowaniu!");
1318 |     await sleepRandom(2000, 3000);
1319 | 
1320 |     // Po rozwiƒÖzaniu captcha, mo≈ºe trzeba kliknƒÖƒá submit ponownie
1321 |     const submitAfterCaptcha = await page.$('button[type="submit"], button[name="login"]');
1322 |     if (submitAfterCaptcha) {
1323 |       await submitAfterCaptcha.click().catch(() => {});
1324 |       await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
1325 |       await sleepRandom(1000, 2000);
1326 |     }
1327 |   }
1328 | 
1329 |   return true;
1330 | }
1331 | 
1332 | /**
1333 |  * Pr√≥ba logowania na dowolnym widocznym formularzu (z lokalnej wersji),
1334 |  * ale z lekkimi ulepszeniami i bez crashy.
1335 |  */
1336 | async function loginViaVisibleForm(page, context = "visible-form") {
1337 |   try {
1338 |     log.debug("LOGIN", `Szukam formularza (${context})...`);
1339 | 
1340 |     await acceptLoginCookies(page).catch(() => {});
1341 |     await acceptCookiesIfPresent(page).catch(() => {});
1342 | 
1343 |     const emailSelector = [
1344 |       "input#email",
1345 |       "input[name='email']",
1346 |       "input[name='email_or_phone']",
1347 |       "input[aria-label*='Adres e-mail']",
1348 |       "input[placeholder*='Adres e-mail']",
1349 |       "input[placeholder*='adres e-mail']",
1350 |       "input[placeholder*='Email']",
1351 |       "input[placeholder*='email']",
1352 |       "input[type='text']",
1353 |     ].join(",");
1354 | 
1355 |     const passSelector = [
1356 |       "input#pass",
1357 |       "input[name='pass']",
1358 |       "input[aria-label*='Has≈Ço']",
1359 |       "input[placeholder*='Has≈Ço']",
1360 |       "input[placeholder*='has≈Ço']",
1361 |       "input[placeholder*='Password']",
1362 |       "input[placeholder*='password']",
1363 |       "input[type='password']",
1364 |     ].join(",");
1365 | 
1366 |     const emailInput = await page.$(emailSelector).catch(() => null);
1367 |     const passInput = await page.$(passSelector).catch(() => null);
1368 | 
1369 |     if (!emailInput || !passInput) {
1370 |       log.debug("LOGIN", "Brak pe≈Çnego formularza na stronie");
1371 |       return false;
1372 |     }
1373 | 
1374 |     const ok = await fillLoginFormBestEffort(page);
1375 |     if (!ok) return false;
1376 | 
1377 |     log.dev("LOGIN", "Formularz logowania wys≈Çany");
1378 |     return true;
1379 |   } catch (err) {
1380 |     log.debug("LOGIN", `B≈ÇƒÖd formularza: ${err?.message || err}`);
1381 |     return false;
1382 |   }
1383 | }
1384 | 
1385 | /**
1386 |  * G≈Ç√≥wne logowanie ‚Äì NAJSTABILNIEJSZE: login.php?next=<URL>
1387 |  * Param nextUrl: URL posta, do kt√≥rego FB ma wr√≥ciƒá po loginie.
1388 |  */
1389 | async function fbLogin(page, nextUrl = "") {
1390 |   try {
1391 |     log.dev("LOGIN", "Start logowania...");
1392 | 
1393 |     const next = nextUrl ? `?next=${encodeURIComponent(nextUrl)}` : "";
1394 |     const url = `https://www.facebook.com/login.php${next}`;
1395 | 
1396 |     await page
1397 |       .goto(url, { waitUntil: "networkidle2", timeout: 60000 })
1398 |       .catch(() => {});
1399 | 
1400 |     await sleepRandom(900, 1400);
1401 | 
1402 |     // cookies ‚Äì dwie metody (mark+click oraz szybki fallback)
1403 |     await acceptLoginCookies(page).catch(() => {});
1404 |     await acceptCookiesIfPresent(page).catch(() => {});
1405 | 
1406 |     const ok = await fillLoginFormBestEffort(page);
1407 |     if (!ok) return false;
1408 | 
1409 |     // FB czasem zostaje na tej samej stronie ‚Äì dodatkowa pauza
1410 |     await sleepRandom(1200, 2000);
1411 | 
1412 |     return true;
1413 |   } catch (e) {
1414 |     log.debug("LOGIN", `B≈ÇƒÖd logowania: ${e?.message || e}`);
1415 |     return false;
1416 |   }
1417 | }
1418 | 
1419 | /**
1420 |  * Heurystyczny check sesji (jak serwer).
1421 |  */
1422 | async function checkIfLogged(page) {
1423 |   try {
1424 |     return await page.evaluate(() => {
1425 |       return !!(
1426 |         document.querySelector('input[aria-label*="Szukaj"]') ||
1427 |         document.querySelector('input[placeholder*="Szukaj"]') ||
1428 |         document.querySelector('a[aria-label*="Profil"]') ||
1429 |         document.querySelector('div[aria-label*="Konto"]')
1430 |       );
1431 |     });
1432 |   } catch {
1433 |     return false;
1434 |   }
1435 | }
1436 | 
1437 | /**
1438 |  * Klikniƒôcie elementu po dok≈Çadnym tek≈õcie (lokalny helper).
1439 |  */
1440 | async function clickByText(page, text) {
1441 |   const res = await page.evaluate((label) => {
1442 |     const els = Array.from(
1443 |       document.querySelectorAll("button, a, div[role='button'], span[role='button']")
1444 |     );
1445 |     const lowLabel = String(label || "").toLowerCase();
1446 |     for (const el of els) {
1447 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
1448 |       if (!t) continue;
1449 |       if (t === lowLabel) {
1450 |         el.click();
1451 |         return true;
1452 |       }
1453 |     }
1454 |     return false;
1455 |   }, text);
1456 |   return res;
1457 | }
1458 | 
1459 | /**
1460 |  * Heurystyka login-wall (serwerowa).
1461 |  * Uwaga: "Log In" czasem jest widoczne mimo, ≈ºe da siƒô czytaƒá komentarze,
1462 |  * wiƒôc to powinno odpalaƒá siƒô dopiero gdy UI nie potrafi odczytaƒá danych.
1463 |  */
1464 | async function looksLikeLoginWall(page) {
1465 |   try {
1466 |     return await page.evaluate(() => {
1467 |       const txt = (document.body?.innerText || "").toLowerCase();
1468 |       if (!txt) return false;
1469 | 
1470 |       const hasLoginWords =
1471 |         txt.includes("log in") ||
1472 |         txt.includes("sign up") ||
1473 |         txt.includes("create new account") ||
1474 |         txt.includes("zaloguj") ||
1475 |         txt.includes("zarejestruj");
1476 | 
1477 |       if (!hasLoginWords) return false;
1478 | 
1479 |       const hasLoginForm =
1480 |         !!document.querySelector("input[type='password']") ||
1481 |         !!document.querySelector("input#email") ||
1482 |         !!document.querySelector("input[name='email']");
1483 | 
1484 |       const hasPostWords =
1485 |         txt.includes("comment") ||
1486 |         txt.includes("comments") ||
1487 |         txt.includes("komentarz") ||
1488 |         txt.includes("lubiƒô to") ||
1489 |         txt.includes("like") ||
1490 |         txt.includes("reply") ||
1491 |         txt.includes("replied");
1492 | 
1493 |       return hasLoginForm || (hasLoginWords && !hasPostWords);
1494 |     });
1495 |   } catch {
1496 |     return false;
1497 |   }
1498 | }
1499 | 
1500 | /**
1501 |  * G≈Ç√≥wny ‚Äûw≈ÇƒÖcznik‚Äù do u≈ºycia w UI handlerach:
1502 |  * - je≈õli wyglƒÖda na login-wall -> login.php?next -> wr√≥ƒá na post
1503 |  * - fallback: pr√≥ba loginViaVisibleForm (gdyby FB zrobi≈Ç overlay)
1504 |  *
1505 |  * Param postUrl: najlepiej podaƒá URL posta (≈ºeby next= dzia≈Ça≈Ço idealnie)
1506 |  */
1507 | async function ensureLoggedInOnPostOverlay(page, postUrl = "") {
1508 |   try {
1509 |     const cur = page.url();
1510 |     const target = postUrl || cur;
1511 | 
1512 |     const wall = await looksLikeLoginWall(page);
1513 |     if (!wall) return false;
1514 | 
1515 |     log.dev("LOGIN", "Wykryto login-wall ‚Üí pr√≥ba logowania");
1516 | 
1517 |     const tried = await fbLogin(page, target);
1518 | 
1519 |     let logged = await checkIfLogged(page);
1520 |     log.dev("LOGIN", `Sesja po fbLogin: ${logged ? "OK" : "BRAK"}`);
1521 | 
1522 |     // je≈õli FB nie przerzuci≈Ç automatycznie, wr√≥ƒá na post
1523 |     if (target && norm(page.url()) !== norm(target)) {
1524 |       await page
1525 |         .goto(target, { waitUntil: "networkidle2", timeout: 60000 })
1526 |         .catch(() => {});
1527 |       await sleepRandom(900, 1400);
1528 |     }
1529 | 
1530 |     // jeszcze raz sprawd≈∫ sesjƒô po powrocie
1531 |     logged = await checkIfLogged(page);
1532 | 
1533 |     // fallback: gdyby FB nadal siedzia≈Ç na overlayu, spr√≥buj visible-form
1534 |     if (!logged) {
1535 |       const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
1536 |       if (usedInline) {
1537 |         logged = await checkIfLogged(page);
1538 |         log.dev("LOGIN", `Sesja po visible-form: ${logged ? "OK" : "BRAK"}`);
1539 |       }
1540 |     }
1541 | 
1542 |     return tried && logged;
1543 |   } catch (e) {
1544 |     log.debug("LOGIN", `ensureLoggedInOnPostOverlay error: ${e?.message || e}`);
1545 |     return false;
1546 |   }
1547 | }
1548 | 
1549 | /**
1550 |  * Wykrywa obecno≈õƒá captcha na stronie (reCAPTCHA, hCaptcha, itp.)
1551 |  */
1552 | async function hasCaptcha(page) {
1553 |   try {
1554 |     const result = await page.evaluate(() => {
1555 |       // reCAPTCHA v2/v3 - rozszerzone selektory
1556 |       const recaptchaSelectors = [
1557 |         'iframe[src*="recaptcha"]',
1558 |         'iframe[src*="google.com/recaptcha"]',
1559 |         'iframe[title*="reCAPTCHA"]',
1560 |         'iframe[title*="recaptcha"]',
1561 |         '.g-recaptcha',
1562 |         '#recaptcha',
1563 |         '[data-sitekey]',
1564 |         '.rc-anchor',
1565 |         '.recaptcha-checkbox',
1566 |       ].join(',');
1567 | 
1568 |       const recaptcha = document.querySelector(recaptchaSelectors);
1569 | 
1570 |       // hCaptcha
1571 |       const hcaptcha = document.querySelector(
1572 |         'iframe[src*="hcaptcha"], .h-captcha'
1573 |       );
1574 | 
1575 |       // Facebook image captcha
1576 |       const fbCaptcha = document.querySelector(
1577 |         'img[src*="captcha"], input[name*="captcha"]'
1578 |       );
1579 | 
1580 |       // Tekst "Nie jestem robotem" / "I'm not a robot" na stronie
1581 |       const bodyText = (document.body?.innerText || '').toLowerCase();
1582 |       const hasRobotText = bodyText.includes('nie jestem robotem') ||
1583 |                           bodyText.includes("i'm not a robot") ||
1584 |                           bodyText.includes('recaptcha');
1585 | 
1586 |       // URL zawiera verification/authentication z recaptcha
1587 |       const url = window.location.href.toLowerCase();
1588 |       const isVerificationPage = url.includes('two_step_verification') ||
1589 |                                   url.includes('checkpoint');
1590 | 
1591 |       return {
1592 |         found: !!(recaptcha || hcaptcha || fbCaptcha || (hasRobotText && isVerificationPage)),
1593 |         details: {
1594 |           recaptcha: !!recaptcha,
1595 |           hcaptcha: !!hcaptcha,
1596 |           fbCaptcha: !!fbCaptcha,
1597 |           robotText: hasRobotText,
1598 |           verificationPage: isVerificationPage
1599 |         }
1600 |       };
1601 |     });
1602 | 
1603 |     if (result.found) {
1604 |       log.debug("CAPTCHA", "Wykryto captcha", result.details);
1605 |     }
1606 | 
1607 |     return result.found;
1608 |   } catch {
1609 |     return false;
1610 |   }
1611 | }
1612 | 
1613 | /**
1614 |  * Pr√≥buje rozwiƒÖzaƒá captcha na stronie (je≈õli plugin 2Captcha jest w≈ÇƒÖczony).
1615 |  * Wymaga puppeteer-extra-plugin-recaptcha.
1616 |  * @returns {Promise<{solved: boolean, error?: string}>}
1617 |  */
1618 | async function solveCaptchaIfPresent(page) {
1619 |   if (!CAPTCHA_ENABLED) {
1620 |     log.debug("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
1621 |     return { solved: false, error: "disabled" };
1622 |   }
1623 | 
1624 |   try {
1625 |     const detected = await hasCaptcha(page);
1626 |     if (!detected) {
1627 |       log.debug("CAPTCHA", "Brak captcha na stronie");
1628 |       return { solved: false, error: "no_captcha" };
1629 |     }
1630 | 
1631 |     log.prod("CAPTCHA", "Wykryto captcha - rozpoczynam rozwiƒÖzywanie...");
1632 | 
1633 |     // puppeteer-extra-plugin-recaptcha dodaje metodƒô solveRecaptchas() do page
1634 |     if (typeof page.solveRecaptchas !== "function") {
1635 |       log.warn("CAPTCHA", "Plugin recaptcha nie jest za≈Çadowany");
1636 |       return { solved: false, error: "plugin_not_loaded" };
1637 |     }
1638 | 
1639 |     const result = await page.solveRecaptchas();
1640 | 
1641 |     if (result.solved && result.solved.length > 0) {
1642 |       log.prod("CAPTCHA", `RozwiƒÖzano ${result.solved.length} captcha!`);
1643 |       await sleepRandom(1000, 2000);
1644 |       return { solved: true };
1645 |     } else if (result.error) {
1646 |       log.warn("CAPTCHA", `B≈ÇƒÖd rozwiƒÖzywania: ${result.error}`);
1647 |       return { solved: false, error: result.error };
1648 |     } else {
1649 |       log.debug("CAPTCHA", "Brak captcha do rozwiƒÖzania (lub nieobs≈Çugiwany typ)");
1650 |       return { solved: false, error: "unsupported_or_none" };
1651 |     }
1652 |   } catch (err) {
1653 |     log.warn("CAPTCHA", `WyjƒÖtek: ${err?.message || err}`);
1654 |     return { solved: false, error: err?.message || "unknown" };
1655 |   }
1656 | }
1657 | 
1658 | export {
1659 |   fbLogin,
1660 |   checkIfLogged,
1661 |   ensureLoggedInOnPostOverlay,
1662 |   clickByText,
1663 |   acceptLoginCookies,
1664 |   loginViaVisibleForm,
1665 |   hasCaptcha,
1666 |   solveCaptchaIfPresent,
1667 | };
1668 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/scroll.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
 1 | import { gaussianRandom, sleep } from "../utils/sleep.js";
 2 | 
 3 | /**
 4 |  * Scrollowanie posta - p≈Çynne, human-like
 5 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
 6 |  * - scrollujemy w ma≈Çych krokach z losowymi op√≥≈∫nieniami
 7 |  */
 8 | async function scrollPost(page, amount = 450) {
 9 |   // Human behavior: scrolluj w ma≈Çych krokach (jak k√≥≈Çko myszy)
10 |   const steps = Math.max(3, Math.ceil(amount / 80)); // ~80px na krok
11 |   const stepAmount = Math.round(amount / steps);
12 | 
13 |   for (let i = 0; i < steps; i++) {
14 |     await page.evaluate((dy) => {
15 |       function findScrollableAncestor(start) {
16 |         let el = start;
17 |         while (el) {
18 |           const style = window.getComputedStyle(el);
19 |           const canScrollY =
20 |             style.overflowY === "auto" || style.overflowY === "scroll";
21 |           if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
22 |             return el;
23 |           }
24 |           el = el.parentElement;
25 |         }
26 |         return null;
27 |       }
28 | 
29 |       // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
30 |       const centerEl = document.elementFromPoint(
31 |         window.innerWidth / 2,
32 |         window.innerHeight / 2
33 |       );
34 | 
35 |       let target = centerEl ? findScrollableAncestor(centerEl) : null;
36 | 
37 |       // fallback: dialog
38 |       if (!target) {
39 |         const dialog = document.querySelector("div[role='dialog']");
40 |         if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
41 |           target = dialog;
42 |         }
43 |       }
44 | 
45 |       // ostateczny fallback: dokument
46 |       if (!target) {
47 |         target =
48 |           document.scrollingElement || document.documentElement || document.body;
49 |       }
50 | 
51 |       if (
52 |         target === document.body ||
53 |         target === document.documentElement ||
54 |         target === document.scrollingElement
55 |       ) {
56 |         const before = window.scrollY;
57 |         window.scrollTo(0, before + dy);
58 |       } else {
59 |         target.scrollTop += dy;
60 |       }
61 |     }, stepAmount);
62 | 
63 |     // Human delay miƒôdzy krokami scrollowania (30-80ms)
64 |     if (i < steps - 1) {
65 |       const delay = gaussianRandom(50, 15);
66 |       await sleep(Math.max(20, Math.min(100, delay)));
67 |     }
68 |   }
69 | }
70 | 
71 | export { scrollPost };
72 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
 1 | // src/fb/ui/index.js
 2 | import * as PostUI from "./post.js";
 3 | import * as PhotoUI from "./photo.js";
 4 | import * as WatchUI from "./watch.js";
 5 | import * as VideosUI from "./videos.js";
 6 | 
 7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
 8 | 
 9 | export function pickUiHandler(url) {
10 |   const u = String(url || "");
11 |   for (const h of HANDLERS) {
12 |     try {
13 |       if (h.matchesUrl(u)) return h;
14 |     } catch {}
15 |   }
16 |   return PostUI;
17 | }
18 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/photo.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
   1 | // src/fb/ui/photo.js
   2 | import { safeGoto } from "../../utils/navigation.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { scrollPost } from "../scroll.js";
   5 | import { acceptCookies, saveCookies } from "../cookies.js";
   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
   7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
   8 | import log from "../../utils/logger.js";
   9 | 
  10 | export const type = "photo";
  11 | 
  12 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
  13 | 
  14 | /**
  15 |  * WA≈ªNE:
  16 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
  17 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
  18 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
  19 |  */
  20 | const PACE_CFG =
  21 |   PACE === "server"
  22 |     ? {
  23 |         // delikatnie wolniej na serwerze (render/CPU)
  24 |         stepJitterMinMs: 140,
  25 |         stepJitterMaxMs: 260,
  26 | 
  27 |         afterScrollMinMs: 260,
  28 |         afterScrollMaxMs: 520,
  29 | 
  30 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
  31 |         effectWaitMs: 5200,
  32 | 
  33 |         scrollPx: 140,
  34 | 
  35 |         // bonusowe kliki, ale event-driven
  36 |         bonusClickTries: 2,
  37 |         bonusClickDelayMinMs: 120,
  38 |         bonusClickDelayMaxMs: 220,
  39 | 
  40 |         // HARD BOTTOM (sprawdzane rzadko)
  41 |         hardBottomEpsPx: 10,
  42 |         hardBottomStableNeed: 4,
  43 |         hardBottomStableDelayMinMs: 320,
  44 |         hardBottomStableDelayMaxMs: 560,
  45 |       }
  46 |     : {
  47 |         // lokalnie szybciej
  48 |         stepJitterMinMs: 90,
  49 |         stepJitterMaxMs: 190,
  50 | 
  51 |         afterScrollMinMs: 180,
  52 |         afterScrollMaxMs: 420,
  53 | 
  54 |         effectWaitMs: 4200,
  55 | 
  56 |         scrollPx: 160,
  57 | 
  58 |         bonusClickTries: 2,
  59 |         bonusClickDelayMinMs: 90,
  60 |         bonusClickDelayMaxMs: 180,
  61 | 
  62 |         hardBottomEpsPx: 10,
  63 |         hardBottomStableNeed: 4,
  64 |         hardBottomStableDelayMinMs: 240,
  65 |         hardBottomStableDelayMaxMs: 420,
  66 |       };
  67 | 
  68 | export function matchesUrl(url) {
  69 |   try {
  70 |     const u = new URL(url);
  71 |     const path = (u.pathname || "").toLowerCase();
  72 | 
  73 |     if (path.includes("photo.php")) return true;
  74 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
  75 |     if (u.searchParams.has("fbid")) return true;
  76 | 
  77 |     return false;
  78 |   } catch {
  79 |     const lower = (url || "").toLowerCase();
  80 |     if (lower.includes("photo.php")) return true;
  81 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
  82 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
  83 |     return false;
  84 |   }
  85 | }
  86 | 
  87 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
  88 | 
  89 | async function clickAllCommentsInMenu(page) {
  90 |   const result = await page.evaluate(() => {
  91 |     const menu =
  92 |       document.querySelector("div[role='menu']") ||
  93 |       document.querySelector("div[role='dialog']");
  94 | 
  95 |     if (!menu) return { clicked: false, noMenu: true };
  96 | 
  97 |     const items = Array.from(
  98 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
  99 |     );
 100 | 
 101 |     const opt = items.find((el) => {
 102 |       const t = (el.textContent || "").trim().toLowerCase();
 103 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
 104 |     });
 105 | 
 106 |     if (!opt) return { clicked: false, noMenu: false };
 107 | 
 108 |     opt.click();
 109 |     setTimeout(() => {
 110 |       try {
 111 |         document.body.click();
 112 |       } catch {}
 113 |     }, 50);
 114 | 
 115 |     return { clicked: true, noMenu: false };
 116 |   });
 117 | 
 118 |   if (result.clicked) {
 119 |     await sleepRandom(180, 320);
 120 |     await page
 121 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
 122 |       .catch(() => {});
 123 |   }
 124 | 
 125 |   return result;
 126 | }
 127 | 
 128 | async function switchCommentsFilterToAll(page) {
 129 |   log.debug("UI:photo", "Prze≈ÇƒÖczam filtr ‚Üí wszystkie komentarze");
 130 | 
 131 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 132 |   if (menuAlreadyOpen) {
 133 |     const r = await clickAllCommentsInMenu(page);
 134 |     return !!r.clicked;
 135 |   }
 136 | 
 137 |   const pre = await page.evaluate(() => {
 138 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 139 |     let filterEl = null;
 140 |     let labelText = "";
 141 | 
 142 |     for (const el of els) {
 143 |       const t = (el.textContent || "").trim();
 144 |       if (!t) continue;
 145 |       const low = t.toLowerCase();
 146 |       if (
 147 |         low === "najtrafniejsze" ||
 148 |         low === "most relevant" ||
 149 |         low === "wszystkie komentarze" ||
 150 |         low === "all comments"
 151 |       ) {
 152 |         filterEl = el;
 153 |         labelText = low;
 154 |         break;
 155 |       }
 156 |     }
 157 | 
 158 |     if (!filterEl) return { state: "not-found" };
 159 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 160 |       return { state: "already-all" };
 161 |     }
 162 | 
 163 |     filterEl.click();
 164 |     return { state: "clicked-filter" };
 165 |   });
 166 | 
 167 |   if (pre.state === "not-found") return false;
 168 |   if (pre.state === "already-all") return true;
 169 | 
 170 |   await sleepRandom(120, 220);
 171 |   const r = await clickAllCommentsInMenu(page);
 172 |   if (r.clicked) return true;
 173 | 
 174 |   const afterLabelIsAll = await page.evaluate(() => {
 175 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 176 |     return els.some((el) => {
 177 |       const t = (el.textContent || "").trim().toLowerCase();
 178 |       return t === "wszystkie komentarze" || t === "all comments";
 179 |     });
 180 |   });
 181 | 
 182 |   return afterLabelIsAll;
 183 | }
 184 | 
 185 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
 186 | 
 187 | async function getCommentsRootHandle(page) {
 188 |   const handle = await page.evaluateHandle(() => {
 189 |     const norm = (s) =>
 190 |       String(s || "")
 191 |         .replace(/\u00a0/g, " ")
 192 |         .replace(/\s+/g, " ")
 193 |         .trim()
 194 |         .toLowerCase();
 195 | 
 196 |     const isVisible = (el) => {
 197 |       if (!el) return false;
 198 |       try {
 199 |         const r = el.getBoundingClientRect();
 200 |         return r.width > 2 && r.height > 2;
 201 |       } catch {
 202 |         return true;
 203 |       }
 204 |     };
 205 | 
 206 |     const isMoreCommentsBtn = (el) => {
 207 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 208 |       if (!t) return false;
 209 |       return (
 210 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 211 |         t.includes("zobacz wiƒôcej komentarzy") ||
 212 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
 213 |         t.includes("view more comments") ||
 214 |         t.includes("view previous comments")
 215 |       );
 216 |     };
 217 | 
 218 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
 219 |       isVisible
 220 |     );
 221 |     const keyBtn = btns.find(isMoreCommentsBtn);
 222 | 
 223 |     if (keyBtn) {
 224 |       const dlg = keyBtn.closest?.("div[role='dialog']");
 225 |       if (dlg) return dlg;
 226 | 
 227 |       let cur = keyBtn.parentElement;
 228 |       for (let i = 0; i < 20 && cur; i++) {
 229 |         if (cur.matches?.("article,main,section,div")) return cur;
 230 |         cur = cur.parentElement;
 231 |       }
 232 |     }
 233 | 
 234 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 235 |     const dlg2 = dialogs.find((d) => {
 236 |       const t = norm(d.innerText || d.textContent);
 237 |       if (!t) return false;
 238 |       if (t.includes("powiadomienia")) return false;
 239 |       if (t.includes("szukaj znajomych")) return false;
 240 |       return (
 241 |         t.includes("najtrafniejsze") ||
 242 |         t.includes("most relevant") ||
 243 |         t.includes("komentarz") ||
 244 |         t.includes("comment")
 245 |       );
 246 |     });
 247 |     if (dlg2) return dlg2;
 248 | 
 249 |     return document.body;
 250 |   });
 251 | 
 252 |   return handle;
 253 | }
 254 | 
 255 | async function getCommentsScrollHandle(page, rootHandle) {
 256 |   const handle = await page.evaluateHandle((root) => {
 257 |     const isVisible = (el) => {
 258 |       if (!el) return false;
 259 |       try {
 260 |         const r = el.getBoundingClientRect();
 261 |         return r.width > 2 && r.height > 2;
 262 |       } catch {
 263 |         return true;
 264 |       }
 265 |     };
 266 | 
 267 |     const canScrollByTest = (el) => {
 268 |       try {
 269 |         if (!el) return false;
 270 |         const h = el.clientHeight || 0;
 271 |         const sh = el.scrollHeight || 0;
 272 |         if (sh <= h + 40) return false;
 273 | 
 274 |         const before = el.scrollTop ?? 0;
 275 |         el.scrollTop = before + 80;
 276 |         const after = el.scrollTop ?? before;
 277 |         el.scrollTop = before;
 278 | 
 279 |         return after !== before;
 280 |       } catch {
 281 |         return false;
 282 |       }
 283 |     };
 284 | 
 285 |     const closestScrollable = (start) => {
 286 |       let cur = start;
 287 |       for (let i = 0; i < 28 && cur; i++) {
 288 |         if (canScrollByTest(cur)) return cur;
 289 |         cur = cur.parentElement;
 290 |       }
 291 |       return null;
 292 |     };
 293 | 
 294 |     const scope = root || document;
 295 | 
 296 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
 297 |     if (outer) {
 298 |       const sc = closestScrollable(outer);
 299 |       if (sc) return sc;
 300 |     }
 301 | 
 302 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
 303 |       .filter(isVisible)
 304 |       .slice(0, 25000);
 305 | 
 306 |     let best = null;
 307 |     let bestDelta = -1;
 308 |     for (const el of candidates) {
 309 |       if (!canScrollByTest(el)) continue;
 310 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
 311 |       if (delta > bestDelta) {
 312 |         bestDelta = delta;
 313 |         best = el;
 314 |       }
 315 |     }
 316 | 
 317 |     return best || null;
 318 |   }, rootHandle);
 319 | 
 320 |   return handle;
 321 | }
 322 | 
 323 | /* ======================================================================== */
 324 | 
 325 | export async function prepare(page, url) {
 326 |   log.dev("UI:photo", `Prepare: ${url}`);
 327 | 
 328 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 329 |   if (!ok) throw new Error("safeGoto-failed");
 330 | 
 331 |   if (page.url().includes("/login")) {
 332 |     log.dev("UI:photo", "/login ‚Äì fbLogin + re-enter");
 333 |     await fbLogin(page);
 334 |     await sleepRandom(2500, 4000);
 335 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 336 |   }
 337 | 
 338 |   await acceptCookies(page, "photo-initial");
 339 | 
 340 |   const logged = await checkIfLogged(page).catch(() => false);
 341 |   if (!logged) {
 342 |     log.dev("UI:photo", "Brak sesji ‚Äì fbLogin()");
 343 |     await fbLogin(page);
 344 |     await sleepRandom(2500, 4000);
 345 |   }
 346 | 
 347 |   await ensureLoggedInOnPostOverlay(page);
 348 |   await acceptCookies(page, "photo");
 349 | 
 350 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
 351 |   if (loggedFinal) await saveCookies(page);
 352 | }
 353 | 
 354 | function parseNumberLikeNode(str) {
 355 |   if (!str) return null;
 356 | 
 357 |   const cleaned = String(str)
 358 |     .toLowerCase()
 359 |     .replace(/\u00a0/g, " ")
 360 |     .replace(/\s+/g, " ")
 361 |     .trim();
 362 | 
 363 |   const plain = cleaned.replace(/[^\d]/g, "");
 364 |   if (/^\d+$/.test(plain)) {
 365 |     const n = Number(plain);
 366 |     return Number.isFinite(n) ? n : null;
 367 |   }
 368 | 
 369 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 370 |   if (m) {
 371 |     const base = Number(m[1].replace(",", "."));
 372 |     if (Number.isFinite(base)) return Math.round(base * 1000);
 373 |   }
 374 | 
 375 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 376 |   if (m2) {
 377 |     const base = Number(m2[1].replace(",", "."));
 378 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
 379 |   }
 380 | 
 381 |   return null;
 382 | }
 383 | 
 384 | async function getPhotoUiCountFromChip(page, rootHandle) {
 385 |   const res = await page
 386 |     .evaluate((root) => {
 387 |       const scope = root || document;
 388 | 
 389 |       const norm = (s) =>
 390 |         String(s || "")
 391 |           .replace(/\u00a0/g, " ")
 392 |           .replace(/\s+/g, " ")
 393 |           .trim();
 394 | 
 395 |       const parseNum = (s) => {
 396 |         const t = norm(s);
 397 |         if (!t) return null;
 398 | 
 399 |         const plain = t.replace(/[^\d]/g, "");
 400 |         if (/^\d+$/.test(plain)) return Number(plain);
 401 | 
 402 |         const lower = t.toLowerCase();
 403 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 404 |         if (m) {
 405 |           const base = Number(m[1].replace(",", "."));
 406 |           if (Number.isFinite(base)) return Math.round(base * 1000);
 407 |         }
 408 | 
 409 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 410 |         if (m2) {
 411 |           const base = Number(m2[1].replace(",", "."));
 412 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
 413 |         }
 414 | 
 415 |         return null;
 416 |       };
 417 | 
 418 |       const isVisible = (el) => {
 419 |         if (!el) return false;
 420 |         const r = el.getBoundingClientRect();
 421 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
 422 |       };
 423 | 
 424 |       const commentBtn = Array.from(
 425 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
 426 |       ).find((el) => {
 427 |         const t = norm(el.textContent).toLowerCase();
 428 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
 429 |       });
 430 | 
 431 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
 432 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
 433 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
 434 | 
 435 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
 436 |         .filter(isVisible)
 437 |         .slice(0, 5000);
 438 | 
 439 |       let best = null;
 440 |       let bestScore = -Infinity;
 441 | 
 442 |       for (const el of candidates) {
 443 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
 444 |         if (!hasIcon) continue;
 445 | 
 446 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
 447 |         let num = null;
 448 |         let raw = null;
 449 | 
 450 |         for (const sp of spans) {
 451 |           const t = norm(sp.textContent);
 452 |           if (!t) continue;
 453 |           if (t.length > 24) continue;
 454 | 
 455 |           const n = parseNum(t);
 456 |           if (typeof n === "number" && Number.isFinite(n)) {
 457 |             if (n <= 0 || n > 10000000) continue;
 458 |             num = n;
 459 |             raw = t;
 460 |             break;
 461 |           }
 462 |         }
 463 | 
 464 |         if (num == null) continue;
 465 | 
 466 |         const r = el.getBoundingClientRect();
 467 |         const cx = r.left + r.width / 2;
 468 |         const cy = r.top + r.height / 2;
 469 | 
 470 |         let score = 0;
 471 | 
 472 |         if (anchorCx != null && anchorCy != null) {
 473 |           const dx = cx - anchorCx;
 474 |           const dy = cy - anchorCy;
 475 |           const dist = Math.sqrt(dx * dx + dy * dy);
 476 |           score -= dist;
 477 |         }
 478 | 
 479 |         const textLen = norm(el.textContent).length;
 480 |         score -= Math.min(400, textLen);
 481 | 
 482 |         score += Math.min(200, Math.log10(num + 1) * 120);
 483 | 
 484 |         if (score > bestScore) {
 485 |           bestScore = score;
 486 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
 487 |         }
 488 |       }
 489 | 
 490 |       return best;
 491 |     }, rootHandle)
 492 |     .catch(() => null);
 493 | 
 494 |   if (!res || typeof res.count !== "number") return null;
 495 |   return { count: res.count, raw: res.raw, dbg: res };
 496 | }
 497 | 
 498 | export async function getCommentCount(page, url) {
 499 |   log.dev("UI:photo", "Liczƒô komentarze...");
 500 | 
 501 |   await scrollPost(page, 220);
 502 |   await sleepRandom(220, 420);
 503 | 
 504 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
 505 |   log.debug("UI:photo", `Filtr all comments: ${okFilter}`);
 506 | 
 507 |   // mikro settle po filtrze (bez mulenia)
 508 |   await sleepRandom(220, 420);
 509 | 
 510 |   const rootHandle = await getCommentsRootHandle(page);
 511 | 
 512 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
 513 |   if (chip?.count != null) {
 514 |     log.debug("UI:photo", "UI count (chip)", chip);
 515 |   }
 516 | 
 517 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
 518 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
 519 | 
 520 |   const loaded = await page
 521 |     .evaluate((root) => {
 522 |       const scope = root || document;
 523 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 524 |       const ids = new Set();
 525 |       for (const a of as) {
 526 |         const href = a.getAttribute("href") || "";
 527 |         const m = href.match(/comment_id=([^&]+)/);
 528 |         if (m && m[1]) ids.add(m[1]);
 529 |       }
 530 |       return ids.size || null;
 531 |     }, rootHandle)
 532 |     .catch(() => null);
 533 | 
 534 |   let total = null;
 535 |   let source = "none";
 536 | 
 537 |   if (chip?.count != null) {
 538 |     total = chip.count;
 539 |     source = "ui-photo-chip";
 540 |   } else if (infoCount != null) {
 541 |     total = infoCount;
 542 |     source = uiInfo?.source || "uicommentinfo";
 543 |   } else if (loaded != null) {
 544 |     total = loaded;
 545 |     source = "loaded-comment_id";
 546 |   }
 547 | 
 548 |   log.debug("UI:photo", "UI comments", {
 549 |     source,
 550 |     chip: chip?.count ?? null,
 551 |     uiInfoSource: uiInfo?.source ?? null,
 552 |     uiInfoRaw: uiInfo?.raw ?? null,
 553 |     uiInfoCount: infoCount,
 554 |     loaded,
 555 |     chosen: total,
 556 |   });
 557 | 
 558 |   try {
 559 |     await rootHandle.dispose?.();
 560 |   } catch {}
 561 | 
 562 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
 563 |   await sleepRandom(180, 340);
 564 | 
 565 |   return total;
 566 | }
 567 | 
 568 | export async function loadAllComments(page, { expectedTotal } = {}) {
 569 |   log.dev("UI:photo", `loadAllComments expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
 570 | 
 571 |   const MAX_STEPS = 900;
 572 |   const MAX_NO_PROGRESS = 28;
 573 | 
 574 |   let noProgress = 0;
 575 | 
 576 |   const rootHandle = await getCommentsRootHandle(page);
 577 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
 578 | 
 579 |   const shortBtn = (t) => {
 580 |     const s = String(t || "").replace(/\s+/g, " ").trim();
 581 |     if (s.length <= 90) return s;
 582 |     return s.slice(0, 90) + "‚Ä¶";
 583 |   };
 584 | 
 585 |   async function countAnchors() {
 586 |     return page.evaluate((root) => {
 587 |       const scope = root || document;
 588 | 
 589 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 590 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
 591 | 
 592 |       const uniq = (arr, param) => {
 593 |         const ids = new Set();
 594 |         for (const a of arr) {
 595 |           const href = a.getAttribute("href") || "";
 596 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
 597 |           if (m && m[1]) ids.add(m[1]);
 598 |         }
 599 |         return ids.size;
 600 |       };
 601 | 
 602 |       return {
 603 |         commentsAnchors: uniq(commentAs, "comment_id"),
 604 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
 605 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
 606 |       };
 607 |     }, rootHandle);
 608 |   }
 609 | 
 610 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
 611 |     try {
 612 |       const info = await page.evaluate((root, scroller, px) => {
 613 |         const pick =
 614 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
 615 | 
 616 |         const before =
 617 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 618 | 
 619 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
 620 |         else window.scrollBy(0, px);
 621 | 
 622 |         const after =
 623 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 624 | 
 625 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
 626 |       }, rootHandle, scrollHandle, pixels);
 627 | 
 628 |       if (!info?.moved) {
 629 |         log.debug("UI:photo", `Scroll NO-MOVE tag=${info?.tag} ${info?.before}‚Üí${info?.after}`);
 630 |       }
 631 |     } catch {
 632 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
 633 |     }
 634 | 
 635 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
 636 |   }
 637 | 
 638 |   async function getScrollMetrics() {
 639 |     return page.evaluate((root, scroller) => {
 640 |       const pick =
 641 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 642 | 
 643 |       const isEl = pick && typeof pick.scrollHeight === "number";
 644 | 
 645 |       if (!isEl) {
 646 |         const se = document.scrollingElement || document.documentElement || document.body;
 647 |         return {
 648 |           tag: "WINDOW",
 649 |           scrollTop: window.scrollY || 0,
 650 |           scrollHeight: se?.scrollHeight || 0,
 651 |           clientHeight: window.innerHeight || 0,
 652 |         };
 653 |       }
 654 | 
 655 |       return {
 656 |         tag: pick.tagName || "UNKNOWN",
 657 |         scrollTop: pick.scrollTop || 0,
 658 |         scrollHeight: pick.scrollHeight || 0,
 659 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
 660 |       };
 661 |     }, rootHandle, scrollHandle);
 662 |   }
 663 | 
 664 |   async function hasLoadMoreButtons() {
 665 |     return page.evaluate((root) => {
 666 |       const scope = root || document;
 667 | 
 668 |       const norm = (s) =>
 669 |         String(s || "")
 670 |           .replace(/\u00a0/g, " ")
 671 |           .replace(/\s+/g, " ")
 672 |           .trim()
 673 |           .toLowerCase();
 674 | 
 675 |       const isVisible = (el) => {
 676 |         if (!el) return false;
 677 |         const r = el.getBoundingClientRect();
 678 |         if (r.width < 2 || r.height < 2) return false;
 679 |         return r.bottom > 0 && r.top < window.innerHeight;
 680 |       };
 681 | 
 682 |       const nodesBtn = Array.from(
 683 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 684 |       ).filter(isVisible);
 685 | 
 686 |       return nodesBtn.some((el) => {
 687 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 688 | 
 689 |         if (
 690 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 691 |           t.includes("zobacz wiƒôcej komentarzy") ||
 692 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 693 |           t.includes("view more comments") ||
 694 |           t.includes("view previous comments")
 695 |         )
 696 |           return true;
 697 | 
 698 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 699 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 700 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 701 |         if (t.includes("view") && t.includes("repl")) return true;
 702 |         if (t.includes("see") && t.includes("repl")) return true;
 703 | 
 704 |         return false;
 705 |       });
 706 |     }, rootHandle);
 707 |   }
 708 | 
 709 |   function isHardBottom(m) {
 710 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
 711 |     const top = Number(m?.scrollTop || 0);
 712 |     const ch = Number(m?.clientHeight || 0);
 713 |     const sh = Number(m?.scrollHeight || 0);
 714 |     if (!sh || !ch) return false;
 715 |     return top + ch >= sh - eps;
 716 |   }
 717 | 
 718 |   let bottomStable = 0;
 719 |   let lastBottomScrollHeight = null;
 720 | 
 721 |   async function updateHardBottomStability() {
 722 |     const m1 = await getScrollMetrics().catch(() => null);
 723 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
 724 | 
 725 |     const atBottom = isHardBottom(m1);
 726 | 
 727 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
 728 | 
 729 |     const m2 = await getScrollMetrics().catch(() => m1);
 730 |     const atBottom2 = isHardBottom(m2);
 731 | 
 732 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
 733 | 
 734 |     const sh = Number(m2?.scrollHeight || 0);
 735 |     const shStable =
 736 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
 737 | 
 738 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
 739 |     else bottomStable = 0;
 740 | 
 741 |     lastBottomScrollHeight = sh;
 742 | 
 743 |     return {
 744 |       atBottom: atBottom && atBottom2,
 745 |       stable: bottomStable,
 746 |       tag: m2?.tag || "UNKNOWN",
 747 |       anyMore,
 748 |       scrollTop: m2?.scrollTop,
 749 |       clientHeight: m2?.clientHeight,
 750 |       scrollHeight: m2?.scrollHeight,
 751 |     };
 752 |   }
 753 | 
 754 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
 755 |   async function waitForEffect(beforeCounts, kind) {
 756 |     const timeout = PACE_CFG.effectWaitMs;
 757 | 
 758 |     const ok = await page
 759 |       .waitForFunction(
 760 |         (root, before, kindArg) => {
 761 |           const scope = root || document;
 762 | 
 763 |           const countUniq = (sel, param) => {
 764 |             const as = Array.from(scope.querySelectorAll(sel));
 765 |             const ids = new Set();
 766 |             for (const a of as) {
 767 |               const href = a.getAttribute("href") || "";
 768 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
 769 |               if (m && m[1]) ids.add(m[1]);
 770 |             }
 771 |             return ids.size;
 772 |           };
 773 | 
 774 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
 775 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
 776 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
 777 | 
 778 |           if (
 779 |             commentsAnchors > (before?.commentsAnchors || 0) ||
 780 |             replyAnchors > (before?.replyAnchors || 0) ||
 781 |             nodes > (before?.nodes || 0)
 782 |           ) {
 783 |             return true;
 784 |           }
 785 | 
 786 |           const norm = (s) =>
 787 |             String(s || "")
 788 |               .replace(/\u00a0/g, " ")
 789 |               .replace(/\s+/g, " ")
 790 |               .trim()
 791 |               .toLowerCase();
 792 | 
 793 |           const isVisible = (el) => {
 794 |             if (!el) return false;
 795 |             const r = el.getBoundingClientRect();
 796 |             if (r.width < 2 || r.height < 2) return false;
 797 |             return r.bottom > 0 && r.top < window.innerHeight;
 798 |           };
 799 | 
 800 |           const nodesBtn = Array.from(
 801 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 802 |           ).filter(isVisible);
 803 | 
 804 |           const stillThere =
 805 |             kindArg === "comments"
 806 |               ? nodesBtn.some((el) => {
 807 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 808 |                   return (
 809 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 810 |                     t.includes("zobacz wiƒôcej komentarzy") ||
 811 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
 812 |                     t.includes("view more comments") ||
 813 |                     t.includes("view previous comments")
 814 |                   );
 815 |                 })
 816 |               : nodesBtn.some((el) => {
 817 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 818 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 819 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 820 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
 821 |                   if (t.includes("view") && t.includes("repl")) return true;
 822 |                   if (t.includes("see") && t.includes("repl")) return true;
 823 |                   return false;
 824 |                 });
 825 | 
 826 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
 827 |           return !stillThere;
 828 |         },
 829 |         { timeout, polling: 120 },
 830 |         rootHandle,
 831 |         beforeCounts,
 832 |         kind
 833 |       )
 834 |       .then(() => true)
 835 |       .catch(() => false);
 836 | 
 837 |     return ok;
 838 |   }
 839 | 
 840 |   async function bonusClicks(kind, beforeCounts) {
 841 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
 842 |     if (!tries) return 0;
 843 | 
 844 |     let clicked = 0;
 845 |     let curBefore = beforeCounts;
 846 | 
 847 |     for (let i = 0; i < tries; i++) {
 848 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
 849 | 
 850 |       const res =
 851 |         kind === "replies"
 852 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
 853 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 854 | 
 855 |       if (!res?.clicked) break;
 856 | 
 857 |       clicked++;
 858 | 
 859 |       // mikro-oddech, potem czekamy na efekt
 860 |       await sleepRandom(80, 140);
 861 |       await waitForEffect(curBefore, kind);
 862 | 
 863 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
 864 |       curBefore = await countAnchors().catch(() => curBefore);
 865 | 
 866 |       // minimalny settle po do≈Çadowaniu
 867 |       await sleepRandom(90, 170);
 868 |     }
 869 | 
 870 |     return clicked;
 871 |   }
 872 | 
 873 |     async function clickOneReplyButton() {
 874 |     const res = await page.evaluate((root) => {
 875 |       const scope = root || document;
 876 | 
 877 |       const norm = (s) =>
 878 |         String(s || "")
 879 |           .replace(/\u00a0/g, " ")
 880 |           .replace(/\s+/g, " ")
 881 |           .trim()
 882 |           .toLowerCase();
 883 | 
 884 |       const isVisible = (el) => {
 885 |         if (!el) return false;
 886 |         try {
 887 |           const r = el.getBoundingClientRect();
 888 |           if (r.width < 2 || r.height < 2) return false;
 889 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
 890 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
 891 |         } catch {
 892 |           return true;
 893 |         }
 894 |       };
 895 | 
 896 |       const isReplyExpanderText = (t) => {
 897 |         if (!t) return false;
 898 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 899 |         if (t.length > 220) return false;
 900 | 
 901 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
 902 |         if (t === "odpowiedz" || t === "reply") return false;
 903 |         if (t.startsWith("odpowiedz ")) return false;
 904 |         if (t.startsWith("reply ")) return false;
 905 | 
 906 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
 907 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 908 | 
 909 |         // warianty opisowe
 910 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 911 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 912 |         if (t.includes("view") && t.includes("repl")) return true;
 913 |         if (t.includes("see") && t.includes("repl")) return true;
 914 | 
 915 |         return false;
 916 |       };
 917 | 
 918 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
 919 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
 920 |       const allTextCandidates = Array.from(
 921 |         scope.querySelectorAll("a,button,div,span")
 922 |       )
 923 |         .filter(isVisible)
 924 |         .slice(0, 35000);
 925 | 
 926 |       let best = null;
 927 |       let bestScore = -Infinity;
 928 | 
 929 |       for (const el of allTextCandidates) {
 930 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
 931 |         const t = norm(tRaw);
 932 |         if (!isReplyExpanderText(t)) continue;
 933 | 
 934 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
 935 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 936 |         if (t.includes("udost") || t.includes("share")) continue;
 937 | 
 938 |         const r = el.getBoundingClientRect();
 939 |         let score = 0;
 940 | 
 941 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
 942 |         score += Math.max(0, r.top);
 943 | 
 944 |         // preferuj te z liczbƒÖ odpowiedzi
 945 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
 946 | 
 947 |         // preferuj ‚Äúwszystkie/all‚Äù
 948 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
 949 | 
 950 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
 951 |         score -= Math.min(500, t.length * 3);
 952 | 
 953 |         if (score > bestScore) {
 954 |           bestScore = score;
 955 |           best = el;
 956 |         }
 957 |       }
 958 | 
 959 |       if (!best) return { clicked: false };
 960 | 
 961 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
 962 |       const clickable =
 963 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
 964 | 
 965 |       try {
 966 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 967 |       } catch {}
 968 | 
 969 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 970 | 
 971 |       const hardClick = (node) => {
 972 |         try {
 973 |           node.click();
 974 |           return true;
 975 |         } catch {}
 976 |         try {
 977 |           const r = node.getBoundingClientRect();
 978 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
 979 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
 980 |           const target = document.elementFromPoint(x, y) || node;
 981 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
 982 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
 983 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
 984 |           return true;
 985 |         } catch {}
 986 |         return false;
 987 |       };
 988 | 
 989 |       const ok = hardClick(clickable);
 990 |       return { clicked: ok, text: txt };
 991 |     }, rootHandle);
 992 | 
 993 |     return res || { clicked: false };
 994 |   }
 995 | 
 996 | 
 997 |   async function clickMoreCommentsButton() {
 998 |     const res = await page.evaluate((root) => {
 999 |       const scope = root || document;
1000 | 
1001 |       const norm = (s) =>
1002 |         String(s || "")
1003 |           .replace(/\u00a0/g, " ")
1004 |           .replace(/\s+/g, " ")
1005 |           .trim()
1006 |           .toLowerCase();
1007 | 
1008 |       const isVisible = (el) => {
1009 |         if (!el) return false;
1010 |         const r = el.getBoundingClientRect();
1011 |         if (r.width < 2 || r.height < 2) return false;
1012 |         return r.bottom > 0 && r.top < window.innerHeight;
1013 |       };
1014 | 
1015 |       const isMore = (t) => {
1016 |         if (!t) return false;
1017 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1018 |         if (t.length > 140) return false;
1019 | 
1020 |         return (
1021 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
1022 |           t.includes("zobacz wiƒôcej komentarzy") ||
1023 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
1024 |           t.includes("view more comments") ||
1025 |           t.includes("view previous comments")
1026 |         );
1027 |       };
1028 | 
1029 |       const candidates = Array.from(
1030 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
1031 |       ).filter(isVisible);
1032 | 
1033 |       let best = null;
1034 |       let bestY = -1;
1035 | 
1036 |       for (const el of candidates) {
1037 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1038 |         if (!isMore(t)) continue;
1039 |         const r = el.getBoundingClientRect();
1040 |         if (r.top > bestY) {
1041 |           bestY = r.top;
1042 |           best = el;
1043 |         }
1044 |       }
1045 | 
1046 |       if (!best) return { clicked: false };
1047 | 
1048 |       try {
1049 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
1050 |       } catch {}
1051 | 
1052 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
1053 | 
1054 |       try {
1055 |         best.click();
1056 |         return { clicked: true, text: txt };
1057 |       } catch {
1058 |         return { clicked: false, text: txt };
1059 |       }
1060 |     }, rootHandle);
1061 | 
1062 |     return res || { clicked: false };
1063 |   }
1064 | 
1065 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
1066 | 
1067 |   async function hasAnyReplyExpanders(page, rootHandle) {
1068 |     return page.evaluate((root) => {
1069 |       const scope = root || document;
1070 | 
1071 |       const norm = (s) =>
1072 |         String(s || "")
1073 |           .replace(/\u00a0/g, " ")
1074 |           .replace(/\s+/g, " ")
1075 |           .trim()
1076 |           .toLowerCase();
1077 | 
1078 |       const isVisible = (el) => {
1079 |         if (!el) return false;
1080 |         try {
1081 |           const r = el.getBoundingClientRect();
1082 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
1083 |         } catch {
1084 |           return true;
1085 |         }
1086 |       };
1087 | 
1088 |       const isReplyExpanderText = (t) => {
1089 |         if (!t) return false;
1090 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1091 |         if (t.length > 220) return false;
1092 | 
1093 |         if (t === "odpowiedz" || t === "reply") return false;
1094 |         if (t.startsWith("odpowiedz ")) return false;
1095 |         if (t.startsWith("reply ")) return false;
1096 | 
1097 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1098 | 
1099 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1100 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
1101 |         if (t.includes("view") && t.includes("repl")) return true;
1102 |         if (t.includes("see") && t.includes("repl")) return true;
1103 | 
1104 |         return false;
1105 |       };
1106 | 
1107 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
1108 | 
1109 |       for (const el of nodes) {
1110 |         if (!isVisible(el)) continue;
1111 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1112 |         if (!t) continue;
1113 | 
1114 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
1115 |         if (t.includes("udost") || t.includes("share")) continue;
1116 | 
1117 |         if (isReplyExpanderText(t)) return true;
1118 |       }
1119 | 
1120 |       return false;
1121 |     }, rootHandle);
1122 |   }
1123 | 
1124 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
1125 |     const res = await page.evaluate(
1126 |       (root, limit) => {
1127 |         const scope = root || document;
1128 | 
1129 |         const norm = (s) =>
1130 |           String(s || "")
1131 |             .replace(/\u00a0/g, " ")
1132 |             .replace(/\s+/g, " ")
1133 |             .trim()
1134 |             .toLowerCase();
1135 | 
1136 |         const isVisible = (el) => {
1137 |           if (!el) return false;
1138 |           try {
1139 |             const r = el.getBoundingClientRect();
1140 |             if (r.width < 2 || r.height < 2) return false;
1141 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
1142 |           } catch {
1143 |             return true;
1144 |           }
1145 |         };
1146 | 
1147 |         const isReplyExpanderText = (t) => {
1148 |           if (!t) return false;
1149 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1150 |           if (t.length > 220) return false;
1151 | 
1152 |           if (t === "odpowiedz" || t === "reply") return false;
1153 |           if (t.startsWith("odpowiedz ")) return false;
1154 |           if (t.startsWith("reply ")) return false;
1155 | 
1156 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1157 | 
1158 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1159 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
1160 |           if (t.includes("view") && t.includes("repl")) return true;
1161 |           if (t.includes("see") && t.includes("repl")) return true;
1162 | 
1163 |           return false;
1164 |         };
1165 | 
1166 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
1167 |           .filter(isVisible)
1168 |           .slice(0, 35000)
1169 |           .map((el) => {
1170 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1171 |             return { el, t };
1172 |           })
1173 |           .filter((x) => {
1174 |             if (!x.t) return false;
1175 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
1176 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
1177 |             return isReplyExpanderText(x.t);
1178 |           });
1179 | 
1180 |         // preferuj elementy ni≈ºej w widoku
1181 |         candidates.sort((a, b) => {
1182 |           const ra = a.el.getBoundingClientRect();
1183 |           const rb = b.el.getBoundingClientRect();
1184 |           return rb.top - ra.top;
1185 |         });
1186 | 
1187 |         const hardClick = (node) => {
1188 |           try {
1189 |             node.click();
1190 |             return true;
1191 |           } catch {}
1192 |           try {
1193 |             const r = node.getBoundingClientRect();
1194 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
1195 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
1196 |             const target = document.elementFromPoint(x, y) || node;
1197 |             target.dispatchEvent(
1198 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
1199 |             );
1200 |             target.dispatchEvent(
1201 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
1202 |             );
1203 |             target.dispatchEvent(
1204 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
1205 |             );
1206 |             return true;
1207 |           } catch {}
1208 |           return false;
1209 |         };
1210 | 
1211 |         let clicked = 0;
1212 |         const sample = [];
1213 | 
1214 |         for (const item of candidates) {
1215 |           if (clicked >= limit) break;
1216 | 
1217 |           const clickable =
1218 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
1219 | 
1220 |           try {
1221 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
1222 |           } catch {}
1223 | 
1224 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
1225 | 
1226 |           const ok = hardClick(clickable);
1227 |           if (ok) {
1228 |             clicked++;
1229 |             if (sample.length < 5) sample.push(txt);
1230 |           }
1231 |         }
1232 | 
1233 |         return { clicked, sample };
1234 |       },
1235 |       rootHandle,
1236 |       maxPerPass
1237 |     );
1238 | 
1239 |     return res || { clicked: 0, sample: [] };
1240 |   }
1241 | 
1242 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
1243 |     await page.evaluate((root, scroller) => {
1244 |       const pick =
1245 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
1246 | 
1247 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
1248 |       else window.scrollTo(0, 0);
1249 |     }, rootHandle, scrollHandle);
1250 |   }
1251 | 
1252 |   async function sweepRepliesTopDown(
1253 |     page,
1254 |     rootHandle,
1255 |     scrollHandle,
1256 |     {
1257 |       maxPasses = 3,
1258 |       stepsPerPass = 40,
1259 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
1260 |       maxClicksPerStep = 12,
1261 |     } = {}
1262 |   ) {
1263 |     let totalClicked = 0;
1264 | 
1265 |     for (let pass = 1; pass <= maxPasses; pass++) {
1266 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
1267 |       await sleepRandom(140, 240);
1268 | 
1269 |       let staleSteps = 0;
1270 | 
1271 |       for (let step = 1; step <= stepsPerPass; step++) {
1272 |         const before = await countAnchors().catch(() => null);
1273 | 
1274 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
1275 |           () => ({ clicked: 0, sample: [] })
1276 |         );
1277 | 
1278 |         if (r.clicked > 0) {
1279 |           totalClicked += r.clicked;
1280 | 
1281 |           if (before) {
1282 |             await sleepRandom(60, 120);
1283 |             await waitForEffect(before, "replies");
1284 |           }
1285 | 
1286 |           await sleepRandom(90, 160);
1287 |           staleSteps = 0;
1288 |         } else {
1289 |           staleSteps++;
1290 |         }
1291 | 
1292 |         const m1 = await getScrollMetrics().catch(() => null);
1293 |         await gentleScrollKick(scrollPx);
1294 |         const m2 = await getScrollMetrics().catch(() => null);
1295 | 
1296 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
1297 | 
1298 |         if (!moved && staleSteps >= 4) break;
1299 |         if (staleSteps >= 8) break;
1300 |       }
1301 | 
1302 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1303 |       if (!any) break;
1304 |     }
1305 | 
1306 |     return totalClicked;
1307 |   }
1308 | 
1309 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
1310 |   let lastLogAt = 0;
1311 |   let lastLogKey = "";
1312 |   const LOG_EVERY_N_STEPS = 6;
1313 |   const LOG_MIN_MS = 800;
1314 |   const shouldLog = (step, key, force = false) => {
1315 |     const now = Date.now();
1316 |     if (force) {
1317 |       lastLogAt = now;
1318 |       lastLogKey = key;
1319 |       return true;
1320 |     }
1321 |     if (step % LOG_EVERY_N_STEPS === 0) {
1322 |       lastLogAt = now;
1323 |       lastLogKey = key;
1324 |       return true;
1325 |     }
1326 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
1327 |       lastLogAt = now;
1328 |       lastLogKey = key;
1329 |       return true;
1330 |     }
1331 |     return false;
1332 |   };
1333 | 
1334 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
1335 |   log.debug("UI:photo", "startCounts", cur);
1336 | 
1337 |   for (let step = 1; step <= MAX_STEPS; step++) {
1338 |     const before = cur;
1339 |     let action = "scroll";
1340 |     let clickInfo = null;
1341 |     let effectOk = false;
1342 |     let bonus = 0;
1343 | 
1344 |     // 1) REPLIES
1345 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
1346 |     if (r1?.clicked) {
1347 |       action = "replies";
1348 |       clickInfo = r1;
1349 | 
1350 |       await sleepRandom(80, 140);
1351 |       effectOk = await waitForEffect(before, "replies");
1352 |       await sleepRandom(90, 170);
1353 | 
1354 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
1355 |       if (effectOk) {
1356 |         bonus = await bonusClicks("replies", before);
1357 |       } else {
1358 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
1359 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1360 |       }
1361 |     } else {
1362 |       // 2) MORE COMMENTS
1363 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
1364 |       if (c1?.clicked) {
1365 |         action = "comments";
1366 |         clickInfo = c1;
1367 | 
1368 |         await sleepRandom(80, 140);
1369 |         effectOk = await waitForEffect(before, "comments");
1370 |         await sleepRandom(90, 170);
1371 | 
1372 |         if (effectOk) {
1373 |           bonus = await bonusClicks("comments", before);
1374 |         } else {
1375 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1376 |         }
1377 |       } else {
1378 |         // 3) SCROLL
1379 |         action = "scroll";
1380 |         await gentleScrollKick(PACE_CFG.scrollPx);
1381 |       }
1382 |     }
1383 | 
1384 |     cur = await countAnchors().catch(() => before);
1385 | 
1386 |     const progressed =
1387 |       cur.commentsAnchors > before.commentsAnchors ||
1388 |       cur.replyAnchors > before.replyAnchors ||
1389 |       cur.nodes > before.nodes;
1390 | 
1391 |     if (!progressed) noProgress++;
1392 |     else noProgress = 0;
1393 | 
1394 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
1395 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
1396 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
1397 |     if (shouldCheckHB) {
1398 |       hb = await updateHardBottomStability().catch(() => ({
1399 |         atBottom: false,
1400 |         stable: bottomStable,
1401 |         tag: "NA",
1402 |         anyMore: true,
1403 |       }));
1404 |     }
1405 | 
1406 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
1407 |     const key =
1408 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
1409 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
1410 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
1411 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
1412 | 
1413 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
1414 |     if (shouldLog(step, key, forceLog)) {
1415 |       log.debug("UI:photo", `step=${step} ${action} cA ${before.commentsAnchors}‚Üí${cur.commentsAnchors} rA ${before.replyAnchors}‚Üí${cur.replyAnchors} np=${noProgress}/${MAX_NO_PROGRESS}`);
1416 |     }
1417 | 
1418 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
1419 |       log.debug("UI:photo", "Stop: hard-bottom-stable");
1420 |       break;
1421 |     }
1422 | 
1423 |     if (noProgress >= MAX_NO_PROGRESS) {
1424 |       log.debug("UI:photo", "Stop: too many no-progress steps");
1425 |       break;
1426 |     }
1427 | 
1428 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
1429 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
1430 |   }
1431 | 
1432 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
1433 |   let final = await countAnchors().catch(() => cur);
1434 |   log.debug("UI:photo", "Done", final);
1435 | 
1436 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1437 |   if (needSweep) {
1438 |     log.debug("UI:photo", "Sweep: reply expanders -> top-down...");
1439 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
1440 |     log.debug("UI:photo", `Sweep: clicked=${clicked}`);
1441 |     final = await countAnchors().catch(() => final);
1442 |     log.debug("UI:photo", "After sweep", final);
1443 |   } else {
1444 |     log.debug("UI:photo", "Sweep: brak reply expanders");
1445 |   }
1446 | 
1447 |   try {
1448 |     await scrollHandle.dispose?.();
1449 |   } catch {}
1450 |   try {
1451 |     await rootHandle.dispose?.();
1452 |   } catch {}
1453 | }
1454 | 
1455 | /* =====================
1456 |    Analiza za≈Ço≈ºe≈Ñ
1457 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
1458 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
1459 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
1460 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
1461 | 
1462 |    Co powiedzia≈Çby sceptyk?
1463 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
1464 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
1465 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
1466 | 
1467 |    ===================== */
1468 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/post.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
   1 | // src/fb/ui/post.js
   2 | import { EXPAND_COMMENTS } from "../../config.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { safeGoto } from "../../utils/navigation.js";
   5 | import log from "../../utils/logger.js";
   6 | 
   7 | import { scrollPost } from "../scroll.js";
   8 | import { acceptCookies, saveCookies } from "../cookies.js";
   9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  10 | import { clickOneExpandButton } from "../expandButtons.js";
  11 | 
  12 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
  13 | 
  14 | export const type = "post";
  15 | 
  16 | export function matchesUrl(url) {
  17 |   if (!url) return false;
  18 |   const u = String(url);
  19 |   if (u.includes("/watch")) return false;
  20 |   if (u.includes("/videos/")) return false;
  21 |   if (u.includes("/photo")) return false;
  22 |   if (u.includes("photo.php")) return false;
  23 | 
  24 |   return (
  25 |     u.includes("/posts/") ||
  26 |     u.includes("permalink.php") ||
  27 |     u.includes("/story.php") ||
  28 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
  29 |   );
  30 | }
  31 | 
  32 | /* ============================================================
  33 |    =============== POST ROOT (DIALOG / MAIN) ===================
  34 |    ============================================================ */
  35 | 
  36 | function postRootScript() {
  37 |   return `
  38 |     function getPostRoot() {
  39 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
  40 | 
  41 |       const postDialog = dialogs.find((dlg) => {
  42 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
  43 |         if (!text) return false;
  44 | 
  45 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
  46 |         const hasActions =
  47 |           text.includes("lubiƒô to") ||
  48 |           text.includes("komentarz") ||
  49 |           text.includes("udostƒôpnij") ||
  50 |           text.includes("write a comment") ||
  51 |           text.includes("comment");
  52 | 
  53 |         const looksLikeNotifications =
  54 |           text.startsWith("powiadomienia") &&
  55 |           text.includes("wszystkie") &&
  56 |           text.includes("nieprzeczytane");
  57 | 
  58 |         return !looksLikeNotifications && hasCommentWord && hasActions;
  59 |       });
  60 | 
  61 |       if (postDialog) {
  62 |         const art = postDialog.querySelector("article");
  63 |         return art || postDialog;
  64 |       }
  65 | 
  66 |       const main = document.querySelector("div[role='main'], main");
  67 |       if (main) {
  68 |         const article = main.querySelector("article");
  69 |         return article || main;
  70 |       }
  71 | 
  72 |       return document.body;
  73 |     }
  74 |   `;
  75 | }
  76 | 
  77 | async function getPostScopeSelector(page) {
  78 |   const scope = await page.evaluate((code) => {
  79 |     // eslint-disable-next-line no-eval
  80 |     eval(code);
  81 |     // @ts-ignore
  82 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
  83 |     if (!root) return "document";
  84 | 
  85 |     const dlg = root.closest("div[role='dialog']");
  86 |     if (dlg) return "div[role='dialog']";
  87 | 
  88 |     const main = document.querySelector("div[role='main'], main");
  89 |     if (main) return "div[role='main']";
  90 | 
  91 |     return "document";
  92 |   }, postRootScript());
  93 | 
  94 |   return scope || "document";
  95 | }
  96 | 
  97 | /* ============================================================
  98 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: WSZYSTKIE / NAJNOWSZE =======
  99 |    ============================================================ */
 100 | 
 101 | async function clickMenuOptionByPattern(page, patterns) {
 102 |   const result = await page.evaluate((patterns) => {
 103 |     const norm = (s) =>
 104 |       String(s || "")
 105 |         .replace(/\u00a0/g, " ")
 106 |         .replace(/\s+/g, " ")
 107 |         .trim()
 108 |         .toLowerCase();
 109 | 
 110 |     const menu = document.querySelector("div[role='menu']");
 111 |     if (!menu) return { clicked: false, noMenu: true };
 112 | 
 113 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 114 | 
 115 |     const opt = items.find((el) => {
 116 |       const t = norm(el.textContent);
 117 |       return patterns.some((p) => t.startsWith(p));
 118 |     });
 119 | 
 120 |     if (!opt) return { clicked: false, noMenu: false, patterns };
 121 | 
 122 |     try {
 123 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 124 |     } catch {}
 125 | 
 126 |     try {
 127 |       opt.click();
 128 |       return { clicked: true, noMenu: false };
 129 |     } catch {
 130 |       return { clicked: false, noMenu: false };
 131 |     }
 132 |   }, patterns);
 133 | 
 134 |   if (result.clicked) {
 135 |     await sleepRandom(250, 450);
 136 |     await page
 137 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 138 |       .catch(() => {});
 139 |   }
 140 | 
 141 |   return result;
 142 | }
 143 | 
 144 | async function clickAllCommentsInMenu(page) {
 145 |   const result = await page.evaluate(() => {
 146 |     const norm = (s) =>
 147 |       String(s || "")
 148 |         .replace(/\u00a0/g, " ")
 149 |         .replace(/\s+/g, " ")
 150 |         .trim()
 151 |         .toLowerCase();
 152 | 
 153 |     const menu = document.querySelector("div[role='menu']");
 154 |     if (!menu) return { clicked: false, noMenu: true };
 155 | 
 156 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 157 | 
 158 |     const opt = items.find((el) => {
 159 |       const t = norm(el.textContent);
 160 |       return (
 161 |         t.startsWith("wszystkie komentarze") ||
 162 |         t.startsWith("all comments") ||
 163 |         t.startsWith("poka≈º wszystkie") ||
 164 |         t.startsWith("pokaz wszystkie") ||
 165 |         t.startsWith("show all")
 166 |       );
 167 |     });
 168 | 
 169 |     if (!opt) return { clicked: false, noMenu: false };
 170 | 
 171 |     try {
 172 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 173 |     } catch {}
 174 | 
 175 |     try {
 176 |       opt.click();
 177 |       return { clicked: true, noMenu: false };
 178 |     } catch {
 179 |       return { clicked: false, noMenu: false };
 180 |     }
 181 |   });
 182 | 
 183 |   if (result.clicked) {
 184 |     await sleepRandom(250, 450);
 185 |     await page
 186 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 187 |       .catch(() => {});
 188 |   }
 189 | 
 190 |   return result;
 191 | }
 192 | 
 193 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
 194 |   log.dev("UI:post", "Prze≈ÇƒÖczam filtr komentarzy...");
 195 |   log.debug("UI:post", `Filter scope: ${scopeSel}`);
 196 | 
 197 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
 198 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 199 |   if (menuAlreadyOpen) {
 200 |     log.debug("UI:post", "Menu ju≈º otwarte ‚Äì wybieram opcjƒô");
 201 |     const r = await clickAllCommentsInMenu(page);
 202 |     if (r?.clicked)
 203 |       log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 204 |     return !!r?.clicked;
 205 |   }
 206 | 
 207 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
 208 |   const pre = await page.evaluate(
 209 |     (scopeSel, code) => {
 210 |       const norm = (s) =>
 211 |         String(s || "")
 212 |           .replace(/\u00a0/g, " ")
 213 |           .replace(/\s+/g, " ")
 214 |           .trim()
 215 |           .toLowerCase();
 216 | 
 217 |       // eslint-disable-next-line no-eval
 218 |       eval(code);
 219 |       // @ts-ignore
 220 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 221 | 
 222 |       function getLabel(el) {
 223 |         if (!el) return "";
 224 |         const aria = el.getAttribute?.("aria-label");
 225 |         if (aria) return aria;
 226 |         return el.textContent || "";
 227 |       }
 228 | 
 229 |       function isVisibleEnough(el) {
 230 |         try {
 231 |           if (!el) return false;
 232 |           const st = window.getComputedStyle(el);
 233 |           if (!st) return true;
 234 |           if (st.display === "none" || st.visibility === "hidden") return false;
 235 |           const r = el.getBoundingClientRect();
 236 |           if (!r || r.width < 8 || r.height < 8) return false;
 237 |           return true;
 238 |         } catch {
 239 |           return true;
 240 |         }
 241 |       }
 242 | 
 243 |       function findClickableAncestor(start) {
 244 |         let el = start;
 245 |         for (let i = 0; i < 10 && el; i++) {
 246 |           const role = el.getAttribute?.("role");
 247 |           const tag = (el.tagName || "").toLowerCase();
 248 |           if (
 249 |             tag === "button" ||
 250 |             role === "button" ||
 251 |             role === "menuitem" ||
 252 |             role === "menuitemradio" ||
 253 |             role === "link"
 254 |           ) {
 255 |             return el;
 256 |           }
 257 |           el = el.parentElement;
 258 |         }
 259 |         return null;
 260 |       }
 261 | 
 262 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
 263 |       const btnsAll = Array.from(
 264 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 265 |       );
 266 |       for (const el of btnsAll) {
 267 |         const t = norm(getLabel(el));
 268 |         if (
 269 |           t === "wszystkie komentarze" ||
 270 |           t === "all comments" ||
 271 |           t === "poka≈º wszystkie" ||
 272 |           t === "pokaz wszystkie" ||
 273 |           t === "show all"
 274 |         ) {
 275 |           return { ok: true, state: "already-all", where: "document" };
 276 |         }
 277 |       }
 278 | 
 279 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 280 |       const scopes = [scopeEl, root, document].filter(Boolean);
 281 | 
 282 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
 283 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
 284 |       for (const sc of scopes) {
 285 |         const clickables = Array.from(
 286 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 287 |         );
 288 | 
 289 |         const candidates = [];
 290 |         for (const el of clickables) {
 291 |           const t = norm(getLabel(el));
 292 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
 293 |           if (!isVisibleEnough(el)) continue;
 294 | 
 295 |           let dist = 999999;
 296 |           try {
 297 |             const r = el.getBoundingClientRect();
 298 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
 299 |             dist = Math.abs(r.top - window.innerHeight / 2);
 300 |           } catch {}
 301 | 
 302 |           candidates.push({ el, dist });
 303 |         }
 304 | 
 305 |         if (candidates.length) {
 306 |           candidates.sort((a, b) => a.dist - b.dist);
 307 |           const picked = candidates[0].el;
 308 | 
 309 |           try {
 310 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 311 |           } catch {}
 312 | 
 313 |           try {
 314 |             picked.click();
 315 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
 316 |           } catch {
 317 |             // nic
 318 |           }
 319 |         }
 320 |       }
 321 | 
 322 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
 323 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
 324 |       for (const sc of scopes) {
 325 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
 326 |           .filter(isVisibleEnough)
 327 |           .slice(0, 20000);
 328 | 
 329 |         for (const n of nodes) {
 330 |           const t = norm(n.textContent);
 331 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
 332 | 
 333 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
 334 |           if (!clickable) continue;
 335 | 
 336 |           try {
 337 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 338 |           } catch {}
 339 | 
 340 |           try {
 341 |             clickable.click();
 342 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
 343 |           } catch {
 344 |             // nic
 345 |           }
 346 |         }
 347 |       }
 348 | 
 349 |       return { ok: false, state: "not-found" };
 350 |     },
 351 |     scopeSel,
 352 |     postRootScript()
 353 |   );
 354 | 
 355 |   if (!pre?.ok) {
 356 |     log.debug("UI:post", "Nie znaleziono przycisku filtra");
 357 |     return false;
 358 |   }
 359 | 
 360 |   if (pre.state === "already-all") {
 361 |     log.debug("UI:post", "Filtr ju≈º ustawiony ‚Äì pomijam");
 362 |     return true;
 363 |   }
 364 | 
 365 |   log.debug("UI:post", "Klikniƒôto filtr", pre);
 366 | 
 367 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 368 |   await sleepRandom(350, 650);
 369 | 
 370 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
 371 |   const menuResult = await clickAllCommentsInMenu(page);
 372 | 
 373 |   if (menuResult?.clicked) {
 374 |     log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 375 |     return true;
 376 |   }
 377 | 
 378 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
 379 |   const afterLabelIsAll = await page.evaluate(() => {
 380 |     const norm = (s) =>
 381 |       String(s || "")
 382 |         .replace(/\u00a0/g, " ")
 383 |         .replace(/\s+/g, " ")
 384 |         .trim()
 385 |         .toLowerCase();
 386 | 
 387 |     const els = Array.from(
 388 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 389 |     );
 390 | 
 391 |     function getLabel(el) {
 392 |       const aria = el.getAttribute?.("aria-label");
 393 |       if (aria) return aria;
 394 |       return el.textContent || "";
 395 |     }
 396 | 
 397 |     return els.some((el) => {
 398 |       const t = norm(getLabel(el));
 399 |       return (
 400 |         t === "wszystkie komentarze" ||
 401 |         t === "all comments" ||
 402 |         t === "poka≈º wszystkie" ||
 403 |         t === "pokaz wszystkie" ||
 404 |         t === "show all"
 405 |       );
 406 |     });
 407 |   });
 408 | 
 409 |   if (afterLabelIsAll) {
 410 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu");
 411 |     return true;
 412 |   }
 413 | 
 414 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá filtra", menuResult);
 415 |   return false;
 416 | }
 417 | 
 418 | /* ============================================================
 419 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: NAJNOWSZE (FAST_MODE) =======
 420 |    ============================================================ */
 421 | 
 422 | async function openFilterMenuScoped(page, scopeSel = "document") {
 423 |   const pre = await page.evaluate(
 424 |     (scopeSel, code) => {
 425 |       const norm = (s) =>
 426 |         String(s || "")
 427 |           .replace(/\u00a0/g, " ")
 428 |           .replace(/\s+/g, " ")
 429 |           .trim()
 430 |           .toLowerCase();
 431 | 
 432 |       // eslint-disable-next-line no-eval
 433 |       eval(code);
 434 |       // @ts-ignore
 435 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 436 | 
 437 |       function getLabel(el) {
 438 |         if (!el) return "";
 439 |         const aria = el.getAttribute?.("aria-label");
 440 |         if (aria) return aria;
 441 |         return el.textContent || "";
 442 |       }
 443 | 
 444 |       function isVisibleEnough(el) {
 445 |         try {
 446 |           if (!el) return false;
 447 |           const st = window.getComputedStyle(el);
 448 |           if (!st) return true;
 449 |           if (st.display === "none" || st.visibility === "hidden") return false;
 450 |           const r = el.getBoundingClientRect();
 451 |           if (!r || r.width < 8 || r.height < 8) return false;
 452 |           return true;
 453 |         } catch {
 454 |           return true;
 455 |         }
 456 |       }
 457 | 
 458 |       // Je≈õli menu ju≈º otwarte
 459 |       if (document.querySelector("div[role='menu']")) {
 460 |         return { ok: true, state: "menu-already-open" };
 461 |       }
 462 | 
 463 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 464 |       const scopes = [scopeEl, root, document].filter(Boolean);
 465 | 
 466 |       // Szukamy przycisku filtra (Najtrafniejsze/Wszystkie/Najnowsze)
 467 |       const filterLabels = [
 468 |         "najtrafniejsze", "most relevant",
 469 |         "wszystkie komentarze", "all comments",
 470 |         "najnowsze", "newest",
 471 |         "poka≈º wszystkie", "show all"
 472 |       ];
 473 | 
 474 |       for (const sc of scopes) {
 475 |         const clickables = Array.from(
 476 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 477 |         );
 478 | 
 479 |         const candidates = [];
 480 |         for (const el of clickables) {
 481 |           const t = norm(getLabel(el));
 482 |           if (!filterLabels.some((f) => t.startsWith(f))) continue;
 483 |           if (!isVisibleEnough(el)) continue;
 484 | 
 485 |           let dist = 999999;
 486 |           try {
 487 |             const r = el.getBoundingClientRect();
 488 |             dist = Math.abs(r.top - window.innerHeight / 2);
 489 |           } catch {}
 490 | 
 491 |           candidates.push({ el, dist, label: t });
 492 |         }
 493 | 
 494 |         if (candidates.length) {
 495 |           candidates.sort((a, b) => a.dist - b.dist);
 496 |           const picked = candidates[0].el;
 497 | 
 498 |           try {
 499 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 500 |           } catch {}
 501 | 
 502 |           try {
 503 |             picked.click();
 504 |             return { ok: true, state: "clicked-filter", label: candidates[0].label };
 505 |           } catch {}
 506 |         }
 507 |       }
 508 | 
 509 |       return { ok: false, state: "not-found" };
 510 |     },
 511 |     scopeSel,
 512 |     postRootScript()
 513 |   );
 514 | 
 515 |   return pre;
 516 | }
 517 | 
 518 | export async function switchCommentsFilterToNewestScoped(page, scopeSel = "document") {
 519 |   log.dev("UI:post", "Prze≈ÇƒÖczam na 'Najnowsze'...");
 520 |   log.debug("UI:post", `Newest filter scope: ${scopeSel}`);
 521 | 
 522 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Najnowsze"
 523 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 524 |   if (menuAlreadyOpen) {
 525 |     log.debug("UI:post", "Menu otwarte ‚Äì wybieram 'Najnowsze'");
 526 |     const r = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 527 |     if (r?.clicked) {
 528 |       log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 529 |       return { ok: true };
 530 |     }
 531 |     return { ok: false, reason: "option-not-found-in-open-menu" };
 532 |   }
 533 | 
 534 |   // 1) Sprawd≈∫ czy ju≈º ustawione na "Najnowsze"
 535 |   const alreadyNewest = await page.evaluate(() => {
 536 |     const norm = (s) =>
 537 |       String(s || "")
 538 |         .replace(/\u00a0/g, " ")
 539 |         .replace(/\s+/g, " ")
 540 |         .trim()
 541 |         .toLowerCase();
 542 | 
 543 |     const btns = Array.from(
 544 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 545 |     );
 546 | 
 547 |     return btns.some((el) => {
 548 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 549 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 550 |     });
 551 |   });
 552 | 
 553 |   if (alreadyNewest) {
 554 |     log.debug("UI:post", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
 555 |     return { ok: true, state: "already-newest" };
 556 |   }
 557 | 
 558 |   // 2) Otw√≥rz menu filtra
 559 |   const openResult = await openFilterMenuScoped(page, scopeSel);
 560 |   if (!openResult?.ok) {
 561 |     log.debug("UI:post", "Nie uda≈Ço siƒô otworzyƒá menu filtra");
 562 |     return { ok: false, reason: "menu-not-opened" };
 563 |   }
 564 | 
 565 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 566 |   await sleepRandom(350, 650);
 567 | 
 568 |   // 3) Wybierz "Najnowsze" z menu
 569 |   const menuResult = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 570 | 
 571 |   if (menuResult?.clicked) {
 572 |     log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 573 |     return { ok: true };
 574 |   }
 575 | 
 576 |   // 4) Fallback: sprawd≈∫ label po klikniƒôciu
 577 |   const afterLabelIsNewest = await page.evaluate(() => {
 578 |     const norm = (s) =>
 579 |       String(s || "")
 580 |         .replace(/\u00a0/g, " ")
 581 |         .replace(/\s+/g, " ")
 582 |         .trim()
 583 |         .toLowerCase();
 584 | 
 585 |     const els = Array.from(
 586 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 587 |     );
 588 | 
 589 |     return els.some((el) => {
 590 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 591 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 592 |     });
 593 |   });
 594 | 
 595 |   if (afterLabelIsNewest) {
 596 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Najnowsze'");
 597 |     return { ok: true };
 598 |   }
 599 | 
 600 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá 'Najnowsze'", menuResult);
 601 |   return { ok: false, reason: menuResult?.noMenu ? "no-menu" : "option-not-found" };
 602 | }
 603 | 
 604 | 
 605 | /* ============================================================
 606 |    =================== LICZENIE Z UI (POST) ====================
 607 |    ============================================================ */
 608 | 
 609 | /**
 610 |  * Kluczowa poprawka:
 611 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
 612 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
 613 |  */
 614 | async function getCommentCountFromUiPostRoot(page) {
 615 |   const res = await page.evaluate((code) => {
 616 |     // eslint-disable-next-line no-eval
 617 |     eval(code);
 618 | 
 619 |     const norm = (s) =>
 620 |       String(s || "")
 621 |         .replace(/\u00a0/g, " ")
 622 |         .replace(/\s+/g, " ")
 623 |         .trim();
 624 | 
 625 |     const lower = (s) => norm(s).toLowerCase();
 626 | 
 627 |     function parsePlEnCount(text) {
 628 |       const t = lower(text);
 629 |       if (!t) return null;
 630 | 
 631 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
 632 | 
 633 |       let x = t
 634 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
 635 |         .replace(/comments?/g, "")
 636 |         .replace(/[():]/g, " ")
 637 |         .replace(/\s+/g, " ")
 638 |         .trim();
 639 | 
 640 |       let mult = 1;
 641 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
 642 |         mult = 1000;
 643 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
 644 |       }
 645 |       if (/\bmln\b|\bmillion\b/.test(x)) {
 646 |         mult = 1000000;
 647 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
 648 |       }
 649 | 
 650 |       x = x.replace(/\s+/g, "");
 651 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
 652 |       x = x.replace(/[^0-9.]/g, "");
 653 |       if (!x) return null;
 654 | 
 655 |       const n = Number(x);
 656 |       if (!Number.isFinite(n)) return null;
 657 | 
 658 |       return Math.round(n * mult);
 659 |     }
 660 | 
 661 |     // @ts-ignore
 662 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 663 |     const scope = root || document;
 664 | 
 665 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
 666 |     const badBlock = (txt) => {
 667 |       const t = lower(txt);
 668 |       if (!t) return false;
 669 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
 670 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
 671 |       return false;
 672 |     };
 673 | 
 674 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
 675 |     const spans = Array.from(scope.querySelectorAll("span"));
 676 |     let best = null;
 677 | 
 678 |     for (const el of spans) {
 679 |       const raw = norm(el.textContent);
 680 |       if (!raw) continue;
 681 |       if (badBlock(raw)) continue;
 682 | 
 683 |       const val = parsePlEnCount(raw);
 684 |       if (val == null) continue;
 685 | 
 686 |       let score = 0;
 687 |       score += Math.max(0, 40 - raw.length);
 688 | 
 689 |       try {
 690 |         const r = el.getBoundingClientRect();
 691 |         if (r.width > 10 && r.height > 10) score += 10;
 692 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
 693 |       } catch {}
 694 | 
 695 |       if (!best || score > best.score) best = { raw, val, score };
 696 |     }
 697 | 
 698 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
 699 | 
 700 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
 701 |     const nodes = Array.from(
 702 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
 703 |     );
 704 | 
 705 |     for (const el of nodes) {
 706 |       const raw = norm(el.textContent);
 707 |       if (!raw) continue;
 708 |       if (badBlock(raw)) continue;
 709 | 
 710 |       const val = parsePlEnCount(raw);
 711 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
 712 |     }
 713 | 
 714 |     // 3) Ostatecznie: regex po tek≈õcie root
 715 |     const blob = norm(scope.innerText || "");
 716 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
 717 |     if (m) {
 718 |       const raw = norm(`${m[1]} ${m[2]}`);
 719 |       const val = parsePlEnCount(raw);
 720 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
 721 |     }
 722 | 
 723 |     return { ok: false, reason: "not-found" };
 724 |   }, postRootScript());
 725 | 
 726 |   return res?.ok ? res : null;
 727 | }
 728 | 
 729 | /* ============================================================
 730 |    =================== LICZENIE ANCHOR√ìW =======================
 731 |    ============================================================ */
 732 | 
 733 | async function getCurrentCommentAnchorCount(page) {
 734 |   const count = await page.evaluate(() => {
 735 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
 736 |     const ids = new Set();
 737 | 
 738 |     for (const a of anchors) {
 739 |       try {
 740 |         const url = new URL(a.href);
 741 |         const cid = url.searchParams.get("comment_id");
 742 |         const rid = url.searchParams.get("reply_comment_id");
 743 |         let raw = rid || cid;
 744 |         if (!raw) continue;
 745 | 
 746 |         if (!/^\d+$/.test(raw)) {
 747 |           try {
 748 |             const dec = atob(raw);
 749 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 750 |             if (m) raw = m[2];
 751 |           } catch {}
 752 |         }
 753 | 
 754 |         if (raw) ids.add(raw);
 755 |       } catch {}
 756 |     }
 757 | 
 758 |     return ids.size;
 759 |   });
 760 | 
 761 |   return count || 0;
 762 | }
 763 | 
 764 | /* ============================================================
 765 |    =================== SCROLL TYLKO W PO≈öCIE ===================
 766 |    ============================================================ */
 767 | 
 768 | async function scrollWithinPost(page, label, factor = 0.25) {
 769 |   const info = await page.evaluate(
 770 |     (factorArg, labelArg, code) => {
 771 |       // eslint-disable-next-line no-eval
 772 |       eval(code);
 773 |       // @ts-ignore
 774 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
 775 | 
 776 |       const norm = (s) =>
 777 |         String(s || "")
 778 |           .replace(/\u00a0/g, " ")
 779 |           .replace(/\s+/g, " ")
 780 |           .trim()
 781 |           .toLowerCase();
 782 | 
 783 |       function canScrollByTest(el) {
 784 |         try {
 785 |           if (!el) return false;
 786 |           const ch = el.clientHeight || 0;
 787 |           const sh = el.scrollHeight || 0;
 788 |           if (ch <= 0) return false;
 789 |           if (sh <= ch + 30) return false;
 790 | 
 791 |           const before = el.scrollTop ?? 0;
 792 |           el.scrollTop = before + 80;
 793 |           const after = el.scrollTop ?? before;
 794 |           el.scrollTop = before;
 795 |           return after !== before;
 796 |         } catch {
 797 |           return false;
 798 |         }
 799 |       }
 800 | 
 801 |       function isVisible(el) {
 802 |         if (!el) return false;
 803 |         const st = window.getComputedStyle(el);
 804 |         if (!st) return true;
 805 |         if (st.display === "none" || st.visibility === "hidden") return false;
 806 |         const r = el.getBoundingClientRect();
 807 |         if (!r || r.width < 5 || r.height < 5) return false;
 808 |         return true;
 809 |       }
 810 | 
 811 |       function pickContainerSmart() {
 812 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
 813 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
 814 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
 815 | 
 816 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
 817 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
 818 | 
 819 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
 820 |         let anchor = null;
 821 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
 822 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
 823 |           .filter(isVisible)
 824 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
 825 | 
 826 |         if (candAnchor) anchor = candAnchor;
 827 | 
 828 |         function score(el) {
 829 |           const ch = el.clientHeight || 0;
 830 |           const sh = el.scrollHeight || 0;
 831 |           const delta = sh - ch;
 832 | 
 833 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
 834 |           const t = norm(el.innerText || "");
 835 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
 836 |           let s = delta + (hasCommentWords ? 12000 : 0);
 837 | 
 838 |           // premia je≈õli blisko anchora
 839 |           if (anchor) {
 840 |             const ar = anchor.getBoundingClientRect();
 841 |             const er = el.getBoundingClientRect();
 842 |             const dist = Math.abs(er.top - ar.top);
 843 |             s += Math.max(0, 4000 - dist);
 844 |           }
 845 | 
 846 |           return s;
 847 |         }
 848 | 
 849 |         let best = null;
 850 |         let bestScore = -1;
 851 | 
 852 |         for (const sc of scopes) {
 853 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
 854 |             .filter(isVisible)
 855 |             .slice(0, 18000);
 856 | 
 857 |           for (const el of divs) {
 858 |             if (!canScrollByTest(el)) continue;
 859 |             const s = score(el);
 860 |             if (s > bestScore) {
 861 |               bestScore = s;
 862 |               best = el;
 863 |             }
 864 |           }
 865 |           if (best) break;
 866 |         }
 867 | 
 868 |         if (best) {
 869 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
 870 |           return { el: best, label: "smart" };
 871 |         }
 872 | 
 873 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
 874 |         return {
 875 |           el: document.scrollingElement || document.documentElement || document.body,
 876 |           label: "window",
 877 |         };
 878 |       }
 879 | 
 880 |       const picked = pickContainerSmart();
 881 |       const container = picked.el;
 882 |       const containerType = picked.label;
 883 | 
 884 |       const isWindowContainer =
 885 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
 886 | 
 887 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 888 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
 889 | 
 890 |       if (maxScroll <= 0) {
 891 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
 892 |       }
 893 | 
 894 |       const f = factorArg || 0.25;
 895 |       const sign = f < 0 ? -1 : 1;
 896 |       const magnitude = Math.min(Math.abs(f), 1);
 897 | 
 898 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
 899 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
 900 |       const step = Math.max(120, Math.min(baseStep, 520));
 901 | 
 902 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
 903 | 
 904 |       if (isWindowContainer) window.scrollTo(0, target);
 905 |       else container.scrollTop = target;
 906 | 
 907 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 908 | 
 909 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
 910 |       if (after === before) {
 911 |         try {
 912 |           window.scrollBy(0, sign * step);
 913 |         } catch {}
 914 |       }
 915 | 
 916 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 917 | 
 918 |       return { before, after: after2, container: containerType, label: labelArg };
 919 |     },
 920 |     factor,
 921 |     label,
 922 |     postRootScript()
 923 |   );
 924 | 
 925 |   return info;
 926 | }
 927 | 
 928 | /* ============================================================
 929 |    =================== EXPAND (LEGACY) =========================
 930 |    ============================================================ */
 931 | 
 932 | async function expandAllComments(page) {
 933 |   if (!EXPAND_COMMENTS) return 0;
 934 | 
 935 |   let clicks = 0;
 936 |   for (let i = 0; i < 30; i++) {
 937 |     const didClick = await clickOneExpandButton(page);
 938 |     if (!didClick) break;
 939 |     clicks++;
 940 |     await sleepRandom(900, 1600);
 941 |   }
 942 |   return clicks;
 943 | }
 944 | 
 945 | /* ============================================================
 946 |    =================== HANDLER API =============================
 947 |    ============================================================ */
 948 | 
 949 | export async function prepare(page, url) {
 950 |   log.dev("UI:post", `Prepare: ${url.slice(0, 60)}...`);
 951 | 
 952 |   const ok = await safeGoto(page, url, "post", {
 953 |     waitUntil: "networkidle2",
 954 |     timeout: NAV_TIMEOUT_MS,
 955 |   });
 956 | 
 957 |   if (!ok) throw new Error("safeGoto-failed");
 958 | 
 959 |   const currentUrl = page.url();
 960 |   if (currentUrl.includes("/login")) {
 961 |     log.dev("UI:post", "/login redirect ‚Üí fbLogin()");
 962 |     await fbLogin(page);
 963 |     await sleepRandom(3000, 4500);
 964 | 
 965 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 966 |     log.dev("UI:post", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
 967 | 
 968 |     if (loggedAfterLogin) {
 969 |       await safeGoto(page, url, "post", {
 970 |         waitUntil: "networkidle2",
 971 |         timeout: NAV_TIMEOUT_MS,
 972 |       });
 973 |     }
 974 |   }
 975 | 
 976 |   await acceptCookies(page, "post-initial");
 977 | 
 978 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
 979 |   await sleepRandom(1200, 1800);
 980 |   await acceptCookies(page, "post");
 981 | 
 982 |   try {
 983 |     const logged = await checkIfLogged(page).catch(() => false);
 984 |     if (logged) await saveCookies(page);
 985 |   } catch {}
 986 | 
 987 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
 988 |   await scrollPost(page, 120).catch(() => {});
 989 |   await sleepRandom(600, 900);
 990 | }
 991 | 
 992 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
 993 |   try {
 994 |     await page.waitForFunction(
 995 |       ({ stableMs }) => {
 996 |         const now = performance.now();
 997 |         const y = window.scrollY || 0;
 998 | 
 999 |         if (!window.__fbScrollStop) {
1000 |           window.__fbScrollStop = { lastY: y, lastChange: now };
1001 |           return false;
1002 |         }
1003 | 
1004 |         const st = window.__fbScrollStop;
1005 | 
1006 |         if (Math.abs(y - st.lastY) > 0) {
1007 |           st.lastY = y;
1008 |           st.lastChange = now;
1009 |           return false;
1010 |         }
1011 | 
1012 |         return now - st.lastChange >= stableMs;
1013 |       },
1014 |       { timeout: timeoutMs },
1015 |       { stableMs }
1016 |     );
1017 |     return true;
1018 |   } catch {
1019 |     return false;
1020 |   }
1021 | }
1022 | 
1023 | export async function getCommentCount(page, url) {
1024 |   log.debug("UI:post", "getCommentCount...");
1025 | 
1026 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
1027 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1028 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1029 | 
1030 |   const scopeSel = await getPostScopeSelector(page);
1031 | 
1032 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
1033 |   log.debug("UI:post", `Filter all comments: ${okFilter}`);
1034 | 
1035 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
1036 |   if (okFilter) {
1037 |     await sleepRandom(250, 450);
1038 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
1039 |   }
1040 | 
1041 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
1042 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
1043 | 
1044 |   log.debug("UI:post", "UI comments", {
1045 |     source: ui?.source || "none",
1046 |     comments: ui?.comments ?? null,
1047 |   });
1048 | 
1049 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
1050 |     return ui.comments;
1051 |   }
1052 | 
1053 |   const anchors = await getCurrentCommentAnchorCount(page);
1054 |   log.debug("UI:post", `Fallback anchor count: ${anchors}`);
1055 | 
1056 |   return anchors > 0 ? anchors : null;
1057 | }
1058 | 
1059 | export async function loadAllComments(page, { expectedTotal } = {}) {
1060 |   log.dev("UI:post", `loadAllComments (expected: ${expectedTotal ?? "n/a"})`);
1061 | 
1062 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1063 | 
1064 |   const MAX_ROUNDS = 600;
1065 |   const MAX_NO_PROGRESS = 60;
1066 | 
1067 |   let noProgress = 0;
1068 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
1069 | 
1070 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
1071 |     const before = lastAnchors;
1072 | 
1073 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
1074 |     const clicks = await expandAllComments(page);
1075 |     await sleepRandom(220, 420);
1076 | 
1077 |     const after = await getCurrentCommentAnchorCount(page);
1078 | 
1079 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
1080 | 
1081 |     if (progressed) noProgress = 0;
1082 |     else noProgress++;
1083 | 
1084 |     lastAnchors = after;
1085 | 
1086 |     if (round === 1 || round % 25 === 0) {
1087 |       log.debug("UI:post", `Round ${round}`, {
1088 |         anchors: `${before}‚Üí${after}`,
1089 |         clicks,
1090 |         noProgress,
1091 |       });
1092 |     }
1093 | 
1094 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
1095 |       if (after >= expectedTotal && noProgress >= 2) {
1096 |         log.debug("UI:post", "Stop: target-reached");
1097 |         break;
1098 |       }
1099 |     }
1100 | 
1101 |     if (noProgress >= MAX_NO_PROGRESS) {
1102 |       log.debug("UI:post", "Stop: no-progress");
1103 |       break;
1104 |     }
1105 |   }
1106 | }
1107 | 
1108 | export async function extractComments(page, url) {
1109 |   const data = await page.evaluate(() => {
1110 |     function extractCommentId(u) {
1111 |       const m = u?.match(/comment_id=([^&]+)/);
1112 |       return m ? decodeURIComponent(m[1]) : null;
1113 |     }
1114 | 
1115 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
1116 |     const idToTimeMap = {};
1117 | 
1118 |     for (let i = 0; i < allLinks.length; i++) {
1119 |       const link = allLinks[i];
1120 |       const href = link.getAttribute("href") || "";
1121 |       const id = extractCommentId(href);
1122 |       if (!id) continue;
1123 | 
1124 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
1125 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
1126 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
1127 |           idToTimeMap[id] = timeText;
1128 |           break;
1129 |         }
1130 |       }
1131 |     }
1132 | 
1133 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
1134 | 
1135 |     const extracted = nodes
1136 |       .map((node, idx) => {
1137 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
1138 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
1139 | 
1140 |         const linkEl = node.querySelector('a[role="link"]');
1141 |         const href = linkEl?.getAttribute("href") || null;
1142 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
1143 | 
1144 |         const id = permalink ? extractCommentId(permalink) : null;
1145 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
1146 | 
1147 |         if (!author || !text) return null;
1148 | 
1149 |         return { id, author, text, time, permalink, pos: idx };
1150 |       })
1151 |       .filter(Boolean);
1152 | 
1153 |     return extracted;
1154 |   });
1155 | 
1156 |   log.debug("UI:post", `extractComments: ${data?.length || 0} komentarzy`);
1157 |   return Array.isArray(data) ? data : [];
1158 | }
1159 | 
1160 | export async function debugSnapshot(page) {
1161 |   const scopeSel = await getPostScopeSelector(page);
1162 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
1163 | 
1164 |   return {
1165 |     scopeSel,
1166 |     anchors,
1167 |     url: page.url(),
1168 |   };
1169 | }
1170 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/videos.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | import { safeGoto } from "../../utils/navigation.js";
  2 | import { sleepRandom } from "../../utils/sleep.js";
  3 | import log from "../../utils/logger.js";
  4 | import { acceptCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | 
  8 | /** Typ handlera UI */
  9 | export const type = "videos";
 10 | 
 11 | export function matchesUrl(url) {
 12 |   const lower = (url || "").toLowerCase();
 13 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
 14 | }
 15 | 
 16 | export async function prepare(page, url) {
 17 |   log.dev("UI:videos", `Prepare: ${url.slice(0, 50)}...`);
 18 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 19 |   if (!ok) throw new Error("safeGoto-failed");
 20 | 
 21 |   const currentUrl = page.url();
 22 |   if (currentUrl.includes("/login")) {
 23 |     log.dev("UI:videos", "Login required");
 24 |     await fbLogin(page);
 25 |     await sleepRandom(3000, 4500);
 26 | 
 27 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 28 |     log.dev("UI:videos", `Sesja po logowaniu: ${loggedAfterLogin ? "OK" : "BRAK"}`);
 29 | 
 30 |     if (loggedAfterLogin) {
 31 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 32 |     } else {
 33 |       log.warn("UI:videos", "Login failed");
 34 |     }
 35 |   }
 36 | 
 37 |   await acceptCookies(page, "videos");
 38 | 
 39 |   // stop autoplay
 40 |   try {
 41 |     await page.evaluate(() => {
 42 |       const vids = Array.from(document.querySelectorAll("video"));
 43 |       for (const v of vids) {
 44 |         try {
 45 |           v.autoplay = false;
 46 |           v.removeAttribute("autoplay");
 47 |           v.muted = true;
 48 |           v.pause();
 49 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
 50 |         } catch {}
 51 |       }
 52 |     });
 53 |     log.debug("UI:videos", "Video paused");
 54 |   } catch (e) {
 55 |     log.debug("UI:videos", `Video pause error: ${e?.message || e}`);
 56 |   }
 57 | }
 58 | 
 59 | export async function getCommentCount(page, url) {
 60 |   const uiInfo = await getUiCommentInfo(page);
 61 |   log.debug("UI:videos", "UI info", {
 62 |     source: uiInfo?.source,
 63 |     raw: uiInfo?.raw,
 64 |     viewType: uiInfo?.viewType,
 65 |     comments: uiInfo?.comments,
 66 |   });
 67 | 
 68 |   let totalComments = null;
 69 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
 70 | 
 71 |   log.dev("UI:videos", `Liczba komentarzy: ${totalComments ?? "brak danych"}`);
 72 |   return totalComments;
 73 | }
 74 | 
 75 | /* ==============================
 76 |    ======= DEBUG HELPERS ========
 77 |    ============================== */
 78 | 
 79 | function shortenHtml(html, max = 220) {
 80 |   if (!html) return null;
 81 |   const s = String(html).replace(/\s+/g, " ").trim();
 82 |   if (s.length <= max) return s;
 83 |   return s.slice(0, max) + "‚Ä¶";
 84 | }
 85 | 
 86 | async function debugDumpShowAllCandidates(page) {
 87 |   const out = await page.evaluate(() => {
 88 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
 89 |     function pick(el) {
 90 |       if (!el) return null;
 91 |       const r = el.getBoundingClientRect();
 92 |       return {
 93 |         tag: el.tagName,
 94 |         role: el.getAttribute("role"),
 95 |         aria: el.getAttribute("aria-label"),
 96 |         text: norm(el.textContent),
 97 |         top: Math.round(r.top),
 98 |         left: Math.round(r.left),
 99 |         w: Math.round(r.width),
100 |         h: Math.round(r.height),
101 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
102 |       };
103 |     }
104 | 
105 |     const headers = Array.from(document.querySelectorAll("span"))
106 |       .filter((s) => {
107 |         const t = norm(s.textContent).toLowerCase();
108 |         return t === "komentarze" || t === "comments";
109 |       })
110 |       .slice(0, 5)
111 |       .map(pick);
112 | 
113 |     const showAll = Array.from(
114 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
115 |     )
116 |       .filter((el) => {
117 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
118 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
119 |       })
120 |       .slice(0, 20)
121 |       .map(pick);
122 | 
123 |     return { headers, showAll };
124 |   });
125 | 
126 |   log.debug("UI:videos", "Candidates", out);
127 | }
128 | 
129 | /* ==========================================
130 |    ======= COMMENTS SCOPE / MARKERS =========
131 |    ========================================== */
132 | 
133 | async function markCommentsScope(page) {
134 |   return await page.evaluate(() => {
135 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
136 | 
137 |     function isVisible(el) {
138 |       if (!el) return false;
139 |       const st = getComputedStyle(el);
140 |       if (st.display === "none" || st.visibility === "hidden") return false;
141 |       const r = el.getBoundingClientRect();
142 |       return !!r && r.width > 5 && r.height > 5;
143 |     }
144 | 
145 |     function pick(el) {
146 |       if (!el) return null;
147 |       const r = el.getBoundingClientRect();
148 |       return {
149 |         tag: el.tagName,
150 |         role: el.getAttribute("role"),
151 |         aria: el.getAttribute("aria-label"),
152 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
153 |         top: Math.round(r.top),
154 |         left: Math.round(r.left),
155 |         w: Math.round(r.width),
156 |         h: Math.round(r.height),
157 |       };
158 |     }
159 | 
160 |     // clear markers
161 |     try {
162 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
163 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
164 |         n.removeAttribute("data-fbw-comments-header-row")
165 |       );
166 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
167 |         n.removeAttribute("data-fbw-comments-anchor")
168 |       );
169 |     } catch {}
170 | 
171 |     // find header
172 |     const headerSpans = Array.from(document.querySelectorAll("span"))
173 |       .filter(isVisible)
174 |       .filter((el) => {
175 |         const t = norm(el.textContent);
176 |         return t === "komentarze" || t === "comments";
177 |       });
178 | 
179 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
180 | 
181 |     // pick first visible header and mark a "root" around it
182 |     const h = headerSpans[0];
183 | 
184 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
185 |     let row = h.parentElement;
186 |     let foundRow = null;
187 | 
188 |     for (let up = 0; up < 14 && row; up++) {
189 |       const btns = Array.from(
190 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
191 |       ).filter(isVisible);
192 | 
193 |       const ok = btns.some((b) => {
194 |         const al = norm(b.getAttribute("aria-label"));
195 |         return (
196 |           al === "poka≈º wszystkie" ||
197 |           al === "wy≈õwietl wszystkie" ||
198 |           al === "show all" ||
199 |           al === "view all" ||
200 |           al === "ukryj komentarze" ||
201 |           al === "hide comments"
202 |         );
203 |       });
204 | 
205 |       if (ok) {
206 |         foundRow = row;
207 |         break;
208 |       }
209 |       row = row.parentElement;
210 |     }
211 | 
212 |     if (foundRow) {
213 |       try {
214 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
215 |       } catch {}
216 |     }
217 | 
218 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
219 |     let root = h.parentElement;
220 |     let best = null;
221 | 
222 |     for (let up = 0; up < 26 && root; up++) {
223 |       const txt = norm(root.innerText || "");
224 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
225 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
226 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
227 |       const isBigEnough = (root.clientHeight || 0) > 250;
228 | 
229 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
230 |         best = root;
231 |         break;
232 |       }
233 |       root = root.parentElement;
234 |     }
235 | 
236 |     // fallback: use header row parent
237 |     if (!best && foundRow) best = foundRow.parentElement;
238 |     if (!best) best = document.body;
239 | 
240 |     try {
241 |       best.setAttribute("data-fbw-comments-root", "1");
242 |     } catch {}
243 | 
244 |     // anchor element for scroll targeting: header span itself
245 |     try {
246 |       h.setAttribute("data-fbw-comments-anchor", "1");
247 |     } catch {}
248 | 
249 |     return {
250 |       ok: true,
251 |       reason: "marked",
252 |       header: pick(h),
253 |       row: foundRow ? pick(foundRow) : null,
254 |       root: pick(best),
255 |     };
256 |   });
257 | }
258 | 
259 | async function clickShowAllFromMarkedRow(page) {
260 |   const res = await page.evaluate(() => {
261 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
262 | 
263 |     function isVisible(el) {
264 |       if (!el) return false;
265 |       const st = getComputedStyle(el);
266 |       if (st.display === "none" || st.visibility === "hidden") return false;
267 |       const r = el.getBoundingClientRect();
268 |       return !!r && r.width > 5 && r.height > 5;
269 |     }
270 | 
271 |     function pick(el) {
272 |       if (!el) return null;
273 |       const r = el.getBoundingClientRect();
274 |       return {
275 |         tag: el.tagName,
276 |         role: el.getAttribute("role"),
277 |         aria: el.getAttribute("aria-label"),
278 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
279 |         top: Math.round(r.top),
280 |         left: Math.round(r.left),
281 |         w: Math.round(r.width),
282 |         h: Math.round(r.height),
283 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
284 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
285 |       };
286 |     }
287 | 
288 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
289 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
290 | 
291 |     const candidates = Array.from(
292 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
293 |     ).filter(isVisible);
294 | 
295 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
296 |     for (const c of candidates) {
297 |       const al = norm(c.getAttribute("aria-label"));
298 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
299 |         try {
300 |           c.scrollIntoView({ block: "center", inline: "nearest" });
301 |         } catch {}
302 |         try {
303 |           c.click();
304 |         } catch {}
305 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
306 |       }
307 |     }
308 | 
309 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
310 |   });
311 | 
312 |   log.debug("UI:videos", "Show-all click", res);
313 |   return !!res?.clicked;
314 | }
315 | 
316 | /* ==========================================
317 |    ======= FILTER/SORT (Najtrafniejsze) ======
318 |    ========================================== */
319 | 
320 | async function ensureAllCommentsFilter(page) {
321 |   const res = await page.evaluate(() => {
322 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
323 | 
324 |     function isVisible(el) {
325 |       if (!el) return false;
326 |       const st = getComputedStyle(el);
327 |       if (st.display === "none" || st.visibility === "hidden") return false;
328 |       const r = el.getBoundingClientRect();
329 |       return !!r && r.width > 5 && r.height > 5;
330 |     }
331 | 
332 |     function pick(el) {
333 |       if (!el) return null;
334 |       const r = el.getBoundingClientRect();
335 |       return {
336 |         tag: el.tagName,
337 |         role: el.getAttribute("role"),
338 |         aria: el.getAttribute("aria-label"),
339 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
340 |         top: Math.round(r.top),
341 |         left: Math.round(r.left),
342 |         w: Math.round(r.width),
343 |         h: Math.round(r.height),
344 |       };
345 |     }
346 | 
347 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
348 | 
349 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
350 |     const rootTxt = norm(root.innerText || "");
351 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
352 |       return { ok: true, action: "already-all", dbg: null };
353 |     }
354 | 
355 |     // find the sort dropdown button in root
356 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
357 | 
358 |     const sortBtn = btns.find((b) => {
359 |       const t = norm(b.textContent);
360 |       return (
361 |         t === "najtrafniejsze" ||
362 |         t === "most relevant" ||
363 |         t === "top comments" ||
364 |         t === "najlepsze" ||
365 |         t === "newest" ||
366 |         t === "najnowsze"
367 |       );
368 |     });
369 | 
370 |     if (!sortBtn) {
371 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
372 |     }
373 | 
374 |     try {
375 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
376 |     } catch {}
377 |     try {
378 |       sortBtn.click();
379 |     } catch {}
380 | 
381 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
382 |   });
383 | 
384 |   log.debug("UI:videos", "Filter step#1", res);
385 | 
386 |   if (!res?.ok || res.action !== "opened-menu") return false;
387 | 
388 |   await sleepRandom(400, 700);
389 | 
390 |   const res2 = await page.evaluate(() => {
391 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
392 | 
393 |     function isVisible(el) {
394 |       if (!el) return false;
395 |       const st = getComputedStyle(el);
396 |       if (st.display === "none" || st.visibility === "hidden") return false;
397 |       const r = el.getBoundingClientRect();
398 |       return !!r && r.width > 5 && r.height > 5;
399 |     }
400 | 
401 |     function pick(el) {
402 |       if (!el) return null;
403 |       const r = el.getBoundingClientRect();
404 |       return {
405 |         tag: el.tagName,
406 |         role: el.getAttribute("role"),
407 |         aria: el.getAttribute("aria-label"),
408 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
409 |         top: Math.round(r.top),
410 |         left: Math.round(r.left),
411 |         w: Math.round(r.width),
412 |         h: Math.round(r.height),
413 |       };
414 |     }
415 | 
416 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
417 | 
418 |     if (!menu) return { ok: false, action: "no-menu" };
419 | 
420 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
421 |       .filter(isVisible)
422 |       .slice(0, 200);
423 | 
424 |     // Prefer: "Wszystkie komentarze" / "All comments"
425 |     let target =
426 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
427 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
428 | 
429 |     // Fallback: "Najnowsze" / "Newest"
430 |     if (!target) {
431 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
432 |     }
433 | 
434 |     if (!target) {
435 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
436 |     }
437 | 
438 |     try {
439 |       target.scrollIntoView({ block: "center", inline: "nearest" });
440 |     } catch {}
441 |     try {
442 |       target.click();
443 |     } catch {}
444 | 
445 |     // close menu
446 |     try {
447 |       setTimeout(() => document.body.click(), 40);
448 |     } catch {}
449 | 
450 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
451 |   });
452 | 
453 |   log.debug("UI:videos", "Filter step#2", res2);
454 | 
455 |   await sleepRandom(500, 900);
456 | 
457 |   return !!res2?.ok;
458 | }
459 | 
460 | /* ==========================================
461 |    ======= FAST_MODE: SORTOWANIE "NAJNOWSZE" ==
462 |    ========================================== */
463 | 
464 | export async function switchCommentsFilterToNewestScoped(page) {
465 |   log.dev("UI:videos", "Prze≈ÇƒÖczam na 'Najnowsze'...");
466 | 
467 |   // ZAWSZE najpierw spr√≥buj kliknƒÖƒá "Poka≈º wszystkie" ≈ºeby otworzyƒá pe≈Çny panel komentarzy
468 |   log.debug("UI:videos", "Otwieranie panelu komentarzy...");
469 | 
470 |   const clickedShowAll = await page.evaluate(() => {
471 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
472 | 
473 |     function isVisible(el) {
474 |       if (!el) return false;
475 |       const st = getComputedStyle(el);
476 |       if (st.display === "none" || st.visibility === "hidden") return false;
477 |       const r = el.getBoundingClientRect();
478 |       return !!r && r.width > 5 && r.height > 5;
479 |     }
480 | 
481 |     // Szukaj przycisku "Poka≈º wszystkie" / "Show all"
482 |     const btns = Array.from(
483 |       document.querySelectorAll("div[role='button'][aria-label], button[aria-label], a[aria-label]")
484 |     ).filter(isVisible);
485 | 
486 |     for (const btn of btns) {
487 |       const al = norm(btn.getAttribute("aria-label"));
488 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
489 |         try {
490 |           btn.scrollIntoView({ block: "center", inline: "nearest" });
491 |         } catch {}
492 |         try {
493 |           btn.click();
494 |           return { clicked: true, label: al };
495 |         } catch {}
496 |       }
497 |     }
498 |     return { clicked: false };
499 |   });
500 | 
501 |   if (clickedShowAll?.clicked) {
502 |     log.debug("UI:videos", `Klikniƒôto '${clickedShowAll.label}'`);
503 |     await sleepRandom(1500, 2200);
504 |   } else {
505 |     log.debug("UI:videos", "Nie znaleziono 'Poka≈º wszystkie' - mo≈ºe ju≈º rozwiniƒôte");
506 |   }
507 | 
508 |   // Oznacz scope komentarzy
509 |   const mark = await markCommentsScope(page).catch(() => null);
510 |   log.debug("UI:videos", `markCommentsScope: ${mark?.ok ? "OK" : mark?.reason}`);
511 | 
512 |   if (!mark?.ok) {
513 |     log.debug("UI:videos", "Nie znaleziono sekcji komentarzy");
514 |     return { ok: false, reason: "no-comments-scope" };
515 |   }
516 | 
517 |   await sleepRandom(200, 400);
518 | 
519 |   // Sprawd≈∫ czy ju≈º "Najnowsze"
520 |   const alreadyNewest = await page.evaluate(() => {
521 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
522 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
523 |     const rootTxt = norm(root.innerText || "");
524 | 
525 |     // Szukamy przycisku z labelem "Najnowsze" jako aktywny filtr
526 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button"));
527 |     return btns.some((b) => {
528 |       const t = norm(b.textContent);
529 |       return t === "najnowsze" || t === "newest";
530 |     });
531 |   });
532 | 
533 |   if (alreadyNewest) {
534 |     log.debug("UI:videos", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
535 |     return { ok: true, state: "already-newest" };
536 |   }
537 | 
538 |   // Otw√≥rz menu sortowania
539 |   const openRes = await page.evaluate(() => {
540 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
541 | 
542 |     function isVisible(el) {
543 |       if (!el) return false;
544 |       const st = getComputedStyle(el);
545 |       if (st.display === "none" || st.visibility === "hidden") return false;
546 |       const r = el.getBoundingClientRect();
547 |       return !!r && r.width > 5 && r.height > 5;
548 |     }
549 | 
550 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
551 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
552 | 
553 |     // Szukaj przycisku sortowania (Najtrafniejsze/Most relevant/Top comments/Wszystkie komentarze)
554 |     const sortBtn = btns.find((b) => {
555 |       const t = norm(b.textContent);
556 |       return (
557 |         t === "najtrafniejsze" ||
558 |         t === "most relevant" ||
559 |         t === "top comments" ||
560 |         t === "najlepsze" ||
561 |         t === "wszystkie komentarze" ||
562 |         t === "all comments"
563 |       );
564 |     });
565 | 
566 |     if (!sortBtn) {
567 |       return { ok: false, reason: "no-sortbtn" };
568 |     }
569 | 
570 |     try {
571 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
572 |     } catch {}
573 |     try {
574 |       sortBtn.click();
575 |     } catch {}
576 | 
577 |     return { ok: true, action: "opened-menu" };
578 |   });
579 | 
580 |   if (!openRes?.ok) {
581 |     log.debug("UI:videos", "Nie znaleziono przycisku sortowania");
582 |     return { ok: false, reason: openRes?.reason || "no-sortbtn" };
583 |   }
584 | 
585 |   await sleepRandom(400, 700);
586 | 
587 |   // Wybierz "Najnowsze" z menu
588 |   const selectRes = await page.evaluate(() => {
589 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
590 | 
591 |     function isVisible(el) {
592 |       if (!el) return false;
593 |       const st = getComputedStyle(el);
594 |       if (st.display === "none" || st.visibility === "hidden") return false;
595 |       const r = el.getBoundingClientRect();
596 |       return !!r && r.width > 5 && r.height > 5;
597 |     }
598 | 
599 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
600 |     if (!menu) return { ok: false, reason: "no-menu" };
601 | 
602 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
603 |       .filter(isVisible);
604 | 
605 |     // Szukaj "Najnowsze" / "Newest"
606 |     const target = items.find((el) => {
607 |       const t = norm(el.textContent);
608 |       return t.startsWith("najnowsze") || t.startsWith("newest") || t.startsWith("od najnowszych") || t.startsWith("most recent");
609 |     });
610 | 
611 |     if (!target) {
612 |       return { ok: false, reason: "no-newest-option" };
613 |     }
614 | 
615 |     try {
616 |       target.scrollIntoView({ block: "center", inline: "nearest" });
617 |     } catch {}
618 |     try {
619 |       target.click();
620 |     } catch {}
621 | 
622 |     // Zamknij menu
623 |     try {
624 |       setTimeout(() => document.body.click(), 40);
625 |     } catch {}
626 | 
627 |     return { ok: true, action: "clicked-newest" };
628 |   });
629 | 
630 |   if (selectRes?.ok) {
631 |     log.dev("UI:videos", "Filtr ustawiony: 'Najnowsze'");
632 |     await sleepRandom(400, 700);
633 |     return { ok: true };
634 |   }
635 | 
636 |   log.debug("UI:videos", `Nie uda≈Ço siƒô wybraƒá 'Najnowsze': ${selectRes?.reason}`);
637 |   return { ok: false, reason: selectRes?.reason || "select-failed" };
638 | }
639 | 
640 | /* ==========================================
641 |    ======= SEQUENTIAL ACTION LOOP ============
642 |    ========================================== */
643 | 
644 | async function oneSequentialAction(page) {
645 |   const res = await page.evaluate(() => {
646 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
647 | 
648 |     function isVisible(el) {
649 |       if (!el) return false;
650 |       const st = getComputedStyle(el);
651 |       if (st.display === "none" || st.visibility === "hidden") return false;
652 |       const r = el.getBoundingClientRect();
653 |       return !!r && r.width > 5 && r.height > 5;
654 |     }
655 | 
656 |     function pick(el) {
657 |       if (!el) return null;
658 |       const r = el.getBoundingClientRect();
659 |       return {
660 |         tag: el.tagName,
661 |         role: el.getAttribute("role"),
662 |         aria: el.getAttribute("aria-label"),
663 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
664 |         top: Math.round(r.top),
665 |         left: Math.round(r.left),
666 |         w: Math.round(r.width),
667 |         h: Math.round(r.height),
668 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
669 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
670 |       };
671 |     }
672 | 
673 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
674 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
675 | 
676 |     const composer =
677 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
678 |       root.querySelector("[aria-label^='Write a comment']") ||
679 |       root.querySelector("[role='textbox'][contenteditable='true']");
680 | 
681 |     let scope = root;
682 |     if (composer) {
683 |       let p = composer.parentElement;
684 |       for (let up = 0; up < 14 && p; up++) {
685 |         const bigEnough = (p.clientHeight || 0) > 220;
686 |         const t = norm(p.innerText || "");
687 |         const looksCommenty =
688 |           t.includes("najtrafniejsze") ||
689 |           t.includes("most relevant") ||
690 |           t.includes("wszystkie komentarze") ||
691 |           t.includes("all comments") ||
692 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
693 |           t.includes("view more comments");
694 |         if (bigEnough && looksCommenty) {
695 |           scope = p;
696 |           break;
697 |         }
698 |         p = p.parentElement;
699 |       }
700 |     }
701 | 
702 |     // UWAGA: klikamy TYLKO elementy klikalne
703 |     const clickables = Array.from(
704 |       scope.querySelectorAll(
705 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
706 |       )
707 |     )
708 |       .filter(isVisible)
709 |       .slice(0, 12000);
710 | 
711 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
712 | 
713 |     const moreCommentNeedles = [
714 |       "wy≈õwietl wiƒôcej komentarzy",
715 |       "zobacz wiƒôcej komentarzy",
716 |       "view more comments",
717 |       "view previous comments",
718 |       "see more comments",
719 |     ];
720 | 
721 |     // 1) MORE COMMENTS ‚Äì tylko clickables
722 |     for (const el of clickables) {
723 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
724 |       if (!t) continue;
725 |       if (bannedExact.has(t)) continue;
726 | 
727 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
728 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
729 |         try { el.click(); } catch {}
730 |         return { acted: true, action: "more-comments", dbg: pick(el) };
731 |       }
732 |     }
733 | 
734 |     // 2) REPLIES ‚Äì tylko clickables
735 |     for (const el of clickables) {
736 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
737 |       if (!t) continue;
738 |       if (bannedExact.has(t)) continue;
739 | 
740 |       const isReply =
741 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
742 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
743 |         t.includes("view more replies") ||
744 |         t.includes("see more replies") ||
745 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
746 | 
747 |       if (isReply) {
748 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
749 |         try { el.click(); } catch {}
750 |         return { acted: true, action: "replies", dbg: pick(el) };
751 |       }
752 |     }
753 | 
754 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
755 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
756 | 
757 |     const beforeScope = scope.scrollTop || 0;
758 |     try {
759 |       if (scope && typeof scope.scrollTop === "number") {
760 |         scope.scrollTop = beforeScope + step;
761 |         const afterScope = scope.scrollTop || beforeScope;
762 |         if (afterScope > beforeScope) {
763 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
764 |         }
765 |       }
766 |     } catch {}
767 | 
768 |     const beforeWin = window.scrollY || 0;
769 |     window.scrollBy(0, step);
770 |     const afterWin = window.scrollY || 0;
771 | 
772 |     return {
773 |       acted: afterWin > beforeWin,
774 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
775 |       dbg: { beforeWin, afterWin, step },
776 |     };
777 |   });
778 | 
779 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
780 |   log.debug("UI:videos", "step", res);
781 |   return res || { acted: false, action: "none", dbg: null };
782 | }
783 | 
784 | 
785 | 
786 | /**
787 |  * Wczytuje wszystkie komentarze dla posta wideo.
788 |  */
789 | export async function loadAllComments(page, { expectedTotal } = {}) {
790 |   log.dev("UI:videos", "≈Åadujƒô komentarze...");
791 | 
792 |   await debugDumpShowAllCandidates(page).catch(() => {});
793 | 
794 |   const mark1 = await markCommentsScope(page).catch(() => null);
795 |   log.debug("UI:videos", "mark#1", mark1);
796 | 
797 |   await sleepRandom(250, 500);
798 | 
799 |   // klik show-all z header-row
800 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
801 |   if (clickedAll) {
802 |     await sleepRandom(900, 1400);
803 |     const mark2 = await markCommentsScope(page).catch(() => null);
804 |     log.debug("UI:videos", "mark#2", mark2);
805 |   } else {
806 |     log.debug("UI:videos", "show-all: nie klikniƒôto");
807 |   }
808 | 
809 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
810 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
811 |   log.debug("UI:videos", `filter ensure: ${filterOk}`);
812 | 
813 |   // policz cykle dynamicznie
814 |   let maxCycles = 180;
815 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
816 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
817 |   }
818 | 
819 |   let noProgress = 0;
820 | 
821 |   for (let i = 1; i <= maxCycles; i++) {
822 |     // jedna akcja na cykl
823 |     const r = await oneSequentialAction(page);
824 | 
825 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
826 |     if (!didProgress) noProgress++;
827 |     else noProgress = 0;
828 | 
829 |     if (i === 1 || i % 20 === 0) {
830 |       log.debug("UI:videos", `Cycle ${i}/${maxCycles}`, { action: r?.action, acted: !!r?.acted, noProgress });
831 |     }
832 | 
833 |     if (noProgress >= 10) {
834 |       log.debug("UI:videos", "Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie");
835 |       break;
836 |     }
837 | 
838 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
839 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
840 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
841 |     else await sleepRandom(450, 850);
842 |   }
843 | 
844 |   log.dev("UI:videos", "Komentarze za≈Çadowane");
845 | }
846 | 
847 | /**
848 |  * Ekstrahuje komentarze z posta wideo.
849 |  */
850 | export async function extractComments(page, url) {
851 |   const comments = await page.evaluate(() => {
852 |     function getCommentId(href) {
853 |       try {
854 |         const u = new URL(href, location.origin);
855 |         const cid = u.searchParams.get("comment_id");
856 |         const rid = u.searchParams.get("reply_comment_id");
857 |         return rid || cid;
858 |       } catch {
859 |         return null;
860 |       }
861 |     }
862 | 
863 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
864 |     const idToTime = {};
865 | 
866 |     for (let i = 0; i < allLinks.length; i++) {
867 |       const id = getCommentId(allLinks[i].href || "");
868 |       if (id) {
869 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
870 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
871 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
872 |             idToTime[id] = txt;
873 |             break;
874 |           }
875 |         }
876 |       }
877 |     }
878 | 
879 |     const commentBlocks = Array.from(
880 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
881 |     );
882 | 
883 |     const data = commentBlocks
884 |       .map((node) => {
885 |         try {
886 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
887 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
888 |           const linkEl = node.querySelector('a[role="link"]');
889 |           const href = linkEl?.getAttribute("href");
890 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
891 |           const id = permalink ? getCommentId(permalink) : null;
892 |           const time = id && idToTime[id] ? idToTime[id] : null;
893 | 
894 |           if (!author && !text) return null;
895 |           return { id, author, text, permalink, time };
896 |         } catch {
897 |           return null;
898 |         }
899 |       })
900 |       .filter(Boolean);
901 | 
902 |     return data;
903 |   });
904 | 
905 |   log.debug("UI:videos", `Wyekstrahowano ${comments.length} komentarzy`);
906 |   return comments;
907 | }
908 | 
909 | export async function debugSnapshot(page) {
910 |   try {
911 |     const path = `snapshot-videos.png`;
912 |     await page.screenshot({ path });
913 |     log.debug("UI:videos", `Zapisano zrzut: ${path}`);
914 |   } catch (e) {
915 |     log.error("UI:videos", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
916 |   }
917 | }
918 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/watch.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/ui/watch.js
  2 | import { safeGoto } from "../../utils/navigation.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { acceptCookies, saveCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | import log from "../../utils/logger.js";
  8 | 
  9 | /** Typ handlera UI */
 10 | export const type = "watch";
 11 | 
 12 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
 13 | export function matchesUrl(url) {
 14 |   try {
 15 |     const u = new URL(url);
 16 |     return (u.pathname || "").toLowerCase().includes("/watch");
 17 |   } catch {
 18 |     return String(url || "").toLowerCase().includes("/watch");
 19 |   }
 20 | }
 21 | 
 22 | /* ============================================================
 23 |    ======================= DEBUG HELPERS ======================
 24 |    ============================================================ */
 25 | 
 26 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
 27 | 
 28 | async function safeShot(page, path, clip = null) {
 29 |   if (!DEBUG_WATCH) return;
 30 |   try {
 31 |     const opts = clip ? { path, clip } : { path, fullPage: false };
 32 |     await page.screenshot(opts);
 33 |     log.debug("UI:watch", `Screenshot ‚Üí ${path}`);
 34 |   } catch (e) {
 35 |     log.debug("UI:watch", `Screenshot failed: ${e?.message || e}`);
 36 |   }
 37 | }
 38 | 
 39 | async function shotElement(page, handle, path) {
 40 |   if (!DEBUG_WATCH) return;
 41 |   try {
 42 |     if (!handle) return;
 43 |     const box = await handle.boundingBox().catch(() => null);
 44 |     if (!box || box.width < 5 || box.height < 5) {
 45 |       log.debug("UI:watch", "shotElement: no bbox");
 46 |       return;
 47 |     }
 48 |     const clip = {
 49 |       x: Math.max(0, box.x),
 50 |       y: Math.max(0, box.y),
 51 |       width: Math.max(1, Math.min(box.width, 1920)),
 52 |       height: Math.max(1, Math.min(box.height, 1080)),
 53 |     };
 54 |     await safeShot(page, path, clip);
 55 |   } catch (e) {
 56 |     log.debug("UI:watch", `shotElement failed: ${e?.message || e}`);
 57 |   }
 58 | }
 59 | 
 60 | async function debugOuterStats(page, outerHandle) {
 61 |   if (!DEBUG_WATCH) return null;
 62 |   if (!outerHandle) return null;
 63 | 
 64 |   return page.evaluate((outer) => {
 65 |     const norm = (s) =>
 66 |       String(s || "")
 67 |         .replace(/\u00a0/g, " ")
 68 |         .replace(/\s+/g, " ")
 69 |         .trim();
 70 | 
 71 |     const r = outer.getBoundingClientRect();
 72 |     const style = getComputedStyle(outer);
 73 | 
 74 |     const anchors = Array.from(
 75 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 76 |     );
 77 | 
 78 |     const allText = (outer.innerText || "").toLowerCase();
 79 |     const moreHits =
 80 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
 81 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
 82 |       (allText.match(/view more comments/g) || []).length +
 83 |       (allText.match(/see more comments/g) || []).length;
 84 | 
 85 |     const labels = [];
 86 |     const nodes = Array.from(
 87 |       outer.querySelectorAll(
 88 |         "button,div[role='button'],span[role='button'],a,abbr,[role='article'],div,span"
 89 |       )
 90 |     ).slice(0, 4000);
 91 | 
 92 |     for (const el of nodes) {
 93 |       const a = el.getAttribute?.("aria-label");
 94 |       const t = norm(a);
 95 |       if (t) labels.push(t);
 96 |     }
 97 | 
 98 |     const freq = new Map();
 99 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
100 |     const topLabels = Array.from(freq.entries())
101 |       .sort((a, b) => b[1] - a[1])
102 |       .slice(0, 15)
103 |       .map(([k, v]) => ({ label: k, n: v }));
104 | 
105 |     return {
106 |       tag: outer.tagName,
107 |       className: outer.className || "",
108 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
109 |       style: {
110 |         overflowY: style.overflowY,
111 |         position: style.position,
112 |       },
113 |       counts: {
114 |         anchors: anchors.length,
115 |         moreHits,
116 |       },
117 |       topLabels,
118 |     };
119 |   }, outerHandle);
120 | }
121 | 
122 | async function debugScrollerStats(page, scrollerHandle) {
123 |   if (!DEBUG_WATCH) return null;
124 |   if (!scrollerHandle) return null;
125 | 
126 |   return page.evaluate((s) => {
127 |     const r = s.getBoundingClientRect();
128 |     const st = getComputedStyle(s);
129 |     return {
130 |       tag: s.tagName,
131 |       className: s.className || "",
132 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
133 |       style: { overflowY: st.overflowY, overflow: st.overflow },
134 |       scroll: {
135 |         scrollTop: s.scrollTop,
136 |         clientHeight: s.clientHeight,
137 |         scrollHeight: s.scrollHeight,
138 |       },
139 |     };
140 |   }, scrollerHandle);
141 | }
142 | 
143 | /* ============================================================
144 |    ======================= PARSING COUNT =======================
145 |    ============================================================ */
146 | 
147 | function parseCountFromText(str) {
148 |   if (!str) return null;
149 | 
150 |   const raw = String(str)
151 |     .toLowerCase()
152 |     .replace(/\u00a0/g, " ")
153 |     .replace(/\s+/g, " ")
154 |     .trim();
155 | 
156 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
157 |   if (!m) return null;
158 | 
159 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
160 |   const suf = (m[2] || "").trim();
161 | 
162 |   const hasDecimal = /[.,]\d/.test(numStr);
163 |   if (hasDecimal) numStr = numStr.replace(",", ".");
164 |   else numStr = numStr.replace(/[.,]/g, "");
165 | 
166 |   let n = Number(numStr);
167 |   if (!Number.isFinite(n)) return null;
168 | 
169 |   if (suf === "k") n *= 1000;
170 |   if (suf === "tys" || suf === "tys.") n *= 1000;
171 |   if (suf === "m" || suf === "mln") n *= 1000000;
172 | 
173 |   n = Math.round(n);
174 |   if (n <= 0) return null;
175 |   return n;
176 | }
177 | 
178 | function parseBestCommentsCountFromBlob(blobStr) {
179 |   if (!blobStr) return null;
180 | 
181 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
182 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
183 | 
184 |   let best = null;
185 |   let match;
186 |   while ((match = re.exec(raw)) !== null) {
187 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
188 |     const n = parseCountFromText(candidate);
189 |     if (n && (!best || n > best)) best = n;
190 |   }
191 |   return best;
192 | }
193 | 
194 | function pickBestCount(candidates) {
195 |   const nums = candidates.filter((v) => typeof v === "number" && Number.isFinite(v) && v > 0);
196 |   if (!nums.length) return null;
197 | 
198 |   nums.sort((a, b) => b - a);
199 |   const best = nums[0];
200 |   const second = nums[1];
201 | 
202 |   if (second && best >= 2 * second && second < 150) return best;
203 | 
204 |   return best;
205 | }
206 | 
207 | /* ============================================================
208 |    =================== COMMENTS CONTAINER FIND =================
209 |    ============================================================ */
210 | 
211 | /**
212 |  * WATCH FIX:
213 |  * - NIE polegamy na h2 "Komentarze" (czƒôsto go nie ma w Watch).
214 |  * - Szukamy najwiƒôkszego klastra link√≥w comment_id/reply_comment_id na stronie.
215 |  */
216 | async function findCommentsOuter(page) {
217 |   const handle = await page.evaluateHandle(() => {
218 |     const nodes = Array.from(document.querySelectorAll("div, section, main, article")).slice(0, 30000);
219 | 
220 |     const visible = (el) => {
221 |       if (!el) return false;
222 |       const r = el.getBoundingClientRect?.();
223 |       return r && r.width >= 220 && r.height >= 220;
224 |     };
225 | 
226 |     let best = null;
227 |     let bestScore = -1;
228 | 
229 |     for (const el of nodes) {
230 |       if (!visible(el)) continue;
231 | 
232 |       const anchors = el.querySelectorAll?.("a[href*='comment_id'], a[href*='reply_comment_id']");
233 |       const aCount = anchors ? anchors.length : 0;
234 |       if (aCount < 3) continue;
235 | 
236 |       const txt = (el.innerText || "").toLowerCase();
237 |       const hasWords =
238 |         txt.includes("komentarz") || txt.includes("komentarzy") || txt.includes("comments") || txt.includes("comment");
239 | 
240 |       // score: anchor count + bonus za s≈Çowa ‚Äúkomentarz‚Äù
241 |       const score = aCount + (hasWords ? 12 : 0);
242 | 
243 |       if (score > bestScore) {
244 |         bestScore = score;
245 |         best = el;
246 |       }
247 |     }
248 | 
249 |     return best || null;
250 |   });
251 | 
252 |   const el = handle?.asElement?.() || null;
253 |   if (!el) return null;
254 | 
255 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
256 |   return ok ? el : null;
257 | }
258 | 
259 | async function findScrollableInOuter(page, outerHandle) {
260 |   if (!outerHandle) return null;
261 | 
262 |   const scrollerHandle = await page.evaluateHandle((outer) => {
263 |     function isVisible(el) {
264 |       if (!el) return false;
265 |       const r = el.getBoundingClientRect();
266 |       return r.width > 2 && r.height > 2;
267 |     }
268 | 
269 |     function canScroll(el) {
270 |       try {
271 |         if (!el) return false;
272 |         const st = getComputedStyle(el);
273 |         const oy = (st.overflowY || "").toLowerCase();
274 |         if (!(oy === "auto" || oy === "scroll")) return false;
275 |         const h = el.clientHeight || 0;
276 |         const sh = el.scrollHeight || 0;
277 |         return sh > h + 80;
278 |       } catch {
279 |         return false;
280 |       }
281 |     }
282 | 
283 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
284 |       .filter(isVisible)
285 |       .slice(0, 20000);
286 | 
287 |     let best = null;
288 |     let bestScore = -1;
289 | 
290 |     for (const el of nodes) {
291 |       if (!canScroll(el)) continue;
292 | 
293 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
294 |       const txt = (el.innerText || "").toLowerCase();
295 | 
296 |       const hasMore =
297 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
298 |         txt.includes("view more comments") ||
299 |         txt.includes("see more comments") ||
300 |         txt.includes("zobacz wiƒôcej komentarzy") ||
301 |         txt.includes("zobacz wcze≈õniejsze komentarze");
302 | 
303 |       const score = delta + (hasMore ? 100000 : 0);
304 |       if (score > bestScore) {
305 |         bestScore = score;
306 |         best = el;
307 |       }
308 |     }
309 | 
310 |     return best || null;
311 |   }, outerHandle);
312 | 
313 |   const el = scrollerHandle?.asElement?.() || null;
314 |   if (!el) return null;
315 | 
316 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
317 |   return ok ? el : null;
318 | }
319 | 
320 | async function clickMoreCommentsIfPresent(page, outerHandle) {
321 |   if (!outerHandle) return false;
322 | 
323 |   const labels = [
324 |     "wy≈õwietl wiƒôcej komentarzy",
325 |     "zobacz wiƒôcej komentarzy",
326 |     "zobacz wcze≈õniejsze komentarze",
327 |     "view more comments",
328 |     "see more comments",
329 |     "show more comments",
330 |     "view previous comments",
331 |   ];
332 | 
333 |   const clicked = await page.evaluate(
334 |     (outer, labelsArr) => {
335 |       const norm = (s) =>
336 |         String(s || "")
337 |           .replace(/\u00a0/g, " ")
338 |           .replace(/\s+/g, " ")
339 |           .trim()
340 |           .toLowerCase();
341 | 
342 |       const isVisible = (el) => {
343 |         if (!el) return false;
344 |         const r = el.getBoundingClientRect();
345 |         return r.width > 2 && r.height > 2;
346 |       };
347 | 
348 |       const nodes = Array.from(
349 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
350 |       ).filter(isVisible);
351 | 
352 |       for (const el of nodes) {
353 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
354 |         if (!t) continue;
355 |         if (labelsArr.some((x) => t.includes(x))) {
356 |           try {
357 |             el.scrollIntoView({ block: "center" });
358 |           } catch {}
359 |           const clickable =
360 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
361 |           try {
362 |             clickable.click();
363 |             return true;
364 |           } catch {}
365 |         }
366 |       }
367 |       return false;
368 |     },
369 |     outerHandle,
370 |     labels
371 |   );
372 | 
373 |   return !!clicked;
374 | }
375 | 
376 | async function getAnchorsCount(page, outerHandle) {
377 |   if (!outerHandle) return 0;
378 |   return page
379 |     .evaluate((outer) => {
380 |       const as = Array.from(
381 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
382 |       );
383 |       const ids = new Set();
384 |       for (const a of as) {
385 |         try {
386 |           const u = new URL(a.href, location.origin);
387 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
388 |           if (id) ids.add(id);
389 |         } catch {}
390 |       }
391 |       return ids.size;
392 |     }, outerHandle)
393 |     .catch(() => 0);
394 | }
395 | 
396 | async function getCommentRootsCount(page, outerHandle) {
397 |   if (!outerHandle) return 0;
398 |   return page
399 |     .evaluate((outer) => {
400 |       const as = Array.from(
401 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
402 |       );
403 |       const roots = new Set();
404 |       for (const a of as) {
405 |         const root = a.closest?.("[role='article']") || a.closest?.("div");
406 |         if (root) roots.add(root);
407 |       }
408 |       return roots.size;
409 |     }, outerHandle)
410 |     .catch(() => 0);
411 | }
412 | 
413 | /* ============================================================
414 |    ============================ API ============================
415 |    ============================================================ */
416 | 
417 | export async function prepare(page, url) {
418 |   log.dev("UI:watch", `Prepare: ${url}`);
419 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
420 |   if (!ok) throw new Error("safeGoto-failed");
421 | 
422 |   await acceptCookies(page, "watch-initial");
423 | 
424 |   const currentUrl = page.url();
425 |   if (currentUrl.includes("/login")) {
426 |     log.dev("UI:watch", "Login wymagany...");
427 |     await fbLogin(page);
428 |     await sleepRandom(3000, 4500);
429 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
430 |     log.dev("UI:watch", `Sesja po login: ${loggedAfterLogin ? "OK" : "BRAK"}`);
431 |     if (loggedAfterLogin) {
432 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
433 |       await acceptCookies(page, "watch-post-login");
434 |     } else {
435 |       log.dev("UI:watch", "Login failed ‚Äì kontynuujƒô bez sesji");
436 |     }
437 |   } else {
438 |     const logged = await checkIfLogged(page).catch(() => false);
439 |     if (!logged) {
440 |       log.dev("UI:watch", "Brak sesji ‚Äì fbLogin()");
441 |       await fbLogin(page);
442 |       await sleepRandom(3000, 4500);
443 |       await acceptCookies(page, "watch-after-login");
444 |       const logged2 = await checkIfLogged(page).catch(() => false);
445 |       log.dev("UI:watch", `Sesja po login: ${logged2 ? "OK" : "BRAK"}`);
446 |     }
447 |   }
448 | 
449 |   try {
450 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
451 |     if (loggedFinal) await saveCookies(page);
452 |   } catch {}
453 | 
454 |   await acceptCookies(page, "watch");
455 | 
456 |   try {
457 |     await page.evaluate(() => {
458 |       const vids = Array.from(document.querySelectorAll("video"));
459 |       for (const v of vids) {
460 |         try {
461 |           v.autoplay = false;
462 |           v.removeAttribute("autoplay");
463 |           v.muted = true;
464 |           v.pause();
465 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
466 |         } catch {}
467 |       }
468 |     });
469 |     log.debug("UI:watch", "Wideo wstrzymane");
470 |   } catch (e) {
471 |     log.debug("UI:watch", `B≈ÇƒÖd wstrzymania wideo: ${e?.message || e}`);
472 |   }
473 | 
474 |   if (DEBUG_WATCH) {
475 |     await safeShot(page, "watch-prepare.png");
476 |   }
477 | }
478 | 
479 | export async function getCommentCount(page, url) {
480 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
481 | 
482 |   const parsedFromUiRaw = uiInfo?.raw ? parseBestCommentsCountFromBlob(uiInfo.raw) : null;
483 | 
484 |   let parsedFromOuter = null;
485 |   const outer = await findCommentsOuter(page).catch(() => null);
486 |   if (outer) {
487 |     parsedFromOuter = await page
488 |       .evaluate((o) => (o.innerText || "").replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim(), outer)
489 |       .then((txt) => parseBestCommentsCountFromBlob(txt))
490 |       .catch(() => null);
491 |   }
492 | 
493 |   const uiDirect =
494 |     uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0 ? uiInfo.comments : null;
495 | 
496 |   const totalComments = pickBestCount([parsedFromOuter, parsedFromUiRaw, uiDirect]);
497 | 
498 |   log.debug("UI:watch", "Count sources", {
499 |     ui_source: uiInfo?.source || null,
500 |     ui_viewType: uiInfo?.viewType || null,
501 |     ui_comments: uiDirect,
502 |     parsedFromUiRaw,
503 |     parsedFromOuter,
504 |     picked: totalComments,
505 |   });
506 | 
507 |   let final = totalComments;
508 | 
509 |   log.dev("UI:watch", `Liczba komentarzy: ${final ?? "brak danych"}`);
510 |   return final;
511 | }
512 | 
513 | export async function loadAllComments(page, { expectedTotal } = {}) {
514 |   log.dev("UI:watch", "≈Åadujƒô komentarze...");
515 | 
516 |   let maxCycles = 40;
517 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
518 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
519 |   }
520 |   log.debug("UI:watch", `maxCycles=${maxCycles}`);
521 | 
522 |   const outer = await findCommentsOuter(page);
523 |   if (!outer) {
524 |     log.debug("UI:watch", "OUTER NOT FOUND");
525 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
526 |     return;
527 |   }
528 | 
529 |   if (DEBUG_WATCH) {
530 |     const stats = await debugOuterStats(page, outer);
531 |     log.debug("UI:watch", "OUTER stats", stats);
532 |     await shotElement(page, outer, "watch-outer.png");
533 |   }
534 | 
535 |   const scroller = await findScrollableInOuter(page, outer);
536 | 
537 |   if (DEBUG_WATCH) {
538 |     if (scroller) {
539 |       const sstats = await debugScrollerStats(page, scroller);
540 |       log.debug("UI:watch", "SCROLLER stats", sstats);
541 |       await shotElement(page, scroller, "watch-scroller.png");
542 |     } else {
543 |       log.debug("UI:watch", "SCROLLER NOT FOUND -> window scroll fallback");
544 |       await safeShot(page, "watch-no-scroller.png");
545 |     }
546 |   }
547 | 
548 |   let prevAnchors = await getAnchorsCount(page, outer);
549 |   let prevRoots = await getCommentRootsCount(page, outer);
550 |   let noProgress = 0;
551 | 
552 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
553 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
554 | 
555 |     let wheeled = false;
556 |     let beforeST = 0;
557 |     let afterST = 0;
558 | 
559 |     if (scroller) {
560 |       try {
561 |         beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
562 |       } catch {}
563 | 
564 |       try {
565 |         const box = await scroller.boundingBox();
566 |         if (box && box.width > 5 && box.height > 5) {
567 |           await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
568 |           await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
569 |           wheeled = true;
570 |         }
571 |       } catch {}
572 | 
573 |       await sleepRandom(450, 850);
574 | 
575 |       try {
576 |         afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
577 |       } catch {}
578 |     } else {
579 |       try {
580 |         beforeST = await page.evaluate(() => {
581 |           const el = document.scrollingElement || document.documentElement;
582 |           return el ? el.scrollTop || 0 : 0;
583 |         });
584 |       } catch {}
585 |       try {
586 |         await page.mouse.wheel({ deltaY: 900 });
587 |         wheeled = true;
588 |       } catch {}
589 |       await sleepRandom(450, 850);
590 |       try {
591 |         afterST = await page.evaluate(() => {
592 |           const el = document.scrollingElement || document.documentElement;
593 |           return el ? el.scrollTop || 0 : 0;
594 |         });
595 |       } catch {}
596 |     }
597 | 
598 |     const curAnchors = await getAnchorsCount(page, outer);
599 |     const curRoots = await getCommentRootsCount(page, outer);
600 | 
601 |     const progressed = curAnchors > prevAnchors || curRoots > prevRoots;
602 | 
603 |     if (progressed) {
604 |       prevAnchors = curAnchors;
605 |       prevRoots = curRoots;
606 |       noProgress = 0;
607 |     } else {
608 |       noProgress++;
609 |     }
610 | 
611 |     if (cycle === 1 || cycle % 10 === 0) {
612 |       log.debug("UI:watch", `cycle ${cycle}/${maxCycles}: anchors=${curAnchors}, roots=${curRoots}, np=${noProgress}`);
613 |     }
614 | 
615 |     if (DEBUG_WATCH && cycle === 5) {
616 |       await safeShot(page, "watch-after-5.png");
617 |     }
618 | 
619 |     if (noProgress >= 8) {
620 |       log.debug("UI:watch", "Brak postƒôpu ‚Äì przerywam");
621 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
622 |       break;
623 |     }
624 |   }
625 | 
626 |   log.dev("UI:watch", "Komentarze za≈Çadowane");
627 | }
628 | 
629 | export async function extractComments(page, url) {
630 |   const outer = await findCommentsOuter(page).catch(() => null);
631 |   if (!outer) {
632 |     log.debug("UI:watch", "extractComments: OUTER NOT FOUND");
633 |     if (DEBUG_WATCH) await safeShot(page, "watch-extract-no-outer.png");
634 |     return [];
635 |   }
636 | 
637 |   const comments = await page.evaluate((outerEl) => {
638 |     function norm(s) {
639 |       return String(s || "")
640 |         .replace(/\u00a0/g, " ")
641 |         .replace(/\s+/g, " ")
642 |         .trim();
643 |     }
644 | 
645 |     function toAbsHref(href) {
646 |       if (!href) return null;
647 |       if (href.startsWith("http")) return href;
648 |       if (href.startsWith("/")) return `${location.origin}${href}`;
649 |       return href;
650 |     }
651 | 
652 |     function getCommentId(href) {
653 |       try {
654 |         const u = new URL(href, location.origin);
655 |         return u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
656 |       } catch {
657 |         return null;
658 |       }
659 |     }
660 | 
661 |     function normalizeTime(text) {
662 |       if (!text) return null;
663 | 
664 |       const t = norm(text).toLowerCase();
665 |       if (!t) return null;
666 | 
667 |       if (t.includes("przed chwilƒÖ")) return "0 min";
668 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
669 |       if (t.includes("wczoraj") || t.includes("yesterday")) return "wczoraj";
670 | 
671 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
672 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô)\b/.test(t)) return t;
673 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
674 |       if (/^\d+\s*(dzie≈Ñ|dni|d)\b/.test(t)) return t;
675 |       if (/^\d+\s*(tyg|tyg\.|week|weeks)\b/.test(t)) return t;
676 | 
677 |       return null;
678 |     }
679 | 
680 |     function findTimeInRoot(root) {
681 |       if (!root) return null;
682 | 
683 |       const els = Array.from(root.querySelectorAll("abbr, a, span")).slice(0, 250);
684 |       for (const el of els) {
685 |         const aria = el.getAttribute?.("aria-label");
686 |         const t1 = normalizeTime(aria);
687 |         if (t1) return t1;
688 | 
689 |         const title = el.getAttribute?.("title");
690 |         const t2 = normalizeTime(title);
691 |         if (t2) return t2;
692 | 
693 |         const txt = el.textContent;
694 |         const t3 = normalizeTime(txt);
695 |         if (t3) return t3;
696 |       }
697 |       return null;
698 |     }
699 | 
700 |     const anchors = Array.from(
701 |       outerEl.querySelectorAll("a[href*='comment_id='], a[href*='reply_comment_id=']")
702 |     );
703 | 
704 |     const seenRoots = new Set();
705 |     const out = [];
706 | 
707 |     for (const a of anchors) {
708 |       const href = a.getAttribute("href") || a.href || null;
709 |       const absHref = toAbsHref(href);
710 | 
711 |       const id = absHref ? getCommentId(absHref) : null;
712 |       if (!id) continue;
713 | 
714 |       const root = a.closest?.("[role='article']") || a.closest?.("div") || null;
715 |       if (!root) continue;
716 |       if (seenRoots.has(root)) continue;
717 |       seenRoots.add(root);
718 | 
719 |       const author =
720 |         norm(root.querySelector("a[role='link'] span")?.textContent) ||
721 |         norm(root.querySelector("strong")?.textContent) ||
722 |         null;
723 | 
724 |       const autos = Array.from(root.querySelectorAll("[dir='auto']"))
725 |         .map((el) => norm(el.textContent))
726 |         .filter(Boolean);
727 | 
728 |       let text = "";
729 |       if (autos.length) text = autos[autos.length - 1];
730 | 
731 |       const time = findTimeInRoot(root);
732 | 
733 |       if (!author && !text) continue;
734 | 
735 |       out.push({
736 |         id,
737 |         author,
738 |         text,
739 |         permalink: absHref,
740 |         time: time || null,
741 |       });
742 |     }
743 | 
744 |     return out;
745 |   }, outer);
746 | 
747 |   log.debug("UI:watch", `Wyekstrahowano ${comments.length} komentarzy`);
748 |   return comments;
749 | }
750 | 
751 | export async function debugSnapshot(page) {
752 |   try {
753 |     const path = `snapshot-watch.png`;
754 |     await page.screenshot({ path });
755 |     log.debug("UI:watch", `Zapisano zrzut: ${path}`);
756 |   } catch (e) {
757 |     log.error("UI:watch", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
758 |   }
759 | }
760 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/uiCommentInfo.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  

```js
  1 | // src/fb/uiCommentInfo.js
  2 | // UI: wykrywanie typu widoku + wyciƒÖganie liczby komentarzy z meta-linii (reakcje | komentarze | udostƒôpnienia)
  3 | // FIX: photo view -> meta row + filtr sklejonych liczb typu "287368".
  4 | // VIDEO/WATCH: komentarze czƒôsto sƒÖ jako: [LICZBA] + [IKONKA], bez tekstu "Komentarz" -> bierzemy z button√≥w z ikonkƒÖ.
  5 | 
  6 | export async function getUiCommentInfo(page) {
  7 |   return page.evaluate(() => {
  8 |     function norm(str) {
  9 |       if (!str) return "";
 10 |       return String(str).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
 11 |     }
 12 | 
 13 |     function detectViewType() {
 14 |       const href = location.href || "";
 15 |       const isWatch = href.includes("/watch");
 16 |       const isVideo = isWatch || /\/videos\/|[?&]v=/i.test(href);
 17 |       const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(href);
 18 | 
 19 |       if (isWatch) return "watch";
 20 |       if (isVideo) return "video";
 21 |       if (isPhoto) return "photo";
 22 |       return "permalink";
 23 |     }
 24 | 
 25 |     function isVisibleRough(el) {
 26 |       if (!el) return false;
 27 |       const st = window.getComputedStyle(el);
 28 |       if (!st) return true;
 29 |       if (st.display === "none" || st.visibility === "hidden") return false;
 30 |       return true;
 31 |     }
 32 | 
 33 |     // pojedynczy token liczbowy (np. "286", "7,8 tys.") ‚Äì odrzuca wieloliczbowe i "x z y"
 34 |     function parseSingleCount(str) {
 35 |       const s = norm(str).toLowerCase();
 36 |       if (!s) return null;
 37 | 
 38 |       // odrzuƒá "x z y"
 39 |       if (/\b\d+\s*z\s*\d+\b/i.test(s)) return null;
 40 | 
 41 |       // je≈õli sƒÖ >=2 grupy cyfr -> odrzucamy (ubija "7,8", "286 368", "1 234")
 42 |       const groups = s.match(/\d+/g);
 43 |       if (groups && groups.length > 1) return null;
 44 | 
 45 |       const m = s.match(/^(\d[\d.,]*)\s*(k|tys|ty≈õ|mln|m)?$/i);
 46 |       if (!m) return null;
 47 | 
 48 |       const raw = m[1];
 49 |       const suf = (m[2] || "").toLowerCase();
 50 | 
 51 |       let value = parseInt(raw.replace(/[^\d]/g, ""), 10);
 52 |       if (!Number.isFinite(value)) return null;
 53 | 
 54 |       if (suf === "k" || suf === "tys" || suf === "ty≈õ") value *= 1000;
 55 |       else if (suf === "mln" || suf === "m") value *= 1000000;
 56 | 
 57 |       return Math.round(value);
 58 |     }
 59 | 
 60 |     function findActionBarRoot() {
 61 |       const candidates = Array.from(document.querySelectorAll("div, section, footer"))
 62 |         .filter(isVisibleRough)
 63 |         .slice(0, 12000);
 64 | 
 65 |       for (const el of candidates) {
 66 |         const t = norm(el.innerText).toLowerCase();
 67 |         if (!t) continue;
 68 | 
 69 |         const hasLike = t.includes("lubiƒô to") || t.includes("like");
 70 |         const hasComment = t.includes("komentarz") || t.includes("comment");
 71 |         const hasShare = t.includes("udostƒôpnij") || t.includes("share");
 72 | 
 73 |         if (hasLike && hasComment && hasShare) {
 74 |           if (t.length > 2200) continue;
 75 |           return el;
 76 |         }
 77 |       }
 78 |       return null;
 79 |     }
 80 | 
 81 |     // usuwa tokeny typu "287368", je≈õli w tym samym zbiorze istniejƒÖ "287" i "368"
 82 |     function dropConcatenations(list) {
 83 |       const strSet = new Set(list.map((x) => String(x.v)));
 84 | 
 85 |       function isConcatOfTwoExisting(vStr) {
 86 |         if (vStr.length < 5) return false;
 87 |         for (let i = 1; i < vStr.length; i++) {
 88 |           const left = vStr.slice(0, i);
 89 |           const right = vStr.slice(i);
 90 |           if (left.length < 2 || right.length < 2) continue;
 91 |           if (strSet.has(left) && strSet.has(right)) return true;
 92 |         }
 93 |         return false;
 94 |       }
 95 | 
 96 |       const out = [];
 97 |       for (const x of list) {
 98 |         const vStr = String(x.v);
 99 |         if (isConcatOfTwoExisting(vStr)) continue;
100 |         out.push(x);
101 |       }
102 |       return out;
103 |     }
104 | 
105 |     function extractFromMetaRow(actionRoot) {
106 |       if (!actionRoot) return { comments: null, shares: null, raw: null };
107 | 
108 |       const badWords = [
109 |         "odpowiedz",
110 |         "wy≈õwietl",
111 |         "zobacz",
112 |         "najtrafniejsze",
113 |         "najnowsze",
114 |         "lider",
115 |         "edytowano",
116 |       ];
117 | 
118 |       const divs = Array.from(actionRoot.querySelectorAll("div"))
119 |         .filter(isVisibleRough)
120 |         .slice(0, 6000);
121 | 
122 |       const scored = [];
123 | 
124 |       for (const d of divs) {
125 |         const text = norm(d.innerText);
126 |         if (!text) continue;
127 | 
128 |         const low = text.toLowerCase();
129 |         const hasReactions = low.includes("wszystkie reakcje") || low.includes("all reactions");
130 |         if (!hasReactions) continue;
131 | 
132 |         if (low.length > 260) continue;
133 |         if (badWords.some((w) => low.includes(w))) continue;
134 | 
135 |         const atoms = Array.from(d.querySelectorAll("span, a, div"))
136 |           .filter(isVisibleRough)
137 |           .map((el) => norm(el.textContent))
138 |           .filter((s) => s && s.length <= 20);
139 | 
140 |         let nums = [];
141 |         for (const s of atoms) {
142 |           const v = parseSingleCount(s);
143 |           if (v == null) continue;
144 |           nums.push({ v, s });
145 |         }
146 | 
147 |         const seen = new Set();
148 |         let uniq = [];
149 |         for (const n of nums) {
150 |           const key = `${n.v}:${n.s}`;
151 |           if (seen.has(key)) continue;
152 |           seen.add(key);
153 |           uniq.push(n);
154 |         }
155 | 
156 |         uniq = dropConcatenations(uniq);
157 | 
158 |         if (uniq.length < 2) continue;
159 | 
160 |         let score = 0;
161 |         score += uniq.length === 2 ? 300 : 0;
162 |         score += Math.max(0, 260 - low.length);
163 | 
164 |         scored.push({ uniq, score, lowLen: low.length });
165 |       }
166 | 
167 |       scored.sort((a, b) => b.score - a.score);
168 |       const best = scored[0];
169 |       if (!best) return { comments: null, shares: null, raw: null };
170 | 
171 |       const comments = best.uniq[0]?.v ?? null;
172 |       const shares = best.uniq[1]?.v ?? null;
173 | 
174 |       const raw = `metaRow len=${best.lowLen} nums=${best.uniq
175 |         .map((x) => `${x.v}:${x.s}`)
176 |         .join(" | ")} -> comments=${comments} shares=${shares}`;
177 | 
178 |       return { comments, shares, raw };
179 |     }
180 | 
181 |     // VIDEO/WATCH: wyciƒÖgnij komentarze z przycisku "liczba + ikonka"
182 |     function extractVideoCommentsFromIconButtons() {
183 |       const btns = Array.from(document.querySelectorAll('[role="button"][tabindex="0"]'))
184 |         .filter(isVisibleRough)
185 |         .slice(0, 12000);
186 | 
187 |       function hasSuffixToken(t) {
188 |         const s = norm(t).toLowerCase();
189 |         return /\b(tys|ty≈õ|k|mln|m)\b/.test(s);
190 |       }
191 | 
192 |       const candidates = [];
193 | 
194 |       for (const b of btns) {
195 |         // wariant 1: ikona jako <i data-visualcompletion="css-img">
196 |         const iconI = b.querySelector('i[data-visualcompletion="css-img"]');
197 |         // wariant 2 (na przysz≈Ço≈õƒá): ikona jako svg
198 |         const iconSvg = b.querySelector("svg");
199 | 
200 |         if (!iconI && !iconSvg) continue;
201 | 
202 |         const toks = Array.from(b.querySelectorAll("span, a, div"))
203 |           .filter(isVisibleRough)
204 |           .map((el) => norm(el.textContent))
205 |           .filter((t) => t && t.length <= 20);
206 | 
207 |         if (!toks.length) continue;
208 | 
209 |         // odetnij tys/mln (np. 496 tys.)
210 |         if (toks.some(hasSuffixToken)) continue;
211 | 
212 |         // szukamy czystej liczby (np. 127)
213 |         let value = null;
214 |         let rawToken = null;
215 | 
216 |         for (const t of toks) {
217 |           if (!/^\d[\d.,]*$/.test(t)) continue;
218 |           const v = parseSingleCount(t);
219 |           if (v == null) continue;
220 |           value = v;
221 |           rawToken = t;
222 |           break;
223 |         }
224 | 
225 |         if (value == null) continue;
226 | 
227 |         const aria =
228 |           norm(b.getAttribute("aria-label")) +
229 |           " " +
230 |           norm((iconI && iconI.getAttribute && iconI.getAttribute("aria-label")) || "");
231 | 
232 |         const lowAria = aria.toLowerCase();
233 | 
234 |         let score = 0;
235 | 
236 |         // je≈õli gdziekolwiek pada "komentarz/comment" -> z≈Çoto
237 |         if (/\b(comment|comments|komentarz|komentarze)\b/.test(lowAria)) score += 120;
238 | 
239 |         // komentarze raczej nie sƒÖ mikro (1..9) w takim przycisku
240 |         if (value <= 9) score -= 60;
241 | 
242 |         // komentarze czƒôsto sƒÖ 10..5000+ -> lekka premia
243 |         if (value >= 10 && value <= 500000) score += 20;
244 | 
245 |         candidates.push({
246 |           value,
247 |           score,
248 |           raw: `iconBtn token=${rawToken} toks=${toks.join(" | ")} aria=${aria}`.slice(0, 500),
249 |         });
250 |       }
251 | 
252 |       if (!candidates.length) {
253 |         return { comments: null, raw: "videoIconButtons: not-found" };
254 |       }
255 | 
256 |       candidates.sort((a, b) => b.score - a.score || b.value - a.value);
257 |       const best = candidates[0];
258 | 
259 |       return {
260 |         comments: best.value,
261 |         raw: `videoIconButtons best=${best.value} score=${best.score} ${best.raw}`,
262 |       };
263 |     }
264 | 
265 |     // VIDEO/WATCH: fallback ‚Äì pr√≥ba klasycznego "near labels" (u Ciebie)
266 |     function extractNearLabels(actionRoot) {
267 |       const LIKE_WORDS = ["lubiƒô to", "like"];
268 |       const COMMENT_WORDS = ["komentarz", "comment"];
269 |       const SHARE_WORDS = ["udostƒôpnij", "share"];
270 | 
271 |       function hasAny(low, arr) {
272 |         return arr.some((w) => low.includes(w));
273 |       }
274 | 
275 |       function getNodeLabel(el) {
276 |         if (!el) return "";
277 |         const a = norm(el.getAttribute?.("aria-label"));
278 |         if (a) return a;
279 |         return norm(el.textContent);
280 |       }
281 | 
282 |       function findActionRowContainer(startEl) {
283 |         let cur = startEl;
284 |         for (let up = 0; up < 8 && cur; up++) {
285 |           const t = norm(cur.innerText).toLowerCase();
286 |           if (
287 |             t &&
288 |             hasAny(t, LIKE_WORDS) &&
289 |             hasAny(t, COMMENT_WORDS) &&
290 |             hasAny(t, SHARE_WORDS)
291 |           ) {
292 |             return cur;
293 |           }
294 |           cur = cur.parentElement;
295 |         }
296 |         return null;
297 |       }
298 | 
299 |       const scope = document.body;
300 | 
301 |       const clickable = Array.from(scope.querySelectorAll('[role="button"], a, span, div'))
302 |         .filter(isVisibleRough)
303 |         .slice(0, 20000);
304 | 
305 |       const commentNodes = [];
306 |       for (const el of clickable) {
307 |         const low = getNodeLabel(el).toLowerCase();
308 |         if (!low) continue;
309 |         if (hasAny(low, COMMENT_WORDS)) commentNodes.push(el);
310 |       }
311 | 
312 |       const scored = [];
313 |       for (const cn of commentNodes) {
314 |         const row = findActionRowContainer(cn);
315 |         if (!row) continue;
316 | 
317 |         const rowText = norm(row.innerText).toLowerCase();
318 |         if (!rowText) continue;
319 | 
320 |         if (rowText.includes("wszystkie reakcje") || rowText.includes("all reactions")) continue;
321 | 
322 |         const parts = Array.from(row.querySelectorAll("span, a, div, [role='button']"))
323 |           .filter(isVisibleRough)
324 |           .map((n) => getNodeLabel(n))
325 |           .map((s) => norm(s))
326 |           .filter((s) => s && s.length <= 40);
327 | 
328 |         const anyNum = parts.some((s) => parseSingleCount(s) != null);
329 |         if (!anyNum) continue;
330 | 
331 |         let score = 0;
332 |         score += Math.max(0, 600 - rowText.length);
333 |         score += Math.max(0, 120 - parts.length);
334 | 
335 |         scored.push({ row, parts, rowLen: rowText.length, score });
336 |       }
337 | 
338 |       scored.sort((a, b) => b.score - a.score);
339 |       const best = scored[0];
340 | 
341 |       if (!best) {
342 |         return { comments: null, shares: null, raw: "nearLabels: no-action-row-found" };
343 |       }
344 | 
345 |       const tokensLow = best.parts.map((s) => s.toLowerCase());
346 | 
347 |       const idxLike = tokensLow.findIndex((t) => hasAny(t, LIKE_WORDS));
348 |       const idxComment = tokensLow.findIndex((t) => hasAny(t, COMMENT_WORDS));
349 |       const idxShare = tokensLow.findIndex((t) => hasAny(t, SHARE_WORDS));
350 | 
351 |       function scanLeftForNumber(fromIdx) {
352 |         if (fromIdx == null || fromIdx < 0) return null;
353 |         for (let i = fromIdx - 1; i >= 0 && i >= fromIdx - 14; i--) {
354 |           const v = parseSingleCount(best.parts[i]);
355 |           if (v != null) return { v, at: i, token: best.parts[i] };
356 |         }
357 |         return null;
358 |       }
359 | 
360 |       let cPick = scanLeftForNumber(idxComment);
361 |       if (!cPick) cPick = scanLeftForNumber(idxLike);
362 | 
363 |       let sPick = scanLeftForNumber(idxShare);
364 |       if (cPick && sPick && sPick.v === cPick.v) sPick = null;
365 | 
366 |       const raw = `nearLabels[actionRow] len=${best.rowLen} tokens=${best.parts.join(
367 |         " | "
368 |       )} -> idxLike=${idxLike} idxComment=${idxComment} idxShare=${idxShare} | comments=${
369 |         cPick ? `${cPick.v}(${cPick.token})@${cPick.at}` : "null"
370 |       } | shares=${sPick ? `${sPick.v}(${sPick.token})@${sPick.at}` : "null"}`;
371 | 
372 |       return {
373 |         comments: cPick ? cPick.v : null,
374 |         shares: sPick ? sPick.v : null,
375 |         raw,
376 |       };
377 |     }
378 | 
379 |     const viewType = detectViewType();
380 |     const actionRoot = findActionBarRoot();
381 | 
382 |     let meta;
383 | 
384 |     if (viewType === "video" || viewType === "watch") {
385 |       // 1) pr√≥buj najpierw ikonki (to jest Tw√≥j przypadek z 127 / 496 tys.)
386 |       meta = extractVideoCommentsFromIconButtons();
387 | 
388 |       // 2) fallback: near labels (jak w Twoim kodzie)
389 |       if (meta.comments == null) {
390 |         const near = extractNearLabels(actionRoot);
391 |         meta = { comments: near.comments, raw: near.raw };
392 |       }
393 |     } else {
394 |       // photo/permalink stabilne -> nie ruszamy
395 |       meta = extractFromMetaRow(actionRoot);
396 |     }
397 | 
398 |     return {
399 |       source: `ui-${viewType}`,
400 |       viewType,
401 |       comments: meta.comments,
402 |       raw: meta.raw,
403 |     };
404 |   });
405 | }
406 | 
```

---

### üìÑ ≈öcie≈ºka: `src/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | if (process.env.__WATCHER_LOCKED__) {
 2 |   console.error("WATCHER DUPLICATE START ‚Äî EXIT");
 3 |   process.exit(1);
 4 | }
 5 | process.env.__WATCHER_LOCKED__ = "1";
 6 | 
 7 | const __log = console.log;
 8 | console.log = (...args) => {
 9 |   const ts = new Date().toISOString().replace("T"," ").replace("Z","");
10 |   __log(`[${ts}]`, ...args);
11 | };
12 | 
13 | // src/index.js
14 | import "dotenv/config";
15 | import fs from "fs";
16 | import path from "path";
17 | import { startWatcher } from "./watcher.js";
18 | import { sendOwnerAlert } from "./telegram.js";
19 | 
20 | function ensureDir(p) {
21 |   try {
22 |     fs.mkdirSync(p, { recursive: true });
23 |   } catch {}
24 | }
25 | 
26 | // Ustal katalogi serwerowe (≈ºeby nie wali≈Ço w /tmp losowo)
27 | const DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), "data");
28 | const TMP_DIR = process.env.TMP_DIR || path.join(process.cwd(), "tmp");
29 | ensureDir(DATA_DIR);
30 | ensureDir(TMP_DIR);
31 | 
32 | // czas + logi
33 | console.log("[BOOT] NODE_ENV =", process.env.NODE_ENV || "dev");
34 | console.log("[BOOT] TZ =", process.env.TZ || "system");
35 | console.log("[BOOT] DATA_DIR =", DATA_DIR);
36 | console.log("[BOOT] TMP_DIR =", TMP_DIR);
37 | console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);
38 | 
39 | // helper
40 | function safeToString(x) {
41 |   try {
42 |     if (x instanceof Error) return `${x.message}\n${x.stack || ""}`;
43 |     if (typeof x === "string") return x;
44 |     return JSON.stringify(x, null, 2);
45 |   } catch {
46 |     return String(x);
47 |   }
48 | }
49 | 
50 | // anti-loop
51 | let _inAlert = false;
52 | function fireAlert(title, message) {
53 |   if (_inAlert) return;
54 |   _inAlert = true;
55 |   sendOwnerAlert(title, message).catch(() => {}).finally(() => (_inAlert = false));
56 | }
57 | 
58 | // HOOKI na b≈Çƒôdy (muszƒÖ byƒá przed startWatcher)
59 | const _origErr = console.error.bind(console);
60 | console.error = (...args) => {
61 |   _origErr(...args);
62 |   fireAlert("console.error", args.map(safeToString).join(" "));
63 | };
64 | 
65 | process.on("unhandledRejection", (reason) => {
66 |   _origErr("[unhandledRejection]", reason);
67 |   fireAlert("unhandledRejection", safeToString(reason));
68 | });
69 | 
70 | process.on("uncaughtException", (err) => {
71 |   _origErr("[uncaughtException]", err);
72 |   fireAlert("uncaughtException", safeToString(err));
73 |   // Daj czas na wys≈Çanie alertu, potem exit (PM2 zrestartuje)
74 |   setTimeout(() => process.exit(1), 3000);
75 | });
76 | 
77 | // ping ‚Äú≈ºyjƒô‚Äù
78 | sendOwnerAlert("ALERTS ONLINE", `FB_Watcher start: ${new Date().toISOString()}`)
79 |   .then(() => console.log("[ALERTS] startup ping sent"))
80 |   .catch(() => console.log("[ALERTS] startup ping failed (ignored)"));
81 | 
82 | startWatcher().catch((err) => {
83 |   console.error("Fatal error:", err);
84 |   process.exit(1);
85 | });
86 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/api.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
  1 | // panel/api.js
  2 | import http from "http";
  3 | import { exec } from "child_process";
  4 | import fs from "fs";
  5 | import path from "path";
  6 | import crypto from "crypto";
  7 | import dotenv from "dotenv";
  8 | 
  9 | // ---- BASE DIR (dev vs exe) ----
 10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 11 | 
 12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 15 | 
 16 | // UI: dev -> src/panel/ui, exe -> ./ui
 17 | const UI_DIR = process.pkg
 18 |   ? path.join(BASE_DIR, "ui")
 19 |   : path.join(BASE_DIR, "src", "panel", "ui");
 20 | 
 21 | // New React UI: dev -> src/panel/web/dist, exe -> ./web
 22 | const NEW_UI_DIR = process.pkg
 23 |   ? path.join(BASE_DIR, "web")
 24 |   : path.join(BASE_DIR, "src", "panel", "web", "dist");
 25 | 
 26 | const PORT = Number(process.env.PANEL_PORT || 3180);
 27 | const TOKEN = process.env.PANEL_TOKEN;
 28 | 
 29 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 30 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 31 | 
 32 | // ---- CACHE (performance) ----
 33 | let cachedProjectDir = null;
 34 | let cachedNodeVersion = null;
 35 | let cachedPm2Version = null;
 36 | let cachedLogPaths = null;
 37 | 
 38 | if (!TOKEN) {
 39 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 40 |   process.exit(1);
 41 | }
 42 | 
 43 | function auth(req, res) {
 44 |   const h = req.headers["authorization"] || "";
 45 |   if (h !== `Bearer ${TOKEN}`) {
 46 |     res.writeHead(401);
 47 |     res.end("Unauthorized");
 48 |     return false;
 49 |   }
 50 |   return true;
 51 | }
 52 | 
 53 | function json(res, obj, code = 200) {
 54 |   res.writeHead(code, { "Content-Type": "application/json" });
 55 |   res.end(JSON.stringify(obj, null, 2));
 56 | }
 57 | 
 58 | function sh(cmd) {
 59 |   return new Promise((resolve) => {
 60 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 61 |       resolve({
 62 |         ok: !err,
 63 |         stdout: (stdout || "").trim(),
 64 |         stderr: (stderr || "").trim(),
 65 |         code: err?.code ?? 0,
 66 |       });
 67 |     });
 68 |   });
 69 | }
 70 | 
 71 | 
 72 | async function getProjectDir() {
 73 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 74 |   if (cachedProjectDir) return cachedProjectDir;
 75 | 
 76 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 77 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 78 |   if (!m)
 79 |     throw new Error(
 80 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 81 |     );
 82 |   cachedProjectDir = m[1].trim();
 83 |   return cachedProjectDir;
 84 | }
 85 | 
 86 | function readBody(req) {
 87 |   return new Promise((resolve) => {
 88 |     let d = "";
 89 |     req.on("data", (c) => (d += c));
 90 |     req.on("end", () => resolve(d));
 91 |   });
 92 | }
 93 | 
 94 | function safeJsonParse(s) {
 95 |   try {
 96 |     return { ok: true, value: JSON.parse(s) };
 97 |   } catch (e) {
 98 |     return { ok: false, error: e?.message || "Invalid JSON" };
 99 |   }
100 | }
101 | 
102 | function ensureDir(p) {
103 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
104 | }
105 | 
106 | function atomicWriteFile(filePath, content) {
107 |   const dir = path.dirname(filePath);
108 |   ensureDir(dir);
109 | 
110 |   const tmp = path.join(
111 |     dir,
112 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
113 |   );
114 |   fs.writeFileSync(tmp, content, "utf8");
115 |   fs.renameSync(tmp, filePath);
116 | }
117 | 
118 | function normalizeUrl(u) {
119 |   if (!u) return "";
120 |   const x = String(u).trim();
121 |   if (!/^https?:\/\/.+/i.test(x)) return "";
122 |   return x;
123 | }
124 | 
125 | function normalizeOptionalUrl(u) {
126 |   if (!u) return "";
127 |   const x = String(u).trim();
128 |   if (x === "") return "";
129 |   if (!/^https?:\/\/.+/i.test(x)) return "";
130 |   return x;
131 | }
132 | 
133 | function nowIso() {
134 |   return new Date().toISOString();
135 | }
136 | 
137 | function stripAnsi(str) {
138 |   return (str || "").replace(/\x1b\[[0-9;]*m/g, "");
139 | }
140 | 
141 | function setEnvKey(envText, key, value) {
142 |   const re = new RegExp(`^${key}=.*$`, "m");
143 |   const line = `${key}=${value}`;
144 |   if (re.test(envText)) return envText.replace(re, line);
145 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
146 | }
147 | 
148 | function pickPostsFile(projectDir) {
149 |   return path.join(projectDir, "data", "posts.json");
150 | }
151 | 
152 | function readPosts(postsPath) {
153 |   if (!fs.existsSync(postsPath)) return [];
154 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
155 |   if (!raw) return [];
156 |   const parsed = safeJsonParse(raw);
157 |   if (!parsed.ok || !Array.isArray(parsed.value))
158 |     throw new Error("posts.json invalid (expected array)");
159 |   return parsed.value;
160 | }
161 | 
162 | function writePosts(postsPath, posts) {
163 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
164 | }
165 | 
166 | function genId() {
167 |   return crypto.randomBytes(8).toString("hex");
168 | }
169 | 
170 | function route(req) {
171 |   const url = new URL(req.url, "http://localhost");
172 |   const pathname = url.pathname;
173 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
174 | }
175 | 
176 | function match(pathname, pattern) {
177 |   const a = pathname.split("/").filter(Boolean);
178 |   const b = pattern.split("/").filter(Boolean);
179 |   if (a.length !== b.length) return null;
180 |   const params = {};
181 |   for (let i = 0; i < a.length; i++) {
182 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
183 |     else if (a[i] !== b[i]) return null;
184 |   }
185 |   return params;
186 | }
187 | 
188 | // ---------- LOGS (dynamic from pm2 describe) ----------
189 | function parsePm2LogPaths(pm2DescribeText) {
190 |   const out =
191 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
192 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
193 |     "";
194 |   const err =
195 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
196 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
197 |     "";
198 |   return { out, err };
199 | }
200 | 
201 | async function getPm2LogPaths(appName) {
202 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
203 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
204 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
205 | 
206 |   if (cachedLogPaths) return cachedLogPaths;
207 | 
208 |   const d = await sh(`pm2 describe ${appName}`);
209 |   if (!d.ok)
210 |     return {
211 |       out: "",
212 |       err: "",
213 |       source: "pm2_error",
214 |       pm2: d.stderr || d.stdout || "",
215 |     };
216 | 
217 |   const p = parsePm2LogPaths(d.stdout);
218 |   cachedLogPaths = { out: p.out || "", err: p.err || "", source: "pm2_describe" };
219 |   return cachedLogPaths;
220 | }
221 | 
222 | async function readTailLog(filePath, lines) {
223 |   try {
224 |     if (!filePath) {
225 |       return {
226 |         ok: false,
227 |         error:
228 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
229 |         path: filePath,
230 |       };
231 |     }
232 | 
233 |     if (!fs.existsSync(filePath)) {
234 |       return {
235 |         ok: false,
236 |         error:
237 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
238 |         path: filePath,
239 |       };
240 |     }
241 | 
242 |     const st = fs.statSync(filePath);
243 |     if (!st || !st.isFile()) {
244 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
245 |     }
246 | 
247 |     if (st.size === 0) {
248 |       return {
249 |         ok: false,
250 |         error:
251 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
252 |         path: filePath,
253 |       };
254 |     }
255 | 
256 |     // Use tail command on Linux (fast, doesn't load entire file into memory)
257 |     const tailResult = await sh(`tail -n ${lines} "${filePath}"`);
258 |     if (tailResult.ok && tailResult.stdout) {
259 |       const txt = (tailResult.stdout || "").trim();
260 |       if (txt) {
261 |         return { ok: true, log: tailResult.stdout, path: filePath, via: "tail" };
262 |       }
263 |     }
264 | 
265 |     // Fallback: read last portion of file (max 512KB) for large files
266 |     const MAX_READ = 512 * 1024;
267 |     if (st.size > MAX_READ) {
268 |       const fd = fs.openSync(filePath, "r");
269 |       const buffer = Buffer.alloc(MAX_READ);
270 |       fs.readSync(fd, buffer, 0, MAX_READ, st.size - MAX_READ);
271 |       fs.closeSync(fd);
272 |       const raw = buffer.toString("utf8");
273 |       const arr = raw.split(/\r?\n/);
274 |       // Skip first line (might be partial)
275 |       const slice = arr.slice(Math.max(1, arr.length - lines)).join("\n");
276 |       const txt = (slice || "").trim();
277 |       if (txt) {
278 |         return { ok: true, log: slice, path: filePath, via: "partial" };
279 |       }
280 |     }
281 | 
282 |     // Small files: read entirely
283 |     const raw = fs.readFileSync(filePath, "utf8");
284 |     const arr = raw.split(/\r?\n/);
285 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
286 |     const txt = (slice || "").trim();
287 | 
288 |     if (!txt) {
289 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
290 |     }
291 | 
292 |     return { ok: true, log: slice, path: filePath, via: "js" };
293 |   } catch (e) {
294 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
295 |   }
296 | }
297 | 
298 | http
299 |   .createServer(async (req, res) => {
300 |     const { pathname, query } = route(req);
301 |     if (req.method === "GET" && pathname === "/ping") {
302 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
303 |   res.end("pong");
304 |   return;
305 | }
306 | 
307 | 
308 |     // ---------- NEW REACT UI (/new/) ----------
309 |     if (req.method === "GET" && pathname.startsWith("/new")) {
310 |       const MIME_TYPES = {
311 |         ".html": "text/html",
312 |         ".js": "application/javascript",
313 |         ".css": "text/css",
314 |         ".json": "application/json",
315 |         ".png": "image/png",
316 |         ".jpg": "image/jpeg",
317 |         ".svg": "image/svg+xml",
318 |         ".ico": "image/x-icon",
319 |         ".woff": "font/woff",
320 |         ".woff2": "font/woff2",
321 |       };
322 | 
323 |       // Remove /new prefix
324 |       let filePath = pathname.replace(/^\/new\/?/, "") || "index.html";
325 | 
326 |       // Try to serve the file
327 |       let fullPath = path.join(NEW_UI_DIR, filePath);
328 | 
329 |       // If file doesn't exist and it's not a static asset, serve index.html (SPA fallback)
330 |       if (!fs.existsSync(fullPath) || fs.statSync(fullPath).isDirectory()) {
331 |         const ext = path.extname(filePath);
332 |         if (!ext || ext === ".html") {
333 |           fullPath = path.join(NEW_UI_DIR, "index.html");
334 |         }
335 |       }
336 | 
337 |       if (fs.existsSync(fullPath) && fs.statSync(fullPath).isFile()) {
338 |         const ext = path.extname(fullPath);
339 |         const contentType = MIME_TYPES[ext] || "application/octet-stream";
340 |         const content = fs.readFileSync(fullPath);
341 |         res.writeHead(200, { "Content-Type": `${contentType}; charset=utf-8` });
342 |         res.end(content);
343 |         return;
344 |       }
345 |     }
346 | 
347 |     // ---------- PUBLIC UI (legacy) ----------
348 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
349 |       const p = path.join(UI_DIR, "index.html");
350 |       const html = fs.readFileSync(p, "utf8");
351 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
352 |       res.end(html);
353 |       return;
354 |     }
355 | 
356 |     if (req.method === "GET" && pathname === "/app.js") {
357 |       const p = path.join(UI_DIR, "app.js");
358 |       const js = fs.readFileSync(p, "utf8");
359 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
360 |       res.end(js);
361 |       return;
362 |     }
363 | 
364 |     // ---------- AUTH for API ----------
365 |     if (pathname.startsWith("/api/")) {
366 |       if (!auth(req, res)) return;
367 |     }
368 | 
369 |     try {
370 |       const PROJECT_DIR = await getProjectDir();
371 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
372 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
373 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
374 | 
375 |       // ===== STATUS =====
376 |       if (req.method === "GET" && pathname === "/api/status") {
377 |         // Cache node/pm2 versions (don't change during runtime)
378 |         if (!cachedNodeVersion) {
379 |           const node = await sh("node -v");
380 |           cachedNodeVersion = node.stdout;
381 |         }
382 |         if (!cachedPm2Version) {
383 |           const pm2v = await sh("pm2 -v");
384 |           cachedPm2Version = pm2v.stdout;
385 |         }
386 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
387 |         json(res, {
388 |           ok: true,
389 |           projectDir: PROJECT_DIR,
390 |           envPath: ENV_PATH,
391 |           cookiesPath: COOKIES_PATH,
392 |           postsPath: POSTS_PATH,
393 |           node: cachedNodeVersion,
394 |           pm2: cachedPm2Version,
395 |           pm2Status: stripAnsi(pm2s.stdout),
396 |           time: nowIso(),
397 |         });
398 |         return;
399 |       }
400 | 
401 |       // ===== ENV GET (selected keys) =====
402 |       if (req.method === "GET" && pathname === "/api/env/get") {
403 |         if (!fs.existsSync(ENV_PATH)) {
404 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
405 |           return;
406 |         }
407 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
408 |         const wanted = [
409 |           // Facebook
410 |           "FB_EMAIL",
411 |           "FB_PASSWORD",
412 |           // Watcher
413 |           "CHECK_INTERVAL_MS",
414 |           "FAST_MODE",
415 |           "INCLUDE_REPLIES",
416 |           // Logi
417 |           "LOG_LEVEL",
418 |           // Puppeteer
419 |           "HEADLESS_BROWSER",
420 |           "USE_UI_HANDLERS",
421 |           "COOKIES_READ_ONLY",
422 |           // ≈πr√≥d≈Ça post√≥w
423 |           "POSTS_SHEET_URL",
424 |           "POSTS_API_URL",
425 |           "POSTS_API_TOKEN",
426 |           // Telegram Owner
427 |           "TELEGRAM_SEND_TO_OWNER",
428 |           "TELEGRAM_BOT_TOKEN_OWNER",
429 |           "TELEGRAM_CHAT_ID_OWNER",
430 |           // Telegram Client
431 |           "TELEGRAM_SEND_TO_CLIENT",
432 |           "TELEGRAM_BOT_TOKEN_CLIENT",
433 |           "TELEGRAM_CHAT_ID_CLIENT",
434 |           // Telegram Format
435 |           "TELEGRAM_USE_PHOTO",
436 |           "TELEGRAM_DISABLE_WEB_PAGE_PREVIEW",
437 |           // Telegram Alerty
438 |           "TG_ALERTS_ENABLED",
439 |           "TG_ALERTS_COOLDOWN_SEC",
440 |           "TG_ALERTS_MAXLEN",
441 |           // Legacy
442 |           "WEBHOOK_URL",
443 |         ];
444 |         const values = {};
445 |         for (const k of wanted) {
446 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
447 |           values[k] = m ? m[1] : "";
448 |         }
449 |         json(res, { ok: true, values });
450 |         return;
451 |       }
452 | 
453 |       // ===== ENV SET MULTIPLE =====
454 |       if (req.method === "POST" && pathname === "/api/env/set") {
455 |         const bodyRaw = await readBody(req);
456 |         const parsed = safeJsonParse(bodyRaw || "{}");
457 |         if (!parsed.ok) {
458 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
459 |           return;
460 |         }
461 | 
462 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
463 |         const restart = Boolean(parsed.value.restart);
464 | 
465 |         if (!set) {
466 |           json(res, { ok: false, error: "Missing set object" }, 400);
467 |           return;
468 |         }
469 |         if (!fs.existsSync(ENV_PATH)) {
470 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
471 |           return;
472 |         }
473 | 
474 |         let env = fs.readFileSync(ENV_PATH, "utf8");
475 |         const updated = [];
476 | 
477 |         for (const [k, v] of Object.entries(set)) {
478 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
479 |           env = setEnvKey(env, k, String(v));
480 |           updated.push(k);
481 |         }
482 | 
483 |         atomicWriteFile(ENV_PATH, env);
484 | 
485 |         let pm2Action = null;
486 |         if (restart) {
487 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
488 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
489 |         }
490 | 
491 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
492 |         return;
493 |       }
494 | 
495 |       // ===== POSTS: LIST =====
496 |       if (req.method === "GET" && pathname === "/api/posts") {
497 |         const posts = readPosts(POSTS_PATH);
498 | 
499 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
500 |         const norm = (posts || []).map((p) => ({
501 |           id: String(p.id || "").trim(),
502 |           url: String(p.url || "").trim(),
503 |           active: p.active !== undefined ? Boolean(p.active) : true,
504 |           name: String(p.name || "").trim(),
505 |           image: String(p.image || "").trim(),
506 |           description: String(p.description || "").trim(),
507 |           createdAt: p.createdAt || "",
508 |           updatedAt: p.updatedAt || "",
509 |         }));
510 | 
511 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
512 |         json(res, { ok: true, posts: norm });
513 |         return;
514 |       }
515 | 
516 |       // ===== POSTS: ADD =====
517 |       if (req.method === "POST" && pathname === "/api/posts") {
518 |         const bodyRaw = await readBody(req);
519 |         const parsed = safeJsonParse(bodyRaw || "{}");
520 |         if (!parsed.ok) {
521 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
522 |           return;
523 |         }
524 | 
525 |         const url = normalizeUrl(parsed.value.url);
526 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
527 | 
528 |         const name = String(parsed.value.name || "").trim();
529 |         const imageRaw = String(parsed.value.image || "").trim();
530 |         const image = normalizeOptionalUrl(imageRaw);
531 |         const description = String(parsed.value.description || "").trim();
532 | 
533 |         if (!url) {
534 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
535 |           return;
536 |         }
537 |         if (imageRaw !== "" && !image) {
538 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
539 |           return;
540 |         }
541 | 
542 |         const posts = readPosts(POSTS_PATH);
543 |         const existing = posts.find((p) => p.url === url);
544 |         if (existing) {
545 |           existing.active = active;
546 |           existing.name = name;
547 |           existing.image = image;
548 |           existing.description = description;
549 |           existing.updatedAt = nowIso();
550 |           writePosts(POSTS_PATH, posts);
551 |           json(res, { ok: true, post: existing, deduped: true });
552 |           return;
553 |         }
554 | 
555 |         const post = {
556 |           id: genId(),
557 |           url,
558 |           active,
559 |           name,
560 |           image,
561 |           description,
562 |           createdAt: nowIso(),
563 |           updatedAt: nowIso(),
564 |         };
565 |         posts.push(post);
566 |         writePosts(POSTS_PATH, posts);
567 | 
568 |         json(res, { ok: true, post });
569 |         return;
570 |       }
571 | 
572 |       // ===== POSTS: PATCH =====
573 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
574 |       if (mPatch) {
575 |         const id = mPatch.id;
576 |         const bodyRaw = await readBody(req);
577 |         const parsed = safeJsonParse(bodyRaw || "{}");
578 |         if (!parsed.ok) {
579 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
580 |           return;
581 |         }
582 | 
583 |         const posts = readPosts(POSTS_PATH);
584 |         const post = posts.find((p) => p.id === id);
585 |         if (!post) {
586 |           json(res, { ok: false, error: "Post not found" }, 404);
587 |           return;
588 |         }
589 | 
590 |         if (parsed.value.url !== undefined) {
591 |           const nextUrl = normalizeUrl(parsed.value.url);
592 |           if (!nextUrl) {
593 |             json(res, { ok: false, error: "Invalid url" }, 400);
594 |             return;
595 |           }
596 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
597 |           if (dup) {
598 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
599 |             return;
600 |           }
601 |           post.url = nextUrl;
602 |         }
603 | 
604 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
605 | 
606 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
607 | 
608 |         if (parsed.value.image !== undefined) {
609 |           const raw = String(parsed.value.image || "").trim();
610 |           const img = normalizeOptionalUrl(raw);
611 |           if (raw !== "" && !img) {
612 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
613 |             return;
614 |           }
615 |           post.image = img;
616 |         }
617 | 
618 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
619 | 
620 |         post.updatedAt = nowIso();
621 |         writePosts(POSTS_PATH, posts);
622 |         json(res, { ok: true, post });
623 |         return;
624 |       }
625 | 
626 |       // ===== POSTS: DELETE =====
627 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
628 |       if (mDel) {
629 |         const id = mDel.id;
630 |         const posts = readPosts(POSTS_PATH);
631 |         const idx = posts.findIndex((p) => p.id === id);
632 |         if (idx === -1) {
633 |           json(res, { ok: false, error: "Post not found" }, 404);
634 |           return;
635 |         }
636 |         const removed = posts.splice(idx, 1)[0];
637 |         writePosts(POSTS_PATH, posts);
638 |         json(res, { ok: true, removed });
639 |         return;
640 |       }
641 | 
642 |       // ===== COOKIES: CLEAR =====
643 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
644 |         const bodyRaw = await readBody(req);
645 |         const parsed = safeJsonParse(bodyRaw || "{}");
646 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
647 | 
648 |         if (!confirm) {
649 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
650 |           return;
651 |         }
652 | 
653 |         atomicWriteFile(COOKIES_PATH, "[]\n");
654 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
655 |         return;
656 |       }
657 | 
658 |       // ===== PM2 =====
659 |       function okOrErr(r, fallbackErr = "Command failed") {
660 |         if (r.ok) return { ok: true, output: stripAnsi(r.stdout || r.stderr || "") };
661 |         return { ok: false, error: stripAnsi(r.stderr || r.stdout || fallbackErr) };
662 |       }
663 |       async function pm2Describe(name) {
664 |         return await sh(`pm2 describe ${name}`);
665 |       }
666 | 
667 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
668 |       const WATCH_NAME = PM2_APP || "fbwatcher";
669 | 
670 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
671 |         const d = await pm2Describe(WATCH_NAME);
672 |         if (d.ok) {
673 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
674 |           json(res, okOrErr(r, "PM2 start failed"));
675 |           return;
676 |         }
677 | 
678 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
679 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
680 |         return;
681 |       }
682 | 
683 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
684 |         const d = await pm2Describe(WATCH_NAME);
685 |         if (!d.ok) {
686 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
687 |           return;
688 |         }
689 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
690 |         json(res, okOrErr(r, "PM2 restart failed"));
691 |         return;
692 |       }
693 | 
694 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
695 |         const d = await pm2Describe(WATCH_NAME);
696 |         if (!d.ok) {
697 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
698 |           return;
699 |         }
700 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
701 |         json(res, okOrErr(r, "PM2 stop failed"));
702 |         return;
703 |       }
704 | 
705 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
706 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
707 |         json(res, okOrErr(r, "PM2 status failed"));
708 |         return;
709 |       }
710 | 
711 |       // ===== LOGS INFO (debug) =====
712 |       if (req.method === "GET" && pathname === "/api/logs/info") {
713 |         const paths = await getPm2LogPaths(PM2_APP);
714 |         json(res, { ok: true, app: PM2_APP, ...paths });
715 |         return;
716 |       }
717 | 
718 |       // ===== LOGS =====
719 |       if (req.method === "GET" && pathname === "/api/logs/out") {
720 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
721 |         const paths = await getPm2LogPaths(PM2_APP);
722 |         const payload = await readTailLog(paths.out, lines);
723 |         json(res, { ...payload, source: paths.source });
724 |         return;
725 |       }
726 | 
727 |       if (req.method === "GET" && pathname === "/api/logs/err") {
728 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
729 |         const paths = await getPm2LogPaths(PM2_APP);
730 |         const payload = await readTailLog(paths.err, lines);
731 |         json(res, { ...payload, source: paths.source });
732 |         return;
733 |       }
734 | 
735 |       // ===== COOKIES: STATUS =====
736 |       if (req.method === "GET" && pathname === "/api/cookies/status") {
737 |         const mainExists = fs.existsSync(COOKIES_PATH);
738 |         let mainAge = undefined;
739 |         let mainSize = undefined;
740 | 
741 |         if (mainExists) {
742 |           const stat = fs.statSync(COOKIES_PATH);
743 |           mainSize = stat.size;
744 |           mainAge = (Date.now() - stat.mtimeMs) / (1000 * 60 * 60); // hours
745 |         }
746 | 
747 |         json(res, {
748 |           ok: true,
749 |           mainCookiesExists: mainExists,
750 |           mainCookiesAge: mainAge,
751 |           mainCookiesSize: mainSize,
752 |           isLoggedIn: mainExists && mainSize > 10,
753 |         });
754 |         return;
755 |       }
756 | 
757 |       json(res, { ok: false, error: "Not found" }, 404);
758 |     } catch (e) {
759 |       json(res, { ok: false, error: e.message }, 500);
760 |     }
761 |   })
762 |   .listen(PORT, "0.0.0.0", () => {
763 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
764 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
765 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
766 |   });
767 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/panel-entry.cjs`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
1 | // src/panel/panel-entry.cjs
2 | require("./api.js");
3 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/ui/app.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
  1 | (() => {
  2 |   const $ = (id) => document.getElementById(id);
  3 | 
  4 |   // ---------- state ----------
  5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
  6 |   let logAutoTimer = null;
  7 |   let lastLogMode = "out"; // 'out' | 'err'
  8 |   let logsExpanded = false;
  9 | 
 10 |   // modal state
 11 |   let modalResolve = null;
 12 | 
 13 |   // edit modal state
 14 |   let editResolve = null;
 15 | 
 16 |   // ---------- ui refs ----------
 17 |   const elToken = $("token");
 18 |   const btnSaveToken = $("saveToken");
 19 |   const btnRefresh = $("refresh");
 20 |   const elStatus = $("status");
 21 | 
 22 |   const btnSaveEnv = $("saveEnv");
 23 |   const btnPm2Start = $("pm2Start");
 24 |   const btnPm2Stop = $("pm2Stop");
 25 |   const btnPm2Restart = $("pm2Restart");
 26 |   const btnClearCookies = $("clearCookies");
 27 |   const elEnvMsg = $("envMsg");
 28 | 
 29 |   const elNewPostUrl = $("newPostUrl");
 30 |   const elNewPostName = $("newPostName");
 31 |   const elNewPostImage = $("newPostImage");
 32 |   const elNewPostActive = $("newPostActive");
 33 |   const btnAddPost = $("addPost");
 34 |   const elPostsTbody = $("posts");
 35 | 
 36 |   const btnLoadOut = $("loadOut");
 37 |   const btnLoadErr = $("loadErr");
 38 |   const elLogLines = $("logLines");
 39 |   const elLogAutoEvery = $("logAutoEvery");
 40 |   const btnLogAutoToggle = $("logAutoToggle");
 41 |   const elLogAutoScroll = $("logAutoScroll");
 42 |   const elLogs = $("logs");
 43 |   const elLogHint = $("logHint");
 44 | 
 45 |   const logsCard = $("logsCard");
 46 |   const btnToggleLogsSize = $("toggleLogsSize");
 47 | 
 48 |   // modal refs (delete + generic)
 49 |   const modalOverlay = $("modalOverlay");
 50 |   const modalBody = $("modalBody");
 51 |   const modalCancel = $("modalCancel");
 52 |   const modalOk = $("modalOk");
 53 | 
 54 |   // env fields
 55 |   const ENV_FIELDS = [
 56 |     "FB_EMAIL",
 57 |     "FB_PASSWORD",
 58 |     "WEBHOOK_URL",
 59 |     "CHECK_INTERVAL_MS",
 60 |     "POSTS_SHEET_URL",
 61 |     "HEADLESS_BROWSER",
 62 |     "USE_UI_HANDLERS",
 63 |     "INCLUDE_REPLIES",
 64 |   ];
 65 | 
 66 |   function setHint(el, msg, ok = true) {
 67 |     if (!el) return;
 68 |     el.textContent = msg || "";
 69 |     el.classList.remove("ok", "err");
 70 |     el.classList.add(ok ? "ok" : "err");
 71 |   }
 72 | 
 73 |   function fmtTime() {
 74 |     try {
 75 |       return new Date().toLocaleString();
 76 |     } catch {
 77 |       return "";
 78 |     }
 79 |   }
 80 | 
 81 |   function getAuthHeaders() {
 82 |     const t = (token || "").trim();
 83 |     return t ? { Authorization: `Bearer ${t}` } : {};
 84 |   }
 85 | 
 86 |   async function api(path, opts = {}) {
 87 |     const headers = {
 88 |       ...(opts.headers || {}),
 89 |       ...getAuthHeaders(),
 90 |     };
 91 | 
 92 |     let body = opts.body;
 93 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
 94 |       headers["Content-Type"] = "application/json";
 95 |       body = JSON.stringify(body);
 96 |     }
 97 | 
 98 |     const res = await fetch(path, {
 99 |       method: opts.method || "GET",
100 |       headers,
101 |       body,
102 |     });
103 | 
104 |     const text = await res.text();
105 |     let data = null;
106 |     try {
107 |       data = JSON.parse(text);
108 |     } catch {
109 |       data = { ok: false, error: text || `HTTP ${res.status}` };
110 |     }
111 | 
112 |     if (!res.ok) {
113 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
114 |     }
115 |     return data;
116 |   }
117 | 
118 |   // ---------- modal ----------
119 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
120 |     return new Promise((resolve) => {
121 |       modalResolve = resolve;
122 | 
123 |       $("modalTitle").textContent = title;
124 |       modalBody.innerHTML = body;
125 | 
126 |       modalOk.textContent = okText;
127 |       modalOk.classList.toggle("danger", !!danger);
128 | 
129 |       modalOverlay.classList.add("show");
130 |       modalOverlay.setAttribute("aria-hidden", "false");
131 | 
132 |       setTimeout(() => {
133 |         (danger ? modalOk : modalCancel).focus();
134 |       }, 0);
135 |     });
136 |   }
137 | 
138 |   function closeModal(result) {
139 |     modalOverlay.classList.remove("show");
140 |     modalOverlay.setAttribute("aria-hidden", "true");
141 |     const r = modalResolve;
142 |     modalResolve = null;
143 |     if (typeof r === "function") r(result);
144 |   }
145 | 
146 |   modalCancel.addEventListener("click", () => closeModal(false));
147 |   modalOk.addEventListener("click", () => closeModal(true));
148 |   modalOverlay.addEventListener("click", (e) => {
149 |     if (e.target === modalOverlay) closeModal(false);
150 |   });
151 |   window.addEventListener("keydown", (e) => {
152 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
153 |   });
154 | 
155 |   // ---------- core actions ----------
156 |   async function loadStatus() {
157 |     setHint(elStatus, "≈Åadowanie statusu...", true);
158 | 
159 |     const r = await api("/api/status");
160 |     if (!r.ok) {
161 |       setHint(
162 |         elStatus,
163 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
164 |         false
165 |       );
166 |       return null;
167 |     }
168 | 
169 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
170 |     return r;
171 |   }
172 | 
173 |   async function loadEnv() {
174 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
175 |     const r = await api("/api/env/get");
176 |     if (!r.ok) {
177 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
178 |       return;
179 |     }
180 |     const v = r.values || {};
181 |     for (const k of ENV_FIELDS) {
182 |       const el = $(k);
183 |       if (!el) continue;
184 |       el.value = (v[k] ?? "").toString();
185 |     }
186 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
187 |   }
188 | 
189 |   async function saveEnv(restart = false) {
190 |     const set = {};
191 |     for (const k of ENV_FIELDS) {
192 |       const el = $(k);
193 |       if (!el) continue;
194 |       set[k] = (el.value ?? "").toString();
195 |     }
196 | 
197 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
198 | 
199 |     const r = await api("/api/env/set", {
200 |       method: "POST",
201 |       body: { set, restart },
202 |     });
203 | 
204 |     if (!r.ok) {
205 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
206 |       return;
207 |     }
208 | 
209 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
210 |   }
211 | 
212 |   function copyIconSvg() {
213 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
214 |     return `
215 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
216 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
217 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
218 |       </svg>
219 |     `;
220 |   }
221 | 
222 |   async function loadPosts() {
223 |     const r = await api("/api/posts");
224 |     if (!r.ok) {
225 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
226 |       return;
227 |     }
228 | 
229 |     const posts = Array.isArray(r.posts) ? r.posts : [];
230 |     elPostsTbody.innerHTML = "";
231 | 
232 |     for (const p of posts) {
233 |       const tr = document.createElement("tr");
234 | 
235 |       const tdId = document.createElement("td");
236 |       tdId.className = "mono col-id";
237 |       tdId.textContent = p.id || "";
238 |       tr.appendChild(tdId);
239 | 
240 |       // LINK + IKONKA KOPIUJ PRZY LINKU
241 |       const tdUrl = document.createElement("td");
242 |       tdUrl.className = "col-url";
243 | 
244 |       if (p.url) {
245 |         const wrap = document.createElement("div");
246 |         wrap.className = "urlWrap";
247 | 
248 |         const a = document.createElement("a");
249 |         a.href = p.url;
250 |         a.target = "_blank";
251 |         a.rel = "noopener noreferrer";
252 |         a.textContent = p.url;
253 | 
254 |         const btnCopyIcon = document.createElement("button");
255 |         btnCopyIcon.className = "iconBtn";
256 |         btnCopyIcon.type = "button";
257 |         btnCopyIcon.title = "Kopiuj link";
258 |         btnCopyIcon.innerHTML = copyIconSvg();
259 | 
260 |         btnCopyIcon.addEventListener("click", async (e) => {
261 |           e.preventDefault();
262 |           e.stopPropagation();
263 | 
264 |           const ok = await copyToClipboard(p.url);
265 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
266 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
267 |         });
268 | 
269 |         wrap.appendChild(a);
270 |         wrap.appendChild(btnCopyIcon);
271 |         tdUrl.appendChild(wrap);
272 |       }
273 | 
274 |       tr.appendChild(tdUrl);
275 | 
276 |       const tdName = document.createElement("td");
277 |       tdName.className = "col-name";
278 |       tdName.textContent = p.name || "";
279 |       tr.appendChild(tdName);
280 | 
281 |       const tdImg = document.createElement("td");
282 |       tdImg.className = "col-img";
283 |       if (p.image) {
284 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
285 |       } else {
286 |         tdImg.textContent = "";
287 |       }
288 |       tr.appendChild(tdImg);
289 | 
290 | 
291 |       const tdActive = document.createElement("td");
292 |       tdActive.className = "col-act";
293 |       const chk = document.createElement("input");
294 |       chk.type = "checkbox";
295 |       chk.checked = !!p.active;
296 |       chk.addEventListener("change", async () => {
297 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
298 |           method: "PATCH",
299 |           body: { active: chk.checked },
300 |         });
301 |         await loadPosts();
302 |       });
303 |       tdActive.appendChild(chk);
304 |       tr.appendChild(tdActive);
305 | 
306 |       // AKCJE: EDYTUJ + USU≈É
307 |       const tdActions = document.createElement("td");
308 |       tdActions.className = "col-btn";
309 | 
310 |       const actions = document.createElement("div");
311 |       actions.className = "actionsWrap";
312 | 
313 |       const btnEdit = document.createElement("button");
314 |       btnEdit.className = "small";
315 |       btnEdit.type = "button";
316 |       btnEdit.textContent = "Edytuj";
317 |       btnEdit.addEventListener("click", async () => {
318 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
319 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
320 |         const ok = await showModal({
321 |           title: "Edytuj post",
322 |           body:
323 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
324 |             `<div style="margin-top:10px">
325 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
326 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
327 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
328 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
329 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
330 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
331 |             </div>`,
332 |           okText: "Zapisz",
333 |           danger: false,
334 |         });
335 | 
336 |         if (!ok) return;
337 | 
338 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
339 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
340 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
341 | 
342 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
343 |           method: "PATCH",
344 |           body: { url: newUrl, name: newName, image: newImg },
345 |         });
346 | 
347 |         if (!rr.ok) {
348 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
349 |           return;
350 |         }
351 | 
352 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
353 |         await loadPosts();
354 |       });
355 | 
356 |       const btnDel = document.createElement("button");
357 |       btnDel.className = "danger";
358 |       btnDel.type = "button";
359 |       btnDel.textContent = "Usu≈Ñ";
360 |       btnDel.addEventListener("click", async () => {
361 |         const ok = await showModal({
362 |           title: "UsunƒÖƒá post?",
363 |           body:
364 |             `<div>Ta operacja jest nieodwracalna.</div>` +
365 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
366 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
367 |           okText: "Usu≈Ñ",
368 |           danger: true,
369 |         });
370 |         if (!ok) return;
371 | 
372 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
373 |         if (!rr.ok) {
374 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
375 |           return;
376 |         }
377 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
378 |         await loadPosts();
379 |       });
380 | 
381 |       actions.appendChild(btnEdit);
382 |       actions.appendChild(btnDel);
383 | 
384 |       tdActions.appendChild(actions);
385 |       tr.appendChild(tdActions);
386 | 
387 |       elPostsTbody.appendChild(tr);
388 |     }
389 |   }
390 | 
391 |   async function addPost() {
392 |     const url = (elNewPostUrl.value || "").trim();
393 |     const name = (elNewPostName.value || "").trim();
394 |     const image = (elNewPostImage.value || "").trim();
395 |     const active = !!elNewPostActive.checked;
396 | 
397 |     const r = await api("/api/posts", {
398 |       method: "POST",
399 |       body: { url, name, image, active },
400 |     });
401 | 
402 |     if (!r.ok) {
403 |       await showModal({
404 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
405 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
406 |         okText: "OK",
407 |         danger: false,
408 |       });
409 |       return;
410 |     }
411 | 
412 |     elNewPostUrl.value = "";
413 |     elNewPostName.value = "";
414 |     elNewPostImage.value = "";
415 |     elNewPostActive.checked = true;
416 | 
417 |     setHint(elEnvMsg, "Dodano post.", true);
418 |     await loadPosts();
419 |   }
420 | 
421 |   async function pm2Call(which) {
422 |     const map = {
423 |       start: "/api/pm2/start",
424 |       stop: "/api/pm2/stop",
425 |       restart: "/api/pm2/restart",
426 |       status: "/api/pm2/status",
427 |     };
428 |     const path = map[which];
429 |     if (!path) return;
430 | 
431 |     const label =
432 |       which === "start" ? "Startujƒô watchera..."
433 |         : which === "stop" ? "Zatrzymujƒô watchera..."
434 |           : which === "restart" ? "Restartujƒô watchera..."
435 |             : "Sprawdzam status...";
436 | 
437 |     setHint(elEnvMsg, label, true);
438 | 
439 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
440 |     if (!r.ok) {
441 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
442 |       return;
443 |     }
444 | 
445 |     const okMsg =
446 |       which === "start" ? "Watcher uruchomiony."
447 |         : which === "stop" ? "Watcher zatrzymany."
448 |           : which === "restart" ? "Watcher zrestartowany."
449 |             : "Status pobrany.";
450 | 
451 |     setHint(elEnvMsg, okMsg, true);
452 | 
453 |     if (which !== "status") await loadStatus();
454 |   }
455 | 
456 |   async function clearCookies() {
457 |     const ok = await showModal({
458 |       title: "Wyczy≈õciƒá cookies?",
459 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
460 |       okText: "Wyczy≈õƒá",
461 |       danger: true,
462 |     });
463 |     if (!ok) return;
464 | 
465 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
466 | 
467 |     const r = await api("/api/cookies/clear", {
468 |       method: "POST",
469 |       body: { confirm: true },
470 |     });
471 | 
472 |     if (!r.ok) {
473 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
474 |       return;
475 |     }
476 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
477 |   }
478 | 
479 |   // ---------- logs ----------
480 |   function getLines() {
481 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
482 |     if (!isFinite(n)) return 200;
483 |     return Math.max(20, Math.min(2000, n));
484 |   }
485 | 
486 |   async function loadLogs(mode) {
487 |     lastLogMode = mode;
488 |     const lines = getLines();
489 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
490 | 
491 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
492 |     if (!r.ok) {
493 |       elLogs.value = "";
494 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
495 |       return;
496 |     }
497 | 
498 |     elLogs.value = (r.log || "").toString().replace(/\x1b\[[0-9;]*m/g, "");
499 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
500 | 
501 |     if (elLogAutoScroll.checked) {
502 |       elLogs.scrollTop = elLogs.scrollHeight;
503 |     }
504 |   }
505 | 
506 |   function stopAutoLogs() {
507 |     if (logAutoTimer) {
508 |       clearInterval(logAutoTimer);
509 |       logAutoTimer = null;
510 |     }
511 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
512 |     btnLogAutoToggle.classList.remove("primary");
513 |   }
514 | 
515 |   function startAutoLogs() {
516 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
517 |     if (every <= 0) {
518 |       stopAutoLogs();
519 |       return;
520 |     }
521 | 
522 |     stopAutoLogs();
523 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
524 |     btnLogAutoToggle.classList.add("primary");
525 | 
526 |     logAutoTimer = setInterval(() => {
527 |       loadLogs(lastLogMode).catch(() => {});
528 |     }, every);
529 |   }
530 | 
531 |   function toggleLogsSize() {
532 |     logsExpanded = !logsExpanded;
533 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
534 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
535 |   }
536 | 
537 |   // ---------- utils ----------
538 |   async function copyToClipboard(text) {
539 |     try {
540 |       await navigator.clipboard.writeText(text);
541 |       return true;
542 |     } catch (e) {
543 |       const ta = document.createElement("textarea");
544 |       ta.value = text;
545 |       ta.style.position = "fixed";
546 |       ta.style.opacity = "0";
547 |       document.body.appendChild(ta);
548 |       ta.select();
549 |       try {
550 |         document.execCommand("copy");
551 |         document.body.removeChild(ta);
552 |         return true;
553 |       } catch {
554 |         document.body.removeChild(ta);
555 |         return false;
556 |       }
557 |     }
558 |   }
559 | 
560 |   function escapeHtml(s) {
561 |     return String(s || "")
562 |       .replaceAll("&", "&amp;")
563 |       .replaceAll("<", "&lt;")
564 |       .replaceAll(">", "&gt;")
565 |       .replaceAll('"', "&quot;")
566 |       .replaceAll("'", "&#039;");
567 |   }
568 | 
569 |   // ---------- wire events ----------
570 |   function wire() {
571 |     elToken.value = token;
572 | 
573 |     btnSaveToken.addEventListener("click", async () => {
574 |       token = (elToken.value || "").trim();
575 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
576 |       await hardRefresh();
577 |     });
578 | 
579 |     btnRefresh.addEventListener("click", async () => {
580 |       await hardRefresh();
581 |     });
582 | 
583 |     btnSaveEnv.addEventListener("click", async () => {
584 |       await saveEnv(false);
585 |     });
586 | 
587 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
588 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
589 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
590 | 
591 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
592 | 
593 |     btnAddPost.addEventListener("click", async () => await addPost());
594 | 
595 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
596 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
597 | 
598 |     btnLogAutoToggle.addEventListener("click", () => {
599 |       if (logAutoTimer) stopAutoLogs();
600 |       else startAutoLogs();
601 |     });
602 | 
603 |     elLogAutoEvery.addEventListener("change", () => {
604 |       if (logAutoTimer) startAutoLogs();
605 |     });
606 | 
607 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
608 |   }
609 | 
610 |   async function hardRefresh() {
611 |     // Parallel requests for better performance
612 |     const promises = [loadStatus(), loadEnv(), loadPosts()];
613 | 
614 |     if (elLogs.value && elLogs.value.trim().length > 0) {
615 |       promises.push(loadLogs(lastLogMode));
616 |     }
617 | 
618 |     await Promise.all(promises);
619 |   }
620 | 
621 |   // ---------- init ----------
622 |   wire();
623 |   hardRefresh().catch(() => {
624 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
625 |   });
626 | })();
627 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/ui/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>Panel FB Watcher</title>
  7 | 
  8 |   <style>
  9 |     :root{
 10 |       --bg:#0b0f14;
 11 |       --card:#121926;
 12 |       --card2:#0b1220;
 13 |       --border:#223047;
 14 |       --border2:#2a3a55;
 15 |       --text:#e7eef7;
 16 |       --muted:rgba(231,238,247,.75);
 17 |       --primary:#2563eb;
 18 |       --danger:#b91c1c;
 19 |       --ok:#34d399;
 20 |       --err:#f87171;
 21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
 22 |       --radius:14px;
 23 |     }
 24 | 
 25 |     * { box-sizing:border-box; }
 26 |     body {
 27 |       font-family: system-ui, Arial;
 28 |       margin: 16px;
 29 |       background: var(--bg);
 30 |       color: var(--text);
 31 |     }
 32 | 
 33 |     h2 { margin: 6px 0 6px; }
 34 |     h3 { margin: 6px 0 12px; }
 35 | 
 36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
 37 |     .card {
 38 |       background: var(--card);
 39 |       border:1px solid var(--border);
 40 |       border-radius: var(--radius);
 41 |       padding:14px;
 42 |       margin:12px 0;
 43 |       box-shadow: var(--shadow);
 44 |     }
 45 | 
 46 |     input, textarea, button, select {
 47 |       font: inherit;
 48 |       border-radius:12px;
 49 |       border:1px solid var(--border2);
 50 |       background: var(--card2);
 51 |       color: var(--text);
 52 |       padding:10px 12px;
 53 |       outline: none;
 54 |     }
 55 |     input:focus, textarea:focus, select:focus {
 56 |       border-color: rgba(37, 99, 235, .75);
 57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
 58 |     }
 59 | 
 60 |     input, textarea { width: 100%; }
 61 |     textarea { resize: vertical; min-height: 90px; }
 62 | 
 63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
 64 |     button:active { transform: translateY(1px); }
 65 |     button.primary { background: var(--primary); border-color: var(--primary); }
 66 |     button.danger { background: var(--danger); border-color: var(--danger); }
 67 |     button.ghost { background: transparent; }
 68 |     button.small { padding:8px 10px; border-radius: 10px; }
 69 | 
 70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 71 | 
 72 |     .muted { opacity:0.78; font-size:12px; }
 73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 74 | 
 75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
 76 | 
 77 |     .thumb {
 78 |       width:200px; height:120px;
 79 |       object-fit:cover;
 80 |       border-radius:10px;
 81 |       border:1px solid var(--border);
 82 |       background: var(--card2);
 83 |     }
 84 | 
 85 |     /* ===== tabela ===== */
 86 |     .tableWrap {
 87 |       width: 100%;
 88 |       /* by≈Ço: overflow-x; teraz robimy pe≈Çny scroll + limit wysoko≈õci */
 89 |       max-height: calc(100vh - 260px);
 90 |       overflow: auto;
 91 | 
 92 |       border-radius: 12px;
 93 |       border: 1px solid rgba(34,48,71,.45);
 94 |       background: rgba(11,18,32,.25);
 95 |     }
 96 | 
 97 |     /* opcjonalnie: ≈Çadniejsze scrollbary */
 98 |     .tableWrap::-webkit-scrollbar { height: 10px; width: 10px; }
 99 |     .tableWrap::-webkit-scrollbar-thumb { background: rgba(42,58,85,.9); border-radius: 999px; }
100 |     .tableWrap::-webkit-scrollbar-track { background: rgba(11,18,32,.35); border-radius: 999px; }
101 | 
102 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
103 |     th, td {
104 |       border-bottom:1px solid rgba(34,48,71,.7);
105 |       padding:10px;
106 |       text-align:left;
107 |       vertical-align:top;
108 |       overflow-wrap:anywhere;
109 |       word-break:break-word;
110 |     }
111 | 
112 |     /* sticky head */
113 |     th {
114 |       font-size: 12px;
115 |       opacity:.9;
116 |       position: sticky;
117 |       top: 0;
118 |       z-index: 5;
119 |       background: rgba(18,25,38,.96);
120 |       backdrop-filter: blur(8px);
121 |     }
122 | 
123 |     /* delikatny hover, ≈ºeby to "oddycha≈Ço" */
124 |     tbody tr:hover td {
125 |       background: rgba(37,99,235,.06);
126 |     }
127 | 
128 |     /* kolumny */
129 |     th.col-id,  td.col-id  { width: 170px; }
130 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
131 |     th.col-name,td.col-name{ width: 170px; }
132 |     th.col-img, td.col-img { width: 220px; }
133 |     th.col-act, td.col-act { width: 110px; text-align:center; }
134 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
135 | 
136 |     /* URL: kolor */
137 |     td.col-url a{
138 |       color: #93c5fd;
139 |       text-decoration: underline;
140 |     }
141 | 
142 |     /* wrapper dla linka + ikonki kopiuj */
143 |     .urlWrap{
144 |       display:flex;
145 |       align-items:flex-start;
146 |       gap:10px;
147 |     }
148 | 
149 |     /* KLUCZ: niech link nie robi ≈õciany (max 2 linie) */
150 | .urlWrap a{
151 |   flex: 1;
152 |   min-width: 0;
153 | 
154 |   /* clamp (Chromium/WebKit) */
155 |   display: -webkit-box;
156 |   -webkit-box-orient: vertical;
157 |   -webkit-line-clamp: 2;
158 | 
159 |   /* clamp (standard / future) */
160 |   line-clamp: 2;
161 | 
162 |   overflow: hidden;
163 | 
164 |   word-break: break-word;
165 |   overflow-wrap: anywhere;
166 |   line-height: 1.25;
167 | 
168 |   /* fallback gdy clamp nie dzia≈Ça */
169 |   max-height: 2.5em;
170 | }
171 | 
172 | 
173 | 
174 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
175 |     .iconBtn{
176 |       width: 28px;
177 |       height: 28px;
178 |       padding: 0;
179 |       display:inline-flex;
180 |       align-items:center;
181 |       justify-content:center;
182 |       border-radius: 10px;
183 |       background: transparent;
184 |       border: 1px solid rgba(42,58,85,.9);
185 |       opacity: .9;
186 |       flex: 0 0 auto;
187 |     }
188 |     .iconBtn:hover{
189 |       opacity: 1;
190 |       background: rgba(37,99,235,.15);
191 |     }
192 |     .iconBtn:active{
193 |       transform: translateY(1px);
194 |     }
195 |     .iconBtn svg{
196 |       width: 16px;
197 |       height: 16px;
198 |       fill: none;
199 |       stroke: rgba(231,238,247,.95);
200 |       stroke-width: 2;
201 |       stroke-linecap: round;
202 |       stroke-linejoin: round;
203 |     }
204 | 
205 |     /* akcje w tabeli */
206 |     .actionsWrap{
207 |       display:flex;
208 |       gap:10px;
209 |       align-items:center;
210 |       justify-content:flex-start;
211 |       flex-wrap:nowrap;
212 |     }
213 | 
214 |     /* ===== status ===== */
215 |     .hint { margin-top:10px; }
216 |     .hint.ok { color: #a7f3d0; }
217 |     .hint.err { color: #fca5a5; }
218 | 
219 |     /* ===== logi: proporcje ===== */
220 |     .logsBox {
221 |       display:flex;
222 |       flex-direction: column;
223 |       gap:10px;
224 |     }
225 |     #logs {
226 |       height: 200px;
227 |       min-height: 160px;
228 |       max-height: 520px;
229 |     }
230 |     .logsExpanded #logs { height: 420px; }
231 | 
232 |     /* ===== modal ===== */
233 |     .modalOverlay{
234 |       position: fixed;
235 |       inset: 0;
236 |       background: rgba(0,0,0,.55);
237 |       display:none;
238 |       align-items:center;
239 |       justify-content:center;
240 |       padding: 18px;
241 |       z-index: 9999;
242 |     }
243 |     .modalOverlay.show{ display:flex; }
244 |     .modal{
245 |       width: min(640px, 100%);
246 |       border-radius: 16px;
247 |       border: 1px solid rgba(34,48,71,.9);
248 |       background: rgba(18,25,38,.98);
249 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
250 |       padding: 16px;
251 |     }
252 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
253 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
254 |     .modal .modalActions{
255 |       display:flex;
256 |       justify-content:flex-end;
257 |       gap:10px;
258 |       margin-top: 14px;
259 |     }
260 |     .kbd{
261 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
262 |       font-size: 12px;
263 |       opacity:.9;
264 |       padding: 2px 6px;
265 |       border:1px solid rgba(42,58,85,.9);
266 |       border-radius: 8px;
267 |       background: rgba(11,18,32,.55);
268 |     }
269 | 
270 |     @media (max-width: 860px){
271 |       table { min-width: 980px; }
272 |       .tableWrap { max-height: calc(100vh - 220px); }
273 |     }
274 |   </style>
275 | </head>
276 | 
277 | <body>
278 |   <h2>FB Watcher ‚Äî Panel</h2>
279 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
280 | 
281 |   <div class="card">
282 |     <div class="row">
283 |       <div style="flex:1; min-width:260px;">
284 |         <label>Token panelu</label>
285 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
286 |       </div>
287 |       <div style="display:flex; gap:10px; align-items:flex-end;">
288 |         <button class="primary" id="saveToken">Zapisz token</button>
289 |         <button id="refresh">Od≈õwie≈º</button>
290 |       </div>
291 |     </div>
292 | 
293 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
294 |   </div>
295 | 
296 |   <div class="card">
297 |     <h3>Ustawienia (.env)</h3>
298 | 
299 |     <div class="row">
300 |       <div style="flex:1; min-width:260px;">
301 |         <label>E-mail Facebook</label>
302 |         <input id="FB_EMAIL" />
303 |       </div>
304 |       <div style="flex:1; min-width:260px;">
305 |         <label>Has≈Ço Facebook</label>
306 |         <input id="FB_PASSWORD" type="password" />
307 |       </div>
308 |     </div>
309 | 
310 |     <label>Webhook (URL)</label>
311 |     <input id="WEBHOOK_URL" />
312 | 
313 |     <div class="row">
314 |       <div style="flex:1; min-width:220px;">
315 |         <label>Interwa≈Ç sprawdzania (ms)</label>
316 |         <input id="CHECK_INTERVAL_MS" />
317 |       </div>
318 |       <div style="flex:2; min-width:260px;">
319 |         <label>Arkusz z postami (CSV export)</label>
320 |         <input id="POSTS_SHEET_URL" />
321 |       </div>
322 |     </div>
323 | 
324 |     <div class="row">
325 |       <div style="flex:1; min-width:220px;">
326 |         <label>Tryb bez okna (headless)</label>
327 |         <select id="HEADLESS_BROWSER">
328 |           <option value="true">true</option>
329 |           <option value="false">false</option>
330 |         </select>
331 |       </div>
332 |       <div style="flex:1; min-width:220px;">
333 |         <label>Obs≈Çuga UI (handlery)</label>
334 |         <select id="USE_UI_HANDLERS">
335 |           <option value="true">true</option>
336 |           <option value="false">false</option>
337 |         </select>
338 |       </div>
339 |       <div style="flex:1; min-width:220px;">
340 |         <label>Uwzglƒôdniaj odpowiedzi</label>
341 |         <select id="INCLUDE_REPLIES">
342 |           <option value="true">true</option>
343 |           <option value="false">false</option>
344 |         </select>
345 |       </div>
346 |     </div>
347 | 
348 |     <div class="row" style="margin-top:10px;">
349 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
350 |       <button id="pm2Start">Start watchera</button>
351 |       <button id="pm2Stop">Stop watchera</button>
352 |       <button id="pm2Restart">Restart watchera</button>
353 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
354 |     </div>
355 | 
356 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
357 |   </div>
358 | 
359 |   <div class="card">
360 |     <h3>Posty (data/posts.json)</h3>
361 | 
362 |     <div class="row">
363 |       <div style="flex:2; min-width:260px;">
364 |         <label>Nowy URL posta</label>
365 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
366 |       </div>
367 | 
368 |       <div style="flex:1; min-width:220px;">
369 |         <label>Nazwa</label>
370 |         <input id="newPostName" placeholder="np. A1" />
371 |       </div>
372 | 
373 |       <div style="flex:1; min-width:260px;">
374 |         <label>URL zdjƒôcia</label>
375 |         <input id="newPostImage" placeholder="https://...jpg" />
376 |       </div>
377 |     </div>
378 | 
379 |     <div class="row" style="margin-top:10px;">
380 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
381 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
382 |           <input type="checkbox" id="newPostActive" checked /> aktywny
383 |         </label>
384 |         <button class="primary" id="addPost">Dodaj</button>
385 |       </div>
386 |     </div>
387 | 
388 |     <div style="margin-top:12px;" class="tableWrap">
389 |       <table>
390 |         <thead>
391 |           <tr>
392 |             <th class="col-id">ID</th>
393 |             <th class="col-url">Link</th>
394 |             <th class="col-name">Nazwa</th>
395 |             <th class="col-img">Zdjƒôcie</th>
396 |             <th class="col-act">Aktywny</th>
397 |             <th class="col-btn">Akcje</th>
398 |           </tr>
399 |         </thead>
400 |         <tbody id="posts"></tbody>
401 |       </table>
402 |     </div>
403 |   </div>
404 | 
405 |   <div class="card" id="logsCard">
406 |     <div class="row" style="justify-content:space-between; align-items:center;">
407 |       <h3 style="margin:0;">Logi</h3>
408 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
409 |         Rozwi≈Ñ
410 |       </button>
411 |     </div>
412 | 
413 |     <div class="logsBox">
414 |       <div class="row">
415 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
416 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
417 | 
418 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
419 | 
420 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
421 |           <option value="0">auto: wy≈Ç.</option>
422 |           <option value="1000">co 1 s</option>
423 |           <option value="2000" selected>co 2 s</option>
424 |           <option value="5000">co 5 s</option>
425 |           <option value="10000">co 10 s</option>
426 |         </select>
427 | 
428 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
429 | 
430 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
431 |           <input type="checkbox" id="logAutoScroll" checked />
432 |           auto-scroll
433 |         </label>
434 |       </div>
435 | 
436 |       <div class="sep"></div>
437 | 
438 |       <textarea
439 |         id="logs"
440 |         class="mono"
441 |         readonly
442 |         spellcheck="false"
443 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
444 | 
445 |       <div id="logHint" class="muted hint"></div>
446 |     </div>
447 |   </div>
448 | 
449 |   <!-- modal -->
450 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
451 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
452 |       <h4 id="modalTitle">Potwierdzenie</h4>
453 |       <div class="modalBody" id="modalBody"></div>
454 |       <div class="modalActions">
455 |         <button id="modalCancel">Anuluj</button>
456 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
457 |       </div>
458 |       <div class="muted" style="margin-top:10px;">
459 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
460 |       </div>
461 |     </div>
462 |   </div>
463 | 
464 |   <script src="/app.js"></script>
465 | </body>
466 | </html>
467 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```html
 1 | <!DOCTYPE html>
 2 | <html lang="pl" class="dark">
 3 |   <head>
 4 |     <meta charset="UTF-8" />
 5 |     <link rel="icon" type="image/svg+xml" href="/vite.svg" />
 6 |     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 7 |     <title>FB Watcher - Panel</title>
 8 |   </head>
 9 |   <body>
10 |     <div id="root"></div>
11 |     <script type="module" src="/src/main.tsx"></script>
12 |   </body>
13 | </html>
14 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/package.json`
**Typ:** JSON  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```json
 1 | {
 2 |   "name": "fbwatcher-panel",
 3 |   "private": true,
 4 |   "version": "0.0.1",
 5 |   "type": "module",
 6 |   "scripts": {
 7 |     "dev": "vite",
 8 |     "build": "tsc -b && vite build",
 9 |     "lint": "eslint .",
10 |     "preview": "vite preview"
11 |   },
12 |   "dependencies": {
13 |     "react": "^18.3.1",
14 |     "react-dom": "^18.3.1",
15 |     "react-router-dom": "^7.1.1",
16 |     "lucide-react": "^0.469.0",
17 |     "clsx": "^2.1.1",
18 |     "tailwind-merge": "^2.6.0",
19 |     "class-variance-authority": "^0.7.1"
20 |   },
21 |   "devDependencies": {
22 |     "@types/react": "^18.3.18",
23 |     "@types/react-dom": "^18.3.5",
24 |     "@vitejs/plugin-react": "^4.3.4",
25 |     "autoprefixer": "^10.4.20",
26 |     "postcss": "^8.4.49",
27 |     "tailwindcss": "^3.4.17",
28 |     "typescript": "~5.6.2",
29 |     "vite": "^6.0.5"
30 |   }
31 | }
32 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/App.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { BrowserRouter, Routes, Route } from 'react-router-dom'
 2 | import { AuthProvider } from '@/hooks/useAuth'
 3 | import { DashboardLayout } from '@/components/layout/DashboardLayout'
 4 | import { Dashboard } from '@/pages/Dashboard'
 5 | import { Watched } from '@/pages/Watched'
 6 | import { Sources } from '@/pages/Sources'
 7 | import { Discoveries } from '@/pages/Discoveries'
 8 | import { Campaigns } from '@/pages/Campaigns'
 9 | import { Cookies } from '@/pages/Cookies'
10 | import { Settings } from '@/pages/Settings'
11 | import { Logs } from '@/pages/Logs'
12 | 
13 | export default function App() {
14 |   return (
15 |     <AuthProvider>
16 |       <BrowserRouter basename="/new">
17 |         <Routes>
18 |           <Route element={<DashboardLayout />}>
19 |             <Route path="/" element={<Dashboard />} />
20 |             <Route path="/watched" element={<Watched />} />
21 |             <Route path="/sources" element={<Sources />} />
22 |             <Route path="/discoveries" element={<Discoveries />} />
23 |             <Route path="/campaigns" element={<Campaigns />} />
24 |             <Route path="/cookies" element={<Cookies />} />
25 |             <Route path="/settings" element={<Settings />} />
26 |             <Route path="/logs" element={<Logs />} />
27 |           </Route>
28 |         </Routes>
29 |       </BrowserRouter>
30 |     </AuthProvider>
31 |   )
32 | }
33 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/DashboardLayout.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { useState, useEffect } from 'react'
 2 | import { Outlet, useLocation } from 'react-router-dom'
 3 | import { Sidebar } from './Sidebar'
 4 | import { Header } from './Header'
 5 | import { MobileNav } from './MobileNav'
 6 | 
 7 | const PAGE_TITLES: Record<string, string> = {
 8 |   '/': 'Dashboard',
 9 |   '/watched': 'Obserwowane posty',
10 |   '/sources': 'Zrodla',
11 |   '/discoveries': 'Wykrycia',
12 |   '/campaigns': 'Kampanie',
13 |   '/cookies': 'Sesje / Cookies',
14 |   '/settings': 'Ustawienia',
15 |   '/logs': 'Logi',
16 | }
17 | 
18 | export function DashboardLayout() {
19 |   const [mobileNavOpen, setMobileNavOpen] = useState(false)
20 |   const location = useLocation()
21 | 
22 |   const pageTitle = PAGE_TITLES[location.pathname] || 'FB Watcher'
23 | 
24 |   // Close mobile nav on route change
25 |   useEffect(() => {
26 |     setMobileNavOpen(false)
27 |   }, [location.pathname])
28 | 
29 |   return (
30 |     <div className="grid min-h-screen w-full md:grid-cols-[220px_1fr] lg:grid-cols-[280px_1fr]">
31 |       {/* Desktop sidebar */}
32 |       <div className="hidden border-r bg-muted/40 md:block">
33 |         <Sidebar />
34 |       </div>
35 | 
36 |       {/* Mobile nav */}
37 |       <MobileNav open={mobileNavOpen} onClose={() => setMobileNavOpen(false)} />
38 | 
39 |       {/* Main content */}
40 |       <div className="flex flex-col">
41 |         <Header title={pageTitle} onMenuClick={() => setMobileNavOpen(true)} />
42 |         <main className="flex flex-1 flex-col gap-4 p-4 lg:gap-6 lg:p-6">
43 |           <Outlet />
44 |         </main>
45 |       </div>
46 |     </div>
47 |   )
48 | }
49 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Header.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { Menu } from 'lucide-react'
 2 | import { Button } from '@/components/ui/button'
 3 | 
 4 | interface HeaderProps {
 5 |   title: string
 6 |   onMenuClick?: () => void
 7 | }
 8 | 
 9 | export function Header({ title, onMenuClick }: HeaderProps) {
10 |   return (
11 |     <header className="flex h-14 items-center gap-4 border-b bg-background px-4 lg:h-[60px] lg:px-6">
12 |       <Button
13 |         variant="ghost"
14 |         size="icon"
15 |         className="shrink-0 md:hidden"
16 |         onClick={onMenuClick}
17 |       >
18 |         <Menu className="h-5 w-5" />
19 |         <span className="sr-only">Menu</span>
20 |       </Button>
21 |       <div className="flex-1">
22 |         <h1 className="text-lg font-semibold md:text-xl">{title}</h1>
23 |       </div>
24 |     </header>
25 |   )
26 | }
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/MobileNav.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { X } from 'lucide-react'
 2 | import { Button } from '@/components/ui/button'
 3 | import { Sidebar } from './Sidebar'
 4 | import { cn } from '@/lib/utils'
 5 | 
 6 | interface MobileNavProps {
 7 |   open: boolean
 8 |   onClose: () => void
 9 | }
10 | 
11 | export function MobileNav({ open, onClose }: MobileNavProps) {
12 |   return (
13 |     <>
14 |       {/* Overlay */}
15 |       <div
16 |         className={cn(
17 |           'fixed inset-0 z-40 bg-black/80 transition-opacity md:hidden',
18 |           open ? 'opacity-100' : 'opacity-0 pointer-events-none'
19 |         )}
20 |         onClick={onClose}
21 |       />
22 | 
23 |       {/* Sidebar */}
24 |       <div
25 |         className={cn(
26 |           'fixed inset-y-0 left-0 z-50 w-72 bg-background transition-transform md:hidden',
27 |           open ? 'translate-x-0' : '-translate-x-full'
28 |         )}
29 |       >
30 |         <Button
31 |           variant="ghost"
32 |           size="icon"
33 |           className="absolute right-2 top-2"
34 |           onClick={onClose}
35 |         >
36 |           <X className="h-5 w-5" />
37 |         </Button>
38 |         <Sidebar />
39 |       </div>
40 |     </>
41 |   )
42 | }
43 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Sidebar.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { NavLink } from 'react-router-dom'
  2 | import {
  3 |   Home,
  4 |   Bell,
  5 |   Eye,
  6 |   Globe,
  7 |   Megaphone,
  8 |   Cookie,
  9 |   Settings,
 10 |   Terminal,
 11 | } from 'lucide-react'
 12 | import { cn } from '@/lib/utils'
 13 | import { Badge } from '@/components/ui/badge'
 14 | import { Separator } from '@/components/ui/separator'
 15 | 
 16 | interface NavItemProps {
 17 |   to: string
 18 |   icon: React.ReactNode
 19 |   label: string
 20 |   badge?: number
 21 |   disabled?: boolean
 22 | }
 23 | 
 24 | function NavItem({ to, icon, label, badge, disabled }: NavItemProps) {
 25 |   if (disabled) {
 26 |     return (
 27 |       <div className="flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground/50 cursor-not-allowed">
 28 |         {icon}
 29 |         <span className="flex-1">{label}</span>
 30 |         <Badge variant="outline" className="text-xs opacity-50">
 31 |           Wkrotce
 32 |         </Badge>
 33 |       </div>
 34 |     )
 35 |   }
 36 | 
 37 |   return (
 38 |     <NavLink
 39 |       to={to}
 40 |       className={({ isActive }) =>
 41 |         cn(
 42 |           'flex items-center gap-3 rounded-lg px-3 py-2 transition-colors',
 43 |           isActive
 44 |             ? 'bg-secondary text-secondary-foreground'
 45 |             : 'text-muted-foreground hover:bg-secondary/50 hover:text-secondary-foreground'
 46 |         )
 47 |       }
 48 |     >
 49 |       {icon}
 50 |       <span className="flex-1">{label}</span>
 51 |       {badge !== undefined && badge > 0 && (
 52 |         <Badge variant="destructive" className="text-xs">
 53 |           {badge}
 54 |         </Badge>
 55 |       )}
 56 |     </NavLink>
 57 |   )
 58 | }
 59 | 
 60 | interface SidebarProps {
 61 |   className?: string
 62 | }
 63 | 
 64 | export function Sidebar({ className }: SidebarProps) {
 65 |   return (
 66 |     <div className={cn('flex h-full flex-col gap-2', className)}>
 67 |       <div className="flex h-14 items-center border-b px-4 lg:h-[60px] lg:px-6">
 68 |         <span className="flex items-center gap-2 font-semibold">
 69 |           <Eye className="h-6 w-6" />
 70 |           <span>FB Watcher</span>
 71 |         </span>
 72 |       </div>
 73 |       <div className="flex-1 overflow-auto">
 74 |         <nav className="grid items-start gap-1 px-2 text-sm font-medium lg:px-4">
 75 |           <div className="py-2">
 76 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
 77 |               Glowne
 78 |             </p>
 79 |           </div>
 80 |           <NavItem to="/" icon={<Home className="h-4 w-4" />} label="Dashboard" />
 81 |           <NavItem
 82 |             to="/discoveries"
 83 |             icon={<Bell className="h-4 w-4" />}
 84 |             label="Wykrycia"
 85 |             disabled
 86 |           />
 87 | 
 88 |           <Separator className="my-3" />
 89 | 
 90 |           <div className="py-2">
 91 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
 92 |               Monitoring
 93 |             </p>
 94 |           </div>
 95 |           <NavItem to="/watched" icon={<Eye className="h-4 w-4" />} label="Obserwowane" />
 96 |           <NavItem
 97 |             to="/sources"
 98 |             icon={<Globe className="h-4 w-4" />}
 99 |             label="Zrodla"
100 |             disabled
101 |           />
102 | 
103 |           <Separator className="my-3" />
104 | 
105 |           <div className="py-2">
106 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
107 |               Automatyzacja
108 |             </p>
109 |           </div>
110 |           <NavItem
111 |             to="/campaigns"
112 |             icon={<Megaphone className="h-4 w-4" />}
113 |             label="Kampanie"
114 |             disabled
115 |           />
116 | 
117 |           <Separator className="my-3" />
118 | 
119 |           <div className="py-2">
120 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
121 |               System
122 |             </p>
123 |           </div>
124 |           <NavItem to="/cookies" icon={<Cookie className="h-4 w-4" />} label="Sesje" />
125 |           <NavItem to="/settings" icon={<Settings className="h-4 w-4" />} label="Ustawienia" />
126 |           <NavItem to="/logs" icon={<Terminal className="h-4 w-4" />} label="Logi" />
127 |         </nav>
128 |       </div>
129 |     </div>
130 |   )
131 | }
132 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/badge.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const badgeVariants = cva(
 6 |   'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
 7 |   {
 8 |     variants: {
 9 |       variant: {
10 |         default: 'border-transparent bg-primary text-primary-foreground hover:bg-primary/80',
11 |         secondary: 'border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80',
12 |         destructive: 'border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80',
13 |         outline: 'text-foreground',
14 |         success: 'border-transparent bg-green-600 text-white hover:bg-green-600/80',
15 |         warning: 'border-transparent bg-yellow-600 text-white hover:bg-yellow-600/80',
16 |       },
17 |     },
18 |     defaultVariants: {
19 |       variant: 'default',
20 |     },
21 |   }
22 | )
23 | 
24 | export interface BadgeProps
25 |   extends React.HTMLAttributes<HTMLDivElement>,
26 |     VariantProps<typeof badgeVariants> {}
27 | 
28 | function Badge({ className, variant, ...props }: BadgeProps) {
29 |   return <div className={cn(badgeVariants({ variant }), className)} {...props} />
30 | }
31 | 
32 | export { Badge, badgeVariants }
33 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/button.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const buttonVariants = cva(
 6 |   'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0',
 7 |   {
 8 |     variants: {
 9 |       variant: {
10 |         default: 'bg-primary text-primary-foreground hover:bg-primary/90',
11 |         destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
12 |         outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
13 |         secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
14 |         ghost: 'hover:bg-accent hover:text-accent-foreground',
15 |         link: 'text-primary underline-offset-4 hover:underline',
16 |       },
17 |       size: {
18 |         default: 'h-10 px-4 py-2',
19 |         sm: 'h-9 rounded-md px-3',
20 |         lg: 'h-11 rounded-md px-8',
21 |         icon: 'h-10 w-10',
22 |       },
23 |     },
24 |     defaultVariants: {
25 |       variant: 'default',
26 |       size: 'default',
27 |     },
28 |   }
29 | )
30 | 
31 | export interface ButtonProps
32 |   extends React.ButtonHTMLAttributes<HTMLButtonElement>,
33 |     VariantProps<typeof buttonVariants> {}
34 | 
35 | const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
36 |   ({ className, variant, size, ...props }, ref) => {
37 |     return (
38 |       <button
39 |         className={cn(buttonVariants({ variant, size, className }))}
40 |         ref={ref}
41 |         {...props}
42 |       />
43 |     )
44 |   }
45 | )
46 | Button.displayName = 'Button'
47 | 
48 | export { Button, buttonVariants }
49 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/card.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 5 |   ({ className, ...props }, ref) => (
 6 |     <div
 7 |       ref={ref}
 8 |       className={cn('rounded-lg border bg-card text-card-foreground shadow-sm', className)}
 9 |       {...props}
10 |     />
11 |   )
12 | )
13 | Card.displayName = 'Card'
14 | 
15 | const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
16 |   ({ className, ...props }, ref) => (
17 |     <div ref={ref} className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
18 |   )
19 | )
20 | CardHeader.displayName = 'CardHeader'
21 | 
22 | const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
23 |   ({ className, ...props }, ref) => (
24 |     <h3
25 |       ref={ref}
26 |       className={cn('text-2xl font-semibold leading-none tracking-tight', className)}
27 |       {...props}
28 |     />
29 |   )
30 | )
31 | CardTitle.displayName = 'CardTitle'
32 | 
33 | const CardDescription = React.forwardRef<
34 |   HTMLParagraphElement,
35 |   React.HTMLAttributes<HTMLParagraphElement>
36 | >(({ className, ...props }, ref) => (
37 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
38 | ))
39 | CardDescription.displayName = 'CardDescription'
40 | 
41 | const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
42 |   ({ className, ...props }, ref) => (
43 |     <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
44 |   )
45 | )
46 | CardContent.displayName = 'CardContent'
47 | 
48 | const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
49 |   ({ className, ...props }, ref) => (
50 |     <div ref={ref} className={cn('flex items-center p-6 pt-0', className)} {...props} />
51 |   )
52 | )
53 | CardFooter.displayName = 'CardFooter'
54 | 
55 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
56 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/checkbox.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { Check } from 'lucide-react'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | export interface CheckboxProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
 6 |   onCheckedChange?: (checked: boolean) => void
 7 | }
 8 | 
 9 | const Checkbox = React.forwardRef<HTMLInputElement, CheckboxProps>(
10 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
11 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
12 |       onChange?.(e)
13 |       onCheckedChange?.(e.target.checked)
14 |     }
15 | 
16 |     return (
17 |       <div className="relative inline-flex items-center">
18 |         <input
19 |           type="checkbox"
20 |           ref={ref}
21 |           checked={checked}
22 |           onChange={handleChange}
23 |           className="sr-only peer"
24 |           {...props}
25 |         />
26 |         <div
27 |           className={cn(
28 |             'h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary peer-checked:text-primary-foreground flex items-center justify-center cursor-pointer',
29 |             className
30 |           )}
31 |           onClick={() => {
32 |             const input = ref && 'current' in ref ? ref.current : null
33 |             if (input) {
34 |               input.click()
35 |             }
36 |           }}
37 |         >
38 |           {checked && <Check className="h-3 w-3" />}
39 |         </div>
40 |       </div>
41 |     )
42 |   }
43 | )
44 | Checkbox.displayName = 'Checkbox'
45 | 
46 | export { Checkbox }
47 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/dialog.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import * as React from 'react'
  2 | import { X } from 'lucide-react'
  3 | import { cn } from '@/lib/utils'
  4 | 
  5 | interface DialogContextValue {
  6 |   open: boolean
  7 |   onOpenChange: (open: boolean) => void
  8 | }
  9 | 
 10 | const DialogContext = React.createContext<DialogContextValue | null>(null)
 11 | 
 12 | interface DialogProps {
 13 |   open?: boolean
 14 |   onOpenChange?: (open: boolean) => void
 15 |   children: React.ReactNode
 16 | }
 17 | 
 18 | function Dialog({ open = false, onOpenChange, children }: DialogProps) {
 19 |   const handleOpenChange = React.useCallback(
 20 |     (newOpen: boolean) => {
 21 |       onOpenChange?.(newOpen)
 22 |     },
 23 |     [onOpenChange]
 24 |   )
 25 | 
 26 |   return (
 27 |     <DialogContext.Provider value={{ open, onOpenChange: handleOpenChange }}>
 28 |       {children}
 29 |     </DialogContext.Provider>
 30 |   )
 31 | }
 32 | 
 33 | interface DialogTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
 34 |   asChild?: boolean
 35 | }
 36 | 
 37 | const DialogTrigger = React.forwardRef<HTMLButtonElement, DialogTriggerProps>(
 38 |   ({ onClick, children, ...props }, ref) => {
 39 |     const context = React.useContext(DialogContext)
 40 |     return (
 41 |       <button
 42 |         ref={ref}
 43 |         onClick={(e) => {
 44 |           onClick?.(e)
 45 |           context?.onOpenChange(true)
 46 |         }}
 47 |         {...props}
 48 |       >
 49 |         {children}
 50 |       </button>
 51 |     )
 52 |   }
 53 | )
 54 | DialogTrigger.displayName = 'DialogTrigger'
 55 | 
 56 | interface DialogPortalProps {
 57 |   children: React.ReactNode
 58 | }
 59 | 
 60 | function DialogPortal({ children }: DialogPortalProps) {
 61 |   const context = React.useContext(DialogContext)
 62 |   if (!context?.open) return null
 63 |   return <>{children}</>
 64 | }
 65 | 
 66 | const DialogOverlay = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 67 |   ({ className, ...props }, ref) => {
 68 |     const context = React.useContext(DialogContext)
 69 |     return (
 70 |       <div
 71 |         ref={ref}
 72 |         className={cn(
 73 |           'fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
 74 |           className
 75 |         )}
 76 |         data-state={context?.open ? 'open' : 'closed'}
 77 |         onClick={() => context?.onOpenChange(false)}
 78 |         {...props}
 79 |       />
 80 |     )
 81 |   }
 82 | )
 83 | DialogOverlay.displayName = 'DialogOverlay'
 84 | 
 85 | const DialogContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 86 |   ({ className, children, ...props }, ref) => {
 87 |     const context = React.useContext(DialogContext)
 88 | 
 89 |     React.useEffect(() => {
 90 |       const handleEscape = (e: KeyboardEvent) => {
 91 |         if (e.key === 'Escape') {
 92 |           context?.onOpenChange(false)
 93 |         }
 94 |       }
 95 |       if (context?.open) {
 96 |         document.addEventListener('keydown', handleEscape)
 97 |         return () => document.removeEventListener('keydown', handleEscape)
 98 |       }
 99 |     }, [context])
100 | 
101 |     return (
102 |       <DialogPortal>
103 |         <DialogOverlay />
104 |         <div
105 |           ref={ref}
106 |           className={cn(
107 |             'fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg',
108 |             className
109 |           )}
110 |           data-state={context?.open ? 'open' : 'closed'}
111 |           onClick={(e) => e.stopPropagation()}
112 |           {...props}
113 |         >
114 |           {children}
115 |           <button
116 |             className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none"
117 |             onClick={() => context?.onOpenChange(false)}
118 |           >
119 |             <X className="h-4 w-4" />
120 |             <span className="sr-only">Zamknij</span>
121 |           </button>
122 |         </div>
123 |       </DialogPortal>
124 |     )
125 |   }
126 | )
127 | DialogContent.displayName = 'DialogContent'
128 | 
129 | const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
130 |   <div className={cn('flex flex-col space-y-1.5 text-center sm:text-left', className)} {...props} />
131 | )
132 | DialogHeader.displayName = 'DialogHeader'
133 | 
134 | const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
135 |   <div
136 |     className={cn('flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2', className)}
137 |     {...props}
138 |   />
139 | )
140 | DialogFooter.displayName = 'DialogFooter'
141 | 
142 | const DialogTitle = React.forwardRef<
143 |   HTMLHeadingElement,
144 |   React.HTMLAttributes<HTMLHeadingElement>
145 | >(({ className, ...props }, ref) => (
146 |   <h2
147 |     ref={ref}
148 |     className={cn('text-lg font-semibold leading-none tracking-tight', className)}
149 |     {...props}
150 |   />
151 | ))
152 | DialogTitle.displayName = 'DialogTitle'
153 | 
154 | const DialogDescription = React.forwardRef<
155 |   HTMLParagraphElement,
156 |   React.HTMLAttributes<HTMLParagraphElement>
157 | >(({ className, ...props }, ref) => (
158 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
159 | ))
160 | DialogDescription.displayName = 'DialogDescription'
161 | 
162 | export {
163 |   Dialog,
164 |   DialogPortal,
165 |   DialogOverlay,
166 |   DialogTrigger,
167 |   DialogContent,
168 |   DialogHeader,
169 |   DialogFooter,
170 |   DialogTitle,
171 |   DialogDescription,
172 | }
173 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/input.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {}
 5 | 
 6 | const Input = React.forwardRef<HTMLInputElement, InputProps>(
 7 |   ({ className, type, ...props }, ref) => {
 8 |     return (
 9 |       <input
10 |         type={type}
11 |         className={cn(
12 |           'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
13 |           className
14 |         )}
15 |         ref={ref}
16 |         {...props}
17 |       />
18 |     )
19 |   }
20 | )
21 | Input.displayName = 'Input'
22 | 
23 | export { Input }
24 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/label.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const labelVariants = cva(
 6 |   'text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70'
 7 | )
 8 | 
 9 | export interface LabelProps
10 |   extends React.LabelHTMLAttributes<HTMLLabelElement>,
11 |     VariantProps<typeof labelVariants> {}
12 | 
13 | const Label = React.forwardRef<HTMLLabelElement, LabelProps>(
14 |   ({ className, ...props }, ref) => (
15 |     <label ref={ref} className={cn(labelVariants(), className)} {...props} />
16 |   )
17 | )
18 | Label.displayName = 'Label'
19 | 
20 | export { Label }
21 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/separator.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | interface SeparatorProps extends React.HTMLAttributes<HTMLDivElement> {
 5 |   orientation?: 'horizontal' | 'vertical'
 6 |   decorative?: boolean
 7 | }
 8 | 
 9 | const Separator = React.forwardRef<HTMLDivElement, SeparatorProps>(
10 |   ({ className, orientation = 'horizontal', decorative = true, ...props }, ref) => (
11 |     <div
12 |       ref={ref}
13 |       role={decorative ? 'none' : 'separator'}
14 |       aria-orientation={decorative ? undefined : orientation}
15 |       className={cn(
16 |         'shrink-0 bg-border',
17 |         orientation === 'horizontal' ? 'h-[1px] w-full' : 'h-full w-[1px]',
18 |         className
19 |       )}
20 |       {...props}
21 |     />
22 |   )
23 | )
24 | Separator.displayName = 'Separator'
25 | 
26 | export { Separator }
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/switch.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface SwitchProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
 5 |   onCheckedChange?: (checked: boolean) => void
 6 | }
 7 | 
 8 | const Switch = React.forwardRef<HTMLInputElement, SwitchProps>(
 9 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
10 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
11 |       onChange?.(e)
12 |       onCheckedChange?.(e.target.checked)
13 |     }
14 | 
15 |     return (
16 |       <label className="relative inline-flex cursor-pointer items-center">
17 |         <input
18 |           type="checkbox"
19 |           ref={ref}
20 |           checked={checked}
21 |           onChange={handleChange}
22 |           className="sr-only peer"
23 |           {...props}
24 |         />
25 |         <div
26 |           className={cn(
27 |             'peer h-6 w-11 rounded-full bg-input ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary',
28 |             className
29 |           )}
30 |         >
31 |           <div
32 |             className={cn(
33 |               'absolute left-[2px] top-[2px] h-5 w-5 rounded-full bg-background transition-transform',
34 |               checked && 'translate-x-5'
35 |             )}
36 |           />
37 |         </div>
38 |       </label>
39 |     )
40 |   }
41 | )
42 | Switch.displayName = 'Switch'
43 | 
44 | export { Switch }
45 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/table.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import * as React from 'react'
  2 | import { cn } from '@/lib/utils'
  3 | 
  4 | const Table = React.forwardRef<HTMLTableElement, React.HTMLAttributes<HTMLTableElement>>(
  5 |   ({ className, ...props }, ref) => (
  6 |     <div className="relative w-full overflow-auto">
  7 |       <table
  8 |         ref={ref}
  9 |         className={cn('w-full caption-bottom text-sm', className)}
 10 |         {...props}
 11 |       />
 12 |     </div>
 13 |   )
 14 | )
 15 | Table.displayName = 'Table'
 16 | 
 17 | const TableHeader = React.forwardRef<
 18 |   HTMLTableSectionElement,
 19 |   React.HTMLAttributes<HTMLTableSectionElement>
 20 | >(({ className, ...props }, ref) => (
 21 |   <thead ref={ref} className={cn('[&_tr]:border-b', className)} {...props} />
 22 | ))
 23 | TableHeader.displayName = 'TableHeader'
 24 | 
 25 | const TableBody = React.forwardRef<
 26 |   HTMLTableSectionElement,
 27 |   React.HTMLAttributes<HTMLTableSectionElement>
 28 | >(({ className, ...props }, ref) => (
 29 |   <tbody ref={ref} className={cn('[&_tr:last-child]:border-0', className)} {...props} />
 30 | ))
 31 | TableBody.displayName = 'TableBody'
 32 | 
 33 | const TableFooter = React.forwardRef<
 34 |   HTMLTableSectionElement,
 35 |   React.HTMLAttributes<HTMLTableSectionElement>
 36 | >(({ className, ...props }, ref) => (
 37 |   <tfoot
 38 |     ref={ref}
 39 |     className={cn('border-t bg-muted/50 font-medium [&>tr]:last:border-b-0', className)}
 40 |     {...props}
 41 |   />
 42 | ))
 43 | TableFooter.displayName = 'TableFooter'
 44 | 
 45 | const TableRow = React.forwardRef<HTMLTableRowElement, React.HTMLAttributes<HTMLTableRowElement>>(
 46 |   ({ className, ...props }, ref) => (
 47 |     <tr
 48 |       ref={ref}
 49 |       className={cn(
 50 |         'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted',
 51 |         className
 52 |       )}
 53 |       {...props}
 54 |     />
 55 |   )
 56 | )
 57 | TableRow.displayName = 'TableRow'
 58 | 
 59 | const TableHead = React.forwardRef<
 60 |   HTMLTableCellElement,
 61 |   React.ThHTMLAttributes<HTMLTableCellElement>
 62 | >(({ className, ...props }, ref) => (
 63 |   <th
 64 |     ref={ref}
 65 |     className={cn(
 66 |       'h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0',
 67 |       className
 68 |     )}
 69 |     {...props}
 70 |   />
 71 | ))
 72 | TableHead.displayName = 'TableHead'
 73 | 
 74 | const TableCell = React.forwardRef<
 75 |   HTMLTableCellElement,
 76 |   React.TdHTMLAttributes<HTMLTableCellElement>
 77 | >(({ className, ...props }, ref) => (
 78 |   <td
 79 |     ref={ref}
 80 |     className={cn('p-4 align-middle [&:has([role=checkbox])]:pr-0', className)}
 81 |     {...props}
 82 |   />
 83 | ))
 84 | TableCell.displayName = 'TableCell'
 85 | 
 86 | const TableCaption = React.forwardRef<
 87 |   HTMLTableCaptionElement,
 88 |   React.HTMLAttributes<HTMLTableCaptionElement>
 89 | >(({ className, ...props }, ref) => (
 90 |   <caption ref={ref} className={cn('mt-4 text-sm text-muted-foreground', className)} {...props} />
 91 | ))
 92 | TableCaption.displayName = 'TableCaption'
 93 | 
 94 | export {
 95 |   Table,
 96 |   TableHeader,
 97 |   TableBody,
 98 |   TableFooter,
 99 |   TableHead,
100 |   TableRow,
101 |   TableCell,
102 |   TableCaption,
103 | }
104 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/tabs.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import * as React from 'react'
  2 | import { cn } from '@/lib/utils'
  3 | 
  4 | interface TabsContextValue {
  5 |   value: string
  6 |   onValueChange: (value: string) => void
  7 | }
  8 | 
  9 | const TabsContext = React.createContext<TabsContextValue | null>(null)
 10 | 
 11 | interface TabsProps extends React.HTMLAttributes<HTMLDivElement> {
 12 |   value?: string
 13 |   defaultValue?: string
 14 |   onValueChange?: (value: string) => void
 15 | }
 16 | 
 17 | const Tabs = React.forwardRef<HTMLDivElement, TabsProps>(
 18 |   ({ className, value, defaultValue, onValueChange, children, ...props }, ref) => {
 19 |     const [internalValue, setInternalValue] = React.useState(defaultValue || '')
 20 |     const currentValue = value !== undefined ? value : internalValue
 21 | 
 22 |     const handleValueChange = React.useCallback(
 23 |       (newValue: string) => {
 24 |         if (value === undefined) {
 25 |           setInternalValue(newValue)
 26 |         }
 27 |         onValueChange?.(newValue)
 28 |       },
 29 |       [value, onValueChange]
 30 |     )
 31 | 
 32 |     return (
 33 |       <TabsContext.Provider value={{ value: currentValue, onValueChange: handleValueChange }}>
 34 |         <div ref={ref} className={cn('', className)} {...props}>
 35 |           {children}
 36 |         </div>
 37 |       </TabsContext.Provider>
 38 |     )
 39 |   }
 40 | )
 41 | Tabs.displayName = 'Tabs'
 42 | 
 43 | const TabsList = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 44 |   ({ className, ...props }, ref) => (
 45 |     <div
 46 |       ref={ref}
 47 |       className={cn(
 48 |         'inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground',
 49 |         className
 50 |       )}
 51 |       {...props}
 52 |     />
 53 |   )
 54 | )
 55 | TabsList.displayName = 'TabsList'
 56 | 
 57 | interface TabsTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
 58 |   value: string
 59 | }
 60 | 
 61 | const TabsTrigger = React.forwardRef<HTMLButtonElement, TabsTriggerProps>(
 62 |   ({ className, value, ...props }, ref) => {
 63 |     const context = React.useContext(TabsContext)
 64 |     const isActive = context?.value === value
 65 | 
 66 |     return (
 67 |       <button
 68 |         ref={ref}
 69 |         className={cn(
 70 |           'inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
 71 |           isActive && 'bg-background text-foreground shadow-sm',
 72 |           className
 73 |         )}
 74 |         onClick={() => context?.onValueChange(value)}
 75 |         data-state={isActive ? 'active' : 'inactive'}
 76 |         {...props}
 77 |       />
 78 |     )
 79 |   }
 80 | )
 81 | TabsTrigger.displayName = 'TabsTrigger'
 82 | 
 83 | interface TabsContentProps extends React.HTMLAttributes<HTMLDivElement> {
 84 |   value: string
 85 | }
 86 | 
 87 | const TabsContent = React.forwardRef<HTMLDivElement, TabsContentProps>(
 88 |   ({ className, value, ...props }, ref) => {
 89 |     const context = React.useContext(TabsContext)
 90 |     const isActive = context?.value === value
 91 | 
 92 |     if (!isActive) return null
 93 | 
 94 |     return (
 95 |       <div
 96 |         ref={ref}
 97 |         className={cn(
 98 |           'mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
 99 |           className
100 |         )}
101 |         data-state={isActive ? 'active' : 'inactive'}
102 |         {...props}
103 |       />
104 |     )
105 |   }
106 | )
107 | TabsContent.displayName = 'TabsContent'
108 | 
109 | export { Tabs, TabsList, TabsTrigger, TabsContent }
110 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/textarea.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}
 5 | 
 6 | const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
 7 |   ({ className, ...props }, ref) => {
 8 |     return (
 9 |       <textarea
10 |         className={cn(
11 |           'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
12 |           className
13 |         )}
14 |         ref={ref}
15 |         {...props}
16 |       />
17 |     )
18 |   }
19 | )
20 | Textarea.displayName = 'Textarea'
21 | 
22 | export { Textarea }
23 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useApi.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
 1 | import { useState, useCallback } from 'react'
 2 | 
 3 | interface UseApiOptions<T> {
 4 |   onSuccess?: (data: T) => void
 5 |   onError?: (error: string) => void
 6 | }
 7 | 
 8 | interface UseApiResult<T, Args extends unknown[]> {
 9 |   data: T | null
10 |   loading: boolean
11 |   error: string | null
12 |   execute: (...args: Args) => Promise<T | null>
13 |   reset: () => void
14 | }
15 | 
16 | export function useApi<T, Args extends unknown[] = []>(
17 |   apiFn: (...args: Args) => Promise<T & { ok: boolean; error?: string }>,
18 |   options: UseApiOptions<T> = {}
19 | ): UseApiResult<T, Args> {
20 |   const [data, setData] = useState<T | null>(null)
21 |   const [loading, setLoading] = useState(false)
22 |   const [error, setError] = useState<string | null>(null)
23 | 
24 |   const execute = useCallback(
25 |     async (...args: Args): Promise<T | null> => {
26 |       setLoading(true)
27 |       setError(null)
28 | 
29 |       try {
30 |         const result = await apiFn(...args)
31 |         if (result.ok) {
32 |           setData(result)
33 |           options.onSuccess?.(result)
34 |           return result
35 |         } else {
36 |           const errorMsg = result.error || 'Unknown error'
37 |           setError(errorMsg)
38 |           options.onError?.(errorMsg)
39 |           return null
40 |         }
41 |       } catch (err) {
42 |         const errorMsg = err instanceof Error ? err.message : 'Network error'
43 |         setError(errorMsg)
44 |         options.onError?.(errorMsg)
45 |         return null
46 |       } finally {
47 |         setLoading(false)
48 |       }
49 |     },
50 |     [apiFn, options]
51 |   )
52 | 
53 |   const reset = useCallback(() => {
54 |     setData(null)
55 |     setError(null)
56 |     setLoading(false)
57 |   }, [])
58 | 
59 |   return { data, loading, error, execute, reset }
60 | }
61 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useAuth.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { createContext, useContext, useState, useCallback, ReactNode } from 'react'
 2 | import { getToken, setToken as saveToken } from '@/lib/api'
 3 | 
 4 | interface AuthContextValue {
 5 |   token: string
 6 |   setToken: (token: string) => void
 7 |   isAuthenticated: boolean
 8 | }
 9 | 
10 | const AuthContext = createContext<AuthContextValue | null>(null)
11 | 
12 | export function AuthProvider({ children }: { children: ReactNode }) {
13 |   const [token, setTokenState] = useState(() => getToken())
14 | 
15 |   const setToken = useCallback((newToken: string) => {
16 |     saveToken(newToken)
17 |     setTokenState(newToken)
18 |   }, [])
19 | 
20 |   const value: AuthContextValue = {
21 |     token,
22 |     setToken,
23 |     isAuthenticated: token.length > 0,
24 |   }
25 | 
26 |   return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
27 | }
28 | 
29 | export function useAuth() {
30 |   const context = useContext(AuthContext)
31 |   if (!context) {
32 |     throw new Error('useAuth must be used within AuthProvider')
33 |   }
34 |   return context
35 | }
36 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useLogs.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
 1 | import { useState, useCallback, useRef, useEffect } from 'react'
 2 | import { getLogsOut, getLogsErr } from '@/lib/api'
 3 | 
 4 | type LogMode = 'out' | 'err'
 5 | 
 6 | interface UseLogsResult {
 7 |   logs: string
 8 |   loading: boolean
 9 |   error: string | null
10 |   mode: LogMode
11 |   autoRefresh: number
12 |   setAutoRefresh: (interval: number) => void
13 |   loadLogs: (mode?: LogMode, lines?: number) => Promise<void>
14 |   setMode: (mode: LogMode) => void
15 | }
16 | 
17 | export function useLogs(initialLines = 200): UseLogsResult {
18 |   const [logs, setLogs] = useState('')
19 |   const [loading, setLoading] = useState(false)
20 |   const [error, setError] = useState<string | null>(null)
21 |   const [mode, setMode] = useState<LogMode>('out')
22 |   const [autoRefresh, setAutoRefresh] = useState(0)
23 |   const intervalRef = useRef<number | null>(null)
24 | 
25 |   const loadLogs = useCallback(
26 |     async (logMode?: LogMode, lines = initialLines) => {
27 |       const targetMode = logMode ?? mode
28 |       setLoading(true)
29 |       setError(null)
30 | 
31 |       try {
32 |         const fn = targetMode === 'out' ? getLogsOut : getLogsErr
33 |         const result = await fn(lines)
34 | 
35 |         if (result.ok && result.log) {
36 |           // Strip ANSI codes
37 |           const cleanLog = result.log.replace(/\x1b\[[0-9;]*m/g, '')
38 |           setLogs(cleanLog)
39 |         } else {
40 |           setError(result.error || 'Nie udalo sie wczytac logow')
41 |           setLogs('')
42 |         }
43 |       } catch (err) {
44 |         setError(err instanceof Error ? err.message : 'Blad sieci')
45 |         setLogs('')
46 |       } finally {
47 |         setLoading(false)
48 |       }
49 |     },
50 |     [mode, initialLines]
51 |   )
52 | 
53 |   // Handle auto-refresh
54 |   useEffect(() => {
55 |     if (intervalRef.current) {
56 |       clearInterval(intervalRef.current)
57 |       intervalRef.current = null
58 |     }
59 | 
60 |     if (autoRefresh > 0) {
61 |       intervalRef.current = window.setInterval(() => {
62 |         loadLogs()
63 |       }, autoRefresh)
64 |     }
65 | 
66 |     return () => {
67 |       if (intervalRef.current) {
68 |         clearInterval(intervalRef.current)
69 |       }
70 |     }
71 |   }, [autoRefresh, loadLogs])
72 | 
73 |   const handleModeChange = useCallback(
74 |     (newMode: LogMode) => {
75 |       setMode(newMode)
76 |       loadLogs(newMode)
77 |     },
78 |     [loadLogs]
79 |   )
80 | 
81 |   return {
82 |     logs,
83 |     loading,
84 |     error,
85 |     mode,
86 |     autoRefresh,
87 |     setAutoRefresh,
88 |     loadLogs,
89 |     setMode: handleModeChange,
90 |   }
91 | }
92 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/index.css`
**Typ:** CSS  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```css
 1 | @tailwind base;
 2 | @tailwind components;
 3 | @tailwind utilities;
 4 | 
 5 | @layer base {
 6 |   :root {
 7 |     --background: 0 0% 100%;
 8 |     --foreground: 222.2 84% 4.9%;
 9 |     --card: 0 0% 100%;
10 |     --card-foreground: 222.2 84% 4.9%;
11 |     --popover: 0 0% 100%;
12 |     --popover-foreground: 222.2 84% 4.9%;
13 |     --primary: 222.2 47.4% 11.2%;
14 |     --primary-foreground: 210 40% 98%;
15 |     --secondary: 210 40% 96.1%;
16 |     --secondary-foreground: 222.2 47.4% 11.2%;
17 |     --muted: 210 40% 96.1%;
18 |     --muted-foreground: 215.4 16.3% 46.9%;
19 |     --accent: 210 40% 96.1%;
20 |     --accent-foreground: 222.2 47.4% 11.2%;
21 |     --destructive: 0 84.2% 60.2%;
22 |     --destructive-foreground: 210 40% 98%;
23 |     --border: 214.3 31.8% 91.4%;
24 |     --input: 214.3 31.8% 91.4%;
25 |     --ring: 222.2 84% 4.9%;
26 |     --radius: 0.5rem;
27 |   }
28 | 
29 |   .dark {
30 |     --background: 222.2 84% 4.9%;
31 |     --foreground: 210 40% 98%;
32 |     --card: 222.2 84% 4.9%;
33 |     --card-foreground: 210 40% 98%;
34 |     --popover: 222.2 84% 4.9%;
35 |     --popover-foreground: 210 40% 98%;
36 |     --primary: 210 40% 98%;
37 |     --primary-foreground: 222.2 47.4% 11.2%;
38 |     --secondary: 217.2 32.6% 17.5%;
39 |     --secondary-foreground: 210 40% 98%;
40 |     --muted: 217.2 32.6% 17.5%;
41 |     --muted-foreground: 215 20.2% 65.1%;
42 |     --accent: 217.2 32.6% 17.5%;
43 |     --accent-foreground: 210 40% 98%;
44 |     --destructive: 0 62.8% 30.6%;
45 |     --destructive-foreground: 210 40% 98%;
46 |     --border: 217.2 32.6% 17.5%;
47 |     --input: 217.2 32.6% 17.5%;
48 |     --ring: 212.7 26.8% 83.9%;
49 |   }
50 | }
51 | 
52 | @layer base {
53 |   * {
54 |     @apply border-border;
55 |   }
56 |   body {
57 |     @apply bg-background text-foreground;
58 |   }
59 | }
60 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/api.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
  1 | import type {
  2 |   SystemStatus,
  3 |   PostsResponse,
  4 |   EnvResponse,
  5 |   LogsResponse,
  6 |   Post,
  7 |   SessionStatus,
  8 | } from './types'
  9 | 
 10 | const TOKEN_KEY = 'FBW_PANEL_TOKEN'
 11 | 
 12 | export function getToken(): string {
 13 |   return localStorage.getItem(TOKEN_KEY) || ''
 14 | }
 15 | 
 16 | export function setToken(token: string): void {
 17 |   localStorage.setItem(TOKEN_KEY, token)
 18 | }
 19 | 
 20 | function getAuthHeaders(): HeadersInit {
 21 |   const token = getToken()
 22 |   return token ? { Authorization: `Bearer ${token}` } : {}
 23 | }
 24 | 
 25 | async function request<T>(
 26 |   path: string,
 27 |   options: RequestInit = {}
 28 | ): Promise<T & { ok: boolean; error?: string }> {
 29 |   const headers: Record<string, string> = {
 30 |     ...(getAuthHeaders() as Record<string, string>),
 31 |     ...((options.headers || {}) as Record<string, string>),
 32 |   }
 33 | 
 34 |   if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
 35 |     headers['Content-Type'] = 'application/json'
 36 |     options.body = JSON.stringify(options.body)
 37 |   }
 38 | 
 39 |   try {
 40 |     const res = await fetch(path, {
 41 |       ...options,
 42 |       headers,
 43 |     })
 44 | 
 45 |     const text = await res.text()
 46 |     let data: T & { ok: boolean; error?: string }
 47 | 
 48 |     try {
 49 |       data = JSON.parse(text)
 50 |     } catch {
 51 |       data = { ok: false, error: text || `HTTP ${res.status}` } as T & { ok: boolean; error?: string }
 52 |     }
 53 | 
 54 |     if (!res.ok && data.ok !== false) {
 55 |       data.ok = false
 56 |       data.error = data.error || `HTTP ${res.status}`
 57 |     }
 58 | 
 59 |     return data
 60 |   } catch (err) {
 61 |     return { ok: false, error: err instanceof Error ? err.message : 'Network error' } as T & { ok: boolean; error?: string }
 62 |   }
 63 | }
 64 | 
 65 | // Status
 66 | export async function getStatus(): Promise<SystemStatus & { ok: boolean; error?: string }> {
 67 |   return request<SystemStatus>('/api/status')
 68 | }
 69 | 
 70 | // Env
 71 | export async function getEnv(): Promise<EnvResponse> {
 72 |   return request<EnvResponse>('/api/env/get')
 73 | }
 74 | 
 75 | export async function setEnv(set: Record<string, string>, restart = false): Promise<{ ok: boolean; error?: string }> {
 76 |   return request('/api/env/set', {
 77 |     method: 'POST',
 78 |     body: JSON.stringify({ set, restart }),
 79 |   })
 80 | }
 81 | 
 82 | // Posts
 83 | export async function getPosts(): Promise<PostsResponse> {
 84 |   return request<PostsResponse>('/api/posts')
 85 | }
 86 | 
 87 | export async function addPost(post: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
 88 |   return request('/api/posts', {
 89 |     method: 'POST',
 90 |     body: JSON.stringify(post),
 91 |   })
 92 | }
 93 | 
 94 | export async function updatePost(id: string, data: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
 95 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
 96 |     method: 'PATCH',
 97 |     body: JSON.stringify(data),
 98 |   })
 99 | }
100 | 
101 | export async function deletePost(id: string): Promise<{ ok: boolean; error?: string }> {
102 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
103 |     method: 'DELETE',
104 |   })
105 | }
106 | 
107 | // PM2
108 | export async function pm2Start(): Promise<{ ok: boolean; output?: string; error?: string }> {
109 |   return request('/api/pm2/start', { method: 'POST' })
110 | }
111 | 
112 | export async function pm2Stop(): Promise<{ ok: boolean; output?: string; error?: string }> {
113 |   return request('/api/pm2/stop', { method: 'POST' })
114 | }
115 | 
116 | export async function pm2Restart(): Promise<{ ok: boolean; output?: string; error?: string }> {
117 |   return request('/api/pm2/restart', { method: 'POST' })
118 | }
119 | 
120 | export async function pm2Status(): Promise<{ ok: boolean; output?: string; error?: string }> {
121 |   return request('/api/pm2/status')
122 | }
123 | 
124 | // Logs
125 | export async function getLogsOut(lines = 200): Promise<LogsResponse> {
126 |   return request<LogsResponse>(`/api/logs/out?lines=${lines}`)
127 | }
128 | 
129 | export async function getLogsErr(lines = 200): Promise<LogsResponse> {
130 |   return request<LogsResponse>(`/api/logs/err?lines=${lines}`)
131 | }
132 | 
133 | // Cookies
134 | export async function clearCookies(): Promise<{ ok: boolean; error?: string }> {
135 |   return request('/api/cookies/clear', {
136 |     method: 'POST',
137 |     body: JSON.stringify({ confirm: true }),
138 |   })
139 | }
140 | 
141 | export async function getCookiesStatus(): Promise<SessionStatus & { ok: boolean; error?: string }> {
142 |   return request<SessionStatus>('/api/cookies/status')
143 | }
144 | 
145 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/types.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
  1 | // Post monitorowany
  2 | export interface Post {
  3 |   id: string
  4 |   url: string
  5 |   active: boolean
  6 |   name: string
  7 |   image: string
  8 |   description: string
  9 |   createdAt: string
 10 |   updatedAt: string
 11 | }
 12 | 
 13 | // Status systemu
 14 | export interface SystemStatus {
 15 |   ok: boolean
 16 |   projectDir: string
 17 |   envPath: string
 18 |   cookiesPath: string
 19 |   postsPath: string
 20 |   node: string
 21 |   pm2: string
 22 |   pm2Status: string
 23 |   time: string
 24 | }
 25 | 
 26 | // Ustawienia .env
 27 | export interface EnvValues {
 28 |   // Facebook
 29 |   FB_EMAIL: string
 30 |   FB_PASSWORD: string
 31 |   // Watcher
 32 |   CHECK_INTERVAL_MS: string
 33 |   FAST_MODE: string
 34 |   INCLUDE_REPLIES: string
 35 |   // Logi
 36 |   LOG_LEVEL: string
 37 |   // Puppeteer
 38 |   HEADLESS_BROWSER: string
 39 |   USE_UI_HANDLERS: string
 40 |   COOKIES_READ_ONLY: string
 41 |   // ≈πr√≥d≈Ça post√≥w
 42 |   POSTS_SHEET_URL: string
 43 |   POSTS_API_URL: string
 44 |   POSTS_API_TOKEN: string
 45 |   // Telegram Owner
 46 |   TELEGRAM_SEND_TO_OWNER: string
 47 |   TELEGRAM_BOT_TOKEN_OWNER: string
 48 |   TELEGRAM_CHAT_ID_OWNER: string
 49 |   // Telegram Client
 50 |   TELEGRAM_SEND_TO_CLIENT: string
 51 |   TELEGRAM_BOT_TOKEN_CLIENT: string
 52 |   TELEGRAM_CHAT_ID_CLIENT: string
 53 |   // Telegram Format
 54 |   TELEGRAM_USE_PHOTO: string
 55 |   TELEGRAM_DISABLE_WEB_PAGE_PREVIEW: string
 56 |   // Telegram Alerty
 57 |   TG_ALERTS_ENABLED: string
 58 |   TG_ALERTS_COOLDOWN_SEC: string
 59 |   TG_ALERTS_MAXLEN: string
 60 |   // Legacy
 61 |   WEBHOOK_URL: string
 62 | }
 63 | 
 64 | // Status sesji cookies
 65 | export interface SessionStatus {
 66 |   mainCookiesExists: boolean
 67 |   mainCookiesAge?: number
 68 |   mainCookiesSize?: number
 69 |   isLoggedIn?: boolean
 70 | }
 71 | 
 72 | // ≈πr√≥d≈Ço monitorowania (przysz≈Ço≈õƒá)
 73 | export interface Source {
 74 |   id: string
 75 |   type: 'home_feed' | 'group' | 'meta_ads'
 76 |   name: string
 77 |   keywords: string[]
 78 |   active: boolean
 79 |   groupUrl?: string
 80 | }
 81 | 
 82 | // Wykrycie do zatwierdzenia (przysz≈Ço≈õƒá)
 83 | export interface Discovery {
 84 |   id: string
 85 |   sourceId: string
 86 |   postUrl: string
 87 |   content: string
 88 |   status: 'pending' | 'approved' | 'rejected'
 89 |   matchedKeywords: string[]
 90 |   discoveredAt: string
 91 | }
 92 | 
 93 | // API Response types
 94 | export interface ApiResponse<T = unknown> {
 95 |   ok: boolean
 96 |   error?: string
 97 |   data?: T
 98 | }
 99 | 
100 | export interface PostsResponse {
101 |   ok: boolean
102 |   posts: Post[]
103 |   error?: string
104 | }
105 | 
106 | export interface EnvResponse {
107 |   ok: boolean
108 |   values: EnvValues
109 |   error?: string
110 | }
111 | 
112 | export interface LogsResponse {
113 |   ok: boolean
114 |   log?: string
115 |   path?: string
116 |   error?: string
117 |   source?: string
118 | }
119 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/utils.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
1 | import { type ClassValue, clsx } from 'clsx'
2 | import { twMerge } from 'tailwind-merge'
3 | 
4 | export function cn(...inputs: ClassValue[]) {
5 |   return twMerge(clsx(inputs))
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/main.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { StrictMode } from 'react'
 2 | import { createRoot } from 'react-dom/client'
 3 | import './index.css'
 4 | import App from './App'
 5 | 
 6 | createRoot(document.getElementById('root')!).render(
 7 |   <StrictMode>
 8 |     <App />
 9 |   </StrictMode>,
10 | )
11 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Campaigns.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Megaphone, Clock } from 'lucide-react'
 3 | 
 4 | export function Campaigns() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Megaphone className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Kampanie</CardTitle>
15 |               <CardDescription>Automatyzacja odpowiedzi na komentarze</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na automatyczne odpowiadanie na wykryte komentarze
25 |               wedlug zdefiniowanych regul i szablonow.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Tworzenie kampanii z szablonami odpowiedzi</li>
38 |             <li>‚Ä¢ Reguly triggerowan (slowa kluczowe, czas)</li>
39 |             <li>‚Ä¢ Harmonogram wysylki</li>
40 |             <li>‚Ä¢ A/B testy odpowiedzi</li>
41 |             <li>‚Ä¢ Statystyki skutecznosci</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Cookies.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { useEffect, useState, useCallback } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import {
  5 |   Dialog,
  6 |   DialogContent,
  7 |   DialogDescription,
  8 |   DialogFooter,
  9 |   DialogHeader,
 10 |   DialogTitle,
 11 | } from '@/components/ui/dialog'
 12 | import {
 13 |   Cookie,
 14 |   RefreshCw,
 15 |   Trash2,
 16 |   CheckCircle,
 17 |   XCircle,
 18 |   AlertTriangle,
 19 |   HardDrive,
 20 | } from 'lucide-react'
 21 | import { getCookiesStatus, clearCookies } from '@/lib/api'
 22 | import type { SessionStatus } from '@/lib/types'
 23 | 
 24 | function formatAge(hours: number): string {
 25 |   if (hours < 1) return 'teraz'
 26 |   if (hours < 24) return `${Math.round(hours)}h temu`
 27 |   const days = Math.floor(hours / 24)
 28 |   return `${days}d temu`
 29 | }
 30 | 
 31 | function formatSize(bytes: number): string {
 32 |   if (bytes < 1024) return `${bytes} B`
 33 |   return `${(bytes / 1024).toFixed(1)} KB`
 34 | }
 35 | 
 36 | export function Cookies() {
 37 |   const [status, setStatus] = useState<SessionStatus | null>(null)
 38 |   const [loading, setLoading] = useState(false)
 39 |   const [error, setError] = useState<string | null>(null)
 40 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
 41 | 
 42 |   // Dialog states
 43 |   const [clearDialogOpen, setClearDialogOpen] = useState(false)
 44 |   const [actionLoading, setActionLoading] = useState(false)
 45 | 
 46 |   const showMessage = (text: string, type: 'success' | 'error') => {
 47 |     setMessage({ text, type })
 48 |     setTimeout(() => setMessage(null), 4000)
 49 |   }
 50 | 
 51 |   const loadStatus = useCallback(async () => {
 52 |     setLoading(true)
 53 |     setError(null)
 54 |     try {
 55 |       const result = await getCookiesStatus()
 56 |       if (result.ok) {
 57 |         setStatus(result)
 58 |       } else {
 59 |         setError(result.error || 'Nie udalo sie pobrac statusu cookies')
 60 |       }
 61 |     } catch {
 62 |       setError('Blad polaczenia')
 63 |     } finally {
 64 |       setLoading(false)
 65 |     }
 66 |   }, [])
 67 | 
 68 |   useEffect(() => {
 69 |     loadStatus()
 70 |   }, [loadStatus])
 71 | 
 72 |   const handleClear = async () => {
 73 |     setActionLoading(true)
 74 |     try {
 75 |       const result = await clearCookies()
 76 |       if (result.ok) {
 77 |         showMessage('Cookies wyczyszczone', 'success')
 78 |         setClearDialogOpen(false)
 79 |         loadStatus()
 80 |       } else {
 81 |         showMessage(result.error || 'Nie udalo sie wyczyscic cookies', 'error')
 82 |       }
 83 |     } catch {
 84 |       showMessage('Blad polaczenia', 'error')
 85 |     } finally {
 86 |       setActionLoading(false)
 87 |     }
 88 |   }
 89 | 
 90 |   return (
 91 |     <div className="flex flex-col gap-4">
 92 |       {message && (
 93 |         <div
 94 |           className={`p-3 rounded-md text-sm ${
 95 |             message.type === 'success'
 96 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
 97 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
 98 |           }`}
 99 |         >
100 |           {message.text}
101 |         </div>
102 |       )}
103 | 
104 |       {error && (
105 |         <Card className="border-destructive">
106 |           <CardContent className="pt-6">
107 |             <p className="text-destructive">{error}</p>
108 |           </CardContent>
109 |         </Card>
110 |       )}
111 | 
112 |       {/* Status */}
113 |       <Card>
114 |         <CardHeader className="flex flex-row items-center justify-between">
115 |           <div>
116 |             <CardTitle>Status sesji</CardTitle>
117 |             <CardDescription>Informacje o aktualnych cookies</CardDescription>
118 |           </div>
119 |           <Button variant="outline" size="sm" onClick={loadStatus} disabled={loading}>
120 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
121 |             Odswiez
122 |           </Button>
123 |         </CardHeader>
124 |         <CardContent>
125 |           {status && (
126 |             <div className="space-y-4">
127 |               <div className="flex items-center gap-3">
128 |                 <div className="flex items-center gap-2">
129 |                   {status.isLoggedIn ? (
130 |                     <>
131 |                       <CheckCircle className="h-5 w-5 text-green-500" />
132 |                       <span className="font-medium">Zalogowany</span>
133 |                     </>
134 |                   ) : status.mainCookiesExists ? (
135 |                     <>
136 |                       <AlertTriangle className="h-5 w-5 text-yellow-500" />
137 |                       <span className="font-medium">Cookies istnieja (status nieznany)</span>
138 |                     </>
139 |                   ) : (
140 |                     <>
141 |                       <XCircle className="h-5 w-5 text-red-500" />
142 |                       <span className="font-medium">Brak cookies</span>
143 |                     </>
144 |                   )}
145 |                 </div>
146 |               </div>
147 | 
148 |               <div className="text-sm text-muted-foreground">
149 |                 {status.mainCookiesAge !== undefined && (
150 |                   <p>Wiek: {formatAge(status.mainCookiesAge)}</p>
151 |                 )}
152 |                 {status.mainCookiesSize !== undefined && (
153 |                   <p>Rozmiar: {formatSize(status.mainCookiesSize)}</p>
154 |                 )}
155 |               </div>
156 |             </div>
157 |           )}
158 |         </CardContent>
159 |       </Card>
160 | 
161 |       {/* Main cookies */}
162 |       <Card>
163 |         <CardHeader>
164 |           <CardTitle className="text-lg flex items-center gap-2">
165 |             <Cookie className="h-5 w-5" />
166 |             Plik cookies
167 |           </CardTitle>
168 |         </CardHeader>
169 |         <CardContent>
170 |           <div className="flex items-center justify-between p-4 bg-muted rounded-lg">
171 |             <div className="flex items-center gap-3">
172 |               <HardDrive className="h-5 w-5 text-muted-foreground" />
173 |               <div>
174 |                 <p className="font-mono text-sm">cookies.json</p>
175 |                 {status && (
176 |                   <p className="text-xs text-muted-foreground">
177 |                     {status.mainCookiesExists
178 |                       ? `${status.mainCookiesSize ? formatSize(status.mainCookiesSize) : ''} ${status.mainCookiesAge !== undefined ? '‚Ä¢ ' + formatAge(status.mainCookiesAge) : ''}`
179 |                       : 'Plik nie istnieje'}
180 |                   </p>
181 |                 )}
182 |               </div>
183 |             </div>
184 |             <Button
185 |               variant="outline"
186 |               size="sm"
187 |               onClick={() => setClearDialogOpen(true)}
188 |               disabled={actionLoading || !status?.mainCookiesExists}
189 |               className="text-destructive hover:text-destructive"
190 |             >
191 |               <Trash2 className="h-4 w-4 mr-1" />
192 |               Wyczysc
193 |             </Button>
194 |           </div>
195 |         </CardContent>
196 |       </Card>
197 | 
198 |       {/* Clear dialog */}
199 |       <Dialog open={clearDialogOpen} onOpenChange={setClearDialogOpen}>
200 |         <DialogContent>
201 |           <DialogHeader>
202 |             <DialogTitle>Wyczyscic cookies?</DialogTitle>
203 |             <DialogDescription>
204 |               To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu watchera.
205 |             </DialogDescription>
206 |           </DialogHeader>
207 |           <DialogFooter>
208 |             <Button variant="outline" onClick={() => setClearDialogOpen(false)}>
209 |               Anuluj
210 |             </Button>
211 |             <Button variant="destructive" onClick={handleClear} disabled={actionLoading}>
212 |               {actionLoading ? 'Czyszczenie...' : 'Wyczysc'}
213 |             </Button>
214 |           </DialogFooter>
215 |         </DialogContent>
216 |       </Dialog>
217 |     </div>
218 |   )
219 | }
220 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Dashboard.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { useEffect, useState } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Badge } from '@/components/ui/badge'
  4 | import { Button } from '@/components/ui/button'
  5 | import { Input } from '@/components/ui/input'
  6 | import { Label } from '@/components/ui/label'
  7 | import { RefreshCw, Server, FolderOpen, FileText, Cookie } from 'lucide-react'
  8 | import { getStatus } from '@/lib/api'
  9 | import { useAuth } from '@/hooks/useAuth'
 10 | import type { SystemStatus } from '@/lib/types'
 11 | 
 12 | function TokenForm() {
 13 |   const { token, setToken } = useAuth()
 14 |   const [inputValue, setInputValue] = useState(token)
 15 | 
 16 |   const handleSave = () => {
 17 |     setToken(inputValue.trim())
 18 |     window.location.reload()
 19 |   }
 20 | 
 21 |   return (
 22 |     <Card>
 23 |       <CardHeader>
 24 |         <CardTitle>Autoryzacja</CardTitle>
 25 |         <CardDescription>
 26 |           Wprowadz token PANEL_TOKEN aby uzyskac dostep do API
 27 |         </CardDescription>
 28 |       </CardHeader>
 29 |       <CardContent>
 30 |         <div className="flex gap-2">
 31 |           <div className="flex-1">
 32 |             <Label htmlFor="token" className="sr-only">
 33 |               Token
 34 |             </Label>
 35 |             <Input
 36 |               id="token"
 37 |               type="password"
 38 |               placeholder="Wprowadz PANEL_TOKEN..."
 39 |               value={inputValue}
 40 |               onChange={(e) => setInputValue(e.target.value)}
 41 |               onKeyDown={(e) => e.key === 'Enter' && handleSave()}
 42 |             />
 43 |           </div>
 44 |           <Button onClick={handleSave}>Zapisz</Button>
 45 |         </div>
 46 |       </CardContent>
 47 |     </Card>
 48 |   )
 49 | }
 50 | 
 51 | function parsePm2Status(statusText: string): { status: string; uptime?: string } {
 52 |   // Parse PM2 status table
 53 |   const lines = statusText.split('\n')
 54 |   for (const line of lines) {
 55 |     if (line.includes('fbwatcher') || line.includes('fb-watcher')) {
 56 |       if (line.includes('online')) {
 57 |         const uptimeMatch = line.match(/(\d+[smhd])/i)
 58 |         return { status: 'online', uptime: uptimeMatch?.[1] }
 59 |       }
 60 |       if (line.includes('stopped')) {
 61 |         return { status: 'stopped' }
 62 |       }
 63 |       if (line.includes('errored')) {
 64 |         return { status: 'errored' }
 65 |       }
 66 |     }
 67 |   }
 68 |   return { status: 'unknown' }
 69 | }
 70 | 
 71 | export function Dashboard() {
 72 |   const { isAuthenticated } = useAuth()
 73 |   const [status, setStatus] = useState<SystemStatus | null>(null)
 74 |   const [loading, setLoading] = useState(false)
 75 |   const [error, setError] = useState<string | null>(null)
 76 | 
 77 |   const loadStatus = async () => {
 78 |     setLoading(true)
 79 |     setError(null)
 80 |     try {
 81 |       const result = await getStatus()
 82 |       if (result.ok) {
 83 |         setStatus(result)
 84 |       } else {
 85 |         setError(result.error || 'Nie udalo sie pobrac statusu')
 86 |       }
 87 |     } catch {
 88 |       setError('Blad polaczenia z API')
 89 |     } finally {
 90 |       setLoading(false)
 91 |     }
 92 |   }
 93 | 
 94 |   useEffect(() => {
 95 |     if (isAuthenticated) {
 96 |       loadStatus()
 97 |     }
 98 |   }, [isAuthenticated])
 99 | 
100 |   if (!isAuthenticated) {
101 |     return (
102 |       <div className="flex flex-col gap-4">
103 |         <TokenForm />
104 |       </div>
105 |     )
106 |   }
107 | 
108 |   const pm2Info = status?.pm2Status ? parsePm2Status(status.pm2Status) : null
109 | 
110 |   return (
111 |     <div className="flex flex-col gap-4">
112 |       <div className="flex items-center justify-between">
113 |         <div>
114 |           <h2 className="text-2xl font-bold tracking-tight">Status systemu</h2>
115 |           <p className="text-muted-foreground">Przeglad stanu FB Watcher</p>
116 |         </div>
117 |         <Button variant="outline" onClick={loadStatus} disabled={loading}>
118 |           <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
119 |           Odswiez
120 |         </Button>
121 |       </div>
122 | 
123 |       {error && (
124 |         <Card className="border-destructive">
125 |           <CardContent className="pt-6">
126 |             <p className="text-destructive">{error}</p>
127 |             <TokenForm />
128 |           </CardContent>
129 |         </Card>
130 |       )}
131 | 
132 |       {status && (
133 |         <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
134 |           <Card>
135 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
136 |               <CardTitle className="text-sm font-medium">Watcher PM2</CardTitle>
137 |               <Server className="h-4 w-4 text-muted-foreground" />
138 |             </CardHeader>
139 |             <CardContent>
140 |               <div className="flex items-center gap-2">
141 |                 <Badge
142 |                   variant={
143 |                     pm2Info?.status === 'online'
144 |                       ? 'success'
145 |                       : pm2Info?.status === 'stopped'
146 |                         ? 'secondary'
147 |                         : 'destructive'
148 |                   }
149 |                 >
150 |                   {pm2Info?.status || 'unknown'}
151 |                 </Badge>
152 |                 {pm2Info?.uptime && (
153 |                   <span className="text-sm text-muted-foreground">
154 |                     {pm2Info.uptime}
155 |                   </span>
156 |                 )}
157 |               </div>
158 |             </CardContent>
159 |           </Card>
160 | 
161 |           <Card>
162 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
163 |               <CardTitle className="text-sm font-medium">Node.js</CardTitle>
164 |               <Server className="h-4 w-4 text-muted-foreground" />
165 |             </CardHeader>
166 |             <CardContent>
167 |               <div className="text-2xl font-bold">{status.node || 'N/A'}</div>
168 |               <p className="text-xs text-muted-foreground">PM2: {status.pm2 || 'N/A'}</p>
169 |             </CardContent>
170 |           </Card>
171 | 
172 |           <Card>
173 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
174 |               <CardTitle className="text-sm font-medium">Katalog projektu</CardTitle>
175 |               <FolderOpen className="h-4 w-4 text-muted-foreground" />
176 |             </CardHeader>
177 |             <CardContent>
178 |               <p className="text-xs text-muted-foreground break-all">{status.projectDir}</p>
179 |             </CardContent>
180 |           </Card>
181 | 
182 |           <Card>
183 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
184 |               <CardTitle className="text-sm font-medium">Pliki konfiguracji</CardTitle>
185 |               <FileText className="h-4 w-4 text-muted-foreground" />
186 |             </CardHeader>
187 |             <CardContent className="space-y-1">
188 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
189 |                 <FileText className="h-3 w-3" /> .env
190 |               </p>
191 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
192 |                 <Cookie className="h-3 w-3" /> cookies.json
193 |               </p>
194 |             </CardContent>
195 |           </Card>
196 |         </div>
197 |       )}
198 | 
199 |       {status && (
200 |         <Card>
201 |           <CardHeader>
202 |             <CardTitle className="text-sm font-medium">PM2 Status</CardTitle>
203 |           </CardHeader>
204 |           <CardContent>
205 |             <pre className="text-xs bg-muted p-4 rounded-md overflow-x-auto whitespace-pre">
206 |               {status.pm2Status}
207 |             </pre>
208 |           </CardContent>
209 |         </Card>
210 |       )}
211 | 
212 |       <TokenForm />
213 |     </div>
214 |   )
215 | }
216 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Discoveries.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Bell, Clock } from 'lucide-react'
 3 | 
 4 | export function Discoveries() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Bell className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Wykrycia</CardTitle>
15 |               <CardDescription>Przegladaj i zatwierdzaj wykryte posty</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na przegladanie automatycznie wykrytych postow
25 |               i zatwierdzanie ich do monitorowania.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Lista wykrytych postow oczekujacych na zatwierdzenie</li>
38 |             <li>‚Ä¢ Podglad tresci posta przed zatwierdzeniem</li>
39 |             <li>‚Ä¢ Masowe zatwierdzanie / odrzucanie</li>
40 |             <li>‚Ä¢ Historia wykryc</li>
41 |             <li>‚Ä¢ Statystyki skutecznosci filtrow</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Logs.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { useEffect, useRef } from 'react'
  2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'
  7 | import { Textarea } from '@/components/ui/textarea'
  8 | import { Checkbox } from '@/components/ui/checkbox'
  9 | import { RefreshCw, Maximize2, Minimize2 } from 'lucide-react'
 10 | import { useLogs } from '@/hooks/useLogs'
 11 | import { useState } from 'react'
 12 | 
 13 | export function Logs() {
 14 |   const {
 15 |     logs,
 16 |     loading,
 17 |     error,
 18 |     mode,
 19 |     autoRefresh,
 20 |     setAutoRefresh,
 21 |     loadLogs,
 22 |     setMode,
 23 |   } = useLogs(200)
 24 | 
 25 |   const [lines, setLines] = useState(200)
 26 |   const [autoScroll, setAutoScroll] = useState(true)
 27 |   const [expanded, setExpanded] = useState(false)
 28 |   const textareaRef = useRef<HTMLTextAreaElement>(null)
 29 | 
 30 |   useEffect(() => {
 31 |     loadLogs()
 32 |   }, []) // eslint-disable-line react-hooks/exhaustive-deps
 33 | 
 34 |   useEffect(() => {
 35 |     if (autoScroll && textareaRef.current) {
 36 |       textareaRef.current.scrollTop = textareaRef.current.scrollHeight
 37 |     }
 38 |   }, [logs, autoScroll])
 39 | 
 40 |   const handleRefresh = () => {
 41 |     loadLogs(mode, lines)
 42 |   }
 43 | 
 44 |   const handleModeChange = (newMode: string) => {
 45 |     setMode(newMode as 'out' | 'err')
 46 |   }
 47 | 
 48 |   const toggleAutoRefresh = () => {
 49 |     if (autoRefresh > 0) {
 50 |       setAutoRefresh(0)
 51 |     } else {
 52 |       setAutoRefresh(5000) // 5 seconds
 53 |     }
 54 |   }
 55 | 
 56 |   return (
 57 |     <div className="flex flex-col gap-4 h-full">
 58 |       <Card className={expanded ? 'fixed inset-4 z-50 flex flex-col' : 'flex-1 flex flex-col'}>
 59 |         <CardHeader className="flex flex-row items-center justify-between shrink-0">
 60 |           <CardTitle>Logi PM2</CardTitle>
 61 |           <div className="flex items-center gap-2">
 62 |             <Tabs value={mode} onValueChange={handleModeChange}>
 63 |               <TabsList>
 64 |                 <TabsTrigger value="out">stdout</TabsTrigger>
 65 |                 <TabsTrigger value="err">stderr</TabsTrigger>
 66 |               </TabsList>
 67 |             </Tabs>
 68 |             <Button variant="outline" size="icon" onClick={() => setExpanded(!expanded)}>
 69 |               {expanded ? <Minimize2 className="h-4 w-4" /> : <Maximize2 className="h-4 w-4" />}
 70 |             </Button>
 71 |           </div>
 72 |         </CardHeader>
 73 |         <CardContent className="flex-1 flex flex-col gap-4 min-h-0">
 74 |           {/* Controls */}
 75 |           <div className="flex flex-wrap items-end gap-4 shrink-0">
 76 |             <div className="space-y-2">
 77 |               <Label htmlFor="lines">Liczba linii</Label>
 78 |               <Input
 79 |                 id="lines"
 80 |                 type="number"
 81 |                 className="w-24"
 82 |                 value={lines}
 83 |                 onChange={(e) => setLines(Number(e.target.value) || 200)}
 84 |                 min={20}
 85 |                 max={2000}
 86 |               />
 87 |             </div>
 88 | 
 89 |             <Button variant="outline" onClick={handleRefresh} disabled={loading}>
 90 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
 91 |               Wczytaj
 92 |             </Button>
 93 | 
 94 |             <Button
 95 |               variant={autoRefresh > 0 ? 'default' : 'outline'}
 96 |               onClick={toggleAutoRefresh}
 97 |             >
 98 |               Auto: {autoRefresh > 0 ? 'WL' : 'WYL'}
 99 |             </Button>
100 | 
101 |             <div className="flex items-center gap-2">
102 |               <Checkbox
103 |                 id="autoScroll"
104 |                 checked={autoScroll}
105 |                 onCheckedChange={(checked) => setAutoScroll(!!checked)}
106 |               />
107 |               <Label htmlFor="autoScroll">Auto-scroll</Label>
108 |             </div>
109 |           </div>
110 | 
111 |           {error && (
112 |             <p className="text-destructive text-sm shrink-0">{error}</p>
113 |           )}
114 | 
115 |           {/* Log content */}
116 |           <Textarea
117 |             ref={textareaRef}
118 |             className="flex-1 font-mono text-xs resize-none min-h-[300px]"
119 |             value={logs}
120 |             readOnly
121 |             placeholder="Brak logow do wyswietlenia..."
122 |           />
123 | 
124 |           <p className="text-xs text-muted-foreground shrink-0">
125 |             Tryb: {mode.toUpperCase()} | Linii: {lines} | Auto-refresh: {autoRefresh > 0 ? `${autoRefresh / 1000}s` : 'wyl'}
126 |           </p>
127 |         </CardContent>
128 |       </Card>
129 |     </div>
130 |   )
131 | }
132 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Settings.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { useEffect, useState } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Switch } from '@/components/ui/switch'
  7 | import { Separator } from '@/components/ui/separator'
  8 | import {
  9 |   Play, Square, RotateCw, Save, RefreshCw,
 10 |   User, Bot, Zap, Terminal, Eye, Send, Bell, Link
 11 | } from 'lucide-react'
 12 | import { getEnv, setEnv, pm2Start, pm2Stop, pm2Restart } from '@/lib/api'
 13 | import type { EnvValues } from '@/lib/types'
 14 | 
 15 | interface FieldConfig {
 16 |   key: keyof EnvValues
 17 |   label: string
 18 |   type?: 'text' | 'password' | 'number' | 'switch' | 'select'
 19 |   placeholder?: string
 20 |   options?: { value: string; label: string }[]
 21 |   description?: string
 22 | }
 23 | 
 24 | interface SectionConfig {
 25 |   title: string
 26 |   icon: React.ReactNode
 27 |   description?: string
 28 |   fields: FieldConfig[]
 29 | }
 30 | 
 31 | const SECTIONS: SectionConfig[] = [
 32 |   {
 33 |     title: 'Watcher',
 34 |     icon: <Zap className="h-5 w-5" />,
 35 |     description: 'Ustawienia monitorowania komentarzy',
 36 |     fields: [
 37 |       { key: 'CHECK_INTERVAL_MS', label: 'Interwal sprawdzania (ms)', type: 'number', placeholder: '60000', description: 'Co ile ms sprawdzaƒá posty' },
 38 |       { key: 'FAST_MODE', label: 'Fast Mode', type: 'switch', description: 'Sortowanie "Najnowsze" dla szybszego wykrywania' },
 39 |       { key: 'INCLUDE_REPLIES', label: 'Uwzglƒôdniaj odpowiedzi', type: 'switch', description: 'Czy monitorowaƒá odpowiedzi na komentarze' },
 40 |     ],
 41 |   },
 42 |   {
 43 |     title: 'Logowanie',
 44 |     icon: <Terminal className="h-5 w-5" />,
 45 |     description: 'Poziom szczeg√≥≈Çowo≈õci log√≥w',
 46 |     fields: [
 47 |       {
 48 |         key: 'LOG_LEVEL',
 49 |         label: 'Poziom log√≥w',
 50 |         type: 'select',
 51 |         options: [
 52 |           { value: 'silent', label: 'Silent - brak log√≥w' },
 53 |           { value: 'production', label: 'Production - tylko wa≈ºne' },
 54 |           { value: 'dev', label: 'Dev - szczeg√≥≈Çowe' },
 55 |           { value: 'debug', label: 'Debug - wszystko' },
 56 |         ],
 57 |       },
 58 |     ],
 59 |   },
 60 |   {
 61 |     title: 'Puppeteer / Browser',
 62 |     icon: <Eye className="h-5 w-5" />,
 63 |     description: 'Ustawienia przeglƒÖdarki',
 64 |     fields: [
 65 |       { key: 'HEADLESS_BROWSER', label: 'Tryb headless', type: 'switch', description: 'Uruchamiaj bez widocznego okna' },
 66 |       { key: 'USE_UI_HANDLERS', label: 'UI Handlers', type: 'switch', description: 'U≈ºywaj handler√≥w UI do interakcji' },
 67 |       { key: 'COOKIES_READ_ONLY', label: 'Cookies tylko do odczytu', type: 'switch', description: 'Nie zapisuj zmian w cookies' },
 68 |     ],
 69 |   },
 70 |   {
 71 |     title: 'Facebook',
 72 |     icon: <User className="h-5 w-5" />,
 73 |     description: 'Dane logowania do FB',
 74 |     fields: [
 75 |       { key: 'FB_EMAIL', label: 'Email', placeholder: 'email@example.com' },
 76 |       { key: 'FB_PASSWORD', label: 'Has≈Ço', type: 'password', placeholder: '********' },
 77 |     ],
 78 |   },
 79 |   {
 80 |     title: '≈πr√≥d≈Ça post√≥w',
 81 |     icon: <Link className="h-5 w-5" />,
 82 |     description: 'SkƒÖd pobieraƒá listƒô post√≥w',
 83 |     fields: [
 84 |       { key: 'POSTS_API_URL', label: 'API URL', placeholder: 'http://server:3180/api/posts', description: 'Remote API panelu' },
 85 |       { key: 'POSTS_API_TOKEN', label: 'API Token', type: 'password', placeholder: 'fbw_xxx...' },
 86 |       { key: 'POSTS_SHEET_URL', label: 'Google Sheet URL', placeholder: 'https://docs.google.com/...', description: 'Fallback gdy API niedostƒôpne' },
 87 |     ],
 88 |   },
 89 |   {
 90 |     title: 'Telegram - W≈Ça≈õciciel',
 91 |     icon: <Send className="h-5 w-5" />,
 92 |     description: 'Powiadomienia do Ciebie',
 93 |     fields: [
 94 |       { key: 'TELEGRAM_SEND_TO_OWNER', label: 'Wysy≈Çaj do w≈Ça≈õciciela', type: 'switch' },
 95 |       { key: 'TELEGRAM_BOT_TOKEN_OWNER', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
 96 |       { key: 'TELEGRAM_CHAT_ID_OWNER', label: 'Chat ID', placeholder: '123456789' },
 97 |     ],
 98 |   },
 99 |   {
100 |     title: 'Telegram - Klient',
101 |     icon: <Bot className="h-5 w-5" />,
102 |     description: 'Powiadomienia do klienta',
103 |     fields: [
104 |       { key: 'TELEGRAM_SEND_TO_CLIENT', label: 'Wysy≈Çaj do klienta', type: 'switch' },
105 |       { key: 'TELEGRAM_BOT_TOKEN_CLIENT', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
106 |       { key: 'TELEGRAM_CHAT_ID_CLIENT', label: 'Chat ID', placeholder: '123456789' },
107 |     ],
108 |   },
109 |   {
110 |     title: 'Telegram - Format',
111 |     icon: <Send className="h-5 w-5" />,
112 |     description: 'Formatowanie wiadomo≈õci',
113 |     fields: [
114 |       { key: 'TELEGRAM_USE_PHOTO', label: 'Wysy≈Çaj ze zdjƒôciem', type: 'switch', description: 'Do≈ÇƒÖcz miniaturƒô posta' },
115 |       { key: 'TELEGRAM_DISABLE_WEB_PAGE_PREVIEW', label: 'Wy≈ÇƒÖcz podglƒÖd link√≥w', type: 'switch' },
116 |     ],
117 |   },
118 |   {
119 |     title: 'Telegram - Alerty',
120 |     icon: <Bell className="h-5 w-5" />,
121 |     description: 'Alerty o b≈Çƒôdach z log√≥w',
122 |     fields: [
123 |       { key: 'TG_ALERTS_ENABLED', label: 'W≈ÇƒÖcz alerty', type: 'switch' },
124 |       { key: 'TG_ALERTS_COOLDOWN_SEC', label: 'Cooldown (sek)', type: 'number', placeholder: '120', description: 'Minimalny odstƒôp miƒôdzy alertami' },
125 |       { key: 'TG_ALERTS_MAXLEN', label: 'Max d≈Çugo≈õƒá', type: 'number', placeholder: '3500', description: 'Maksymalna d≈Çugo≈õƒá wiadomo≈õci' },
126 |     ],
127 |   },
128 | ]
129 | 
130 | function isTruthy(val: string): boolean {
131 |   return val === 'true' || val === '1' || val === 'yes'
132 | }
133 | 
134 | function boolToEnv(val: boolean): string {
135 |   return val ? 'true' : 'false'
136 | }
137 | 
138 | export function Settings() {
139 |   const [values, setValues] = useState<EnvValues | null>(null)
140 |   const [loading, setLoading] = useState(false)
141 |   const [saving, setSaving] = useState(false)
142 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
143 |   const [pm2Loading, setPm2Loading] = useState<string | null>(null)
144 | 
145 |   const showMessage = (text: string, type: 'success' | 'error') => {
146 |     setMessage({ text, type })
147 |     setTimeout(() => setMessage(null), 3000)
148 |   }
149 | 
150 |   const loadEnv = async () => {
151 |     setLoading(true)
152 |     try {
153 |       const result = await getEnv()
154 |       if (result.ok) {
155 |         setValues(result.values)
156 |       } else {
157 |         showMessage(result.error || 'Nie udalo sie wczytac ustawien', 'error')
158 |       }
159 |     } catch {
160 |       showMessage('Blad polaczenia', 'error')
161 |     } finally {
162 |       setLoading(false)
163 |     }
164 |   }
165 | 
166 |   useEffect(() => {
167 |     loadEnv()
168 |   }, [])
169 | 
170 |   const handleChange = (key: keyof EnvValues, value: string) => {
171 |     if (values) {
172 |       setValues({ ...values, [key]: value })
173 |     }
174 |   }
175 | 
176 |   const handleSwitchChange = (key: keyof EnvValues, checked: boolean) => {
177 |     if (values) {
178 |       setValues({ ...values, [key]: boolToEnv(checked) })
179 |     }
180 |   }
181 | 
182 |   const handleSave = async (restart = false) => {
183 |     if (!values) return
184 | 
185 |     setSaving(true)
186 |     try {
187 |       const envRecord: Record<string, string> = {}
188 |       for (const key of Object.keys(values) as (keyof typeof values)[]) {
189 |         envRecord[key] = values[key]
190 |       }
191 |       const result = await setEnv(envRecord, restart)
192 |       if (result.ok) {
193 |         showMessage(restart ? 'Zapisano i zrestartowano' : 'Zapisano ustawienia', 'success')
194 |       } else {
195 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
196 |       }
197 |     } catch {
198 |       showMessage('Blad polaczenia', 'error')
199 |     } finally {
200 |       setSaving(false)
201 |     }
202 |   }
203 | 
204 |   const handlePm2Action = async (action: 'start' | 'stop' | 'restart') => {
205 |     setPm2Loading(action)
206 |     try {
207 |       const fn = action === 'start' ? pm2Start : action === 'stop' ? pm2Stop : pm2Restart
208 |       const result = await fn()
209 |       if (result.ok) {
210 |         const labels = { start: 'Uruchomiono', stop: 'Zatrzymano', restart: 'Zrestartowano' }
211 |         showMessage(labels[action], 'success')
212 |       } else {
213 |         showMessage(result.error || `Nie udalo sie ${action}`, 'error')
214 |       }
215 |     } catch {
216 |       showMessage('Blad polaczenia', 'error')
217 |     } finally {
218 |       setPm2Loading(null)
219 |     }
220 |   }
221 | 
222 |   const renderField = (field: FieldConfig) => {
223 |     if (!values) return null
224 |     const value = values[field.key] || ''
225 | 
226 |     if (field.type === 'switch') {
227 |       return (
228 |         <div key={field.key} className="flex items-center justify-between py-2">
229 |           <div className="space-y-0.5">
230 |             <Label htmlFor={field.key}>{field.label}</Label>
231 |             {field.description && (
232 |               <p className="text-xs text-muted-foreground">{field.description}</p>
233 |             )}
234 |           </div>
235 |           <Switch
236 |             id={field.key}
237 |             checked={isTruthy(value)}
238 |             onCheckedChange={(checked) => handleSwitchChange(field.key, checked)}
239 |           />
240 |         </div>
241 |       )
242 |     }
243 | 
244 |     if (field.type === 'select' && field.options) {
245 |       return (
246 |         <div key={field.key} className="space-y-2">
247 |           <Label htmlFor={field.key}>{field.label}</Label>
248 |           <select
249 |             id={field.key}
250 |             value={value}
251 |             onChange={(e) => handleChange(field.key, e.target.value)}
252 |             className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
253 |           >
254 |             {field.options.map((opt) => (
255 |               <option key={opt.value} value={opt.value}>
256 |                 {opt.label}
257 |               </option>
258 |             ))}
259 |           </select>
260 |         </div>
261 |       )
262 |     }
263 | 
264 |     return (
265 |       <div key={field.key} className="space-y-2">
266 |         <Label htmlFor={field.key}>{field.label}</Label>
267 |         <Input
268 |           id={field.key}
269 |           type={field.type || 'text'}
270 |           placeholder={field.placeholder}
271 |           value={value}
272 |           onChange={(e) => handleChange(field.key, e.target.value)}
273 |         />
274 |         {field.description && (
275 |           <p className="text-xs text-muted-foreground">{field.description}</p>
276 |         )}
277 |       </div>
278 |     )
279 |   }
280 | 
281 |   return (
282 |     <div className="flex flex-col gap-4">
283 |       {message && (
284 |         <div
285 |           className={`p-3 rounded-md text-sm ${
286 |             message.type === 'success'
287 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
288 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
289 |           }`}
290 |         >
291 |           {message.text}
292 |         </div>
293 |       )}
294 | 
295 |       {/* PM2 Controls */}
296 |       <Card>
297 |         <CardHeader>
298 |           <CardTitle>PM2 Controls</CardTitle>
299 |           <CardDescription>Zarzadzanie procesem watchera</CardDescription>
300 |         </CardHeader>
301 |         <CardContent>
302 |           <div className="flex flex-wrap gap-2">
303 |             <Button
304 |               variant="outline"
305 |               onClick={() => handlePm2Action('start')}
306 |               disabled={!!pm2Loading}
307 |             >
308 |               <Play className="h-4 w-4 mr-2" />
309 |               {pm2Loading === 'start' ? 'Uruchamianie...' : 'Start'}
310 |             </Button>
311 |             <Button
312 |               variant="outline"
313 |               onClick={() => handlePm2Action('stop')}
314 |               disabled={!!pm2Loading}
315 |             >
316 |               <Square className="h-4 w-4 mr-2" />
317 |               {pm2Loading === 'stop' ? 'Zatrzymywanie...' : 'Stop'}
318 |             </Button>
319 |             <Button
320 |               variant="outline"
321 |               onClick={() => handlePm2Action('restart')}
322 |               disabled={!!pm2Loading}
323 |             >
324 |               <RotateCw className="h-4 w-4 mr-2" />
325 |               {pm2Loading === 'restart' ? 'Restartowanie...' : 'Restart'}
326 |             </Button>
327 |           </div>
328 |         </CardContent>
329 |       </Card>
330 | 
331 |       {/* Save buttons - sticky */}
332 |       <Card className="sticky top-4 z-10 border-primary/50">
333 |         <CardContent className="pt-4">
334 |           <div className="flex flex-wrap items-center justify-between gap-2">
335 |             <Button variant="outline" size="sm" onClick={loadEnv} disabled={loading}>
336 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
337 |               Wczytaj ponownie
338 |             </Button>
339 |             <div className="flex gap-2">
340 |               <Button onClick={() => handleSave(false)} disabled={saving}>
341 |                 <Save className="h-4 w-4 mr-2" />
342 |                 {saving ? 'Zapisywanie...' : 'Zapisz'}
343 |               </Button>
344 |               <Button variant="secondary" onClick={() => handleSave(true)} disabled={saving}>
345 |                 <RotateCw className="h-4 w-4 mr-2" />
346 |                 Zapisz i restartuj
347 |               </Button>
348 |             </div>
349 |           </div>
350 |         </CardContent>
351 |       </Card>
352 | 
353 |       {/* Settings sections */}
354 |       {values && SECTIONS.map((section) => (
355 |         <Card key={section.title}>
356 |           <CardHeader>
357 |             <CardTitle className="flex items-center gap-2 text-lg">
358 |               {section.icon}
359 |               {section.title}
360 |             </CardTitle>
361 |             {section.description && (
362 |               <CardDescription>{section.description}</CardDescription>
363 |             )}
364 |           </CardHeader>
365 |           <CardContent className="space-y-4">
366 |             {section.fields.map((field, idx) => (
367 |               <div key={field.key}>
368 |                 {renderField(field)}
369 |                 {idx < section.fields.length - 1 && field.type !== 'switch' && (
370 |                   <Separator className="mt-4" />
371 |                 )}
372 |               </div>
373 |             ))}
374 |           </CardContent>
375 |         </Card>
376 |       ))}
377 |     </div>
378 |   )
379 | }
380 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Sources.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Globe, Clock } from 'lucide-react'
 3 | 
 4 | export function Sources() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Globe className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Zrodla monitorowania</CardTitle>
15 |               <CardDescription>Zarzadzaj zrodlami postow do monitorowania</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na automatyczne wykrywanie postow z roznych zrodel:
25 |               glownego feedu, grup, czy Meta Ads Library.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Monitorowanie glownego feedu FB</li>
38 |             <li>‚Ä¢ Monitorowanie wybranych grup</li>
39 |             <li>‚Ä¢ Integracja z Meta Ads Library</li>
40 |             <li>‚Ä¢ Filtrowanie po slowach kluczowych</li>
41 |             <li>‚Ä¢ Automatyczne dodawanie wykrytych postow</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Watched.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```tsx
  1 | import { useEffect, useState, useCallback } from 'react'
  2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Checkbox } from '@/components/ui/checkbox'
  7 | import {
  8 |   Table,
  9 |   TableBody,
 10 |   TableCell,
 11 |   TableHead,
 12 |   TableHeader,
 13 |   TableRow,
 14 | } from '@/components/ui/table'
 15 | import {
 16 |   Dialog,
 17 |   DialogContent,
 18 |   DialogDescription,
 19 |   DialogFooter,
 20 |   DialogHeader,
 21 |   DialogTitle,
 22 | } from '@/components/ui/dialog'
 23 | import { Plus, Pencil, Trash2, ExternalLink, Copy, RefreshCw } from 'lucide-react'
 24 | import { getPosts, addPost, updatePost, deletePost } from '@/lib/api'
 25 | import type { Post } from '@/lib/types'
 26 | 
 27 | export function Watched() {
 28 |   const [posts, setPosts] = useState<Post[]>([])
 29 |   const [loading, setLoading] = useState(false)
 30 |   const [error, setError] = useState<string | null>(null)
 31 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
 32 | 
 33 |   // Add form state
 34 |   const [newUrl, setNewUrl] = useState('')
 35 |   const [newName, setNewName] = useState('')
 36 |   const [newImage, setNewImage] = useState('')
 37 |   const [newActive, setNewActive] = useState(true)
 38 |   const [adding, setAdding] = useState(false)
 39 | 
 40 |   // Edit dialog state
 41 |   const [editPost, setEditPost] = useState<Post | null>(null)
 42 |   const [editUrl, setEditUrl] = useState('')
 43 |   const [editName, setEditName] = useState('')
 44 |   const [editImage, setEditImage] = useState('')
 45 |   const [saving, setSaving] = useState(false)
 46 | 
 47 |   // Delete dialog state
 48 |   const [deleteTarget, setDeleteTarget] = useState<Post | null>(null)
 49 |   const [deleting, setDeleting] = useState(false)
 50 | 
 51 |   const loadPosts = useCallback(async () => {
 52 |     setLoading(true)
 53 |     setError(null)
 54 |     try {
 55 |       const result = await getPosts()
 56 |       if (result.ok) {
 57 |         setPosts(result.posts)
 58 |       } else {
 59 |         setError(result.error || 'Nie udalo sie pobrac postow')
 60 |       }
 61 |     } catch {
 62 |       setError('Blad polaczenia')
 63 |     } finally {
 64 |       setLoading(false)
 65 |     }
 66 |   }, [])
 67 | 
 68 |   useEffect(() => {
 69 |     loadPosts()
 70 |   }, [loadPosts])
 71 | 
 72 |   const showMessage = (text: string, type: 'success' | 'error') => {
 73 |     setMessage({ text, type })
 74 |     setTimeout(() => setMessage(null), 3000)
 75 |   }
 76 | 
 77 |   const handleAdd = async () => {
 78 |     if (!newUrl.trim()) {
 79 |       showMessage('Podaj URL posta', 'error')
 80 |       return
 81 |     }
 82 | 
 83 |     setAdding(true)
 84 |     try {
 85 |       const result = await addPost({
 86 |         url: newUrl.trim(),
 87 |         name: newName.trim(),
 88 |         image: newImage.trim(),
 89 |         active: newActive,
 90 |       })
 91 | 
 92 |       if (result.ok) {
 93 |         showMessage('Post dodany', 'success')
 94 |         setNewUrl('')
 95 |         setNewName('')
 96 |         setNewImage('')
 97 |         setNewActive(true)
 98 |         loadPosts()
 99 |       } else {
100 |         showMessage(result.error || 'Nie udalo sie dodac posta', 'error')
101 |       }
102 |     } catch {
103 |       showMessage('Blad polaczenia', 'error')
104 |     } finally {
105 |       setAdding(false)
106 |     }
107 |   }
108 | 
109 |   const handleToggleActive = async (post: Post) => {
110 |     try {
111 |       const result = await updatePost(post.id, { active: !post.active })
112 |       if (result.ok) {
113 |         loadPosts()
114 |       } else {
115 |         showMessage(result.error || 'Nie udalo sie zmienic statusu', 'error')
116 |       }
117 |     } catch {
118 |       showMessage('Blad polaczenia', 'error')
119 |     }
120 |   }
121 | 
122 |   const openEditDialog = (post: Post) => {
123 |     setEditPost(post)
124 |     setEditUrl(post.url)
125 |     setEditName(post.name)
126 |     setEditImage(post.image)
127 |   }
128 | 
129 |   const handleEdit = async () => {
130 |     if (!editPost) return
131 | 
132 |     setSaving(true)
133 |     try {
134 |       const result = await updatePost(editPost.id, {
135 |         url: editUrl.trim(),
136 |         name: editName.trim(),
137 |         image: editImage.trim(),
138 |       })
139 | 
140 |       if (result.ok) {
141 |         showMessage('Zapisano zmiany', 'success')
142 |         setEditPost(null)
143 |         loadPosts()
144 |       } else {
145 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
146 |       }
147 |     } catch {
148 |       showMessage('Blad polaczenia', 'error')
149 |     } finally {
150 |       setSaving(false)
151 |     }
152 |   }
153 | 
154 |   const handleDelete = async () => {
155 |     if (!deleteTarget) return
156 | 
157 |     setDeleting(true)
158 |     try {
159 |       const result = await deletePost(deleteTarget.id)
160 |       if (result.ok) {
161 |         showMessage('Post usuniety', 'success')
162 |         setDeleteTarget(null)
163 |         loadPosts()
164 |       } else {
165 |         showMessage(result.error || 'Nie udalo sie usunac', 'error')
166 |       }
167 |     } catch {
168 |       showMessage('Blad polaczenia', 'error')
169 |     } finally {
170 |       setDeleting(false)
171 |     }
172 |   }
173 | 
174 |   const copyToClipboard = async (text: string) => {
175 |     try {
176 |       await navigator.clipboard.writeText(text)
177 |       showMessage('Skopiowano do schowka', 'success')
178 |     } catch {
179 |       showMessage('Nie udalo sie skopiowac', 'error')
180 |     }
181 |   }
182 | 
183 |   return (
184 |     <div className="flex flex-col gap-4">
185 |       {message && (
186 |         <div
187 |           className={`p-3 rounded-md text-sm ${
188 |             message.type === 'success'
189 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
190 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
191 |           }`}
192 |         >
193 |           {message.text}
194 |         </div>
195 |       )}
196 | 
197 |       {/* Add form */}
198 |       <Card>
199 |         <CardHeader>
200 |           <CardTitle className="text-lg">Dodaj nowy post</CardTitle>
201 |         </CardHeader>
202 |         <CardContent>
203 |           <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
204 |             <div className="space-y-2">
205 |               <Label htmlFor="newUrl">URL posta *</Label>
206 |               <Input
207 |                 id="newUrl"
208 |                 placeholder="https://www.facebook.com/..."
209 |                 value={newUrl}
210 |                 onChange={(e) => setNewUrl(e.target.value)}
211 |               />
212 |             </div>
213 |             <div className="space-y-2">
214 |               <Label htmlFor="newName">Nazwa</Label>
215 |               <Input
216 |                 id="newName"
217 |                 placeholder="Opcjonalna nazwa"
218 |                 value={newName}
219 |                 onChange={(e) => setNewName(e.target.value)}
220 |               />
221 |             </div>
222 |             <div className="space-y-2">
223 |               <Label htmlFor="newImage">URL obrazka</Label>
224 |               <Input
225 |                 id="newImage"
226 |                 placeholder="https://..."
227 |                 value={newImage}
228 |                 onChange={(e) => setNewImage(e.target.value)}
229 |               />
230 |             </div>
231 |             <div className="flex items-end gap-4">
232 |               <div className="flex items-center gap-2">
233 |                 <Checkbox
234 |                   id="newActive"
235 |                   checked={newActive}
236 |                   onCheckedChange={(checked) => setNewActive(!!checked)}
237 |                 />
238 |                 <Label htmlFor="newActive">Aktywny</Label>
239 |               </div>
240 |               <Button onClick={handleAdd} disabled={adding}>
241 |                 <Plus className="h-4 w-4 mr-2" />
242 |                 {adding ? 'Dodawanie...' : 'Dodaj'}
243 |               </Button>
244 |             </div>
245 |           </div>
246 |         </CardContent>
247 |       </Card>
248 | 
249 |       {/* Posts table */}
250 |       <Card>
251 |         <CardHeader className="flex flex-row items-center justify-between">
252 |           <CardTitle className="text-lg">Obserwowane posty ({posts.length})</CardTitle>
253 |           <Button variant="outline" size="sm" onClick={loadPosts} disabled={loading}>
254 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
255 |             Odswiez
256 |           </Button>
257 |         </CardHeader>
258 |         <CardContent>
259 |           {error && <p className="text-destructive mb-4">{error}</p>}
260 | 
261 |           <Table>
262 |             <TableHeader>
263 |               <TableRow>
264 |                 <TableHead className="w-[60px]">ID</TableHead>
265 |                 <TableHead>URL</TableHead>
266 |                 <TableHead>Nazwa</TableHead>
267 |                 <TableHead className="w-[260px]">Obrazek</TableHead>
268 |                 <TableHead className="w-[80px]">Aktywny</TableHead>
269 |                 <TableHead className="w-[120px]">Akcje</TableHead>
270 |               </TableRow>
271 |             </TableHeader>
272 |             <TableBody>
273 |               {posts.map((post) => (
274 |                 <TableRow key={post.id}>
275 |                   <TableCell className="font-mono text-xs">{post.id.slice(0, 6)}</TableCell>
276 |                   <TableCell>
277 |                     <div className="flex items-center gap-2 max-w-md">
278 |                       <a
279 |                         href={post.url}
280 |                         target="_blank"
281 |                         rel="noopener noreferrer"
282 |                         className="text-blue-400 hover:underline truncate text-sm"
283 |                       >
284 |                         {post.url}
285 |                       </a>
286 |                       <Button
287 |                         variant="ghost"
288 |                         size="icon"
289 |                         className="h-6 w-6 shrink-0"
290 |                         onClick={() => copyToClipboard(post.url)}
291 |                       >
292 |                         <Copy className="h-3 w-3" />
293 |                       </Button>
294 |                       <a
295 |                         href={post.url}
296 |                         target="_blank"
297 |                         rel="noopener noreferrer"
298 |                         className="shrink-0"
299 |                       >
300 |                         <ExternalLink className="h-3 w-3 text-muted-foreground" />
301 |                       </a>
302 |                     </div>
303 |                   </TableCell>
304 |                   <TableCell className="max-w-[150px] truncate">{post.name || '-'}</TableCell>
305 |                   <TableCell>
306 |                     {post.image ? (
307 |                       <img
308 |   src={post.image}
309 |   alt=""
310 |   className="w-[220px] h-[120px] object-contain rounded-md bg-black/20 transition-transform duration-200 hover:scale-[1.03] cursor-zoom-in"
311 | />
312 | 
313 |                     ) : (
314 |                       '-'
315 |                     )}
316 |                   </TableCell>
317 |                   <TableCell>
318 |                     <Checkbox
319 |                       checked={post.active}
320 |                       onCheckedChange={() => handleToggleActive(post)}
321 |                     />
322 |                   </TableCell>
323 |                   <TableCell>
324 |                     <div className="flex items-center gap-1">
325 |                       <Button
326 |                         variant="ghost"
327 |                         size="icon"
328 |                         className="h-8 w-8"
329 |                         onClick={() => openEditDialog(post)}
330 |                       >
331 |                         <Pencil className="h-4 w-4" />
332 |                       </Button>
333 |                       <Button
334 |                         variant="ghost"
335 |                         size="icon"
336 |                         className="h-8 w-8 text-destructive hover:text-destructive"
337 |                         onClick={() => setDeleteTarget(post)}
338 |                       >
339 |                         <Trash2 className="h-4 w-4" />
340 |                       </Button>
341 |                     </div>
342 |                   </TableCell>
343 |                 </TableRow>
344 |               ))}
345 |               {posts.length === 0 && !loading && (
346 |                 <TableRow>
347 |                   <TableCell colSpan={6} className="text-center text-muted-foreground py-8">
348 |                     Brak obserwowanych postow. Dodaj pierwszy powyzej.
349 |                   </TableCell>
350 |                 </TableRow>
351 |               )}
352 |             </TableBody>
353 |           </Table>
354 |         </CardContent>
355 |       </Card>
356 | 
357 |       {/* Edit dialog */}
358 |       <Dialog open={!!editPost} onOpenChange={(open) => !open && setEditPost(null)}>
359 |         <DialogContent>
360 |           <DialogHeader>
361 |             <DialogTitle>Edytuj post</DialogTitle>
362 |             <DialogDescription>Zmien dane obserwowanego posta</DialogDescription>
363 |           </DialogHeader>
364 |           <div className="grid gap-4 py-4">
365 |             <div className="space-y-2">
366 |               <Label htmlFor="editUrl">URL</Label>
367 |               <Input
368 |                 id="editUrl"
369 |                 value={editUrl}
370 |                 onChange={(e) => setEditUrl(e.target.value)}
371 |               />
372 |             </div>
373 |             <div className="space-y-2">
374 |               <Label htmlFor="editName">Nazwa</Label>
375 |               <Input
376 |                 id="editName"
377 |                 value={editName}
378 |                 onChange={(e) => setEditName(e.target.value)}
379 |               />
380 |             </div>
381 |             <div className="space-y-2">
382 |               <Label htmlFor="editImage">URL obrazka</Label>
383 |               <Input
384 |                 id="editImage"
385 |                 value={editImage}
386 |                 onChange={(e) => setEditImage(e.target.value)}
387 |               />
388 |             </div>
389 |           </div>
390 |           <DialogFooter>
391 |             <Button variant="outline" onClick={() => setEditPost(null)}>
392 |               Anuluj
393 |             </Button>
394 |             <Button onClick={handleEdit} disabled={saving}>
395 |               {saving ? 'Zapisywanie...' : 'Zapisz'}
396 |             </Button>
397 |           </DialogFooter>
398 |         </DialogContent>
399 |       </Dialog>
400 | 
401 |       {/* Delete confirmation dialog */}
402 |       <Dialog open={!!deleteTarget} onOpenChange={(open) => !open && setDeleteTarget(null)}>
403 |         <DialogContent>
404 |           <DialogHeader>
405 |             <DialogTitle>Usunac post?</DialogTitle>
406 |             <DialogDescription>Ta operacja jest nieodwracalna.</DialogDescription>
407 |           </DialogHeader>
408 |           {deleteTarget && (
409 |             <div className="py-4">
410 |               <p className="font-medium">{deleteTarget.name || 'Bez nazwy'}</p>
411 |               <p className="text-sm text-muted-foreground break-all mt-1">
412 |                 {deleteTarget.url}
413 |               </p>
414 |             </div>
415 |           )}
416 |           <DialogFooter>
417 |             <Button variant="outline" onClick={() => setDeleteTarget(null)}>
418 |               Anuluj
419 |             </Button>
420 |             <Button variant="destructive" onClick={handleDelete} disabled={deleting}>
421 |               {deleting ? 'Usuwanie...' : 'Usun'}
422 |             </Button>
423 |           </DialogFooter>
424 |         </DialogContent>
425 |       </Dialog>
426 |     </div>
427 |   )
428 | }
429 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/vite-env.d.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```ts
1 | /// <reference types="vite/client" />
2 | 
```

---

### üìÑ ≈öcie≈ºka: `src/telegram.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/telegram.js
  2 | import axios from "axios";
  3 | import log from "./utils/logger.js";
  4 | 
  5 | /* ============================================================
  6 |    FILTR WIEKU KOMENTARZA (TELEGRAM)
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 |   const t = String(raw).toLowerCase().trim();
 12 |   const now = new Date();
 13 | 
 14 |   if (t.includes("przed chwilƒÖ")) return now;
 15 |   if (t.includes("w≈Ça≈õnie teraz") || t === "teraz" || t === "now" || t === "just now") return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   // Obs≈Çugujemy polskie i angielskie skr√≥ty
 24 |   // np: 15 sek., 5 min, 2 godz., 1 dzie≈Ñ, 4 tyg., 4 weeks
 25 |   const m = t.match(/(\d+)\s*(sek\.?|s|sec|secs|second|seconds|min\.?|m|minut|minuty|minutƒô|godz\.?|h|hr|hour|hours|dni|dzie≈Ñ|d|tyg\.?|week|weeks)\b/);
 26 |   if (!m) return null;
 27 | 
 28 |   const value = parseInt(m[1], 10);
 29 |   if (!Number.isFinite(value)) return null;
 30 | 
 31 |   const unit = m[2];
 32 |   const d = new Date(now);
 33 | 
 34 |   if (unit.startsWith("sek") || unit === "s" || unit.startsWith("sec") || unit.startsWith("second")) d.setSeconds(d.getSeconds() - value);
 35 |   else if (unit.startsWith("min") || unit === "m") d.setMinutes(d.getMinutes() - value);
 36 |   else if (unit.startsWith("godz") || unit === "h" || unit === "hr" || unit.startsWith("hour")) d.setHours(d.getHours() - value);
 37 |   else if (unit.startsWith("dni") || unit.startsWith("dzie") || unit === "d") d.setDate(d.getDate() - value);
 38 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
 39 | 
 40 |   return d;
 41 | }
 42 | 
 43 | function shouldSendByAge(comment) {
 44 |   // ENV:
 45 |   // TELEGRAM_MAX_AGE_MIN=60
 46 |   // TELEGRAM_DROP_IF_NO_TIME=1  (domy≈õlnie: 1)
 47 |   const maxAgeMin = Number(process.env.TELEGRAM_MAX_AGE_MIN || 60);
 48 |   const dropIfNoTime = envBool("TELEGRAM_DROP_IF_NO_TIME", true);
 49 | 
 50 |   const rel = String(comment?.fb_time_raw || comment?.time || comment?.relative_time || "").trim();
 51 |   if (!rel) return !dropIfNoTime;
 52 | 
 53 |   const abs = parseFbRelativeTime(rel);
 54 |   if (!abs) return !dropIfNoTime;
 55 | 
 56 |   const ageMinutes = (Date.now() - abs.getTime()) / 60000;
 57 |   return ageMinutes <= maxAgeMin;
 58 | }
 59 | 
 60 | function envBool(name, def = false) {
 61 |   const v = String(process.env[name] ?? "").trim().toLowerCase();
 62 |   if (!v) return def;
 63 |   return ["1", "true", "yes", "tak", "y", "on"].includes(v);
 64 | }
 65 | 
 66 | function escapeHtml(s) {
 67 |   if (s == null) return "";
 68 |   return String(s)
 69 |     .replaceAll("&", "&amp;")
 70 |     .replaceAll("<", "&lt;")
 71 |     .replaceAll(">", "&gt;")
 72 |     .replaceAll('"', "&quot;");
 73 | }
 74 | 
 75 | function buildCaptionHtml(post, c) {
 76 |   const postName = escapeHtml(post?.name || "");
 77 |   const postDesc = escapeHtml(post?.description || "");
 78 |   const author = escapeHtml(c?.author || c?.name || "");
 79 |   const text = escapeHtml(c?.text || c?.message || "");
 80 |   const rel = escapeHtml(c?.fb_time_raw || c?.time || c?.relative_time || "");
 81 |   const url = String(post?.url || "").trim();
 82 | 
 83 |   const postLine = postDesc ? `${postName} ‚Äî ${postDesc}` : postName;
 84 | 
 85 |   return (
 86 |     `<b>üì© Nowy komentarz na Facebooku</b>\n\n` +
 87 |     `<b>üë§ Autor:</b>\n${author || "-"}\n\n` +
 88 |     `<b>üïí Czas:</b>\n${rel || "-"}\n\n` +
 89 |     `<b>üìù Tre≈õƒá:</b>\n${text || "-"}\n\n` +
 90 |     `<b>üìå Post:</b>\n${postLine || "-"}\n\n` +
 91 |     (url ? `<a href="${escapeHtml(url)}">üëâ Otw√≥rz post</a>` : "")
 92 |   );
 93 | }
 94 | 
 95 | async function tgRequest(token, method, payload) {
 96 |   const t = String(token || "").trim();
 97 |   if (!t) return { ok: false, error: "Brak tokena bota" };
 98 | 
 99 |   const endpoint = `https://api.telegram.org/bot${t}/${method}`;
100 | 
101 |   try {
102 |     const res = await axios.post(endpoint, payload, { timeout: 15000 });
103 |     if (res?.data?.ok) return { ok: true, data: res.data };
104 |     return { ok: false, error: res?.data?.description || "Telegram error" };
105 |   } catch (e) {
106 |     return {
107 |       ok: false,
108 |       error: e?.response?.data?.description || e?.message || String(e),
109 |     };
110 |   }
111 | }
112 | 
113 | async function sendMessage(token, chat_id, text, opts = {}) {
114 |   const parse_mode = opts.parse_mode || "HTML";
115 |   const disable_web_page_preview = !!opts.disable_web_page_preview;
116 | 
117 |   return tgRequest(token, "sendMessage", {
118 |     chat_id,
119 |     text,
120 |     parse_mode,
121 |     disable_web_page_preview,
122 |   });
123 | }
124 | 
125 | async function sendPhoto(token, chat_id, photo, caption, opts = {}) {
126 |   const parse_mode = opts.parse_mode || "HTML";
127 |   return tgRequest(token, "sendPhoto", {
128 |     chat_id,
129 |     photo,
130 |     caption,
131 |     parse_mode,
132 |   });
133 | }
134 | 
135 | function getTargets() {
136 |   const sendOwner = envBool("TELEGRAM_SEND_TO_OWNER", true);
137 |   const sendClient = envBool("TELEGRAM_SEND_TO_CLIENT", true);
138 | 
139 |   const ownerToken = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
140 |   const ownerChat = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
141 | 
142 |   const clientToken = String(process.env.TELEGRAM_BOT_TOKEN_CLIENT || "").trim();
143 |   const clientChat = String(process.env.TELEGRAM_CHAT_ID_CLIENT || "").trim();
144 | 
145 |   const targets = [];
146 |   log.debug("TELEGRAM", "Targets config", {
147 |     sendOwner,
148 |     sendClient,
149 |     ownerToken: ownerToken ? ownerToken.slice(0, 12) + "..." : null,
150 |     ownerChat: ownerChat || null,
151 |     clientToken: clientToken ? clientToken.slice(0, 12) + "..." : null,
152 |     clientChat: clientChat || null,
153 |   });
154 | 
155 |   if (sendOwner && ownerToken && ownerChat) {
156 |     targets.push({ label: "OWNER", token: ownerToken, chat_id: ownerChat });
157 |   } else if (sendOwner) {
158 |     log.warn("TELEGRAM", "OWNER w≈ÇƒÖczony, ale brak tokena lub chat_id");
159 |   }
160 | 
161 |   if (sendClient && clientToken && clientChat) {
162 |     targets.push({ label: "CLIENT", token: clientToken, chat_id: clientChat });
163 |   } else if (sendClient) {
164 |     log.warn("TELEGRAM", "CLIENT w≈ÇƒÖczony, ale brak tokena lub chat_id");
165 |   }
166 | 
167 |   return targets;
168 | }
169 | 
170 | /**
171 |  * 1 komentarz => wysy≈Çka na 2 Telegramy:
172 |  * - Tw√≥j (Twoim botem)
173 |  * - Klienta (botem klienta)
174 |  */
175 | async function sendTelegramLead(post, comment) {
176 |   const targets = getTargets();
177 |   if (!targets.length) return;
178 | 
179 |   const usePhoto = envBool("TELEGRAM_USE_PHOTO", true);
180 |   const disablePreview = envBool("TELEGRAM_DISABLE_WEB_PAGE_PREVIEW", true);
181 | 
182 |   const caption = buildCaptionHtml(post, comment);
183 |   const img = String(post?.image || "").trim();
184 | 
185 |   for (const t of targets) {
186 |     if (usePhoto && img) {
187 |       const r1 = await sendPhoto(t.token, t.chat_id, img, caption, {
188 |         parse_mode: "HTML",
189 |       });
190 |       if (r1.ok) {
191 |         log.dev("TELEGRAM", `Wys≈Çano lead (photo) ‚Üí ${t.label}`);
192 |         await new Promise((r) => setTimeout(r, 350));
193 |         continue;
194 |       }
195 |       log.dev("TELEGRAM", `sendPhoto failed (${t.label}) ‚Üí fallback`, { error: r1.error });
196 |     }
197 | 
198 |     const r2 = await sendMessage(t.token, t.chat_id, caption, {
199 |       parse_mode: "HTML",
200 |       disable_web_page_preview: disablePreview,
201 |     });
202 | 
203 |     if (r2.ok) log.dev("TELEGRAM", `Wys≈Çano lead (message) ‚Üí ${t.label}`);
204 |     else log.error("TELEGRAM", `sendMessage error (${t.label}): ${r2.error}`);
205 | 
206 |     await new Promise((r) => setTimeout(r, 350));
207 |   }
208 | }
209 | 
210 | async function sendTelegramLeads(post, comments = []) {
211 |   for (const c of comments) {
212 |     await sendTelegramLead(post, c);
213 |     await new Promise((r) => setTimeout(r, 250));
214 |   }
215 | }
216 | 
217 | /* ============================================================
218 |    =======================  ALERTY OWNER  ======================
219 |    ============================================================ */
220 | 
221 | let _lastAlertAt = 0;
222 | let _lastAlertKey = "";
223 | let _repeatCount = 0;
224 | 
225 | function shorten(s, max) {
226 |   const x = String(s ?? "");
227 |   if (x.length <= max) return x;
228 |   return x.slice(0, max - 12) + "\n‚Ä¶(obciƒôto)‚Ä¶";
229 | }
230 | 
231 | function makeAlertKey(title, msg) {
232 |   const a = String(title || "").slice(0, 80);
233 |   const b = String(msg || "").slice(0, 200);
234 |   return `${a}::${b}`;
235 | }
236 | 
237 | async function sendOwnerAlert(title, message, opts = {}) {
238 |   if (!envBool("TG_ALERTS_ENABLED", true)) return;
239 | 
240 |   const token = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
241 |   const chatId = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
242 |   if (!token || !chatId) return;
243 | 
244 |   const cooldownSec = Number(process.env.TG_ALERTS_COOLDOWN_SEC || "120");
245 |   const maxLen = Number(process.env.TG_ALERTS_MAXLEN || "3500");
246 |   const tz = String(process.env.TG_ALERTS_TIMEZONE || "Europe/Warsaw").trim();
247 | 
248 |   const now = Date.now();
249 |   const key = makeAlertKey(title, message);
250 | 
251 |   // Anti-spam: je≈õli to samo w k√≥≈Çko w cooldownie, nie spamuj ‚Äî tylko licz
252 |   if (key === _lastAlertKey && now - _lastAlertAt < cooldownSec * 1000) {
253 |     _repeatCount++;
254 |     return;
255 |   }
256 | 
257 |   // Je≈õli wcze≈õniej co≈õ siƒô powtarza≈Ço, do≈õlij podsumowanie
258 |   if (_repeatCount > 0) {
259 |     const summary = `<b>‚ö†Ô∏è PowtarzajƒÖce siƒô b≈Çƒôdy</b>\n\nPoprzedni alert powt√≥rzy≈Ç siƒô <b>${_repeatCount}</b> razy w kr√≥tkim czasie.`;
260 |     await sendMessage(token, chatId, summary, { parse_mode: "HTML" }).catch(
261 |       () => {}
262 |     );
263 |     _repeatCount = 0;
264 |   }
265 | 
266 |   _lastAlertAt = now;
267 |   _lastAlertKey = key;
268 | 
269 |   // Lokalny czas PL (nie UTC)
270 |   const dt = new Date();
271 |   const tsLocal = new Intl.DateTimeFormat("pl-PL", {
272 |     timeZone: tz,
273 |     year: "numeric",
274 |     month: "2-digit",
275 |     day: "2-digit",
276 |     hour: "2-digit",
277 |     minute: "2-digit",
278 |     second: "2-digit",
279 |   }).format(dt);
280 | 
281 |   // Dla pewno≈õci dopisujemy te≈º UTC (kr√≥tkie), ≈ºeby ≈Çatwiej by≈Ço debugowaƒá serwer
282 |   const tsUtc = dt.toISOString().replace("T", " ").replace("Z", " UTC");
283 | 
284 |   const text =
285 |     `<b>üö® FB_Watcher ‚Äì ALERT</b>\n` +
286 |     `<b>üïí</b> ${escapeHtml(tsLocal)} (${escapeHtml(tz)})\n` +
287 |     `<b>üåç</b> ${escapeHtml(tsUtc)}\n\n` +
288 |     `<b>${escapeHtml(title || "B≈ÇƒÖd")}</b>\n\n` +
289 |     `<pre>${escapeHtml(shorten(message, maxLen))}</pre>`;
290 | 
291 |   const r = await sendMessage(token, chatId, text, {
292 |     parse_mode: "HTML",
293 |     disable_web_page_preview: true,
294 |   });
295 | 
296 |   if (!r.ok) {
297 |     // nie r√≥b pƒôtli error->alert->error
298 |     log.dev("TELEGRAM", `Alert nie wys≈Çany: ${r.error}`);
299 |   }
300 | }
301 | 
302 | 
303 | export { sendTelegramLead, sendTelegramLeads, sendOwnerAlert };
304 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/logger.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  

```js
  1 | // src/utils/logger.js
  2 | // Ujednolicony system logowania z poziomami: SILENT(0), PROD(1), DEV(2), DEBUG(3)
  3 | 
  4 | /**
  5 |  * LOG_LEVEL:
  6 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
  7 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny)
  8 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings
  9 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info
 10 |  */
 11 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
 12 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
 13 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
 14 | 
 15 | // ANSI kolory
 16 | const colors = {
 17 |   reset: "\x1b[0m",
 18 |   dim: "\x1b[2m",
 19 |   red: "\x1b[31m",
 20 |   green: "\x1b[32m",
 21 |   yellow: "\x1b[33m",
 22 |   blue: "\x1b[34m",
 23 |   magenta: "\x1b[35m",
 24 |   cyan: "\x1b[36m",
 25 |   white: "\x1b[37m",
 26 |   gray: "\x1b[90m",
 27 | };
 28 | 
 29 | // Kolory dla modu≈Ç√≥w
 30 | const moduleColors = {
 31 |   WATCHER: colors.cyan,
 32 |   NAV: colors.blue,
 33 |   "UI:post": colors.magenta,
 34 |   "UI:videos": colors.magenta,
 35 |   "UI:photo": colors.magenta,
 36 |   "UI:watch": colors.magenta,
 37 |   FILTER: colors.yellow,
 38 |   EXTRACT: colors.green,
 39 |   DEDUP: colors.gray,
 40 |   TELEGRAM: colors.blue,
 41 |   WEBHOOK: colors.blue,
 42 |   API: colors.cyan,
 43 |   COOKIES: colors.gray,
 44 |   LOGIN: colors.yellow,
 45 |   ERROR: colors.red,
 46 |   FAST: colors.green,
 47 | };
 48 | 
 49 | function c(color, text) {
 50 |   if (!LOG_COLORS) return text;
 51 |   return `${color}${text}${colors.reset}`;
 52 | }
 53 | 
 54 | function timestamp() {
 55 |   if (!LOG_TIMESTAMPS) return "";
 56 |   const now = new Date();
 57 |   const hh = String(now.getHours()).padStart(2, "0");
 58 |   const mm = String(now.getMinutes()).padStart(2, "0");
 59 |   const ss = String(now.getSeconds()).padStart(2, "0");
 60 |   return c(colors.dim, `[${hh}:${mm}:${ss}]`) + " ";
 61 | }
 62 | 
 63 | function formatModule(mod) {
 64 |   const color = moduleColors[mod] || colors.white;
 65 |   return c(color, `[${mod}]`);
 66 | }
 67 | 
 68 | function formatData(data) {
 69 |   if (data === undefined || data === null) return "";
 70 |   if (typeof data === "string") return ` ${c(colors.dim, data)}`;
 71 |   if (typeof data === "number") return ` ${c(colors.dim, String(data))}`;
 72 | 
 73 |   // Object - poka≈º kluczowe info
 74 |   try {
 75 |     const keys = Object.keys(data);
 76 |     if (keys.length === 0) return "";
 77 | 
 78 |     const parts = [];
 79 |     for (const k of keys.slice(0, 5)) {
 80 |       const v = data[k];
 81 |       if (v === undefined || v === null) continue;
 82 |       if (typeof v === "string" && v.length > 50) {
 83 |         parts.push(`${k}:"${v.slice(0, 47)}..."`);
 84 |       } else if (typeof v === "object") {
 85 |         parts.push(`${k}:{...}`);
 86 |       } else {
 87 |         parts.push(`${k}:${JSON.stringify(v)}`);
 88 |       }
 89 |     }
 90 |     if (keys.length > 5) parts.push(`+${keys.length - 5} more`);
 91 |     return ` ${c(colors.dim, `(${parts.join(", ")})`)}`;
 92 |   } catch {
 93 |     return "";
 94 |   }
 95 | }
 96 | 
 97 | function formatDataFull(data) {
 98 |   if (data === undefined || data === null) return "";
 99 |   try {
100 |     return `\n${c(colors.dim, JSON.stringify(data, null, 2))}`;
101 |   } catch {
102 |     return "";
103 |   }
104 | }
105 | 
106 | /**
107 |  * Logger g≈Ç√≥wny
108 |  */
109 | const log = {
110 |   /** Poziom 0+ - B≈Çƒôdy krytyczne (zawsze pokazywane) */
111 |   error(mod, msg, data) {
112 |     const prefix = timestamp() + formatModule(mod || "ERROR");
113 |     console.error(`${prefix} ${c(colors.red, "‚úó")} ${msg}${formatData(data)}`);
114 |   },
115 | 
116 |   /** Poziom 0+ - Ostrze≈ºenia (zawsze pokazywane) */
117 |   warn(mod, msg, data) {
118 |     const prefix = timestamp() + formatModule(mod || "WARN");
119 |     console.warn(`${prefix} ${c(colors.yellow, "‚ö†")} ${msg}${formatData(data)}`);
120 |   },
121 | 
122 |   /** Poziom 1+ - PROD: Status cykli, nowe komentarze, kluczowe zdarzenia */
123 |   prod(mod, msg, data) {
124 |     if (LOG_LEVEL < 1) return;
125 |     const prefix = timestamp() + formatModule(mod);
126 |     console.log(`${prefix} ${msg}${formatData(data)}`);
127 |   },
128 | 
129 |   /** Poziom 1+ - PROD z ikonƒÖ sukcesu */
130 |   success(mod, msg, data) {
131 |     if (LOG_LEVEL < 1) return;
132 |     const prefix = timestamp() + formatModule(mod);
133 |     console.log(`${prefix} ${c(colors.green, "‚úì")} ${msg}${formatData(data)}`);
134 |   },
135 | 
136 |   /** Poziom 2+ - DEV: Szczeg√≥≈Çy operacji, timings */
137 |   dev(mod, msg, data) {
138 |     if (LOG_LEVEL < 2) return;
139 |     const prefix = timestamp() + formatModule(mod);
140 |     console.log(`${prefix} ${msg}${formatData(data)}`);
141 |   },
142 | 
143 |   /** Poziom 3+ - DEBUG: Pe≈Çne dumpy, payloady, DOM info */
144 |   debug(mod, msg, data) {
145 |     if (LOG_LEVEL < 3) return;
146 |     const prefix = timestamp() + formatModule(mod);
147 |     console.log(`${prefix} ${c(colors.gray, "[DBG]")} ${msg}${formatDataFull(data)}`);
148 |   },
149 | 
150 |   /** Separator wizualny (poziom 1+) */
151 |   separator(char = "‚îÄ", length = 50) {
152 |     if (LOG_LEVEL < 1) return;
153 |     console.log(c(colors.dim, char.repeat(length)));
154 |   },
155 | 
156 |   /** Nag≈Ç√≥wek sekcji (poziom 1+) */
157 |   header(title) {
158 |     if (LOG_LEVEL < 1) return;
159 |     console.log("");
160 |     console.log(c(colors.cyan, `‚ïê‚ïê‚ïê ${title} ${"‚ïê".repeat(Math.max(0, 44 - title.length))}`));
161 |   },
162 | 
163 |   /** Podsumowanie cyklu (poziom 1+) */
164 |   cycleSummary({ cycle, posts, newComments, duration, errors = 0, cacheSize = 0, cacheEntries = 0, totalKnownIds = 0 }) {
165 |     if (LOG_LEVEL < 1) return;
166 |     const prefix = timestamp() + formatModule("WATCHER");
167 |     const status = errors > 0 ? c(colors.yellow, `‚ö† ${errors} err`) : c(colors.green, "‚úì");
168 |     const durationStr = duration ? ` (${(duration / 1000).toFixed(1)}s)` : "";
169 |     console.log(
170 |       `${prefix} Cykl #${cycle} done: ${posts} post√≥w, ${c(colors.green, `+${newComments}`)} nowych${durationStr} ${status}`
171 |     );
172 | 
173 |     // Metryki cache (poziom 2+ - DEV)
174 |     if (LOG_LEVEL >= 2 && (cacheSize > 0 || totalKnownIds > 0)) {
175 |       const cacheSizeStr = cacheSize > 0 ? `${Math.round(cacheSize / 1024)}KB` : "0KB";
176 |       console.log(
177 |         `${prefix} ${c(colors.dim, `Cache: ${cacheSizeStr}, ${cacheEntries} post√≥w, ${totalKnownIds} knownIds`)}`
178 |       );
179 |     }
180 |   },
181 | 
182 |   /** Aktualny poziom logowania */
183 |   get level() {
184 |     return LOG_LEVEL;
185 |   },
186 | 
187 |   /** Czy dany poziom jest w≈ÇƒÖczony */
188 |   isEnabled(level) {
189 |     return LOG_LEVEL >= level;
190 |   },
191 | };
192 | 
193 | // Sta≈Çe poziom√≥w do eksportu
194 | const LEVELS = {
195 |   SILENT: 0,
196 |   PROD: 1,
197 |   DEV: 2,
198 |   DEBUG: 3,
199 | };
200 | 
201 | export { log, LEVELS };
202 | export default log;
203 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/mouse.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  

```js
  1 | // src/utils/mouse.js
  2 | // Human Behavior Mode - symulacja ruch√≥w myszy krzywymi Beziera
  3 | 
  4 | import { gaussianRandom, sleep } from "./sleep.js";
  5 | 
  6 | /**
  7 |  * Oblicza punkt na krzywej Beziera (3. stopnia)
  8 |  * @param {number} t - parametr 0-1
  9 |  * @param {number} p0 - punkt startowy
 10 |  * @param {number} p1 - punkt kontrolny 1
 11 |  * @param {number} p2 - punkt kontrolny 2
 12 |  * @param {number} p3 - punkt ko≈Ñcowy
 13 |  * @returns {number}
 14 |  */
 15 | function bezierPoint(t, p0, p1, p2, p3) {
 16 |   const u = 1 - t;
 17 |   return (
 18 |     u * u * u * p0 +
 19 |     3 * u * u * t * p1 +
 20 |     3 * u * t * t * p2 +
 21 |     t * t * t * p3
 22 |   );
 23 | }
 24 | 
 25 | /**
 26 |  * Generuje ≈õcie≈ºkƒô ruchu myszy miƒôdzy dwoma punktami
 27 |  * u≈ºywajƒÖc krzywej Beziera z losowymi punktami kontrolnymi
 28 |  * @param {number} startX
 29 |  * @param {number} startY
 30 |  * @param {number} endX
 31 |  * @param {number} endY
 32 |  * @param {number} steps - liczba krok√≥w (wiƒôcej = p≈Çynniej)
 33 |  * @returns {Array<{x: number, y: number}>}
 34 |  */
 35 | function generateBezierPath(startX, startY, endX, endY, steps = 25) {
 36 |   const path = [];
 37 | 
 38 |   // Losowe punkty kontrolne - dodajƒÖ "ludzkƒÖ" krzywo≈õƒá
 39 |   const dx = endX - startX;
 40 |   const dy = endY - startY;
 41 |   const distance = Math.sqrt(dx * dx + dy * dy);
 42 | 
 43 |   // Punkty kontrolne odsuniƒôte o 20-40% odleg≈Ço≈õci w losowym kierunku
 44 |   const offset1 = gaussianRandom(distance * 0.3, distance * 0.1);
 45 |   const angle1 = Math.random() * Math.PI * 2;
 46 |   const cp1x = startX + dx * 0.3 + Math.cos(angle1) * offset1;
 47 |   const cp1y = startY + dy * 0.3 + Math.sin(angle1) * offset1;
 48 | 
 49 |   const offset2 = gaussianRandom(distance * 0.3, distance * 0.1);
 50 |   const angle2 = Math.random() * Math.PI * 2;
 51 |   const cp2x = startX + dx * 0.7 + Math.cos(angle2) * offset2;
 52 |   const cp2y = startY + dy * 0.7 + Math.sin(angle2) * offset2;
 53 | 
 54 |   for (let i = 0; i <= steps; i++) {
 55 |     const t = i / steps;
 56 | 
 57 |     // Easing - wolniej na poczƒÖtku i ko≈Ñcu (naturalny ruch)
 58 |     const easedT = t < 0.5
 59 |       ? 2 * t * t
 60 |       : 1 - Math.pow(-2 * t + 2, 2) / 2;
 61 | 
 62 |     const x = bezierPoint(easedT, startX, cp1x, cp2x, endX);
 63 |     const y = bezierPoint(easedT, startY, cp1y, cp2y, endY);
 64 | 
 65 |     path.push({ x: Math.round(x), y: Math.round(y) });
 66 |   }
 67 | 
 68 |   return path;
 69 | }
 70 | 
 71 | /**
 72 |  * Przesuwa mysz wzd≈Çu≈º ≈õcie≈ºki Beziera
 73 |  * @param {import('puppeteer').Page} page
 74 |  * @param {number} startX
 75 |  * @param {number} startY
 76 |  * @param {number} endX
 77 |  * @param {number} endY
 78 |  * @returns {Promise<void>}
 79 |  */
 80 | async function moveMouse(page, startX, startY, endX, endY) {
 81 |   const distance = Math.sqrt(
 82 |     Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)
 83 |   );
 84 | 
 85 |   // Wiƒôcej krok√≥w dla d≈Çu≈ºszych ruch√≥w
 86 |   const steps = Math.max(15, Math.min(50, Math.round(distance / 15)));
 87 |   const path = generateBezierPath(startX, startY, endX, endY, steps);
 88 | 
 89 |   for (const point of path) {
 90 |     await page.mouse.move(point.x, point.y);
 91 | 
 92 |     // Losowe op√≥≈∫nienie miƒôdzy ruchami (5-15ms)
 93 |     const moveDelay = gaussianRandom(10, 3);
 94 |     await sleep(Math.max(3, Math.min(20, moveDelay)));
 95 |   }
 96 | }
 97 | 
 98 | /**
 99 |  * Pobiera pozycjƒô ≈õrodka elementu
100 |  * @param {import('puppeteer').ElementHandle} element
101 |  * @returns {Promise<{x: number, y: number}>}
102 |  */
103 | async function getElementCenter(element) {
104 |   const box = await element.boundingBox();
105 |   if (!box) return null;
106 | 
107 |   return {
108 |     x: box.x + box.width / 2,
109 |     y: box.y + box.height / 2,
110 |   };
111 | }
112 | 
113 | /**
114 |  * Przesuwa mysz do elementu u≈ºywajƒÖc krzywej Beziera
115 |  * @param {import('puppeteer').Page} page
116 |  * @param {import('puppeteer').ElementHandle} element
117 |  * @returns {Promise<boolean>} - true je≈õli sukces
118 |  */
119 | async function moveToElement(page, element) {
120 |   try {
121 |     const target = await getElementCenter(element);
122 |     if (!target) return false;
123 | 
124 |     // Pobierz aktualnƒÖ pozycjƒô myszy (domy≈õlnie ≈õrodek ekranu)
125 |     const viewport = page.viewport();
126 |     const currentX = viewport ? viewport.width / 2 : 500;
127 |     const currentY = viewport ? viewport.height / 2 : 300;
128 | 
129 |     // Dodaj ma≈ÇƒÖ losowo≈õƒá do punktu docelowego (nie celuj idealnie w ≈õrodek)
130 |     const offsetX = gaussianRandom(0, 3);
131 |     const offsetY = gaussianRandom(0, 3);
132 | 
133 |     await moveMouse(
134 |       page,
135 |       currentX,
136 |       currentY,
137 |       target.x + offsetX,
138 |       target.y + offsetY
139 |     );
140 | 
141 |     return true;
142 |   } catch {
143 |     return false;
144 |   }
145 | }
146 | 
147 | /**
148 |  * Human-like klikniƒôcie - ruch myszy + klik z ma≈Çym op√≥≈∫nieniem
149 |  * @param {import('puppeteer').Page} page
150 |  * @param {import('puppeteer').ElementHandle} element
151 |  * @returns {Promise<boolean>} - true je≈õli sukces
152 |  */
153 | async function humanClick(page, element) {
154 |   try {
155 |     // Ruch do elementu
156 |     const moved = await moveToElement(page, element);
157 |     if (!moved) {
158 |       // Fallback do normalnego kliku
159 |       await element.click().catch(() => {});
160 |       return true;
161 |     }
162 | 
163 |     // Ma≈Çe op√≥≈∫nienie przed klikiem (50-150ms)
164 |     const preClickDelay = gaussianRandom(100, 30);
165 |     await sleep(Math.max(40, Math.min(200, preClickDelay)));
166 | 
167 |     // Klik
168 |     await page.mouse.click(
169 |       (await getElementCenter(element)).x,
170 |       (await getElementCenter(element)).y
171 |     );
172 | 
173 |     // Ma≈Çe op√≥≈∫nienie po kliku (30-100ms)
174 |     const postClickDelay = gaussianRandom(60, 20);
175 |     await sleep(Math.max(20, Math.min(120, postClickDelay)));
176 | 
177 |     return true;
178 |   } catch {
179 |     // Fallback
180 |     await element.click().catch(() => {});
181 |     return true;
182 |   }
183 | }
184 | 
185 | /**
186 |  * Losowy ruch myszy - symuluje "rozglƒÖdanie siƒô" po stronie
187 |  * @param {import('puppeteer').Page} page
188 |  * @returns {Promise<void>}
189 |  */
190 | async function randomMouseMovement(page) {
191 |   try {
192 |     const viewport = page.viewport();
193 |     if (!viewport) return;
194 | 
195 |     // Losowy punkt na stronie
196 |     const targetX = gaussianRandom(viewport.width / 2, viewport.width / 4);
197 |     const targetY = gaussianRandom(viewport.height / 2, viewport.height / 4);
198 | 
199 |     // Clamp do viewport
200 |     const clampedX = Math.max(50, Math.min(viewport.width - 50, targetX));
201 |     const clampedY = Math.max(50, Math.min(viewport.height - 50, targetY));
202 | 
203 |     const currentX = viewport.width / 2;
204 |     const currentY = viewport.height / 2;
205 | 
206 |     await moveMouse(page, currentX, currentY, clampedX, clampedY);
207 |   } catch {
208 |     // Ignoruj b≈Çƒôdy - to tylko dodatkowa symulacja
209 |   }
210 | }
211 | 
212 | export {
213 |   generateBezierPath,
214 |   moveMouse,
215 |   moveToElement,
216 |   humanClick,
217 |   randomMouseMovement,
218 | };
219 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/navigation.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  

```js
 1 | // src/utils/navigation.js
 2 | import { sleepRandom } from "./sleep.js";
 3 | import log from "./logger.js";
 4 | 
 5 | /**
 6 |  * Bezpieczne page.goto z retry.
 7 |  * - pr√≥buje kilka razy
 8 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
 9 |  */
10 | export async function safeGoto(page, url, label = "goto", options = {}) {
11 |   const MAX_ATTEMPTS = 3;
12 | 
13 |   const finalOptions = {
14 |     waitUntil: "networkidle2",
15 |     timeout: 90000, // 90s
16 |     ...options,
17 |   };
18 | 
19 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
20 |     try {
21 |       log.debug("NAV", `[${label}] Pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`);
22 | 
23 |       // === FORCE DESKTOP PROFILE (SERVER FIX) ===
24 |       await page.setViewport({ width: 1366, height: 768 });
25 |       // DISABLED UA // === END FORCE DESKTOP PROFILE ===
26 | 
27 |       await page.goto(url, finalOptions);
28 | 
29 |       log.debug("NAV", `[${label}] OK na pr√≥bie ${attempt}`);
30 |       return true;
31 |     } catch (err) {
32 |       log.warn("NAV", `[${label}] B≈ÇƒÖd pr√≥ba ${attempt}: ${err.message}`);
33 | 
34 |       if (attempt === MAX_ATTEMPTS) {
35 |         return false;
36 |       }
37 | 
38 |       await sleepRandom(3000, 7000);
39 | 
40 |       try {
41 |         log.debug("NAV", "Pr√≥ba od≈õwie≈ºenia FB...");
42 |         await page
43 |           .goto("https://www.facebook.com/", {
44 |             waitUntil: "load",
45 |             timeout: 45000,
46 |           })
47 |           .catch(() => {});
48 |       } catch (e2) {
49 |         log.warn("NAV", `Od≈õwie≈ºenie FB te≈º b≈ÇƒÖd: ${e2.message}`);
50 |       }
51 |     }
52 |   }
53 | 
54 |   // tu w praktyce nie dojdziemy
55 |   return false;
56 | }
57 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/sleep.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  

```js
  1 | // src/utils/sleep.js
  2 | // Human Behavior Mode - op√≥≈∫nienia symulujƒÖce cz≈Çowieka
  3 | 
  4 | /**
  5 |  * Podstawowy sleep
  6 |  */
  7 | function sleep(ms) {
  8 |   return new Promise((res) => setTimeout(res, ms));
  9 | }
 10 | 
 11 | /**
 12 |  * Sleep z losowym op√≥≈∫nieniem (jednolity rozk≈Çad)
 13 |  */
 14 | function sleepRandom(minMs, maxMs) {
 15 |   const delta = maxMs - minMs;
 16 |   const extra = Math.random() * delta;
 17 |   return sleep(minMs + extra);
 18 | }
 19 | 
 20 | /**
 21 |  * Generuje losowƒÖ warto≈õƒá z rozk≈Çadu normalnego (Gaussa)
 22 |  * Box-Muller transform
 23 |  * @param {number} mean - ≈õrednia
 24 |  * @param {number} stdDev - odchylenie standardowe
 25 |  * @returns {number}
 26 |  */
 27 | function gaussianRandom(mean, stdDev) {
 28 |   let u1, u2;
 29 |   do {
 30 |     u1 = Math.random();
 31 |     u2 = Math.random();
 32 |   } while (u1 === 0); // u1 nie mo≈ºe byƒá 0
 33 | 
 34 |   const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
 35 |   return mean + z * stdDev;
 36 | }
 37 | 
 38 | /**
 39 |  * Ludzkie op√≥≈∫nienie z rozk≈Çadem Gaussa
 40 |  * @param {number} baseMs - bazowe op√≥≈∫nienie (≈õrednia)
 41 |  * @param {number} variance - wariancja jako procent (0.0-1.0)
 42 |  * @returns {Promise<void>}
 43 |  */
 44 | async function humanDelay(baseMs, variance = 0.3) {
 45 |   const stdDev = baseMs * variance;
 46 |   let delay = gaussianRandom(baseMs, stdDev);
 47 | 
 48 |   // Clamp do rozsƒÖdnych warto≈õci (50% - 200% ≈õredniej)
 49 |   delay = Math.max(baseMs * 0.5, Math.min(baseMs * 2, delay));
 50 | 
 51 |   return sleep(delay);
 52 | }
 53 | 
 54 | /**
 55 |  * Op√≥≈∫nienie przy pisaniu - symuluje ludzkƒÖ szybko≈õƒá
 56 |  * ≈örednio ~120ms na znak, z mikro-pauzami
 57 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
 58 |  */
 59 | async function humanTypingDelay() {
 60 |   // Rozk≈Çad: ≈õrednia 120ms, stdDev 40ms
 61 |   let delay = gaussianRandom(120, 40);
 62 | 
 63 |   // Clamp: 60-250ms na znak
 64 |   delay = Math.max(60, Math.min(250, delay));
 65 | 
 66 |   // 5% szansa na mikro-pauzƒô (jakby cz≈Çowiek my≈õla≈Ç)
 67 |   if (Math.random() < 0.05) {
 68 |     delay += gaussianRandom(300, 100);
 69 |   }
 70 | 
 71 |   await sleep(delay);
 72 |   return delay;
 73 | }
 74 | 
 75 | /**
 76 |  * Pauza miƒôdzy postami - 3-8 sekund z rozk≈Çadem Gaussa
 77 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
 78 |  */
 79 | async function betweenPostsPause() {
 80 |   // ≈örednia 5.5s, stdDev 1.2s ‚Üí wiƒôkszo≈õƒá w zakresie 3-8s
 81 |   let delay = gaussianRandom(5500, 1200);
 82 | 
 83 |   // Clamp: 3-10 sekund
 84 |   delay = Math.max(3000, Math.min(10000, delay));
 85 | 
 86 |   await sleep(delay);
 87 |   return delay;
 88 | }
 89 | 
 90 | /**
 91 |  * Wpisuje tekst znak po znaku z ludzkimi op√≥≈∫nieniami
 92 |  * @param {import('puppeteer').ElementHandle} element - input element
 93 |  * @param {string} text - tekst do wpisania
 94 |  * @param {import('puppeteer').Page} page - strona (do keyboard)
 95 |  * @returns {Promise<void>}
 96 |  */
 97 | async function humanType(element, text, page) {
 98 |   for (let i = 0; i < text.length; i++) {
 99 |     const char = text[i];
100 | 
101 |     // Wpisz znak
102 |     await page.keyboard.type(char);
103 | 
104 |     // Op√≥≈∫nienie miƒôdzy znakami
105 |     await humanTypingDelay();
106 |   }
107 | }
108 | 
109 | /**
110 |  * Fisher-Yates shuffle - randomizacja tablicy
111 |  * @param {Array} array - tablica do pomieszania
112 |  * @returns {Array} - nowa, pomieszana tablica
113 |  */
114 | function shuffleArray(array) {
115 |   const shuffled = [...array];
116 |   for (let i = shuffled.length - 1; i > 0; i--) {
117 |     const j = Math.floor(Math.random() * (i + 1));
118 |     [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
119 |   }
120 |   return shuffled;
121 | }
122 | 
123 | export {
124 |   sleep,
125 |   sleepRandom,
126 |   gaussianRandom,
127 |   humanDelay,
128 |   humanTypingDelay,
129 |   betweenPostsPause,
130 |   humanType,
131 |   shuffleArray,
132 | };
133 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/time.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  

```js
 1 | // src/utils/time.js
 2 | import log from "./logger.js";
 3 | 
 4 | /**
 5 |  * Parser wzglƒôdnego czasu FB ‚Üí Date
 6 |  * np. "2 min", "3 godz", "wczoraj"
 7 |  */
 8 | export function parseFbRelativeTime(raw) {
 9 |   if (!raw) return null;
10 | 
11 |   const t = raw.toLowerCase().trim();
12 |   const now = new Date();
13 | 
14 |   if (t.includes("przed chwilƒÖ") || t === "teraz" || t === "now" || t === "just now") {
15 |     return now;
16 |   }
17 | 
18 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
19 |     const d = new Date(now);
20 |     d.setDate(d.getDate() - 1);
21 |     return d;
22 |   }
23 | 
24 |   const m = t.match(/(\d+)\s*(sek|sec|min|minut|godz|hour|h|dni|day|tyg|week)/i);
25 |   if (!m) return null;
26 | 
27 |   const value = parseInt(m[1], 10);
28 |   if (!Number.isFinite(value)) return null;
29 | 
30 |   const unit = m[2].toLowerCase();
31 |   const d = new Date(now);
32 | 
33 |   if (unit.startsWith("sek") || unit.startsWith("sec")) d.setSeconds(d.getSeconds() - value);
34 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
35 |   else if (unit.startsWith("godz") || unit.startsWith("hour") || unit === "h") d.setHours(d.getHours() - value);
36 |   else if (unit.startsWith("dni") || unit.startsWith("day")) d.setDate(d.getDate() - value);
37 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
38 | 
39 |   return d;
40 | }
41 | 
42 | /**
43 |  * Filtruje komentarze - zostawia tylko te m≈Çodsze ni≈º maxAgeMin
44 |  */
45 | export function filterByAge(comments, maxAgeMin = 60) {
46 |   const now = Date.now();
47 | 
48 |   return comments.filter((c) => {
49 |     const rel = (c?.fb_time_raw || c?.time || "").trim();
50 |     if (!rel) return false;
51 | 
52 |     const abs = parseFbRelativeTime(rel);
53 |     if (!abs) return false;
54 | 
55 |     const ageMinutes = (now - abs.getTime()) / 60000;
56 |     log.debug("TIME", "Age filter", {
57 |       raw: rel,
58 |       ageMin: Math.round(ageMinutes * 10) / 10,
59 |       maxAgeMin,
60 |     });
61 |     return ageMinutes <= maxAgeMin;
62 |   });
63 | }
64 | 
```

---

### üìÑ ≈öcie≈ºka: `src/watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  

```js
   1 | // src/watcher.js
   2 | import puppeteer from "puppeteer-extra";
   3 | import StealthPlugin from "puppeteer-extra-plugin-stealth";
   4 | import RecaptchaPlugin from "puppeteer-extra-plugin-recaptcha";
   5 | 
   6 | // Stealth Plugin - ukrywa automatyzacjƒô (ZAWSZE pierwszy)
   7 | puppeteer.use(StealthPlugin());
   8 | console.log("[STEALTH] Plugin stealth w≈ÇƒÖczony");
   9 | import fs from "fs";
  10 | import path from "path";
  11 | import {
  12 |   EXPAND_COMMENTS,
  13 |   CHECK_INTERVAL_MS,
  14 |   POSTS_SHEET_URL,
  15 |   POSTS_REFRESH_MS,
  16 |   FAST_MODE,
  17 |   FAST_MAX_AGE_MIN,
  18 |   POSTS_API_URL,
  19 |   POSTS_API_TOKEN,
  20 |   CAPTCHA_API_KEY,
  21 |   CAPTCHA_ENABLED,
  22 |   REMOTE_DEBUG_PORT,
  23 |   HUMAN_MODE,
  24 |   PROXY_URL,
  25 | } from "./config.js";
  26 | 
  27 | // Konfiguracja captcha solver (2Captcha)
  28 | if (CAPTCHA_ENABLED && CAPTCHA_API_KEY) {
  29 |   puppeteer.use(
  30 |     RecaptchaPlugin({
  31 |       provider: {
  32 |         id: "2captcha",
  33 |         token: CAPTCHA_API_KEY,
  34 |       },
  35 |       visualFeedback: true,
  36 |     })
  37 |   );
  38 |   console.log("[CAPTCHA] 2Captcha solver w≈ÇƒÖczony");
  39 | }
  40 | 
  41 | import {
  42 |   prepare,
  43 |   getCommentCount,
  44 |   loadAllComments,
  45 |   extractCommentsData,
  46 |   switchCommentsFilterToNewest,
  47 | } from "./fb/comments.js";
  48 | 
  49 | import { loadCookies, saveCookies } from "./fb/cookies.js";
  50 | import { checkIfLogged, fbLogin, solveCaptchaIfPresent } from "./fb/login.js";
  51 | import { isCheckpoint, getCheckpointType } from "./fb/checkpoint.js";
  52 | import { parseFbRelativeTime, filterByAge } from "./utils/time.js";
  53 | import { shuffleArray, betweenPostsPause } from "./utils/sleep.js";
  54 | import { loadCache, saveCache, getCacheSize, getCacheEntryCount } from "./db/cache.js";
  55 | import { sendTelegramLeads, sendOwnerAlert } from "./telegram.js";
  56 | import log from "./utils/logger.js";
  57 | 
  58 | /**
  59 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
  60 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
  61 |  */
  62 | const POSTS_FILE =
  63 |   process.env.POSTS_FILE || path.join(process.cwd(), "data", "posts.json");
  64 | 
  65 | /**
  66 |  * CACHE DYSKOWY
  67 |  */
  68 | const commentsCache = loadCache();
  69 | const lastCounts = new Map();
  70 | const knownCommentsPerPost = new Map();
  71 | 
  72 | // Limity dla knownIds - zapobiega memory leak
  73 | const MAX_KNOWN_IDS_PER_POST = 1000;  // max komentarzy na post w pamiƒôci
  74 | const KNOWN_IDS_TRIM_TO = 800;        // do ilu przycinaƒá gdy przekroczy limit
  75 | 
  76 | for (const [url, entry] of Object.entries(commentsCache)) {
  77 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
  78 |   if (Array.isArray(entry?.knownIds)) {
  79 |     // Przytnij podczas ≈Çadowania je≈õli za du≈ºo
  80 |     const ids = entry.knownIds.slice(-MAX_KNOWN_IDS_PER_POST);
  81 |     knownCommentsPerPost.set(url, new Set(ids));
  82 |   }
  83 | }
  84 | 
  85 | let currentPosts = [];
  86 | let lastRefreshAny = 0;
  87 | let cycleNumber = 0;
  88 | 
  89 | let navErrorCount = 0;
  90 | const MAX_NAV_ERRORS = 5;
  91 | 
  92 | function isNavigationError(err) {
  93 |   if (!err) return false;
  94 |   const msg = String(err.message || err).toLowerCase();
  95 |   return (
  96 |     msg.includes("safegoto-failed") ||
  97 |     msg.includes("navigation timeout") ||
  98 |     msg.includes("net::err_connection_timed_out") ||
  99 |     msg.includes("net::err_timed_out")
 100 |   );
 101 | }
 102 | 
 103 | function envBool(name, def = false) {
 104 |   const raw = String(process.env[name] ?? "").trim().toLowerCase();
 105 |   if (raw === "") return def;
 106 |   return ["1", "true", "yes", "y", "tak", "on"].includes(raw);
 107 | }
 108 | 
 109 | // ================== FAST_MODE HELPER ==================
 110 | function getCommentAgeMinutes(timeStr) {
 111 |   if (!timeStr) return null;
 112 |   const abs = parseFbRelativeTime(timeStr);
 113 |   if (!abs) return null;
 114 |   return (Date.now() - abs.getTime()) / 60000;
 115 | }
 116 | 
 117 | // ================== TELEGRAM (FILTER AGE) ==================
 118 | async function sendTelegramIfFresh(post, comments, ctx = "normal") {
 119 |   const list = Array.isArray(comments) ? comments : [];
 120 |   if (list.length === 0) return;
 121 | 
 122 |   const now = Date.now();
 123 | 
 124 |   const normalized = list.map((c) => {
 125 |     const rel = String(c?.fb_time_raw || c?.time || "").trim();
 126 |     const abs = parseFbRelativeTime(rel);
 127 |     const iso = abs ? abs.toISOString() : (c?.fb_time_iso || null);
 128 |     const ageMin = abs ? Math.round(((now - abs.getTime()) / 60000) * 10) / 10 : null;
 129 | 
 130 |     return {
 131 |       ...c,
 132 |       fb_time_raw: rel || null,
 133 |       fb_time_iso: iso,
 134 |       _ageMin: ageMin,
 135 |     };
 136 |   });
 137 | 
 138 |   // log wieku komentarzy (tylko DEBUG)
 139 |   for (const c of normalized) {
 140 |     log.debug("TELEGRAM", `Komentarz ${c?.id}`, {
 141 |       ctx,
 142 |       author: c?.author || c?.name,
 143 |       rel: c?.fb_time_raw,
 144 |       ageMin: c?._ageMin,
 145 |     });
 146 |   }
 147 | 
 148 |   const fresh = filterByAge(normalized);
 149 |   const maxAge = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 150 | 
 151 |   log.dev("TELEGRAM", `Filtr wieku: ${normalized.length} ‚Üí ${fresh.length}`, { ctx, maxAge });
 152 | 
 153 |   if (fresh.length > 0) {
 154 |     await sendTelegramLeads(post, fresh);
 155 |   } else {
 156 |     log.dev("TELEGRAM", "Brak ≈õwie≈ºych komentarzy - nic nie wysy≈Çam");
 157 |   }
 158 | }
 159 | 
 160 | /* ============================================================
 161 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
 162 |    ============================================================ */
 163 | 
 164 | async function applyStealth(page) {
 165 |   await page.evaluateOnNewDocument(() => {
 166 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
 167 |     window.chrome = window.chrome || { runtime: {} };
 168 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
 169 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
 170 | 
 171 |     const permissions = window.navigator.permissions;
 172 |     if (permissions && permissions.query) {
 173 |       const originalQuery = permissions.query.bind(permissions);
 174 |       permissions.query = (parameters) => {
 175 |         if (parameters && parameters.name === "notifications" && window.Notification) {
 176 |           return Promise.resolve({ state: window.Notification.permission });
 177 |         }
 178 |         return originalQuery(parameters);
 179 |       };
 180 |     }
 181 |   });
 182 | }
 183 | 
 184 | /* ============================================================
 185 |    ===============   PANEL POSTS (data/posts.json)   ===========
 186 |    ============================================================ */
 187 | 
 188 | function safeJsonParse(s) {
 189 |   try {
 190 |     return { ok: true, value: JSON.parse(s) };
 191 |   } catch (e) {
 192 |     return { ok: false, error: e?.message || "Invalid JSON" };
 193 |   }
 194 | }
 195 | 
 196 | function normalizeUrl(u) {
 197 |   if (!u) return "";
 198 |   const x = String(u).trim();
 199 |   if (!/^https?:\/\/.+/i.test(x)) return "";
 200 |   return x;
 201 | }
 202 | 
 203 | function makePostKey(url) {
 204 |   try {
 205 |     const u = new URL(String(url || "").trim());
 206 |     for (const k of Array.from(u.searchParams.keys())) {
 207 |       if (k.startsWith("__") || ["ref", "notif_id", "notif_t", "refid"].includes(k)) {
 208 |         u.searchParams.delete(k);
 209 |       }
 210 |     }
 211 |     if (u.pathname.includes("permalink.php")) {
 212 |       const s = u.searchParams.get("story_fbid");
 213 |       const id = u.searchParams.get("id");
 214 |       if (s && id) return `permalink:${id}:${s}`;
 215 |     }
 216 |     if (u.pathname.includes("story.php")) {
 217 |       const s = u.searchParams.get("story_fbid");
 218 |       const id = u.searchParams.get("id");
 219 |       if (s && id) return `story:${id}:${s}`;
 220 |     }
 221 |     const mPosts = u.pathname.match(/\/posts\/([^/?#]+)/i);
 222 |     if (mPosts?.[1]) return `posts:${mPosts[1]}`;
 223 |     const v = u.searchParams.get("v");
 224 |     if (u.pathname.includes("/watch") && v) return `watch:${v}`;
 225 |     const mVid = u.pathname.match(/\/videos\/([^/?#]+)/i);
 226 |     if (mVid?.[1]) return `videos:${mVid[1]}`;
 227 |     const q = u.searchParams.toString();
 228 |     return `url:${u.host}${u.pathname}${q ? "?" + q : ""}`;
 229 |   } catch {
 230 |     return `url:${String(url || "").trim()}`;
 231 |   }
 232 | }
 233 | 
 234 | function readPanelPosts() {
 235 |   try {
 236 |     if (!fs.existsSync(POSTS_FILE)) {
 237 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
 238 |     }
 239 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
 240 |     if (!raw) {
 241 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
 242 |     }
 243 | 
 244 |     const parsed = safeJsonParse(raw);
 245 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
 246 |       return { ok: false, error: "posts.json ma z≈Çy format", posts: [], path: POSTS_FILE };
 247 |     }
 248 | 
 249 |     const posts = parsed.value
 250 |       .map((p) => {
 251 |         const url = normalizeUrl(p?.url);
 252 |         const active = Boolean(p?.active);
 253 |         if (!url) return null;
 254 |         return {
 255 |           id: String(p?.id || url),
 256 |           url,
 257 |           active,
 258 |           name: p?.name ? String(p.name) : "",
 259 |           image: p?.image ? String(p.image) : "",
 260 |           description: p?.description ? String(p.description) : "",
 261 |         };
 262 |       })
 263 |       .filter(Boolean);
 264 | 
 265 |     const activePosts = posts.filter((p) => p.active);
 266 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
 267 |   } catch (e) {
 268 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
 269 |   }
 270 | }
 271 | 
 272 | /* ============================================================
 273 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
 274 |    ============================================================ */
 275 | 
 276 | function parseSheetCsv(text) {
 277 |   const lines = text
 278 |     .split(/\r?\n/)
 279 |     .map((l) => l.trim())
 280 |     .filter((l) => l.length > 0);
 281 | 
 282 |   if (!lines.length) {
 283 |     log.warn("SHEET", "Pusty CSV z arkusza");
 284 |     return [];
 285 |   }
 286 | 
 287 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
 288 |   const idxUrl = header.findIndex((h) => h === "url");
 289 |   const idxActive = header.findIndex((h) => h === "active");
 290 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
 291 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
 292 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
 293 | 
 294 |   if (idxUrl === -1) {
 295 |     log.error("SHEET", "Brak kolumny 'url' w arkuszu");
 296 |     return [];
 297 |   }
 298 | 
 299 |   const posts = [];
 300 |   for (let i = 1; i < lines.length; i++) {
 301 |     const row = lines[i].split(",");
 302 |     const rawUrl = (row[idxUrl] || "").trim();
 303 |     if (!rawUrl) continue;
 304 | 
 305 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
 306 |     const activeNorm = activeRaw.toLowerCase();
 307 |     const isActive = idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
 308 | 
 309 |     if (!isActive) continue;
 310 | 
 311 |     posts.push({
 312 |       id: `sheet-${i}`,
 313 |       url: rawUrl,
 314 |       name: idxName !== -1 ? (row[idxName] || "").trim() : "",
 315 |       image: idxImage !== -1 ? (row[idxImage] || "").trim() : "",
 316 |       description: idxDesc !== -1 ? (row[idxDesc] || "").trim() : "",
 317 |     });
 318 |   }
 319 | 
 320 |   return posts;
 321 | }
 322 | 
 323 | /* ============================================================
 324 |    ===============   POSTS FROM REMOTE API   ====================
 325 |    ============================================================ */
 326 | 
 327 | async function fetchPostsFromApi() {
 328 |   if (!POSTS_API_URL) return { ok: false, reason: "no-url" };
 329 | 
 330 |   log.dev("API", `Pobieram posty z: ${POSTS_API_URL}`);
 331 | 
 332 |   try {
 333 |     const headers = { "Content-Type": "application/json" };
 334 |     if (POSTS_API_TOKEN) {
 335 |       headers["Authorization"] = `Bearer ${POSTS_API_TOKEN}`;
 336 |     }
 337 | 
 338 |     const res = await fetch(POSTS_API_URL, {
 339 |       method: "GET",
 340 |       headers,
 341 |       timeout: 10000,
 342 |     });
 343 | 
 344 |     if (!res.ok) {
 345 |       log.error("API", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
 346 |       return { ok: false, reason: "http-error", status: res.status };
 347 |     }
 348 | 
 349 |     const data = await res.json();
 350 | 
 351 |     if (!data.ok || !Array.isArray(data.posts)) {
 352 |       log.error("API", "Nieprawid≈Çowa odpowied≈∫ (brak ok/posts)");
 353 |       return { ok: false, reason: "invalid-response" };
 354 |     }
 355 | 
 356 |     const posts = data.posts
 357 |       .filter((p) => p.active !== false)
 358 |       .map((p) => ({
 359 |         id: String(p.id || "").trim(),
 360 |         url: String(p.url || "").trim(),
 361 |         active: true,
 362 |         name: String(p.name || "").trim(),
 363 |         image: String(p.image || "").trim(),
 364 |         description: String(p.description || "").trim(),
 365 |       }))
 366 |       .filter((p) => p.url);
 367 | 
 368 |     return { ok: true, posts, total: data.posts.length };
 369 |   } catch (err) {
 370 |     log.error("API", `B≈ÇƒÖd pobierania post√≥w: ${err.message}`);
 371 |     return { ok: false, reason: "fetch-error", error: err.message };
 372 |   }
 373 | }
 374 | 
 375 | /* ============================================================
 376 |    ===============   POSTS REFRESH   ===========================
 377 |    ============================================================ */
 378 | 
 379 | async function refreshPostsIfNeeded(force = false) {
 380 |   const now = Date.now();
 381 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
 382 |   lastRefreshAny = now;
 383 | 
 384 |   // 1) PRIMARY: Remote API
 385 |   if (POSTS_API_URL) {
 386 |     const api = await fetchPostsFromApi();
 387 |     if (api.ok && api.posts.length > 0) {
 388 |       const newPosts = api.posts;
 389 |       const oldJson = JSON.stringify(currentPosts);
 390 |       const newJson = JSON.stringify(newPosts);
 391 | 
 392 |       if (oldJson !== newJson) {
 393 |         log.prod("API", `Za≈Çadowano ${newPosts.length} post√≥w`, { total: api.total });
 394 |         currentPosts = newPosts;
 395 |       } else {
 396 |         log.dev("API", `Bez zmian (${newPosts.length} aktywnych)`);
 397 |       }
 398 |       return;
 399 |     }
 400 | 
 401 |     log.dev("API", `Fallback do lokalnego pliku (${api.reason || "unknown"})`);
 402 |   }
 403 | 
 404 |   // 2) SECONDARY: lokalny panel posts.json
 405 |   const panel = readPanelPosts();
 406 |   if (panel.ok && panel.posts.length > 0) {
 407 |     const newPosts = panel.posts;
 408 |     const oldJson = JSON.stringify(currentPosts);
 409 |     const newJson = JSON.stringify(newPosts);
 410 | 
 411 |     if (oldJson !== newJson) {
 412 |       log.prod("POSTS", `Za≈Çadowano ${newPosts.length} post√≥w z pliku`, { total: panel.total });
 413 |       currentPosts = newPosts;
 414 |     } else {
 415 |       log.dev("POSTS", `Bez zmian (${newPosts.length} aktywnych)`);
 416 |     }
 417 |     return;
 418 |   }
 419 | 
 420 |   log.dev("POSTS", "Panel bez post√≥w ‚Üí fallback: Sheets");
 421 | 
 422 |   // 3) FALLBACK: Sheets
 423 |   if (!POSTS_SHEET_URL) {
 424 |     log.warn("SHEET", "POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w");
 425 |     currentPosts = [];
 426 |     return;
 427 |   }
 428 | 
 429 |   log.dev("SHEET", "Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
 430 | 
 431 |   try {
 432 |     const res = await fetch(POSTS_SHEET_URL);
 433 |     if (!res.ok) {
 434 |       log.error("SHEET", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
 435 |       currentPosts = [];
 436 |       return;
 437 |     }
 438 | 
 439 |     const csvText = await res.text();
 440 |     const newPosts = parseSheetCsv(csvText);
 441 | 
 442 |     if (!newPosts.length) {
 443 |       log.warn("SHEET", "Arkusz nie zwr√≥ci≈Ç aktywnych post√≥w");
 444 |       currentPosts = [];
 445 |       return;
 446 |     }
 447 | 
 448 |     const oldJson = JSON.stringify(currentPosts);
 449 |     const newJson = JSON.stringify(newPosts);
 450 | 
 451 |     if (oldJson !== newJson) {
 452 |       log.prod("SHEET", `Za≈Çadowano ${newPosts.length} post√≥w`);
 453 |       currentPosts = newPosts;
 454 |     } else {
 455 |       log.dev("SHEET", "Bez zmian");
 456 |     }
 457 |   } catch (err) {
 458 |     log.error("SHEET", `B≈ÇƒÖd pobierania CSV: ${err.message}`);
 459 |     currentPosts = [];
 460 |   }
 461 | }
 462 | 
 463 | /* ============================================================
 464 |    =====================   CACHE HELPERS   =====================
 465 |    ============================================================ */
 466 | 
 467 | function getCacheKey(post) {
 468 |   return post.url;
 469 | }
 470 | 
 471 | function getKnownSetForPost(cacheKey) {
 472 |   let set = knownCommentsPerPost.get(cacheKey);
 473 |   if (!set) {
 474 |     const entry = commentsCache[cacheKey];
 475 |     set = entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
 476 |     knownCommentsPerPost.set(cacheKey, set);
 477 |   }
 478 |   return set;
 479 | }
 480 | 
 481 | /**
 482 |  * Przycina Set knownIds gdy przekroczy limit (FIFO - usuwa najstarsze).
 483 |  * Zapobiega memory leak przy d≈Çugim dzia≈Çaniu.
 484 |  */
 485 | function cleanupKnownIds(set) {
 486 |   if (set.size <= MAX_KNOWN_IDS_PER_POST) return;
 487 | 
 488 |   const arr = Array.from(set);
 489 |   const toRemove = arr.slice(0, arr.length - KNOWN_IDS_TRIM_TO);
 490 |   for (const id of toRemove) {
 491 |     set.delete(id);
 492 |   }
 493 | 
 494 |   log.debug("CACHE", `Przyciƒôto knownIds: ${arr.length} ‚Üí ${set.size}`);
 495 | }
 496 | 
 497 | 
 498 | /**
 499 |  * Zwraca ca≈ÇkowitƒÖ liczbƒô knownIds w pamiƒôci (dla monitoringu)
 500 |  */
 501 | function getTotalKnownIdsCount() {
 502 |   let total = 0;
 503 |   for (const set of knownCommentsPerPost.values()) {
 504 |     total += set.size;
 505 |   }
 506 |   return total;
 507 | }
 508 | 
 509 | function flushCacheToDisk() {
 510 |   const out = { ...commentsCache };
 511 | 
 512 |   for (const [cacheKey, count] of lastCounts.entries()) {
 513 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
 514 |     out[cacheKey].lastCount = count;
 515 |   }
 516 | 
 517 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
 518 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
 519 |     out[cacheKey].knownIds = Array.from(set);
 520 |   }
 521 | 
 522 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
 523 |   Object.assign(commentsCache, out);
 524 |   saveCache(out);
 525 | }
 526 | 
 527 | /* ============================================================
 528 |    =====================   G≈Å√ìWNY WATCHER   ===================
 529 |    ============================================================ */
 530 | 
 531 | const isDev = process.env.NODE_ENV !== "production";
 532 | 
 533 | function getExecutablePath() {
 534 |   const p =
 535 |     process.env.PUPPETEER_EXECUTABLE_PATH ||
 536 |     process.env.CHROME_PATH ||
 537 |     process.env.CHROMIUM_PATH ||
 538 |     "";
 539 |   return String(p || "").trim() || undefined;
 540 | }
 541 | 
 542 | async function startWatcher() {
 543 |   log.header("FB Comment Watcher");
 544 |   log.prod("WATCHER", `Start - interwa≈Ç: ${Math.round(CHECK_INTERVAL_MS / 1000)}s`, {
 545 |     fastMode: FAST_MODE,
 546 |     logLevel: log.level,
 547 |   });
 548 | 
 549 |   const loop = async () => {
 550 |     let browser = null;
 551 |     let page = null;
 552 |     let hadNavErrorThisRound = false;
 553 |     const cycleStart = Date.now();
 554 |     cycleNumber++;
 555 |     let newCommentsTotal = 0;
 556 |     let errorsCount = 0;
 557 | 
 558 |     try {
 559 |       log.prod("WATCHER", `Cykl #${cycleNumber} start`, { posts: currentPosts.length });
 560 | 
 561 |       const wantHeadless = envBool("HEADLESS_BROWSER", true);
 562 |       const headlessMode = wantHeadless ? (isDev ? true : "new") : false;
 563 | 
 564 |       const linux = process.platform === "linux";
 565 |       const executablePath = getExecutablePath();
 566 | 
 567 |       const args = [
 568 |         "--disable-notifications",
 569 |         "--disable-blink-features=AutomationControlled",
 570 |       ];
 571 | 
 572 |       if (linux) {
 573 |         args.push("--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage");
 574 |       }
 575 | 
 576 |       // Remote debugging - pozwala pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
 577 |       if (REMOTE_DEBUG_PORT > 0) {
 578 |         args.push(`--remote-debugging-port=${REMOTE_DEBUG_PORT}`);
 579 |         args.push("--remote-debugging-address=127.0.0.1");
 580 |         log.prod("DEBUG", `Remote debugging na porcie ${REMOTE_DEBUG_PORT} - po≈ÇƒÖcz przez: ssh -L ${REMOTE_DEBUG_PORT}:localhost:${REMOTE_DEBUG_PORT} user@server`);
 581 |       }
 582 | 
 583 |       // Proxy - residential rotating proxy zmniejsza ryzyko ban√≥w
 584 |       if (PROXY_URL) {
 585 |         args.push(`--proxy-server=${PROXY_URL}`);
 586 |         // Ukryj credentials w logu
 587 |         const safeProxyUrl = PROXY_URL.replace(/\/\/([^:]+):([^@]+)@/, "//***:***@");
 588 |         log.prod("PROXY", `U≈ºywam proxy: ${safeProxyUrl}`);
 589 |       }
 590 | 
 591 |       // Human Mode info
 592 |       if (HUMAN_MODE) {
 593 |         log.prod("HUMAN", "Human Behavior Mode w≈ÇƒÖczony");
 594 |       }
 595 | 
 596 |       browser = await puppeteer.launch({
 597 |         headless: headlessMode,
 598 |         defaultViewport: null,
 599 |         executablePath,
 600 |         args,
 601 |         ignoreDefaultArgs: ["--enable-automation"],
 602 |       });
 603 | 
 604 |       page = await browser.newPage();
 605 |       await applyStealth(page);
 606 | 
 607 |       page.setDefaultNavigationTimeout(90000);
 608 |       page.setDefaultTimeout(90000);
 609 |       await page.setViewport({ width: 1280, height: 720 });
 610 | 
 611 |       // cookies + login
 612 |       await loadCookies(page);
 613 |       await page.goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 }).catch(() => {});
 614 | 
 615 |       let loggedIn = await checkIfLogged(page);
 616 | 
 617 |       // === CHECKPOINT DETECTION (tylko alert) ===
 618 |       const checkpoint = await isCheckpoint(page);
 619 |       if (checkpoint) {
 620 |         const checkpointType = await getCheckpointType(page);
 621 |         log.warn("CHECKPOINT", `Wykryto checkpoint: ${checkpointType}`);
 622 | 
 623 |         // Pr√≥ba rozwiƒÖzania captcha (je≈õli to captcha, nie 2FA)
 624 |         if (CAPTCHA_ENABLED) {
 625 |           const captchaResult = await solveCaptchaIfPresent(page);
 626 |           if (captchaResult.solved) {
 627 |             log.success("CAPTCHA", "Captcha rozwiƒÖzana!");
 628 |             await new Promise(r => setTimeout(r, 2000));
 629 |             loggedIn = await checkIfLogged(page);
 630 |             if (!loggedIn) {
 631 |               await fbLogin(page);
 632 |               loggedIn = await checkIfLogged(page);
 633 |             }
 634 |           }
 635 |         }
 636 | 
 637 |         // Je≈õli nadal nie zalogowany - alert i stop (lub czekaj przy remote debug)
 638 |         if (!loggedIn) {
 639 |           await sendOwnerAlert(
 640 |             "CHECKPOINT - Wymagana interwencja",
 641 |             `Facebook wymaga weryfikacji to≈ºsamo≈õci.\n\n` +
 642 |             `Typ: ${checkpointType}\n\n` +
 643 |             `Wymagane dzia≈Çanie:\n` +
 644 |             `1. Zaloguj siƒô rƒôcznie i zaktualizuj cookies.json\n` +
 645 |             `2. Zmie≈Ñ dane logowania w .env je≈õli potrzeba\n` +
 646 |             `3. PM2 automatycznie wznowi pracƒô`
 647 |           );
 648 | 
 649 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô zamiast wychodziƒá
 650 |           if (REMOTE_DEBUG_PORT > 0) {
 651 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
 652 |             log.warn("CHECKPOINT", "PrzeglƒÖdarka czeka na rƒôcznƒÖ interwencjƒô.");
 653 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect, potem naci≈õnij Ctrl+C i uruchom ponownie.");
 654 |             log.warn("CHECKPOINT", "Sprawdzam co 30s czy jeste≈õ zalogowany...");
 655 | 
 656 |             // Czekaj w pƒôtli a≈º u≈ºytkownik rƒôcznie rozwiƒÖ≈ºe checkpoint (max 30 min)
 657 |             const MAX_WAIT_2FA_MS = 30 * 60 * 1000; // 30 minut
 658 |             const startWait2FA = Date.now();
 659 |             while (true) {
 660 |               if (Date.now() - startWait2FA > MAX_WAIT_2FA_MS) {
 661 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA (30 min) - restart procesu");
 662 |                 await sendOwnerAlert("TIMEOUT 2FA", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô. Proces zostanie zrestartowany.");
 663 |                 process.exit(1);
 664 |               }
 665 |               await new Promise(r => setTimeout(r, 30000));
 666 |               const nowLogged = await checkIfLogged(page).catch(() => false);
 667 |               if (nowLogged) {
 668 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
 669 |                 await saveCookies(page);
 670 |                 loggedIn = true;
 671 |                 break;
 672 |               }
 673 |               const remainingMin = Math.round((MAX_WAIT_2FA_MS - (Date.now() - startWait2FA)) / 60000);
 674 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMin} min)`);
 675 |             }
 676 |           } else {
 677 |             log.error("CHECKPOINT", "Wymagana interwencja - zatrzymujƒô proces");
 678 |             process.exit(1);
 679 |           }
 680 |         }
 681 |       }
 682 |       // === KONIEC CHECKPOINT DETECTION ===
 683 | 
 684 |       if (!loggedIn) {
 685 |         log.dev("LOGIN", "Brak sesji ‚Äì logowanie...");
 686 |         const LOGIN_TIMEOUT_MS = 120000; // 2 minuty na login
 687 |         try {
 688 |           await Promise.race([
 689 |             fbLogin(page),
 690 |             new Promise((_, reject) => setTimeout(() => reject(new Error('Login timeout (2 min)')), LOGIN_TIMEOUT_MS))
 691 |           ]);
 692 |         } catch (loginErr) {
 693 |           log.error("LOGIN", `B≈ÇƒÖd logowania: ${loginErr.message}`);
 694 |           await sendOwnerAlert("LOGIN ERROR", `Logowanie nie powiod≈Ço siƒô: ${loginErr.message}`);
 695 |           throw loginErr;
 696 |         }
 697 |         loggedIn = await checkIfLogged(page);
 698 | 
 699 |         // Sprawd≈∫ checkpoint po pr√≥bie logowania
 700 |         const checkpointAfterLogin = await isCheckpoint(page);
 701 |         if (checkpointAfterLogin) {
 702 |           const checkpointType = await getCheckpointType(page);
 703 |           log.warn("CHECKPOINT", `Checkpoint po logowaniu: ${checkpointType}`);
 704 | 
 705 |           await sendOwnerAlert(
 706 |             "CHECKPOINT po logowaniu",
 707 |             `Facebook wymaga weryfikacji po pr√≥bie logowania.\n\nTyp: ${checkpointType}`
 708 |           );
 709 | 
 710 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô (max 30 min)
 711 |           if (REMOTE_DEBUG_PORT > 0) {
 712 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
 713 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect. Sprawdzam co 30s...");
 714 | 
 715 |             const MAX_WAIT_2FA_MS_LOGIN = 30 * 60 * 1000; // 30 minut
 716 |             const startWait2FALogin = Date.now();
 717 |             while (true) {
 718 |               if (Date.now() - startWait2FALogin > MAX_WAIT_2FA_MS_LOGIN) {
 719 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA po logowaniu (30 min) - restart procesu");
 720 |                 await sendOwnerAlert("TIMEOUT 2FA LOGIN", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô po logowaniu. Proces zostanie zrestartowany.");
 721 |                 process.exit(1);
 722 |               }
 723 |               await new Promise(r => setTimeout(r, 30000));
 724 |               const nowLogged = await checkIfLogged(page).catch(() => false);
 725 |               if (nowLogged) {
 726 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
 727 |                 await saveCookies(page);
 728 |                 loggedIn = true;
 729 |                 break;
 730 |               }
 731 |               const remainingMinLogin = Math.round((MAX_WAIT_2FA_MS_LOGIN - (Date.now() - startWait2FALogin)) / 60000);
 732 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMinLogin} min)`);
 733 |             }
 734 |           } else {
 735 |             process.exit(1);
 736 |           }
 737 |         }
 738 | 
 739 |         if (loggedIn) {
 740 |           log.success("LOGIN", "Zalogowano pomy≈õlnie");
 741 |           await saveCookies(page);
 742 |         } else {
 743 |           log.error("LOGIN", "Logowanie nieudane");
 744 |         }
 745 |       } else {
 746 |         log.dev("LOGIN", "U≈ºyto istniejƒÖcej sesji");
 747 |       }
 748 | 
 749 |       // posts
 750 |       await refreshPostsIfNeeded(true);
 751 | 
 752 |       if (!currentPosts.length) {
 753 |         log.warn("WATCHER", "Brak aktywnych post√≥w do monitorowania");
 754 |       } else {
 755 |         // Human Behavior: randomizacja kolejno≈õci post√≥w
 756 |         const shuffledPosts = shuffleArray(currentPosts);
 757 |         const postOrder = shuffledPosts.map(p => p.name || p.id.slice(0, 8)).join(" ‚Üí ");
 758 |         log.dev("HUMAN", `Kolejno≈õƒá post√≥w: ${postOrder}`);
 759 | 
 760 |         let postIndex = 0;
 761 |         for (const post of shuffledPosts) {
 762 |           // Human Behavior: pauza PRZED ka≈ºdym postem (poza pierwszym)
 763 |           if (postIndex > 0) {
 764 |             const pauseMs = await betweenPostsPause();
 765 |             log.dev("HUMAN", `Pauza: ${(pauseMs / 1000).toFixed(1)}s`);
 766 |           }
 767 |           postIndex++;
 768 | 
 769 |           const cacheKey = getCacheKey(post);
 770 |           const postLabel = post.name || post.id.slice(0, 8);
 771 | 
 772 |           try {
 773 |             log.dev("NAV", `‚Üí ${postLabel}`);
 774 |             await prepare(page, post.url);
 775 | 
 776 |             // ==================== FAST_MODE BRANCH ====================
 777 |             if (FAST_MODE) {
 778 |               const knownSet = getKnownSetForPost(cacheKey);
 779 |               const isFirstRun = !lastCounts.has(cacheKey);
 780 | 
 781 |               // 1. Prze≈ÇƒÖcz na "Najnowsze"
 782 |               const switchResult = await switchCommentsFilterToNewest(page, post.url).catch(() => ({ ok: false }));
 783 | 
 784 |               if (!switchResult.ok) {
 785 |                 log.dev("FAST", `${postLabel}: Fallback do normalnego trybu`, { reason: switchResult.reason });
 786 |               } else {
 787 |                 await new Promise((r) => setTimeout(r, 600 + Math.random() * 400));
 788 | 
 789 |                 const snapshot = await extractCommentsData(page, post.url).catch(() => []);
 790 |                 const sample = snapshot.slice(0, 30);
 791 | 
 792 |                 log.dev("FAST", `${postLabel}: ${sample.length} komentarzy (sort=Najnowsze)`);
 793 | 
 794 |                 // Inicjalizacja
 795 |                 if (isFirstRun) {
 796 |                   lastCounts.set(cacheKey, sample.length);
 797 |                   for (const c of sample) if (c?.id) knownSet.add(c.id);
 798 |                   log.dev("FAST", `${postLabel}: Inicjalizacja - zapamiƒôtano ${sample.length}`);
 799 |                   continue;
 800 |                 }
 801 | 
 802 |                 // Early skip
 803 |                 if (sample.length > 0) {
 804 |                   const newestTime = sample[0]?.time || sample[0]?.fb_time_raw;
 805 |                   const newestAge = getCommentAgeMinutes(newestTime);
 806 | 
 807 |                   if (newestAge !== null && newestAge > FAST_MAX_AGE_MIN) {
 808 |                     log.dev("FAST", `${postLabel}: SKIP - najnowszy ${Math.round(newestAge)} min`, { limit: FAST_MAX_AGE_MIN });
 809 |                     continue;
 810 |                   }
 811 |                 }
 812 | 
 813 |                 // Dedup
 814 |                 const newComments = [];
 815 |                 for (const c of sample) {
 816 |                   if (!c?.id) continue;
 817 |                   if (!knownSet.has(c.id)) {
 818 |                     knownSet.add(c.id);
 819 |                     newComments.push(c);
 820 |                     c.__postId = post.id;
 821 |                     c.__postUrl = post.url;
 822 |                   }
 823 |                 }
 824 | 
 825 |                 // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
 826 |                 cleanupKnownIds(knownSet);
 827 | 
 828 |                 // Wysy≈Çka
 829 |                 if (newComments.length > 0) {
 830 |                   log.success("FAST", `${postLabel}: +${newComments.length} nowych`);
 831 |                   newCommentsTotal += newComments.length;
 832 | 
 833 |                   const safeComments = newComments.filter((c) => c.__postId === post.id);
 834 |                   if (safeComments.length !== newComments.length) {
 835 |                     log.warn("FAST", "Odfiltrowano komentarze spoza posta", {
 836 |                       before: newComments.length,
 837 |                       after: safeComments.length,
 838 |                     });
 839 |                   }
 840 |                   await sendTelegramIfFresh(post, safeComments, "fast");
 841 |                 } else {
 842 |                   log.dev("FAST", `${postLabel}: Brak nowych`);
 843 |                 }
 844 | 
 845 |                 continue;
 846 |               }
 847 |             }
 848 |             // ==================== KONIEC FAST_MODE ====================
 849 | 
 850 |             const count = await getCommentCount(page, post.url);
 851 |             const hasCount = typeof count === "number" && Number.isFinite(count);
 852 | 
 853 |             if (!hasCount) {
 854 |               log.dev("WATCHER", `${postLabel}: Brak licznika - tryb awaryjny`);
 855 |             }
 856 | 
 857 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
 858 |             const knownSet = getKnownSetForPost(cacheKey);
 859 | 
 860 |             // Pierwsze wej≈õcie
 861 |             if (prev === null) {
 862 |               const initialCount = hasCount ? count : 0;
 863 |               lastCounts.set(cacheKey, initialCount);
 864 | 
 865 |               log.dev("WATCHER", `${postLabel}: Inicjalizacja (${initialCount} komentarzy)`);
 866 | 
 867 |               if (EXPAND_COMMENTS) {
 868 |                 await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }, post.url).catch(() => {});
 869 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
 870 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
 871 |                 log.dev("WATCHER", `${postLabel}: Zapamiƒôtano ${snap.length} istniejƒÖcych`);
 872 |               }
 873 | 
 874 |               continue;
 875 |             }
 876 | 
 877 |             if (hasCount) {
 878 |               if (count !== prev) {
 879 |                 log.dev("WATCHER", `${postLabel}: Zmiana ${prev} ‚Üí ${count}`);
 880 |                 lastCounts.set(cacheKey, count);
 881 |               } else {
 882 |                 log.dev("WATCHER", `${postLabel}: Bez zmian (${count})`);
 883 |               }
 884 |             }
 885 | 
 886 |             if (!EXPAND_COMMENTS) continue;
 887 | 
 888 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(() => {});
 889 |             const snapshot = await extractCommentsData(page, post.url).catch(() => []);
 890 | 
 891 |             const newComments = [];
 892 |             for (const c of snapshot) {
 893 |               if (!c?.id) continue;
 894 |               if (!knownSet.has(c.id)) {
 895 |                 knownSet.add(c.id);
 896 |                 newComments.push(c);
 897 |                 c.__postId = post.id;
 898 |                 c.__postUrl = post.url;
 899 |               }
 900 |             }
 901 | 
 902 |             // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
 903 |             cleanupKnownIds(knownSet);
 904 | 
 905 |             log.debug("DEDUP", `${postLabel}: context`, {
 906 |               snapshotLen: snapshot.length,
 907 |               newLen: newComments.length,
 908 |             });
 909 | 
 910 |             // Fallback
 911 |             if (hasCount && newComments.length === 0 && count > prev) {
 912 |               const diff = Math.max(1, count - prev);
 913 |               const tail = snapshot.slice(-diff);
 914 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
 915 | 
 916 |               log.dev("WATCHER", `${postLabel}: Fallback - biorƒô ostatnie ${diff}`);
 917 |               await sendTelegramIfFresh(post, tail, "fallback");
 918 |               newCommentsTotal += tail.length;
 919 |               continue;
 920 |             }
 921 | 
 922 |             if (newComments.length > 0) {
 923 |               log.success("WATCHER", `${postLabel}: +${newComments.length} nowych`);
 924 |               newCommentsTotal += newComments.length;
 925 | 
 926 |               const safeComments = newComments.filter((c) => c.__postId === post.id);
 927 |               if (safeComments.length !== newComments.length) {
 928 |                 log.warn("WATCHER", "Odfiltrowano komentarze spoza posta", {
 929 |                   before: newComments.length,
 930 |                   after: safeComments.length,
 931 |                 });
 932 |               }
 933 |               await sendTelegramIfFresh(post, safeComments, "normal");
 934 |             }
 935 |           } catch (err) {
 936 |             errorsCount++;
 937 |             log.error("WATCHER", `B≈ÇƒÖd przy ${postLabel}: ${err?.message || err}`);
 938 |             log.debug("WATCHER", "Stack", { stack: err?.stack });
 939 | 
 940 |             if (isNavigationError(err)) {
 941 |               hadNavErrorThisRound = true;
 942 |               navErrorCount++;
 943 |               log.warn("WATCHER", `B≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`);
 944 |             }
 945 |           }
 946 |         }
 947 |       }
 948 |     } catch (err) {
 949 |       errorsCount++;
 950 |       log.error("WATCHER", `B≈ÇƒÖd w cyklu: ${err?.message || err}`);
 951 |     } finally {
 952 |       flushCacheToDisk();
 953 | 
 954 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
 955 |         log.dev("WATCHER", `Reset licznika b≈Çƒôd√≥w nawigacji (by≈Ço ${navErrorCount})`);
 956 |         navErrorCount = 0;
 957 |       }
 958 | 
 959 |       if (browser) {
 960 |         try {
 961 |           await browser.close();
 962 |           log.dev("WATCHER", "Zamkniƒôto przeglƒÖdarkƒô");
 963 |         } catch (e) {
 964 |           log.warn("WATCHER", `B≈ÇƒÖd zamykania przeglƒÖdarki: ${e?.message}`);
 965 |         }
 966 |       }
 967 | 
 968 |       const duration = Date.now() - cycleStart;
 969 |       const cacheSize = getCacheSize();
 970 |       const cacheEntries = getCacheEntryCount();
 971 |       const totalKnownIds = getTotalKnownIdsCount();
 972 | 
 973 |       log.cycleSummary({
 974 |         cycle: cycleNumber,
 975 |         posts: currentPosts.length,
 976 |         newComments: newCommentsTotal,
 977 |         duration,
 978 |         errors: errorsCount,
 979 |         cacheSize,
 980 |         cacheEntries,
 981 |         totalKnownIds,
 982 |       });
 983 | 
 984 |       // Alert je≈õli cache przekroczy≈Ç 10MB
 985 |       if (cacheSize > 10 * 1024 * 1024) {
 986 |         log.warn("CACHE", `Rozmiar cache przekroczy≈Ç 10MB: ${Math.round(cacheSize / 1024 / 1024)}MB`);
 987 |       }
 988 | 
 989 |       if (navErrorCount >= MAX_NAV_ERRORS) {
 990 |         log.error("WATCHER", "Za du≈ºo b≈Çƒôd√≥w nawigacji ‚Äì ko≈Ñczƒô proces");
 991 |         process.exit(1);
 992 |       }
 993 | 
 994 |       const jitter = Math.floor(Math.random() * 5000);
 995 |       const delay = CHECK_INTERVAL_MS + jitter;
 996 |       log.dev("WATCHER", `Nastƒôpny cykl za ${Math.round(delay / 1000)}s`);
 997 |       setTimeout(loop, delay);
 998 |     }
 999 |   };
1000 | 
1001 |   loop();
1002 | }
1003 | 
1004 | export { startWatcher };
1005 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/api.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
  1 | import http from "http";
  2 | import { exec } from "child_process";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import crypto from "crypto";
  6 | import dotenv from "dotenv";
  7 | 
  8 | // ---- BASE DIR (dev vs exe) ----
  9 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 10 | 
 11 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 12 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 13 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 14 | 
 15 | // UI: dev -> src/panel/ui, exe -> ./ui
 16 | const UI_DIR = process.pkg
 17 |   ? path.join(BASE_DIR, "ui")
 18 |   : path.join(BASE_DIR, "src", "panel", "ui");
 19 | 
 20 | const PORT = Number(process.env.PANEL_PORT || 3180);
 21 | const TOKEN = process.env.PANEL_TOKEN;
 22 | 
 23 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 24 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 25 | 
 26 | if (!TOKEN) {
 27 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 28 |   process.exit(1);
 29 | }
 30 | 
 31 | function auth(req, res) {
 32 |   const h = req.headers["authorization"] || "";
 33 |   if (h !== `Bearer ${TOKEN}`) {
 34 |     res.writeHead(401);
 35 |     res.end("Unauthorized");
 36 |     return false;
 37 |   }
 38 |   return true;
 39 | }
 40 | 
 41 | function json(res, obj, code = 200) {
 42 |   res.writeHead(code, { "Content-Type": "application/json" });
 43 |   res.end(JSON.stringify(obj, null, 2));
 44 | }
 45 | 
 46 | function sh(cmd) {
 47 |   return new Promise((resolve) => {
 48 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 49 |       resolve({
 50 |         ok: !err,
 51 |         stdout: (stdout || "").trim(),
 52 |         stderr: (stderr || "").trim(),
 53 |         code: err?.code ?? 0,
 54 |       });
 55 |     });
 56 |   });
 57 | }
 58 | 
 59 | async function getProjectDir() {
 60 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 61 | 
 62 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 63 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 64 |   if (!m)
 65 |     throw new Error(
 66 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 67 |     );
 68 |   return m[1].trim();
 69 | }
 70 | 
 71 | function readBody(req) {
 72 |   return new Promise((resolve) => {
 73 |     let d = "";
 74 |     req.on("data", (c) => (d += c));
 75 |     req.on("end", () => resolve(d));
 76 |   });
 77 | }
 78 | 
 79 | function safeJsonParse(s) {
 80 |   try {
 81 |     return { ok: true, value: JSON.parse(s) };
 82 |   } catch (e) {
 83 |     return { ok: false, error: e?.message || "Invalid JSON" };
 84 |   }
 85 | }
 86 | 
 87 | function ensureDir(p) {
 88 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
 89 | }
 90 | 
 91 | function atomicWriteFile(filePath, content) {
 92 |   const dir = path.dirname(filePath);
 93 |   ensureDir(dir);
 94 | 
 95 |   const tmp = path.join(
 96 |     dir,
 97 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
 98 |   );
 99 |   fs.writeFileSync(tmp, content, "utf8");
100 |   fs.renameSync(tmp, filePath);
101 | }
102 | 
103 | function normalizeUrl(u) {
104 |   if (!u) return "";
105 |   const x = String(u).trim();
106 |   if (!/^https?:\/\/.+/i.test(x)) return "";
107 |   return x;
108 | }
109 | 
110 | function normalizeOptionalUrl(u) {
111 |   if (!u) return "";
112 |   const x = String(u).trim();
113 |   if (x === "") return "";
114 |   if (!/^https?:\/\/.+/i.test(x)) return "";
115 |   return x;
116 | }
117 | 
118 | function nowIso() {
119 |   return new Date().toISOString();
120 | }
121 | 
122 | function setEnvKey(envText, key, value) {
123 |   const re = new RegExp(`^${key}=.*$`, "m");
124 |   const line = `${key}=${value}`;
125 |   if (re.test(envText)) return envText.replace(re, line);
126 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
127 | }
128 | 
129 | function pickPostsFile(projectDir) {
130 |   return path.join(projectDir, "data", "posts.json");
131 | }
132 | 
133 | function readPosts(postsPath) {
134 |   if (!fs.existsSync(postsPath)) return [];
135 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
136 |   if (!raw) return [];
137 |   const parsed = safeJsonParse(raw);
138 |   if (!parsed.ok || !Array.isArray(parsed.value))
139 |     throw new Error("posts.json invalid (expected array)");
140 |   return parsed.value;
141 | }
142 | 
143 | function writePosts(postsPath, posts) {
144 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
145 | }
146 | 
147 | function genId() {
148 |   return crypto.randomBytes(8).toString("hex");
149 | }
150 | 
151 | function route(req) {
152 |   const url = new URL(req.url, "http://localhost");
153 |   const pathname = url.pathname;
154 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
155 | }
156 | 
157 | function match(pathname, pattern) {
158 |   const a = pathname.split("/").filter(Boolean);
159 |   const b = pattern.split("/").filter(Boolean);
160 |   if (a.length !== b.length) return null;
161 |   const params = {};
162 |   for (let i = 0; i < a.length; i++) {
163 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
164 |     else if (a[i] !== b[i]) return null;
165 |   }
166 |   return params;
167 | }
168 | 
169 | // ---------- LOGS (dynamic from pm2 describe) ----------
170 | function parsePm2LogPaths(pm2DescribeText) {
171 |   const out =
172 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
173 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
174 |     "";
175 |   const err =
176 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
177 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
178 |     "";
179 |   return { out, err };
180 | }
181 | 
182 | async function getPm2LogPaths(appName) {
183 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
184 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
185 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
186 | 
187 |   const d = await sh(`pm2 describe ${appName}`);
188 |   if (!d.ok)
189 |     return {
190 |       out: "",
191 |       err: "",
192 |       source: "pm2_error",
193 |       pm2: d.stderr || d.stdout || "",
194 |     };
195 | 
196 |   const p = parsePm2LogPaths(d.stdout);
197 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
198 | }
199 | 
200 | async function readTailLog(filePath, lines) {
201 |   try {
202 |     if (!filePath) {
203 |       return {
204 |         ok: false,
205 |         error:
206 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
207 |         path: filePath,
208 |       };
209 |     }
210 | 
211 |     if (!fs.existsSync(filePath)) {
212 |       return {
213 |         ok: false,
214 |         error:
215 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
216 |         path: filePath,
217 |       };
218 |     }
219 | 
220 |     const st = fs.statSync(filePath);
221 |     if (!st || !st.isFile()) {
222 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
223 |     }
224 | 
225 |     if (st.size === 0) {
226 |       return {
227 |         ok: false,
228 |         error:
229 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
230 |         path: filePath,
231 |       };
232 |     }
233 | 
234 |     const tailCmd = `tail -n ${lines} "${filePath}"`;
235 |     const r = await sh(tailCmd);
236 | 
237 |     if (r.ok && (r.stdout || "").trim()) {
238 |       return { ok: true, log: r.stdout, path: filePath, via: "tail" };
239 |     }
240 | 
241 |     // fallback JS
242 |     const raw = fs.readFileSync(filePath, "utf8");
243 |     const arr = raw.split(/\r?\n/);
244 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
245 |     const txt = (slice || "").trim();
246 | 
247 |     if (!txt) {
248 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
249 |     }
250 | 
251 |     return { ok: true, log: slice, path: filePath, via: "js" };
252 |   } catch (e) {
253 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
254 |   }
255 | }
256 | 
257 | http
258 |   .createServer(async (req, res) => {
259 |     const { pathname, query } = route(req);
260 | 
261 |     // ---------- PUBLIC UI ----------
262 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
263 |       const p = path.join(UI_DIR, "index.html");
264 |       const html = fs.readFileSync(p, "utf8");
265 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
266 |       res.end(html);
267 |       return;
268 |     }
269 | 
270 |     if (req.method === "GET" && pathname === "/app.js") {
271 |       const p = path.join(UI_DIR, "app.js");
272 |       const js = fs.readFileSync(p, "utf8");
273 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
274 |       res.end(js);
275 |       return;
276 |     }
277 | 
278 |     // ---------- AUTH for API ----------
279 |     if (pathname.startsWith("/api/")) {
280 |       if (!auth(req, res)) return;
281 |     }
282 | 
283 |     try {
284 |       const PROJECT_DIR = await getProjectDir();
285 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
286 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
287 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
288 | 
289 |       // ===== STATUS =====
290 |       if (req.method === "GET" && pathname === "/api/status") {
291 |         const node = await sh("node -v");
292 |         const pm2v = await sh("pm2 -v");
293 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
294 |         json(res, {
295 |           ok: true,
296 |           projectDir: PROJECT_DIR,
297 |           envPath: ENV_PATH,
298 |           cookiesPath: COOKIES_PATH,
299 |           postsPath: POSTS_PATH,
300 |           node: node.stdout,
301 |           pm2: pm2v.stdout,
302 |           pm2Status: pm2s.stdout,
303 |           time: nowIso(),
304 |         });
305 |         return;
306 |       }
307 | 
308 |       // ===== ENV GET (selected keys) =====
309 |       if (req.method === "GET" && pathname === "/api/env/get") {
310 |         if (!fs.existsSync(ENV_PATH)) {
311 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
312 |           return;
313 |         }
314 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
315 |         const wanted = [
316 |           "FB_EMAIL",
317 |           "FB_PASSWORD",
318 |           "WEBHOOK_URL",
319 |           "CHECK_INTERVAL_MS",
320 |           "POSTS_SHEET_URL",
321 |           "HEADLESS_BROWSER",
322 |           "USE_UI_HANDLERS",
323 |           "INCLUDE_REPLIES",
324 |         ];
325 |         const values = {};
326 |         for (const k of wanted) {
327 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
328 |           values[k] = m ? m[1] : "";
329 |         }
330 |         json(res, { ok: true, values });
331 |         return;
332 |       }
333 | 
334 |       // ===== ENV SET MULTIPLE =====
335 |       if (req.method === "POST" && pathname === "/api/env/set") {
336 |         const bodyRaw = await readBody(req);
337 |         const parsed = safeJsonParse(bodyRaw || "{}");
338 |         if (!parsed.ok) {
339 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
340 |           return;
341 |         }
342 | 
343 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
344 |         const restart = Boolean(parsed.value.restart);
345 | 
346 |         if (!set) {
347 |           json(res, { ok: false, error: "Missing set object" }, 400);
348 |           return;
349 |         }
350 |         if (!fs.existsSync(ENV_PATH)) {
351 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
352 |           return;
353 |         }
354 | 
355 |         let env = fs.readFileSync(ENV_PATH, "utf8");
356 |         const updated = [];
357 | 
358 |         for (const [k, v] of Object.entries(set)) {
359 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
360 |           env = setEnvKey(env, k, String(v));
361 |           updated.push(k);
362 |         }
363 | 
364 |         atomicWriteFile(ENV_PATH, env);
365 | 
366 |         let pm2Action = null;
367 |         if (restart) {
368 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
369 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
370 |         }
371 | 
372 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
373 |         return;
374 |       }
375 | 
376 |       // ===== POSTS: LIST =====
377 |       if (req.method === "GET" && pathname === "/api/posts") {
378 |         const posts = readPosts(POSTS_PATH);
379 | 
380 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
381 |         const norm = (posts || []).map((p) => ({
382 |           id: String(p.id || "").trim(),
383 |           url: String(p.url || "").trim(),
384 |           active: p.active !== undefined ? Boolean(p.active) : true,
385 |           name: String(p.name || "").trim(),
386 |           image: String(p.image || "").trim(),
387 |           description: String(p.description || "").trim(),
388 |           createdAt: p.createdAt || "",
389 |           updatedAt: p.updatedAt || "",
390 |         }));
391 | 
392 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
393 |         json(res, { ok: true, posts: norm });
394 |         return;
395 |       }
396 | 
397 |       // ===== POSTS: ADD =====
398 |       if (req.method === "POST" && pathname === "/api/posts") {
399 |         const bodyRaw = await readBody(req);
400 |         const parsed = safeJsonParse(bodyRaw || "{}");
401 |         if (!parsed.ok) {
402 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
403 |           return;
404 |         }
405 | 
406 |         const url = normalizeUrl(parsed.value.url);
407 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
408 | 
409 |         const name = String(parsed.value.name || "").trim();
410 |         const imageRaw = String(parsed.value.image || "").trim();
411 |         const image = normalizeOptionalUrl(imageRaw);
412 |         const description = String(parsed.value.description || "").trim();
413 | 
414 |         if (!url) {
415 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
416 |           return;
417 |         }
418 |         if (imageRaw !== "" && !image) {
419 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
420 |           return;
421 |         }
422 | 
423 |         const posts = readPosts(POSTS_PATH);
424 |         const existing = posts.find((p) => p.url === url);
425 |         if (existing) {
426 |           existing.active = active;
427 |           existing.name = name;
428 |           existing.image = image;
429 |           existing.description = description;
430 |           existing.updatedAt = nowIso();
431 |           writePosts(POSTS_PATH, posts);
432 |           json(res, { ok: true, post: existing, deduped: true });
433 |           return;
434 |         }
435 | 
436 |         const post = {
437 |           id: genId(),
438 |           url,
439 |           active,
440 |           name,
441 |           image,
442 |           description,
443 |           createdAt: nowIso(),
444 |           updatedAt: nowIso(),
445 |         };
446 |         posts.push(post);
447 |         writePosts(POSTS_PATH, posts);
448 | 
449 |         json(res, { ok: true, post });
450 |         return;
451 |       }
452 | 
453 |       // ===== POSTS: PATCH =====
454 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
455 |       if (mPatch) {
456 |         const id = mPatch.id;
457 |         const bodyRaw = await readBody(req);
458 |         const parsed = safeJsonParse(bodyRaw || "{}");
459 |         if (!parsed.ok) {
460 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
461 |           return;
462 |         }
463 | 
464 |         const posts = readPosts(POSTS_PATH);
465 |         const post = posts.find((p) => p.id === id);
466 |         if (!post) {
467 |           json(res, { ok: false, error: "Post not found" }, 404);
468 |           return;
469 |         }
470 | 
471 |         if (parsed.value.url !== undefined) {
472 |           const nextUrl = normalizeUrl(parsed.value.url);
473 |           if (!nextUrl) {
474 |             json(res, { ok: false, error: "Invalid url" }, 400);
475 |             return;
476 |           }
477 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
478 |           if (dup) {
479 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
480 |             return;
481 |           }
482 |           post.url = nextUrl;
483 |         }
484 | 
485 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
486 | 
487 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
488 | 
489 |         if (parsed.value.image !== undefined) {
490 |           const raw = String(parsed.value.image || "").trim();
491 |           const img = normalizeOptionalUrl(raw);
492 |           if (raw !== "" && !img) {
493 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
494 |             return;
495 |           }
496 |           post.image = img;
497 |         }
498 | 
499 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
500 | 
501 |         post.updatedAt = nowIso();
502 |         writePosts(POSTS_PATH, posts);
503 |         json(res, { ok: true, post });
504 |         return;
505 |       }
506 | 
507 |       // ===== POSTS: DELETE =====
508 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
509 |       if (mDel) {
510 |         const id = mDel.id;
511 |         const posts = readPosts(POSTS_PATH);
512 |         const idx = posts.findIndex((p) => p.id === id);
513 |         if (idx === -1) {
514 |           json(res, { ok: false, error: "Post not found" }, 404);
515 |           return;
516 |         }
517 |         const removed = posts.splice(idx, 1)[0];
518 |         writePosts(POSTS_PATH, posts);
519 |         json(res, { ok: true, removed });
520 |         return;
521 |       }
522 | 
523 |       // ===== COOKIES: CLEAR =====
524 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
525 |         const bodyRaw = await readBody(req);
526 |         const parsed = safeJsonParse(bodyRaw || "{}");
527 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
528 | 
529 |         if (!confirm) {
530 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
531 |           return;
532 |         }
533 | 
534 |         atomicWriteFile(COOKIES_PATH, "[]\n");
535 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
536 |         return;
537 |       }
538 | 
539 |       // ===== PM2 =====
540 |       function okOrErr(r, fallbackErr = "Command failed") {
541 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
542 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
543 |       }
544 |       async function pm2Describe(name) {
545 |         return await sh(`pm2 describe ${name}`);
546 |       }
547 | 
548 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
549 |       const WATCH_NAME = PM2_APP || "fbwatcher";
550 | 
551 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
552 |         const d = await pm2Describe(WATCH_NAME);
553 |         if (d.ok) {
554 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
555 |           json(res, okOrErr(r, "PM2 start failed"));
556 |           return;
557 |         }
558 | 
559 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
560 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
561 |         return;
562 |       }
563 | 
564 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
565 |         const d = await pm2Describe(WATCH_NAME);
566 |         if (!d.ok) {
567 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
568 |           return;
569 |         }
570 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
571 |         json(res, okOrErr(r, "PM2 restart failed"));
572 |         return;
573 |       }
574 | 
575 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
576 |         const d = await pm2Describe(WATCH_NAME);
577 |         if (!d.ok) {
578 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
579 |           return;
580 |         }
581 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
582 |         json(res, okOrErr(r, "PM2 stop failed"));
583 |         return;
584 |       }
585 | 
586 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
587 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
588 |         json(res, okOrErr(r, "PM2 status failed"));
589 |         return;
590 |       }
591 | 
592 |       // ===== LOGS INFO (debug) =====
593 |       if (req.method === "GET" && pathname === "/api/logs/info") {
594 |         const paths = await getPm2LogPaths(PM2_APP);
595 |         json(res, { ok: true, app: PM2_APP, ...paths });
596 |         return;
597 |       }
598 | 
599 |       // ===== LOGS =====
600 |       if (req.method === "GET" && pathname === "/api/logs/out") {
601 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
602 |         const paths = await getPm2LogPaths(PM2_APP);
603 |         const payload = await readTailLog(paths.out, lines);
604 |         json(res, { ...payload, source: paths.source });
605 |         return;
606 |       }
607 | 
608 |       if (req.method === "GET" && pathname === "/api/logs/err") {
609 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
610 |         const paths = await getPm2LogPaths(PM2_APP);
611 |         const payload = await readTailLog(paths.err, lines);
612 |         json(res, { ...payload, source: paths.source });
613 |         return;
614 |       }
615 | 
616 |       json(res, { ok: false, error: "Not found" }, 404);
617 |     } catch (e) {
618 |       json(res, { ok: false, error: e.message }, 500);
619 |     }
620 |   })
621 |   .listen(PORT, "127.0.0.1", () => {
622 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
623 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
624 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
625 |   });
626 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/panel-entry.cjs`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
1 | // src/panel/panel-entry.cjs
2 | require("./api.js");
3 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/app.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```js
  1 | const $ = (id) => document.getElementById(id);
  2 | 
  3 | /* =========================
  4 |    AUTH / API
  5 | ========================= */
  6 | 
  7 | function getToken() {
  8 |   return localStorage.getItem("panel_token") || "";
  9 | }
 10 | function setToken(t) {
 11 |   localStorage.setItem("panel_token", t || "");
 12 | }
 13 | 
 14 | async function api(path, opts = {}) {
 15 |   const token = getToken();
 16 |   const headers = Object.assign({}, opts.headers || {}, {
 17 |     Authorization: `Bearer ${token}`,
 18 |   });
 19 | 
 20 |   const res = await fetch(path, { ...opts, headers });
 21 |   const text = await res.text();
 22 | 
 23 |   let json;
 24 |   try {
 25 |     json = JSON.parse(text);
 26 |   } catch {
 27 |     json = { ok: false, error: "Non-JSON response", raw: text };
 28 |   }
 29 | 
 30 |   if (!res.ok || json.ok === false) {
 31 |     throw new Error(
 32 |       json.error ||
 33 |         json.output ||
 34 |         json.raw ||
 35 |         `HTTP ${res.status}`
 36 |     );
 37 |   }
 38 | 
 39 |   return json;
 40 | }
 41 | 
 42 | function msg(el, s) {
 43 |   el.textContent = s;
 44 | }
 45 | 
 46 | /* =========================
 47 |    STATUS / ENV
 48 | ========================= */
 49 | 
 50 | async function refreshAll() {
 51 |   try {
 52 |     const st = await api("/api/status");
 53 |     msg(
 54 |       $("status"),
 55 |       `OK ‚Ä¢ ${st.time} ‚Ä¢ node=${st.node} ‚Ä¢ pm2=${(st.pm2 || "").trim()}`
 56 |     );
 57 | 
 58 |     const env = await api("/api/env/get");
 59 |     const keys = [
 60 |       "FB_EMAIL",
 61 |       "FB_PASSWORD",
 62 |       "WEBHOOK_URL",
 63 |       "CHECK_INTERVAL_MS",
 64 |       "POSTS_SHEET_URL",
 65 |       "HEADLESS_BROWSER",
 66 |       "USE_UI_HANDLERS",
 67 |       "INCLUDE_REPLIES",
 68 |     ];
 69 |     for (const k of keys) {
 70 |       if ($(k)) $(k).value = env.values[k] ?? "";
 71 |     }
 72 | 
 73 |     await loadPosts();
 74 |   } catch (e) {
 75 |     msg($("status"), `B≈ÅƒÑD: ${e.message}`);
 76 |   }
 77 | }
 78 | 
 79 | /* =========================
 80 |    POSTS
 81 | ========================= */
 82 | 
 83 | function esc(s) {
 84 |   return String(s || "")
 85 |     .replaceAll("&", "&amp;")
 86 |     .replaceAll("<", "&lt;")
 87 |     .replaceAll(">", "&gt;");
 88 | }
 89 | 
 90 | async function loadPosts() {
 91 |   const r = await api("/api/posts");
 92 |   const tbody = $("posts");
 93 |   tbody.innerHTML = "";
 94 | 
 95 |   for (const p of r.posts || []) {
 96 |     const tr = document.createElement("tr");
 97 | 
 98 |     tr.innerHTML = `
 99 |       <td class="mono">${esc(p.id)}</td>
100 |       <td><a href="${esc(p.url)}" target="_blank">${esc(p.url)}</a></td>
101 |       <td>${esc(p.name || "")}</td>
102 |       <td>
103 |         ${p.image ? `<img src="${esc(p.image)}" style="width:60px;border-radius:6px;">` : "‚Äî"}
104 |       </td>
105 |       <td>${esc(p.description || "")}</td>
106 |       <td>
107 |         <input type="checkbox" ${p.active ? "checked" : ""} data-id="${p.id}" class="toggleActive">
108 |       </td>
109 |       <td>
110 |         <button data-id="${p.id}" class="edit">Edytuj</button>
111 |         <button data-id="${p.id}" class="del">Usu≈Ñ</button>
112 |       </td>
113 |     `;
114 | 
115 |     tbody.appendChild(tr);
116 |   }
117 | 
118 |   /* aktywno≈õƒá */
119 |   document.querySelectorAll(".toggleActive").forEach((cb) => {
120 |     cb.addEventListener("change", async (e) => {
121 |       await api(`/api/posts/${e.target.dataset.id}`, {
122 |         method: "PATCH",
123 |         headers: { "Content-Type": "application/json" },
124 |         body: JSON.stringify({ active: e.target.checked }),
125 |       });
126 |     });
127 |   });
128 | 
129 |   /* usu≈Ñ */
130 |   document.querySelectorAll(".del").forEach((btn) => {
131 |     btn.addEventListener("click", async () => {
132 |       await api(`/api/posts/${btn.dataset.id}`, { method: "DELETE" });
133 |       await loadPosts();
134 |     });
135 |   });
136 | 
137 |   /* EDYCJA ‚Äî TU JEST FIX */
138 |   document.querySelectorAll(".edit").forEach((btn) => {
139 |     btn.addEventListener("click", async () => {
140 |       const r2 = await api("/api/posts");
141 |       const post = r2.posts.find((x) => x.id === btn.dataset.id);
142 |       if (!post) return;
143 | 
144 |       const nameInput = prompt("Name (nazwa):", post.name || "");
145 |       const imageInput = prompt("Image URL (zdjƒôcie):", post.image || "");
146 |       const descInput = prompt("Description (opis):", post.description || "");
147 | 
148 |       const name =
149 |         nameInput === null ? post.name || "" : nameInput;
150 |       const image =
151 |         imageInput === null ? post.image || "" : imageInput;
152 |       const description =
153 |         descInput === null ? post.description || "" : descInput;
154 | 
155 |       await api(`/api/posts/${post.id}`, {
156 |         method: "PATCH",
157 |         headers: { "Content-Type": "application/json" },
158 |         body: JSON.stringify({
159 |           name: String(name).trim(),
160 |           image: String(image).trim(),
161 |           description: String(description).trim(),
162 |         }),
163 |       });
164 | 
165 |       await loadPosts();
166 |     });
167 |   });
168 | }
169 | 
170 | /* =========================
171 |    ADD POST
172 | ========================= */
173 | 
174 | $("addPost").addEventListener("click", async () => {
175 |   await api("/api/posts", {
176 |     method: "POST",
177 |     headers: { "Content-Type": "application/json" },
178 |     body: JSON.stringify({
179 |       url: $("newPostUrl").value.trim(),
180 |       name: $("newPostName").value.trim(),
181 |       image: $("newPostImage").value.trim(),
182 |       description: $("newPostDescription").value.trim(),
183 |       active: $("newPostActive").checked,
184 |     }),
185 |   });
186 | 
187 |   $("newPostUrl").value = "";
188 |   $("newPostName").value = "";
189 |   $("newPostImage").value = "";
190 |   $("newPostDescription").value = "";
191 | 
192 |   await loadPosts();
193 | });
194 | 
195 | /* =========================
196 |    INIT
197 | ========================= */
198 | 
199 | $("saveToken").addEventListener("click", () => {
200 |   setToken($("token").value.trim());
201 |   refreshAll();
202 | });
203 | 
204 | $("refresh").addEventListener("click", refreshAll);
205 | 
206 | (function init() {
207 |   $("token").value = getToken();
208 |   refreshAll();
209 | })();
210 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>FB Watcher Panel</title>
  7 |   <style>
  8 |     body { font-family: system-ui, Arial; margin: 16px; background:#0b0f14; color:#e7eef7; }
  9 |     .row { display:flex; gap:12px; flex-wrap:wrap; }
 10 |     .card { background:#121926; border:1px solid #223047; border-radius:12px; padding:14px; margin:12px 0; }
 11 |     input, textarea, button, select { font: inherit; border-radius:10px; border:1px solid #2a3a55; background:#0b1220; color:#e7eef7; padding:10px; }
 12 |     input, textarea { width: 100%; box-sizing:border-box; }
 13 |     button { cursor:pointer; }
 14 |     button.primary { background:#2563eb; border-color:#2563eb; }
 15 |     button.danger { background:#b91c1c; border-color:#b91c1c; }
 16 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 17 |     table { width:100%; border-collapse: collapse; }
 18 |     th, td { border-bottom:1px solid #223047; padding:8px; text-align:left; vertical-align:top; }
 19 |     .muted { opacity:0.75; font-size:12px; }
 20 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 21 |     .sep { height:1px; background:#223047; margin:10px 0; opacity:0.8; }
 22 |     .thumb { width:64px; height:40px; object-fit:cover; border-radius:8px; border:1px solid #223047; background:#0b1220; }
 23 |   </style>
 24 | </head>
 25 | <body>
 26 |   <h2>FB Watcher ‚Äî Panel</h2>
 27 |   <div class="muted">Panel dzia≈Ça lokalnie. Token wymagany do akcji.</div>
 28 | 
 29 |   <div class="card">
 30 |     <div class="row">
 31 |       <div style="flex:1; min-width:260px;">
 32 |         <label>Token panelu</label>
 33 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
 34 |       </div>
 35 |       <div style="display:flex; gap:10px; align-items:flex-end;">
 36 |         <button class="primary" id="saveToken">Zapisz token</button>
 37 |         <button id="refresh">Od≈õwie≈º</button>
 38 |       </div>
 39 |     </div>
 40 |     <div id="status" class="muted" style="margin-top:10px;"></div>
 41 |   </div>
 42 | 
 43 |   <div class="card">
 44 |     <h3>Ustawienia (.env)</h3>
 45 | 
 46 |     <div class="row">
 47 |       <div style="flex:1; min-width:260px;">
 48 |         <label>FB_EMAIL</label>
 49 |         <input id="FB_EMAIL" />
 50 |       </div>
 51 |       <div style="flex:1; min-width:260px;">
 52 |         <label>FB_PASSWORD</label>
 53 |         <input id="FB_PASSWORD" type="password" />
 54 |       </div>
 55 |     </div>
 56 | 
 57 |     <label>WEBHOOK_URL</label>
 58 |     <input id="WEBHOOK_URL" />
 59 | 
 60 |     <div class="row">
 61 |       <div style="flex:1; min-width:200px;">
 62 |         <label>CHECK_INTERVAL_MS</label>
 63 |         <input id="CHECK_INTERVAL_MS" />
 64 |       </div>
 65 |       <div style="flex:2; min-width:260px;">
 66 |         <label>POSTS_SHEET_URL (csv export)</label>
 67 |         <input id="POSTS_SHEET_URL" />
 68 |       </div>
 69 |     </div>
 70 | 
 71 |     <div class="row">
 72 |       <div style="flex:1; min-width:200px;">
 73 |         <label>HEADLESS_BROWSER</label>
 74 |         <select id="HEADLESS_BROWSER">
 75 |           <option value="true">true</option>
 76 |           <option value="false">false</option>
 77 |         </select>
 78 |       </div>
 79 |       <div style="flex:1; min-width:200px;">
 80 |         <label>USE_UI_HANDLERS</label>
 81 |         <select id="USE_UI_HANDLERS">
 82 |           <option value="true">true</option>
 83 |           <option value="false">false</option>
 84 |         </select>
 85 |       </div>
 86 |       <div style="flex:1; min-width:200px;">
 87 |         <label>INCLUDE_REPLIES</label>
 88 |         <select id="INCLUDE_REPLIES">
 89 |           <option value="true">true</option>
 90 |           <option value="false">false</option>
 91 |         </select>
 92 |       </div>
 93 |     </div>
 94 | 
 95 |     <div class="row" style="margin-top:10px;">
 96 |       <button class="primary" id="saveEnv">Zapisz ENV</button>
 97 |       <button id="pm2Start">PM2 Start</button>
 98 |       <button id="pm2Stop">PM2 Stop</button>
 99 |       <button id="pm2Restart">PM2 Restart</button>
100 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
101 |     </div>
102 | 
103 |     <div id="envMsg" class="muted" style="margin-top:10px;"></div>
104 |   </div>
105 | 
106 |   <div class="card">
107 |     <h3>Posty (data/posts.json)</h3>
108 | 
109 |     <div class="row">
110 |       <div style="flex:2; min-width:260px;">
111 |         <label>Nowy URL posta</label>
112 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
113 |       </div>
114 | 
115 |       <div style="flex:1; min-width:220px;">
116 |         <label>Name (nazwa)</label>
117 |         <input id="newPostName" placeholder="np. A1" />
118 |       </div>
119 | 
120 |       <div style="flex:1; min-width:260px;">
121 |         <label>Image URL (zdjƒôcie)</label>
122 |         <input id="newPostImage" placeholder="https://...jpg" />
123 |       </div>
124 |     </div>
125 | 
126 |     <label>Description (opis)</label>
127 |     <textarea id="newPostDescription" style="height:90px;" placeholder="Kr√≥tki opis..."></textarea>
128 | 
129 |     <div class="row" style="margin-top:10px;">
130 |       <div style="min-width:160px; display:flex; align-items:center; gap:10px;">
131 |         <label style="margin:0;">
132 |           <input type="checkbox" id="newPostActive" checked /> aktywny
133 |         </label>
134 |         <button class="primary" id="addPost">Dodaj</button>
135 |       </div>
136 |     </div>
137 | 
138 |     <div style="margin-top:12px;">
139 |       <table>
140 |         <thead>
141 |           <tr>
142 |             <th>ID</th>
143 |             <th>URL</th>
144 |             <th>Name</th>
145 |             <th>Image</th>
146 |             <th>Description</th>
147 |             <th>Active</th>
148 |             <th>Akcje</th>
149 |           </tr>
150 |         </thead>
151 |         <tbody id="posts"></tbody>
152 |       </table>
153 |     </div>
154 |   </div>
155 | 
156 |   <div class="card">
157 |     <h3>Logi</h3>
158 | 
159 |     <div class="row">
160 |       <button id="loadOut">OUT</button>
161 |       <button id="loadErr">ERR</button>
162 | 
163 |       <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
164 | 
165 |       <select id="logAutoEvery" style="width:140px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
166 |         <option value="0">auto: off</option>
167 |         <option value="1000">co 1s</option>
168 |         <option value="2000" selected>co 2s</option>
169 |         <option value="5000">co 5s</option>
170 |         <option value="10000">co 10s</option>
171 |       </select>
172 | 
173 |       <button class="primary" id="logAutoToggle">Auto: OFF</button>
174 | 
175 |       <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
176 |         <input type="checkbox" id="logAutoScroll" checked />
177 |         auto-scroll
178 |       </label>
179 |     </div>
180 | 
181 |     <div class="sep"></div>
182 | 
183 |     <textarea
184 |       id="logs"
185 |       class="mono"
186 |       style="height:320px; margin-top:10px;"
187 |       readonly
188 |       spellcheck="false"
189 |       placeholder="Kliknij OUT albo ERR, ≈ºeby wczytaƒá logi..."></textarea>
190 | 
191 |     <div id="logHint" class="muted" style="margin-top:8px;"></div>
192 |   </div>
193 | 
194 |   <script src="/app.js"></script>
195 | </body>
196 | </html>
197 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/panel-entry.cjs`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
1 | // src/panel/panel-entry.cjs
2 | require("./api.js");
3 | 
```

---

### üìÑ ≈öcie≈ºka: `CLAUDE.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

```md
  1 | # FB_Watcher - Kontekst projektu
  2 | 
  3 | ## Opis projektu
  4 | Bot monitorujƒÖcy komentarze na postach Facebook za pomocƒÖ Puppeteer. Wykrywa nowe komentarze i wysy≈Ça powiadomienia przez Telegram.
  5 | 
  6 | ## Mapa plik√≥w (dla oszczƒôdno≈õci token√≥w)
  7 | 
  8 | | Plik | Linie | G≈Ç√≥wne funkcje | Opis |
  9 | |------|-------|----------------|------|
 10 | | `src/watcher.js` | ~895 | `startWatcher()`, `processPost()`, `fetchPosts()` | g≈Ç√≥wna pƒôtla |
 11 | | `src/fb/login.js` | ~824 | `doLogin()`, `setupCaptchaSolver()` | logowanie + 2Captcha |
 12 | | `src/fb/comments.js` | ~782 | `extractComments()`, `parseComment()` | ekstrakcja komentarzy |
 13 | | `src/telegram.js` | ~303 | `sendNotification()`, `formatMessage()` | powiadomienia |
 14 | | `src/utils/logger.js` | ~202 | `log()`, `logLevel` | logowanie |
 15 | | `src/fb/checkpoint.js` | ~180 | `detectCheckpoint()`, `handleCheckpoint()` | wykrywanie 2FA |
 16 | | `src/config.js` | ~172 | eksport zmiennych | env variables |
 17 | | `src/fb/cookies.js` | ~149 | `loadCookies()`, `saveCookies()` | zarzƒÖdzanie sesjƒÖ |
 18 | | `src/db/cache.js` | ~116 | `getCache()`, `updateCache()` | deduplikacja |
 19 | | `src/index.js` | ~83 | `main()` | punkt wej≈õcia |
 20 | | `src/utils/time.js` | ~63 | `parseRelativeTime()` | parsowanie "2 godz." |
 21 | | `src/utils/sleep.js` | ~132 | `humanDelay()`, `shuffleArray()`, `humanType()` | human behavior delays |
 22 | | `src/utils/mouse.js` | ~195 | `humanClick()`, `moveToElement()` | ruchy myszy Bezier |
 23 | 
 24 | ## Czƒôste operacje (gdzie edytowaƒá)
 25 | 
 26 | | Chcƒô zmieniƒá... | Edytuj plik | Funkcja |
 27 | |-----------------|-------------|---------|
 28 | | Format powiadomie≈Ñ | `src/telegram.js` | `formatMessage()` |
 29 | | Logikƒô logowania | `src/fb/login.js` | `doLogin()` |
 30 | | Ekstrakcjƒô komentarzy | `src/fb/comments.js` | `extractComments()` |
 31 | | Interwa≈Ç sprawdzania | `src/config.js` | `CHECK_INTERVAL_MS` |
 32 | | Obs≈Çugƒô checkpoint | `src/fb/checkpoint.js` | `handleCheckpoint()` |
 33 | | Cache komentarzy | `src/db/cache.js` | `updateCache()` |
 34 | | Op√≥≈∫nienia human-like | `src/utils/sleep.js` | `humanTypingDelay()` |
 35 | | Ruchy myszy | `src/utils/mouse.js` | `humanClick()` |
 36 | 
 37 | ## Architektura
 38 | 
 39 | ### ≈πr√≥d≈Ça post√≥w (priorytet)
 40 | 1. **Remote API** (`POSTS_API_URL`) - panel administracyjny
 41 | 2. **Lokalny plik** (`data/posts.json`) - fallback
 42 | 3. **Google Sheets** (`POSTS_SHEET_URL`) - ostateczny fallback
 43 | 
 44 | ## Ostatnia sesja (2026-01-20)
 45 | 
 46 | ### Branch: `feat/react-admin-panel`
 47 | 
 48 | ### Co zosta≈Ço zrobione
 49 | - **2Captcha solver** - automatyczne rozwiƒÖzywanie captcha przy logowaniu:
 50 |   - Plugin `puppeteer-extra-plugin-recaptcha`
 51 |   - Konfiguracja: `CAPTCHA_API_KEY` w .env
 52 |   - Dzia≈Ça dla reCAPTCHA v2/v3
 53 | - **Uproszczenie logiki cookies** - usuniƒôto rotacjƒô backup cookies:
 54 |   - Usuniƒôto soft ban detection
 55 |   - Usuniƒôto automatycznƒÖ rotacjƒô cookies przy checkpoint
 56 |   - Checkpoint = alert Telegram + stop (wymaga rƒôcznej interwencji)
 57 | - **Czyszczenie kodu** - usuniƒôto ~400 linii niepotrzebnego kodu
 58 | 
 59 | ### Konfiguracja 2Captcha (.env)
 60 | ```
 61 | CAPTCHA_API_KEY=twoj_klucz_2captcha
 62 | ```
 63 | 
 64 | ### Logika checkpoint (uproszczona)
 65 | ```
 66 | Checkpoint/2FA wykryty
 67 |     ‚Üì
 68 | Pr√≥ba rozwiƒÖzania captcha (2Captcha)
 69 |     ‚Üì
 70 | Je≈õli sukces ‚Üí kontynuuj
 71 | Je≈õli 2FA/blokada ‚Üí Alert Telegram + Stop
 72 |     ‚Üì
 73 | Rƒôczna interwencja:
 74 |   - Zmie≈Ñ login/has≈Ço w .env
 75 |   - Lub zaktualizuj cookies.json
 76 |     ‚Üì
 77 | PM2 restartuje automatycznie
 78 | ```
 79 | 
 80 | ## Konfiguracja (.env)
 81 | 
 82 | ### Podstawowe
 83 | ```
 84 | FB_EMAIL=email@example.com
 85 | FB_PASSWORD=haslo
 86 | CHECK_INTERVAL_MS=60000
 87 | ```
 88 | 
 89 | ### FAST_MODE
 90 | ```
 91 | FAST_MODE=true           # w≈ÇƒÖcza tryb szybki
 92 | FAST_MAX_AGE_MIN=180     # limit wieku komentarzy (minuty)
 93 | ```
 94 | 
 95 | ### Captcha
 96 | ```
 97 | CAPTCHA_API_KEY=klucz_2captcha
 98 | ```
 99 | 
100 | ### Logi
101 | ```
102 | LOG_LEVEL=1              # 0=silent, 1=prod, 2=dev, 3=debug
103 | ```
104 | 
105 | ### Remote Debug
106 | ```
107 | REMOTE_DEBUG_PORT=9222   # port do podglƒÖdu przeglƒÖdarki (0=wy≈ÇƒÖczony)
108 | ```
109 | 
110 | ### Human Behavior Mode
111 | ```
112 | HUMAN_MODE=true                    # w≈ÇƒÖcza symulacjƒô cz≈Çowieka (domy≈õlnie true)
113 | PROXY_URL=http://user:pass@host:port  # rotating residential proxy (opcjonalne)
114 | ```
115 | 
116 | ## Wa≈ºne informacje techniczne
117 | 
118 | ### Stealth
119 | Bot u≈ºywa technik ukrywania automatyzacji:
120 | - `navigator.webdriver = false`
121 | - Usuniƒôcie flag Chromium automation
122 | - Losowe op√≥≈∫nienia miƒôdzy akcjami
123 | - Plugin `puppeteer-extra-plugin-stealth` (aktywowany!)
124 | 
125 | ### Human Behavior Mode
126 | Symulacja zachowa≈Ñ cz≈Çowieka dla zmniejszenia ryzyka wykrycia:
127 | - **Stealth Plugin**: ukrywa webdriver, plugins, WebGL, canvas fingerprint
128 | - **Wolne pisanie**: ~120ms/znak z mikro-pauzami (zamiast 35ms)
129 | - **Rozk≈Çad Gaussa**: naturalne op√≥≈∫nienia zamiast jednolitych
130 | - **Shuffle post√≥w**: losowa kolejno≈õƒá sprawdzania (Fisher-Yates)
131 | - **Pauzy miƒôdzy postami**: 3-8 sekund z rozk≈Çadem normalnym
132 | - **Ruchy myszy**: krzywe Beziera (opcjonalne)
133 | - **Proxy support**: residential rotating proxy
134 | 
135 | Logi przy `LOG_LEVEL=2`:
136 | ```
137 | [STEALTH] Plugin stealth w≈ÇƒÖczony
138 | [PROXY] U≈ºywam proxy: http://***@host:port
139 | [HUMAN] Human Behavior Mode w≈ÇƒÖczony
140 | [HUMAN] Kolejno≈õƒá post√≥w: post3 ‚Üí post1 ‚Üí post2
141 | [HUMAN] Pauza: 5.2s
142 | ```
143 | 
144 | ### Cache
145 | - Plik: `data/comments-cache.json`
146 | - Struktura: `{ [postUrl]: { lastCount, knownIds: [] } }`
147 | - Deduplikacja przez ID komentarzy
148 | - Auto-cleanup gdy > 1000 IDs na post
149 | 
150 | ### Cookies
151 | - Plik: `cookies.json` w g≈Ç√≥wnym katalogu
152 | - Format: tablica cookies z Puppeteer
153 | - Atomic write (bezpieczny zapis)
154 | 
155 | ### Captcha Solver
156 | - Serwis: 2Captcha.com
157 | - Plugin: `puppeteer-extra-plugin-recaptcha`
158 | - Obs≈Çuguje: reCAPTCHA v2, v3, hCaptcha
159 | - Czas rozwiƒÖzania: ~30-60 sekund
160 | 
161 | ### Remote Debug (podglƒÖd przeglƒÖdarki na ≈ºywo)
162 | Pozwala pod≈ÇƒÖczyƒá siƒô do przeglƒÖdarki bota i rƒôcznie zrobiƒá 2FA/checkpoint.
163 | 
164 | ```bash
165 | # 1. Na serwerze - uruchom z portem debug
166 | REMOTE_DEBUG_PORT=9222 node src/index.js
167 | 
168 | # 2. Na PC - tunel SSH
169 | ssh -L 9222:localhost:9222 root@162.55.188.103
170 | 
171 | # 3. W Chrome na PC
172 | chrome://inspect/#devices ‚Üí Configure ‚Üí localhost:9222
173 | ```
174 | 
175 | Kliknij "inspect" przy facebook.com - masz pe≈ÇnƒÖ kontrolƒô nad przeglƒÖdarkƒÖ.
176 | 
177 | ### Proxy (opcjonalne)
178 | Zmniejsza ryzyko ban√≥w przez zmianƒô IP:
179 | - **Format**: `http://user:pass@host:port` lub `socks5://host:port`
180 | - **Zalecane**: Residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
181 | - Facebook flaguje: datacenter IP, ciƒÖg≈ÇƒÖ aktywno≈õƒá z jednego IP
182 | - Residential IP wyglƒÖdajƒÖ jak zwykli u≈ºytkownicy
183 | 
184 | ## Serwer produkcyjny
185 | 
186 | | Parametr | Warto≈õƒá |
187 | |----------|---------|
188 | | IP | `162.55.188.103` |
189 | | User | `root` |
190 | | System | Ubuntu 24.04.3 LTS |
191 | | ≈öcie≈ºka | `/opt/fb-watcher` |
192 | 
193 | ```bash
194 | # Po≈ÇƒÖczenie SSH
195 | ssh root@162.55.188.103
196 | 
197 | # SSH z tunelem do remote debug
198 | ssh -L 9222:localhost:9222 root@162.55.188.103
199 | ```
200 | 
201 | ## Komendy
202 | 
203 | ```bash
204 | # Uruchomienie
205 | node src/index.js
206 | 
207 | # PM2 (produkcja)
208 | pm2 start ecosystem.config.cjs
209 | 
210 | # Logi
211 | pm2 logs fb-watcher
212 | 
213 | # Generowanie cookies rƒôcznie
214 | node scripts/generate-cookies.js
215 | 
216 | # Uruchomienie z remote debug (podglƒÖd przeglƒÖdarki)
217 | REMOTE_DEBUG_PORT=9222 node src/index.js
218 | ```
219 | 
220 | ## Skrypty pomocnicze
221 | 
222 | ### `scripts/generate-cookies.js`
223 | Rƒôczne generowanie cookies przez logowanie w przeglƒÖdarce.
224 | ```bash
225 | node scripts/generate-cookies.js           # zapisz cookies.json
226 | node scripts/generate-cookies.js --list    # poka≈º istniejƒÖce
227 | ```
228 | 
229 | ## Workflow - wrzucanie na serwer
230 | 
231 | **ZASADA:** Zawsze tworzyƒá nowy branch przed wrzuceniem na serwer.
232 | 
233 | ```bash
234 | # 1. Nowy branch z timestampem
235 | git checkout -b deploy/YYYYMMDD-HHMMSS
236 | 
237 | # 2. Commit + push
238 | git add . && git commit -m "opis zmian"
239 | git push -u origin HEAD
240 | 
241 | # 3. Na serwerze
242 | ssh root@162.55.188.103
243 | cd /opt/fb-watcher
244 | git fetch && git checkout <branch>
245 | pm2 restart fb-watcher
246 | ```
247 | 
248 | ## Jak zadawaƒá pytania (oszczƒôdno≈õƒá token√≥w)
249 | 
250 | ### Dobrze
251 | ```
252 | "W src/telegram.js:120 formatMessage() - dodaj link do posta"
253 | "src/fb/login.js:45-60 - dodaj 3 retry przy b≈Çƒôdzie"
254 | "Czy w watcher.js:200-220 jest memory leak?"
255 | ```
256 | 
257 | ### ≈πle
258 | ```
259 | "Znajd≈∫ gdzie jest sendNotification"
260 | "Sprawd≈∫ czy watcher.js jest OK"
261 | "Poka≈º mi ca≈Çy plik login.js"
262 | ```
263 | 
264 | ### Zasady
265 | 1. **Podawaj ≈õcie≈ºkƒô + numer linii** je≈õli znasz
266 | 2. **Jedno pytanie = jeden temat** ‚Üí potem `/clear`
267 | 3. **Unikaj "poka≈º mi" / "wyja≈õnij ca≈Çy plik"**
268 | 4. **Po zako≈Ñczeniu zadania** ‚Üí `/clear` ‚Üí nowe zadanie
269 | 5. **Aktualizuj mapƒô plik√≥w** gdy dodasz nowy plik
270 | 
271 | ## Do zrobienia / Potencjalne usprawnienia
272 | - [ ] Testy 2Captcha na produkcji przy rzeczywistym checkpoint
273 | - [ ] Obs≈Çuga b≈Çƒôd√≥w gdy FB zmieni UI
274 | - [ ] Rate limiting dla Telegram
275 | - [ ] Metryki/statystyki wykrywania
276 | 
```

---

### üìÑ ≈öcie≈ºka: `cookies.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768949166457%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "c_user",
 18 |     "value": "61586902376231",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800484179.134967,
 22 |     "size": 20,
 23 |     "httpOnly": false,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "wd",
 33 |     "value": "1366x768",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1769553966,
 37 |     "size": 10,
 38 |     "httpOnly": false,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "Lax",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "xs",
 48 |     "value": "30%3AQpODUJy18dEViA%3A2%3A1768947868%3A-1%3A-1%3A%3AAcyvJd0PSoHqZgkPeeum7BDwv6SnDC8w49TCKBXWtA",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1800484179.135037,
 52 |     "size": 96,
 53 |     "httpOnly": true,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "None",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "oo",
 63 |     "value": "v1%7C3%3A1768947870",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1803507869.854458,
 67 |     "size": 21,
 68 |     "httpOnly": true,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "kQBwad5GZLHhirX_vA4H-M5I",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803507869.651363,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "kQBwaZbB9A8fcEdDLaEr2T1d",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803507860.517749,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_1.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821583937%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "29%3A0TI_s65lTO3qzg%3A2%3A1768821578%3A-1%3A-1%3A%3AAcxaLgNbdpNWTjDF0y56iMggsdBM_j9nH4pbE8YgFg",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800357582.420874,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768821581",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803381581.604868,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769426383,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61586902376231",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800357582.420761,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "LRNuadcWAD_nJokuImU0LXvJ",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803381581.404045,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "LRNuaTIVfVkEK0ALCqTBXrbX",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803381551.714364,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_2.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821704911%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "15%3A5aJJDn3N950RaA%3A2%3A1768821699%3A-1%3A-1%3A%3AAcyULKKMWvRSHdia6ASG6JHmVdDYRIt6UMSLrv0jaQ",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800357702.405451,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768821701",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803381701.372198,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769426504,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61584544438252",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800357702.405334,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "phNuaVpJfP45vjR5_9Z3ww0u",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803381700.950217,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "phNuafrGqbN4eXv7NV-JPKnJ",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803381673.692538,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_3.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768822164105%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "12%3Ar5MWBSq2el_6cA%3A2%3A1768822161%3A-1%3A-1%3A%3AAcwVwvqQ6SZ4-1toGi9O2R8-9M-Hp0pkMGAQlGJhHg",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800358163.45879,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768822162",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803382162.846874,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "c_user",
 48 |     "value": "100003588756313",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1800358163.458665,
 52 |     "size": 21,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "None",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "wd",
 63 |     "value": "1920x945",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1769426963,
 67 |     "size": 10,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "Lax",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "QxVuaaOR9rdA5NlSfrHD1EfX",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803382162.597484,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "QxVuadPVWi05FhOfQNVLWqGr",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803382085.502047,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_4.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768852924758%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "22%3ALWafh4jINN69qw%3A2%3A1768852919%3A-1%3A-1%3A%3AAcx_l28-lOf1k4OIIYDNmw-No6DzjAvqpIsUYtw8ZA",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800388921.700278,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768852921",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803412920.650126,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769457724,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61584544438252",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800388921.700174,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "o41uaWpt5tiPEsycxXtK4Cbs",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803412920.412847,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "o41uaXMjjzfbjImZRgyLijUq",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803412902.086271,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/comments-cache.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | {
  2 |   "test": {
  3 |     "lastCount": 5,
  4 |     "knownIds": [
  5 |       "a",
  6 |       "b",
  7 |       "c"
  8 |     ]
  9 |   },
 10 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R": {
 11 |     "lastCount": 10,
 12 |     "knownIds": [
 13 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjI5OTI2MTgzMDU0NzUxNw==",
 14 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTk2MTEyNzAwNzgyMDg3MA==",
 15 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIwMjkwODkxMTM4NjA0OQ==",
 16 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTg5OTY1NjQ1MDc1NzE5Ng==",
 17 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTM5MDY4MjkwMjc4MTI0Nw==",
 18 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjY1ODQzNjM2NDU0MzExMg==",
 19 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIxOTMyNjE4NjE5NzY0OQ==",
 20 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfNzA1OTk0MTA1OTI1MDMz",
 21 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfODk1NzE3NDY2MzIyMTMx",
 22 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTYxMzAxNzY0NjUzMzExNQ=="
 23 |     ]
 24 |   },
 25 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R": {
 26 |     "lastCount": 10,
 27 |     "knownIds": [
 28 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0MTI4NTk3NTA0OTc4MjM=",
 29 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzc0NjA4Njc1ODU1MjMxNQ==",
 30 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDczODQ2NTI5NzU0Mw==",
 31 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEzODI2NjExNTM1OTc5OTE=",
 32 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0Mjg4OTg4Mjg5NjgyNjE=",
 33 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDI4MzMwODQxNzU0OA==",
 34 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg5NDAyMDg3NjQ3MDI3Nw==",
 35 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEyNDczMDE4MzM4ODMyMDQ=",
 36 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQyMDk4MTIyMzkyMzI0NzY=",
 37 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQxMDc0Mjk0NTI3MzU2Njg="
 38 |     ]
 39 |   },
 40 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R": {
 41 |     "lastCount": 10,
 42 |     "knownIds": [
 43 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NTM5MjgxMjU4Mzk3Mjg=",
 44 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzg2MzE3NDIyOTY2MDQ2NQ==",
 45 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0OTA0NTAzMzk0NjA1NDk=",
 46 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MDY4MTE3OTEyMzI5NTQ=",
 47 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE5NDU4MDYyMjYzMTMxMTk=",
 48 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzc1MzMyOTk5NzI0MzE4MA==",
 49 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzExODM2NzcyNjAxNDA5ODI=",
 50 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzgyMzI2MTI1MDY5NTAzNA==",
 51 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MjU3MjI3NzI1MTQzMTk=",
 52 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NjMxOTcwNjQ3MjMwMDU="
 53 |     ]
 54 |   },
 55 |   "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R": {
 56 |     "lastCount": 4,
 57 |     "knownIds": [
 58 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfOTE2MjYzNjI4MDE4ODI2",
 59 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTQwNTc1MzE2MTI1NTAwNg==",
 60 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMzY4MDUyNTM3MjA3ODY5OQ==",
 61 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTYyNDA2MjUzNTYyMjI2Mg=="
 62 |     ]
 63 |   },
 64 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R": {
 65 |     "lastCount": 10,
 66 |     "knownIds": [
 67 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODk3NjcyMTg2Mjg2MzY5",
 68 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNDM1NTcyMDk1ODAzNjk1Mg==",
 69 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTA4MDAwMjI3NzU4NTE2MQ==",
 70 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTk2NTI0MzkwMTA4NDYxOA==",
 71 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNzA3MDcxMjcyMjMwOTYx",
 72 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI3OTQ4OTgyNDIxNzQwMQ==",
 73 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI2NTE4NTYwODc3Mzg4MQ==",
 74 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTQwNzc0MTg2NDExNzM2NA==",
 75 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODI0MzQ2NjcwMzk5NTg2",
 76 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTM1OTI5NDg4NTk0OTgwNg=="
 77 |     ]
 78 |   },
 79 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0318uW2Wb8gH4No2tudirSDVbDij3MCM1VM4nZ38mb3Kw9d8SDF8A8TyruVv5QLrTZl&id=61578702383044&__cft__[0]=AZZwCrt1G5eyASBVhdpuf3DZgoV_-CNIVqBzw1O4tN4UccEme5c6PCwt95Pjdcru2GOJ_QGzfYHeCwiZDvRdu5ZDS5zqeNlIs6DOvcIO9dWuWUhH1EyHO4LoMrF_sNYg_MD67DxNEzI60tDW7tXUTUVQx011P1sGO3cBu0EUOvcgTw&__tn__=%2CO%2CP-R": {
 80 |     "lastCount": 4,
 81 |     "knownIds": [
 82 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjMyNzE4MzE4NzcyMzY5NA==",
 83 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfODY5MjM1NjU1ODkyMTE1",
 84 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMTYwOTQ1Mjc3MzU2NDk1NA==",
 85 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjU5NTQ2MTQ4Njc1MjU5NTQ="
 86 |     ]
 87 |   },
 88 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R": {
 89 |     "lastCount": 10,
 90 |     "knownIds": [
 91 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfOTM3ODA2OTYxOTU3MTgz",
 92 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODk2MjY0MTA2NDc2MzY2",
 93 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODQ4MzM0MTI0ODQ5MzIz",
 94 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjQ5NTY5Mzg3MDg0NjExOQ==",
 95 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTkzMTA1ODYzNzU5OTY4MQ==",
 96 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU3NzI4NjUzNzg5OTk2NDI=",
 97 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTA5NzM4OTAwMjQ2ODM1Ng==",
 98 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU2NTAwMDc1MzQ2NjUzMDk=",
 99 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTMxMDU0OTUwNDE3MTQyOQ==",
100 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTEzNDgxNDg1NTIyNDUwNg=="
101 |     ]
102 |   },
103 |   "https://www.facebook.com/AtelierGaragee/posts/pfbid02ATAxGye5dbcaG8bzAD8EQEyri7aFgm9XUsE1t342j4HSCkQcD1YT7F51WYMpfyN8l?__cft__[0]=AZaBEG6ksRywUu51yRCMwmNgFY1VReoKiSP1kUwfY6mLCTmDV38xiPUIOEXLvFrOuTxnrAihkxHoIISVh7TG6Sk5MrH9R_MPM4m55j_FtuMP6EIJQNZW28aSELdSa8vTZH8cIM1gr0GoAvuJ5jLiTjB2mXfIkn6n06IHHpR4RQ0vKQ&__tn__=%2CO%2CP-R": {
104 |     "lastCount": 7,
105 |     "knownIds": [
106 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMjEzNjU5NDY2Mzc3MTQxMw==",
107 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDIzODgyODc0MzAzMDU1NQ==",
108 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTQxOTY3OTkzNjE3NDUxNg==",
109 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNzI5ODE3NTg2NTU1NzA2",
110 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfODY4NTU1OTA1OTExNzAy",
111 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTkzMDU4NjIzNDE1ODk0OQ==",
112 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDE3MTI3NzM5MzEzMjA5Ng=="
113 |     ]
114 |   },
115 |   "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R": {
116 |     "lastCount": 5,
117 |     "knownIds": [
118 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfODgzNzMxMzY3MzczNzkw",
119 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMjU0MDU5Nzk3NTI0MTkwODA=",
120 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfNzY3MTI1NDY5MDY2NTYy",
121 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTY0OTYyODk4OTgxODA3OA==",
122 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTIzNTA4MDQwMTg1ODQ1OA=="
123 |     ]
124 |   },
125 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R": {
126 |     "lastCount": 9,
127 |     "knownIds": [
128 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTE3ODcwODMxNDQyODkxOQ==",
129 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODc4Mzc3NzgxNzkwNTcz",
130 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTk1Njg5ODk4MTkxMzI5NA==",
131 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTU2ODIyNzI2NDQ5ODkxNQ==",
132 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMjU2NTg0ODY4NzE0OTcyNw==",
133 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODcxNDA2NjYyNTM1NjE5",
134 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODM4NDYxNjYyNTIwODkw",
135 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMzA2Njk2NzUzNjg0NDc3NA==",
136 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTIxNDM0MTQxMzk2OTE4Mw=="
137 |     ]
138 |   },
139 |   "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R": {
140 |     "lastCount": 0,
141 |     "knownIds": []
142 |   },
143 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid035w4oCt6cS3n6zCdxYeYVhu5MrLm6gJo2MKPPtVK1R7APfTpPVkzyHnvfu9NkmFypl&id=100064116006584&__cft__[0]=AZZCqTstO-EyvwQuGR3_itqZZ0EVlzOHdSUCmBUvadLGqfz1-MvpYyJYlRhSiV4CynwiO_uaRpQvKHRhvksK3_ImJjibd6qWne7eOgOYHmrdmGx2u8SHjUsVoP7CM42LZ-9X3Hr-P5rtAtX7QFrXXK9ImMiiySJFt9BCw-Gfdw3p7Q&__tn__=%2CO%2CP-R": {
144 |     "lastCount": 0,
145 |     "knownIds": []
146 |   },
147 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R": {
148 |     "lastCount": 10,
149 |     "knownIds": [
150 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzczMDAwMjU1MzQ5NzAwOQ==",
151 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE0MzE2MDA4MDE4OTIzODM=",
152 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg1NDAzMTU2MzkwMzE0OA==",
153 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzIzMDI3NzY3NjY4ODMxNTI=",
154 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTY3NzkyNTUzNTk3NjM=",
155 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTc1ODg4OTU2NDA1MjA=",
156 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg3NTIzMTg3NTA4OTgyMQ==",
157 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE1MjU2NDUwNjU4MTQwNzA=",
158 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzEzOTAzMjg1OTU5MTIzOTg=",
159 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE5MzI1ODM1MTEwMjI5MzE="
160 |     ]
161 |   },
162 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02haCDE2RQqyVm3F9U2L7EXaAYoG4RMur5QoH814aVLbwhedNQJmNzxzpXNovZAeCil&id=100079527351401&__cft__[0]=AZZ4KqKhcAuigo35JEfdAJdl-sieDCm5aMX0PjuHk9MRO70fMmx66wJ43grMxUBvlsyMszWGovTDK-g5CigEof4_bJv5sgo0GKxq6CxWtc14BF6hi4xRwTNM1E-fw5rHkQ7KHKEYD6D8I4aKRS55tDd2EX1CtC6sJyT4va_X2uhnjw&__tn__=%2CO%2CP-R": {
163 |     "lastCount": 10,
164 |     "knownIds": [
165 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjUwMzE2MTA2Njc0NDcyOQ==",
166 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTA1MDI0Njg3NzI4NTg5OA==",
167 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODIxNTgzMDI0MjU5MjM2",
168 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYwNDAyMjc4ODIyODAxNTI=",
169 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTg1MzA2ODY4NTMzMDk4Mw==",
170 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYxMTMzODY3NTE1OTEwOTU=",
171 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODc4MDY0MDU0OTQ1Nzg5",
172 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMzE4NzA3NTg4ODEzMjk2Mw==",
173 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODgzMTMzNjc3NTA0Njk5",
174 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfNjM4NTU4MjU5MzE0MDk4"
175 |     ]
176 |   },
177 |   "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R": {
178 |     "lastCount": 2,
179 |     "knownIds": [
180 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfODQ3Mjg0NTYxNDU5MzA1",
181 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfMTU2MDAyNjY1ODY1NzI0OQ=="
182 |     ]
183 |   },
184 |   "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R": {
185 |     "lastCount": 2,
186 |     "knownIds": [
187 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfNDM4NjgwMjEwODMwODM1NA==",
188 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfOTEzMjIwMzU0NzI5MjAx"
189 |     ]
190 |   },
191 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R": {
192 |     "lastCount": 10,
193 |     "knownIds": [
194 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1Mzg2MzIwMjU3NzE5NjA4",
195 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzE2NjE0NjUyMTgyMDI2MzU=",
196 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg2NTk4NTAxMjk4NjUyNA==",
197 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkxMDg1MDc0ODEwNzYzMg==",
198 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkwNDM4NjQzMjE2MDQ4OQ==",
199 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI0NjI3Nzk3NDA4NDQ2MTU=",
200 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzExODIwMjI3NDc0NTIyNzY=",
201 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1NjcyNTI5NDU5MDc0Nzc2",
202 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI5Mjc5MzAwMDczOTU3MjI=",
203 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg1NDAyOTY5MDc3NDkwMA=="
204 |     ]
205 |   },
206 |   "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R": {
207 |     "lastCount": 10,
208 |     "knownIds": [
209 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzEzNjk2NDAyMzc3MTAzMjY=",
210 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MzI3MTM2NzQ2MjkyMjY=",
211 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzIwMDM4MTM0OTAxNjU0NzY=",
212 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1ODAxNzQ0OTYzNTUzNTc=",
213 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzg4NzY4NjAzNzAwODIyOA==",
214 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE4MTgwNjk5OTIyMDI5OTE=",
215 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzcyNzEwMjU5Mzc3Njk0NA==",
216 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzY0ODg1MjQxMTY0Njk5NQ==",
217 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MTA5NzMwMTAxMDg4Mzk=",
218 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzgzMzM2NDU3NjI4MjQ0MQ=="
219 |     ]
220 |   },
221 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R": {
222 |     "lastCount": 10,
223 |     "knownIds": [
224 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMzg4MTg2ODc1ODc3MzExNQ==",
225 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjM3NzQyNzI4NjA0MjE0NQ==",
226 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTgxOTIwMjk4NTQyODAwMw==",
227 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTIwNzMwMzEwNzU2NDU3NA==",
228 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfOTM3ODM3NTI4ODI0ODUw",
229 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTM2MDk5NzQ5OTEwMzM3NQ==",
230 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjQ0OTIzMTQ1MjE0MTU1NA==",
231 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODIyMjQ0NjgwNDc4NDk4",
232 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfNDIxMjE3MzAxOTA5OTcyMQ==",
233 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODI1MzgyNDEzMTYxOTYz"
234 |     ]
235 |   },
236 |   "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R": {
237 |     "lastCount": 10,
238 |     "knownIds": [
239 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzk2NDgzNzYxNjcwODQ1Nw==",
240 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE0MTE4NDE1MTA1ODY4Nzk=",
241 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzg3MjE3MDExNTY4MDIyNg==",
242 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzUxMjU3NDcyNTA5ODQ0MzA=",
243 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE1Njg3MDUyODc3NjY4MTQ=",
244 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NzY3MjA4NTk2MDY2Mzg=",
245 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE3OTA3NjgxMjE2MjQyOTE=",
246 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzkxMTAxNjg4NDYxNDc5Mw==",
247 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NDMxNTY5MTY2MDE3Nzc=",
248 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzIyODI0Njk5NzIyMzI3MjE="
249 |     ]
250 |   },
251 |   "https://www.facebook.com/robstal.garaze.blaszane/posts/pfbid02aFFtjSkLZXQWiEowiS52Lx2Zht7M9Te5f4xosriFySu9BuP1WKFfV39MhKbyhJR9l?__cft__[0]=AZZTxMcsG7gI2gK2OOuyPJBa-_ZVrPQ0uZc0Idu_beS_85zVc7_fFP7OtcVuHUiEeboigKm2al5IpzDUlqiHmZcUoivzhkJnh-BH1WQnoDlIjfJ6sY-wVYcFBcsDyg5jl_4Fxm8yCGC8LhH_Qr0loqh2E5AlspC1TJZ6CkBU-pG6Iw&__tn__=%2CO%2CP-R": {
252 |     "lastCount": 6,
253 |     "knownIds": [
254 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzI1NDk5NTIyMjE2MzIzNzMy",
255 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE3NDE0NTIwNjAxNDQ2NDA=",
256 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE0NjQ4MjgwMzUyNjg5NDE=",
257 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzgyMTY3MDczNDIwMzM2Mg==",
258 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE1NjE1NDQyNDQ5Mjk2NjM=",
259 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzEzNjM4MDY5MjE0Mzc1NjE="
260 |     ]
261 |   },
262 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R": {
263 |     "lastCount": 8,
264 |     "knownIds": [
265 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTg5NTQ0Mjc0MTA2NzkzOA==",
266 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjUzMTM3NjcyNDE2MjkxNjA=",
267 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfODU2NDcxNDAzODM5NTA5",
268 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTk0NDYwMTI0MzE0OTEzOA==",
269 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTU0ODg1OTk0NjM2NDYzMw==",
270 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTM1OTYyODIyODgyMDI1MA==",
271 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTQ0MTY1NTkyNzU1NTI1Ng==",
272 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjQ1Njk3OTU5ODA5MjI5Nw=="
273 |     ]
274 |   },
275 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R": {
276 |     "lastCount": 10,
277 |     "knownIds": [
278 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTM3NjMzMjEwMzc0MzI4Mg==",
279 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTc4Mzg4MjE2ODk2NzA3Mg==",
280 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTU1NDIzNTU0OTAwMzM4OQ==",
281 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjExODcwMjk1ODY2NDk3MA==",
282 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTI3NzEzMTQ2MTAyMDM5OA==",
283 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjUyODYxNTQyMzQzMzkzOTQ=",
284 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODU0ODg2Mzk3NDM1Njk0",
285 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTQzODM3ODYxNDUyMzA2Mg==",
286 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODcwMTMxNjY5MDg0NTUw",
287 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMzUyNzkxNDE3NzM3MTA1Ng=="
288 |     ]
289 |   },
290 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R": {
291 |     "lastCount": 10,
292 |     "knownIds": [
293 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTYzMjEwMjg3NzkyNTA1Ng==",
294 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTg0NjA1NDE3OTM2NDc1MA==",
295 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODYxMTk2NDAzMzcyMDA3",
296 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODQwMTIxMjU4ODU0MDM3",
297 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMjM0NTE2MjM3OTI5Mjk5NQ==",
298 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU2MTUzMTI3ODM4MjA3Nw==",
299 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfOTA3NDY3NzU1MDc0MTQ2",
300 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY0NzE2MzYwNjI0NjE0MQ==",
301 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU5MjE5NTg2NTQ2NDUzNg==",
302 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY1Njk1NjI5ODYwOTEzMA=="
303 |     ]
304 |   },
305 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R": {
306 |     "lastCount": 4,
307 |     "knownIds": [
308 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjIzMTI2MDAxMDYxMjkyMQ==",
309 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjQ4NzcxNjk1NTAxOTYzNQ==",
310 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTYwNjA4OTk3Mzk4MjE2Nw==",
311 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTE2NDg1MjIwMjUwNTgyMA=="
312 |     ]
313 |   },
314 |   "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R": {
315 |     "lastCount": 2,
316 |     "knownIds": [
317 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODg1NzkwMzI0MTk3NTI0",
318 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODc0NDkwNDI4NjcyNDgz"
319 |     ]
320 |   },
321 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R": {
322 |     "lastCount": 10,
323 |     "knownIds": [
324 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTYwODEzNDExMDUzMDY2Nw==",
325 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODg0OTEyMjk3OTc0NA==",
326 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfODc3OTA1NjU0ODgxNTk3",
327 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTE0NjQyMDYwOTExMzMz",
328 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTk0ODU3ODk4MjY4MDM1Ng==",
329 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTIxMjU4MDUzNTc4Njc0",
330 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjA4MzQzOTAwMjQwNzI2MQ==",
331 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfNDI1NjIzOTI5NDY2NDYzNw==",
332 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjMzMzU5OTUyNzExNDk5OA==",
333 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODQ2MTcyMzEyMzkxOA=="
334 |     ]
335 |   },
336 |   "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R": {
337 |     "lastCount": 10,
338 |     "knownIds": [
339 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTYxOTcyMzkxMjUzNjQyMA==",
340 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTkxNjUxNTY5OTc0NzE2NA==",
341 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMjU3MDQyMjY4NTkyMDg1MzQ=",
342 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQ5NjYwNTE0MTQwMjQyOQ==",
343 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQzNDU2OTA2NDc1MjYyMg==",
344 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTU3NjUwODE2MzUwMjUxNg==",
345 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM4MDgzNDU2Mzc4OTI3Nw==",
346 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM5MTcxNTQ0MjQ2NTIwNQ==",
347 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfODY0ODIyNjU2NDEwMDUz",
348 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM3MjM5MjIzMTM1MjUyNg=="
349 |     ]
350 |   },
351 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R": {
352 |     "lastCount": 10,
353 |     "knownIds": [
354 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTE5MTg1MzA0OTgwNTgzOQ==",
355 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfOTA0NDI0NjQ4Nzg2MzU2",
356 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkwNDM1MTkwMzgwMTc5Ng==",
357 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkyMDUyMTMwMjAwODYyNw==",
358 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfODY0NDI3OTczMDA1Njkz",
359 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfNzcxMTI5Mjc4NjAxMTQw",
360 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTExNjg1NTg2NzA4NjM3Nw==",
361 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTUzNTA0MTM5MTE2NzAzMA==",
362 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTg0NTI2MjE1Mjc2NTk1Mg==",
363 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTU5MjIxNjQ2NTI0MTQ1OA=="
364 |     ]
365 |   },
366 |   "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R": {
367 |     "lastCount": 10,
368 |     "knownIds": [
369 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzg2MzU5NjM0Mjk2MTAwNA==",
370 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0ODE1OTI1MzM1NjE5MTQ=",
371 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzQxMjA4ODA3MDE1MTIxODA=",
372 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzExMjk4MjU4MzI0Mzc3NTU=",
373 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIzNjYzNzYzMTcxMzQ2MDg=",
374 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIxOTEzNjEyMjc5NDAzNzk=",
375 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIwNzI3NDQzMzM1MTU3NjU=",
376 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzM4Mjg1NTU0NzQxMTI0NDQ=",
377 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE3MDI1NzY5MTczODIyMTY=",
378 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0NDUwNTQ3MTA1MjA2MDA="
379 |     ]
380 |   },
381 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02WfKaSL6M75BrEuCFRhtbwaGifhdusk9fv1C6z7Uy2qjtgxnegr9eUSJ5DidUSTTBl&id=100083286129696&__cft__[0]=AZZWKYTrBrADgzl3D3vEiZ2tkuDzBlEy155fy0Pj_wYpv8qMioPu5zZ-DvHIiydZXWjg4kuZP08TLxcprCd_rL6InDXOEqNMpLWVreiSsfMojqV5ZfOigeJksjxDIjo0CT7lw0xOVDiT5_addtlk6SXi&__tn__=%2CO%2CP-R": {
382 |     "lastCount": 10,
383 |     "knownIds": [
384 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE5ODIyMTY4MjUxODgxNA==",
385 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTU2Mjc2NDgwODMyNTg2NA==",
386 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMjQwMTAwNzI0ODIwMjQxMDI=",
387 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM0MjcyNjQyNDI5MjExOQ==",
388 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM5MzQyNDc0NTU4NjE4Ng==",
389 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE2MzE2MjUwOTEzOTA5NQ==",
390 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTUyNjMyNDIyNTMyNTE0Mg==",
391 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTQ5ODQzNzU5MTI1MzM1MQ==",
392 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTczNTEyMTk5NDUyMTEyNg==",
393 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfNzQ1Njk2NDMxNDMzMjgx"
394 |     ]
395 |   },
396 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R": {
397 |     "lastCount": 10,
398 |     "knownIds": [
399 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk1NDE5MDM5MDQwMzg=",
400 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExOTcyNDc0NjU5MDYyODA=",
401 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzI2NTEwNDMzMzI4NTQwNzYx",
402 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzcyOTcxODI2MDIwNzg3OA==",
403 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzczMjI4MTA3Mjg5NzY1NA==",
404 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExNDQ2MTM5ODc1NjgwNTU=",
405 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzgwOTIwMzM4NTQ3MzgxMQ==",
406 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzIxNDE1MTY0Nzk5NDg3MzM=",
407 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk0OTA3NjcyNTU4NjQ=",
408 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzMwMzQyODMxMDAyOTMyMTU="
409 |     ]
410 |   }
411 | }
```

---

### üìÑ ≈öcie≈ºka: `data/posts.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "id": "20d407e350f43063",
  4 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R",
  5 |     "active": true,
  6 |     "name": "A1",
  7 |     "image": "",
  8 |     "description": "",
  9 |     "createdAt": "2026-01-13T12:01:58.668Z",
 10 |     "updatedAt": "2026-01-13T12:01:58.668Z"
 11 |   },
 12 |   {
 13 |     "id": "f689bed37d549bed",
 14 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R",
 15 |     "active": true,
 16 |     "name": "A1",
 17 |     "image": "",
 18 |     "description": "",
 19 |     "createdAt": "2026-01-13T12:02:19.900Z",
 20 |     "updatedAt": "2026-01-13T12:02:19.900Z"
 21 |   },
 22 |   {
 23 |     "id": "71bb210aa5589b65",
 24 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R",
 25 |     "active": true,
 26 |     "name": "A1",
 27 |     "image": "",
 28 |     "description": "",
 29 |     "createdAt": "2026-01-13T12:02:38.054Z",
 30 |     "updatedAt": "2026-01-13T12:02:38.054Z"
 31 |   },
 32 |   {
 33 |     "id": "993164c73c6c2f3a",
 34 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R",
 35 |     "active": true,
 36 |     "name": "A1",
 37 |     "image": "",
 38 |     "description": "",
 39 |     "createdAt": "2026-01-13T12:02:47.316Z",
 40 |     "updatedAt": "2026-01-13T12:02:47.316Z"
 41 |   },
 42 |   {
 43 |     "id": "2313d315e854c69d",
 44 |     "url": "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R",
 45 |     "active": true,
 46 |     "name": "A1",
 47 |     "image": "",
 48 |     "description": "",
 49 |     "createdAt": "2026-01-13T12:02:56.964Z",
 50 |     "updatedAt": "2026-01-13T12:02:56.964Z"
 51 |   },
 52 |   {
 53 |     "id": "6b805b9f4cbaeaea",
 54 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R",
 55 |     "active": true,
 56 |     "name": "A1",
 57 |     "image": "",
 58 |     "description": "",
 59 |     "createdAt": "2026-01-13T12:03:12.748Z",
 60 |     "updatedAt": "2026-01-13T12:03:12.748Z"
 61 |   },
 62 |   {
 63 |     "id": "98187316e5c997d2",
 64 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R",
 65 |     "active": true,
 66 |     "name": "A1",
 67 |     "image": "",
 68 |     "description": "",
 69 |     "createdAt": "2026-01-13T12:03:23.490Z",
 70 |     "updatedAt": "2026-01-13T12:03:23.490Z"
 71 |   },
 72 |   {
 73 |     "id": "eaf757d67c85db01",
 74 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R",
 75 |     "active": true,
 76 |     "name": "A1",
 77 |     "image": "",
 78 |     "description": "",
 79 |     "createdAt": "2026-01-13T12:03:40.087Z",
 80 |     "updatedAt": "2026-01-13T12:03:40.087Z"
 81 |   },
 82 |   {
 83 |     "id": "5da859b41dc6453b",
 84 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R",
 85 |     "active": true,
 86 |     "name": "A1",
 87 |     "image": "",
 88 |     "description": "",
 89 |     "createdAt": "2026-01-13T12:03:48.543Z",
 90 |     "updatedAt": "2026-01-13T12:03:48.543Z"
 91 |   },
 92 |   {
 93 |     "id": "74d177191382a1f2",
 94 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R",
 95 |     "active": true,
 96 |     "name": "A1",
 97 |     "image": "",
 98 |     "description": "",
 99 |     "createdAt": "2026-01-13T12:04:09.163Z",
100 |     "updatedAt": "2026-01-13T12:04:09.163Z"
101 |   },
102 |   {
103 |     "id": "43712b5c70dd5b63",
104 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R",
105 |     "active": true,
106 |     "name": "A1",
107 |     "image": "",
108 |     "description": "",
109 |     "createdAt": "2026-01-13T12:04:18.203Z",
110 |     "updatedAt": "2026-01-13T12:04:18.203Z"
111 |   },
112 |   {
113 |     "id": "1bb8d3d9d5817ba7",
114 |     "url": "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R",
115 |     "active": true,
116 |     "name": "A1",
117 |     "image": "",
118 |     "description": "",
119 |     "createdAt": "2026-01-13T12:04:27.086Z",
120 |     "updatedAt": "2026-01-13T12:04:27.086Z"
121 |   },
122 |   {
123 |     "id": "6ef3c021b443c50a",
124 |     "url": "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R",
125 |     "active": true,
126 |     "name": "A4",
127 |     "image": "",
128 |     "description": "",
129 |     "createdAt": "2026-01-13T12:04:38.682Z",
130 |     "updatedAt": "2026-01-13T12:04:38.682Z"
131 |   },
132 |   {
133 |     "id": "8116e13c116116c8",
134 |     "url": "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R",
135 |     "active": true,
136 |     "name": "A4",
137 |     "image": "",
138 |     "description": "",
139 |     "createdAt": "2026-01-13T12:04:46.680Z",
140 |     "updatedAt": "2026-01-13T12:04:46.680Z"
141 |   },
142 |   {
143 |     "id": "3b6cfa43309ffe8d",
144 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R",
145 |     "active": true,
146 |     "name": "A4",
147 |     "image": "",
148 |     "description": "",
149 |     "createdAt": "2026-01-13T12:04:54.365Z",
150 |     "updatedAt": "2026-01-13T12:04:54.365Z"
151 |   },
152 |   {
153 |     "id": "0c50963c372aabab",
154 |     "url": "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R",
155 |     "active": true,
156 |     "name": "A4",
157 |     "image": "",
158 |     "description": "",
159 |     "createdAt": "2026-01-13T12:05:02.328Z",
160 |     "updatedAt": "2026-01-13T12:05:02.328Z"
161 |   },
162 |   {
163 |     "id": "4fe4b13eaed47ede",
164 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R",
165 |     "active": true,
166 |     "name": "A4",
167 |     "image": "",
168 |     "description": "",
169 |     "createdAt": "2026-01-13T12:05:10.668Z",
170 |     "updatedAt": "2026-01-13T12:05:10.668Z"
171 |   },
172 |   {
173 |     "id": "b46ca54914eebf06",
174 |     "url": "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R",
175 |     "active": true,
176 |     "name": "A4",
177 |     "image": "",
178 |     "description": "",
179 |     "createdAt": "2026-01-13T12:05:18.631Z",
180 |     "updatedAt": "2026-01-13T12:05:18.631Z"
181 |   },
182 |   {
183 |     "id": "d2ca2a803d8fc150",
184 |     "url": "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R",
185 |     "active": true,
186 |     "name": "A4",
187 |     "image": "",
188 |     "description": "",
189 |     "createdAt": "2026-01-13T12:05:28.201Z",
190 |     "updatedAt": "2026-01-13T12:05:28.201Z"
191 |   },
192 |   {
193 |     "id": "b5304298e34e0a96",
194 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R",
195 |     "active": true,
196 |     "name": "A6",
197 |     "image": "",
198 |     "description": "",
199 |     "createdAt": "2026-01-13T12:05:36.647Z",
200 |     "updatedAt": "2026-01-13T12:05:44.651Z"
201 |   },
202 |   {
203 |     "id": "c96523ed0496d6a6",
204 |     "url": "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R",
205 |     "active": true,
206 |     "name": "A6",
207 |     "image": "",
208 |     "description": "",
209 |     "createdAt": "2026-01-13T12:05:57.251Z",
210 |     "updatedAt": "2026-01-13T12:05:57.251Z"
211 |   },
212 |   {
213 |     "id": "bf549948402a600d",
214 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R",
215 |     "active": true,
216 |     "name": "A6",
217 |     "image": "",
218 |     "description": "",
219 |     "createdAt": "2026-01-13T12:06:00.841Z",
220 |     "updatedAt": "2026-01-13T12:06:00.841Z"
221 |   },
222 |   {
223 |     "id": "e60b5d49e8733062",
224 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R",
225 |     "active": true,
226 |     "name": "A6",
227 |     "image": "",
228 |     "description": "",
229 |     "createdAt": "2026-01-13T12:06:12.701Z",
230 |     "updatedAt": "2026-01-13T12:06:12.701Z"
231 |   },
232 |   {
233 |     "id": "f8cccfff57b15d13",
234 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R",
235 |     "active": true,
236 |     "name": "B5",
237 |     "image": "",
238 |     "description": "",
239 |     "createdAt": "2026-01-13T12:06:21.505Z",
240 |     "updatedAt": "2026-01-13T12:06:21.505Z"
241 |   },
242 |   {
243 |     "id": "2ba4e8d680acf0fc",
244 |     "url": "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R",
245 |     "active": true,
246 |     "name": "B5",
247 |     "image": "",
248 |     "description": "",
249 |     "createdAt": "2026-01-13T12:06:31.521Z",
250 |     "updatedAt": "2026-01-13T12:06:31.521Z"
251 |   },
252 |   {
253 |     "id": "03d290a9d31ca2b5",
254 |     "url": "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R",
255 |     "active": true,
256 |     "name": "B5",
257 |     "image": "",
258 |     "description": "",
259 |     "createdAt": "2026-01-13T12:06:41.365Z",
260 |     "updatedAt": "2026-01-13T12:06:41.365Z"
261 |   }
262 | ]
263 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/.env`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```dotenv
 1 | FB_EMAIL=Test@Test.pl
 2 | FB_PASSWORD=test
 3 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
 4 | CHECK_INTERVAL_MS=60000
 5 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
 6 | COOKIES_READ_ONLY=false
 7 | HEADLESS_BROWSER=true
 8 | USE_UI_HANDLERS=false
 9 | INCLUDE_REPLIES=true
10 | 
11 | PROJECT_DIR="C:/Projekty vs/FB_Watcher"
12 | PANEL_TOKEN=TEST_TOKEN_123
13 | PANEL_PORT=3180
14 | PM2_APP=fbwatcher
15 | 
16 | PM2_LOG_OUT=C:\Users\zorro\.pm2\logs\fbwatcher-out.log
17 | PM2_LOG_ERR=C:\Users\zorro\.pm2\logs\fbwatcher-error.log
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/package.json`
**Typ:** JSON  
**Opis:** Metadane projektu i zale≈ºno≈õci (npm).  

```json
 1 | {
 2 |   "name": "fb_puppeteer",
 3 |   "version": "1.0.0",
 4 |   "description": "Watcher komentarzy FB + webhook do Make",
 5 |   "main": "src/index.js",
 6 |   "type": "module",
 7 |   "scripts": {
 8 |     "start": "node src/index.js",
 9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs"
11 |   },
12 |   "keywords": [],
13 |   "author": "",
14 |   "license": "ISC",
15 |   "dependencies": {
16 |     "axios": "^1.13.2",
17 |     "dotenv": "^17.2.3",
18 |     "puppeteer": "^24.31.0"
19 |   },
20 |   "devDependencies": {
21 |     "@yao-pkg/pkg": "^6.11.0",
22 |     "esbuild": "^0.27.2",
23 |     "nexe": "^5.0.0-beta.4",
24 |     "pkg": "^5.8.1"
25 |   },
26 |   "pkg": {
27 |     "assets": [
28 |       "src/panel/api.js",
29 |       "src/panel/**/*.js",
30 |       ".env",
31 |       "data/**/*"
32 |     ]
33 |   }
34 | }
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // index.js
 2 | import { startWatcher } from "./watcher.js";
 3 | 
 4 | console.log("[CFG] HEADLESS_BROWSER (process.env) =", process.env.HEADLESS_BROWSER);
 5 | 
 6 | startWatcher().catch((err) => {
 7 |   console.error("Fatal error:", err);
 8 |   process.exit(1);
 9 | });
10 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  

```js
  1 | // src/watcher.js
  2 | import puppeteer from "puppeteer";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import {
  6 |   EXPAND_COMMENTS,
  7 |   CHECK_INTERVAL_MS,
  8 |   POSTS_SHEET_URL,
  9 |   POSTS_REFRESH_MS,
 10 | } from "./config.js";
 11 | 
 12 | import {
 13 |   prepare,
 14 |   getCommentCount,
 15 |   loadAllComments,
 16 |   extractCommentsData,
 17 | } from "./fb/comments.js";
 18 | 
 19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
 20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
 21 | import { sendWebhook } from "./webhook.js";
 22 | import { loadCache, saveCache } from "./db/cache.js";
 23 | 
 24 | /**
 25 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
 26 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
 27 |  *
 28 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
 29 |  * POSTS_FILE=C:\Projekty vs\FB_Watcher\data\posts.json
 30 |  */
 31 | const POSTS_FILE =
 32 |   process.env.POSTS_FILE ||
 33 |   path.join(process.cwd(), "data", "posts.json");
 34 | 
 35 | /**
 36 |  * CACHE DYSKOWY:
 37 |  * {
 38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
 39 |  * }
 40 |  */
 41 | const commentsCache = loadCache();
 42 | const lastCounts = new Map(); // url -> lastCount
 43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
 44 | 
 45 | for (const [url, entry] of Object.entries(commentsCache)) {
 46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
 47 |   if (Array.isArray(entry?.knownIds))
 48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
 49 | }
 50 | 
 51 | let currentPosts = [];
 52 | let lastRefreshAny = 0; // wsp√≥lny zegar od≈õwie≈ºania ≈∫r√≥de≈Ç
 53 | 
 54 | let navErrorCount = 0;
 55 | const MAX_NAV_ERRORS = 5;
 56 | 
 57 | function isNavigationError(err) {
 58 |   if (!err) return false;
 59 |   const msg = String(err.message || err).toLowerCase();
 60 |   return (
 61 |     msg.includes("safegoto-failed") ||
 62 |     msg.includes("navigation timeout") ||
 63 |     msg.includes("net::err_connection_timed_out") ||
 64 |     msg.includes("net::err_timed_out")
 65 |   );
 66 | }
 67 | 
 68 | /* ============================================================
 69 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
 70 |    ============================================================ */
 71 | 
 72 | async function applyStealth(page) {
 73 |   await page.evaluateOnNewDocument(() => {
 74 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
 75 |     // @ts-ignore
 76 |     window.chrome = window.chrome || { runtime: {} };
 77 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
 78 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
 79 | 
 80 |     const permissions = window.navigator.permissions;
 81 |     if (permissions && permissions.query) {
 82 |       const originalQuery = permissions.query.bind(permissions);
 83 |       permissions.query = (parameters) => {
 84 |         if (
 85 |           parameters &&
 86 |           parameters.name === "notifications" &&
 87 |           window.Notification
 88 |         ) {
 89 |           return Promise.resolve({ state: window.Notification.permission });
 90 |         }
 91 |         return originalQuery(parameters);
 92 |       };
 93 |     }
 94 |   });
 95 | }
 96 | 
 97 | /* ============================================================
 98 |    ===============   PANEL POSTS (data/posts.json)   ===========
 99 |    ============================================================ */
100 | 
101 | function safeJsonParse(s) {
102 |   try {
103 |     return { ok: true, value: JSON.parse(s) };
104 |   } catch (e) {
105 |     return { ok: false, error: e?.message || "Invalid JSON" };
106 |   }
107 | }
108 | 
109 | function normalizeUrl(u) {
110 |   if (!u) return "";
111 |   const x = String(u).trim();
112 |   if (!/^https?:\/\/.+/i.test(x)) return "";
113 |   return x;
114 | }
115 | 
116 | function readPanelPosts() {
117 |   try {
118 |     if (!fs.existsSync(POSTS_FILE)) {
119 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
120 |     }
121 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
122 |     if (!raw) {
123 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
124 |     }
125 |     const parsed = safeJsonParse(raw);
126 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
127 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
128 |     }
129 | 
130 |     const posts = parsed.value
131 |       .map((p) => {
132 |         const url = normalizeUrl(p?.url);
133 |         const active = Boolean(p?.active);
134 |         if (!url) return null;
135 |         return {
136 |           id: String(p?.id || url),
137 |           url,
138 |           active,
139 |           name: p?.name ? String(p.name) : "",
140 |           image: p?.image ? String(p.image) : "",
141 |           description: p?.description ? String(p.description) : "",
142 |         };
143 |       })
144 |       .filter(Boolean);
145 | 
146 |     const activePosts = posts.filter((p) => p.active);
147 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
148 |   } catch (e) {
149 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
150 |   }
151 | }
152 | 
153 | /* ============================================================
154 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
155 |    ============================================================ */
156 | 
157 | function parseSheetCsv(text) {
158 |   const lines = text
159 |     .split(/\r?\n/)
160 |     .map((l) => l.trim())
161 |     .filter((l) => l.length > 0);
162 | 
163 |   if (!lines.length) {
164 |     console.warn("[Sheet] Pusty CSV z arkusza.");
165 |     return [];
166 |   }
167 | 
168 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
169 | 
170 |   const idxUrl = header.findIndex((h) => h === "url");
171 |   const idxActive = header.findIndex((h) => h === "active");
172 | 
173 |   // nowe kolumny od klienta
174 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
175 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
176 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
177 | 
178 |   if (idxUrl === -1) {
179 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
180 |     return [];
181 |   }
182 | 
183 |   const posts = [];
184 | 
185 |   for (let i = 1; i < lines.length; i++) {
186 |     const row = lines[i].split(",");
187 |     const rawUrl = (row[idxUrl] || "").trim();
188 |     if (!rawUrl) continue;
189 | 
190 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
191 |     const activeNorm = activeRaw.toLowerCase();
192 |     const isActive =
193 |       idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
194 | 
195 |     if (!isActive) continue;
196 | 
197 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
198 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
199 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
200 | 
201 |     posts.push({
202 |       id: `sheet-${i}`,
203 |       url: rawUrl,
204 |       name,
205 |       image,
206 |       description,
207 |     });
208 |   }
209 | 
210 |   return posts;
211 | }
212 | 
213 | /* ============================================================
214 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
215 |    ============================================================ */
216 | 
217 | async function refreshPostsIfNeeded(force = false) {
218 |   const now = Date.now();
219 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
220 |   lastRefreshAny = now;
221 | 
222 |   // 1) PRIMARY: panel posts.json
223 |   const panel = readPanelPosts();
224 |   if (panel.ok && panel.posts.length > 0) {
225 |     const newPosts = panel.posts;
226 | 
227 |     const oldJson = JSON.stringify(currentPosts);
228 |     const newJson = JSON.stringify(newPosts);
229 | 
230 |     if (oldJson !== newJson) {
231 |       console.log(
232 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
233 |       );
234 |       currentPosts = newPosts;
235 |     } else {
236 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
237 |     }
238 |     return;
239 |   }
240 | 
241 |   console.log(
242 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
243 |   );
244 | 
245 |   // 2) FALLBACK: Sheets
246 |   if (!POSTS_SHEET_URL) {
247 |     console.warn(
248 |       "[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza."
249 |     );
250 |     currentPosts = [];
251 |     return;
252 |   }
253 | 
254 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
255 | 
256 |   try {
257 |     const res = await fetch(POSTS_SHEET_URL);
258 |     if (!res.ok) {
259 |       console.error(
260 |         "[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:",
261 |         res.status,
262 |         res.statusText
263 |       );
264 |       currentPosts = [];
265 |       return;
266 |     }
267 | 
268 |     const csvText = await res.text();
269 |     const newPosts = parseSheetCsv(csvText);
270 | 
271 |     if (!newPosts.length) {
272 |       console.warn(
273 |         "[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE)."
274 |       );
275 |       currentPosts = [];
276 |       return;
277 |     }
278 | 
279 |     const oldJson = JSON.stringify(currentPosts);
280 |     const newJson = JSON.stringify(newPosts);
281 | 
282 |     if (oldJson !== newJson) {
283 |       console.log(
284 |         `[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`
285 |       );
286 |       currentPosts = newPosts;
287 |     } else {
288 |       console.log("[Sheet] Lista post√≥w bez zmian.");
289 |     }
290 |   } catch (err) {
291 |     console.error(
292 |       "[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:",
293 |       err.message
294 |     );
295 |     currentPosts = [];
296 |   }
297 | }
298 | 
299 | /* ============================================================
300 |    =====================   CACHE HELPERS   =====================
301 |    ============================================================ */
302 | 
303 | function getCacheKey(post) {
304 |   return post.url;
305 | }
306 | 
307 | function getKnownSetForPost(cacheKey) {
308 |   let set = knownCommentsPerPost.get(cacheKey);
309 |   if (!set) {
310 |     const entry = commentsCache[cacheKey];
311 |     set =
312 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
313 |     knownCommentsPerPost.set(cacheKey, set);
314 |   }
315 |   return set;
316 | }
317 | 
318 | function flushCacheToDisk() {
319 |   const out = { ...commentsCache };
320 | 
321 |   for (const [cacheKey, count] of lastCounts.entries()) {
322 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
323 |     out[cacheKey].lastCount = count;
324 |   }
325 | 
326 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
327 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
328 |     out[cacheKey].knownIds = Array.from(set);
329 |   }
330 | 
331 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
332 |   Object.assign(commentsCache, out);
333 |   saveCache(out);
334 | }
335 | 
336 | /* ============================================================
337 |    =====================   G≈Å√ìWNY WATCHER   ===================
338 |    ============================================================ */
339 | 
340 | const isDev = process.env.NODE_ENV !== "production";
341 | 
342 | async function startWatcher() {
343 |   console.log(
344 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
345 |     Math.round(CHECK_INTERVAL_MS / 1000),
346 |     "sekund."
347 |   );
348 | 
349 |   const loop = async () => {
350 |     let browser = null;
351 |     let page = null;
352 |     let hadNavErrorThisRound = false;
353 | 
354 |     try {
355 |       console.log(
356 |         "[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="
357 |       );
358 | 
359 |       browser = await puppeteer.launch({
360 |         headless: isDev ? true : "new",
361 |         defaultViewport: null,
362 |         args: [
363 |           "--no-sandbox",
364 |           "--disable-setuid-sandbox",
365 |           "--disable-dev-shm-usage",
366 |           "--disable-notifications",
367 |           "--disable-blink-features=AutomationControlled",
368 |         ],
369 |         ignoreDefaultArgs: ["--enable-automation"],
370 |       });
371 | 
372 |       page = await browser.newPage();
373 |       await applyStealth(page);
374 | 
375 |       page.setDefaultNavigationTimeout(90000);
376 |       page.setDefaultTimeout(90000);
377 | 
378 |       await page.setViewport({ width: 1280, height: 720 });
379 | 
380 |       // cookies + login
381 |       await loadCookies(page);
382 |       await page
383 |         .goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 })
384 |         .catch(() => {});
385 | 
386 |       let loggedIn = await checkIfLogged(page);
387 |       if (!loggedIn) {
388 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
389 |         await fbLogin(page);
390 |         loggedIn = await checkIfLogged(page);
391 | 
392 |         if (loggedIn) {
393 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
394 |           await saveCookies(page);
395 |         } else {
396 |           console.error(
397 |             "[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone)."
398 |           );
399 |         }
400 |       } else {
401 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
402 |       }
403 | 
404 |       // posts
405 |       await refreshPostsIfNeeded(true);
406 | 
407 |       if (!currentPosts.length) {
408 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
409 |       } else {
410 |         for (const post of currentPosts) {
411 |           const cacheKey = getCacheKey(post);
412 | 
413 |           try {
414 |             // zawsze prepare przed liczeniem/scrollowaniem/ekstrakcjƒÖ
415 |             await prepare(page, post.url);
416 | 
417 |             const count = await getCommentCount(page, post.url);
418 |             const hasCount = typeof count === "number" && Number.isFinite(count);
419 | 
420 |             if (!hasCount) {
421 |               console.log(
422 |                 `[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`
423 |               );
424 |             }
425 | 
426 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
427 |             const knownSet = getKnownSetForPost(cacheKey);
428 | 
429 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
430 |             if (prev === null) {
431 |               const initialCount = hasCount ? count : 0;
432 |               lastCounts.set(cacheKey, initialCount);
433 | 
434 |               console.log(
435 |                 hasCount
436 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
437 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
438 |               );
439 | 
440 |               if (EXPAND_COMMENTS) {
441 |                 await loadAllComments(
442 |                   page,
443 |                   { expectedTotal: hasCount ? count : undefined },
444 |                   post.url
445 |                 ).catch(() => {});
446 | 
447 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
448 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
449 |                 console.log(
450 |                   `[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`
451 |                 );
452 |               } else {
453 |                 console.log(
454 |                   `[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`
455 |                 );
456 |               }
457 | 
458 |               continue;
459 |             }
460 | 
461 |             // licznik: aktualizuj tylko je≈õli mamy twarde dane
462 |             if (hasCount) {
463 |               if (count !== prev) {
464 |                 console.log(
465 |                   `[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`
466 |                 );
467 |                 lastCounts.set(cacheKey, count);
468 |               } else {
469 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
470 |               }
471 |             } else {
472 |               console.log(
473 |                 `[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`
474 |               );
475 |             }
476 | 
477 |             if (!EXPAND_COMMENTS) continue;
478 | 
479 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(
480 |               () => {}
481 |             );
482 | 
483 |             let snapshot = await extractCommentsData(page, post.url).catch(() => []);
484 | 
485 |             // nowe ID
486 |             const newComments = [];
487 |             for (const c of snapshot) {
488 |               if (!c?.id) continue;
489 |               if (!knownSet.has(c.id)) {
490 |                 knownSet.add(c.id);
491 |                 newComments.push(c);
492 |               }
493 |             }
494 | 
495 |             // fallback "tail" tylko je≈õli mamy wiarygodny licznik i wzrost
496 |             if (hasCount && newComments.length === 0 && count > prev) {
497 |               const diff = Math.max(1, count - prev);
498 |               const tail = snapshot.slice(-diff);
499 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
500 | 
501 |               console.log(
502 |                 `[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`
503 |               );
504 |               await sendWebhook(post, tail, count, prev);
505 |               continue;
506 |             }
507 | 
508 |             if (newComments.length > 0) {
509 |               console.log(
510 |                 `[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`
511 |               );
512 |               await sendWebhook(
513 |                 post,
514 |                 newComments,
515 |                 hasCount ? count : null,
516 |                 hasCount ? prev : null
517 |               );
518 |             } else {
519 |               console.log(
520 |                 `[Watcher] Post ${post.id}: Brak nowych komentarzy (po ID i fallbacku).`
521 |               );
522 |             }
523 |           } catch (err) {
524 |             console.error(
525 |               `[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`,
526 |               err?.message || err
527 |             );
528 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
529 | 
530 |             if (isNavigationError(err)) {
531 |               hadNavErrorThisRound = true;
532 |               navErrorCount++;
533 |               console.log(
534 |                 `[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`
535 |               );
536 |             }
537 |           }
538 |         }
539 |       }
540 |     } catch (err) {
541 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
542 |     } finally {
543 |       flushCacheToDisk();
544 | 
545 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
546 |         console.log(
547 |           `[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`
548 |         );
549 |         navErrorCount = 0;
550 |       }
551 | 
552 |       if (browser) {
553 |         try {
554 |           await browser.close();
555 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
556 |         } catch (e) {
557 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
558 |         }
559 |       }
560 | 
561 |       if (navErrorCount >= MAX_NAV_ERRORS) {
562 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
563 |         process.exit(1);
564 |       }
565 | 
566 |       const jitter = Math.floor(Math.random() * 5000);
567 |       const delay = CHECK_INTERVAL_MS + jitter;
568 |       console.log(
569 |         `[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`
570 |       );
571 |       setTimeout(loop, delay);
572 |     }
573 |   };
574 | 
575 |   loop();
576 | }
577 | 
578 | export { startWatcher };
579 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/webhook.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/webhook.js
  2 | import axios from "axios";
  3 | import { POST_LABELS } from "./config.js";
  4 | 
  5 | /* ============================================================
  6 |    PARSER CZASU FB ‚Üí ISO
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 | 
 12 |   const t = raw.toLowerCase().trim();
 13 |   const now = new Date();
 14 | 
 15 |   if (t.includes("przed chwilƒÖ")) return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
 24 |   if (!m) return null;
 25 | 
 26 |   const value = parseInt(m[1], 10);
 27 |   if (!Number.isFinite(value)) return null;
 28 | 
 29 |   const unit = m[2];
 30 |   const d = new Date(now);
 31 | 
 32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
 33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
 34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
 35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
 36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
 37 | 
 38 |   return d;
 39 | }
 40 | 
 41 | /* ============================================================
 42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
 43 |    ============================================================ */
 44 | 
 45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
 46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 47 | 
 48 | function filterByAge(comments) {
 49 |   const now = Date.now();
 50 | 
 51 |   return comments.filter((c) => {
 52 |     if (!c.time || c.time.trim() === "") return false;
 53 | 
 54 |     const abs = parseFbRelativeTime(c.time);
 55 |     if (!abs) return false;
 56 | 
 57 |     const ageMinutes = (now - abs.getTime()) / 60000;
 58 |     return ageMinutes <= MAX_AGE_MIN;
 59 |   });
 60 | }
 61 | 
 62 | /* ============================================================
 63 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
 64 |    ============================================================ */
 65 | 
 66 | async function sendWebhook(post, newComments, newCount, oldCount) {
 67 |   const url = process.env.WEBHOOK_URL;
 68 |   if (!url) {
 69 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
 70 |     return;
 71 |   }
 72 | 
 73 |   // meta posta (panel/sheets/env fallback)
 74 |   const postName =
 75 |     (post?.name && String(post.name).trim()) ||
 76 |     POST_LABELS[post?.id] ||
 77 |     post?.id ||
 78 |     "post";
 79 | 
 80 |   const postImage =
 81 |     (post?.image && String(post.image).trim()) || null;
 82 | 
 83 |   const postDescription =
 84 |     (post?.description && String(post.description).trim()) || null;
 85 | 
 86 |   /* --------------------------------------------
 87 |        1) Normalizacja czasu i dodanie p√≥l ISO
 88 |      -------------------------------------------- */
 89 | 
 90 |   const normalized = newComments.map((c) => {
 91 |     const iso = parseFbRelativeTime(c.time);
 92 |     return {
 93 |       ...c,
 94 |       fb_time_raw: c.time || null,
 95 |       fb_time_iso: iso ? iso.toISOString() : null,
 96 |     };
 97 |   });
 98 | 
 99 |   /* --------------------------------------------
100 |        2) Filtrowanie komentarzy po wieku
101 |      -------------------------------------------- */
102 | 
103 |   const freshOnly = filterByAge(normalized);
104 | 
105 |   console.log("[Webhook] Filtr wieku komentarzy:", {
106 |     before: normalized.length,
107 |     after: freshOnly.length,
108 |     maxAgeMin: MAX_AGE_MIN,
109 |   });
110 | 
111 |   if (freshOnly.length === 0) {
112 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
113 |     return;
114 |   }
115 | 
116 |   /* --------------------------------------------
117 |        3) Payload do webhooka
118 |      -------------------------------------------- */
119 | 
120 |   const payload = {
121 |     post: {
122 |       id: post?.id || null,
123 |       url: post?.url || null,
124 |       name: postName,
125 |       image: postImage,
126 |       description: postDescription,
127 |     },
128 |     commentCount: newCount,
129 |     previousCommentCount: oldCount,
130 |     newComments: freshOnly,
131 |     timestamp: new Date().toISOString(),
132 |   };
133 | 
134 |   console.log("[Webhook] Wysy≈Çanie danych o nowych komentarzach:", payload);
135 | 
136 |   /* --------------------------------------------
137 |        4) Wysy≈Çka do Make / webhooka
138 |      -------------------------------------------- */
139 | 
140 |   try {
141 |     await axios.post(url, payload, { timeout: 10000 });
142 |     console.log("[Webhook] Wys≈Çano nowe komentarze do webhooka.");
143 |   } catch (err) {
144 |     console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err.message);
145 |   }
146 | }
147 | 
148 | export { sendWebhook };
149 | 
```

---

### üìÑ ≈öcie≈ºka: `debug-login.mjs`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | import fs from "fs/promises";
 2 | import puppeteer from "puppeteer";
 3 | 
 4 | const email = process.env.FB_EMAIL;
 5 | const pass = process.env.FB_PASSWORD;
 6 | 
 7 | if (!email || !pass) {
 8 |   console.log("Brak FB_EMAIL/FB_PASSWORD w env (.env lub zmienne).");
 9 |   process.exit(1);
10 | }
11 | 
12 | const executablePath = process.env.PUPPETEER_EXECUTABLE_PATH || "/usr/bin/chromium-browser";
13 | 
14 | const browser = await puppeteer.launch({
15 |   headless: true,
16 |   executablePath,
17 |   args: [
18 |     "--no-sandbox",
19 |     "--disable-setuid-sandbox",
20 |     "--disable-dev-shm-usage",
21 |     "--disable-notifications",
22 |     "--lang=en-US,en",
23 |   ],
24 | });
25 | 
26 | const page = await browser.newPage();
27 | page.setDefaultTimeout(60000);
28 | 
29 | await page.goto("https://www.facebook.com/login", { waitUntil: "domcontentloaded" });
30 | await page.waitForSelector("#email", { timeout: 60000 });
31 | await page.type("#email", email, { delay: 30 });
32 | await page.type("#pass", pass, { delay: 30 });
33 | 
34 | await Promise.all([
35 |   page.click('button[name="login"]'),
36 |   page.waitForNavigation({ waitUntil: "domcontentloaded" }).catch(() => null),
37 | ]);
38 | 
39 | const url = page.url();
40 | const title = await page.title().catch(() => "");
41 | const bodyText = await page.evaluate(() => document.body?.innerText?.slice(0, 2000) || "");
42 | 
43 | await page.screenshot({ path: "/tmp/fb-login.png", fullPage: true }).catch(() => null);
44 | 
45 | console.log("URL:", url);
46 | console.log("TITLE:", title);
47 | console.log("BODY_SNIPPET:\n", bodyText);
48 | 
49 | await browser.close();
50 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/01__index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | if (process.env.__WATCHER_LOCKED__) {
 2 |   console.error("WATCHER DUPLICATE START ‚Äî EXIT");
 3 |   process.exit(1);
 4 | }
 5 | process.env.__WATCHER_LOCKED__ = "1";
 6 | 
 7 | const __log = console.log;
 8 | console.log = (...args) => {
 9 |   const ts = new Date().toISOString().replace("T"," ").replace("Z","");
10 |   __log(`[${ts}]`, ...args);
11 | };
12 | 
13 | // src/index.js
14 | import "dotenv/config";
15 | import fs from "fs";
16 | import path from "path";
17 | import { startWatcher } from "./watcher.js";
18 | import { sendOwnerAlert } from "./telegram.js";
19 | 
20 | function ensureDir(p) {
21 |   try {
22 |     fs.mkdirSync(p, { recursive: true });
23 |   } catch {}
24 | }
25 | 
26 | // Ustal katalogi serwerowe (≈ºeby nie wali≈Ço w /tmp losowo)
27 | const DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), "data");
28 | const TMP_DIR = process.env.TMP_DIR || path.join(process.cwd(), "tmp");
29 | ensureDir(DATA_DIR);
30 | ensureDir(TMP_DIR);
31 | 
32 | // czas + logi
33 | console.log("[BOOT] NODE_ENV =", process.env.NODE_ENV || "dev");
34 | console.log("[BOOT] TZ =", process.env.TZ || "system");
35 | console.log("[BOOT] DATA_DIR =", DATA_DIR);
36 | console.log("[BOOT] TMP_DIR =", TMP_DIR);
37 | console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);
38 | 
39 | // helper
40 | function safeToString(x) {
41 |   try {
42 |     if (x instanceof Error) return `${x.message}\n${x.stack || ""}`;
43 |     if (typeof x === "string") return x;
44 |     return JSON.stringify(x, null, 2);
45 |   } catch {
46 |     return String(x);
47 |   }
48 | }
49 | 
50 | // anti-loop
51 | let _inAlert = false;
52 | function fireAlert(title, message) {
53 |   if (_inAlert) return;
54 |   _inAlert = true;
55 |   sendOwnerAlert(title, message).catch(() => {}).finally(() => (_inAlert = false));
56 | }
57 | 
58 | // HOOKI na b≈Çƒôdy (muszƒÖ byƒá przed startWatcher)
59 | const _origErr = console.error.bind(console);
60 | console.error = (...args) => {
61 |   _origErr(...args);
62 |   fireAlert("console.error", args.map(safeToString).join(" "));
63 | };
64 | 
65 | process.on("unhandledRejection", (reason) => {
66 |   _origErr("[unhandledRejection]", reason);
67 |   fireAlert("unhandledRejection", safeToString(reason));
68 | });
69 | 
70 | process.on("uncaughtException", (err) => {
71 |   _origErr("[uncaughtException]", err);
72 |   fireAlert("uncaughtException", safeToString(err));
73 | });
74 | 
75 | // ping ‚Äú≈ºyjƒô‚Äù
76 | sendOwnerAlert("ALERTS ONLINE", `FB_Watcher start: ${new Date().toISOString()}`)
77 |   .then(() => console.log("[ALERTS] startup ping sent"))
78 |   .catch(() => console.log("[ALERTS] startup ping failed (ignored)"));
79 | 
80 | startWatcher().catch((err) => {
81 |   console.error("Fatal error:", err);
82 |   process.exit(1);
83 | });
84 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/02__watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  

```js
  1 | // src/watcher.js
  2 | import puppeteer from "puppeteer";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import {
  6 |   EXPAND_COMMENTS,
  7 |   CHECK_INTERVAL_MS,
  8 |   POSTS_SHEET_URL,
  9 |   POSTS_REFRESH_MS,
 10 | } from "./config.js";
 11 | 
 12 | import {
 13 |   prepare,
 14 |   getCommentCount,
 15 |   loadAllComments,
 16 |   extractCommentsData,
 17 | } from "./fb/comments.js";
 18 | 
 19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
 20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
 21 | import { sendWebhook, parseFbRelativeTime, filterByAge } from "./webhook.js";
 22 | import { loadCache, saveCache } from "./db/cache.js";
 23 | import { sendTelegramLeads } from "./telegram.js";
 24 | 
 25 | /**
 26 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
 27 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
 28 |  *
 29 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
 30 |  * POSTS_FILE=/opt/fb-watcher/data/posts.json
 31 |  */
 32 | const POSTS_FILE =
 33 |   process.env.POSTS_FILE || path.join(process.cwd(), "data", "posts.json");
 34 | 
 35 | /**
 36 |  * CACHE DYSKOWY:
 37 |  * {
 38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
 39 |  * }
 40 |  */
 41 | const commentsCache = loadCache();
 42 | const lastCounts = new Map(); // url -> lastCount
 43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
 44 | 
 45 | for (const [url, entry] of Object.entries(commentsCache)) {
 46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
 47 |   if (Array.isArray(entry?.knownIds))
 48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
 49 | }
 50 | 
 51 | let currentPosts = [];
 52 | let lastRefreshAny = 0;
 53 | 
 54 | let navErrorCount = 0;
 55 | const MAX_NAV_ERRORS = 5;
 56 | 
 57 | function isNavigationError(err) {
 58 |   if (!err) return false;
 59 |   const msg = String(err.message || err).toLowerCase();
 60 |   return (
 61 |     msg.includes("safegoto-failed") ||
 62 |     msg.includes("navigation timeout") ||
 63 |     msg.includes("net::err_connection_timed_out") ||
 64 |     msg.includes("net::err_timed_out")
 65 |   );
 66 | }
 67 | 
 68 | function envBool(name, def = false) {
 69 |   const raw = String(process.env[name] ?? "").trim().toLowerCase();
 70 |   if (raw === "") return def;
 71 |   return ["1", "true", "yes", "y", "tak", "on"].includes(raw);
 72 | }
 73 | 
 74 | // ================== TELEGRAM (FILTER AGE + AGE LOG) ==================
 75 | async function sendTelegramIfFresh(post, comments, ctx = "normal") {
 76 |   const list = Array.isArray(comments) ? comments : [];
 77 |   if (list.length === 0) return;
 78 | 
 79 |   const now = Date.now();
 80 | 
 81 |   const normalized = list.map((c) => {
 82 |     const rel = String(c?.fb_time_raw || c?.time || "").trim();
 83 |     const abs = parseFbRelativeTime(rel);
 84 |     const iso = abs ? abs.toISOString() : (c?.fb_time_iso || null);
 85 |     const ageMin = abs ? Math.round(((now - abs.getTime()) / 60000) * 10) / 10 : null;
 86 | 
 87 |     return {
 88 |       ...c,
 89 |       fb_time_raw: rel || null,
 90 |       fb_time_iso: iso,
 91 |       _ageMin: ageMin,
 92 |     };
 93 |   });
 94 | 
 95 |   // log wieku KA≈ªDEGO komentarza (szybki debug)
 96 |   for (const c of normalized) {
 97 |     console.log("[TG][AGE]", {
 98 |       ctx,
 99 |       id: c?.id || null,
100 |       author: c?.author || c?.name || null,
101 |       rel: c?.fb_time_raw || null,
102 |       iso: c?.fb_time_iso || null,
103 |       ageMin: c?._ageMin,
104 |     });
105 |   }
106 | 
107 |   const fresh = filterByAge(normalized);
108 | 
109 |   console.log("[TG] Filtr wieku komentarzy:", {
110 |     ctx,
111 |     before: normalized.length,
112 |     after: fresh.length,
113 |     maxAgeMin: Number(process.env.WEBHOOK_MAX_AGE_MIN || 60),
114 |   });
115 | 
116 |   if (fresh.length > 0) {
117 |     await sendTelegramLeads(post, fresh);
118 |   } else {
119 |     console.log("[TG] Brak ≈õwie≈ºych komentarzy ‚Äì nic nie wysy≈Çam.");
120 |   }
121 | }
122 | // =====================================================================
123 | 
124 | /* ============================================================
125 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
126 |    ============================================================ */
127 | 
128 | async function applyStealth(page) {
129 |   await page.evaluateOnNewDocument(() => {
130 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
131 |     // @ts-ignore
132 |     window.chrome = window.chrome || { runtime: {} };
133 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
134 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
135 | 
136 |     const permissions = window.navigator.permissions;
137 |     if (permissions && permissions.query) {
138 |       const originalQuery = permissions.query.bind(permissions);
139 |       permissions.query = (parameters) => {
140 |         if (
141 |           parameters &&
142 |           parameters.name === "notifications" &&
143 |           window.Notification
144 |         ) {
145 |           return Promise.resolve({ state: window.Notification.permission });
146 |         }
147 |         return originalQuery(parameters);
148 |       };
149 |     }
150 |   });
151 | }
152 | 
153 | /* ============================================================
154 |    ===============   PANEL POSTS (data/posts.json)   ===========
155 |    ============================================================ */
156 | 
157 | function safeJsonParse(s) {
158 |   try {
159 |     return { ok: true, value: JSON.parse(s) };
160 |   } catch (e) {
161 |     return { ok: false, error: e?.message || "Invalid JSON" };
162 |   }
163 | }
164 | 
165 | function normalizeUrl(u) {
166 | 
167 | function makePostKey(url) {
168 |   try {
169 |     const u = new URL(String(url || "").trim());
170 |     for (const k of Array.from(u.searchParams.keys())) {
171 |       if (k.startsWith("__") || ["ref","notif_id","notif_t","refid"].includes(k)) {
172 |         u.searchParams.delete(k);
173 |       }
174 |     }
175 |     if (u.pathname.includes("permalink.php")) {
176 |       const s = u.searchParams.get("story_fbid");
177 |       const id = u.searchParams.get("id");
178 |       if (s && id) return `permalink:${id}:${s}`;
179 |     }
180 |     if (u.pathname.includes("story.php")) {
181 |       const s = u.searchParams.get("story_fbid");
182 |       const id = u.searchParams.get("id");
183 |       if (s && id) return `story:${id}:${s}`;
184 |     }
185 |     const mPosts = u.pathname.match(/\/posts\/([^/?#]+)/i);
186 |     if (mPosts?.[1]) return `posts:${mPosts[1]}`;
187 |     const v = u.searchParams.get("v");
188 |     if (u.pathname.includes("/watch") && v) return `watch:${v}`;
189 |     const mVid = u.pathname.match(/\/videos\/([^/?#]+)/i);
190 |     if (mVid?.[1]) return `videos:${mVid[1]}`;
191 |     const q = u.searchParams.toString();
192 |     return `url:${u.host}${u.pathname}${q ? "?" + q : ""}`;
193 |   } catch {
194 |     return `url:${String(url || "").trim()}`;
195 |   }
196 | }
197 | 
198 |   if (!u) return "";
199 |   const x = String(u).trim();
200 |   if (!/^https?:\/\/.+/i.test(x)) return "";
201 |   return x;
202 | }
203 | 
204 | function readPanelPosts() {
205 |   try {
206 |     if (!fs.existsSync(POSTS_FILE)) {
207 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
208 |     }
209 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
210 |     if (!raw) {
211 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
212 |     }
213 | 
214 |     const parsed = safeJsonParse(raw);
215 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
216 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
217 |     }
218 | 
219 |     const posts = parsed.value
220 |       .map((p) => {
221 |         const url = normalizeUrl(p?.url);
222 |         const active = Boolean(p?.active);
223 |         if (!url) return null;
224 |         return {
225 |           id: String(p?.id || url),
226 |           url,
227 |           active,
228 |           name: p?.name ? String(p.name) : "",
229 |           image: p?.image ? String(p.image) : "",
230 |           description: p?.description ? String(p.description) : "",
231 |         };
232 |       })
233 |       .filter(Boolean);
234 | 
235 |     const activePosts = posts.filter((p) => p.active);
236 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
237 |   } catch (e) {
238 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
239 |   }
240 | }
241 | 
242 | /* ============================================================
243 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
244 |    ============================================================ */
245 | 
246 | function parseSheetCsv(text) {
247 |   const lines = text
248 |     .split(/\r?\n/)
249 |     .map((l) => l.trim())
250 |     .filter((l) => l.length > 0);
251 | 
252 |   if (!lines.length) {
253 |     console.warn("[Sheet] Pusty CSV z arkusza.");
254 |     return [];
255 |   }
256 | 
257 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
258 | 
259 |   const idxUrl = header.findIndex((h) => h === "url");
260 |   const idxActive = header.findIndex((h) => h === "active");
261 | 
262 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
263 |   const idxImage = header.findIndex(
264 |     (h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie"
265 |   );
266 |   const idxDesc = header.findIndex(
267 |     (h) => h === "description" || h === "desc" || h === "opis"
268 |   );
269 | 
270 |   if (idxUrl === -1) {
271 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
272 |     return [];
273 |   }
274 | 
275 |   const posts = [];
276 | 
277 |   for (let i = 1; i < lines.length; i++) {
278 |     const row = lines[i].split(",");
279 |     const rawUrl = (row[idxUrl] || "").trim();
280 |     if (!rawUrl) continue;
281 | 
282 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
283 |     const activeNorm = activeRaw.toLowerCase();
284 |     const isActive =
285 |       idxActive === -1
286 |         ? true
287 |         : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
288 | 
289 |     if (!isActive) continue;
290 | 
291 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
292 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
293 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
294 | 
295 |     posts.push({
296 |       id: `sheet-${i}`,
297 |       url: rawUrl,
298 |       name,
299 |       image,
300 |       description,
301 |     });
302 |   }
303 | 
304 |   return posts;
305 | }
306 | 
307 | /* ============================================================
308 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
309 |    ============================================================ */
310 | 
311 | async function refreshPostsIfNeeded(force = false) {
312 |   const now = Date.now();
313 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
314 |   lastRefreshAny = now;
315 | 
316 |   // 1) PRIMARY: panel posts.json
317 |   const panel = readPanelPosts();
318 |   if (panel.ok && panel.posts.length > 0) {
319 |     const newPosts = panel.posts;
320 | 
321 |     const oldJson = JSON.stringify(currentPosts);
322 |     const newJson = JSON.stringify(newPosts);
323 | 
324 |     if (oldJson !== newJson) {
325 |       console.log(
326 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
327 |       );
328 |       currentPosts = newPosts;
329 |     } else {
330 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
331 |     }
332 |     return;
333 |   }
334 | 
335 |   console.log(
336 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
337 |   );
338 | 
339 |   // 2) FALLBACK: Sheets
340 |   if (!POSTS_SHEET_URL) {
341 |     console.warn("[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza.");
342 |     currentPosts = [];
343 |     return;
344 |   }
345 | 
346 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
347 | 
348 |   try {
349 |     const res = await fetch(POSTS_SHEET_URL);
350 |     if (!res.ok) {
351 |       console.error("[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
352 |       currentPosts = [];
353 |       return;
354 |     }
355 | 
356 |     const csvText = await res.text();
357 |     const newPosts = parseSheetCsv(csvText);
358 | 
359 |     if (!newPosts.length) {
360 |       console.warn("[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE).");
361 |       currentPosts = [];
362 |       return;
363 |     }
364 | 
365 |     const oldJson = JSON.stringify(currentPosts);
366 |     const newJson = JSON.stringify(newPosts);
367 | 
368 |     if (oldJson !== newJson) {
369 |       console.log(`[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`);
370 |       currentPosts = newPosts;
371 |     } else {
372 |       console.log("[Sheet] Lista post√≥w bez zmian.");
373 |     }
374 |   } catch (err) {
375 |     console.error("[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:", err.message);
376 |     currentPosts = [];
377 |   }
378 | }
379 | 
380 | /* ============================================================
381 |    =====================   CACHE HELPERS   =====================
382 |    ============================================================ */
383 | 
384 | function getCacheKey(post) {
385 |   return post.url;
386 | }
387 | 
388 | function getKnownSetForPost(cacheKey) {
389 |   let set = knownCommentsPerPost.get(cacheKey);
390 |   if (!set) {
391 |     const entry = commentsCache[cacheKey];
392 |     set =
393 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
394 |     knownCommentsPerPost.set(cacheKey, set);
395 |   }
396 |   return set;
397 | }
398 | 
399 | function flushCacheToDisk() {
400 |   const out = { ...commentsCache };
401 | 
402 |   for (const [cacheKey, count] of lastCounts.entries()) {
403 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
404 |     out[cacheKey].lastCount = count;
405 |   }
406 | 
407 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
408 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
409 |     out[cacheKey].knownIds = Array.from(set);
410 |   }
411 | 
412 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
413 |   Object.assign(commentsCache, out);
414 |   saveCache(out);
415 | }
416 | 
417 | /* ============================================================
418 |    =====================   G≈Å√ìWNY WATCHER   ===================
419 |    ============================================================ */
420 | 
421 | const isDev = process.env.NODE_ENV !== "production";
422 | 
423 | function getExecutablePath() {
424 |   const p =
425 |     process.env.PUPPETEER_EXECUTABLE_PATH ||
426 |     process.env.CHROME_PATH ||
427 |     process.env.CHROMIUM_PATH ||
428 |     "";
429 |   return String(p || "").trim() || undefined;
430 | }
431 | 
432 | async function startWatcher() {
433 |   console.log(
434 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
435 |     Math.round(CHECK_INTERVAL_MS / 1000),
436 |     "sekund."
437 |   );
438 | 
439 |   const loop = async () => {
440 |     let browser = null;
441 |     let page = null;
442 |     let hadNavErrorThisRound = false;
443 | 
444 |     try {
445 |       console.log("[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ====");
446 | 
447 |       const wantHeadless = envBool("HEADLESS_BROWSER", true);
448 |       const headlessMode = wantHeadless ? (isDev ? true : "new") : false;
449 | 
450 |       const linux = process.platform === "linux";
451 |       const executablePath = getExecutablePath();
452 | 
453 |       const args = [
454 |         "--disable-notifications",
455 |         "--disable-blink-features=AutomationControlled",
456 |       ];
457 | 
458 |       if (linux) {
459 |         args.push("--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage");
460 |       }
461 | 
462 |       browser = await puppeteer.launch({
463 |         headless: headlessMode,
464 |         defaultViewport: null,
465 |         executablePath,
466 |         args,
467 |         ignoreDefaultArgs: ["--enable-automation"],
468 |       });
469 | 
470 |       page = await browser.newPage();
471 |       await applyStealth(page);
472 | 
473 |       page.setDefaultNavigationTimeout(90000);
474 |       page.setDefaultTimeout(90000);
475 | 
476 |       await page.setViewport({ width: 1280, height: 720 });
477 | 
478 |       // cookies + login
479 |       await loadCookies(page);
480 |       await page.goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 }).catch(() => {});
481 | 
482 |       let loggedIn = await checkIfLogged(page);
483 |       if (!loggedIn) {
484 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
485 |         await fbLogin(page);
486 |         loggedIn = await checkIfLogged(page);
487 | 
488 |         if (loggedIn) {
489 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
490 |           await saveCookies(page);
491 |         } else {
492 |           console.error("[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone).");
493 |         }
494 |       } else {
495 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
496 |       }
497 | 
498 |       // posts
499 |       await refreshPostsIfNeeded(true);
500 | 
501 |       if (!currentPosts.length) {
502 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
503 |       } else {
504 |         for (const post of currentPosts) {
505 |           const cacheKey = getCacheKey(post);
506 | 
507 |           try {
508 |             await prepare(page, post.url);
509 | 
510 |             const count = await getCommentCount(page, post.url);
511 |             const hasCount = typeof count === "number" && Number.isFinite(count);
512 | 
513 |             if (!hasCount) {
514 |               console.log(`[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`);
515 |             }
516 | 
517 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
518 |             const knownSet = getKnownSetForPost(cacheKey);
519 | 
520 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
521 |             if (prev === null) {
522 |               const initialCount = hasCount ? count : 0;
523 |               lastCounts.set(cacheKey, initialCount);
524 | 
525 |               console.log(
526 |                 hasCount
527 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
528 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
529 |               );
530 | 
531 |               if (EXPAND_COMMENTS) {
532 |                 await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }, post.url).catch(() => {});
533 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
534 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
535 |                 console.log(`[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`);
536 |               } else {
537 |                 console.log(`[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`);
538 |               }
539 | 
540 |               continue;
541 |             }
542 | 
543 |             if (hasCount) {
544 |               if (count !== prev) {
545 |                 console.log(`[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`);
546 |                 lastCounts.set(cacheKey, count);
547 |               } else {
548 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
549 |               }
550 |             } else {
551 |               console.log(`[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`);
552 |             }
553 | 
554 |             if (!EXPAND_COMMENTS) continue;
555 | 
556 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(() => {});
557 |             const snapshot = await extractCommentsData(page, post.url).catch(() => []);
558 | 
559 |             const newComments = [];
560 |             for (const c of snapshot) {
561 |               if (!c?.id) continue;
562 |               if (!knownSet.has(c.id)) {
563 |                 knownSet.add(c.id);
564 |                 newComments.push(c);
565 |       c.__postId = post.id;
566 |       c.__postUrl = post.url;
567 |               }
568 |             }
569 | 
570 |             
571 |             // ===== DEBUG: sanity-check skƒÖd sƒÖ komentarze =====
572 |             console.log("[DBG][POST_CTX]", {
573 |               postId: post?.id || null,
574 |               postUrl: post?.url || null,
575 |               snapshotLen: Array.isArray(snapshot) ? snapshot.length : null,
576 |               newLen: Array.isArray(newComments) ? newComments.length : null,
577 |               sample: (Array.isArray(newComments) ? newComments.slice(0, 3) : []).map((c) => ({
578 |                 id: c?.id || null,
579 |                 author: c?.author || c?.name || null,
580 |                 time: c?.fb_time_raw || c?.time || null,
581 |                 // poni≈ºsze pola mogƒÖ istnieƒá albo nie ‚Äî ale jak istniejƒÖ, to nam powiedzƒÖ prawdƒô:
582 |                 link: c?.link || c?.permalink || c?.url || null,
583 |                 postRef: c?.postUrl || c?.post_url || c?.post || null,
584 |               })),
585 |             });
586 |             // ================================================
587 | if (hasCount && newComments.length === 0 && count > prev) {
588 |               const diff = Math.max(1, count - prev);
589 |               const tail = snapshot.slice(-diff);
590 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
591 | 
592 |               console.log(`[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`);
593 |               await sendWebhook(post, tail, count, prev);
594 | 
595 |               await sendTelegramIfFresh(post, tail, "fallback");
596 | 
597 |               continue;
598 |             }
599 | 
600 |             if (newComments.length > 0) {
601 |               console.log(`[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`);
602 |               await sendWebhook(post, newComments, hasCount ? count : null, hasCount ? prev : null);
603 | 
604 | 
605 | 
606 | 
607 |     const safeComments = newComments.filter(c => c.__postId === post.id);
608 |     if (safeComments.length !== newComments.length) {
609 |       console.warn("[WATCHER][GUARD] Odfiltrowano komentarze spoza posta", {
610 |         postId: post.id,
611 |         before: newComments.length,
612 |         after: safeComments.length
613 |       });
614 |     }
615 |                 await sendTelegramIfFresh(post, safeComments, "normal");
616 |             }
617 |           } catch (err) {
618 |             console.error(`[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`, err?.message || err);
619 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
620 | 
621 |             if (isNavigationError(err)) {
622 |               hadNavErrorThisRound = true;
623 |               navErrorCount++;
624 |               console.log(`[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`);
625 |             }
626 |           }
627 |         }
628 |       }
629 |     } catch (err) {
630 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
631 |     } finally {
632 |       flushCacheToDisk();
633 | 
634 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
635 |         console.log(`[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`);
636 |         navErrorCount = 0;
637 |       }
638 | 
639 |       if (browser) {
640 |         try {
641 |           await browser.close();
642 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
643 |         } catch (e) {
644 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
645 |         }
646 |       }
647 | 
648 |       if (navErrorCount >= MAX_NAV_ERRORS) {
649 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
650 |         process.exit(1);
651 |       }
652 | 
653 |       const jitter = Math.floor(Math.random() * 5000);
654 |       const delay = CHECK_INTERVAL_MS + jitter;
655 |       console.log(`[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`);
656 |       setTimeout(loop, delay);
657 |     }
658 |   };
659 | 
660 |   loop();
661 | }
662 | 
663 | export { startWatcher };
664 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/04__telegram.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/telegram.js
  2 | import axios from "axios";
  3 | 
  4 | /* ============================================================
  5 |    FILTR WIEKU KOMENTARZA (TELEGRAM)
  6 |    ============================================================ */
  7 | 
  8 | function parseFbRelativeTime(raw) {
  9 |   if (!raw) return null;
 10 |   const t = String(raw).toLowerCase().trim();
 11 |   const now = new Date();
 12 | 
 13 |   if (t.includes("przed chwilƒÖ")) return now;
 14 |   if (t.includes("w≈Ça≈õnie teraz") || t === "teraz" || t === "now" || t === "just now") return now;
 15 | 
 16 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 17 |     const d = new Date(now);
 18 |     d.setDate(d.getDate() - 1);
 19 |     return d;
 20 |   }
 21 | 
 22 |   // Obs≈Çugujemy polskie i angielskie skr√≥ty
 23 |   // np: 15 sek., 5 min, 2 godz., 1 dzie≈Ñ, 4 tyg., 4 weeks
 24 |   const m = t.match(/(\d+)\s*(sek\.?|s|sec|secs|second|seconds|min\.?|m|minut|minuty|minutƒô|godz\.?|h|hr|hour|hours|dni|dzie≈Ñ|d|tyg\.?|week|weeks)\b/);
 25 |   if (!m) return null;
 26 | 
 27 |   const value = parseInt(m[1], 10);
 28 |   if (!Number.isFinite(value)) return null;
 29 | 
 30 |   const unit = m[2];
 31 |   const d = new Date(now);
 32 | 
 33 |   if (unit.startsWith("sek") || unit === "s" || unit.startsWith("sec") || unit.startsWith("second")) d.setSeconds(d.getSeconds() - value);
 34 |   else if (unit.startsWith("min") || unit === "m") d.setMinutes(d.getMinutes() - value);
 35 |   else if (unit.startsWith("godz") || unit === "h" || unit === "hr" || unit.startsWith("hour")) d.setHours(d.getHours() - value);
 36 |   else if (unit.startsWith("dni") || unit.startsWith("dzie") || unit === "d") d.setDate(d.getDate() - value);
 37 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
 38 | 
 39 |   return d;
 40 | }
 41 | 
 42 | function shouldSendByAge(comment) {
 43 |   // ENV:
 44 |   // TELEGRAM_MAX_AGE_MIN=60
 45 |   // TELEGRAM_DROP_IF_NO_TIME=1  (domy≈õlnie: 1)
 46 |   const maxAgeMin = Number(process.env.TELEGRAM_MAX_AGE_MIN || process.env.WEBHOOK_MAX_AGE_MIN || 60);
 47 |   const dropIfNoTime = envBool("TELEGRAM_DROP_IF_NO_TIME", true);
 48 | 
 49 |   const rel = String(comment?.fb_time_raw || comment?.time || comment?.relative_time || "").trim();
 50 |   if (!rel) return !dropIfNoTime;
 51 | 
 52 |   const abs = parseFbRelativeTime(rel);
 53 |   if (!abs) return !dropIfNoTime;
 54 | 
 55 |   const ageMinutes = (Date.now() - abs.getTime()) / 60000;
 56 |   return ageMinutes <= maxAgeMin;
 57 | }
 58 | 
 59 | function envBool(name, def = false) {
 60 |   const v = String(process.env[name] ?? "").trim().toLowerCase();
 61 |   if (!v) return def;
 62 |   return ["1", "true", "yes", "tak", "y", "on"].includes(v);
 63 | }
 64 | 
 65 | function escapeHtml(s) {
 66 |   if (s == null) return "";
 67 |   return String(s)
 68 |     .replaceAll("&", "&amp;")
 69 |     .replaceAll("<", "&lt;")
 70 |     .replaceAll(">", "&gt;")
 71 |     .replaceAll('"', "&quot;");
 72 | }
 73 | 
 74 | function buildCaptionHtml(post, c) {
 75 |   const postName = escapeHtml(post?.name || "");
 76 |   const postDesc = escapeHtml(post?.description || "");
 77 |   const author = escapeHtml(c?.author || c?.name || "");
 78 |   const text = escapeHtml(c?.text || c?.message || "");
 79 |   const rel = escapeHtml(c?.fb_time_raw || c?.time || c?.relative_time || "");
 80 |   const url = String(post?.url || "").trim();
 81 | 
 82 |   const postLine = postDesc ? `${postName} ‚Äî ${postDesc}` : postName;
 83 | 
 84 |   return (
 85 |     `<b>üì© Nowy komentarz na Facebooku</b>\n\n` +
 86 |     `<b>üë§ Autor:</b>\n${author || "-"}\n\n` +
 87 |     `<b>üïí Czas:</b>\n${rel || "-"}\n\n` +
 88 |     `<b>üìù Tre≈õƒá:</b>\n${text || "-"}\n\n` +
 89 |     `<b>üìå Post:</b>\n${postLine || "-"}\n\n` +
 90 |     (url ? `<a href="${escapeHtml(url)}">üëâ Otw√≥rz post</a>` : "")
 91 |   );
 92 | }
 93 | 
 94 | async function tgRequest(token, method, payload) {
 95 |   const t = String(token || "").trim();
 96 |   if (!t) return { ok: false, error: "Brak tokena bota" };
 97 | 
 98 |   const endpoint = `https://api.telegram.org/bot${t}/${method}`;
 99 | 
100 |   try {
101 |     const res = await axios.post(endpoint, payload, { timeout: 15000 });
102 |     if (res?.data?.ok) return { ok: true, data: res.data };
103 |     return { ok: false, error: res?.data?.description || "Telegram error" };
104 |   } catch (e) {
105 |     return {
106 |       ok: false,
107 |       error: e?.response?.data?.description || e?.message || String(e),
108 |     };
109 |   }
110 | }
111 | 
112 | async function sendMessage(token, chat_id, text, opts = {}) {
113 |   const parse_mode = opts.parse_mode || "HTML";
114 |   const disable_web_page_preview = !!opts.disable_web_page_preview;
115 | 
116 |   return tgRequest(token, "sendMessage", {
117 |     chat_id,
118 |     text,
119 |     parse_mode,
120 |     disable_web_page_preview,
121 |   });
122 | }
123 | 
124 | async function sendPhoto(token, chat_id, photo, caption, opts = {}) {
125 |   const parse_mode = opts.parse_mode || "HTML";
126 |   return tgRequest(token, "sendPhoto", {
127 |     chat_id,
128 |     photo,
129 |     caption,
130 |     parse_mode,
131 |   });
132 | }
133 | 
134 | function getTargets() {
135 |   const sendOwner = envBool("TELEGRAM_SEND_TO_OWNER", true);
136 |   const sendClient = envBool("TELEGRAM_SEND_TO_CLIENT", true);
137 | 
138 |   const ownerToken = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
139 |   const ownerChat = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
140 | 
141 |   const clientToken = String(process.env.TELEGRAM_BOT_TOKEN_CLIENT || "").trim();
142 |   const clientChat = String(process.env.TELEGRAM_CHAT_ID_CLIENT || "").trim();
143 | 
144 |   const targets = [];
145 |   console.log("[TG][TARGETS]", {
146 |     sendOwner,
147 |     sendClient,
148 |     ownerToken: ownerToken ? ownerToken.slice(0, 12) + "..." : null,
149 |     ownerChat: ownerChat || null,
150 |     clientToken: clientToken ? clientToken.slice(0, 12) + "..." : null,
151 |     clientChat: clientChat || null,
152 |   });
153 | 
154 | 
155 |   if (sendOwner && ownerToken && ownerChat) {
156 |     targets.push({ label: "OWNER", token: ownerToken, chat_id: ownerChat });
157 |   } else if (sendOwner) {
158 |     console.warn(
159 |       "[TG] OWNER w≈ÇƒÖczony, ale brakuje TELEGRAM_BOT_TOKEN_OWNER lub TELEGRAM_CHAT_ID_OWNER."
160 |     );
161 |   }
162 | 
163 |   if (sendClient && clientToken && clientChat) {
164 |     targets.push({ label: "CLIENT", token: clientToken, chat_id: clientChat });
165 |   } else if (sendClient) {
166 |     console.warn(
167 |       "[TG] CLIENT w≈ÇƒÖczony, ale brakuje TELEGRAM_BOT_TOKEN_CLIENT lub TELEGRAM_CHAT_ID_CLIENT."
168 |     );
169 |   }
170 | 
171 |   return targets;
172 | }
173 | 
174 | /**
175 |  * 1 komentarz => wysy≈Çka na 2 Telegramy:
176 |  * - Tw√≥j (Twoim botem)
177 |  * - Klienta (botem klienta)
178 |  */
179 | async function sendTelegramLead(post, comment) {
180 |   const targets = getTargets();
181 |   if (!targets.length) return;
182 | 
183 |   const usePhoto = envBool("TELEGRAM_USE_PHOTO", true);
184 |   const disablePreview = envBool("TELEGRAM_DISABLE_WEB_PAGE_PREVIEW", true);
185 | 
186 |   const caption = buildCaptionHtml(post, comment);
187 |   const img = String(post?.image || "").trim();
188 | 
189 |   for (const t of targets) {
190 |     if (usePhoto && img) {
191 |       const r1 = await sendPhoto(t.token, t.chat_id, img, caption, {
192 |         parse_mode: "HTML",
193 |       });
194 |       if (r1.ok) {
195 |         console.log(`[TG] Wys≈Çano lead (photo) -> ${t.label}`);
196 |         await new Promise((r) => setTimeout(r, 350));
197 |         continue;
198 |       }
199 |       console.warn(
200 |         `[TG] sendPhoto nie przesz≈Ço (${t.label}) -> fallback do sendMessage:`,
201 |         r1.error
202 |       );
203 |     }
204 | 
205 |     const r2 = await sendMessage(t.token, t.chat_id, caption, {
206 |       parse_mode: "HTML",
207 |       disable_web_page_preview: disablePreview,
208 |     });
209 | 
210 |     if (r2.ok) console.log(`[TG] Wys≈Çano lead (message) -> ${t.label}`);
211 |     else console.error(`[TG] sendMessage error (${t.label}):`, r2.error);
212 | 
213 |     await new Promise((r) => setTimeout(r, 350));
214 |   }
215 | }
216 | 
217 | async function sendTelegramLeads(post, comments = []) {
218 |   for (const c of comments) {
219 |     await sendTelegramLead(post, c);
220 |     await new Promise((r) => setTimeout(r, 250));
221 |   }
222 | }
223 | 
224 | /* ============================================================
225 |    =======================  ALERTY OWNER  ======================
226 |    ============================================================ */
227 | 
228 | let _lastAlertAt = 0;
229 | let _lastAlertKey = "";
230 | let _repeatCount = 0;
231 | 
232 | function shorten(s, max) {
233 |   const x = String(s ?? "");
234 |   if (x.length <= max) return x;
235 |   return x.slice(0, max - 12) + "\n‚Ä¶(obciƒôto)‚Ä¶";
236 | }
237 | 
238 | function makeAlertKey(title, msg) {
239 |   const a = String(title || "").slice(0, 80);
240 |   const b = String(msg || "").slice(0, 200);
241 |   return `${a}::${b}`;
242 | }
243 | 
244 | async function sendOwnerAlert(title, message, opts = {}) {
245 |   if (!envBool("TG_ALERTS_ENABLED", true)) return;
246 | 
247 |   const token = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
248 |   const chatId = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
249 |   if (!token || !chatId) return;
250 | 
251 |   const cooldownSec = Number(process.env.TG_ALERTS_COOLDOWN_SEC || "120");
252 |   const maxLen = Number(process.env.TG_ALERTS_MAXLEN || "3500");
253 |   const tz = String(process.env.TG_ALERTS_TIMEZONE || "Europe/Warsaw").trim();
254 | 
255 |   const now = Date.now();
256 |   const key = makeAlertKey(title, message);
257 | 
258 |   // Anti-spam: je≈õli to samo w k√≥≈Çko w cooldownie, nie spamuj ‚Äî tylko licz
259 |   if (key === _lastAlertKey && now - _lastAlertAt < cooldownSec * 1000) {
260 |     _repeatCount++;
261 |     return;
262 |   }
263 | 
264 |   // Je≈õli wcze≈õniej co≈õ siƒô powtarza≈Ço, do≈õlij podsumowanie
265 |   if (_repeatCount > 0) {
266 |     const summary = `<b>‚ö†Ô∏è PowtarzajƒÖce siƒô b≈Çƒôdy</b>\n\nPoprzedni alert powt√≥rzy≈Ç siƒô <b>${_repeatCount}</b> razy w kr√≥tkim czasie.`;
267 |     await sendMessage(token, chatId, summary, { parse_mode: "HTML" }).catch(
268 |       () => {}
269 |     );
270 |     _repeatCount = 0;
271 |   }
272 | 
273 |   _lastAlertAt = now;
274 |   _lastAlertKey = key;
275 | 
276 |   // Lokalny czas PL (nie UTC)
277 |   const dt = new Date();
278 |   const tsLocal = new Intl.DateTimeFormat("pl-PL", {
279 |     timeZone: tz,
280 |     year: "numeric",
281 |     month: "2-digit",
282 |     day: "2-digit",
283 |     hour: "2-digit",
284 |     minute: "2-digit",
285 |     second: "2-digit",
286 |   }).format(dt);
287 | 
288 |   // Dla pewno≈õci dopisujemy te≈º UTC (kr√≥tkie), ≈ºeby ≈Çatwiej by≈Ço debugowaƒá serwer
289 |   const tsUtc = dt.toISOString().replace("T", " ").replace("Z", " UTC");
290 | 
291 |   const text =
292 |     `<b>üö® FB_Watcher ‚Äì ALERT</b>\n` +
293 |     `<b>üïí</b> ${escapeHtml(tsLocal)} (${escapeHtml(tz)})\n` +
294 |     `<b>üåç</b> ${escapeHtml(tsUtc)}\n\n` +
295 |     `<b>${escapeHtml(title || "B≈ÇƒÖd")}</b>\n\n` +
296 |     `<pre>${escapeHtml(shorten(message, maxLen))}</pre>`;
297 | 
298 |   const r = await sendMessage(token, chatId, text, {
299 |     parse_mode: "HTML",
300 |     disable_web_page_preview: true,
301 |   });
302 | 
303 |   if (!r.ok) {
304 |     // nie r√≥b pƒôtli error->alert->error
305 |     console.log("[TG ALERT] Nie uda≈Ço siƒô wys≈Çaƒá alertu:", r.error);
306 |   }
307 | }
308 | 
309 | 
310 | export { sendTelegramLead, sendTelegramLeads, sendOwnerAlert };
311 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/05__webhook.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/webhook.js
  2 | import axios from "axios";
  3 | import { POST_LABELS } from "./config.js";
  4 | 
  5 | /* ============================================================
  6 |    PARSER CZASU FB ‚Üí ISO
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 | 
 12 |   const t = raw.toLowerCase().trim();
 13 |   const now = new Date();
 14 | 
 15 |   if (t.includes("przed chwilƒÖ")) return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
 24 |   if (!m) return null;
 25 | 
 26 |   const value = parseInt(m[1], 10);
 27 |   if (!Number.isFinite(value)) return null;
 28 | 
 29 |   const unit = m[2];
 30 |   const d = new Date(now);
 31 | 
 32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
 33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
 34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
 35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
 36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
 37 | 
 38 |   return d;
 39 | }
 40 | 
 41 | /* ============================================================
 42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
 43 |    ============================================================ */
 44 | 
 45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
 46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 47 | 
 48 | function filterByAge(comments) {
 49 |   const now = Date.now();
 50 | 
 51 |   return comments.filter((c) => {
 52 |     const rel = (c?.fb_time_raw || c?.time || "").trim();
 53 |     if (!rel) return false;
 54 | 
 55 |     const abs = parseFbRelativeTime(rel);
 56 |     if (!abs) return false;
 57 | 
 58 |     const ageMinutes = (now - abs.getTime()) / 60000;
 59 |       console.log("[Webhook][AGE]", { 
 60 |         raw: rel, 
 61 |         iso: abs.toISOString(), 
 62 |         ageMin: Math.round(ageMinutes * 100) / 100, 
 63 |         maxAgeMin: MAX_AGE_MIN 
 64 |       });
 65 |     return ageMinutes <= MAX_AGE_MIN;
 66 |   });
 67 | }
 68 | 
 69 | /* ============================================================
 70 |    BUILD EVENT PAYLOAD (1 komentarz = 1 obiekt)
 71 |    ============================================================ */
 72 | 
 73 | function buildEventPayload(post, c) {
 74 |   // meta posta (panel/sheets/env fallback)
 75 |   const postName =
 76 |     (post?.name && String(post.name).trim()) ||
 77 |     POST_LABELS[post?.id] ||
 78 |     post?.id ||
 79 |     "post";
 80 | 
 81 |   const postImage = (post?.image && String(post.image).trim()) || null;
 82 |   const postDescription = (post?.description && String(post.description).trim()) || null;
 83 | 
 84 |   const rel = (c?.fb_time_raw || c?.time || "").trim() || null;
 85 |   const createdAt = c?.fb_time_iso || null;
 86 | 
 87 |   return {
 88 |     event: "new_comment",
 89 | 
 90 |     post: {
 91 |       id: post?.id || null,
 92 |       name: postName,
 93 |       description: postDescription,
 94 |       image: postImage,
 95 |       url: post?.url || null,
 96 |     },
 97 | 
 98 |     comment: {
 99 |       id: c?.id || null,
100 |       author: c?.author || c?.name || null,
101 |       text: c?.text || c?.message || null,
102 |       created_at: createdAt,
103 |       relative_time: rel,
104 |     },
105 | 
106 |     meta: {
107 |       source: "facebook",
108 |       detected_at: new Date().toISOString(),
109 |     },
110 |   };
111 | }
112 | 
113 | /* ============================================================
114 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
115 |    ============================================================ */
116 | 
117 | async function sendWebhook(post, newComments, newCount, oldCount) {
118 |   const url = process.env.WEBHOOK_URL;
119 |   if (!url) {
120 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
121 |     return;
122 |   }
123 | 
124 |   const list = Array.isArray(newComments) ? newComments : [];
125 |   if (list.length === 0) return;
126 | 
127 |   /* --------------------------------------------
128 |        1) Normalizacja czasu i dodanie p√≥l ISO
129 |      -------------------------------------------- */
130 | 
131 |   const normalized = list.map((c) => {
132 |     const rel = (c?.time || "").trim();
133 |     const iso = parseFbRelativeTime(rel);
134 |     return {
135 |       ...c,
136 |       fb_time_raw: rel || null,
137 |       fb_time_iso: iso ? iso.toISOString() : null,
138 |     };
139 |   });
140 | 
141 |   /* --------------------------------------------
142 |        2) Filtrowanie komentarzy po wieku
143 |      -------------------------------------------- */
144 | 
145 |   const freshOnly = filterByAge(normalized);
146 | 
147 |   console.log("[Webhook] Filtr wieku komentarzy:", {
148 |     before: normalized.length,
149 |     after: freshOnly.length,
150 |     maxAgeMin: MAX_AGE_MIN,
151 |   });
152 | 
153 |   if (freshOnly.length === 0) {
154 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
155 |     return;
156 |   }
157 | 
158 |   /* --------------------------------------------
159 |        3) Wysy≈Çka: 1 komentarz = 1 event
160 |      -------------------------------------------- */
161 | 
162 |   for (const c of freshOnly) {
163 |     const payload = buildEventPayload(post, c);
164 | 
165 |     // pomocniczo: zachowujemy te≈º liczniki w logach (nie w payload)
166 |     console.log("[Webhook] Send event:", {
167 |       postId: payload.post.id,
168 |       commentId: payload.comment.id,
169 |       author: payload.comment.author,
170 |       counts: { newCount, oldCount },
171 |     });
172 | 
173 |     try {
174 |       await axios.post(url, payload, { timeout: 10000 });
175 |       console.log("[Webhook] Wys≈Çano event new_comment.");
176 |     } catch (err) {
177 |       console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err?.message || err);
178 |     }
179 |   }
180 | }
181 | 
182 | export { sendWebhook, parseFbRelativeTime, filterByAge };
183 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/06__comments.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/comments.js
  2 | import { EXPAND_COMMENTS } from "../config.js";
  3 | import { sleepRandom } from "../utils/sleep.js";
  4 | import { scrollPost } from "./scroll.js";
  5 | import { acceptCookies, saveCookies } from "./cookies.js";
  6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
  7 | import { clickOneExpandButton } from "./expandButtons.js";
  8 | import { safeGoto } from "../utils/navigation.js";
  9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
 10 | 
 11 | import * as uiPhoto from "./ui/photo.js";
 12 | import * as uiPost from "./ui/post.js";
 13 | import * as uiVideos from "./ui/videos.js";
 14 | import * as uiWatch from "./ui/watch.js";
 15 | 
 16 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 17 |   ? Number(process.env.NAV_TIMEOUT_MS)
 18 |   : 90000;
 19 | 
 20 | /* ============================================================
 21 |    ===================== UI ROUTER ============================
 22 |    ============================================================ */
 23 | 
 24 | function pickUiHandler(url) {
 25 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
 26 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
 27 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
 28 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
 29 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
 30 |   return null;
 31 | }
 32 | 
 33 | 
 34 | /* ============================================================
 35 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
 36 |    ============================================================ */
 37 | 
 38 | async function openCommentsMenu(page) {
 39 |   const r = await page.evaluate(() => {
 40 |     const norm = (s) =>
 41 |       String(s || "")
 42 |         .replace(/\u00a0/g, " ")
 43 |         .replace(/\s+/g, " ")
 44 |         .trim()
 45 |         .toLowerCase();
 46 | 
 47 |     function getLabel(el) {
 48 |       return el.getAttribute?.("aria-label") || el.textContent || "";
 49 |     }
 50 | 
 51 |     if (document.querySelector("div[role='menu']"))
 52 |       return { ok: true, state: "menu-already-open" };
 53 | 
 54 |     const els = Array.from(
 55 |       document.querySelectorAll(
 56 |         "button,div[role='button'],span[role='button'],a[role='button']"
 57 |       )
 58 |     );
 59 | 
 60 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
 61 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
 62 |     const btn = els.find((el) => {
 63 |       const t = norm(getLabel(el));
 64 |       return (
 65 |         t === "najtrafniejsze" ||
 66 |         t === "most relevant" ||
 67 |         t === "wszystkie komentarze" ||
 68 |         t === "all comments" ||
 69 |         t === "najnowsze" ||
 70 |         t === "newest" ||
 71 |         t === "poka≈º wszystkie" ||
 72 |         t === "show all" ||
 73 |         t === "wy≈õwietl wszystkie" ||
 74 |         t === "view all"
 75 |       );
 76 |     });
 77 | 
 78 |     if (!btn) return { ok: false, reason: "no-trigger" };
 79 | 
 80 |     try {
 81 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
 82 |     } catch {}
 83 | 
 84 |     try {
 85 |       btn.click();
 86 |       return { ok: true, state: "clicked-trigger" };
 87 |     } catch {
 88 |       return { ok: false, reason: "click-failed" };
 89 |     }
 90 |   });
 91 | 
 92 |   return r?.ok === true;
 93 | }
 94 | 
 95 | async function clickMenuOptionByPrefix(page, prefixes) {
 96 |   return page.evaluate(
 97 |     (prefixes) => {
 98 |       const norm = (s) =>
 99 |         String(s || "")
100 |           .replace(/\u00a0/g, " ")
101 |           .replace(/\s+/g, " ")
102 |           .trim()
103 |           .toLowerCase();
104 | 
105 |       const menu =
106 |         document.querySelector("div[role='menu']") ||
107 |         document.querySelector("div[role='dialog']");
108 |       if (!menu) return { ok: false, reason: "no-menu" };
109 | 
110 |       const items = Array.from(
111 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
112 |       );
113 | 
114 |       const opt = items.find((el) => {
115 |         const t = norm(el.textContent);
116 |         return prefixes.some((p) => t.startsWith(p));
117 |       });
118 | 
119 |       if (!opt) return { ok: false, reason: "no-opt" };
120 | 
121 |       try {
122 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
123 |       } catch {}
124 | 
125 |       try {
126 |         opt.click();
127 |         return { ok: true };
128 |       } catch {
129 |         return { ok: false, reason: "click-failed" };
130 |       }
131 |     },
132 |     prefixes
133 |   );
134 | }
135 | 
136 | async function switchCommentsFilterToAllLegacy(page) {
137 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy na: 'Wszystkie komentarze'‚Ä¶");
138 | 
139 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
140 |     const opened = await openCommentsMenu(page);
141 |     if (opened) await sleepRandom(250, 450);
142 |   }
143 | 
144 |   const picked = await clickMenuOptionByPrefix(page, [
145 |     "wszystkie komentarze",
146 |     "all comments",
147 |     "poka≈º wszystkie",
148 |     "show all",
149 |     "wy≈õwietl wszystkie",
150 |     "view all",
151 |   ]);
152 | 
153 |   if (picked?.ok) {
154 |     await sleepRandom(250, 450);
155 |     await page
156 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
157 |         timeout: 2500,
158 |       })
159 |       .catch(() => {});
160 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
161 |     return true;
162 |   }
163 | 
164 |   console.log("[FB][filter] Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze' (best-effort).");
165 |   return false;
166 | }
167 | 
168 | /* ============================================================
169 |    ===================  EXPAND (LEGACY)  =======================
170 |    ============================================================ */
171 | 
172 | export async function expandAllComments(page) {
173 |   if (!EXPAND_COMMENTS) return 0;
174 | 
175 |   let clicks = 0;
176 |   for (let i = 0; i < 30; i++) {
177 |     const didClick = await clickOneExpandButton(page);
178 |     if (!didClick) break;
179 |     clicks++;
180 |     await sleepRandom(450, 900);
181 |   }
182 |   return clicks;
183 | }
184 | 
185 | /* ============================================================
186 |    ===================  LICZNIK KOMENTARZY  ====================
187 |    ============================================================ */
188 | 
189 | async function getCommentCountLegacy(page) {
190 |   const ui = await getUiCommentInfo(page).catch(() => null);
191 | 
192 |   const uiCandidates = [
193 |     ui?.comments,
194 |     ui?.count,
195 |     ui?.commentCount,
196 |     ui?.commentsCount,
197 |     ui?.totalComments,
198 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
199 | 
200 |   if (uiCandidates.length) {
201 |     const best = Math.max(...uiCandidates);
202 |     console.log("[FB][count] UI:", {
203 |       best,
204 |       candidates: uiCandidates,
205 |       source: ui?.source || "ui",
206 |       raw: ui?.raw || null,
207 |       viewType: ui?.viewType || null,
208 |     });
209 |     return best;
210 |   }
211 | 
212 |   const uiLoose = await page
213 |     .evaluate(() => {
214 |       const texts = [];
215 |       const pushText = (t) => {
216 |         if (!t) return;
217 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
218 |         if (s) texts.push(s);
219 |       };
220 | 
221 |       const els = Array.from(
222 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
223 |       );
224 |       for (const el of els) {
225 |         pushText(el.getAttribute?.("aria-label"));
226 |         pushText(el.textContent);
227 |       }
228 | 
229 |       const nums = [];
230 |       for (const t of texts) {
231 |         const low = t.toLowerCase();
232 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
233 |         if (m) nums.push(Number(m[1]));
234 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
235 |         if (m) nums.push(Number(m[1]));
236 |       }
237 | 
238 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
239 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
240 |     })
241 |     .catch(() => ({ count: null, sample: [] }));
242 | 
243 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
244 |     console.log("[FB][count] UI-loose:", uiLoose.count);
245 |     return uiLoose.count;
246 |   }
247 | 
248 |   if (ui) {
249 |     console.log("[FB][count] UI object (no number):", { keys: Object.keys(ui), ui });
250 |   } else {
251 |     console.log("[FB][count] UI object: null (getUiCommentInfo failed or returned null)");
252 |   }
253 | 
254 |   const anchors = await page.evaluate(() => {
255 |     const as = Array.from(
256 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
257 |     );
258 |     const ids = new Set();
259 |     for (const a of as) {
260 |       try {
261 |         const u = new URL(a.href);
262 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
263 |         if (raw) ids.add(raw);
264 |       } catch {}
265 |     }
266 |     return ids.size;
267 |   });
268 | 
269 |   if (anchors > 0) console.log("[FB][count] anchors-fallback:", anchors);
270 |   return anchors > 0 ? anchors : null;
271 | }
272 | 
273 | /* ============================================================
274 |    ===================  EKSTRAKCJA KOMENTARZY  =================
275 |    ============================================================ */
276 | 
277 | async function extractCommentsFromDOM(page) {
278 |   const data = await page.evaluate(() => {
279 |     function extractCommentIdRaw(url) {
280 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
281 |       return m ? decodeURIComponent(m[1]) : null;
282 |     }
283 | 
284 |     function safeAtob(input) {
285 |       try {
286 |         let s = String(input || "");
287 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
288 |         while (s.length % 4) s += "=";
289 |         return atob(s);
290 |       } catch {
291 |         return null;
292 |       }
293 |     }
294 | 
295 |     function idNumFromRaw(idRaw) {
296 |       if (!idRaw) return null;
297 |       const s = String(idRaw).trim();
298 |       if (/^\d+$/.test(s)) return s;
299 | 
300 |       const dec = safeAtob(s);
301 |       if (dec) {
302 |         const m = String(dec).match(/(\d{6,})\s*$/);
303 |         if (m) return m[1];
304 |       }
305 |       const m2 = s.match(/_(\d+)\b/);
306 |       return m2 ? m2[1] : null;
307 |     }
308 | 
309 |     function normalizeTime(text) {
310 |       if (!text) return null;
311 | 
312 |       const t = String(text)
313 |         .toLowerCase()
314 |         .replace(/\u00a0/g, " ")
315 |         .replace(/\s+/g, " ")
316 |         .trim();
317 | 
318 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
319 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
320 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
321 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
322 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
323 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
324 | 
325 |       return null;
326 |     }
327 | 
328 |     function findTimeAround(linkEl, fallbackNode) {
329 |       const root =
330 |         linkEl?.closest?.("div[role='article']") ||
331 |         linkEl?.closest?.("div[aria-label]") ||
332 |         linkEl?.closest?.("div") ||
333 |         fallbackNode;
334 | 
335 |       if (!root) return null;
336 | 
337 |       const els = root.querySelectorAll("a, abbr, span");
338 |       for (const el of els) {
339 |         const aria = el.getAttribute?.("aria-label");
340 |         const t1 = normalizeTime(aria);
341 |         if (t1) return t1;
342 | 
343 |         const txt = el.textContent?.trim();
344 |         const t2 = normalizeTime(txt);
345 |         if (t2) return t2;
346 |       }
347 |       return null;
348 |     }
349 | 
350 |     const nodes = Array.from(
351 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
352 |     );
353 | 
354 |     const extracted = nodes
355 |         .map((node, idx) => {
356 |           const author = node.querySelector("a[role=\"link\"] span span")?.textContent?.trim() || null;
357 |           const text = node.querySelector("div[dir=\"auto\"]")?.textContent?.trim() || null;
358 | 
359 |           const linkEl = node.querySelector("a[href*=\"reply_comment_id\"]") ||
360 |                          node.querySelector("a[href*=\"comment_id\"]") ||
361 |                          node.querySelector("a[role=\"link\"]");
362 | 
363 |           const href = linkEl?.getAttribute("href") || null;
364 |           const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com`) : null;
365 | 
366 |           const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
367 |           const id = id_raw ? String(id_raw).trim() : null;
368 |           const id_num = id_raw ? idNumFromRaw(id_raw) : null;
369 |           const time = findTimeAround(linkEl, node);
370 | 
371 |           if (!author || !text || !id) return null;
372 | 
373 |           return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
374 |         })
375 |         .filter(Boolean);
376 | 
377 |     return extracted;
378 |   });
379 | 
380 |   return Array.isArray(data) ? data : [];
381 | }
382 | 
383 | /* ============================================================
384 |    ===================  PREPARE / LOAD (LEGACY)  ===============
385 |    ============================================================ */
386 | 
387 | async function prepareLegacy(page, url) {
388 |   const ok = await safeGoto(page, url, "comments", {
389 |     waitUntil: "networkidle2",
390 |     timeout: NAV_TIMEOUT_MS,
391 |   });
392 | 
393 |   if (!ok) throw new Error("safeGoto-failed");
394 | 
395 |   const currentUrl = page.url();
396 |   if (currentUrl.includes("/login")) {
397 |     console.log("[FB] /login redirect ‚Üí fbLogin() and back");
398 |     await fbLogin(page);
399 |     await sleepRandom(3000, 4500);
400 | 
401 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
402 |     console.log("[FB] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
403 | 
404 |     if (loggedAfterLogin) {
405 |       await safeGoto(page, url, "comments", {
406 |         waitUntil: "networkidle2",
407 |         timeout: NAV_TIMEOUT_MS,
408 |       });
409 |     }
410 |   }
411 | 
412 |   await acceptCookies(page, "post-initial");
413 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
414 |   await sleepRandom(900, 1400);
415 |   await acceptCookies(page, "post");
416 | 
417 |   try {
418 |     const logged = await checkIfLogged(page).catch(() => false);
419 |     if (logged) await saveCookies(page);
420 |   } catch {}
421 | 
422 |   await scrollPost(page, 140).catch(() => {});
423 |   await sleepRandom(500, 800);
424 | 
425 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
426 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
427 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
428 |   await sleepRandom(250, 450);
429 | }
430 | 
431 | async function loadAllCommentsLegacy(page, opts = {}) {
432 |   if (!EXPAND_COMMENTS) return;
433 | 
434 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
435 | 
436 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
437 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
438 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
439 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
440 | 
441 |   console.log("[FB][load] start", { expected });
442 | 
443 |   function uniqAnchorCountEval() {
444 |     return page.evaluate(() => {
445 |       const as = Array.from(
446 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
447 |       );
448 |       const ids = new Set();
449 |       for (const a of as) {
450 |         const href = a.getAttribute("href") || "";
451 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
452 |         if (m && m[1]) ids.add(m[1]);
453 |       }
454 |       return ids.size;
455 |     });
456 |   }
457 | 
458 |   function commentNodesCountEval() {
459 |     return page.evaluate(() => {
460 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
461 |       return nodes ? nodes.length : 0;
462 |     });
463 |   }
464 | 
465 |   function hasMoreButtonsEval() {
466 |     return page.evaluate(() => {
467 |       const norm = (s) =>
468 |         String(s || "")
469 |           .replace(/\u00a0/g, " ")
470 |           .replace(/\s+/g, " ")
471 |           .trim()
472 |           .toLowerCase();
473 | 
474 |       const btns = Array.from(
475 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
476 |       );
477 |       return btns.some((b) => {
478 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
479 |         return (
480 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
481 |           t.includes("zobacz wiƒôcej komentarzy") ||
482 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
483 |           t.includes("more comments") ||
484 |           t.includes("view more comments") ||
485 |           t.includes("view previous comments") ||
486 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
487 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
488 |           t.includes("more replies") ||
489 |           t.includes("view more replies")
490 |         );
491 |       });
492 |     });
493 |   }
494 | 
495 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
496 |   let nodes = await commentNodesCountEval().catch(() => 0);
497 | 
498 |   let stable = 0;
499 |   let noProgress = 0;
500 | 
501 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
502 |     let clicks = 0;
503 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
504 |       const did = await clickOneExpandButton(page).catch(() => false);
505 |       if (!did) break;
506 |       clicks++;
507 |       await sleepRandom(250, 450);
508 |     }
509 | 
510 |     await scrollPost(page, 220).catch(() => {});
511 |     await sleepRandom(400, 700);
512 | 
513 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
514 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
515 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
516 | 
517 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
518 | 
519 |     if (progressed) {
520 |       anchors = nextAnchors;
521 |       nodes = nextNodes;
522 |       stable = 0;
523 |       noProgress = 0;
524 |     } else {
525 |       stable++;
526 |       noProgress++;
527 |     }
528 | 
529 |     console.log(
530 |       `[FB][load] round ${round}: anchors ${anchors} -> ${nextAnchors}, nodes ${nodes} -> ${nextNodes}, clicks=${clicks}, stable=${stable}/${STABLE_ROUNDS}, moreBtns=${moreBtns}, noProgress=${noProgress}/${MAX_NO_PROGRESS}`
531 |     );
532 | 
533 |     const stableEnough = stable >= STABLE_ROUNDS;
534 | 
535 |     if (!moreBtns && stableEnough) {
536 |       console.log("[FB][load] stop: no more buttons + stable");
537 |       break;
538 |     }
539 | 
540 |     const reachedExpected =
541 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
542 |     if (reachedExpected && stableEnough && !moreBtns) {
543 |       console.log("[FB][load] stop: expected reached (by nodes) + stable + no more buttons");
544 |       break;
545 |     }
546 | 
547 |     if (stableEnough && moreBtns) {
548 |       console.log("[FB][load] rescue: stable but still buttons -> deep scroll + wait");
549 |       await scrollPost(page, 520).catch(() => {});
550 |       await sleepRandom(1000, 1600);
551 |       stable = 0;
552 |       continue;
553 |     }
554 | 
555 |     if (noProgress >= MAX_NO_PROGRESS) {
556 |       if (moreBtns) {
557 |         console.log("[FB][load] last-rescue: no-progress but still buttons -> deep scroll + wait");
558 |         await scrollPost(page, 650).catch(() => {});
559 |         await sleepRandom(1400, 1900);
560 |         stable = 0;
561 |         noProgress = 0;
562 |         continue;
563 |       }
564 | 
565 |       console.log("[FB][load] stop: too many no-progress rounds");
566 |       break;
567 |     }
568 | 
569 |     anchors = nextAnchors;
570 |     nodes = nextNodes;
571 |   }
572 | 
573 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
574 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
575 |   console.log("[FB][load] done:", { anchors: finalAnchors, nodes: finalNodes });
576 | }
577 | 
578 | /* ============================================================
579 |    ===================  PUBLIC API (ROUTED)  ===================
580 |    ============================================================ */
581 | 
582 | export async function prepare(page, url) {
583 |   const ui = pickUiHandler(url);
584 |   if (ui?.prepare) {
585 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} prepare`);
586 |     return ui.prepare(page, url);
587 |   }
588 |   console.log("[FB][router] UI -> legacy prepare");
589 |   return prepareLegacy(page, url);
590 | }
591 | 
592 | export async function getCommentCount(page, url) {
593 |   const ui = pickUiHandler(url || page.url());
594 |   if (ui?.getCommentCount) {
595 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} getCommentCount`);
596 |     return ui.getCommentCount(page, url);
597 |   }
598 |   console.log("[FB][router] UI -> legacy getCommentCount");
599 |   return getCommentCountLegacy(page);
600 | }
601 | 
602 | export async function loadAllComments(page, opts = {}, url = null) {
603 |   if (!EXPAND_COMMENTS) return;
604 | 
605 |   const finalUrl = url || page.url();
606 |   const ui = pickUiHandler(finalUrl);
607 | 
608 |   if (ui?.loadAllComments) {
609 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} loadAllComments`);
610 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal });
611 |   }
612 | 
613 |   console.log("[FB][router] UI -> legacy loadAllComments");
614 |   return loadAllCommentsLegacy(page, opts);
615 | }
616 | 
617 | export async function extractCommentsData(page, url = null) {
618 |   const finalUrl = url || page.url();
619 |   const ui = pickUiHandler(finalUrl);
620 | 
621 |   const getPostRef = (u) => {
622 |     if (!u) return null;
623 |     try {
624 |       const x = new URL(u);
625 | 
626 |       // permalink.php?story_fbid=...
627 |       const story = x.searchParams.get("story_fbid");
628 |       if (story) return `story_fbid:${story}`;
629 | 
630 |       // /.../posts/<id>  |  /.../videos/<id>  |  /.../photos/<id>
631 |       const parts = x.pathname.split("/").filter(Boolean);
632 |       for (let i = 0; i < parts.length - 1; i++) {
633 |         const k = parts[i];
634 |         if (k === "posts" || k === "videos" || k === "photos" || k === "reels") {
635 |           const v = parts[i + 1];
636 |           if (v) return `${k}:${v}`;
637 |         }
638 |       }
639 | 
640 |       // fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)
641 |         return null;
642 |     } catch (e) {
643 |       return null;
644 |     }
645 |   };
646 | 
647 |   const postRef = getPostRef(finalUrl);
648 | 
649 |   const filterByRef = (arr) => {
650 |     if (!Array.isArray(arr)) return [];
651 |     if (!postRef) return arr;
652 | 
653 |     let dropped = 0;
654 |       const out = [];
655 |       let sampleLogged = 0;
656 | 
657 |       // kontekst: do czego porownujemy
658 |       console.log(`[DEDUP][CTX] want= finalUrl=`);
659 | 
660 |       for (const c of arr) {
661 |         const permalink = (c && typeof c === "object") ? (c.permalink || null) : null;
662 |         const cref = permalink ? getPostRef(permalink) : null;
663 | 
664 |         // pokaz 3 pierwsze permalink->cref
665 |         if (sampleLogged < 3 && permalink) {
666 |           console.log(`[DEDUP][SAMPLE] permalink= cref=`);
667 |           sampleLogged += 1;
668 |         }
669 | 
670 |         if (cref && cref !== postRef) {
671 |           dropped += 1;
672 |           continue;
673 |         }
674 |         if (c && typeof c === "object") c.postRef = postRef;
675 |         out.push(c);
676 |       }
677 | 
678 |       if (dropped > 0) {
679 |         console.log(`[DEDUP] dropped= (ref mismatch) postRef=`);
680 |       }
681 | 
682 |       if (arr.length > 0 && out.length === 0 && dropped === arr.length) {
683 |         out._dedupAllDropped = true;
684 |         console.log(`[DEDUP][ALL_DROPPED] all= want=`);
685 |       }
686 | 
687 |       return out;
688 |   };
689 | 
690 |   if (ui?.extractComments) {
691 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} extractComments`);
692 |     const out = await ui.extractComments(page, finalUrl);
693 |     return filterByRef(out);
694 |   }
695 | 
696 |   const out = await extractCommentsFromDOM(page);
697 |   return filterByRef(out);
698 | }
699 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/07__scroll.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | /**
 2 |  * Scrollowanie posta:
 3 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
 4 |  * - je≈õli siƒô nie uda ‚Üí dialog ‚Üí dokument
 5 |  */
 6 | async function scrollPost(page, amount = 450) {
 7 |   await page.evaluate((dy) => {
 8 |     function findScrollableAncestor(start) {
 9 |       let el = start;
10 |       while (el) {
11 |         const style = window.getComputedStyle(el);
12 |         const canScrollY =
13 |           style.overflowY === "auto" || style.overflowY === "scroll";
14 |         if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
15 |           return el;
16 |         }
17 |         el = el.parentElement;
18 |       }
19 |       return null;
20 |     }
21 | 
22 |     // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
23 |     const centerEl = document.elementFromPoint(
24 |       window.innerWidth / 2,
25 |       window.innerHeight / 2
26 |     );
27 | 
28 |     let target = centerEl ? findScrollableAncestor(centerEl) : null;
29 | 
30 |     // fallback: dialog
31 |     if (!target) {
32 |       const dialog = document.querySelector("div[role='dialog']");
33 |       if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
34 |         target = dialog;
35 |       }
36 |     }
37 | 
38 |     // ostateczny fallback: dokument
39 |     if (!target) {
40 |       target =
41 |         document.scrollingElement || document.documentElement || document.body;
42 |     }
43 | 
44 |     if (
45 |       target === document.body ||
46 |       target === document.documentElement ||
47 |       target === document.scrollingElement
48 |     ) {
49 |       const before = window.scrollY;
50 |       window.scrollTo(0, before + dy);
51 |     } else {
52 |       target.scrollTop += dy;
53 |     }
54 |   }, amount);
55 | }
56 | 
57 | export { scrollPost };
58 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/08__login.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/login.js
  2 | import { sleepRandom } from "../utils/sleep.js";
  3 | 
  4 | /**
  5 |  * FB login helpers ‚Äì PRO (NO COOLDOWN)
  6 |  *
  7 |  * Najwa≈ºniejsze:
  8 |  * - G≈Ç√≥wne logowanie: https://www.facebook.com/login.php?next=<postUrl>
  9 |  * - Best-effort (zero throw, zero crashy)
 10 |  * - Dwa tryby:
 11 |  *    1) login.php?next (najstabilniejsze)
 12 |  *    2) fallback: loginViaVisibleForm (overlay / r√≥≈ºne layouty)
 13 |  *
 14 |  * Kompatybilno≈õƒá:
 15 |  * - eksportujemy te≈º clickByText, acceptLoginCookies, loginViaVisibleForm (jak w wersji lokalnej)
 16 |  */
 17 | 
 18 | function norm(s) {
 19 |   return String(s || "")
 20 |     .replace(/\u00a0/g, " ")
 21 |     .replace(/\s+/g, " ")
 22 |     .trim();
 23 | }
 24 | 
 25 | /**
 26 |  * Cookies popup ‚Äì wersja "mark + click" (jak lokalnie), ale best-effort.
 27 |  */
 28 | async function acceptLoginCookies(page) {
 29 |   try {
 30 |     console.log("[FB][login-cookies] Szukam popupu cookies...");
 31 | 
 32 |     await sleepRandom(300, 900);
 33 | 
 34 |     const found = await page.evaluate(() => {
 35 |       const wanted = [
 36 |         "Zezw√≥l na wszystkie pliki cookie",
 37 |         "Zezw√≥l na wszystkie pliki",
 38 |         "Allow all cookies",
 39 |         "Accept all cookies",
 40 |         "Akceptuj wszystkie",
 41 |         "Odrzuƒá opcjonalne pliki cookie",
 42 |         "Odrzuc opcjonalne pliki cookie",
 43 |       ].map((t) => t.toLowerCase());
 44 | 
 45 |       const buttons = Array.from(
 46 |         document.querySelectorAll("button, [role='button']")
 47 |       );
 48 | 
 49 |       for (const btn of buttons) {
 50 |         const txt = (btn.innerText || btn.textContent || "").trim();
 51 |         if (!txt) continue;
 52 |         const low = txt.toLowerCase();
 53 | 
 54 |         if (wanted.some((w) => low.includes(w))) {
 55 |           btn.setAttribute("data-fb-cookie-btn", "1");
 56 |           return true;
 57 |         }
 58 |       }
 59 | 
 60 |       return false;
 61 |     });
 62 | 
 63 |     if (!found) {
 64 |       return false;
 65 |     }
 66 | 
 67 |     await page
 68 |       .click('[data-fb-cookie-btn="1"]')
 69 |       .catch(() => {});
 70 | 
 71 |     console.log(
 72 |       '[FB][login-cookies] Klikniƒôto cookies (data-fb-cookie-btn="1").'
 73 |     );
 74 | 
 75 |     await sleepRandom(600, 1200);
 76 |     return true;
 77 |   } catch (err) {
 78 |     console.log("[FB][login-cookies] B≈ÇƒÖd (ignorowany):", err?.message || err);
 79 |     return false;
 80 |   }
 81 | }
 82 | 
 83 | /**
 84 |  * Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).
 85 |  */
 86 | async function acceptCookiesIfPresent(page) {
 87 |   try {
 88 |     await sleepRandom(250, 650);
 89 | 
 90 |     const clicked = await page.evaluate(() => {
 91 |       const wanted = [
 92 |         "Zezw√≤l na wszystkie pliki cookie",
 93 |         "Zezw√≥l na wszystkie pliki cookie",
 94 |         "Zezw√≤l na wszystkie pliki",
 95 |         "Zezw√≥l na wszystkie pliki",
 96 |         "Allow all cookies",
 97 |         "Accept all cookies",
 98 |         "Akceptuj wszystkie",
 99 |       ].map((x) => x.toLowerCase());
100 | 
101 |       const btns = Array.from(
102 |         document.querySelectorAll("button, [role='button']")
103 |       );
104 | 
105 |       for (const b of btns) {
106 |         const t = (b.innerText || b.textContent || "").trim();
107 |         if (!t) continue;
108 |         const low = t.toLowerCase();
109 |         if (wanted.some((w) => low.includes(w))) {
110 |           b.click();
111 |           return true;
112 |         }
113 |       }
114 |       return false;
115 |     });
116 | 
117 |     if (clicked) {
118 |       console.log("[FB][cookies] Klikniƒôto accept cookies (fallback).");
119 |       await sleepRandom(500, 1100);
120 |     }
121 |     return !!clicked;
122 |   } catch {
123 |     return false;
124 |   }
125 | }
126 | 
127 | /**
128 |  * Pomocnik: wpisz login/has≈Ço + kliknij login. Best-effort.
129 |  */
130 | async function fillLoginFormBestEffort(page) {
131 |   const email = process.env.FB_EMAIL || "";
132 |   const password = process.env.FB_PASSWORD || "";
133 | 
134 |   if (!email || !password) {
135 |     console.log("[FB][login] Brak FB_EMAIL / FB_PASSWORD ‚Äì pomijam login.");
136 |     return false;
137 |   }
138 | 
139 |   const emailSel = [
140 |     "input#email",
141 |     "input[name='email']",
142 |     "input[name='email_or_phone']",
143 |     "input[type='text']",
144 |   ].join(",");
145 | 
146 |   const passSel = [
147 |     "input#pass",
148 |     "input[name='pass']",
149 |     "input[type='password']",
150 |   ].join(",");
151 | 
152 |   const emailInput = await page.$(emailSel).catch(() => null);
153 |   const passInput = await page.$(passSel).catch(() => null);
154 | 
155 |   if (!emailInput || !passInput) {
156 |     console.log("[FB][login] Brak p√≥l email/has≈Ço na stronie login.");
157 |     return false;
158 |   }
159 | 
160 |   console.log("[FB][login] Wpisujƒô email i has≈Ço...");
161 | 
162 |   await emailInput.click({ clickCount: 3 }).catch(() => {});
163 |   await page.keyboard.press("Backspace").catch(() => {});
164 |   await emailInput.type(email, { delay: 35 }).catch(() => {});
165 | 
166 |   await passInput.click({ clickCount: 3 }).catch(() => {});
167 |   await page.keyboard.press("Backspace").catch(() => {});
168 |   await passInput.type(password, { delay: 35 }).catch(() => {});
169 | 
170 |   const loginButton =
171 |     (await page.$('button[name="login"]')) ||
172 |     (await page.$('button[type="submit"]')) ||
173 |     (await page.$('div[role="button"][tabindex="0"]')) ||
174 |     (await page.$("button")) ||
175 |     null;
176 | 
177 |   if (!loginButton) {
178 |     console.log("[FB][login] Brak przycisku logowania ‚Äì ko≈Ñczƒô pr√≥bƒô.");
179 |     return false;
180 |   }
181 | 
182 |   console.log("[FB][login] Klikam logowanie‚Ä¶");
183 | 
184 |   await Promise.all([
185 |     loginButton.click().catch(() => {}),
186 |     page
187 |       .waitForNavigation({ waitUntil: "networkidle2", timeout: 60000 })
188 |       .catch(() => {}),
189 |   ]);
190 | 
191 |   await sleepRandom(1400, 2400);
192 |   return true;
193 | }
194 | 
195 | /**
196 |  * Pr√≥ba logowania na dowolnym widocznym formularzu (z lokalnej wersji),
197 |  * ale z lekkimi ulepszeniami i bez crashy.
198 |  */
199 | async function loginViaVisibleForm(page, context = "visible-form") {
200 |   try {
201 |     console.log(`[FB][login-form] Szukam formularza logowania (${context})...`);
202 | 
203 |     await acceptLoginCookies(page).catch(() => {});
204 |     await acceptCookiesIfPresent(page).catch(() => {});
205 | 
206 |     const emailSelector = [
207 |       "input#email",
208 |       "input[name='email']",
209 |       "input[name='email_or_phone']",
210 |       "input[aria-label*='Adres e-mail']",
211 |       "input[placeholder*='Adres e-mail']",
212 |       "input[placeholder*='adres e-mail']",
213 |       "input[placeholder*='Email']",
214 |       "input[placeholder*='email']",
215 |       "input[type='text']",
216 |     ].join(",");
217 | 
218 |     const passSelector = [
219 |       "input#pass",
220 |       "input[name='pass']",
221 |       "input[aria-label*='Has≈Ço']",
222 |       "input[placeholder*='Has≈Ço']",
223 |       "input[placeholder*='has≈Ço']",
224 |       "input[placeholder*='Password']",
225 |       "input[placeholder*='password']",
226 |       "input[type='password']",
227 |     ].join(",");
228 | 
229 |     const emailInput = await page.$(emailSelector).catch(() => null);
230 |     const passInput = await page.$(passSelector).catch(() => null);
231 | 
232 |     if (!emailInput || !passInput) {
233 |       console.log(
234 |         "[FB][login-form] Brak pe≈Çnego formularza (email + has≈Ço) na stronie."
235 |       );
236 |       return false;
237 |     }
238 | 
239 |     const ok = await fillLoginFormBestEffort(page);
240 |     if (!ok) return false;
241 | 
242 |     console.log("[FB][login-form] Formularz logowania wys≈Çany.");
243 |     return true;
244 |   } catch (err) {
245 |     console.error("[FB][login-form] B≈ÇƒÖd (ignorowany):", err?.message || err);
246 |     return false;
247 |   }
248 | }
249 | 
250 | /**
251 |  * G≈Ç√≥wne logowanie ‚Äì NAJSTABILNIEJSZE: login.php?next=<URL>
252 |  * Param nextUrl: URL posta, do kt√≥rego FB ma wr√≥ciƒá po loginie.
253 |  */
254 | async function fbLogin(page, nextUrl = "") {
255 |   try {
256 |     console.log("[FB][login] Start logowania (best-effort)");
257 | 
258 |     const next = nextUrl ? `?next=${encodeURIComponent(nextUrl)}` : "";
259 |     const url = `https://www.facebook.com/login.php${next}`;
260 | 
261 |     await page
262 |       .goto(url, { waitUntil: "networkidle2", timeout: 60000 })
263 |       .catch(() => {});
264 | 
265 |     await sleepRandom(900, 1400);
266 | 
267 |     // cookies ‚Äì dwie metody (mark+click oraz szybki fallback)
268 |     await acceptLoginCookies(page).catch(() => {});
269 |     await acceptCookiesIfPresent(page).catch(() => {});
270 | 
271 |     const ok = await fillLoginFormBestEffort(page);
272 |     if (!ok) return false;
273 | 
274 |     // FB czasem zostaje na tej samej stronie ‚Äì dodatkowa pauza
275 |     await sleepRandom(1200, 2000);
276 | 
277 |     return true;
278 |   } catch (e) {
279 |     console.log("[FB][login] B≈ÇƒÖd (ignorowany):", e?.message || e);
280 |     return false;
281 |   }
282 | }
283 | 
284 | /**
285 |  * Heurystyczny check sesji (jak serwer).
286 |  */
287 | async function checkIfLogged(page) {
288 |   try {
289 |     return await page.evaluate(() => {
290 |       return !!(
291 |         document.querySelector('input[aria-label*="Szukaj"]') ||
292 |         document.querySelector('input[placeholder*="Szukaj"]') ||
293 |         document.querySelector('a[aria-label*="Profil"]') ||
294 |         document.querySelector('div[aria-label*="Konto"]')
295 |       );
296 |     });
297 |   } catch {
298 |     return false;
299 |   }
300 | }
301 | 
302 | /**
303 |  * Klikniƒôcie elementu po dok≈Çadnym tek≈õcie (lokalny helper).
304 |  */
305 | async function clickByText(page, text) {
306 |   const res = await page.evaluate((label) => {
307 |     const els = Array.from(
308 |       document.querySelectorAll("button, a, div[role='button'], span[role='button']")
309 |     );
310 |     const lowLabel = String(label || "").toLowerCase();
311 |     for (const el of els) {
312 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
313 |       if (!t) continue;
314 |       if (t === lowLabel) {
315 |         el.click();
316 |         return true;
317 |       }
318 |     }
319 |     return false;
320 |   }, text);
321 |   return res;
322 | }
323 | 
324 | /**
325 |  * Heurystyka login-wall (serwerowa).
326 |  * Uwaga: "Log In" czasem jest widoczne mimo, ≈ºe da siƒô czytaƒá komentarze,
327 |  * wiƒôc to powinno odpalaƒá siƒô dopiero gdy UI nie potrafi odczytaƒá danych.
328 |  */
329 | async function looksLikeLoginWall(page) {
330 |   try {
331 |     return await page.evaluate(() => {
332 |       const txt = (document.body?.innerText || "").toLowerCase();
333 |       if (!txt) return false;
334 | 
335 |       const hasLoginWords =
336 |         txt.includes("log in") ||
337 |         txt.includes("sign up") ||
338 |         txt.includes("create new account") ||
339 |         txt.includes("zaloguj") ||
340 |         txt.includes("zarejestruj");
341 | 
342 |       if (!hasLoginWords) return false;
343 | 
344 |       const hasLoginForm =
345 |         !!document.querySelector("input[type='password']") ||
346 |         !!document.querySelector("input#email") ||
347 |         !!document.querySelector("input[name='email']");
348 | 
349 |       const hasPostWords =
350 |         txt.includes("comment") ||
351 |         txt.includes("comments") ||
352 |         txt.includes("komentarz") ||
353 |         txt.includes("lubiƒô to") ||
354 |         txt.includes("like") ||
355 |         txt.includes("reply") ||
356 |         txt.includes("replied");
357 | 
358 |       return hasLoginForm || (hasLoginWords && !hasPostWords);
359 |     });
360 |   } catch {
361 |     return false;
362 |   }
363 | }
364 | 
365 | /**
366 |  * G≈Ç√≥wny ‚Äûw≈ÇƒÖcznik‚Äù do u≈ºycia w UI handlerach:
367 |  * - je≈õli wyglƒÖda na login-wall -> login.php?next -> wr√≥ƒá na post
368 |  * - fallback: pr√≥ba loginViaVisibleForm (gdyby FB zrobi≈Ç overlay)
369 |  *
370 |  * Param postUrl: najlepiej podaƒá URL posta (≈ºeby next= dzia≈Ça≈Ço idealnie)
371 |  */
372 | async function ensureLoggedInOnPostOverlay(page, postUrl = "") {
373 |   try {
374 |     const cur = page.url();
375 |     const target = postUrl || cur;
376 | 
377 |     const wall = await looksLikeLoginWall(page);
378 |     if (!wall) return false;
379 | 
380 |     console.log(
381 |       "[FB][login] Wykryto login-wall -> login.php?next i pr√≥ba logowania."
382 |     );
383 | 
384 |     const tried = await fbLogin(page, target);
385 | 
386 |     let logged = await checkIfLogged(page);
387 |     console.log("[FB][login] session after fbLogin:", logged ? "YES" : "NO");
388 | 
389 |     // je≈õli FB nie przerzuci≈Ç automatycznie, wr√≥ƒá na post
390 |     if (target && norm(page.url()) !== norm(target)) {
391 |       await page
392 |         .goto(target, { waitUntil: "networkidle2", timeout: 60000 })
393 |         .catch(() => {});
394 |       await sleepRandom(900, 1400);
395 |     }
396 | 
397 |     // jeszcze raz sprawd≈∫ sesjƒô po powrocie
398 |     logged = await checkIfLogged(page);
399 | 
400 |     // fallback: gdyby FB nadal siedzia≈Ç na overlayu, spr√≥buj visible-form
401 |     if (!logged) {
402 |       const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
403 |       if (usedInline) {
404 |         logged = await checkIfLogged(page);
405 |         console.log(
406 |           "[FB][login] session after loginViaVisibleForm:",
407 |           logged ? "YES" : "NO"
408 |         );
409 |       }
410 |     }
411 | 
412 |     return tried && logged;
413 |   } catch (e) {
414 |     console.log(
415 |       "[FB][login] ensureLoggedInOnPostOverlay error (ignored):",
416 |       e?.message || e
417 |     );
418 |     return false;
419 |   }
420 | }
421 | 
422 | export {
423 |   fbLogin,
424 |   checkIfLogged,
425 |   ensureLoggedInOnPostOverlay,
426 |   clickByText,
427 |   acceptLoginCookies,
428 |   loginViaVisibleForm,
429 | };
430 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/09__cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/cookies.js
  2 | 
  3 | import fs from "fs/promises";
  4 | import { sleepRandom } from "../utils/sleep.js";
  5 | 
  6 | 
  7 | 
  8 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
  9 | const COOKIES_READ_ONLY =
 10 |   String(process.env.COOKIES_READ_ONLY || "")
 11 |     .trim()
 12 |     .toLowerCase() === "true";
 13 | 
 14 | console.log(
 15 |   "[FB][cookies] COOKIES_READ_ONLY =",
 16 |   COOKIES_READ_ONLY,
 17 |   "(raw:",
 18 |   process.env.COOKIES_READ_ONLY,
 19 |   ")"
 20 | );
 21 | 
 22 | 
 23 | /**
 24 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
 25 |  */
 26 | async function loadCookies(page) {
 27 |   try {
 28 |     const raw = await fs.readFile("cookies.json", "utf8");
 29 |     const cookies = JSON.parse(raw);
 30 | 
 31 |     if (Array.isArray(cookies) && cookies.length) {
 32 |       await page.setCookie(...cookies);
 33 |       console.log("[FB][cookies] Za≈Çadowano zapisane cookies (cookies.json).");
 34 |     } else {
 35 |       console.log(
 36 |         "[FB][cookies] cookies.json istnieje, ale nie zawiera poprawnej tablicy cookies."
 37 |       );
 38 |     }
 39 |   } catch (err) {
 40 |     console.log(
 41 |       "[FB][cookies] Brak zapisanych cookies lub b≈ÇƒÖd odczytu ‚Äì logowanie od zera.",
 42 |       err?.message || err
 43 |     );
 44 |   }
 45 | }
 46 | 
 47 | /**
 48 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
 49 |  * w katalogu roboczym procesu (tam, skƒÖd odpalasz node).
 50 |  */
 51 | async function saveCookies(page) {
 52 |   if (COOKIES_READ_ONLY) {
 53 |     console.log(
 54 |       "[FB][cookies] COOKIES_READ_ONLY=true ‚Äì pomijam zapis cookies.json (tylko odczyt z pliku)."
 55 |     );
 56 |     return;
 57 |   }
 58 | 
 59 |   try {
 60 |     const cookies = await page.cookies();
 61 | 
 62 |     await fs.writeFile(
 63 |       "cookies.json",
 64 |       JSON.stringify(cookies, null, 2),
 65 |       "utf8"
 66 |     );
 67 | 
 68 |     console.log(
 69 |       `[FB][cookies] Zapisano cookies.json (liczba cookies: ${cookies.length}).`
 70 |     );
 71 |   } catch (e) {
 72 |     console.log(
 73 |       "[FB][cookies] B≈ÇƒÖd przy zapisie cookies.json:",
 74 |       e?.message || e
 75 |     );
 76 |   }
 77 | }
 78 | 
 79 | 
 80 | 
 81 | /**
 82 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
 83 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
 84 |  */
 85 | async function acceptCookies(page, label = "global") {
 86 |   try {
 87 |     // chwila na pojawienie siƒô popupu
 88 |     await sleepRandom(800, 1500);
 89 | 
 90 |     const result = await page.evaluate(() => {
 91 |       const wanted = [
 92 |         "zezw√≥l na wszystkie pliki cookie",
 93 |         "zezw√≥l na wszystkie pliki",
 94 |         "akceptuj wszystkie pliki cookie",
 95 |         "akceptuj wszystkie",
 96 |         "allow all cookies",
 97 |         "accept all cookies",
 98 |         "accept essential and optional cookies",
 99 |         "tylko niezbƒôdne pliki cookie",
100 |         "odrzuƒá opcjonalne pliki cookie",
101 |       ].map((t) => t.toLowerCase());
102 | 
103 |       const buttons = Array.from(
104 |         document.querySelectorAll("button, [role='button']")
105 |       );
106 | 
107 |       let clicked = false;
108 |       const texts = [];
109 | 
110 |       for (const btn of buttons) {
111 |         const txt = (btn.innerText || btn.textContent || "").trim();
112 |         if (!txt) continue;
113 | 
114 |         const low = txt.toLowerCase();
115 |         texts.push(txt);
116 | 
117 |         if (wanted.some((w) => low.includes(w))) {
118 |           btn.click();
119 |           clicked = true;
120 |           break;
121 |         }
122 |       }
123 | 
124 |       return { clicked, texts };
125 |     });
126 | 
127 |     if (result.clicked) {
128 |       console.log(
129 |         `[FB][cookies-${label}] Klikniƒôto przycisk akceptacji cookies.`
130 |       );
131 |       await sleepRandom(1500, 2500);
132 |     } else {
133 |       console.log(
134 |         `[FB][cookies-${label}] Nie znaleziono przycisku cookies. Teksty na przyciskach:`,
135 |         result.texts
136 |       );
137 |     }
138 |   } catch (err) {
139 |     console.log(
140 |       `[FB][cookies-${label}] B≈ÇƒÖd przy obs≈Çudze popupu cookies:`,
141 |       err?.message || err
142 |     );
143 |   }
144 | }
145 | 
146 | export { loadCookies, saveCookies, acceptCookies };
147 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/10__expandButtons.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/expandButtons.js
  2 | // Centralny ‚Äûbutton classifier‚Äù dla wszystkich przycisk√≥w typu:
  3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments‚Äù
  4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies‚Äù
  5 | // - ‚ÄûZobacz wiƒôcej / See more‚Äù (bez ‚ÄûZobacz t≈Çumaczenie‚Äù).
  6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
  7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
  8 | 
  9 | import { INCLUDE_REPLIES } from "../config.js";
 10 | 
 11 | async function clickOneExpandButton(page) {
 12 |   const res = await page.evaluate((includeReplies) => {
 13 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 14 |       location.href
 15 |     );
 16 |     const isWatchView = /\/watch\//i.test(location.href);
 17 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
 18 | 
 19 |     function getPostRoot() {
 20 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 21 |       const postDialog = dialogs.find((dlg) => {
 22 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 23 |         if (!text) return false;
 24 |         const hasCommentWord =
 25 |           text.includes("komentarz") || text.includes("comment");
 26 |         const hasActions =
 27 |           text.includes("lubiƒô to") ||
 28 |           text.includes("komentarz") ||
 29 |           text.includes("udostƒôpnij") ||
 30 |           text.includes("napisz komentarz") ||
 31 |           text.includes("comment");
 32 |         const looksLikeNotifications =
 33 |           text.startsWith("powiadomienia") &&
 34 |           text.includes("wszystkie") &&
 35 |           text.includes("nieprzeczytane");
 36 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 37 |       });
 38 |       if (postDialog) return postDialog;
 39 |       const main = document.querySelector("div[role='main']");
 40 |       if (main) {
 41 |         const article = main.querySelector("article");
 42 |         return article || main;
 43 |       }
 44 |       return document.body;
 45 |     }
 46 | 
 47 |     function isVisible(el) {
 48 |       if (!el) return false;
 49 |       const style = window.getComputedStyle(el);
 50 |       if (!style) return false;
 51 |       if (style.display === "none" || style.visibility === "hidden") return false;
 52 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
 53 |       if (style.pointerEvents === "none") return false;
 54 |       const rect = el.getBoundingClientRect();
 55 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
 56 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
 57 |       return true;
 58 |     }
 59 | 
 60 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
 61 |     const root =
 62 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
 63 |     // (widok /watch/ jest traktowany jak video)
 64 | 
 65 |     const buttons = Array.from(
 66 |       root.querySelectorAll(
 67 |         "button, a, div[role='button'], span[role='button']"
 68 |       )
 69 |     );
 70 | 
 71 |     function classifyButton(raw) {
 72 |       const text = raw.toLowerCase();
 73 |       const hasCommentWord =
 74 |         text.includes("komentarz") ||
 75 |         text.includes("comments") ||
 76 |         text.includes("comment");
 77 |       const hasReplyWord =
 78 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
 79 |         text.includes("reply") ||
 80 |         text.includes("replies") ||
 81 |         text.includes("repl");
 82 |       const hasMoreWord =
 83 |         text.includes("wy≈õwietl") ||
 84 |         text.includes("zobacz") ||
 85 |         text.includes("poka≈º") ||
 86 |         text.includes("view") ||
 87 |         text.includes("show") ||
 88 |         text.includes("see") ||
 89 |         text.includes("wszystkie") ||
 90 |         text.includes("all") ||
 91 |         text.includes("previous");
 92 |       const hasTranslationWord =
 93 |         text.includes("t≈Çumaczenie") || text.includes("translation");
 94 |       if (hasTranslationWord) return null;
 95 |       if (
 96 |         text === "komentarz" ||
 97 |         text === "comment" ||
 98 |         text === "lubiƒô to" ||
 99 |         text === "lubiƒô to!" ||
100 |         text === "like" ||
101 |         text === "odpowiedz" ||
102 |         text === "reply"
103 |       ) {
104 |         return null;
105 |       }
106 |       if (
107 |         hasCommentWord &&
108 |         hasMoreWord &&
109 |         (text.includes("wiƒôcej") ||
110 |           text.includes("more") ||
111 |           text.includes("poprzednie") ||
112 |           text.includes("previous"))
113 |       ) {
114 |         return { kind: "more-comments", priority: 3 };
115 |       }
116 | 
117 |       // ‚úÖ ON/OFF odpowiedzi
118 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
119 |         return { kind: "more-replies", priority: 2 };
120 |       }
121 | 
122 |       if (
123 |         text === "zobacz wiƒôcej" ||
124 |         text === "see more" ||
125 |         text.startsWith("zobacz wiƒôcej ") ||
126 |         text.startsWith("see more ")
127 |       ) {
128 |         return { kind: "see-more-text", priority: 1 };
129 |       }
130 |       return null;
131 |     }
132 | 
133 |     const candidates = [];
134 | 
135 |     for (const el of buttons) {
136 |       if (!isVisible(el)) continue;
137 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
138 |       if (!raw) continue;
139 |       const cls = classifyButton(raw);
140 |       if (!cls) continue;
141 |       const rect = el.getBoundingClientRect();
142 |       candidates.push({
143 |         el,
144 |         kind: cls.kind,
145 |         priority: cls.priority,
146 |         top: rect.top,
147 |         text: raw,
148 |       });
149 |     }
150 | 
151 |     if (!candidates.length) {
152 |       return { clicked: false };
153 |     }
154 | 
155 |     candidates.sort((a, b) => {
156 |       if (a.priority !== b.priority) return b.priority - a.priority;
157 |       return a.top - b.top;
158 |     });
159 | 
160 |     const chosen = candidates[0];
161 |     try {
162 |       chosen.el.click();
163 |       return {
164 |         clicked: true,
165 |         kind: chosen.kind,
166 |         text: chosen.text,
167 |       };
168 |     } catch (e) {
169 |       return { clicked: false };
170 |     }
171 |   }, INCLUDE_REPLIES);
172 | 
173 |   if (res && res.clicked) {
174 |     console.log(
175 |       `[FB] -> klik expand '${res.text}' (kind=${res.kind})`
176 |     );
177 |   }
178 |   return !!(res && res.clicked);
179 | }
180 | 
181 | export { clickOneExpandButton };
182 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/11__index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // src/fb/ui/index.js
 2 | import * as PostUI from "./post.js";
 3 | import * as PhotoUI from "./photo.js";
 4 | import * as WatchUI from "./watch.js";
 5 | import * as VideosUI from "./videos.js";
 6 | 
 7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
 8 | 
 9 | export function pickUiHandler(url) {
10 |   const u = String(url || "");
11 |   for (const h of HANDLERS) {
12 |     try {
13 |       if (h.matchesUrl(u)) return h;
14 |     } catch {}
15 |   }
16 |   return PostUI;
17 | }
18 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/12__post.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/ui/post.js
  2 | import { EXPAND_COMMENTS } from "../../config.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { safeGoto } from "../../utils/navigation.js";
  5 | 
  6 | import { scrollPost } from "../scroll.js";
  7 | import { acceptCookies, saveCookies } from "../cookies.js";
  8 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  9 | import { clickOneExpandButton } from "../expandButtons.js";
 10 | 
 11 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
 12 | 
 13 | export const type = "post";
 14 | 
 15 | export function matchesUrl(url) {
 16 |   if (!url) return false;
 17 |   const u = String(url);
 18 |   if (u.includes("/watch")) return false;
 19 |   if (u.includes("/videos/")) return false;
 20 |   if (u.includes("/photo")) return false;
 21 |   if (u.includes("photo.php")) return false;
 22 | 
 23 |   return (
 24 |     u.includes("/posts/") ||
 25 |     u.includes("permalink.php") ||
 26 |     u.includes("/story.php") ||
 27 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
 28 |   );
 29 | }
 30 | 
 31 | /* ============================================================
 32 |    =============== POST ROOT (DIALOG / MAIN) ===================
 33 |    ============================================================ */
 34 | 
 35 | function postRootScript() {
 36 |   return `
 37 |     function getPostRoot() {
 38 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 39 | 
 40 |       const postDialog = dialogs.find((dlg) => {
 41 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 42 |         if (!text) return false;
 43 | 
 44 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
 45 |         const hasActions =
 46 |           text.includes("lubiƒô to") ||
 47 |           text.includes("komentarz") ||
 48 |           text.includes("udostƒôpnij") ||
 49 |           text.includes("write a comment") ||
 50 |           text.includes("comment");
 51 | 
 52 |         const looksLikeNotifications =
 53 |           text.startsWith("powiadomienia") &&
 54 |           text.includes("wszystkie") &&
 55 |           text.includes("nieprzeczytane");
 56 | 
 57 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 58 |       });
 59 | 
 60 |       if (postDialog) {
 61 |         const art = postDialog.querySelector("article");
 62 |         return art || postDialog;
 63 |       }
 64 | 
 65 |       const main = document.querySelector("div[role='main'], main");
 66 |       if (main) {
 67 |         const article = main.querySelector("article");
 68 |         return article || main;
 69 |       }
 70 | 
 71 |       return document.body;
 72 |     }
 73 |   `;
 74 | }
 75 | 
 76 | async function getPostScopeSelector(page) {
 77 |   const scope = await page.evaluate((code) => {
 78 |     // eslint-disable-next-line no-eval
 79 |     eval(code);
 80 |     // @ts-ignore
 81 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 82 |     if (!root) return "document";
 83 | 
 84 |     const dlg = root.closest("div[role='dialog']");
 85 |     if (dlg) return "div[role='dialog']";
 86 | 
 87 |     const main = document.querySelector("div[role='main'], main");
 88 |     if (main) return "div[role='main']";
 89 | 
 90 |     return "document";
 91 |   }, postRootScript());
 92 | 
 93 |   return scope || "document";
 94 | }
 95 | 
 96 | /* ============================================================
 97 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: ALL COMMENTS ===============
 98 |    ============================================================ */
 99 | 
100 | async function clickAllCommentsInMenu(page) {
101 |   const result = await page.evaluate(() => {
102 |     const norm = (s) =>
103 |       String(s || "")
104 |         .replace(/\u00a0/g, " ")
105 |         .replace(/\s+/g, " ")
106 |         .trim()
107 |         .toLowerCase();
108 | 
109 |     const menu = document.querySelector("div[role='menu']");
110 |     if (!menu) return { clicked: false, noMenu: true };
111 | 
112 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
113 | 
114 |     const opt = items.find((el) => {
115 |       const t = norm(el.textContent);
116 |       return (
117 |         t.startsWith("wszystkie komentarze") ||
118 |         t.startsWith("all comments") ||
119 |         t.startsWith("poka≈º wszystkie") ||
120 |         t.startsWith("pokaz wszystkie") ||
121 |         t.startsWith("show all")
122 |       );
123 |     });
124 | 
125 |     if (!opt) return { clicked: false, noMenu: false };
126 | 
127 |     try {
128 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
129 |     } catch {}
130 | 
131 |     try {
132 |       opt.click();
133 |       return { clicked: true, noMenu: false };
134 |     } catch {
135 |       return { clicked: false, noMenu: false };
136 |     }
137 |   });
138 | 
139 |   if (result.clicked) {
140 |     await sleepRandom(250, 450);
141 |     await page
142 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
143 |       .catch(() => {});
144 |   }
145 | 
146 |   return result;
147 | }
148 | 
149 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
150 |   console.log("[FB][ui:post][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
151 |   console.log("[FB][ui:post][filter] scope=", scopeSel);
152 | 
153 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
154 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
155 |   if (menuAlreadyOpen) {
156 |     console.log("[FB][ui:post][filter] Menu ju≈º otwarte ‚Äì wybieram opcjƒô.");
157 |     const r = await clickAllCommentsInMenu(page);
158 |     if (r?.clicked)
159 |       console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
160 |     return !!r?.clicked;
161 |   }
162 | 
163 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
164 |   const pre = await page.evaluate(
165 |     (scopeSel, code) => {
166 |       const norm = (s) =>
167 |         String(s || "")
168 |           .replace(/\u00a0/g, " ")
169 |           .replace(/\s+/g, " ")
170 |           .trim()
171 |           .toLowerCase();
172 | 
173 |       // eslint-disable-next-line no-eval
174 |       eval(code);
175 |       // @ts-ignore
176 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
177 | 
178 |       function getLabel(el) {
179 |         if (!el) return "";
180 |         const aria = el.getAttribute?.("aria-label");
181 |         if (aria) return aria;
182 |         return el.textContent || "";
183 |       }
184 | 
185 |       function isVisibleEnough(el) {
186 |         try {
187 |           if (!el) return false;
188 |           const st = window.getComputedStyle(el);
189 |           if (!st) return true;
190 |           if (st.display === "none" || st.visibility === "hidden") return false;
191 |           const r = el.getBoundingClientRect();
192 |           if (!r || r.width < 8 || r.height < 8) return false;
193 |           return true;
194 |         } catch {
195 |           return true;
196 |         }
197 |       }
198 | 
199 |       function findClickableAncestor(start) {
200 |         let el = start;
201 |         for (let i = 0; i < 10 && el; i++) {
202 |           const role = el.getAttribute?.("role");
203 |           const tag = (el.tagName || "").toLowerCase();
204 |           if (
205 |             tag === "button" ||
206 |             role === "button" ||
207 |             role === "menuitem" ||
208 |             role === "menuitemradio" ||
209 |             role === "link"
210 |           ) {
211 |             return el;
212 |           }
213 |           el = el.parentElement;
214 |         }
215 |         return null;
216 |       }
217 | 
218 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
219 |       const btnsAll = Array.from(
220 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
221 |       );
222 |       for (const el of btnsAll) {
223 |         const t = norm(getLabel(el));
224 |         if (
225 |           t === "wszystkie komentarze" ||
226 |           t === "all comments" ||
227 |           t === "poka≈º wszystkie" ||
228 |           t === "pokaz wszystkie" ||
229 |           t === "show all"
230 |         ) {
231 |           return { ok: true, state: "already-all", where: "document" };
232 |         }
233 |       }
234 | 
235 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
236 |       const scopes = [scopeEl, root, document].filter(Boolean);
237 | 
238 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
239 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
240 |       for (const sc of scopes) {
241 |         const clickables = Array.from(
242 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
243 |         );
244 | 
245 |         const candidates = [];
246 |         for (const el of clickables) {
247 |           const t = norm(getLabel(el));
248 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
249 |           if (!isVisibleEnough(el)) continue;
250 | 
251 |           let dist = 999999;
252 |           try {
253 |             const r = el.getBoundingClientRect();
254 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
255 |             dist = Math.abs(r.top - window.innerHeight / 2);
256 |           } catch {}
257 | 
258 |           candidates.push({ el, dist });
259 |         }
260 | 
261 |         if (candidates.length) {
262 |           candidates.sort((a, b) => a.dist - b.dist);
263 |           const picked = candidates[0].el;
264 | 
265 |           try {
266 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
267 |           } catch {}
268 | 
269 |           try {
270 |             picked.click();
271 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
272 |           } catch {
273 |             // nic
274 |           }
275 |         }
276 |       }
277 | 
278 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
279 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
280 |       for (const sc of scopes) {
281 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
282 |           .filter(isVisibleEnough)
283 |           .slice(0, 20000);
284 | 
285 |         for (const n of nodes) {
286 |           const t = norm(n.textContent);
287 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
288 | 
289 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
290 |           if (!clickable) continue;
291 | 
292 |           try {
293 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
294 |           } catch {}
295 | 
296 |           try {
297 |             clickable.click();
298 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
299 |           } catch {
300 |             // nic
301 |           }
302 |         }
303 |       }
304 | 
305 |       return { ok: false, state: "not-found" };
306 |     },
307 |     scopeSel,
308 |     postRootScript()
309 |   );
310 | 
311 |   if (!pre?.ok) {
312 |     console.log("[FB][ui:post][filter] Nie znaleziono przycisku filtra komentarzy.");
313 |     return false;
314 |   }
315 | 
316 |   if (pre.state === "already-all") {
317 |     console.log("[FB][ui:post][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' / 'Poka≈º wszystkie' ‚Äì pomijam.");
318 |     return true;
319 |   }
320 | 
321 |   console.log("[FB][ui:post][filter] Klikniƒôto filtr:", pre);
322 | 
323 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
324 |   await sleepRandom(350, 650);
325 | 
326 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
327 |   const menuResult = await clickAllCommentsInMenu(page);
328 | 
329 |   if (menuResult?.clicked) {
330 |     console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
331 |     return true;
332 |   }
333 | 
334 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
335 |   const afterLabelIsAll = await page.evaluate(() => {
336 |     const norm = (s) =>
337 |       String(s || "")
338 |         .replace(/\u00a0/g, " ")
339 |         .replace(/\s+/g, " ")
340 |         .trim()
341 |         .toLowerCase();
342 | 
343 |     const els = Array.from(
344 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
345 |     );
346 | 
347 |     function getLabel(el) {
348 |       const aria = el.getAttribute?.("aria-label");
349 |       if (aria) return aria;
350 |       return el.textContent || "";
351 |     }
352 | 
353 |     return els.some((el) => {
354 |       const t = norm(getLabel(el));
355 |       return (
356 |         t === "wszystkie komentarze" ||
357 |         t === "all comments" ||
358 |         t === "poka≈º wszystkie" ||
359 |         t === "pokaz wszystkie" ||
360 |         t === "show all"
361 |       );
362 |     });
363 |   });
364 | 
365 |   if (afterLabelIsAll) {
366 |     console.log("[FB][ui:post][filter] Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
367 |     return true;
368 |   }
369 | 
370 |   console.log(
371 |     "[FB][ui:post][filter] Nie uda≈Ço siƒô ustawiƒá filtra na 'Wszystkie komentarze' / 'Poka≈º wszystkie'. menuResult=",
372 |     menuResult
373 |   );
374 |   return false;
375 | }
376 | 
377 | 
378 | /* ============================================================
379 |    =================== LICZENIE Z UI (POST) ====================
380 |    ============================================================ */
381 | 
382 | /**
383 |  * Kluczowa poprawka:
384 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
385 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
386 |  */
387 | async function getCommentCountFromUiPostRoot(page) {
388 |   const res = await page.evaluate((code) => {
389 |     // eslint-disable-next-line no-eval
390 |     eval(code);
391 | 
392 |     const norm = (s) =>
393 |       String(s || "")
394 |         .replace(/\u00a0/g, " ")
395 |         .replace(/\s+/g, " ")
396 |         .trim();
397 | 
398 |     const lower = (s) => norm(s).toLowerCase();
399 | 
400 |     function parsePlEnCount(text) {
401 |       const t = lower(text);
402 |       if (!t) return null;
403 | 
404 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
405 | 
406 |       let x = t
407 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
408 |         .replace(/comments?/g, "")
409 |         .replace(/[():]/g, " ")
410 |         .replace(/\s+/g, " ")
411 |         .trim();
412 | 
413 |       let mult = 1;
414 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
415 |         mult = 1000;
416 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
417 |       }
418 |       if (/\bmln\b|\bmillion\b/.test(x)) {
419 |         mult = 1000000;
420 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
421 |       }
422 | 
423 |       x = x.replace(/\s+/g, "");
424 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
425 |       x = x.replace(/[^0-9.]/g, "");
426 |       if (!x) return null;
427 | 
428 |       const n = Number(x);
429 |       if (!Number.isFinite(n)) return null;
430 | 
431 |       return Math.round(n * mult);
432 |     }
433 | 
434 |     // @ts-ignore
435 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
436 |     const scope = root || document;
437 | 
438 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
439 |     const badBlock = (txt) => {
440 |       const t = lower(txt);
441 |       if (!t) return false;
442 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
443 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
444 |       return false;
445 |     };
446 | 
447 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
448 |     const spans = Array.from(scope.querySelectorAll("span"));
449 |     let best = null;
450 | 
451 |     for (const el of spans) {
452 |       const raw = norm(el.textContent);
453 |       if (!raw) continue;
454 |       if (badBlock(raw)) continue;
455 | 
456 |       const val = parsePlEnCount(raw);
457 |       if (val == null) continue;
458 | 
459 |       let score = 0;
460 |       score += Math.max(0, 40 - raw.length);
461 | 
462 |       try {
463 |         const r = el.getBoundingClientRect();
464 |         if (r.width > 10 && r.height > 10) score += 10;
465 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
466 |       } catch {}
467 | 
468 |       if (!best || score > best.score) best = { raw, val, score };
469 |     }
470 | 
471 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
472 | 
473 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
474 |     const nodes = Array.from(
475 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
476 |     );
477 | 
478 |     for (const el of nodes) {
479 |       const raw = norm(el.textContent);
480 |       if (!raw) continue;
481 |       if (badBlock(raw)) continue;
482 | 
483 |       const val = parsePlEnCount(raw);
484 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
485 |     }
486 | 
487 |     // 3) Ostatecznie: regex po tek≈õcie root
488 |     const blob = norm(scope.innerText || "");
489 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
490 |     if (m) {
491 |       const raw = norm(`${m[1]} ${m[2]}`);
492 |       const val = parsePlEnCount(raw);
493 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
494 |     }
495 | 
496 |     return { ok: false, reason: "not-found" };
497 |   }, postRootScript());
498 | 
499 |   return res?.ok ? res : null;
500 | }
501 | 
502 | /* ============================================================
503 |    =================== LICZENIE ANCHOR√ìW =======================
504 |    ============================================================ */
505 | 
506 | async function getCurrentCommentAnchorCount(page) {
507 |   const count = await page.evaluate(() => {
508 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
509 |     const ids = new Set();
510 | 
511 |     for (const a of anchors) {
512 |       try {
513 |         const url = new URL(a.href);
514 |         const cid = url.searchParams.get("comment_id");
515 |         const rid = url.searchParams.get("reply_comment_id");
516 |         let raw = rid || cid;
517 |         if (!raw) continue;
518 | 
519 |         if (!/^\d+$/.test(raw)) {
520 |           try {
521 |             const dec = atob(raw);
522 |             const m = dec.match(/:(\d+)_([0-9]+)/);
523 |             if (m) raw = m[2];
524 |           } catch {}
525 |         }
526 | 
527 |         if (raw) ids.add(raw);
528 |       } catch {}
529 |     }
530 | 
531 |     return ids.size;
532 |   });
533 | 
534 |   return count || 0;
535 | }
536 | 
537 | /* ============================================================
538 |    =================== SCROLL TYLKO W PO≈öCIE ===================
539 |    ============================================================ */
540 | 
541 | async function scrollWithinPost(page, label, factor = 0.25) {
542 |   const info = await page.evaluate(
543 |     (factorArg, labelArg, code) => {
544 |       // eslint-disable-next-line no-eval
545 |       eval(code);
546 |       // @ts-ignore
547 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
548 | 
549 |       const norm = (s) =>
550 |         String(s || "")
551 |           .replace(/\u00a0/g, " ")
552 |           .replace(/\s+/g, " ")
553 |           .trim()
554 |           .toLowerCase();
555 | 
556 |       function canScrollByTest(el) {
557 |         try {
558 |           if (!el) return false;
559 |           const ch = el.clientHeight || 0;
560 |           const sh = el.scrollHeight || 0;
561 |           if (ch <= 0) return false;
562 |           if (sh <= ch + 30) return false;
563 | 
564 |           const before = el.scrollTop ?? 0;
565 |           el.scrollTop = before + 80;
566 |           const after = el.scrollTop ?? before;
567 |           el.scrollTop = before;
568 |           return after !== before;
569 |         } catch {
570 |           return false;
571 |         }
572 |       }
573 | 
574 |       function isVisible(el) {
575 |         if (!el) return false;
576 |         const st = window.getComputedStyle(el);
577 |         if (!st) return true;
578 |         if (st.display === "none" || st.visibility === "hidden") return false;
579 |         const r = el.getBoundingClientRect();
580 |         if (!r || r.width < 5 || r.height < 5) return false;
581 |         return true;
582 |       }
583 | 
584 |       function pickContainerSmart() {
585 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
586 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
587 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
588 | 
589 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
590 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
591 | 
592 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
593 |         let anchor = null;
594 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
595 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
596 |           .filter(isVisible)
597 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
598 | 
599 |         if (candAnchor) anchor = candAnchor;
600 | 
601 |         function score(el) {
602 |           const ch = el.clientHeight || 0;
603 |           const sh = el.scrollHeight || 0;
604 |           const delta = sh - ch;
605 | 
606 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
607 |           const t = norm(el.innerText || "");
608 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
609 |           let s = delta + (hasCommentWords ? 12000 : 0);
610 | 
611 |           // premia je≈õli blisko anchora
612 |           if (anchor) {
613 |             const ar = anchor.getBoundingClientRect();
614 |             const er = el.getBoundingClientRect();
615 |             const dist = Math.abs(er.top - ar.top);
616 |             s += Math.max(0, 4000 - dist);
617 |           }
618 | 
619 |           return s;
620 |         }
621 | 
622 |         let best = null;
623 |         let bestScore = -1;
624 | 
625 |         for (const sc of scopes) {
626 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
627 |             .filter(isVisible)
628 |             .slice(0, 18000);
629 | 
630 |           for (const el of divs) {
631 |             if (!canScrollByTest(el)) continue;
632 |             const s = score(el);
633 |             if (s > bestScore) {
634 |               bestScore = s;
635 |               best = el;
636 |             }
637 |           }
638 |           if (best) break;
639 |         }
640 | 
641 |         if (best) {
642 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
643 |           return { el: best, label: "smart" };
644 |         }
645 | 
646 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
647 |         return {
648 |           el: document.scrollingElement || document.documentElement || document.body,
649 |           label: "window",
650 |         };
651 |       }
652 | 
653 |       const picked = pickContainerSmart();
654 |       const container = picked.el;
655 |       const containerType = picked.label;
656 | 
657 |       const isWindowContainer =
658 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
659 | 
660 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
661 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
662 | 
663 |       if (maxScroll <= 0) {
664 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
665 |       }
666 | 
667 |       const f = factorArg || 0.25;
668 |       const sign = f < 0 ? -1 : 1;
669 |       const magnitude = Math.min(Math.abs(f), 1);
670 | 
671 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
672 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
673 |       const step = Math.max(120, Math.min(baseStep, 520));
674 | 
675 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
676 | 
677 |       if (isWindowContainer) window.scrollTo(0, target);
678 |       else container.scrollTop = target;
679 | 
680 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
681 | 
682 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
683 |       if (after === before) {
684 |         try {
685 |           window.scrollBy(0, sign * step);
686 |         } catch {}
687 |       }
688 | 
689 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
690 | 
691 |       return { before, after: after2, container: containerType, label: labelArg };
692 |     },
693 |     factor,
694 |     label,
695 |     postRootScript()
696 |   );
697 | 
698 |   return info;
699 | }
700 | 
701 | /* ============================================================
702 |    =================== EXPAND (LEGACY) =========================
703 |    ============================================================ */
704 | 
705 | async function expandAllComments(page) {
706 |   if (!EXPAND_COMMENTS) return 0;
707 | 
708 |   let clicks = 0;
709 |   for (let i = 0; i < 30; i++) {
710 |     const didClick = await clickOneExpandButton(page);
711 |     if (!didClick) break;
712 |     clicks++;
713 |     await sleepRandom(900, 1600);
714 |   }
715 |   return clicks;
716 | }
717 | 
718 | /* ============================================================
719 |    =================== HANDLER API =============================
720 |    ============================================================ */
721 | 
722 | export async function prepare(page, url) {
723 |   console.log(`[FB][ui:post] prepare: ${url}`);
724 | 
725 |   const ok = await safeGoto(page, url, "post", {
726 |     waitUntil: "networkidle2",
727 |     timeout: NAV_TIMEOUT_MS,
728 |   });
729 | 
730 |   if (!ok) throw new Error("safeGoto-failed");
731 | 
732 |   const currentUrl = page.url();
733 |   if (currentUrl.includes("/login")) {
734 |     console.log("[FB][ui:post] /login redirect ‚Üí fbLogin() and back");
735 |     await fbLogin(page);
736 |     await sleepRandom(3000, 4500);
737 | 
738 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
739 |     console.log("[FB][ui:post] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
740 | 
741 |     if (loggedAfterLogin) {
742 |       await safeGoto(page, url, "post", {
743 |         waitUntil: "networkidle2",
744 |         timeout: NAV_TIMEOUT_MS,
745 |       });
746 |     }
747 |   }
748 | 
749 |   await acceptCookies(page, "post-initial");
750 | 
751 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
752 |   await sleepRandom(1200, 1800);
753 |   await acceptCookies(page, "post");
754 | 
755 |   try {
756 |     const logged = await checkIfLogged(page).catch(() => false);
757 |     if (logged) await saveCookies(page);
758 |   } catch {}
759 | 
760 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
761 |   await scrollPost(page, 120).catch(() => {});
762 |   await sleepRandom(600, 900);
763 | }
764 | 
765 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
766 |   try {
767 |     await page.waitForFunction(
768 |       ({ stableMs }) => {
769 |         const now = performance.now();
770 |         const y = window.scrollY || 0;
771 | 
772 |         if (!window.__fbScrollStop) {
773 |           window.__fbScrollStop = { lastY: y, lastChange: now };
774 |           return false;
775 |         }
776 | 
777 |         const st = window.__fbScrollStop;
778 | 
779 |         if (Math.abs(y - st.lastY) > 0) {
780 |           st.lastY = y;
781 |           st.lastChange = now;
782 |           return false;
783 |         }
784 | 
785 |         return now - st.lastChange >= stableMs;
786 |       },
787 |       { timeout: timeoutMs },
788 |       { stableMs }
789 |     );
790 |     return true;
791 |   } catch {
792 |     return false;
793 |   }
794 | }
795 | 
796 | export async function getCommentCount(page, url) {
797 |   console.log("[FB][ui:post] getCommentCount‚Ä¶");
798 | 
799 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
800 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
801 | 
802 |   const scopeSel = await getPostScopeSelector(page);
803 | 
804 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
805 |   console.log("[FB][ui:post] filter all comments:", okFilter);
806 | 
807 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
808 |   if (okFilter) {
809 |     await sleepRandom(250, 450);
810 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
811 |   }
812 | 
813 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
814 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
815 | 
816 |   console.log("[FB][ui:post] UI comments:", {
817 |     source: ui?.source || "none",
818 |     raw: ui?.raw || null,
819 |     comments: ui?.comments ?? null,
820 |   });
821 | 
822 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
823 |     return ui.comments;
824 |   }
825 | 
826 |   const anchors = await getCurrentCommentAnchorCount(page);
827 |   console.log("[FB][ui:post] Fallback anchor count =", anchors);
828 | 
829 |   return anchors > 0 ? anchors : null;
830 | }
831 | 
832 | export async function loadAllComments(page, { expectedTotal } = {}) {
833 |   console.log(`[FB][ui:post] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"}`);
834 | 
835 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
836 | 
837 |   const MAX_ROUNDS = 600;
838 |   const MAX_NO_PROGRESS = 60;
839 | 
840 |   let noProgress = 0;
841 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
842 | 
843 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
844 |     const before = lastAnchors;
845 | 
846 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
847 |     const clicks = await expandAllComments(page);
848 |     await sleepRandom(220, 420);
849 | 
850 |     const after = await getCurrentCommentAnchorCount(page);
851 | 
852 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
853 | 
854 |     if (progressed) noProgress = 0;
855 |     else noProgress++;
856 | 
857 |     lastAnchors = after;
858 | 
859 |     if (round === 1 || round % 25 === 0) {
860 |       console.log(
861 |         `[FB][ui:post] round=${round} container=${scrollInfo.container} scrollTop: ${scrollInfo.before}‚Üí${scrollInfo.after} anchors: ${before}‚Üí${after} clicks=${clicks} noProgress=${noProgress}`
862 |       );
863 |     }
864 | 
865 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
866 |       if (after >= expectedTotal && noProgress >= 2) {
867 |         console.log("[FB][ui:post] stop reason=target-reached");
868 |         break;
869 |       }
870 |     }
871 | 
872 |     if (noProgress >= MAX_NO_PROGRESS) {
873 |       console.log("[FB][ui:post] stop reason=no-progress");
874 |       break;
875 |     }
876 |   }
877 | }
878 | 
879 | export async function extractComments(page, url) {
880 |   const data = await page.evaluate(() => {
881 |     function extractCommentId(u) {
882 |       const m = u?.match(/comment_id=([^&]+)/);
883 |       return m ? decodeURIComponent(m[1]) : null;
884 |     }
885 | 
886 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
887 |     const idToTimeMap = {};
888 | 
889 |     for (let i = 0; i < allLinks.length; i++) {
890 |       const link = allLinks[i];
891 |       const href = link.getAttribute("href") || "";
892 |       const id = extractCommentId(href);
893 |       if (!id) continue;
894 | 
895 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
896 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
897 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
898 |           idToTimeMap[id] = timeText;
899 |           break;
900 |         }
901 |       }
902 |     }
903 | 
904 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
905 | 
906 |     const extracted = nodes
907 |       .map((node, idx) => {
908 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
909 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
910 | 
911 |         const linkEl = node.querySelector('a[role="link"]');
912 |         const href = linkEl?.getAttribute("href") || null;
913 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
914 | 
915 |         const id = permalink ? extractCommentId(permalink) : null;
916 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
917 | 
918 |         if (!author || !text) return null;
919 | 
920 |         return { id, author, text, time, permalink, pos: idx };
921 |       })
922 |       .filter(Boolean);
923 | 
924 |     return extracted;
925 |   });
926 | 
927 |   console.log("[FB][ui:post] extractComments: count =", data?.length || 0);
928 |   return Array.isArray(data) ? data : [];
929 | }
930 | 
931 | export async function debugSnapshot(page) {
932 |   const scopeSel = await getPostScopeSelector(page);
933 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
934 | 
935 |   return {
936 |     scopeSel,
937 |     anchors,
938 |     url: page.url(),
939 |   };
940 | }
941 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/13__photo.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
   1 | // src/fb/ui/photo.js
   2 | import { safeGoto } from "../../utils/navigation.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { scrollPost } from "../scroll.js";
   5 | import { acceptCookies, saveCookies } from "../cookies.js";
   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
   7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
   8 | 
   9 | export const type = "photo";
  10 | 
  11 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
  12 | 
  13 | /**
  14 |  * WA≈ªNE:
  15 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
  16 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
  17 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
  18 |  */
  19 | const PACE_CFG =
  20 |   PACE === "server"
  21 |     ? {
  22 |         // delikatnie wolniej na serwerze (render/CPU)
  23 |         stepJitterMinMs: 140,
  24 |         stepJitterMaxMs: 260,
  25 | 
  26 |         afterScrollMinMs: 260,
  27 |         afterScrollMaxMs: 520,
  28 | 
  29 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
  30 |         effectWaitMs: 5200,
  31 | 
  32 |         scrollPx: 140,
  33 | 
  34 |         // bonusowe kliki, ale event-driven
  35 |         bonusClickTries: 2,
  36 |         bonusClickDelayMinMs: 120,
  37 |         bonusClickDelayMaxMs: 220,
  38 | 
  39 |         // HARD BOTTOM (sprawdzane rzadko)
  40 |         hardBottomEpsPx: 10,
  41 |         hardBottomStableNeed: 4,
  42 |         hardBottomStableDelayMinMs: 320,
  43 |         hardBottomStableDelayMaxMs: 560,
  44 |       }
  45 |     : {
  46 |         // lokalnie szybciej
  47 |         stepJitterMinMs: 90,
  48 |         stepJitterMaxMs: 190,
  49 | 
  50 |         afterScrollMinMs: 180,
  51 |         afterScrollMaxMs: 420,
  52 | 
  53 |         effectWaitMs: 4200,
  54 | 
  55 |         scrollPx: 160,
  56 | 
  57 |         bonusClickTries: 2,
  58 |         bonusClickDelayMinMs: 90,
  59 |         bonusClickDelayMaxMs: 180,
  60 | 
  61 |         hardBottomEpsPx: 10,
  62 |         hardBottomStableNeed: 4,
  63 |         hardBottomStableDelayMinMs: 240,
  64 |         hardBottomStableDelayMaxMs: 420,
  65 |       };
  66 | 
  67 | export function matchesUrl(url) {
  68 |   try {
  69 |     const u = new URL(url);
  70 |     const path = (u.pathname || "").toLowerCase();
  71 | 
  72 |     if (path.includes("photo.php")) return true;
  73 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
  74 |     if (u.searchParams.has("fbid")) return true;
  75 | 
  76 |     return false;
  77 |   } catch {
  78 |     const lower = (url || "").toLowerCase();
  79 |     if (lower.includes("photo.php")) return true;
  80 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
  81 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
  82 |     return false;
  83 |   }
  84 | }
  85 | 
  86 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
  87 | 
  88 | async function clickAllCommentsInMenu(page) {
  89 |   const result = await page.evaluate(() => {
  90 |     const menu =
  91 |       document.querySelector("div[role='menu']") ||
  92 |       document.querySelector("div[role='dialog']");
  93 | 
  94 |     if (!menu) return { clicked: false, noMenu: true };
  95 | 
  96 |     const items = Array.from(
  97 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
  98 |     );
  99 | 
 100 |     const opt = items.find((el) => {
 101 |       const t = (el.textContent || "").trim().toLowerCase();
 102 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
 103 |     });
 104 | 
 105 |     if (!opt) return { clicked: false, noMenu: false };
 106 | 
 107 |     opt.click();
 108 |     setTimeout(() => {
 109 |       try {
 110 |         document.body.click();
 111 |       } catch {}
 112 |     }, 50);
 113 | 
 114 |     return { clicked: true, noMenu: false };
 115 |   });
 116 | 
 117 |   if (result.clicked) {
 118 |     await sleepRandom(180, 320);
 119 |     await page
 120 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
 121 |       .catch(() => {});
 122 |   }
 123 | 
 124 |   return result;
 125 | }
 126 | 
 127 | async function switchCommentsFilterToAll(page) {
 128 |   console.log("[FB][ui:photo][filter] switch -> all comments");
 129 | 
 130 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 131 |   if (menuAlreadyOpen) {
 132 |     const r = await clickAllCommentsInMenu(page);
 133 |     return !!r.clicked;
 134 |   }
 135 | 
 136 |   const pre = await page.evaluate(() => {
 137 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 138 |     let filterEl = null;
 139 |     let labelText = "";
 140 | 
 141 |     for (const el of els) {
 142 |       const t = (el.textContent || "").trim();
 143 |       if (!t) continue;
 144 |       const low = t.toLowerCase();
 145 |       if (
 146 |         low === "najtrafniejsze" ||
 147 |         low === "most relevant" ||
 148 |         low === "wszystkie komentarze" ||
 149 |         low === "all comments"
 150 |       ) {
 151 |         filterEl = el;
 152 |         labelText = low;
 153 |         break;
 154 |       }
 155 |     }
 156 | 
 157 |     if (!filterEl) return { state: "not-found" };
 158 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 159 |       return { state: "already-all" };
 160 |     }
 161 | 
 162 |     filterEl.click();
 163 |     return { state: "clicked-filter" };
 164 |   });
 165 | 
 166 |   if (pre.state === "not-found") return false;
 167 |   if (pre.state === "already-all") return true;
 168 | 
 169 |   await sleepRandom(120, 220);
 170 |   const r = await clickAllCommentsInMenu(page);
 171 |   if (r.clicked) return true;
 172 | 
 173 |   const afterLabelIsAll = await page.evaluate(() => {
 174 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 175 |     return els.some((el) => {
 176 |       const t = (el.textContent || "").trim().toLowerCase();
 177 |       return t === "wszystkie komentarze" || t === "all comments";
 178 |     });
 179 |   });
 180 | 
 181 |   return afterLabelIsAll;
 182 | }
 183 | 
 184 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
 185 | 
 186 | async function getCommentsRootHandle(page) {
 187 |   const handle = await page.evaluateHandle(() => {
 188 |     const norm = (s) =>
 189 |       String(s || "")
 190 |         .replace(/\u00a0/g, " ")
 191 |         .replace(/\s+/g, " ")
 192 |         .trim()
 193 |         .toLowerCase();
 194 | 
 195 |     const isVisible = (el) => {
 196 |       if (!el) return false;
 197 |       try {
 198 |         const r = el.getBoundingClientRect();
 199 |         return r.width > 2 && r.height > 2;
 200 |       } catch {
 201 |         return true;
 202 |       }
 203 |     };
 204 | 
 205 |     const isMoreCommentsBtn = (el) => {
 206 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 207 |       if (!t) return false;
 208 |       return (
 209 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 210 |         t.includes("zobacz wiƒôcej komentarzy") ||
 211 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
 212 |         t.includes("view more comments") ||
 213 |         t.includes("view previous comments")
 214 |       );
 215 |     };
 216 | 
 217 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
 218 |       isVisible
 219 |     );
 220 |     const keyBtn = btns.find(isMoreCommentsBtn);
 221 | 
 222 |     if (keyBtn) {
 223 |       const dlg = keyBtn.closest?.("div[role='dialog']");
 224 |       if (dlg) return dlg;
 225 | 
 226 |       let cur = keyBtn.parentElement;
 227 |       for (let i = 0; i < 20 && cur; i++) {
 228 |         if (cur.matches?.("article,main,section,div")) return cur;
 229 |         cur = cur.parentElement;
 230 |       }
 231 |     }
 232 | 
 233 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 234 |     const dlg2 = dialogs.find((d) => {
 235 |       const t = norm(d.innerText || d.textContent);
 236 |       if (!t) return false;
 237 |       if (t.includes("powiadomienia")) return false;
 238 |       if (t.includes("szukaj znajomych")) return false;
 239 |       return (
 240 |         t.includes("najtrafniejsze") ||
 241 |         t.includes("most relevant") ||
 242 |         t.includes("komentarz") ||
 243 |         t.includes("comment")
 244 |       );
 245 |     });
 246 |     if (dlg2) return dlg2;
 247 | 
 248 |     return document.body;
 249 |   });
 250 | 
 251 |   return handle;
 252 | }
 253 | 
 254 | async function getCommentsScrollHandle(page, rootHandle) {
 255 |   const handle = await page.evaluateHandle((root) => {
 256 |     const isVisible = (el) => {
 257 |       if (!el) return false;
 258 |       try {
 259 |         const r = el.getBoundingClientRect();
 260 |         return r.width > 2 && r.height > 2;
 261 |       } catch {
 262 |         return true;
 263 |       }
 264 |     };
 265 | 
 266 |     const canScrollByTest = (el) => {
 267 |       try {
 268 |         if (!el) return false;
 269 |         const h = el.clientHeight || 0;
 270 |         const sh = el.scrollHeight || 0;
 271 |         if (sh <= h + 40) return false;
 272 | 
 273 |         const before = el.scrollTop ?? 0;
 274 |         el.scrollTop = before + 80;
 275 |         const after = el.scrollTop ?? before;
 276 |         el.scrollTop = before;
 277 | 
 278 |         return after !== before;
 279 |       } catch {
 280 |         return false;
 281 |       }
 282 |     };
 283 | 
 284 |     const closestScrollable = (start) => {
 285 |       let cur = start;
 286 |       for (let i = 0; i < 28 && cur; i++) {
 287 |         if (canScrollByTest(cur)) return cur;
 288 |         cur = cur.parentElement;
 289 |       }
 290 |       return null;
 291 |     };
 292 | 
 293 |     const scope = root || document;
 294 | 
 295 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
 296 |     if (outer) {
 297 |       const sc = closestScrollable(outer);
 298 |       if (sc) return sc;
 299 |     }
 300 | 
 301 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
 302 |       .filter(isVisible)
 303 |       .slice(0, 25000);
 304 | 
 305 |     let best = null;
 306 |     let bestDelta = -1;
 307 |     for (const el of candidates) {
 308 |       if (!canScrollByTest(el)) continue;
 309 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
 310 |       if (delta > bestDelta) {
 311 |         bestDelta = delta;
 312 |         best = el;
 313 |       }
 314 |     }
 315 | 
 316 |     return best || null;
 317 |   }, rootHandle);
 318 | 
 319 |   return handle;
 320 | }
 321 | 
 322 | /* ======================================================================== */
 323 | 
 324 | export async function prepare(page, url) {
 325 |   console.log(`[FB][ui:photo] prepare: ${url}`);
 326 | 
 327 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 328 |   if (!ok) throw new Error("safeGoto-failed");
 329 | 
 330 |   if (page.url().includes("/login")) {
 331 |     console.log("[FB][ui:photo] /login ‚Äì fbLogin + re-enter.");
 332 |     await fbLogin(page);
 333 |     await sleepRandom(2500, 4000);
 334 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 335 |   }
 336 | 
 337 |   await acceptCookies(page, "photo-initial");
 338 | 
 339 |   const logged = await checkIfLogged(page).catch(() => false);
 340 |   if (!logged) {
 341 |     console.log("[FB][ui:photo] not logged ‚Äì fbLogin().");
 342 |     await fbLogin(page);
 343 |     await sleepRandom(2500, 4000);
 344 |   }
 345 | 
 346 |   await ensureLoggedInOnPostOverlay(page);
 347 |   await acceptCookies(page, "photo");
 348 | 
 349 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
 350 |   if (loggedFinal) await saveCookies(page);
 351 | }
 352 | 
 353 | function parseNumberLikeNode(str) {
 354 |   if (!str) return null;
 355 | 
 356 |   const cleaned = String(str)
 357 |     .toLowerCase()
 358 |     .replace(/\u00a0/g, " ")
 359 |     .replace(/\s+/g, " ")
 360 |     .trim();
 361 | 
 362 |   const plain = cleaned.replace(/[^\d]/g, "");
 363 |   if (/^\d+$/.test(plain)) {
 364 |     const n = Number(plain);
 365 |     return Number.isFinite(n) ? n : null;
 366 |   }
 367 | 
 368 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 369 |   if (m) {
 370 |     const base = Number(m[1].replace(",", "."));
 371 |     if (Number.isFinite(base)) return Math.round(base * 1000);
 372 |   }
 373 | 
 374 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 375 |   if (m2) {
 376 |     const base = Number(m2[1].replace(",", "."));
 377 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
 378 |   }
 379 | 
 380 |   return null;
 381 | }
 382 | 
 383 | async function getPhotoUiCountFromChip(page, rootHandle) {
 384 |   const res = await page
 385 |     .evaluate((root) => {
 386 |       const scope = root || document;
 387 | 
 388 |       const norm = (s) =>
 389 |         String(s || "")
 390 |           .replace(/\u00a0/g, " ")
 391 |           .replace(/\s+/g, " ")
 392 |           .trim();
 393 | 
 394 |       const parseNum = (s) => {
 395 |         const t = norm(s);
 396 |         if (!t) return null;
 397 | 
 398 |         const plain = t.replace(/[^\d]/g, "");
 399 |         if (/^\d+$/.test(plain)) return Number(plain);
 400 | 
 401 |         const lower = t.toLowerCase();
 402 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 403 |         if (m) {
 404 |           const base = Number(m[1].replace(",", "."));
 405 |           if (Number.isFinite(base)) return Math.round(base * 1000);
 406 |         }
 407 | 
 408 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 409 |         if (m2) {
 410 |           const base = Number(m2[1].replace(",", "."));
 411 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
 412 |         }
 413 | 
 414 |         return null;
 415 |       };
 416 | 
 417 |       const isVisible = (el) => {
 418 |         if (!el) return false;
 419 |         const r = el.getBoundingClientRect();
 420 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
 421 |       };
 422 | 
 423 |       const commentBtn = Array.from(
 424 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
 425 |       ).find((el) => {
 426 |         const t = norm(el.textContent).toLowerCase();
 427 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
 428 |       });
 429 | 
 430 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
 431 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
 432 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
 433 | 
 434 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
 435 |         .filter(isVisible)
 436 |         .slice(0, 5000);
 437 | 
 438 |       let best = null;
 439 |       let bestScore = -Infinity;
 440 | 
 441 |       for (const el of candidates) {
 442 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
 443 |         if (!hasIcon) continue;
 444 | 
 445 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
 446 |         let num = null;
 447 |         let raw = null;
 448 | 
 449 |         for (const sp of spans) {
 450 |           const t = norm(sp.textContent);
 451 |           if (!t) continue;
 452 |           if (t.length > 24) continue;
 453 | 
 454 |           const n = parseNum(t);
 455 |           if (typeof n === "number" && Number.isFinite(n)) {
 456 |             if (n <= 0 || n > 10000000) continue;
 457 |             num = n;
 458 |             raw = t;
 459 |             break;
 460 |           }
 461 |         }
 462 | 
 463 |         if (num == null) continue;
 464 | 
 465 |         const r = el.getBoundingClientRect();
 466 |         const cx = r.left + r.width / 2;
 467 |         const cy = r.top + r.height / 2;
 468 | 
 469 |         let score = 0;
 470 | 
 471 |         if (anchorCx != null && anchorCy != null) {
 472 |           const dx = cx - anchorCx;
 473 |           const dy = cy - anchorCy;
 474 |           const dist = Math.sqrt(dx * dx + dy * dy);
 475 |           score -= dist;
 476 |         }
 477 | 
 478 |         const textLen = norm(el.textContent).length;
 479 |         score -= Math.min(400, textLen);
 480 | 
 481 |         score += Math.min(200, Math.log10(num + 1) * 120);
 482 | 
 483 |         if (score > bestScore) {
 484 |           bestScore = score;
 485 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
 486 |         }
 487 |       }
 488 | 
 489 |       return best;
 490 |     }, rootHandle)
 491 |     .catch(() => null);
 492 | 
 493 |   if (!res || typeof res.count !== "number") return null;
 494 |   return { count: res.count, raw: res.raw, dbg: res };
 495 | }
 496 | 
 497 | export async function getCommentCount(page, url) {
 498 |   console.log("[FB][ui:photo] getCommentCount‚Ä¶");
 499 | 
 500 |   await scrollPost(page, 220);
 501 |   await sleepRandom(220, 420);
 502 | 
 503 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
 504 |   console.log(`[FB][ui:photo] filter all comments: ${okFilter}`);
 505 | 
 506 |   // mikro settle po filtrze (bez mulenia)
 507 |   await sleepRandom(220, 420);
 508 | 
 509 |   const rootHandle = await getCommentsRootHandle(page);
 510 | 
 511 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
 512 |   if (chip?.count != null) {
 513 |     console.log("[FB][ui:photo] UI count (chip):", chip);
 514 |   }
 515 | 
 516 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
 517 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
 518 | 
 519 |   const loaded = await page
 520 |     .evaluate((root) => {
 521 |       const scope = root || document;
 522 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 523 |       const ids = new Set();
 524 |       for (const a of as) {
 525 |         const href = a.getAttribute("href") || "";
 526 |         const m = href.match(/comment_id=([^&]+)/);
 527 |         if (m && m[1]) ids.add(m[1]);
 528 |       }
 529 |       return ids.size || null;
 530 |     }, rootHandle)
 531 |     .catch(() => null);
 532 | 
 533 |   let total = null;
 534 |   let source = "none";
 535 | 
 536 |   if (chip?.count != null) {
 537 |     total = chip.count;
 538 |     source = "ui-photo-chip";
 539 |   } else if (infoCount != null) {
 540 |     total = infoCount;
 541 |     source = uiInfo?.source || "uicommentinfo";
 542 |   } else if (loaded != null) {
 543 |     total = loaded;
 544 |     source = "loaded-comment_id";
 545 |   }
 546 | 
 547 |   console.log("[FB][ui:photo] UI comments:", {
 548 |     source,
 549 |     chip: chip?.count ?? null,
 550 |     uiInfoSource: uiInfo?.source ?? null,
 551 |     uiInfoRaw: uiInfo?.raw ?? null,
 552 |     uiInfoCount: infoCount,
 553 |     loaded,
 554 |     chosen: total,
 555 |   });
 556 | 
 557 |   try {
 558 |     await rootHandle.dispose?.();
 559 |   } catch {}
 560 | 
 561 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
 562 |   await sleepRandom(180, 340);
 563 | 
 564 |   return total;
 565 | }
 566 | 
 567 | export async function loadAllComments(page, { expectedTotal } = {}) {
 568 |   console.log(`[FB][ui:photo] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
 569 | 
 570 |   const MAX_STEPS = 900;
 571 |   const MAX_NO_PROGRESS = 28;
 572 | 
 573 |   let noProgress = 0;
 574 | 
 575 |   const rootHandle = await getCommentsRootHandle(page);
 576 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
 577 | 
 578 |   const shortBtn = (t) => {
 579 |     const s = String(t || "").replace(/\s+/g, " ").trim();
 580 |     if (s.length <= 90) return s;
 581 |     return s.slice(0, 90) + "‚Ä¶";
 582 |   };
 583 | 
 584 |   async function countAnchors() {
 585 |     return page.evaluate((root) => {
 586 |       const scope = root || document;
 587 | 
 588 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 589 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
 590 | 
 591 |       const uniq = (arr, param) => {
 592 |         const ids = new Set();
 593 |         for (const a of arr) {
 594 |           const href = a.getAttribute("href") || "";
 595 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
 596 |           if (m && m[1]) ids.add(m[1]);
 597 |         }
 598 |         return ids.size;
 599 |       };
 600 | 
 601 |       return {
 602 |         commentsAnchors: uniq(commentAs, "comment_id"),
 603 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
 604 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
 605 |       };
 606 |     }, rootHandle);
 607 |   }
 608 | 
 609 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
 610 |     try {
 611 |       const info = await page.evaluate((root, scroller, px) => {
 612 |         const pick =
 613 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
 614 | 
 615 |         const before =
 616 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 617 | 
 618 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
 619 |         else window.scrollBy(0, px);
 620 | 
 621 |         const after =
 622 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 623 | 
 624 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
 625 |       }, rootHandle, scrollHandle, pixels);
 626 | 
 627 |       if (!info?.moved) {
 628 |         console.log(
 629 |           `[FB][ui:photo][scroll] NO-MOVE tag=${info?.tag} before=${info?.before} after=${info?.after}`
 630 |         );
 631 |       }
 632 |     } catch {
 633 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
 634 |     }
 635 | 
 636 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
 637 |   }
 638 | 
 639 |   async function getScrollMetrics() {
 640 |     return page.evaluate((root, scroller) => {
 641 |       const pick =
 642 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 643 | 
 644 |       const isEl = pick && typeof pick.scrollHeight === "number";
 645 | 
 646 |       if (!isEl) {
 647 |         const se = document.scrollingElement || document.documentElement || document.body;
 648 |         return {
 649 |           tag: "WINDOW",
 650 |           scrollTop: window.scrollY || 0,
 651 |           scrollHeight: se?.scrollHeight || 0,
 652 |           clientHeight: window.innerHeight || 0,
 653 |         };
 654 |       }
 655 | 
 656 |       return {
 657 |         tag: pick.tagName || "UNKNOWN",
 658 |         scrollTop: pick.scrollTop || 0,
 659 |         scrollHeight: pick.scrollHeight || 0,
 660 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
 661 |       };
 662 |     }, rootHandle, scrollHandle);
 663 |   }
 664 | 
 665 |   async function hasLoadMoreButtons() {
 666 |     return page.evaluate((root) => {
 667 |       const scope = root || document;
 668 | 
 669 |       const norm = (s) =>
 670 |         String(s || "")
 671 |           .replace(/\u00a0/g, " ")
 672 |           .replace(/\s+/g, " ")
 673 |           .trim()
 674 |           .toLowerCase();
 675 | 
 676 |       const isVisible = (el) => {
 677 |         if (!el) return false;
 678 |         const r = el.getBoundingClientRect();
 679 |         if (r.width < 2 || r.height < 2) return false;
 680 |         return r.bottom > 0 && r.top < window.innerHeight;
 681 |       };
 682 | 
 683 |       const nodesBtn = Array.from(
 684 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 685 |       ).filter(isVisible);
 686 | 
 687 |       return nodesBtn.some((el) => {
 688 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 689 | 
 690 |         if (
 691 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 692 |           t.includes("zobacz wiƒôcej komentarzy") ||
 693 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 694 |           t.includes("view more comments") ||
 695 |           t.includes("view previous comments")
 696 |         )
 697 |           return true;
 698 | 
 699 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 700 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 701 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 702 |         if (t.includes("view") && t.includes("repl")) return true;
 703 |         if (t.includes("see") && t.includes("repl")) return true;
 704 | 
 705 |         return false;
 706 |       });
 707 |     }, rootHandle);
 708 |   }
 709 | 
 710 |   function isHardBottom(m) {
 711 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
 712 |     const top = Number(m?.scrollTop || 0);
 713 |     const ch = Number(m?.clientHeight || 0);
 714 |     const sh = Number(m?.scrollHeight || 0);
 715 |     if (!sh || !ch) return false;
 716 |     return top + ch >= sh - eps;
 717 |   }
 718 | 
 719 |   let bottomStable = 0;
 720 |   let lastBottomScrollHeight = null;
 721 | 
 722 |   async function updateHardBottomStability() {
 723 |     const m1 = await getScrollMetrics().catch(() => null);
 724 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
 725 | 
 726 |     const atBottom = isHardBottom(m1);
 727 | 
 728 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
 729 | 
 730 |     const m2 = await getScrollMetrics().catch(() => m1);
 731 |     const atBottom2 = isHardBottom(m2);
 732 | 
 733 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
 734 | 
 735 |     const sh = Number(m2?.scrollHeight || 0);
 736 |     const shStable =
 737 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
 738 | 
 739 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
 740 |     else bottomStable = 0;
 741 | 
 742 |     lastBottomScrollHeight = sh;
 743 | 
 744 |     return {
 745 |       atBottom: atBottom && atBottom2,
 746 |       stable: bottomStable,
 747 |       tag: m2?.tag || "UNKNOWN",
 748 |       anyMore,
 749 |       scrollTop: m2?.scrollTop,
 750 |       clientHeight: m2?.clientHeight,
 751 |       scrollHeight: m2?.scrollHeight,
 752 |     };
 753 |   }
 754 | 
 755 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
 756 |   async function waitForEffect(beforeCounts, kind) {
 757 |     const timeout = PACE_CFG.effectWaitMs;
 758 | 
 759 |     const ok = await page
 760 |       .waitForFunction(
 761 |         (root, before, kindArg) => {
 762 |           const scope = root || document;
 763 | 
 764 |           const countUniq = (sel, param) => {
 765 |             const as = Array.from(scope.querySelectorAll(sel));
 766 |             const ids = new Set();
 767 |             for (const a of as) {
 768 |               const href = a.getAttribute("href") || "";
 769 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
 770 |               if (m && m[1]) ids.add(m[1]);
 771 |             }
 772 |             return ids.size;
 773 |           };
 774 | 
 775 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
 776 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
 777 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
 778 | 
 779 |           if (
 780 |             commentsAnchors > (before?.commentsAnchors || 0) ||
 781 |             replyAnchors > (before?.replyAnchors || 0) ||
 782 |             nodes > (before?.nodes || 0)
 783 |           ) {
 784 |             return true;
 785 |           }
 786 | 
 787 |           const norm = (s) =>
 788 |             String(s || "")
 789 |               .replace(/\u00a0/g, " ")
 790 |               .replace(/\s+/g, " ")
 791 |               .trim()
 792 |               .toLowerCase();
 793 | 
 794 |           const isVisible = (el) => {
 795 |             if (!el) return false;
 796 |             const r = el.getBoundingClientRect();
 797 |             if (r.width < 2 || r.height < 2) return false;
 798 |             return r.bottom > 0 && r.top < window.innerHeight;
 799 |           };
 800 | 
 801 |           const nodesBtn = Array.from(
 802 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 803 |           ).filter(isVisible);
 804 | 
 805 |           const stillThere =
 806 |             kindArg === "comments"
 807 |               ? nodesBtn.some((el) => {
 808 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 809 |                   return (
 810 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 811 |                     t.includes("zobacz wiƒôcej komentarzy") ||
 812 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
 813 |                     t.includes("view more comments") ||
 814 |                     t.includes("view previous comments")
 815 |                   );
 816 |                 })
 817 |               : nodesBtn.some((el) => {
 818 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 819 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 820 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 821 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
 822 |                   if (t.includes("view") && t.includes("repl")) return true;
 823 |                   if (t.includes("see") && t.includes("repl")) return true;
 824 |                   return false;
 825 |                 });
 826 | 
 827 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
 828 |           return !stillThere;
 829 |         },
 830 |         { timeout, polling: 120 },
 831 |         rootHandle,
 832 |         beforeCounts,
 833 |         kind
 834 |       )
 835 |       .then(() => true)
 836 |       .catch(() => false);
 837 | 
 838 |     return ok;
 839 |   }
 840 | 
 841 |   async function bonusClicks(kind, beforeCounts) {
 842 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
 843 |     if (!tries) return 0;
 844 | 
 845 |     let clicked = 0;
 846 |     let curBefore = beforeCounts;
 847 | 
 848 |     for (let i = 0; i < tries; i++) {
 849 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
 850 | 
 851 |       const res =
 852 |         kind === "replies"
 853 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
 854 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 855 | 
 856 |       if (!res?.clicked) break;
 857 | 
 858 |       clicked++;
 859 | 
 860 |       // mikro-oddech, potem czekamy na efekt
 861 |       await sleepRandom(80, 140);
 862 |       await waitForEffect(curBefore, kind);
 863 | 
 864 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
 865 |       curBefore = await countAnchors().catch(() => curBefore);
 866 | 
 867 |       // minimalny settle po do≈Çadowaniu
 868 |       await sleepRandom(90, 170);
 869 |     }
 870 | 
 871 |     return clicked;
 872 |   }
 873 | 
 874 |     async function clickOneReplyButton() {
 875 |     const res = await page.evaluate((root) => {
 876 |       const scope = root || document;
 877 | 
 878 |       const norm = (s) =>
 879 |         String(s || "")
 880 |           .replace(/\u00a0/g, " ")
 881 |           .replace(/\s+/g, " ")
 882 |           .trim()
 883 |           .toLowerCase();
 884 | 
 885 |       const isVisible = (el) => {
 886 |         if (!el) return false;
 887 |         try {
 888 |           const r = el.getBoundingClientRect();
 889 |           if (r.width < 2 || r.height < 2) return false;
 890 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
 891 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
 892 |         } catch {
 893 |           return true;
 894 |         }
 895 |       };
 896 | 
 897 |       const isReplyExpanderText = (t) => {
 898 |         if (!t) return false;
 899 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 900 |         if (t.length > 220) return false;
 901 | 
 902 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
 903 |         if (t === "odpowiedz" || t === "reply") return false;
 904 |         if (t.startsWith("odpowiedz ")) return false;
 905 |         if (t.startsWith("reply ")) return false;
 906 | 
 907 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
 908 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 909 | 
 910 |         // warianty opisowe
 911 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 912 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 913 |         if (t.includes("view") && t.includes("repl")) return true;
 914 |         if (t.includes("see") && t.includes("repl")) return true;
 915 | 
 916 |         return false;
 917 |       };
 918 | 
 919 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
 920 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
 921 |       const allTextCandidates = Array.from(
 922 |         scope.querySelectorAll("a,button,div,span")
 923 |       )
 924 |         .filter(isVisible)
 925 |         .slice(0, 35000);
 926 | 
 927 |       let best = null;
 928 |       let bestScore = -Infinity;
 929 | 
 930 |       for (const el of allTextCandidates) {
 931 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
 932 |         const t = norm(tRaw);
 933 |         if (!isReplyExpanderText(t)) continue;
 934 | 
 935 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
 936 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 937 |         if (t.includes("udost") || t.includes("share")) continue;
 938 | 
 939 |         const r = el.getBoundingClientRect();
 940 |         let score = 0;
 941 | 
 942 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
 943 |         score += Math.max(0, r.top);
 944 | 
 945 |         // preferuj te z liczbƒÖ odpowiedzi
 946 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
 947 | 
 948 |         // preferuj ‚Äúwszystkie/all‚Äù
 949 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
 950 | 
 951 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
 952 |         score -= Math.min(500, t.length * 3);
 953 | 
 954 |         if (score > bestScore) {
 955 |           bestScore = score;
 956 |           best = el;
 957 |         }
 958 |       }
 959 | 
 960 |       if (!best) return { clicked: false };
 961 | 
 962 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
 963 |       const clickable =
 964 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
 965 | 
 966 |       try {
 967 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 968 |       } catch {}
 969 | 
 970 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 971 | 
 972 |       const hardClick = (node) => {
 973 |         try {
 974 |           node.click();
 975 |           return true;
 976 |         } catch {}
 977 |         try {
 978 |           const r = node.getBoundingClientRect();
 979 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
 980 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
 981 |           const target = document.elementFromPoint(x, y) || node;
 982 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
 983 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
 984 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
 985 |           return true;
 986 |         } catch {}
 987 |         return false;
 988 |       };
 989 | 
 990 |       const ok = hardClick(clickable);
 991 |       return { clicked: ok, text: txt };
 992 |     }, rootHandle);
 993 | 
 994 |     return res || { clicked: false };
 995 |   }
 996 | 
 997 | 
 998 |   async function clickMoreCommentsButton() {
 999 |     const res = await page.evaluate((root) => {
1000 |       const scope = root || document;
1001 | 
1002 |       const norm = (s) =>
1003 |         String(s || "")
1004 |           .replace(/\u00a0/g, " ")
1005 |           .replace(/\s+/g, " ")
1006 |           .trim()
1007 |           .toLowerCase();
1008 | 
1009 |       const isVisible = (el) => {
1010 |         if (!el) return false;
1011 |         const r = el.getBoundingClientRect();
1012 |         if (r.width < 2 || r.height < 2) return false;
1013 |         return r.bottom > 0 && r.top < window.innerHeight;
1014 |       };
1015 | 
1016 |       const isMore = (t) => {
1017 |         if (!t) return false;
1018 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1019 |         if (t.length > 140) return false;
1020 | 
1021 |         return (
1022 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
1023 |           t.includes("zobacz wiƒôcej komentarzy") ||
1024 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
1025 |           t.includes("view more comments") ||
1026 |           t.includes("view previous comments")
1027 |         );
1028 |       };
1029 | 
1030 |       const candidates = Array.from(
1031 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
1032 |       ).filter(isVisible);
1033 | 
1034 |       let best = null;
1035 |       let bestY = -1;
1036 | 
1037 |       for (const el of candidates) {
1038 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1039 |         if (!isMore(t)) continue;
1040 |         const r = el.getBoundingClientRect();
1041 |         if (r.top > bestY) {
1042 |           bestY = r.top;
1043 |           best = el;
1044 |         }
1045 |       }
1046 | 
1047 |       if (!best) return { clicked: false };
1048 | 
1049 |       try {
1050 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
1051 |       } catch {}
1052 | 
1053 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
1054 | 
1055 |       try {
1056 |         best.click();
1057 |         return { clicked: true, text: txt };
1058 |       } catch {
1059 |         return { clicked: false, text: txt };
1060 |       }
1061 |     }, rootHandle);
1062 | 
1063 |     return res || { clicked: false };
1064 |   }
1065 | 
1066 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
1067 | 
1068 |   async function hasAnyReplyExpanders(page, rootHandle) {
1069 |     return page.evaluate((root) => {
1070 |       const scope = root || document;
1071 | 
1072 |       const norm = (s) =>
1073 |         String(s || "")
1074 |           .replace(/\u00a0/g, " ")
1075 |           .replace(/\s+/g, " ")
1076 |           .trim()
1077 |           .toLowerCase();
1078 | 
1079 |       const isVisible = (el) => {
1080 |         if (!el) return false;
1081 |         try {
1082 |           const r = el.getBoundingClientRect();
1083 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
1084 |         } catch {
1085 |           return true;
1086 |         }
1087 |       };
1088 | 
1089 |       const isReplyExpanderText = (t) => {
1090 |         if (!t) return false;
1091 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1092 |         if (t.length > 220) return false;
1093 | 
1094 |         if (t === "odpowiedz" || t === "reply") return false;
1095 |         if (t.startsWith("odpowiedz ")) return false;
1096 |         if (t.startsWith("reply ")) return false;
1097 | 
1098 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1099 | 
1100 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1101 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
1102 |         if (t.includes("view") && t.includes("repl")) return true;
1103 |         if (t.includes("see") && t.includes("repl")) return true;
1104 | 
1105 |         return false;
1106 |       };
1107 | 
1108 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
1109 | 
1110 |       for (const el of nodes) {
1111 |         if (!isVisible(el)) continue;
1112 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1113 |         if (!t) continue;
1114 | 
1115 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
1116 |         if (t.includes("udost") || t.includes("share")) continue;
1117 | 
1118 |         if (isReplyExpanderText(t)) return true;
1119 |       }
1120 | 
1121 |       return false;
1122 |     }, rootHandle);
1123 |   }
1124 | 
1125 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
1126 |     const res = await page.evaluate(
1127 |       (root, limit) => {
1128 |         const scope = root || document;
1129 | 
1130 |         const norm = (s) =>
1131 |           String(s || "")
1132 |             .replace(/\u00a0/g, " ")
1133 |             .replace(/\s+/g, " ")
1134 |             .trim()
1135 |             .toLowerCase();
1136 | 
1137 |         const isVisible = (el) => {
1138 |           if (!el) return false;
1139 |           try {
1140 |             const r = el.getBoundingClientRect();
1141 |             if (r.width < 2 || r.height < 2) return false;
1142 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
1143 |           } catch {
1144 |             return true;
1145 |           }
1146 |         };
1147 | 
1148 |         const isReplyExpanderText = (t) => {
1149 |           if (!t) return false;
1150 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1151 |           if (t.length > 220) return false;
1152 | 
1153 |           if (t === "odpowiedz" || t === "reply") return false;
1154 |           if (t.startsWith("odpowiedz ")) return false;
1155 |           if (t.startsWith("reply ")) return false;
1156 | 
1157 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1158 | 
1159 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1160 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
1161 |           if (t.includes("view") && t.includes("repl")) return true;
1162 |           if (t.includes("see") && t.includes("repl")) return true;
1163 | 
1164 |           return false;
1165 |         };
1166 | 
1167 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
1168 |           .filter(isVisible)
1169 |           .slice(0, 35000)
1170 |           .map((el) => {
1171 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1172 |             return { el, t };
1173 |           })
1174 |           .filter((x) => {
1175 |             if (!x.t) return false;
1176 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
1177 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
1178 |             return isReplyExpanderText(x.t);
1179 |           });
1180 | 
1181 |         // preferuj elementy ni≈ºej w widoku
1182 |         candidates.sort((a, b) => {
1183 |           const ra = a.el.getBoundingClientRect();
1184 |           const rb = b.el.getBoundingClientRect();
1185 |           return rb.top - ra.top;
1186 |         });
1187 | 
1188 |         const hardClick = (node) => {
1189 |           try {
1190 |             node.click();
1191 |             return true;
1192 |           } catch {}
1193 |           try {
1194 |             const r = node.getBoundingClientRect();
1195 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
1196 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
1197 |             const target = document.elementFromPoint(x, y) || node;
1198 |             target.dispatchEvent(
1199 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
1200 |             );
1201 |             target.dispatchEvent(
1202 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
1203 |             );
1204 |             target.dispatchEvent(
1205 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
1206 |             );
1207 |             return true;
1208 |           } catch {}
1209 |           return false;
1210 |         };
1211 | 
1212 |         let clicked = 0;
1213 |         const sample = [];
1214 | 
1215 |         for (const item of candidates) {
1216 |           if (clicked >= limit) break;
1217 | 
1218 |           const clickable =
1219 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
1220 | 
1221 |           try {
1222 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
1223 |           } catch {}
1224 | 
1225 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
1226 | 
1227 |           const ok = hardClick(clickable);
1228 |           if (ok) {
1229 |             clicked++;
1230 |             if (sample.length < 5) sample.push(txt);
1231 |           }
1232 |         }
1233 | 
1234 |         return { clicked, sample };
1235 |       },
1236 |       rootHandle,
1237 |       maxPerPass
1238 |     );
1239 | 
1240 |     return res || { clicked: 0, sample: [] };
1241 |   }
1242 | 
1243 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
1244 |     await page.evaluate((root, scroller) => {
1245 |       const pick =
1246 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
1247 | 
1248 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
1249 |       else window.scrollTo(0, 0);
1250 |     }, rootHandle, scrollHandle);
1251 |   }
1252 | 
1253 |   async function sweepRepliesTopDown(
1254 |     page,
1255 |     rootHandle,
1256 |     scrollHandle,
1257 |     {
1258 |       maxPasses = 3,
1259 |       stepsPerPass = 40,
1260 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
1261 |       maxClicksPerStep = 12,
1262 |     } = {}
1263 |   ) {
1264 |     let totalClicked = 0;
1265 | 
1266 |     for (let pass = 1; pass <= maxPasses; pass++) {
1267 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
1268 |       await sleepRandom(140, 240);
1269 | 
1270 |       let staleSteps = 0;
1271 | 
1272 |       for (let step = 1; step <= stepsPerPass; step++) {
1273 |         const before = await countAnchors().catch(() => null);
1274 | 
1275 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
1276 |           () => ({ clicked: 0, sample: [] })
1277 |         );
1278 | 
1279 |         if (r.clicked > 0) {
1280 |           totalClicked += r.clicked;
1281 | 
1282 |           if (before) {
1283 |             await sleepRandom(60, 120);
1284 |             await waitForEffect(before, "replies");
1285 |           }
1286 | 
1287 |           await sleepRandom(90, 160);
1288 |           staleSteps = 0;
1289 |         } else {
1290 |           staleSteps++;
1291 |         }
1292 | 
1293 |         const m1 = await getScrollMetrics().catch(() => null);
1294 |         await gentleScrollKick(scrollPx);
1295 |         const m2 = await getScrollMetrics().catch(() => null);
1296 | 
1297 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
1298 | 
1299 |         if (!moved && staleSteps >= 4) break;
1300 |         if (staleSteps >= 8) break;
1301 |       }
1302 | 
1303 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1304 |       if (!any) break;
1305 |     }
1306 | 
1307 |     return totalClicked;
1308 |   }
1309 | 
1310 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
1311 |   let lastLogAt = 0;
1312 |   let lastLogKey = "";
1313 |   const LOG_EVERY_N_STEPS = 6;
1314 |   const LOG_MIN_MS = 800;
1315 |   const shouldLog = (step, key, force = false) => {
1316 |     const now = Date.now();
1317 |     if (force) {
1318 |       lastLogAt = now;
1319 |       lastLogKey = key;
1320 |       return true;
1321 |     }
1322 |     if (step % LOG_EVERY_N_STEPS === 0) {
1323 |       lastLogAt = now;
1324 |       lastLogKey = key;
1325 |       return true;
1326 |     }
1327 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
1328 |       lastLogAt = now;
1329 |       lastLogKey = key;
1330 |       return true;
1331 |     }
1332 |     return false;
1333 |   };
1334 | 
1335 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
1336 |   console.log("[FB][ui:photo] startCounts:", cur);
1337 | 
1338 |   for (let step = 1; step <= MAX_STEPS; step++) {
1339 |     const before = cur;
1340 |     let action = "scroll";
1341 |     let clickInfo = null;
1342 |     let effectOk = false;
1343 |     let bonus = 0;
1344 | 
1345 |     // 1) REPLIES
1346 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
1347 |     if (r1?.clicked) {
1348 |       action = "replies";
1349 |       clickInfo = r1;
1350 | 
1351 |       await sleepRandom(80, 140);
1352 |       effectOk = await waitForEffect(before, "replies");
1353 |       await sleepRandom(90, 170);
1354 | 
1355 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
1356 |       if (effectOk) {
1357 |         bonus = await bonusClicks("replies", before);
1358 |       } else {
1359 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
1360 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1361 |       }
1362 |     } else {
1363 |       // 2) MORE COMMENTS
1364 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
1365 |       if (c1?.clicked) {
1366 |         action = "comments";
1367 |         clickInfo = c1;
1368 | 
1369 |         await sleepRandom(80, 140);
1370 |         effectOk = await waitForEffect(before, "comments");
1371 |         await sleepRandom(90, 170);
1372 | 
1373 |         if (effectOk) {
1374 |           bonus = await bonusClicks("comments", before);
1375 |         } else {
1376 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1377 |         }
1378 |       } else {
1379 |         // 3) SCROLL
1380 |         action = "scroll";
1381 |         await gentleScrollKick(PACE_CFG.scrollPx);
1382 |       }
1383 |     }
1384 | 
1385 |     cur = await countAnchors().catch(() => before);
1386 | 
1387 |     const progressed =
1388 |       cur.commentsAnchors > before.commentsAnchors ||
1389 |       cur.replyAnchors > before.replyAnchors ||
1390 |       cur.nodes > before.nodes;
1391 | 
1392 |     if (!progressed) noProgress++;
1393 |     else noProgress = 0;
1394 | 
1395 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
1396 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
1397 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
1398 |     if (shouldCheckHB) {
1399 |       hb = await updateHardBottomStability().catch(() => ({
1400 |         atBottom: false,
1401 |         stable: bottomStable,
1402 |         tag: "NA",
1403 |         anyMore: true,
1404 |       }));
1405 |     }
1406 | 
1407 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
1408 |     const key =
1409 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
1410 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
1411 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
1412 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
1413 | 
1414 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
1415 |     if (shouldLog(step, key, forceLog)) {
1416 |       console.log(
1417 |         `[FB][ui:photo] step=${step} action=${action} eff=${effectOk ? "OK" : "NO"} bonus=${bonus} ` +
1418 |           `cA ${before.commentsAnchors}->${cur.commentsAnchors} ` +
1419 |           `rA ${before.replyAnchors}->${cur.replyAnchors} ` +
1420 |           `nodes ${before.nodes}->${cur.nodes} ` +
1421 |           `np=${noProgress}/${MAX_NO_PROGRESS} ` +
1422 |           `hb=${hb.atBottom ? "Y" : "N"} stable=${hb.stable}/${PACE_CFG.hardBottomStableNeed} more=${
1423 |             hb.anyMore ? "Y" : "N"
1424 |           } scroller=${hb.tag}` +
1425 |           (clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "")
1426 |       );
1427 |     }
1428 | 
1429 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
1430 |       console.log("[FB][ui:photo] stop: hard-bottom-stable (true bottom reached)");
1431 |       break;
1432 |     }
1433 | 
1434 |     if (noProgress >= MAX_NO_PROGRESS) {
1435 |       console.log("[FB][ui:photo] stop: too many no-progress steps (safety)");
1436 |       break;
1437 |     }
1438 | 
1439 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
1440 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
1441 |   }
1442 | 
1443 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
1444 |   let final = await countAnchors().catch(() => cur);
1445 |   console.log("[FB][ui:photo] done:", final);
1446 | 
1447 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1448 |   if (needSweep) {
1449 |     console.log("[FB][ui:photo] sweep: wykryto jeszcze reply expanders -> odpalam sweep top-down‚Ä¶");
1450 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
1451 |     console.log(`[FB][ui:photo] sweep: clicked=${clicked}`);
1452 |     final = await countAnchors().catch(() => final);
1453 |     console.log("[FB][ui:photo] after sweep:", final);
1454 |   } else {
1455 |     console.log("[FB][ui:photo] sweep: brak reply expanders -> pomijam.");
1456 |   }
1457 | 
1458 |   try {
1459 |     await scrollHandle.dispose?.();
1460 |   } catch {}
1461 |   try {
1462 |     await rootHandle.dispose?.();
1463 |   } catch {}
1464 | }
1465 | 
1466 | /* =====================
1467 |    Analiza za≈Ço≈ºe≈Ñ
1468 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
1469 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
1470 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
1471 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
1472 | 
1473 |    Co powiedzia≈Çby sceptyk?
1474 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
1475 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
1476 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
1477 | 
1478 |    ===================== */
1479 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/14__watch.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/ui/watch.js
  2 | import { safeGoto } from "../../utils/navigation.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { acceptCookies, saveCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | 
  8 | /** Typ handlera UI */
  9 | export const type = "watch";
 10 | 
 11 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
 12 | export function matchesUrl(url) {
 13 |   try {
 14 |     const u = new URL(url);
 15 |     return (u.pathname || "").toLowerCase().includes("/watch");
 16 |   } catch {
 17 |     return String(url || "").toLowerCase().includes("/watch");
 18 |   }
 19 | }
 20 | 
 21 | /* ============================================================
 22 |    ======================= DEBUG HELPERS ======================
 23 |    ============================================================ */
 24 | 
 25 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
 26 | 
 27 | async function safeShot(page, path, clip = null) {
 28 |   if (!DEBUG_WATCH) return;
 29 |   try {
 30 |     const opts = clip ? { path, clip } : { path, fullPage: false };
 31 |     await page.screenshot(opts);
 32 |     console.log(`[FB][ui:watch][DBG] screenshot -> ${path}`);
 33 |   } catch (e) {
 34 |     console.log("[FB][ui:watch][DBG] screenshot failed:", e?.message || e);
 35 |   }
 36 | }
 37 | 
 38 | async function shotElement(page, handle, path) {
 39 |   if (!DEBUG_WATCH) return;
 40 |   try {
 41 |     if (!handle) return;
 42 |     const box = await handle.boundingBox().catch(() => null);
 43 |     if (!box || box.width < 5 || box.height < 5) {
 44 |       console.log("[FB][ui:watch][DBG] shotElement: no bbox");
 45 |       return;
 46 |     }
 47 |     const clip = {
 48 |       x: Math.max(0, box.x),
 49 |       y: Math.max(0, box.y),
 50 |       width: Math.max(1, Math.min(box.width, 1920)),
 51 |       height: Math.max(1, Math.min(box.height, 1080)),
 52 |     };
 53 |     await safeShot(page, path, clip);
 54 |   } catch (e) {
 55 |     console.log("[FB][ui:watch][DBG] shotElement failed:", e?.message || e);
 56 |   }
 57 | }
 58 | 
 59 | async function debugOuterStats(page, outerHandle) {
 60 |   if (!DEBUG_WATCH) return null;
 61 |   if (!outerHandle) return null;
 62 | 
 63 |   return page.evaluate((outer) => {
 64 |     const norm = (s) =>
 65 |       String(s || "")
 66 |         .replace(/\u00a0/g, " ")
 67 |         .replace(/\s+/g, " ")
 68 |         .trim();
 69 | 
 70 |     const r = outer.getBoundingClientRect();
 71 |     const style = getComputedStyle(outer);
 72 | 
 73 |     const anchors = Array.from(
 74 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 75 |     );
 76 | 
 77 |     const allText = (outer.innerText || "").toLowerCase();
 78 |     const moreHits =
 79 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
 80 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
 81 |       (allText.match(/view more comments/g) || []).length +
 82 |       (allText.match(/see more comments/g) || []).length;
 83 | 
 84 |     const labels = [];
 85 |     const nodes = Array.from(
 86 |       outer.querySelectorAll(
 87 |         "button,div[role='button'],span[role='button'],a,abbr,[role='article'],div,span"
 88 |       )
 89 |     ).slice(0, 4000);
 90 | 
 91 |     for (const el of nodes) {
 92 |       const a = el.getAttribute?.("aria-label");
 93 |       const t = norm(a);
 94 |       if (t) labels.push(t);
 95 |     }
 96 | 
 97 |     const freq = new Map();
 98 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
 99 |     const topLabels = Array.from(freq.entries())
100 |       .sort((a, b) => b[1] - a[1])
101 |       .slice(0, 15)
102 |       .map(([k, v]) => ({ label: k, n: v }));
103 | 
104 |     return {
105 |       tag: outer.tagName,
106 |       className: outer.className || "",
107 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
108 |       style: {
109 |         overflowY: style.overflowY,
110 |         position: style.position,
111 |       },
112 |       counts: {
113 |         anchors: anchors.length,
114 |         moreHits,
115 |       },
116 |       topLabels,
117 |     };
118 |   }, outerHandle);
119 | }
120 | 
121 | async function debugScrollerStats(page, scrollerHandle) {
122 |   if (!DEBUG_WATCH) return null;
123 |   if (!scrollerHandle) return null;
124 | 
125 |   return page.evaluate((s) => {
126 |     const r = s.getBoundingClientRect();
127 |     const st = getComputedStyle(s);
128 |     return {
129 |       tag: s.tagName,
130 |       className: s.className || "",
131 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
132 |       style: { overflowY: st.overflowY, overflow: st.overflow },
133 |       scroll: {
134 |         scrollTop: s.scrollTop,
135 |         clientHeight: s.clientHeight,
136 |         scrollHeight: s.scrollHeight,
137 |       },
138 |     };
139 |   }, scrollerHandle);
140 | }
141 | 
142 | /* ============================================================
143 |    ======================= PARSING COUNT =======================
144 |    ============================================================ */
145 | 
146 | function parseCountFromText(str) {
147 |   if (!str) return null;
148 | 
149 |   const raw = String(str)
150 |     .toLowerCase()
151 |     .replace(/\u00a0/g, " ")
152 |     .replace(/\s+/g, " ")
153 |     .trim();
154 | 
155 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
156 |   if (!m) return null;
157 | 
158 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
159 |   const suf = (m[2] || "").trim();
160 | 
161 |   const hasDecimal = /[.,]\d/.test(numStr);
162 |   if (hasDecimal) numStr = numStr.replace(",", ".");
163 |   else numStr = numStr.replace(/[.,]/g, "");
164 | 
165 |   let n = Number(numStr);
166 |   if (!Number.isFinite(n)) return null;
167 | 
168 |   if (suf === "k") n *= 1000;
169 |   if (suf === "tys" || suf === "tys.") n *= 1000;
170 |   if (suf === "m" || suf === "mln") n *= 1000000;
171 | 
172 |   n = Math.round(n);
173 |   if (n <= 0) return null;
174 |   return n;
175 | }
176 | 
177 | function parseBestCommentsCountFromBlob(blobStr) {
178 |   if (!blobStr) return null;
179 | 
180 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
181 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
182 | 
183 |   let best = null;
184 |   let match;
185 |   while ((match = re.exec(raw)) !== null) {
186 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
187 |     const n = parseCountFromText(candidate);
188 |     if (n && (!best || n > best)) best = n;
189 |   }
190 |   return best;
191 | }
192 | 
193 | function pickBestCount(candidates) {
194 |   const nums = candidates.filter((v) => typeof v === "number" && Number.isFinite(v) && v > 0);
195 |   if (!nums.length) return null;
196 | 
197 |   nums.sort((a, b) => b - a);
198 |   const best = nums[0];
199 |   const second = nums[1];
200 | 
201 |   if (second && best >= 2 * second && second < 150) return best;
202 | 
203 |   return best;
204 | }
205 | 
206 | /* ============================================================
207 |    =================== COMMENTS CONTAINER FIND =================
208 |    ============================================================ */
209 | 
210 | /**
211 |  * WATCH FIX:
212 |  * - NIE polegamy na h2 "Komentarze" (czƒôsto go nie ma w Watch).
213 |  * - Szukamy najwiƒôkszego klastra link√≥w comment_id/reply_comment_id na stronie.
214 |  */
215 | async function findCommentsOuter(page) {
216 |   const handle = await page.evaluateHandle(() => {
217 |     const nodes = Array.from(document.querySelectorAll("div, section, main, article")).slice(0, 30000);
218 | 
219 |     const visible = (el) => {
220 |       if (!el) return false;
221 |       const r = el.getBoundingClientRect?.();
222 |       return r && r.width >= 220 && r.height >= 220;
223 |     };
224 | 
225 |     let best = null;
226 |     let bestScore = -1;
227 | 
228 |     for (const el of nodes) {
229 |       if (!visible(el)) continue;
230 | 
231 |       const anchors = el.querySelectorAll?.("a[href*='comment_id'], a[href*='reply_comment_id']");
232 |       const aCount = anchors ? anchors.length : 0;
233 |       if (aCount < 3) continue;
234 | 
235 |       const txt = (el.innerText || "").toLowerCase();
236 |       const hasWords =
237 |         txt.includes("komentarz") || txt.includes("komentarzy") || txt.includes("comments") || txt.includes("comment");
238 | 
239 |       // score: anchor count + bonus za s≈Çowa ‚Äúkomentarz‚Äù
240 |       const score = aCount + (hasWords ? 12 : 0);
241 | 
242 |       if (score > bestScore) {
243 |         bestScore = score;
244 |         best = el;
245 |       }
246 |     }
247 | 
248 |     return best || null;
249 |   });
250 | 
251 |   const el = handle?.asElement?.() || null;
252 |   if (!el) return null;
253 | 
254 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
255 |   return ok ? el : null;
256 | }
257 | 
258 | async function findScrollableInOuter(page, outerHandle) {
259 |   if (!outerHandle) return null;
260 | 
261 |   const scrollerHandle = await page.evaluateHandle((outer) => {
262 |     function isVisible(el) {
263 |       if (!el) return false;
264 |       const r = el.getBoundingClientRect();
265 |       return r.width > 2 && r.height > 2;
266 |     }
267 | 
268 |     function canScroll(el) {
269 |       try {
270 |         if (!el) return false;
271 |         const st = getComputedStyle(el);
272 |         const oy = (st.overflowY || "").toLowerCase();
273 |         if (!(oy === "auto" || oy === "scroll")) return false;
274 |         const h = el.clientHeight || 0;
275 |         const sh = el.scrollHeight || 0;
276 |         return sh > h + 80;
277 |       } catch {
278 |         return false;
279 |       }
280 |     }
281 | 
282 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
283 |       .filter(isVisible)
284 |       .slice(0, 20000);
285 | 
286 |     let best = null;
287 |     let bestScore = -1;
288 | 
289 |     for (const el of nodes) {
290 |       if (!canScroll(el)) continue;
291 | 
292 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
293 |       const txt = (el.innerText || "").toLowerCase();
294 | 
295 |       const hasMore =
296 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
297 |         txt.includes("view more comments") ||
298 |         txt.includes("see more comments") ||
299 |         txt.includes("zobacz wiƒôcej komentarzy") ||
300 |         txt.includes("zobacz wcze≈õniejsze komentarze");
301 | 
302 |       const score = delta + (hasMore ? 100000 : 0);
303 |       if (score > bestScore) {
304 |         bestScore = score;
305 |         best = el;
306 |       }
307 |     }
308 | 
309 |     return best || null;
310 |   }, outerHandle);
311 | 
312 |   const el = scrollerHandle?.asElement?.() || null;
313 |   if (!el) return null;
314 | 
315 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
316 |   return ok ? el : null;
317 | }
318 | 
319 | async function clickMoreCommentsIfPresent(page, outerHandle) {
320 |   if (!outerHandle) return false;
321 | 
322 |   const labels = [
323 |     "wy≈õwietl wiƒôcej komentarzy",
324 |     "zobacz wiƒôcej komentarzy",
325 |     "zobacz wcze≈õniejsze komentarze",
326 |     "view more comments",
327 |     "see more comments",
328 |     "show more comments",
329 |     "view previous comments",
330 |   ];
331 | 
332 |   const clicked = await page.evaluate(
333 |     (outer, labelsArr) => {
334 |       const norm = (s) =>
335 |         String(s || "")
336 |           .replace(/\u00a0/g, " ")
337 |           .replace(/\s+/g, " ")
338 |           .trim()
339 |           .toLowerCase();
340 | 
341 |       const isVisible = (el) => {
342 |         if (!el) return false;
343 |         const r = el.getBoundingClientRect();
344 |         return r.width > 2 && r.height > 2;
345 |       };
346 | 
347 |       const nodes = Array.from(
348 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
349 |       ).filter(isVisible);
350 | 
351 |       for (const el of nodes) {
352 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
353 |         if (!t) continue;
354 |         if (labelsArr.some((x) => t.includes(x))) {
355 |           try {
356 |             el.scrollIntoView({ block: "center" });
357 |           } catch {}
358 |           const clickable =
359 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
360 |           try {
361 |             clickable.click();
362 |             return true;
363 |           } catch {}
364 |         }
365 |       }
366 |       return false;
367 |     },
368 |     outerHandle,
369 |     labels
370 |   );
371 | 
372 |   return !!clicked;
373 | }
374 | 
375 | async function getAnchorsCount(page, outerHandle) {
376 |   if (!outerHandle) return 0;
377 |   return page
378 |     .evaluate((outer) => {
379 |       const as = Array.from(
380 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
381 |       );
382 |       const ids = new Set();
383 |       for (const a of as) {
384 |         try {
385 |           const u = new URL(a.href, location.origin);
386 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
387 |           if (id) ids.add(id);
388 |         } catch {}
389 |       }
390 |       return ids.size;
391 |     }, outerHandle)
392 |     .catch(() => 0);
393 | }
394 | 
395 | async function getCommentRootsCount(page, outerHandle) {
396 |   if (!outerHandle) return 0;
397 |   return page
398 |     .evaluate((outer) => {
399 |       const as = Array.from(
400 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
401 |       );
402 |       const roots = new Set();
403 |       for (const a of as) {
404 |         const root = a.closest?.("[role='article']") || a.closest?.("div");
405 |         if (root) roots.add(root);
406 |       }
407 |       return roots.size;
408 |     }, outerHandle)
409 |     .catch(() => 0);
410 | }
411 | 
412 | /* ============================================================
413 |    ============================ API ============================
414 |    ============================================================ */
415 | 
416 | export async function prepare(page, url) {
417 |   console.log(`[FB][ui:watch] Otwieranie wideo (Watch): ${url}`);
418 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
419 |   if (!ok) throw new Error("safeGoto-failed");
420 | 
421 |   await acceptCookies(page, "watch-initial");
422 | 
423 |   const currentUrl = page.url();
424 |   if (currentUrl.includes("/login")) {
425 |     console.log("[FB][ui:watch] Wymagane logowanie do Facebook ‚Äì logujƒô...");
426 |     await fbLogin(page);
427 |     await sleepRandom(3000, 4500);
428 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
429 |     console.log(
430 |       `[FB][ui:watch] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
431 |     );
432 |     if (loggedAfterLogin) {
433 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
434 |       await acceptCookies(page, "watch-post-login");
435 |     } else {
436 |       console.log("[FB][ui:watch] Logowanie nie powiod≈Ço siƒô ‚Äì kontynuujƒô bez sesji.");
437 |     }
438 |   } else {
439 |     const logged = await checkIfLogged(page).catch(() => false);
440 |     if (!logged) {
441 |       console.log("[FB][ui:watch] Brak sesji ‚Äì fbLogin().");
442 |       await fbLogin(page);
443 |       await sleepRandom(3000, 4500);
444 |       await acceptCookies(page, "watch-after-login");
445 |       const logged2 = await checkIfLogged(page).catch(() => false);
446 |       console.log(`[FB][ui:watch] Stan sesji po fbLogin: ${logged2 ? "ZALOGOWANY" : "NIEZALOGOWANY"}`);
447 |     }
448 |   }
449 | 
450 |   try {
451 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
452 |     if (loggedFinal) await saveCookies(page);
453 |   } catch {}
454 | 
455 |   await acceptCookies(page, "watch");
456 | 
457 |   try {
458 |     await page.evaluate(() => {
459 |       const vids = Array.from(document.querySelectorAll("video"));
460 |       for (const v of vids) {
461 |         try {
462 |           v.autoplay = false;
463 |           v.removeAttribute("autoplay");
464 |           v.muted = true;
465 |           v.pause();
466 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
467 |         } catch {}
468 |       }
469 |     });
470 |     console.log("[FB][ui:watch] Wideo wstrzymane (pause).");
471 |   } catch (e) {
472 |     console.log("[FB][ui:watch] B≈ÇƒÖd wstrzymania wideo:", e?.message || e);
473 |   }
474 | 
475 |   if (DEBUG_WATCH) {
476 |     await safeShot(page, "watch-prepare.png");
477 |   }
478 | }
479 | 
480 | export async function getCommentCount(page, url) {
481 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
482 | 
483 |   const parsedFromUiRaw = uiInfo?.raw ? parseBestCommentsCountFromBlob(uiInfo.raw) : null;
484 | 
485 |   let parsedFromOuter = null;
486 |   const outer = await findCommentsOuter(page).catch(() => null);
487 |   if (outer) {
488 |     parsedFromOuter = await page
489 |       .evaluate((o) => (o.innerText || "").replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim(), outer)
490 |       .then((txt) => parseBestCommentsCountFromBlob(txt))
491 |       .catch(() => null);
492 |   }
493 | 
494 |   const uiDirect =
495 |     uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0 ? uiInfo.comments : null;
496 | 
497 |   const totalComments = pickBestCount([parsedFromOuter, parsedFromUiRaw, uiDirect]);
498 | 
499 |   console.log(`[FB][ui:watch][DBG] count sources:`, {
500 |     ui_source: uiInfo?.source || null,
501 |     ui_viewType: uiInfo?.viewType || null,
502 |     ui_comments: uiDirect,
503 |     parsedFromUiRaw,
504 |     parsedFromOuter,
505 |     picked: totalComments,
506 |   });
507 | 
508 |   let final = totalComments;
509 | 
510 |   console.log(`[FB][ui:watch] Liczba komentarzy wg UI: ${final !== null ? final : "brak danych"}`);
511 |   return final;
512 | }
513 | 
514 | export async function loadAllComments(page, { expectedTotal } = {}) {
515 |   console.log("[FB][ui:watch] ≈Åadujƒô wszystkie komentarze (Watch)...");
516 | 
517 |   let maxCycles = 40;
518 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
519 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
520 |   }
521 |   console.log(`[FB][ui:watch] Rozpoczynam sekwencyjne ≈Çadowanie komentarzy, maxCycles=${maxCycles}.`);
522 | 
523 |   const outer = await findCommentsOuter(page);
524 |   if (!outer) {
525 |     console.log("[FB][ui:watch][DBG] OUTER NOT FOUND -> return");
526 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
527 |     return;
528 |   }
529 | 
530 |   if (DEBUG_WATCH) {
531 |     const stats = await debugOuterStats(page, outer);
532 |     console.log("[FB][ui:watch][DBG] OUTER stats:", stats);
533 |     await shotElement(page, outer, "watch-outer.png");
534 |   }
535 | 
536 |   const scroller = await findScrollableInOuter(page, outer);
537 | 
538 |   if (DEBUG_WATCH) {
539 |     if (scroller) {
540 |       const sstats = await debugScrollerStats(page, scroller);
541 |       console.log("[FB][ui:watch][DBG] SCROLLER stats:", sstats);
542 |       await shotElement(page, scroller, "watch-scroller.png");
543 |     } else {
544 |       console.log("[FB][ui:watch][DBG] SCROLLER NOT FOUND -> fallback: window scroll");
545 |       await safeShot(page, "watch-no-scroller.png");
546 |     }
547 |   }
548 | 
549 |   let prevAnchors = await getAnchorsCount(page, outer);
550 |   let prevRoots = await getCommentRootsCount(page, outer);
551 |   let noProgress = 0;
552 | 
553 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
554 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
555 | 
556 |     let wheeled = false;
557 |     let beforeST = 0;
558 |     let afterST = 0;
559 | 
560 |     if (scroller) {
561 |       try {
562 |         beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
563 |       } catch {}
564 | 
565 |       try {
566 |         const box = await scroller.boundingBox();
567 |         if (box && box.width > 5 && box.height > 5) {
568 |           await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
569 |           await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
570 |           wheeled = true;
571 |         }
572 |       } catch {}
573 | 
574 |       await sleepRandom(450, 850);
575 | 
576 |       try {
577 |         afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
578 |       } catch {}
579 |     } else {
580 |       try {
581 |         beforeST = await page.evaluate(() => {
582 |           const el = document.scrollingElement || document.documentElement;
583 |           return el ? el.scrollTop || 0 : 0;
584 |         });
585 |       } catch {}
586 |       try {
587 |         await page.mouse.wheel({ deltaY: 900 });
588 |         wheeled = true;
589 |       } catch {}
590 |       await sleepRandom(450, 850);
591 |       try {
592 |         afterST = await page.evaluate(() => {
593 |           const el = document.scrollingElement || document.documentElement;
594 |           return el ? el.scrollTop || 0 : 0;
595 |         });
596 |       } catch {}
597 |     }
598 | 
599 |     const curAnchors = await getAnchorsCount(page, outer);
600 |     const curRoots = await getCommentRootsCount(page, outer);
601 | 
602 |     const progressed = curAnchors > prevAnchors || curRoots > prevRoots;
603 | 
604 |     if (progressed) {
605 |       prevAnchors = curAnchors;
606 |       prevRoots = curRoots;
607 |       noProgress = 0;
608 |     } else {
609 |       noProgress++;
610 |     }
611 | 
612 |     console.log(
613 |       `[FB][ui:watch][DBG] cycle ${cycle}/${maxCycles}: clickedMore=${clicked}, wheel=${wheeled}, scrollTop ${beforeST} -> ${afterST}, roots=${curRoots}, anchors=${curAnchors}, noProgress=${noProgress}`
614 |     );
615 | 
616 |     if (DEBUG_WATCH && cycle === 5) {
617 |       await safeShot(page, "watch-after-5.png");
618 |     }
619 | 
620 |     if (noProgress >= 8) {
621 |       console.log("[FB][ui:watch] Brak postƒôpu przez kilka cykli ‚Äì przerywam.");
622 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
623 |       break;
624 |     }
625 |   }
626 | 
627 |   console.log("[FB][ui:watch] Za≈Çadowano wszystkie dostƒôpne komentarze (Watch).");
628 | }
629 | 
630 | export async function extractComments(page, url) {
631 |   const outer = await findCommentsOuter(page).catch(() => null);
632 |   if (!outer) {
633 |     console.log("[FB][ui:watch][DBG] extractComments: OUTER NOT FOUND");
634 |     if (DEBUG_WATCH) await safeShot(page, "watch-extract-no-outer.png");
635 |     return [];
636 |   }
637 | 
638 |   const comments = await page.evaluate((outerEl) => {
639 |     function norm(s) {
640 |       return String(s || "")
641 |         .replace(/\u00a0/g, " ")
642 |         .replace(/\s+/g, " ")
643 |         .trim();
644 |     }
645 | 
646 |     function toAbsHref(href) {
647 |       if (!href) return null;
648 |       if (href.startsWith("http")) return href;
649 |       if (href.startsWith("/")) return `${location.origin}${href}`;
650 |       return href;
651 |     }
652 | 
653 |     function getCommentId(href) {
654 |       try {
655 |         const u = new URL(href, location.origin);
656 |         return u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
657 |       } catch {
658 |         return null;
659 |       }
660 |     }
661 | 
662 |     function normalizeTime(text) {
663 |       if (!text) return null;
664 | 
665 |       const t = norm(text).toLowerCase();
666 |       if (!t) return null;
667 | 
668 |       if (t.includes("przed chwilƒÖ")) return "0 min";
669 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
670 |       if (t.includes("wczoraj") || t.includes("yesterday")) return "wczoraj";
671 | 
672 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
673 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô)\b/.test(t)) return t;
674 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
675 |       if (/^\d+\s*(dzie≈Ñ|dni|d)\b/.test(t)) return t;
676 |       if (/^\d+\s*(tyg|tyg\.|week|weeks)\b/.test(t)) return t;
677 | 
678 |       return null;
679 |     }
680 | 
681 |     function findTimeInRoot(root) {
682 |       if (!root) return null;
683 | 
684 |       const els = Array.from(root.querySelectorAll("abbr, a, span")).slice(0, 250);
685 |       for (const el of els) {
686 |         const aria = el.getAttribute?.("aria-label");
687 |         const t1 = normalizeTime(aria);
688 |         if (t1) return t1;
689 | 
690 |         const title = el.getAttribute?.("title");
691 |         const t2 = normalizeTime(title);
692 |         if (t2) return t2;
693 | 
694 |         const txt = el.textContent;
695 |         const t3 = normalizeTime(txt);
696 |         if (t3) return t3;
697 |       }
698 |       return null;
699 |     }
700 | 
701 |     const anchors = Array.from(
702 |       outerEl.querySelectorAll("a[href*='comment_id='], a[href*='reply_comment_id=']")
703 |     );
704 | 
705 |     const seenRoots = new Set();
706 |     const out = [];
707 | 
708 |     for (const a of anchors) {
709 |       const href = a.getAttribute("href") || a.href || null;
710 |       const absHref = toAbsHref(href);
711 | 
712 |       const id = absHref ? getCommentId(absHref) : null;
713 |       if (!id) continue;
714 | 
715 |       const root = a.closest?.("[role='article']") || a.closest?.("div") || null;
716 |       if (!root) continue;
717 |       if (seenRoots.has(root)) continue;
718 |       seenRoots.add(root);
719 | 
720 |       const author =
721 |         norm(root.querySelector("a[role='link'] span")?.textContent) ||
722 |         norm(root.querySelector("strong")?.textContent) ||
723 |         null;
724 | 
725 |       const autos = Array.from(root.querySelectorAll("[dir='auto']"))
726 |         .map((el) => norm(el.textContent))
727 |         .filter(Boolean);
728 | 
729 |       let text = "";
730 |       if (autos.length) text = autos[autos.length - 1];
731 | 
732 |       const time = findTimeInRoot(root);
733 | 
734 |       if (!author && !text) continue;
735 | 
736 |       out.push({
737 |         id,
738 |         author,
739 |         text,
740 |         permalink: absHref,
741 |         time: time || null,
742 |       });
743 |     }
744 | 
745 |     return out;
746 |   }, outer);
747 | 
748 |   console.log(`[FB][ui:watch] Wyekstrahowano komentarzy: ${comments.length}`);
749 |   return comments;
750 | }
751 | 
752 | export async function debugSnapshot(page) {
753 |   try {
754 |     const path = `snapshot-watch.png`;
755 |     await page.screenshot({ path });
756 |     console.log(`[FB][ui:watch] Zapisano zrzut ekranu: ${path}`);
757 |   } catch (e) {
758 |     console.error("[FB][ui:watch] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
759 |   }
760 | }
761 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/15__videos.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | import { safeGoto } from "../../utils/navigation.js";
  2 | import { sleepRandom } from "../../utils/sleep.js";
  3 | import { acceptCookies } from "../cookies.js";
  4 | import { fbLogin, checkIfLogged } from "../login.js";
  5 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  6 | 
  7 | /** Typ handlera UI */
  8 | export const type = "videos";
  9 | 
 10 | export function matchesUrl(url) {
 11 |   const lower = (url || "").toLowerCase();
 12 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
 13 | }
 14 | 
 15 | export async function prepare(page, url) {
 16 |   console.log(`[FB][ui:videos] Otwieranie posta wideo: ${url}`);
 17 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 18 |   if (!ok) throw new Error("safeGoto-failed");
 19 | 
 20 |   const currentUrl = page.url();
 21 |   if (currentUrl.includes("/login")) {
 22 |     console.log("[FB][ui:videos] Wymagane logowanie ‚Äì pr√≥bujƒô zalogowaƒá.");
 23 |     await fbLogin(page);
 24 |     await sleepRandom(3000, 4500);
 25 | 
 26 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 27 |     console.log(
 28 |       `[FB][ui:videos] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
 29 |     );
 30 | 
 31 |     if (loggedAfterLogin) {
 32 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 33 |     } else {
 34 |       console.log("[FB][ui:videos] Logowanie nieudane ‚Äì kontynuacja bez sesji.");
 35 |     }
 36 |   }
 37 | 
 38 |   await acceptCookies(page, "videos");
 39 | 
 40 |   // stop autoplay
 41 |   try {
 42 |     await page.evaluate(() => {
 43 |       const vids = Array.from(document.querySelectorAll("video"));
 44 |       for (const v of vids) {
 45 |         try {
 46 |           v.autoplay = false;
 47 |           v.removeAttribute("autoplay");
 48 |           v.muted = true;
 49 |           v.pause();
 50 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
 51 |         } catch {}
 52 |       }
 53 |     });
 54 |     console.log("[FB][ui:videos] Wideo wstrzymane (autoplay wy≈ÇƒÖczony).");
 55 |   } catch (e) {
 56 |     console.log("[FB][ui:videos] B≈ÇƒÖd zatrzymania wideo:", e?.message || e);
 57 |   }
 58 | }
 59 | 
 60 | export async function getCommentCount(page, url) {
 61 |   const uiInfo = await getUiCommentInfo(page);
 62 |   console.log(`[FB][ui:videos][DBG] UI info:`, {
 63 |     source: uiInfo?.source,
 64 |     raw: uiInfo?.raw,
 65 |     viewType: uiInfo?.viewType,
 66 |     comments: uiInfo?.comments,
 67 |   });
 68 | 
 69 |   let totalComments = null;
 70 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
 71 | 
 72 |   console.log(
 73 |     `[FB][ui:videos] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`
 74 |   );
 75 |   return totalComments;
 76 | }
 77 | 
 78 | /* ==============================
 79 |    ======= DEBUG HELPERS ========
 80 |    ============================== */
 81 | 
 82 | function shortenHtml(html, max = 220) {
 83 |   if (!html) return null;
 84 |   const s = String(html).replace(/\s+/g, " ").trim();
 85 |   if (s.length <= max) return s;
 86 |   return s.slice(0, max) + "‚Ä¶";
 87 | }
 88 | 
 89 | async function debugDumpShowAllCandidates(page) {
 90 |   const out = await page.evaluate(() => {
 91 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
 92 |     function pick(el) {
 93 |       if (!el) return null;
 94 |       const r = el.getBoundingClientRect();
 95 |       return {
 96 |         tag: el.tagName,
 97 |         role: el.getAttribute("role"),
 98 |         aria: el.getAttribute("aria-label"),
 99 |         text: norm(el.textContent),
100 |         top: Math.round(r.top),
101 |         left: Math.round(r.left),
102 |         w: Math.round(r.width),
103 |         h: Math.round(r.height),
104 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
105 |       };
106 |     }
107 | 
108 |     const headers = Array.from(document.querySelectorAll("span"))
109 |       .filter((s) => {
110 |         const t = norm(s.textContent).toLowerCase();
111 |         return t === "komentarze" || t === "comments";
112 |       })
113 |       .slice(0, 5)
114 |       .map(pick);
115 | 
116 |     const showAll = Array.from(
117 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
118 |     )
119 |       .filter((el) => {
120 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
121 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
122 |       })
123 |       .slice(0, 20)
124 |       .map(pick);
125 | 
126 |     return { headers, showAll };
127 |   });
128 | 
129 |   console.log("[FB][ui:videos][DBG] candidates:", JSON.stringify(out, null, 2));
130 | }
131 | 
132 | /* ==========================================
133 |    ======= COMMENTS SCOPE / MARKERS =========
134 |    ========================================== */
135 | 
136 | async function markCommentsScope(page) {
137 |   return await page.evaluate(() => {
138 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
139 | 
140 |     function isVisible(el) {
141 |       if (!el) return false;
142 |       const st = getComputedStyle(el);
143 |       if (st.display === "none" || st.visibility === "hidden") return false;
144 |       const r = el.getBoundingClientRect();
145 |       return !!r && r.width > 5 && r.height > 5;
146 |     }
147 | 
148 |     function pick(el) {
149 |       if (!el) return null;
150 |       const r = el.getBoundingClientRect();
151 |       return {
152 |         tag: el.tagName,
153 |         role: el.getAttribute("role"),
154 |         aria: el.getAttribute("aria-label"),
155 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
156 |         top: Math.round(r.top),
157 |         left: Math.round(r.left),
158 |         w: Math.round(r.width),
159 |         h: Math.round(r.height),
160 |       };
161 |     }
162 | 
163 |     // clear markers
164 |     try {
165 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
166 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
167 |         n.removeAttribute("data-fbw-comments-header-row")
168 |       );
169 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
170 |         n.removeAttribute("data-fbw-comments-anchor")
171 |       );
172 |     } catch {}
173 | 
174 |     // find header
175 |     const headerSpans = Array.from(document.querySelectorAll("span"))
176 |       .filter(isVisible)
177 |       .filter((el) => {
178 |         const t = norm(el.textContent);
179 |         return t === "komentarze" || t === "comments";
180 |       });
181 | 
182 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
183 | 
184 |     // pick first visible header and mark a "root" around it
185 |     const h = headerSpans[0];
186 | 
187 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
188 |     let row = h.parentElement;
189 |     let foundRow = null;
190 | 
191 |     for (let up = 0; up < 14 && row; up++) {
192 |       const btns = Array.from(
193 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
194 |       ).filter(isVisible);
195 | 
196 |       const ok = btns.some((b) => {
197 |         const al = norm(b.getAttribute("aria-label"));
198 |         return (
199 |           al === "poka≈º wszystkie" ||
200 |           al === "wy≈õwietl wszystkie" ||
201 |           al === "show all" ||
202 |           al === "view all" ||
203 |           al === "ukryj komentarze" ||
204 |           al === "hide comments"
205 |         );
206 |       });
207 | 
208 |       if (ok) {
209 |         foundRow = row;
210 |         break;
211 |       }
212 |       row = row.parentElement;
213 |     }
214 | 
215 |     if (foundRow) {
216 |       try {
217 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
218 |       } catch {}
219 |     }
220 | 
221 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
222 |     let root = h.parentElement;
223 |     let best = null;
224 | 
225 |     for (let up = 0; up < 26 && root; up++) {
226 |       const txt = norm(root.innerText || "");
227 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
228 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
229 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
230 |       const isBigEnough = (root.clientHeight || 0) > 250;
231 | 
232 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
233 |         best = root;
234 |         break;
235 |       }
236 |       root = root.parentElement;
237 |     }
238 | 
239 |     // fallback: use header row parent
240 |     if (!best && foundRow) best = foundRow.parentElement;
241 |     if (!best) best = document.body;
242 | 
243 |     try {
244 |       best.setAttribute("data-fbw-comments-root", "1");
245 |     } catch {}
246 | 
247 |     // anchor element for scroll targeting: header span itself
248 |     try {
249 |       h.setAttribute("data-fbw-comments-anchor", "1");
250 |     } catch {}
251 | 
252 |     return {
253 |       ok: true,
254 |       reason: "marked",
255 |       header: pick(h),
256 |       row: foundRow ? pick(foundRow) : null,
257 |       root: pick(best),
258 |     };
259 |   });
260 | }
261 | 
262 | async function clickShowAllFromMarkedRow(page) {
263 |   const res = await page.evaluate(() => {
264 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
265 | 
266 |     function isVisible(el) {
267 |       if (!el) return false;
268 |       const st = getComputedStyle(el);
269 |       if (st.display === "none" || st.visibility === "hidden") return false;
270 |       const r = el.getBoundingClientRect();
271 |       return !!r && r.width > 5 && r.height > 5;
272 |     }
273 | 
274 |     function pick(el) {
275 |       if (!el) return null;
276 |       const r = el.getBoundingClientRect();
277 |       return {
278 |         tag: el.tagName,
279 |         role: el.getAttribute("role"),
280 |         aria: el.getAttribute("aria-label"),
281 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
282 |         top: Math.round(r.top),
283 |         left: Math.round(r.left),
284 |         w: Math.round(r.width),
285 |         h: Math.round(r.height),
286 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
287 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
288 |       };
289 |     }
290 | 
291 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
292 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
293 | 
294 |     const candidates = Array.from(
295 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
296 |     ).filter(isVisible);
297 | 
298 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
299 |     for (const c of candidates) {
300 |       const al = norm(c.getAttribute("aria-label"));
301 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
302 |         try {
303 |           c.scrollIntoView({ block: "center", inline: "nearest" });
304 |         } catch {}
305 |         try {
306 |           c.click();
307 |         } catch {}
308 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
309 |       }
310 |     }
311 | 
312 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
313 |   });
314 | 
315 |   console.log("[FB][ui:videos][DBG] show-all click:", JSON.stringify(res, null, 2));
316 |   return !!res?.clicked;
317 | }
318 | 
319 | /* ==========================================
320 |    ======= FILTER/SORT (Najtrafniejsze) ======
321 |    ========================================== */
322 | 
323 | async function ensureAllCommentsFilter(page) {
324 |   const res = await page.evaluate(() => {
325 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
326 | 
327 |     function isVisible(el) {
328 |       if (!el) return false;
329 |       const st = getComputedStyle(el);
330 |       if (st.display === "none" || st.visibility === "hidden") return false;
331 |       const r = el.getBoundingClientRect();
332 |       return !!r && r.width > 5 && r.height > 5;
333 |     }
334 | 
335 |     function pick(el) {
336 |       if (!el) return null;
337 |       const r = el.getBoundingClientRect();
338 |       return {
339 |         tag: el.tagName,
340 |         role: el.getAttribute("role"),
341 |         aria: el.getAttribute("aria-label"),
342 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
343 |         top: Math.round(r.top),
344 |         left: Math.round(r.left),
345 |         w: Math.round(r.width),
346 |         h: Math.round(r.height),
347 |       };
348 |     }
349 | 
350 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
351 | 
352 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
353 |     const rootTxt = norm(root.innerText || "");
354 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
355 |       return { ok: true, action: "already-all", dbg: null };
356 |     }
357 | 
358 |     // find the sort dropdown button in root
359 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
360 | 
361 |     const sortBtn = btns.find((b) => {
362 |       const t = norm(b.textContent);
363 |       return (
364 |         t === "najtrafniejsze" ||
365 |         t === "most relevant" ||
366 |         t === "top comments" ||
367 |         t === "najlepsze" ||
368 |         t === "newest" ||
369 |         t === "najnowsze"
370 |       );
371 |     });
372 | 
373 |     if (!sortBtn) {
374 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
375 |     }
376 | 
377 |     try {
378 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
379 |     } catch {}
380 |     try {
381 |       sortBtn.click();
382 |     } catch {}
383 | 
384 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
385 |   });
386 | 
387 |   console.log("[FB][ui:videos][DBG] filter step#1:", JSON.stringify(res, null, 2));
388 | 
389 |   if (!res?.ok || res.action !== "opened-menu") return false;
390 | 
391 |   await sleepRandom(400, 700);
392 | 
393 |   const res2 = await page.evaluate(() => {
394 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
395 | 
396 |     function isVisible(el) {
397 |       if (!el) return false;
398 |       const st = getComputedStyle(el);
399 |       if (st.display === "none" || st.visibility === "hidden") return false;
400 |       const r = el.getBoundingClientRect();
401 |       return !!r && r.width > 5 && r.height > 5;
402 |     }
403 | 
404 |     function pick(el) {
405 |       if (!el) return null;
406 |       const r = el.getBoundingClientRect();
407 |       return {
408 |         tag: el.tagName,
409 |         role: el.getAttribute("role"),
410 |         aria: el.getAttribute("aria-label"),
411 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
412 |         top: Math.round(r.top),
413 |         left: Math.round(r.left),
414 |         w: Math.round(r.width),
415 |         h: Math.round(r.height),
416 |       };
417 |     }
418 | 
419 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
420 | 
421 |     if (!menu) return { ok: false, action: "no-menu" };
422 | 
423 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
424 |       .filter(isVisible)
425 |       .slice(0, 200);
426 | 
427 |     // Prefer: "Wszystkie komentarze" / "All comments"
428 |     let target =
429 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
430 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
431 | 
432 |     // Fallback: "Najnowsze" / "Newest"
433 |     if (!target) {
434 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
435 |     }
436 | 
437 |     if (!target) {
438 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
439 |     }
440 | 
441 |     try {
442 |       target.scrollIntoView({ block: "center", inline: "nearest" });
443 |     } catch {}
444 |     try {
445 |       target.click();
446 |     } catch {}
447 | 
448 |     // close menu
449 |     try {
450 |       setTimeout(() => document.body.click(), 40);
451 |     } catch {}
452 | 
453 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
454 |   });
455 | 
456 |   console.log("[FB][ui:videos][DBG] filter step#2:", JSON.stringify(res2, null, 2));
457 | 
458 |   await sleepRandom(500, 900);
459 | 
460 |   return !!res2?.ok;
461 | }
462 | 
463 | /* ==========================================
464 |    ======= SEQUENTIAL ACTION LOOP ============
465 |    ========================================== */
466 | 
467 | async function oneSequentialAction(page) {
468 |   const res = await page.evaluate(() => {
469 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
470 | 
471 |     function isVisible(el) {
472 |       if (!el) return false;
473 |       const st = getComputedStyle(el);
474 |       if (st.display === "none" || st.visibility === "hidden") return false;
475 |       const r = el.getBoundingClientRect();
476 |       return !!r && r.width > 5 && r.height > 5;
477 |     }
478 | 
479 |     function pick(el) {
480 |       if (!el) return null;
481 |       const r = el.getBoundingClientRect();
482 |       return {
483 |         tag: el.tagName,
484 |         role: el.getAttribute("role"),
485 |         aria: el.getAttribute("aria-label"),
486 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
487 |         top: Math.round(r.top),
488 |         left: Math.round(r.left),
489 |         w: Math.round(r.width),
490 |         h: Math.round(r.height),
491 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
492 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
493 |       };
494 |     }
495 | 
496 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
497 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
498 | 
499 |     const composer =
500 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
501 |       root.querySelector("[aria-label^='Write a comment']") ||
502 |       root.querySelector("[role='textbox'][contenteditable='true']");
503 | 
504 |     let scope = root;
505 |     if (composer) {
506 |       let p = composer.parentElement;
507 |       for (let up = 0; up < 14 && p; up++) {
508 |         const bigEnough = (p.clientHeight || 0) > 220;
509 |         const t = norm(p.innerText || "");
510 |         const looksCommenty =
511 |           t.includes("najtrafniejsze") ||
512 |           t.includes("most relevant") ||
513 |           t.includes("wszystkie komentarze") ||
514 |           t.includes("all comments") ||
515 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
516 |           t.includes("view more comments");
517 |         if (bigEnough && looksCommenty) {
518 |           scope = p;
519 |           break;
520 |         }
521 |         p = p.parentElement;
522 |       }
523 |     }
524 | 
525 |     // UWAGA: klikamy TYLKO elementy klikalne
526 |     const clickables = Array.from(
527 |       scope.querySelectorAll(
528 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
529 |       )
530 |     )
531 |       .filter(isVisible)
532 |       .slice(0, 12000);
533 | 
534 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
535 | 
536 |     const moreCommentNeedles = [
537 |       "wy≈õwietl wiƒôcej komentarzy",
538 |       "zobacz wiƒôcej komentarzy",
539 |       "view more comments",
540 |       "view previous comments",
541 |       "see more comments",
542 |     ];
543 | 
544 |     // 1) MORE COMMENTS ‚Äì tylko clickables
545 |     for (const el of clickables) {
546 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
547 |       if (!t) continue;
548 |       if (bannedExact.has(t)) continue;
549 | 
550 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
551 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
552 |         try { el.click(); } catch {}
553 |         return { acted: true, action: "more-comments", dbg: pick(el) };
554 |       }
555 |     }
556 | 
557 |     // 2) REPLIES ‚Äì tylko clickables
558 |     for (const el of clickables) {
559 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
560 |       if (!t) continue;
561 |       if (bannedExact.has(t)) continue;
562 | 
563 |       const isReply =
564 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
565 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
566 |         t.includes("view more replies") ||
567 |         t.includes("see more replies") ||
568 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
569 | 
570 |       if (isReply) {
571 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
572 |         try { el.click(); } catch {}
573 |         return { acted: true, action: "replies", dbg: pick(el) };
574 |       }
575 |     }
576 | 
577 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
578 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
579 | 
580 |     const beforeScope = scope.scrollTop || 0;
581 |     try {
582 |       if (scope && typeof scope.scrollTop === "number") {
583 |         scope.scrollTop = beforeScope + step;
584 |         const afterScope = scope.scrollTop || beforeScope;
585 |         if (afterScope > beforeScope) {
586 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
587 |         }
588 |       }
589 |     } catch {}
590 | 
591 |     const beforeWin = window.scrollY || 0;
592 |     window.scrollBy(0, step);
593 |     const afterWin = window.scrollY || 0;
594 | 
595 |     return {
596 |       acted: afterWin > beforeWin,
597 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
598 |       dbg: { beforeWin, afterWin, step },
599 |     };
600 |   });
601 | 
602 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
603 |   console.log("[FB][ui:videos][DBG] step:", JSON.stringify(res, null, 2));
604 |   return res || { acted: false, action: "none", dbg: null };
605 | }
606 | 
607 | 
608 | 
609 | /**
610 |  * Wczytuje wszystkie komentarze dla posta wideo.
611 |  */
612 | export async function loadAllComments(page, { expectedTotal } = {}) {
613 |   console.log("[FB][ui:videos] ≈Åadujƒô wszystkie komentarze (VIDEOS)...");
614 | 
615 |   await debugDumpShowAllCandidates(page).catch(() => {});
616 | 
617 |   const mark1 = await markCommentsScope(page).catch(() => null);
618 |   console.log("[FB][ui:videos][DBG] mark#1:", JSON.stringify(mark1, null, 2));
619 | 
620 |   await sleepRandom(250, 500);
621 | 
622 |   // klik show-all z header-row
623 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
624 |   if (clickedAll) {
625 |     await sleepRandom(900, 1400);
626 |     const mark2 = await markCommentsScope(page).catch(() => null);
627 |     console.log("[FB][ui:videos][DBG] mark#2:", JSON.stringify(mark2, null, 2));
628 |   } else {
629 |     console.log("[FB][ui:videos] show-all: nie klikniƒôto (patrz DBG wy≈ºej).");
630 |   }
631 | 
632 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
633 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
634 |   console.log("[FB][ui:videos] filter ensure:", filterOk);
635 | 
636 |   // policz cykle dynamicznie
637 |   let maxCycles = 180;
638 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
639 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
640 |   }
641 | 
642 |   let noProgress = 0;
643 | 
644 |   for (let i = 1; i <= maxCycles; i++) {
645 |     // jedna akcja na cykl
646 |     const r = await oneSequentialAction(page);
647 | 
648 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
649 |     if (!didProgress) noProgress++;
650 |     else noProgress = 0;
651 | 
652 |     console.log(
653 |       `[FB][ui:videos] cycle ${i}/${maxCycles} action=${r?.action} acted=${!!r?.acted} noProgress=${noProgress}`
654 |     );
655 | 
656 |     if (noProgress >= 10) {
657 |       console.log("[FB][ui:videos] Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie.");
658 |       break;
659 |     }
660 | 
661 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
662 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
663 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
664 |     else await sleepRandom(450, 850);
665 |   }
666 | 
667 |   console.log("[FB][ui:videos] Komentarze wideo za≈Çadowane.");
668 | }
669 | 
670 | /**
671 |  * Ekstrahuje komentarze z posta wideo.
672 |  */
673 | export async function extractComments(page, url) {
674 |   const comments = await page.evaluate(() => {
675 |     function getCommentId(href) {
676 |       try {
677 |         const u = new URL(href, location.origin);
678 |         const cid = u.searchParams.get("comment_id");
679 |         const rid = u.searchParams.get("reply_comment_id");
680 |         return rid || cid;
681 |       } catch {
682 |         return null;
683 |       }
684 |     }
685 | 
686 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
687 |     const idToTime = {};
688 | 
689 |     for (let i = 0; i < allLinks.length; i++) {
690 |       const id = getCommentId(allLinks[i].href || "");
691 |       if (id) {
692 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
693 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
694 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
695 |             idToTime[id] = txt;
696 |             break;
697 |           }
698 |         }
699 |       }
700 |     }
701 | 
702 |     const commentBlocks = Array.from(
703 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
704 |     );
705 | 
706 |     const data = commentBlocks
707 |       .map((node) => {
708 |         try {
709 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
710 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
711 |           const linkEl = node.querySelector('a[role="link"]');
712 |           const href = linkEl?.getAttribute("href");
713 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
714 |           const id = permalink ? getCommentId(permalink) : null;
715 |           const time = id && idToTime[id] ? idToTime[id] : null;
716 | 
717 |           if (!author && !text) return null;
718 |           return { id, author, text, permalink, time };
719 |         } catch {
720 |           return null;
721 |         }
722 |       })
723 |       .filter(Boolean);
724 | 
725 |     return data;
726 |   });
727 | 
728 |   console.log(`[FB][ui:videos] Wyekstrahowano komentarzy: ${comments.length}`);
729 |   return comments;
730 | }
731 | 
732 | export async function debugSnapshot(page) {
733 |   try {
734 |     const path = `snapshot-videos.png`;
735 |     await page.screenshot({ path });
736 |     console.log(`[FB][ui:videos] Zapisano zrzut ekranu: ${path}`);
737 |   } catch (e) {
738 |     console.error("[FB][ui:videos] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
739 |   }
740 | }
741 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/16__navigation.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // src/utils/navigation.js
 2 | import { sleepRandom } from "./sleep.js";
 3 | 
 4 | /**
 5 |  * Bezpieczne page.goto z retry.
 6 |  * - pr√≥buje kilka razy
 7 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
 8 |  */
 9 | export async function safeGoto(page, url, label = "goto", options = {}) {
10 |   const MAX_ATTEMPTS = 3;
11 | 
12 |   const finalOptions = {
13 |     waitUntil: "networkidle2",
14 |     timeout: 90000, // 90s
15 |     ...options,
16 |   };
17 | 
18 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
19 |     try {
20 |       console.log(
21 |         `[NAV] (${label}) pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`
22 |       );
23 | 
24 |   // === FORCE DESKTOP PROFILE (SERVER FIX) ===
25 |   await page.setViewport({ width: 1366, height: 768 });
26 | // DISABLED UA // === END FORCE DESKTOP PROFILE ===
27 | 
28 |       await page.goto(url, finalOptions);
29 | 
30 |       console.log(`[NAV] (${label}) OK na pr√≥bie ${attempt}`);
31 |       return true;
32 |     } catch (err) {
33 |       console.error(
34 |         `[NAV] (${label}) b≈ÇƒÖd na pr√≥bie ${attempt}:`,
35 |         err.message
36 |       );
37 | 
38 |       if (attempt === MAX_ATTEMPTS) {
39 |         // sygna≈Ç dla wy≈ºej: to ju≈º nie jest chwilowy lag
40 |         return false;
41 |       }
42 | 
43 |       // chwila przerwy
44 |       await sleepRandom(3000, 7000);
45 | 
46 |       // pr√≥ba ‚Äûprzep≈Çukania‚Äù sesji ‚Äì wej≈õcie na FB
47 |       try {
48 |         console.log("[NAV] pr√≥ba od≈õwie≈ºenia FB (strona g≈Ç√≥wna)...");
49 |         await page
50 |           .goto("https://www.facebook.com/", {
51 |             waitUntil: "load",
52 |             timeout: 45000,
53 |           })
54 |           .catch(() => {});
55 |       } catch (e2) {
56 |         console.error(
57 |           "[NAV] od≈õwie≈ºenie FB te≈º polecia≈Ço b≈Çƒôdem:",
58 |           e2.message
59 |         );
60 |       }
61 |     }
62 |   }
63 | 
64 |   // tu w praktyce nie dojdziemy
65 |   return false;
66 | }
67 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/17__sleep.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | function sleep(ms) {
 2 |   return new Promise((res) => setTimeout(res, ms));
 3 | }
 4 | 
 5 | function sleepRandom(minMs, maxMs) {
 6 |   const delta = maxMs - minMs;
 7 |   const extra = Math.random() * delta;
 8 |   return sleep(minMs + extra);
 9 | }
10 | 
11 | export { sleep, sleepRandom };
12 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/18__api.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // panel/api.js
  2 | import http from "http";
  3 | import { exec } from "child_process";
  4 | import fs from "fs";
  5 | import path from "path";
  6 | import crypto from "crypto";
  7 | import dotenv from "dotenv";
  8 | 
  9 | // ---- BASE DIR (dev vs exe) ----
 10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 11 | 
 12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 15 | 
 16 | // UI: dev -> src/panel/ui, exe -> ./ui
 17 | const UI_DIR = process.pkg
 18 |   ? path.join(BASE_DIR, "ui")
 19 |   : path.join(BASE_DIR, "src", "panel", "ui");
 20 | 
 21 | const PORT = Number(process.env.PANEL_PORT || 3180);
 22 | const TOKEN = process.env.PANEL_TOKEN;
 23 | 
 24 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 25 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 26 | 
 27 | if (!TOKEN) {
 28 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 29 |   process.exit(1);
 30 | }
 31 | 
 32 | function auth(req, res) {
 33 |   const h = req.headers["authorization"] || "";
 34 |   if (h !== `Bearer ${TOKEN}`) {
 35 |     res.writeHead(401);
 36 |     res.end("Unauthorized");
 37 |     return false;
 38 |   }
 39 |   return true;
 40 | }
 41 | 
 42 | function json(res, obj, code = 200) {
 43 |   res.writeHead(code, { "Content-Type": "application/json" });
 44 |   res.end(JSON.stringify(obj, null, 2));
 45 | }
 46 | 
 47 | function sh(cmd) {
 48 |   return new Promise((resolve) => {
 49 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 50 |       resolve({
 51 |         ok: !err,
 52 |         stdout: (stdout || "").trim(),
 53 |         stderr: (stderr || "").trim(),
 54 |         code: err?.code ?? 0,
 55 |       });
 56 |     });
 57 |   });
 58 | }
 59 | 
 60 | 
 61 | async function getProjectDir() {
 62 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 63 | 
 64 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 65 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 66 |   if (!m)
 67 |     throw new Error(
 68 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 69 |     );
 70 |   return m[1].trim();
 71 | }
 72 | 
 73 | function readBody(req) {
 74 |   return new Promise((resolve) => {
 75 |     let d = "";
 76 |     req.on("data", (c) => (d += c));
 77 |     req.on("end", () => resolve(d));
 78 |   });
 79 | }
 80 | 
 81 | function safeJsonParse(s) {
 82 |   try {
 83 |     return { ok: true, value: JSON.parse(s) };
 84 |   } catch (e) {
 85 |     return { ok: false, error: e?.message || "Invalid JSON" };
 86 |   }
 87 | }
 88 | 
 89 | function ensureDir(p) {
 90 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
 91 | }
 92 | 
 93 | function atomicWriteFile(filePath, content) {
 94 |   const dir = path.dirname(filePath);
 95 |   ensureDir(dir);
 96 | 
 97 |   const tmp = path.join(
 98 |     dir,
 99 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
100 |   );
101 |   fs.writeFileSync(tmp, content, "utf8");
102 |   fs.renameSync(tmp, filePath);
103 | }
104 | 
105 | function normalizeUrl(u) {
106 |   if (!u) return "";
107 |   const x = String(u).trim();
108 |   if (!/^https?:\/\/.+/i.test(x)) return "";
109 |   return x;
110 | }
111 | 
112 | function normalizeOptionalUrl(u) {
113 |   if (!u) return "";
114 |   const x = String(u).trim();
115 |   if (x === "") return "";
116 |   if (!/^https?:\/\/.+/i.test(x)) return "";
117 |   return x;
118 | }
119 | 
120 | function nowIso() {
121 |   return new Date().toISOString();
122 | }
123 | 
124 | function setEnvKey(envText, key, value) {
125 |   const re = new RegExp(`^${key}=.*$`, "m");
126 |   const line = `${key}=${value}`;
127 |   if (re.test(envText)) return envText.replace(re, line);
128 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
129 | }
130 | 
131 | function pickPostsFile(projectDir) {
132 |   return path.join(projectDir, "data", "posts.json");
133 | }
134 | 
135 | function readPosts(postsPath) {
136 |   if (!fs.existsSync(postsPath)) return [];
137 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
138 |   if (!raw) return [];
139 |   const parsed = safeJsonParse(raw);
140 |   if (!parsed.ok || !Array.isArray(parsed.value))
141 |     throw new Error("posts.json invalid (expected array)");
142 |   return parsed.value;
143 | }
144 | 
145 | function writePosts(postsPath, posts) {
146 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
147 | }
148 | 
149 | function genId() {
150 |   return crypto.randomBytes(8).toString("hex");
151 | }
152 | 
153 | function route(req) {
154 |   const url = new URL(req.url, "http://localhost");
155 |   const pathname = url.pathname;
156 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
157 | }
158 | 
159 | function match(pathname, pattern) {
160 |   const a = pathname.split("/").filter(Boolean);
161 |   const b = pattern.split("/").filter(Boolean);
162 |   if (a.length !== b.length) return null;
163 |   const params = {};
164 |   for (let i = 0; i < a.length; i++) {
165 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
166 |     else if (a[i] !== b[i]) return null;
167 |   }
168 |   return params;
169 | }
170 | 
171 | // ---------- LOGS (dynamic from pm2 describe) ----------
172 | function parsePm2LogPaths(pm2DescribeText) {
173 |   const out =
174 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
175 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
176 |     "";
177 |   const err =
178 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
179 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
180 |     "";
181 |   return { out, err };
182 | }
183 | 
184 | async function getPm2LogPaths(appName) {
185 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
186 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
187 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
188 | 
189 |   const d = await sh(`pm2 describe ${appName}`);
190 |   if (!d.ok)
191 |     return {
192 |       out: "",
193 |       err: "",
194 |       source: "pm2_error",
195 |       pm2: d.stderr || d.stdout || "",
196 |     };
197 | 
198 |   const p = parsePm2LogPaths(d.stdout);
199 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
200 | }
201 | 
202 | async function readTailLog(filePath, lines) {
203 |   try {
204 |     if (!filePath) {
205 |       return {
206 |         ok: false,
207 |         error:
208 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
209 |         path: filePath,
210 |       };
211 |     }
212 | 
213 |     if (!fs.existsSync(filePath)) {
214 |       return {
215 |         ok: false,
216 |         error:
217 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
218 |         path: filePath,
219 |       };
220 |     }
221 | 
222 |     const st = fs.statSync(filePath);
223 |     if (!st || !st.isFile()) {
224 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
225 |     }
226 | 
227 |     if (st.size === 0) {
228 |       return {
229 |         ok: false,
230 |         error:
231 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
232 |         path: filePath,
233 |       };
234 |     }
235 | 
236 |     
237 |     // fallback JS
238 |     const raw = fs.readFileSync(filePath, "utf8");
239 |     const arr = raw.split(/\r?\n/);
240 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
241 |     const txt = (slice || "").trim();
242 | 
243 |     if (!txt) {
244 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
245 |     }
246 | 
247 |     return { ok: true, log: slice, path: filePath, via: "js" };
248 |   } catch (e) {
249 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
250 |   }
251 | }
252 | 
253 | http
254 |   .createServer(async (req, res) => {
255 |     const { pathname, query } = route(req);
256 |     if (req.method === "GET" && pathname === "/ping") {
257 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
258 |   res.end("pong");
259 |   return;
260 | }
261 | 
262 | 
263 |     // ---------- PUBLIC UI ----------
264 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
265 |       const p = path.join(UI_DIR, "index.html");
266 |       const html = fs.readFileSync(p, "utf8");
267 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
268 |       res.end(html);
269 |       return;
270 |     }
271 | 
272 |     if (req.method === "GET" && pathname === "/app.js") {
273 |       const p = path.join(UI_DIR, "app.js");
274 |       const js = fs.readFileSync(p, "utf8");
275 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
276 |       res.end(js);
277 |       return;
278 |     }
279 | 
280 |     // ---------- AUTH for API ----------
281 |     if (pathname.startsWith("/api/")) {
282 |       if (!auth(req, res)) return;
283 |     }
284 | 
285 |     try {
286 |       const PROJECT_DIR = await getProjectDir();
287 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
288 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
289 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
290 | 
291 |       // ===== STATUS =====
292 |       if (req.method === "GET" && pathname === "/api/status") {
293 |         const node = await sh("node -v");
294 |         const pm2v = await sh("pm2 -v");
295 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
296 |         json(res, {
297 |           ok: true,
298 |           projectDir: PROJECT_DIR,
299 |           envPath: ENV_PATH,
300 |           cookiesPath: COOKIES_PATH,
301 |           postsPath: POSTS_PATH,
302 |           node: node.stdout,
303 |           pm2: pm2v.stdout,
304 |           pm2Status: pm2s.stdout,
305 |           time: nowIso(),
306 |         });
307 |         return;
308 |       }
309 | 
310 |       // ===== ENV GET (selected keys) =====
311 |       if (req.method === "GET" && pathname === "/api/env/get") {
312 |         if (!fs.existsSync(ENV_PATH)) {
313 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
314 |           return;
315 |         }
316 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
317 |         const wanted = [
318 |           "FB_EMAIL",
319 |           "FB_PASSWORD",
320 |           "WEBHOOK_URL",
321 |           "CHECK_INTERVAL_MS",
322 |           "POSTS_SHEET_URL",
323 |           "HEADLESS_BROWSER",
324 |           "USE_UI_HANDLERS",
325 |           "INCLUDE_REPLIES",
326 |         ];
327 |         const values = {};
328 |         for (const k of wanted) {
329 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
330 |           values[k] = m ? m[1] : "";
331 |         }
332 |         json(res, { ok: true, values });
333 |         return;
334 |       }
335 | 
336 |       // ===== ENV SET MULTIPLE =====
337 |       if (req.method === "POST" && pathname === "/api/env/set") {
338 |         const bodyRaw = await readBody(req);
339 |         const parsed = safeJsonParse(bodyRaw || "{}");
340 |         if (!parsed.ok) {
341 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
342 |           return;
343 |         }
344 | 
345 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
346 |         const restart = Boolean(parsed.value.restart);
347 | 
348 |         if (!set) {
349 |           json(res, { ok: false, error: "Missing set object" }, 400);
350 |           return;
351 |         }
352 |         if (!fs.existsSync(ENV_PATH)) {
353 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
354 |           return;
355 |         }
356 | 
357 |         let env = fs.readFileSync(ENV_PATH, "utf8");
358 |         const updated = [];
359 | 
360 |         for (const [k, v] of Object.entries(set)) {
361 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
362 |           env = setEnvKey(env, k, String(v));
363 |           updated.push(k);
364 |         }
365 | 
366 |         atomicWriteFile(ENV_PATH, env);
367 | 
368 |         let pm2Action = null;
369 |         if (restart) {
370 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
371 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
372 |         }
373 | 
374 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
375 |         return;
376 |       }
377 | 
378 |       // ===== POSTS: LIST =====
379 |       if (req.method === "GET" && pathname === "/api/posts") {
380 |         const posts = readPosts(POSTS_PATH);
381 | 
382 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
383 |         const norm = (posts || []).map((p) => ({
384 |           id: String(p.id || "").trim(),
385 |           url: String(p.url || "").trim(),
386 |           active: p.active !== undefined ? Boolean(p.active) : true,
387 |           name: String(p.name || "").trim(),
388 |           image: String(p.image || "").trim(),
389 |           description: String(p.description || "").trim(),
390 |           createdAt: p.createdAt || "",
391 |           updatedAt: p.updatedAt || "",
392 |         }));
393 | 
394 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
395 |         json(res, { ok: true, posts: norm });
396 |         return;
397 |       }
398 | 
399 |       // ===== POSTS: ADD =====
400 |       if (req.method === "POST" && pathname === "/api/posts") {
401 |         const bodyRaw = await readBody(req);
402 |         const parsed = safeJsonParse(bodyRaw || "{}");
403 |         if (!parsed.ok) {
404 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
405 |           return;
406 |         }
407 | 
408 |         const url = normalizeUrl(parsed.value.url);
409 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
410 | 
411 |         const name = String(parsed.value.name || "").trim();
412 |         const imageRaw = String(parsed.value.image || "").trim();
413 |         const image = normalizeOptionalUrl(imageRaw);
414 |         const description = String(parsed.value.description || "").trim();
415 | 
416 |         if (!url) {
417 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
418 |           return;
419 |         }
420 |         if (imageRaw !== "" && !image) {
421 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
422 |           return;
423 |         }
424 | 
425 |         const posts = readPosts(POSTS_PATH);
426 |         const existing = posts.find((p) => p.url === url);
427 |         if (existing) {
428 |           existing.active = active;
429 |           existing.name = name;
430 |           existing.image = image;
431 |           existing.description = description;
432 |           existing.updatedAt = nowIso();
433 |           writePosts(POSTS_PATH, posts);
434 |           json(res, { ok: true, post: existing, deduped: true });
435 |           return;
436 |         }
437 | 
438 |         const post = {
439 |           id: genId(),
440 |           url,
441 |           active,
442 |           name,
443 |           image,
444 |           description,
445 |           createdAt: nowIso(),
446 |           updatedAt: nowIso(),
447 |         };
448 |         posts.push(post);
449 |         writePosts(POSTS_PATH, posts);
450 | 
451 |         json(res, { ok: true, post });
452 |         return;
453 |       }
454 | 
455 |       // ===== POSTS: PATCH =====
456 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
457 |       if (mPatch) {
458 |         const id = mPatch.id;
459 |         const bodyRaw = await readBody(req);
460 |         const parsed = safeJsonParse(bodyRaw || "{}");
461 |         if (!parsed.ok) {
462 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
463 |           return;
464 |         }
465 | 
466 |         const posts = readPosts(POSTS_PATH);
467 |         const post = posts.find((p) => p.id === id);
468 |         if (!post) {
469 |           json(res, { ok: false, error: "Post not found" }, 404);
470 |           return;
471 |         }
472 | 
473 |         if (parsed.value.url !== undefined) {
474 |           const nextUrl = normalizeUrl(parsed.value.url);
475 |           if (!nextUrl) {
476 |             json(res, { ok: false, error: "Invalid url" }, 400);
477 |             return;
478 |           }
479 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
480 |           if (dup) {
481 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
482 |             return;
483 |           }
484 |           post.url = nextUrl;
485 |         }
486 | 
487 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
488 | 
489 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
490 | 
491 |         if (parsed.value.image !== undefined) {
492 |           const raw = String(parsed.value.image || "").trim();
493 |           const img = normalizeOptionalUrl(raw);
494 |           if (raw !== "" && !img) {
495 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
496 |             return;
497 |           }
498 |           post.image = img;
499 |         }
500 | 
501 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
502 | 
503 |         post.updatedAt = nowIso();
504 |         writePosts(POSTS_PATH, posts);
505 |         json(res, { ok: true, post });
506 |         return;
507 |       }
508 | 
509 |       // ===== POSTS: DELETE =====
510 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
511 |       if (mDel) {
512 |         const id = mDel.id;
513 |         const posts = readPosts(POSTS_PATH);
514 |         const idx = posts.findIndex((p) => p.id === id);
515 |         if (idx === -1) {
516 |           json(res, { ok: false, error: "Post not found" }, 404);
517 |           return;
518 |         }
519 |         const removed = posts.splice(idx, 1)[0];
520 |         writePosts(POSTS_PATH, posts);
521 |         json(res, { ok: true, removed });
522 |         return;
523 |       }
524 | 
525 |       // ===== COOKIES: CLEAR =====
526 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
527 |         const bodyRaw = await readBody(req);
528 |         const parsed = safeJsonParse(bodyRaw || "{}");
529 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
530 | 
531 |         if (!confirm) {
532 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
533 |           return;
534 |         }
535 | 
536 |         atomicWriteFile(COOKIES_PATH, "[]\n");
537 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
538 |         return;
539 |       }
540 | 
541 |       // ===== PM2 =====
542 |       function okOrErr(r, fallbackErr = "Command failed") {
543 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
544 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
545 |       }
546 |       async function pm2Describe(name) {
547 |         return await sh(`pm2 describe ${name}`);
548 |       }
549 | 
550 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
551 |       const WATCH_NAME = PM2_APP || "fbwatcher";
552 | 
553 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
554 |         const d = await pm2Describe(WATCH_NAME);
555 |         if (d.ok) {
556 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
557 |           json(res, okOrErr(r, "PM2 start failed"));
558 |           return;
559 |         }
560 | 
561 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
562 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
563 |         return;
564 |       }
565 | 
566 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
567 |         const d = await pm2Describe(WATCH_NAME);
568 |         if (!d.ok) {
569 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
570 |           return;
571 |         }
572 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
573 |         json(res, okOrErr(r, "PM2 restart failed"));
574 |         return;
575 |       }
576 | 
577 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
578 |         const d = await pm2Describe(WATCH_NAME);
579 |         if (!d.ok) {
580 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
581 |           return;
582 |         }
583 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
584 |         json(res, okOrErr(r, "PM2 stop failed"));
585 |         return;
586 |       }
587 | 
588 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
589 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
590 |         json(res, okOrErr(r, "PM2 status failed"));
591 |         return;
592 |       }
593 | 
594 |       // ===== LOGS INFO (debug) =====
595 |       if (req.method === "GET" && pathname === "/api/logs/info") {
596 |         const paths = await getPm2LogPaths(PM2_APP);
597 |         json(res, { ok: true, app: PM2_APP, ...paths });
598 |         return;
599 |       }
600 | 
601 |       // ===== LOGS =====
602 |       if (req.method === "GET" && pathname === "/api/logs/out") {
603 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
604 |         const paths = await getPm2LogPaths(PM2_APP);
605 |         const payload = await readTailLog(paths.out, lines);
606 |         json(res, { ...payload, source: paths.source });
607 |         return;
608 |       }
609 | 
610 |       if (req.method === "GET" && pathname === "/api/logs/err") {
611 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
612 |         const paths = await getPm2LogPaths(PM2_APP);
613 |         const payload = await readTailLog(paths.err, lines);
614 |         json(res, { ...payload, source: paths.source });
615 |         return;
616 |       }
617 | 
618 |       json(res, { ok: false, error: "Not found" }, 404);
619 |     } catch (e) {
620 |       json(res, { ok: false, error: e.message }, 500);
621 |     }
622 |   })
623 |   .listen(PORT, "0.0.0.0", () => {
624 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
625 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
626 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
627 |   });
628 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/19__index.html`
**Typ:** HTML  
**Opis:** Plik projektu (kod/konfiguracja).  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>Panel FB Watcher</title>
  7 | 
  8 |   <style>
  9 |     :root{
 10 |       --bg:#0b0f14;
 11 |       --card:#121926;
 12 |       --card2:#0b1220;
 13 |       --border:#223047;
 14 |       --border2:#2a3a55;
 15 |       --text:#e7eef7;
 16 |       --muted:rgba(231,238,247,.75);
 17 |       --primary:#2563eb;
 18 |       --danger:#b91c1c;
 19 |       --ok:#34d399;
 20 |       --err:#f87171;
 21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
 22 |       --radius:14px;
 23 |     }
 24 | 
 25 |     * { box-sizing:border-box; }
 26 |     body {
 27 |       font-family: system-ui, Arial;
 28 |       margin: 16px;
 29 |       background: var(--bg);
 30 |       color: var(--text);
 31 |     }
 32 | 
 33 |     h2 { margin: 6px 0 6px; }
 34 |     h3 { margin: 6px 0 12px; }
 35 | 
 36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
 37 |     .card {
 38 |       background: var(--card);
 39 |       border:1px solid var(--border);
 40 |       border-radius: var(--radius);
 41 |       padding:14px;
 42 |       margin:12px 0;
 43 |       box-shadow: var(--shadow);
 44 |     }
 45 | 
 46 |     input, textarea, button, select {
 47 |       font: inherit;
 48 |       border-radius:12px;
 49 |       border:1px solid var(--border2);
 50 |       background: var(--card2);
 51 |       color: var(--text);
 52 |       padding:10px 12px;
 53 |       outline: none;
 54 |     }
 55 |     input:focus, textarea:focus, select:focus {
 56 |       border-color: rgba(37, 99, 235, .75);
 57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
 58 |     }
 59 | 
 60 |     input, textarea { width: 100%; }
 61 |     textarea { resize: vertical; min-height: 90px; }
 62 | 
 63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
 64 |     button:active { transform: translateY(1px); }
 65 |     button.primary { background: var(--primary); border-color: var(--primary); }
 66 |     button.danger { background: var(--danger); border-color: var(--danger); }
 67 |     button.ghost { background: transparent; }
 68 |     button.small { padding:8px 10px; border-radius: 10px; }
 69 | 
 70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 71 | 
 72 |     .muted { opacity:0.78; font-size:12px; }
 73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 74 | 
 75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
 76 | 
 77 |     .thumb {
 78 |       width:64px; height:40px;
 79 |       object-fit:cover;
 80 |       border-radius:10px;
 81 |       border:1px solid var(--border);
 82 |       background: var(--card2);
 83 |     }
 84 | 
 85 |     /* ===== tabela ===== */
 86 |     .tableWrap {
 87 |       width: 100%;
 88 |       /* by≈Ço: overflow-x; teraz robimy pe≈Çny scroll + limit wysoko≈õci */
 89 |       max-height: calc(100vh - 260px);
 90 |       overflow: auto;
 91 | 
 92 |       border-radius: 12px;
 93 |       border: 1px solid rgba(34,48,71,.45);
 94 |       background: rgba(11,18,32,.25);
 95 |     }
 96 | 
 97 |     /* opcjonalnie: ≈Çadniejsze scrollbary */
 98 |     .tableWrap::-webkit-scrollbar { height: 10px; width: 10px; }
 99 |     .tableWrap::-webkit-scrollbar-thumb { background: rgba(42,58,85,.9); border-radius: 999px; }
100 |     .tableWrap::-webkit-scrollbar-track { background: rgba(11,18,32,.35); border-radius: 999px; }
101 | 
102 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
103 |     th, td {
104 |       border-bottom:1px solid rgba(34,48,71,.7);
105 |       padding:10px;
106 |       text-align:left;
107 |       vertical-align:top;
108 |       overflow-wrap:anywhere;
109 |       word-break:break-word;
110 |     }
111 | 
112 |     /* sticky head */
113 |     th {
114 |       font-size: 12px;
115 |       opacity:.9;
116 |       position: sticky;
117 |       top: 0;
118 |       z-index: 5;
119 |       background: rgba(18,25,38,.96);
120 |       backdrop-filter: blur(8px);
121 |     }
122 | 
123 |     /* delikatny hover, ≈ºeby to "oddycha≈Ço" */
124 |     tbody tr:hover td {
125 |       background: rgba(37,99,235,.06);
126 |     }
127 | 
128 |     /* kolumny */
129 |     th.col-id,  td.col-id  { width: 170px; }
130 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
131 |     th.col-name,td.col-name{ width: 170px; }
132 |     th.col-img, td.col-img { width: 120px; }
133 |     th.col-desc,td.col-desc{ width: 260px; }
134 |     th.col-act, td.col-act { width: 110px; text-align:center; }
135 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
136 | 
137 |     /* URL: kolor */
138 |     td.col-url a{
139 |       color: #93c5fd;
140 |       text-decoration: underline;
141 |     }
142 | 
143 |     /* wrapper dla linka + ikonki kopiuj */
144 |     .urlWrap{
145 |       display:flex;
146 |       align-items:flex-start;
147 |       gap:10px;
148 |     }
149 | 
150 |     /* KLUCZ: niech link nie robi ≈õciany (max 2 linie) */
151 | .urlWrap a{
152 |   flex: 1;
153 |   min-width: 0;
154 | 
155 |   /* clamp (Chromium/WebKit) */
156 |   display: -webkit-box;
157 |   -webkit-box-orient: vertical;
158 |   -webkit-line-clamp: 2;
159 | 
160 |   /* clamp (standard / future) */
161 |   line-clamp: 2;
162 | 
163 |   overflow: hidden;
164 | 
165 |   word-break: break-word;
166 |   overflow-wrap: anywhere;
167 |   line-height: 1.25;
168 | 
169 |   /* fallback gdy clamp nie dzia≈Ça */
170 |   max-height: 2.5em;
171 | }
172 | 
173 | 
174 | 
175 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
176 |     .iconBtn{
177 |       width: 28px;
178 |       height: 28px;
179 |       padding: 0;
180 |       display:inline-flex;
181 |       align-items:center;
182 |       justify-content:center;
183 |       border-radius: 10px;
184 |       background: transparent;
185 |       border: 1px solid rgba(42,58,85,.9);
186 |       opacity: .9;
187 |       flex: 0 0 auto;
188 |     }
189 |     .iconBtn:hover{
190 |       opacity: 1;
191 |       background: rgba(37,99,235,.15);
192 |     }
193 |     .iconBtn:active{
194 |       transform: translateY(1px);
195 |     }
196 |     .iconBtn svg{
197 |       width: 16px;
198 |       height: 16px;
199 |       fill: none;
200 |       stroke: rgba(231,238,247,.95);
201 |       stroke-width: 2;
202 |       stroke-linecap: round;
203 |       stroke-linejoin: round;
204 |     }
205 | 
206 |     /* akcje w tabeli */
207 |     .actionsWrap{
208 |       display:flex;
209 |       gap:10px;
210 |       align-items:center;
211 |       justify-content:flex-start;
212 |       flex-wrap:nowrap;
213 |     }
214 | 
215 |     /* ===== status ===== */
216 |     .hint { margin-top:10px; }
217 |     .hint.ok { color: #a7f3d0; }
218 |     .hint.err { color: #fca5a5; }
219 | 
220 |     /* ===== logi: proporcje ===== */
221 |     .logsBox {
222 |       display:flex;
223 |       flex-direction: column;
224 |       gap:10px;
225 |     }
226 |     #logs {
227 |       height: 200px;
228 |       min-height: 160px;
229 |       max-height: 520px;
230 |     }
231 |     .logsExpanded #logs { height: 420px; }
232 | 
233 |     /* ===== modal ===== */
234 |     .modalOverlay{
235 |       position: fixed;
236 |       inset: 0;
237 |       background: rgba(0,0,0,.55);
238 |       display:none;
239 |       align-items:center;
240 |       justify-content:center;
241 |       padding: 18px;
242 |       z-index: 9999;
243 |     }
244 |     .modalOverlay.show{ display:flex; }
245 |     .modal{
246 |       width: min(640px, 100%);
247 |       border-radius: 16px;
248 |       border: 1px solid rgba(34,48,71,.9);
249 |       background: rgba(18,25,38,.98);
250 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
251 |       padding: 16px;
252 |     }
253 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
254 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
255 |     .modal .modalActions{
256 |       display:flex;
257 |       justify-content:flex-end;
258 |       gap:10px;
259 |       margin-top: 14px;
260 |     }
261 |     .kbd{
262 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
263 |       font-size: 12px;
264 |       opacity:.9;
265 |       padding: 2px 6px;
266 |       border:1px solid rgba(42,58,85,.9);
267 |       border-radius: 8px;
268 |       background: rgba(11,18,32,.55);
269 |     }
270 | 
271 |     @media (max-width: 860px){
272 |       table { min-width: 980px; }
273 |       .tableWrap { max-height: calc(100vh - 220px); }
274 |     }
275 |   </style>
276 | </head>
277 | 
278 | <body>
279 |   <h2>FB Watcher ‚Äî Panel</h2>
280 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
281 | 
282 |   <div class="card">
283 |     <div class="row">
284 |       <div style="flex:1; min-width:260px;">
285 |         <label>Token panelu</label>
286 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
287 |       </div>
288 |       <div style="display:flex; gap:10px; align-items:flex-end;">
289 |         <button class="primary" id="saveToken">Zapisz token</button>
290 |         <button id="refresh">Od≈õwie≈º</button>
291 |       </div>
292 |     </div>
293 | 
294 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
295 |   </div>
296 | 
297 |   <div class="card">
298 |     <h3>Ustawienia (.env)</h3>
299 | 
300 |     <div class="row">
301 |       <div style="flex:1; min-width:260px;">
302 |         <label>E-mail Facebook</label>
303 |         <input id="FB_EMAIL" />
304 |       </div>
305 |       <div style="flex:1; min-width:260px;">
306 |         <label>Has≈Ço Facebook</label>
307 |         <input id="FB_PASSWORD" type="password" />
308 |       </div>
309 |     </div>
310 | 
311 |     <label>Webhook (URL)</label>
312 |     <input id="WEBHOOK_URL" />
313 | 
314 |     <div class="row">
315 |       <div style="flex:1; min-width:220px;">
316 |         <label>Interwa≈Ç sprawdzania (ms)</label>
317 |         <input id="CHECK_INTERVAL_MS" />
318 |       </div>
319 |       <div style="flex:2; min-width:260px;">
320 |         <label>Arkusz z postami (CSV export)</label>
321 |         <input id="POSTS_SHEET_URL" />
322 |       </div>
323 |     </div>
324 | 
325 |     <div class="row">
326 |       <div style="flex:1; min-width:220px;">
327 |         <label>Tryb bez okna (headless)</label>
328 |         <select id="HEADLESS_BROWSER">
329 |           <option value="true">true</option>
330 |           <option value="false">false</option>
331 |         </select>
332 |       </div>
333 |       <div style="flex:1; min-width:220px;">
334 |         <label>Obs≈Çuga UI (handlery)</label>
335 |         <select id="USE_UI_HANDLERS">
336 |           <option value="true">true</option>
337 |           <option value="false">false</option>
338 |         </select>
339 |       </div>
340 |       <div style="flex:1; min-width:220px;">
341 |         <label>Uwzglƒôdniaj odpowiedzi</label>
342 |         <select id="INCLUDE_REPLIES">
343 |           <option value="true">true</option>
344 |           <option value="false">false</option>
345 |         </select>
346 |       </div>
347 |     </div>
348 | 
349 |     <div class="row" style="margin-top:10px;">
350 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
351 |       <button id="pm2Start">Start watchera</button>
352 |       <button id="pm2Stop">Stop watchera</button>
353 |       <button id="pm2Restart">Restart watchera</button>
354 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
355 |     </div>
356 | 
357 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
358 |   </div>
359 | 
360 |   <div class="card">
361 |     <h3>Posty (data/posts.json)</h3>
362 | 
363 |     <div class="row">
364 |       <div style="flex:2; min-width:260px;">
365 |         <label>Nowy URL posta</label>
366 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
367 |       </div>
368 | 
369 |       <div style="flex:1; min-width:220px;">
370 |         <label>Nazwa</label>
371 |         <input id="newPostName" placeholder="np. A1" />
372 |       </div>
373 | 
374 |       <div style="flex:1; min-width:260px;">
375 |         <label>URL zdjƒôcia</label>
376 |         <input id="newPostImage" placeholder="https://...jpg" />
377 |       </div>
378 |     </div>
379 | 
380 |     <label>Opis</label>
381 |     <textarea id="newPostDescription" placeholder="Kr√≥tki opis..."></textarea>
382 | 
383 |     <div class="row" style="margin-top:10px;">
384 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
385 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
386 |           <input type="checkbox" id="newPostActive" checked /> aktywny
387 |         </label>
388 |         <button class="primary" id="addPost">Dodaj</button>
389 |       </div>
390 |     </div>
391 | 
392 |     <div style="margin-top:12px;" class="tableWrap">
393 |       <table>
394 |         <thead>
395 |           <tr>
396 |             <th class="col-id">ID</th>
397 |             <th class="col-url">Link</th>
398 |             <th class="col-name">Nazwa</th>
399 |             <th class="col-img">Zdjƒôcie</th>
400 |             <th class="col-desc">Opis</th>
401 |             <th class="col-act">Aktywny</th>
402 |             <th class="col-btn">Akcje</th>
403 |           </tr>
404 |         </thead>
405 |         <tbody id="posts"></tbody>
406 |       </table>
407 |     </div>
408 |   </div>
409 | 
410 |   <div class="card" id="logsCard">
411 |     <div class="row" style="justify-content:space-between; align-items:center;">
412 |       <h3 style="margin:0;">Logi</h3>
413 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
414 |         Rozwi≈Ñ
415 |       </button>
416 |     </div>
417 | 
418 |     <div class="logsBox">
419 |       <div class="row">
420 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
421 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
422 | 
423 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
424 | 
425 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
426 |           <option value="0">auto: wy≈Ç.</option>
427 |           <option value="1000">co 1 s</option>
428 |           <option value="2000" selected>co 2 s</option>
429 |           <option value="5000">co 5 s</option>
430 |           <option value="10000">co 10 s</option>
431 |         </select>
432 | 
433 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
434 | 
435 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
436 |           <input type="checkbox" id="logAutoScroll" checked />
437 |           auto-scroll
438 |         </label>
439 |       </div>
440 | 
441 |       <div class="sep"></div>
442 | 
443 |       <textarea
444 |         id="logs"
445 |         class="mono"
446 |         readonly
447 |         spellcheck="false"
448 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
449 | 
450 |       <div id="logHint" class="muted hint"></div>
451 |     </div>
452 |   </div>
453 | 
454 |   <!-- modal -->
455 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
456 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
457 |       <h4 id="modalTitle">Potwierdzenie</h4>
458 |       <div class="modalBody" id="modalBody"></div>
459 |       <div class="modalActions">
460 |         <button id="modalCancel">Anuluj</button>
461 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
462 |       </div>
463 |       <div class="muted" style="margin-top:10px;">
464 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
465 |       </div>
466 |     </div>
467 |   </div>
468 | 
469 |   <script src="/app.js"></script>
470 | </body>
471 | </html>
472 | 
```

---

### üìÑ ≈öcie≈ºka: `export_chat_context/20__app.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | (() => {
  2 |   const $ = (id) => document.getElementById(id);
  3 | 
  4 |   // ---------- state ----------
  5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
  6 |   let logAutoTimer = null;
  7 |   let lastLogMode = "out"; // 'out' | 'err'
  8 |   let logsExpanded = false;
  9 | 
 10 |   // modal state
 11 |   let modalResolve = null;
 12 | 
 13 |   // edit modal state
 14 |   let editResolve = null;
 15 | 
 16 |   // ---------- ui refs ----------
 17 |   const elToken = $("token");
 18 |   const btnSaveToken = $("saveToken");
 19 |   const btnRefresh = $("refresh");
 20 |   const elStatus = $("status");
 21 | 
 22 |   const btnSaveEnv = $("saveEnv");
 23 |   const btnPm2Start = $("pm2Start");
 24 |   const btnPm2Stop = $("pm2Stop");
 25 |   const btnPm2Restart = $("pm2Restart");
 26 |   const btnClearCookies = $("clearCookies");
 27 |   const elEnvMsg = $("envMsg");
 28 | 
 29 |   const elNewPostUrl = $("newPostUrl");
 30 |   const elNewPostName = $("newPostName");
 31 |   const elNewPostImage = $("newPostImage");
 32 |   const elNewPostDescription = $("newPostDescription");
 33 |   const elNewPostActive = $("newPostActive");
 34 |   const btnAddPost = $("addPost");
 35 |   const elPostsTbody = $("posts");
 36 | 
 37 |   const btnLoadOut = $("loadOut");
 38 |   const btnLoadErr = $("loadErr");
 39 |   const elLogLines = $("logLines");
 40 |   const elLogAutoEvery = $("logAutoEvery");
 41 |   const btnLogAutoToggle = $("logAutoToggle");
 42 |   const elLogAutoScroll = $("logAutoScroll");
 43 |   const elLogs = $("logs");
 44 |   const elLogHint = $("logHint");
 45 | 
 46 |   const logsCard = $("logsCard");
 47 |   const btnToggleLogsSize = $("toggleLogsSize");
 48 | 
 49 |   // modal refs (delete + generic)
 50 |   const modalOverlay = $("modalOverlay");
 51 |   const modalBody = $("modalBody");
 52 |   const modalCancel = $("modalCancel");
 53 |   const modalOk = $("modalOk");
 54 | 
 55 |   // env fields
 56 |   const ENV_FIELDS = [
 57 |     "FB_EMAIL",
 58 |     "FB_PASSWORD",
 59 |     "WEBHOOK_URL",
 60 |     "CHECK_INTERVAL_MS",
 61 |     "POSTS_SHEET_URL",
 62 |     "HEADLESS_BROWSER",
 63 |     "USE_UI_HANDLERS",
 64 |     "INCLUDE_REPLIES",
 65 |   ];
 66 | 
 67 |   function setHint(el, msg, ok = true) {
 68 |     if (!el) return;
 69 |     el.textContent = msg || "";
 70 |     el.classList.remove("ok", "err");
 71 |     el.classList.add(ok ? "ok" : "err");
 72 |   }
 73 | 
 74 |   function fmtTime() {
 75 |     try {
 76 |       return new Date().toLocaleString();
 77 |     } catch {
 78 |       return "";
 79 |     }
 80 |   }
 81 | 
 82 |   function getAuthHeaders() {
 83 |     const t = (token || "").trim();
 84 |     return t ? { Authorization: `Bearer ${t}` } : {};
 85 |   }
 86 | 
 87 |   async function api(path, opts = {}) {
 88 |     const headers = {
 89 |       ...(opts.headers || {}),
 90 |       ...getAuthHeaders(),
 91 |     };
 92 | 
 93 |     let body = opts.body;
 94 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
 95 |       headers["Content-Type"] = "application/json";
 96 |       body = JSON.stringify(body);
 97 |     }
 98 | 
 99 |     const res = await fetch(path, {
100 |       method: opts.method || "GET",
101 |       headers,
102 |       body,
103 |     });
104 | 
105 |     const text = await res.text();
106 |     let data = null;
107 |     try {
108 |       data = JSON.parse(text);
109 |     } catch {
110 |       data = { ok: false, error: text || `HTTP ${res.status}` };
111 |     }
112 | 
113 |     if (!res.ok) {
114 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
115 |     }
116 |     return data;
117 |   }
118 | 
119 |   // ---------- modal ----------
120 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
121 |     return new Promise((resolve) => {
122 |       modalResolve = resolve;
123 | 
124 |       $("modalTitle").textContent = title;
125 |       modalBody.innerHTML = body;
126 | 
127 |       modalOk.textContent = okText;
128 |       modalOk.classList.toggle("danger", !!danger);
129 | 
130 |       modalOverlay.classList.add("show");
131 |       modalOverlay.setAttribute("aria-hidden", "false");
132 | 
133 |       setTimeout(() => {
134 |         (danger ? modalOk : modalCancel).focus();
135 |       }, 0);
136 |     });
137 |   }
138 | 
139 |   function closeModal(result) {
140 |     modalOverlay.classList.remove("show");
141 |     modalOverlay.setAttribute("aria-hidden", "true");
142 |     const r = modalResolve;
143 |     modalResolve = null;
144 |     if (typeof r === "function") r(result);
145 |   }
146 | 
147 |   modalCancel.addEventListener("click", () => closeModal(false));
148 |   modalOk.addEventListener("click", () => closeModal(true));
149 |   modalOverlay.addEventListener("click", (e) => {
150 |     if (e.target === modalOverlay) closeModal(false);
151 |   });
152 |   window.addEventListener("keydown", (e) => {
153 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
154 |   });
155 | 
156 |   // ---------- core actions ----------
157 |   async function loadStatus() {
158 |     setHint(elStatus, "≈Åadowanie statusu...", true);
159 | 
160 |     const r = await api("/api/status");
161 |     if (!r.ok) {
162 |       setHint(
163 |         elStatus,
164 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
165 |         false
166 |       );
167 |       return null;
168 |     }
169 | 
170 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
171 |     return r;
172 |   }
173 | 
174 |   async function loadEnv() {
175 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
176 |     const r = await api("/api/env/get");
177 |     if (!r.ok) {
178 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
179 |       return;
180 |     }
181 |     const v = r.values || {};
182 |     for (const k of ENV_FIELDS) {
183 |       const el = $(k);
184 |       if (!el) continue;
185 |       el.value = (v[k] ?? "").toString();
186 |     }
187 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
188 |   }
189 | 
190 |   async function saveEnv(restart = false) {
191 |     const set = {};
192 |     for (const k of ENV_FIELDS) {
193 |       const el = $(k);
194 |       if (!el) continue;
195 |       set[k] = (el.value ?? "").toString();
196 |     }
197 | 
198 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
199 | 
200 |     const r = await api("/api/env/set", {
201 |       method: "POST",
202 |       body: { set, restart },
203 |     });
204 | 
205 |     if (!r.ok) {
206 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
207 |       return;
208 |     }
209 | 
210 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
211 |   }
212 | 
213 |   function copyIconSvg() {
214 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
215 |     return `
216 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
217 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
218 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
219 |       </svg>
220 |     `;
221 |   }
222 | 
223 |   async function loadPosts() {
224 |     const r = await api("/api/posts");
225 |     if (!r.ok) {
226 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
227 |       return;
228 |     }
229 | 
230 |     const posts = Array.isArray(r.posts) ? r.posts : [];
231 |     elPostsTbody.innerHTML = "";
232 | 
233 |     for (const p of posts) {
234 |       const tr = document.createElement("tr");
235 | 
236 |       const tdId = document.createElement("td");
237 |       tdId.className = "mono col-id";
238 |       tdId.textContent = p.id || "";
239 |       tr.appendChild(tdId);
240 | 
241 |       // LINK + IKONKA KOPIUJ PRZY LINKU
242 |       const tdUrl = document.createElement("td");
243 |       tdUrl.className = "col-url";
244 | 
245 |       if (p.url) {
246 |         const wrap = document.createElement("div");
247 |         wrap.className = "urlWrap";
248 | 
249 |         const a = document.createElement("a");
250 |         a.href = p.url;
251 |         a.target = "_blank";
252 |         a.rel = "noopener noreferrer";
253 |         a.textContent = p.url;
254 | 
255 |         const btnCopyIcon = document.createElement("button");
256 |         btnCopyIcon.className = "iconBtn";
257 |         btnCopyIcon.type = "button";
258 |         btnCopyIcon.title = "Kopiuj link";
259 |         btnCopyIcon.innerHTML = copyIconSvg();
260 | 
261 |         btnCopyIcon.addEventListener("click", async (e) => {
262 |           e.preventDefault();
263 |           e.stopPropagation();
264 | 
265 |           const ok = await copyToClipboard(p.url);
266 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
267 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
268 |         });
269 | 
270 |         wrap.appendChild(a);
271 |         wrap.appendChild(btnCopyIcon);
272 |         tdUrl.appendChild(wrap);
273 |       }
274 | 
275 |       tr.appendChild(tdUrl);
276 | 
277 |       const tdName = document.createElement("td");
278 |       tdName.className = "col-name";
279 |       tdName.textContent = p.name || "";
280 |       tr.appendChild(tdName);
281 | 
282 |       const tdImg = document.createElement("td");
283 |       tdImg.className = "col-img";
284 |       if (p.image) {
285 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
286 |       } else {
287 |         tdImg.textContent = "";
288 |       }
289 |       tr.appendChild(tdImg);
290 | 
291 |       const tdDesc = document.createElement("td");
292 |       tdDesc.className = "col-desc";
293 |       tdDesc.textContent = p.description || "";
294 |       tr.appendChild(tdDesc);
295 | 
296 |       const tdActive = document.createElement("td");
297 |       tdActive.className = "col-act";
298 |       const chk = document.createElement("input");
299 |       chk.type = "checkbox";
300 |       chk.checked = !!p.active;
301 |       chk.addEventListener("change", async () => {
302 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
303 |           method: "PATCH",
304 |           body: { active: chk.checked },
305 |         });
306 |         await loadPosts();
307 |       });
308 |       tdActive.appendChild(chk);
309 |       tr.appendChild(tdActive);
310 | 
311 |       // AKCJE: EDYTUJ + USU≈É
312 |       const tdActions = document.createElement("td");
313 |       tdActions.className = "col-btn";
314 | 
315 |       const actions = document.createElement("div");
316 |       actions.className = "actionsWrap";
317 | 
318 |       const btnEdit = document.createElement("button");
319 |       btnEdit.className = "small";
320 |       btnEdit.type = "button";
321 |       btnEdit.textContent = "Edytuj";
322 |       btnEdit.addEventListener("click", async () => {
323 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
324 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
325 |         const ok = await showModal({
326 |           title: "Edytuj post",
327 |           body:
328 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
329 |             `<div style="margin-top:10px">
330 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
331 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
332 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
333 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
334 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
335 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
336 |               <label class="muted" style="display:block;margin:8px 0 6px;">Opis</label>
337 |               <textarea id="edit_desc" style="height:90px;">${escapeHtml(p.description || "")}</textarea>
338 |             </div>`,
339 |           okText: "Zapisz",
340 |           danger: false,
341 |         });
342 | 
343 |         if (!ok) return;
344 | 
345 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
346 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
347 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
348 |         const newDesc = (document.getElementById("edit_desc")?.value || "").trim();
349 | 
350 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
351 |           method: "PATCH",
352 |           body: { url: newUrl, name: newName, image: newImg, description: newDesc },
353 |         });
354 | 
355 |         if (!rr.ok) {
356 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
357 |           return;
358 |         }
359 | 
360 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
361 |         await loadPosts();
362 |       });
363 | 
364 |       const btnDel = document.createElement("button");
365 |       btnDel.className = "danger";
366 |       btnDel.type = "button";
367 |       btnDel.textContent = "Usu≈Ñ";
368 |       btnDel.addEventListener("click", async () => {
369 |         const ok = await showModal({
370 |           title: "UsunƒÖƒá post?",
371 |           body:
372 |             `<div>Ta operacja jest nieodwracalna.</div>` +
373 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
374 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
375 |           okText: "Usu≈Ñ",
376 |           danger: true,
377 |         });
378 |         if (!ok) return;
379 | 
380 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
381 |         if (!rr.ok) {
382 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
383 |           return;
384 |         }
385 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
386 |         await loadPosts();
387 |       });
388 | 
389 |       actions.appendChild(btnEdit);
390 |       actions.appendChild(btnDel);
391 | 
392 |       tdActions.appendChild(actions);
393 |       tr.appendChild(tdActions);
394 | 
395 |       elPostsTbody.appendChild(tr);
396 |     }
397 |   }
398 | 
399 |   async function addPost() {
400 |     const url = (elNewPostUrl.value || "").trim();
401 |     const name = (elNewPostName.value || "").trim();
402 |     const image = (elNewPostImage.value || "").trim();
403 |     const description = (elNewPostDescription.value || "").trim();
404 |     const active = !!elNewPostActive.checked;
405 | 
406 |     const r = await api("/api/posts", {
407 |       method: "POST",
408 |       body: { url, name, image, description, active },
409 |     });
410 | 
411 |     if (!r.ok) {
412 |       await showModal({
413 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
414 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
415 |         okText: "OK",
416 |         danger: false,
417 |       });
418 |       return;
419 |     }
420 | 
421 |     elNewPostUrl.value = "";
422 |     elNewPostName.value = "";
423 |     elNewPostImage.value = "";
424 |     elNewPostDescription.value = "";
425 |     elNewPostActive.checked = true;
426 | 
427 |     setHint(elEnvMsg, "Dodano post.", true);
428 |     await loadPosts();
429 |   }
430 | 
431 |   async function pm2Call(which) {
432 |     const map = {
433 |       start: "/api/pm2/start",
434 |       stop: "/api/pm2/stop",
435 |       restart: "/api/pm2/restart",
436 |       status: "/api/pm2/status",
437 |     };
438 |     const path = map[which];
439 |     if (!path) return;
440 | 
441 |     const label =
442 |       which === "start" ? "Startujƒô watchera..."
443 |         : which === "stop" ? "Zatrzymujƒô watchera..."
444 |           : which === "restart" ? "Restartujƒô watchera..."
445 |             : "Sprawdzam status...";
446 | 
447 |     setHint(elEnvMsg, label, true);
448 | 
449 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
450 |     if (!r.ok) {
451 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
452 |       return;
453 |     }
454 | 
455 |     const okMsg =
456 |       which === "start" ? "Watcher uruchomiony."
457 |         : which === "stop" ? "Watcher zatrzymany."
458 |           : which === "restart" ? "Watcher zrestartowany."
459 |             : "Status pobrany.";
460 | 
461 |     setHint(elEnvMsg, okMsg, true);
462 | 
463 |     if (which !== "status") await loadStatus();
464 |   }
465 | 
466 |   async function clearCookies() {
467 |     const ok = await showModal({
468 |       title: "Wyczy≈õciƒá cookies?",
469 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
470 |       okText: "Wyczy≈õƒá",
471 |       danger: true,
472 |     });
473 |     if (!ok) return;
474 | 
475 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
476 | 
477 |     const r = await api("/api/cookies/clear", {
478 |       method: "POST",
479 |       body: { confirm: true },
480 |     });
481 | 
482 |     if (!r.ok) {
483 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
484 |       return;
485 |     }
486 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
487 |   }
488 | 
489 |   // ---------- logs ----------
490 |   function getLines() {
491 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
492 |     if (!isFinite(n)) return 200;
493 |     return Math.max(20, Math.min(2000, n));
494 |   }
495 | 
496 |   async function loadLogs(mode) {
497 |     lastLogMode = mode;
498 |     const lines = getLines();
499 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
500 | 
501 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
502 |     if (!r.ok) {
503 |       elLogs.value = "";
504 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
505 |       return;
506 |     }
507 | 
508 |     elLogs.value = (r.log || "").toString();
509 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
510 | 
511 |     if (elLogAutoScroll.checked) {
512 |       elLogs.scrollTop = elLogs.scrollHeight;
513 |     }
514 |   }
515 | 
516 |   function stopAutoLogs() {
517 |     if (logAutoTimer) {
518 |       clearInterval(logAutoTimer);
519 |       logAutoTimer = null;
520 |     }
521 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
522 |     btnLogAutoToggle.classList.remove("primary");
523 |   }
524 | 
525 |   function startAutoLogs() {
526 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
527 |     if (every <= 0) {
528 |       stopAutoLogs();
529 |       return;
530 |     }
531 | 
532 |     stopAutoLogs();
533 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
534 |     btnLogAutoToggle.classList.add("primary");
535 | 
536 |     logAutoTimer = setInterval(() => {
537 |       loadLogs(lastLogMode).catch(() => {});
538 |     }, every);
539 |   }
540 | 
541 |   function toggleLogsSize() {
542 |     logsExpanded = !logsExpanded;
543 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
544 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
545 |   }
546 | 
547 |   // ---------- utils ----------
548 |   async function copyToClipboard(text) {
549 |     try {
550 |       await navigator.clipboard.writeText(text);
551 |       return true;
552 |     } catch (e) {
553 |       const ta = document.createElement("textarea");
554 |       ta.value = text;
555 |       ta.style.position = "fixed";
556 |       ta.style.opacity = "0";
557 |       document.body.appendChild(ta);
558 |       ta.select();
559 |       try {
560 |         document.execCommand("copy");
561 |         document.body.removeChild(ta);
562 |         return true;
563 |       } catch {
564 |         document.body.removeChild(ta);
565 |         return false;
566 |       }
567 |     }
568 |   }
569 | 
570 |   function escapeHtml(s) {
571 |     return String(s || "")
572 |       .replaceAll("&", "&amp;")
573 |       .replaceAll("<", "&lt;")
574 |       .replaceAll(">", "&gt;")
575 |       .replaceAll('"', "&quot;")
576 |       .replaceAll("'", "&#039;");
577 |   }
578 | 
579 |   // ---------- wire events ----------
580 |   function wire() {
581 |     elToken.value = token;
582 | 
583 |     btnSaveToken.addEventListener("click", async () => {
584 |       token = (elToken.value || "").trim();
585 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
586 |       await hardRefresh();
587 |     });
588 | 
589 |     btnRefresh.addEventListener("click", async () => {
590 |       await hardRefresh();
591 |     });
592 | 
593 |     btnSaveEnv.addEventListener("click", async () => {
594 |       await saveEnv(false);
595 |     });
596 | 
597 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
598 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
599 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
600 | 
601 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
602 | 
603 |     btnAddPost.addEventListener("click", async () => await addPost());
604 | 
605 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
606 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
607 | 
608 |     btnLogAutoToggle.addEventListener("click", () => {
609 |       if (logAutoTimer) stopAutoLogs();
610 |       else startAutoLogs();
611 |     });
612 | 
613 |     elLogAutoEvery.addEventListener("change", () => {
614 |       if (logAutoTimer) startAutoLogs();
615 |     });
616 | 
617 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
618 |   }
619 | 
620 |   async function hardRefresh() {
621 |     await loadStatus();
622 |     await loadEnv();
623 |     await loadPosts();
624 | 
625 |     if (elLogs.value && elLogs.value.trim().length > 0) {
626 |       await loadLogs(lastLogMode);
627 |     }
628 |   }
629 | 
630 |   // ---------- init ----------
631 |   wire();
632 |   hardRefresh().catch(() => {
633 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
634 |   });
635 | })();
636 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/.env`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  

```dotenv
 1 | >FB_EMAIL=enzosmaigpt@gmail.com
 2 | FB_PASSWORD=Supersmart97!
 3 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz  # tutaj sw√≥j webhook z Make
 4 | CHECK_INTERVAL_MS=60000                         # co ile ms sprawdzaƒá (np. 60000 = 1 min)
 5 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
 6 | COOKIES_READ_ONLY=false
 7 | HEADLESS_BROWSER=false
 8 | USE_UI_HANDLERS=false
 9 | INCLUDE_REPLIES=true
10 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/api.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // panel/api.js
  2 | import http from "http";
  3 | import { exec } from "child_process";
  4 | import fs from "fs";
  5 | import path from "path";
  6 | import crypto from "crypto";
  7 | import dotenv from "dotenv";
  8 | 
  9 | // ---- BASE DIR (dev vs exe) ----
 10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 11 | 
 12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 15 | 
 16 | // UI: dev -> src/panel/ui, exe -> ./ui
 17 | const UI_DIR = process.pkg
 18 |   ? path.join(BASE_DIR, "ui")
 19 |   : path.join(BASE_DIR, "src", "panel", "ui");
 20 | 
 21 | const PORT = Number(process.env.PANEL_PORT || 3180);
 22 | const TOKEN = process.env.PANEL_TOKEN;
 23 | 
 24 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 25 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 26 | 
 27 | if (!TOKEN) {
 28 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 29 |   process.exit(1);
 30 | }
 31 | 
 32 | function auth(req, res) {
 33 |   const h = req.headers["authorization"] || "";
 34 |   if (h !== `Bearer ${TOKEN}`) {
 35 |     res.writeHead(401);
 36 |     res.end("Unauthorized");
 37 |     return false;
 38 |   }
 39 |   return true;
 40 | }
 41 | 
 42 | function json(res, obj, code = 200) {
 43 |   res.writeHead(code, { "Content-Type": "application/json" });
 44 |   res.end(JSON.stringify(obj, null, 2));
 45 | }
 46 | 
 47 | function sh(cmd) {
 48 |   return new Promise((resolve) => {
 49 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 50 |       resolve({
 51 |         ok: !err,
 52 |         stdout: (stdout || "").trim(),
 53 |         stderr: (stderr || "").trim(),
 54 |         code: err?.code ?? 0,
 55 |       });
 56 |     });
 57 |   });
 58 | }
 59 | 
 60 | 
 61 | async function getProjectDir() {
 62 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 63 | 
 64 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 65 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 66 |   if (!m)
 67 |     throw new Error(
 68 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 69 |     );
 70 |   return m[1].trim();
 71 | }
 72 | 
 73 | function readBody(req) {
 74 |   return new Promise((resolve) => {
 75 |     let d = "";
 76 |     req.on("data", (c) => (d += c));
 77 |     req.on("end", () => resolve(d));
 78 |   });
 79 | }
 80 | 
 81 | function safeJsonParse(s) {
 82 |   try {
 83 |     return { ok: true, value: JSON.parse(s) };
 84 |   } catch (e) {
 85 |     return { ok: false, error: e?.message || "Invalid JSON" };
 86 |   }
 87 | }
 88 | 
 89 | function ensureDir(p) {
 90 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
 91 | }
 92 | 
 93 | function atomicWriteFile(filePath, content) {
 94 |   const dir = path.dirname(filePath);
 95 |   ensureDir(dir);
 96 | 
 97 |   const tmp = path.join(
 98 |     dir,
 99 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
100 |   );
101 |   fs.writeFileSync(tmp, content, "utf8");
102 |   fs.renameSync(tmp, filePath);
103 | }
104 | 
105 | function normalizeUrl(u) {
106 |   if (!u) return "";
107 |   const x = String(u).trim();
108 |   if (!/^https?:\/\/.+/i.test(x)) return "";
109 |   return x;
110 | }
111 | 
112 | function normalizeOptionalUrl(u) {
113 |   if (!u) return "";
114 |   const x = String(u).trim();
115 |   if (x === "") return "";
116 |   if (!/^https?:\/\/.+/i.test(x)) return "";
117 |   return x;
118 | }
119 | 
120 | function nowIso() {
121 |   return new Date().toISOString();
122 | }
123 | 
124 | function setEnvKey(envText, key, value) {
125 |   const re = new RegExp(`^${key}=.*$`, "m");
126 |   const line = `${key}=${value}`;
127 |   if (re.test(envText)) return envText.replace(re, line);
128 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
129 | }
130 | 
131 | function pickPostsFile(projectDir) {
132 |   return path.join(projectDir, "data", "posts.json");
133 | }
134 | 
135 | function readPosts(postsPath) {
136 |   if (!fs.existsSync(postsPath)) return [];
137 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
138 |   if (!raw) return [];
139 |   const parsed = safeJsonParse(raw);
140 |   if (!parsed.ok || !Array.isArray(parsed.value))
141 |     throw new Error("posts.json invalid (expected array)");
142 |   return parsed.value;
143 | }
144 | 
145 | function writePosts(postsPath, posts) {
146 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
147 | }
148 | 
149 | function genId() {
150 |   return crypto.randomBytes(8).toString("hex");
151 | }
152 | 
153 | function route(req) {
154 |   const url = new URL(req.url, "http://localhost");
155 |   const pathname = url.pathname;
156 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
157 | }
158 | 
159 | function match(pathname, pattern) {
160 |   const a = pathname.split("/").filter(Boolean);
161 |   const b = pattern.split("/").filter(Boolean);
162 |   if (a.length !== b.length) return null;
163 |   const params = {};
164 |   for (let i = 0; i < a.length; i++) {
165 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
166 |     else if (a[i] !== b[i]) return null;
167 |   }
168 |   return params;
169 | }
170 | 
171 | // ---------- LOGS (dynamic from pm2 describe) ----------
172 | function parsePm2LogPaths(pm2DescribeText) {
173 |   const out =
174 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
175 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
176 |     "";
177 |   const err =
178 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
179 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
180 |     "";
181 |   return { out, err };
182 | }
183 | 
184 | async function getPm2LogPaths(appName) {
185 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
186 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
187 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
188 | 
189 |   const d = await sh(`pm2 describe ${appName}`);
190 |   if (!d.ok)
191 |     return {
192 |       out: "",
193 |       err: "",
194 |       source: "pm2_error",
195 |       pm2: d.stderr || d.stdout || "",
196 |     };
197 | 
198 |   const p = parsePm2LogPaths(d.stdout);
199 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
200 | }
201 | 
202 | async function readTailLog(filePath, lines) {
203 |   try {
204 |     if (!filePath) {
205 |       return {
206 |         ok: false,
207 |         error:
208 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
209 |         path: filePath,
210 |       };
211 |     }
212 | 
213 |     if (!fs.existsSync(filePath)) {
214 |       return {
215 |         ok: false,
216 |         error:
217 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
218 |         path: filePath,
219 |       };
220 |     }
221 | 
222 |     const st = fs.statSync(filePath);
223 |     if (!st || !st.isFile()) {
224 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
225 |     }
226 | 
227 |     if (st.size === 0) {
228 |       return {
229 |         ok: false,
230 |         error:
231 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
232 |         path: filePath,
233 |       };
234 |     }
235 | 
236 |     
237 |     // fallback JS
238 |     const raw = fs.readFileSync(filePath, "utf8");
239 |     const arr = raw.split(/\r?\n/);
240 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
241 |     const txt = (slice || "").trim();
242 | 
243 |     if (!txt) {
244 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
245 |     }
246 | 
247 |     return { ok: true, log: slice, path: filePath, via: "js" };
248 |   } catch (e) {
249 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
250 |   }
251 | }
252 | 
253 | http
254 |   .createServer(async (req, res) => {
255 |     const { pathname, query } = route(req);
256 |     if (req.method === "GET" && pathname === "/ping") {
257 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
258 |   res.end("pong");
259 |   return;
260 | }
261 | 
262 | 
263 |     // ---------- PUBLIC UI ----------
264 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
265 |       const p = path.join(UI_DIR, "index.html");
266 |       const html = fs.readFileSync(p, "utf8");
267 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
268 |       res.end(html);
269 |       return;
270 |     }
271 | 
272 |     if (req.method === "GET" && pathname === "/app.js") {
273 |       const p = path.join(UI_DIR, "app.js");
274 |       const js = fs.readFileSync(p, "utf8");
275 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
276 |       res.end(js);
277 |       return;
278 |     }
279 | 
280 |     // ---------- AUTH for API ----------
281 |     if (pathname.startsWith("/api/")) {
282 |       if (!auth(req, res)) return;
283 |     }
284 | 
285 |     try {
286 |       const PROJECT_DIR = await getProjectDir();
287 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
288 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
289 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
290 | 
291 |       // ===== STATUS =====
292 |       if (req.method === "GET" && pathname === "/api/status") {
293 |         const node = await sh("node -v");
294 |         const pm2v = await sh("pm2 -v");
295 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
296 |         json(res, {
297 |           ok: true,
298 |           projectDir: PROJECT_DIR,
299 |           envPath: ENV_PATH,
300 |           cookiesPath: COOKIES_PATH,
301 |           postsPath: POSTS_PATH,
302 |           node: node.stdout,
303 |           pm2: pm2v.stdout,
304 |           pm2Status: pm2s.stdout,
305 |           time: nowIso(),
306 |         });
307 |         return;
308 |       }
309 | 
310 |       // ===== ENV GET (selected keys) =====
311 |       if (req.method === "GET" && pathname === "/api/env/get") {
312 |         if (!fs.existsSync(ENV_PATH)) {
313 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
314 |           return;
315 |         }
316 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
317 |         const wanted = [
318 |           "FB_EMAIL",
319 |           "FB_PASSWORD",
320 |           "WEBHOOK_URL",
321 |           "CHECK_INTERVAL_MS",
322 |           "POSTS_SHEET_URL",
323 |           "HEADLESS_BROWSER",
324 |           "USE_UI_HANDLERS",
325 |           "INCLUDE_REPLIES",
326 |         ];
327 |         const values = {};
328 |         for (const k of wanted) {
329 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
330 |           values[k] = m ? m[1] : "";
331 |         }
332 |         json(res, { ok: true, values });
333 |         return;
334 |       }
335 | 
336 |       // ===== ENV SET MULTIPLE =====
337 |       if (req.method === "POST" && pathname === "/api/env/set") {
338 |         const bodyRaw = await readBody(req);
339 |         const parsed = safeJsonParse(bodyRaw || "{}");
340 |         if (!parsed.ok) {
341 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
342 |           return;
343 |         }
344 | 
345 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
346 |         const restart = Boolean(parsed.value.restart);
347 | 
348 |         if (!set) {
349 |           json(res, { ok: false, error: "Missing set object" }, 400);
350 |           return;
351 |         }
352 |         if (!fs.existsSync(ENV_PATH)) {
353 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
354 |           return;
355 |         }
356 | 
357 |         let env = fs.readFileSync(ENV_PATH, "utf8");
358 |         const updated = [];
359 | 
360 |         for (const [k, v] of Object.entries(set)) {
361 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
362 |           env = setEnvKey(env, k, String(v));
363 |           updated.push(k);
364 |         }
365 | 
366 |         atomicWriteFile(ENV_PATH, env);
367 | 
368 |         let pm2Action = null;
369 |         if (restart) {
370 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
371 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
372 |         }
373 | 
374 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
375 |         return;
376 |       }
377 | 
378 |       // ===== POSTS: LIST =====
379 |       if (req.method === "GET" && pathname === "/api/posts") {
380 |         const posts = readPosts(POSTS_PATH);
381 | 
382 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
383 |         const norm = (posts || []).map((p) => ({
384 |           id: String(p.id || "").trim(),
385 |           url: String(p.url || "").trim(),
386 |           active: p.active !== undefined ? Boolean(p.active) : true,
387 |           name: String(p.name || "").trim(),
388 |           image: String(p.image || "").trim(),
389 |           description: String(p.description || "").trim(),
390 |           createdAt: p.createdAt || "",
391 |           updatedAt: p.updatedAt || "",
392 |         }));
393 | 
394 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
395 |         json(res, { ok: true, posts: norm });
396 |         return;
397 |       }
398 | 
399 |       // ===== POSTS: ADD =====
400 |       if (req.method === "POST" && pathname === "/api/posts") {
401 |         const bodyRaw = await readBody(req);
402 |         const parsed = safeJsonParse(bodyRaw || "{}");
403 |         if (!parsed.ok) {
404 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
405 |           return;
406 |         }
407 | 
408 |         const url = normalizeUrl(parsed.value.url);
409 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
410 | 
411 |         const name = String(parsed.value.name || "").trim();
412 |         const imageRaw = String(parsed.value.image || "").trim();
413 |         const image = normalizeOptionalUrl(imageRaw);
414 |         const description = String(parsed.value.description || "").trim();
415 | 
416 |         if (!url) {
417 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
418 |           return;
419 |         }
420 |         if (imageRaw !== "" && !image) {
421 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
422 |           return;
423 |         }
424 | 
425 |         const posts = readPosts(POSTS_PATH);
426 |         const existing = posts.find((p) => p.url === url);
427 |         if (existing) {
428 |           existing.active = active;
429 |           existing.name = name;
430 |           existing.image = image;
431 |           existing.description = description;
432 |           existing.updatedAt = nowIso();
433 |           writePosts(POSTS_PATH, posts);
434 |           json(res, { ok: true, post: existing, deduped: true });
435 |           return;
436 |         }
437 | 
438 |         const post = {
439 |           id: genId(),
440 |           url,
441 |           active,
442 |           name,
443 |           image,
444 |           description,
445 |           createdAt: nowIso(),
446 |           updatedAt: nowIso(),
447 |         };
448 |         posts.push(post);
449 |         writePosts(POSTS_PATH, posts);
450 | 
451 |         json(res, { ok: true, post });
452 |         return;
453 |       }
454 | 
455 |       // ===== POSTS: PATCH =====
456 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
457 |       if (mPatch) {
458 |         const id = mPatch.id;
459 |         const bodyRaw = await readBody(req);
460 |         const parsed = safeJsonParse(bodyRaw || "{}");
461 |         if (!parsed.ok) {
462 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
463 |           return;
464 |         }
465 | 
466 |         const posts = readPosts(POSTS_PATH);
467 |         const post = posts.find((p) => p.id === id);
468 |         if (!post) {
469 |           json(res, { ok: false, error: "Post not found" }, 404);
470 |           return;
471 |         }
472 | 
473 |         if (parsed.value.url !== undefined) {
474 |           const nextUrl = normalizeUrl(parsed.value.url);
475 |           if (!nextUrl) {
476 |             json(res, { ok: false, error: "Invalid url" }, 400);
477 |             return;
478 |           }
479 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
480 |           if (dup) {
481 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
482 |             return;
483 |           }
484 |           post.url = nextUrl;
485 |         }
486 | 
487 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
488 | 
489 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
490 | 
491 |         if (parsed.value.image !== undefined) {
492 |           const raw = String(parsed.value.image || "").trim();
493 |           const img = normalizeOptionalUrl(raw);
494 |           if (raw !== "" && !img) {
495 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
496 |             return;
497 |           }
498 |           post.image = img;
499 |         }
500 | 
501 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
502 | 
503 |         post.updatedAt = nowIso();
504 |         writePosts(POSTS_PATH, posts);
505 |         json(res, { ok: true, post });
506 |         return;
507 |       }
508 | 
509 |       // ===== POSTS: DELETE =====
510 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
511 |       if (mDel) {
512 |         const id = mDel.id;
513 |         const posts = readPosts(POSTS_PATH);
514 |         const idx = posts.findIndex((p) => p.id === id);
515 |         if (idx === -1) {
516 |           json(res, { ok: false, error: "Post not found" }, 404);
517 |           return;
518 |         }
519 |         const removed = posts.splice(idx, 1)[0];
520 |         writePosts(POSTS_PATH, posts);
521 |         json(res, { ok: true, removed });
522 |         return;
523 |       }
524 | 
525 |       // ===== COOKIES: CLEAR =====
526 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
527 |         const bodyRaw = await readBody(req);
528 |         const parsed = safeJsonParse(bodyRaw || "{}");
529 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
530 | 
531 |         if (!confirm) {
532 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
533 |           return;
534 |         }
535 | 
536 |         atomicWriteFile(COOKIES_PATH, "[]\n");
537 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
538 |         return;
539 |       }
540 | 
541 |       // ===== PM2 =====
542 |       function okOrErr(r, fallbackErr = "Command failed") {
543 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
544 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
545 |       }
546 |       async function pm2Describe(name) {
547 |         return await sh(`pm2 describe ${name}`);
548 |       }
549 | 
550 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
551 |       const WATCH_NAME = PM2_APP || "fbwatcher";
552 | 
553 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
554 |         const d = await pm2Describe(WATCH_NAME);
555 |         if (d.ok) {
556 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
557 |           json(res, okOrErr(r, "PM2 start failed"));
558 |           return;
559 |         }
560 | 
561 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
562 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
563 |         return;
564 |       }
565 | 
566 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
567 |         const d = await pm2Describe(WATCH_NAME);
568 |         if (!d.ok) {
569 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
570 |           return;
571 |         }
572 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
573 |         json(res, okOrErr(r, "PM2 restart failed"));
574 |         return;
575 |       }
576 | 
577 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
578 |         const d = await pm2Describe(WATCH_NAME);
579 |         if (!d.ok) {
580 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
581 |           return;
582 |         }
583 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
584 |         json(res, okOrErr(r, "PM2 stop failed"));
585 |         return;
586 |       }
587 | 
588 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
589 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
590 |         json(res, okOrErr(r, "PM2 status failed"));
591 |         return;
592 |       }
593 | 
594 |       // ===== LOGS INFO (debug) =====
595 |       if (req.method === "GET" && pathname === "/api/logs/info") {
596 |         const paths = await getPm2LogPaths(PM2_APP);
597 |         json(res, { ok: true, app: PM2_APP, ...paths });
598 |         return;
599 |       }
600 | 
601 |       // ===== LOGS =====
602 |       if (req.method === "GET" && pathname === "/api/logs/out") {
603 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
604 |         const paths = await getPm2LogPaths(PM2_APP);
605 |         const payload = await readTailLog(paths.out, lines);
606 |         json(res, { ...payload, source: paths.source });
607 |         return;
608 |       }
609 | 
610 |       if (req.method === "GET" && pathname === "/api/logs/err") {
611 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
612 |         const paths = await getPm2LogPaths(PM2_APP);
613 |         const payload = await readTailLog(paths.err, lines);
614 |         json(res, { ...payload, source: paths.source });
615 |         return;
616 |       }
617 | 
618 |       json(res, { ok: false, error: "Not found" }, 404);
619 |     } catch (e) {
620 |       json(res, { ok: false, error: e.message }, 500);
621 |     }
622 |   })
623 |   .listen(PORT, "127.0.0.1", () => {
624 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
625 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
626 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
627 |   });
628 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/app.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | (() => {
  2 |   const $ = (id) => document.getElementById(id);
  3 | 
  4 |   // ---------- state ----------
  5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
  6 |   let logAutoTimer = null;
  7 |   let lastLogMode = "out"; // 'out' | 'err'
  8 |   let logsExpanded = false;
  9 | 
 10 |   // modal state
 11 |   let modalResolve = null;
 12 | 
 13 |   // edit modal state
 14 |   let editResolve = null;
 15 | 
 16 |   // ---------- ui refs ----------
 17 |   const elToken = $("token");
 18 |   const btnSaveToken = $("saveToken");
 19 |   const btnRefresh = $("refresh");
 20 |   const elStatus = $("status");
 21 | 
 22 |   const btnSaveEnv = $("saveEnv");
 23 |   const btnPm2Start = $("pm2Start");
 24 |   const btnPm2Stop = $("pm2Stop");
 25 |   const btnPm2Restart = $("pm2Restart");
 26 |   const btnClearCookies = $("clearCookies");
 27 |   const elEnvMsg = $("envMsg");
 28 | 
 29 |   const elNewPostUrl = $("newPostUrl");
 30 |   const elNewPostName = $("newPostName");
 31 |   const elNewPostImage = $("newPostImage");
 32 |   const elNewPostDescription = $("newPostDescription");
 33 |   const elNewPostActive = $("newPostActive");
 34 |   const btnAddPost = $("addPost");
 35 |   const elPostsTbody = $("posts");
 36 | 
 37 |   const btnLoadOut = $("loadOut");
 38 |   const btnLoadErr = $("loadErr");
 39 |   const elLogLines = $("logLines");
 40 |   const elLogAutoEvery = $("logAutoEvery");
 41 |   const btnLogAutoToggle = $("logAutoToggle");
 42 |   const elLogAutoScroll = $("logAutoScroll");
 43 |   const elLogs = $("logs");
 44 |   const elLogHint = $("logHint");
 45 | 
 46 |   const logsCard = $("logsCard");
 47 |   const btnToggleLogsSize = $("toggleLogsSize");
 48 | 
 49 |   // modal refs (delete + generic)
 50 |   const modalOverlay = $("modalOverlay");
 51 |   const modalBody = $("modalBody");
 52 |   const modalCancel = $("modalCancel");
 53 |   const modalOk = $("modalOk");
 54 | 
 55 |   // env fields
 56 |   const ENV_FIELDS = [
 57 |     "FB_EMAIL",
 58 |     "FB_PASSWORD",
 59 |     "WEBHOOK_URL",
 60 |     "CHECK_INTERVAL_MS",
 61 |     "POSTS_SHEET_URL",
 62 |     "HEADLESS_BROWSER",
 63 |     "USE_UI_HANDLERS",
 64 |     "INCLUDE_REPLIES",
 65 |   ];
 66 | 
 67 |   function setHint(el, msg, ok = true) {
 68 |     if (!el) return;
 69 |     el.textContent = msg || "";
 70 |     el.classList.remove("ok", "err");
 71 |     el.classList.add(ok ? "ok" : "err");
 72 |   }
 73 | 
 74 |   function fmtTime() {
 75 |     try {
 76 |       return new Date().toLocaleString();
 77 |     } catch {
 78 |       return "";
 79 |     }
 80 |   }
 81 | 
 82 |   function getAuthHeaders() {
 83 |     const t = (token || "").trim();
 84 |     return t ? { Authorization: `Bearer ${t}` } : {};
 85 |   }
 86 | 
 87 |   async function api(path, opts = {}) {
 88 |     const headers = {
 89 |       ...(opts.headers || {}),
 90 |       ...getAuthHeaders(),
 91 |     };
 92 | 
 93 |     let body = opts.body;
 94 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
 95 |       headers["Content-Type"] = "application/json";
 96 |       body = JSON.stringify(body);
 97 |     }
 98 | 
 99 |     const res = await fetch(path, {
100 |       method: opts.method || "GET",
101 |       headers,
102 |       body,
103 |     });
104 | 
105 |     const text = await res.text();
106 |     let data = null;
107 |     try {
108 |       data = JSON.parse(text);
109 |     } catch {
110 |       data = { ok: false, error: text || `HTTP ${res.status}` };
111 |     }
112 | 
113 |     if (!res.ok) {
114 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
115 |     }
116 |     return data;
117 |   }
118 | 
119 |   // ---------- modal ----------
120 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
121 |     return new Promise((resolve) => {
122 |       modalResolve = resolve;
123 | 
124 |       $("modalTitle").textContent = title;
125 |       modalBody.innerHTML = body;
126 | 
127 |       modalOk.textContent = okText;
128 |       modalOk.classList.toggle("danger", !!danger);
129 | 
130 |       modalOverlay.classList.add("show");
131 |       modalOverlay.setAttribute("aria-hidden", "false");
132 | 
133 |       setTimeout(() => {
134 |         (danger ? modalOk : modalCancel).focus();
135 |       }, 0);
136 |     });
137 |   }
138 | 
139 |   function closeModal(result) {
140 |     modalOverlay.classList.remove("show");
141 |     modalOverlay.setAttribute("aria-hidden", "true");
142 |     const r = modalResolve;
143 |     modalResolve = null;
144 |     if (typeof r === "function") r(result);
145 |   }
146 | 
147 |   modalCancel.addEventListener("click", () => closeModal(false));
148 |   modalOk.addEventListener("click", () => closeModal(true));
149 |   modalOverlay.addEventListener("click", (e) => {
150 |     if (e.target === modalOverlay) closeModal(false);
151 |   });
152 |   window.addEventListener("keydown", (e) => {
153 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
154 |   });
155 | 
156 |   // ---------- core actions ----------
157 |   async function loadStatus() {
158 |     setHint(elStatus, "≈Åadowanie statusu...", true);
159 | 
160 |     const r = await api("/api/status");
161 |     if (!r.ok) {
162 |       setHint(
163 |         elStatus,
164 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
165 |         false
166 |       );
167 |       return null;
168 |     }
169 | 
170 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
171 |     return r;
172 |   }
173 | 
174 |   async function loadEnv() {
175 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
176 |     const r = await api("/api/env/get");
177 |     if (!r.ok) {
178 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
179 |       return;
180 |     }
181 |     const v = r.values || {};
182 |     for (const k of ENV_FIELDS) {
183 |       const el = $(k);
184 |       if (!el) continue;
185 |       el.value = (v[k] ?? "").toString();
186 |     }
187 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
188 |   }
189 | 
190 |   async function saveEnv(restart = false) {
191 |     const set = {};
192 |     for (const k of ENV_FIELDS) {
193 |       const el = $(k);
194 |       if (!el) continue;
195 |       set[k] = (el.value ?? "").toString();
196 |     }
197 | 
198 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
199 | 
200 |     const r = await api("/api/env/set", {
201 |       method: "POST",
202 |       body: { set, restart },
203 |     });
204 | 
205 |     if (!r.ok) {
206 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
207 |       return;
208 |     }
209 | 
210 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
211 |   }
212 | 
213 |   function copyIconSvg() {
214 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
215 |     return `
216 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
217 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
218 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
219 |       </svg>
220 |     `;
221 |   }
222 | 
223 |   async function loadPosts() {
224 |     const r = await api("/api/posts");
225 |     if (!r.ok) {
226 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
227 |       return;
228 |     }
229 | 
230 |     const posts = Array.isArray(r.posts) ? r.posts : [];
231 |     elPostsTbody.innerHTML = "";
232 | 
233 |     for (const p of posts) {
234 |       const tr = document.createElement("tr");
235 | 
236 |       const tdId = document.createElement("td");
237 |       tdId.className = "mono col-id";
238 |       tdId.textContent = p.id || "";
239 |       tr.appendChild(tdId);
240 | 
241 |       // LINK + IKONKA KOPIUJ PRZY LINKU
242 |       const tdUrl = document.createElement("td");
243 |       tdUrl.className = "col-url";
244 | 
245 |       if (p.url) {
246 |         const wrap = document.createElement("div");
247 |         wrap.className = "urlWrap";
248 | 
249 |         const a = document.createElement("a");
250 |         a.href = p.url;
251 |         a.target = "_blank";
252 |         a.rel = "noopener noreferrer";
253 |         a.textContent = p.url;
254 | 
255 |         const btnCopyIcon = document.createElement("button");
256 |         btnCopyIcon.className = "iconBtn";
257 |         btnCopyIcon.type = "button";
258 |         btnCopyIcon.title = "Kopiuj link";
259 |         btnCopyIcon.innerHTML = copyIconSvg();
260 | 
261 |         btnCopyIcon.addEventListener("click", async (e) => {
262 |           e.preventDefault();
263 |           e.stopPropagation();
264 | 
265 |           const ok = await copyToClipboard(p.url);
266 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
267 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
268 |         });
269 | 
270 |         wrap.appendChild(a);
271 |         wrap.appendChild(btnCopyIcon);
272 |         tdUrl.appendChild(wrap);
273 |       }
274 | 
275 |       tr.appendChild(tdUrl);
276 | 
277 |       const tdName = document.createElement("td");
278 |       tdName.className = "col-name";
279 |       tdName.textContent = p.name || "";
280 |       tr.appendChild(tdName);
281 | 
282 |       const tdImg = document.createElement("td");
283 |       tdImg.className = "col-img";
284 |       if (p.image) {
285 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
286 |       } else {
287 |         tdImg.textContent = "";
288 |       }
289 |       tr.appendChild(tdImg);
290 | 
291 |       const tdDesc = document.createElement("td");
292 |       tdDesc.className = "col-desc";
293 |       tdDesc.textContent = p.description || "";
294 |       tr.appendChild(tdDesc);
295 | 
296 |       const tdActive = document.createElement("td");
297 |       tdActive.className = "col-act";
298 |       const chk = document.createElement("input");
299 |       chk.type = "checkbox";
300 |       chk.checked = !!p.active;
301 |       chk.addEventListener("change", async () => {
302 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
303 |           method: "PATCH",
304 |           body: { active: chk.checked },
305 |         });
306 |         await loadPosts();
307 |       });
308 |       tdActive.appendChild(chk);
309 |       tr.appendChild(tdActive);
310 | 
311 |       // AKCJE: EDYTUJ + USU≈É
312 |       const tdActions = document.createElement("td");
313 |       tdActions.className = "col-btn";
314 | 
315 |       const actions = document.createElement("div");
316 |       actions.className = "actionsWrap";
317 | 
318 |       const btnEdit = document.createElement("button");
319 |       btnEdit.className = "small";
320 |       btnEdit.type = "button";
321 |       btnEdit.textContent = "Edytuj";
322 |       btnEdit.addEventListener("click", async () => {
323 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
324 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
325 |         const ok = await showModal({
326 |           title: "Edytuj post",
327 |           body:
328 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
329 |             `<div style="margin-top:10px">
330 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
331 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
332 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
333 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
334 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
335 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
336 |               <label class="muted" style="display:block;margin:8px 0 6px;">Opis</label>
337 |               <textarea id="edit_desc" style="height:90px;">${escapeHtml(p.description || "")}</textarea>
338 |             </div>`,
339 |           okText: "Zapisz",
340 |           danger: false,
341 |         });
342 | 
343 |         if (!ok) return;
344 | 
345 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
346 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
347 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
348 |         const newDesc = (document.getElementById("edit_desc")?.value || "").trim();
349 | 
350 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
351 |           method: "PATCH",
352 |           body: { url: newUrl, name: newName, image: newImg, description: newDesc },
353 |         });
354 | 
355 |         if (!rr.ok) {
356 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
357 |           return;
358 |         }
359 | 
360 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
361 |         await loadPosts();
362 |       });
363 | 
364 |       const btnDel = document.createElement("button");
365 |       btnDel.className = "danger";
366 |       btnDel.type = "button";
367 |       btnDel.textContent = "Usu≈Ñ";
368 |       btnDel.addEventListener("click", async () => {
369 |         const ok = await showModal({
370 |           title: "UsunƒÖƒá post?",
371 |           body:
372 |             `<div>Ta operacja jest nieodwracalna.</div>` +
373 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
374 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
375 |           okText: "Usu≈Ñ",
376 |           danger: true,
377 |         });
378 |         if (!ok) return;
379 | 
380 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
381 |         if (!rr.ok) {
382 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
383 |           return;
384 |         }
385 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
386 |         await loadPosts();
387 |       });
388 | 
389 |       actions.appendChild(btnEdit);
390 |       actions.appendChild(btnDel);
391 | 
392 |       tdActions.appendChild(actions);
393 |       tr.appendChild(tdActions);
394 | 
395 |       elPostsTbody.appendChild(tr);
396 |     }
397 |   }
398 | 
399 |   async function addPost() {
400 |     const url = (elNewPostUrl.value || "").trim();
401 |     const name = (elNewPostName.value || "").trim();
402 |     const image = (elNewPostImage.value || "").trim();
403 |     const description = (elNewPostDescription.value || "").trim();
404 |     const active = !!elNewPostActive.checked;
405 | 
406 |     const r = await api("/api/posts", {
407 |       method: "POST",
408 |       body: { url, name, image, description, active },
409 |     });
410 | 
411 |     if (!r.ok) {
412 |       await showModal({
413 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
414 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
415 |         okText: "OK",
416 |         danger: false,
417 |       });
418 |       return;
419 |     }
420 | 
421 |     elNewPostUrl.value = "";
422 |     elNewPostName.value = "";
423 |     elNewPostImage.value = "";
424 |     elNewPostDescription.value = "";
425 |     elNewPostActive.checked = true;
426 | 
427 |     setHint(elEnvMsg, "Dodano post.", true);
428 |     await loadPosts();
429 |   }
430 | 
431 |   async function pm2Call(which) {
432 |     const map = {
433 |       start: "/api/pm2/start",
434 |       stop: "/api/pm2/stop",
435 |       restart: "/api/pm2/restart",
436 |       status: "/api/pm2/status",
437 |     };
438 |     const path = map[which];
439 |     if (!path) return;
440 | 
441 |     const label =
442 |       which === "start" ? "Startujƒô watchera..."
443 |         : which === "stop" ? "Zatrzymujƒô watchera..."
444 |           : which === "restart" ? "Restartujƒô watchera..."
445 |             : "Sprawdzam status...";
446 | 
447 |     setHint(elEnvMsg, label, true);
448 | 
449 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
450 |     if (!r.ok) {
451 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
452 |       return;
453 |     }
454 | 
455 |     const okMsg =
456 |       which === "start" ? "Watcher uruchomiony."
457 |         : which === "stop" ? "Watcher zatrzymany."
458 |           : which === "restart" ? "Watcher zrestartowany."
459 |             : "Status pobrany.";
460 | 
461 |     setHint(elEnvMsg, okMsg, true);
462 | 
463 |     if (which !== "status") await loadStatus();
464 |   }
465 | 
466 |   async function clearCookies() {
467 |     const ok = await showModal({
468 |       title: "Wyczy≈õciƒá cookies?",
469 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
470 |       okText: "Wyczy≈õƒá",
471 |       danger: true,
472 |     });
473 |     if (!ok) return;
474 | 
475 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
476 | 
477 |     const r = await api("/api/cookies/clear", {
478 |       method: "POST",
479 |       body: { confirm: true },
480 |     });
481 | 
482 |     if (!r.ok) {
483 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
484 |       return;
485 |     }
486 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
487 |   }
488 | 
489 |   // ---------- logs ----------
490 |   function getLines() {
491 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
492 |     if (!isFinite(n)) return 200;
493 |     return Math.max(20, Math.min(2000, n));
494 |   }
495 | 
496 |   async function loadLogs(mode) {
497 |     lastLogMode = mode;
498 |     const lines = getLines();
499 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
500 | 
501 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
502 |     if (!r.ok) {
503 |       elLogs.value = "";
504 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
505 |       return;
506 |     }
507 | 
508 |     elLogs.value = (r.log || "").toString();
509 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
510 | 
511 |     if (elLogAutoScroll.checked) {
512 |       elLogs.scrollTop = elLogs.scrollHeight;
513 |     }
514 |   }
515 | 
516 |   function stopAutoLogs() {
517 |     if (logAutoTimer) {
518 |       clearInterval(logAutoTimer);
519 |       logAutoTimer = null;
520 |     }
521 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
522 |     btnLogAutoToggle.classList.remove("primary");
523 |   }
524 | 
525 |   function startAutoLogs() {
526 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
527 |     if (every <= 0) {
528 |       stopAutoLogs();
529 |       return;
530 |     }
531 | 
532 |     stopAutoLogs();
533 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
534 |     btnLogAutoToggle.classList.add("primary");
535 | 
536 |     logAutoTimer = setInterval(() => {
537 |       loadLogs(lastLogMode).catch(() => {});
538 |     }, every);
539 |   }
540 | 
541 |   function toggleLogsSize() {
542 |     logsExpanded = !logsExpanded;
543 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
544 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
545 |   }
546 | 
547 |   // ---------- utils ----------
548 |   async function copyToClipboard(text) {
549 |     try {
550 |       await navigator.clipboard.writeText(text);
551 |       return true;
552 |     } catch (e) {
553 |       const ta = document.createElement("textarea");
554 |       ta.value = text;
555 |       ta.style.position = "fixed";
556 |       ta.style.opacity = "0";
557 |       document.body.appendChild(ta);
558 |       ta.select();
559 |       try {
560 |         document.execCommand("copy");
561 |         document.body.removeChild(ta);
562 |         return true;
563 |       } catch {
564 |         document.body.removeChild(ta);
565 |         return false;
566 |       }
567 |     }
568 |   }
569 | 
570 |   function escapeHtml(s) {
571 |     return String(s || "")
572 |       .replaceAll("&", "&amp;")
573 |       .replaceAll("<", "&lt;")
574 |       .replaceAll(">", "&gt;")
575 |       .replaceAll('"', "&quot;")
576 |       .replaceAll("'", "&#039;");
577 |   }
578 | 
579 |   // ---------- wire events ----------
580 |   function wire() {
581 |     elToken.value = token;
582 | 
583 |     btnSaveToken.addEventListener("click", async () => {
584 |       token = (elToken.value || "").trim();
585 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
586 |       await hardRefresh();
587 |     });
588 | 
589 |     btnRefresh.addEventListener("click", async () => {
590 |       await hardRefresh();
591 |     });
592 | 
593 |     btnSaveEnv.addEventListener("click", async () => {
594 |       await saveEnv(false);
595 |     });
596 | 
597 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
598 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
599 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
600 | 
601 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
602 | 
603 |     btnAddPost.addEventListener("click", async () => await addPost());
604 | 
605 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
606 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
607 | 
608 |     btnLogAutoToggle.addEventListener("click", () => {
609 |       if (logAutoTimer) stopAutoLogs();
610 |       else startAutoLogs();
611 |     });
612 | 
613 |     elLogAutoEvery.addEventListener("change", () => {
614 |       if (logAutoTimer) startAutoLogs();
615 |     });
616 | 
617 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
618 |   }
619 | 
620 |   async function hardRefresh() {
621 |     await loadStatus();
622 |     await loadEnv();
623 |     await loadPosts();
624 | 
625 |     if (elLogs.value && elLogs.value.trim().length > 0) {
626 |       await loadLogs(lastLogMode);
627 |     }
628 |   }
629 | 
630 |   // ---------- init ----------
631 |   wire();
632 |   hardRefresh().catch(() => {
633 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
634 |   });
635 | })();
636 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/cache.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // src/db/cache.js
 2 | import fs from "fs";
 3 | import path from "path";
 4 | 
 5 | const FILE = "./data/comments-cache.json";
 6 | 
 7 | /**
 8 |  * Upewnia siƒô, ≈ºe istnieje katalog ./data
 9 |  */
10 | function ensureDir() {
11 |   const dir = path.dirname(FILE);
12 |   if (!fs.existsSync(dir)) {
13 |     fs.mkdirSync(dir, { recursive: true });
14 |   }
15 | }
16 | 
17 | export function loadCache() {
18 |   try {
19 |     ensureDir();
20 |     if (!fs.existsSync(FILE)) return {};
21 |     const raw = fs.readFileSync(FILE, "utf8");
22 |     if (!raw.trim()) return {};
23 |     return JSON.parse(raw);
24 |   } catch (e) {
25 |     console.error("[Cache] B≈ÇƒÖd ≈Çadowania:", e.message);
26 |     return {};
27 |   }
28 | }
29 | 
30 | export function saveCache(cache) {
31 |   try {
32 |     ensureDir();
33 |     fs.writeFileSync(FILE, JSON.stringify(cache, null, 2), "utf8");
34 |   } catch (e) {
35 |     console.error("[Cache] B≈ÇƒÖd zapisu:", e.message);
36 |   }
37 | }
38 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments-cache.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
   1 | {
   2 |   "https://facebook.com/link1": {
   3 |     "lastCount": 29,
   4 |     "knownIds": [
   5 |       "123",
   6 |       "456"
   7 |     ]
   8 |   },
   9 |   "https://facebook.com/link2": {
  10 |     "lastCount": 57,
  11 |     "knownIds": [
  12 |       "abc",
  13 |       "def"
  14 |     ]
  15 |   },
  16 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid079NeZjZknqqgvVLHDt5vpJgYqcX7UvssfEST6NiitVe3onh4qYokNA85DnZK1BhPl&id=100090694156429&__cft__[0]=AZWmzrfj9TrX5809IiholJ6RkBsezJVNuGQJNMH52aluQjQSwydq4YraJ8rlkQorKEpIh1N7abUBI-efeoMG2uMQfkzu1usqipQ_WKHQUVfq33KA6HpnZOuStLznHFvipBOGUQpnnjdL3oI5_4ZaCo6wXBYwnLzyiykZlimAEuBJsQ&__tn__=%2CO%2CP-R-R": {
  17 |     "lastCount": 104,
  18 |     "knownIds": [
  19 |       "1484858249285495",
  20 |       "813389271325163",
  21 |       "1554947679035357",
  22 |       "2064706784353621",
  23 |       "1400229968337586",
  24 |       "3146745832165404",
  25 |       "864901412623837",
  26 |       "1334534481217980",
  27 |       "1216871160254967",
  28 |       "835691398836304",
  29 |       "1765746040745680",
  30 |       "1484095092670708",
  31 |       "2142426246288280",
  32 |       "1354810826103677",
  33 |       "3231812590299517",
  34 |       "1787108076024772",
  35 |       "2037082873729847",
  36 |       "810095718578035",
  37 |       "1496580228290704",
  38 |       "1285300293282784",
  39 |       "885834407309298",
  40 |       "2010918516356987",
  41 |       "1145766607762431",
  42 |       "1384920606355138",
  43 |       "1099282025432920",
  44 |       "782259838102706",
  45 |       "1630651867913592",
  46 |       "1551288445886787",
  47 |       "1107523747914378",
  48 |       "1891179351488048",
  49 |       "837432745336470",
  50 |       "1306699774561125",
  51 |       "849083654308399",
  52 |       "1159662906331762",
  53 |       "1503740687509347",
  54 |       "1167731508198719",
  55 |       "631812859921567",
  56 |       "832530796255974",
  57 |       "25044316688560452",
  58 |       "1836420183740368",
  59 |       "1869539913655384",
  60 |       "1925478198312702",
  61 |       "790410607328297",
  62 |       "1499721354445851",
  63 |       "2215897285600409",
  64 |       "1785285768710210",
  65 |       "689438657224839",
  66 |       "814192041462836",
  67 |       "1339557404321088",
  68 |       "819227754057961",
  69 |       "853366920378300",
  70 |       "690043700835679",
  71 |       "1161513736091920",
  72 |       "1402865434541124",
  73 |       "1378640030285785",
  74 |       "4287827091539742",
  75 |       "2260484717754151",
  76 |       "4278060919181347",
  77 |       "1146617930935835",
  78 |       "2925190721008415",
  79 |       "3424769301006561",
  80 |       "1387548826218225",
  81 |       "1560722205371869",
  82 |       "2285358328556761",
  83 |       "1338022761205508",
  84 |       "1616803799202675",
  85 |       "1380319883472469",
  86 |       "25053704220950267",
  87 |       "699216616574439",
  88 |       "1200160261543254",
  89 |       "817272907772287",
  90 |       "1528135821848453",
  91 |       "813912798071240",
  92 |       "1514009586484637",
  93 |       "809421785317123",
  94 |       "1199323368711290",
  95 |       "1585261986244190",
  96 |       "636284516218701",
  97 |       "1493955611830762",
  98 |       "843308691393626",
  99 |       "672678829055747",
 100 |       "1491665861892549",
 101 |       "819224034469759",
 102 |       "1204107861783559",
 103 |       "2691413441208886",
 104 |       "1143829177957375",
 105 |       "2964604867059729",
 106 |       "1255315996355719",
 107 |       "735547182905880",
 108 |       "1186687466677656",
 109 |       "1227664472885150",
 110 |       "1504779077395595",
 111 |       "612236685246014",
 112 |       "4155440434772171",
 113 |       "887782953686064",
 114 |       "1192562142800829",
 115 |       "1566836271123858",
 116 |       "1334713168343936",
 117 |       "1597761001219562",
 118 |       "1348060153661921",
 119 |       "25228605600124856",
 120 |       "1108603637806170",
 121 |       "846070368354758",
 122 |       "2238614166617625"
 123 |     ]
 124 |   },
 125 |   "https://www.facebook.com/blachostal.nowoczesne.garaze/posts/pfbid035cuqZ8Ryx9RyGvXLtnLgmhpn1U6g7ATf7jPz5PCERqXVLAX1K4EcYWyCFtpV4eKdl?__cft__[0]=AZUpQP-0LIjNhIOd4-WavmmTf-1EIzmuVzXqt3rBbeemot7QoTS0K6WPNiYhYO7OJHC11Q6tzK7hCnE9m4Z7gi7TzO-7HKXXkLY_w9xlW_IeUL8OtBEabhmc0l6dtUX-Ymh3MbcoeBSVz_xpNu__MHueNjtJJiqVlW0XjtA_wZmFoA&__tn__=%2CO%2CP-R": {
 126 |     "lastCount": 57,
 127 |     "knownIds": [
 128 |       "837086052064961",
 129 |       "739384599166756",
 130 |       "1338324470611610",
 131 |       "1170589628261159",
 132 |       "1958112638098026",
 133 |       "835834932432887",
 134 |       "800492942752214",
 135 |       "1161016129562915",
 136 |       "1336721634828423",
 137 |       "865545639316414",
 138 |       "636140609435489",
 139 |       "1694692387894376",
 140 |       "1207837304699525",
 141 |       "877011254648738",
 142 |       "1915547985673759",
 143 |       "1769454663771678",
 144 |       "1379026987086490",
 145 |       "1317369222903353",
 146 |       "1158866746216284",
 147 |       "1186495090203276",
 148 |       "1879599489623012",
 149 |       "1970131387085863",
 150 |       "1365957888504043",
 151 |       "841299492182407",
 152 |       "2123442388479251",
 153 |       "1303547907750484",
 154 |       "1152933336198413",
 155 |       "757831063921521",
 156 |       "788077300493101",
 157 |       "1334471641547577",
 158 |       "818180254496310",
 159 |       "4030832773895572",
 160 |       "655115834137470",
 161 |       "1240686021150283",
 162 |       "1566836444424818",
 163 |       "1668416530798344",
 164 |       "2808509649339736",
 165 |       "2264210650659328",
 166 |       "1148371167275090",
 167 |       "1533245467824618",
 168 |       "1192562142800829",
 169 |       "1566836271123858",
 170 |       "1334713168343936",
 171 |       "1533084681472944",
 172 |       "3756537031316420",
 173 |       "1822548139145637",
 174 |       "808914925383512",
 175 |       "1133937601502415",
 176 |       "4108962026025143",
 177 |       "2230109340791092",
 178 |       "796845636852589",
 179 |       "1360812648547437",
 180 |       "779905761538818",
 181 |       "1103960681528297",
 182 |       "2228148440988296",
 183 |       "1100544302065673",
 184 |       "2238614166617625"
 185 |     ]
 186 |   },
 187 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid022BUAUcJmmCcnK3Q72F4CvKTJ1TN8EPWci4jeC7nFALZzMRVchreV4C4bUZ4x9e3bl&id=100064116006584": {
 188 |     "lastCount": 73,
 189 |     "knownIds": [
 190 |       "1749611885694430",
 191 |       "1330391901482980",
 192 |       "1148543403259376",
 193 |       "1174352560850592",
 194 |       "1464617361315828",
 195 |       "3673815659417730",
 196 |       "4132488383686483",
 197 |       "2535772406797096",
 198 |       "703942479431556",
 199 |       "2671866479814432",
 200 |       "2208707316297998",
 201 |       "1333529047893602",
 202 |       "1882383499328551",
 203 |       "3922670094622150",
 204 |       "1038495614892417",
 205 |       "1393258995787290",
 206 |       "808416805428093",
 207 |       "1841676156425478",
 208 |       "2627661040959901",
 209 |       "1318862856385985",
 210 |       "2454636844932679",
 211 |       "1125272642419471",
 212 |       "1154909593218875",
 213 |       "1324142002771144",
 214 |       "1893966948108194",
 215 |       "9662769650439208",
 216 |       "1123269052946986",
 217 |       "1164627985875534",
 218 |       "3088947611278670",
 219 |       "1389127985680999",
 220 |       "2757266117997737",
 221 |       "1833299830734373",
 222 |       "680500117659289",
 223 |       "641182325550151",
 224 |       "1033012642023795",
 225 |       "660078953387192",
 226 |       "1828985121209354",
 227 |       "703695865366600",
 228 |       "9952510204804510",
 229 |       "4016734478615313",
 230 |       "1696870044301105",
 231 |       "2129744274182064",
 232 |       "1658045408197468",
 233 |       "796346829484183",
 234 |       "1863978071017302",
 235 |       "1315407846218314",
 236 |       "1113102554327952",
 237 |       "1978854649620670",
 238 |       "1313416067452535",
 239 |       "1982134975861425",
 240 |       "1286011706903122",
 241 |       "1126742986296906",
 242 |       "999820972175816",
 243 |       "1150598243794985",
 244 |       "9432829300172607",
 245 |       "1174256631476979",
 246 |       "2039749086867789",
 247 |       "2706825462837018",
 248 |       "657118717418423",
 249 |       "9264119667046076",
 250 |       "1872924636990353",
 251 |       "1192562142800829",
 252 |       "1566836271123858",
 253 |       "1334713168343936",
 254 |       "1873518990225811",
 255 |       "834703568989661",
 256 |       "1891200018479913",
 257 |       "699194213204568",
 258 |       "694484656653829",
 259 |       "1545484699792456",
 260 |       "842516725028237",
 261 |       "2238614166617625",
 262 |       "1336694961258543"
 263 |     ]
 264 |   },
 265 |   "https://www.facebook.com/photo/?fbid=1261396812687012&set=a.629604755866224": {
 266 |     "lastCount": 171,
 267 |     "knownIds": [
 268 |       "2091351504939519",
 269 |       "1884747355812159",
 270 |       "1375814240653458",
 271 |       "1386466736342431",
 272 |       "2913525755520216",
 273 |       "914825275043397",
 274 |       "1192562142800829",
 275 |       "1182339083868514",
 276 |       "884682243989592",
 277 |       "878016028062528",
 278 |       "3990260714555932",
 279 |       "1395049695660201",
 280 |       "1400007592135635",
 281 |       "25383836781271270",
 282 |       "2464158020678682",
 283 |       "25380261558251901",
 284 |       "889910733363126",
 285 |       "1542448540123823",
 286 |       "1288191046408027",
 287 |       "828934086590504",
 288 |       "1559321618526036",
 289 |       "3338738306278939",
 290 |       "1401010148404114",
 291 |       "825179916952017",
 292 |       "1190699832394619",
 293 |       "835043512861815",
 294 |       "741030128390667",
 295 |       "3183933031793355",
 296 |       "2652169795120256",
 297 |       "829289853422315",
 298 |       "794397296986489",
 299 |       "1186035596331903",
 300 |       "872151695709683",
 301 |       "1168445255485970",
 302 |       "840748091906335",
 303 |       "1416435073160346",
 304 |       "1210178124339059",
 305 |       "868656982201643",
 306 |       "1161092656141133",
 307 |       "1557690708748766",
 308 |       "2321446244935364",
 309 |       "1293998722769377",
 310 |       "738828288661567",
 311 |       "862078689805684",
 312 |       "1345758703952318",
 313 |       "1752196685433084",
 314 |       "1384199336385255",
 315 |       "880252451247618",
 316 |       "887617090465269",
 317 |       "889586553580023",
 318 |       "881248257908478",
 319 |       "25184700861158963",
 320 |       "1788769208444222",
 321 |       "2023978775123360",
 322 |       "790072490734904",
 323 |       "1366031925320244",
 324 |       "2422165638242886",
 325 |       "1873234940224413",
 326 |       "1188813365965756",
 327 |       "1573818770516512",
 328 |       "1005206625155946",
 329 |       "1162845742665115",
 330 |       "1178746437126776",
 331 |       "1565070374622312",
 332 |       "1613790206669359",
 333 |       "835230942645797",
 334 |       "1411481383824753",
 335 |       "1537167007430654",
 336 |       "1769386407102433",
 337 |       "1387315283050136",
 338 |       "858534963666507",
 339 |       "857641136968017",
 340 |       "1755210908491116",
 341 |       "1419871056593296",
 342 |       "4298595940379216",
 343 |       "848905577516580",
 344 |       "2895125147350502",
 345 |       "1503806647551165",
 346 |       "885909654017036",
 347 |       "780452878339522",
 348 |       "1426932012381076",
 349 |       "892456339973962",
 350 |       "1184352506627848",
 351 |       "881319174424157",
 352 |       "1205273138185990",
 353 |       "827167420092033",
 354 |       "807497485649488",
 355 |       "2508198259576746",
 356 |       "853919757233092",
 357 |       "1904985440052869",
 358 |       "4277996195782352",
 359 |       "855114936990882",
 360 |       "864261956003488",
 361 |       "875432355170220",
 362 |       "711412321631856",
 363 |       "2356779018098813",
 364 |       "1512873466670468",
 365 |       "809319638773964",
 366 |       "1873157936893990",
 367 |       "24546345048373206",
 368 |       "836164595848285",
 369 |       "1193774995419478",
 370 |       "4065448630421517",
 371 |       "3347211812097106",
 372 |       "2711019595902901",
 373 |       "25288616604081912",
 374 |       "3488548011284811",
 375 |       "2115063869305678",
 376 |       "25195142240180496",
 377 |       "748066968322684",
 378 |       "1346616433378423",
 379 |       "876910218199240",
 380 |       "1206011641448351",
 381 |       "784442221315015",
 382 |       "1116285873732562",
 383 |       "1196575319097608",
 384 |       "786967771040505",
 385 |       "836897525861851",
 386 |       "1210808507640106",
 387 |       "1336882541077354",
 388 |       "1296651692501039",
 389 |       "874604001583153",
 390 |       "725090780157624",
 391 |       "1027324389551469",
 392 |       "854580610329547",
 393 |       "2179223112487256",
 394 |       "25112636721761691",
 395 |       "1213667170614746",
 396 |       "1246630423997635",
 397 |       "4288373401410200",
 398 |       "1176663654591895",
 399 |       "1856622578557519",
 400 |       "662447050281327",
 401 |       "1916944149172020",
 402 |       "2099479680800232",
 403 |       "4319827551671876",
 404 |       "1131714269154246",
 405 |       "2081759715929691",
 406 |       "848609507928587",
 407 |       "1161996186127820",
 408 |       "1376111390773710",
 409 |       "3907427189550696",
 410 |       "1206314870843698",
 411 |       "1486343152426071",
 412 |       "1235908888378023",
 413 |       "1597671841430090",
 414 |       "896662692816720",
 415 |       "25182931644709006",
 416 |       "805856392445115",
 417 |       "1535435530837453",
 418 |       "1555316578849891",
 419 |       "874602815531394",
 420 |       "1180837327489586",
 421 |       "4243395015986914",
 422 |       "2016617425849497",
 423 |       "842162171860315",
 424 |       "1398656838277110",
 425 |       "849696054094330",
 426 |       "1566836271123858",
 427 |       "1334713168343936",
 428 |       "1893305694607056",
 429 |       "1379851033923470",
 430 |       "869806365490831",
 431 |       "25246629424946112",
 432 |       "1778244582865308",
 433 |       "1221952383139083",
 434 |       "1383300383497013",
 435 |       "1378487037020809",
 436 |       "1180772130245894"
 437 |     ]
 438 |   },
 439 |   "https://www.facebook.com/watch?v=1546039723188424": {
 440 |     "lastCount": 667,
 441 |     "knownIds": [
 442 |       "1034829085496923",
 443 |       "873279545368406",
 444 |       "1157937886525659",
 445 |       "1217102703640704",
 446 |       "676074752102804",
 447 |       "1850621605626373",
 448 |       "814757514891721",
 449 |       "2690947364599539",
 450 |       "866218982562606",
 451 |       "797586103275496",
 452 |       "1200108822074875",
 453 |       "739892525798237",
 454 |       "1528177094970396",
 455 |       "3136486936525783",
 456 |       "3384251621723953",
 457 |       "1351140720045390",
 458 |       "847775191230725",
 459 |       "1391665129291704",
 460 |       "1147976430739464",
 461 |       "1370610761211656",
 462 |       "1536916187346419",
 463 |       "1338022657618581",
 464 |       "835227862814169",
 465 |       "2789288267945650",
 466 |       "1356734035908376",
 467 |       "3530644377074573",
 468 |       "1817009098951314",
 469 |       "1274075071163081",
 470 |       "815875647943360",
 471 |       "1387337559498686",
 472 |       "2079040016247175",
 473 |       "1980037552540559",
 474 |       "1554283373382984",
 475 |       "1483655376039555",
 476 |       "1437302024626602",
 477 |       "1989797221592305",
 478 |       "1400768578154773",
 479 |       "3188707454634158",
 480 |       "4318381861735402",
 481 |       "1229234325739478",
 482 |       "820324120869151",
 483 |       "858682013561724",
 484 |       "1410167497120999",
 485 |       "2031332694319611",
 486 |       "1854370808519239",
 487 |       "1381435747018306",
 488 |       "1216217753742556",
 489 |       "1350047526313914",
 490 |       "902801388745893",
 491 |       "1932403151033451",
 492 |       "1414307940113741",
 493 |       "1542514287026670",
 494 |       "1587036489390772",
 495 |       "1798918124121190",
 496 |       "1572615540843915",
 497 |       "1279578837262812",
 498 |       "2104194069984523",
 499 |       "840156885326687",
 500 |       "1353472306279850",
 501 |       "1414407773447758",
 502 |       "834222002828895",
 503 |       "1359696375151200",
 504 |       "32562186280096617",
 505 |       "874871655430503",
 506 |       "876677201463749",
 507 |       "1176938817433772",
 508 |       "2319594431887963",
 509 |       "1150705436843993",
 510 |       "1359028538929393",
 511 |       "842046068695533",
 512 |       "1512987039956409",
 513 |       "1192562142800829",
 514 |       "1566836271123858",
 515 |       "1334713168343936",
 516 |       "1815331212473698",
 517 |       "1639103264165336",
 518 |       "2027206161403312",
 519 |       "1175923591297419",
 520 |       "2331178203988335",
 521 |       "732165593268210",
 522 |       "1606395597391252",
 523 |       "1378487037020809",
 524 |       "1180772130245894",
 525 |       "3538623532959776",
 526 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3MzI3OTU0NTM2ODQwNg==",
 527 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEwMzQ4MjkwODU0OTY5MjM=",
 528 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNTc5Mzc4ODY1MjU2NTk=",
 529 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzI3ODkyODgyNjc5NDU2NTA=",
 530 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgxNTg3NTY0Nzk0MzM2MA==",
 531 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE5ODAwMzc1NTI1NDA1NTk=",
 532 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTAxNjc0OTcxMjA5OTk=",
 533 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwNzkwNDAwMTYyNDcxNzU=",
 534 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg1ODY4MjAxMzU2MTcyNA==",
 535 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTQzMDc5NDAxMTM3NDE=",
 536 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMjkyMzQzMjU3Mzk0Nzg=",
 537 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzcyNTkyMDMxNjczNzkzNA==",
 538 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMTYyMTc3NTM3NDI1NTY=",
 539 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgzNzUyNTcwNTcwMDM0OQ==",
 540 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1NDI1MTQyODcwMjY2NzA=",
 541 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIxMDQxOTQwNjk5ODQ1MjM=",
 542 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyNzk1Nzg4MzcyNjI4MTI=",
 543 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgzNDIyMjAwMjgyODg5NQ==",
 544 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTM0NzIzMDYyNzk4NTA=",
 545 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTk2OTYzNzUxNTEyMDA=",
 546 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTQ0MDc3NzM0NDc3NTg=",
 547 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0MDE1Njg4NTMyNjY4Nw==",
 548 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMyNTYyMTg2MjgwMDk2NjE3",
 549 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3NDg3MTY1NTQzMDUwMw==",
 550 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNzY5Mzg4MTc0MzM3NzI=",
 551 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNTA3MDU0MzY4NDM5OTM=",
 552 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTkwMjg1Mzg5MjkzOTM=",
 553 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzM1Mzg2MjM1MzI5NTk3NzY=",
 554 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE2MzkxMDMyNjQxNjUzMzY=",
 555 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMyOTE0MTE3NzMxNTY2Nzg4",
 556 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNzU5MjM1OTEyOTc0MTk=",
 557 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1MjgxNzcwOTQ5NzAzOTY=",
 558 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1NzI2MTU1NDA4NDM5MTU=",
 559 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE2MDYzOTU1OTczOTEyNTI=",
 560 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE3OTg5MTgxMjQxMjExOTA=",
 561 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1ODcwMzY0ODkzOTA3NzI=",
 562 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIzMTk1OTQ0MzE4ODc5NjM=",
 563 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzODczMzc1NTk0OTg2ODY=",
 564 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE5NTY5MzgyMjQ4NjQ4NDA=",
 565 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3NjY3NzIwMTQ2Mzc0OQ==",
 566 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwMjcyMDYxNjE0MDMzMTI=",
 567 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMTcxMDI3MDM2NDA3MDQ=",
 568 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE4NTA2MjE2MDU2MjYzNzM=",
 569 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgxNDc1NzUxNDg5MTcyMQ==",
 570 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzc5NzU4NjEwMzI3NTQ5Ng==",
 571 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMDAxMDg4MjIwNzQ4NzU=",
 572 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzczOTg5MjUyNTc5ODIzNw==",
 573 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzczMjE2NTU5MzI2ODIxMA==",
 574 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMxMzY0ODY5MzY1MjU3ODM=",
 575 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0Nzc3NTE5MTIzMDcyNQ==",
 576 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzOTE2NjUxMjkyOTE3MDQ=",
 577 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTY3MzQwMzU5MDgzNzY=",
 578 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzM1MzA2NDQzNzcwNzQ1NzM=",
 579 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE4MTcwMDkwOTg5NTEzMTQ=",
 580 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyNzQwNzUwNzExNjMwODE=",
 581 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwMzEzMzI2OTQzMTk2MTE=",
 582 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgyMDMyNDEyMDg2OTE1MQ==",
 583 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTAwNDc1MjYzMTM5MTQ=",
 584 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0MjA0NjA2ODY5NTUzMw==",
 585 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1OTY4MDU0MTE1MDYwNTA="
 586 |     ]
 587 |   },
 588 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02JxENQPAgXLfvSfdPzPRhgDmj1zqRFG2PGgCzduiY5LYZjkseBLWvuhDpt34DerN5l&id=61584520760919&__cft__[0]=AZXJAJKSlXAiajIjlB-6ckGQ63AZIss4k7yPNV5xlLRfJeEBt2jRUUAfnoxqPfHyR0N4CIbHCZ50-sHRWaH3XVpJlN5UqJBZA3SeMhDOdmQoTWGQgVoxiZRwOAuovy_VPVw0d006Qr8Iy_0GBJLmVnL5&__tn__=%2CO%2CP-R": {
 589 |     "lastCount": 72,
 590 |     "knownIds": [
 591 |       "1387048646140084",
 592 |       "4029936247259749",
 593 |       "2660328750978691",
 594 |       "1334713168343936",
 595 |       "1308776751017890",
 596 |       "860633059666540",
 597 |       "1162914796039786",
 598 |       "707446865381225",
 599 |       "1332922231472322",
 600 |       "32631282399850242",
 601 |       "1659956864728691",
 602 |       "2009452379840879",
 603 |       "1397998685092575",
 604 |       "731542136047939",
 605 |       "2195100867683396",
 606 |       "1352140803044491",
 607 |       "1582048652803221",
 608 |       "3213235995511395",
 609 |       "713851081769506",
 610 |       "1751614108794244",
 611 |       "1455003568933656",
 612 |       "954678057719951",
 613 |       "4265160300476831",
 614 |       "863798326084470",
 615 |       "1368214498653334",
 616 |       "2271294380058475",
 617 |       "1914780959411823",
 618 |       "4342023332710628",
 619 |       "25610648951903072",
 620 |       "1961217241125600",
 621 |       "2059570238136530",
 622 |       "1359374301769672",
 623 |       "1386298086274612",
 624 |       "1187415322720164",
 625 |       "1195488835863790",
 626 |       "843794491735616",
 627 |       "708983228922331",
 628 |       "1020099650299656",
 629 |       "1309353301236675",
 630 |       "1375348427384280",
 631 |       "1837383113815193",
 632 |       "1861441061169345",
 633 |       "1523263618748823",
 634 |       "836093312396374",
 635 |       "834220359478702",
 636 |       "1545544119923126",
 637 |       "1556567885685420",
 638 |       "1343080830898918",
 639 |       "1103236938390764",
 640 |       "859649783143680",
 641 |       "1499835097914532",
 642 |       "727778929827248",
 643 |       "2366730120438641",
 644 |       "1931144420799614",
 645 |       "856913427204800",
 646 |       "1190384626410068",
 647 |       "817196824521583",
 648 |       "3895894027369306",
 649 |       "25370985949201334",
 650 |       "4283846458525963",
 651 |       "3226169730892248",
 652 |       "1804234623581441",
 653 |       "1565106078066742",
 654 |       "1566836271123858",
 655 |       "1378487037020809",
 656 |       "1180772130245894",
 657 |       "1220933543289726",
 658 |       "695065753431906",
 659 |       "2410182332773265",
 660 |       "1224551999488388",
 661 |       "1399917991714636",
 662 |       "1432091554999171"
 663 |     ]
 664 |   },
 665 |   "https://www.facebook.com/photo/?fbid=122094212247150692&set=a.122094201615150692": {
 666 |     "lastCount": 59,
 667 |     "knownIds": [
 668 |       "1169334382002952",
 669 |       "863106073038155",
 670 |       "1566375511189660",
 671 |       "2037974683629442",
 672 |       "1542866486933334",
 673 |       "1665264284450867",
 674 |       "711382065374373",
 675 |       "1467630091745966",
 676 |       "3122601214616860",
 677 |       "812865358241500",
 678 |       "2139753380172429",
 679 |       "846184221228551",
 680 |       "4106518426267211",
 681 |       "1624997921820642",
 682 |       "1984837538742860",
 683 |       "885251587616725",
 684 |       "1571528797174773",
 685 |       "33078682511745755",
 686 |       "2991949180990526",
 687 |       "879570997756128",
 688 |       "1202215825092490",
 689 |       "658039723942725",
 690 |       "1180772130245894",
 691 |       "1641872540127188",
 692 |       "774470002313371",
 693 |       "846169851470673",
 694 |       "2222423831587657",
 695 |       "823002400530889",
 696 |       "1220388709956707",
 697 |       "4051903231728363",
 698 |       "1903855931014636",
 699 |       "2081042142667648",
 700 |       "1364286302043929",
 701 |       "4346243682326124",
 702 |       "1219553130030174",
 703 |       "2558857481162263",
 704 |       "1966354757557104",
 705 |       "1031025025853926",
 706 |       "744866855291492",
 707 |       "1353775642401360",
 708 |       "874640861779581",
 709 |       "844895071281433",
 710 |       "2818259021703353",
 711 |       "887072213991851",
 712 |       "715618478251297",
 713 |       "1027959339511906",
 714 |       "1399917991714636",
 715 |       "1432091554999171",
 716 |       "25296652460004948",
 717 |       "1378487037020809",
 718 |       "674278005622004",
 719 |       "1364869044560158",
 720 |       "786209294477791",
 721 |       "1893315601272988",
 722 |       "2005747403318365",
 723 |       "1220933543289726",
 724 |       "710638258395186",
 725 |       "771571385942297",
 726 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTE2OTMzNDM4MjAwMjk1Mg==",
 727 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzExMzgyMDY1Mzc0Mzcz",
 728 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODEyODY1MzU4MjQxNTAw",
 729 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjEzOTc1MzM4MDE3MjQyOQ==",
 730 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ2MTg0MjIxMjI4NTUx",
 731 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDEwNjUxODQyNjI2NzIxMQ==",
 732 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTYyNDk5NzkyMTgyMDY0Mg==",
 733 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTk4NDgzNzUzODc0Mjg2MA==",
 734 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODg1MjUxNTg3NjE2NzI1",
 735 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU3MTUyODc5NzE3NDc3Mw==",
 736 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMzMwNzg2ODI1MTE3NDU3NTU=",
 737 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjk5MTk0OTE4MDk5MDUyNg==",
 738 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODc5NTcwOTk3NzU2MTI4",
 739 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzg2MjA5Mjk0NDc3Nzkx",
 740 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIwMjIxNTgyNTA5MjQ5MA==",
 741 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNjU4MDM5NzIzOTQyNzI1",
 742 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTE4MDc3MjEzMDI0NTg5NA==",
 743 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTY0MTg3MjU0MDEyNzE4OA==",
 744 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzc0NDcwMDAyMzEzMzcx",
 745 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ2MTY5ODUxNDcwNjcz",
 746 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjIyMjQyMzgzMTU4NzY1Nw==",
 747 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODIzMDAyNDAwNTMwODg5",
 748 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIyMDM4ODcwOTk1NjcwNw==",
 749 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDA1MTkwMzIzMTcyODM2Mw==",
 750 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTkwMzg1NTkzMTAxNDYzNg==",
 751 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA4MTA0MjE0MjY2NzY0OA==",
 752 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM2NDI4NjMwMjA0MzkyOQ==",
 753 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDM0NjI0MzY4MjMyNjEyNA==",
 754 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIxOTU1MzEzMDAzMDE3NA==",
 755 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjU1ODg1NzQ4MTE2MjI2Mw==",
 756 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTk2NjM1NDc1NzU1NzEwNA==",
 757 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTAzMTAyNTAyNTg1MzkyNg==",
 758 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzQ0ODY2ODU1MjkxNDky",
 759 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM1Mzc3NTY0MjQwMTM2MA==",
 760 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODc0NjQwODYxNzc5NTgx",
 761 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ0ODk1MDcxMjgxNDMz",
 762 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjgxODI1OTAyMTcwMzM1Mw==",
 763 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODg3MDcyMjEzOTkxODUx",
 764 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzE1NjE4NDc4MjUxMjk3",
 765 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTAyNzk1OTMzOTUxMTkwNg==",
 766 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM5OTkxNzk5MTcxNDYzNg==",
 767 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTQzMjA5MTU1NDk5OTE3MQ==",
 768 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjUyOTY2NTI0NjAwMDQ5NDg=",
 769 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM3ODQ4NzAzNzAyMDgwOQ==",
 770 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNjc0Mjc4MDA1NjIyMDA0",
 771 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM2NDg2OTA0NDU2MDE1OA==",
 772 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzEwNjM4MjU4Mzk1MTg2",
 773 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzcxNTcxMzg1OTQyMjk3",
 774 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODYyNDQ1NTQyOTkzNTQ1",
 775 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjI0NzcxNzg2ODk4ODg3MA==",
 776 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODYzMTA2MDczMDM4MTU1",
 777 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU2NjM3NTUxMTE4OTY2MA==",
 778 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjAzNzk3NDY4MzYyOTQ0Mg==",
 779 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU0Mjg2NjQ4NjkzMzMzNA==",
 780 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTY2NTI2NDI4NDQ1MDg2Nw==",
 781 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTQ2NzYzMDA5MTc0NTk2Ng==",
 782 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMzEyMjYwMTIxNDYxNjg2MA==",
 783 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
 784 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA1MzUxNzM2MjExNDE1Mw=="
 785 |     ]
 786 |   },
 787 |   "https://www.facebook.com/watch?v=1747017129293695": {
 788 |     "lastCount": 47,
 789 |     "knownIds": [
 790 |       "1418703679590774",
 791 |       "1241367197833798",
 792 |       "1309276017905401",
 793 |       "25793567626914911",
 794 |       "724928260680561",
 795 |       "1096804382383041",
 796 |       "25202925069357291",
 797 |       "841785541563927",
 798 |       "867017875854415",
 799 |       "854931910451517",
 800 |       "684653267842600",
 801 |       "831670253122745",
 802 |       "1368632978005981",
 803 |       "860225270291994",
 804 |       "4263223717254760",
 805 |       "1166898958452725",
 806 |       "727407229861963",
 807 |       "1374879277637474",
 808 |       "1178997877656809",
 809 |       "1901642503725329",
 810 |       "827290810101566",
 811 |       "1185991473630041",
 812 |       "853482857087660",
 813 |       "1481115546516836",
 814 |       "1382703660048206",
 815 |       "834576799283137",
 816 |       "2596555094062101",
 817 |       "816880584589546",
 818 |       "1903241780592717",
 819 |       "878506131377275",
 820 |       "1273023674590635",
 821 |       "2300220227070942",
 822 |       "720324560662891",
 823 |       "1933859273839066",
 824 |       "834537405631346",
 825 |       "1284526736694577",
 826 |       "1897678497773700",
 827 |       "1364869044560158",
 828 |       "1180772130245894",
 829 |       "3122601214616860",
 830 |       "1467768004333384",
 831 |       "753075217807130",
 832 |       "1596784824815673",
 833 |       "1122239806390192",
 834 |       "1109640851017363",
 835 |       "2688908578229084",
 836 |       "1360530128869154"
 837 |     ]
 838 |   },
 839 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02kXCMp7deNZJTc7JidwqGsjwY2dS3mWwAU83LYBJyrSDtjh45QxaQVh6aEEJE5VjXl&id=100091331246314&__cft__[0]=AZUjZ-UzQbZGoBWF7hBt_usoibO4vkZvwqOU5CUPhYQ61TIrpq3Riv_KlOiY9QUvNCOuHUSaHak6qTWzZJr7JD_yfUWHDyPruKP-tUhQAgisHc2EDlpm8qPGFP6UBGV7SV7uuFe63QeaRvjtPZIqXnJ3OniAICMNa__SEkZpj6ZPLg&__tn__=%2CO%2CP-R-R": {
 840 |     "lastCount": 38,
 841 |     "knownIds": [
 842 |       "4612275575768952",
 843 |       "863490763296586",
 844 |       "1360338219212140",
 845 |       "1338968061297670",
 846 |       "1154900446816263",
 847 |       "1117194126968745",
 848 |       "727101979916496",
 849 |       "1470304077365038",
 850 |       "608200102356103",
 851 |       "746670951803384",
 852 |       "1714850583235964",
 853 |       "1843296863226977",
 854 |       "4073829472880410",
 855 |       "1159712666288389",
 856 |       "1644632413610052",
 857 |       "858309986590509",
 858 |       "1366045154884211",
 859 |       "1340624584210280",
 860 |       "1145536310893602",
 861 |       "4394012717590835",
 862 |       "2113096706180083",
 863 |       "2657786187890234",
 864 |       "1414087970316708",
 865 |       "1214583947385185",
 866 |       "1479995833058699",
 867 |       "25133525979631543",
 868 |       "1613143033185067",
 869 |       "1189145460014871",
 870 |       "1139075151759139",
 871 |       "823333920486786",
 872 |       "24925046737116211",
 873 |       "2582213132132102",
 874 |       "837202788892444",
 875 |       "842359905054242",
 876 |       "1518657456053815",
 877 |       "1361048705561471",
 878 |       "1396138751967453",
 879 |       "2722027871485275",
 880 |       "1475148573596866",
 881 |       "1174977574073678",
 882 |       "2114940926003258",
 883 |       "1277131887792553",
 884 |       "765602586485873",
 885 |       "1373502007518092",
 886 |       "1506882210374158",
 887 |       "871892968745045",
 888 |       "1413690186852109",
 889 |       "696162543569582",
 890 |       "2045630056205678",
 891 |       "872717195152262",
 892 |       "843443721502601",
 893 |       "1157107909873874",
 894 |       "1496140238155905",
 895 |       "1489153539052385",
 896 |       "836062149391615",
 897 |       "871363288913690",
 898 |       "1388050096309972",
 899 |       "1084941183587751",
 900 |       "2316732332172277",
 901 |       "2014873149277102",
 902 |       "1641072606872503",
 903 |       "1576485500012904",
 904 |       "768049532957370",
 905 |       "1163915825906950",
 906 |       "25705749892425137",
 907 |       "1357776346134991",
 908 |       "1155290522946127",
 909 |       "1180715860351971",
 910 |       "1836243433744983",
 911 |       "1492639025296126",
 912 |       "2387222021696823",
 913 |       "1807553916565736",
 914 |       "868979565671714",
 915 |       "25849881801270432",
 916 |       "1730002768404124",
 917 |       "1221666770021346",
 918 |       "1353115676540006",
 919 |       "1761857647829506",
 920 |       "1936095640453930",
 921 |       "1486910209043353",
 922 |       "1682057306101909",
 923 |       "1417475586467162",
 924 |       "710626598495722",
 925 |       "1394665231995802",
 926 |       "752814524512853",
 927 |       "1984043662156010",
 928 |       "838851478954595",
 929 |       "838951908846312",
 930 |       "2163263157413358",
 931 |       "1358562942659258",
 932 |       "1701108984197674",
 933 |       "1957062724870577",
 934 |       "1383920783513739",
 935 |       "1372656587867854",
 936 |       "1179050510995713",
 937 |       "1209173161068840",
 938 |       "1191801159197515",
 939 |       "869826455729920",
 940 |       "700819386010250",
 941 |       "1336100817711136",
 942 |       "1961843504547442",
 943 |       "841223478619468",
 944 |       "845052431266562",
 945 |       "1252631383556573",
 946 |       "878629608161627",
 947 |       "824320927176060",
 948 |       "811323951907371",
 949 |       "866017626046573",
 950 |       "1745796472785148",
 951 |       "1573999687287614",
 952 |       "709749508447354",
 953 |       "696525893535421",
 954 |       "891821463373037",
 955 |       "774173708988258",
 956 |       "1192379798889692",
 957 |       "869432538984678",
 958 |       "1492893031795206",
 959 |       "25099761356357709",
 960 |       "844860108267167",
 961 |       "1195219262554251",
 962 |       "2135715656959834",
 963 |       "1223232519729073",
 964 |       "1355414616123145",
 965 |       "816970137909621",
 966 |       "846627378287079"
 967 |     ]
 968 |   },
 969 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid063V3tEVCLYTLCN14sfxE3mRT6HYbF4bNJbC5eUZwseJJ5FUiNZWT3mTdDSAFerZhl&id=61584544438252&comment_id=1419086153162158&__cft__[0]=AZWm3oo-dN99-UYzeKtjkEHgHjYIX4YW4JnFChW_Cx6F4TB37u6rNrYAbBU51fDQjj7d_yXuelDLQiJheVhWvnjPhMulL_3J1sStEw1nqPN3c1OU6iIK4s61-wUWnAtzSLU&__tn__=R]-R": {
 970 |     "lastCount": 32,
 971 |     "knownIds": []
 972 |   },
 973 |   "https://www.facebook.com/BomstalPL/videos/783071247466062/": {
 974 |     "lastCount": 132,
 975 |     "knownIds": [
 976 |       "1893315601272988",
 977 |       "2247717868988870",
 978 |       "2005747403318365",
 979 |       "1220933543289726",
 980 |       "719374621195615",
 981 |       "1544018156624974",
 982 |       "4247878415527757",
 983 |       "1640251893631368",
 984 |       "2806506346354734",
 985 |       "1052807816952086",
 986 |       "25430006279927262",
 987 |       "1141697814572107",
 988 |       "811134138442597",
 989 |       "1726544788013486",
 990 |       "840550231766865",
 991 |       "623478780718696",
 992 |       "2427128127688980",
 993 |       "4128477230631067",
 994 |       "1834795843805713",
 995 |       "822504117141851",
 996 |       "1339450881003183",
 997 |       "1647835896599979",
 998 |       "776708588494114",
 999 |       "1049915130480912",
1000 |       "1558482942267271",
1001 |       "1384867746306333",
1002 |       "1165286899073108",
1003 |       "1759929938028561",
1004 |       "4252577001685395",
1005 |       "1972171566914165",
1006 |       "3961083067477147",
1007 |       "1113379921005263",
1008 |       "1000928565457626",
1009 |       "3839818619654976",
1010 |       "1506631200474272",
1011 |       "1139427624830680",
1012 |       "24546220008407533",
1013 |       "25831638156439916",
1014 |       "1366891205003574",
1015 |       "708395945028827",
1016 |       "1339333207296370",
1017 |       "769083696161334",
1018 |       "1902096047053318",
1019 |       "1458196751907748",
1020 |       "825227187115497",
1021 |       "1445596376556015",
1022 |       "1257634676391629",
1023 |       "2281604608934592",
1024 |       "819613120720105",
1025 |       "859477753137839",
1026 |       "2080110199465235",
1027 |       "846775507864079",
1028 |       "820481787407395",
1029 |       "1539291064077596",
1030 |       "2084851718951026",
1031 |       "1135791425189896",
1032 |       "1819115498690038",
1033 |       "687675160555530",
1034 |       "1529325341544660",
1035 |       "793097830397288",
1036 |       "824187610371685",
1037 |       "1171770334904936",
1038 |       "734713902986986",
1039 |       "1388988616361861",
1040 |       "1537344817690788",
1041 |       "1154855742774015",
1042 |       "3898928450408025",
1043 |       "1956898454906212",
1044 |       "1106409598055657",
1045 |       "1901549407412060",
1046 |       "4270309346586665",
1047 |       "835817858930600",
1048 |       "1806455579976415",
1049 |       "1151331006489662",
1050 |       "1775630366410292",
1051 |       "795564262849155",
1052 |       "1324834109282472",
1053 |       "1176867533812766",
1054 |       "4282609995389611",
1055 |       "1880599495867393",
1056 |       "821112693840718",
1057 |       "1449150746363603",
1058 |       "1869531137105699",
1059 |       "1343985646831626",
1060 |       "1022263589976782",
1061 |       "2025178901651918",
1062 |       "666737399508325",
1063 |       "1918321695650984",
1064 |       "1370355787795719",
1065 |       "847524547935024",
1066 |       "1929845371078707",
1067 |       "773485702411851",
1068 |       "1406104364344225",
1069 |       "25162471200106012",
1070 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcxOTM3NDYyMTE5NTYxNQ==",
1071 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NDQwMTgxNTY2MjQ5NzQ=",
1072 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNDc4Nzg0MTU1Mjc3NTc=",
1073 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE2NDAyNTE4OTM2MzEzNjg=",
1074 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwMjIyNjM1ODk5NzY3ODI=",
1075 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwMjUxNzg5MDE2NTE5MTg=",
1076 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY2NjczNzM5OTUwODMyNQ==",
1077 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MTgzMjE2OTU2NTA5ODQ=",
1078 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNzAzNTU3ODc3OTU3MTk=",
1079 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0NzUyNDU0NzkzNTAyNA==",
1080 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5Mjk4NDUzNzEwNzg3MDc=",
1081 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3MzQ4NTcwMjQxMTg1MQ==",
1082 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0MDYxMDQzNjQzNDQyMjU=",
1083 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1MTYyNDcxMjAwMTA2MDEy",
1084 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI4MDY1MDYzNDYzNTQ3MzQ=",
1085 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1NDMwMDA2Mjc5OTI3MjYy",
1086 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDE2OTc4MTQ1NzIxMDc=",
1087 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxMTEzNDEzODQ0MjU5Nw==",
1088 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0MDU1MDIzMTc2Njg2NQ==",
1089 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzYyMzQ3ODc4MDcxODY5Ng==",
1090 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0MjcxMjgxMjc2ODg5ODA=",
1091 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQxMjg0NzcyMzA2MzEwNjc=",
1092 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MzQ3OTU4NDM4MDU3MTM=",
1093 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMjUwNDExNzE0MTg1MQ==",
1094 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMzk0NTA4ODEwMDMxODM=",
1095 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE2NDc4MzU4OTY1OTk5Nzk=",
1096 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3NjcwODU4ODQ5NDExNA==",
1097 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNTY1Nzg4MzU5NTA2NDc=",
1098 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwNDk5MTUxMzA0ODA5MTI=",
1099 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NTg0ODI5NDIyNjcyNzE=",
1100 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODQ4Njc3NDYzMDYzMzM=",
1101 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNjUyODY4OTkwNzMxMDg=",
1102 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3NTk5Mjk5MzgwMjg1NjE=",
1103 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNTI1NzcwMDE2ODUzOTU=",
1104 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5NzIxNzE1NjY5MTQxNjU=",
1105 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM5NjEwODMwNjc0NzcxNDc=",
1106 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMTMzNzk5MjEwMDUyNjM=",
1107 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwMDA5Mjg1NjU0NTc2MjY=",
1108 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM4Mzk4MTg2MTk2NTQ5NzY=",
1109 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MDY2MzEyMDA0NzQyNzI=",
1110 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzk0Mjc2MjQ4MzA2ODA=",
1111 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0NTQ2MjIwMDA4NDA3NTMz",
1112 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1ODMxNjM4MTU2NDM5OTE2",
1113 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNjY4OTEyMDUwMDM1NzQ=",
1114 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMzkzMzMyMDcyOTYzNzA=",
1115 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODk0OTQxMzkxOTI2ODA=",
1116 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc2OTA4MzY5NjE2MTMzNA==",
1117 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNTcwNjY1MDI5MjcyNDA=",
1118 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MDIwOTYwNDcwNTMzMTg=",
1119 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NTgxOTY3NTE5MDc3NDg=",
1120 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyNTIyNzE4NzExNTQ5Nw==",
1121 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDU1OTYzNzY1NTYwMTU=",
1122 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNTc2MzQ2NzYzOTE2Mjk=",
1123 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIyODE2MDQ2MDg5MzQ1OTI=",
1124 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxOTYxMzEyMDcyMDEwNQ==",
1125 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1OTQ3Nzc1MzEzNzgzOQ==",
1126 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwODAxMTAxOTk0NjUyMzU=",
1127 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0Njc3NTUwNzg2NDA3OQ==",
1128 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMDQ4MTc4NzQwNzM5NQ==",
1129 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MzkyOTEwNjQwNzc1OTY=",
1130 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcwODM5NTk0NTAyODgyNw==",
1131 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwODQ4NTE3MTg5NTEwMjY=",
1132 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwNTI4MDc4MTY5NTIwODY=",
1133 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3MjY1NDQ3ODgwMTM0ODY=",
1134 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzU3OTE0MjUxODk4OTY=",
1135 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MTkxMTU0OTg2OTAwMzg=",
1136 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY4NzY3NTE2MDU1NTUzMA==",
1137 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MjkzMjUzNDE1NDQ2NjA=",
1138 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5MzA5NzgzMDM5NzI4OA==",
1139 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyNDE4NzYxMDM3MTY4NQ==",
1140 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzczNDcxMzkwMjk4Njk4Ng==",
1141 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODg5ODg2MTYzNjE4NjE=",
1142 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MzczNDQ4MTc2OTA3ODg=",
1143 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNTQ4NTU3NDI3NzQwMTU=",
1144 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM4OTg5Mjg0NTA0MDgwMjU=",
1145 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5NTY4OTg0NTQ5MDYyMTI=",
1146 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMDY0MDk1OTgwNTU2NTc=",
1147 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MDE1NDk0MDc0MTIwNjA=",
1148 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNzAzMDkzNDY1ODY2NjU=",
1149 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgzNTgxNzg1ODkzMDYwMA==",
1150 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MDY0NTU1Nzk5NzY0MTU=",
1151 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNTEzMzEwMDY0ODk2NjI=",
1152 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNzE3NzAzMzQ5MDQ5MzY=",
1153 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgzODg1NjgzNTU3MTU1Mg==",
1154 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMDk5ODMzMDc1NDk2Nw==",
1155 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3NzU2MzAzNjY0MTAyOTI=",
1156 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5NTU2NDI2Mjg0OTE1NQ==",
1157 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMjQ4MzQxMDkyODI0NzI=",
1158 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyODI2MDk5OTUzODk2MTE=",
1159 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4ODA1OTk0OTU4NjczOTM=",
1160 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMTExMjY5Mzg0MDcxOA==",
1161 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDkxNTA3NDYzNjM2MDM=",
1162 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4Njk1MzExMzcxMDU2OTk=",
1163 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNDM5ODU2NDY4MzE2MjY=",
1164 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1NjExODQ0MzQ2MTU2MQ==",
1165 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNjQyNDE0Njg2NjE0NzY=",
1166 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MzM2OTM3OTM5MDYxMDA=",
1167 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcwMDAxMTc1NTkzNjE1NA==",
1168 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1MDQyMDI5NDIwMDAyOQ==",
1169 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0NzgxNjkzNDQxNTI2NDQ4",
1170 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxMzM4MDAzODE2NTU1Mg==",
1171 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4NzE4NDY4MDQyMTAzNzA=",
1172 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDAyMzI0NTgxNzAzNTk=",
1173 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3NzY4NTE4MTU1NzEyNw==",
1174 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5MjUxMDUxMzQwMjUzOQ==",
1175 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMTc1MjMzNzY0NDEyNDM=",
1176 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNzMxMTAyMzEyMzMzMTA=",
1177 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMjYwMTc3MTYyNzMxNjU=",
1178 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc1MTg5Mzg4Nzc1MjUyMw==",
1179 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NjA2MzkyNDE4MDk0MjE=",
1180 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDM3MjYxNzA5NzcxOTY=",
1181 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY0MDczNDcwMjExMjI1MA==",
1182 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDQ4MTk0NzAxNDk3OTU=",
1183 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5ODM3NTg0OTc3NzE5OQ==",
1184 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcxNjY5NjIxNzc0NjM5Mg==",
1185 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNzY4Njc1MzM4MTI3NjY=",
1186 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1Njk1NDg0MTczODYzNzY=",
1187 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyMTM4MDk4NDQxNDY0Nzc=",
1188 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwNzk0NDUzNDYxNDA4MTY=",
1189 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzU2MDM0NTg3NTk4Nzk=",
1190 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NjM4NzMzNjE2NDM3MDc=",
1191 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0Njc4Njg1Nzc5Njg0Ng==",
1192 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NjQ1MTgwOTQ2NTI3Mjc=",
1193 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0OTA2OTc3MDg3MjE5MjA="
1194 |     ]
1195 |   },
1196 |   "https://www.facebook.com/reel/1546039723188424": {
1197 |     "lastCount": 0,
1198 |     "knownIds": []
1199 |   },
1200 |   "https://www.facebook.com/photo/?fbid=2351440198621066&set=gm.3153703288136627&idorvanity=1751513541688949": {
1201 |     "lastCount": 37,
1202 |     "knownIds": [
1203 |       "3153836981456591",
1204 |       "3153817881458501",
1205 |       "3153750958131860",
1206 |       "3153753768131579",
1207 |       "3153788818128074",
1208 |       "3153768804796742",
1209 |       "3153738294799793",
1210 |       "3153752964798326",
1211 |       "3153860804787542",
1212 |       "3153788374794785",
1213 |       "3153759971464292",
1214 |       "3153759054797717",
1215 |       "3153752751465014",
1216 |       "1893315601272988",
1217 |       "2247717868988870",
1218 |       "2005747403318365",
1219 |       "1220933543289726",
1220 |       "3153748931465396",
1221 |       "3153747031465586",
1222 |       "3153735721466717",
1223 |       "3153717901468499",
1224 |       "3153711098135846",
1225 |       "3153705458136410",
1226 |       "3154673998039556",
1227 |       "3154217458085210",
1228 |       "3154187304754892",
1229 |       "3154210174752605",
1230 |       "3154124964761126",
1231 |       "3154064401433849",
1232 |       "3154059831434306",
1233 |       "3153890731451216",
1234 |       "3154504031389886",
1235 |       "3153925784781044",
1236 |       "3153865034787119",
1237 |       "3154064964767126",
1238 |       "3154104928096463",
1239 |       "3154065551433734",
1240 |       "3155242934649329",
1241 |       "2075246729890539"
1242 |     ]
1243 |   },
1244 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02K5stNkCQhxne1PLsnjB7LdnwVSCCxqSipPWxgpHQRR9YxzJA9QjqcrcPHx7HsjKDl&id=61584520760919": {
1245 |     "lastCount": 87,
1246 |     "knownIds": [
1247 |       "1387048646140084",
1248 |       "4029936247259749",
1249 |       "2660328750978691",
1250 |       "1334713168343936",
1251 |       "1308776751017890",
1252 |       "860633059666540",
1253 |       "1162914796039786",
1254 |       "707446865381225",
1255 |       "1332922231472322",
1256 |       "32631282399850242",
1257 |       "1659956864728691",
1258 |       "2009452379840879",
1259 |       "1397998685092575",
1260 |       "731542136047939",
1261 |       "2195100867683396",
1262 |       "1352140803044491",
1263 |       "1582048652803221",
1264 |       "3213235995511395",
1265 |       "713851081769506",
1266 |       "1751614108794244",
1267 |       "1220933543289726",
1268 |       "1455003568933656",
1269 |       "954678057719951",
1270 |       "4265160300476831",
1271 |       "863798326084470",
1272 |       "1368214498653334",
1273 |       "2271294380058475",
1274 |       "1914780959411823",
1275 |       "4342023332710628",
1276 |       "25610648951903072",
1277 |       "1961217241125600",
1278 |       "2059570238136530",
1279 |       "695065753431906",
1280 |       "1359374301769672",
1281 |       "1386298086274612",
1282 |       "1187415322720164",
1283 |       "1195488835863790",
1284 |       "843794491735616",
1285 |       "708983228922331",
1286 |       "1020099650299656",
1287 |       "1309353301236675",
1288 |       "1375348427384280",
1289 |       "1837383113815193",
1290 |       "1861441061169345",
1291 |       "1523263618748823",
1292 |       "836093312396374",
1293 |       "834220359478702",
1294 |       "1545544119923126",
1295 |       "1556567885685420",
1296 |       "1343080830898918",
1297 |       "1103236938390764",
1298 |       "859649783143680",
1299 |       "1499835097914532",
1300 |       "727778929827248",
1301 |       "2366730120438641",
1302 |       "1931144420799614",
1303 |       "856913427204800",
1304 |       "1190384626410068",
1305 |       "817196824521583",
1306 |       "3895894027369306",
1307 |       "25370985949201334",
1308 |       "4283846458525963",
1309 |       "3226169730892248",
1310 |       "1804234623581441",
1311 |       "1565106078066742",
1312 |       "1566836271123858",
1313 |       "2410182332773265",
1314 |       "1224551999488388",
1315 |       "2005747403318365",
1316 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjI0NzcxNzg2ODk4ODg3MA==",
1317 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM4NzA0ODY0NjE0MDA4NA==",
1318 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDAyOTkzNjI0NzI1OTc0OQ==",
1319 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjY2MDMyODc1MDk3ODY5MQ==",
1320 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMwODc3Njc1MTAxNzg5MA==",
1321 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODYwNjMzMDU5NjY2NTQw",
1322 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE2MjkxNDc5NjAzOTc4Ng==",
1323 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzA3NDQ2ODY1MzgxMjI1",
1324 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMzMjkyMjIzMTQ3MjMyMg==",
1325 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzI2MzEyODIzOTk4NTAyNDI=",
1326 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTY1OTk1Njg2NDcyODY5MQ==",
1327 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAwOTQ1MjM3OTg0MDg3OQ==",
1328 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM5Nzk5ODY4NTA5MjU3NQ==",
1329 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjE5NTEwMDg2NzY4MzM5Ng==",
1330 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM1MjE0MDgwMzA0NDQ5MQ==",
1331 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU4MjA0ODY1MjgwMzIyMQ==",
1332 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzIxMzIzNTk5NTUxMTM5NQ==",
1333 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzEzODUxMDgxNzY5NTA2",
1334 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTIyMDkzMzU0MzI4OTcyNg==",
1335 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ1NTAwMzU2ODkzMzY1Ng==",
1336 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfOTU0Njc4MDU3NzE5OTUx",
1337 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDI2NTE2MDMwMDQ3NjgzMQ==",
1338 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODYzNzk4MzI2MDg0NDcw",
1339 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM2ODIxNDQ5ODY1MzMzNA==",
1340 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjI3MTI5NDM4MDA1ODQ3NQ==",
1341 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTkxNDc4MDk1OTQxMTgyMw==",
1342 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDM0MjAyMzMzMjcxMDYyOA==",
1343 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjU2MTA2NDg5NTE5MDMwNzI=",
1344 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTk2MTIxNzI0MTEyNTYwMA==",
1345 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjA1OTU3MDIzODEzNjUzMA==",
1346 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNjk1MDY1NzUzNDMxOTA2",
1347 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM1OTM3NDMwMTc2OTY3Mg==",
1348 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM4NjI5ODA4NjI3NDYxMg==",
1349 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE4NzQxNTMyMjcyMDE2NA==",
1350 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5NTQ4ODgzNTg2Mzc5MA==",
1351 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQzNzk0NDkxNzM1NjE2",
1352 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzA4OTgzMjI4OTIyMzMx",
1353 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTAyMDA5OTY1MDI5OTY1Ng==",
1354 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMwOTM1MzMwMTIzNjY3NQ==",
1355 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM3NTM0ODQyNzM4NDI4MA==",
1356 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTgzNzM4MzExMzgxNTE5Mw==",
1357 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTg2MTQ0MTA2MTE2OTM0NQ==",
1358 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTUyMzI2MzYxODc0ODgyMw==",
1359 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM2MDkzMzEyMzk2Mzc0",
1360 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM0MjIwMzU5NDc4NzAy",
1361 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU0NTU0NDExOTkyMzEyNg==",
1362 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU1NjU2Nzg4NTY4NTQyMA==",
1363 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM0MzA4MDgzMDg5ODkxOA==",
1364 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTEwMzIzNjkzODM5MDc2NA==",
1365 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODU5NjQ5NzgzMTQzNjgw",
1366 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ5OTgzNTA5NzkxNDUzMg==",
1367 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzI3Nzc4OTI5ODI3MjQ4",
1368 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjM2NjczMDEyMDQzODY0MQ==",
1369 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTkzMTE0NDQyMDc5OTYxNA==",
1370 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODU2OTEzNDI3MjA0ODAw",
1371 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MDM4NDYyNjQxMDA2OA==",
1372 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODE3MTk2ODI0NTIxNTgz",
1373 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzg5NTg5NDAyNzM2OTMwNg==",
1374 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjUzNzA5ODU5NDkyMDEzMzQ=",
1375 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDI4Mzg0NjQ1ODUyNTk2Mw==",
1376 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzIyNjE2OTczMDg5MjI0OA==",
1377 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTgwNDIzNDYyMzU4MTQ0MQ==",
1378 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjQxMDE4MjMzMjc3MzI2NQ==",
1379 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTIyNDU1MTk5OTQ4ODM4OA==",
1380 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAwNTc0NzQwMzMxODM2NQ==",
1381 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjA3NTI0NjcyOTg5MDUzOQ==",
1382 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQzMzY3ODQzNDk5MzAzOA==",
1383 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ2MzQyOTUyOTExNzM3MA==",
1384 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAzNzkxMTEzMDM4MDE5Ng==",
1385 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMzNDcxMzE2ODM0MzkzNg==",
1386 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTc1MTYxNDEwODc5NDI0NA==",
1387 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU2NTEwNjA3ODA2Njc0Mg==",
1388 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU2NjgzNjI3MTEyMzg1OA==",
1389 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM5OTE2MDI1MzE5NzUz",
1390 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjYwMjQwNTEwMzQ2NzU4NA==",
1391 |       "1520049082604093",
1392 |       "Y29tbWVudDoxMjIwOTQyMDU3NTUxNTA2OTJfMTUyMDA0OTA4MjYwNDA5Mw==",
1393 |       "715410431602862",
1394 |       "Y29tbWVudDoxMjIwOTQyMDE2MjExNTA2OTJfNzE1NDEwNDMxNjAyODYy",
1395 |       "2247717868988870",
1396 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzk0OTI1MDI2MTk2NDA4NA==",
1397 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MjE1MzcxMjI5NDA0OA==",
1398 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE1Njk4OTUwOTkyNDc0MA==",
1399 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQ1Mjk0NTk1MDQ0MTk3",
1400 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODc4NDE0NDc0NTIyNDQy",
1401 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODY5MTg4ODE4OTU0OTA1",
1402 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU1ODYyNjUyNTMwNTk2Mg==",
1403 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQwNjg1MzEyMDMyMTU5",
1404 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzIwODQ0NDMxMDc2MDM3",
1405 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MzgwNzM5MjA4MzQyMQ==",
1406 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODIzNjQ4NTA3MTc2MzA2",
1407 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
1408 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODc3NjkyMDA4NTQxMTg2"
1409 |     ]
1410 |   },
1411 |   "https://www.facebook.com/watch?v=1007690551560515": {
1412 |     "lastCount": 95,
1413 |     "knownIds": [
1414 |       "24724695490539165",
1415 |       "1004761021865101",
1416 |       "1374128397566877",
1417 |       "1222276019745872",
1418 |       "1893315601272988",
1419 |       "2247717868988870",
1420 |       "2005747403318365",
1421 |       "1220933543289726",
1422 |       "2907372662986782",
1423 |       "1478452229883974",
1424 |       "2075246729890539",
1425 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMjQ3MjQ2OTU0OTA1MzkxNjU=",
1426 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTAwNDc2MTAyMTg2NTEwMQ==",
1427 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTM3NDEyODM5NzU2Njg3Nw==",
1428 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTIyMjI3NjAxOTc0NTg3Mg==",
1429 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMjkwNzM3MjY2Mjk4Njc4Mg==",
1430 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTQ3ODQ1MjIyOTg4Mzk3NA=="
1431 |     ]
1432 |   },
1433 |   "https://www.facebook.com/photo/?fbid=1261877999299746&set=a.642315474589338": {
1434 |     "lastCount": 453,
1435 |     "knownIds": [
1436 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDQzMDIwODc0MDM1NzE=",
1437 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4Njk5NTU0NDM5MDI5Mw==",
1438 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzMjc4NjEyMjEwNTA0MjI=",
1439 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzcyNTE0MzQwMjgxNjY=",
1440 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDIxNTE5NDM5OTc5NTM=",
1441 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjUzMDYxMTE4MDMyOTI=",
1442 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQyNjU2MTcxNDM0NzU=",
1443 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjY1Nzk1MjE5ODA1NTM=",
1444 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTQ2MDkzMTQ0ODY0NDk=",
1445 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTYxODA1MjY5NzU5ODQ=",
1446 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNjQ2NTg0ODQwNjUyMTQ=",
1447 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzgyMjE1NDc3NzI0NTA=",
1448 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTU2MzI0ODY3ODg0MQ==",
1449 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjM1MDg3NzE0MzIzNDk=",
1450 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyOTk2MjEzOTgxMTM0MA==",
1451 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjgzMzMzODgzOTUzOTg=",
1452 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDgxODM4NzExOTY4OTk=",
1453 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkyNTE5MTIyMDY3NzA1Nw==",
1454 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NDU5NjU0MzIyODY5NA==",
1455 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjkwNjI2MjQ3MTIwODI=",
1456 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTEyODAyNzc5NTc2Nzk=",
1457 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTc5ODIwOTE1NTk4ODk=",
1458 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTg2NDUyMTg4NTI1MA==",
1459 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTkyOTI2NjkxNTIyNTU=",
1460 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjI3OTU4ODg2NjYyMTM=",
1461 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MDA5NzExMjA5OTUwNzQ=",
1462 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzA4MDgyODcyNzk0Njg=",
1463 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzg3NTI1NDAzMjUyNjc=",
1464 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NzQxNjczMTQ2MzIwMg==",
1465 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI3MTEzMDY3MDU4Njk2NzU=",
1466 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzgxNDQ3MDk4NzY4NTE=",
1467 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY5ODI0ODk0NjQ0NjQ5MQ==",
1468 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODkzMjM1NzU3MTM4Mjg=",
1469 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjQ0MjU1NDUzNjU1MDI=",
1470 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQwNjk0MjM2OTE5NzE=",
1471 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NDQ0Mjc2NjY5NjYxMzM=",
1472 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NzE4MDU0MjUyODM5Mw==",
1473 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MTIxMDE2NzgwNTA4OA==",
1474 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MjcwODcyNDM1MjYwOQ==",
1475 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM3MTI4NTA1ODMyODE=",
1476 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwODIwMjY2NTM1NTYxNA==",
1477 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Njc2NDIyMzM0NTM5NA==",
1478 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM5MzQ1MjA1MzgzODM=",
1479 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDU1MDgzMjgyMTAwMjk=",
1480 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyMTI2NTc2ODkyMjQ4Mzk=",
1481 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODgxOTg5MjYzMzQzMzg=",
1482 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5Mzg5NTUyNjcwMDQzMDg=",
1483 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTYyMzQzNzg1OTk3MzA=",
1484 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTIxNDMyMzQzMTE2NzY=",
1485 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODk1Nzc0ODI1NzkxODU=",
1486 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODkwNzg3NzU5NTkyMjA=",
1487 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNTM2MDU2ODgyNDI3OTI=",
1488 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTc4NDgwNjE0ODc4Mjc=",
1489 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxODUwMjUzNDY0MzU5MQ==",
1490 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczMDIyMTAyMjk2NjgwNQ==",
1491 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMzNzcwNjc3NDU1ODY0Njcy",
1492 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTMwMTg2MDU1NjU0NTQ=",
1493 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NDM5MjYxNzU5MDczMzc0",
1494 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODExMzgwMjA4ODk2ODk=",
1495 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NjQ5MDYwMzA1MTU0NA==",
1496 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NDIwODIyMzAzNDUyMg==",
1497 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTQ5Nzg1NjIzMjMxODc=",
1498 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDkxMzgwNTYzODA3NDU=",
1499 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQxMDQwNjI4NDk4NjEwMTU=",
1500 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNTg5NzYxNjIyMjI1Nw==",
1501 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzAzMzc1MTgzMTIxNg==",
1502 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDk1MjIyODcyMDQ3NjM=",
1503 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTU5NTk4ODYwMjQ3MzQ=",
1504 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDQ4ODM2OTI5MTcwOQ==",
1505 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMDM1NTA5NjUzMDQwNA==",
1506 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzgxMDgwOTE3Mzc5Mjc=",
1507 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwNDgwOTYwOTA3MzQwOQ==",
1508 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTM1NjUyMzY1MzgxMDE=",
1509 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTE5MTE0NTg0NjgyMDU=",
1510 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTA3MjU1OTY4NjM2Mzg=",
1511 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1OTk3ODc1OTc3NzEyMQ==",
1512 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MDk5ODk3MTIyMzc4NQ==",
1513 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MTkzNTE0MTIyNzIwNTY=",
1514 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk0MzIzNzU2OTczODY=",
1515 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzOTUwNzYzODk3NTYxNw==",
1516 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODc4MzAzMzMwMzY0MzY=",
1517 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MDExNjg0MTE1MTk5Njc5",
1518 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MjY5MDQ1MTIxMTcwMzU=",
1519 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NTYzNjYyMzgzMjI5MjY2",
1520 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODI2MjQ2OTY2MzczMzQ=",
1521 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjE0NDM0ODM0NjM0Mzc=",
1522 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4Njk3NTAwMzY5NTY5ODU=",
1523 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2ODAzMDQ3NTY5OTgzNQ==",
1524 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTY0NTk0MjI4OTM2NjY=",
1525 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjQyMzQ4MTUwMDUwODk=",
1526 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Njc3MDg1MzM1MTM5NQ==",
1527 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDAzNDk5Njg3MTc1MDM=",
1528 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNzM0MzA3MjEyNTkzNzI=",
1529 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MjExMDM1NTExOTA5MQ==",
1530 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNDc1NjI4NjA2OTUwMzY=",
1531 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjg4NjQyOTQ3NTE4OTU=",
1532 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjc5NjgzMzg0NzE2ODM=",
1533 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI4NTIxOTI1MjgzMDg1MjU=",
1534 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NDA1MTQ3MTgxMTAyNw==",
1535 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkzMTMxMTE1MzAyMjA3OQ==",
1536 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY3ODU0MTE4NTE4OTcyMQ==",
1537 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NDAxOTA3NTk5MzY2NzE=",
1538 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MDY2MTk5NTM4NzMxOA==",
1539 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM1ODM4NjYxMjUwODY4MzQ=",
1540 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM3MDAzMjc1NTQ0OTY=",
1541 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNzY5MjYzMDY0Mzc2NjU=",
1542 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDgyODE1NTMwNDk3MTg=",
1543 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NzMxMzM2MDY2OTY2MjU=",
1544 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzU4ODk4NjEwMzMxNjE=",
1545 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MTU5NjkxNjU0NDA4NTY=",
1546 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNzYwMjQ2NTk1OTQxOTI=",
1547 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNzg3Njg0NTc2MjExNTk=",
1548 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwODg5NDg3ODUyNzk5Nzg=",
1549 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1NjgxNDYwMzM2OTUxOQ==",
1550 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTU2NTQzNzU2ODg1MjY=",
1551 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MDUxMjE0ODE2ODAzNQ==",
1552 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MDEzNTAyMzM5MTA0NzI=",
1553 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQwMzQ4NjEwNzU2MTI=",
1554 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDc4MDU4NDQyMjg4OTI=",
1555 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzMjIzNDg5MDQ4NzM3NTg=",
1556 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNzMxNTI3MDA3MjA1OA==",
1557 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODQwOTA5MTYzNDQ3MTA=",
1558 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNjE2NDI5MTk0MDY3NzM=",
1559 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTMwNTQ2NDM5MTA0NjU=",
1560 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDg4NzE3Nzk2ODk4Mzk=",
1561 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODcwMDQ0MDY1NDIyODM=",
1562 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MTA5MDgwMzQ5MjIzMA==",
1563 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTAzODg3Mjg5ODU4OTU=",
1564 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTE0OTI2Njg0MjQyMzM=",
1565 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDE5NDAxNTY0OTc0NDA=",
1566 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNjI1MjQyMTA5OTEwODE=",
1567 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNzU3ODQ5NTQ1Mzk1OA==",
1568 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzY0MjAwNDc0NDUyNTM=",
1569 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTI1Mzc5MjExODEwOTY=",
1570 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxNDc4MjUxMTM3OTIwNg==",
1571 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0NDc3ODU3NTY3MTA5Mzc=",
1572 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NTQ0NzIwODU0NzgzNDc=",
1573 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODcyMzk1MjI4Mzc2NzI=",
1574 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0NjIxNDA3Mzg2MDg5MjE=",
1575 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTk5NDYwODI3ODc4OTM=",
1576 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNDUxMTQwMTk1Nzg0MDM=",
1577 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMxMzIzNjEzNzY5NDM4ODI=",
1578 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODQ5MzQ3NTYwMTQzNzc=",
1579 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTU2OTc3MzUyNzc0MjA=",
1580 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMzkxNDk1NjA3OTM5OA==",
1581 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4Njc3NzA3MTA4MDIyMQ==",
1582 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNTM4NDEyMDI5MDA2Mg==",
1583 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDMzODczODA4NzEyNTE=",
1584 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MjMwMzMwMzUwMjI2NzE=",
1585 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyODkyNTA4MTE1NDg5MTg=",
1586 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTE3MDA2MTU5NDM5NzM=",
1587 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyMDQyNTg1Nzk5ODI4ODU=",
1588 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDE0NDM3MTc2ODM0NzM=",
1589 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTY3NzAxMjUzNTMzMzE=",
1590 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjExMjc0ODIwMDc4MDE=",
1591 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzA2NTczMDU4MTE0NTY=",
1592 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjQxMTg4OTEzMzcyMzI=",
1593 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzODI5NzY5OTU1MTkwNjk=",
1594 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyOTU5ODM2NjQ5OTcwMQ==",
1595 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTEyMTcyMDI2MTM0Mzc=",
1596 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDIyMTEwMzA2MjQ2NzM=",
1597 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODYxNjU5MjQwMzEyMw==",
1598 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxMTc2NTAwMTY1OTg1NQ==",
1599 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1Nzg2MDMyNDk4Mjg2Njg=",
1600 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyOTkwMjI2NjgyODA3OQ==",
1601 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc5NDk1MTQwNjkwODcyNw==",
1602 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNTIzMTkzMDcwNTQwNjM=",
1603 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTE2MjUwMjk1OTc4MDc=",
1604 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNjIxNjI5MDA2ODczNDM=",
1605 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwNDUxMDM1MTkwODMxNg==",
1606 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTA0NDI1MjkwOTY2NTA=",
1607 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDYwMTM2MDM0MDUxMzQ=",
1608 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjg1MTY2NzUyMjUzOTM=",
1609 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyODg2NzIxODY2MTkwMDU=",
1610 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MDA4Mjc4MDEyMjAwNQ==",
1611 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4ODY5NzQ5Njg2MDQwNTQ=",
1612 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwOTM4NzA4NzI3MjA3MDc=",
1613 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMwNTk3ODYxNjA4NjA4MTI=",
1614 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MTE1MTA3ODM4MTc5Mjk=",
1615 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NzM4OTU4NTI5MDU0MjA3",
1616 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzA0NjE2MTQ3NTI5NTc=",
1617 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NzI4Njc4Njg0NjQxOA==",
1618 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0ODEyOTIzNzk5MzI3MQ==",
1619 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDA5MTI1NDE5ODc4MjY=",
1620 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMzcwNTI3MzgxNjUxNTE=",
1621 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTk2OTIzMTQyNjUxNjA=",
1622 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM4ODQ3NTcyNjE2NTYyODA=",
1623 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTM1OTIyMjgzNzMxMTk=",
1624 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODUyMTg5ODM3NTIyNTE=",
1625 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczMjM5MTQxMjcyMjY0Ng==",
1626 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk2MTU2MzIzOTk5NzI=",
1627 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQxNjA3MDA5NTA4ODgzNDg=",
1628 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc5MDQ5NTY1NDAzODIxMw==",
1629 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTg0Mjg2NTEwNDgxMzE=",
1630 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NDI3NjE2Mjk5OTA3NTU=",
1631 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDI2NTAwMjQ1MDA1MDU=",
1632 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3OTM1NTE2NTI2OTM3OQ==",
1633 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODE5NzUyMzY4MDE1OTU=",
1634 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI5MzA3MjExNjM4MDM1ODU=",
1635 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODkwMDAxNTkzMzg1ODA=",
1636 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODQ3NDUzODMwMDM5NDc=",
1637 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MzE1Nzk3Mjc3MjAzNDE=",
1638 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNzYxOTg4NjcwNDY3Ng==",
1639 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2OTUwMzI4NzE0NzY1OTg=",
1640 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNDMyMTU4NzM4NzgyNw==",
1641 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODAxODAxOTAwNDk5MQ==",
1642 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MzI5MDE3MTA0NTA2NQ==",
1643 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MTA3NTE4NjM3MTIzNzI=",
1644 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NTgwMTUxOTQ2ODg0MA==",
1645 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDQ2ODM1NzAwNjQ5ODM=",
1646 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDE1NzgzOTMxODAzNjI=",
1647 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NjA2Mjc4MzY4MjcyOA==",
1648 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNjgyNDY3MjQ3NzM2Ng==",
1649 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjUxNTY4MjU0MTQwNDg=",
1650 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI5ODg5Mjk2MjQ2Mzg2OTI=",
1651 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzgyMTMzMzc3Njc5Mzc=",
1652 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDU5MTIyNDM4NDMxNDg=",
1653 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjU4OTYwODE3NDYyNTE=",
1654 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0MDM1NDEzNTE2MDU0Ng==",
1655 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNTk5MjczNTYxNjU4OQ==",
1656 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM3NzIyNjUzMjk1NzQyNDE=",
1657 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzEzMzUzNDE0NTY5NDk=",
1658 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyODMxMDIxNjUyMzY2ODk=",
1659 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxNjg4MTQ0NDcxMzk2NA==",
1660 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjc3NjE5MDg1ODUzMDM=",
1661 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTExOTQ0ODA5MDgwNzQ=",
1662 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTc1MzgwMzQ4ODI3MTM2",
1663 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyMjc4NTMyMDU5NjY5Mw==",
1664 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NDQ4Mzk2MDAxNTIwNTM2",
1665 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMjU2NjM1MjY0OTQwOA==",
1666 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjY3MjE1NDIwNTgyODk=",
1667 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI2NzY5ODgzMjI2NTI1OTU=",
1668 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzc1NTgyOTc4NTIwMDc=",
1669 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNzI4NTM5MjMyODY3MTA=",
1670 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4OTE4NDg4MzUzNDgyNg==",
1671 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MDI4MDI3MjM3MDA4NzI=",
1672 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTUxNjM0Mjg1MDE0ODM=",
1673 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzY2ODQwNDM2ODk0NzY=",
1674 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0ODkxOTc0NDM5MzIwNg==",
1675 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwOTA5ODUxNzk2NzgxNzQ=",
1676 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NDIyNzkwNzM5ODc0Nw==",
1677 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzU1MDU2NTcxNDI2MDc=",
1678 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNzY5NDU4MDM3Nzk3Mg==",
1679 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODg3OTMzMzE2ODIxNg==",
1680 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMzUxNjU4NjE1NzM3OA==",
1681 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODkyNDkwNTg4OTg2NjQ=",
1682 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NDkyMTU3NzI5NTc1MA==",
1683 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODczOTE1Mjk3NTY0OTk=",
1684 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDMxOTk1MjY5MTgxODI=",
1685 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTM5MTAyOTk4OTY0NTM=",
1686 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTgwNTg4NDQ2NzYyNzg=",
1687 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzc1NDAwNTQwNzMxMjI=",
1688 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyNzAyNDY3ODY0Njg0OTk=",
1689 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NTkyNzEyNTkxMDA1Nw==",
1690 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTMyMDIzMzUzNjUwNDc=",
1691 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMzgyOTY3MDgxMjA5MTI=",
1692 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjM2MTkzNjQ4MjM5OTI=",
1693 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTA3NjU1MjUzMzg5Njg=",
1694 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMjQxMjgzOTYwOTEyMg==",
1695 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDA4Mzc4MjM2MzA3NTg=",
1696 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMTk3NzkwOTU1MzY0NDg=",
1697 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODU2NjEyMTU4NTU4NjA=",
1698 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4ODcyMjM5MzcxMzY5OQ==",
1699 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDUxNDYxNDM0ODYzMTY=",
1700 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Mzg5MTg0NzAwMDUzMA==",
1701 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTA4ODY5MzExMDE1NzA=",
1702 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDE4MDg5OTMyOTcyOQ==",
1703 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODQ2ODgwMTU5NDk2MjY=",
1704 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNzM0NDMxNjgxNDQ5NDg=",
1705 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzU4NDk3NjM4MzU4MjI=",
1706 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3OTE0NzEwNzk2Mzc4MQ==",
1707 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1Njc4MjM5NDc1NjQ2Mzg=",
1708 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzU5MjI0ODQ0MjIwMg==",
1709 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY0OTA2MDI0NDg2Njk5OA==",
1710 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNzkyNTgzNjYxOTIxODI=",
1711 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NjIxMzA2MjE4NTkzNTQ=",
1712 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2MzcyMDg1MjcwMDg0OA==",
1713 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4MjU5Njg1NDgwMzEwOA==",
1714 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0ODcyMTY2MDkyMzkwMg==",
1715 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNTg1MjY4MTI3NTg3ODk=",
1716 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1MzYzMjU1MDM2MzUzOA==",
1717 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwNDE3MTc5MTkzMzgyOA==",
1718 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzU0OTgwMDQzNzg4Mzg=",
1719 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzg4MDQ0Mzc2ODk5Nzg=",
1720 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzIyNDA0OTQ2MTY0ODI=",
1721 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyNzAyODg1Mjg2MDI2NDU2",
1722 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQ5MTI5MzY1MjIwMTc=",
1723 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzEzMjM5MTgzNzU1Ng==",
1724 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTgxMjAyODY3MzYwOA==",
1725 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MDU3MTI4MDQwNTU2MTA=",
1726 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTY1NzcwNDIxMzM4NDc=",
1727 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTM2MTQwNzU1NTgwMjg=",
1728 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxMjMxNjI0MDE1NDkxMDM=",
1729 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODgyNzczNzk0MTk2MTA=",
1730 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MzI4NDA4ODUwMjQ0ODg=",
1731 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxMjc4NDU3NDg2NTY4Nw==",
1732 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjM2MjkyNTgyMjA3MzU=",
1733 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDc1ODYzOTMyMTk2NDk=",
1734 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NDc0NTA3Mzk0OTA0NQ==",
1735 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDM0MDE2NjE0Nzg5OA==",
1736 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTc5MzYzMzU2MTIzNDI=",
1737 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzcxMDQ2NjAzMzg3MjA=",
1738 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjgwNzExMDQzODg5MTQ=",
1739 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjc1NTk5NTE4MzQ0MDc=",
1740 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNDM2OTIxNzc1NTQ5OTU=",
1741 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MDM5OTE2MTI4NjU4Ng==",
1742 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzNjk0OTM4NzM0OTU4MzU=",
1743 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNDMyOTQ5NjA4ODkxNQ==",
1744 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTQ5ODA2MzczNjQxMzg=",
1745 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTcwNDIxNTcxNTY2OTE=",
1746 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNDkzODY2Mjg0OTM2Mw==",
1747 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyOTcxODA3MDQ5MTMzNTUz",
1748 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzgxODY4ODQyMzQ1Nw==",
1749 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NzExNTQzMDM4NTk4MA==",
1750 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQ0MTMyNDc5NjIyNTI2Njg=",
1751 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzYyNjAwMDgzMTM4ODQ=",
1752 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODc3MjI3ODU4ODg4MTU=",
1753 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI0NzE4MjIwMjU0NTIyMzYx",
1754 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1NDg4MzE5MTAyMzgyNQ==",
1755 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTEyMzg1NzE5NjI1NTg=",
1756 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDQxMzIzNTAyNjI3OTI=",
1757 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDg1MzY1OTc1MTE4OTA=",
1758 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTY4ODAzMDI1OTcxMDA=",
1759 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MDAwNzUyOTQ2MjY1Nzc2",
1760 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTAyOTQ3NTQ0OTYzNzM=",
1761 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzczMjMwMzMyNDQ3MzM=",
1762 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MTc1OTc5MDU5MTY0MjA=",
1763 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzAzOTkwODM2ODUzNA==",
1764 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQwMjU0ODIyODc1OTUyMTQ=",
1765 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MjkxNTI5OTAzODM4MzY1",
1766 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzU3MTY2OTkyMjcwODAyNw==",
1767 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyMTQ3NjM0NDIxMzAzNjM=",
1768 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODY1ODI5NTYwMjg2MDI=",
1769 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQ4MzUyNTEwNjQ3Nzk=",
1770 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDk0NjYwMjM1OTAzODU=",
1771 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyMzE1NDU3MTA0MzE2MDM=",
1772 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDk0MDY4OTk3NTYzNjA=",
1773 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwODU3NTAyMjMxOTc0Ng==",
1774 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNjIyMTcyNDYwNjcxNzQ=",
1775 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQzNjU2MTY3MzM2NTk1NDM=",
1776 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3MTc0MzE1Njk2NjEyNjk=",
1777 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MjA4MzM0Mzg1NTI1MDc2",
1778 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDA0NDY2NTA0MDIzNzM=",
1779 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNTU0NDEzODAwNDE4NzQ=",
1780 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjg2OTc0OTI0ODAxMjY=",
1781 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyNDk4NDkyOTg4NzMyNjg=",
1782 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM0MzMwMzMyMjM1MjEwMDI=",
1783 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MTQwMTgxMzMxNDAxNg==",
1784 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0NjgwODY0NzgxMzY2NA==",
1785 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODk4MTAzMzY1NzQ4OQ==",
1786 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjE5MjE2NzkyOTAzNTk=",
1787 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNDQ1NjczMzYzOTQxODM=",
1788 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5OTcyOTE1MjQ4NDUzNw==",
1789 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwMzgxODczNTY0MzUwNQ==",
1790 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODU5NTM2Mjk4NTQ1MDI=",
1791 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4NzU3NjgwNDMzNzA2OQ==",
1792 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODk4MDAyNjkyODY5NTI=",
1793 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjY2OTg5MzE0NDEzNzY=",
1794 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM0MDA4Njc2Mjk4NzMxNjM1",
1795 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NDI1MjgxNDMwNDY1Mzc=",
1796 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI3MTkyOTQyOTE3NTU4MDE=",
1797 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTg5MTYzMTIxMjE0OTg=",
1798 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjk2ODAwODgzMjc1MDA=",
1799 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2Nzg3Mzk1OTQ0NDQ5Mw==",
1800 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQxNDgyMDc5MTc2OTM=",
1801 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MTc5OTQ1OTI4OTE3MjU=",
1802 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMDY5MjQ1MzQ1MjU3NTg=",
1803 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NzM0MjIyODI4MzAwOQ==",
1804 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MzAxNDk3NzUwMzg5MQ==",
1805 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkxOTkzMTU3NDUzMjc4MQ==",
1806 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMDgyODg1OTQzMTcyMDI=",
1807 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNzc1NzkwODg2ODI3MA==",
1808 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyOTI5MTY2Mzk1MTg2MjA=",
1809 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNjU5NzE5MDAzMDIzNQ==",
1810 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNjY0MjQzMjQ5MzIxMg==",
1811 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNjc5NDEzMDIxMjIxODY=",
1812 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNDM0NzgwNzI1NzUyNzI=",
1813 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTU0MzU4NTkxODg5Mjg=",
1814 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5Mjg2OTMwNDQ2OTg4ODE=",
1815 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNDkzMDI2MjczNDAyNTM=",
1816 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3OTkzODMwOTA3MzczODY=",
1817 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzcyODM2OTQzODI1MTY=",
1818 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDkyODkxMDQ3MjAyNDQ=",
1819 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxMjI2MTE1MTgxNzMwMQ==",
1820 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNjcxMTU1MTg4MjQwMzQ=",
1821 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMzM0OTIxNjE3NTc5Nw==",
1822 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTQ0ODY1MTM2OTU2NzI=",
1823 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjE5NjYwODg1ODg2OTA=",
1824 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTE4ODk2MTg5NTIyNTU=",
1825 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTAxODcxMDYyMjI5OTk=",
1826 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzQ1NjIzNDE0OTAxODk=",
1827 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM2OTg4NzU4MzAyNDUzMzg=",
1828 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQzMDA2MDk4OTY4NTA5Mzg=",
1829 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMjUxMjU3NTk4ODEzOQ==",
1830 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxNTM2NjM3MTIxODExOQ==",
1831 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjI4MjQ1NDUxMzcxOTQ=",
1832 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NDg2MjIzMDMyMTM3OTY=",
1833 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODc5NjUzMzUyMjkyMw==",
1834 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NzYyMjEzMTk3MjE3NTE=",
1835 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI4MTg5MDUzMjg1MDA1ODc=",
1836 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODI1NzAwNTY4MDU5Mg==",
1837 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODcyNTYwMzU5NTYxNDM=",
1838 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTk3OTg0ODI5Nzc4NTU=",
1839 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4NjUwMzE1Nzc3NjUwNQ==",
1840 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTQzMDA5MjU2NDg0Mzk=",
1841 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyOTQ3NTU0NzU3NTM4MDA=",
1842 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTQ5OTUwMDg3OTM2NDg=",
1843 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyOTU1OTE1Njg2MzUwNA==",
1844 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDQwMTkzMTA1MDA2OTk=",
1845 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMzY3ODU3OTE2MDExMDk=",
1846 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4Njg4ODExNjA2NTQ4OTQ=",
1847 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTA2MjA3OTY5MDMzNzY=",
1848 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NzQ0NzM0OTg1MTMwMTMx",
1849 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MjU4NTU4NDIzNTg3Mg==",
1850 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjE4NzU0NTkxMDgyNTQ=",
1851 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2ODU5ODQ5OTU3MDkzNjc=",
1852 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNTUxNDY2MDU5ODM1Nw==",
1853 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NjI0OTMwODM3MTE3OQ==",
1854 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3ODQwNjI5NDYzNzAzNg==",
1855 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODUwOTI3MzI1ODc0Nzg=",
1856 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODM3NDg2NjU5NzY2ODQ=",
1857 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4ODI1NDU0Njk5NzE0NQ==",
1858 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTg0NDg1NzE4NjI2NTE=",
1859 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzQwODE4NzA2NDI4NjA=",
1860 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1OTE0NDIxNjYxNTA4NjE4",
1861 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODEzMDE0MTQxMDg0MTk=",
1862 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NzM4NDg1NzAxNzMxNzE=",
1863 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDA1OTEwOTM4NjIwNTE=",
1864 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NjkzMDUzMzc4OTI0OQ==",
1865 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODQ2MTA0Nzk3MTQ1NTQ=",
1866 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODIxNzI5MDMyMDYwNDM=",
1867 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4ODIzNDUxMDU2ODkxNzU=",
1868 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTYxNzQ3MjAxMTkyMw==",
1869 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2MTUyODQxNjI2OTkyMw==",
1870 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNDc1NTkwOTIxNzI4MDc=",
1871 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0NjI1ODQ1ODMzMDc0OA==",
1872 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNTEwMjYwMjM1MTMzNzE=",
1873 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTQwOTc0ODE4NjIwNTE=",
1874 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkyODQ5MDUxOTkzMzcyNA==",
1875 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzExODE4ODcwNTA2NQ==",
1876 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODM0MTc5OTA0MjE2NDM=",
1877 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NzM3MDU3MDY4MTk0MDQ=",
1878 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzUxNzU0OTQxOTQyMjE=",
1879 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NTQyNDQ3NDY4NjgzMzEy",
1880 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MDc2Njg0MjQ2MzQ4OA==",
1881 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk1NDg1MzYwMjQ1OTg=",
1882 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDc5MjY3NDMwNDE5MDU=",
1883 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDkzOTc3OTYzNjM5MDM=",
1884 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODAwODgxMDcwNjI2NzU="
1885 |     ]
1886 |   },
1887 |   "https://www.facebook.com/stylowegaraze/posts/pfbid05vq8oLbrfBwqnN8EjEcae1ZE5MdfHip3QxCwJ3htMPDYPfBeEJivQ8qT9Yz22uyUl": {
1888 |     "lastCount": 188,
1889 |     "knownIds": [
1890 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
1891 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxMTc5MTI2OTU2Mjk1MDg=",
1892 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg3NDI4MjM4MTkyMjA4Ng==",
1893 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0OTQ2ODg1NDUwOTA1NzM=",
1894 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgwOTU5MDc1NTM5MTc1MA==",
1895 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzNzExODkzOTAwMTUwNTY=",
1896 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg2NjkyNzU5OTI1MjAyOA==",
1897 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMTY5MTMzNjcyMDYzNjg=",
1898 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMzc1MjEwNzE1NTA1NTk=",
1899 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg1NjYyMzA2NzI1OTc3OQ==",
1900 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExODgwMzE4NTI3OTkyNjQ=",
1901 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MzU4MjE1NDc2MjQ1NTU=",
1902 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgzMTQ0MzUyNjMxOTk5Nw==",
1903 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNTg3MTkyNDkyODI3NzY=",
1904 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NjE0MTYxNDUwMTM4ODE=",
1905 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1OTI5Mzk4ODU0MTAxNDE=",
1906 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzOTk1NDcxOTQ5NDg2NTk=",
1907 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExODA3Mjg4MTM5OTY3ODY=",
1908 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNzIxODM4NzQ4MjIyMTM=",
1909 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMzc0MDIyMjcwOTIxMTk=",
1910 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5NDgyMTIzMzI0MDczNTU=",
1911 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0OTMyMDgzMzUzMTI5Njc0",
1912 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg4OTgxMTQwMDM3MDg1MA==",
1913 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg1OTEyNDYxMDA2Njc3Ng==",
1914 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNzMwODI2NTc4NzQwMzY=",
1915 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDcxNjgzNzM4NjQwNzk=",
1916 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgxNjMyOTI1NzkxNTA5Ng==",
1917 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MzQ0NTczOTQxNjYyNzg=",
1918 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1MDU2NzAwNTcwNjQ4NzE2",
1919 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY4NDg0OTUxNDQxOTc0OQ==",
1920 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgxMjQxMjQ4ODI3MTEzOQ==",
1921 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQzNzIzODc4OTI5NzkwODY=",
1922 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMjk4Mjc2NzQxNzg0ODc=",
1923 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQyNDIxODM2MDI3MDUwMjc=",
1924 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5OTQwNzU3NjMyMjg3MA==",
1925 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQxNzgyOTcyNTkxNTIyMDM=",
1926 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMjQyMjEwODE2ODkxNzE=",
1927 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc1OTIwMTczMDQ2NDQ3Ng==",
1928 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5OTEyOTI5Mjk3MzUzMg==",
1929 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzUwNTQ3MTA0NTk5NDkzMg==",
1930 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4Njg3ODE2MDc0MDUzNDI=",
1931 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4NTUzMTcxMzg2NzYzODA=",
1932 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NjIxNzU3MjUxOTU0Mjg=",
1933 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY4NzQzNTk2NzE1NTg2NQ==",
1934 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NTc1ODQ1MTc5MTk2MQ==",
1935 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExOTUwMTIyNzkxMzAxODI=",
1936 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE3NTg3MTc1OTQ3ODk1NTU=",
1937 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1MzI2NjI0Mjc2OTIxNTg2",
1938 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTgyMjEzMTYzNjY5OTI=",
1939 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMDE5NDgyMjUyNTQyODk=",
1940 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTYwOTE5OTMwODI0MzY=",
1941 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMTI0NDc0MTAzODAyOTA=",
1942 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MDU4NDYxMTM2NTg4MTU=",
1943 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0OTAyOTg1ODE2MjE3Nw==",
1944 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQzNjE4NzAxMTA4MDI2MDU=",
1945 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDA4MzgyNjc4NTI3ODI=",
1946 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMzg0MzQ2MjgyODM2NTk=",
1947 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY1NzMzMDcyNDEwMjY3OA==",
1948 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDMzMzMxNTM2MzUxMzA=",
1949 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgyOTQxOTA1OTczNjUyNA==",
1950 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3OTg1ODczNzk5MTAyMQ==",
1951 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMTA5Mzk2NjI3MTYwNTA=",
1952 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5NDcyOTkxOTk0NzAyNg==",
1953 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwOTMxMjY0MDk1NzMyNzM=",
1954 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMzU4NzA1OTcxNzQ0Mjg=",
1955 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MTUyMDg3MTU3NjQxMTE=",
1956 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0NzMxNDQ1Mjk5ODA4NDE4",
1957 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxNDkwOTE0NDg5MTc4ODE=",
1958 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzE3MTIyOTIyNjM2NzI=",
1959 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3NTQxNjEwMTk0NTQxNw==",
1960 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjkwMjIwMDgzMTQ5MjU=",
1961 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NjI1NzIxODgzNzU3NTU=",
1962 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzY1MjM1MDc5MDg4ODE=",
1963 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMzEzMTMzNzE5MzAyNzE=",
1964 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1OTIyNTM1Nzc3Nzg2ODc=",
1965 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNTk5MTQwMDIyMjI2MTM=",
1966 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzYxODEzMzg0ODYyNzY=",
1967 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODI4Mzk5ODQwMTkwMDU=",
1968 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMjkwMTgyMjI0OTI3NjY=",
1969 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDU1NzA3OTA0NTI3Nzc=",
1970 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MzE1NDAwMTc3NTkyMTA=",
1971 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3NjYxODgyODE3Mzk2Mw==",
1972 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTc2NDcyMDIwOTkyNjM=",
1973 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY1NTg3MzA4MzQ1Mzc3OA==",
1974 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1ODIxMzMwNTI3NDczMTk=",
1975 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyODAwNzYzMjA0Mjc1MjU=",
1976 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwMjMzNDA2MjQ2NjI5NDI=",
1977 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3ODA4MjI3NDU0OTUyNw==",
1978 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMjk1MTcwNjI1MDM2MDY=",
1979 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2OTE5NDk0MjIzMjQyOA==",
1980 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYzMjA4Nzc4MzI0MzMxNg==",
1981 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0ODc3MDIyMDIyNDY1Mzk=",
1982 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxNDc5MTQwMjIzNzE2MTI=",
1983 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcyNjUzNjk2MzM0MDIwMA==",
1984 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTUyNjk5NzIzMTY3ODQ=",
1985 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0NTYzOTIxNDcxODEyMQ==",
1986 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMjgxMzUxODQ2MjMwNTg=",
1987 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NzIxMDg5MjA0Mjc1Ng==",
1988 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MjQyNzE3MTQ4MTA0OTM=",
1989 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczNDYyMjg5NjE2NDA0Mg==",
1990 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1ODc4Njg4OTkyNjYzNDQ=",
1991 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MzUxNDE3MzQxMDQyNzY=",
1992 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MTM2MTE1Mjk4OTQ4NzI=",
1993 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxMjYxNDI5MTY0MjY0Mw==",
1994 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3MDAxNjIzMjE4NTc3MA==",
1995 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjY2NTU5MzEzNjk3MTM=",
1996 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMTI4MjQ2MTczNTk1Nzg=",
1997 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwOTA3MjM3Nzk2NjA4MzE=",
1998 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjYwMjY5MzQ5MDUzNjY=",
1999 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2NTYxNDQ0NzgzOTExMzE=",
2000 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzMyOTY4MTc4MDc5MzU=",
2001 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MzkxNTc1MTY5MDMwNjI=",
2002 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNjk2ODc0OTUyMjk1ODU=",
2003 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNDYzMjk1NzQwNTQyNTc=",
2004 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MjgyNTEyNTE2MTQ2MTg=",
2005 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMDA0Mjc5NDAzOTg5MDk=",
2006 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI3MzExODQ2MjM3NDA3NTk=",
2007 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxODMyNTY5MTE2OTM2Ng==",
2008 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5MTAwNzE2MDEzMTU4Mg==",
2009 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3MDkyODQ1NTUzMjAxNQ==",
2010 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDkxNzU1MjcyMjkyNTY=",
2011 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3ODc0ODc1Nzk5MjI2Ng==",
2012 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MDM4MzQ4NDA0ODQzNjU=",
2013 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NTE1NDg5MDI0OTc2NjM=",
2014 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDA2MDIxMTQ3ODA2NjE=",
2015 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NzU4NDQ2ODY2NzUwMg==",
2016 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTMxMDc2NTg4NTAwNzc=",
2017 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2NTkzMzk0NDgwNjY4NTY=",
2018 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NzQ3MzI4MzcwMTg4OTQ=",
2019 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwOTM1MjU1NDgyNzU2NTAx",
2020 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYxNTIwMDI3MTE3NDc3NA==",
2021 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzczMDkxNDQwMDk3MzA=",
2022 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczMTMyMTAwOTY4MjA1Mw==",
2023 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM3MTM1MTE0MTU2MDc5NjE=",
2024 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzU5NjA5ODM3MzU2OTk5OA==",
2025 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MjU0MzM4MzgyNTc0NzA=",
2026 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM4OTYwOTEwMDM5ODU3NDY=",
2027 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0MTEyNjkyMjM1MDQ2NTI2",
2028 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODAzNDk2NjA3MDYyNjc=",
2029 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwMDI3OTQ2MzMyMzUzOTA=",
2030 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NjM0NzQ0NTQzNDkzOQ==",
2031 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MDUxODM0OTc0MTk5Nzg=",
2032 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMDk1MzA5MTEzODU2Mjk5",
2033 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzUxMTE4NzE5Njk5NjM=",
2034 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0NzE1MDQ2NzcwODM4MQ==",
2035 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM3OTM3MDQ5MTQyNjY5MjE=",
2036 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNjM0NzExNTI1ODgxMDI=",
2037 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMzc4NDEyNTc3OTgwMjg=",
2038 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNTE1OTk2NzcxNzQyNzc=",
2039 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0OTI3NzM5OTIxMDA3NTc=",
2040 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYwNzkwMjUwODYwMDgyOA==",
2041 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzUzMzM2MjEyNjUyNjg4MA==",
2042 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxNjA1NzU1NDYyMzU1Nw==",
2043 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE3Mzk2OTEyNzMzMzQ1MzA=",
2044 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDkyNjYzNTA3MjE5ODI=",
2045 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1Mzc2MzMyMzQzMTA2MDg=",
2046 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2OTEwNTQ0OTE1OTM3NQ==",
2047 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2MjM2MjAxOTE2NDQyNTk=",
2048 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY2ODg1Mjk0OTQ5MzA5MQ==",
2049 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0NDI5MzIyNjk0MDk1MzM=",
2050 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMDA2NzY4NjUyNjMxODA=",
2051 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcwMjI0OTg5NTk2NzE2MA==",
2052 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwOTEwOTI1Mjc3MDcxMTU=",
2053 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwODAyNjQ5NTIyMTcxNDE=",
2054 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NTcxMDgwNDU3MDU1NzY=",
2055 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzOTY3NDMwMzE0NDQ5NTM=",
2056 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0ODQ4NDc0Nzg1NTU4OA==",
2057 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDg1NTYzMTA3NTYyMDM=",
2058 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM5OTMyNzgzNDQzMTgwMTM=",
2059 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDEwMDA3NzA1ODcwMTE=",
2060 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDY4NjQ1NDAxMDA2OTg=",
2061 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzOTI5MTMzNzczNDEzNjM3",
2062 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczMTExMTc5MzE4ODk0Mw==",
2063 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMzODc3MjM1MTEzNjkyODQ=",
2064 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTA3NDk1OTY5MDg3NDM=",
2065 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzMDA0MzQwNjcxMjk2OTY=",
2066 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MjMyNzE5NTQ5MjExMDA=",
2067 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwNTM4NTEwMjE1OTcyMjA=",
2068 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0OTY1MzAzMDg1NjY4OA==",
2069 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDA0MzMwMDM4NjM4MDQ=",
2070 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MTM4MTE3ODI3OTcxNzQ=",
2071 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2NDcxNjcwOTY0NTE4MA==",
2072 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzgxMDE5ODcyNDc2ODY=",
2073 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NTIzNTIwMzk2NjM2MDE=",
2074 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODgyMjYyNjY3NTM0NjA=",
2075 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzU1MzE1ODU1NDU0NTA2Mw==",
2076 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNzA3NzU5NzE1Nzc5Nzk=",
2077 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzkwMTY5NzM3NTY5ODY0OQ=="
2078 |     ]
2079 |   },
2080 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid07QEU9poceJ3Awgq8MowtLEituw7ogQs6QZzwzNpi6KmfPn4Eom7QqPA5AquxumVFl&id=100050638022594": {
2081 |     "lastCount": 412,
2082 |     "knownIds": [
2083 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1OTE0NDk4NjE0ODA4OTI4",
2084 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjY4MjUyOTc4NjAwNzY=",
2085 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzYxNDI4MDEzNTA5NzI4Mw==",
2086 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NjI1MjU2NjQzNDkyNTU=",
2087 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIwMDA1MzM1MzkwMDM=",
2088 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNjg5OTQyNTgxNjY0Nw==",
2089 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjMwOTk5NDg1NTg4MTE=",
2090 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NjIxMzQ5OTI4MzY3Mg==",
2091 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTIxNjc1Njg5OTkyNzc=",
2092 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODgxOTU2NTI4NTczNjI=",
2093 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzEzMTE5OTgxMzUzMTA=",
2094 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY5OTQ1OTA0OTY3OTgxNA==",
2095 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTM5NDE2MTg2OTE5NzY=",
2096 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTM0NTM2NDY1ODA2MzA=",
2097 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MzI5MzczNjcwNjM4MDk=",
2098 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1NjcxOTAzNzA3NTA5NA==",
2099 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0ODY3MTg0NzU3MjIzNzA=",
2100 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NTQ4OTg3NTg1MjgwMjI=",
2101 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NzQyNjI2NTM0NzIwNDU=",
2102 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjYyOTc1MzQ1NjA3NTI=",
2103 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODAyNzc0NzI4NzY5MTc=",
2104 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNjMxNDA2NzQ1MjUyNTE=",
2105 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NDUwODk4MTU0OTY4OQ==",
2106 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDk1OTY5NDUyNzQyNg==",
2107 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NTY4MDgyOTUxNjk4NQ==",
2108 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzMDI3Nzk0NDMzNDIyNjY=",
2109 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODAxMzUwOTQzMTU1NjY=",
2110 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4Mjk4MjMyMDc1MzM5MQ==",
2111 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjYzNDAzNzk1NTc2Mjg=",
2112 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzAwMDMxOTQ2MTAzODA=",
2113 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzIxODczMTc3MjQzMjE=",
2114 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjA2NjYxNDY2NzE3MjM=",
2115 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjY5MzEyOTgyNjc3MTE=",
2116 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTY5Nzg0MTgwNDU5OTc=",
2117 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDE3NzExNzc0ODE5Nw==",
2118 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTk1OTIzNzg3NjY1NTk=",
2119 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzM2NTQyNjE2MDA0NjU3",
2120 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQxNzA0NTY3Mzk4Mzc0MTA=",
2121 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MTAzMTMwNzM0NzQ0Mjg=",
2122 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzUxMzUxMjM5ODY4NjY=",
2123 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNTE0MzIzMTY2NzY1MA==",
2124 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMTk0NTE1MDMyNjcxODA=",
2125 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5ODk4MjY2MzMwOTUwNQ==",
2126 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4MjE3MDk5NTg0Nzg0NjM=",
2127 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODQ4NzcxMTMzNDc3OTU=",
2128 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNzk4MzU1MzQ5NzYzOTg2",
2129 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODU0NTY4NzY0NDk2MzI=",
2130 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjI0NTQyNDIxNjU3OTc=",
2131 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2Mjg5MDM4MTE4MTY2NTA=",
2132 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5ODM2MjA4Njg4NDc3OTg=",
2133 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MzU0ODM4NDMwNjkxNw==",
2134 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczNzg0ODQ1OTMzNTQ0Ng==",
2135 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMxMzc4ODE1Nzk3MjU1NTI=",
2136 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNjk4MjkwMTM0NTU2MDQ=",
2137 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjczMDc5OTE0NDYzNDA=",
2138 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3NDE4NjU4OTU5NTgwNTM=",
2139 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIxNjExMjM1MTI4NTA=",
2140 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTk2NzY5NDk3MzA3NTU=",
2141 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTkyNDYyMDQ4MjM2MDk=",
2142 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTk3NDQ3MDkwNDE2ODg=",
2143 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNjUzMTUxNDcwMzI0NDA=",
2144 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MTYzNTE2NjI2MjU4OTk=",
2145 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTI4NzI1ODIzNDg4ODg1",
2146 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTM3NzgzMTI4OTQ5MTI=",
2147 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTMxMzcyNDA0MzA1ODY=",
2148 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNTIyNzE1ODMzMzYwNDc=",
2149 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2ODEyMzk1OTAyMzYyMw==",
2150 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDg4MjUzNTAzNjM1NQ==",
2151 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjA3MzUxOTI3NTEzMDY=",
2152 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDMwMzk1ODQ2Mzc0OQ==",
2153 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Nzc4ODYwMDk4Nzk0NzA=",
2154 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTYwODE4NDIyMDk0MjI=",
2155 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4NDc3MTk5NzkxNDg1OQ==",
2156 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMDU4NzA0MDY3NDczMA==",
2157 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NDMxMTM1OTk5NjE1MDk=",
2158 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI0Mzg4ODE2NTMyMzI4NDI=",
2159 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMTExNTgwMDYwNjc2Njc=",
2160 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjU3MDE1NjQ5NDkyMDk=",
2161 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMyOTA1MDE2NDE1NzgwMTk4",
2162 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjQwNTMyMjU4ODY5MTY=",
2163 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3ODk4NTIzMTczMDg3Ng==",
2164 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTA3NjA3OTk1MzgwMDY=",
2165 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NjA5NjYwNDQ1MzE5NTE=",
2166 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4Njg1NTcxNzEzNTQ5NA==",
2167 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4ODE4NjU0MDMxMTU1Nw==",
2168 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMzU4ODIzMzUwMDQ2NDQ=",
2169 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNzY3MjQ2NTc0NTY5NA==",
2170 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTE4NDcxMjA4NTIyMzU=",
2171 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2Nzk3NDQ2NjE3MzExNw==",
2172 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0NTg2MDc2NTIwODM1OQ==",
2173 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzMjIzNTg4MzEzODc1Mw==",
2174 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1OTEwOTM3NzA1MjEyMw==",
2175 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxNjk5NDkwNDY2MjUwMw==",
2176 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDYyNzk1NDAwMDU4NA==",
2177 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyOTc4MzExODczNjAyOTI=",
2178 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDcwMjE0NDQ0NTAzODM=",
2179 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNDQ2OTM4MDY0NDIzOQ==",
2180 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODY1NjcyODg2NDY0NzU=",
2181 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxNTAzOTEyMTU4NDEwMg==",
2182 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NDg2NDcyMzI0NzEyMTE=",
2183 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjQ3ODE0ODI0MzMxMjc=",
2184 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4MjQ2MzcwMDk3OTI4NA==",
2185 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMjU4NDA0MDgyMjQ4NDk=",
2186 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjIwOTY3ODY3MjM4NTM=",
2187 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzIyMTY2MTk0MTE0ODg1",
2188 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NDI1Nzc5MzM2MTA0OTc=",
2189 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTkwMTQ4MjY3MjQ1Mg==",
2190 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMDE1MDE0ODA2NjMxNTA=",
2191 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2NDgzOTg1ODk2NTE5MjM=",
2192 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MzAwODk0ODU4NzUwNA==",
2193 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTQ1MzYwMTcxMzI5OA==",
2194 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTY5MDQwNzg0NTU2ODQ=",
2195 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTcwNzQ0MTIyNjg0OA==",
2196 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Njc5ODc0Nzc5NjM2OTI=",
2197 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODgxODkxNTYwNDUyODg=",
2198 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjcxNTUxMDc3MTk3NjE=",
2199 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4OTY3OTk1MzQyODg5NA==",
2200 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyOTQ4NTU2MDE5NDA1NA==",
2201 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMTc2NzY1OTY5MjY4Mzc=",
2202 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMDU5MjY0MzEyODk2Nzg=",
2203 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTc4MTQ4OTc5Njc3NTk=",
2204 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3MTk3MjAyMjU2NTIzMTY=",
2205 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyODczMTkxNDgzNjIzOTg=",
2206 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNTU5OTg0ODMzMzQyMjg=",
2207 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTc0NDIwNTIzMzM5MjY=",
2208 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDUyMTQ3ODgyODAzOQ==",
2209 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Mzc4NzA4OTc1MTcyNDQ=",
2210 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMDE3NjA4MzcxMTQ1MDE=",
2211 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MzM1MjQ3ODQ4NDE2NA==",
2212 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0NzEzNzc1MTczMzgyOA==",
2213 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MTIyOTI0NTY1OTY3Mjg=",
2214 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNzQyMjg2MzkzOTM4MTQ=",
2215 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwOTQ2MDA0MTg5NjYxNQ==",
2216 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NTk0MjAxNTQ2Njc4NDg=",
2217 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjc5Mjc2Nzg0NDkyMTI=",
2218 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NjAyNDc0MDQ2NDkwOTQ=",
2219 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MTI4NjM5NzYwMTAwOQ==",
2220 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc5MTAxOTc5MDYxMjM4OQ==",
2221 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczMzE1NDIxOTg0NDU3MQ==",
2222 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzM1MDQxODQ5MjQ3NTI=",
2223 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNTY3MDEwODI3MjU5MA==",
2224 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNzQ1ODU4MDA5NjYxOA==",
2225 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzQ2ODMxNzc2Nzg0NTA=",
2226 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MzY0NjI2NDc1MTkwMDg=",
2227 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NjM1NDkyNjM5NjQ4Nw==",
2228 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MDkwNTAwNTQwNTUzMTk1",
2229 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODEzNzQ4MjA4MzcxMjc=",
2230 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMjczNDg4NjYxMzgxNjI=",
2231 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjExODIxNjk0Mzk0MzM=",
2232 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc1MTQwNDc2NDYzOTkyNg==",
2233 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTM3NTg4NzYwNTkwOTk=",
2234 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNzU5NzQyMDI2MzA0Mg==",
2235 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQxNzQ0MTAzOTk0NDY5MjM=",
2236 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTk2NzI3NzE0OTc4MjA=",
2237 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTQxMzk3OTU0MTA0NTE=",
2238 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjUwMTE4NjkwNzkxNjE=",
2239 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjk1NTg0MDkwMzU2NjQ=",
2240 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMDQyNzgzNzc5ODU4MA==",
2241 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4MTIyMTQzODI3NjM1NzU=",
2242 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDAzMDUxODE0ODI2MDU=",
2243 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5OTA3ODE1NjAxNzg1OQ==",
2244 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjk5MjI5Mjg5ODU4ODI=",
2245 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4MTE2MjI2MDkyMTY1Nw==",
2246 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NjE3NzE4OTEyOTgxNQ==",
2247 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjQ0OTkwMDUzMTAzMDc=",
2248 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjczNTMzODE3NTI0OTI=",
2249 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNDUxMjU0NjkwOTMzNzQ=",
2250 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTY2OTg3MTY2NjE1NjI=",
2251 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDYzMDA3NTY3ODc3NzE=",
2252 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTUwMDYzNzg3NTMzNjk=",
2253 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODg0MjA5MzkyNjU1MTk=",
2254 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDE1MTY1MTEzNDkwNDc=",
2255 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTkyODg5NDM0MzIxMTk=",
2256 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzMzMDY4ODQzMzMwMDE=",
2257 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNDU4NzQxNTAzNzE2MQ==",
2258 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3NDEzMzExMTI2Njg3NTk=",
2259 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODY5MDMwMTYwODc4NTg=",
2260 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNDU5NjIxMjQ0NTc5MQ==",
2261 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2Mzc2MzA5NTM4ODY1NDY=",
2262 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTM4ODgxOTIwMjU5NTM=",
2263 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5ODEwMTA4MTkxMTA2Mzg=",
2264 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjU2NzQ0NTE3ODk1ODQ=",
2265 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NjA4NzE0NDgyNDE2Nw==",
2266 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTIzMDk0MTU3OTEyNjU=",
2267 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MjcwNjM3NDU5MTkzMzg0",
2268 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzQzOTk3MTA5NDgzMzg=",
2269 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NTYzNzA0MzUwNDU1Mjg=",
2270 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjYzMzc4Mzg5MzkzMTA=",
2271 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMzcxMDUyNDAzNjIyNzM=",
2272 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NzU1NDI0NjY3MTc5OTU=",
2273 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NDY2NzUxNTI2Mjk3MzQ3",
2274 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDEwNDU1NDEzNTYyNDc=",
2275 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5MTgwMjM5Njg3ODMxMA==",
2276 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjA5MDU2NzQ5NDQ5OTI=",
2277 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzYyNjExMzM4MzIxMjk=",
2278 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjA5Mjg4ODg2OTg3MTY=",
2279 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwMDk0MzQ5MjE0MDUyNDU=",
2280 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyMjUxODEwNzI3Njk1OA==",
2281 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyNjI3MTIwNDU2MTYyNTE=",
2282 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2ODE1ODExODk4OTAyOTU=",
2283 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkwOTYwOTc0NDk3MzA1OA==",
2284 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODUyNDU0MjkwNDg2MjI=",
2285 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMjU5ODgwNzExNzIxNTI=",
2286 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTUyMTU2MjQ0MjE4OQ==",
2287 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwOTg4NzI0NDg5MjI0NTU=",
2288 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY3OTY0OTE1NTA4MTYzMQ==",
2289 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTkxMDAxMzI2ODM0NjE=",
2290 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzg3MjI3MDY5ODEwMDc=",
2291 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MjcyMTE1MDgzOTcwMTA=",
2292 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMzYzNzk2MjM1MDI0NzY=",
2293 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NDEyNDA3ODUxNjM0Mw==",
2294 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgwNDA4MTY4MjY0Nzc0NQ==",
2295 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjM1NDg4NTg2MDg1NTU=",
2296 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MzM5ODQ5Mjc1ODMxNQ==",
2297 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyODUzMDM4NzE5NDg5NTM=",
2298 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTYzODY0MTYyODEwOTI=",
2299 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODczODAyMTk4MjIzMjI=",
2300 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMjQ5NDAyMTQ2MzM5NDE=",
2301 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjUxNTgzNDExODQ4MzA=",
2302 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NzcwODg5OTY3MTcxODE=",
2303 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NDM1OTM5NjU4MjM4MA==",
2304 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Nzg2OTEzMDM0NDY0OTY=",
2305 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NzQyOTkxMjM3NTkzOTg=",
2306 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MjU5MTc0NDgzMTc3OTI=",
2307 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjUyNzQ0NzE2NDU3MDY=",
2308 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMzQzMzA4NTAzMjIxMzg=",
2309 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDc5MTk4NzQ0MDkxNQ==",
2310 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjM0MDA2MTU0ODA2NTc=",
2311 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzcyMDgyOTc5MjkzMTc=",
2312 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MjUxNDg4MDg3MjI1Njc=",
2313 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Mzg4OTAyNDQwMTM5MDU=",
2314 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MTU1NDg5NDIxMzY2NjU=",
2315 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMzQwNTk4MDU0Njk1MjM=",
2316 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNDgyNjg5MDc0MzM1NzQ=",
2317 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDUzMjQwNzA3NjIzMjA=",
2318 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTA5MzkzMjI5MjIyOTI=",
2319 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzk0NzM0NTQwMTI4NjM0Ng==",
2320 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDkxNTE0NDE4MTk2NA==",
2321 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDQ3OTAxODY5MjI3NzA=",
2322 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyNjI2NzQ1NzIzNTQ1ODI=",
2323 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyNTMwNzA1MzE4ODA2NDg=",
2324 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0MzMzMDQ4NTY4OTEwNjE=",
2325 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTIwMzI4MjYyMzMyMzI=",
2326 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTg1MzM0MTc4Nzg2NDI=",
2327 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NTY2NzM3Njk2NDU1NA==",
2328 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjU5NjQ3MzkwODAwMTU=",
2329 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjQ1OTM3ODE3MjM0NjE=",
2330 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzODQyMjk5NTQ1NTI0MA==",
2331 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNzk5NTk3ODkxMDc5NDY=",
2332 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDM3MTYzNDE3MDYzODk=",
2333 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3ODIzODcxMjU4MTIxMDU=",
2334 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3Nzc1OTU3MjYyMjI3NDg=",
2335 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkzMzc0MjAxNTk5MTA4OA==",
2336 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NjMwNzM4Nzc5ODgzMzk3",
2337 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MTk4Nzk2MzU1OTU0OTc=",
2338 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2ODU0Nzg2OTAwNDgwNw==",
2339 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQwNzQ5NjY0NjI3NTI4MDc=",
2340 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDQ5MDc1ODEyNjczNjM=",
2341 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzE3Mzk2MDQ3MDA1NTM=",
2342 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjEyNTEzNTIzNDYwMg==",
2343 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMjY2Nzg4MDQ2MzYwOA==",
2344 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4OTE4NjM4MDgwNjMxOA==",
2345 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NTM4NDYwNDk0MzI5MTI=",
2346 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNjI5NjU5MzA1MzI5MDA=",
2347 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTMyNjg3Mjk0ODE0NDM=",
2348 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTkwMTQ4Mjk4NDUxOTQ=",
2349 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxNDA2MTg5MzAwNzY1MjQ=",
2350 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDI1MDE3NTQ3NjE2MTY=",
2351 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MjU3MjI1NTIwMDEwNg==",
2352 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTM1NzM3MDY5NDU5NzI3",
2353 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NDc3MDAzOTc3OTI1Mw==",
2354 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNDc5MTM4MzczMTgyMg==",
2355 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODMzOTY5MTAxOTU0NTc=",
2356 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMTg5OTYyMzg2MTUwNzM=",
2357 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDcwNTE4NTc1NjU4ODk=",
2358 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNzIzMjYxODk2NjM3MzU=",
2359 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTE0MzU2NzU4ODkyMzk=",
2360 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTUzNzI4NzQ4ODExMTg=",
2361 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTgzOTA1NTQ0NjEzNjYy",
2362 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyMDU4MzQ3MDk5NDM5MjI=",
2363 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczMzQ3NDExMzEyNzY1Mw==",
2364 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTQzNDg4NTcyNDcwNTc=",
2365 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4OTUyODg5MDgwNDcyNjk=",
2366 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0ODcyMzU3ODA3OTI5Mw==",
2367 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNzgzNzEzNDkzNDQ4OTM=",
2368 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxMTM1MTM5NTAyNzE3NA==",
2369 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0Mzk4NTY3NTEwNDczNjk=",
2370 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzM2MzMwMDc3NTgwMTY=",
2371 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTIxOTQ5Nzk4ODk2MjU=",
2372 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMjM1MDE1MjcwMzQ2Nw==",
2373 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNDgwNjgwNjM5ODM5Nzk=",
2374 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzODU5NDc4MTgzMTUzNDI=",
2375 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkwNDYyMzgxNTYyOTk3OQ==",
2376 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDEyMDEwNTg2MzEyMDM=",
2377 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzY2Nzk5MTM5NjEzNDc=",
2378 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNDcwNjg2ODcyMTc0OTg=",
2379 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTQzNDM2OTQwNDcyMw==",
2380 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQyMDY3MjIxNjI5Nzg4NDU=",
2381 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDAxNzA0NTgyMTY4ODc=",
2382 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzI1OTI3NjQ1MTgzOTg=",
2383 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkxNDI5NTUwNTA5OTI5MA==",
2384 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDg1NjkyODcwMTU2MjM=",
2385 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODk1NDY5MzkyOTE3NTE=",
2386 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MTE0NTIyNjI4NTkzMg==",
2387 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODEyNTU1MjA2ODk5MDg=",
2388 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTYzNjMxMTcwODQ0ODc=",
2389 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNzA1NjA1MTQ0OTY4OQ==",
2390 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDEyNjgxNTE3MjUwODk=",
2391 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDkyNTU4Njc4Mzc3MzQ=",
2392 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMDUzMzA2ODY2NDY0OTg=",
2393 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzI4OTMxMDc5NTM5NDU=",
2394 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjkzMjE1NTY5MzQyNw==",
2395 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODY0MDU0OTI1MDIyODY=",
2396 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzODE1MDAyMjIxMzAwODQ=",
2397 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTc1ODM1NzE0MDczMzg=",
2398 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MjUzMjg3NzUxMTYxMjg=",
2399 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjM1NTgwNzYzMDIyMjg=",
2400 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5MjgzMjM0NjUyNzE0Ng==",
2401 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMzQ1MjI3NTkwMTM3MA==",
2402 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NDMyMjAwMzMyNzE1MDI=",
2403 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjM5NjIyOTI5NjAzMDY=",
2404 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMTQxMzM1MzczMDk2OTc=",
2405 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTMyMjE3OTIxNzk2NTQ=",
2406 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDA0NTc5NDQ1NzQ4ODU=",
2407 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjI2NzI0NDY0ODM1MTM=",
2408 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMTkyNjQ0NjA2MDM4Mg==",
2409 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTA1OTY3NTkyNDMwMjM=",
2410 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MzY3NTg4MDc4NjgyNzQ=",
2411 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjkxNjczODIxNDM3NTY=",
2412 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NDcxOTY3NjM1ODAzNzk2",
2413 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzgzMjgxMjM2ODM5Mzc=",
2414 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2OTIxNjM4NTgwODA0NQ==",
2415 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwMjg4NTM2NDI3NDgzMTM=",
2416 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMjUwMDQ2MTk1MjE4NjU=",
2417 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4Mzg0NTU0MTM0MDM0OQ==",
2418 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMyMjg1MTY0MzA2NTg4NDU=",
2419 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTMyMzQ3NjI0NDU0Mjg=",
2420 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMDI2MDk3MDA1NTMxNDE=",
2421 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxMDAyMjkwMjAzMTY0MQ==",
2422 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjgyNDcyMDgzMzY1MDY=",
2423 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ1NzcxNTYzNzI1NjMzODQ=",
2424 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTI1MDQzNjk5NDQxODk=",
2425 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzYzODY5Mzc1NDcwMTg=",
2426 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI0MjI2NzY0NzE1MjAwODk=",
2427 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MjM2NTMzODg5OTQ5OTU=",
2428 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI4NDEyNTU1MjkzOTA4NDI=",
2429 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDAzMTYyNTU1MzE3NTE=",
2430 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTg2NjQzNTA4NzQ2OQ==",
2431 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjg5OTE5MDE1NTE0ODU=",
2432 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTUxOTM5MDkyMjU0MzE=",
2433 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NjkyNDA3OTM3MTkyOTY=",
2434 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NzEyNjM3MDM1NzIxMDQ=",
2435 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM0NTg1MzkwMjc2Mjk2NTM=",
2436 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTAzMzEyNzc2NDY3OTA=",
2437 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2NTE4ODY5ODI0NTYzNjg=",
2438 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjQ4MDEyMjE3MzgzMw==",
2439 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTYwMDE2OTE2OTEzMDE=",
2440 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIwODA2NzQxMTE5NjE=",
2441 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyMDgxNjgwMTMwMzk3NDY=",
2442 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1OTIzMDQ4Nzc3MjgxNjQ3",
2443 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MDg4NTU1MzAwNjAzOTQ=",
2444 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTE0ODUxNDI4NzUwNTM=",
2445 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0MTczNzY5ODk1NTY0Mg==",
2446 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQyODQ2NTQxNTUxMjYyNTk=",
2447 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTY1NDMyNzgyODkxODA=",
2448 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDE3ODg4MzQyNjgxNjE=",
2449 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODE1OTMzNTAzOTkyNTU=",
2450 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjAyNzExNzg0NDkxMTU=",
2451 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MDAyNDczMzYzMDUzMg==",
2452 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDUzMzk3NzcyMzUzNA==",
2453 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzM3NjQxOTE0OTMwMjk=",
2454 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwODQ2Mzc1MzIyNzIxODc=",
2455 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyOTA2ODAxNzYxNTY3MDM=",
2456 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzM4MzAzODA3ODYwMTg=",
2457 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3MTU1MTU0NDg1OTE3MDI=",
2458 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODk1NTQxNjQ5ODYxOTM=",
2459 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyOTk4Mzc0NzIxNjQzMzQ=",
2460 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDI5MDY4NDM3OTgxNjk=",
2461 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY1MDQyODU1MTM5NzQ1Nw==",
2462 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1ODA5NjYxNjU4NDAwMQ==",
2463 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3ODc0NjAwMDg2MjMyOTg=",
2464 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDgzMzQwMDkyMzk5OQ==",
2465 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0NDU4MDEwODU2NDE5NDE=",
2466 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0Njg3NjY0NTMzNjg2MzQ=",
2467 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzMTY5NjE4NjE5MDk4OTY=",
2468 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MjEzMDQ2ODQ1NjI3Nw==",
2469 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MTg3Mzc0MzI0MjcxNQ==",
2470 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NzgxMzAxMTM1ODY3MjQ=",
2471 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzQxNjg5NDEwODIzNjE=",
2472 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5OTY3OTgzNDQ0MzMwMDI=",
2473 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTA2NjkyOTQxODUyMDM=",
2474 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NjAxNTU0MDc4ODM2NDY=",
2475 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NzQ2OTU4NzEzMjcwMjg=",
2476 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzA2NzE0MjAyMzE3NjQw",
2477 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNzk0MjkyNzA4ODkxNzY=",
2478 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MDAzNjc3MzYyODUxNQ==",
2479 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzODExNTQzNzU2NzY5NDE=",
2480 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTc4MDg3OTY2NDgyMTM=",
2481 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MjkwMjM4NTQxNDA5MzA=",
2482 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjUxMjQ0NDc4NDMwNjU=",
2483 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Njc3NjQ1MTc4NzQxMDE=",
2484 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4MzE1NTI0NDc3ODAxMQ==",
2485 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTA4OTAyMzkyNDI4MDM=",
2486 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MzMzNzQxMTc4ODE1OA==",
2487 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2NzMyMzkzMjMzMDE3OTQz",
2488 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA1MzUxNzM2MjExNDE1Mw==",
2489 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzOTc4ODE4MjA2MzAxMDc=",
2490 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNjg2NjY2NjcyMDM0NTc="
2491 |     ]
2492 |   },
2493 |   "https://fb.watch/E7JKv3fqd4/": {
2494 |     "lastCount": 3531,
2495 |     "knownIds": [
2496 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExOTY2MzY3Mzg5Nzk4MjI=",
2497 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1ODc4MTgyMDkwNTMwOTA=",
2498 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI2NjI5NDk1NjQwMzkxODg=",
2499 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExNjM1ODE5ODE5MzQxNjE=",
2500 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMzU1MjA0Mjk3MDc3NQ==",
2501 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzQyMzE2Nzg0MzcxNTIxMjk=",
2502 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzM4OTYwOTA2MTQwMjM2Mjg=",
2503 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI1MTIxMzgxNzk3NTQ4NzEx",
2504 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1MTY5NjA5MjI3NTc3MzA=",
2505 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3MjkyMzc1NTQ0MTU5MjM=",
2506 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzc3NTk5MTE0ODczNDg0NA==",
2507 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIwMzM4ODAxMTA3MTIwMDA=",
2508 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI1MzgxMDE2MzQ4MjA2MDQ3",
2509 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5MTQ0NDA0OTI4MTUwNzU=",
2510 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEzMzkyNjY2ODA0MTUxNjY=",
2511 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExMjA3OTQ0NjMxNTMyOTA=",
2512 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzQ0NTk1MTg4ODA5NDYzMDM=",
2513 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3MzQ1MjgyNTA1NzY5NTk=",
2514 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzg0NTgxNTk2ODAyNDIxNA==",
2515 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgyODE1MTU5OTkxNTE1NA==",
2516 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIxODYyMjg1NTUxOTk2NzY=",
2517 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzMyMDc1MDY3OTk0MTQxMDc=",
2518 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzc3MDE5ODI2MjcyMjUyOA==",
2519 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMTg1NDUxMzEwNzM0Nw==",
2520 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzg0OTcwNzc4NDI2MjQwMA==",
2521 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExMzcwMzUzODg2Mzc0NDc=",
2522 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1MzA1NjYwNDQ2NTYzMTI=",
2523 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0MzI4MTM3NDE1NTAyOTc=",
2524 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3NjE5MjM4MDQ1MDQ2Mjc=",
2525 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzM0NDg4NDI0NjE5NDE0OTk=",
2526 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE4OTAzNjMzNjUyNDM0MjU=",
2527 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzY3NDUyODM5NTQ1MjA5NQ==",
2528 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMjg2NzQ3OTMyMzIzOA==",
2529 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgxMzQzMzAwODE0OTM3Ng==",
2530 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5NDY5NzQwODI1MzczNjY=",
2531 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzk4ODQ2MzA2NjgwOTMyMg==",
2532 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEyMjQ3MzMxMTk1NjI3ODk=",
2533 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEzMjE0NTY3NTYzNDYwNTE=",
2534 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1OTc0OTA0OTc4OTgxODE=",
2535 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzcwOTcyOTY2NDk0NDY2MQ==",
2536 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIwNzkyNDU4MDk1MTI1ODM=",
2537 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzMzNDQyNjAyNzIzODc4NTA=",
2538 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExOTI5MzU0NTI3MjEzNjM=",
2539 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgxNDM5MjAxNzg5Mjg3NQ==",
2540 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5MjE3NjI0MDE3MDYxNzk=",
2541 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1NzQzOTYyODA2Mzk3MzM=",
2542 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0OTEwMTA0Nzg4MDEzMzY=",
2543 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI2MTgxMDIxMjc0ODI0MDQ0",
2544 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0NjQyODQzNzg1OTIyNDQ="
2545 |     ]
2546 |   },
2547 |   "https://www.facebook.com/watch?v=1339546710688438": {
2548 |     "lastCount": 19,
2549 |     "knownIds": [
2550 |       "Y29tbWVudDoxMjcwMTgwMDU4NDc1MDQ0XzcwMjIxNTk1NTk1MzU1Mw==",
2551 |       "Y29tbWVudDoxMjcwMTgwMDU4NDc1MDQ0XzE0OTQ2NzA1MDQ5NjkzODg="
2552 |     ]
2553 |   },
2554 |   "https://www.facebook.com/watch?v=1193982469334393": {
2555 |     "lastCount": 5,
2556 |     "knownIds": [
2557 |       "Y29tbWVudDoxMjk4NzI0NTg1NjMwOTM5Xzc5OTAzMjI0NjUwMDQzNQ==",
2558 |       "Y29tbWVudDoxMjk4NzI0NTg1NjMwOTM5Xzg5MDAyNjgyMDM3MTY2Nw=="
2559 |     ]
2560 |   }
2561 | }
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/comments.js
  2 | import { EXPAND_COMMENTS } from "../config.js";
  3 | import { sleepRandom } from "../utils/sleep.js";
  4 | import { scrollPost } from "./scroll.js";
  5 | import { acceptCookies, saveCookies } from "./cookies.js";
  6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
  7 | import { clickOneExpandButton } from "./expandButtons.js";
  8 | import { safeGoto } from "../utils/navigation.js";
  9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
 10 | 
 11 | import * as uiPhoto from "./ui/photo.js";
 12 | import * as uiPost from "./ui/post.js";
 13 | import * as uiVideos from "./ui/videos.js";
 14 | import * as uiWatch from "./ui/watch.js";
 15 | 
 16 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 17 |   ? Number(process.env.NAV_TIMEOUT_MS)
 18 |   : 90000;
 19 | 
 20 | /* ============================================================
 21 |    ===================== UI ROUTER ============================
 22 |    ============================================================ */
 23 | 
 24 | function pickUiHandler(url) {
 25 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
 26 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
 27 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
 28 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
 29 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
 30 |   return null;
 31 | }
 32 | 
 33 | 
 34 | /* ============================================================
 35 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
 36 |    ============================================================ */
 37 | 
 38 | async function openCommentsMenu(page) {
 39 |   const r = await page.evaluate(() => {
 40 |     const norm = (s) =>
 41 |       String(s || "")
 42 |         .replace(/\u00a0/g, " ")
 43 |         .replace(/\s+/g, " ")
 44 |         .trim()
 45 |         .toLowerCase();
 46 | 
 47 |     function getLabel(el) {
 48 |       return el.getAttribute?.("aria-label") || el.textContent || "";
 49 |     }
 50 | 
 51 |     if (document.querySelector("div[role='menu']"))
 52 |       return { ok: true, state: "menu-already-open" };
 53 | 
 54 |     const els = Array.from(
 55 |       document.querySelectorAll(
 56 |         "button,div[role='button'],span[role='button'],a[role='button']"
 57 |       )
 58 |     );
 59 | 
 60 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
 61 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
 62 |     const btn = els.find((el) => {
 63 |       const t = norm(getLabel(el));
 64 |       return (
 65 |         t === "najtrafniejsze" ||
 66 |         t === "most relevant" ||
 67 |         t === "wszystkie komentarze" ||
 68 |         t === "all comments" ||
 69 |         t === "najnowsze" ||
 70 |         t === "newest" ||
 71 |         t === "poka≈º wszystkie" ||
 72 |         t === "show all" ||
 73 |         t === "wy≈õwietl wszystkie" ||
 74 |         t === "view all"
 75 |       );
 76 |     });
 77 | 
 78 |     if (!btn) return { ok: false, reason: "no-trigger" };
 79 | 
 80 |     try {
 81 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
 82 |     } catch {}
 83 | 
 84 |     try {
 85 |       btn.click();
 86 |       return { ok: true, state: "clicked-trigger" };
 87 |     } catch {
 88 |       return { ok: false, reason: "click-failed" };
 89 |     }
 90 |   });
 91 | 
 92 |   return r?.ok === true;
 93 | }
 94 | 
 95 | async function clickMenuOptionByPrefix(page, prefixes) {
 96 |   return page.evaluate(
 97 |     (prefixes) => {
 98 |       const norm = (s) =>
 99 |         String(s || "")
100 |           .replace(/\u00a0/g, " ")
101 |           .replace(/\s+/g, " ")
102 |           .trim()
103 |           .toLowerCase();
104 | 
105 |       const menu =
106 |         document.querySelector("div[role='menu']") ||
107 |         document.querySelector("div[role='dialog']");
108 |       if (!menu) return { ok: false, reason: "no-menu" };
109 | 
110 |       const items = Array.from(
111 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
112 |       );
113 | 
114 |       const opt = items.find((el) => {
115 |         const t = norm(el.textContent);
116 |         return prefixes.some((p) => t.startsWith(p));
117 |       });
118 | 
119 |       if (!opt) return { ok: false, reason: "no-opt" };
120 | 
121 |       try {
122 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
123 |       } catch {}
124 | 
125 |       try {
126 |         opt.click();
127 |         return { ok: true };
128 |       } catch {
129 |         return { ok: false, reason: "click-failed" };
130 |       }
131 |     },
132 |     prefixes
133 |   );
134 | }
135 | 
136 | async function switchCommentsFilterToAllLegacy(page) {
137 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy na: 'Wszystkie komentarze'‚Ä¶");
138 | 
139 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
140 |     const opened = await openCommentsMenu(page);
141 |     if (opened) await sleepRandom(250, 450);
142 |   }
143 | 
144 |   const picked = await clickMenuOptionByPrefix(page, [
145 |     "wszystkie komentarze",
146 |     "all comments",
147 |     "poka≈º wszystkie",
148 |     "show all",
149 |     "wy≈õwietl wszystkie",
150 |     "view all",
151 |   ]);
152 | 
153 |   if (picked?.ok) {
154 |     await sleepRandom(250, 450);
155 |     await page
156 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
157 |         timeout: 2500,
158 |       })
159 |       .catch(() => {});
160 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
161 |     return true;
162 |   }
163 | 
164 |   console.log("[FB][filter] Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze' (best-effort).");
165 |   return false;
166 | }
167 | 
168 | /* ============================================================
169 |    ===================  EXPAND (LEGACY)  =======================
170 |    ============================================================ */
171 | 
172 | export async function expandAllComments(page) {
173 |   if (!EXPAND_COMMENTS) return 0;
174 | 
175 |   let clicks = 0;
176 |   for (let i = 0; i < 30; i++) {
177 |     const didClick = await clickOneExpandButton(page);
178 |     if (!didClick) break;
179 |     clicks++;
180 |     await sleepRandom(450, 900);
181 |   }
182 |   return clicks;
183 | }
184 | 
185 | /* ============================================================
186 |    ===================  LICZNIK KOMENTARZY  ====================
187 |    ============================================================ */
188 | 
189 | async function getCommentCountLegacy(page) {
190 |   const ui = await getUiCommentInfo(page).catch(() => null);
191 | 
192 |   const uiCandidates = [
193 |     ui?.comments,
194 |     ui?.count,
195 |     ui?.commentCount,
196 |     ui?.commentsCount,
197 |     ui?.totalComments,
198 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
199 | 
200 |   if (uiCandidates.length) {
201 |     const best = Math.max(...uiCandidates);
202 |     console.log("[FB][count] UI:", {
203 |       best,
204 |       candidates: uiCandidates,
205 |       source: ui?.source || "ui",
206 |       raw: ui?.raw || null,
207 |       viewType: ui?.viewType || null,
208 |     });
209 |     return best;
210 |   }
211 | 
212 |   const uiLoose = await page
213 |     .evaluate(() => {
214 |       const texts = [];
215 |       const pushText = (t) => {
216 |         if (!t) return;
217 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
218 |         if (s) texts.push(s);
219 |       };
220 | 
221 |       const els = Array.from(
222 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
223 |       );
224 |       for (const el of els) {
225 |         pushText(el.getAttribute?.("aria-label"));
226 |         pushText(el.textContent);
227 |       }
228 | 
229 |       const nums = [];
230 |       for (const t of texts) {
231 |         const low = t.toLowerCase();
232 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
233 |         if (m) nums.push(Number(m[1]));
234 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
235 |         if (m) nums.push(Number(m[1]));
236 |       }
237 | 
238 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
239 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
240 |     })
241 |     .catch(() => ({ count: null, sample: [] }));
242 | 
243 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
244 |     console.log("[FB][count] UI-loose:", uiLoose.count);
245 |     return uiLoose.count;
246 |   }
247 | 
248 |   if (ui) {
249 |     console.log("[FB][count] UI object (no number):", { keys: Object.keys(ui), ui });
250 |   } else {
251 |     console.log("[FB][count] UI object: null (getUiCommentInfo failed or returned null)");
252 |   }
253 | 
254 |   const anchors = await page.evaluate(() => {
255 |     const as = Array.from(
256 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
257 |     );
258 |     const ids = new Set();
259 |     for (const a of as) {
260 |       try {
261 |         const u = new URL(a.href);
262 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
263 |         if (raw) ids.add(raw);
264 |       } catch {}
265 |     }
266 |     return ids.size;
267 |   });
268 | 
269 |   if (anchors > 0) console.log("[FB][count] anchors-fallback:", anchors);
270 |   return anchors > 0 ? anchors : null;
271 | }
272 | 
273 | /* ============================================================
274 |    ===================  EKSTRAKCJA KOMENTARZY  =================
275 |    ============================================================ */
276 | 
277 | async function extractCommentsFromDOM(page) {
278 |   const data = await page.evaluate(() => {
279 |     function extractCommentIdRaw(url) {
280 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
281 |       return m ? decodeURIComponent(m[1]) : null;
282 |     }
283 | 
284 |     function safeAtob(input) {
285 |       try {
286 |         let s = String(input || "");
287 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
288 |         while (s.length % 4) s += "=";
289 |         return atob(s);
290 |       } catch {
291 |         return null;
292 |       }
293 |     }
294 | 
295 |     function idNumFromRaw(idRaw) {
296 |       if (!idRaw) return null;
297 |       const s = String(idRaw).trim();
298 |       if (/^\d+$/.test(s)) return s;
299 | 
300 |       const dec = safeAtob(s);
301 |       if (dec) {
302 |         const m = String(dec).match(/(\d{6,})\s*$/);
303 |         if (m) return m[1];
304 |       }
305 |       const m2 = s.match(/_(\d+)\b/);
306 |       return m2 ? m2[1] : null;
307 |     }
308 | 
309 |     function normalizeTime(text) {
310 |       if (!text) return null;
311 | 
312 |       const t = String(text)
313 |         .toLowerCase()
314 |         .replace(/\u00a0/g, " ")
315 |         .replace(/\s+/g, " ")
316 |         .trim();
317 | 
318 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
319 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
320 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
321 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
322 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
323 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
324 | 
325 |       return null;
326 |     }
327 | 
328 |     function findTimeAround(linkEl, fallbackNode) {
329 |       const root =
330 |         linkEl?.closest?.("div[role='article']") ||
331 |         linkEl?.closest?.("div[aria-label]") ||
332 |         linkEl?.closest?.("div") ||
333 |         fallbackNode;
334 | 
335 |       if (!root) return null;
336 | 
337 |       const els = root.querySelectorAll("a, abbr, span");
338 |       for (const el of els) {
339 |         const aria = el.getAttribute?.("aria-label");
340 |         const t1 = normalizeTime(aria);
341 |         if (t1) return t1;
342 | 
343 |         const txt = el.textContent?.trim();
344 |         const t2 = normalizeTime(txt);
345 |         if (t2) return t2;
346 |       }
347 |       return null;
348 |     }
349 | 
350 |     const nodes = Array.from(
351 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
352 |     );
353 | 
354 |     const extracted = nodes
355 |       .map((node, idx) => {
356 |         const author =
357 |           node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
358 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
359 | 
360 |         const linkEl =
361 |           node.querySelector("a[href*='reply_comment_id']") ||
362 |           node.querySelector("a[href*='comment_id']") ||
363 |           node.querySelector('a[role="link"]');
364 | 
365 |         const href = linkEl?.getAttribute("href") || null;
366 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
367 | 
368 |         const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
369 | 
370 |         const id = id_raw ? String(id_raw).trim() : null;
371 |         const id_num = id_raw ? idNumFromRaw(id_raw) : null;
372 | 
373 |         const time = findTimeAround(linkEl, node);
374 | 
375 |         if (!author || !text) return null;
376 | 
377 |         return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
378 |       })
379 |       .filter(Boolean);
380 | 
381 |     return extracted;
382 |   });
383 | 
384 |   return Array.isArray(data) ? data : [];
385 | }
386 | 
387 | /* ============================================================
388 |    ===================  PREPARE / LOAD (LEGACY)  ===============
389 |    ============================================================ */
390 | 
391 | async function prepareLegacy(page, url) {
392 |   const ok = await safeGoto(page, url, "comments", {
393 |     waitUntil: "networkidle2",
394 |     timeout: NAV_TIMEOUT_MS,
395 |   });
396 | 
397 |   if (!ok) throw new Error("safeGoto-failed");
398 | 
399 |   const currentUrl = page.url();
400 |   if (currentUrl.includes("/login")) {
401 |     console.log("[FB] /login redirect ‚Üí fbLogin() and back");
402 |     await fbLogin(page);
403 |     await sleepRandom(3000, 4500);
404 | 
405 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
406 |     console.log("[FB] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
407 | 
408 |     if (loggedAfterLogin) {
409 |       await safeGoto(page, url, "comments", {
410 |         waitUntil: "networkidle2",
411 |         timeout: NAV_TIMEOUT_MS,
412 |       });
413 |     }
414 |   }
415 | 
416 |   await acceptCookies(page, "post-initial");
417 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
418 |   await sleepRandom(900, 1400);
419 |   await acceptCookies(page, "post");
420 | 
421 |   try {
422 |     const logged = await checkIfLogged(page).catch(() => false);
423 |     if (logged) await saveCookies(page);
424 |   } catch {}
425 | 
426 |   await scrollPost(page, 140).catch(() => {});
427 |   await sleepRandom(500, 800);
428 | 
429 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
430 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
431 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
432 |   await sleepRandom(250, 450);
433 | }
434 | 
435 | async function loadAllCommentsLegacy(page, opts = {}) {
436 |   if (!EXPAND_COMMENTS) return;
437 | 
438 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
439 | 
440 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
441 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
442 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
443 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
444 | 
445 |   console.log("[FB][load] start", { expected });
446 | 
447 |   function uniqAnchorCountEval() {
448 |     return page.evaluate(() => {
449 |       const as = Array.from(
450 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
451 |       );
452 |       const ids = new Set();
453 |       for (const a of as) {
454 |         const href = a.getAttribute("href") || "";
455 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
456 |         if (m && m[1]) ids.add(m[1]);
457 |       }
458 |       return ids.size;
459 |     });
460 |   }
461 | 
462 |   function commentNodesCountEval() {
463 |     return page.evaluate(() => {
464 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
465 |       return nodes ? nodes.length : 0;
466 |     });
467 |   }
468 | 
469 |   function hasMoreButtonsEval() {
470 |     return page.evaluate(() => {
471 |       const norm = (s) =>
472 |         String(s || "")
473 |           .replace(/\u00a0/g, " ")
474 |           .replace(/\s+/g, " ")
475 |           .trim()
476 |           .toLowerCase();
477 | 
478 |       const btns = Array.from(
479 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
480 |       );
481 |       return btns.some((b) => {
482 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
483 |         return (
484 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
485 |           t.includes("zobacz wiƒôcej komentarzy") ||
486 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
487 |           t.includes("more comments") ||
488 |           t.includes("view more comments") ||
489 |           t.includes("view previous comments") ||
490 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
491 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
492 |           t.includes("more replies") ||
493 |           t.includes("view more replies")
494 |         );
495 |       });
496 |     });
497 |   }
498 | 
499 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
500 |   let nodes = await commentNodesCountEval().catch(() => 0);
501 | 
502 |   let stable = 0;
503 |   let noProgress = 0;
504 | 
505 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
506 |     let clicks = 0;
507 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
508 |       const did = await clickOneExpandButton(page).catch(() => false);
509 |       if (!did) break;
510 |       clicks++;
511 |       await sleepRandom(250, 450);
512 |     }
513 | 
514 |     await scrollPost(page, 220).catch(() => {});
515 |     await sleepRandom(400, 700);
516 | 
517 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
518 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
519 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
520 | 
521 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
522 | 
523 |     if (progressed) {
524 |       anchors = nextAnchors;
525 |       nodes = nextNodes;
526 |       stable = 0;
527 |       noProgress = 0;
528 |     } else {
529 |       stable++;
530 |       noProgress++;
531 |     }
532 | 
533 |     console.log(
534 |       `[FB][load] round ${round}: anchors ${anchors} -> ${nextAnchors}, nodes ${nodes} -> ${nextNodes}, clicks=${clicks}, stable=${stable}/${STABLE_ROUNDS}, moreBtns=${moreBtns}, noProgress=${noProgress}/${MAX_NO_PROGRESS}`
535 |     );
536 | 
537 |     const stableEnough = stable >= STABLE_ROUNDS;
538 | 
539 |     if (!moreBtns && stableEnough) {
540 |       console.log("[FB][load] stop: no more buttons + stable");
541 |       break;
542 |     }
543 | 
544 |     const reachedExpected =
545 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
546 |     if (reachedExpected && stableEnough && !moreBtns) {
547 |       console.log("[FB][load] stop: expected reached (by nodes) + stable + no more buttons");
548 |       break;
549 |     }
550 | 
551 |     if (stableEnough && moreBtns) {
552 |       console.log("[FB][load] rescue: stable but still buttons -> deep scroll + wait");
553 |       await scrollPost(page, 520).catch(() => {});
554 |       await sleepRandom(1000, 1600);
555 |       stable = 0;
556 |       continue;
557 |     }
558 | 
559 |     if (noProgress >= MAX_NO_PROGRESS) {
560 |       if (moreBtns) {
561 |         console.log("[FB][load] last-rescue: no-progress but still buttons -> deep scroll + wait");
562 |         await scrollPost(page, 650).catch(() => {});
563 |         await sleepRandom(1400, 1900);
564 |         stable = 0;
565 |         noProgress = 0;
566 |         continue;
567 |       }
568 | 
569 |       console.log("[FB][load] stop: too many no-progress rounds");
570 |       break;
571 |     }
572 | 
573 |     anchors = nextAnchors;
574 |     nodes = nextNodes;
575 |   }
576 | 
577 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
578 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
579 |   console.log("[FB][load] done:", { anchors: finalAnchors, nodes: finalNodes });
580 | }
581 | 
582 | /* ============================================================
583 |    ===================  PUBLIC API (ROUTED)  ===================
584 |    ============================================================ */
585 | 
586 | export async function prepare(page, url) {
587 |   const ui = pickUiHandler(url);
588 |   if (ui?.prepare) {
589 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} prepare`);
590 |     return ui.prepare(page, url);
591 |   }
592 |   console.log("[FB][router] UI -> legacy prepare");
593 |   return prepareLegacy(page, url);
594 | }
595 | 
596 | export async function getCommentCount(page, url) {
597 |   const ui = pickUiHandler(url || page.url());
598 |   if (ui?.getCommentCount) {
599 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} getCommentCount`);
600 |     return ui.getCommentCount(page, url);
601 |   }
602 |   console.log("[FB][router] UI -> legacy getCommentCount");
603 |   return getCommentCountLegacy(page);
604 | }
605 | 
606 | export async function loadAllComments(page, opts = {}, url = null) {
607 |   if (!EXPAND_COMMENTS) return;
608 | 
609 |   const finalUrl = url || page.url();
610 |   const ui = pickUiHandler(finalUrl);
611 | 
612 |   if (ui?.loadAllComments) {
613 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} loadAllComments`);
614 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal });
615 |   }
616 | 
617 |   console.log("[FB][router] UI -> legacy loadAllComments");
618 |   return loadAllCommentsLegacy(page, opts);
619 | }
620 | 
621 | export async function extractCommentsData(page, url = null) {
622 |   const finalUrl = url || page.url();
623 |   const ui = pickUiHandler(finalUrl);
624 | 
625 |   if (ui?.extractComments) {
626 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} extractComments`);
627 |     const out = await ui.extractComments(page, finalUrl);
628 |     return Array.isArray(out) ? out : [];
629 |   }
630 | 
631 |   const out = await extractCommentsFromDOM(page);
632 |   return Array.isArray(out) ? out : [];
633 | }
634 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments.legacy.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
   1 | // src/fb/comments.js
   2 | // src/fb/legacy/comments.legacy.js
   3 | import { EXPAND_COMMENTS } from "../../config.js";
   4 | import { sleepRandom } from "../../utils/sleep.js";
   5 | import { safeGoto } from "../../utils/navigation.js";
   6 | 
   7 | import { scrollPost } from "../scroll.js";
   8 | import { acceptCookies, saveCookies } from "../cookies.js";
   9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  10 | import { clickOneExpandButton } from "../expandButtons.js";
  11 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  12 | 
  13 | 
  14 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
  15 |   ? Number(process.env.NAV_TIMEOUT_MS)
  16 |   : 90000; // by≈Ço 60000, podbijamy do 90s
  17 | 
  18 | let firstPostPauseDone = false;
  19 | /* ============================================================
  20 |    =======  PRZE≈ÅƒÑCZANIE FILTRA ‚ÄûWSZYSTKIE KOMENTARZE‚Äù  ========
  21 |    ============================================================ */
  22 | 
  23 | async function switchCommentsFilterToAll(page) {
  24 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
  25 | 
  26 |   // 1) je≈õli menu ju≈º jest otwarte ‚Äì nie klikamy ponownie, tylko pr√≥bujemy wybraƒá opcjƒô "Wszystkie komentarze" z istniejƒÖcego menu
  27 |   const menuAlreadyOpen = await page.evaluate(() => {
  28 |     return !!document.querySelector("div[role='menu']");
  29 |   });
  30 | 
  31 |   if (menuAlreadyOpen) {
  32 |     console.log("[FB][filter] Menu filtra ju≈º otwarte ‚Äì pr√≥bujƒô wybraƒá opcjƒô.");
  33 | 
  34 |     const menuResult = await clickAllCommentsInMenu(page);
  35 |     if (menuResult.clicked) {
  36 |       console.log("[FB][filter] Wybrano 'Wszystkie komentarze' z otwartego menu.");
  37 |       return true;
  38 |     }
  39 |     console.log("[FB][filter] Menu otwarte, ale nie ma opcji 'Wszystkie komentarze'.");
  40 |     return false;
  41 |   }
  42 | 
  43 |   // 2) spr√≥buj znale≈∫ƒá bie≈ºƒÖcy przycisk filtra i sprawdziƒá, co jest ustawione
  44 |   const pre = await page.evaluate(() => {
  45 |     const els = Array.from(
  46 |       document.querySelectorAll("div[role='button'], span[role='button']")
  47 |     );
  48 |     let filterEl = null;
  49 |     let labelText = "";
  50 |     for (const el of els) {
  51 |       const t = (el.textContent || "").trim();
  52 |       if (!t) continue;
  53 |       const low = t.toLowerCase();
  54 |       if (
  55 |         low === "najtrafniejsze" ||
  56 |         low === "most relevant" ||
  57 |         low === "wszystkie komentarze" ||
  58 |         low === "all comments"
  59 |       ) {
  60 |         filterEl = el;
  61 |         labelText = low;
  62 |         break;
  63 |       }
  64 |     }
  65 |     if (!filterEl) {
  66 |       return { state: "not-found" };
  67 |     }
  68 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
  69 |       return { state: "already-all" };
  70 |     }
  71 |     filterEl.click();
  72 |     return { state: "clicked-filter" };
  73 |   });
  74 | 
  75 |   if (pre.state === "not-found") {
  76 |     console.log("[FB][filter] Nie znaleziono przycisku filtra komentarzy.");
  77 |     return false;
  78 |   }
  79 |   if (pre.state === "already-all") {
  80 |     console.log("[FB][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' ‚Äì pomijam.");
  81 |     return true;
  82 |   }
  83 |   if (pre.state === "clicked-filter") {
  84 |     await sleepRandom(400, 800);
  85 |     const menuResult = await clickAllCommentsInMenu(page);
  86 |     if (!menuResult.clicked && menuResult.noMenu) {
  87 |       // fallback: mo≈ºe filtr prze≈ÇƒÖcza siƒô bez menu ‚Äì sprawdzamy label jeszcze raz
  88 |       const afterLabelIsAll = await page.evaluate(() => {
  89 |         const els = Array.from(
  90 |           document.querySelectorAll("div[role='button'], span[role='button']")
  91 |         );
  92 |         const btn = els.find((el) => {
  93 |           const t = (el.textContent || "").trim().toLowerCase();
  94 |           return t === "wszystkie komentarze" || t === "all comments";
  95 |         });
  96 |         return !!btn;
  97 |       });
  98 |       if (afterLabelIsAll) {
  99 |         console.log(
 100 |           "[FB][filter] Po klikniƒôciu filtr prze≈ÇƒÖczy≈Ç siƒô bez menu na 'Wszystkie komentarze'."
 101 |         );
 102 |         return true;
 103 |       }
 104 |       console.log(
 105 |         "[FB][filter] Klikniƒôto filtr, ale nie pojawi≈Ço siƒô menu i label nie jest 'Wszystkie komentarze'."
 106 |       );
 107 |       return false;
 108 |     }
 109 |     if (!menuResult.clicked && !menuResult.noMenu) {
 110 |       console.log("[FB][filter] Menu filtra jest, ale brak opcji 'Wszystkie komentarze'.");
 111 |       return false;
 112 |     }
 113 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze'.");
 114 |     return true;
 115 |   }
 116 |   console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);
 117 |   return false;
 118 | }
 119 | 
 120 | async function clickShowAllCommentsIfPresent(page) {
 121 |   console.log("[FB][show-all] Pr√≥ba klikniƒôcia 'Poka≈º wszystkie' (aria-label)‚Ä¶");
 122 | 
 123 |   try {
 124 |     const clicked = await page.evaluate(() => {
 125 |       // Je≈õli filtr ju≈º jest, to znaczy ≈ºe "Poka≈º wszystkie" zosta≈Ço klikniƒôte / niepotrzebne
 126 |       const bodyText = (document.body.innerText || "").toLowerCase();
 127 |       if (
 128 |         bodyText.includes("najtrafniejsze") ||
 129 |         bodyText.includes("najnowsze") ||
 130 |         bodyText.includes("wszystkie komentarze") ||
 131 |         bodyText.includes("all comments") ||
 132 |         bodyText.includes("ukryj komentarze") ||
 133 |         bodyText.includes("hide comments")
 134 |       ) {
 135 |         return false;
 136 |       }
 137 |       const selectors = [
 138 |         "div[aria-label='Poka≈º wszystkie'][role='button']",
 139 |         "div[aria-label='Wy≈õwietl wszystkie'][role='button']",
 140 |         "div[aria-label='Show all'][role='button']",
 141 |         "div[aria-label='View all'][role='button']",
 142 |       ];
 143 |       let el = null;
 144 |       for (const sel of selectors) {
 145 |         el = document.querySelector(sel);
 146 |         if (el) break;
 147 |       }
 148 |       if (!el) return false;
 149 |       try {
 150 |         el.scrollIntoView({ block: "center", inline: "nearest" });
 151 |       } catch (e) {
 152 |         // scrollIntoView nie musi siƒô udaƒá
 153 |       }
 154 |       if (typeof el.click === "function") {
 155 |         el.click();
 156 |         return true;
 157 |       }
 158 |       return false;
 159 |     });
 160 |     if (!clicked) {
 161 |       console.log(
 162 |         "[FB][show-all] Nie znaleziono aria-label='Poka≈º wszystkie' albo filtr ju≈º widoczny ‚Äì pomijam."
 163 |       );
 164 |       return false;
 165 |     }
 166 |     console.log("[FB][show-all] Klikniƒôto 'Poka≈º wszystkie' (aria-label).");
 167 |     await sleepRandom(900, 1600);
 168 |     return true;
 169 |   } catch (err) {
 170 |     console.log(
 171 |       "[FB][show-all] B≈ÇƒÖd podczas klikania 'Poka≈º wszystkie':",
 172 |       err?.message || err
 173 |     );
 174 |     return false;
 175 |   }
 176 | }
 177 | import fs from 'fs';
 178 | 
 179 | async function extractCommentsFromDOM(page) {
 180 |   const data = await page.evaluate(() => {
 181 |     function extractCommentId(url) {
 182 |       const match = url?.match(/comment_id=([^&]+)/);
 183 |       return match ? decodeURIComponent(match[1]) : null;
 184 |     }
 185 | 
 186 |     // Mapa commentId -> time
 187 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 188 |     const idToTimeMap = {};
 189 | 
 190 |     for (let i = 0; i < allLinks.length; i++) {
 191 |       const link = allLinks[i];
 192 |       const href = link.getAttribute('href') || '';
 193 |       const id = extractCommentId(href);
 194 | 
 195 |       if (id) {
 196 |         // Szukamy nastƒôpnego linka z tekstem typu "1 godz.", "2 dni" itd.
 197 |         for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
 198 |           const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
 199 |           if (timeText && /^\d+\s?(min|godz|sek|dni|tyg)/.test(timeText)) {
 200 |             idToTimeMap[id] = timeText;
 201 |             break;
 202 |           }
 203 |         }
 204 |       }
 205 |     }
 206 | 
 207 |     const commentNodes = Array.from(
 208 |       document.querySelectorAll('div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k')
 209 |     );
 210 | 
 211 |     const extracted = commentNodes.map((node) => {
 212 |       try {
 213 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim();
 214 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim();
 215 |         const linkEl = node.querySelector('a[role="link"]');
 216 |         const href = linkEl?.getAttribute('href');
 217 |         const permalink = href?.startsWith('http') ? href : `https://www.facebook.com${href}`;
 218 |         const id = extractCommentId(permalink) || null;
 219 | 
 220 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
 221 | 
 222 |         if (!author || !text) return null;
 223 | 
 224 |         return { id, author, text, permalink, time };
 225 |       } catch (err) {
 226 |         return null;
 227 |       }
 228 |     }).filter(Boolean);
 229 | 
 230 |     return extracted;
 231 |   });
 232 | 
 233 |   console.log('[FB] extractCommentsFromDOM ‚Äì wyciƒÖgniƒôto komentarzy:', data.length);
 234 |   console.log('[DBG] Komentarze:', JSON.stringify(data, null, 2));
 235 | 
 236 |   return data;
 237 | }
 238 | 
 239 | 
 240 | 
 241 | 
 242 | /* ============================================================
 243 |    =========== POST ROOT (DIALOG / MAIN / FALLBACK) ============
 244 |    ============================================================ */
 245 | 
 246 | async function clickAllCommentsInMenu(page) {
 247 |   const result = await page.evaluate(() => {
 248 |     const menu =
 249 |       document.querySelector("div[role='menu']") ||
 250 |       document.querySelector("div[role='dialog']");
 251 |     if (!menu) {
 252 |       return { clicked: false, noMenu: true };
 253 |     }
 254 |     const items = Array.from(
 255 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 256 |     );
 257 |     const opt = items.find((el) => {
 258 |       const t = (el.textContent || "").trim().toLowerCase();
 259 |       return (
 260 |         t.startsWith("wszystkie komentarze") ||
 261 |         t.startsWith("all comments")
 262 |       );
 263 |     });
 264 |     if (!opt) {
 265 |       return { clicked: false, noMenu: false };
 266 |     }
 267 |     opt.click();
 268 |     setTimeout(() => {
 269 |       try {
 270 |         document.body.click();
 271 |       } catch {}
 272 |     }, 50);
 273 |     return { clicked: true, noMenu: false };
 274 |   });
 275 |   if (result.clicked) {
 276 |     await sleepRandom(300, 600);
 277 |     await page
 278 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 279 |         timeout: 2000,
 280 |       })
 281 |       .catch(() => {});
 282 |   }
 283 |   return result;
 284 | }
 285 | 
 286 | /* ============================================================
 287 |    ===== POMOCNICZE: LICZENIE ID KOMENTARZY ====================
 288 |    ============================================================ */
 289 | 
 290 | function postRootScript() {
 291 |   return `
 292 |     function getPostRoot() {
 293 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 294 |       const postDialog = dialogs.find((dlg) => {
 295 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 296 |         if (!text) return false;
 297 |         const hasCommentWord =
 298 |           text.includes("komentarz") || text.includes("comment");
 299 |         const hasActions =
 300 |           text.includes("lubiƒô to") ||
 301 |           text.includes("komentarz") ||
 302 |           text.includes("udostƒôpnij") ||
 303 |           text.includes("napisz komentarz") ||
 304 |           text.includes("comment");
 305 |         const looksLikeNotifications =
 306 |           text.startsWith("powiadomienia") &&
 307 |           text.includes("wszystkie") &&
 308 |           text.includes("nieprzeczytane");
 309 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 310 |       });
 311 |       if (postDialog) return postDialog;
 312 |       const main = document.querySelector("div[role='main']");
 313 |       if (main) {
 314 |         const article = main.querySelector("article");
 315 |         return article || main;
 316 |       }
 317 |       return document.body;
 318 |     }
 319 |   `;
 320 | }
 321 | 
 322 | async function getCurrentCommentAnchorCount(page) {
 323 |   const count = await page.evaluate(() => {
 324 |     const anchors = Array.from(
 325 |       document.querySelectorAll(
 326 |         "a[href*='comment_id'], a[href*='reply_comment_id']"
 327 |       )
 328 |     );
 329 |     const ids = new Set();
 330 |     for (const a of anchors) {
 331 |       try {
 332 |         const url = new URL(a.href);
 333 |         const cid = url.searchParams.get("comment_id");
 334 |         const rid = url.searchParams.get("reply_comment_id");
 335 |         let raw = rid || cid;
 336 |         if (!raw) continue;
 337 |         if (!/^\d+$/.test(raw)) {
 338 |           try {
 339 |             const dec = atob(raw);
 340 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 341 |             if (m) raw = m[2];
 342 |           } catch {}
 343 |         }
 344 |         if (raw) ids.add(raw);
 345 |       } catch {}
 346 |     }
 347 |     return ids.size;
 348 |   });
 349 |   return count || 0;
 350 | }
 351 | 
 352 | /* ============================================================
 353 |    ======= SCROLL W OBRƒòBIE POSTA (DIALOG/MAIN/FALLBACK) =======
 354 |    ============================================================ */
 355 | 
 356 | async function scrollWithinPost(page, label, factor = 0.3) {
 357 |   const info = await page.evaluate(
 358 |     (factorArg, labelArg, postRootCode) => {
 359 |       const href = location.href;
 360 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 361 |         href
 362 |       );
 363 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 364 |       // wstrzykujemy funkcjƒô getPostRoot
 365 |       // eslint-disable-next-line no-eval
 366 |       eval(postRootCode);
 367 |       // @ts-ignore
 368 |       const rootFn =
 369 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 370 |       function pushIfScrollable(list, el, labelName) {
 371 |         if (!el) return;
 372 |         const style = window.getComputedStyle(el);
 373 |         if (!style) return;
 374 |         const oy = style.overflowY;
 375 |         const clientH = el.clientHeight || 0;
 376 |         const scrollH = el.scrollHeight || 0;
 377 |         const delta = scrollH - clientH;
 378 |         if (
 379 |           clientH > 0 &&
 380 |           delta > 10 &&
 381 |           (oy === "auto" ||
 382 |             oy === "scroll" ||
 383 |             oy === "overlay" ||
 384 |             oy === "hidden")
 385 |         ) {
 386 |           list.push({ el, label: labelName, delta });
 387 |         }
 388 |       }
 389 |       let container = null;
 390 |       let containerType = null;
 391 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 392 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 393 |       if (cached) {
 394 |         container = cached;
 395 |         containerType = "cached-comments";
 396 |       }
 397 |       // ===== PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy "oficjalny" panel komentarzy =====
 398 |       if (!container && (isPhotoView || isVideoView)) {
 399 |         const moreCommentsBtn = Array.from(
 400 |           document.querySelectorAll(
 401 |             "button, div[role='button'], span[role='button']"
 402 |           )
 403 |         ).find((el) => {
 404 |           const t = (el.textContent || "").toLowerCase();
 405 |           return (
 406 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 407 |             t.includes("zobacz wiƒôcej komentarzy") ||
 408 |             t.includes("view more comments") ||
 409 |             t.includes("view previous comments")
 410 |           );
 411 |         });
 412 |         if (moreCommentsBtn) {
 413 |           let p = moreCommentsBtn.parentElement;
 414 |           while (p && p !== document.body && p !== document.documentElement) {
 415 |             const style = window.getComputedStyle(p);
 416 |             const oy = style.overflowY;
 417 |             const ch = p.clientHeight || 0;
 418 |             const sh = p.scrollHeight || 0;
 419 |             const delta = sh - ch;
 420 |             if (
 421 |               ch > 0 &&
 422 |               delta > 10 &&
 423 |               (oy === "auto" ||
 424 |                 oy === "scroll" ||
 425 |                 oy === "overlay" ||
 426 |                 oy === "hidden")
 427 |             ) {
 428 |               container = p;
 429 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 430 |               break;
 431 |             }
 432 |             p = p.parentElement;
 433 |           }
 434 |         }
 435 |         // VIDEO ‚Äì dodatkowa pr√≥ba: po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 436 |         if (!container && isVideoView) {
 437 |           const commentsHeader = Array.from(
 438 |             document.querySelectorAll("div, span")
 439 |           ).find((el) => {
 440 |             const t = (el.textContent || "").toLowerCase();
 441 |             return (
 442 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 443 |               (t.includes("comments") && t.includes("most relevant")) ||
 444 |               t.trim() === "komentarze" ||
 445 |               t.trim() === "comments"
 446 |             );
 447 |           });
 448 |           if (commentsHeader) {
 449 |             let p = commentsHeader.parentElement;
 450 |             while (p && p !== document.body && p !== document.documentElement) {
 451 |               const style = window.getComputedStyle(p);
 452 |               const oy = style.overflowY;
 453 |               const ch = p.clientHeight || 0;
 454 |               const sh = p.scrollHeight || 0;
 455 |               const delta = sh - ch;
 456 |               if (
 457 |                 ch > 0 &&
 458 |                 delta > 10 &&
 459 |                 (oy === "auto" ||
 460 |                   oy === "scroll" ||
 461 |                   oy === "overlay" ||
 462 |                   oy === "hidden")
 463 |               ) {
 464 |                 container = p;
 465 |                 containerType = "video-comments-header";
 466 |                 break;
 467 |               }
 468 |               p = p.parentElement;
 469 |             }
 470 |           }
 471 |         }
 472 |         // dodatkowy fallback na VIDEO ‚Äì po polu "Napisz komentarz..."
 473 |         if (!container && isVideoView) {
 474 |           const commentBox = Array.from(
 475 |             document.querySelectorAll("div[role='textbox'], textarea")
 476 |           ).find((el) => {
 477 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 478 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 479 |             const txt = (el.textContent || "").toLowerCase();
 480 |             const needles = [
 481 |               "napisz komentarz",
 482 |               "write a comment",
 483 |               "escribe un comentario",
 484 |               "schreibe einen kommentar",
 485 |             ];
 486 |             return needles.some((n) =>
 487 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 488 |             );
 489 |           });
 490 |           if (commentBox) {
 491 |             let p = commentBox.parentElement;
 492 |             while (p && p !== document.body && p !== document.documentElement) {
 493 |               const style = window.getComputedStyle(p);
 494 |               const oy = style.overflowY;
 495 |               const ch = p.clientHeight || 0;
 496 |               const sh = p.scrollHeight || 0;
 497 |               const delta = sh - ch;
 498 |               if (
 499 |                 ch > 0 &&
 500 |                 delta > 10 &&
 501 |                 (oy === "auto" ||
 502 |                   oy === "scroll" ||
 503 |                   oy === "overlay" ||
 504 |                   oy === "hidden")
 505 |               ) {
 506 |                 container = p;
 507 |                 containerType = "video-comments-textbox";
 508 |                 break;
 509 |               }
 510 |               p = p.parentElement;
 511 |             }
 512 |           }
 513 |         }
 514 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì nie ruszamy okna
 515 |         if (isVideoView && !container) {
 516 |           const cur = window.scrollY || 0;
 517 |           return {
 518 |             before: cur,
 519 |             after: cur,
 520 |             container: "video-no-scroll",
 521 |             label: labelArg,
 522 |           };
 523 |         }
 524 |       }
 525 |       // ===== Standardowa heurystyka (permalink / photo fallback) =====
 526 |       if (!container) {
 527 |         const root = rootFn() || document.body;
 528 |         const candidates = [];
 529 |         pushIfScrollable(candidates, root, "root");
 530 |         const dialog =
 531 |           root.closest("div[role='dialog']") ||
 532 |           document.querySelector("div[role='dialog']");
 533 |         if (dialog) {
 534 |           pushIfScrollable(candidates, dialog, "dialog");
 535 |         }
 536 |         const scope = dialog || root;
 537 |         const blocks = Array.from(
 538 |           scope.querySelectorAll("div, section, main, article")
 539 |         );
 540 |         for (const el of blocks) {
 541 |           pushIfScrollable(candidates, el, "auto");
 542 |         }
 543 |         let best = null;
 544 |         for (const c of candidates) {
 545 |           if (!best || c.delta > best.delta) best = c;
 546 |         }
 547 |         if (best) {
 548 |           container = best.el;
 549 |           containerType = best.label;
 550 |         } else {
 551 |           container =
 552 |             document.scrollingElement ||
 553 |             document.documentElement ||
 554 |             document.body;
 555 |           const delta =
 556 |             (container.scrollHeight || 0) - (container.clientHeight || 0);
 557 |           if (delta <= 0) {
 558 |             const cur = container.scrollTop || window.scrollY || 0;
 559 |             return {
 560 |               before: cur,
 561 |               after: cur,
 562 |               container: "window-no-scroll",
 563 |               label: labelArg,
 564 |             };
 565 |           }
 566 |           containerType = "window";
 567 |         }
 568 |       }
 569 |       // Zapamiƒôtujemy kontener komentarzy (≈ºeby kolejne wywo≈Çania go u≈ºy≈Çy)
 570 |       if (container) {
 571 |         const isRootContainer =
 572 |           container === document.body ||
 573 |           container === document.documentElement ||
 574 |           container === document.scrollingElement;
 575 |         if (!isRootContainer) {
 576 |           try {
 577 |             container.setAttribute("data-fbwatcher-comments", "1");
 578 |           } catch {}
 579 |         }
 580 |       }
 581 |       const isWindowContainer =
 582 |         container === document.body ||
 583 |         container === document.documentElement ||
 584 |         container === document.scrollingElement;
 585 |       // na watch nie scrollujemy okna, tylko panel komentarzy
 586 |       if (isVideoView && isWindowContainer) {
 587 |         const cur = window.scrollY || 0;
 588 |         return {
 589 |           before: cur,
 590 |           after: cur,
 591 |           container: "video-window-blocked",
 592 |           label: labelArg,
 593 |         };
 594 |       }
 595 |       const before = isWindowContainer
 596 |         ? window.scrollY || 0
 597 |         : container.scrollTop || 0;
 598 |       const maxScroll =
 599 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 600 |       if (maxScroll <= 0) {
 601 |         return {
 602 |           before,
 603 |           after: before,
 604 |           container: (containerType || "unknown") + "-no-scroll",
 605 |           label: labelArg,
 606 |         };
 607 |       }
 608 |       const factor = factorArg || 0.3;
 609 |       const sign = factor < 0 ? -1 : 1;
 610 |       const magnitude = Math.min(Math.abs(factor), 1);
 611 |       const baseStep =
 612 |         (container.clientHeight || window.innerHeight || 600) * magnitude;
 613 |       // na VIDEO robimy mniejszy krok, ≈ºeby nie przeskakiwaƒá przycisk√≥w
 614 |       let step = Math.max(30, Math.min(baseStep, isVideoView ? 180 : 220));
 615 |       let target;
 616 |       if (sign < 0) {
 617 |         target = Math.max(0, before - step);
 618 |       } else {
 619 |         target = Math.min(maxScroll, before + step);
 620 |       }
 621 |       if (isWindowContainer) {
 622 |         window.scrollTo(0, target);
 623 |       } else {
 624 |         container.scrollTop = target;
 625 |       }
 626 |       const after = isWindowContainer
 627 |         ? window.scrollY || 0
 628 |         : container.scrollTop || 0;
 629 |       return {
 630 |         before,
 631 |         after,
 632 |         container: containerType || "unknown",
 633 |         label: labelArg,
 634 |       };
 635 |     },
 636 |     factor,
 637 |     label,
 638 |     postRootScript()
 639 |   );
 640 |   return info;
 641 | }
 642 | 
 643 | /* ============================================================
 644 |    ======= DOCIƒÑGNIƒòCIE DO ABSOLUTNEGO DO≈ÅU KOMENTARZY =========
 645 |    ============================================================ */
 646 | 
 647 | async function scrollToAbsoluteBottom(page, label = "bottom") {
 648 |   const info = await page.evaluate(
 649 |     (labelArg, postRootCode) => {
 650 |       const href = location.href;
 651 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 652 |         href
 653 |       );
 654 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 655 |       // wstrzykujemy funkcjƒô getPostRoot
 656 |       // eslint-disable-next-line no-eval
 657 |       eval(postRootCode);
 658 |       // @ts-ignore
 659 |       const rootFn =
 660 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 661 |       function pushIfScrollable(list, el, labelName) {
 662 |         if (!el) return;
 663 |         const style = window.getComputedStyle(el);
 664 |         if (!style) return;
 665 |         const oy = style.overflowY;
 666 |         const clientH = el.clientHeight || 0;
 667 |         const scrollH = el.scrollHeight || 0;
 668 |         const delta = scrollH - clientH;
 669 |         if (
 670 |           clientH > 0 &&
 671 |           delta > 10 &&
 672 |           (oy === "auto" ||
 673 |             oy === "scroll" ||
 674 |             oy === "overlay" ||
 675 |             oy === "hidden")
 676 |         ) {
 677 |           list.push({ el, label: labelName, delta });
 678 |         }
 679 |       }
 680 |       let container = null;
 681 |       let containerType = null;
 682 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 683 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 684 |       if (cached) {
 685 |         container = cached;
 686 |         containerType = "cached-comments";
 687 |       }
 688 |       // PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy znale≈∫ƒá panel komentarzy
 689 |       if (!container && (isPhotoView || isVideoView)) {
 690 |         const moreCommentsBtn = Array.from(
 691 |           document.querySelectorAll(
 692 |             "button, div[role='button'], span[role='button']"
 693 |           )
 694 |         ).find((el) => {
 695 |           const t = (el.textContent || "").toLowerCase();
 696 |           return (
 697 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 698 |             t.includes("zobacz wiƒôcej komentarzy") ||
 699 |             t.includes("view more comments") ||
 700 |             t.includes("view previous comments")
 701 |           );
 702 |         });
 703 |         if (moreCommentsBtn) {
 704 |           let p = moreCommentsBtn.parentElement;
 705 |           while (p && p !== document.body && p !== document.documentElement) {
 706 |             const style = window.getComputedStyle(p);
 707 |             const oy = style.overflowY;
 708 |             const ch = p.clientHeight || 0;
 709 |             const sh = p.scrollHeight || 0;
 710 |             const delta = sh - ch;
 711 |             if (
 712 |               ch > 0 &&
 713 |               delta > 10 &&
 714 |               (oy === "auto" || oy === "scroll" || oy === "overlay" || oy === "hidden")
 715 |             ) {
 716 |               container = p;
 717 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 718 |               break;
 719 |             }
 720 |             p = p.parentElement;
 721 |           }
 722 |         }
 723 |         // dodatkowa pr√≥ba po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 724 |         if (!container && isVideoView) {
 725 |           const commentsHeader = Array.from(
 726 |             document.querySelectorAll("div, span")
 727 |           ).find((el) => {
 728 |             const t = (el.textContent || "").toLowerCase();
 729 |             return (
 730 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 731 |               (t.includes("comments") && t.includes("most relevant")) ||
 732 |               t.trim() === "komentarze" ||
 733 |               t.trim() === "comments"
 734 |             );
 735 |           });
 736 |           if (commentsHeader) {
 737 |             let p = commentsHeader.parentElement;
 738 |             while (p && p !== document.body && p !== document.documentElement) {
 739 |               const style = window.getComputedStyle(p);
 740 |               const oy = style.overflowY;
 741 |               const ch = p.clientHeight || 0;
 742 |               const sh = p.scrollHeight || 0;
 743 |               const delta = sh - ch;
 744 |               if (
 745 |                 ch > 0 &&
 746 |                 delta > 10 &&
 747 |                 (oy === "auto" ||
 748 |                   oy === "scroll" ||
 749 |                   oy === "overlay" ||
 750 |                   oy === "hidden")
 751 |               ) {
 752 |                 container = p;
 753 |                 containerType = "video-comments-header";
 754 |                 break;
 755 |               }
 756 |               p = p.parentElement;
 757 |             }
 758 |           }
 759 |         }
 760 |         // NOWY FALLBACK ‚Äì po polu "Napisz komentarz..."
 761 |         if (!container) {
 762 |           const commentBox = Array.from(
 763 |             document.querySelectorAll("div[role='textbox'], textarea")
 764 |           ).find((el) => {
 765 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 766 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 767 |             const txt = (el.textContent || "").toLowerCase();
 768 |             const needles = [
 769 |               "napisz komentarz",
 770 |               "write a comment",
 771 |               "escribe un comentario",
 772 |               "schreibe einen kommentar",
 773 |             ];
 774 |             return needles.some((n) =>
 775 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 776 |             );
 777 |           });
 778 |           if (commentBox) {
 779 |             let p = commentBox.parentElement;
 780 |             while (p && p !== document.body && p !== document.documentElement) {
 781 |               const style = window.getComputedStyle(p);
 782 |               const oy = style.overflowY;
 783 |               const ch = p.clientHeight || 0;
 784 |               const sh = p.scrollHeight || 0;
 785 |               const delta = sh - ch;
 786 |               if (
 787 |                 ch > 0 &&
 788 |                 delta > 10 &&
 789 |                 (oy === "auto" ||
 790 |                   oy === "scroll" ||
 791 |                   oy === "overlay" ||
 792 |                   oy === "hidden")
 793 |               ) {
 794 |                 container = p;
 795 |                 containerType = isPhotoView
 796 |                   ? "photo-comments-textbox"
 797 |                   : "video-comments-textbox";
 798 |                 break;
 799 |               }
 800 |               p = p.parentElement;
 801 |             }
 802 |           }
 803 |         }
 804 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì dajemy spok√≥j
 805 |         if (isVideoView && !container) {
 806 |           const cur = window.scrollY || 0;
 807 |           return {
 808 |             label: labelArg,
 809 |             container: "video-no-scroll",
 810 |             steps: 0,
 811 |             final: cur,
 812 |             maxScroll: 0,
 813 |             atBottom: true,
 814 |           };
 815 |         }
 816 |       }
 817 |       // Standardowa heurystyka (permalink / photo fallback)
 818 |       if (!container) {
 819 |         const root = rootFn() || document.body;
 820 |         const candidates = [];
 821 |         pushIfScrollable(candidates, root, "root");
 822 |         const dialog =
 823 |           root.closest("div[role='dialog']") ||
 824 |           document.querySelector("div[role='dialog']");
 825 |         if (dialog) {
 826 |           pushIfScrollable(candidates, dialog, "dialog");
 827 |         }
 828 |         const scope = dialog || root;
 829 |         const blocks = Array.from(
 830 |           scope.querySelectorAll("div, section, main, article")
 831 |         );
 832 |         for (const el of blocks) {
 833 |           pushIfScrollable(candidates, el, "auto");
 834 |         }
 835 |         let best = null;
 836 |         for (const c of candidates) {
 837 |           if (!best || c.delta > best.delta) {
 838 |             best = c;
 839 |           }
 840 |         }
 841 |         if (best) {
 842 |           container = best.el;
 843 |           containerType = best.label;
 844 |         } else {
 845 |           container =
 846 |             document.scrollingElement ||
 847 |             document.documentElement ||
 848 |             document.body;
 849 |           containerType = "window";
 850 |         }
 851 |       }
 852 |       // Zapamiƒôtaj kontener komentarzy (je≈õli to nie jest globalne okno)
 853 |       if (container) {
 854 |         const isRootContainer =
 855 |           container === document.body ||
 856 |           container === document.documentElement ||
 857 |           container === document.scrollingElement;
 858 |         if (!isRootContainer) {
 859 |           try {
 860 |             container.setAttribute("data-fbwatcher-comments", "1");
 861 |           } catch {}
 862 |         }
 863 |       }
 864 |       const isWindowContainer =
 865 |         container === document.body ||
 866 |         container === document.documentElement ||
 867 |         container === document.scrollingElement;
 868 |       // na watch nie ruszamy globalnego scrolla je≈õli nie mamy innego kontenera
 869 |       if (isVideoView && isWindowContainer) {
 870 |         const cur = window.scrollY || 0;
 871 |         return {
 872 |           label: labelArg,
 873 |           container: "video-window-blocked",
 874 |           steps: 0,
 875 |           final: cur,
 876 |           maxScroll: 0,
 877 |           atBottom: true,
 878 |         };
 879 |       }
 880 |       let steps = 0;
 881 |       const maxSteps = 160;
 882 |       let lastPos = isWindowContainer
 883 |         ? window.scrollY || 0
 884 |         : container.scrollTop || 0;
 885 |       while (steps < maxSteps) {
 886 |         steps++;
 887 |         const maxScroll =
 888 |           (container.scrollHeight || 0) - (container.clientHeight || 0);
 889 |         const pos = isWindowContainer
 890 |           ? window.scrollY || 0
 891 |           : container.scrollTop || 0;
 892 |         // ju≈º na dole
 893 |         if (maxScroll <= 0 || pos >= maxScroll - 2) {
 894 |           return {
 895 |             label: labelArg,
 896 |             container: containerType || "unknown",
 897 |             steps,
 898 |             final: pos,
 899 |             maxScroll,
 900 |             atBottom: true,
 901 |           };
 902 |         }
 903 |         const baseStep =
 904 |           (container.clientHeight || window.innerHeight || 600) * 0.9;
 905 |         const step = Math.max(60, Math.min(baseStep, maxScroll - pos));
 906 |         if (isWindowContainer) {
 907 |           window.scrollTo(0, pos + step);
 908 |         } else {
 909 |           container.scrollTop = pos + step;
 910 |         }
 911 |         const afterPos = isWindowContainer
 912 |           ? window.scrollY || 0
 913 |           : container.scrollTop || 0;
 914 |         // brak ruchu mimo pr√≥by ‚Äì uznajemy ≈ºe jeste≈õmy na dole
 915 |         if (afterPos === lastPos) {
 916 |           return {
 917 |             label: labelArg,
 918 |             container: containerType || "unknown",
 919 |             steps,
 920 |             final: afterPos,
 921 |             maxScroll,
 922 |             atBottom: true,
 923 |           };
 924 |         }
 925 |         lastPos = afterPos;
 926 |       }
 927 |       const maxScrollFinal =
 928 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 929 |       const finalPos = isWindowContainer
 930 |         ? window.scrollY || 0
 931 |         : container.scrollTop || 0;
 932 |       return {
 933 |         label: labelArg,
 934 |         container: containerType || "unknown",
 935 |         steps,
 936 |         final: finalPos,
 937 |         maxScroll: maxScrollFinal,
 938 |         atBottom: finalPos >= maxScrollFinal - 2,
 939 |       };
 940 |     },
 941 |     label,
 942 |     postRootScript()
 943 |   );
 944 |   return info;
 945 | }
 946 | 
 947 | /* ============================================================
 948 |    ===================== VIDEO ‚Äì AUTO PAUSE ====================
 949 |    ============================================================ */
 950 | 
 951 | async function pauseVideoIfAny(page) {
 952 |   try {
 953 |     await page.evaluate(() => {
 954 |       const vids = Array.from(document.querySelectorAll("video"));
 955 |       for (const v of vids) {
 956 |         try {
 957 |           v.autoplay = false;
 958 |           v.removeAttribute("autoplay");
 959 |           v.muted = true;
 960 |           v.pause();
 961 |           if (!isNaN(v.currentTime) && v.currentTime === 0) {
 962 |             v.currentTime = 0.01;
 963 |           }
 964 |         } catch (e) {}
 965 |       }
 966 |     });
 967 |     console.log("[FB] Video pause: zatrzymano wszystkie <video>.");
 968 |   } catch (e) {
 969 |     console.log("[FB] Video pause ‚Äì b≈ÇƒÖd:", e?.message || e);
 970 |   }
 971 | }
 972 | 
 973 | /* ============================================================
 974 |    ======= BRUTALNA DO≈ªYNKA ‚Äì LOAD MORE NA DOLE ================
 975 |    ============================================================ */
 976 | 
 977 | async function clickAllLoadMoreAtBottom(page, view, maxClicks = 300) {
 978 |   // Brutalna do≈ºynka na dole ‚Äì bez scrolla, tylko to, co widaƒá
 979 |   return await page.evaluate(({ isVideo, max }) => {
 980 |     function normalize(text) {
 981 |       return (text || "").toLowerCase().replace(/\s+/g, " ").trim();
 982 |     }
 983 |     function findCommentsRoot() {
 984 |       // Dla watch/reel FB czƒôsto siedzi w g≈Ç√≥wnej kolumnie
 985 |       const main = document.querySelector("div[role='main']");
 986 |       if (!main) return document.body;
 987 |       const article = main.querySelector("article");
 988 |       if (article) return article;
 989 |       return main;
 990 |     }
 991 |     const root = findCommentsRoot();
 992 |     if (!root) return 0;
 993 |     let clicks = 0;
 994 |     for (let i = 0; i < max; i++) {
 995 |       const candidates = Array.from(
 996 |         root.querySelectorAll(
 997 |           "button,div[role='button'],span[role='button'],a[role='button']"
 998 |         )
 999 |       );
1000 |       const btn = candidates.find((el) => {
1001 |         const t = normalize(el.textContent);
1002 |         if (!t) return false;
1003 |         if (t.startsWith("wy≈õwietl wiƒôcej komentarzy")) return true;
1004 |         if (t === "poka≈º wiƒôcej odpowiedzi") return true;
1005 |         if (/^wy≈õwietl wszystkie \d+ odpowiedzi$/.test(t)) return true;
1006 |         if (t === "wy≈õwietl 1 odpowied≈∫") return true;
1007 |         if (/odpowiedzi$/.test(t) && /odpowiedzi/.test(t) && t.includes("odpowiedzia≈Ç")) {
1008 |           return true;
1009 |         }
1010 |         return false;
1011 |       });
1012 |       if (!btn) break;
1013 |       const rect = btn.getBoundingClientRect();
1014 |       if (rect.bottom < 0 || rect.top > window.innerHeight) break;
1015 |       btn.click();
1016 |       clicks++;
1017 |     }
1018 |     return clicks;
1019 |   }, { isVideo: !!view.isVideo, max: maxClicks });
1020 | }
1021 | 
1022 | /* ============================================================
1023 |    ======= AGRESYWNE DO≈ÅADOWANIE WSZYSTKICH KOMENTARZY =========
1024 |    ============================================================ */
1025 | 
1026 | async function ensureAllCommentsLoaded(page, expectedTotal = null) {
1027 |   // expectedTotal tylko do log√≥w ‚Äì NIE jest twardym warunkiem stopu
1028 |   const hasTarget = typeof expectedTotal === "number" && expectedTotal > 0;
1029 |   const view = await page.evaluate(() => {
1030 |     const href = location.href;
1031 |     const isWatch = href.includes("/watch/");
1032 |     const isVideo = isWatch || /\/watch\/|\/videos\/|[\?&]v=/i.test(href); // üëà dodane /videos/
1033 |     const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
1034 |       href
1035 |     );
1036 |     return { href, isWatch, isVideo, isPhoto };
1037 |   });
1038 |   console.log(
1039 |     "[FB] ensureAllCommentsLoaded ‚Äì start",
1040 |     hasTarget ? `(target=${expectedTotal})` : "(bez targetu)",
1041 |     "| view:",
1042 |     view
1043 |   );
1044 |   const MAX_ROUNDS = view.isVideo ? 1500 : 2500;
1045 |   const MAX_NO_PROGRESS = 10; // ile rund bez progresu zanim uznamy, ≈ºe koniec
1046 |   let noProgressRounds = 0;
1047 |   let roundsDone = 0;
1048 |   let lastAnchors = 0;
1049 |   let breakReason = "max-rounds";
1050 |   // helper ‚Äì czy na stronie sƒÖ jeszcze przyciski load-more/replies
1051 |   async function hasLoadMoreButtons() {
1052 |     return await page.evaluate(() => {
1053 |       const phrases = [
1054 |         "wy≈õwietl wiƒôcej komentarzy",
1055 |         "wy≈õwietl wszystkie",
1056 |         "wy≈õwietl wszystkie odpowiedzi",
1057 |         "wy≈õwietl odpowiedzi",
1058 |         "zobacz wiƒôcej komentarzy",
1059 |         "view more comments",
1060 |         "view more replies",
1061 |         "see more comments",
1062 |         "see more replies",
1063 |       ];
1064 |       const btns = Array.from(
1065 |         document.querySelectorAll("button, div[role='button'], span[role='button'], a")
1066 |       );
1067 |       return btns.some((el) => {
1068 |         const txt = (el.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
1069 |         if (!txt) return false;
1070 |         return phrases.some((p) => txt.includes(p));
1071 |       });
1072 |     });
1073 |   }
1074 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
1075 |     const beforeAnchors = await getCurrentCommentAnchorCount(page);
1076 |     // scrollujemy TYLKO przez scrollWithinPost ‚Äì on ogarnia kontener komentarzy
1077 |     const scrollInfo = await scrollWithinPost(
1078 |       page,
1079 |       `round-${round}`,
1080 |       view.isVideo ? 0.18 : 0.25
1081 |     );
1082 |     const clicks = await expandAllComments(page);
1083 |     const afterAnchors = await getCurrentCommentAnchorCount(page);
1084 |     const moreButtons = await hasLoadMoreButtons();
1085 |     const scrolled = scrollInfo.after !== scrollInfo.before;
1086 |     const progressed =
1087 |       scrolled || clicks > 0 || afterAnchors > beforeAnchors;
1088 |     if (progressed) {
1089 |       noProgressRounds = 0;
1090 |       lastAnchors = afterAnchors;
1091 |     } else {
1092 |       noProgressRounds++;
1093 |     }
1094 |     roundsDone = round;
1095 |     if (round === 1 || round % 25 === 0 || round > MAX_ROUNDS - 5) {
1096 |       console.log(
1097 |         `[FB] ensureAllCommentsLoaded ‚Äì round ${round} ` +
1098 |           `container=${scrollInfo.container} ` +
1099 |           `scrollTop: ${scrollInfo.before} ‚Üí ${scrollInfo.after} ` +
1100 |           `anchors: ${beforeAnchors} ‚Üí ${afterAnchors} ` +
1101 |           `clicks=${clicks} noProgress=${noProgressRounds} moreButtons=${moreButtons}`
1102 |       );
1103 |     }
1104 |     if (hasTarget && afterAnchors >= expectedTotal && !moreButtons) {
1105 |       breakReason = "target-reached-no-buttons";
1106 |       break;
1107 |     }
1108 |     if (!moreButtons && noProgressRounds >= MAX_NO_PROGRESS) {
1109 |       breakReason = "no-buttons-no-progress";
1110 |       break;
1111 |     }
1112 |     if (noProgressRounds >= MAX_NO_PROGRESS * 2) {
1113 |       breakReason = "hard-no-progress";
1114 |       break;
1115 |     }
1116 |     await sleepRandom(250, 600);
1117 |   }
1118 |   console.log(
1119 |     "[FB] ensureAllCommentsLoaded ‚Äì g≈Ç√≥wna pƒôtla:",
1120 |     `reason=${breakReason}, rounds=${roundsDone}, anchors=${lastAnchors}${
1121 |       hasTarget ? `/target=${expectedTotal}` : ""
1122 |     }`
1123 |   );
1124 |   // Runda kontrolna w g√≥rƒô ‚Äì domykamy expandy ‚Äûu g√≥ry‚Äù
1125 |   try {
1126 |     let ctrlReason = "max-ctrl-rounds";
1127 |     for (let i = 1; i <= 200; i++) {
1128 |       const up = await scrollWithinPost(page, `ctrl-up-${i}`, -0.55);
1129 |       const clicked = await clickOneExpandButton(page);
1130 |       await sleepRandom(160, 320);
1131 |       if (up.after === 0) {
1132 |         ctrlReason = "top-reached";
1133 |         break;
1134 |       }
1135 |       if (up.after === up.before && !clicked) {
1136 |         ctrlReason = "no-move-no-click";
1137 |         break;
1138 |       }
1139 |     }
1140 |     console.log("[FB] ensureAllCommentsLoaded ‚Äì runda kontrolna:", ctrlReason);
1141 |   } catch (e) {
1142 |     console.log(
1143 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd w rundzie kontrolnej:",
1144 |       e?.message || e
1145 |     );
1146 |   }
1147 |   let bottomClicks = 0;
1148 |   let lastBottomPos = null;
1149 |   let stableRounds = 0;
1150 |   try {
1151 |     for (let i = 1; i <= 400; i++) {
1152 |       const info = await scrollWithinPost(
1153 |         page,
1154 |         `final-bottom-${i}`,
1155 |         view.isVideo ? 0.6 : 0.8
1156 |       );
1157 |       if (lastBottomPos === info.after) {
1158 |         stableRounds++;
1159 |       } else {
1160 |         stableRounds = 0;
1161 |       }
1162 |       lastBottomPos = info.after;
1163 |       if (i === 1 || i % 50 === 0) {
1164 |         console.log(
1165 |           `[FB] ensureAllCommentsLoaded ‚Äì final-bottom step ${i}: container=${info.container}, ` +
1166 |             `scrollTop: ${info.before} ‚Üí ${info.after}`
1167 |         );
1168 |       }
1169 |       if (stableRounds >= 3) break;
1170 |       await sleepRandom(120, 260);
1171 |     }
1172 |     const bottomExpand = await expandAllComments(page);
1173 |     const extraClicks = await clickAllLoadMoreAtBottom(page, view, 300);
1174 |     bottomClicks = bottomExpand + extraClicks;
1175 |     if (bottomClicks > 0) {
1176 |       console.log(
1177 |         `[FB] ensureAllCommentsLoaded ‚Äì bottom pass: expand=${bottomExpand}, extra=${extraClicks}, total=${bottomClicks}`
1178 |       );
1179 |       await sleepRandom(700, 1300);
1180 |     }
1181 |   } catch (e) {
1182 |     console.log(
1183 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd przy final bottom:",
1184 |       e?.message || e
1185 |     );
1186 |   }
1187 |   const finalAnchors = await getCurrentCommentAnchorCount(page);
1188 |   console.log(
1189 |     "[FB] ensureAllCommentsLoaded ‚Äì koniec. anchors=",
1190 |     finalAnchors,
1191 |     "bottomClicks=",
1192 |     bottomClicks
1193 |   );
1194 | }
1195 | 
1196 | /* ============================================================
1197 |    ==================== WIƒòCEJ KOMENTARZY (VIDEO) ===============
1198 |    ============================================================ */
1199 | 
1200 | async function clickMoreCommentsButtonsVideo(page, maxLoops = 80) {
1201 |   console.log(
1202 |     "[FB][more-comments] Start klikania 'Wy≈õwietl wiƒôcej komentarzy / odpowiedzi' (video)‚Ä¶"
1203 |   );
1204 |   for (let i = 0; i < maxLoops; i++) {
1205 |     const result = await page.evaluate(() => {
1206 |       const norm = (s) =>
1207 |         (s || "")
1208 |           .replace(/\s+/g, " ")
1209 |           .trim()
1210 |           .toLowerCase();
1211 |       function getPostRoot() {
1212 |         // 1) overlay z postem / video
1213 |         const dialogs = Array.from(
1214 |           document.querySelectorAll("div[role='dialog']")
1215 |         );
1216 |         for (const dlg of dialogs) {
1217 |           const txt = (dlg.innerText || dlg.textContent || "").toLowerCase();
1218 |           if (!txt) continue;
1219 |           if (
1220 |             txt.includes("komentarz") ||
1221 |             txt.includes("comments") ||
1222 |             txt.includes("napisz komentarz")
1223 |           ) {
1224 |             const art = dlg.querySelector("article");
1225 |             return art || dlg;
1226 |           }
1227 |         }
1228 |         // 2) strona "Filmy" ‚Äì g≈Ç√≥wny artyku≈Ç
1229 |         const main = document.querySelector("main");
1230 |         if (main) {
1231 |           const art = main.querySelector("article");
1232 |           if (art) return art;
1233 |           return main;
1234 |         }
1235 |         // 3) fallback
1236 |         return document.body || document;
1237 |       }
1238 |       const root = getPostRoot();
1239 |       const MORE_COMMENTS_LABELS = [
1240 |         "wy≈õwietl wiƒôcej komentarzy",
1241 |         "zobacz wiƒôcej komentarzy",
1242 |         "view more comments",
1243 |         "view previous comments",
1244 |         "see more comments",
1245 |       ];
1246 |       const REPLY_LABELS = [
1247 |         "wy≈õwietl wiƒôcej odpowiedzi",
1248 |         "zobacz wiƒôcej odpowiedzi",
1249 |         "view more replies",
1250 |         "see more replies",
1251 |       ];
1252 |       const els = Array.from(
1253 |         root.querySelectorAll(
1254 |           "button, div[role='button'], span[role='button'], span"
1255 |         )
1256 |       );
1257 |       let target = null;
1258 |       let kind = null;
1259 |       // 1) priorytet: "Wy≈õwietl wiƒôcej komentarzy"
1260 |       for (const el of els) {
1261 |         const txt = norm(el.textContent);
1262 |         if (!txt) continue;
1263 |         if (MORE_COMMENTS_LABELS.includes(txt)) {
1264 |           const rect = el.getBoundingClientRect();
1265 |           if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1266 |           target = el;
1267 |           kind = "comments";
1268 |           break;
1269 |         }
1270 |       }
1271 |       // 2) je≈õli nie ma "wiƒôcej komentarzy" ‚Äì szukamy "wiƒôcej/X odpowiedzi"
1272 |       if (!target) {
1273 |         for (const el of els) {
1274 |           const txt = norm(el.textContent);
1275 |           if (!txt) continue;
1276 |           if (REPLY_LABELS.includes(txt)) {
1277 |             const rect = el.getBoundingClientRect();
1278 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1279 |             target = el;
1280 |             kind = "replies";
1281 |             break;
1282 |           }
1283 |           if (
1284 |             /(^|\s)\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(txt) ||
1285 |             (txt.includes(" replies") && /\d+/.test(txt))
1286 |           ) {
1287 |             const rect = el.getBoundingClientRect();
1288 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1289 |             target = el;
1290 |             kind = "replies";
1291 |             break;
1292 |           }
1293 |         }
1294 |       }
1295 |       if (!target) {
1296 |         return { clicked: false, kind: null };
1297 |       }
1298 |       try {
1299 |         target.scrollIntoView({ block: "center", inline: "nearest" });
1300 |       } catch (e) {
1301 |         // ignorujemy
1302 |       }
1303 |       if (typeof target.click === "function") {
1304 |         target.click();
1305 |         return { clicked: true, kind };
1306 |       }
1307 |       return { clicked: false, kind: null };
1308 |     });
1309 |     if (!result || !result.clicked) {
1310 |       if (i === 0) {
1311 |         console.log(
1312 |           "[FB][more-comments] Brak przycisk√≥w 'wiƒôcej komentarzy/odpowiedzi' ‚Äì nic nie klikam."
1313 |         );
1314 |       } else {
1315 |         console.log(
1316 |           `[FB][more-comments] Brak kolejnych przycisk√≥w ‚Äì zako≈Ñczono po ${i} klikniƒôciach.`
1317 |         );
1318 |       }
1319 |       break;
1320 |     }
1321 |     const what =
1322 |       result.kind === "replies"
1323 |         ? "wiƒôcej odpowiedzi / X odpowiedzi"
1324 |         : "wiƒôcej komentarzy";
1325 |     console.log(
1326 |       `[FB][more-comments] Klikniƒôto '${what}' (iteracja ${i + 1}/${maxLoops}).`
1327 |     );
1328 |     await sleepRandom(900, 1600);
1329 |     try {
1330 |       await scrollWithinPost(page, `video-more-${i + 1}`, 0.18);
1331 |     } catch (e) {
1332 |       console.log(
1333 |         "[FB][more-comments] scrollWithinPost(video) ‚Äì b≈ÇƒÖd:",
1334 |         e?.message || e
1335 |       );
1336 |     }
1337 |     await sleepRandom(800, 1400);
1338 |   }
1339 |   console.log(
1340 |     `[FB][more-comments] Zako≈Ñczono sekwencjƒô video (maxLoops=${maxLoops}).`
1341 |   );
1342 | }
1343 | 
1344 | /* ============================================================
1345 |    ================= SEKWENCYJNY SPACER (VIDEO) =================
1346 |    ============================================================ */
1347 | 
1348 | async function walkVideoCommentsSequential(page, maxCycles = 40) {
1349 |   console.log("[FB][video-walk] start ‚Äì sekwencyjny spacer po komentarzach (VIDEO)‚Ä¶");
1350 | 
1351 |   let noProgressStreak = 0;
1352 | 
1353 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
1354 |     const result = await page.evaluate(() => {
1355 |       const norm = (s) =>
1356 |         String(s || "")
1357 |           .replace(/\u00a0/g, " ")
1358 |           .replace(/\s+/g, " ")
1359 |           .trim()
1360 |           .toLowerCase();
1361 | 
1362 |       const isVisible = (el) => {
1363 |         if (!el) return false;
1364 |         const st = window.getComputedStyle(el);
1365 |         if (!st) return true;
1366 |         if (st.display === "none" || st.visibility === "hidden") return false;
1367 |         return true;
1368 |       };
1369 | 
1370 |       function getLabel(el) {
1371 |         if (!el) return "";
1372 |         const a = el.getAttribute?.("aria-label");
1373 |         if (a) return a;
1374 |         return el.textContent || "";
1375 |       }
1376 | 
1377 |       function findClickable(el, maxUp = 8) {
1378 |         let cur = el;
1379 |         for (let i = 0; i < maxUp && cur; i++) {
1380 |           const role = cur.getAttribute?.("role");
1381 |           const tag = (cur.tagName || "").toLowerCase();
1382 |           if (tag === "button" || tag === "a" || role === "button") return cur;
1383 |           cur = cur.parentElement;
1384 |         }
1385 |         return el; // fallback
1386 |       }
1387 | 
1388 |       function getPostRoot() {
1389 |         // 1) dialog / overlay (czƒôste przy video)
1390 |         const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
1391 |         for (const dlg of dialogs) {
1392 |           const txt = norm(dlg.innerText || dlg.textContent);
1393 |           if (!txt) continue;
1394 |           if (txt.includes("komentarz") || txt.includes("comments") || txt.includes("napisz komentarz")) {
1395 |             const art = dlg.querySelector("article");
1396 |             return art || dlg;
1397 |           }
1398 |         }
1399 | 
1400 |         // 2) klasyczny main
1401 |         const main = document.querySelector("main, div[role='main']");
1402 |         if (main) {
1403 |           const art = main.querySelector("article");
1404 |           return art || main;
1405 |         }
1406 | 
1407 |         return document.body || document.documentElement;
1408 |       }
1409 | 
1410 |       // REALNY test scrollowalno≈õci: pr√≥bujemy ruszyƒá scrollTop i sprawdzamy czy siƒô zmieni≈Ç.
1411 |       function canScrollByTest(el) {
1412 |         try {
1413 |           if (!el) return false;
1414 |           const h = el.clientHeight || 0;
1415 |           const sh = el.scrollHeight || 0;
1416 |           if (sh <= h + 40) return false;
1417 | 
1418 |           const before = el.scrollTop ?? 0;
1419 |           el.scrollTop = before + 50;
1420 |           const after = el.scrollTop ?? before;
1421 | 
1422 |           // przywr√≥ƒá (≈ºeby nie rozje≈ºd≈ºaƒá)
1423 |           el.scrollTop = before;
1424 | 
1425 |           return after !== before;
1426 |         } catch (e) {
1427 |           return false;
1428 |         }
1429 |       }
1430 | 
1431 |       function getCommentsContainerSmart(root) {
1432 |   // cache kontenera miƒôdzy cyklami (FB czƒôsto rerenderuje, ale referencja zwykle ≈ºyje chwilƒô)
1433 |   function isInDom(el) {
1434 |     try {
1435 |       return !!el && document.contains(el);
1436 |     } catch (e) {
1437 |       return false;
1438 |     }
1439 |   }
1440 | 
1441 |   function canScrollByTest(el) {
1442 |     try {
1443 |       if (!el) return false;
1444 |       const h = el.clientHeight || 0;
1445 |       const sh = el.scrollHeight || 0;
1446 |       if (sh <= h + 40) return false;
1447 | 
1448 |       const before = el.scrollTop ?? 0;
1449 |       el.scrollTop = before + 50;
1450 |       const after = el.scrollTop ?? before;
1451 |       el.scrollTop = before;
1452 | 
1453 |       return after !== before;
1454 |     } catch (e) {
1455 |       return false;
1456 |     }
1457 |   }
1458 | 
1459 |   // 0) spr√≥buj u≈ºyƒá ostatniego dobrego kontenera
1460 |   const cached = window.__FBW_VIDEO_COMMENTS_CONTAINER;
1461 |   if (isInDom(cached) && canScrollByTest(cached)) {
1462 |     return cached;
1463 |   }
1464 | 
1465 |   // 1) normalne szukanie
1466 |   const scopes = [root, document.body, document.documentElement].filter(Boolean);
1467 | 
1468 |   let best = null;
1469 |   let bestScore = -1;
1470 | 
1471 |   for (const scope of scopes) {
1472 |     const divs = Array.from(scope.querySelectorAll("div"))
1473 |       .filter(isVisible)
1474 |       .slice(0, 16000);
1475 | 
1476 |     for (const el of divs) {
1477 |       if (!canScrollByTest(el)) continue;
1478 | 
1479 |       const h = el.clientHeight || 0;
1480 |       const sh = el.scrollHeight || 0;
1481 |       const delta = sh - h;
1482 | 
1483 |       const t = norm(el.innerText || "");
1484 |       const hasCommentWords =
1485 |         t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
1486 | 
1487 |       const score = delta + (hasCommentWords ? 9000 : 0);
1488 | 
1489 |       if (score > bestScore) {
1490 |         bestScore = score;
1491 |         best = el;
1492 |       }
1493 |     }
1494 | 
1495 |     if (best) break;
1496 |   }
1497 | 
1498 |   // 2) cache
1499 |   if (best) {
1500 |     window.__FBW_VIDEO_COMMENTS_CONTAINER = best;
1501 |     return best;
1502 |   }
1503 | 
1504 |   return document.scrollingElement || document.documentElement || root;
1505 | }
1506 | 
1507 | 
1508 |       function clickMoreCommentsOnce(scope) {
1509 |         const LABELS = [
1510 |           "wy≈õwietl wiƒôcej komentarzy",
1511 |           "zobacz wiƒôcej komentarzy",
1512 |           "view more comments",
1513 |           "see more comments",
1514 |           "show more comments",
1515 |         ];
1516 | 
1517 |         const nodes = Array.from(
1518 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1519 |         )
1520 |           .filter(isVisible)
1521 |           .slice(0, 30000);
1522 | 
1523 |         for (const el of nodes) {
1524 |           const txt = norm(getLabel(el));
1525 |           if (!txt) continue;
1526 | 
1527 |           const hit = LABELS.some((w) => txt.includes(w));
1528 |           if (!hit) continue;
1529 | 
1530 |           const btn = findClickable(el);
1531 | 
1532 |           try {
1533 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1534 |           } catch (e) {}
1535 | 
1536 |           try {
1537 |             btn.click();
1538 |             return true;
1539 |           } catch (e) {}
1540 |         }
1541 |         return false;
1542 |       }
1543 | 
1544 |       function expandReplies(scope, limit = 35) {
1545 |         const nodes = Array.from(
1546 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1547 |         )
1548 |           .filter(isVisible)
1549 |           .slice(0, 40000);
1550 | 
1551 |         let clicked = 0;
1552 | 
1553 |         for (const el of nodes) {
1554 |           const txt = norm(getLabel(el));
1555 |           if (!txt) continue;
1556 | 
1557 |           const isMoreReplies =
1558 |             txt.includes("wiƒôcej odpowiedzi") ||
1559 |             txt.includes("more replies") ||
1560 |             txt.includes("view previous replies") ||
1561 |             txt.includes("zobacz odpowiedzi") ||
1562 |             txt.includes("show replies");
1563 | 
1564 |           // ≈Çapie ‚Äú12 odpowiedzi‚Äù, ale te≈º warianty z dodatkami
1565 |           const isCountReplies = /\b\d+\s+(odpowied≈∫|odpowiedzi|repl(y|ies))\b/.test(txt);
1566 | 
1567 |           if (!isMoreReplies && !isCountReplies) continue;
1568 | 
1569 |           const btn = findClickable(el);
1570 | 
1571 |           try {
1572 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1573 |           } catch (e) {}
1574 | 
1575 |           try {
1576 |             btn.click();
1577 |             clicked++;
1578 |             if (clicked >= limit) break;
1579 |           } catch (e) {}
1580 |         }
1581 | 
1582 |         return clicked;
1583 |       }
1584 | 
1585 |       function scrollSomewhere(container) {
1586 |         const beforeC = container?.scrollTop ?? 0;
1587 |         const beforeW = window.scrollY ?? 0;
1588 | 
1589 |         const step = Math.max(300, (container?.clientHeight || 0) * 0.8, 700);
1590 | 
1591 |         // 1) pr√≥buj na kontenerze
1592 |         try {
1593 |           if (container && typeof container.scrollTop === "number") {
1594 |             container.scrollTop = Math.min(beforeC + step, container.scrollHeight || beforeC + step);
1595 |           }
1596 |         } catch (e) {}
1597 | 
1598 |         const afterC = container?.scrollTop ?? beforeC;
1599 | 
1600 |         // 2) jak nie ruszy≈Ço ‚Äì pr√≥buj window
1601 |         if (afterC === beforeC) {
1602 |           try {
1603 |             window.scrollBy(0, step);
1604 |           } catch (e) {}
1605 |         }
1606 | 
1607 |         const afterW = window.scrollY ?? beforeW;
1608 | 
1609 |         return {
1610 |           beforeC,
1611 |           afterC,
1612 |           beforeW,
1613 |           afterW,
1614 |           scrolled: afterC !== beforeC || afterW !== beforeW,
1615 |         };
1616 |       }
1617 | 
1618 |       const root = getPostRoot();
1619 |       const container = getCommentsContainerSmart(root);
1620 | 
1621 |       // WA≈ªNE: na video czƒôsto ‚Äúwiƒôcej komentarzy‚Äù jest poza root ‚Üí szukamy i w body
1622 |       let clickedMore = clickMoreCommentsOnce(root);
1623 |       if (!clickedMore) clickedMore = clickMoreCommentsOnce(document.body);
1624 | 
1625 |       // ‚Äú12 odpowiedzi‚Äù te≈º potrafi byƒá poza root
1626 |       const repliesClickedRoot = expandReplies(root, 35);
1627 |       const repliesClickedBody = expandReplies(document.body, Math.max(0, 35 - repliesClickedRoot));
1628 |       const repliesClicked = repliesClickedRoot + repliesClickedBody;
1629 | 
1630 |       const scrollRes = scrollSomewhere(container);
1631 | 
1632 |       const hasButtons = clickedMore || repliesClicked > 0;
1633 | 
1634 |       return {
1635 |         clickedMore,
1636 |         repliesClicked,
1637 |         scrolled: scrollRes.scrolled,
1638 |         hasButtons,
1639 |         dbg: {
1640 |           beforeC: scrollRes.beforeC,
1641 |           afterC: scrollRes.afterC,
1642 |           beforeW: scrollRes.beforeW,
1643 |           afterW: scrollRes.afterW,
1644 |           containerTag: container?.tagName || null,
1645 |         },
1646 |       };
1647 |     });
1648 | 
1649 |     console.log(
1650 |       `[FB][video-walk] cycle ${cycle}: more=${result.clickedMore}, replies=${result.repliesClicked}, scrolled=${result.scrolled} | dbg=${JSON.stringify(result.dbg)}`
1651 |     );
1652 | 
1653 |     // Stop dopiero po 3 pustych cyklach (FB czƒôsto ≈Çaduje leniwie)
1654 |     if (!result.hasButtons && !result.scrolled) {
1655 |       noProgressStreak++;
1656 |       console.log(`[FB][video-walk] no-progress streak = ${noProgressStreak}/3`);
1657 |       if (noProgressStreak >= 3) {
1658 |         console.log("[FB][video-walk] stop ‚Äì 3x brak przycisk√≥w i brak scrolla.");
1659 |         break;
1660 |       }
1661 |     } else {
1662 |       noProgressStreak = 0;
1663 |     }
1664 | 
1665 |     await sleepRandom(1200, 2000);
1666 |   }
1667 | 
1668 |   console.log("[FB][video-walk] koniec spaceru po komentarzach VIDEO.");
1669 | }
1670 | 
1671 | 
1672 | 
1673 | /* ============================================================
1674 |    ==================== LICZBA KOMENTARZY ======================
1675 |    ============================================================ */
1676 | 
1677 | async function getCommentCount(page, postUrl) {
1678 |   console.log(`[FB] Otwieranie posta: ${postUrl}`);
1679 |   const ok = await safeGoto(page, postUrl, "post", {
1680 |     waitUntil: "networkidle2",
1681 |     timeout: NAV_TIMEOUT_MS,
1682 |   });
1683 |   if (!ok) {
1684 |     throw new Error("safeGoto-failed");
1685 |   }
1686 |   let currentUrl = page.url();
1687 |   if (currentUrl.includes("/login")) {
1688 |     console.log(
1689 |       "[FB] Zamiast posta wylƒÖdowa≈Çem na /login?next=... ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1690 |     );
1691 |     await fbLogin(page);
1692 |     await sleepRandom(3000, 4500);
1693 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
1694 |     console.log(
1695 |       "[FB] Stan sesji po fbLogin() z /login:",
1696 |       loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1697 |     );
1698 |     if (loggedAfterLogin) {
1699 |       await safeGoto(page, postUrl, "post", {
1700 |         waitUntil: "networkidle2",
1701 |         timeout: NAV_TIMEOUT_MS,
1702 |       });
1703 |     } else {
1704 |       console.log(
1705 |         "[FB] Po fbLogin() z /login nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1706 |       );
1707 |     }
1708 |   }
1709 |   await acceptCookies(page, "post-initial");
1710 |   let loggedOnPost = false;
1711 |   try {
1712 |     loggedOnPost = await checkIfLogged(page);
1713 |   } catch (e) {
1714 |     console.log(
1715 |       "[FB] checkIfLogged na widoku posta ‚Äì b≈ÇƒÖd:",
1716 |       e?.message || e
1717 |     );
1718 |   }
1719 |   if (!loggedOnPost) {
1720 |     console.log(
1721 |       "[FB] Na widoku posta brak aktywnej sesji (np. pasek 'Zaloguj siƒô') ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1722 |     );
1723 |     await fbLogin(page);
1724 |     await sleepRandom(3000, 4500);
1725 |     const loggedAfterFbLogin = await checkIfLogged(page).catch(() => false);
1726 |     console.log(
1727 |       "[FB] Stan sesji po fbLogin() z widoku posta:",
1728 |       loggedAfterFbLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1729 |     );
1730 |     if (loggedAfterFbLogin) {
1731 |       console.log(
1732 |         "[FB] Po fbLogin() wykryto zalogowanego u≈ºytkownika ‚Äì ponownie otwieram posta."
1733 |       );
1734 |       await safeGoto(page, postUrl, "post", {
1735 |         waitUntil: "networkidle2",
1736 |         timeout: NAV_TIMEOUT_MS,
1737 |       });
1738 |       await acceptCookies(page, "post-initial");
1739 |     } else {
1740 |       console.log(
1741 |         "[FB] Po fbLogin() nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1742 |       );
1743 |     }
1744 |   }
1745 |   await ensureLoggedInOnPostOverlay(page);
1746 |   await sleepRandom(3000, 4500);
1747 |   await acceptCookies(page, "post");
1748 |   try {
1749 |     const loggedAfterPostOverlay = await checkIfLogged(page);
1750 |     if (loggedAfterPostOverlay) {
1751 |       console.log(
1752 |         "[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."
1753 |       );
1754 |       await saveCookies(page);
1755 |     } else {
1756 |       console.log(
1757 |         "[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."
1758 |       );
1759 |     }
1760 |   } catch (e) {
1761 |     console.log(
1762 |       "[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",
1763 |       e?.message || e
1764 |     );
1765 |   }
1766 |   await sleepRandom(1500, 2500);
1767 |   const isWatchView = postUrl.includes("/watch/");
1768 |   const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(postUrl);
1769 |   const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(postUrl);
1770 |   console.log(
1771 |     "[FB] getCommentCount ‚Äì view type:",
1772 |     isWatchView ? "WATCH" : isVideoView ? "VIDEO" : isPhotoView ? "PHOTO" : "POST"
1773 |   );
1774 |   if (isVideoView) {
1775 |     await pauseVideoIfAny(page);
1776 |     await clickShowAllCommentsIfPresent(page);
1777 |   }
1778 |   if (!isVideoView) {
1779 |     await scrollPost(page, 200);
1780 |     await sleepRandom(800, 1200);
1781 |   }
1782 |   try {
1783 |     const okFilter = await switchCommentsFilterToAll(page);
1784 |     console.log(
1785 |       "[FB] Pierwsza pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1786 |       okFilter
1787 |     );
1788 |     if (okFilter) await sleepRandom(1200, 2000);
1789 |   } catch (e) {
1790 |     console.log(
1791 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",
1792 |       e.message
1793 |     );
1794 |   }
1795 |   if (isVideoView) {
1796 |     await pauseVideoIfAny(page);
1797 |   }
1798 |   const uiInfo = await getUiCommentInfo(page);
1799 |   console.log("[DBG] Comments debug (skr√≥cone):", {
1800 |     source: uiInfo?.source,
1801 |     raw: uiInfo?.raw,
1802 |     viewType: uiInfo?.viewType,
1803 |     comments: uiInfo?.comments,
1804 |   });
1805 |   let expectedTotal = null;
1806 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
1807 |     expectedTotal = uiInfo.comments;
1808 |   }
1809 |   if (isVideoView) {
1810 |     await clickMoreCommentsButtonsVideo(page);
1811 |   }
1812 |   if (isVideoView) {
1813 |     await walkVideoCommentsSequential(page, expectedTotal || null);
1814 |   } else {
1815 |     await ensureAllCommentsLoaded(page, expectedTotal);
1816 |   }
1817 |   try {
1818 |     const ok2 = await switchCommentsFilterToAll(page);
1819 |     console.log(
1820 |       "[FB] Druga pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1821 |       ok2
1822 |     );
1823 |     if (ok2) await sleepRandom(800, 1500);
1824 |   } catch (e) {
1825 |     console.log(
1826 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",
1827 |       e.message
1828 |     );
1829 |   }
1830 |   const fallback = await page.evaluate(() => {
1831 |     const root = document;
1832 |     const anchors = Array.from(
1833 |       root.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
1834 |     );
1835 |     const ids = new Set();
1836 |     for (const a of anchors) {
1837 |       try {
1838 |         const url = new URL(a.href);
1839 |         const cid = url.searchParams.get("comment_id");
1840 |         const rid = url.searchParams.get("reply_comment_id");
1841 |         let raw = rid || cid;
1842 |         if (!raw) continue;
1843 |         if (!/^\d+$/.test(raw)) {
1844 |           try {
1845 |             const dec = atob(raw);
1846 |             const m = dec.match(/:(\d+)_([0-9]+)/);
1847 |             if (m) raw = m[2];
1848 |           } catch {}
1849 |         }
1850 |         if (raw) ids.add(raw);
1851 |       } catch {}
1852 |     }
1853 |     return { count: ids.size };
1854 |   });
1855 |   console.log("[FB] Fallback ‚Äì anchor IDs:", fallback.count);
1856 |   let finalNum = uiInfo?.comments ?? null;
1857 |   if (fallback.count > 0) {
1858 |     if (finalNum == null || finalNum === 0) {
1859 |       finalNum = fallback.count;
1860 |       console.log(
1861 |         "[FB] UI puste/0 ‚Äì u≈ºywam anchor√≥w jako ≈∫r√≥d≈Ça.",
1862 |         `anchor=${fallback.count}`
1863 |       );
1864 |     } else {
1865 |       const diff = finalNum - fallback.count;
1866 |       if (diff > 5) {
1867 |         console.log(
1868 |           "[FB] UI >> anchory ‚Äì czƒô≈õƒá komentarzy niedostƒôpna, u≈ºywam anchor√≥w.",
1869 |           `ui=${finalNum}, anchor=${fallback.count}`
1870 |         );
1871 |         finalNum = fallback.count;
1872 |       } else if (fallback.count > finalNum) {
1873 |         console.log(
1874 |           "[FB] Anchory > UI ‚Äì u≈ºywam anchor√≥w jako bazowej liczby.",
1875 |           `ui=${finalNum}, anchor=${fallback.count}`
1876 |         );
1877 |         finalNum = fallback.count;
1878 |       } else {
1879 |         console.log(
1880 |           "[FB] UI ~= anchory ‚Äì zostawiam UI jako ≈∫r√≥d≈Ço.",
1881 |           `ui=${finalNum}, anchor=${fallback.count}`
1882 |         );
1883 |       }
1884 |     }
1885 |   } else {
1886 |     console.log("[FB] Anchory=0 ‚Äì opieram siƒô wy≈ÇƒÖcznie na UI:", finalNum);
1887 |   }
1888 |   if (finalNum != null) {
1889 |     console.log("[FB] Liczba komentarzy (final):", finalNum);
1890 |     return finalNum;
1891 |   }
1892 |   console.log("[FB] Brak liczby komentarzy w UI i brak anchor√≥w, zwracam 0.");
1893 |   return 0;
1894 | }
1895 | 
1896 | /* ============================================================
1897 |    ================= ROZWIJANIE KOMENTARZY ====================
1898 |    ============================================================ */
1899 | 
1900 | async function expandAllComments(page) {
1901 |   if (!EXPAND_COMMENTS) {
1902 |     console.log("[FB] EXPAND_COMMENTS=false ‚Üí pomijam rozwijanie.");
1903 |     return 0;
1904 |   }
1905 |   let clicks = 0;
1906 |   for (let i = 0; i < 30; i++) {
1907 |     const didClick = await clickOneExpandButton(page);
1908 |     if (!didClick) break;
1909 |     clicks++;
1910 |     await sleepRandom(900, 1600);
1911 |   }
1912 |   return clicks;
1913 | }
1914 | 
1915 | export async function extractCommentsData(page) {
1916 |   try {
1917 |     const comments = await extractCommentsFromDOM(page);
1918 |     return comments;
1919 |   } catch (err) {
1920 |     console.error('[FB] extractCommentsData ‚Äì b≈ÇƒÖd:', err.message);
1921 |     return [];
1922 |   }
1923 | }
1924 | 
1925 | export { getCommentCount, expandAllComments,  };
1926 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/cookies.js
  2 | 
  3 | import fs from "fs/promises";
  4 | import { sleepRandom } from "../utils/sleep.js";
  5 | 
  6 | 
  7 | 
  8 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
  9 | const COOKIES_READ_ONLY =
 10 |   String(process.env.COOKIES_READ_ONLY || "")
 11 |     .trim()
 12 |     .toLowerCase() === "true";
 13 | 
 14 | console.log(
 15 |   "[FB][cookies] COOKIES_READ_ONLY =",
 16 |   COOKIES_READ_ONLY,
 17 |   "(raw:",
 18 |   process.env.COOKIES_READ_ONLY,
 19 |   ")"
 20 | );
 21 | 
 22 | 
 23 | /**
 24 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
 25 |  */
 26 | async function loadCookies(page) {
 27 |   try {
 28 |     const raw = await fs.readFile("cookies.json", "utf8");
 29 |     const cookies = JSON.parse(raw);
 30 | 
 31 |     if (Array.isArray(cookies) && cookies.length) {
 32 |       await page.setCookie(...cookies);
 33 |       console.log("[FB][cookies] Za≈Çadowano zapisane cookies (cookies.json).");
 34 |     } else {
 35 |       console.log(
 36 |         "[FB][cookies] cookies.json istnieje, ale nie zawiera poprawnej tablicy cookies."
 37 |       );
 38 |     }
 39 |   } catch (err) {
 40 |     console.log(
 41 |       "[FB][cookies] Brak zapisanych cookies lub b≈ÇƒÖd odczytu ‚Äì logowanie od zera.",
 42 |       err?.message || err
 43 |     );
 44 |   }
 45 | }
 46 | 
 47 | /**
 48 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
 49 |  * w katalogu roboczym procesu (tam, skƒÖd odpalasz node).
 50 |  */
 51 | async function saveCookies(page) {
 52 |   if (COOKIES_READ_ONLY) {
 53 |     console.log(
 54 |       "[FB][cookies] COOKIES_READ_ONLY=true ‚Äì pomijam zapis cookies.json (tylko odczyt z pliku)."
 55 |     );
 56 |     return;
 57 |   }
 58 | 
 59 |   try {
 60 |     const cookies = await page.cookies();
 61 | 
 62 |     await fs.writeFile(
 63 |       "cookies.json",
 64 |       JSON.stringify(cookies, null, 2),
 65 |       "utf8"
 66 |     );
 67 | 
 68 |     console.log(
 69 |       `[FB][cookies] Zapisano cookies.json (liczba cookies: ${cookies.length}).`
 70 |     );
 71 |   } catch (e) {
 72 |     console.log(
 73 |       "[FB][cookies] B≈ÇƒÖd przy zapisie cookies.json:",
 74 |       e?.message || e
 75 |     );
 76 |   }
 77 | }
 78 | 
 79 | 
 80 | 
 81 | /**
 82 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
 83 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
 84 |  */
 85 | async function acceptCookies(page, label = "global") {
 86 |   try {
 87 |     // chwila na pojawienie siƒô popupu
 88 |     await sleepRandom(800, 1500);
 89 | 
 90 |     const result = await page.evaluate(() => {
 91 |       const wanted = [
 92 |         "zezw√≥l na wszystkie pliki cookie",
 93 |         "zezw√≥l na wszystkie pliki",
 94 |         "akceptuj wszystkie pliki cookie",
 95 |         "akceptuj wszystkie",
 96 |         "allow all cookies",
 97 |         "accept all cookies",
 98 |         "accept essential and optional cookies",
 99 |         "tylko niezbƒôdne pliki cookie",
100 |         "odrzuƒá opcjonalne pliki cookie",
101 |       ].map((t) => t.toLowerCase());
102 | 
103 |       const buttons = Array.from(
104 |         document.querySelectorAll("button, [role='button']")
105 |       );
106 | 
107 |       let clicked = false;
108 |       const texts = [];
109 | 
110 |       for (const btn of buttons) {
111 |         const txt = (btn.innerText || btn.textContent || "").trim();
112 |         if (!txt) continue;
113 | 
114 |         const low = txt.toLowerCase();
115 |         texts.push(txt);
116 | 
117 |         if (wanted.some((w) => low.includes(w))) {
118 |           btn.click();
119 |           clicked = true;
120 |           break;
121 |         }
122 |       }
123 | 
124 |       return { clicked, texts };
125 |     });
126 | 
127 |     if (result.clicked) {
128 |       console.log(
129 |         `[FB][cookies-${label}] Klikniƒôto przycisk akceptacji cookies.`
130 |       );
131 |       await sleepRandom(1500, 2500);
132 |     } else {
133 |       console.log(
134 |         `[FB][cookies-${label}] Nie znaleziono przycisku cookies. Teksty na przyciskach:`,
135 |         result.texts
136 |       );
137 |     }
138 |   } catch (err) {
139 |     console.log(
140 |       `[FB][cookies-${label}] B≈ÇƒÖd przy obs≈Çudze popupu cookies:`,
141 |       err?.message || err
142 |     );
143 |   }
144 | }
145 | 
146 | export { loadCookies, saveCookies, acceptCookies };
147 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/cookies.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1766424712903%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "oo",
 18 |     "value": "v1%7C3%3A1765999179",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800559178.663726,
 22 |     "size": 21,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "xs",
 33 |     "value": "47%3Ayi9zwhrdzuBVIw%3A2%3A1765999177%3A-1%3A-1%3A%3AAcyzLWUa4RYsYSWGVaAWF-8v_BXKW8MzXVn3OBRYLQ",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1797960539.317587,
 37 |     "size": 96,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1366x768",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1767029512,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61584544438252",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1797960539.317325,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "datr",
 78 |     "value": "LwJDaQvuIWjub0yGJMEnvvMZ",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1800559152.834742,
 82 |     "size": 28,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "sb",
 93 |     "value": "LwJDaXGRlxl-i7CRj302m_8c",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1800559178.355148,
 97 |     "size": 26,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/expandButtons.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/expandButtons.js
  2 | // Centralny ‚Äûbutton classifier‚Äù dla wszystkich przycisk√≥w typu:
  3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments‚Äù
  4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies‚Äù
  5 | // - ‚ÄûZobacz wiƒôcej / See more‚Äù (bez ‚ÄûZobacz t≈Çumaczenie‚Äù).
  6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
  7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
  8 | 
  9 | import { INCLUDE_REPLIES } from "../config.js";
 10 | 
 11 | async function clickOneExpandButton(page) {
 12 |   const res = await page.evaluate((includeReplies) => {
 13 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 14 |       location.href
 15 |     );
 16 |     const isWatchView = /\/watch\//i.test(location.href);
 17 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
 18 | 
 19 |     function getPostRoot() {
 20 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 21 |       const postDialog = dialogs.find((dlg) => {
 22 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 23 |         if (!text) return false;
 24 |         const hasCommentWord =
 25 |           text.includes("komentarz") || text.includes("comment");
 26 |         const hasActions =
 27 |           text.includes("lubiƒô to") ||
 28 |           text.includes("komentarz") ||
 29 |           text.includes("udostƒôpnij") ||
 30 |           text.includes("napisz komentarz") ||
 31 |           text.includes("comment");
 32 |         const looksLikeNotifications =
 33 |           text.startsWith("powiadomienia") &&
 34 |           text.includes("wszystkie") &&
 35 |           text.includes("nieprzeczytane");
 36 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 37 |       });
 38 |       if (postDialog) return postDialog;
 39 |       const main = document.querySelector("div[role='main']");
 40 |       if (main) {
 41 |         const article = main.querySelector("article");
 42 |         return article || main;
 43 |       }
 44 |       return document.body;
 45 |     }
 46 | 
 47 |     function isVisible(el) {
 48 |       if (!el) return false;
 49 |       const style = window.getComputedStyle(el);
 50 |       if (!style) return false;
 51 |       if (style.display === "none" || style.visibility === "hidden") return false;
 52 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
 53 |       if (style.pointerEvents === "none") return false;
 54 |       const rect = el.getBoundingClientRect();
 55 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
 56 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
 57 |       return true;
 58 |     }
 59 | 
 60 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
 61 |     const root =
 62 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
 63 |     // (widok /watch/ jest traktowany jak video)
 64 | 
 65 |     const buttons = Array.from(
 66 |       root.querySelectorAll(
 67 |         "button, a, div[role='button'], span[role='button']"
 68 |       )
 69 |     );
 70 | 
 71 |     function classifyButton(raw) {
 72 |       const text = raw.toLowerCase();
 73 |       const hasCommentWord =
 74 |         text.includes("komentarz") ||
 75 |         text.includes("comments") ||
 76 |         text.includes("comment");
 77 |       const hasReplyWord =
 78 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
 79 |         text.includes("reply") ||
 80 |         text.includes("replies") ||
 81 |         text.includes("repl");
 82 |       const hasMoreWord =
 83 |         text.includes("wy≈õwietl") ||
 84 |         text.includes("zobacz") ||
 85 |         text.includes("poka≈º") ||
 86 |         text.includes("view") ||
 87 |         text.includes("show") ||
 88 |         text.includes("see") ||
 89 |         text.includes("wszystkie") ||
 90 |         text.includes("all") ||
 91 |         text.includes("previous");
 92 |       const hasTranslationWord =
 93 |         text.includes("t≈Çumaczenie") || text.includes("translation");
 94 |       if (hasTranslationWord) return null;
 95 |       if (
 96 |         text === "komentarz" ||
 97 |         text === "comment" ||
 98 |         text === "lubiƒô to" ||
 99 |         text === "lubiƒô to!" ||
100 |         text === "like" ||
101 |         text === "odpowiedz" ||
102 |         text === "reply"
103 |       ) {
104 |         return null;
105 |       }
106 |       if (
107 |         hasCommentWord &&
108 |         hasMoreWord &&
109 |         (text.includes("wiƒôcej") ||
110 |           text.includes("more") ||
111 |           text.includes("poprzednie") ||
112 |           text.includes("previous"))
113 |       ) {
114 |         return { kind: "more-comments", priority: 3 };
115 |       }
116 | 
117 |       // ‚úÖ ON/OFF odpowiedzi
118 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
119 |         return { kind: "more-replies", priority: 2 };
120 |       }
121 | 
122 |       if (
123 |         text === "zobacz wiƒôcej" ||
124 |         text === "see more" ||
125 |         text.startsWith("zobacz wiƒôcej ") ||
126 |         text.startsWith("see more ")
127 |       ) {
128 |         return { kind: "see-more-text", priority: 1 };
129 |       }
130 |       return null;
131 |     }
132 | 
133 |     const candidates = [];
134 | 
135 |     for (const el of buttons) {
136 |       if (!isVisible(el)) continue;
137 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
138 |       if (!raw) continue;
139 |       const cls = classifyButton(raw);
140 |       if (!cls) continue;
141 |       const rect = el.getBoundingClientRect();
142 |       candidates.push({
143 |         el,
144 |         kind: cls.kind,
145 |         priority: cls.priority,
146 |         top: rect.top,
147 |         text: raw,
148 |       });
149 |     }
150 | 
151 |     if (!candidates.length) {
152 |       return { clicked: false };
153 |     }
154 | 
155 |     candidates.sort((a, b) => {
156 |       if (a.priority !== b.priority) return b.priority - a.priority;
157 |       return a.top - b.top;
158 |     });
159 | 
160 |     const chosen = candidates[0];
161 |     try {
162 |       chosen.el.click();
163 |       return {
164 |         clicked: true,
165 |         kind: chosen.kind,
166 |         text: chosen.text,
167 |       };
168 |     } catch (e) {
169 |       return { clicked: false };
170 |     }
171 |   }, INCLUDE_REPLIES);
172 | 
173 |   if (res && res.clicked) {
174 |     console.log(
175 |       `[FB] -> klik expand '${res.text}' (kind=${res.kind})`
176 |     );
177 |   }
178 |   return !!(res && res.clicked);
179 | }
180 | 
181 | export { clickOneExpandButton };
182 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/export_files.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // export_files.js
 2 | import fs from "fs";
 3 | import path from "path";
 4 | 
 5 | const FILES = [
 6 |   // ===== ROOT =====
 7 |   ".env",
 8 |   ".gitignore",
 9 |   "package.json",
10 |   "package-lock.json",
11 |   "cookies.json",
12 | 
13 |   // ===== CONFIG / DATA =====
14 |   "config/links.js",
15 |   "config/links.json",
16 | 
17 |   "data/comments-cache.json",
18 | 
19 |   // ===== SRC ‚Äì CORE =====
20 |   "src/index.js",
21 |   "src/config.js",
22 |   "src/watcher.js",
23 |   "src/webhook.js",
24 | 
25 |   // ===== SRC ‚Äì DB =====
26 |   "src/db/cache.js",
27 | 
28 |   // ===== SRC ‚Äì UTILS =====
29 |   "src/utils/navigation.js",
30 |   "src/utils/sleep.js",
31 | 
32 |   // ===== SRC ‚Äì FB CORE =====
33 |   "src/fb/comments.js",
34 |   "src/fb/scroll.js",
35 |   "src/fb/cookies.js",
36 |   "src/fb/login.js",
37 |   "src/fb/expandButtons.js",
38 |   "src/fb/uiCommentInfo.js",
39 | 
40 |   // ===== SRC ‚Äì FB UI ROUTER =====
41 |   "src/fb/ui/index.js",
42 | 
43 |   // ===== SRC ‚Äì FB UI HANDLERS =====
44 |   "src/fb/ui/post.js",
45 |   "src/fb/ui/photo.js",
46 |   "src/fb/ui/videos.js",
47 |   "src/fb/ui/watch.js",
48 | 
49 |   // ===== SRC ‚Äì FB LEGACY (BACKUP) =====
50 |   "src/fb/legacy/comments.legacy.js",
51 | 
52 |   // ===== EXPORT / TOOLS =====
53 |   "export_files.js"
54 | ];
55 | 
56 | // folder docelowy
57 | const EXPORT_DIR = path.join(process.cwd(), "export_fb_watcher");
58 | 
59 | // tworzymy folder, je≈õli nie istnieje
60 | if (!fs.existsSync(EXPORT_DIR)) {
61 |   fs.mkdirSync(EXPORT_DIR, { recursive: true });
62 | }
63 | 
64 | FILES.forEach((file) => {
65 |   const srcPath = path.join(process.cwd(), file);
66 |   const dstPath = path.join(EXPORT_DIR, path.basename(file));
67 | 
68 |   if (fs.existsSync(srcPath)) {
69 |     fs.copyFileSync(srcPath, dstPath);
70 |     console.log(`‚úì Wyeksportowano: ${file}`);
71 |   } else {
72 |     console.log(`‚ö†Ô∏è Nie znaleziono pliku: ${file}`);
73 |   }
74 | });
75 | 
76 | console.log("\n=== EKSPORT ZAKO≈ÉCZONY ===");
77 | console.log(`Pliki znajdziesz tu: ${EXPORT_DIR}`);
78 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/index.html`
**Typ:** HTML  
**Opis:** Plik projektu (kod/konfiguracja).  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>Panel FB Watcher</title>
  7 | 
  8 |   <style>
  9 |     :root{
 10 |       --bg:#0b0f14;
 11 |       --card:#121926;
 12 |       --card2:#0b1220;
 13 |       --border:#223047;
 14 |       --border2:#2a3a55;
 15 |       --text:#e7eef7;
 16 |       --muted:rgba(231,238,247,.75);
 17 |       --primary:#2563eb;
 18 |       --danger:#b91c1c;
 19 |       --ok:#34d399;
 20 |       --err:#f87171;
 21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
 22 |       --radius:14px;
 23 |     }
 24 | 
 25 |     * { box-sizing:border-box; }
 26 |     body {
 27 |       font-family: system-ui, Arial;
 28 |       margin: 16px;
 29 |       background: var(--bg);
 30 |       color: var(--text);
 31 |     }
 32 | 
 33 |     h2 { margin: 6px 0 6px; }
 34 |     h3 { margin: 6px 0 12px; }
 35 | 
 36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
 37 |     .card {
 38 |       background: var(--card);
 39 |       border:1px solid var(--border);
 40 |       border-radius: var(--radius);
 41 |       padding:14px;
 42 |       margin:12px 0;
 43 |       box-shadow: var(--shadow);
 44 |     }
 45 | 
 46 |     input, textarea, button, select {
 47 |       font: inherit;
 48 |       border-radius:12px;
 49 |       border:1px solid var(--border2);
 50 |       background: var(--card2);
 51 |       color: var(--text);
 52 |       padding:10px 12px;
 53 |       outline: none;
 54 |     }
 55 |     input:focus, textarea:focus, select:focus {
 56 |       border-color: rgba(37, 99, 235, .75);
 57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
 58 |     }
 59 | 
 60 |     input, textarea { width: 100%; }
 61 |     textarea { resize: vertical; min-height: 90px; }
 62 | 
 63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
 64 |     button:active { transform: translateY(1px); }
 65 |     button.primary { background: var(--primary); border-color: var(--primary); }
 66 |     button.danger { background: var(--danger); border-color: var(--danger); }
 67 |     button.ghost { background: transparent; }
 68 |     button.small { padding:8px 10px; border-radius: 10px; }
 69 | 
 70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 71 | 
 72 |     .muted { opacity:0.78; font-size:12px; }
 73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 74 | 
 75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
 76 | 
 77 |     .thumb {
 78 |       width:64px; height:40px;
 79 |       object-fit:cover;
 80 |       border-radius:10px;
 81 |       border:1px solid var(--border);
 82 |       background: var(--card2);
 83 |     }
 84 | 
 85 |     /* ===== tabela ===== */
 86 |     .tableWrap {
 87 |       width: 100%;
 88 |       overflow-x: auto;
 89 |       border-radius: 12px;
 90 |       border: 1px solid rgba(34,48,71,.45);
 91 |       background: rgba(11,18,32,.25);
 92 |     }
 93 | 
 94 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
 95 |     th, td {
 96 |       border-bottom:1px solid rgba(34,48,71,.7);
 97 |       padding:10px;
 98 |       text-align:left;
 99 |       vertical-align:top;
100 |       overflow-wrap:anywhere;
101 |       word-break:break-word;
102 |     }
103 |     th { font-size: 12px; opacity:.9; position: sticky; top: 0; background: rgba(18,25,38,.96); backdrop-filter: blur(8px); }
104 | 
105 |     /* kolumny */
106 |     th.col-id,  td.col-id  { width: 170px; }
107 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
108 |     th.col-name,td.col-name{ width: 170px; }
109 |     th.col-img, td.col-img { width: 120px; }
110 |     th.col-desc,td.col-desc{ width: 260px; }
111 |     th.col-act, td.col-act { width: 110px; text-align:center; }
112 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
113 | 
114 |     /* URL: pe≈Çny, zawijany */
115 |     td.col-url a{
116 |       color: #93c5fd;
117 |       text-decoration: underline;
118 |       white-space: normal;
119 |       overflow-wrap:anywhere;
120 |       word-break:break-word;
121 |       display:inline;
122 |     }
123 | 
124 |     /* wrapper dla linka + ikonki kopiuj */
125 |     .urlWrap{
126 |       display:flex;
127 |       align-items:flex-start;
128 |       gap:10px;
129 |     }
130 |     .urlWrap a{
131 |       flex: 1;
132 |       min-width: 0;
133 |     }
134 | 
135 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
136 |     .iconBtn{
137 |       width: 28px;
138 |       height: 28px;
139 |       padding: 0;
140 |       display:inline-flex;
141 |       align-items:center;
142 |       justify-content:center;
143 |       border-radius: 10px;
144 |       background: transparent;
145 |       border: 1px solid rgba(42,58,85,.9);
146 |       opacity: .9;
147 |       flex: 0 0 auto;
148 |     }
149 |     .iconBtn:hover{
150 |       opacity: 1;
151 |       background: rgba(37,99,235,.15);
152 |     }
153 |     .iconBtn:active{
154 |       transform: translateY(1px);
155 |     }
156 |     .iconBtn svg{
157 |       width: 16px;
158 |       height: 16px;
159 |       fill: none;
160 |       stroke: rgba(231,238,247,.95);
161 |       stroke-width: 2;
162 |       stroke-linecap: round;
163 |       stroke-linejoin: round;
164 |     }
165 | 
166 |     /* akcje w tabeli */
167 |     .actionsWrap{
168 |       display:flex;
169 |       gap:10px;
170 |       align-items:center;
171 |       justify-content:flex-start;
172 |       flex-wrap:nowrap;
173 |     }
174 | 
175 |     /* ===== status ===== */
176 |     .hint { margin-top:10px; }
177 |     .hint.ok { color: #a7f3d0; }
178 |     .hint.err { color: #fca5a5; }
179 | 
180 |     /* ===== logi: proporcje ===== */
181 |     .logsBox {
182 |       display:flex;
183 |       flex-direction: column;
184 |       gap:10px;
185 |     }
186 |     #logs {
187 |       height: 200px;
188 |       min-height: 160px;
189 |       max-height: 520px;
190 |     }
191 |     .logsExpanded #logs { height: 420px; }
192 | 
193 |     /* ===== modal ===== */
194 |     .modalOverlay{
195 |       position: fixed;
196 |       inset: 0;
197 |       background: rgba(0,0,0,.55);
198 |       display:none;
199 |       align-items:center;
200 |       justify-content:center;
201 |       padding: 18px;
202 |       z-index: 9999;
203 |     }
204 |     .modalOverlay.show{ display:flex; }
205 |     .modal{
206 |       width: min(640px, 100%);
207 |       border-radius: 16px;
208 |       border: 1px solid rgba(34,48,71,.9);
209 |       background: rgba(18,25,38,.98);
210 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
211 |       padding: 16px;
212 |     }
213 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
214 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
215 |     .modal .modalActions{
216 |       display:flex;
217 |       justify-content:flex-end;
218 |       gap:10px;
219 |       margin-top: 14px;
220 |     }
221 |     .kbd{
222 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
223 |       font-size: 12px;
224 |       opacity:.9;
225 |       padding: 2px 6px;
226 |       border:1px solid rgba(42,58,85,.9);
227 |       border-radius: 8px;
228 |       background: rgba(11,18,32,.55);
229 |     }
230 | 
231 |     @media (max-width: 860px){
232 |       table { min-width: 980px; }
233 |     }
234 |   </style>
235 | </head>
236 | 
237 | <body>
238 |   <h2>FB Watcher ‚Äî Panel</h2>
239 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
240 | 
241 |   <div class="card">
242 |     <div class="row">
243 |       <div style="flex:1; min-width:260px;">
244 |         <label>Token panelu</label>
245 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
246 |       </div>
247 |       <div style="display:flex; gap:10px; align-items:flex-end;">
248 |         <button class="primary" id="saveToken">Zapisz token</button>
249 |         <button id="refresh">Od≈õwie≈º</button>
250 |       </div>
251 |     </div>
252 | 
253 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
254 |   </div>
255 | 
256 |   <div class="card">
257 |     <h3>Ustawienia (.env)</h3>
258 | 
259 |     <div class="row">
260 |       <div style="flex:1; min-width:260px;">
261 |         <label>E-mail Facebook</label>
262 |         <input id="FB_EMAIL" />
263 |       </div>
264 |       <div style="flex:1; min-width:260px;">
265 |         <label>Has≈Ço Facebook</label>
266 |         <input id="FB_PASSWORD" type="password" />
267 |       </div>
268 |     </div>
269 | 
270 |     <label>Webhook (URL)</label>
271 |     <input id="WEBHOOK_URL" />
272 | 
273 |     <div class="row">
274 |       <div style="flex:1; min-width:220px;">
275 |         <label>Interwa≈Ç sprawdzania (ms)</label>
276 |         <input id="CHECK_INTERVAL_MS" />
277 |       </div>
278 |       <div style="flex:2; min-width:260px;">
279 |         <label>Arkusz z postami (CSV export)</label>
280 |         <input id="POSTS_SHEET_URL" />
281 |       </div>
282 |     </div>
283 | 
284 |     <div class="row">
285 |       <div style="flex:1; min-width:220px;">
286 |         <label>Tryb bez okna (headless)</label>
287 |         <select id="HEADLESS_BROWSER">
288 |           <option value="true">true</option>
289 |           <option value="false">false</option>
290 |         </select>
291 |       </div>
292 |       <div style="flex:1; min-width:220px;">
293 |         <label>Obs≈Çuga UI (handlery)</label>
294 |         <select id="USE_UI_HANDLERS">
295 |           <option value="true">true</option>
296 |           <option value="false">false</option>
297 |         </select>
298 |       </div>
299 |       <div style="flex:1; min-width:220px;">
300 |         <label>Uwzglƒôdniaj odpowiedzi</label>
301 |         <select id="INCLUDE_REPLIES">
302 |           <option value="true">true</option>
303 |           <option value="false">false</option>
304 |         </select>
305 |       </div>
306 |     </div>
307 | 
308 |     <div class="row" style="margin-top:10px;">
309 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
310 |       <button id="pm2Start">Start watchera</button>
311 |       <button id="pm2Stop">Stop watchera</button>
312 |       <button id="pm2Restart">Restart watchera</button>
313 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
314 |     </div>
315 | 
316 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
317 |   </div>
318 | 
319 |   <div class="card">
320 |     <h3>Posty (data/posts.json)</h3>
321 | 
322 |     <div class="row">
323 |       <div style="flex:2; min-width:260px;">
324 |         <label>Nowy URL posta</label>
325 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
326 |       </div>
327 | 
328 |       <div style="flex:1; min-width:220px;">
329 |         <label>Nazwa</label>
330 |         <input id="newPostName" placeholder="np. A1" />
331 |       </div>
332 | 
333 |       <div style="flex:1; min-width:260px;">
334 |         <label>URL zdjƒôcia</label>
335 |         <input id="newPostImage" placeholder="https://...jpg" />
336 |       </div>
337 |     </div>
338 | 
339 |     <label>Opis</label>
340 |     <textarea id="newPostDescription" placeholder="Kr√≥tki opis..."></textarea>
341 | 
342 |     <div class="row" style="margin-top:10px;">
343 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
344 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
345 |           <input type="checkbox" id="newPostActive" checked /> aktywny
346 |         </label>
347 |         <button class="primary" id="addPost">Dodaj</button>
348 |       </div>
349 |     </div>
350 | 
351 |     <div style="margin-top:12px;" class="tableWrap">
352 |       <table>
353 |         <thead>
354 |           <tr>
355 |             <th class="col-id">ID</th>
356 |             <th class="col-url">Link</th>
357 |             <th class="col-name">Nazwa</th>
358 |             <th class="col-img">Zdjƒôcie</th>
359 |             <th class="col-desc">Opis</th>
360 |             <th class="col-act">Aktywny</th>
361 |             <th class="col-btn">Akcje</th>
362 |           </tr>
363 |         </thead>
364 |         <tbody id="posts"></tbody>
365 |       </table>
366 |     </div>
367 |   </div>
368 | 
369 |   <div class="card" id="logsCard">
370 |     <div class="row" style="justify-content:space-between; align-items:center;">
371 |       <h3 style="margin:0;">Logi</h3>
372 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
373 |         Rozwi≈Ñ
374 |       </button>
375 |     </div>
376 | 
377 |     <div class="logsBox">
378 |       <div class="row">
379 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
380 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
381 | 
382 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
383 | 
384 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
385 |           <option value="0">auto: wy≈Ç.</option>
386 |           <option value="1000">co 1 s</option>
387 |           <option value="2000" selected>co 2 s</option>
388 |           <option value="5000">co 5 s</option>
389 |           <option value="10000">co 10 s</option>
390 |         </select>
391 | 
392 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
393 | 
394 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
395 |           <input type="checkbox" id="logAutoScroll" checked />
396 |           auto-scroll
397 |         </label>
398 |       </div>
399 | 
400 |       <div class="sep"></div>
401 | 
402 |       <textarea
403 |         id="logs"
404 |         class="mono"
405 |         readonly
406 |         spellcheck="false"
407 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
408 | 
409 |       <div id="logHint" class="muted hint"></div>
410 |     </div>
411 |   </div>
412 | 
413 |   <!-- modal -->
414 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
415 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
416 |       <h4 id="modalTitle">Potwierdzenie</h4>
417 |       <div class="modalBody" id="modalBody"></div>
418 |       <div class="modalActions">
419 |         <button id="modalCancel">Anuluj</button>
420 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
421 |       </div>
422 |       <div class="muted" style="margin-top:10px;">
423 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
424 |       </div>
425 |     </div>
426 |   </div>
427 | 
428 |   <script src="/app.js"></script>
429 | </body>
430 | </html>
431 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // src/fb/ui/index.js
 2 | import * as PostUI from "./post.js";
 3 | import * as PhotoUI from "./photo.js";
 4 | import * as WatchUI from "./watch.js";
 5 | import * as VideosUI from "./videos.js";
 6 | 
 7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
 8 | 
 9 | export function pickUiHandler(url) {
10 |   const u = String(url || "");
11 |   for (const h of HANDLERS) {
12 |     try {
13 |       if (h.matchesUrl(u)) return h;
14 |     } catch {}
15 |   }
16 |   return PostUI;
17 | }
18 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/links.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/config/links.js
  2 | import fs from "fs";
  3 | import path from "path";
  4 | 
  5 | // Je≈õli masz Node <18, odkomentuj te dwie linijki:
  6 | // import fetch from "node-fetch";
  7 | // global.fetch = fetch;
  8 | 
  9 | const LINKS_SHEET_URL = process.env.LINKS_SHEET_URL;
 10 | const LOCAL_FILE = path.join(process.cwd(), "config", "links.json");
 11 | 
 12 | let linksCache = [];
 13 | let lastHash = null;
 14 | 
 15 | /* ============================================
 16 |    Prost y "hash" listy link√≥w
 17 |    ============================================ */
 18 | function calcHash(urls) {
 19 |   return urls.join("|");
 20 | }
 21 | 
 22 | /* ============================================
 23 |    Wczytanie lokalnego pliku JSON
 24 |    ============================================ */
 25 | function loadLinksFromLocalFile() {
 26 |   try {
 27 |     const raw = fs.readFileSync(LOCAL_FILE, "utf8");
 28 |     const data = JSON.parse(raw);
 29 | 
 30 |     if (Array.isArray(data.links)) {
 31 |       const cleaned = data.links
 32 |         .filter((u) => typeof u === "string")
 33 |         .map((u) => u.trim())
 34 |         .filter((u) => u.startsWith("http"));
 35 | 
 36 |       console.log("[CFG] Za≈Çadowane linki z lokalnego pliku:", cleaned);
 37 |       return cleaned;
 38 |     }
 39 | 
 40 |     console.warn("[CFG] Lokalny links.json nie zawiera poprawnego pola 'links'");
 41 |     return [];
 42 |   } catch (err) {
 43 |     console.warn("[CFG] Brak / b≈ÇƒÖd wczytywania links.json:", err.message);
 44 |     return [];
 45 |   }
 46 | }
 47 | 
 48 | /* ============================================
 49 |    Parser CSV z Sheetsa
 50 |    ============================================ */
 51 | function parseCsv(text) {
 52 |   const hasSemicolon = text.includes(";");
 53 |   const delimiter = hasSemicolon ? ";" : ",";
 54 | 
 55 |   const lines = text
 56 |     .split(/\r?\n/)
 57 |     .map((l) => l.trim())
 58 |     .filter(Boolean);
 59 | 
 60 |   if (!lines.length) {
 61 |     return [];
 62 |   }
 63 | 
 64 |   const header = lines[0].split(delimiter).map((h) => h.trim().toLowerCase());
 65 | 
 66 |   const idxActive = header.indexOf("active");
 67 |   const idxUrl = header.indexOf("url");
 68 | 
 69 |   if (idxUrl === -1) {
 70 |     console.warn("[CFG] W CSV nie znaleziono kolumny 'url'");
 71 |     return [];
 72 |   }
 73 | 
 74 |   const rows = [];
 75 | 
 76 |   for (let i = 1; i < lines.length; i++) {
 77 |     const cols = lines[i].split(delimiter).map((c) => c.trim());
 78 | 
 79 |     const url = cols[idxUrl] || "";
 80 |     if (!url || !url.startsWith("http")) continue;
 81 | 
 82 |     let active = true;
 83 | 
 84 |     if (idxActive !== -1) {
 85 |       const val = (cols[idxActive] || "").toLowerCase();
 86 |       active = val === "true" || val === "1" || val === "yes" || val === "y";
 87 |     }
 88 | 
 89 |     if (!active) continue;
 90 | 
 91 |     rows.push(url);
 92 |   }
 93 | 
 94 |   return rows;
 95 | }
 96 | 
 97 | /* ============================================
 98 |    Pobranie link√≥w z Sheeta lub lokalnie
 99 |    ============================================ */
100 | async function fetchLinks() {
101 |   if (!LINKS_SHEET_URL) {
102 |     console.warn("[CFG] Brak LINKS_SHEET_URL w .env ‚Äì u≈ºywam lokalnego pliku");
103 |     return loadLinksFromLocalFile();
104 |   }
105 | 
106 |   try {
107 |     console.log("[CFG] Pobieram linki z Google Sheeta...");
108 |     const res = await fetch(LINKS_SHEET_URL);
109 | 
110 |     if (!res.ok) {
111 |       console.warn("[CFG] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
112 |       return loadLinksFromLocalFile();
113 |     }
114 | 
115 |     const text = await res.text();
116 |     const urls = parseCsv(text);
117 |     const unique = [...new Set(urls)];
118 | 
119 |     // backup
120 |     const payload = { links: unique };
121 |     fs.mkdirSync(path.dirname(LOCAL_FILE), { recursive: true });
122 |     fs.writeFileSync(LOCAL_FILE, JSON.stringify(payload, null, 2), "utf8");
123 |     console.log("[CFG] Zapisano backup do links.json");
124 | 
125 |     return unique;
126 |   } catch (err) {
127 |     console.error("[CFG] B≈ÇƒÖd przy pobieraniu link√≥w z Sheeta:", err.message);
128 |     console.warn("[CFG] Pr√≥ba u≈ºycia lokalnego links.json jako fallback");
129 |     return loadLinksFromLocalFile();
130 |   }
131 | }
132 | 
133 | /* ============================================
134 |    Reload z por√≥wnaniem hashy
135 |    ============================================ */
136 | async function reloadLinks() {
137 |   const urls = await fetchLinks();
138 |   const hash = calcHash(urls);
139 | 
140 |   if (hash === lastHash) {
141 |     console.log("[CFG] Linki bez zmian (hash taki sam)");
142 |     return;
143 |   }
144 | 
145 |   lastHash = hash;
146 |   linksCache = urls;
147 | 
148 |   console.log("[CFG] Zaktualizowane linki:", linksCache);
149 | }
150 | 
151 | /* ============================================
152 |    API eksportowane dla reszty programu
153 |    ============================================ */
154 | export async function initLinks(autoRefreshMs = 0) {
155 |   await reloadLinks(); // pierwszy load
156 | 
157 |   if (autoRefreshMs > 0) {
158 |     console.log(
159 |       `[CFG] Auto-refresh link√≥w co ${Math.round(autoRefreshMs / 1000)}s`
160 |     );
161 | 
162 |     setInterval(() => {
163 |       reloadLinks().catch((err) =>
164 |         console.error("[CFG] B≈ÇƒÖd przy auto-refresh link√≥w:", err.message)
165 |       );
166 |     }, autoRefreshMs);
167 |   }
168 | }
169 | 
170 | export function getLinks() {
171 |   return linksCache;
172 | }
173 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/links.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
1 | {
2 |   "links": [
3 |     "https://www.facebook.com/post1",
4 |     "https://www.facebook.com/post2"
5 |   ]
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/login.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/login.js
  2 | import { sleepRandom } from "../utils/sleep.js";
  3 | 
  4 | /**
  5 |  * Akceptuje popup cookies na stronie logowania FB.
  6 |  * Szuka przycisku po tek≈õcie, oznacza go data-atrybutem i klika z poziomu Puppeteera.
  7 |  */
  8 | async function acceptLoginCookies(page) {
  9 |   try {
 10 |     console.log("[FB][login-cookies] Szukam popupu cookies...");
 11 | 
 12 |     // chwila na pojawienie siƒô popupu
 13 |     await sleepRandom(800, 1300);
 14 | 
 15 |     const found = await page.evaluate(() => {
 16 |       const wanted = [
 17 |         "Zezw√≥l na wszystkie pliki cookie",
 18 |         "Zezw√≥l na wszystkie pliki",
 19 |         "Allow all cookies",
 20 |         "Odrzuƒá opcjonalne pliki cookie",
 21 |         "Odrzuc opcjonalne pliki cookie",
 22 |       ].map((t) => t.toLowerCase());
 23 | 
 24 |       const buttons = Array.from(
 25 |         document.querySelectorAll("button, [role='button']")
 26 |       );
 27 | 
 28 |       let marked = false;
 29 | 
 30 |       for (const btn of buttons) {
 31 |         const txt = (btn.innerText || btn.textContent || "").trim();
 32 |         if (!txt) continue;
 33 |         const low = txt.toLowerCase();
 34 | 
 35 |         if (wanted.some((w) => low.includes(w))) {
 36 |           btn.setAttribute("data-fb-cookie-btn", "1");
 37 |           marked = true;
 38 |           break;
 39 |         }
 40 |       }
 41 | 
 42 |       return marked;
 43 |     });
 44 | 
 45 |     if (!found) {
 46 |       console.log(
 47 |         "[FB][login-cookies] Nie znaleziono przycisku cookies (po tek≈õcie)."
 48 |       );
 49 |       return false;
 50 |     }
 51 | 
 52 |     await page.click('[data-fb-cookie-btn="1"]');
 53 |     console.log(
 54 |       '[FB][login-cookies] Klikniƒôto przycisk cookies przez Puppeteera (data-fb-cookie-btn="1").'
 55 |     );
 56 | 
 57 |     await sleepRandom(1200, 2000);
 58 |     return true;
 59 |   } catch (err) {
 60 |     console.log("[FB][login-cookies] B≈ÇƒÖd:", err.message);
 61 |     return false;
 62 |   }
 63 | }
 64 | 
 65 | /**
 66 |  * Pr pr√≥ba zalogowania siƒô na **dowolnym widocznym formularzu logowania**:
 67 |  * - pasek u g√≥ry,
 68 |  * - pe≈Çna strona logowania,
 69 |  * - popup "Wy≈õwietl wiƒôcej na Facebooku".
 70 |  */
 71 | async function loginViaVisibleForm(page, context = "visible-form") {
 72 |   try {
 73 |     console.log(`[FB][login-form] Szukam formularza logowania (${context})...`);
 74 | 
 75 |     // Spr√≥buj ogarnƒÖƒá ewentualne cookies na logowaniu
 76 |     await acceptLoginCookies(page).catch(() => {});
 77 | 
 78 |     const emailSelector = [
 79 |       "input#email",
 80 |       "input[name='email']",
 81 |       "input[name='email_or_phone']",
 82 |       "input[aria-label*='Adres e-mail']",
 83 |       "input[placeholder*='Adres e-mail']",
 84 |       "input[placeholder*='adres e-mail']",
 85 |       "input[placeholder*='Email']",
 86 |       "input[placeholder*='email']",
 87 |     ].join(",");
 88 | 
 89 |     const passSelector = [
 90 |       "input#pass",
 91 |       "input[name='pass']",
 92 |       "input[aria-label*='Has≈Ço']",
 93 |       "input[placeholder*='Has≈Ço']",
 94 |       "input[placeholder*='has≈Ço']",
 95 |       "input[placeholder*='Password']",
 96 |       "input[placeholder*='password']",
 97 |     ].join(",");
 98 | 
 99 |     const emailInput = await page.$(emailSelector);
100 |     const passInput = await page.$(passSelector);
101 | 
102 |     if (!emailInput || !passInput) {
103 |       console.log(
104 |         "[FB][login-form] Brak pe≈Çnego formularza (email + has≈Ço) na stronie."
105 |       );
106 |       return false;
107 |     }
108 | 
109 |     const email = process.env.FB_EMAIL || "";
110 |     const password = process.env.FB_PASSWORD || "";
111 | 
112 |     if (!email || !password) {
113 |       console.error(
114 |         "[FB][login-form] Brak FB_EMAIL / FB_PASSWORD w zmiennych ≈õrodowiskowych."
115 |       );
116 |       return false;
117 |     }
118 | 
119 |     console.log("[FB][login-form] Wype≈Çniam email/has≈Ço...");
120 | 
121 |     // wyczy≈õƒá i wpisz email
122 |     await emailInput.click({ clickCount: 3 });
123 |     await page.keyboard.press("Backspace");
124 |     await emailInput.type(email, { delay: 50 });
125 | 
126 |     // wyczy≈õƒá i wpisz has≈Ço
127 |     await passInput.click({ clickCount: 3 });
128 |     await page.keyboard.press("Backspace");
129 |     await passInput.type(password, { delay: 50 });
130 | 
131 |     const loginButton =
132 |       (await page.$("button[name='login']")) ||
133 |       (await page.$("button[type='submit']"));
134 | 
135 |     if (!loginButton) {
136 |       console.log("[FB][login-form] Nie znalaz≈Çem przycisku logowania.");
137 |       return false;
138 |     }
139 | 
140 |     console.log("[FB][login-form] Klikam Zaloguj siƒô‚Ä¶");
141 | 
142 |     await Promise.all([
143 |       loginButton.click(),
144 |       page
145 |         .waitForNavigation({
146 |           waitUntil: "networkidle2",
147 |           timeout: 60000,
148 |         })
149 |         .catch(() => {}),
150 |     ]);
151 | 
152 |     await sleepRandom(1500, 2500);
153 |     console.log("[FB][login-form] Formularz logowania wys≈Çany.");
154 |     return true;
155 |   } catch (err) {
156 |     console.error("[FB][login-form] B≈ÇƒÖd:", err.message);
157 |     return false;
158 |   }
159 | }
160 | 
161 | /**
162 |  * G≈Ç√≥wne logowanie na FB ‚Äì klasyczne /login.
163 |  */
164 | async function fbLogin(page) {
165 |   console.log("[FB][login] Start logowania‚Ä¶");
166 | 
167 |   await page.goto("https://www.facebook.com/login", {
168 |     waitUntil: "networkidle2",
169 |     timeout: 60000,
170 |   });
171 | 
172 |   // popup cookies ‚Äì pr√≥bujemy go zamknƒÖƒá zanim dotkniemy input√≥w
173 |   await acceptLoginCookies(page);
174 | 
175 |   console.log("[FB][login] Czekam na input email/pass...");
176 | 
177 |   await page.waitForSelector("#email", { timeout: 60000 });
178 |   await page.waitForSelector("#pass", { timeout: 60000 });
179 | 
180 |   // jeszcze raz sprawd≈∫, czy cookies nie wyskoczy≈Çy ponownie
181 |   await acceptLoginCookies(page);
182 | 
183 |   console.log("[FB][login] Wpisujƒô email...");
184 |   await page.type("#email", process.env.FB_EMAIL || "", { delay: 60 });
185 | 
186 |   console.log("[FB][login] Wpisujƒô has≈Ço...");
187 |   await page.type("#pass", process.env.FB_PASSWORD || "", { delay: 60 });
188 | 
189 |   console.log("[FB][login] Klikam Zaloguj siƒô‚Ä¶");
190 | 
191 |   await Promise.all([
192 |     page.click('button[name="login"]'),
193 |     page
194 |       .waitForNavigation({
195 |         waitUntil: "networkidle2",
196 |         timeout: 60000,
197 |       })
198 |       .catch(() => {}),
199 |   ]);
200 | 
201 |   console.log("[FB] Po logowaniu:", page.url());
202 | }
203 | 
204 | /**
205 |  * Szybki check, czy jeste≈õmy zalogowani.
206 |  */
207 | async function checkIfLogged(page) {
208 |   return page.evaluate(() => {
209 |     const selectors = [
210 |       'input[aria-label*="Szukaj"]',
211 |       'input[placeholder*="Szukaj"]',
212 |       'a[aria-label*="Profil"]',
213 |       'div[aria-label*="Konto"]',
214 |     ];
215 |     return selectors.some((sel) => document.querySelector(sel));
216 |   });
217 | }
218 | 
219 | /**
220 |  * Klikniƒôcie elementu (button / link) po dok≈Çadnym tek≈õcie ‚Äì po stronie DOM.
221 |  * U≈ºywane np. w nak≈Çadce ‚ÄûWy≈õwietl wiƒôcej na Facebooku‚Äù.
222 |  */
223 | async function clickByText(page, text) {
224 |   const res = await page.evaluate((label) => {
225 |     const els = Array.from(
226 |       document.querySelectorAll("button, a, div[role='button']")
227 |     );
228 |     const lowLabel = label.toLowerCase();
229 |     for (const el of els) {
230 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
231 |       if (!t) continue;
232 |       if (t === lowLabel) {
233 |         el.click();
234 |         return true;
235 |       }
236 |     }
237 |     return false;
238 |   }, text);
239 |   return res;
240 | }
241 | 
242 | /**
243 |  * Je≈ºeli na po≈õcie pojawi siƒô nak≈Çadka z przyciskiem ‚ÄûZaloguj siƒô / Log In‚Äù
244 |  * ‚Äì pr√≥bujemy zalogowaƒá siƒô **na miejscu**.
245 |  */
246 | async function ensureLoggedInOnPostOverlay(page) {
247 |   const overlayDetected = await page.evaluate(() => {
248 |     const texts = Array.from(
249 |       document.querySelectorAll("div, span, h1, h2, h3, button, a")
250 |     )
251 |       .map((el) => (el.textContent || "").trim())
252 |       .filter(Boolean);
253 | 
254 |     return texts.some((t) => {
255 |       const low = t.toLowerCase();
256 |       return (
257 |         low.includes("wy≈õwietl wiƒôcej na facebooku") ||
258 |         low.includes("zobacz wiƒôcej na facebooku") ||
259 |         low.includes("see more on facebook")
260 |       );
261 |     });
262 |   });
263 | 
264 |   if (!overlayDetected) return;
265 | 
266 |   console.log(
267 |     "[FB] Wykryto nak≈Çadkƒô / okno logowania na po≈õcie ‚Äì pr√≥ba zalogowania."
268 |   );
269 | 
270 |   // 1) Najpierw spr√≥buj po prostu zalogowaƒá siƒô na widocznym formularzu
271 |   const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
272 |   if (usedInline) {
273 |     const logged = await checkIfLogged(page);
274 |     if (logged) {
275 |       console.log(
276 |         "[FB] Uda≈Ço siƒô zalogowaƒá z poziomu nak≈Çadki posta (inline formularz)."
277 |       );
278 |       return;
279 |     }
280 |   }
281 | 
282 |   // 2) Fallback ‚Äì klikamy "Zaloguj siƒô" / "Log In", je≈õli jest osobny przycisk
283 |   let clicked = await clickByText(page, "Zaloguj siƒô");
284 |   if (!clicked) {
285 |     clicked = await clickByText(page, "Log In");
286 |   }
287 | 
288 |   if (clicked) {
289 |     console.log(
290 |       "[FB] Klikniƒôto przycisk logowania w nak≈Çadce posta. Czekam na prze≈Çadowanie..."
291 |     );
292 |     await sleepRandom(4000, 6000);
293 | 
294 |     // Po prze≈Çadowaniu znowu spr√≥buj formularza, tym razem ju≈º na pe≈Çnej stronie logowania
295 |     const used = await loginViaVisibleForm(page, "post-overlay-after-click");
296 |     if (used) {
297 |       const logged = await checkIfLogged(page);
298 |       if (logged) {
299 |         console.log("[FB] Zalogowano po klikniƒôciu przycisku w nak≈Çadce.");
300 |       } else {
301 |         console.log(
302 |           "[FB] Formularz po nak≈Çadce wys≈Çany, ale nadal nie widaƒá zalogowanej sesji."
303 |         );
304 |       }
305 |     } else {
306 |       console.log(
307 |         "[FB] Po klikniƒôciu przycisku w nak≈Çadce nie znalaz≈Çem formularza logowania."
308 |       );
309 |     }
310 |   } else {
311 |     console.log(
312 |       "[FB] Nie uda≈Ço siƒô znale≈∫ƒá przycisku logowania w nak≈Çadce posta."
313 |     );
314 |   }
315 | }
316 | 
317 | export {
318 |   fbLogin,
319 |   checkIfLogged,
320 |   ensureLoggedInOnPostOverlay,
321 |   clickByText,
322 |   acceptLoginCookies,
323 |   loginViaVisibleForm,
324 | };
325 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/navigation.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // src/utils/navigation.js
 2 | import { sleepRandom } from "./sleep.js";
 3 | 
 4 | /**
 5 |  * Bezpieczne page.goto z retry.
 6 |  * - pr√≥buje kilka razy
 7 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
 8 |  */
 9 | export async function safeGoto(page, url, label = "goto", options = {}) {
10 |   const MAX_ATTEMPTS = 3;
11 | 
12 |   const finalOptions = {
13 |     waitUntil: "networkidle2",
14 |     timeout: 90000, // 90s
15 |     ...options,
16 |   };
17 | 
18 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
19 |     try {
20 |       console.log(
21 |         `[NAV] (${label}) pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`
22 |       );
23 | 
24 |   // === FORCE DESKTOP PROFILE (SERVER FIX) ===
25 |   await page.setViewport({ width: 1366, height: 768 });
26 | // DISABLED UA // === END FORCE DESKTOP PROFILE ===
27 | 
28 |       await page.goto(url, finalOptions);
29 | 
30 |       console.log(`[NAV] (${label}) OK na pr√≥bie ${attempt}`);
31 |       return true;
32 |     } catch (err) {
33 |       console.error(
34 |         `[NAV] (${label}) b≈ÇƒÖd na pr√≥bie ${attempt}:`,
35 |         err.message
36 |       );
37 | 
38 |       if (attempt === MAX_ATTEMPTS) {
39 |         // sygna≈Ç dla wy≈ºej: to ju≈º nie jest chwilowy lag
40 |         return false;
41 |       }
42 | 
43 |       // chwila przerwy
44 |       await sleepRandom(3000, 7000);
45 | 
46 |       // pr√≥ba ‚Äûprzep≈Çukania‚Äù sesji ‚Äì wej≈õcie na FB
47 |       try {
48 |         console.log("[NAV] pr√≥ba od≈õwie≈ºenia FB (strona g≈Ç√≥wna)...");
49 |         await page
50 |           .goto("https://www.facebook.com/", {
51 |             waitUntil: "load",
52 |             timeout: 45000,
53 |           })
54 |           .catch(() => {});
55 |       } catch (e2) {
56 |         console.error(
57 |           "[NAV] od≈õwie≈ºenie FB te≈º polecia≈Ço b≈Çƒôdem:",
58 |           e2.message
59 |         );
60 |       }
61 |     }
62 |   }
63 | 
64 |   // tu w praktyce nie dojdziemy
65 |   return false;
66 | }
67 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/package.json`
**Typ:** JSON  
**Opis:** Metadane projektu i zale≈ºno≈õci (npm).  

```json
 1 | 
 2 | {
 3 |   "name": "fb_puppeteer",
 4 |   "version": "1.0.0",
 5 |   "description": "Watcher komentarzy FB + webhook do Make",
 6 |   "main": "src/index.js",
 7 |   "type": "module",
 8 |   "scripts": {
 9 |     "start": "node src/index.js"
10 |   },
11 |   "keywords": [],
12 |   "author": "",
13 |   "license": "ISC",
14 |   "dependencies": {
15 |     "axios": "^1.13.2",
16 |     "dotenv": "^17.2.3",
17 |     "puppeteer": "^24.31.0"
18 |   }
19 | }
20 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/photo.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
   1 | // src/fb/ui/photo.js
   2 | import { safeGoto } from "../../utils/navigation.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { scrollPost } from "../scroll.js";
   5 | import { acceptCookies, saveCookies } from "../cookies.js";
   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
   7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
   8 | 
   9 | export const type = "photo";
  10 | 
  11 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
  12 | 
  13 | /**
  14 |  * WA≈ªNE:
  15 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
  16 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
  17 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
  18 |  */
  19 | const PACE_CFG =
  20 |   PACE === "server"
  21 |     ? {
  22 |         // delikatnie wolniej na serwerze (render/CPU)
  23 |         stepJitterMinMs: 140,
  24 |         stepJitterMaxMs: 260,
  25 | 
  26 |         afterScrollMinMs: 260,
  27 |         afterScrollMaxMs: 520,
  28 | 
  29 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
  30 |         effectWaitMs: 5200,
  31 | 
  32 |         scrollPx: 140,
  33 | 
  34 |         // bonusowe kliki, ale event-driven
  35 |         bonusClickTries: 2,
  36 |         bonusClickDelayMinMs: 120,
  37 |         bonusClickDelayMaxMs: 220,
  38 | 
  39 |         // HARD BOTTOM (sprawdzane rzadko)
  40 |         hardBottomEpsPx: 10,
  41 |         hardBottomStableNeed: 4,
  42 |         hardBottomStableDelayMinMs: 320,
  43 |         hardBottomStableDelayMaxMs: 560,
  44 |       }
  45 |     : {
  46 |         // lokalnie szybciej
  47 |         stepJitterMinMs: 90,
  48 |         stepJitterMaxMs: 190,
  49 | 
  50 |         afterScrollMinMs: 180,
  51 |         afterScrollMaxMs: 420,
  52 | 
  53 |         effectWaitMs: 4200,
  54 | 
  55 |         scrollPx: 160,
  56 | 
  57 |         bonusClickTries: 2,
  58 |         bonusClickDelayMinMs: 90,
  59 |         bonusClickDelayMaxMs: 180,
  60 | 
  61 |         hardBottomEpsPx: 10,
  62 |         hardBottomStableNeed: 4,
  63 |         hardBottomStableDelayMinMs: 240,
  64 |         hardBottomStableDelayMaxMs: 420,
  65 |       };
  66 | 
  67 | export function matchesUrl(url) {
  68 |   try {
  69 |     const u = new URL(url);
  70 |     const path = (u.pathname || "").toLowerCase();
  71 | 
  72 |     if (path.includes("photo.php")) return true;
  73 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
  74 |     if (u.searchParams.has("fbid")) return true;
  75 | 
  76 |     return false;
  77 |   } catch {
  78 |     const lower = (url || "").toLowerCase();
  79 |     if (lower.includes("photo.php")) return true;
  80 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
  81 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
  82 |     return false;
  83 |   }
  84 | }
  85 | 
  86 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
  87 | 
  88 | async function clickAllCommentsInMenu(page) {
  89 |   const result = await page.evaluate(() => {
  90 |     const menu =
  91 |       document.querySelector("div[role='menu']") ||
  92 |       document.querySelector("div[role='dialog']");
  93 | 
  94 |     if (!menu) return { clicked: false, noMenu: true };
  95 | 
  96 |     const items = Array.from(
  97 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
  98 |     );
  99 | 
 100 |     const opt = items.find((el) => {
 101 |       const t = (el.textContent || "").trim().toLowerCase();
 102 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
 103 |     });
 104 | 
 105 |     if (!opt) return { clicked: false, noMenu: false };
 106 | 
 107 |     opt.click();
 108 |     setTimeout(() => {
 109 |       try {
 110 |         document.body.click();
 111 |       } catch {}
 112 |     }, 50);
 113 | 
 114 |     return { clicked: true, noMenu: false };
 115 |   });
 116 | 
 117 |   if (result.clicked) {
 118 |     await sleepRandom(180, 320);
 119 |     await page
 120 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
 121 |       .catch(() => {});
 122 |   }
 123 | 
 124 |   return result;
 125 | }
 126 | 
 127 | async function switchCommentsFilterToAll(page) {
 128 |   console.log("[FB][ui:photo][filter] switch -> all comments");
 129 | 
 130 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 131 |   if (menuAlreadyOpen) {
 132 |     const r = await clickAllCommentsInMenu(page);
 133 |     return !!r.clicked;
 134 |   }
 135 | 
 136 |   const pre = await page.evaluate(() => {
 137 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 138 |     let filterEl = null;
 139 |     let labelText = "";
 140 | 
 141 |     for (const el of els) {
 142 |       const t = (el.textContent || "").trim();
 143 |       if (!t) continue;
 144 |       const low = t.toLowerCase();
 145 |       if (
 146 |         low === "najtrafniejsze" ||
 147 |         low === "most relevant" ||
 148 |         low === "wszystkie komentarze" ||
 149 |         low === "all comments"
 150 |       ) {
 151 |         filterEl = el;
 152 |         labelText = low;
 153 |         break;
 154 |       }
 155 |     }
 156 | 
 157 |     if (!filterEl) return { state: "not-found" };
 158 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 159 |       return { state: "already-all" };
 160 |     }
 161 | 
 162 |     filterEl.click();
 163 |     return { state: "clicked-filter" };
 164 |   });
 165 | 
 166 |   if (pre.state === "not-found") return false;
 167 |   if (pre.state === "already-all") return true;
 168 | 
 169 |   await sleepRandom(120, 220);
 170 |   const r = await clickAllCommentsInMenu(page);
 171 |   if (r.clicked) return true;
 172 | 
 173 |   const afterLabelIsAll = await page.evaluate(() => {
 174 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 175 |     return els.some((el) => {
 176 |       const t = (el.textContent || "").trim().toLowerCase();
 177 |       return t === "wszystkie komentarze" || t === "all comments";
 178 |     });
 179 |   });
 180 | 
 181 |   return afterLabelIsAll;
 182 | }
 183 | 
 184 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
 185 | 
 186 | async function getCommentsRootHandle(page) {
 187 |   const handle = await page.evaluateHandle(() => {
 188 |     const norm = (s) =>
 189 |       String(s || "")
 190 |         .replace(/\u00a0/g, " ")
 191 |         .replace(/\s+/g, " ")
 192 |         .trim()
 193 |         .toLowerCase();
 194 | 
 195 |     const isVisible = (el) => {
 196 |       if (!el) return false;
 197 |       try {
 198 |         const r = el.getBoundingClientRect();
 199 |         return r.width > 2 && r.height > 2;
 200 |       } catch {
 201 |         return true;
 202 |       }
 203 |     };
 204 | 
 205 |     const isMoreCommentsBtn = (el) => {
 206 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 207 |       if (!t) return false;
 208 |       return (
 209 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 210 |         t.includes("zobacz wiƒôcej komentarzy") ||
 211 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
 212 |         t.includes("view more comments") ||
 213 |         t.includes("view previous comments")
 214 |       );
 215 |     };
 216 | 
 217 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
 218 |       isVisible
 219 |     );
 220 |     const keyBtn = btns.find(isMoreCommentsBtn);
 221 | 
 222 |     if (keyBtn) {
 223 |       const dlg = keyBtn.closest?.("div[role='dialog']");
 224 |       if (dlg) return dlg;
 225 | 
 226 |       let cur = keyBtn.parentElement;
 227 |       for (let i = 0; i < 20 && cur; i++) {
 228 |         if (cur.matches?.("article,main,section,div")) return cur;
 229 |         cur = cur.parentElement;
 230 |       }
 231 |     }
 232 | 
 233 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 234 |     const dlg2 = dialogs.find((d) => {
 235 |       const t = norm(d.innerText || d.textContent);
 236 |       if (!t) return false;
 237 |       if (t.includes("powiadomienia")) return false;
 238 |       if (t.includes("szukaj znajomych")) return false;
 239 |       return (
 240 |         t.includes("najtrafniejsze") ||
 241 |         t.includes("most relevant") ||
 242 |         t.includes("komentarz") ||
 243 |         t.includes("comment")
 244 |       );
 245 |     });
 246 |     if (dlg2) return dlg2;
 247 | 
 248 |     return document.body;
 249 |   });
 250 | 
 251 |   return handle;
 252 | }
 253 | 
 254 | async function getCommentsScrollHandle(page, rootHandle) {
 255 |   const handle = await page.evaluateHandle((root) => {
 256 |     const isVisible = (el) => {
 257 |       if (!el) return false;
 258 |       try {
 259 |         const r = el.getBoundingClientRect();
 260 |         return r.width > 2 && r.height > 2;
 261 |       } catch {
 262 |         return true;
 263 |       }
 264 |     };
 265 | 
 266 |     const canScrollByTest = (el) => {
 267 |       try {
 268 |         if (!el) return false;
 269 |         const h = el.clientHeight || 0;
 270 |         const sh = el.scrollHeight || 0;
 271 |         if (sh <= h + 40) return false;
 272 | 
 273 |         const before = el.scrollTop ?? 0;
 274 |         el.scrollTop = before + 80;
 275 |         const after = el.scrollTop ?? before;
 276 |         el.scrollTop = before;
 277 | 
 278 |         return after !== before;
 279 |       } catch {
 280 |         return false;
 281 |       }
 282 |     };
 283 | 
 284 |     const closestScrollable = (start) => {
 285 |       let cur = start;
 286 |       for (let i = 0; i < 28 && cur; i++) {
 287 |         if (canScrollByTest(cur)) return cur;
 288 |         cur = cur.parentElement;
 289 |       }
 290 |       return null;
 291 |     };
 292 | 
 293 |     const scope = root || document;
 294 | 
 295 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
 296 |     if (outer) {
 297 |       const sc = closestScrollable(outer);
 298 |       if (sc) return sc;
 299 |     }
 300 | 
 301 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
 302 |       .filter(isVisible)
 303 |       .slice(0, 25000);
 304 | 
 305 |     let best = null;
 306 |     let bestDelta = -1;
 307 |     for (const el of candidates) {
 308 |       if (!canScrollByTest(el)) continue;
 309 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
 310 |       if (delta > bestDelta) {
 311 |         bestDelta = delta;
 312 |         best = el;
 313 |       }
 314 |     }
 315 | 
 316 |     return best || null;
 317 |   }, rootHandle);
 318 | 
 319 |   return handle;
 320 | }
 321 | 
 322 | /* ======================================================================== */
 323 | 
 324 | export async function prepare(page, url) {
 325 |   console.log(`[FB][ui:photo] prepare: ${url}`);
 326 | 
 327 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 328 |   if (!ok) throw new Error("safeGoto-failed");
 329 | 
 330 |   if (page.url().includes("/login")) {
 331 |     console.log("[FB][ui:photo] /login ‚Äì fbLogin + re-enter.");
 332 |     await fbLogin(page);
 333 |     await sleepRandom(2500, 4000);
 334 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 335 |   }
 336 | 
 337 |   await acceptCookies(page, "photo-initial");
 338 | 
 339 |   const logged = await checkIfLogged(page).catch(() => false);
 340 |   if (!logged) {
 341 |     console.log("[FB][ui:photo] not logged ‚Äì fbLogin().");
 342 |     await fbLogin(page);
 343 |     await sleepRandom(2500, 4000);
 344 |   }
 345 | 
 346 |   await ensureLoggedInOnPostOverlay(page);
 347 |   await acceptCookies(page, "photo");
 348 | 
 349 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
 350 |   if (loggedFinal) await saveCookies(page);
 351 | }
 352 | 
 353 | function parseNumberLikeNode(str) {
 354 |   if (!str) return null;
 355 | 
 356 |   const cleaned = String(str)
 357 |     .toLowerCase()
 358 |     .replace(/\u00a0/g, " ")
 359 |     .replace(/\s+/g, " ")
 360 |     .trim();
 361 | 
 362 |   const plain = cleaned.replace(/[^\d]/g, "");
 363 |   if (/^\d+$/.test(plain)) {
 364 |     const n = Number(plain);
 365 |     return Number.isFinite(n) ? n : null;
 366 |   }
 367 | 
 368 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 369 |   if (m) {
 370 |     const base = Number(m[1].replace(",", "."));
 371 |     if (Number.isFinite(base)) return Math.round(base * 1000);
 372 |   }
 373 | 
 374 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 375 |   if (m2) {
 376 |     const base = Number(m2[1].replace(",", "."));
 377 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
 378 |   }
 379 | 
 380 |   return null;
 381 | }
 382 | 
 383 | async function getPhotoUiCountFromChip(page, rootHandle) {
 384 |   const res = await page
 385 |     .evaluate((root) => {
 386 |       const scope = root || document;
 387 | 
 388 |       const norm = (s) =>
 389 |         String(s || "")
 390 |           .replace(/\u00a0/g, " ")
 391 |           .replace(/\s+/g, " ")
 392 |           .trim();
 393 | 
 394 |       const parseNum = (s) => {
 395 |         const t = norm(s);
 396 |         if (!t) return null;
 397 | 
 398 |         const plain = t.replace(/[^\d]/g, "");
 399 |         if (/^\d+$/.test(plain)) return Number(plain);
 400 | 
 401 |         const lower = t.toLowerCase();
 402 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 403 |         if (m) {
 404 |           const base = Number(m[1].replace(",", "."));
 405 |           if (Number.isFinite(base)) return Math.round(base * 1000);
 406 |         }
 407 | 
 408 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 409 |         if (m2) {
 410 |           const base = Number(m2[1].replace(",", "."));
 411 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
 412 |         }
 413 | 
 414 |         return null;
 415 |       };
 416 | 
 417 |       const isVisible = (el) => {
 418 |         if (!el) return false;
 419 |         const r = el.getBoundingClientRect();
 420 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
 421 |       };
 422 | 
 423 |       const commentBtn = Array.from(
 424 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
 425 |       ).find((el) => {
 426 |         const t = norm(el.textContent).toLowerCase();
 427 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
 428 |       });
 429 | 
 430 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
 431 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
 432 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
 433 | 
 434 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
 435 |         .filter(isVisible)
 436 |         .slice(0, 5000);
 437 | 
 438 |       let best = null;
 439 |       let bestScore = -Infinity;
 440 | 
 441 |       for (const el of candidates) {
 442 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
 443 |         if (!hasIcon) continue;
 444 | 
 445 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
 446 |         let num = null;
 447 |         let raw = null;
 448 | 
 449 |         for (const sp of spans) {
 450 |           const t = norm(sp.textContent);
 451 |           if (!t) continue;
 452 |           if (t.length > 24) continue;
 453 | 
 454 |           const n = parseNum(t);
 455 |           if (typeof n === "number" && Number.isFinite(n)) {
 456 |             if (n <= 0 || n > 10000000) continue;
 457 |             num = n;
 458 |             raw = t;
 459 |             break;
 460 |           }
 461 |         }
 462 | 
 463 |         if (num == null) continue;
 464 | 
 465 |         const r = el.getBoundingClientRect();
 466 |         const cx = r.left + r.width / 2;
 467 |         const cy = r.top + r.height / 2;
 468 | 
 469 |         let score = 0;
 470 | 
 471 |         if (anchorCx != null && anchorCy != null) {
 472 |           const dx = cx - anchorCx;
 473 |           const dy = cy - anchorCy;
 474 |           const dist = Math.sqrt(dx * dx + dy * dy);
 475 |           score -= dist;
 476 |         }
 477 | 
 478 |         const textLen = norm(el.textContent).length;
 479 |         score -= Math.min(400, textLen);
 480 | 
 481 |         score += Math.min(200, Math.log10(num + 1) * 120);
 482 | 
 483 |         if (score > bestScore) {
 484 |           bestScore = score;
 485 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
 486 |         }
 487 |       }
 488 | 
 489 |       return best;
 490 |     }, rootHandle)
 491 |     .catch(() => null);
 492 | 
 493 |   if (!res || typeof res.count !== "number") return null;
 494 |   return { count: res.count, raw: res.raw, dbg: res };
 495 | }
 496 | 
 497 | export async function getCommentCount(page, url) {
 498 |   console.log("[FB][ui:photo] getCommentCount‚Ä¶");
 499 | 
 500 |   await scrollPost(page, 220);
 501 |   await sleepRandom(220, 420);
 502 | 
 503 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
 504 |   console.log(`[FB][ui:photo] filter all comments: ${okFilter}`);
 505 | 
 506 |   // mikro settle po filtrze (bez mulenia)
 507 |   await sleepRandom(220, 420);
 508 | 
 509 |   const rootHandle = await getCommentsRootHandle(page);
 510 | 
 511 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
 512 |   if (chip?.count != null) {
 513 |     console.log("[FB][ui:photo] UI count (chip):", chip);
 514 |   }
 515 | 
 516 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
 517 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
 518 | 
 519 |   const loaded = await page
 520 |     .evaluate((root) => {
 521 |       const scope = root || document;
 522 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 523 |       const ids = new Set();
 524 |       for (const a of as) {
 525 |         const href = a.getAttribute("href") || "";
 526 |         const m = href.match(/comment_id=([^&]+)/);
 527 |         if (m && m[1]) ids.add(m[1]);
 528 |       }
 529 |       return ids.size || null;
 530 |     }, rootHandle)
 531 |     .catch(() => null);
 532 | 
 533 |   let total = null;
 534 |   let source = "none";
 535 | 
 536 |   if (chip?.count != null) {
 537 |     total = chip.count;
 538 |     source = "ui-photo-chip";
 539 |   } else if (infoCount != null) {
 540 |     total = infoCount;
 541 |     source = uiInfo?.source || "uicommentinfo";
 542 |   } else if (loaded != null) {
 543 |     total = loaded;
 544 |     source = "loaded-comment_id";
 545 |   }
 546 | 
 547 |   console.log("[FB][ui:photo] UI comments:", {
 548 |     source,
 549 |     chip: chip?.count ?? null,
 550 |     uiInfoSource: uiInfo?.source ?? null,
 551 |     uiInfoRaw: uiInfo?.raw ?? null,
 552 |     uiInfoCount: infoCount,
 553 |     loaded,
 554 |     chosen: total,
 555 |   });
 556 | 
 557 |   try {
 558 |     await rootHandle.dispose?.();
 559 |   } catch {}
 560 | 
 561 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
 562 |   await sleepRandom(180, 340);
 563 | 
 564 |   return total;
 565 | }
 566 | 
 567 | export async function loadAllComments(page, { expectedTotal } = {}) {
 568 |   console.log(`[FB][ui:photo] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
 569 | 
 570 |   const MAX_STEPS = 900;
 571 |   const MAX_NO_PROGRESS = 28;
 572 | 
 573 |   let noProgress = 0;
 574 | 
 575 |   const rootHandle = await getCommentsRootHandle(page);
 576 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
 577 | 
 578 |   const shortBtn = (t) => {
 579 |     const s = String(t || "").replace(/\s+/g, " ").trim();
 580 |     if (s.length <= 90) return s;
 581 |     return s.slice(0, 90) + "‚Ä¶";
 582 |   };
 583 | 
 584 |   async function countAnchors() {
 585 |     return page.evaluate((root) => {
 586 |       const scope = root || document;
 587 | 
 588 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 589 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
 590 | 
 591 |       const uniq = (arr, param) => {
 592 |         const ids = new Set();
 593 |         for (const a of arr) {
 594 |           const href = a.getAttribute("href") || "";
 595 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
 596 |           if (m && m[1]) ids.add(m[1]);
 597 |         }
 598 |         return ids.size;
 599 |       };
 600 | 
 601 |       return {
 602 |         commentsAnchors: uniq(commentAs, "comment_id"),
 603 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
 604 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
 605 |       };
 606 |     }, rootHandle);
 607 |   }
 608 | 
 609 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
 610 |     try {
 611 |       const info = await page.evaluate((root, scroller, px) => {
 612 |         const pick =
 613 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
 614 | 
 615 |         const before =
 616 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 617 | 
 618 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
 619 |         else window.scrollBy(0, px);
 620 | 
 621 |         const after =
 622 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 623 | 
 624 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
 625 |       }, rootHandle, scrollHandle, pixels);
 626 | 
 627 |       if (!info?.moved) {
 628 |         console.log(
 629 |           `[FB][ui:photo][scroll] NO-MOVE tag=${info?.tag} before=${info?.before} after=${info?.after}`
 630 |         );
 631 |       }
 632 |     } catch {
 633 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
 634 |     }
 635 | 
 636 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
 637 |   }
 638 | 
 639 |   async function getScrollMetrics() {
 640 |     return page.evaluate((root, scroller) => {
 641 |       const pick =
 642 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 643 | 
 644 |       const isEl = pick && typeof pick.scrollHeight === "number";
 645 | 
 646 |       if (!isEl) {
 647 |         const se = document.scrollingElement || document.documentElement || document.body;
 648 |         return {
 649 |           tag: "WINDOW",
 650 |           scrollTop: window.scrollY || 0,
 651 |           scrollHeight: se?.scrollHeight || 0,
 652 |           clientHeight: window.innerHeight || 0,
 653 |         };
 654 |       }
 655 | 
 656 |       return {
 657 |         tag: pick.tagName || "UNKNOWN",
 658 |         scrollTop: pick.scrollTop || 0,
 659 |         scrollHeight: pick.scrollHeight || 0,
 660 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
 661 |       };
 662 |     }, rootHandle, scrollHandle);
 663 |   }
 664 | 
 665 |   async function hasLoadMoreButtons() {
 666 |     return page.evaluate((root) => {
 667 |       const scope = root || document;
 668 | 
 669 |       const norm = (s) =>
 670 |         String(s || "")
 671 |           .replace(/\u00a0/g, " ")
 672 |           .replace(/\s+/g, " ")
 673 |           .trim()
 674 |           .toLowerCase();
 675 | 
 676 |       const isVisible = (el) => {
 677 |         if (!el) return false;
 678 |         const r = el.getBoundingClientRect();
 679 |         if (r.width < 2 || r.height < 2) return false;
 680 |         return r.bottom > 0 && r.top < window.innerHeight;
 681 |       };
 682 | 
 683 |       const nodesBtn = Array.from(
 684 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 685 |       ).filter(isVisible);
 686 | 
 687 |       return nodesBtn.some((el) => {
 688 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 689 | 
 690 |         if (
 691 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 692 |           t.includes("zobacz wiƒôcej komentarzy") ||
 693 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 694 |           t.includes("view more comments") ||
 695 |           t.includes("view previous comments")
 696 |         )
 697 |           return true;
 698 | 
 699 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 700 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 701 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 702 |         if (t.includes("view") && t.includes("repl")) return true;
 703 |         if (t.includes("see") && t.includes("repl")) return true;
 704 | 
 705 |         return false;
 706 |       });
 707 |     }, rootHandle);
 708 |   }
 709 | 
 710 |   function isHardBottom(m) {
 711 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
 712 |     const top = Number(m?.scrollTop || 0);
 713 |     const ch = Number(m?.clientHeight || 0);
 714 |     const sh = Number(m?.scrollHeight || 0);
 715 |     if (!sh || !ch) return false;
 716 |     return top + ch >= sh - eps;
 717 |   }
 718 | 
 719 |   let bottomStable = 0;
 720 |   let lastBottomScrollHeight = null;
 721 | 
 722 |   async function updateHardBottomStability() {
 723 |     const m1 = await getScrollMetrics().catch(() => null);
 724 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
 725 | 
 726 |     const atBottom = isHardBottom(m1);
 727 | 
 728 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
 729 | 
 730 |     const m2 = await getScrollMetrics().catch(() => m1);
 731 |     const atBottom2 = isHardBottom(m2);
 732 | 
 733 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
 734 | 
 735 |     const sh = Number(m2?.scrollHeight || 0);
 736 |     const shStable =
 737 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
 738 | 
 739 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
 740 |     else bottomStable = 0;
 741 | 
 742 |     lastBottomScrollHeight = sh;
 743 | 
 744 |     return {
 745 |       atBottom: atBottom && atBottom2,
 746 |       stable: bottomStable,
 747 |       tag: m2?.tag || "UNKNOWN",
 748 |       anyMore,
 749 |       scrollTop: m2?.scrollTop,
 750 |       clientHeight: m2?.clientHeight,
 751 |       scrollHeight: m2?.scrollHeight,
 752 |     };
 753 |   }
 754 | 
 755 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
 756 |   async function waitForEffect(beforeCounts, kind) {
 757 |     const timeout = PACE_CFG.effectWaitMs;
 758 | 
 759 |     const ok = await page
 760 |       .waitForFunction(
 761 |         (root, before, kindArg) => {
 762 |           const scope = root || document;
 763 | 
 764 |           const countUniq = (sel, param) => {
 765 |             const as = Array.from(scope.querySelectorAll(sel));
 766 |             const ids = new Set();
 767 |             for (const a of as) {
 768 |               const href = a.getAttribute("href") || "";
 769 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
 770 |               if (m && m[1]) ids.add(m[1]);
 771 |             }
 772 |             return ids.size;
 773 |           };
 774 | 
 775 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
 776 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
 777 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
 778 | 
 779 |           if (
 780 |             commentsAnchors > (before?.commentsAnchors || 0) ||
 781 |             replyAnchors > (before?.replyAnchors || 0) ||
 782 |             nodes > (before?.nodes || 0)
 783 |           ) {
 784 |             return true;
 785 |           }
 786 | 
 787 |           const norm = (s) =>
 788 |             String(s || "")
 789 |               .replace(/\u00a0/g, " ")
 790 |               .replace(/\s+/g, " ")
 791 |               .trim()
 792 |               .toLowerCase();
 793 | 
 794 |           const isVisible = (el) => {
 795 |             if (!el) return false;
 796 |             const r = el.getBoundingClientRect();
 797 |             if (r.width < 2 || r.height < 2) return false;
 798 |             return r.bottom > 0 && r.top < window.innerHeight;
 799 |           };
 800 | 
 801 |           const nodesBtn = Array.from(
 802 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 803 |           ).filter(isVisible);
 804 | 
 805 |           const stillThere =
 806 |             kindArg === "comments"
 807 |               ? nodesBtn.some((el) => {
 808 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 809 |                   return (
 810 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 811 |                     t.includes("zobacz wiƒôcej komentarzy") ||
 812 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
 813 |                     t.includes("view more comments") ||
 814 |                     t.includes("view previous comments")
 815 |                   );
 816 |                 })
 817 |               : nodesBtn.some((el) => {
 818 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 819 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 820 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 821 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
 822 |                   if (t.includes("view") && t.includes("repl")) return true;
 823 |                   if (t.includes("see") && t.includes("repl")) return true;
 824 |                   return false;
 825 |                 });
 826 | 
 827 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
 828 |           return !stillThere;
 829 |         },
 830 |         { timeout, polling: 120 },
 831 |         rootHandle,
 832 |         beforeCounts,
 833 |         kind
 834 |       )
 835 |       .then(() => true)
 836 |       .catch(() => false);
 837 | 
 838 |     return ok;
 839 |   }
 840 | 
 841 |   async function bonusClicks(kind, beforeCounts) {
 842 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
 843 |     if (!tries) return 0;
 844 | 
 845 |     let clicked = 0;
 846 |     let curBefore = beforeCounts;
 847 | 
 848 |     for (let i = 0; i < tries; i++) {
 849 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
 850 | 
 851 |       const res =
 852 |         kind === "replies"
 853 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
 854 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 855 | 
 856 |       if (!res?.clicked) break;
 857 | 
 858 |       clicked++;
 859 | 
 860 |       // mikro-oddech, potem czekamy na efekt
 861 |       await sleepRandom(80, 140);
 862 |       await waitForEffect(curBefore, kind);
 863 | 
 864 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
 865 |       curBefore = await countAnchors().catch(() => curBefore);
 866 | 
 867 |       // minimalny settle po do≈Çadowaniu
 868 |       await sleepRandom(90, 170);
 869 |     }
 870 | 
 871 |     return clicked;
 872 |   }
 873 | 
 874 |     async function clickOneReplyButton() {
 875 |     const res = await page.evaluate((root) => {
 876 |       const scope = root || document;
 877 | 
 878 |       const norm = (s) =>
 879 |         String(s || "")
 880 |           .replace(/\u00a0/g, " ")
 881 |           .replace(/\s+/g, " ")
 882 |           .trim()
 883 |           .toLowerCase();
 884 | 
 885 |       const isVisible = (el) => {
 886 |         if (!el) return false;
 887 |         try {
 888 |           const r = el.getBoundingClientRect();
 889 |           if (r.width < 2 || r.height < 2) return false;
 890 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
 891 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
 892 |         } catch {
 893 |           return true;
 894 |         }
 895 |       };
 896 | 
 897 |       const isReplyExpanderText = (t) => {
 898 |         if (!t) return false;
 899 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 900 |         if (t.length > 220) return false;
 901 | 
 902 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
 903 |         if (t === "odpowiedz" || t === "reply") return false;
 904 |         if (t.startsWith("odpowiedz ")) return false;
 905 |         if (t.startsWith("reply ")) return false;
 906 | 
 907 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
 908 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 909 | 
 910 |         // warianty opisowe
 911 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 912 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 913 |         if (t.includes("view") && t.includes("repl")) return true;
 914 |         if (t.includes("see") && t.includes("repl")) return true;
 915 | 
 916 |         return false;
 917 |       };
 918 | 
 919 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
 920 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
 921 |       const allTextCandidates = Array.from(
 922 |         scope.querySelectorAll("a,button,div,span")
 923 |       )
 924 |         .filter(isVisible)
 925 |         .slice(0, 35000);
 926 | 
 927 |       let best = null;
 928 |       let bestScore = -Infinity;
 929 | 
 930 |       for (const el of allTextCandidates) {
 931 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
 932 |         const t = norm(tRaw);
 933 |         if (!isReplyExpanderText(t)) continue;
 934 | 
 935 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
 936 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 937 |         if (t.includes("udost") || t.includes("share")) continue;
 938 | 
 939 |         const r = el.getBoundingClientRect();
 940 |         let score = 0;
 941 | 
 942 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
 943 |         score += Math.max(0, r.top);
 944 | 
 945 |         // preferuj te z liczbƒÖ odpowiedzi
 946 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
 947 | 
 948 |         // preferuj ‚Äúwszystkie/all‚Äù
 949 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
 950 | 
 951 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
 952 |         score -= Math.min(500, t.length * 3);
 953 | 
 954 |         if (score > bestScore) {
 955 |           bestScore = score;
 956 |           best = el;
 957 |         }
 958 |       }
 959 | 
 960 |       if (!best) return { clicked: false };
 961 | 
 962 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
 963 |       const clickable =
 964 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
 965 | 
 966 |       try {
 967 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 968 |       } catch {}
 969 | 
 970 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 971 | 
 972 |       const hardClick = (node) => {
 973 |         try {
 974 |           node.click();
 975 |           return true;
 976 |         } catch {}
 977 |         try {
 978 |           const r = node.getBoundingClientRect();
 979 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
 980 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
 981 |           const target = document.elementFromPoint(x, y) || node;
 982 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
 983 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
 984 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
 985 |           return true;
 986 |         } catch {}
 987 |         return false;
 988 |       };
 989 | 
 990 |       const ok = hardClick(clickable);
 991 |       return { clicked: ok, text: txt };
 992 |     }, rootHandle);
 993 | 
 994 |     return res || { clicked: false };
 995 |   }
 996 | 
 997 | 
 998 |   async function clickMoreCommentsButton() {
 999 |     const res = await page.evaluate((root) => {
1000 |       const scope = root || document;
1001 | 
1002 |       const norm = (s) =>
1003 |         String(s || "")
1004 |           .replace(/\u00a0/g, " ")
1005 |           .replace(/\s+/g, " ")
1006 |           .trim()
1007 |           .toLowerCase();
1008 | 
1009 |       const isVisible = (el) => {
1010 |         if (!el) return false;
1011 |         const r = el.getBoundingClientRect();
1012 |         if (r.width < 2 || r.height < 2) return false;
1013 |         return r.bottom > 0 && r.top < window.innerHeight;
1014 |       };
1015 | 
1016 |       const isMore = (t) => {
1017 |         if (!t) return false;
1018 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1019 |         if (t.length > 140) return false;
1020 | 
1021 |         return (
1022 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
1023 |           t.includes("zobacz wiƒôcej komentarzy") ||
1024 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
1025 |           t.includes("view more comments") ||
1026 |           t.includes("view previous comments")
1027 |         );
1028 |       };
1029 | 
1030 |       const candidates = Array.from(
1031 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
1032 |       ).filter(isVisible);
1033 | 
1034 |       let best = null;
1035 |       let bestY = -1;
1036 | 
1037 |       for (const el of candidates) {
1038 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1039 |         if (!isMore(t)) continue;
1040 |         const r = el.getBoundingClientRect();
1041 |         if (r.top > bestY) {
1042 |           bestY = r.top;
1043 |           best = el;
1044 |         }
1045 |       }
1046 | 
1047 |       if (!best) return { clicked: false };
1048 | 
1049 |       try {
1050 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
1051 |       } catch {}
1052 | 
1053 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
1054 | 
1055 |       try {
1056 |         best.click();
1057 |         return { clicked: true, text: txt };
1058 |       } catch {
1059 |         return { clicked: false, text: txt };
1060 |       }
1061 |     }, rootHandle);
1062 | 
1063 |     return res || { clicked: false };
1064 |   }
1065 | 
1066 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
1067 | 
1068 |   async function hasAnyReplyExpanders(page, rootHandle) {
1069 |     return page.evaluate((root) => {
1070 |       const scope = root || document;
1071 | 
1072 |       const norm = (s) =>
1073 |         String(s || "")
1074 |           .replace(/\u00a0/g, " ")
1075 |           .replace(/\s+/g, " ")
1076 |           .trim()
1077 |           .toLowerCase();
1078 | 
1079 |       const isVisible = (el) => {
1080 |         if (!el) return false;
1081 |         try {
1082 |           const r = el.getBoundingClientRect();
1083 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
1084 |         } catch {
1085 |           return true;
1086 |         }
1087 |       };
1088 | 
1089 |       const isReplyExpanderText = (t) => {
1090 |         if (!t) return false;
1091 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1092 |         if (t.length > 220) return false;
1093 | 
1094 |         if (t === "odpowiedz" || t === "reply") return false;
1095 |         if (t.startsWith("odpowiedz ")) return false;
1096 |         if (t.startsWith("reply ")) return false;
1097 | 
1098 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1099 | 
1100 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1101 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
1102 |         if (t.includes("view") && t.includes("repl")) return true;
1103 |         if (t.includes("see") && t.includes("repl")) return true;
1104 | 
1105 |         return false;
1106 |       };
1107 | 
1108 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
1109 | 
1110 |       for (const el of nodes) {
1111 |         if (!isVisible(el)) continue;
1112 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1113 |         if (!t) continue;
1114 | 
1115 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
1116 |         if (t.includes("udost") || t.includes("share")) continue;
1117 | 
1118 |         if (isReplyExpanderText(t)) return true;
1119 |       }
1120 | 
1121 |       return false;
1122 |     }, rootHandle);
1123 |   }
1124 | 
1125 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
1126 |     const res = await page.evaluate(
1127 |       (root, limit) => {
1128 |         const scope = root || document;
1129 | 
1130 |         const norm = (s) =>
1131 |           String(s || "")
1132 |             .replace(/\u00a0/g, " ")
1133 |             .replace(/\s+/g, " ")
1134 |             .trim()
1135 |             .toLowerCase();
1136 | 
1137 |         const isVisible = (el) => {
1138 |           if (!el) return false;
1139 |           try {
1140 |             const r = el.getBoundingClientRect();
1141 |             if (r.width < 2 || r.height < 2) return false;
1142 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
1143 |           } catch {
1144 |             return true;
1145 |           }
1146 |         };
1147 | 
1148 |         const isReplyExpanderText = (t) => {
1149 |           if (!t) return false;
1150 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1151 |           if (t.length > 220) return false;
1152 | 
1153 |           if (t === "odpowiedz" || t === "reply") return false;
1154 |           if (t.startsWith("odpowiedz ")) return false;
1155 |           if (t.startsWith("reply ")) return false;
1156 | 
1157 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1158 | 
1159 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1160 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
1161 |           if (t.includes("view") && t.includes("repl")) return true;
1162 |           if (t.includes("see") && t.includes("repl")) return true;
1163 | 
1164 |           return false;
1165 |         };
1166 | 
1167 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
1168 |           .filter(isVisible)
1169 |           .slice(0, 35000)
1170 |           .map((el) => {
1171 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1172 |             return { el, t };
1173 |           })
1174 |           .filter((x) => {
1175 |             if (!x.t) return false;
1176 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
1177 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
1178 |             return isReplyExpanderText(x.t);
1179 |           });
1180 | 
1181 |         // preferuj elementy ni≈ºej w widoku
1182 |         candidates.sort((a, b) => {
1183 |           const ra = a.el.getBoundingClientRect();
1184 |           const rb = b.el.getBoundingClientRect();
1185 |           return rb.top - ra.top;
1186 |         });
1187 | 
1188 |         const hardClick = (node) => {
1189 |           try {
1190 |             node.click();
1191 |             return true;
1192 |           } catch {}
1193 |           try {
1194 |             const r = node.getBoundingClientRect();
1195 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
1196 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
1197 |             const target = document.elementFromPoint(x, y) || node;
1198 |             target.dispatchEvent(
1199 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
1200 |             );
1201 |             target.dispatchEvent(
1202 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
1203 |             );
1204 |             target.dispatchEvent(
1205 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
1206 |             );
1207 |             return true;
1208 |           } catch {}
1209 |           return false;
1210 |         };
1211 | 
1212 |         let clicked = 0;
1213 |         const sample = [];
1214 | 
1215 |         for (const item of candidates) {
1216 |           if (clicked >= limit) break;
1217 | 
1218 |           const clickable =
1219 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
1220 | 
1221 |           try {
1222 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
1223 |           } catch {}
1224 | 
1225 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
1226 | 
1227 |           const ok = hardClick(clickable);
1228 |           if (ok) {
1229 |             clicked++;
1230 |             if (sample.length < 5) sample.push(txt);
1231 |           }
1232 |         }
1233 | 
1234 |         return { clicked, sample };
1235 |       },
1236 |       rootHandle,
1237 |       maxPerPass
1238 |     );
1239 | 
1240 |     return res || { clicked: 0, sample: [] };
1241 |   }
1242 | 
1243 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
1244 |     await page.evaluate((root, scroller) => {
1245 |       const pick =
1246 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
1247 | 
1248 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
1249 |       else window.scrollTo(0, 0);
1250 |     }, rootHandle, scrollHandle);
1251 |   }
1252 | 
1253 |   async function sweepRepliesTopDown(
1254 |     page,
1255 |     rootHandle,
1256 |     scrollHandle,
1257 |     {
1258 |       maxPasses = 3,
1259 |       stepsPerPass = 40,
1260 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
1261 |       maxClicksPerStep = 12,
1262 |     } = {}
1263 |   ) {
1264 |     let totalClicked = 0;
1265 | 
1266 |     for (let pass = 1; pass <= maxPasses; pass++) {
1267 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
1268 |       await sleepRandom(140, 240);
1269 | 
1270 |       let staleSteps = 0;
1271 | 
1272 |       for (let step = 1; step <= stepsPerPass; step++) {
1273 |         const before = await countAnchors().catch(() => null);
1274 | 
1275 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
1276 |           () => ({ clicked: 0, sample: [] })
1277 |         );
1278 | 
1279 |         if (r.clicked > 0) {
1280 |           totalClicked += r.clicked;
1281 | 
1282 |           if (before) {
1283 |             await sleepRandom(60, 120);
1284 |             await waitForEffect(before, "replies");
1285 |           }
1286 | 
1287 |           await sleepRandom(90, 160);
1288 |           staleSteps = 0;
1289 |         } else {
1290 |           staleSteps++;
1291 |         }
1292 | 
1293 |         const m1 = await getScrollMetrics().catch(() => null);
1294 |         await gentleScrollKick(scrollPx);
1295 |         const m2 = await getScrollMetrics().catch(() => null);
1296 | 
1297 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
1298 | 
1299 |         if (!moved && staleSteps >= 4) break;
1300 |         if (staleSteps >= 8) break;
1301 |       }
1302 | 
1303 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1304 |       if (!any) break;
1305 |     }
1306 | 
1307 |     return totalClicked;
1308 |   }
1309 | 
1310 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
1311 |   let lastLogAt = 0;
1312 |   let lastLogKey = "";
1313 |   const LOG_EVERY_N_STEPS = 6;
1314 |   const LOG_MIN_MS = 800;
1315 |   const shouldLog = (step, key, force = false) => {
1316 |     const now = Date.now();
1317 |     if (force) {
1318 |       lastLogAt = now;
1319 |       lastLogKey = key;
1320 |       return true;
1321 |     }
1322 |     if (step % LOG_EVERY_N_STEPS === 0) {
1323 |       lastLogAt = now;
1324 |       lastLogKey = key;
1325 |       return true;
1326 |     }
1327 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
1328 |       lastLogAt = now;
1329 |       lastLogKey = key;
1330 |       return true;
1331 |     }
1332 |     return false;
1333 |   };
1334 | 
1335 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
1336 |   console.log("[FB][ui:photo] startCounts:", cur);
1337 | 
1338 |   for (let step = 1; step <= MAX_STEPS; step++) {
1339 |     const before = cur;
1340 |     let action = "scroll";
1341 |     let clickInfo = null;
1342 |     let effectOk = false;
1343 |     let bonus = 0;
1344 | 
1345 |     // 1) REPLIES
1346 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
1347 |     if (r1?.clicked) {
1348 |       action = "replies";
1349 |       clickInfo = r1;
1350 | 
1351 |       await sleepRandom(80, 140);
1352 |       effectOk = await waitForEffect(before, "replies");
1353 |       await sleepRandom(90, 170);
1354 | 
1355 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
1356 |       if (effectOk) {
1357 |         bonus = await bonusClicks("replies", before);
1358 |       } else {
1359 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
1360 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1361 |       }
1362 |     } else {
1363 |       // 2) MORE COMMENTS
1364 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
1365 |       if (c1?.clicked) {
1366 |         action = "comments";
1367 |         clickInfo = c1;
1368 | 
1369 |         await sleepRandom(80, 140);
1370 |         effectOk = await waitForEffect(before, "comments");
1371 |         await sleepRandom(90, 170);
1372 | 
1373 |         if (effectOk) {
1374 |           bonus = await bonusClicks("comments", before);
1375 |         } else {
1376 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1377 |         }
1378 |       } else {
1379 |         // 3) SCROLL
1380 |         action = "scroll";
1381 |         await gentleScrollKick(PACE_CFG.scrollPx);
1382 |       }
1383 |     }
1384 | 
1385 |     cur = await countAnchors().catch(() => before);
1386 | 
1387 |     const progressed =
1388 |       cur.commentsAnchors > before.commentsAnchors ||
1389 |       cur.replyAnchors > before.replyAnchors ||
1390 |       cur.nodes > before.nodes;
1391 | 
1392 |     if (!progressed) noProgress++;
1393 |     else noProgress = 0;
1394 | 
1395 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
1396 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
1397 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
1398 |     if (shouldCheckHB) {
1399 |       hb = await updateHardBottomStability().catch(() => ({
1400 |         atBottom: false,
1401 |         stable: bottomStable,
1402 |         tag: "NA",
1403 |         anyMore: true,
1404 |       }));
1405 |     }
1406 | 
1407 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
1408 |     const key =
1409 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
1410 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
1411 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
1412 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
1413 | 
1414 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
1415 |     if (shouldLog(step, key, forceLog)) {
1416 |       console.log(
1417 |         `[FB][ui:photo] step=${step} action=${action} eff=${effectOk ? "OK" : "NO"} bonus=${bonus} ` +
1418 |           `cA ${before.commentsAnchors}->${cur.commentsAnchors} ` +
1419 |           `rA ${before.replyAnchors}->${cur.replyAnchors} ` +
1420 |           `nodes ${before.nodes}->${cur.nodes} ` +
1421 |           `np=${noProgress}/${MAX_NO_PROGRESS} ` +
1422 |           `hb=${hb.atBottom ? "Y" : "N"} stable=${hb.stable}/${PACE_CFG.hardBottomStableNeed} more=${
1423 |             hb.anyMore ? "Y" : "N"
1424 |           } scroller=${hb.tag}` +
1425 |           (clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "")
1426 |       );
1427 |     }
1428 | 
1429 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
1430 |       console.log("[FB][ui:photo] stop: hard-bottom-stable (true bottom reached)");
1431 |       break;
1432 |     }
1433 | 
1434 |     if (noProgress >= MAX_NO_PROGRESS) {
1435 |       console.log("[FB][ui:photo] stop: too many no-progress steps (safety)");
1436 |       break;
1437 |     }
1438 | 
1439 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
1440 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
1441 |   }
1442 | 
1443 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
1444 |   let final = await countAnchors().catch(() => cur);
1445 |   console.log("[FB][ui:photo] done:", final);
1446 | 
1447 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1448 |   if (needSweep) {
1449 |     console.log("[FB][ui:photo] sweep: wykryto jeszcze reply expanders -> odpalam sweep top-down‚Ä¶");
1450 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
1451 |     console.log(`[FB][ui:photo] sweep: clicked=${clicked}`);
1452 |     final = await countAnchors().catch(() => final);
1453 |     console.log("[FB][ui:photo] after sweep:", final);
1454 |   } else {
1455 |     console.log("[FB][ui:photo] sweep: brak reply expanders -> pomijam.");
1456 |   }
1457 | 
1458 |   try {
1459 |     await scrollHandle.dispose?.();
1460 |   } catch {}
1461 |   try {
1462 |     await rootHandle.dispose?.();
1463 |   } catch {}
1464 | }
1465 | 
1466 | /* =====================
1467 |    Analiza za≈Ço≈ºe≈Ñ
1468 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
1469 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
1470 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
1471 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
1472 | 
1473 |    Co powiedzia≈Çby sceptyk?
1474 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
1475 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
1476 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
1477 | 
1478 |    ===================== */
1479 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/post.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/ui/post.js
  2 | import { EXPAND_COMMENTS } from "../../config.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { safeGoto } from "../../utils/navigation.js";
  5 | 
  6 | import { scrollPost } from "../scroll.js";
  7 | import { acceptCookies, saveCookies } from "../cookies.js";
  8 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  9 | import { clickOneExpandButton } from "../expandButtons.js";
 10 | 
 11 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
 12 | 
 13 | export const type = "post";
 14 | 
 15 | export function matchesUrl(url) {
 16 |   if (!url) return false;
 17 |   const u = String(url);
 18 |   if (u.includes("/watch")) return false;
 19 |   if (u.includes("/videos/")) return false;
 20 |   if (u.includes("/photo")) return false;
 21 |   if (u.includes("photo.php")) return false;
 22 | 
 23 |   return (
 24 |     u.includes("/posts/") ||
 25 |     u.includes("permalink.php") ||
 26 |     u.includes("/story.php") ||
 27 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
 28 |   );
 29 | }
 30 | 
 31 | /* ============================================================
 32 |    =============== POST ROOT (DIALOG / MAIN) ===================
 33 |    ============================================================ */
 34 | 
 35 | function postRootScript() {
 36 |   return `
 37 |     function getPostRoot() {
 38 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 39 | 
 40 |       const postDialog = dialogs.find((dlg) => {
 41 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 42 |         if (!text) return false;
 43 | 
 44 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
 45 |         const hasActions =
 46 |           text.includes("lubiƒô to") ||
 47 |           text.includes("komentarz") ||
 48 |           text.includes("udostƒôpnij") ||
 49 |           text.includes("write a comment") ||
 50 |           text.includes("comment");
 51 | 
 52 |         const looksLikeNotifications =
 53 |           text.startsWith("powiadomienia") &&
 54 |           text.includes("wszystkie") &&
 55 |           text.includes("nieprzeczytane");
 56 | 
 57 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 58 |       });
 59 | 
 60 |       if (postDialog) {
 61 |         const art = postDialog.querySelector("article");
 62 |         return art || postDialog;
 63 |       }
 64 | 
 65 |       const main = document.querySelector("div[role='main'], main");
 66 |       if (main) {
 67 |         const article = main.querySelector("article");
 68 |         return article || main;
 69 |       }
 70 | 
 71 |       return document.body;
 72 |     }
 73 |   `;
 74 | }
 75 | 
 76 | async function getPostScopeSelector(page) {
 77 |   const scope = await page.evaluate((code) => {
 78 |     // eslint-disable-next-line no-eval
 79 |     eval(code);
 80 |     // @ts-ignore
 81 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 82 |     if (!root) return "document";
 83 | 
 84 |     const dlg = root.closest("div[role='dialog']");
 85 |     if (dlg) return "div[role='dialog']";
 86 | 
 87 |     const main = document.querySelector("div[role='main'], main");
 88 |     if (main) return "div[role='main']";
 89 | 
 90 |     return "document";
 91 |   }, postRootScript());
 92 | 
 93 |   return scope || "document";
 94 | }
 95 | 
 96 | /* ============================================================
 97 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: ALL COMMENTS ===============
 98 |    ============================================================ */
 99 | 
100 | async function clickAllCommentsInMenu(page) {
101 |   const result = await page.evaluate(() => {
102 |     const norm = (s) =>
103 |       String(s || "")
104 |         .replace(/\u00a0/g, " ")
105 |         .replace(/\s+/g, " ")
106 |         .trim()
107 |         .toLowerCase();
108 | 
109 |     const menu = document.querySelector("div[role='menu']");
110 |     if (!menu) return { clicked: false, noMenu: true };
111 | 
112 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
113 | 
114 |     const opt = items.find((el) => {
115 |       const t = norm(el.textContent);
116 |       return (
117 |         t.startsWith("wszystkie komentarze") ||
118 |         t.startsWith("all comments") ||
119 |         t.startsWith("poka≈º wszystkie") ||
120 |         t.startsWith("pokaz wszystkie") ||
121 |         t.startsWith("show all")
122 |       );
123 |     });
124 | 
125 |     if (!opt) return { clicked: false, noMenu: false };
126 | 
127 |     try {
128 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
129 |     } catch {}
130 | 
131 |     try {
132 |       opt.click();
133 |       return { clicked: true, noMenu: false };
134 |     } catch {
135 |       return { clicked: false, noMenu: false };
136 |     }
137 |   });
138 | 
139 |   if (result.clicked) {
140 |     await sleepRandom(250, 450);
141 |     await page
142 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
143 |       .catch(() => {});
144 |   }
145 | 
146 |   return result;
147 | }
148 | 
149 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
150 |   console.log("[FB][ui:post][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
151 |   console.log("[FB][ui:post][filter] scope=", scopeSel);
152 | 
153 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
154 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
155 |   if (menuAlreadyOpen) {
156 |     console.log("[FB][ui:post][filter] Menu ju≈º otwarte ‚Äì wybieram opcjƒô.");
157 |     const r = await clickAllCommentsInMenu(page);
158 |     if (r?.clicked)
159 |       console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
160 |     return !!r?.clicked;
161 |   }
162 | 
163 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
164 |   const pre = await page.evaluate(
165 |     (scopeSel, code) => {
166 |       const norm = (s) =>
167 |         String(s || "")
168 |           .replace(/\u00a0/g, " ")
169 |           .replace(/\s+/g, " ")
170 |           .trim()
171 |           .toLowerCase();
172 | 
173 |       // eslint-disable-next-line no-eval
174 |       eval(code);
175 |       // @ts-ignore
176 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
177 | 
178 |       function getLabel(el) {
179 |         if (!el) return "";
180 |         const aria = el.getAttribute?.("aria-label");
181 |         if (aria) return aria;
182 |         return el.textContent || "";
183 |       }
184 | 
185 |       function isVisibleEnough(el) {
186 |         try {
187 |           if (!el) return false;
188 |           const st = window.getComputedStyle(el);
189 |           if (!st) return true;
190 |           if (st.display === "none" || st.visibility === "hidden") return false;
191 |           const r = el.getBoundingClientRect();
192 |           if (!r || r.width < 8 || r.height < 8) return false;
193 |           return true;
194 |         } catch {
195 |           return true;
196 |         }
197 |       }
198 | 
199 |       function findClickableAncestor(start) {
200 |         let el = start;
201 |         for (let i = 0; i < 10 && el; i++) {
202 |           const role = el.getAttribute?.("role");
203 |           const tag = (el.tagName || "").toLowerCase();
204 |           if (
205 |             tag === "button" ||
206 |             role === "button" ||
207 |             role === "menuitem" ||
208 |             role === "menuitemradio" ||
209 |             role === "link"
210 |           ) {
211 |             return el;
212 |           }
213 |           el = el.parentElement;
214 |         }
215 |         return null;
216 |       }
217 | 
218 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
219 |       const btnsAll = Array.from(
220 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
221 |       );
222 |       for (const el of btnsAll) {
223 |         const t = norm(getLabel(el));
224 |         if (
225 |           t === "wszystkie komentarze" ||
226 |           t === "all comments" ||
227 |           t === "poka≈º wszystkie" ||
228 |           t === "pokaz wszystkie" ||
229 |           t === "show all"
230 |         ) {
231 |           return { ok: true, state: "already-all", where: "document" };
232 |         }
233 |       }
234 | 
235 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
236 |       const scopes = [scopeEl, root, document].filter(Boolean);
237 | 
238 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
239 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
240 |       for (const sc of scopes) {
241 |         const clickables = Array.from(
242 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
243 |         );
244 | 
245 |         const candidates = [];
246 |         for (const el of clickables) {
247 |           const t = norm(getLabel(el));
248 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
249 |           if (!isVisibleEnough(el)) continue;
250 | 
251 |           let dist = 999999;
252 |           try {
253 |             const r = el.getBoundingClientRect();
254 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
255 |             dist = Math.abs(r.top - window.innerHeight / 2);
256 |           } catch {}
257 | 
258 |           candidates.push({ el, dist });
259 |         }
260 | 
261 |         if (candidates.length) {
262 |           candidates.sort((a, b) => a.dist - b.dist);
263 |           const picked = candidates[0].el;
264 | 
265 |           try {
266 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
267 |           } catch {}
268 | 
269 |           try {
270 |             picked.click();
271 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
272 |           } catch {
273 |             // nic
274 |           }
275 |         }
276 |       }
277 | 
278 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
279 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
280 |       for (const sc of scopes) {
281 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
282 |           .filter(isVisibleEnough)
283 |           .slice(0, 20000);
284 | 
285 |         for (const n of nodes) {
286 |           const t = norm(n.textContent);
287 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
288 | 
289 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
290 |           if (!clickable) continue;
291 | 
292 |           try {
293 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
294 |           } catch {}
295 | 
296 |           try {
297 |             clickable.click();
298 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
299 |           } catch {
300 |             // nic
301 |           }
302 |         }
303 |       }
304 | 
305 |       return { ok: false, state: "not-found" };
306 |     },
307 |     scopeSel,
308 |     postRootScript()
309 |   );
310 | 
311 |   if (!pre?.ok) {
312 |     console.log("[FB][ui:post][filter] Nie znaleziono przycisku filtra komentarzy.");
313 |     return false;
314 |   }
315 | 
316 |   if (pre.state === "already-all") {
317 |     console.log("[FB][ui:post][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' / 'Poka≈º wszystkie' ‚Äì pomijam.");
318 |     return true;
319 |   }
320 | 
321 |   console.log("[FB][ui:post][filter] Klikniƒôto filtr:", pre);
322 | 
323 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
324 |   await sleepRandom(350, 650);
325 | 
326 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
327 |   const menuResult = await clickAllCommentsInMenu(page);
328 | 
329 |   if (menuResult?.clicked) {
330 |     console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
331 |     return true;
332 |   }
333 | 
334 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
335 |   const afterLabelIsAll = await page.evaluate(() => {
336 |     const norm = (s) =>
337 |       String(s || "")
338 |         .replace(/\u00a0/g, " ")
339 |         .replace(/\s+/g, " ")
340 |         .trim()
341 |         .toLowerCase();
342 | 
343 |     const els = Array.from(
344 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
345 |     );
346 | 
347 |     function getLabel(el) {
348 |       const aria = el.getAttribute?.("aria-label");
349 |       if (aria) return aria;
350 |       return el.textContent || "";
351 |     }
352 | 
353 |     return els.some((el) => {
354 |       const t = norm(getLabel(el));
355 |       return (
356 |         t === "wszystkie komentarze" ||
357 |         t === "all comments" ||
358 |         t === "poka≈º wszystkie" ||
359 |         t === "pokaz wszystkie" ||
360 |         t === "show all"
361 |       );
362 |     });
363 |   });
364 | 
365 |   if (afterLabelIsAll) {
366 |     console.log("[FB][ui:post][filter] Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
367 |     return true;
368 |   }
369 | 
370 |   console.log(
371 |     "[FB][ui:post][filter] Nie uda≈Ço siƒô ustawiƒá filtra na 'Wszystkie komentarze' / 'Poka≈º wszystkie'. menuResult=",
372 |     menuResult
373 |   );
374 |   return false;
375 | }
376 | 
377 | 
378 | /* ============================================================
379 |    =================== LICZENIE Z UI (POST) ====================
380 |    ============================================================ */
381 | 
382 | /**
383 |  * Kluczowa poprawka:
384 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
385 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
386 |  */
387 | async function getCommentCountFromUiPostRoot(page) {
388 |   const res = await page.evaluate((code) => {
389 |     // eslint-disable-next-line no-eval
390 |     eval(code);
391 | 
392 |     const norm = (s) =>
393 |       String(s || "")
394 |         .replace(/\u00a0/g, " ")
395 |         .replace(/\s+/g, " ")
396 |         .trim();
397 | 
398 |     const lower = (s) => norm(s).toLowerCase();
399 | 
400 |     function parsePlEnCount(text) {
401 |       const t = lower(text);
402 |       if (!t) return null;
403 | 
404 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
405 | 
406 |       let x = t
407 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
408 |         .replace(/comments?/g, "")
409 |         .replace(/[():]/g, " ")
410 |         .replace(/\s+/g, " ")
411 |         .trim();
412 | 
413 |       let mult = 1;
414 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
415 |         mult = 1000;
416 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
417 |       }
418 |       if (/\bmln\b|\bmillion\b/.test(x)) {
419 |         mult = 1000000;
420 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
421 |       }
422 | 
423 |       x = x.replace(/\s+/g, "");
424 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
425 |       x = x.replace(/[^0-9.]/g, "");
426 |       if (!x) return null;
427 | 
428 |       const n = Number(x);
429 |       if (!Number.isFinite(n)) return null;
430 | 
431 |       return Math.round(n * mult);
432 |     }
433 | 
434 |     // @ts-ignore
435 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
436 |     const scope = root || document;
437 | 
438 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
439 |     const badBlock = (txt) => {
440 |       const t = lower(txt);
441 |       if (!t) return false;
442 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
443 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
444 |       return false;
445 |     };
446 | 
447 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
448 |     const spans = Array.from(scope.querySelectorAll("span"));
449 |     let best = null;
450 | 
451 |     for (const el of spans) {
452 |       const raw = norm(el.textContent);
453 |       if (!raw) continue;
454 |       if (badBlock(raw)) continue;
455 | 
456 |       const val = parsePlEnCount(raw);
457 |       if (val == null) continue;
458 | 
459 |       let score = 0;
460 |       score += Math.max(0, 40 - raw.length);
461 | 
462 |       try {
463 |         const r = el.getBoundingClientRect();
464 |         if (r.width > 10 && r.height > 10) score += 10;
465 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
466 |       } catch {}
467 | 
468 |       if (!best || score > best.score) best = { raw, val, score };
469 |     }
470 | 
471 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
472 | 
473 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
474 |     const nodes = Array.from(
475 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
476 |     );
477 | 
478 |     for (const el of nodes) {
479 |       const raw = norm(el.textContent);
480 |       if (!raw) continue;
481 |       if (badBlock(raw)) continue;
482 | 
483 |       const val = parsePlEnCount(raw);
484 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
485 |     }
486 | 
487 |     // 3) Ostatecznie: regex po tek≈õcie root
488 |     const blob = norm(scope.innerText || "");
489 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
490 |     if (m) {
491 |       const raw = norm(`${m[1]} ${m[2]}`);
492 |       const val = parsePlEnCount(raw);
493 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
494 |     }
495 | 
496 |     return { ok: false, reason: "not-found" };
497 |   }, postRootScript());
498 | 
499 |   return res?.ok ? res : null;
500 | }
501 | 
502 | /* ============================================================
503 |    =================== LICZENIE ANCHOR√ìW =======================
504 |    ============================================================ */
505 | 
506 | async function getCurrentCommentAnchorCount(page) {
507 |   const count = await page.evaluate(() => {
508 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
509 |     const ids = new Set();
510 | 
511 |     for (const a of anchors) {
512 |       try {
513 |         const url = new URL(a.href);
514 |         const cid = url.searchParams.get("comment_id");
515 |         const rid = url.searchParams.get("reply_comment_id");
516 |         let raw = rid || cid;
517 |         if (!raw) continue;
518 | 
519 |         if (!/^\d+$/.test(raw)) {
520 |           try {
521 |             const dec = atob(raw);
522 |             const m = dec.match(/:(\d+)_([0-9]+)/);
523 |             if (m) raw = m[2];
524 |           } catch {}
525 |         }
526 | 
527 |         if (raw) ids.add(raw);
528 |       } catch {}
529 |     }
530 | 
531 |     return ids.size;
532 |   });
533 | 
534 |   return count || 0;
535 | }
536 | 
537 | /* ============================================================
538 |    =================== SCROLL TYLKO W PO≈öCIE ===================
539 |    ============================================================ */
540 | 
541 | async function scrollWithinPost(page, label, factor = 0.25) {
542 |   const info = await page.evaluate(
543 |     (factorArg, labelArg, code) => {
544 |       // eslint-disable-next-line no-eval
545 |       eval(code);
546 |       // @ts-ignore
547 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
548 | 
549 |       const norm = (s) =>
550 |         String(s || "")
551 |           .replace(/\u00a0/g, " ")
552 |           .replace(/\s+/g, " ")
553 |           .trim()
554 |           .toLowerCase();
555 | 
556 |       function canScrollByTest(el) {
557 |         try {
558 |           if (!el) return false;
559 |           const ch = el.clientHeight || 0;
560 |           const sh = el.scrollHeight || 0;
561 |           if (ch <= 0) return false;
562 |           if (sh <= ch + 30) return false;
563 | 
564 |           const before = el.scrollTop ?? 0;
565 |           el.scrollTop = before + 80;
566 |           const after = el.scrollTop ?? before;
567 |           el.scrollTop = before;
568 |           return after !== before;
569 |         } catch {
570 |           return false;
571 |         }
572 |       }
573 | 
574 |       function isVisible(el) {
575 |         if (!el) return false;
576 |         const st = window.getComputedStyle(el);
577 |         if (!st) return true;
578 |         if (st.display === "none" || st.visibility === "hidden") return false;
579 |         const r = el.getBoundingClientRect();
580 |         if (!r || r.width < 5 || r.height < 5) return false;
581 |         return true;
582 |       }
583 | 
584 |       function pickContainerSmart() {
585 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
586 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
587 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
588 | 
589 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
590 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
591 | 
592 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
593 |         let anchor = null;
594 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
595 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
596 |           .filter(isVisible)
597 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
598 | 
599 |         if (candAnchor) anchor = candAnchor;
600 | 
601 |         function score(el) {
602 |           const ch = el.clientHeight || 0;
603 |           const sh = el.scrollHeight || 0;
604 |           const delta = sh - ch;
605 | 
606 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
607 |           const t = norm(el.innerText || "");
608 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
609 |           let s = delta + (hasCommentWords ? 12000 : 0);
610 | 
611 |           // premia je≈õli blisko anchora
612 |           if (anchor) {
613 |             const ar = anchor.getBoundingClientRect();
614 |             const er = el.getBoundingClientRect();
615 |             const dist = Math.abs(er.top - ar.top);
616 |             s += Math.max(0, 4000 - dist);
617 |           }
618 | 
619 |           return s;
620 |         }
621 | 
622 |         let best = null;
623 |         let bestScore = -1;
624 | 
625 |         for (const sc of scopes) {
626 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
627 |             .filter(isVisible)
628 |             .slice(0, 18000);
629 | 
630 |           for (const el of divs) {
631 |             if (!canScrollByTest(el)) continue;
632 |             const s = score(el);
633 |             if (s > bestScore) {
634 |               bestScore = s;
635 |               best = el;
636 |             }
637 |           }
638 |           if (best) break;
639 |         }
640 | 
641 |         if (best) {
642 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
643 |           return { el: best, label: "smart" };
644 |         }
645 | 
646 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
647 |         return {
648 |           el: document.scrollingElement || document.documentElement || document.body,
649 |           label: "window",
650 |         };
651 |       }
652 | 
653 |       const picked = pickContainerSmart();
654 |       const container = picked.el;
655 |       const containerType = picked.label;
656 | 
657 |       const isWindowContainer =
658 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
659 | 
660 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
661 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
662 | 
663 |       if (maxScroll <= 0) {
664 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
665 |       }
666 | 
667 |       const f = factorArg || 0.25;
668 |       const sign = f < 0 ? -1 : 1;
669 |       const magnitude = Math.min(Math.abs(f), 1);
670 | 
671 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
672 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
673 |       const step = Math.max(120, Math.min(baseStep, 520));
674 | 
675 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
676 | 
677 |       if (isWindowContainer) window.scrollTo(0, target);
678 |       else container.scrollTop = target;
679 | 
680 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
681 | 
682 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
683 |       if (after === before) {
684 |         try {
685 |           window.scrollBy(0, sign * step);
686 |         } catch {}
687 |       }
688 | 
689 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
690 | 
691 |       return { before, after: after2, container: containerType, label: labelArg };
692 |     },
693 |     factor,
694 |     label,
695 |     postRootScript()
696 |   );
697 | 
698 |   return info;
699 | }
700 | 
701 | /* ============================================================
702 |    =================== EXPAND (LEGACY) =========================
703 |    ============================================================ */
704 | 
705 | async function expandAllComments(page) {
706 |   if (!EXPAND_COMMENTS) return 0;
707 | 
708 |   let clicks = 0;
709 |   for (let i = 0; i < 30; i++) {
710 |     const didClick = await clickOneExpandButton(page);
711 |     if (!didClick) break;
712 |     clicks++;
713 |     await sleepRandom(900, 1600);
714 |   }
715 |   return clicks;
716 | }
717 | 
718 | /* ============================================================
719 |    =================== HANDLER API =============================
720 |    ============================================================ */
721 | 
722 | export async function prepare(page, url) {
723 |   console.log(`[FB][ui:post] prepare: ${url}`);
724 | 
725 |   const ok = await safeGoto(page, url, "post", {
726 |     waitUntil: "networkidle2",
727 |     timeout: NAV_TIMEOUT_MS,
728 |   });
729 | 
730 |   if (!ok) throw new Error("safeGoto-failed");
731 | 
732 |   const currentUrl = page.url();
733 |   if (currentUrl.includes("/login")) {
734 |     console.log("[FB][ui:post] /login redirect ‚Üí fbLogin() and back");
735 |     await fbLogin(page);
736 |     await sleepRandom(3000, 4500);
737 | 
738 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
739 |     console.log("[FB][ui:post] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
740 | 
741 |     if (loggedAfterLogin) {
742 |       await safeGoto(page, url, "post", {
743 |         waitUntil: "networkidle2",
744 |         timeout: NAV_TIMEOUT_MS,
745 |       });
746 |     }
747 |   }
748 | 
749 |   await acceptCookies(page, "post-initial");
750 | 
751 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
752 |   await sleepRandom(1200, 1800);
753 |   await acceptCookies(page, "post");
754 | 
755 |   try {
756 |     const logged = await checkIfLogged(page).catch(() => false);
757 |     if (logged) await saveCookies(page);
758 |   } catch {}
759 | 
760 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
761 |   await scrollPost(page, 120).catch(() => {});
762 |   await sleepRandom(600, 900);
763 | }
764 | 
765 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
766 |   try {
767 |     await page.waitForFunction(
768 |       ({ stableMs }) => {
769 |         const now = performance.now();
770 |         const y = window.scrollY || 0;
771 | 
772 |         if (!window.__fbScrollStop) {
773 |           window.__fbScrollStop = { lastY: y, lastChange: now };
774 |           return false;
775 |         }
776 | 
777 |         const st = window.__fbScrollStop;
778 | 
779 |         if (Math.abs(y - st.lastY) > 0) {
780 |           st.lastY = y;
781 |           st.lastChange = now;
782 |           return false;
783 |         }
784 | 
785 |         return now - st.lastChange >= stableMs;
786 |       },
787 |       { timeout: timeoutMs },
788 |       { stableMs }
789 |     );
790 |     return true;
791 |   } catch {
792 |     return false;
793 |   }
794 | }
795 | 
796 | export async function getCommentCount(page, url) {
797 |   console.log("[FB][ui:post] getCommentCount‚Ä¶");
798 | 
799 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
800 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
801 | 
802 |   const scopeSel = await getPostScopeSelector(page);
803 | 
804 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
805 |   console.log("[FB][ui:post] filter all comments:", okFilter);
806 | 
807 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
808 |   if (okFilter) {
809 |     await sleepRandom(250, 450);
810 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
811 |   }
812 | 
813 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
814 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
815 | 
816 |   console.log("[FB][ui:post] UI comments:", {
817 |     source: ui?.source || "none",
818 |     raw: ui?.raw || null,
819 |     comments: ui?.comments ?? null,
820 |   });
821 | 
822 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
823 |     return ui.comments;
824 |   }
825 | 
826 |   const anchors = await getCurrentCommentAnchorCount(page);
827 |   console.log("[FB][ui:post] Fallback anchor count =", anchors);
828 | 
829 |   return anchors > 0 ? anchors : null;
830 | }
831 | 
832 | export async function loadAllComments(page, { expectedTotal } = {}) {
833 |   console.log(`[FB][ui:post] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"}`);
834 | 
835 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
836 | 
837 |   const MAX_ROUNDS = 600;
838 |   const MAX_NO_PROGRESS = 60;
839 | 
840 |   let noProgress = 0;
841 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
842 | 
843 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
844 |     const before = lastAnchors;
845 | 
846 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
847 |     const clicks = await expandAllComments(page);
848 |     await sleepRandom(220, 420);
849 | 
850 |     const after = await getCurrentCommentAnchorCount(page);
851 | 
852 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
853 | 
854 |     if (progressed) noProgress = 0;
855 |     else noProgress++;
856 | 
857 |     lastAnchors = after;
858 | 
859 |     if (round === 1 || round % 25 === 0) {
860 |       console.log(
861 |         `[FB][ui:post] round=${round} container=${scrollInfo.container} scrollTop: ${scrollInfo.before}‚Üí${scrollInfo.after} anchors: ${before}‚Üí${after} clicks=${clicks} noProgress=${noProgress}`
862 |       );
863 |     }
864 | 
865 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
866 |       if (after >= expectedTotal && noProgress >= 2) {
867 |         console.log("[FB][ui:post] stop reason=target-reached");
868 |         break;
869 |       }
870 |     }
871 | 
872 |     if (noProgress >= MAX_NO_PROGRESS) {
873 |       console.log("[FB][ui:post] stop reason=no-progress");
874 |       break;
875 |     }
876 |   }
877 | }
878 | 
879 | export async function extractComments(page, url) {
880 |   const data = await page.evaluate(() => {
881 |     function extractCommentId(u) {
882 |       const m = u?.match(/comment_id=([^&]+)/);
883 |       return m ? decodeURIComponent(m[1]) : null;
884 |     }
885 | 
886 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
887 |     const idToTimeMap = {};
888 | 
889 |     for (let i = 0; i < allLinks.length; i++) {
890 |       const link = allLinks[i];
891 |       const href = link.getAttribute("href") || "";
892 |       const id = extractCommentId(href);
893 |       if (!id) continue;
894 | 
895 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
896 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
897 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
898 |           idToTimeMap[id] = timeText;
899 |           break;
900 |         }
901 |       }
902 |     }
903 | 
904 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
905 | 
906 |     const extracted = nodes
907 |       .map((node, idx) => {
908 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
909 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
910 | 
911 |         const linkEl = node.querySelector('a[role="link"]');
912 |         const href = linkEl?.getAttribute("href") || null;
913 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
914 | 
915 |         const id = permalink ? extractCommentId(permalink) : null;
916 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
917 | 
918 |         if (!author || !text) return null;
919 | 
920 |         return { id, author, text, time, permalink, pos: idx };
921 |       })
922 |       .filter(Boolean);
923 | 
924 |     return extracted;
925 |   });
926 | 
927 |   console.log("[FB][ui:post] extractComments: count =", data?.length || 0);
928 |   return Array.isArray(data) ? data : [];
929 | }
930 | 
931 | export async function debugSnapshot(page) {
932 |   const scopeSel = await getPostScopeSelector(page);
933 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
934 | 
935 |   return {
936 |     scopeSel,
937 |     anchors,
938 |     url: page.url(),
939 |   };
940 | }
941 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/scroll.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | /**
 2 |  * Scrollowanie posta:
 3 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
 4 |  * - je≈õli siƒô nie uda ‚Üí dialog ‚Üí dokument
 5 |  */
 6 | async function scrollPost(page, amount = 450) {
 7 |   await page.evaluate((dy) => {
 8 |     function findScrollableAncestor(start) {
 9 |       let el = start;
10 |       while (el) {
11 |         const style = window.getComputedStyle(el);
12 |         const canScrollY =
13 |           style.overflowY === "auto" || style.overflowY === "scroll";
14 |         if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
15 |           return el;
16 |         }
17 |         el = el.parentElement;
18 |       }
19 |       return null;
20 |     }
21 | 
22 |     // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
23 |     const centerEl = document.elementFromPoint(
24 |       window.innerWidth / 2,
25 |       window.innerHeight / 2
26 |     );
27 | 
28 |     let target = centerEl ? findScrollableAncestor(centerEl) : null;
29 | 
30 |     // fallback: dialog
31 |     if (!target) {
32 |       const dialog = document.querySelector("div[role='dialog']");
33 |       if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
34 |         target = dialog;
35 |       }
36 |     }
37 | 
38 |     // ostateczny fallback: dokument
39 |     if (!target) {
40 |       target =
41 |         document.scrollingElement || document.documentElement || document.body;
42 |     }
43 | 
44 |     if (
45 |       target === document.body ||
46 |       target === document.documentElement ||
47 |       target === document.scrollingElement
48 |     ) {
49 |       const before = window.scrollY;
50 |       window.scrollTo(0, before + dy);
51 |     } else {
52 |       target.scrollTop += dy;
53 |     }
54 |   }, amount);
55 | }
56 | 
57 | export { scrollPost };
58 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/sleep.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | function sleep(ms) {
 2 |   return new Promise((res) => setTimeout(res, ms));
 3 | }
 4 | 
 5 | function sleepRandom(minMs, maxMs) {
 6 |   const delta = maxMs - minMs;
 7 |   const extra = Math.random() * delta;
 8 |   return sleep(minMs + extra);
 9 | }
10 | 
11 | export { sleep, sleepRandom };
12 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/uicommentinfo.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/uiCommentInfo.js
  2 | // UI: wykrywanie typu widoku + wyciƒÖganie liczby komentarzy z meta-linii (reakcje | komentarze | udostƒôpnienia)
  3 | // FIX: photo view -> meta row + filtr sklejonych liczb typu "287368".
  4 | // VIDEO/WATCH: komentarze czƒôsto sƒÖ jako: [LICZBA] + [IKONKA], bez tekstu "Komentarz" -> bierzemy z button√≥w z ikonkƒÖ.
  5 | 
  6 | export async function getUiCommentInfo(page) {
  7 |   return page.evaluate(() => {
  8 |     function norm(str) {
  9 |       if (!str) return "";
 10 |       return String(str).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
 11 |     }
 12 | 
 13 |     function detectViewType() {
 14 |       const href = location.href || "";
 15 |       const isWatch = href.includes("/watch");
 16 |       const isVideo = isWatch || /\/videos\/|[?&]v=/i.test(href);
 17 |       const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(href);
 18 | 
 19 |       if (isWatch) return "watch";
 20 |       if (isVideo) return "video";
 21 |       if (isPhoto) return "photo";
 22 |       return "permalink";
 23 |     }
 24 | 
 25 |     function isVisibleRough(el) {
 26 |       if (!el) return false;
 27 |       const st = window.getComputedStyle(el);
 28 |       if (!st) return true;
 29 |       if (st.display === "none" || st.visibility === "hidden") return false;
 30 |       return true;
 31 |     }
 32 | 
 33 |     // pojedynczy token liczbowy (np. "286", "7,8 tys.") ‚Äì odrzuca wieloliczbowe i "x z y"
 34 |     function parseSingleCount(str) {
 35 |       const s = norm(str).toLowerCase();
 36 |       if (!s) return null;
 37 | 
 38 |       // odrzuƒá "x z y"
 39 |       if (/\b\d+\s*z\s*\d+\b/i.test(s)) return null;
 40 | 
 41 |       // je≈õli sƒÖ >=2 grupy cyfr -> odrzucamy (ubija "7,8", "286 368", "1 234")
 42 |       const groups = s.match(/\d+/g);
 43 |       if (groups && groups.length > 1) return null;
 44 | 
 45 |       const m = s.match(/^(\d[\d.,]*)\s*(k|tys|ty≈õ|mln|m)?$/i);
 46 |       if (!m) return null;
 47 | 
 48 |       const raw = m[1];
 49 |       const suf = (m[2] || "").toLowerCase();
 50 | 
 51 |       let value = parseInt(raw.replace(/[^\d]/g, ""), 10);
 52 |       if (!Number.isFinite(value)) return null;
 53 | 
 54 |       if (suf === "k" || suf === "tys" || suf === "ty≈õ") value *= 1000;
 55 |       else if (suf === "mln" || suf === "m") value *= 1000000;
 56 | 
 57 |       return Math.round(value);
 58 |     }
 59 | 
 60 |     function findActionBarRoot() {
 61 |       const candidates = Array.from(document.querySelectorAll("div, section, footer"))
 62 |         .filter(isVisibleRough)
 63 |         .slice(0, 12000);
 64 | 
 65 |       for (const el of candidates) {
 66 |         const t = norm(el.innerText).toLowerCase();
 67 |         if (!t) continue;
 68 | 
 69 |         const hasLike = t.includes("lubiƒô to") || t.includes("like");
 70 |         const hasComment = t.includes("komentarz") || t.includes("comment");
 71 |         const hasShare = t.includes("udostƒôpnij") || t.includes("share");
 72 | 
 73 |         if (hasLike && hasComment && hasShare) {
 74 |           if (t.length > 2200) continue;
 75 |           return el;
 76 |         }
 77 |       }
 78 |       return null;
 79 |     }
 80 | 
 81 |     // usuwa tokeny typu "287368", je≈õli w tym samym zbiorze istniejƒÖ "287" i "368"
 82 |     function dropConcatenations(list) {
 83 |       const strSet = new Set(list.map((x) => String(x.v)));
 84 | 
 85 |       function isConcatOfTwoExisting(vStr) {
 86 |         if (vStr.length < 5) return false;
 87 |         for (let i = 1; i < vStr.length; i++) {
 88 |           const left = vStr.slice(0, i);
 89 |           const right = vStr.slice(i);
 90 |           if (left.length < 2 || right.length < 2) continue;
 91 |           if (strSet.has(left) && strSet.has(right)) return true;
 92 |         }
 93 |         return false;
 94 |       }
 95 | 
 96 |       const out = [];
 97 |       for (const x of list) {
 98 |         const vStr = String(x.v);
 99 |         if (isConcatOfTwoExisting(vStr)) continue;
100 |         out.push(x);
101 |       }
102 |       return out;
103 |     }
104 | 
105 |     function extractFromMetaRow(actionRoot) {
106 |       if (!actionRoot) return { comments: null, shares: null, raw: null };
107 | 
108 |       const badWords = [
109 |         "odpowiedz",
110 |         "wy≈õwietl",
111 |         "zobacz",
112 |         "najtrafniejsze",
113 |         "najnowsze",
114 |         "lider",
115 |         "edytowano",
116 |       ];
117 | 
118 |       const divs = Array.from(actionRoot.querySelectorAll("div"))
119 |         .filter(isVisibleRough)
120 |         .slice(0, 6000);
121 | 
122 |       const scored = [];
123 | 
124 |       for (const d of divs) {
125 |         const text = norm(d.innerText);
126 |         if (!text) continue;
127 | 
128 |         const low = text.toLowerCase();
129 |         const hasReactions = low.includes("wszystkie reakcje") || low.includes("all reactions");
130 |         if (!hasReactions) continue;
131 | 
132 |         if (low.length > 260) continue;
133 |         if (badWords.some((w) => low.includes(w))) continue;
134 | 
135 |         const atoms = Array.from(d.querySelectorAll("span, a, div"))
136 |           .filter(isVisibleRough)
137 |           .map((el) => norm(el.textContent))
138 |           .filter((s) => s && s.length <= 20);
139 | 
140 |         let nums = [];
141 |         for (const s of atoms) {
142 |           const v = parseSingleCount(s);
143 |           if (v == null) continue;
144 |           nums.push({ v, s });
145 |         }
146 | 
147 |         const seen = new Set();
148 |         let uniq = [];
149 |         for (const n of nums) {
150 |           const key = `${n.v}:${n.s}`;
151 |           if (seen.has(key)) continue;
152 |           seen.add(key);
153 |           uniq.push(n);
154 |         }
155 | 
156 |         uniq = dropConcatenations(uniq);
157 | 
158 |         if (uniq.length < 2) continue;
159 | 
160 |         let score = 0;
161 |         score += uniq.length === 2 ? 300 : 0;
162 |         score += Math.max(0, 260 - low.length);
163 | 
164 |         scored.push({ uniq, score, lowLen: low.length });
165 |       }
166 | 
167 |       scored.sort((a, b) => b.score - a.score);
168 |       const best = scored[0];
169 |       if (!best) return { comments: null, shares: null, raw: null };
170 | 
171 |       const comments = best.uniq[0]?.v ?? null;
172 |       const shares = best.uniq[1]?.v ?? null;
173 | 
174 |       const raw = `metaRow len=${best.lowLen} nums=${best.uniq
175 |         .map((x) => `${x.v}:${x.s}`)
176 |         .join(" | ")} -> comments=${comments} shares=${shares}`;
177 | 
178 |       return { comments, shares, raw };
179 |     }
180 | 
181 |     // VIDEO/WATCH: wyciƒÖgnij komentarze z przycisku "liczba + ikonka"
182 |     function extractVideoCommentsFromIconButtons() {
183 |       const btns = Array.from(document.querySelectorAll('[role="button"][tabindex="0"]'))
184 |         .filter(isVisibleRough)
185 |         .slice(0, 12000);
186 | 
187 |       function hasSuffixToken(t) {
188 |         const s = norm(t).toLowerCase();
189 |         return /\b(tys|ty≈õ|k|mln|m)\b/.test(s);
190 |       }
191 | 
192 |       const candidates = [];
193 | 
194 |       for (const b of btns) {
195 |         // wariant 1: ikona jako <i data-visualcompletion="css-img">
196 |         const iconI = b.querySelector('i[data-visualcompletion="css-img"]');
197 |         // wariant 2 (na przysz≈Ço≈õƒá): ikona jako svg
198 |         const iconSvg = b.querySelector("svg");
199 | 
200 |         if (!iconI && !iconSvg) continue;
201 | 
202 |         const toks = Array.from(b.querySelectorAll("span, a, div"))
203 |           .filter(isVisibleRough)
204 |           .map((el) => norm(el.textContent))
205 |           .filter((t) => t && t.length <= 20);
206 | 
207 |         if (!toks.length) continue;
208 | 
209 |         // odetnij tys/mln (np. 496 tys.)
210 |         if (toks.some(hasSuffixToken)) continue;
211 | 
212 |         // szukamy czystej liczby (np. 127)
213 |         let value = null;
214 |         let rawToken = null;
215 | 
216 |         for (const t of toks) {
217 |           if (!/^\d[\d.,]*$/.test(t)) continue;
218 |           const v = parseSingleCount(t);
219 |           if (v == null) continue;
220 |           value = v;
221 |           rawToken = t;
222 |           break;
223 |         }
224 | 
225 |         if (value == null) continue;
226 | 
227 |         const aria =
228 |           norm(b.getAttribute("aria-label")) +
229 |           " " +
230 |           norm((iconI && iconI.getAttribute && iconI.getAttribute("aria-label")) || "");
231 | 
232 |         const lowAria = aria.toLowerCase();
233 | 
234 |         let score = 0;
235 | 
236 |         // je≈õli gdziekolwiek pada "komentarz/comment" -> z≈Çoto
237 |         if (/\b(comment|comments|komentarz|komentarze)\b/.test(lowAria)) score += 120;
238 | 
239 |         // komentarze raczej nie sƒÖ mikro (1..9) w takim przycisku
240 |         if (value <= 9) score -= 60;
241 | 
242 |         // komentarze czƒôsto sƒÖ 10..5000+ -> lekka premia
243 |         if (value >= 10 && value <= 500000) score += 20;
244 | 
245 |         candidates.push({
246 |           value,
247 |           score,
248 |           raw: `iconBtn token=${rawToken} toks=${toks.join(" | ")} aria=${aria}`.slice(0, 500),
249 |         });
250 |       }
251 | 
252 |       if (!candidates.length) {
253 |         return { comments: null, raw: "videoIconButtons: not-found" };
254 |       }
255 | 
256 |       candidates.sort((a, b) => b.score - a.score || b.value - a.value);
257 |       const best = candidates[0];
258 | 
259 |       return {
260 |         comments: best.value,
261 |         raw: `videoIconButtons best=${best.value} score=${best.score} ${best.raw}`,
262 |       };
263 |     }
264 | 
265 |     // VIDEO/WATCH: fallback ‚Äì pr√≥ba klasycznego "near labels" (u Ciebie)
266 |     function extractNearLabels(actionRoot) {
267 |       const LIKE_WORDS = ["lubiƒô to", "like"];
268 |       const COMMENT_WORDS = ["komentarz", "comment"];
269 |       const SHARE_WORDS = ["udostƒôpnij", "share"];
270 | 
271 |       function hasAny(low, arr) {
272 |         return arr.some((w) => low.includes(w));
273 |       }
274 | 
275 |       function getNodeLabel(el) {
276 |         if (!el) return "";
277 |         const a = norm(el.getAttribute?.("aria-label"));
278 |         if (a) return a;
279 |         return norm(el.textContent);
280 |       }
281 | 
282 |       function findActionRowContainer(startEl) {
283 |         let cur = startEl;
284 |         for (let up = 0; up < 8 && cur; up++) {
285 |           const t = norm(cur.innerText).toLowerCase();
286 |           if (
287 |             t &&
288 |             hasAny(t, LIKE_WORDS) &&
289 |             hasAny(t, COMMENT_WORDS) &&
290 |             hasAny(t, SHARE_WORDS)
291 |           ) {
292 |             return cur;
293 |           }
294 |           cur = cur.parentElement;
295 |         }
296 |         return null;
297 |       }
298 | 
299 |       const scope = document.body;
300 | 
301 |       const clickable = Array.from(scope.querySelectorAll('[role="button"], a, span, div'))
302 |         .filter(isVisibleRough)
303 |         .slice(0, 20000);
304 | 
305 |       const commentNodes = [];
306 |       for (const el of clickable) {
307 |         const low = getNodeLabel(el).toLowerCase();
308 |         if (!low) continue;
309 |         if (hasAny(low, COMMENT_WORDS)) commentNodes.push(el);
310 |       }
311 | 
312 |       const scored = [];
313 |       for (const cn of commentNodes) {
314 |         const row = findActionRowContainer(cn);
315 |         if (!row) continue;
316 | 
317 |         const rowText = norm(row.innerText).toLowerCase();
318 |         if (!rowText) continue;
319 | 
320 |         if (rowText.includes("wszystkie reakcje") || rowText.includes("all reactions")) continue;
321 | 
322 |         const parts = Array.from(row.querySelectorAll("span, a, div, [role='button']"))
323 |           .filter(isVisibleRough)
324 |           .map((n) => getNodeLabel(n))
325 |           .map((s) => norm(s))
326 |           .filter((s) => s && s.length <= 40);
327 | 
328 |         const anyNum = parts.some((s) => parseSingleCount(s) != null);
329 |         if (!anyNum) continue;
330 | 
331 |         let score = 0;
332 |         score += Math.max(0, 600 - rowText.length);
333 |         score += Math.max(0, 120 - parts.length);
334 | 
335 |         scored.push({ row, parts, rowLen: rowText.length, score });
336 |       }
337 | 
338 |       scored.sort((a, b) => b.score - a.score);
339 |       const best = scored[0];
340 | 
341 |       if (!best) {
342 |         return { comments: null, shares: null, raw: "nearLabels: no-action-row-found" };
343 |       }
344 | 
345 |       const tokensLow = best.parts.map((s) => s.toLowerCase());
346 | 
347 |       const idxLike = tokensLow.findIndex((t) => hasAny(t, LIKE_WORDS));
348 |       const idxComment = tokensLow.findIndex((t) => hasAny(t, COMMENT_WORDS));
349 |       const idxShare = tokensLow.findIndex((t) => hasAny(t, SHARE_WORDS));
350 | 
351 |       function scanLeftForNumber(fromIdx) {
352 |         if (fromIdx == null || fromIdx < 0) return null;
353 |         for (let i = fromIdx - 1; i >= 0 && i >= fromIdx - 14; i--) {
354 |           const v = parseSingleCount(best.parts[i]);
355 |           if (v != null) return { v, at: i, token: best.parts[i] };
356 |         }
357 |         return null;
358 |       }
359 | 
360 |       let cPick = scanLeftForNumber(idxComment);
361 |       if (!cPick) cPick = scanLeftForNumber(idxLike);
362 | 
363 |       let sPick = scanLeftForNumber(idxShare);
364 |       if (cPick && sPick && sPick.v === cPick.v) sPick = null;
365 | 
366 |       const raw = `nearLabels[actionRow] len=${best.rowLen} tokens=${best.parts.join(
367 |         " | "
368 |       )} -> idxLike=${idxLike} idxComment=${idxComment} idxShare=${idxShare} | comments=${
369 |         cPick ? `${cPick.v}(${cPick.token})@${cPick.at}` : "null"
370 |       } | shares=${sPick ? `${sPick.v}(${sPick.token})@${sPick.at}` : "null"}`;
371 | 
372 |       return {
373 |         comments: cPick ? cPick.v : null,
374 |         shares: sPick ? sPick.v : null,
375 |         raw,
376 |       };
377 |     }
378 | 
379 |     const viewType = detectViewType();
380 |     const actionRoot = findActionBarRoot();
381 | 
382 |     let meta;
383 | 
384 |     if (viewType === "video" || viewType === "watch") {
385 |       // 1) pr√≥buj najpierw ikonki (to jest Tw√≥j przypadek z 127 / 496 tys.)
386 |       meta = extractVideoCommentsFromIconButtons();
387 | 
388 |       // 2) fallback: near labels (jak w Twoim kodzie)
389 |       if (meta.comments == null) {
390 |         const near = extractNearLabels(actionRoot);
391 |         meta = { comments: near.comments, raw: near.raw };
392 |       }
393 |     } else {
394 |       // photo/permalink stabilne -> nie ruszamy
395 |       meta = extractFromMetaRow(actionRoot);
396 |     }
397 | 
398 |     return {
399 |       source: `ui-${viewType}`,
400 |       viewType,
401 |       comments: meta.comments,
402 |       raw: meta.raw,
403 |     };
404 |   });
405 | }
406 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/videos.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | import { safeGoto } from "../../utils/navigation.js";
  2 | import { sleepRandom } from "../../utils/sleep.js";
  3 | import { acceptCookies } from "../cookies.js";
  4 | import { fbLogin, checkIfLogged } from "../login.js";
  5 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  6 | 
  7 | /** Typ handlera UI */
  8 | export const type = "videos";
  9 | 
 10 | export function matchesUrl(url) {
 11 |   const lower = (url || "").toLowerCase();
 12 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
 13 | }
 14 | 
 15 | export async function prepare(page, url) {
 16 |   console.log(`[FB][ui:videos] Otwieranie posta wideo: ${url}`);
 17 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 18 |   if (!ok) throw new Error("safeGoto-failed");
 19 | 
 20 |   const currentUrl = page.url();
 21 |   if (currentUrl.includes("/login")) {
 22 |     console.log("[FB][ui:videos] Wymagane logowanie ‚Äì pr√≥bujƒô zalogowaƒá.");
 23 |     await fbLogin(page);
 24 |     await sleepRandom(3000, 4500);
 25 | 
 26 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 27 |     console.log(
 28 |       `[FB][ui:videos] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
 29 |     );
 30 | 
 31 |     if (loggedAfterLogin) {
 32 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 33 |     } else {
 34 |       console.log("[FB][ui:videos] Logowanie nieudane ‚Äì kontynuacja bez sesji.");
 35 |     }
 36 |   }
 37 | 
 38 |   await acceptCookies(page, "videos");
 39 | 
 40 |   // stop autoplay
 41 |   try {
 42 |     await page.evaluate(() => {
 43 |       const vids = Array.from(document.querySelectorAll("video"));
 44 |       for (const v of vids) {
 45 |         try {
 46 |           v.autoplay = false;
 47 |           v.removeAttribute("autoplay");
 48 |           v.muted = true;
 49 |           v.pause();
 50 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
 51 |         } catch {}
 52 |       }
 53 |     });
 54 |     console.log("[FB][ui:videos] Wideo wstrzymane (autoplay wy≈ÇƒÖczony).");
 55 |   } catch (e) {
 56 |     console.log("[FB][ui:videos] B≈ÇƒÖd zatrzymania wideo:", e?.message || e);
 57 |   }
 58 | }
 59 | 
 60 | export async function getCommentCount(page, url) {
 61 |   const uiInfo = await getUiCommentInfo(page);
 62 |   console.log(`[FB][ui:videos][DBG] UI info:`, {
 63 |     source: uiInfo?.source,
 64 |     raw: uiInfo?.raw,
 65 |     viewType: uiInfo?.viewType,
 66 |     comments: uiInfo?.comments,
 67 |   });
 68 | 
 69 |   let totalComments = null;
 70 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
 71 | 
 72 |   console.log(
 73 |     `[FB][ui:videos] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`
 74 |   );
 75 |   return totalComments;
 76 | }
 77 | 
 78 | /* ==============================
 79 |    ======= DEBUG HELPERS ========
 80 |    ============================== */
 81 | 
 82 | function shortenHtml(html, max = 220) {
 83 |   if (!html) return null;
 84 |   const s = String(html).replace(/\s+/g, " ").trim();
 85 |   if (s.length <= max) return s;
 86 |   return s.slice(0, max) + "‚Ä¶";
 87 | }
 88 | 
 89 | async function debugDumpShowAllCandidates(page) {
 90 |   const out = await page.evaluate(() => {
 91 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
 92 |     function pick(el) {
 93 |       if (!el) return null;
 94 |       const r = el.getBoundingClientRect();
 95 |       return {
 96 |         tag: el.tagName,
 97 |         role: el.getAttribute("role"),
 98 |         aria: el.getAttribute("aria-label"),
 99 |         text: norm(el.textContent),
100 |         top: Math.round(r.top),
101 |         left: Math.round(r.left),
102 |         w: Math.round(r.width),
103 |         h: Math.round(r.height),
104 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
105 |       };
106 |     }
107 | 
108 |     const headers = Array.from(document.querySelectorAll("span"))
109 |       .filter((s) => {
110 |         const t = norm(s.textContent).toLowerCase();
111 |         return t === "komentarze" || t === "comments";
112 |       })
113 |       .slice(0, 5)
114 |       .map(pick);
115 | 
116 |     const showAll = Array.from(
117 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
118 |     )
119 |       .filter((el) => {
120 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
121 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
122 |       })
123 |       .slice(0, 20)
124 |       .map(pick);
125 | 
126 |     return { headers, showAll };
127 |   });
128 | 
129 |   console.log("[FB][ui:videos][DBG] candidates:", JSON.stringify(out, null, 2));
130 | }
131 | 
132 | /* ==========================================
133 |    ======= COMMENTS SCOPE / MARKERS =========
134 |    ========================================== */
135 | 
136 | async function markCommentsScope(page) {
137 |   return await page.evaluate(() => {
138 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
139 | 
140 |     function isVisible(el) {
141 |       if (!el) return false;
142 |       const st = getComputedStyle(el);
143 |       if (st.display === "none" || st.visibility === "hidden") return false;
144 |       const r = el.getBoundingClientRect();
145 |       return !!r && r.width > 5 && r.height > 5;
146 |     }
147 | 
148 |     function pick(el) {
149 |       if (!el) return null;
150 |       const r = el.getBoundingClientRect();
151 |       return {
152 |         tag: el.tagName,
153 |         role: el.getAttribute("role"),
154 |         aria: el.getAttribute("aria-label"),
155 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
156 |         top: Math.round(r.top),
157 |         left: Math.round(r.left),
158 |         w: Math.round(r.width),
159 |         h: Math.round(r.height),
160 |       };
161 |     }
162 | 
163 |     // clear markers
164 |     try {
165 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
166 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
167 |         n.removeAttribute("data-fbw-comments-header-row")
168 |       );
169 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
170 |         n.removeAttribute("data-fbw-comments-anchor")
171 |       );
172 |     } catch {}
173 | 
174 |     // find header
175 |     const headerSpans = Array.from(document.querySelectorAll("span"))
176 |       .filter(isVisible)
177 |       .filter((el) => {
178 |         const t = norm(el.textContent);
179 |         return t === "komentarze" || t === "comments";
180 |       });
181 | 
182 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
183 | 
184 |     // pick first visible header and mark a "root" around it
185 |     const h = headerSpans[0];
186 | 
187 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
188 |     let row = h.parentElement;
189 |     let foundRow = null;
190 | 
191 |     for (let up = 0; up < 14 && row; up++) {
192 |       const btns = Array.from(
193 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
194 |       ).filter(isVisible);
195 | 
196 |       const ok = btns.some((b) => {
197 |         const al = norm(b.getAttribute("aria-label"));
198 |         return (
199 |           al === "poka≈º wszystkie" ||
200 |           al === "wy≈õwietl wszystkie" ||
201 |           al === "show all" ||
202 |           al === "view all" ||
203 |           al === "ukryj komentarze" ||
204 |           al === "hide comments"
205 |         );
206 |       });
207 | 
208 |       if (ok) {
209 |         foundRow = row;
210 |         break;
211 |       }
212 |       row = row.parentElement;
213 |     }
214 | 
215 |     if (foundRow) {
216 |       try {
217 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
218 |       } catch {}
219 |     }
220 | 
221 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
222 |     let root = h.parentElement;
223 |     let best = null;
224 | 
225 |     for (let up = 0; up < 26 && root; up++) {
226 |       const txt = norm(root.innerText || "");
227 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
228 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
229 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
230 |       const isBigEnough = (root.clientHeight || 0) > 250;
231 | 
232 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
233 |         best = root;
234 |         break;
235 |       }
236 |       root = root.parentElement;
237 |     }
238 | 
239 |     // fallback: use header row parent
240 |     if (!best && foundRow) best = foundRow.parentElement;
241 |     if (!best) best = document.body;
242 | 
243 |     try {
244 |       best.setAttribute("data-fbw-comments-root", "1");
245 |     } catch {}
246 | 
247 |     // anchor element for scroll targeting: header span itself
248 |     try {
249 |       h.setAttribute("data-fbw-comments-anchor", "1");
250 |     } catch {}
251 | 
252 |     return {
253 |       ok: true,
254 |       reason: "marked",
255 |       header: pick(h),
256 |       row: foundRow ? pick(foundRow) : null,
257 |       root: pick(best),
258 |     };
259 |   });
260 | }
261 | 
262 | async function clickShowAllFromMarkedRow(page) {
263 |   const res = await page.evaluate(() => {
264 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
265 | 
266 |     function isVisible(el) {
267 |       if (!el) return false;
268 |       const st = getComputedStyle(el);
269 |       if (st.display === "none" || st.visibility === "hidden") return false;
270 |       const r = el.getBoundingClientRect();
271 |       return !!r && r.width > 5 && r.height > 5;
272 |     }
273 | 
274 |     function pick(el) {
275 |       if (!el) return null;
276 |       const r = el.getBoundingClientRect();
277 |       return {
278 |         tag: el.tagName,
279 |         role: el.getAttribute("role"),
280 |         aria: el.getAttribute("aria-label"),
281 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
282 |         top: Math.round(r.top),
283 |         left: Math.round(r.left),
284 |         w: Math.round(r.width),
285 |         h: Math.round(r.height),
286 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
287 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
288 |       };
289 |     }
290 | 
291 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
292 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
293 | 
294 |     const candidates = Array.from(
295 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
296 |     ).filter(isVisible);
297 | 
298 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
299 |     for (const c of candidates) {
300 |       const al = norm(c.getAttribute("aria-label"));
301 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
302 |         try {
303 |           c.scrollIntoView({ block: "center", inline: "nearest" });
304 |         } catch {}
305 |         try {
306 |           c.click();
307 |         } catch {}
308 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
309 |       }
310 |     }
311 | 
312 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
313 |   });
314 | 
315 |   console.log("[FB][ui:videos][DBG] show-all click:", JSON.stringify(res, null, 2));
316 |   return !!res?.clicked;
317 | }
318 | 
319 | /* ==========================================
320 |    ======= FILTER/SORT (Najtrafniejsze) ======
321 |    ========================================== */
322 | 
323 | async function ensureAllCommentsFilter(page) {
324 |   const res = await page.evaluate(() => {
325 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
326 | 
327 |     function isVisible(el) {
328 |       if (!el) return false;
329 |       const st = getComputedStyle(el);
330 |       if (st.display === "none" || st.visibility === "hidden") return false;
331 |       const r = el.getBoundingClientRect();
332 |       return !!r && r.width > 5 && r.height > 5;
333 |     }
334 | 
335 |     function pick(el) {
336 |       if (!el) return null;
337 |       const r = el.getBoundingClientRect();
338 |       return {
339 |         tag: el.tagName,
340 |         role: el.getAttribute("role"),
341 |         aria: el.getAttribute("aria-label"),
342 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
343 |         top: Math.round(r.top),
344 |         left: Math.round(r.left),
345 |         w: Math.round(r.width),
346 |         h: Math.round(r.height),
347 |       };
348 |     }
349 | 
350 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
351 | 
352 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
353 |     const rootTxt = norm(root.innerText || "");
354 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
355 |       return { ok: true, action: "already-all", dbg: null };
356 |     }
357 | 
358 |     // find the sort dropdown button in root
359 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
360 | 
361 |     const sortBtn = btns.find((b) => {
362 |       const t = norm(b.textContent);
363 |       return (
364 |         t === "najtrafniejsze" ||
365 |         t === "most relevant" ||
366 |         t === "top comments" ||
367 |         t === "najlepsze" ||
368 |         t === "newest" ||
369 |         t === "najnowsze"
370 |       );
371 |     });
372 | 
373 |     if (!sortBtn) {
374 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
375 |     }
376 | 
377 |     try {
378 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
379 |     } catch {}
380 |     try {
381 |       sortBtn.click();
382 |     } catch {}
383 | 
384 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
385 |   });
386 | 
387 |   console.log("[FB][ui:videos][DBG] filter step#1:", JSON.stringify(res, null, 2));
388 | 
389 |   if (!res?.ok || res.action !== "opened-menu") return false;
390 | 
391 |   await sleepRandom(400, 700);
392 | 
393 |   const res2 = await page.evaluate(() => {
394 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
395 | 
396 |     function isVisible(el) {
397 |       if (!el) return false;
398 |       const st = getComputedStyle(el);
399 |       if (st.display === "none" || st.visibility === "hidden") return false;
400 |       const r = el.getBoundingClientRect();
401 |       return !!r && r.width > 5 && r.height > 5;
402 |     }
403 | 
404 |     function pick(el) {
405 |       if (!el) return null;
406 |       const r = el.getBoundingClientRect();
407 |       return {
408 |         tag: el.tagName,
409 |         role: el.getAttribute("role"),
410 |         aria: el.getAttribute("aria-label"),
411 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
412 |         top: Math.round(r.top),
413 |         left: Math.round(r.left),
414 |         w: Math.round(r.width),
415 |         h: Math.round(r.height),
416 |       };
417 |     }
418 | 
419 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
420 | 
421 |     if (!menu) return { ok: false, action: "no-menu" };
422 | 
423 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
424 |       .filter(isVisible)
425 |       .slice(0, 200);
426 | 
427 |     // Prefer: "Wszystkie komentarze" / "All comments"
428 |     let target =
429 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
430 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
431 | 
432 |     // Fallback: "Najnowsze" / "Newest"
433 |     if (!target) {
434 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
435 |     }
436 | 
437 |     if (!target) {
438 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
439 |     }
440 | 
441 |     try {
442 |       target.scrollIntoView({ block: "center", inline: "nearest" });
443 |     } catch {}
444 |     try {
445 |       target.click();
446 |     } catch {}
447 | 
448 |     // close menu
449 |     try {
450 |       setTimeout(() => document.body.click(), 40);
451 |     } catch {}
452 | 
453 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
454 |   });
455 | 
456 |   console.log("[FB][ui:videos][DBG] filter step#2:", JSON.stringify(res2, null, 2));
457 | 
458 |   await sleepRandom(500, 900);
459 | 
460 |   return !!res2?.ok;
461 | }
462 | 
463 | /* ==========================================
464 |    ======= SEQUENTIAL ACTION LOOP ============
465 |    ========================================== */
466 | 
467 | async function oneSequentialAction(page) {
468 |   const res = await page.evaluate(() => {
469 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
470 | 
471 |     function isVisible(el) {
472 |       if (!el) return false;
473 |       const st = getComputedStyle(el);
474 |       if (st.display === "none" || st.visibility === "hidden") return false;
475 |       const r = el.getBoundingClientRect();
476 |       return !!r && r.width > 5 && r.height > 5;
477 |     }
478 | 
479 |     function pick(el) {
480 |       if (!el) return null;
481 |       const r = el.getBoundingClientRect();
482 |       return {
483 |         tag: el.tagName,
484 |         role: el.getAttribute("role"),
485 |         aria: el.getAttribute("aria-label"),
486 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
487 |         top: Math.round(r.top),
488 |         left: Math.round(r.left),
489 |         w: Math.round(r.width),
490 |         h: Math.round(r.height),
491 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
492 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
493 |       };
494 |     }
495 | 
496 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
497 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
498 | 
499 |     const composer =
500 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
501 |       root.querySelector("[aria-label^='Write a comment']") ||
502 |       root.querySelector("[role='textbox'][contenteditable='true']");
503 | 
504 |     let scope = root;
505 |     if (composer) {
506 |       let p = composer.parentElement;
507 |       for (let up = 0; up < 14 && p; up++) {
508 |         const bigEnough = (p.clientHeight || 0) > 220;
509 |         const t = norm(p.innerText || "");
510 |         const looksCommenty =
511 |           t.includes("najtrafniejsze") ||
512 |           t.includes("most relevant") ||
513 |           t.includes("wszystkie komentarze") ||
514 |           t.includes("all comments") ||
515 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
516 |           t.includes("view more comments");
517 |         if (bigEnough && looksCommenty) {
518 |           scope = p;
519 |           break;
520 |         }
521 |         p = p.parentElement;
522 |       }
523 |     }
524 | 
525 |     // UWAGA: klikamy TYLKO elementy klikalne
526 |     const clickables = Array.from(
527 |       scope.querySelectorAll(
528 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
529 |       )
530 |     )
531 |       .filter(isVisible)
532 |       .slice(0, 12000);
533 | 
534 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
535 | 
536 |     const moreCommentNeedles = [
537 |       "wy≈õwietl wiƒôcej komentarzy",
538 |       "zobacz wiƒôcej komentarzy",
539 |       "view more comments",
540 |       "view previous comments",
541 |       "see more comments",
542 |     ];
543 | 
544 |     // 1) MORE COMMENTS ‚Äì tylko clickables
545 |     for (const el of clickables) {
546 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
547 |       if (!t) continue;
548 |       if (bannedExact.has(t)) continue;
549 | 
550 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
551 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
552 |         try { el.click(); } catch {}
553 |         return { acted: true, action: "more-comments", dbg: pick(el) };
554 |       }
555 |     }
556 | 
557 |     // 2) REPLIES ‚Äì tylko clickables
558 |     for (const el of clickables) {
559 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
560 |       if (!t) continue;
561 |       if (bannedExact.has(t)) continue;
562 | 
563 |       const isReply =
564 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
565 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
566 |         t.includes("view more replies") ||
567 |         t.includes("see more replies") ||
568 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
569 | 
570 |       if (isReply) {
571 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
572 |         try { el.click(); } catch {}
573 |         return { acted: true, action: "replies", dbg: pick(el) };
574 |       }
575 |     }
576 | 
577 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
578 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
579 | 
580 |     const beforeScope = scope.scrollTop || 0;
581 |     try {
582 |       if (scope && typeof scope.scrollTop === "number") {
583 |         scope.scrollTop = beforeScope + step;
584 |         const afterScope = scope.scrollTop || beforeScope;
585 |         if (afterScope > beforeScope) {
586 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
587 |         }
588 |       }
589 |     } catch {}
590 | 
591 |     const beforeWin = window.scrollY || 0;
592 |     window.scrollBy(0, step);
593 |     const afterWin = window.scrollY || 0;
594 | 
595 |     return {
596 |       acted: afterWin > beforeWin,
597 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
598 |       dbg: { beforeWin, afterWin, step },
599 |     };
600 |   });
601 | 
602 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
603 |   console.log("[FB][ui:videos][DBG] step:", JSON.stringify(res, null, 2));
604 |   return res || { acted: false, action: "none", dbg: null };
605 | }
606 | 
607 | 
608 | 
609 | /**
610 |  * Wczytuje wszystkie komentarze dla posta wideo.
611 |  */
612 | export async function loadAllComments(page, { expectedTotal } = {}) {
613 |   console.log("[FB][ui:videos] ≈Åadujƒô wszystkie komentarze (VIDEOS)...");
614 | 
615 |   await debugDumpShowAllCandidates(page).catch(() => {});
616 | 
617 |   const mark1 = await markCommentsScope(page).catch(() => null);
618 |   console.log("[FB][ui:videos][DBG] mark#1:", JSON.stringify(mark1, null, 2));
619 | 
620 |   await sleepRandom(250, 500);
621 | 
622 |   // klik show-all z header-row
623 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
624 |   if (clickedAll) {
625 |     await sleepRandom(900, 1400);
626 |     const mark2 = await markCommentsScope(page).catch(() => null);
627 |     console.log("[FB][ui:videos][DBG] mark#2:", JSON.stringify(mark2, null, 2));
628 |   } else {
629 |     console.log("[FB][ui:videos] show-all: nie klikniƒôto (patrz DBG wy≈ºej).");
630 |   }
631 | 
632 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
633 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
634 |   console.log("[FB][ui:videos] filter ensure:", filterOk);
635 | 
636 |   // policz cykle dynamicznie
637 |   let maxCycles = 180;
638 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
639 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
640 |   }
641 | 
642 |   let noProgress = 0;
643 | 
644 |   for (let i = 1; i <= maxCycles; i++) {
645 |     // jedna akcja na cykl
646 |     const r = await oneSequentialAction(page);
647 | 
648 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
649 |     if (!didProgress) noProgress++;
650 |     else noProgress = 0;
651 | 
652 |     console.log(
653 |       `[FB][ui:videos] cycle ${i}/${maxCycles} action=${r?.action} acted=${!!r?.acted} noProgress=${noProgress}`
654 |     );
655 | 
656 |     if (noProgress >= 10) {
657 |       console.log("[FB][ui:videos] Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie.");
658 |       break;
659 |     }
660 | 
661 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
662 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
663 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
664 |     else await sleepRandom(450, 850);
665 |   }
666 | 
667 |   console.log("[FB][ui:videos] Komentarze wideo za≈Çadowane.");
668 | }
669 | 
670 | /**
671 |  * Ekstrahuje komentarze z posta wideo.
672 |  */
673 | export async function extractComments(page, url) {
674 |   const comments = await page.evaluate(() => {
675 |     function getCommentId(href) {
676 |       try {
677 |         const u = new URL(href, location.origin);
678 |         const cid = u.searchParams.get("comment_id");
679 |         const rid = u.searchParams.get("reply_comment_id");
680 |         return rid || cid;
681 |       } catch {
682 |         return null;
683 |       }
684 |     }
685 | 
686 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
687 |     const idToTime = {};
688 | 
689 |     for (let i = 0; i < allLinks.length; i++) {
690 |       const id = getCommentId(allLinks[i].href || "");
691 |       if (id) {
692 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
693 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
694 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
695 |             idToTime[id] = txt;
696 |             break;
697 |           }
698 |         }
699 |       }
700 |     }
701 | 
702 |     const commentBlocks = Array.from(
703 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
704 |     );
705 | 
706 |     const data = commentBlocks
707 |       .map((node) => {
708 |         try {
709 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
710 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
711 |           const linkEl = node.querySelector('a[role="link"]');
712 |           const href = linkEl?.getAttribute("href");
713 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
714 |           const id = permalink ? getCommentId(permalink) : null;
715 |           const time = id && idToTime[id] ? idToTime[id] : null;
716 | 
717 |           if (!author && !text) return null;
718 |           return { id, author, text, permalink, time };
719 |         } catch {
720 |           return null;
721 |         }
722 |       })
723 |       .filter(Boolean);
724 | 
725 |     return data;
726 |   });
727 | 
728 |   console.log(`[FB][ui:videos] Wyekstrahowano komentarzy: ${comments.length}`);
729 |   return comments;
730 | }
731 | 
732 | export async function debugSnapshot(page) {
733 |   try {
734 |     const path = `snapshot-videos.png`;
735 |     await page.screenshot({ path });
736 |     console.log(`[FB][ui:videos] Zapisano zrzut ekranu: ${path}`);
737 |   } catch (e) {
738 |     console.error("[FB][ui:videos] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
739 |   }
740 | }
741 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/watch.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/fb/ui/watch.js
  2 | import { safeGoto } from "../../utils/navigation.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { acceptCookies, saveCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | 
  8 | /** Typ handlera UI */
  9 | export const type = "watch";
 10 | 
 11 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
 12 | export function matchesUrl(url) {
 13 |   try {
 14 |     const u = new URL(url);
 15 |     return (u.pathname || "").toLowerCase().includes("/watch");
 16 |   } catch {
 17 |     return String(url || "").toLowerCase().includes("/watch");
 18 |   }
 19 | }
 20 | 
 21 | /* ============================================================
 22 |    ======================= DEBUG HELPERS ======================
 23 |    ============================================================ */
 24 | 
 25 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
 26 | 
 27 | async function safeShot(page, path, clip = null) {
 28 |   if (!DEBUG_WATCH) return;
 29 |   try {
 30 |     const opts = clip ? { path, clip } : { path, fullPage: false };
 31 |     await page.screenshot(opts);
 32 |     console.log(`[FB][ui:watch][DBG] screenshot -> ${path}`);
 33 |   } catch (e) {
 34 |     console.log("[FB][ui:watch][DBG] screenshot failed:", e?.message || e);
 35 |   }
 36 | }
 37 | 
 38 | async function shotElement(page, handle, path) {
 39 |   if (!DEBUG_WATCH) return;
 40 |   try {
 41 |     if (!handle) return;
 42 |     const box = await handle.boundingBox().catch(() => null);
 43 |     if (!box || box.width < 5 || box.height < 5) {
 44 |       console.log("[FB][ui:watch][DBG] shotElement: no bbox");
 45 |       return;
 46 |     }
 47 |     const clip = {
 48 |       x: Math.max(0, box.x),
 49 |       y: Math.max(0, box.y),
 50 |       width: Math.max(1, Math.min(box.width, 1920)),
 51 |       height: Math.max(1, Math.min(box.height, 1080)),
 52 |     };
 53 |     await safeShot(page, path, clip);
 54 |   } catch (e) {
 55 |     console.log("[FB][ui:watch][DBG] shotElement failed:", e?.message || e);
 56 |   }
 57 | }
 58 | 
 59 | async function debugOuterStats(page, outerHandle) {
 60 |   if (!DEBUG_WATCH) return null;
 61 |   if (!outerHandle) return null;
 62 | 
 63 |   return page.evaluate((outer) => {
 64 |     const norm = (s) =>
 65 |       String(s || "")
 66 |         .replace(/\u00a0/g, " ")
 67 |         .replace(/\s+/g, " ")
 68 |         .trim();
 69 | 
 70 |     const r = outer.getBoundingClientRect();
 71 |     const style = getComputedStyle(outer);
 72 | 
 73 |     const articles = Array.from(outer.querySelectorAll("[role='article']"));
 74 |     const articlesComment = articles.filter((a) => {
 75 |       const aria = (a.getAttribute("aria-label") || "").toLowerCase();
 76 |       return aria.includes("komentarz") || aria.includes("comment");
 77 |     });
 78 | 
 79 |     const anchors = Array.from(
 80 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 81 |     );
 82 | 
 83 |     const allText = (outer.innerText || "").toLowerCase();
 84 |     const moreHits =
 85 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
 86 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
 87 |       (allText.match(/view more comments/g) || []).length +
 88 |       (allText.match(/see more comments/g) || []).length;
 89 | 
 90 |     // TOP aria-labels (czƒôsto w outer widaƒá czy to powiadomienia / sidebar / komentarze)
 91 |     const labels = [];
 92 |     const nodes = Array.from(
 93 |       outer.querySelectorAll("button,div[role='button'],span[role='button'],a,abbr,[role='article']")
 94 |     ).slice(0, 4000);
 95 | 
 96 |     for (const el of nodes) {
 97 |       const a = el.getAttribute?.("aria-label");
 98 |       const t = norm(a);
 99 |       if (t) labels.push(t);
100 |     }
101 | 
102 |     const freq = new Map();
103 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
104 |     const topLabels = Array.from(freq.entries())
105 |       .sort((a, b) => b[1] - a[1])
106 |       .slice(0, 15)
107 |       .map(([k, v]) => ({ label: k, n: v }));
108 | 
109 |     return {
110 |       tag: outer.tagName,
111 |       className: outer.className || "",
112 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
113 |       style: {
114 |         overflowY: style.overflowY,
115 |         position: style.position,
116 |       },
117 |       counts: {
118 |         roleArticle: articles.length,
119 |         roleArticleComment: articlesComment.length,
120 |         anchors: anchors.length,
121 |         moreHits,
122 |       },
123 |       topLabels,
124 |     };
125 |   }, outerHandle);
126 | }
127 | 
128 | async function debugScrollerStats(page, scrollerHandle) {
129 |   if (!DEBUG_WATCH) return null;
130 |   if (!scrollerHandle) return null;
131 | 
132 |   return page.evaluate((s) => {
133 |     const r = s.getBoundingClientRect();
134 |     const st = getComputedStyle(s);
135 |     return {
136 |       tag: s.tagName,
137 |       className: s.className || "",
138 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
139 |       style: { overflowY: st.overflowY, overflow: st.overflow },
140 |       scroll: {
141 |         scrollTop: s.scrollTop,
142 |         clientHeight: s.clientHeight,
143 |         scrollHeight: s.scrollHeight,
144 |       },
145 |     };
146 |   }, scrollerHandle);
147 | }
148 | 
149 | /* ============================================================
150 |    ======================= PARSING COUNT =======================
151 |    ============================================================ */
152 | 
153 | function parseCountFromText(str) {
154 |   if (!str) return null;
155 | 
156 |   const raw = String(str)
157 |     .toLowerCase()
158 |     .replace(/\u00a0/g, " ")
159 |     .replace(/\s+/g, " ")
160 |     .trim();
161 | 
162 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
163 |   if (!m) return null;
164 | 
165 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
166 |   const suf = (m[2] || "").trim();
167 | 
168 |   const hasDecimal = /[.,]\d/.test(numStr);
169 |   if (hasDecimal) numStr = numStr.replace(",", ".");
170 |   else numStr = numStr.replace(/[.,]/g, "");
171 | 
172 |   let n = Number(numStr);
173 |   if (!Number.isFinite(n)) return null;
174 | 
175 |   if (suf === "k") n *= 1000;
176 |   if (suf === "tys" || suf === "tys.") n *= 1000;
177 |   if (suf === "m" || suf === "mln") n *= 1000000;
178 | 
179 |   n = Math.round(n);
180 |   if (n <= 0) return null;
181 |   return n;
182 | }
183 | 
184 | function parseBestCommentsCountFromBlob(blobStr) {
185 |   if (!blobStr) return null;
186 | 
187 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
188 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
189 | 
190 |   let best = null;
191 |   let match;
192 |   while ((match = re.exec(raw)) !== null) {
193 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
194 |     const n = parseCountFromText(candidate);
195 |     if (n && (!best || n > best)) best = n;
196 |   }
197 |   return best;
198 | }
199 | 
200 | /* ============================================================
201 |    =================== COMMENTS CONTAINER FIND =================
202 |    ============================================================ */
203 | 
204 | async function findCommentsOuter(page) {
205 |   // h2 "Komentarze" / "Comments" -> parent
206 |   const h2 = await page
207 |     .$x("//h2[normalize-space()='Komentarze' or normalize-space()='Comments']")
208 |     .then((arr) => arr?.[0] || null);
209 | 
210 |   if (!h2) return null;
211 | 
212 |   const outer = await page.evaluateHandle((node) => {
213 |     const isEl = (x) => x && x.nodeType === 1;
214 |     let cur = node;
215 |     for (let i = 0; i < 10; i++) {
216 |       if (!isEl(cur)) break;
217 |       const el = cur;
218 |       if (el.classList && el.classList.contains("x1jx94hy")) return el;
219 |       cur = el.parentElement;
220 |     }
221 |     return node.parentElement || null;
222 |   }, h2);
223 | 
224 |   const el = outer?.asElement?.() || null;
225 |   if (!el) return null;
226 | 
227 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
228 |   return ok ? el : null;
229 | }
230 | 
231 | async function findScrollableInOuter(page, outerHandle) {
232 |   if (!outerHandle) return null;
233 | 
234 |   const scrollerHandle = await page.evaluateHandle((outer) => {
235 |     function isVisible(el) {
236 |       if (!el) return false;
237 |       const r = el.getBoundingClientRect();
238 |       return r.width > 2 && r.height > 2;
239 |     }
240 | 
241 |     function canScroll(el) {
242 |       try {
243 |         if (!el) return false;
244 |         const st = getComputedStyle(el);
245 |         const oy = (st.overflowY || "").toLowerCase();
246 |         if (!(oy === "auto" || oy === "scroll")) return false;
247 |         const h = el.clientHeight || 0;
248 |         const sh = el.scrollHeight || 0;
249 |         return sh > h + 80;
250 |       } catch {
251 |         return false;
252 |       }
253 |     }
254 | 
255 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
256 |       .filter(isVisible)
257 |       .slice(0, 15000);
258 | 
259 |     let best = null;
260 |     let bestScore = -1;
261 | 
262 |     for (const el of nodes) {
263 |       if (!canScroll(el)) continue;
264 | 
265 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
266 |       const txt = (el.innerText || "").toLowerCase();
267 | 
268 |       const hasMore =
269 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
270 |         txt.includes("view more comments") ||
271 |         txt.includes("see more comments") ||
272 |         txt.includes("zobacz wiƒôcej komentarzy");
273 | 
274 |       const score = delta + (hasMore ? 100000 : 0);
275 |       if (score > bestScore) {
276 |         bestScore = score;
277 |         best = el;
278 |       }
279 |     }
280 | 
281 |     return best || null;
282 |   }, outerHandle);
283 | 
284 |   const el = scrollerHandle?.asElement?.() || null;
285 |   if (!el) return null;
286 | 
287 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
288 |   return ok ? el : null;
289 | }
290 | 
291 | async function clickMoreCommentsIfPresent(page, outerHandle) {
292 |   if (!outerHandle) return false;
293 | 
294 |   const labels = [
295 |     "wy≈õwietl wiƒôcej komentarzy",
296 |     "zobacz wiƒôcej komentarzy",
297 |     "zobacz wcze≈õniejsze komentarze",
298 |     "view more comments",
299 |     "see more comments",
300 |     "show more comments",
301 |     "view previous comments",
302 |   ];
303 | 
304 |   const clicked = await page.evaluate(
305 |     (outer, labelsArr) => {
306 |       const norm = (s) =>
307 |         String(s || "")
308 |           .replace(/\u00a0/g, " ")
309 |           .replace(/\s+/g, " ")
310 |           .trim()
311 |           .toLowerCase();
312 | 
313 |       const isVisible = (el) => {
314 |         if (!el) return false;
315 |         const r = el.getBoundingClientRect();
316 |         return r.width > 2 && r.height > 2;
317 |       };
318 | 
319 |       const nodes = Array.from(
320 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
321 |       ).filter(isVisible);
322 | 
323 |       for (const el of nodes) {
324 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
325 |         if (!t) continue;
326 |         if (labelsArr.some((x) => t.includes(x))) {
327 |           try {
328 |             el.scrollIntoView({ block: "center" });
329 |           } catch {}
330 |           const clickable =
331 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
332 |           try {
333 |             clickable.click();
334 |             return true;
335 |           } catch {}
336 |         }
337 |       }
338 |       return false;
339 |     },
340 |     outerHandle,
341 |     labels
342 |   );
343 | 
344 |   return !!clicked;
345 | }
346 | 
347 | async function getVisibleCommentCount(page, outerHandle) {
348 |   if (!outerHandle) return 0;
349 |   return page
350 |     .evaluate((outer) => {
351 |       const articles = Array.from(outer.querySelectorAll("[role='article']"));
352 |       let count = 0;
353 |       for (const a of articles) {
354 |         const aria = (a.getAttribute("aria-label") || "").toLowerCase();
355 |         if (aria.includes("komentarz") || aria.includes("comment")) count++;
356 |       }
357 |       return count;
358 |     }, outerHandle)
359 |     .catch(() => 0);
360 | }
361 | 
362 | async function getAnchorsCount(page, outerHandle) {
363 |   if (!outerHandle) return 0;
364 |   return page
365 |     .evaluate((outer) => {
366 |       const as = Array.from(
367 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
368 |       );
369 |       const ids = new Set();
370 |       for (const a of as) {
371 |         try {
372 |           const u = new URL(a.href, location.origin);
373 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
374 |           if (id) ids.add(id);
375 |         } catch {}
376 |       }
377 |       return ids.size;
378 |     }, outerHandle)
379 |     .catch(() => 0);
380 | }
381 | 
382 | /* ============================================================
383 |    ============================ API ============================
384 |    ============================================================ */
385 | 
386 | /**
387 |  * Przygotowanie strony dla wideo w Watch.
388 |  * ZASADA: nic nie klikamy poza UI Watch.
389 |  */
390 | export async function prepare(page, url) {
391 |   console.log(`[FB][ui:watch] Otwieranie wideo (Watch): ${url}`);
392 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
393 |   if (!ok) throw new Error("safeGoto-failed");
394 | 
395 |   await acceptCookies(page, "watch-initial");
396 | 
397 |   const currentUrl = page.url();
398 |   if (currentUrl.includes("/login")) {
399 |     console.log("[FB][ui:watch] Wymagane logowanie do Facebook ‚Äì logujƒô...");
400 |     await fbLogin(page);
401 |     await sleepRandom(3000, 4500);
402 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
403 |     console.log(
404 |       `[FB][ui:watch] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
405 |     );
406 |     if (loggedAfterLogin) {
407 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
408 |       await acceptCookies(page, "watch-post-login");
409 |     } else {
410 |       console.log("[FB][ui:watch] Logowanie nie powiod≈Ço siƒô ‚Äì kontynuujƒô bez sesji.");
411 |     }
412 |   } else {
413 |     const logged = await checkIfLogged(page).catch(() => false);
414 |     if (!logged) {
415 |       console.log("[FB][ui:watch] Brak sesji ‚Äì fbLogin().");
416 |       await fbLogin(page);
417 |       await sleepRandom(3000, 4500);
418 |       await acceptCookies(page, "watch-after-login");
419 |       const logged2 = await checkIfLogged(page).catch(() => false);
420 |       console.log(`[FB][ui:watch] Stan sesji po fbLogin: ${logged2 ? "ZALOGOWANY" : "NIEZALOGOWANY"}`);
421 |     }
422 |   }
423 | 
424 |   try {
425 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
426 |     if (loggedFinal) await saveCookies(page);
427 |   } catch {}
428 | 
429 |   await acceptCookies(page, "watch");
430 | 
431 |   // pauza wideo (bez klikania UI)
432 |   try {
433 |     await page.evaluate(() => {
434 |       const vids = Array.from(document.querySelectorAll("video"));
435 |       for (const v of vids) {
436 |         try {
437 |           v.autoplay = false;
438 |           v.removeAttribute("autoplay");
439 |           v.muted = true;
440 |           v.pause();
441 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
442 |         } catch {}
443 |       }
444 |     });
445 |     console.log("[FB][ui:watch] Wideo wstrzymane (pause).");
446 |   } catch (e) {
447 |     console.log("[FB][ui:watch] B≈ÇƒÖd wstrzymania wideo:", e?.message || e);
448 |   }
449 | 
450 |   if (DEBUG_WATCH) {
451 |     await safeShot(page, "watch-prepare.png");
452 |   }
453 | }
454 | 
455 | /**
456 |  * Pobiera liczbƒô komentarzy dla wideo (Watch).
457 |  */
458 | export async function getCommentCount(page, url) {
459 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
460 |   console.log(`[FB][ui:watch][DBG] UI info:`, {
461 |     source: uiInfo?.source,
462 |     raw: uiInfo?.raw ? String(uiInfo.raw).slice(0, 250) + "..." : null,
463 |     viewType: uiInfo?.viewType,
464 |     comments: uiInfo?.comments,
465 |   });
466 | 
467 |   let totalComments = null;
468 | 
469 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
470 |     totalComments = uiInfo.comments;
471 |   } else if (uiInfo?.raw) {
472 |     const parsed = parseBestCommentsCountFromBlob(uiInfo.raw);
473 |     if (parsed) {
474 |       totalComments = parsed;
475 |       console.log(`[FB][ui:watch][DBG] Parsed from uiInfo.raw => ${parsed}`);
476 |     }
477 |   }
478 | 
479 |   console.log(`[FB][ui:watch] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`);
480 |   return totalComments;
481 | }
482 | 
483 | /**
484 |  * Wczytuje wszystkie komentarze w trybie Watch.
485 |  * -> jedyne kliki: "Wy≈õwietl wiƒôcej komentarzy"
486 |  * -> scroll: wheel na kontenerze komentarzy
487 |  */
488 | export async function loadAllComments(page, { expectedTotal } = {}) {
489 |   console.log("[FB][ui:watch] ≈Åadujƒô wszystkie komentarze (Watch)...");
490 | 
491 |   let maxCycles = 40;
492 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
493 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
494 |   }
495 |   console.log(`[FB][ui:watch] Rozpoczynam sekwencyjne ≈Çadowanie komentarzy, maxCycles=${maxCycles}.`);
496 | 
497 |   const outer = await findCommentsOuter(page);
498 |   if (!outer) {
499 |     console.log("[FB][ui:watch][DBG] OUTER NOT FOUND -> return");
500 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
501 |     return;
502 |   }
503 | 
504 |   if (DEBUG_WATCH) {
505 |     const stats = await debugOuterStats(page, outer);
506 |     console.log("[FB][ui:watch][DBG] OUTER stats:", stats);
507 |     await shotElement(page, outer, "watch-outer.png");
508 |   }
509 | 
510 |   const scroller = await findScrollableInOuter(page, outer);
511 |   if (!scroller) {
512 |     console.log("[FB][ui:watch][DBG] SCROLLER NOT FOUND -> return");
513 |     if (DEBUG_WATCH) {
514 |       const stats = await debugOuterStats(page, outer);
515 |       console.log("[FB][ui:watch][DBG] OUTER stats (no scroller):", stats);
516 |       await safeShot(page, "watch-no-scroller.png");
517 |     }
518 |     return;
519 |   }
520 | 
521 |   if (DEBUG_WATCH) {
522 |     const sstats = await debugScrollerStats(page, scroller);
523 |     console.log("[FB][ui:watch][DBG] SCROLLER stats:", sstats);
524 |     await shotElement(page, scroller, "watch-scroller.png");
525 |   }
526 | 
527 |   let prevArticles = await getVisibleCommentCount(page, outer);
528 |   let prevAnchors = await getAnchorsCount(page, outer);
529 |   let noProgress = 0;
530 | 
531 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
532 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
533 | 
534 |     // scrollTop before/after
535 |     let beforeST = 0;
536 |     let afterST = 0;
537 |     try {
538 |       beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
539 |     } catch {}
540 | 
541 |     let wheeled = false;
542 |     try {
543 |       const box = await scroller.boundingBox();
544 |       if (box && box.width > 5 && box.height > 5) {
545 |         await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
546 |         await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
547 |         wheeled = true;
548 |       }
549 |     } catch {}
550 | 
551 |     await sleepRandom(450, 850);
552 | 
553 |     try {
554 |       afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
555 |     } catch {}
556 | 
557 |     const curArticles = await getVisibleCommentCount(page, outer);
558 |     const curAnchors = await getAnchorsCount(page, outer);
559 | 
560 |     const progressed = curArticles > prevArticles || curAnchors > prevAnchors;
561 | 
562 |     if (progressed) {
563 |       prevArticles = curArticles;
564 |       prevAnchors = curAnchors;
565 |       noProgress = 0;
566 |     } else {
567 |       noProgress++;
568 |     }
569 | 
570 |     console.log(
571 |       `[FB][ui:watch][DBG] cycle ${cycle}/${maxCycles}: clickedMore=${clicked}, wheel=${wheeled}, scrollTop ${beforeST} -> ${afterST}, articles=${curArticles}, anchors=${curAnchors}, noProgress=${noProgress}`
572 |     );
573 | 
574 |     if (DEBUG_WATCH && cycle === 5) {
575 |       await safeShot(page, "watch-after-5.png");
576 |     }
577 | 
578 |     if (noProgress >= 6) {
579 |       console.log("[FB][ui:watch] Brak postƒôpu przez kilka cykli ‚Äì przerywam.");
580 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
581 |       break;
582 |     }
583 |   }
584 | 
585 |   console.log("[FB][ui:watch] Za≈Çadowano wszystkie dostƒôpne komentarze (Watch).");
586 | }
587 | 
588 | /**
589 |  * Ekstrahuje komentarze spod wideo (Watch).
590 |  * (szerszy selektor: role=article + aria-label)
591 |  */
592 | export async function extractComments(page, url) {
593 |   const comments = await page.evaluate(() => {
594 |     function getCommentId(href) {
595 |       try {
596 |         const u = new URL(href, location.origin);
597 |         const cid = u.searchParams.get("comment_id");
598 |         const rid = u.searchParams.get("reply_comment_id");
599 |         return rid || cid;
600 |       } catch {
601 |         return null;
602 |       }
603 |     }
604 | 
605 |     function pickText(el) {
606 |       if (!el) return "";
607 |       return (el.textContent || "")
608 |         .replace(/\u00a0/g, " ")
609 |         .replace(/\s+/g, " ")
610 |         .trim();
611 |     }
612 | 
613 |     const articles = Array.from(document.querySelectorAll("[role='article']")).filter((a) => {
614 |       const aria = (a.getAttribute("aria-label") || "").toLowerCase();
615 |       return aria.includes("komentarz") || aria.includes("comment");
616 |     });
617 | 
618 |     const out = [];
619 | 
620 |     for (const art of articles) {
621 |       try {
622 |         const linkEl = art.querySelector("a[href*='comment_id='], a[href*='reply_comment_id=']");
623 |         const href = linkEl?.href || null;
624 |         const id = href ? getCommentId(href) : null;
625 | 
626 |         const author =
627 |           pickText(art.querySelector("a[role='link'] span")) ||
628 |           pickText(art.querySelector("strong")) ||
629 |           null;
630 | 
631 |         let text = "";
632 |         const autos = Array.from(art.querySelectorAll("[dir='auto']")).map(pickText).filter(Boolean);
633 |         if (autos.length) {
634 |           text = autos.length >= 2 ? autos[autos.length - 1] : autos[0];
635 |         }
636 | 
637 |         const permalink = href || null;
638 |         if (!author && !text) continue;
639 | 
640 |         out.push({ id, author, text, permalink, time: null });
641 |       } catch {}
642 |     }
643 | 
644 |     return out;
645 |   });
646 | 
647 |   console.log(`[FB][ui:watch] Wyekstrahowano komentarzy: ${comments.length}`);
648 |   return comments;
649 | }
650 | 
651 | export async function debugSnapshot(page) {
652 |   try {
653 |     const path = `snapshot-watch.png`;
654 |     await page.screenshot({ path });
655 |     console.log(`[FB][ui:watch] Zapisano zrzut ekranu: ${path}`);
656 |   } catch (e) {
657 |     console.error("[FB][ui:watch] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
658 |   }
659 | }
660 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  

```js
  1 | // src/watcher.js
  2 | import puppeteer from "puppeteer";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import {
  6 |   EXPAND_COMMENTS,
  7 |   CHECK_INTERVAL_MS,
  8 |   POSTS_SHEET_URL,
  9 |   POSTS_REFRESH_MS,
 10 | } from "./config.js";
 11 | 
 12 | import {
 13 |   prepare,
 14 |   getCommentCount,
 15 |   loadAllComments,
 16 |   extractCommentsData,
 17 | } from "./fb/comments.js";
 18 | 
 19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
 20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
 21 | import { sendWebhook } from "./webhook.js";
 22 | import { loadCache, saveCache } from "./db/cache.js";
 23 | 
 24 | /**
 25 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
 26 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
 27 |  *
 28 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
 29 |  * POSTS_FILE=C:\Projekty vs\FB_Watcher\data\posts.json
 30 |  */
 31 | const POSTS_FILE =
 32 |   process.env.POSTS_FILE ||
 33 |   path.join(process.cwd(), "data", "posts.json");
 34 | 
 35 | /**
 36 |  * CACHE DYSKOWY:
 37 |  * {
 38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
 39 |  * }
 40 |  */
 41 | const commentsCache = loadCache();
 42 | const lastCounts = new Map(); // url -> lastCount
 43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
 44 | 
 45 | for (const [url, entry] of Object.entries(commentsCache)) {
 46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
 47 |   if (Array.isArray(entry?.knownIds))
 48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
 49 | }
 50 | 
 51 | let currentPosts = [];
 52 | let lastRefreshAny = 0; // wsp√≥lny zegar od≈õwie≈ºania ≈∫r√≥de≈Ç
 53 | 
 54 | let navErrorCount = 0;
 55 | const MAX_NAV_ERRORS = 5;
 56 | 
 57 | function isNavigationError(err) {
 58 |   if (!err) return false;
 59 |   const msg = String(err.message || err).toLowerCase();
 60 |   return (
 61 |     msg.includes("safegoto-failed") ||
 62 |     msg.includes("navigation timeout") ||
 63 |     msg.includes("net::err_connection_timed_out") ||
 64 |     msg.includes("net::err_timed_out")
 65 |   );
 66 | }
 67 | 
 68 | /* ============================================================
 69 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
 70 |    ============================================================ */
 71 | 
 72 | async function applyStealth(page) {
 73 |   await page.evaluateOnNewDocument(() => {
 74 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
 75 |     // @ts-ignore
 76 |     window.chrome = window.chrome || { runtime: {} };
 77 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
 78 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
 79 | 
 80 |     const permissions = window.navigator.permissions;
 81 |     if (permissions && permissions.query) {
 82 |       const originalQuery = permissions.query.bind(permissions);
 83 |       permissions.query = (parameters) => {
 84 |         if (
 85 |           parameters &&
 86 |           parameters.name === "notifications" &&
 87 |           window.Notification
 88 |         ) {
 89 |           return Promise.resolve({ state: window.Notification.permission });
 90 |         }
 91 |         return originalQuery(parameters);
 92 |       };
 93 |     }
 94 |   });
 95 | }
 96 | 
 97 | /* ============================================================
 98 |    ===============   PANEL POSTS (data/posts.json)   ===========
 99 |    ============================================================ */
100 | 
101 | function safeJsonParse(s) {
102 |   try {
103 |     return { ok: true, value: JSON.parse(s) };
104 |   } catch (e) {
105 |     return { ok: false, error: e?.message || "Invalid JSON" };
106 |   }
107 | }
108 | 
109 | function normalizeUrl(u) {
110 |   if (!u) return "";
111 |   const x = String(u).trim();
112 |   if (!/^https?:\/\/.+/i.test(x)) return "";
113 |   return x;
114 | }
115 | 
116 | function readPanelPosts() {
117 |   try {
118 |     if (!fs.existsSync(POSTS_FILE)) {
119 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
120 |     }
121 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
122 |     if (!raw) {
123 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
124 |     }
125 |     const parsed = safeJsonParse(raw);
126 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
127 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
128 |     }
129 | 
130 |     const posts = parsed.value
131 |       .map((p) => {
132 |         const url = normalizeUrl(p?.url);
133 |         const active = Boolean(p?.active);
134 |         if (!url) return null;
135 |         return {
136 |           id: String(p?.id || url),
137 |           url,
138 |           active,
139 |           name: p?.name ? String(p.name) : "",
140 |           image: p?.image ? String(p.image) : "",
141 |           description: p?.description ? String(p.description) : "",
142 |         };
143 |       })
144 |       .filter(Boolean);
145 | 
146 |     const activePosts = posts.filter((p) => p.active);
147 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
148 |   } catch (e) {
149 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
150 |   }
151 | }
152 | 
153 | /* ============================================================
154 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
155 |    ============================================================ */
156 | 
157 | function parseSheetCsv(text) {
158 |   const lines = text
159 |     .split(/\r?\n/)
160 |     .map((l) => l.trim())
161 |     .filter((l) => l.length > 0);
162 | 
163 |   if (!lines.length) {
164 |     console.warn("[Sheet] Pusty CSV z arkusza.");
165 |     return [];
166 |   }
167 | 
168 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
169 | 
170 |   const idxUrl = header.findIndex((h) => h === "url");
171 |   const idxActive = header.findIndex((h) => h === "active");
172 | 
173 |   // nowe kolumny od klienta
174 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
175 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
176 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
177 | 
178 |   if (idxUrl === -1) {
179 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
180 |     return [];
181 |   }
182 | 
183 |   const posts = [];
184 | 
185 |   for (let i = 1; i < lines.length; i++) {
186 |     const row = lines[i].split(",");
187 |     const rawUrl = (row[idxUrl] || "").trim();
188 |     if (!rawUrl) continue;
189 | 
190 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
191 |     const activeNorm = activeRaw.toLowerCase();
192 |     const isActive =
193 |       idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
194 | 
195 |     if (!isActive) continue;
196 | 
197 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
198 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
199 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
200 | 
201 |     posts.push({
202 |       id: `sheet-${i}`,
203 |       url: rawUrl,
204 |       name,
205 |       image,
206 |       description,
207 |     });
208 |   }
209 | 
210 |   return posts;
211 | }
212 | 
213 | /* ============================================================
214 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
215 |    ============================================================ */
216 | 
217 | async function refreshPostsIfNeeded(force = false) {
218 |   const now = Date.now();
219 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
220 |   lastRefreshAny = now;
221 | 
222 |   // 1) PRIMARY: panel posts.json
223 |   const panel = readPanelPosts();
224 |   if (panel.ok && panel.posts.length > 0) {
225 |     const newPosts = panel.posts;
226 | 
227 |     const oldJson = JSON.stringify(currentPosts);
228 |     const newJson = JSON.stringify(newPosts);
229 | 
230 |     if (oldJson !== newJson) {
231 |       console.log(
232 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
233 |       );
234 |       currentPosts = newPosts;
235 |     } else {
236 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
237 |     }
238 |     return;
239 |   }
240 | 
241 |   console.log(
242 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
243 |   );
244 | 
245 |   // 2) FALLBACK: Sheets
246 |   if (!POSTS_SHEET_URL) {
247 |     console.warn(
248 |       "[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza."
249 |     );
250 |     currentPosts = [];
251 |     return;
252 |   }
253 | 
254 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
255 | 
256 |   try {
257 |     const res = await fetch(POSTS_SHEET_URL);
258 |     if (!res.ok) {
259 |       console.error(
260 |         "[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:",
261 |         res.status,
262 |         res.statusText
263 |       );
264 |       currentPosts = [];
265 |       return;
266 |     }
267 | 
268 |     const csvText = await res.text();
269 |     const newPosts = parseSheetCsv(csvText);
270 | 
271 |     if (!newPosts.length) {
272 |       console.warn(
273 |         "[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE)."
274 |       );
275 |       currentPosts = [];
276 |       return;
277 |     }
278 | 
279 |     const oldJson = JSON.stringify(currentPosts);
280 |     const newJson = JSON.stringify(newPosts);
281 | 
282 |     if (oldJson !== newJson) {
283 |       console.log(
284 |         `[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`
285 |       );
286 |       currentPosts = newPosts;
287 |     } else {
288 |       console.log("[Sheet] Lista post√≥w bez zmian.");
289 |     }
290 |   } catch (err) {
291 |     console.error(
292 |       "[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:",
293 |       err.message
294 |     );
295 |     currentPosts = [];
296 |   }
297 | }
298 | 
299 | /* ============================================================
300 |    =====================   CACHE HELPERS   =====================
301 |    ============================================================ */
302 | 
303 | function getCacheKey(post) {
304 |   return post.url;
305 | }
306 | 
307 | function getKnownSetForPost(cacheKey) {
308 |   let set = knownCommentsPerPost.get(cacheKey);
309 |   if (!set) {
310 |     const entry = commentsCache[cacheKey];
311 |     set =
312 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
313 |     knownCommentsPerPost.set(cacheKey, set);
314 |   }
315 |   return set;
316 | }
317 | 
318 | function flushCacheToDisk() {
319 |   const out = { ...commentsCache };
320 | 
321 |   for (const [cacheKey, count] of lastCounts.entries()) {
322 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
323 |     out[cacheKey].lastCount = count;
324 |   }
325 | 
326 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
327 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
328 |     out[cacheKey].knownIds = Array.from(set);
329 |   }
330 | 
331 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
332 |   Object.assign(commentsCache, out);
333 |   saveCache(out);
334 | }
335 | 
336 | /* ============================================================
337 |    =====================   G≈Å√ìWNY WATCHER   ===================
338 |    ============================================================ */
339 | 
340 | const isDev = process.env.NODE_ENV !== "production";
341 | 
342 | async function startWatcher() {
343 |   console.log(
344 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
345 |     Math.round(CHECK_INTERVAL_MS / 1000),
346 |     "sekund."
347 |   );
348 | 
349 |   const loop = async () => {
350 |     let browser = null;
351 |     let page = null;
352 |     let hadNavErrorThisRound = false;
353 | 
354 |     try {
355 |       console.log(
356 |         "[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="
357 |       );
358 | 
359 |       browser = await puppeteer.launch({
360 |         headless: isDev ? true : "new",
361 |         defaultViewport: null,
362 |         args: [
363 |           "--no-sandbox",
364 |           "--disable-setuid-sandbox",
365 |           "--disable-dev-shm-usage",
366 |           "--disable-notifications",
367 |           "--disable-blink-features=AutomationControlled",
368 |         ],
369 |         ignoreDefaultArgs: ["--enable-automation"],
370 |       });
371 | 
372 |       page = await browser.newPage();
373 |       await applyStealth(page);
374 | 
375 |       page.setDefaultNavigationTimeout(90000);
376 |       page.setDefaultTimeout(90000);
377 | 
378 |       await page.setViewport({ width: 1280, height: 720 });
379 | 
380 |       // cookies + login
381 |       await loadCookies(page);
382 |       await page
383 |         .goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 })
384 |         .catch(() => {});
385 | 
386 |       let loggedIn = await checkIfLogged(page);
387 |       if (!loggedIn) {
388 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
389 |         await fbLogin(page);
390 |         loggedIn = await checkIfLogged(page);
391 | 
392 |         if (loggedIn) {
393 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
394 |           await saveCookies(page);
395 |         } else {
396 |           console.error(
397 |             "[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone)."
398 |           );
399 |         }
400 |       } else {
401 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
402 |       }
403 | 
404 |       // posts
405 |       await refreshPostsIfNeeded(true);
406 | 
407 |       if (!currentPosts.length) {
408 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
409 |       } else {
410 |         for (const post of currentPosts) {
411 |           const cacheKey = getCacheKey(post);
412 | 
413 |           try {
414 |             // zawsze prepare przed liczeniem/scrollowaniem/ekstrakcjƒÖ
415 |             await prepare(page, post.url);
416 | 
417 |             const count = await getCommentCount(page, post.url);
418 |             const hasCount = typeof count === "number" && Number.isFinite(count);
419 | 
420 |             if (!hasCount) {
421 |               console.log(
422 |                 `[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`
423 |               );
424 |             }
425 | 
426 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
427 |             const knownSet = getKnownSetForPost(cacheKey);
428 | 
429 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
430 |             if (prev === null) {
431 |               const initialCount = hasCount ? count : 0;
432 |               lastCounts.set(cacheKey, initialCount);
433 | 
434 |               console.log(
435 |                 hasCount
436 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
437 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
438 |               );
439 | 
440 |               if (EXPAND_COMMENTS) {
441 |                 await loadAllComments(
442 |                   page,
443 |                   { expectedTotal: hasCount ? count : undefined },
444 |                   post.url
445 |                 ).catch(() => {});
446 | 
447 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
448 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
449 |                 console.log(
450 |                   `[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`
451 |                 );
452 |               } else {
453 |                 console.log(
454 |                   `[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`
455 |                 );
456 |               }
457 | 
458 |               continue;
459 |             }
460 | 
461 |             // licznik: aktualizuj tylko je≈õli mamy twarde dane
462 |             if (hasCount) {
463 |               if (count !== prev) {
464 |                 console.log(
465 |                   `[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`
466 |                 );
467 |                 lastCounts.set(cacheKey, count);
468 |               } else {
469 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
470 |               }
471 |             } else {
472 |               console.log(
473 |                 `[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`
474 |               );
475 |             }
476 | 
477 |             if (!EXPAND_COMMENTS) continue;
478 | 
479 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(
480 |               () => {}
481 |             );
482 | 
483 |             let snapshot = await extractCommentsData(page, post.url).catch(() => []);
484 | 
485 |             // nowe ID
486 |             const newComments = [];
487 |             for (const c of snapshot) {
488 |               if (!c?.id) continue;
489 |               if (!knownSet.has(c.id)) {
490 |                 knownSet.add(c.id);
491 |                 newComments.push(c);
492 |               }
493 |             }
494 | 
495 |             // fallback "tail" tylko je≈õli mamy wiarygodny licznik i wzrost
496 |             if (hasCount && newComments.length === 0 && count > prev) {
497 |               const diff = Math.max(1, count - prev);
498 |               const tail = snapshot.slice(-diff);
499 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
500 | 
501 |               console.log(
502 |                 `[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`
503 |               );
504 |               await sendWebhook(post, tail, count, prev);
505 |               continue;
506 |             }
507 | 
508 |             if (newComments.length > 0) {
509 |               console.log(
510 |                 `[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`
511 |               );
512 |               await sendWebhook(
513 |                 post,
514 |                 newComments,
515 |                 hasCount ? count : null,
516 |                 hasCount ? prev : null
517 |               );
518 |             } else {
519 |               console.log(
520 |                 `[Watcher] Post ${post.id}: Brak nowych komentarzy (po ID i fallbacku).`
521 |               );
522 |             }
523 |           } catch (err) {
524 |             console.error(
525 |               `[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`,
526 |               err?.message || err
527 |             );
528 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
529 | 
530 |             if (isNavigationError(err)) {
531 |               hadNavErrorThisRound = true;
532 |               navErrorCount++;
533 |               console.log(
534 |                 `[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`
535 |               );
536 |             }
537 |           }
538 |         }
539 |       }
540 |     } catch (err) {
541 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
542 |     } finally {
543 |       flushCacheToDisk();
544 | 
545 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
546 |         console.log(
547 |           `[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`
548 |         );
549 |         navErrorCount = 0;
550 |       }
551 | 
552 |       if (browser) {
553 |         try {
554 |           await browser.close();
555 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
556 |         } catch (e) {
557 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
558 |         }
559 |       }
560 | 
561 |       if (navErrorCount >= MAX_NAV_ERRORS) {
562 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
563 |         process.exit(1);
564 |       }
565 | 
566 |       const jitter = Math.floor(Math.random() * 5000);
567 |       const delay = CHECK_INTERVAL_MS + jitter;
568 |       console.log(
569 |         `[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`
570 |       );
571 |       setTimeout(loop, delay);
572 |     }
573 |   };
574 | 
575 |   loop();
576 | }
577 | 
578 | export { startWatcher };
579 | 
```

---

### üìÑ ≈öcie≈ºka: `export_fb_watcher/webhook.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/webhook.js
  2 | import axios from "axios";
  3 | import { POST_LABELS } from "./config.js";
  4 | 
  5 | /* ============================================================
  6 |    PARSER CZASU FB ‚Üí ISO
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 | 
 12 |   const t = raw.toLowerCase().trim();
 13 |   const now = new Date();
 14 | 
 15 |   if (t.includes("przed chwilƒÖ")) return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
 24 |   if (!m) return null;
 25 | 
 26 |   const value = parseInt(m[1], 10);
 27 |   if (!Number.isFinite(value)) return null;
 28 | 
 29 |   const unit = m[2];
 30 |   const d = new Date(now);
 31 | 
 32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
 33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
 34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
 35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
 36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
 37 | 
 38 |   return d;
 39 | }
 40 | 
 41 | /* ============================================================
 42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
 43 |    ============================================================ */
 44 | 
 45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
 46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 47 | 
 48 | function filterByAge(comments) {
 49 |   const now = Date.now();
 50 | 
 51 |   return comments.filter((c) => {
 52 |     if (!c.time || c.time.trim() === "") return false;
 53 | 
 54 |     const abs = parseFbRelativeTime(c.time);
 55 |     if (!abs) return false;
 56 | 
 57 |     const ageMinutes = (now - abs.getTime()) / 60000;
 58 |     return ageMinutes <= MAX_AGE_MIN;
 59 |   });
 60 | }
 61 | 
 62 | /* ============================================================
 63 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
 64 |    ============================================================ */
 65 | 
 66 | async function sendWebhook(post, newComments, newCount, oldCount) {
 67 |   const url = process.env.WEBHOOK_URL;
 68 |   if (!url) {
 69 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
 70 |     return;
 71 |   }
 72 | 
 73 |   // meta posta (panel/sheets/env fallback)
 74 |   const postName =
 75 |     (post?.name && String(post.name).trim()) ||
 76 |     POST_LABELS[post?.id] ||
 77 |     post?.id ||
 78 |     "post";
 79 | 
 80 |   const postImage =
 81 |     (post?.image && String(post.image).trim()) || null;
 82 | 
 83 |   const postDescription =
 84 |     (post?.description && String(post.description).trim()) || null;
 85 | 
 86 |   /* --------------------------------------------
 87 |        1) Normalizacja czasu i dodanie p√≥l ISO
 88 |      -------------------------------------------- */
 89 | 
 90 |   const normalized = newComments.map((c) => {
 91 |     const iso = parseFbRelativeTime(c.time);
 92 |     return {
 93 |       ...c,
 94 |       fb_time_raw: c.time || null,
 95 |       fb_time_iso: iso ? iso.toISOString() : null,
 96 |     };
 97 |   });
 98 | 
 99 |   /* --------------------------------------------
100 |        2) Filtrowanie komentarzy po wieku
101 |      -------------------------------------------- */
102 | 
103 |   const freshOnly = filterByAge(normalized);
104 | 
105 |   console.log("[Webhook] Filtr wieku komentarzy:", {
106 |     before: normalized.length,
107 |     after: freshOnly.length,
108 |     maxAgeMin: MAX_AGE_MIN,
109 |   });
110 | 
111 |   if (freshOnly.length === 0) {
112 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
113 |     return;
114 |   }
115 | 
116 |   /* --------------------------------------------
117 |        3) Payload do webhooka
118 |      -------------------------------------------- */
119 | 
120 |   const payload = {
121 |     post: {
122 |       id: post?.id || null,
123 |       url: post?.url || null,
124 |       name: postName,
125 |       image: postImage,
126 |       description: postDescription,
127 |     },
128 |     commentCount: newCount,
129 |     previousCommentCount: oldCount,
130 |     newComments: freshOnly,
131 |     timestamp: new Date().toISOString(),
132 |   };
133 | 
134 |   console.log("[Webhook] Wysy≈Çanie danych o nowych komentarzach:", payload);
135 | 
136 |   /* --------------------------------------------
137 |        4) Wysy≈Çka do Make / webhooka
138 |      -------------------------------------------- */
139 | 
140 |   try {
141 |     await axios.post(url, payload, { timeout: 10000 });
142 |     console.log("[Webhook] Wys≈Çano nowe komentarze do webhooka.");
143 |   } catch (err) {
144 |     console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err.message);
145 |   }
146 | }
147 | 
148 | export { sendWebhook };
149 | 
```

---

### üìÑ ≈öcie≈ºka: `export_files.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // export_files.js
 2 | import fs from "fs";
 3 | import path from "path";
 4 | 
 5 | const ROOT = process.cwd();
 6 | const EXPORT_DIR = path.join(ROOT, "export_chat_context");
 7 | 
 8 | // MAKS 18 PLIK√ìW ‚Äî FULL KONTEKST DO PRACY
 9 | const FILES = [
10 |   // 1‚Äì3: start i cykl ≈ºycia
11 |   "src/index.js",
12 |   "src/watcher.js",
13 |   "src/config.js",
14 | 
15 |   // 4‚Äì5: wyj≈õcia / integracje
16 |   "src/telegram.js",
17 |   "src/webhook.js",
18 | 
19 |   // 6‚Äì10: FB core (komentarze + scroll + login)
20 |   "src/fb/comments.js",
21 |   "src/fb/scroll.js",
22 |   "src/fb/login.js",
23 |   "src/fb/cookies.js",
24 |   "src/fb/expandButtons.js",
25 | 
26 |   // 11‚Äì15: router + kluczowe UI layouty
27 |   "src/fb/ui/index.js",
28 |   "src/fb/ui/post.js",
29 |   "src/fb/ui/photo.js",
30 |   "src/fb/ui/watch.js",
31 |   "src/fb/ui/videos.js",
32 | 
33 |   // 16‚Äì17: stabilno≈õƒá
34 |   "src/utils/navigation.js",
35 |   "src/utils/sleep.js",
36 | 
37 |   // 18: PANEL API (≈ºeby wiedzieƒá jak panel steruje backendem)
38 |   "src/panel/api.js",
39 |   "src/panel/ui/index.html",
40 |   "src/panel/ui/app.js",
41 | ];
42 | 
43 | function ensureDir(p) {
44 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
45 | }
46 | 
47 | console.log("=== EXPORT CHAT CONTEXT (MAX 18 FILES) ===");
48 | 
49 | if (fs.existsSync(EXPORT_DIR)) {
50 |   fs.rmSync(EXPORT_DIR, { recursive: true, force: true });
51 | }
52 | ensureDir(EXPORT_DIR);
53 | 
54 | FILES.forEach((file, idx) => {
55 |   const src = path.join(ROOT, file);
56 |   if (!fs.existsSync(src)) {
57 |     console.log(`‚ö†Ô∏è  Brak: ${file}`);
58 |     return;
59 |   }
60 | 
61 |   const num = String(idx + 1).padStart(2, "0");
62 |   const dst = path.join(EXPORT_DIR, `${num}__${path.basename(file)}`);
63 | 
64 |   fs.copyFileSync(src, dst);
65 |   console.log(`‚úì ${num} ${file}`);
66 | });
67 | 
68 | console.log("\n=== GOTOWE ===");
69 | console.log(`‚û°Ô∏è Wklej tutaj pliki z folderu: ${EXPORT_DIR}`);
70 | 
```

---

### üìÑ ≈öcie≈ºka: `Rozwoj.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

```md
  1 | # FB Watcher ‚Äî koncepcja dzia≈Çania panelu (pod integracjƒô backendu)
  2 | 
  3 | Ten dokument opisuje **jak ma dzia≈Çaƒá panel administratora** dla systemu FB Watcher.
  4 | Panel jest **centrum sterowania**, backend (scrapery / workerzy) bƒôdzie dopinany etapami.
  5 | 
  6 | Panel:
  7 | - przechowuje konfiguracjƒô,
  8 | - zbiera wykrycia (discoveries),
  9 | - umo≈ºliwia zatwierdzanie,
 10 | - zarzƒÖdza obserwacjƒÖ i akcjami (alerty, autoposting).
 11 | 
 12 | ---
 13 | 
 14 | ## Wsp√≥lny schemat dzia≈Çania
 15 | 
 16 | ≈πR√ìD≈ÅO ‚Üí WYKRYCIE (DISCOVERY) ‚Üí ZATWIERDZENIE ‚Üí OBSERWACJA / AKCJA
 17 | 
 18 | Panel **nie scrapuje** ‚Äî panel **zarzƒÖdza i decyduje**.
 19 | 
 20 | ---
 21 | 
 22 | ## 1. PrzeglƒÖdanie g≈Ç√≥wnej strony Facebooka (Home / Feed)
 23 | 
 24 | ### Cel
 25 | Automatyczne wykrywanie post√≥w z **g≈Ç√≥wnej tablicy Facebooka** (Home / Feed),
 26 | czyli tego, co realnie pojawia siƒô u≈ºytkownikowi po zalogowaniu:
 27 | - posty stron,
 28 | - posty publiczne,
 29 | - posty sponsorowane,
 30 | - tre≈õci powiƒÖzane z zainteresowaniami.
 31 | 
 32 | ### Jak to dzia≈Ça
 33 | 1. W panelu konfigurowane sƒÖ:
 34 |    - tryb skanowania **g≈Ç√≥wnej strony Facebooka**,
 35 |    - zestawy s≈Ç√≥w kluczowych.
 36 | 2. Backend cyklicznie przeglƒÖda g≈Ç√≥wny feed Facebooka.
 37 | 3. Ka≈ºdy post dopasowany do s≈Ç√≥w kluczowych trafia do panelu jako **Wykrycie (Discovery)**.
 38 | 4. Operator w panelu:
 39 |    - **Zatwierdza** ‚Üí post zostaje dodany do listy obserwowanych (Watcher),
 40 |    - **Odrzuca** ‚Üí wykrycie jest ignorowane.
 41 | 
 42 | ### Panel musi posiadaƒá
 43 | - konfiguracjƒô skanowania strony g≈Ç√≥wnej Facebooka,
 44 | - listƒô wykryƒá z typu `home_feed`,
 45 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
 46 | 
 47 | ---
 48 | 
 49 | ## 2. Scrapping grup Facebooka
 50 | 
 51 | ### Cel
 52 | Wychwytywanie zapyta≈Ñ i lead√≥w z grup bran≈ºowych.
 53 | 
 54 | ### Jak to dzia≈Ça
 55 | 1. W panelu dodawane sƒÖ:
 56 |    - grupy Facebook,
 57 |    - przypisane zestawy s≈Ç√≥w kluczowych.
 58 | 2. Backend skanuje nowe posty w grupach.
 59 | 3. Dopasowania trafiajƒÖ do **Wykryƒá (Discovery)** z typem `group_post`.
 60 | 4. Operator:
 61 |    - zatwierdza ‚Üí (opcjonalnie) dodaje post do obserwowanych,
 62 |    - odrzuca ‚Üí ignor.
 63 | 
 64 | ### Panel musi posiadaƒá
 65 | - listƒô grup,
 66 | - przypisywanie keyword√≥w,
 67 | - decyzjƒô na wykryciu: `dodaj do obserwowanych` / `tylko alert`.
 68 | 
 69 | ---
 70 | 
 71 | ## 3. Meta Ads (reklamy konkurencji)
 72 | 
 73 | ### Cel
 74 | Monitoring reklam konkurencji i wyciƒÖganie konkretnych reklam/post√≥w do dalszej obserwacji.
 75 | 
 76 | ### Jak to dzia≈Ça
 77 | 1. W panelu definiowane sƒÖ:
 78 |    - konkurencja (opcjonalnie),
 79 |    - s≈Çowa kluczowe.
 80 | 2. Backend skanuje Meta Ads Library.
 81 | 3. Znalezione reklamy trafiajƒÖ do **Wykryƒá (Discovery)**:
 82 |    - link do reklamy,
 83 |    - reklamodawca,
 84 |    - typ (grafika / wideo),
 85 |    - opis.
 86 | 4. Panel posiada wyszukiwarkƒô wykryƒá.
 87 | 5. Po **zatwierdzeniu**:
 88 |    - je≈õli reklama ma publiczny link/post ‚Üí trafia do obserwowanych link√≥w watchera,
 89 |    - reklama zostaje przypisana do istniejƒÖcych obserwacji.
 90 | 
 91 | ### Panel musi posiadaƒá
 92 | - listƒô monitor√≥w Meta Ads,
 93 | - listƒô wykryƒá reklam,
 94 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
 95 | 
 96 | ---
 97 | 
 98 | ## 4. Automatyczne dodawanie og≈Çosze≈Ñ (Marketplace)
 99 | 
100 | ### Cel
101 | Autoposting og≈Çosze≈Ñ z puli tre≈õci, z rotacjƒÖ i obs≈ÇugƒÖ wielu kont.
102 | 
103 | ### Jak to dzia≈Ça
104 | 1. W panelu tworzone sƒÖ:
105 |    - pule og≈Çosze≈Ñ (szablony),
106 |    - kampanie publikacji.
107 | 2. Kampania:
108 |    - wybiera konto FB,
109 |    - ustala harmonogram,
110 |    - rotuje tre≈õci.
111 | 3. Backend publikuje og≈Çoszenia.
112 | 4. Przy b≈Çƒôdzie lub blokadzie:
113 |    - kampania zostaje zatrzymana,
114 |    - panel pokazuje status i mo≈ºliwo≈õƒá wznowienia.
115 | 
116 | ### Panel musi posiadaƒá
117 | - pulƒô og≈Çosze≈Ñ,
118 | - kampanie publikacji,
119 | - statusy: ACTIVE / PAUSED / ERROR,
120 | - przyciski STOP / WZN√ìW.
121 | 
122 | ---
123 | 
124 | ## Kluczowe byty w panelu (minimalny zestaw)
125 | 
126 | - **Sources** ‚Äì g≈Ç√≥wna strona FB, grupy, meta ads
127 | - **Discoveries** ‚Äì wszystkie wykrycia (jedno wsp√≥lne miejsce)
128 | - **Watched** ‚Äì obserwowane linki/posty (dla watchera)
129 | - **Campaigns** ‚Äì autoposting / marketplace
130 | 
131 | Ka≈ºdy typ wykrycia przechodzi przez:
132 | `Discoveries ‚Üí Zatwierd≈∫ ‚Üí Watched / Campaign`
133 | 
134 | ---
135 | 
136 | ## Za≈Ço≈ºenia architektoniczne
137 | 
138 | - Panel = ≈∫r√≥d≈Ço prawdy
139 | - Backend = wykonawca (worker)
140 | - G≈Ç√≥wna strona FB, grupy i Meta Ads to **r√≥≈ºne ≈∫r√≥d≈Ça**, ale **ten sam proces zatwierdzania**
141 | - Ka≈ºda funkcja backendu mo≈ºe byƒá dodana p√≥≈∫niej bez zmiany panelu
142 | 
143 | ---
144 | 
145 | ## Uwaga projektowa
146 | 
147 | Panel musi byƒá gotowy na:
148 | - wiele kont Facebook,
149 | - blokady i zatrzymania,
150 | - r√≥≈ºne typy ≈∫r√≥de≈Ç (Home / Group / Ads),
151 | - dalszƒÖ rozbudowƒô bez refaktoru UI.
152 | 
153 | 
```

---

### üìÑ ≈öcie≈ºka: `scripts/generate-cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | #!/usr/bin/env node
  2 | /**
  3 |  * scripts/generate-cookies.js
  4 |  *
  5 |  * Skrypt pomocniczy do generowania cookies Facebook z rotacjƒÖ.
  6 |  * Otwiera przeglƒÖdarkƒô w trybie widocznym, czeka na manualne logowanie (z 2FA),
  7 |  * a nastƒôpnie zapisuje cookies do plik√≥w z numeracjƒÖ.
  8 |  *
  9 |  * U≈ºycie:
 10 |  *   node scripts/generate-cookies.js [--index=N] [--upload] [--list]
 11 |  *
 12 |  * Opcje:
 13 |  *   --index=N  - zapisz jako cookies_N.json (domy≈õlnie: nastƒôpny wolny numer)
 14 |  *   --upload   - po zapisaniu, wy≈õlij cookies przez SCP na serwer
 15 |  *   --list     - tylko poka≈º listƒô istniejƒÖcych plik√≥w cookies
 16 |  *
 17 |  * Przyk≈Çady:
 18 |  *   node scripts/generate-cookies.js                    # zapisz jako cookies_1.json (lub nastƒôpny)
 19 |  *   node scripts/generate-cookies.js --index=2          # zapisz jako cookies_2.json
 20 |  *   node scripts/generate-cookies.js --index=1 --upload # zapisz i wy≈õlij na serwer
 21 |  *   node scripts/generate-cookies.js --list             # poka≈º istniejƒÖce pliki
 22 |  */
 23 | 
 24 | import "dotenv/config";
 25 | import puppeteer from "puppeteer";
 26 | import fs from "fs/promises";
 27 | import fsSync from "fs";
 28 | import path from "path";
 29 | import { execSync } from "child_process";
 30 | import readline from "readline";
 31 | 
 32 | // Konfiguracja
 33 | const MAIN_COOKIES_FILE = "cookies.json";
 34 | const BACKUP_COOKIES_DIR = process.env.BACKUP_COOKIES_DIR || "./data/backup_cookies";
 35 | const SCP_COOKIES_TARGET = (process.env.SCP_COOKIES_TARGET || "").trim();
 36 | 
 37 | // Kolory konsoli
 38 | const colors = {
 39 |   reset: "\x1b[0m",
 40 |   bright: "\x1b[1m",
 41 |   green: "\x1b[32m",
 42 |   yellow: "\x1b[33m",
 43 |   blue: "\x1b[34m",
 44 |   cyan: "\x1b[36m",
 45 |   red: "\x1b[31m",
 46 |   dim: "\x1b[2m",
 47 | };
 48 | 
 49 | function log(msg, color = "reset") {
 50 |   console.log(`${colors[color]}${msg}${colors.reset}`);
 51 | }
 52 | 
 53 | function logBox(lines) {
 54 |   const maxLen = Math.max(...lines.map((l) => l.length));
 55 |   const border = "‚ïê".repeat(maxLen + 2);
 56 | 
 57 |   console.log(`\n${colors.cyan}‚ïî${border}‚ïó${colors.reset}`);
 58 |   for (const line of lines) {
 59 |     const padding = " ".repeat(maxLen - line.length);
 60 |     console.log(`${colors.cyan}‚ïë${colors.reset} ${line}${padding} ${colors.cyan}‚ïë${colors.reset}`);
 61 |   }
 62 |   console.log(`${colors.cyan}‚ïö${border}‚ïù${colors.reset}\n`);
 63 | }
 64 | 
 65 | /**
 66 |  * Pobiera listƒô istniejƒÖcych plik√≥w cookies_N.json
 67 |  */
 68 | function getExistingCookiesFiles() {
 69 |   try {
 70 |     const backupDir = path.resolve(BACKUP_COOKIES_DIR);
 71 |     if (!fsSync.existsSync(backupDir)) return [];
 72 | 
 73 |     const files = fsSync.readdirSync(backupDir);
 74 |     const cookieFiles = [];
 75 | 
 76 |     for (const file of files) {
 77 |       const match = file.match(/^cookies_(\d+)\.json$/);
 78 |       if (match) {
 79 |         const index = parseInt(match[1], 10);
 80 |         const filePath = path.join(backupDir, file);
 81 |         const stats = fsSync.statSync(filePath);
 82 |         const ageHours = Math.round((Date.now() - stats.mtimeMs) / (1000 * 60 * 60));
 83 | 
 84 |         cookieFiles.push({ index, filename: file, path: filePath, ageHours });
 85 |       }
 86 |     }
 87 | 
 88 |     return cookieFiles.sort((a, b) => a.index - b.index);
 89 |   } catch {
 90 |     return [];
 91 |   }
 92 | }
 93 | 
 94 | /**
 95 |  * Znajduje nastƒôpny wolny numer
 96 |  */
 97 | function getNextFreeIndex() {
 98 |   const existing = getExistingCookiesFiles();
 99 |   if (existing.length === 0) return 1;
100 |   return Math.max(...existing.map((f) => f.index)) + 1;
101 | }
102 | 
103 | /**
104 |  * Parsuje argumenty CLI
105 |  */
106 | function parseArgs() {
107 |   const args = process.argv.slice(2);
108 |   const result = {
109 |     index: null,
110 |     upload: false,
111 |     list: false,
112 |   };
113 | 
114 |   for (const arg of args) {
115 |     if (arg === "--upload") {
116 |       result.upload = true;
117 |     } else if (arg === "--list") {
118 |       result.list = true;
119 |     } else if (arg.startsWith("--index=")) {
120 |       const val = arg.split("=")[1];
121 |       result.index = parseInt(val, 10);
122 |       if (isNaN(result.index) || result.index < 1) {
123 |         log(`B≈ÇƒÖd: --index musi byƒá liczbƒÖ >= 1`, "red");
124 |         process.exit(1);
125 |       }
126 |     }
127 |   }
128 | 
129 |   return result;
130 | }
131 | 
132 | async function waitForEnter() {
133 |   const rl = readline.createInterface({
134 |     input: process.stdin,
135 |     output: process.stdout,
136 |   });
137 | 
138 |   return new Promise((resolve) => {
139 |     rl.question(`${colors.yellow}>>> Naci≈õnij ENTER gdy sko≈Ñczysz logowanie...${colors.reset}`, () => {
140 |       rl.close();
141 |       resolve();
142 |     });
143 |   });
144 | }
145 | 
146 | async function checkIfLogged(page) {
147 |   try {
148 |     return await page.evaluate(() => {
149 |       const hasSearch = !!(
150 |         document.querySelector('input[aria-label*="Szukaj"]') ||
151 |         document.querySelector('input[placeholder*="Szukaj"]') ||
152 |         document.querySelector('input[placeholder*="Search"]')
153 |       );
154 |       const hasProfile = !!(
155 |         document.querySelector('a[aria-label*="Profil"]') ||
156 |         document.querySelector('a[aria-label*="Profile"]')
157 |       );
158 |       const hasAccount = !!(
159 |         document.querySelector('div[aria-label*="Konto"]') ||
160 |         document.querySelector('div[aria-label*="Account"]')
161 |       );
162 |       const hasFeed = !!document.querySelector('[role="feed"]');
163 | 
164 |       return hasSearch || hasProfile || hasAccount || hasFeed;
165 |     });
166 |   } catch {
167 |     return false;
168 |   }
169 | }
170 | 
171 | async function ensureDir(dir) {
172 |   try {
173 |     await fs.mkdir(dir, { recursive: true });
174 |   } catch {
175 |     // ignoruj
176 |   }
177 | }
178 | 
179 | async function saveCookiesToFile(cookies, filePath) {
180 |   await ensureDir(path.dirname(filePath));
181 |   await fs.writeFile(filePath, JSON.stringify(cookies, null, 2), "utf8");
182 | }
183 | 
184 | function uploadViaScp(localPath, target) {
185 |   if (!target) {
186 |     log("Brak SCP_COOKIES_TARGET w .env - pomijam upload", "yellow");
187 |     return false;
188 |   }
189 | 
190 |   try {
191 |     log(`Wysy≈Çam przez SCP: ${path.basename(localPath)} ‚Üí ${target}`, "blue");
192 |     execSync(`scp "${localPath}" "${target}"`, { stdio: "inherit" });
193 |     log("Upload zako≈Ñczony!", "green");
194 |     return true;
195 |   } catch (err) {
196 |     log(`B≈ÇƒÖd SCP: ${err.message}`, "red");
197 |     return false;
198 |   }
199 | }
200 | 
201 | function showList() {
202 |   const files = getExistingCookiesFiles();
203 | 
204 |   logBox([
205 |     "Lista plik√≥w backup cookies",
206 |     `Folder: ${BACKUP_COOKIES_DIR}`,
207 |   ]);
208 | 
209 |   if (files.length === 0) {
210 |     log("  (brak plik√≥w)", "dim");
211 |   } else {
212 |     for (const f of files) {
213 |       const ageStr = f.ageHours < 24 ? `${f.ageHours}h` : `${Math.round(f.ageHours / 24)}d`;
214 |       log(`  ${colors.cyan}${f.filename}${colors.reset} - wiek: ${ageStr}`);
215 |     }
216 |   }
217 | 
218 |   console.log();
219 |   log(`Nastƒôpny wolny numer: ${getNextFreeIndex()}`, "dim");
220 | }
221 | 
222 | async function main() {
223 |   const args = parseArgs();
224 | 
225 |   // Tryb --list
226 |   if (args.list) {
227 |     showList();
228 |     process.exit(0);
229 |   }
230 | 
231 |   // Ustal numer pliku
232 |   const targetIndex = args.index ?? getNextFreeIndex();
233 |   const targetFilename = `cookies_${targetIndex}.json`;
234 |   const targetPath = path.join(path.resolve(BACKUP_COOKIES_DIR), targetFilename);
235 | 
236 |   // Sprawd≈∫ czy plik ju≈º istnieje
237 |   const existing = getExistingCookiesFiles();
238 |   const existsAlready = existing.some((f) => f.index === targetIndex);
239 | 
240 |   logBox([
241 |     "FB Cookie Generator (z rotacjƒÖ)",
242 |     "",
243 |     `Zapisze jako: ${targetFilename}`,
244 |     existsAlready ? `(UWAGA: nadpisze istniejƒÖcy plik!)` : `(nowy plik)`,
245 |     "",
246 |     "Otworzy przeglƒÖdarkƒô - zaloguj siƒô rƒôcznie.",
247 |   ]);
248 | 
249 |   // Poka≈º istniejƒÖce pliki
250 |   if (existing.length > 0) {
251 |     log("IstniejƒÖce pliki backup:", "dim");
252 |     for (const f of existing) {
253 |       const marker = f.index === targetIndex ? " ‚Üê nadpisany" : "";
254 |       log(`  ${f.filename}${marker}`, "dim");
255 |     }
256 |     console.log();
257 |   }
258 | 
259 |   log("Uruchamiam przeglƒÖdarkƒô...", "blue");
260 | 
261 |   const browser = await puppeteer.launch({
262 |     headless: false,
263 |     defaultViewport: null,
264 |     args: [
265 |       "--start-maximized",
266 |       "--disable-notifications",
267 |       "--disable-blink-features=AutomationControlled",
268 |     ],
269 |     ignoreDefaultArgs: ["--enable-automation"],
270 |   });
271 | 
272 |   const page = await browser.newPage();
273 | 
274 |   // Stealth
275 |   await page.evaluateOnNewDocument(() => {
276 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
277 |     window.chrome = window.chrome || { runtime: {} };
278 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
279 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
280 |   });
281 | 
282 |   log("Nawigujƒô do Facebook...", "blue");
283 |   await page.goto("https://www.facebook.com/login.php", { waitUntil: "networkidle2" });
284 | 
285 |   logBox([
286 |     "INSTRUKCJA",
287 |     "",
288 |     "1. Zaloguj siƒô na swoje konto Facebook",
289 |     "2. Je≈õli FB poprosi o 2FA - wprowad≈∫ kod",
290 |     "3. Poczekaj a≈º zobaczysz stronƒô g≈Ç√≥wnƒÖ",
291 |     "4. Wr√≥ƒá tutaj i naci≈õnij ENTER",
292 |   ]);
293 | 
294 |   await waitForEnter();
295 | 
296 |   log("Sprawdzam status logowania...", "blue");
297 |   let isLogged = await checkIfLogged(page);
298 | 
299 |   if (!isLogged) {
300 |     log("Nie wykryto sesji. Spr√≥buj ponownie.", "yellow");
301 | 
302 |     const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
303 |     const retry = await new Promise((resolve) => {
304 |       rl.question("Czy chcesz spr√≥bowaƒá ponownie? (t/n): ", (answer) => {
305 |         rl.close();
306 |         resolve(answer.toLowerCase() === "t" || answer.toLowerCase() === "y");
307 |       });
308 |     });
309 | 
310 |     if (retry) {
311 |       await waitForEnter();
312 |       isLogged = await checkIfLogged(page);
313 |     }
314 | 
315 |     if (!isLogged) {
316 |       log("Nie wykryto sesji. Zamykam.", "red");
317 |       await browser.close();
318 |       process.exit(1);
319 |     }
320 |   }
321 | 
322 |   log("Sesja wykryta! Pobieram cookies...", "green");
323 | 
324 |   const cookies = await page.cookies();
325 |   log(`Pobrano ${cookies.length} cookies`, "cyan");
326 | 
327 |   // Zapisz do g≈Ç√≥wnego pliku
328 |   const mainPath = path.resolve(MAIN_COOKIES_FILE);
329 |   await saveCookiesToFile(cookies, mainPath);
330 |   log(`Zapisano: ${mainPath}`, "green");
331 | 
332 |   // Zapisz jako backup z numerem
333 |   await saveCookiesToFile(cookies, targetPath);
334 |   log(`Zapisano backup: ${targetPath}`, "green");
335 | 
336 |   // Opcjonalnie: upload SCP
337 |   if (args.upload) {
338 |     uploadViaScp(targetPath, SCP_COOKIES_TARGET);
339 |   }
340 | 
341 |   await browser.close();
342 | 
343 |   logBox([
344 |     "SUKCES!",
345 |     "",
346 |     `Cookies zapisane jako: ${targetFilename}`,
347 |     "",
348 |     "Aby wygenerowaƒá kolejny zestaw:",
349 |     `  node scripts/generate-cookies.js --index=${targetIndex + 1}`,
350 |     "",
351 |     args.upload && SCP_COOKIES_TARGET
352 |       ? `Upload: ${SCP_COOKIES_TARGET}`
353 |       : "Skopiuj pliki na serwer rƒôcznie lub u≈ºyj --upload",
354 |   ].filter(Boolean));
355 | 
356 |   process.exit(0);
357 | }
358 | 
359 | main().catch((err) => {
360 |   console.error("B≈ÇƒÖd:", err);
361 |   process.exit(1);
362 | });
363 | 
```

---

### üìÑ ≈öcie≈ºka: `test-telegram.mjs`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | import "dotenv/config";
 2 | import { sendTelegramLeads } from "./src/telegram.js";
 3 | 
 4 | await sendTelegramLeads(
 5 |   { name: "TEST", description: "test", url: "https://facebook.com", image: "" },
 6 |   [{ author: "Tester", text: "To jest test", fb_time_raw: "1 min", id: "test-1" }]
 7 | );
 8 | 
 9 | console.log("TEST DONE");
10 | 
```

---

### üìÑ ≈öcie≈ºka: `tools/export-project-to-md.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | #!/usr/bin/env node
  2 | /**
  3 |  * Export ca≈Çego projektu do jednego pliku Markdown z:
  4 |  * - spisem tre≈õci
  5 |  * - per-plik sekcjami
  6 |  * - numerami linii
  7 |  *
  8 |  * Uruchom:
  9 |  *   node tools/export-project-to-md.js
 10 |  *
 11 |  * Opcje (ENV):
 12 |  *   EXPORT_OUT=EXPORT_PROJEKTU.md
 13 |  *   EXPORT_ROOT=.           (domy≈õlnie katalog, w kt√≥rym uruchamiasz)
 14 |  *   EXPORT_MAX_BYTES=2000000 (max rozmiar pojedynczego pliku w bajtach; domy≈õlnie 2 MB)
 15 |  */
 16 | 
 17 | import fs from "fs";
 18 | import path from "path";
 19 | 
 20 | const ROOT = path.resolve(process.env.EXPORT_ROOT || process.cwd());
 21 | const OUT_FILE = path.resolve(process.env.EXPORT_OUT || path.join(ROOT, "EXPORT_PROJEKTU.md"));
 22 | const MAX_BYTES = Number(process.env.EXPORT_MAX_BYTES || 2_000_000);
 23 | 
 24 | const IGNORE_DIRS = new Set([
 25 |   "node_modules",
 26 |   ".git",
 27 |   "dist",
 28 |   "build",
 29 |   "out",
 30 |   ".next",
 31 |   ".turbo",
 32 |   ".cache",
 33 |   "coverage",
 34 |   ".pnpm-store",
 35 |   ".yarn",
 36 |   ".vscode",
 37 |   ".idea",
 38 | ]);
 39 | 
 40 | const IGNORE_FILES = new Set([
 41 |   "package-lock.json", // mo≈ºesz odkomentowaƒá, je≈õli chcesz go mieƒá: usu≈Ñ z listy
 42 |   // "yarn.lock",
 43 |   // "pnpm-lock.yaml",
 44 | ]);
 45 | 
 46 | const ALLOWED_EXT = new Set([
 47 |   ".js",
 48 |   ".mjs",
 49 |   ".cjs",
 50 |   ".ts",
 51 |   ".tsx",
 52 |   ".jsx",
 53 |   ".json",
 54 |   ".env",
 55 |   ".env.local",
 56 |   ".env.production",
 57 |   ".env.development",
 58 |   ".html",
 59 |   ".css",
 60 |   ".md",
 61 |   ".yml",
 62 |   ".yaml",
 63 |   ".txt",
 64 | ]);
 65 | 
 66 | // Typowe binarki / ≈õmieci
 67 | const BINARY_EXT = new Set([
 68 |   ".png",
 69 |   ".jpg",
 70 |   ".jpeg",
 71 |   ".webp",
 72 |   ".gif",
 73 |   ".ico",
 74 |   ".pdf",
 75 |   ".zip",
 76 |   ".rar",
 77 |   ".7z",
 78 |   ".tar",
 79 |   ".gz",
 80 |   ".exe",
 81 |   ".dll",
 82 |   ".so",
 83 |   ".dylib",
 84 |   ".bin",
 85 |   ".woff",
 86 |   ".woff2",
 87 |   ".ttf",
 88 |   ".otf",
 89 |   ".mp4",
 90 |   ".mov",
 91 |   ".avi",
 92 |   ".mkv",
 93 |   ".mp3",
 94 |   ".wav",
 95 | ]);
 96 | 
 97 | function isHiddenName(name) {
 98 |   return name.startsWith(".") && name !== ".env" && !name.startsWith(".env.");
 99 | }
100 | 
101 | function normalizeRel(p) {
102 |   const rel = path.relative(ROOT, p);
103 |   return rel.split(path.sep).join("/");
104 | }
105 | 
106 | function detectLangByExt(filePath) {
107 |   const base = path.basename(filePath);
108 |   const ext = path.extname(filePath).toLowerCase();
109 | 
110 |   if (base === ".env" || base.startsWith(".env.")) return "dotenv";
111 |   if (ext === ".js" || ext === ".mjs" || ext === ".cjs") return "js";
112 |   if (ext === ".ts") return "ts";
113 |   if (ext === ".tsx") return "tsx";
114 |   if (ext === ".jsx") return "jsx";
115 |   if (ext === ".json") return "json";
116 |   if (ext === ".html") return "html";
117 |   if (ext === ".css") return "css";
118 |   if (ext === ".yml" || ext === ".yaml") return "yaml";
119 |   if (ext === ".md") return "md";
120 |   return "";
121 | }
122 | 
123 | function looksBinaryByExt(filePath) {
124 |   const ext = path.extname(filePath).toLowerCase();
125 |   return BINARY_EXT.has(ext);
126 | }
127 | 
128 | function isAllowedFile(filePath) {
129 |   const name = path.basename(filePath);
130 |   if (IGNORE_FILES.has(name)) return false;
131 | 
132 |   const ext = path.extname(name).toLowerCase();
133 |   if (looksBinaryByExt(filePath)) return false;
134 | 
135 |   // specjalnie traktujemy .env bez rozszerzenia
136 |   if (name === ".env" || name.startsWith(".env.")) return true;
137 | 
138 |   if (!ext) return false;
139 |   return ALLOWED_EXT.has(ext);
140 | }
141 | 
142 | function stripWeirdControlChars(s) {
143 |   // usu≈Ñ NUL i inne kontrolne, kt√≥re potrafiƒÖ rozwaliƒá MD
144 |   return s.replace(/\u0000/g, "");
145 | }
146 | 
147 | function safeReadText(filePath) {
148 |   const st = fs.statSync(filePath);
149 |   if (st.size > MAX_BYTES) {
150 |     return {
151 |       ok: false,
152 |       reason: `Plik wiƒôkszy ni≈º limit (${st.size} B > ${MAX_BYTES} B)`,
153 |       text: null,
154 |       size: st.size,
155 |     };
156 |   }
157 | 
158 |   // szybka detekcja binarki po pierwszych bajtach (NUL)
159 |   const buf = fs.readFileSync(filePath);
160 |   for (let i = 0; i < Math.min(buf.length, 4096); i++) {
161 |     if (buf[i] === 0) {
162 |       return { ok: false, reason: "Wykryto binarkƒô (NUL byte)", text: null, size: st.size };
163 |     }
164 |   }
165 | 
166 |   const text = stripWeirdControlChars(buf.toString("utf8"));
167 |   return { ok: true, reason: null, text, size: st.size };
168 | }
169 | 
170 | function padLeft(n, width) {
171 |   const s = String(n);
172 |   return s.length >= width ? s : " ".repeat(width - s.length) + s;
173 | }
174 | 
175 | function addLineNumbers(text) {
176 |   const lines = text.split(/\r?\n/);
177 |   const width = String(lines.length).length;
178 |   return lines
179 |     .map((line, idx) => `${padLeft(idx + 1, width)} | ${line}`)
180 |     .join("\n");
181 | }
182 | 
183 | function mdEscapeHeadingAnchor(s) {
184 |   // GitHub-like anchor (uproszczony i stabilny)
185 |   // "src/fb/comments.js" -> "srcfbcommentsjs"
186 |   return s
187 |     .toLowerCase()
188 |     .replace(/[`]/g, "")
189 |     .replace(/[^\p{L}\p{N}\s/-]+/gu, "") // usu≈Ñ znaki inne ni≈º litery/cyfry/spacje/-/
190 |     .replace(/\s+/g, "-")
191 |     .replace(/[\/]/g, "-")
192 |     .replace(/-+/g, "-")
193 |     .replace(/^-|-$/g, "");
194 | }
195 | 
196 | function guessDescription(relPath) {
197 |   const p = relPath.toLowerCase();
198 |   if (p.includes("/fb/")) return "Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).";
199 |   if (p.includes("/panel/")) return "Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.";
200 |   if (p.includes("/utils/")) return "Utility helpers (sleep, nawigacja, parsowanie, itp.).";
201 |   if (p.endsWith("watcher.js")) return "G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.";
202 |   if (p.endsWith("config.js") || p.endsWith(".env") || p.includes(".env")) return "Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.";
203 |   if (p.endsWith("package.json")) return "Metadane projektu i zale≈ºno≈õci (npm).";
204 |   return "Plik projektu (kod/konfiguracja).";
205 | }
206 | 
207 | function walk(dir, outFiles) {
208 |   const entries = fs.readdirSync(dir, { withFileTypes: true });
209 | 
210 |   for (const ent of entries) {
211 |     const full = path.join(dir, ent.name);
212 | 
213 |     if (ent.isDirectory()) {
214 |       if (IGNORE_DIRS.has(ent.name)) continue;
215 |       if (isHiddenName(ent.name)) continue;
216 |       walk(full, outFiles);
217 |       continue;
218 |     }
219 | 
220 |     if (!ent.isFile()) continue;
221 | 
222 |     // ukryte pliki: dopuszczamy .env* i .github? -> tu domy≈õlnie pomijamy ukryte poza .env*
223 |     if (isHiddenName(ent.name) && !(ent.name === ".env" || ent.name.startsWith(".env."))) continue;
224 | 
225 |     if (!isAllowedFile(full)) continue;
226 | 
227 |     outFiles.push(full);
228 |   }
229 | }
230 | 
231 | function sortFiles(files) {
232 |   // 1) configy i root files na g√≥rze
233 |   // 2) src/ potem reszta
234 |   // 3) alfabetycznie
235 |   const rel = (f) => normalizeRel(f);
236 | 
237 |   const score = (r) => {
238 |     const low = r.toLowerCase();
239 |     if (low === "package.json") return 0;
240 |     if (low.startsWith(".env")) return 1;
241 |     if (low.includes("config")) return 2;
242 |     if (low.startsWith("src/")) return 10;
243 |     if (low.includes("panel")) return 20;
244 |     return 30;
245 |   };
246 | 
247 |   return [...files].sort((a, b) => {
248 |     const ra = rel(a);
249 |     const rb = rel(b);
250 |     const sa = score(ra);
251 |     const sb = score(rb);
252 |     if (sa !== sb) return sa - sb;
253 |     return ra.localeCompare(rb);
254 |   });
255 | }
256 | 
257 | function main() {
258 |   const files = [];
259 |   walk(ROOT, files);
260 | 
261 |   const sorted = sortFiles(files);
262 | 
263 |   const projectName = path.basename(ROOT);
264 |   const nowIso = new Date().toISOString();
265 | 
266 |   let md = "";
267 |   md += `# üì¶ EXPORT PROJEKTU: ${projectName}\n\n`;
268 |   md += `**Root:** \`${ROOT}\`  \n`;
269 |   md += `**Wygenerowano:** \`${nowIso}\`  \n`;
270 |   md += `**Liczba plik√≥w:** \`${sorted.length}\`  \n`;
271 |   md += `**Max rozmiar pliku:** \`${MAX_BYTES} B\`  \n\n`;
272 | 
273 |   md += `## üß≠ Spis tre≈õci\n`;
274 |   for (const f of sorted) {
275 |     const r = normalizeRel(f);
276 |     const anchor = mdEscapeHeadingAnchor(`≈õcie≈ºka-${r}`);
277 |     md += `- [${r}](#${anchor})\n`;
278 |   }
279 |   md += `\n---\n\n`;
280 | 
281 |   for (const f of sorted) {
282 |     const r = normalizeRel(f);
283 |     const lang = detectLangByExt(f);
284 |     const ext = path.extname(f).toLowerCase();
285 |     const type =
286 |       r.endsWith(".md") ? "Markdown" :
287 |       r.endsWith(".json") ? "JSON" :
288 |       (r === ".env" || r.startsWith(".env.")) ? "ENV" :
289 |       (ext === ".html") ? "HTML" :
290 |       (ext === ".css") ? "CSS" :
291 |       (ext === ".yml" || ext === ".yaml") ? "YAML" :
292 |       (ext === ".ts" || ext === ".tsx") ? "TypeScript" :
293 |       "JavaScript/tekst";
294 | 
295 |     const desc = guessDescription(r);
296 | 
297 |     const read = safeReadText(f);
298 |     md += `### üìÑ ≈öcie≈ºka: \`${r}\`\n`;
299 |     md += `**Typ:** ${type}  \n`;
300 |     md += `**Opis:** ${desc}  \n`;
301 | 
302 |     if (!read.ok) {
303 |       md += `**UWAGA:** pominiƒôto tre≈õƒá ‚Üí ${read.reason}  \n\n`;
304 |       md += `---\n\n`;
305 |       continue;
306 |     }
307 | 
308 |     const numbered = addLineNumbers(read.text);
309 | 
310 |     md += `\n\`\`\`${lang}\n`;
311 |     md += `${numbered}\n`;
312 |     md += `\`\`\`\n\n`;
313 |     md += `---\n\n`;
314 |   }
315 | 
316 |   fs.writeFileSync(OUT_FILE, md, "utf8");
317 |   console.log(`[EXPORT] OK -> ${OUT_FILE}`);
318 |   console.log(`[EXPORT] Plik√≥w: ${sorted.length}`);
319 | }
320 | 
321 | try {
322 |   main();
323 | } catch (e) {
324 |   console.error("[EXPORT] ERROR:", e?.stack || e?.message || String(e));
325 |   process.exit(1);
326 | }
327 | 
```

---

