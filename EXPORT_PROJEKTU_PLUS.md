# üì¶ EXPORT PROJEKTU+: FB_Watcher

**Root:** `C:\Projekty vs\FB_Watcher`  
**Wygenerowano:** `2026-01-21T21:09:57.414Z`  
**Liczba plik√≥w:** `98`  
**≈ÅƒÖczny rozmiar (raw):** `6284115 B`  
**Max rozmiar pliku:** `2000000 B`  
**Redaction:** `OFF`  

---

## üó∫Ô∏è Overview

## üö™ Entrypoints & Flow

- src/index.js ‚Üí g≈Ç√≥wny start aplikacji
- src/watcher.js ‚Üí g≈Ç√≥wna pƒôtla watchera
- src/panel/** ‚Üí backend / frontend panelu
- tools/export-project-to-md.js ‚Üí narzƒôdzie eksportu projektu

---

### üìä Statystyki

- Top rozszerzenia:
  - `.js`: **36**
  - `.tsx`: **27**
  - `.json`: **13**
  - `.ts`: **7**
  - `.md`: **4**
  - `.html`: **3**
  - `.env`: **2**
  - `.cjs`: **2**
  - `.mjs`: **2**
  - `.css`: **1**
  - `.cookies.json`: **1**

### üå≥ Struktura (depth=3)

```text
‚îú‚îÄ config/
‚îÇ  ‚îú‚îÄ links.js
‚îÇ  ‚îî‚îÄ links.json
‚îú‚îÄ data/
‚îÇ  ‚îú‚îÄ backup_cookies/
‚îÇ  ‚îÇ  ‚îú‚îÄ cookies_1.json
‚îÇ  ‚îÇ  ‚îú‚îÄ cookies_2.json
‚îÇ  ‚îÇ  ‚îú‚îÄ cookies_3.json
‚îÇ  ‚îÇ  ‚îî‚îÄ cookies_4.json
‚îÇ  ‚îú‚îÄ comments-cache.json
‚îÇ  ‚îî‚îÄ posts.json
‚îú‚îÄ DEBUG_EXPORT/
‚îÇ  ‚îú‚îÄ src/
‚îÇ  ‚îÇ  ‚îú‚îÄ panel/
‚îÇ  ‚îÇ  ‚îú‚îÄ config.js
‚îÇ  ‚îÇ  ‚îú‚îÄ index.js
‚îÇ  ‚îÇ  ‚îú‚îÄ watcher.js
‚îÇ  ‚îÇ  ‚îî‚îÄ webhook.js
‚îÇ  ‚îú‚îÄ .env
‚îÇ  ‚îî‚îÄ package.json
‚îú‚îÄ scripts/
‚îÇ  ‚îî‚îÄ generate-cookies.js
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ db/
‚îÇ  ‚îÇ  ‚îî‚îÄ cache.js
‚îÇ  ‚îú‚îÄ fb/
‚îÇ  ‚îÇ  ‚îú‚îÄ legacy/
‚îÇ  ‚îÇ  ‚îú‚îÄ ui/
‚îÇ  ‚îÇ  ‚îú‚îÄ checkpoint.js
‚îÇ  ‚îÇ  ‚îú‚îÄ comments.js
‚îÇ  ‚îÇ  ‚îú‚îÄ cookies.js
‚îÇ  ‚îÇ  ‚îú‚îÄ expandButtons.js
‚îÇ  ‚îÇ  ‚îú‚îÄ login.js
‚îÇ  ‚îÇ  ‚îú‚îÄ scroll.js
‚îÇ  ‚îÇ  ‚îî‚îÄ uiCommentInfo.js
‚îÇ  ‚îú‚îÄ panel/
‚îÇ  ‚îÇ  ‚îú‚îÄ ui/
‚îÇ  ‚îÇ  ‚îú‚îÄ web/
‚îÇ  ‚îÇ  ‚îú‚îÄ api.js
‚îÇ  ‚îÇ  ‚îî‚îÄ panel-entry.cjs
‚îÇ  ‚îú‚îÄ utils/
‚îÇ  ‚îÇ  ‚îú‚îÄ logger.js
‚îÇ  ‚îÇ  ‚îú‚îÄ mouse.js
‚îÇ  ‚îÇ  ‚îú‚îÄ navigation.js
‚îÇ  ‚îÇ  ‚îú‚îÄ sleep.js
‚îÇ  ‚îÇ  ‚îî‚îÄ time.js
‚îÇ  ‚îú‚îÄ config.js
‚îÇ  ‚îú‚îÄ index.js
‚îÇ  ‚îú‚îÄ telegram.js
‚îÇ  ‚îî‚îÄ watcher.js
‚îú‚îÄ tools/
‚îÇ  ‚îî‚îÄ export-project-to-md.js
‚îú‚îÄ .env
‚îú‚îÄ CLAUDE.md
‚îú‚îÄ cookies.json
‚îú‚îÄ debug-login.mjs
‚îú‚îÄ EXPORT_PROJEKTU_PLUS.md
‚îú‚îÄ EXPORT_PROJEKTU.md
‚îú‚îÄ package-lock.json
‚îú‚îÄ package.json
‚îú‚îÄ Rozwoj.md
‚îî‚îÄ test-telegram.mjs
```

---

## üì¶ Public API (exports)

### `config/links.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-config-linksjs)

- L170: **export function** `getLinks`

### `DEBUG_EXPORT/src/watcher.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-watcherjs)

- L578: **export {..}** `startWatcher`

### `DEBUG_EXPORT/src/webhook.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-webhookjs)

- L148: **export {..}** `sendWebhook`

### `src/db/cache.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-db-cachejs)

- L18: **export function** `loadCache`
- L50: **export function** `saveCache`
- L93: **export function** `getCacheSize`
- L106: **export function** `getCacheEntryCount`

### `src/fb/checkpoint.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-checkpointjs)

- L180: **export {..}** `isCheckpoint, getCheckpointType, isCheckpointUrl`

### `src/fb/expandButtons.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-expandbuttonsjs)

- L186: **export {..}** `clickOneExpandButton`

### `src/fb/legacy/comments.legacy.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-legacy-commentslegacyjs)

- L1925: **export {..}** `getCommentCount, expandAllComments,`

### `src/fb/scroll.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-scrolljs)

- L71: **export {..}** `scrollPost`

### `src/fb/ui/index.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-indexjs)

- L9: **export function** `pickUiHandler`

### `src/fb/ui/photo.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-photojs)

- L10: **export const** `type`
- L68: **export function** `matchesUrl`

### `src/fb/ui/post.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-postjs)

- L14: **export const** `type`
- L16: **export function** `matchesUrl`

### `src/fb/ui/videos.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-videosjs)

- L9: **export const** `type`
- L11: **export function** `matchesUrl`

### `src/fb/ui/watch.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-watchjs)

- L10: **export const** `type`
- L13: **export function** `matchesUrl`

### `src/panel/web/postcss.config.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-postcssconfigjs)

- L1: **export default** `(default)`

### `src/panel/web/src/App.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-apptsx)

- L13: **export default** `(default)`

### `src/panel/web/src/components/layout/DashboardLayout.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-dashboardlayouttsx)

- L18: **export function** `DashboardLayout`

### `src/panel/web/src/components/layout/Header.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-headertsx)

- L9: **export function** `Header`

### `src/panel/web/src/components/layout/MobileNav.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-mobilenavtsx)

- L11: **export function** `MobileNav`

### `src/panel/web/src/components/layout/Sidebar.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-sidebartsx)

- L64: **export function** `Sidebar`

### `src/panel/web/src/components/ui/badge.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-badgetsx)

- L32: **export {..}** `Badge, badgeVariants`

### `src/panel/web/src/components/ui/button.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-buttontsx)

- L48: **export {..}** `Button, buttonVariants`

### `src/panel/web/src/components/ui/card.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-cardtsx)

- L55: **export {..}** `Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent`

### `src/panel/web/src/components/ui/checkbox.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-checkboxtsx)

- L46: **export {..}** `Checkbox`

### `src/panel/web/src/components/ui/input.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-inputtsx)

- L23: **export {..}** `Input`

### `src/panel/web/src/components/ui/label.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-labeltsx)

- L20: **export {..}** `Label`

### `src/panel/web/src/components/ui/separator.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-separatortsx)

- L26: **export {..}** `Separator`

### `src/panel/web/src/components/ui/switch.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-switchtsx)

- L44: **export {..}** `Switch`

### `src/panel/web/src/components/ui/tabs.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-tabstsx)

- L109: **export {..}** `Tabs, TabsList, TabsTrigger, TabsContent`

### `src/panel/web/src/components/ui/textarea.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-textareatsx)

- L22: **export {..}** `Textarea`

### `src/panel/web/src/hooks/useApi.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-hooks-useapits)

- L16: **export function** `useApi`

### `src/panel/web/src/hooks/useAuth.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-hooks-useauthtsx)

- L12: **export function** `AuthProvider`
- L29: **export function** `useAuth`

### `src/panel/web/src/hooks/useLogs.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-hooks-uselogsts)

- L17: **export function** `useLogs`

### `src/panel/web/src/lib/api.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-lib-apits)

- L12: **export function** `getToken`
- L16: **export function** `setToken`

### `src/panel/web/src/lib/utils.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-lib-utilsts)

- L4: **export function** `cn`

### `src/panel/web/src/pages/Campaigns.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-campaignstsx)

- L4: **export function** `Campaigns`

### `src/panel/web/src/pages/Cookies.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-cookiestsx)

- L36: **export function** `Cookies`

### `src/panel/web/src/pages/Dashboard.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-dashboardtsx)

- L71: **export function** `Dashboard`

### `src/panel/web/src/pages/Discoveries.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-discoveriestsx)

- L4: **export function** `Discoveries`

### `src/panel/web/src/pages/Logs.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-logstsx)

- L13: **export function** `Logs`

### `src/panel/web/src/pages/Settings.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-settingstsx)

- L138: **export function** `Settings`

### `src/panel/web/src/pages/Sources.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-sourcestsx)

- L4: **export function** `Sources`

### `src/panel/web/src/pages/Watched.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-watchedtsx)

- L27: **export function** `Watched`

### `src/panel/web/tailwind.config.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-tailwindconfigjs)

- L2: **export default** `(default)`

### `src/panel/web/vite.config.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-viteconfigts)

- L5: **export default** `(default)`

### `src/telegram.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-telegramjs)

- L303: **export {..}** `sendTelegramLead, sendTelegramLeads, sendOwnerAlert`

### `src/utils/logger.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-loggerjs)

- L201: **export {..}** `log, LEVELS`
- L202: **export default** `(default)`

### `src/utils/time.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-timejs)

- L8: **export function** `parseFbRelativeTime`
- L45: **export function** `filterByAge`

### `src/watcher.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-watcherjs)

- L1004: **export {..}** `startWatcher`

---

## üß† Function/Class index

### `config/links.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-config-linksjs)

- L18: **function** `calcHash`
- L25: **function** `loadLinksFromLocalFile`
- L51: **function** `parseCsv`
- L100: **async function** `fetchLinks`
- L136: **async function** `reloadLinks`
- L154: **export async function** `initLinks`
- L170: **export function** `getLinks`

### `DEBUG_EXPORT/src/config.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-configjs)

- L34: **function** `getPostsFromEnv`
- L47: **function** `getPostLabelsFromEnv`

### `DEBUG_EXPORT/src/panel/api.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-panel-apijs)

- L31: **function** `auth`
- L41: **function** `json`
- L46: **function** `sh`
- L59: **async function** `getProjectDir`
- L71: **function** `readBody`
- L79: **function** `safeJsonParse`
- L87: **function** `ensureDir`
- L91: **function** `atomicWriteFile`
- L103: **function** `normalizeUrl`
- L110: **function** `normalizeOptionalUrl`
- L118: **function** `nowIso`
- L122: **function** `setEnvKey`
- L129: **function** `pickPostsFile`
- L133: **function** `readPosts`
- L143: **function** `writePosts`
- L147: **function** `genId`
- L151: **function** `route`
- L157: **function** `match`
- L170: **function** `parsePm2LogPaths`
- L182: **async function** `getPm2LogPaths`
- L200: **async function** `readTailLog`
- L540: **function** `okOrErr`
- L544: **async function** `pm2Describe`

### `DEBUG_EXPORT/src/panel/ui/app.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-panel-ui-appjs)

- L7: **function** `getToken`
- L10: **function** `setToken`
- L14: **async function** `api`
- L42: **function** `msg`
- L50: **async function** `refreshAll`
- L83: **function** `esc`
- L90: **async function** `loadPosts`

### `DEBUG_EXPORT/src/watcher.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-watcherjs)

- L57: **function** `isNavigationError`
- L72: **async function** `applyStealth`
- L101: **function** `safeJsonParse`
- L109: **function** `normalizeUrl`
- L116: **function** `readPanelPosts`
- L157: **function** `parseSheetCsv`
- L217: **async function** `refreshPostsIfNeeded`
- L303: **function** `getCacheKey`
- L307: **function** `getKnownSetForPost`
- L318: **function** `flushCacheToDisk`
- L342: **async function** `startWatcher`
- L349: **const async** `loop`

### `DEBUG_EXPORT/src/webhook.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-debug-export-src-webhookjs)

- L9: **function** `parseFbRelativeTime`
- L48: **function** `filterByAge`
- L66: **async function** `sendWebhook`

### `scripts/generate-cookies.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-scripts-generate-cookiesjs)

- L49: **function** `log`
- L53: **function** `logBox`
- L68: **function** `getExistingCookiesFiles`
- L97: **function** `getNextFreeIndex`
- L106: **function** `parseArgs`
- L132: **async function** `waitForEnter`
- L146: **async function** `checkIfLogged`
- L171: **async function** `ensureDir`
- L179: **async function** `saveCookiesToFile`
- L184: **function** `uploadViaScp`
- L201: **function** `showList`
- L222: **async function** `main`

### `src/config.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-configjs)

- L48: **function** `getPostsFromEnv`
- L61: **function** `getPostLabelsFromEnv`

### `src/db/cache.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-db-cachejs)

- L12: **function** `ensureDir`
- L18: **export function** `loadCache`
- L50: **export function** `saveCache`
- L93: **export function** `getCacheSize`
- L106: **export function** `getCacheEntryCount`

### `src/fb/checkpoint.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-checkpointjs)

- L63: **function** `isCheckpointUrl`
- L72: **async function** `hasCheckpointElements`
- L89: **async function** `hasCheckpointText`
- L106: **async function** `isCheckpoint`
- L153: **async function** `getCheckpointType`

### `src/fb/comments.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-commentsjs)

- L25: **function** `pickUiHandler`
- L34: **function** `resolveFastFlag`
- L46: **async function** `openCommentsMenu`
- L48: **const arrow** `norm`
- L55: **function** `getLabel`
- L103: **async function** `clickMenuOptionByPrefix`
- L106: **const arrow** `norm`
- L144: **async function** `switchCommentsFilterToAllLegacy`
- L181: **export async function** `switchCommentsFilterToNewest`
- L237: **export async function** `expandAllComments`
- L254: **async function** `getCommentCountLegacy`
- L280: **const arrow** `pushText`
- L342: **async function** `extractCommentsFromDOM`
- L344: **function** `extractCommentIdRaw`
- L349: **function** `safeAtob`
- L360: **function** `idNumFromRaw`
- L374: **function** `normalizeTime`
- L393: **function** `findTimeAround`
- L456: **async function** `prepareLegacy`
- L500: **async function** `loadAllCommentsLegacy`
- L512: **function** `uniqAnchorCountEval`
- L527: **function** `commentNodesCountEval`
- L534: **function** `hasMoreButtonsEval`
- L536: **const arrow** `norm`
- L655: **export async function** `prepare`
- L669: **export async function** `getCommentCount`
- L684: **export async function** `loadAllComments`
- L700: **export async function** `extractCommentsData`
- L706: **const arrow** `getPostRef`
- L734: **const arrow** `filterByRef`

### `src/fb/cookies.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-cookiesjs)

- L19: **async function** `loadCookies`
- L40: **async function** `atomicWriteFile`
- L56: **async function** `saveCookies`
- L92: **async function** `acceptCookies`

### `src/fb/expandButtons.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-expandbuttonsjs)

- L13: **async function** `clickOneExpandButton`
- L24: **function** `getPostRoot`
- L52: **function** `isVisible`
- L76: **function** `classifyButton`

### `src/fb/legacy/comments.legacy.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-legacy-commentslegacyjs)

- L23: **async function** `switchCommentsFilterToAll`
- L120: **async function** `clickShowAllCommentsIfPresent`
- L179: **async function** `extractCommentsFromDOM`
- L181: **function** `extractCommentId`
- L246: **async function** `clickAllCommentsInMenu`
- L290: **function** `postRootScript`
- L292: **function** `getPostRoot`
- L322: **async function** `getCurrentCommentAnchorCount`
- L356: **async function** `scrollWithinPost`
- L370: **function** `pushIfScrollable`
- L647: **async function** `scrollToAbsoluteBottom`
- L661: **function** `pushIfScrollable`
- L951: **async function** `pauseVideoIfAny`
- L977: **async function** `clickAllLoadMoreAtBottom`
- L980: **function** `normalize`
- L983: **function** `findCommentsRoot`
- L1026: **async function** `ensureAllCommentsLoaded`
- L1051: **async function** `hasLoadMoreButtons`
- L1200: **async function** `clickMoreCommentsButtonsVideo`
- L1206: **const arrow** `norm`
- L1211: **function** `getPostRoot`
- L1348: **async function** `walkVideoCommentsSequential`
- L1355: **const arrow** `norm`
- L1362: **const arrow** `isVisible`
- L1370: **function** `getLabel`
- L1377: **function** `findClickable`
- L1388: **function** `getPostRoot`
- L1411: **function** `canScrollByTest`
- L1431: **function** `getCommentsContainerSmart`
- L1433: **function** `isInDom`
- L1441: **function** `canScrollByTest`
- L1508: **function** `clickMoreCommentsOnce`
- L1544: **function** `expandReplies`
- L1585: **function** `scrollSomewhere`
- L1677: **async function** `getCommentCount`
- L1900: **async function** `expandAllComments`
- L1915: **export async function** `extractCommentsData`

### `src/fb/login.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-loginjs)

- L11: **async function** `diagnoseCaptchaType`
- L205: **async function** `solveFunCaptchaViaApi`
- L294: **async function** `solveRecaptchaViaApi`
- L391: **async function** `solveGridCaptcha`
- L628: **function** `translateInstruction`
- L681: **async function** `hasImageGrid`
- L717: **function** `norm`
- L727: **async function** `acceptLoginCookies`
- L783: **async function** `acceptCookiesIfPresent`
- L827: **async function** `clickSubmitButton`
- L937: **async function** `fillLoginFormBestEffort`
- L1336: **async function** `loginViaVisibleForm`
- L1389: **async function** `fbLogin`
- L1422: **async function** `checkIfLogged`
- L1440: **async function** `clickByText`
- L1464: **async function** `looksLikeLoginWall`
- L1507: **async function** `ensureLoggedInOnPostOverlay`
- L1552: **async function** `hasCaptcha`
- L1618: **async function** `solveCaptchaIfPresent`

### `src/fb/scroll.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-scrolljs)

- L8: **async function** `scrollPost`
- L15: **function** `findScrollableAncestor`

### `src/fb/ui/index.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-indexjs)

- L9: **export function** `pickUiHandler`

### `src/fb/ui/photo.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-photojs)

- L68: **export function** `matchesUrl`
- L89: **async function** `clickAllCommentsInMenu`
- L128: **async function** `switchCommentsFilterToAll`
- L187: **async function** `getCommentsRootHandle`
- L189: **const arrow** `norm`
- L196: **const arrow** `isVisible`
- L206: **const arrow** `isMoreCommentsBtn`
- L255: **async function** `getCommentsScrollHandle`
- L257: **const arrow** `isVisible`
- L267: **const arrow** `canScrollByTest`
- L285: **const arrow** `closestScrollable`
- L325: **export async function** `prepare`
- L354: **function** `parseNumberLikeNode`
- L384: **async function** `getPhotoUiCountFromChip`
- L389: **const arrow** `norm`
- L395: **const arrow** `parseNum`
- L418: **const arrow** `isVisible`
- L498: **export async function** `getCommentCount`
- L568: **export async function** `loadAllComments`
- L579: **const arrow** `shortBtn`
- L585: **async function** `countAnchors`
- L592: **const arrow** `uniq`
- L610: **async function** `gentleScrollKick`
- L638: **async function** `getScrollMetrics`
- L664: **async function** `hasLoadMoreButtons`
- L668: **const arrow** `norm`
- L675: **const arrow** `isVisible`
- L709: **function** `isHardBottom`
- L721: **async function** `updateHardBottomStability`
- L755: **async function** `waitForEffect`
- L763: **const arrow** `countUniq`
- L786: **const arrow** `norm`
- L793: **const arrow** `isVisible`
- L840: **async function** `bonusClicks`
- L873: **async function** `clickOneReplyButton`
- L877: **const arrow** `norm`
- L884: **const arrow** `isVisible`
- L896: **const arrow** `isReplyExpanderText`
- L971: **const arrow** `hardClick`
- L997: **async function** `clickMoreCommentsButton`
- L1001: **const arrow** `norm`
- L1008: **const arrow** `isVisible`
- L1015: **const arrow** `isMore`
- L1067: **async function** `hasAnyReplyExpanders`
- L1071: **const arrow** `norm`
- L1078: **const arrow** `isVisible`
- L1088: **const arrow** `isReplyExpanderText`
- L1124: **async function** `clickAllVisibleReplyExpanders`
- L1129: **const arrow** `norm`
- L1136: **const arrow** `isVisible`
- L1147: **const arrow** `isReplyExpanderText`
- L1187: **const arrow** `hardClick`
- L1242: **async function** `scrollCommentsToTop`
- L1252: **async function** `sweepRepliesTopDown`
- L1314: **const arrow** `shouldLog`

### `src/fb/ui/post.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-postjs)

- L16: **export function** `matchesUrl`
- L36: **function** `postRootScript`
- L38: **function** `getPostRoot`
- L77: **async function** `getPostScopeSelector`
- L101: **async function** `clickMenuOptionByPattern`
- L103: **const arrow** `norm`
- L144: **async function** `clickAllCommentsInMenu`
- L146: **const arrow** `norm`
- L193: **async function** `switchCommentsFilterToAllScoped`
- L210: **const arrow** `norm`
- L222: **function** `getLabel`
- L229: **function** `isVisibleEnough`
- L243: **function** `findClickableAncestor`
- L380: **const arrow** `norm`
- L391: **function** `getLabel`
- L422: **async function** `openFilterMenuScoped`
- L425: **const arrow** `norm`
- L437: **function** `getLabel`
- L444: **function** `isVisibleEnough`
- L518: **export async function** `switchCommentsFilterToNewestScoped`
- L536: **const arrow** `norm`
- L578: **const arrow** `norm`
- L614: **async function** `getCommentCountFromUiPostRoot`
- L619: **const arrow** `norm`
- L625: **const arrow** `lower`
- L627: **function** `parsePlEnCount`
- L666: **const arrow** `badBlock`
- L733: **async function** `getCurrentCommentAnchorCount`
- L768: **async function** `scrollWithinPost`
- L776: **const arrow** `norm`
- L783: **function** `canScrollByTest`
- L801: **function** `isVisible`
- L811: **function** `pickContainerSmart`
- L828: **function** `score`
- L932: **async function** `expandAllComments`
- L949: **export async function** `prepare`
- L992: **async function** `waitForScrollStop`
- L1023: **export async function** `getCommentCount`
- L1059: **export async function** `loadAllComments`
- L1108: **export async function** `extractComments`
- L1110: **function** `extractCommentId`
- L1160: **export async function** `debugSnapshot`

### `src/fb/ui/videos.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-videosjs)

- L11: **export function** `matchesUrl`
- L16: **export async function** `prepare`
- L59: **export async function** `getCommentCount`
- L79: **function** `shortenHtml`
- L86: **async function** `debugDumpShowAllCandidates`
- L88: **const arrow** `norm`
- L89: **function** `pick`
- L133: **async function** `markCommentsScope`
- L135: **const arrow** `norm`
- L137: **function** `isVisible`
- L145: **function** `pick`
- L259: **async function** `clickShowAllFromMarkedRow`
- L261: **const arrow** `norm`
- L263: **function** `isVisible`
- L271: **function** `pick`
- L320: **async function** `ensureAllCommentsFilter`
- L322: **const arrow** `norm`
- L324: **function** `isVisible`
- L332: **function** `pick`
- L391: **const arrow** `norm`
- L393: **function** `isVisible`
- L401: **function** `pick`
- L464: **export async function** `switchCommentsFilterToNewestScoped`
- L471: **const arrow** `norm`
- L473: **function** `isVisible`
- L521: **const arrow** `norm`
- L540: **const arrow** `norm`
- L542: **function** `isVisible`
- L589: **const arrow** `norm`
- L591: **function** `isVisible`
- L644: **async function** `oneSequentialAction`
- L646: **const arrow** `norm`
- L648: **function** `isVisible`
- L656: **function** `pick`
- L789: **export async function** `loadAllComments`
- L850: **export async function** `extractComments`
- L852: **function** `getCommentId`
- L909: **export async function** `debugSnapshot`

### `src/fb/ui/watch.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-ui-watchjs)

- L13: **export function** `matchesUrl`
- L28: **async function** `safeShot`
- L39: **async function** `shotElement`
- L60: **async function** `debugOuterStats`
- L65: **const arrow** `norm`
- L122: **async function** `debugScrollerStats`
- L147: **function** `parseCountFromText`
- L178: **function** `parseBestCommentsCountFromBlob`
- L194: **function** `pickBestCount`
- L216: **async function** `findCommentsOuter`
- L220: **const arrow** `visible`
- L259: **async function** `findScrollableInOuter`
- L263: **function** `isVisible`
- L269: **function** `canScroll`
- L320: **async function** `clickMoreCommentsIfPresent`
- L335: **const arrow** `norm`
- L342: **const arrow** `isVisible`
- L376: **async function** `getAnchorsCount`
- L396: **async function** `getCommentRootsCount`
- L417: **export async function** `prepare`
- L479: **export async function** `getCommentCount`
- L513: **export async function** `loadAllComments`
- L629: **export async function** `extractComments`
- L638: **function** `norm`
- L645: **function** `toAbsHref`
- L652: **function** `getCommentId`
- L661: **function** `normalizeTime`
- L680: **function** `findTimeInRoot`
- L751: **export async function** `debugSnapshot`

### `src/fb/uiCommentInfo.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-fb-uicommentinfojs)

- L6: **export async function** `getUiCommentInfo`
- L8: **function** `norm`
- L13: **function** `detectViewType`
- L25: **function** `isVisibleRough`
- L34: **function** `parseSingleCount`
- L60: **function** `findActionBarRoot`
- L82: **function** `dropConcatenations`
- L85: **function** `isConcatOfTwoExisting`
- L105: **function** `extractFromMetaRow`
- L182: **function** `extractVideoCommentsFromIconButtons`
- L187: **function** `hasSuffixToken`
- L266: **function** `extractNearLabels`
- L271: **function** `hasAny`
- L275: **function** `getNodeLabel`
- L282: **function** `findActionRowContainer`
- L351: **function** `scanLeftForNumber`

### `src/index.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-indexjs)

- L20: **function** `ensureDir`
- L40: **function** `safeToString`
- L52: **function** `fireAlert`

### `src/panel/api.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-apijs)

- L43: **function** `auth`
- L53: **function** `json`
- L58: **function** `sh`
- L72: **async function** `getProjectDir`
- L86: **function** `readBody`
- L94: **function** `safeJsonParse`
- L102: **function** `ensureDir`
- L106: **function** `atomicWriteFile`
- L118: **function** `normalizeUrl`
- L125: **function** `normalizeOptionalUrl`
- L133: **function** `nowIso`
- L137: **function** `stripAnsi`
- L141: **function** `setEnvKey`
- L148: **function** `pickPostsFile`
- L152: **function** `readPosts`
- L162: **function** `writePosts`
- L166: **function** `genId`
- L170: **function** `route`
- L176: **function** `match`
- L189: **function** `parsePm2LogPaths`
- L201: **async function** `getPm2LogPaths`
- L222: **async function** `readTailLog`
- L659: **function** `okOrErr`
- L663: **async function** `pm2Describe`

### `src/panel/ui/app.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-ui-appjs)

- L66: **function** `setHint`
- L73: **function** `fmtTime`
- L81: **function** `getAuthHeaders`
- L86: **async function** `api`
- L119: **function** `showModal`
- L138: **function** `closeModal`
- L156: **async function** `loadStatus`
- L173: **async function** `loadEnv`
- L189: **async function** `saveEnv`
- L212: **function** `copyIconSvg`
- L222: **async function** `loadPosts`
- L391: **async function** `addPost`
- L421: **async function** `pm2Call`
- L456: **async function** `clearCookies`
- L480: **function** `getLines`
- L486: **async function** `loadLogs`
- L506: **function** `stopAutoLogs`
- L515: **function** `startAutoLogs`
- L531: **function** `toggleLogsSize`
- L538: **async function** `copyToClipboard`
- L560: **function** `escapeHtml`
- L570: **function** `wire`
- L610: **async function** `hardRefresh`

### `src/panel/web/src/components/layout/DashboardLayout.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-dashboardlayouttsx)

- L18: **export function** `DashboardLayout`

### `src/panel/web/src/components/layout/Header.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-headertsx)

- L9: **export function** `Header`

### `src/panel/web/src/components/layout/MobileNav.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-mobilenavtsx)

- L11: **export function** `MobileNav`

### `src/panel/web/src/components/layout/Sidebar.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-layout-sidebartsx)

- L24: **function** `NavItem`
- L64: **export function** `Sidebar`

### `src/panel/web/src/components/ui/badge.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-badgetsx)

- L28: **function** `Badge`

### `src/panel/web/src/components/ui/checkbox.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-checkboxtsx)

- L11: **const arrow** `handleChange`

### `src/panel/web/src/components/ui/dialog.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-dialogtsx)

- L18: **function** `Dialog`
- L60: **function** `DialogPortal`
- L90: **const arrow** `handleEscape`
- L129: **const arrow** `DialogHeader`
- L134: **const arrow** `DialogFooter`

### `src/panel/web/src/components/ui/switch.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-components-ui-switchtsx)

- L10: **const arrow** `handleChange`

### `src/panel/web/src/hooks/useAuth.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-hooks-useauthtsx)

- L12: **export function** `AuthProvider`
- L29: **export function** `useAuth`

### `src/panel/web/src/hooks/useLogs.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-hooks-uselogsts)

- L17: **export function** `useLogs`

### `src/panel/web/src/lib/api.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-lib-apits)

- L12: **export function** `getToken`
- L16: **export function** `setToken`
- L20: **function** `getAuthHeaders`
- L66: **export async function** `getStatus`
- L71: **export async function** `getEnv`
- L75: **export async function** `setEnv`
- L83: **export async function** `getPosts`
- L87: **export async function** `addPost`
- L94: **export async function** `updatePost`
- L101: **export async function** `deletePost`
- L108: **export async function** `pm2Start`
- L112: **export async function** `pm2Stop`
- L116: **export async function** `pm2Restart`
- L120: **export async function** `pm2Status`
- L125: **export async function** `getLogsOut`
- L129: **export async function** `getLogsErr`
- L134: **export async function** `clearCookies`
- L141: **export async function** `getCookiesStatus`

### `src/panel/web/src/lib/utils.ts` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-lib-utilsts)

- L4: **export function** `cn`

### `src/panel/web/src/pages/Campaigns.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-campaignstsx)

- L4: **export function** `Campaigns`

### `src/panel/web/src/pages/Cookies.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-cookiestsx)

- L24: **function** `formatAge`
- L31: **function** `formatSize`
- L36: **export function** `Cookies`
- L46: **const arrow** `showMessage`
- L72: **const async** `handleClear`

### `src/panel/web/src/pages/Dashboard.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-dashboardtsx)

- L12: **function** `TokenForm`
- L16: **const arrow** `handleSave`
- L51: **function** `parsePm2Status`
- L71: **export function** `Dashboard`
- L77: **const async** `loadStatus`

### `src/panel/web/src/pages/Discoveries.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-discoveriestsx)

- L4: **export function** `Discoveries`

### `src/panel/web/src/pages/Logs.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-logstsx)

- L13: **export function** `Logs`
- L40: **const arrow** `handleRefresh`
- L44: **const arrow** `handleModeChange`
- L48: **const arrow** `toggleAutoRefresh`

### `src/panel/web/src/pages/Settings.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-settingstsx)

- L130: **function** `isTruthy`
- L134: **function** `boolToEnv`
- L138: **export function** `Settings`
- L145: **const arrow** `showMessage`
- L150: **const async** `loadEnv`
- L170: **const arrow** `handleChange`
- L176: **const arrow** `handleSwitchChange`
- L182: **const async** `handleSave`
- L204: **const async** `handlePm2Action`
- L222: **const arrow** `renderField`

### `src/panel/web/src/pages/Sources.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-sourcestsx)

- L4: **export function** `Sources`

### `src/panel/web/src/pages/Watched.tsx` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-panel-web-src-pages-watchedtsx)

- L27: **export function** `Watched`
- L72: **const arrow** `showMessage`
- L77: **const async** `handleAdd`
- L109: **const async** `handleToggleActive`
- L122: **const arrow** `openEditDialog`
- L129: **const async** `handleEdit`
- L154: **const async** `handleDelete`
- L174: **const async** `copyToClipboard`

### `src/telegram.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-telegramjs)

- L9: **function** `parseFbRelativeTime`
- L43: **function** `shouldSendByAge`
- L60: **function** `envBool`
- L66: **function** `escapeHtml`
- L75: **function** `buildCaptionHtml`
- L95: **async function** `tgRequest`
- L113: **async function** `sendMessage`
- L125: **async function** `sendPhoto`
- L135: **function** `getTargets`
- L175: **async function** `sendTelegramLead`
- L210: **async function** `sendTelegramLeads`
- L225: **function** `shorten`
- L231: **function** `makeAlertKey`
- L237: **async function** `sendOwnerAlert`

### `src/utils/logger.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-loggerjs)

- L54: **function** `timestamp`
- L63: **function** `formatModule`
- L68: **function** `formatData`
- L97: **function** `formatDataFull`

### `src/utils/mouse.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-mousejs)

- L15: **function** `bezierPoint`
- L35: **function** `generateBezierPath`
- L80: **async function** `moveMouse`
- L103: **async function** `getElementCenter`
- L119: **async function** `moveToElement`
- L153: **async function** `humanClick`
- L190: **async function** `randomMouseMovement`

### `src/utils/navigation.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-navigationjs)

- L10: **export async function** `safeGoto`

### `src/utils/sleep.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-sleepjs)

- L7: **function** `sleep`
- L14: **function** `sleepRandom`
- L27: **function** `gaussianRandom`
- L44: **async function** `humanDelay`
- L59: **async function** `humanTypingDelay`
- L79: **async function** `betweenPostsPause`
- L97: **async function** `humanType`
- L114: **function** `shuffleArray`

### `src/utils/time.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-utils-timejs)

- L8: **export function** `parseFbRelativeTime`
- L45: **export function** `filterByAge`

### `src/watcher.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-src-watcherjs)

- L92: **function** `isNavigationError`
- L103: **function** `envBool`
- L110: **function** `getCommentAgeMinutes`
- L118: **async function** `sendTelegramIfFresh`
- L164: **async function** `applyStealth`
- L188: **function** `safeJsonParse`
- L196: **function** `normalizeUrl`
- L203: **function** `makePostKey`
- L234: **function** `readPanelPosts`
- L276: **function** `parseSheetCsv`
- L327: **async function** `fetchPostsFromApi`
- L379: **async function** `refreshPostsIfNeeded`
- L467: **function** `getCacheKey`
- L471: **function** `getKnownSetForPost`
- L485: **function** `cleanupKnownIds`
- L501: **function** `getTotalKnownIdsCount`
- L509: **function** `flushCacheToDisk`
- L533: **function** `getExecutablePath`
- L542: **async function** `startWatcher`
- L549: **const async** `loop`

### `tools/export-project-to-md.js` ‚Üí [sekcja pliku](#≈õcie≈ºka-tools-export-project-to-mdjs)

- L134: **function** `normalizeRel`
- L138: **function** `isHiddenName`
- L142: **function** `looksBinaryByExt`
- L147: **function** `isAllowedFile`
- L163: **function** `detectLang`
- L179: **function** `typeLabel`
- L192: **function** `guessDescription`
- L203: **function** `safeReadText`
- L223: **function** `redactIfNeeded`
- L245: **function** `padLeft`
- L250: **function** `addLineNumbers`
- L256: **function** `makeAnchor`
- L268: **function** `walk`
- L292: **function** `sortFiles`
- L293: **const arrow** `rel`
- L295: **const arrow** `score`
- L315: **function** `countByExt`
- L327: **function** `buildTree`
- L330: **function** `insert`
- L346: **function** `walkNode`
- L385: **function** `extractExports`
- L389: **const arrow** `push`
- L432: **function** `extractFunctionsAndClasses`
- L437: **const arrow** `add`
- L500: **function** `extractLocalImports`
- L505: **const arrow** `add`
- L530: **function** `keywordHits`
- L554: **function** `main`

---

## üîé Keyword index

### `cookies` (hits: 140)

- `.env` L9: `# cookies`
- `src/fb/comments.js` L5: `import { acceptCookies, saveCookies } from "./cookies.js";`
- `src/fb/cookies.js` L1: `// src/fb/cookies.js`
- `src/fb/cookies.js` L17: `* ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.`
- `src/fb/cookies.js` L21: `const raw = await fs.readFile("cookies.json", "utf8");`
- `src/fb/cookies.js` L22: `const cookies = JSON.parse(raw);`
- `src/fb/cookies.js` L24: `if (Array.isArray(cookies) && cookies.length) {`
- `src/fb/cookies.js` L25: `await page.setCookie(...cookies);`
- `src/fb/cookies.js` L26: `log.dev("COOKIES", `Za≈Çadowano ${cookies.length} cookies z pliku`);`
- `src/fb/cookies.js` L28: `log.dev("COOKIES", "cookies.json istnieje, ale nie zawiera poprawnej tablicy");`
- `src/fb/cookies.js` L31: `log.dev("COOKIES", `Brak cookies.json lub b≈ÇƒÖd odczytu: ${err?.message || err}`);`
- `src/fb/cookies.js` L53: `* Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json`
- `src/fb/cookies.js` L63: `const cookies = await page.cookies();`
- `src/fb/cookies.js` L64: `const content = JSON.stringify(cookies, null, 2);`
- `src/fb/cookies.js` L66: `await atomicWriteFile("cookies.json", content);`
- `src/fb/cookies.js` L68: `log.dev("COOKIES", `Zapisano ${cookies.length} cookies do pliku`);`
- `src/fb/cookies.js` L70: `log.warn("COOKIES", `B≈ÇƒÖd zapisu cookies.json: ${e?.message || e}`);`
- `src/fb/cookies.js` L76: `if (f.startsWith(".cookies.") && f.endsWith(".tmp")) {`
- `src/fb/cookies.js` L89: `* Og√≥lne akceptowanie popupu cookies na FB (np. na postach).`
- `src/fb/cookies.js` L103: `"allow all cookies",`
- `src/fb/cookies.js` L104: `"accept all cookies",`
- `src/fb/cookies.js` L105: `"accept essential and optional cookies",`
- `src/fb/cookies.js` L135: `log.debug("COOKIES", `[${label}] Klikniƒôto akceptacjƒô cookies`);`
- `src/fb/cookies.js` L138: `log.debug("COOKIES", `[${label}] Nie znaleziono przycisku cookies`, { texts: result.texts?.slice(0, 5) });`
- `src/fb/legacy/comments.legacy.js` L8: `import { acceptCookies, saveCookies } from "../cookies.js";`
- `src/fb/legacy/comments.legacy.js` L1752: `"[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."`
- `src/fb/legacy/comments.legacy.js` L1757: `"[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."`
- `src/fb/legacy/comments.legacy.js` L1762: `"[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",`
- `src/fb/login.js` L729: `log.debug("LOGIN", "Szukam popupu cookies...");`
- `src/fb/login.js` L737: `"Allow all cookies",`
- `src/fb/login.js` L738: `"Accept all cookies",`
- `src/fb/login.js` L770: `log.debug("LOGIN", "Klikniƒôto cookies popup");`
- `src/fb/login.js` L775: `log.debug("LOGIN", `B≈ÇƒÖd cookies popup: ${err?.message || err}`);`
- `src/fb/login.js` L781: `* Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).`
- `src/fb/login.js` L793: `"Allow all cookies",`
- `src/fb/login.js` L794: `"Accept all cookies",`
- `src/fb/login.js` L815: `log.debug("LOGIN", "Klikniƒôto accept cookies (fallback)");`
- `src/fb/login.js` L1402: `// cookies ‚Äì dwie metody (mark+click oraz szybki fallback)`
- `src/fb/ui/photo.js` L5: `import { acceptCookies, saveCookies } from "../cookies.js";`
- `src/fb/ui/post.js` L8: `import { acceptCookies, saveCookies } from "../cookies.js";`
- `src/fb/ui/videos.js` L4: `import { acceptCookies } from "../cookies.js";`
- `src/fb/ui/watch.js` L4: `import { acceptCookies, saveCookies } from "../cookies.js";`
- `src/panel/api.js` L372: `const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");`
- `src/panel/api.js` L391: `cookiesPath: COOKIES_PATH,`
- `src/panel/api.js` L643: `if (req.method === "POST" && pathname === "/api/cookies/clear") {`
- `src/panel/api.js` L649: `json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);`
- `src/panel/api.js` L654: `json(res, { ok: true, cookiesPath: COOKIES_PATH });`
- `src/panel/ui/app.js` L458: `title: "Wyczy≈õciƒá cookies?",`
- `src/panel/ui/app.js` L465: `setHint(elEnvMsg, "Czyszczƒô cookies...", true);`
- `src/panel/ui/app.js` L467: `const r = await api("/api/cookies/clear", {`
- `src/panel/ui/app.js` L473: `setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);`
- `src/panel/ui/index.html` L353: `<button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>`
- `src/panel/web/src/App.tsx` L24: `<Route path="/cookies" element={<Cookies />} />`
- `src/panel/web/src/components/layout/DashboardLayout.tsx` L13: `'/cookies': 'Sesje / Cookies',`
- `src/panel/web/src/components/layout/Sidebar.tsx` L124: `<NavItem to="/cookies" icon={<Cookie className="h-4 w-4" />} label="Sesje" />`
- `src/panel/web/src/lib/api.ts` L135: `return request('/api/cookies/clear', {`
- `src/panel/web/src/lib/api.ts` L142: `return request<SessionStatus>('/api/cookies/status')`
- `src/panel/web/src/lib/types.ts` L18: `cookiesPath: string`
- `src/panel/web/src/lib/types.ts` L64: `// Status sesji cookies`
- `src/panel/web/src/pages/Cookies.tsx` L59: `setError(result.error || 'Nie udalo sie pobrac statusu cookies')`

### `pm2` (hits: 113)

- `.env` L43: `PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log`
- `.env` L44: `PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log`
- `src/panel/api.js` L76: `const r = await sh(`pm2 describe ${PM2_APP}`);`
- `src/panel/api.js` L80: ``Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)``
- `src/panel/api.js` L188: `// ---------- LOGS (dynamic from pm2 describe) ----------`
- `src/panel/api.js` L189: `function parsePm2LogPaths(pm2DescribeText) {`
- `src/panel/api.js` L191: `pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||`
- `src/panel/api.js` L192: `pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||`
- `src/panel/api.js` L195: `pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||`
- `src/panel/api.js` L196: `pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||`
- `src/panel/api.js` L208: `const d = await sh(`pm2 describe ${appName}`);`
- `src/panel/api.js` L213: `source: "pm2_error",`
- `src/panel/api.js` L214: `pm2: d.stderr || d.stdout || "",`
- `src/panel/api.js` L218: `cachedLogPaths = { out: p.out || "", err: p.err || "", source: "pm2_describe" };`
- `src/panel/api.js` L228: `"Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",`
- `src/panel/api.js` L377: `// Cache node/pm2 versions (don't change during runtime)`
- `src/panel/api.js` L383: `const pm2v = await sh("pm2 -v");`
- `src/panel/api.js` L384: `cachedPm2Version = pm2v.stdout;`
- `src/panel/api.js` L386: `const pm2s = await sh(`pm2 status ${PM2_APP}`);`
- `src/panel/api.js` L394: `pm2: cachedPm2Version,`
- `src/panel/api.js` L395: `pm2Status: stripAnsi(pm2s.stdout),`
- `src/panel/api.js` L485: `let pm2Action = null;`
- `src/panel/api.js` L487: `const r = await sh(`pm2 restart ${PM2_APP} --update-env`);`
- `src/panel/api.js` L488: `pm2Action = { ok: r.ok, out: r.stdout || r.stderr };`
- `src/panel/api.js` L491: `json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });`
- `src/panel/api.js` L663: `async function pm2Describe(name) {`
- `src/panel/api.js` L664: `return await sh(`pm2 describe ${name}`);`
- `src/panel/api.js` L670: `if (req.method === "POST" && pathname === "/api/pm2/start") {`
- `src/panel/api.js` L671: `const d = await pm2Describe(WATCH_NAME);`
- `src/panel/api.js` L673: `const r = await sh(`pm2 start ${WATCH_NAME}`);`
- `src/panel/api.js` L678: `const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);`
- `src/panel/ui/app.js` L23: `const btnPm2Start = $("pm2Start");`
- `src/panel/ui/app.js` L24: `const btnPm2Stop = $("pm2Stop");`
- `src/panel/ui/app.js` L25: `const btnPm2Restart = $("pm2Restart");`
- `src/panel/ui/app.js` L421: `async function pm2Call(which) {`
- `src/panel/ui/app.js` L423: `start: "/api/pm2/start",`
- `src/panel/ui/app.js` L424: `stop: "/api/pm2/stop",`
- `src/panel/ui/app.js` L425: `restart: "/api/pm2/restart",`
- `src/panel/ui/app.js` L426: `status: "/api/pm2/status",`
- `src/panel/ui/app.js` L587: `btnPm2Start.addEventListener("click", async () => await pm2Call("start"));`
- `src/panel/ui/app.js` L588: `btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));`
- `src/panel/ui/app.js` L589: `btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));`
- `src/panel/ui/index.html` L350: `<button id="pm2Start">Start watchera</button>`
- `src/panel/ui/index.html` L351: `<button id="pm2Stop">Stop watchera</button>`
- `src/panel/ui/index.html` L352: `<button id="pm2Restart">Restart watchera</button>`
- `src/panel/web/src/lib/api.ts` L108: `export async function pm2Start(): Promise<{ ok: boolean; output?: string; error?: string }> {`
- `src/panel/web/src/lib/api.ts` L109: `return request('/api/pm2/start', { method: 'POST' })`
- `src/panel/web/src/lib/api.ts` L112: `export async function pm2Stop(): Promise<{ ok: boolean; output?: string; error?: string }> {`
- `src/panel/web/src/lib/api.ts` L113: `return request('/api/pm2/stop', { method: 'POST' })`
- `src/panel/web/src/lib/api.ts` L116: `export async function pm2Restart(): Promise<{ ok: boolean; output?: string; error?: string }> {`
- `src/panel/web/src/lib/api.ts` L117: `return request('/api/pm2/restart', { method: 'POST' })`
- `src/panel/web/src/lib/api.ts` L120: `export async function pm2Status(): Promise<{ ok: boolean; output?: string; error?: string }> {`
- `src/panel/web/src/lib/api.ts` L121: `return request('/api/pm2/status')`
- `src/panel/web/src/lib/types.ts` L21: `pm2: string`
- `src/panel/web/src/lib/types.ts` L22: `pm2Status: string`
- `src/panel/web/src/pages/Dashboard.tsx` L108: `const pm2Info = status?.pm2Status ? parsePm2Status(status.pm2Status) : null`
- `src/panel/web/src/pages/Dashboard.tsx` L143: `pm2Info?.status === 'online'`
- `src/panel/web/src/pages/Dashboard.tsx` L145: `: pm2Info?.status === 'stopped'`
- `src/panel/web/src/pages/Dashboard.tsx` L150: `{pm2Info?.status || 'unknown'}`
- `src/panel/web/src/pages/Dashboard.tsx` L152: `{pm2Info?.uptime && (`

### `watcher` (hits: 103)

- `package.json` L9: `"panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",`
- `.env` L2: `FB_EMAIL=fbwatcher1@gmail.com`
- `.env` L25: `# PROJECT_DIR=/opt/fb-watcher`
- `.env` L26: `# POSTS_FILE=/opt/fb-watcher/data/posts.json`
- `.env` L31: `# === POSTS Z REMOTE API (lokalny watcher ‚Üê panel na serwerze) ===`
- `.env` L42: `PM2_APP=fbwatcher`
- `.env` L43: `PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log`
- `.env` L44: `PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log`
- `DEBUG_EXPORT/src/config.js` L19: `* POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).`
- `DEBUG_EXPORT/src/config.js` L30: `* ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,`
- `DEBUG_EXPORT/src/config.js` L63: `* Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,`
- `DEBUG_EXPORT/src/config.js` L97: `// u≈ºywane przez watcher.js / comments.js`
- `src/config.js` L13: `* Je≈õli ustawione, watcher pobiera posty z panelu przez HTTP (priorytet nad plikiem i Sheets)`
- `src/config.js` L33: `* POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).`
- `src/config.js` L44: `* ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,`
- `src/config.js` L77: `* Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,`
- `src/config.js` L177: `// u≈ºywane przez watcher.js / comments.js`
- `src/fb/legacy/comments.legacy.js` L392: `const cached = document.querySelector("[data-fbwatcher-comments='1']");`
- `src/fb/legacy/comments.legacy.js` L577: `container.setAttribute("data-fbwatcher-comments", "1");`
- `src/fb/legacy/comments.legacy.js` L683: `const cached = document.querySelector("[data-fbwatcher-comments='1']");`
- `src/fb/legacy/comments.legacy.js` L860: `container.setAttribute("data-fbwatcher-comments", "1");`
- `src/index.js` L17: `import { startWatcher } from "./watcher.js";`
- `src/panel/api.js` L29: `const PM2_APP = process.env.PM2_APP || "fbwatcher";`
- `src/panel/api.js` L251: `"Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",`
- `src/panel/api.js` L668: `const WATCH_NAME = PM2_APP || "fbwatcher";`
- `src/panel/ui/app.js` L209: `setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);`
- `src/panel/ui/app.js` L432: `which === "start" ? "Startujƒô watchera..."`
- `src/panel/ui/app.js` L433: `: which === "stop" ? "Zatrzymujƒô watchera..."`
- `src/panel/ui/app.js` L434: `: which === "restart" ? "Restartujƒô watchera..."`
- `src/panel/ui/index.html` L350: `<button id="pm2Start">Start watchera</button>`
- `src/panel/ui/index.html` L351: `<button id="pm2Stop">Stop watchera</button>`
- `src/panel/ui/index.html` L352: `<button id="pm2Restart">Restart watchera</button>`
- `src/panel/web/package-lock.json` L2: `"name": "fbwatcher-panel",`
- `src/panel/web/package-lock.json` L8: `"name": "fbwatcher-panel",`
- `src/panel/web/package.json` L2: `"name": "fbwatcher-panel",`
- `src/panel/web/src/pages/Cookies.tsx` L204: `To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu watchera.`
- `src/panel/web/src/pages/Dashboard.tsx` L55: `if (line.includes('fbwatcher') || line.includes('fb-watcher')) {`
- `src/panel/web/src/pages/Settings.tsx` L299: `<CardDescription>Zarzadzanie procesem watchera</CardDescription>`
- `src/watcher.js` L1: `// src/watcher.js`
- `DEBUG_EXPORT/src/panel/api.js` L23: `const PM2_APP = process.env.PM2_APP || "fbwatcher";`
- `DEBUG_EXPORT/src/panel/api.js` L229: `"Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",`
- `DEBUG_EXPORT/src/panel/api.js` L549: `const WATCH_NAME = PM2_APP || "fbwatcher";`
- `CLAUDE.md` L10: `| `src/watcher.js` | ~895 | `startWatcher()`, `processPost()`, `fetchPosts()` | g≈Ç√≥wna pƒôtla |`
- `CLAUDE.md` L191: `| ≈öcie≈ºka | `/opt/fb-watcher` |`
- `CLAUDE.md` L211: `pm2 logs fb-watcher`
- `CLAUDE.md` L243: `cd /opt/fb-watcher`
- `CLAUDE.md` L245: `pm2 restart fb-watcher`
- `CLAUDE.md` L254: `"Czy w watcher.js:200-220 jest memory leak?"`
- `CLAUDE.md` L260: `"Sprawd≈∫ czy watcher.js jest OK"`
- `DEBUG_EXPORT/.env` L14: `PM2_APP=fbwatcher`
- `DEBUG_EXPORT/.env` L16: `PM2_LOG_OUT=C:\Users\zorro\.pm2\logs\fbwatcher-out.log`
- `DEBUG_EXPORT/.env` L17: `PM2_LOG_ERR=C:\Users\zorro\.pm2\logs\fbwatcher-error.log`
- `DEBUG_EXPORT/package.json` L9: `"panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",`
- `DEBUG_EXPORT/src/index.js` L2: `import { startWatcher } from "./watcher.js";`
- `DEBUG_EXPORT/src/watcher.js` L1: `// src/watcher.js`
- `DEBUG_EXPORT/src/watcher.js` L356: `"[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="`
- `DEBUG_EXPORT/src/watcher.js` L541: `console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);`
- `EXPORT_PROJEKTU.md` L15: `- [export_fb_watcher/config.js](#≈õcie≈ºka-exportfbwatcher-configjs)`
- `EXPORT_PROJEKTU.md` L82: `- [src/watcher.js](#≈õcie≈ºka-src-watcherjs)`
- `EXPORT_PROJEKTU.md` L87: `- [export_fb_watcher/panel-entry.cjs](#≈õcie≈ºka-exportfbwatcher-panel-entrycjs)`

### `PM2` (hits: 51)

- `.env` L41: `# === PM2 ===`
- `.env` L42: `PM2_APP=fbwatcher`
- `.env` L43: `PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log`
- `.env` L44: `PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log`
- `src/index.js` L73: `// Daj czas na wys≈Çanie alertu, potem exit (PM2 zrestartuje)`
- `src/panel/api.js` L29: `const PM2_APP = process.env.PM2_APP || "fbwatcher";`
- `src/panel/api.js` L76: `const r = await sh(`pm2 describe ${PM2_APP}`);`
- `src/panel/api.js` L202: `const envOut = (process.env.PM2_LOG_OUT || "").trim();`
- `src/panel/api.js` L203: `const envErr = (process.env.PM2_LOG_ERR || "").trim();`
- `src/panel/api.js` L237: `"Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",`
- `src/panel/api.js` L386: `const pm2s = await sh(`pm2 status ${PM2_APP}`);`
- `src/panel/api.js` L487: `const r = await sh(`pm2 restart ${PM2_APP} --update-env`);`
- `src/panel/api.js` L658: `// ===== PM2 =====`
- `src/panel/api.js` L668: `const WATCH_NAME = PM2_APP || "fbwatcher";`
- `src/panel/api.js` L674: `json(res, okOrErr(r, "PM2 start failed"));`
- `src/panel/ui/app.js` L441: `setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);`
- `src/panel/web/src/lib/api.ts` L107: `// PM2`
- `src/panel/web/src/pages/Dashboard.tsx` L52: `// Parse PM2 status table`
- `src/panel/web/src/pages/Dashboard.tsx` L136: `<CardTitle className="text-sm font-medium">Watcher PM2</CardTitle>`
- `src/panel/web/src/pages/Dashboard.tsx` L168: `<p className="text-xs text-muted-foreground">PM2: {status.pm2 || 'N/A'}</p>`
- `src/panel/web/src/pages/Dashboard.tsx` L202: `<CardTitle className="text-sm font-medium">PM2 Status</CardTitle>`
- `src/panel/web/src/pages/Logs.tsx` L60: `<CardTitle>Logi PM2</CardTitle>`
- `src/panel/web/src/pages/Settings.tsx` L295: `{/* PM2 Controls */}`
- `src/panel/web/src/pages/Settings.tsx` L298: `<CardTitle>PM2 Controls</CardTitle>`
- `src/watcher.js` L646: ``3. PM2 automatycznie wznowi pracƒô``
- `DEBUG_EXPORT/src/panel/api.js` L23: `const PM2_APP = process.env.PM2_APP || "fbwatcher";`
- `DEBUG_EXPORT/src/panel/api.js` L62: `const r = await sh(`pm2 describe ${PM2_APP}`);`
- `DEBUG_EXPORT/src/panel/api.js` L183: `const envOut = (process.env.PM2_LOG_OUT || "").trim();`
- `DEBUG_EXPORT/src/panel/api.js` L184: `const envErr = (process.env.PM2_LOG_ERR || "").trim();`
- `DEBUG_EXPORT/src/panel/api.js` L215: `"Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",`
- `DEBUG_EXPORT/src/panel/api.js` L293: `const pm2s = await sh(`pm2 status ${PM2_APP}`);`
- `DEBUG_EXPORT/src/panel/api.js` L368: `const r = await sh(`pm2 restart ${PM2_APP} --update-env`);`
- `DEBUG_EXPORT/src/panel/api.js` L539: `// ===== PM2 =====`
- `DEBUG_EXPORT/src/panel/api.js` L549: `const WATCH_NAME = PM2_APP || "fbwatcher";`
- `DEBUG_EXPORT/src/panel/api.js` L555: `json(res, okOrErr(r, "PM2 start failed"));`
- `DEBUG_EXPORT/src/panel/api.js` L560: `json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));`
- `DEBUG_EXPORT/src/panel/api.js` L567: `json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });`
- `DEBUG_EXPORT/src/panel/ui/index.html` L97: `<button id="pm2Start">PM2 Start</button>`
- `DEBUG_EXPORT/src/panel/ui/index.html` L98: `<button id="pm2Stop">PM2 Stop</button>`
- `DEBUG_EXPORT/src/panel/ui/index.html` L99: `<button id="pm2Restart">PM2 Restart</button>`
- `CLAUDE.md` L77: `PM2 restartuje automatycznie`
- `CLAUDE.md` L207: `# PM2 (produkcja)`
- `DEBUG_EXPORT/.env` L14: `PM2_APP=fbwatcher`
- `DEBUG_EXPORT/.env` L16: `PM2_LOG_OUT=C:\Users\zorro\.pm2\logs\fbwatcher-out.log`
- `DEBUG_EXPORT/.env` L17: `PM2_LOG_ERR=C:\Users\zorro\.pm2\logs\fbwatcher-error.log`
- `EXPORT_PROJEKTU.md` L251: `41 | # === PM2 ===`
- `EXPORT_PROJEKTU.md` L252: `42 | PM2_APP=fbwatcher`
- `EXPORT_PROJEKTU.md` L253: `43 | PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log`
- `package-lock.json` L4982: `"integrity": "sha512-vKivATfr97l2/QBCYAkXYDbrIWPM2IIKEl7YPhjCvKlG3kE2gm+uBo6nEXK3M5/Ffh/FLpKExzOQ3JJoJGFKBw==",`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L44: `"PM2",`

### `COOKIES` (hits: 43)

- `.env` L10: `COOKIES_READ_ONLY=false`
- `src/fb/cookies.js` L7: `// üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env`
- `src/fb/cookies.js` L8: `const COOKIES_READ_ONLY =`
- `src/fb/cookies.js` L9: `String(process.env.COOKIES_READ_ONLY || "")`
- `src/fb/cookies.js` L13: `log.debug("COOKIES", `COOKIES_READ_ONLY=${COOKIES_READ_ONLY}`, { raw: process.env.COOKIES_READ_ONLY });`
- `src/fb/cookies.js` L26: `log.dev("COOKIES", `Za≈Çadowano ${cookies.length} cookies z pliku`);`
- `src/fb/cookies.js` L28: `log.dev("COOKIES", "cookies.json istnieje, ale nie zawiera poprawnej tablicy");`
- `src/fb/cookies.js` L31: `log.dev("COOKIES", `Brak cookies.json lub b≈ÇƒÖd odczytu: ${err?.message || err}`);`
- `src/fb/cookies.js` L57: `if (COOKIES_READ_ONLY) {`
- `src/fb/cookies.js` L58: `log.debug("COOKIES", "COOKIES_READ_ONLY=true ‚Äì pomijam zapis");`
- `src/fb/cookies.js` L68: `log.dev("COOKIES", `Zapisano ${cookies.length} cookies do pliku`);`
- `src/fb/cookies.js` L70: `log.warn("COOKIES", `B≈ÇƒÖd zapisu cookies.json: ${e?.message || e}`);`
- `src/fb/cookies.js` L135: `log.debug("COOKIES", `[${label}] Klikniƒôto akceptacjƒô cookies`);`
- `src/fb/cookies.js` L138: `log.debug("COOKIES", `[${label}] Nie znaleziono przycisku cookies`, { texts: result.texts?.slice(0, 5) });`
- `src/fb/cookies.js` L141: `log.debug("COOKIES", `[${label}] B≈ÇƒÖd popupu: ${err?.message || err}`);`
- `src/panel/api.js` L372: `const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");`
- `src/panel/api.js` L391: `cookiesPath: COOKIES_PATH,`
- `src/panel/api.js` L421: `"COOKIES_READ_ONLY",`
- `src/panel/api.js` L642: `// ===== COOKIES: CLEAR =====`
- `src/panel/api.js` L653: `atomicWriteFile(COOKIES_PATH, "[]\n");`
- `src/panel/api.js` L654: `json(res, { ok: true, cookiesPath: COOKIES_PATH });`
- `src/panel/web/src/lib/types.ts` L40: `COOKIES_READ_ONLY: string`
- `src/panel/web/src/pages/Settings.tsx` L67: `{ key: 'COOKIES_READ_ONLY', label: 'Cookies tylko do odczytu', type: 'switch', description: 'Nie zapisuj zmian w cookies' },`
- `src/utils/logger.js` L43: `COOKIES: colors.gray,`
- `DEBUG_EXPORT/src/panel/api.js` L286: `const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");`
- `DEBUG_EXPORT/src/panel/api.js` L298: `cookiesPath: COOKIES_PATH,`
- `DEBUG_EXPORT/src/panel/api.js` L523: `// ===== COOKIES: CLEAR =====`
- `DEBUG_EXPORT/src/panel/api.js` L534: `atomicWriteFile(COOKIES_PATH, "[]\n");`
- `DEBUG_EXPORT/src/panel/api.js` L535: `json(res, { ok: true, cookiesPath: COOKIES_PATH });`
- `DEBUG_EXPORT/.env` L6: `COOKIES_READ_ONLY=false`
- `EXPORT_PROJEKTU.md` L220: `10 | COOKIES_READ_ONLY=false`
- `scripts/generate-cookies.js` L33: `const MAIN_COOKIES_FILE = "cookies.json";`
- `scripts/generate-cookies.js` L34: `const BACKUP_COOKIES_DIR = process.env.BACKUP_COOKIES_DIR || "./data/backup_cookies";`
- `scripts/generate-cookies.js` L35: `const SCP_COOKIES_TARGET = (process.env.SCP_COOKIES_TARGET || "").trim();`
- `scripts/generate-cookies.js` L70: `const backupDir = path.resolve(BACKUP_COOKIES_DIR);`
- `scripts/generate-cookies.js` L186: `log("Brak SCP_COOKIES_TARGET w .env - pomijam upload", "yellow");`
- `scripts/generate-cookies.js` L206: ``Folder: ${BACKUP_COOKIES_DIR}`,`
- `scripts/generate-cookies.js` L234: `const targetPath = path.join(path.resolve(BACKUP_COOKIES_DIR), targetFilename);`
- `scripts/generate-cookies.js` L328: `const mainPath = path.resolve(MAIN_COOKIES_FILE);`
- `scripts/generate-cookies.js` L338: `uploadViaScp(targetPath, SCP_COOKIES_TARGET);`
- `scripts/generate-cookies.js` L351: `args.upload && SCP_COOKIES_TARGET`
- `scripts/generate-cookies.js` L352: `? `Upload: ${SCP_COOKIES_TARGET}``
- `tools/export-project-to-md.js` L53: `"COOKIES",`

### `Najnowsze` (hits: 35)

- `src/config.js` L106: `// FAST_MODE: szybki tryb - sortowanie "Najnowsze", bez loadAllComments`
- `src/config.js` L111: `// Komentarze starsze ni≈º limit ‚Üí skip posta (je≈õli sort=Najnowsze)`
- `src/fb/comments.js` L68: `// Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)`
- `src/fb/comments.js` L198: `log.dev("FILTER", "Prze≈ÇƒÖczam na 'Najnowsze' (legacy)...");`
- `src/fb/comments.js` L210: `// Kliknij "Najnowsze" / "Newest"`
- `src/fb/comments.js` L225: `log.dev("FILTER", "Ustawiono 'Najnowsze'");`
- `src/fb/comments.js` L229: `log.dev("FILTER", "Nie uda≈Ço siƒô wybraƒá 'Najnowsze'");`
- `src/fb/comments.js` L495: `// ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le`
- `src/fb/ui/post.js` L466: `// Szukamy przycisku filtra (Najtrafniejsze/Wszystkie/Najnowsze)`
- `src/fb/ui/post.js` L519: `log.dev("UI:post", "Prze≈ÇƒÖczam na 'Najnowsze'...");`
- `src/fb/ui/post.js` L522: `// 0) Je≈õli menu ju≈º otwarte -> wybierz "Najnowsze"`
- `src/fb/ui/post.js` L525: `log.debug("UI:post", "Menu otwarte ‚Äì wybieram 'Najnowsze'");`
- `src/fb/ui/post.js` L528: `log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");`
- `src/fb/ui/post.js` L534: `// 1) Sprawd≈∫ czy ju≈º ustawione na "Najnowsze"`
- `src/fb/ui/post.js` L554: `log.debug("UI:post", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");`
- `src/fb/ui/post.js` L568: `// 3) Wybierz "Najnowsze" z menu`
- `src/fb/ui/post.js` L572: `log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");`
- `src/fb/ui/post.js` L596: `log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Najnowsze'");`
- `src/fb/ui/post.js` L600: `log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá 'Najnowsze'", menuResult);`
- `src/fb/ui/videos.js` L349: `// If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing`
- `src/fb/ui/videos.js` L429: `// Fallback: "Najnowsze" / "Newest"`
- `src/fb/ui/videos.js` L465: `log.dev("UI:videos", "Prze≈ÇƒÖczam na 'Najnowsze'...");`
- `src/fb/ui/videos.js` L519: `// Sprawd≈∫ czy ju≈º "Najnowsze"`
- `src/fb/ui/videos.js` L525: `// Szukamy przycisku z labelem "Najnowsze" jako aktywny filtr`
- `src/fb/ui/videos.js` L534: `log.debug("UI:videos", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");`
- `src/fb/ui/videos.js` L587: `// Wybierz "Najnowsze" z menu`
- `src/fb/ui/videos.js` L605: `// Szukaj "Najnowsze" / "Newest"`
- `src/fb/ui/videos.js` L631: `log.dev("UI:videos", "Filtr ustawiony: 'Najnowsze'");`
- `src/fb/ui/videos.js` L636: `log.debug("UI:videos", `Nie uda≈Ço siƒô wybraƒá 'Najnowsze': ${selectRes?.reason}`);`
- `src/fb/ui/videos.js` L809: `// po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"`
- `src/panel/web/src/pages/Settings.tsx` L38: `{ key: 'FAST_MODE', label: 'Fast Mode', type: 'switch', description: 'Sortowanie "Najnowsze" dla szybszego wykrywania' },`
- `src/watcher.js` L781: `// 1. Prze≈ÇƒÖcz na "Najnowsze"`
- `src/watcher.js` L792: `log.dev("FAST", `${postLabel}: ${sample.length} komentarzy (sort=Najnowsze)`);`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L49: `"Najnowsze",`

### `switchComments` (hits: 24)

- `src/fb/comments.js` L144: `async function switchCommentsFilterToAllLegacy(page) {`
- `src/fb/comments.js` L181: `export async function switchCommentsFilterToNewest(page, url = null) {`
- `src/fb/comments.js` L186: `if (ui?.type === "post" && typeof uiPost.switchCommentsFilterToNewestScoped === "function") {`
- `src/fb/comments.js` L187: `log.dev("FILTER", "UI ‚Üí post switchCommentsFilterToNewestScoped");`
- `src/fb/comments.js` L188: `return uiPost.switchCommentsFilterToNewestScoped(page);`
- `src/fb/comments.js` L192: `if (ui?.type === "videos" && typeof uiVideos.switchCommentsFilterToNewestScoped === "function") {`
- `src/fb/comments.js` L193: `log.dev("FILTER", "UI ‚Üí videos switchCommentsFilterToNewestScoped");`
- `src/fb/comments.js` L194: `return uiVideos.switchCommentsFilterToNewestScoped(page);`
- `src/fb/comments.js` L496: `await switchCommentsFilterToAllLegacy(page).catch(() => false);`
- `src/fb/legacy/comments.legacy.js` L23: `async function switchCommentsFilterToAll(page) {`
- `src/fb/legacy/comments.legacy.js` L116: `console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);`
- `src/fb/legacy/comments.legacy.js` L1783: `const okFilter = await switchCommentsFilterToAll(page);`
- `src/fb/legacy/comments.legacy.js` L1791: `"[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",`
- `src/fb/legacy/comments.legacy.js` L1818: `const ok2 = await switchCommentsFilterToAll(page);`
- `src/fb/legacy/comments.legacy.js` L1826: `"[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",`
- `src/fb/ui/photo.js` L128: `async function switchCommentsFilterToAll(page) {`
- `src/fb/ui/photo.js` L504: `const okFilter = await switchCommentsFilterToAll(page).catch(() => false);`
- `src/fb/ui/post.js` L193: `async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {`
- `src/fb/ui/post.js` L518: `export async function switchCommentsFilterToNewestScoped(page, scopeSel = "document") {`
- `src/fb/ui/post.js` L1032: `const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);`
- `src/fb/ui/videos.js` L464: `export async function switchCommentsFilterToNewestScoped(page) {`
- `src/watcher.js` L46: `switchCommentsFilterToNewest,`
- `src/watcher.js` L782: `const switchResult = await switchCommentsFilterToNewest(page, post.url).catch(() => ({ ok: false }));`
- `tools/export-project-to-md.js` L51: `"switchComments",`

### `FAST_MODE` (hits: 23)

- `.env` L70: `FAST_MODE=true`
- `src/config.js` L106: `// FAST_MODE: szybki tryb - sortowanie "Najnowsze", bez loadAllComments`
- `src/config.js` L107: `// FAST_MODE=true w≈ÇƒÖcza, domy≈õlnie false (stabilny tryb dedup)`
- `src/config.js` L108: `const FAST_MODE = process.env.FAST_MODE === "true";`
- `src/config.js` L110: `// FAST_MAX_AGE_MIN: limit wieku komentarzy w FAST_MODE (minuty)`
- `src/config.js` L183: `// FAST_MODE`
- `src/config.js` L184: `FAST_MODE,`
- `src/fb/comments.js` L178: `=======  FAST_MODE: SORTOWANIE "NAJNOWSZE"  =================`
- `src/fb/ui/post.js` L419: `=========== PRZE≈ÅƒÑCZANIE FILTRA: NAJNOWSZE (FAST_MODE) =======`
- `src/fb/ui/videos.js` L461: `======= FAST_MODE: SORTOWANIE "NAJNOWSZE" ==`
- `src/panel/api.js` L414: `"FAST_MODE",`
- `src/panel/web/src/lib/types.ts` L33: `FAST_MODE: string`
- `src/panel/web/src/pages/Settings.tsx` L38: `{ key: 'FAST_MODE', label: 'Fast Mode', type: 'switch', description: 'Sortowanie "Najnowsze" dla szybszego wykrywania' },`
- `src/watcher.js` L16: `FAST_MODE,`
- `src/watcher.js` L109: `// ================== FAST_MODE HELPER ==================`
- `src/watcher.js` L545: `fastMode: FAST_MODE,`
- `src/watcher.js` L776: `// ==================== FAST_MODE BRANCH ====================`
- `src/watcher.js` L777: `if (FAST_MODE) {`
- `src/watcher.js` L848: `// ==================== KONIEC FAST_MODE ====================`
- `CLAUDE.md` L89: `### FAST_MODE`
- `CLAUDE.md` L91: `FAST_MODE=true           # w≈ÇƒÖcza tryb szybki`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L40: `"FAST_MODE",`

### `USE_UI_HANDLERS` (hits: 21)

- `.env` L14: `USE_UI_HANDLERS=true`
- `DEBUG_EXPORT/src/config.js` L79: `// USE_UI_HANDLERS=false ‚Üí jedzie legacy`
- `DEBUG_EXPORT/src/config.js` L80: `const USE_UI_HANDLERS =`
- `DEBUG_EXPORT/src/config.js` L81: `process.env.USE_UI_HANDLERS === "false" ? false : true;`
- `DEBUG_EXPORT/src/config.js` L99: `USE_UI_HANDLERS,`
- `src/config.js` L93: `// USE_UI_HANDLERS=false ‚Üí jedzie legacy`
- `src/config.js` L94: `const USE_UI_HANDLERS =`
- `src/config.js` L95: `process.env.USE_UI_HANDLERS === "false" ? false : true;`
- `src/config.js` L179: `USE_UI_HANDLERS,`
- `src/panel/api.js` L420: `"USE_UI_HANDLERS",`
- `src/panel/ui/app.js` L62: `"USE_UI_HANDLERS",`
- `src/panel/ui/index.html` L334: `<select id="USE_UI_HANDLERS">`
- `src/panel/web/src/lib/types.ts` L39: `USE_UI_HANDLERS: string`
- `src/panel/web/src/pages/Settings.tsx` L66: `{ key: 'USE_UI_HANDLERS', label: 'UI Handlers', type: 'switch', description: 'U≈ºywaj handler√≥w UI do interakcji' },`
- `DEBUG_EXPORT/src/panel/api.js` L322: `"USE_UI_HANDLERS",`
- `DEBUG_EXPORT/src/panel/ui/app.js` L66: `"USE_UI_HANDLERS",`
- `DEBUG_EXPORT/src/panel/ui/index.html` L80: `<label>USE_UI_HANDLERS</label>`
- `DEBUG_EXPORT/src/panel/ui/index.html` L81: `<select id="USE_UI_HANDLERS">`
- `DEBUG_EXPORT/.env` L8: `USE_UI_HANDLERS=false`
- `EXPORT_PROJEKTU.md` L224: `14 | USE_UI_HANDLERS=true`
- `tools/export-project-to-md.js` L55: `"USE_UI_HANDLERS",`

### `newest` (hits: 21)

- `src/fb/comments.js` L78: `t === "newest" ||`
- `src/fb/comments.js` L213: `"newest",`
- `src/fb/ui/post.js` L470: `"najnowsze", "newest",`
- `src/fb/ui/post.js` L526: `const r = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);`
- `src/fb/ui/post.js` L549: `return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";`
- `src/fb/ui/post.js` L555: `return { ok: true, state: "already-newest" };`
- `src/fb/ui/post.js` L569: `const menuResult = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);`
- `src/fb/ui/post.js` L591: `return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";`
- `src/fb/ui/videos.js` L365: `t === "newest" ||`
- `src/fb/ui/videos.js` L431: `target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));`
- `src/fb/ui/videos.js` L529: `return t === "najnowsze" || t === "newest";`
- `src/fb/ui/videos.js` L535: `return { ok: true, state: "already-newest" };`
- `src/fb/ui/videos.js` L608: `return t.startsWith("najnowsze") || t.startsWith("newest") || t.startsWith("od najnowszych") || t.startsWith("most recent");`
- `src/fb/ui/videos.js` L612: `return { ok: false, reason: "no-newest-option" };`
- `src/fb/ui/videos.js` L627: `return { ok: true, action: "clicked-newest" };`
- `src/watcher.js` L804: `const newestTime = sample[0]?.time || sample[0]?.fb_time_raw;`
- `src/watcher.js` L805: `const newestAge = getCommentAgeMinutes(newestTime);`
- `src/watcher.js` L807: `if (newestAge !== null && newestAge > FAST_MAX_AGE_MIN) {`
- `src/watcher.js` L808: `log.dev("FAST", `${postLabel}: SKIP - najnowszy ${Math.round(newestAge)} min`, { limit: FAST_MAX_AGE_MIN });`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L50: `"newest",`

### `HEADLESS_BROWSER` (hits: 16)

- `.env` L13: `HEADLESS_BROWSER=true`
- `src/index.js` L37: `console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);`
- `src/panel/api.js` L419: `"HEADLESS_BROWSER",`
- `src/panel/ui/app.js` L61: `"HEADLESS_BROWSER",`
- `src/panel/ui/index.html` L327: `<select id="HEADLESS_BROWSER">`
- `src/panel/web/src/lib/types.ts` L38: `HEADLESS_BROWSER: string`
- `src/panel/web/src/pages/Settings.tsx` L65: `{ key: 'HEADLESS_BROWSER', label: 'Tryb headless', type: 'switch', description: 'Uruchamiaj bez widocznego okna' },`
- `src/watcher.js` L561: `const wantHeadless = envBool("HEADLESS_BROWSER", true);`
- `DEBUG_EXPORT/src/panel/api.js` L321: `"HEADLESS_BROWSER",`
- `DEBUG_EXPORT/src/panel/ui/app.js` L65: `"HEADLESS_BROWSER",`
- `DEBUG_EXPORT/src/panel/ui/index.html` L73: `<label>HEADLESS_BROWSER</label>`
- `DEBUG_EXPORT/src/panel/ui/index.html` L74: `<select id="HEADLESS_BROWSER">`
- `DEBUG_EXPORT/.env` L7: `HEADLESS_BROWSER=true`
- `DEBUG_EXPORT/src/index.js` L4: `console.log("[CFG] HEADLESS_BROWSER (process.env) =", process.env.HEADLESS_BROWSER);`
- `EXPORT_PROJEKTU.md` L223: `13 | HEADLESS_BROWSER=true`
- `tools/export-project-to-md.js` L54: `"HEADLESS_BROWSER",`

### `PANEL_TOKEN` (hits: 16)

- `.env` L37: `PANEL_TOKEN=TEST_TOKEN_123`
- `src/config.js` L19: `* Musi byƒá taki sam jak PANEL_TOKEN na serwerze`
- `src/panel/api.js` L27: `const TOKEN = process.env.PANEL_TOKEN;`
- `src/panel/api.js` L39: `console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");`
- `src/panel/ui/app.js` L5: `let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";`
- `src/panel/ui/app.js` L575: `localStorage.setItem("FBW_PANEL_TOKEN", token);`
- `src/panel/ui/index.html` L285: `<input id="token" placeholder="PANEL_TOKEN z .env" />`
- `src/panel/web/src/lib/api.ts` L10: `const TOKEN_KEY = 'FBW_PANEL_TOKEN'`
- `src/panel/web/src/pages/Dashboard.tsx` L26: `Wprowadz token PANEL_TOKEN aby uzyskac dostep do API`
- `src/panel/web/src/pages/Dashboard.tsx` L38: `placeholder="Wprowadz PANEL_TOKEN..."`
- `DEBUG_EXPORT/src/panel/api.js` L21: `const TOKEN = process.env.PANEL_TOKEN;`
- `DEBUG_EXPORT/src/panel/api.js` L27: `console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");`
- `DEBUG_EXPORT/src/panel/ui/index.html` L33: `<input id="token" placeholder="PANEL_TOKEN z .env" />`
- `DEBUG_EXPORT/.env` L12: `PANEL_TOKEN=TEST_TOKEN_123`
- `EXPORT_PROJEKTU.md` L247: `37 | PANEL_TOKEN=TEST_TOKEN_123`
- `tools/export-project-to-md.js` L43: `"PANEL_TOKEN",`

### `WEBHOOK_URL` (hits: 15)

- `.env` L5: `WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz`
- `src/panel/api.js` L442: `"WEBHOOK_URL",`
- `src/panel/ui/app.js` L58: `"WEBHOOK_URL",`
- `src/panel/ui/index.html` L311: `<input id="WEBHOOK_URL" />`
- `src/panel/web/src/lib/types.ts` L61: `WEBHOOK_URL: string`
- `DEBUG_EXPORT/src/panel/api.js` L318: `"WEBHOOK_URL",`
- `DEBUG_EXPORT/src/panel/ui/app.js` L62: `"WEBHOOK_URL",`
- `DEBUG_EXPORT/src/panel/ui/index.html` L57: `<label>WEBHOOK_URL</label>`
- `DEBUG_EXPORT/src/panel/ui/index.html` L58: `<input id="WEBHOOK_URL" />`
- `DEBUG_EXPORT/.env` L3: `WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz`
- `DEBUG_EXPORT/src/webhook.js` L67: `const url = process.env.WEBHOOK_URL;`
- `DEBUG_EXPORT/src/webhook.js` L69: `console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");`
- `EXPORT_PROJEKTU.md` L215: `5 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L42: `"WEBHOOK_URL",`

### `FAST_MAX_AGE_MIN` (hits: 8)

- `src/config.js` L110: `// FAST_MAX_AGE_MIN: limit wieku komentarzy w FAST_MODE (minuty)`
- `src/config.js` L112: `const FAST_MAX_AGE_MIN = Number(process.env.FAST_MAX_AGE_MIN || 180);`
- `src/config.js` L185: `FAST_MAX_AGE_MIN,`
- `src/watcher.js` L17: `FAST_MAX_AGE_MIN,`
- `src/watcher.js` L807: `if (newestAge !== null && newestAge > FAST_MAX_AGE_MIN) {`
- `src/watcher.js` L808: `log.dev("FAST", `${postLabel}: SKIP - najnowszy ${Math.round(newestAge)} min`, { limit: FAST_MAX_AGE_MIN });`
- `CLAUDE.md` L92: `FAST_MAX_AGE_MIN=180     # limit wieku komentarzy (minuty)`
- `tools/export-project-to-md.js` L41: `"FAST_MAX_AGE_MIN",`

### `DEDUP` (hits: 8)

- `src/fb/comments.js` L743: `log.debug("DEDUP", `Context: want=${postRef || "null"}`);`
- `src/fb/comments.js` L751: `log.debug("DEDUP", `Sample: cref=${cref || "null"}`);`
- `src/fb/comments.js` L764: `log.debug("DEDUP", `Dropped ${dropped} (ref mismatch)`);`
- `src/fb/comments.js` L769: `log.warn("DEDUP", `All ${arr.length} dropped (ref mismatch)`);`
- `src/utils/logger.js` L39: `DEDUP: colors.gray,`
- `src/watcher.js` L905: `log.debug("DEDUP", `${postLabel}: context`, {`
- `tools/export-project-to-md.js` L21: `*   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze`
- `tools/export-project-to-md.js` L48: `"DEDUP",`

### `dedup` (hits: 7)

- `src/config.js` L107: `// FAST_MODE=true w≈ÇƒÖcza, domy≈õlnie false (stabilny tryb dedup)`
- `src/fb/comments.js` L725: `// fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)`
- `src/fb/comments.js` L768: `out._dedupAllDropped = true;`
- `src/panel/api.js` L551: `json(res, { ok: true, post: existing, deduped: true });`
- `DEBUG_EXPORT/src/panel/api.js` L432: `json(res, { ok: true, post: existing, deduped: true });`
- `CLAUDE.md` L18: `| `src/db/cache.js` | ~116 | `getCache()`, `updateCache()` | deduplikacja |`
- `tools/export-project-to-md.js` L47: `"dedup",`

---

## üß© Import graph (lite)

### `DEBUG_EXPORT/src/index.js`

- L2: `./watcher.js`

### `DEBUG_EXPORT/src/panel/panel-entry.cjs`

- L2: `./api.js`

### `DEBUG_EXPORT/src/watcher.js`

- L19: `./fb/cookies.js`
- L20: `./fb/login.js`
- L21: `./webhook.js`
- L22: `./db/cache.js`

### `DEBUG_EXPORT/src/webhook.js`

- L3: `./config.js`

### `EXPORT_PROJEKTU.md`

- L12037: `./api.js`
- L19264: `./api.js`
- L19701: `./api.js`

### `src/db/cache.js`

- L4: `../utils/logger.js`

### `src/fb/checkpoint.js`

- L2: `../utils/logger.js`

### `src/fb/comments.js`

- L2: `../config.js`
- L3: `../utils/sleep.js`
- L4: `./scroll.js`
- L5: `./cookies.js`
- L6: `./login.js`
- L7: `./expandButtons.js`
- L8: `../utils/navigation.js`
- L9: `./uiCommentInfo.js`
- L10: `../utils/logger.js`
- L12: `./ui/photo.js`
- L13: `./ui/post.js`
- L14: `./ui/videos.js`
- L15: `./ui/watch.js`

### `src/fb/cookies.js`

- L4: `../utils/sleep.js`
- L5: `../utils/logger.js`

### `src/fb/expandButtons.js`

- L9: `../config.js`
- L10: `../utils/sleep.js`
- L11: `../utils/logger.js`

### `src/fb/legacy/comments.legacy.js`

- L3: `../../config.js`
- L4: `../../utils/sleep.js`
- L5: `../../utils/navigation.js`
- L7: `../scroll.js`
- L8: `../cookies.js`
- L9: `../login.js`
- L10: `../expandButtons.js`
- L11: `../uiCommentInfo.js`

### `src/fb/login.js`

- L2: `../utils/sleep.js`
- L3: `../utils/logger.js`
- L4: `../config.js`

### `src/fb/scroll.js`

- L1: `../utils/sleep.js`

### `src/fb/ui/index.js`

- L2: `./post.js`
- L3: `./photo.js`
- L4: `./watch.js`
- L5: `./videos.js`

### `src/fb/ui/photo.js`

- L2: `../../utils/navigation.js`
- L3: `../../utils/sleep.js`
- L4: `../scroll.js`
- L5: `../cookies.js`
- L6: `../login.js`
- L7: `../uiCommentInfo.js`
- L8: `../../utils/logger.js`

### `src/fb/ui/post.js`

- L2: `../../config.js`
- L3: `../../utils/sleep.js`
- L4: `../../utils/navigation.js`
- L5: `../../utils/logger.js`
- L7: `../scroll.js`
- L8: `../cookies.js`
- L9: `../login.js`
- L10: `../expandButtons.js`

### `src/fb/ui/videos.js`

- L1: `../../utils/navigation.js`
- L2: `../../utils/sleep.js`
- L3: `../../utils/logger.js`
- L4: `../cookies.js`
- L5: `../login.js`
- L6: `../uiCommentInfo.js`

### `src/fb/ui/watch.js`

- L2: `../../utils/navigation.js`
- L3: `../../utils/sleep.js`
- L4: `../cookies.js`
- L5: `../login.js`
- L6: `../uiCommentInfo.js`
- L7: `../../utils/logger.js`

### `src/index.js`

- L17: `./watcher.js`
- L18: `./telegram.js`

### `src/panel/panel-entry.cjs`

- L2: `./api.js`

### `src/panel/web/src/components/layout/DashboardLayout.tsx`

- L3: `./Sidebar`
- L4: `./Header`
- L5: `./MobileNav`

### `src/panel/web/src/components/layout/MobileNav.tsx`

- L3: `./Sidebar`

### `src/panel/web/src/main.tsx`

- L3: `./index.css`
- L4: `./App`

### `src/telegram.js`

- L3: `./utils/logger.js`

### `src/utils/mouse.js`

- L4: `./sleep.js`

### `src/utils/navigation.js`

- L2: `./sleep.js`
- L3: `./logger.js`

### `src/utils/time.js`

- L2: `./logger.js`

### `src/watcher.js`

- L49: `./fb/cookies.js`
- L50: `./fb/login.js`
- L51: `./fb/checkpoint.js`
- L52: `./utils/time.js`
- L53: `./utils/sleep.js`
- L54: `./db/cache.js`
- L55: `./telegram.js`
- L56: `./utils/logger.js`

### `test-telegram.mjs`

- L2: `./src/telegram.js`

### `tools/export-project-to-md.js`

- L497: `./x`

---

## üß≠ Spis tre≈õci plik√≥w
- [package.json](#≈õcie≈ºka-packagejson)
- [.env](#≈õcie≈ºka-env)
- [config/links.js](#≈õcie≈ºka-config-linksjs)
- [config/links.json](#≈õcie≈ºka-config-linksjson)
- [DEBUG_EXPORT/src/config.js](#≈õcie≈ºka-debug-export-src-configjs)
- [src/config.js](#≈õcie≈ºka-src-configjs)
- [src/panel/web/postcss.config.js](#≈õcie≈ºka-src-panel-web-postcssconfigjs)
- [src/panel/web/tailwind.config.js](#≈õcie≈ºka-src-panel-web-tailwindconfigjs)
- [src/panel/web/tsconfig.json](#≈õcie≈ºka-src-panel-web-tsconfigjson)
- [src/panel/web/vite.config.ts](#≈õcie≈ºka-src-panel-web-viteconfigts)
- [src/db/cache.js](#≈õcie≈ºka-src-db-cachejs)
- [src/fb/checkpoint.js](#≈õcie≈ºka-src-fb-checkpointjs)
- [src/fb/comments.js](#≈õcie≈ºka-src-fb-commentsjs)
- [src/fb/cookies.js](#≈õcie≈ºka-src-fb-cookiesjs)
- [src/fb/expandButtons.js](#≈õcie≈ºka-src-fb-expandbuttonsjs)
- [src/fb/legacy/comments.legacy.js](#≈õcie≈ºka-src-fb-legacy-commentslegacyjs)
- [src/fb/login.js](#≈õcie≈ºka-src-fb-loginjs)
- [src/fb/scroll.js](#≈õcie≈ºka-src-fb-scrolljs)
- [src/fb/ui/index.js](#≈õcie≈ºka-src-fb-ui-indexjs)
- [src/fb/ui/photo.js](#≈õcie≈ºka-src-fb-ui-photojs)
- [src/fb/ui/post.js](#≈õcie≈ºka-src-fb-ui-postjs)
- [src/fb/ui/videos.js](#≈õcie≈ºka-src-fb-ui-videosjs)
- [src/fb/ui/watch.js](#≈õcie≈ºka-src-fb-ui-watchjs)
- [src/fb/uiCommentInfo.js](#≈õcie≈ºka-src-fb-uicommentinfojs)
- [src/index.js](#≈õcie≈ºka-src-indexjs)
- [src/panel/api.js](#≈õcie≈ºka-src-panel-apijs)
- [src/panel/panel-entry.cjs](#≈õcie≈ºka-src-panel-panel-entrycjs)
- [src/panel/ui/app.js](#≈õcie≈ºka-src-panel-ui-appjs)
- [src/panel/ui/index.html](#≈õcie≈ºka-src-panel-ui-indexhtml)
- [src/panel/web/index.html](#≈õcie≈ºka-src-panel-web-indexhtml)
- [src/panel/web/package-lock.json](#≈õcie≈ºka-src-panel-web-package-lockjson)
- [src/panel/web/package.json](#≈õcie≈ºka-src-panel-web-packagejson)
- [src/panel/web/src/App.tsx](#≈õcie≈ºka-src-panel-web-src-apptsx)
- [src/panel/web/src/components/layout/DashboardLayout.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-dashboardlayouttsx)
- [src/panel/web/src/components/layout/Header.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-headertsx)
- [src/panel/web/src/components/layout/MobileNav.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-mobilenavtsx)
- [src/panel/web/src/components/layout/Sidebar.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-sidebartsx)
- [src/panel/web/src/components/ui/badge.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-badgetsx)
- [src/panel/web/src/components/ui/button.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-buttontsx)
- [src/panel/web/src/components/ui/card.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-cardtsx)
- [src/panel/web/src/components/ui/checkbox.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-checkboxtsx)
- [src/panel/web/src/components/ui/dialog.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-dialogtsx)
- [src/panel/web/src/components/ui/input.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-inputtsx)
- [src/panel/web/src/components/ui/label.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-labeltsx)
- [src/panel/web/src/components/ui/separator.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-separatortsx)
- [src/panel/web/src/components/ui/switch.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-switchtsx)
- [src/panel/web/src/components/ui/table.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabletsx)
- [src/panel/web/src/components/ui/tabs.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabstsx)
- [src/panel/web/src/components/ui/textarea.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-textareatsx)
- [src/panel/web/src/hooks/useApi.ts](#≈õcie≈ºka-src-panel-web-src-hooks-useapits)
- [src/panel/web/src/hooks/useAuth.tsx](#≈õcie≈ºka-src-panel-web-src-hooks-useauthtsx)
- [src/panel/web/src/hooks/useLogs.ts](#≈õcie≈ºka-src-panel-web-src-hooks-uselogsts)
- [src/panel/web/src/index.css](#≈õcie≈ºka-src-panel-web-src-indexcss)
- [src/panel/web/src/lib/api.ts](#≈õcie≈ºka-src-panel-web-src-lib-apits)
- [src/panel/web/src/lib/types.ts](#≈õcie≈ºka-src-panel-web-src-lib-typests)
- [src/panel/web/src/lib/utils.ts](#≈õcie≈ºka-src-panel-web-src-lib-utilsts)
- [src/panel/web/src/main.tsx](#≈õcie≈ºka-src-panel-web-src-maintsx)
- [src/panel/web/src/pages/Campaigns.tsx](#≈õcie≈ºka-src-panel-web-src-pages-campaignstsx)
- [src/panel/web/src/pages/Cookies.tsx](#≈õcie≈ºka-src-panel-web-src-pages-cookiestsx)
- [src/panel/web/src/pages/Dashboard.tsx](#≈õcie≈ºka-src-panel-web-src-pages-dashboardtsx)
- [src/panel/web/src/pages/Discoveries.tsx](#≈õcie≈ºka-src-panel-web-src-pages-discoveriestsx)
- [src/panel/web/src/pages/Logs.tsx](#≈õcie≈ºka-src-panel-web-src-pages-logstsx)
- [src/panel/web/src/pages/Settings.tsx](#≈õcie≈ºka-src-panel-web-src-pages-settingstsx)
- [src/panel/web/src/pages/Sources.tsx](#≈õcie≈ºka-src-panel-web-src-pages-sourcestsx)
- [src/panel/web/src/pages/Watched.tsx](#≈õcie≈ºka-src-panel-web-src-pages-watchedtsx)
- [src/panel/web/src/vite-env.d.ts](#≈õcie≈ºka-src-panel-web-src-vite-envdts)
- [src/telegram.js](#≈õcie≈ºka-src-telegramjs)
- [src/utils/logger.js](#≈õcie≈ºka-src-utils-loggerjs)
- [src/utils/mouse.js](#≈õcie≈ºka-src-utils-mousejs)
- [src/utils/navigation.js](#≈õcie≈ºka-src-utils-navigationjs)
- [src/utils/sleep.js](#≈õcie≈ºka-src-utils-sleepjs)
- [src/utils/time.js](#≈õcie≈ºka-src-utils-timejs)
- [src/watcher.js](#≈õcie≈ºka-src-watcherjs)
- [DEBUG_EXPORT/src/panel/api.js](#≈õcie≈ºka-debug-export-src-panel-apijs)
- [DEBUG_EXPORT/src/panel/panel-entry.cjs](#≈õcie≈ºka-debug-export-src-panel-panel-entrycjs)
- [DEBUG_EXPORT/src/panel/ui/app.js](#≈õcie≈ºka-debug-export-src-panel-ui-appjs)
- [DEBUG_EXPORT/src/panel/ui/index.html](#≈õcie≈ºka-debug-export-src-panel-ui-indexhtml)
- [CLAUDE.md](#≈õcie≈ºka-claudemd)
- [cookies.json](#≈õcie≈ºka-cookiesjson)
- [data/backup_cookies/cookies_1.json](#≈õcie≈ºka-data-backup-cookies-cookies-1json)
- [data/backup_cookies/cookies_2.json](#≈õcie≈ºka-data-backup-cookies-cookies-2json)
- [data/backup_cookies/cookies_3.json](#≈õcie≈ºka-data-backup-cookies-cookies-3json)
- [data/backup_cookies/cookies_4.json](#≈õcie≈ºka-data-backup-cookies-cookies-4json)
- [data/comments-cache.json](#≈õcie≈ºka-data-comments-cachejson)
- [data/posts.json](#≈õcie≈ºka-data-postsjson)
- [DEBUG_EXPORT/.env](#≈õcie≈ºka-debug-export-env)
- [DEBUG_EXPORT/package.json](#≈õcie≈ºka-debug-export-packagejson)
- [DEBUG_EXPORT/src/index.js](#≈õcie≈ºka-debug-export-src-indexjs)
- [DEBUG_EXPORT/src/watcher.js](#≈õcie≈ºka-debug-export-src-watcherjs)
- [DEBUG_EXPORT/src/webhook.js](#≈õcie≈ºka-debug-export-src-webhookjs)
- [debug-login.mjs](#≈õcie≈ºka-debug-loginmjs)
- [EXPORT_PROJEKTU_PLUS.md](#≈õcie≈ºka-export-projektu-plusmd)
- [EXPORT_PROJEKTU.md](#≈õcie≈ºka-export-projektumd)
- [package-lock.json](#≈õcie≈ºka-package-lockjson)
- [Rozwoj.md](#≈õcie≈ºka-rozwojmd)
- [scripts/generate-cookies.js](#≈õcie≈ºka-scripts-generate-cookiesjs)
- [test-telegram.mjs](#≈õcie≈ºka-test-telegrammjs)
- [tools/export-project-to-md.js](#≈õcie≈ºka-tools-export-project-to-mdjs)

---

### üìÑ ≈öcie≈ºka: `package.json`
**Typ:** JSON  
**Opis:** Metadane projektu i zale≈ºno≈õci (npm).  

```json
 1 | {
 2 |   "name": "fb_puppeteer",
 3 |   "version": "1.0.0",
 4 |   "description": "Watcher komentarzy FB + webhook do Make",
 5 |   "main": "src/index.js",
 6 |   "type": "module",
 7 |   "scripts": {
 8 |     "start": "node src/index.js",
 9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs",
11 |     "panel:web:install": "cd src/panel/web && npm install",
12 |     "panel:web:dev": "cd src/panel/web && npm run dev",
13 |     "panel:web:build": "cd src/panel/web && npm run build"
14 |   },
15 |   "keywords": [],
16 |   "author": "",
17 |   "license": "ISC",
18 |   "dependencies": {
19 |     "axios": "^1.13.2",
20 |     "dotenv": "^17.2.3",
21 |     "puppeteer": "^24.31.0",
22 |     "puppeteer-extra": "^3.3.6",
23 |     "puppeteer-extra-plugin-recaptcha": "^3.6.8",
24 |     "puppeteer-extra-plugin-stealth": "^2.11.2"
25 |   },
26 |   "devDependencies": {
27 |     "@yao-pkg/pkg": "^6.11.0",
28 |     "esbuild": "^0.27.2",
29 |     "nexe": "^5.0.0-beta.4",
30 |     "pkg": "^5.8.1"
31 |   },
32 |   "pkg": {
33 |     "assets": [
34 |       "src/panel/api.js",
35 |       "src/panel/**/*.js",
36 |       ".env",
37 |       "data/**/*"
38 |     ]
39 |   }
40 | }
41 | 
```

---

### üìÑ ≈öcie≈ºka: `.env`
**Typ:** ENV  
**Opis:** Konfiguracja / sta≈Çe / ustawienia.  

```dotenv
 1 | # === FB WATCHER ===
 2 | FB_EMAIL=fbwatcher1@gmail.com
 3 | FB_PASSWORD=FbWatcher123!
 4 | 
 5 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
 6 | CHECK_INTERVAL_MS=60000
 7 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
 8 | 
 9 | # cookies
10 | COOKIES_READ_ONLY=false
11 | 
12 | # puppeteer
13 | HEADLESS_BROWSER=true
14 | USE_UI_HANDLERS=true
15 | INCLUDE_REPLIES=false
16 | 
17 | # runtime
18 | NODE_ENV=production
19 | TZ=Europe/Warsaw
20 | 
21 | # logi: silent | production | dev | debug
22 | LOG_LEVEL=production
23 | 
24 | # ≈õcie≈ºki serwerowe (produkcja Linux)
25 | # PROJECT_DIR=/opt/fb-watcher
26 | # POSTS_FILE=/opt/fb-watcher/data/posts.json
27 | 
28 | # lokalne testy (Windows)
29 | PROJECT_DIR=C:/Projekty vs/FB_Watcher
30 | 
31 | # === POSTS Z REMOTE API (lokalny watcher ‚Üê panel na serwerze) ===
32 | # Ustaw adres IP/domenƒô serwera gdzie dzia≈Ça panel
33 | POSTS_API_URL=http://162.55.188.103:3180/api/posts
34 | POSTS_API_TOKEN=fbw_3c9e8a2d7f4b1a6c9d5e0f8a2b7c4e9d1f6a0b5c8e2d9a4f7
35 | 
36 | # === PANEL ===
37 | PANEL_TOKEN=TEST_TOKEN_123
38 | PANEL_PORT=3180
39 | PANEL_BIND=0.0.0.0
40 | 
41 | # === PM2 ===
42 | PM2_APP=fbwatcher
43 | PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log
44 | PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log
45 | 
46 | # === TELEGRAM (2 boty) ===
47 | 
48 | # Tw√≥j bot + Tw√≥j prywatny chat
49 | TELEGRAM_BOT_TOKEN_OWNER=8561327207:AAHgjWbwCNtPGJSa5pwVcP2mMJm9T_bh6HM
50 | TELEGRAM_CHAT_ID_OWNER=6774389439
51 | 
52 | # Bot klienta + prywatny chat klienta
53 | TELEGRAM_BOT_TOKEN_CLIENT=8504080014:AAHoxXLDe90hIP4efHouoKX4pb7kXSwDgS8
54 | TELEGRAM_CHAT_ID_CLIENT=7081837522
55 | 
56 | # prze≈ÇƒÖczniki
57 | TELEGRAM_SEND_TO_OWNER=1
58 | TELEGRAM_SEND_TO_CLIENT=0
59 | 
60 | # formatowanie
61 | TELEGRAM_USE_PHOTO=1
62 | TELEGRAM_DISABLE_WEB_PAGE_PREVIEW=1
63 | 
64 | # alerty z log√≥w
65 | TG_ALERTS_ENABLED=1
66 | TG_ALERTS_COOLDOWN_SEC=120
67 | TG_ALERTS_MAXLEN=3500
68 | 
69 | 
70 | FAST_MODE=true
71 | 
72 | # === 2CAPTCHA ===
73 | CAPTCHA_API_KEY=bc82e530a13e72887acbbdfd9cc0fdee
```

---

### üìÑ ≈öcie≈ºka: `config/links.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja / sta≈Çe / ustawienia.  

```js
  1 | // src/config/links.js
  2 | import fs from "fs";
  3 | import path from "path";
  4 | 
  5 | // Je≈õli masz Node <18, odkomentuj te dwie linijki:
  6 | // import fetch from "node-fetch";
  7 | // global.fetch = fetch;
  8 | 
  9 | const LINKS_SHEET_URL = process.env.LINKS_SHEET_URL;
 10 | const LOCAL_FILE = path.join(process.cwd(), "config", "links.json");
 11 | 
 12 | let linksCache = [];
 13 | let lastHash = null;
 14 | 
 15 | /* ============================================
 16 |    Prost y "hash" listy link√≥w
 17 |    ============================================ */
 18 | function calcHash(urls) {
 19 |   return urls.join("|");
 20 | }
 21 | 
 22 | /* ============================================
 23 |    Wczytanie lokalnego pliku JSON
 24 |    ============================================ */
 25 | function loadLinksFromLocalFile() {
 26 |   try {
 27 |     const raw = fs.readFileSync(LOCAL_FILE, "utf8");
 28 |     const data = JSON.parse(raw);
 29 | 
 30 |     if (Array.isArray(data.links)) {
 31 |       const cleaned = data.links
 32 |         .filter((u) => typeof u === "string")
 33 |         .map((u) => u.trim())
 34 |         .filter((u) => u.startsWith("http"));
 35 | 
 36 |       console.log("[CFG] Za≈Çadowane linki z lokalnego pliku:", cleaned);
 37 |       return cleaned;
 38 |     }
 39 | 
 40 |     console.warn("[CFG] Lokalny links.json nie zawiera poprawnego pola 'links'");
 41 |     return [];
 42 |   } catch (err) {
 43 |     console.warn("[CFG] Brak / b≈ÇƒÖd wczytywania links.json:", err.message);
 44 |     return [];
 45 |   }
 46 | }
 47 | 
 48 | /* ============================================
 49 |    Parser CSV z Sheetsa
 50 |    ============================================ */
 51 | function parseCsv(text) {
 52 |   const hasSemicolon = text.includes(";");
 53 |   const delimiter = hasSemicolon ? ";" : ",";
 54 | 
 55 |   const lines = text
 56 |     .split(/\r?\n/)
 57 |     .map((l) => l.trim())
 58 |     .filter(Boolean);
 59 | 
 60 |   if (!lines.length) {
 61 |     return [];
 62 |   }
 63 | 
 64 |   const header = lines[0].split(delimiter).map((h) => h.trim().toLowerCase());
 65 | 
 66 |   const idxActive = header.indexOf("active");
 67 |   const idxUrl = header.indexOf("url");
 68 | 
 69 |   if (idxUrl === -1) {
 70 |     console.warn("[CFG] W CSV nie znaleziono kolumny 'url'");
 71 |     return [];
 72 |   }
 73 | 
 74 |   const rows = [];
 75 | 
 76 |   for (let i = 1; i < lines.length; i++) {
 77 |     const cols = lines[i].split(delimiter).map((c) => c.trim());
 78 | 
 79 |     const url = cols[idxUrl] || "";
 80 |     if (!url || !url.startsWith("http")) continue;
 81 | 
 82 |     let active = true;
 83 | 
 84 |     if (idxActive !== -1) {
 85 |       const val = (cols[idxActive] || "").toLowerCase();
 86 |       active = val === "true" || val === "1" || val === "yes" || val === "y";
 87 |     }
 88 | 
 89 |     if (!active) continue;
 90 | 
 91 |     rows.push(url);
 92 |   }
 93 | 
 94 |   return rows;
 95 | }
 96 | 
 97 | /* ============================================
 98 |    Pobranie link√≥w z Sheeta lub lokalnie
 99 |    ============================================ */
100 | async function fetchLinks() {
101 |   if (!LINKS_SHEET_URL) {
102 |     console.warn("[CFG] Brak LINKS_SHEET_URL w .env ‚Äì u≈ºywam lokalnego pliku");
103 |     return loadLinksFromLocalFile();
104 |   }
105 | 
106 |   try {
107 |     console.log("[CFG] Pobieram linki z Google Sheeta...");
108 |     const res = await fetch(LINKS_SHEET_URL);
109 | 
110 |     if (!res.ok) {
111 |       console.warn("[CFG] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
112 |       return loadLinksFromLocalFile();
113 |     }
114 | 
115 |     const text = await res.text();
116 |     const urls = parseCsv(text);
117 |     const unique = [...new Set(urls)];
118 | 
119 |     // backup
120 |     const payload = { links: unique };
121 |     fs.mkdirSync(path.dirname(LOCAL_FILE), { recursive: true });
122 |     fs.writeFileSync(LOCAL_FILE, JSON.stringify(payload, null, 2), "utf8");
123 |     console.log("[CFG] Zapisano backup do links.json");
124 | 
125 |     return unique;
126 |   } catch (err) {
127 |     console.error("[CFG] B≈ÇƒÖd przy pobieraniu link√≥w z Sheeta:", err.message);
128 |     console.warn("[CFG] Pr√≥ba u≈ºycia lokalnego links.json jako fallback");
129 |     return loadLinksFromLocalFile();
130 |   }
131 | }
132 | 
133 | /* ============================================
134 |    Reload z por√≥wnaniem hashy
135 |    ============================================ */
136 | async function reloadLinks() {
137 |   const urls = await fetchLinks();
138 |   const hash = calcHash(urls);
139 | 
140 |   if (hash === lastHash) {
141 |     console.log("[CFG] Linki bez zmian (hash taki sam)");
142 |     return;
143 |   }
144 | 
145 |   lastHash = hash;
146 |   linksCache = urls;
147 | 
148 |   console.log("[CFG] Zaktualizowane linki:", linksCache);
149 | }
150 | 
151 | /* ============================================
152 |    API eksportowane dla reszty programu
153 |    ============================================ */
154 | export async function initLinks(autoRefreshMs = 0) {
155 |   await reloadLinks(); // pierwszy load
156 | 
157 |   if (autoRefreshMs > 0) {
158 |     console.log(
159 |       `[CFG] Auto-refresh link√≥w co ${Math.round(autoRefreshMs / 1000)}s`
160 |     );
161 | 
162 |     setInterval(() => {
163 |       reloadLinks().catch((err) =>
164 |         console.error("[CFG] B≈ÇƒÖd przy auto-refresh link√≥w:", err.message)
165 |       );
166 |     }, autoRefreshMs);
167 |   }
168 | }
169 | 
170 | export function getLinks() {
171 |   return linksCache;
172 | }
173 | 
```

---

### üìÑ ≈öcie≈ºka: `config/links.json`
**Typ:** JSON  
**Opis:** Konfiguracja / sta≈Çe / ustawienia.  

```json
1 | {
2 |   "links": [
3 |     "https://www.facebook.com/post1",
4 |     "https://www.facebook.com/post2"
5 |   ]
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 10 | /**
 11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 12 |  * Np.:
 13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 15 |  */
 16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 17 | 
 18 | /**
 19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 20 |  * Np. domy≈õlnie co 5 minut.
 21 |  */
 22 | const POSTS_REFRESH_MS = Number(
 23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 24 | );
 25 | 
 26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 27 | /**
 28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 32 |  */
 33 | 
 34 | function getPostsFromEnv() {
 35 |   const raw = process.env.FB_POST_URLS || "";
 36 |   const urls = raw
 37 |     .split(",")
 38 |     .map((s) => s.trim())
 39 |     .filter(Boolean);
 40 | 
 41 |   return urls.map((url, index) => ({
 42 |     id: `post${index + 1}`,
 43 |     url,
 44 |   }));
 45 | }
 46 | 
 47 | function getPostLabelsFromEnv(posts) {
 48 |   const raw = process.env.FB_POST_LABELS || "";
 49 |   const labels = raw.split(",").map((s) => s.trim());
 50 | 
 51 |   const map = {};
 52 |   posts.forEach((post, idx) => {
 53 |     map[post.id] = labels[idx] || post.id;
 54 |   });
 55 |   return map;
 56 | }
 57 | 
 58 | const POSTS = getPostsFromEnv();
 59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 60 | 
 61 | /**
 62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 64 |  * dop√≥ki nie dodasz post√≥w w panelu.
 65 |  */
 66 | if (!POSTS.length && !POSTS_SHEET_URL) {
 67 |   console.warn(
 68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 69 |   );
 70 | }
 71 | 
 72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 73 | 
 74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 75 | const EXPAND_COMMENTS =
 76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 77 | 
 78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 80 | const USE_UI_HANDLERS =
 81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 82 | 
 83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 85 | const INCLUDE_REPLIES =
 86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
 87 | 
 88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
 89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
 90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
 91 | 
 92 | export {
 93 |   // stary system ‚Äì optional
 94 |   POSTS,
 95 |   POST_LABELS,
 96 | 
 97 |   // u≈ºywane przez watcher.js / comments.js
 98 |   EXPAND_COMMENTS,
 99 |   USE_UI_HANDLERS,
100 |   INCLUDE_REPLIES,
101 |   CHECK_INTERVAL_MS,
102 | 
103 |   // ≈∫r√≥d≈Ça post√≥w
104 |   POSTS_JSON_PATH,
105 |   POSTS_SHEET_URL,
106 |   POSTS_REFRESH_MS,
107 | };
108 | 
```

---

### üìÑ ≈öcie≈ºka: `src/config.js`
**Typ:** JavaScript/tekst  
**Opis:** Konfiguracja / sta≈Çe / ustawienia.  

```js
  1 | import "dotenv/config";
  2 | 
  3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  4 | /**
  5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  6 |  */
  7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  8 | 
  9 | /* ==================== PANEL API ‚Äì ZDALNE POSTY ==================== */
 10 | /**
 11 |  * POSTS_API_URL ‚Äì URL do API panelu (endpoint GET /api/posts)
 12 |  * Np.: POSTS_API_URL=http://twoj-serwer:3180/api/posts
 13 |  * Je≈õli ustawione, watcher pobiera posty z panelu przez HTTP (priorytet nad plikiem i Sheets)
 14 |  */
 15 | const POSTS_API_URL = (process.env.POSTS_API_URL || "").trim();
 16 | 
 17 | /**
 18 |  * POSTS_API_TOKEN ‚Äì Bearer token do autoryzacji API panelu
 19 |  * Musi byƒá taki sam jak PANEL_TOKEN na serwerze
 20 |  */
 21 | const POSTS_API_TOKEN = (process.env.POSTS_API_TOKEN || "").trim();
 22 | 
 23 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
 24 | /**
 25 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
 26 |  * Np.:
 27 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
 28 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
 29 |  */
 30 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
 31 | 
 32 | /**
 33 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
 34 |  * Np. domy≈õlnie co 5 minut.
 35 |  */
 36 | const POSTS_REFRESH_MS = Number(
 37 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
 38 | );
 39 | 
 40 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
 41 | /**
 42 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
 43 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
 44 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
 45 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
 46 |  */
 47 | 
 48 | function getPostsFromEnv() {
 49 |   const raw = process.env.FB_POST_URLS || "";
 50 |   const urls = raw
 51 |     .split(",")
 52 |     .map((s) => s.trim())
 53 |     .filter(Boolean);
 54 | 
 55 |   return urls.map((url, index) => ({
 56 |     id: `post${index + 1}`,
 57 |     url,
 58 |   }));
 59 | }
 60 | 
 61 | function getPostLabelsFromEnv(posts) {
 62 |   const raw = process.env.FB_POST_LABELS || "";
 63 |   const labels = raw.split(",").map((s) => s.trim());
 64 | 
 65 |   const map = {};
 66 |   posts.forEach((post, idx) => {
 67 |     map[post.id] = labels[idx] || post.id;
 68 |   });
 69 |   return map;
 70 | }
 71 | 
 72 | const POSTS = getPostsFromEnv();
 73 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
 74 | 
 75 | /**
 76 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
 77 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
 78 |  * dop√≥ki nie dodasz post√≥w w panelu.
 79 |  */
 80 | if (!POSTS.length && !POSTS_SHEET_URL) {
 81 |   console.warn(
 82 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
 83 |   );
 84 | }
 85 | 
 86 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
 87 | 
 88 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
 89 | const EXPAND_COMMENTS =
 90 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
 91 | 
 92 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
 93 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
 94 | const USE_UI_HANDLERS =
 95 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
 96 | 
 97 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
 98 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
 99 | const INCLUDE_REPLIES =
100 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
101 | 
102 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
103 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
104 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
105 | 
106 | // FAST_MODE: szybki tryb - sortowanie "Najnowsze", bez loadAllComments
107 | // FAST_MODE=true w≈ÇƒÖcza, domy≈õlnie false (stabilny tryb dedup)
108 | const FAST_MODE = process.env.FAST_MODE === "true";
109 | 
110 | // FAST_MAX_AGE_MIN: limit wieku komentarzy w FAST_MODE (minuty)
111 | // Komentarze starsze ni≈º limit ‚Üí skip posta (je≈õli sort=Najnowsze)
112 | const FAST_MAX_AGE_MIN = Number(process.env.FAST_MAX_AGE_MIN || 180);
113 | 
114 | /* ==================== LOGOWANIE ==================== */
115 | /**
116 |  * LOG_LEVEL ‚Äì poziom szczeg√≥≈Çowo≈õci log√≥w:
117 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
118 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny, do pracy na serwerze)
119 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings (do pracy przy kodzie)
120 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info (hard debug)
121 |  *
122 |  * LOG_TIMESTAMPS ‚Äì czy dodawaƒá [HH:MM:SS] prefix (domy≈õlnie true)
123 |  * LOG_COLORS ‚Äì czy kolorowaƒá logi w konsoli (domy≈õlnie true)
124 |  */
125 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
126 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
127 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
128 | 
129 | /* ==================== CAPTCHA SOLVER ==================== */
130 | /**
131 |  * CAPTCHA_API_KEY ‚Äì klucz API do 2Captcha
132 |  * U≈ºywany do automatycznego rozwiƒÖzywania captcha przy logowaniu
133 |  */
134 | const CAPTCHA_API_KEY = (process.env.CAPTCHA_API_KEY || "").trim();
135 | 
136 | /**
137 |  * CAPTCHA_ENABLED ‚Äì czy w≈ÇƒÖczyƒá automatyczne rozwiƒÖzywanie captcha
138 |  * Domy≈õlnie: true je≈õli CAPTCHA_API_KEY jest ustawiony
139 |  */
140 | const CAPTCHA_ENABLED = process.env.CAPTCHA_ENABLED !== "false" && !!CAPTCHA_API_KEY;
141 | 
142 | /* ==================== REMOTE DEBUG ==================== */
143 | /**
144 |  * REMOTE_DEBUG_PORT ‚Äì port do zdalnego debugowania Chrome
145 |  * Gdy ustawiony, mo≈ºesz pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
146 |  * i widzieƒá/kontrolowaƒá przeglƒÖdarkƒô na ≈ºywo (2FA, checkpoint)
147 |  *
148 |  * U≈ºycie:
149 |  *   1. REMOTE_DEBUG_PORT=9222 node src/index.js
150 |  *   2. SSH tunel: ssh -L 9222:localhost:9222 user@server
151 |  *   3. W Chrome: chrome://inspect ‚Üí Configure ‚Üí localhost:9222
152 |  */
153 | const REMOTE_DEBUG_PORT = Number(process.env.REMOTE_DEBUG_PORT || 0);
154 | 
155 | /* ==================== HUMAN BEHAVIOR MODE ==================== */
156 | /**
157 |  * HUMAN_MODE ‚Äì w≈ÇƒÖcza symulacjƒô zachowa≈Ñ cz≈Çowieka
158 |  * - Wolniejsze wpisywanie (~120ms/znak zamiast 35ms)
159 |  * - Losowa kolejno≈õƒá post√≥w
160 |  * - Pauzy miƒôdzy postami (3-8 sekund)
161 |  * Domy≈õlnie: true
162 |  */
163 | const HUMAN_MODE = process.env.HUMAN_MODE !== "false";
164 | 
165 | /**
166 |  * PROXY_URL ‚Äì URL do proxy HTTP/SOCKS5
167 |  * Format: http://user:pass@host:port lub socks5://host:port
168 |  * Zalecane: residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
169 |  */
170 | const PROXY_URL = (process.env.PROXY_URL || "").trim();
171 | 
172 | export {
173 |   // stary system ‚Äì optional
174 |   POSTS,
175 |   POST_LABELS,
176 | 
177 |   // u≈ºywane przez watcher.js / comments.js
178 |   EXPAND_COMMENTS,
179 |   USE_UI_HANDLERS,
180 |   INCLUDE_REPLIES,
181 |   CHECK_INTERVAL_MS,
182 | 
183 |   // FAST_MODE
184 |   FAST_MODE,
185 |   FAST_MAX_AGE_MIN,
186 | 
187 |   // ≈∫r√≥d≈Ça post√≥w
188 |   POSTS_JSON_PATH,
189 |   POSTS_SHEET_URL,
190 |   POSTS_REFRESH_MS,
191 |   POSTS_API_URL,
192 |   POSTS_API_TOKEN,
193 | 
194 |   // logowanie
195 |   LOG_LEVEL,
196 |   LOG_TIMESTAMPS,
197 |   LOG_COLORS,
198 | 
199 |   // captcha solver
200 |   CAPTCHA_API_KEY,
201 |   CAPTCHA_ENABLED,
202 | 
203 |   // remote debug
204 |   REMOTE_DEBUG_PORT,
205 | 
206 |   // human behavior mode
207 |   HUMAN_MODE,
208 |   PROXY_URL,
209 | };
210 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/postcss.config.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
1 | export default {
2 |   plugins: {
3 |     tailwindcss: {},
4 |     autoprefixer: {},
5 |   },
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/tailwind.config.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
 1 | /** @type {import('tailwindcss').Config} */
 2 | export default {
 3 |   darkMode: 'class',
 4 |   content: [
 5 |     './index.html',
 6 |     './src/**/*.{js,ts,jsx,tsx}',
 7 |   ],
 8 |   theme: {
 9 |     extend: {
10 |       colors: {
11 |         border: 'hsl(var(--border))',
12 |         input: 'hsl(var(--input))',
13 |         ring: 'hsl(var(--ring))',
14 |         background: 'hsl(var(--background))',
15 |         foreground: 'hsl(var(--foreground))',
16 |         primary: {
17 |           DEFAULT: 'hsl(var(--primary))',
18 |           foreground: 'hsl(var(--primary-foreground))',
19 |         },
20 |         secondary: {
21 |           DEFAULT: 'hsl(var(--secondary))',
22 |           foreground: 'hsl(var(--secondary-foreground))',
23 |         },
24 |         destructive: {
25 |           DEFAULT: 'hsl(var(--destructive))',
26 |           foreground: 'hsl(var(--destructive-foreground))',
27 |         },
28 |         muted: {
29 |           DEFAULT: 'hsl(var(--muted))',
30 |           foreground: 'hsl(var(--muted-foreground))',
31 |         },
32 |         accent: {
33 |           DEFAULT: 'hsl(var(--accent))',
34 |           foreground: 'hsl(var(--accent-foreground))',
35 |         },
36 |         popover: {
37 |           DEFAULT: 'hsl(var(--popover))',
38 |           foreground: 'hsl(var(--popover-foreground))',
39 |         },
40 |         card: {
41 |           DEFAULT: 'hsl(var(--card))',
42 |           foreground: 'hsl(var(--card-foreground))',
43 |         },
44 |       },
45 |       borderRadius: {
46 |         lg: 'var(--radius)',
47 |         md: 'calc(var(--radius) - 2px)',
48 |         sm: 'calc(var(--radius) - 4px)',
49 |       },
50 |     },
51 |   },
52 |   plugins: [],
53 | }
54 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/tsconfig.json`
**Typ:** JSON  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```json
 1 | {
 2 |   "compilerOptions": {
 3 |     "target": "ES2020",
 4 |     "useDefineForClassFields": true,
 5 |     "lib": ["ES2020", "DOM", "DOM.Iterable"],
 6 |     "module": "ESNext",
 7 |     "skipLibCheck": true,
 8 | 
 9 |     "moduleResolution": "bundler",
10 |     "allowImportingTsExtensions": true,
11 |     "isolatedModules": true,
12 |     "moduleDetection": "force",
13 |     "noEmit": true,
14 |     "jsx": "react-jsx",
15 | 
16 |     "strict": true,
17 |     "noUnusedLocals": true,
18 |     "noUnusedParameters": true,
19 |     "noFallthroughCasesInSwitch": true,
20 |     "noUncheckedSideEffectImports": true,
21 | 
22 |     "baseUrl": ".",
23 |     "paths": {
24 |       "@/*": ["./src/*"]
25 |     }
26 |   },
27 |   "include": ["src"]
28 | }
29 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/vite.config.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
 1 | import { defineConfig } from 'vite'
 2 | import react from '@vitejs/plugin-react'
 3 | import path from 'path'
 4 | 
 5 | export default defineConfig({
 6 |   plugins: [react()],
 7 |   base: '/new/',
 8 |   resolve: {
 9 |     alias: {
10 |       '@': path.resolve(__dirname, './src'),
11 |     },
12 |   },
13 |   server: {
14 |     port: 5173,
15 |     proxy: {
16 |       '/api': {
17 |         target: 'http://localhost:3180',
18 |         changeOrigin: true,
19 |       },
20 |     },
21 |   },
22 |   build: {
23 |     outDir: 'dist',
24 |     emptyOutDir: true,
25 |   },
26 | })
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/db/cache.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/db/cache.js
  2 | import fs from "fs";
  3 | import path from "path";
  4 | import log from "../utils/logger.js";
  5 | 
  6 | const DATA_DIR = "./data";
  7 | const FILE = path.join(DATA_DIR, "comments-cache.json");
  8 | 
  9 | /**
 10 |  * Upewnia siƒô, ≈ºe istnieje katalog ./data
 11 |  */
 12 | function ensureDir() {
 13 |   if (!fs.existsSync(DATA_DIR)) {
 14 |     fs.mkdirSync(DATA_DIR, { recursive: true });
 15 |   }
 16 | }
 17 | 
 18 | export function loadCache() {
 19 |   try {
 20 |     ensureDir();
 21 |     if (!fs.existsSync(FILE)) return {};
 22 |     const raw = fs.readFileSync(FILE, "utf8");
 23 |     if (!raw.trim()) return {};
 24 |     return JSON.parse(raw);
 25 |   } catch (e) {
 26 |     log.warn("CACHE", `B≈ÇƒÖd ≈Çadowania: ${e.message}`);
 27 | 
 28 |     // Pr√≥ba odczytu backup je≈õli g≈Ç√≥wny plik uszkodzony
 29 |     const backupFile = FILE + ".backup";
 30 |     if (fs.existsSync(backupFile)) {
 31 |       try {
 32 |         const backupRaw = fs.readFileSync(backupFile, "utf8");
 33 |         if (backupRaw.trim()) {
 34 |           log.warn("CACHE", "Odtworzono z backup");
 35 |           return JSON.parse(backupRaw);
 36 |         }
 37 |       } catch (backupErr) {
 38 |         log.warn("CACHE", `B≈ÇƒÖd odczytu backup: ${backupErr.message}`);
 39 |       }
 40 |     }
 41 | 
 42 |     return {};
 43 |   }
 44 | }
 45 | 
 46 | /**
 47 |  * Atomic write - zapisuje do pliku tymczasowego, potem rename.
 48 |  * Zapobiega uszkodzeniu cache przy przerwaniu procesu.
 49 |  */
 50 | export function saveCache(cache) {
 51 |   try {
 52 |     ensureDir();
 53 | 
 54 |     const tmpFile = path.join(DATA_DIR, `.comments-cache.${Date.now()}.tmp`);
 55 |     const content = JSON.stringify(cache, null, 2);
 56 | 
 57 |     // 1. Zapisz do pliku tymczasowego
 58 |     fs.writeFileSync(tmpFile, content, "utf8");
 59 | 
 60 |     // 2. Utw√≥rz backup aktualnego pliku (je≈õli istnieje)
 61 |     if (fs.existsSync(FILE)) {
 62 |       try {
 63 |         fs.copyFileSync(FILE, FILE + ".backup");
 64 |       } catch {
 65 |         // Ignoruj b≈ÇƒÖd backup - nie krytyczny
 66 |       }
 67 |     }
 68 | 
 69 |     // 3. Atomic rename (atomowa operacja na wiƒôkszo≈õci system√≥w plik√≥w)
 70 |     fs.renameSync(tmpFile, FILE);
 71 | 
 72 |   } catch (e) {
 73 |     log.warn("CACHE", `B≈ÇƒÖd zapisu: ${e.message}`);
 74 | 
 75 |     // Spr√≥buj usunƒÖƒá plik tmp je≈õli zosta≈Ç
 76 |     try {
 77 |       const tmpPattern = path.join(DATA_DIR, ".comments-cache.*.tmp");
 78 |       const files = fs.readdirSync(DATA_DIR);
 79 |       for (const f of files) {
 80 |         if (f.startsWith(".comments-cache.") && f.endsWith(".tmp")) {
 81 |           fs.unlinkSync(path.join(DATA_DIR, f));
 82 |         }
 83 |       }
 84 |     } catch {
 85 |       // Ignoruj b≈Çƒôdy cleanup
 86 |     }
 87 |   }
 88 | }
 89 | 
 90 | /**
 91 |  * Zwraca rozmiar cache w bajtach (dla monitoringu)
 92 |  */
 93 | export function getCacheSize() {
 94 |   try {
 95 |     if (!fs.existsSync(FILE)) return 0;
 96 |     const stats = fs.statSync(FILE);
 97 |     return stats.size;
 98 |   } catch {
 99 |     return 0;
100 |   }
101 | }
102 | 
103 | /**
104 |  * Zwraca liczbƒô wpis√≥w w cache (dla monitoringu)
105 |  */
106 | export function getCacheEntryCount() {
107 |   try {
108 |     if (!fs.existsSync(FILE)) return 0;
109 |     const raw = fs.readFileSync(FILE, "utf8");
110 |     if (!raw.trim()) return 0;
111 |     const data = JSON.parse(raw);
112 |     return Object.keys(data).length;
113 |   } catch {
114 |     return 0;
115 |   }
116 | }
117 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/checkpoint.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/checkpoint.js
  2 | import log from "../utils/logger.js";
  3 | 
  4 | /**
  5 |  * Wykrywanie i obs≈Çuga checkpoint√≥w/2FA Facebooka
  6 |  */
  7 | 
  8 | // URL patterns wskazujƒÖce na checkpoint/2FA
  9 | const CHECKPOINT_URL_PATTERNS = [
 10 |   "/checkpoint/",
 11 |   "/two_factor/",
 12 |   "/login/identify",
 13 |   "/recover/initiate",
 14 |   "/login/device-based/",
 15 |   "/checkpoint/block/",
 16 |   "/checkpoint/601/",
 17 | ];
 18 | 
 19 | // DOM selektory wskazujƒÖce na checkpoint/2FA
 20 | const CHECKPOINT_DOM_SELECTORS = [
 21 |   // 2FA
 22 |   'input[name="approvals_code"]',
 23 |   'input[autocomplete="one-time-code"]',
 24 |   'form[id*="two_factor"]',
 25 |   // Checkpoint
 26 |   '[data-testid="checkpoint_container"]',
 27 |   'form[action*="checkpoint"]',
 28 |   // Weryfikacja konta
 29 |   'input[name="captcha_response"]',
 30 |   '[role="dialog"][aria-label*="weryfikacja"]',
 31 |   '[role="dialog"][aria-label*="verification"]',
 32 |   // Podejrzana aktywno≈õƒá
 33 |   'div[data-testid="login_challenge"]',
 34 | ];
 35 | 
 36 | // Teksty wskazujƒÖce na checkpoint (polskie i angielskie)
 37 | const CHECKPOINT_TEXT_PATTERNS = [
 38 |   "wprowad≈∫ kod",
 39 |   "enter code",
 40 |   "two-factor",
 41 |   "dwuetapow",
 42 |   "weryfikacja",
 43 |   "verification required",
 44 |   "suspicious activity",
 45 |   "podejrzana aktywno≈õƒá",
 46 |   "confirm your identity",
 47 |   "potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá",
 48 |   "potwierd≈∫, ≈ºe to ty",
 49 |   "we need to confirm",
 50 |   "security check",
 51 |   "sprawdzenie zabezpiecze≈Ñ",
 52 |   "account verification",
 53 |   "weryfikacja konta",
 54 |   "enter the code",
 55 |   "wpisz kod",
 56 |   "approve your login",
 57 |   "zatwierd≈∫ logowanie",
 58 | ];
 59 | 
 60 | /**
 61 |  * Sprawdza czy URL wskazuje na checkpoint
 62 |  */
 63 | function isCheckpointUrl(url) {
 64 |   if (!url) return false;
 65 |   const lower = url.toLowerCase();
 66 |   return CHECKPOINT_URL_PATTERNS.some((p) => lower.includes(p));
 67 | }
 68 | 
 69 | /**
 70 |  * Sprawdza czy strona zawiera elementy checkpoint/2FA
 71 |  */
 72 | async function hasCheckpointElements(page) {
 73 |   try {
 74 |     const result = await page.evaluate((selectors) => {
 75 |       for (const sel of selectors) {
 76 |         if (document.querySelector(sel)) return true;
 77 |       }
 78 |       return false;
 79 |     }, CHECKPOINT_DOM_SELECTORS);
 80 |     return result;
 81 |   } catch {
 82 |     return false;
 83 |   }
 84 | }
 85 | 
 86 | /**
 87 |  * Sprawdza czy strona zawiera tekst wskazujƒÖcy na checkpoint
 88 |  */
 89 | async function hasCheckpointText(page) {
 90 |   try {
 91 |     const result = await page.evaluate((patterns) => {
 92 |       const bodyText = (document.body?.innerText || "").toLowerCase();
 93 |       return patterns.some((p) => bodyText.includes(p.toLowerCase()));
 94 |     }, CHECKPOINT_TEXT_PATTERNS);
 95 |     return result;
 96 |   } catch {
 97 |     return false;
 98 |   }
 99 | }
100 | 
101 | /**
102 |  * G≈Ç√≥wna funkcja wykrywania checkpoint
103 |  * @param {Page} page - Puppeteer page
104 |  * @returns {Promise<boolean>} - true je≈õli wykryto checkpoint
105 |  */
106 | async function isCheckpoint(page) {
107 |   try {
108 |     const url = page.url();
109 | 
110 |     // 1. Sprawd≈∫ URL
111 |     if (isCheckpointUrl(url)) {
112 |       log.dev("CHECKPOINT", `Wykryto checkpoint w URL: ${url}`);
113 |       return true;
114 |     }
115 | 
116 |     // 2. Sprawd≈∫ elementy DOM
117 |     const hasElements = await hasCheckpointElements(page);
118 |     if (hasElements) {
119 |       log.dev("CHECKPOINT", "Wykryto elementy checkpoint w DOM");
120 |       return true;
121 |     }
122 | 
123 |     // 3. Sprawd≈∫ tekst strony (tylko je≈õli nie jeste≈õmy zalogowani)
124 |     // Unikamy false positive na normalnych stronach
125 |     const hasText = await hasCheckpointText(page);
126 |     if (hasText) {
127 |       // Dodatkowa weryfikacja - czy to nie normalna strona FB?
128 |       const isNormalPage = await page.evaluate(() => {
129 |         // Szukamy element√≥w normalnej strony FB
130 |         const hasNewsFeed = !!document.querySelector('[role="feed"]');
131 |         const hasSearch = !!document.querySelector('input[aria-label*="Szukaj"], input[placeholder*="Szukaj"]');
132 |         return hasNewsFeed || hasSearch;
133 |       });
134 | 
135 |       if (!isNormalPage) {
136 |         log.dev("CHECKPOINT", "Wykryto tekst checkpoint na stronie");
137 |         return true;
138 |       }
139 |     }
140 | 
141 |     return false;
142 |   } catch (err) {
143 |     log.debug("CHECKPOINT", `B≈ÇƒÖd detekcji: ${err?.message}`);
144 |     return false;
145 |   }
146 | }
147 | 
148 | /**
149 |  * Okre≈õla typ checkpoint
150 |  * @param {Page} page - Puppeteer page
151 |  * @returns {Promise<string>} - typ checkpoint
152 |  */
153 | async function getCheckpointType(page) {
154 |   try {
155 |     const url = page.url();
156 | 
157 |     if (url.includes("/two_factor/")) return "2FA";
158 |     if (url.includes("/checkpoint/block/")) return "BLOCKED";
159 |     if (url.includes("/checkpoint/")) return "CHECKPOINT";
160 |     if (url.includes("/login/identify")) return "IDENTIFY";
161 |     if (url.includes("/recover/")) return "RECOVERY";
162 | 
163 |     const has2faInput = await page
164 |       .evaluate(() => {
165 |         return !!(
166 |           document.querySelector('input[name="approvals_code"]') ||
167 |           document.querySelector('input[autocomplete="one-time-code"]')
168 |         );
169 |       })
170 |       .catch(() => false);
171 | 
172 |     if (has2faInput) return "2FA";
173 | 
174 |     return "UNKNOWN";
175 |   } catch {
176 |     return "UNKNOWN";
177 |   }
178 | }
179 | 
180 | export { isCheckpoint, getCheckpointType, isCheckpointUrl };
181 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/comments.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/comments.js
  2 | import { EXPAND_COMMENTS } from "../config.js";
  3 | import { sleepRandom, humanDelay } from "../utils/sleep.js";
  4 | import { scrollPost } from "./scroll.js";
  5 | import { acceptCookies, saveCookies } from "./cookies.js";
  6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
  7 | import { clickOneExpandButton } from "./expandButtons.js";
  8 | import { safeGoto } from "../utils/navigation.js";
  9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
 10 | import log from "../utils/logger.js";
 11 | 
 12 | import * as uiPhoto from "./ui/photo.js";
 13 | import * as uiPost from "./ui/post.js";
 14 | import * as uiVideos from "./ui/videos.js";
 15 | import * as uiWatch from "./ui/watch.js";
 16 | 
 17 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 18 |   ? Number(process.env.NAV_TIMEOUT_MS)
 19 |   : 90000;
 20 | 
 21 | /* ============================================================
 22 |    ===================== UI ROUTER ============================
 23 |    ============================================================ */
 24 | 
 25 | function pickUiHandler(url) {
 26 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
 27 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
 28 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
 29 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
 30 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
 31 |   return null;
 32 | }
 33 | 
 34 | function resolveFastFlag(url, opts, ui) {
 35 |   const wantFast = Boolean(opts && opts.fast);
 36 |   if (!wantFast) return false;
 37 |   // Minimalny zakres FAST: tylko UI "post" (permalink/story/posts)
 38 |   if (!ui || ui.type !== "post") return false;
 39 |   return true;
 40 | }
 41 | 
 42 | /* ============================================================
 43 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
 44 |    ============================================================ */
 45 | 
 46 | async function openCommentsMenu(page) {
 47 |   const r = await page.evaluate(() => {
 48 |     const norm = (s) =>
 49 |       String(s || "")
 50 |         .replace(/\u00a0/g, " ")
 51 |         .replace(/\s+/g, " ")
 52 |         .trim()
 53 |         .toLowerCase();
 54 | 
 55 |     function getLabel(el) {
 56 |       return el.getAttribute?.("aria-label") || el.textContent || "";
 57 |     }
 58 | 
 59 |     if (document.querySelector("div[role='menu']"))
 60 |       return { ok: true, state: "menu-already-open" };
 61 | 
 62 |     const els = Array.from(
 63 |       document.querySelectorAll(
 64 |         "button,div[role='button'],span[role='button'],a[role='button']"
 65 |       )
 66 |     );
 67 | 
 68 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
 69 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
 70 |     const btn = els.find((el) => {
 71 |       const t = norm(getLabel(el));
 72 |       return (
 73 |         t === "najtrafniejsze" ||
 74 |         t === "most relevant" ||
 75 |         t === "wszystkie komentarze" ||
 76 |         t === "all comments" ||
 77 |         t === "najnowsze" ||
 78 |         t === "newest" ||
 79 |         t === "poka≈º wszystkie" ||
 80 |         t === "show all" ||
 81 |         t === "wy≈õwietl wszystkie" ||
 82 |         t === "view all"
 83 |       );
 84 |     });
 85 | 
 86 |     if (!btn) return { ok: false, reason: "no-trigger" };
 87 | 
 88 |     try {
 89 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
 90 |     } catch {}
 91 | 
 92 |     try {
 93 |       btn.click();
 94 |       return { ok: true, state: "clicked-trigger" };
 95 |     } catch {
 96 |       return { ok: false, reason: "click-failed" };
 97 |     }
 98 |   });
 99 | 
100 |   return r?.ok === true;
101 | }
102 | 
103 | async function clickMenuOptionByPrefix(page, prefixes) {
104 |   return page.evaluate(
105 |     (prefixes) => {
106 |       const norm = (s) =>
107 |         String(s || "")
108 |           .replace(/\u00a0/g, " ")
109 |           .replace(/\s+/g, " ")
110 |           .trim()
111 |           .toLowerCase();
112 | 
113 |       const menu =
114 |         document.querySelector("div[role='menu']") ||
115 |         document.querySelector("div[role='dialog']");
116 |       if (!menu) return { ok: false, reason: "no-menu" };
117 | 
118 |       const items = Array.from(
119 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
120 |       );
121 | 
122 |       const opt = items.find((el) => {
123 |         const t = norm(el.textContent);
124 |         return prefixes.some((p) => t.startsWith(p));
125 |       });
126 | 
127 |       if (!opt) return { ok: false, reason: "no-opt" };
128 | 
129 |       try {
130 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
131 |       } catch {}
132 | 
133 |       try {
134 |         opt.click();
135 |         return { ok: true };
136 |       } catch {
137 |         return { ok: false, reason: "click-failed" };
138 |       }
139 |     },
140 |     prefixes
141 |   );
142 | }
143 | 
144 | async function switchCommentsFilterToAllLegacy(page) {
145 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Wszystkie komentarze'...");
146 | 
147 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
148 |     await humanDelay(200, 0.3); // Human: pauza przed otwarciem menu
149 |     const opened = await openCommentsMenu(page);
150 |     if (opened) await humanDelay(500, 0.3); // Human: czekaj na animacjƒô menu
151 |   }
152 | 
153 |   const picked = await clickMenuOptionByPrefix(page, [
154 |     "wszystkie komentarze",
155 |     "all comments",
156 |     "poka≈º wszystkie",
157 |     "show all",
158 |     "wy≈õwietl wszystkie",
159 |     "view all",
160 |   ]);
161 | 
162 |   if (picked?.ok) {
163 |     await humanDelay(400, 0.3);
164 |     await page
165 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
166 |         timeout: 2500,
167 |       })
168 |       .catch(() => {});
169 |     log.dev("FILTER", "Ustawiono 'Wszystkie komentarze'");
170 |     return true;
171 |   }
172 | 
173 |   log.dev("FILTER", "Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze'");
174 |   return false;
175 | }
176 | 
177 | /* ============================================================
178 |    =======  FAST_MODE: SORTOWANIE "NAJNOWSZE"  =================
179 |    ============================================================ */
180 | 
181 | export async function switchCommentsFilterToNewest(page, url = null) {
182 |   const finalUrl = url || page.url();
183 |   const ui = pickUiHandler(finalUrl);
184 | 
185 |   // Dla UI "post" u≈ºywamy scope-aware wersji
186 |   if (ui?.type === "post" && typeof uiPost.switchCommentsFilterToNewestScoped === "function") {
187 |     log.dev("FILTER", "UI ‚Üí post switchCommentsFilterToNewestScoped");
188 |     return uiPost.switchCommentsFilterToNewestScoped(page);
189 |   }
190 | 
191 |   // Dla UI "videos" u≈ºywamy scope-aware wersji
192 |   if (ui?.type === "videos" && typeof uiVideos.switchCommentsFilterToNewestScoped === "function") {
193 |     log.dev("FILTER", "UI ‚Üí videos switchCommentsFilterToNewestScoped");
194 |     return uiVideos.switchCommentsFilterToNewestScoped(page);
195 |   }
196 | 
197 |   // Legacy/fallback dla innych UI
198 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Najnowsze' (legacy)...");
199 | 
200 |   // Otw√≥rz menu je≈õli zamkniƒôte
201 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
202 |     const opened = await openCommentsMenu(page);
203 |     if (!opened) {
204 |       log.dev("FILTER", "Nie uda≈Ço siƒô otworzyƒá menu sortowania");
205 |       return { ok: false, reason: "menu-not-opened" };
206 |     }
207 |     await humanDelay(400, 0.3);
208 |   }
209 | 
210 |   // Kliknij "Najnowsze" / "Newest"
211 |   const picked = await clickMenuOptionByPrefix(page, [
212 |     "najnowsze",
213 |     "newest",
214 |     "od najnowszych",
215 |     "most recent",
216 |   ]);
217 | 
218 |   if (picked?.ok) {
219 |     await humanDelay(400, 0.3);
220 |     await page
221 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
222 |         timeout: 2500,
223 |       })
224 |       .catch(() => {});
225 |     log.dev("FILTER", "Ustawiono 'Najnowsze'");
226 |     return { ok: true };
227 |   }
228 | 
229 |   log.dev("FILTER", "Nie uda≈Ço siƒô wybraƒá 'Najnowsze'");
230 |   return { ok: false, reason: picked?.reason || "option-not-found" };
231 | }
232 | 
233 | /* ============================================================
234 |    ===================  EXPAND (LEGACY)  =======================
235 |    ============================================================ */
236 | 
237 | export async function expandAllComments(page) {
238 |   if (!EXPAND_COMMENTS) return 0;
239 | 
240 |   let clicks = 0;
241 |   for (let i = 0; i < 30; i++) {
242 |     const didClick = await clickOneExpandButton(page);
243 |     if (!didClick) break;
244 |     clicks++;
245 |     await humanDelay(700, 0.3);
246 |   }
247 |   return clicks;
248 | }
249 | 
250 | /* ============================================================
251 |    ===================  LICZNIK KOMENTARZY  ====================
252 |    ============================================================ */
253 | 
254 | async function getCommentCountLegacy(page) {
255 |   const ui = await getUiCommentInfo(page).catch(() => null);
256 | 
257 |   const uiCandidates = [
258 |     ui?.comments,
259 |     ui?.count,
260 |     ui?.commentCount,
261 |     ui?.commentsCount,
262 |     ui?.totalComments,
263 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
264 | 
265 |   if (uiCandidates.length) {
266 |     const best = Math.max(...uiCandidates);
267 |     log.debug("EXTRACT", "UI count", {
268 |       best,
269 |       candidates: uiCandidates,
270 |       source: ui?.source || "ui",
271 |       raw: ui?.raw || null,
272 |       viewType: ui?.viewType || null,
273 |     });
274 |     return best;
275 |   }
276 | 
277 |   const uiLoose = await page
278 |     .evaluate(() => {
279 |       const texts = [];
280 |       const pushText = (t) => {
281 |         if (!t) return;
282 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
283 |         if (s) texts.push(s);
284 |       };
285 | 
286 |       const els = Array.from(
287 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
288 |       );
289 |       for (const el of els) {
290 |         pushText(el.getAttribute?.("aria-label"));
291 |         pushText(el.textContent);
292 |       }
293 | 
294 |       const nums = [];
295 |       for (const t of texts) {
296 |         const low = t.toLowerCase();
297 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
298 |         if (m) nums.push(Number(m[1]));
299 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
300 |         if (m) nums.push(Number(m[1]));
301 |       }
302 | 
303 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
304 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
305 |     })
306 |     .catch(() => ({ count: null, sample: [] }));
307 | 
308 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
309 |     log.debug("EXTRACT", `UI-loose count: ${uiLoose.count}`);
310 |     return uiLoose.count;
311 |   }
312 | 
313 |   if (ui) {
314 |     log.debug("EXTRACT", "UI object (no number)", { keys: Object.keys(ui) });
315 |   } else {
316 |     log.debug("EXTRACT", "UI object: null");
317 |   }
318 | 
319 |   const anchors = await page.evaluate(() => {
320 |     const as = Array.from(
321 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
322 |     );
323 |     const ids = new Set();
324 |     for (const a of as) {
325 |       try {
326 |         const u = new URL(a.href);
327 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
328 |         if (raw) ids.add(raw);
329 |       } catch {}
330 |     }
331 |     return ids.size;
332 |   });
333 | 
334 |   if (anchors > 0) log.debug("EXTRACT", `Anchors-fallback: ${anchors}`);
335 |   return anchors > 0 ? anchors : null;
336 | }
337 | 
338 | /* ============================================================
339 |    ===================  EKSTRAKCJA KOMENTARZY  =================
340 |    ============================================================ */
341 | 
342 | async function extractCommentsFromDOM(page) {
343 |   const data = await page.evaluate(() => {
344 |     function extractCommentIdRaw(url) {
345 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
346 |       return m ? decodeURIComponent(m[1]) : null;
347 |     }
348 | 
349 |     function safeAtob(input) {
350 |       try {
351 |         let s = String(input || "");
352 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
353 |         while (s.length % 4) s += "=";
354 |         return atob(s);
355 |       } catch {
356 |         return null;
357 |       }
358 |     }
359 | 
360 |     function idNumFromRaw(idRaw) {
361 |       if (!idRaw) return null;
362 |       const s = String(idRaw).trim();
363 |       if (/^\d+$/.test(s)) return s;
364 | 
365 |       const dec = safeAtob(s);
366 |       if (dec) {
367 |         const m = String(dec).match(/(\d{6,})\s*$/);
368 |         if (m) return m[1];
369 |       }
370 |       const m2 = s.match(/_(\d+)\b/);
371 |       return m2 ? m2[1] : null;
372 |     }
373 | 
374 |     function normalizeTime(text) {
375 |       if (!text) return null;
376 | 
377 |       const t = String(text)
378 |         .toLowerCase()
379 |         .replace(/\u00a0/g, " ")
380 |         .replace(/\s+/g, " ")
381 |         .trim();
382 | 
383 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
384 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
385 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
386 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
387 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
388 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
389 | 
390 |       return null;
391 |     }
392 | 
393 |     function findTimeAround(linkEl, fallbackNode) {
394 |       const root =
395 |         linkEl?.closest?.("div[role='article']") ||
396 |         linkEl?.closest?.("div[aria-label]") ||
397 |         linkEl?.closest?.("div") ||
398 |         fallbackNode;
399 | 
400 |       if (!root) return null;
401 | 
402 |       const els = root.querySelectorAll("a, abbr, span");
403 |       for (const el of els) {
404 |         const aria = el.getAttribute?.("aria-label");
405 |         const t1 = normalizeTime(aria);
406 |         if (t1) return t1;
407 | 
408 |         const txt = el.textContent?.trim();
409 |         const t2 = normalizeTime(txt);
410 |         if (t2) return t2;
411 |       }
412 |       return null;
413 |     }
414 | 
415 |     const nodes = Array.from(
416 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
417 |     );
418 | 
419 |     const extracted = nodes
420 |       .map((node, idx) => {
421 |         const author = node.querySelector("a[role=\"link\"] span span")?.textContent?.trim() || null;
422 |         const text = node.querySelector("div[dir=\"auto\"]")?.textContent?.trim() || null;
423 | 
424 |         const linkEl = node.querySelector("a[href*=\"reply_comment_id\"]") ||
425 |           node.querySelector("a[href*=\"comment_id\"]") ||
426 |           node.querySelector("a[role=\"link\"]");
427 | 
428 |         const href = linkEl?.getAttribute("href") || null;
429 |         const permalink = href
430 |           ? href.startsWith("http")
431 |             ? href
432 |             : `https://www.facebook.com${href}`
433 |           : null;
434 | 
435 |         const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
436 |         const id = id_raw ? String(id_raw).trim() : null;
437 |         const id_num = id_raw ? idNumFromRaw(id_raw) : null;
438 |         const time = findTimeAround(linkEl, node);
439 | 
440 |         if (!author || !text || !id) return null;
441 | 
442 |         return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
443 |       })
444 |       .filter(Boolean);
445 | 
446 |     return extracted;
447 |   });
448 | 
449 |   return Array.isArray(data) ? data : [];
450 | }
451 | 
452 | /* ============================================================
453 |    ===================  PREPARE / LOAD (LEGACY)  ===============
454 |    ============================================================ */
455 | 
456 | async function prepareLegacy(page, url) {
457 |   const ok = await safeGoto(page, url, "comments", {
458 |     waitUntil: "networkidle2",
459 |     timeout: NAV_TIMEOUT_MS,
460 |   });
461 | 
462 |   if (!ok) throw new Error("safeGoto-failed");
463 | 
464 |   const currentUrl = page.url();
465 |   if (currentUrl.includes("/login")) {
466 |     log.dev("LOGIN", "/login redirect ‚Üí fbLogin()");
467 |     await fbLogin(page);
468 |     await sleepRandom(3000, 4500);
469 | 
470 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
471 |     log.dev("LOGIN", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
472 | 
473 |     if (loggedAfterLogin) {
474 |       await safeGoto(page, url, "comments", {
475 |         waitUntil: "networkidle2",
476 |         timeout: NAV_TIMEOUT_MS,
477 |       });
478 |     }
479 |   }
480 | 
481 |   await acceptCookies(page, "post-initial");
482 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
483 |   await sleepRandom(900, 1400);
484 |   await acceptCookies(page, "post");
485 | 
486 |   try {
487 |     const logged = await checkIfLogged(page).catch(() => false);
488 |     if (logged) await saveCookies(page);
489 |   } catch {}
490 | 
491 |   await scrollPost(page, 140).catch(() => {});
492 |   await sleepRandom(500, 800);
493 | 
494 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
495 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
496 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
497 |   await humanDelay(400, 0.3);
498 | }
499 | 
500 | async function loadAllCommentsLegacy(page, opts = {}) {
501 |   if (!EXPAND_COMMENTS) return;
502 | 
503 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
504 | 
505 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
506 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
507 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
508 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
509 | 
510 |   log.dev("EXTRACT", "Load start", { expected });
511 | 
512 |   function uniqAnchorCountEval() {
513 |     return page.evaluate(() => {
514 |       const as = Array.from(
515 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
516 |       );
517 |       const ids = new Set();
518 |       for (const a of as) {
519 |         const href = a.getAttribute("href") || "";
520 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
521 |         if (m && m[1]) ids.add(m[1]);
522 |       }
523 |       return ids.size;
524 |     });
525 |   }
526 | 
527 |   function commentNodesCountEval() {
528 |     return page.evaluate(() => {
529 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
530 |       return nodes ? nodes.length : 0;
531 |     });
532 |   }
533 | 
534 |   function hasMoreButtonsEval() {
535 |     return page.evaluate(() => {
536 |       const norm = (s) =>
537 |         String(s || "")
538 |           .replace(/\u00a0/g, " ")
539 |           .replace(/\s+/g, " ")
540 |           .trim()
541 |           .toLowerCase();
542 | 
543 |       const btns = Array.from(
544 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
545 |       );
546 |       return btns.some((b) => {
547 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
548 |         return (
549 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
550 |           t.includes("zobacz wiƒôcej komentarzy") ||
551 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
552 |           t.includes("more comments") ||
553 |           t.includes("view more comments") ||
554 |           t.includes("view previous comments") ||
555 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
556 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
557 |           t.includes("more replies") ||
558 |           t.includes("view more replies")
559 |         );
560 |       });
561 |     });
562 |   }
563 | 
564 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
565 |   let nodes = await commentNodesCountEval().catch(() => 0);
566 | 
567 |   let stable = 0;
568 |   let noProgress = 0;
569 | 
570 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
571 |     let clicks = 0;
572 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
573 |       const did = await clickOneExpandButton(page).catch(() => false);
574 |       if (!did) break;
575 |       clicks++;
576 |       await humanDelay(400, 0.3);
577 |     }
578 | 
579 |     await scrollPost(page, 220).catch(() => {});
580 |     await sleepRandom(400, 700);
581 | 
582 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
583 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
584 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
585 | 
586 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
587 | 
588 |     if (progressed) {
589 |       anchors = nextAnchors;
590 |       nodes = nextNodes;
591 |       stable = 0;
592 |       noProgress = 0;
593 |     } else {
594 |       stable++;
595 |       noProgress++;
596 |     }
597 | 
598 |     log.debug("EXTRACT", `Round ${round}`, {
599 |       anchors: `${anchors}‚Üí${nextAnchors}`,
600 |       nodes: `${nodes}‚Üí${nextNodes}`,
601 |       clicks,
602 |       stable: `${stable}/${STABLE_ROUNDS}`,
603 |       moreBtns,
604 |     });
605 | 
606 |     const stableEnough = stable >= STABLE_ROUNDS;
607 | 
608 |     if (!moreBtns && stableEnough) {
609 |       log.dev("EXTRACT", "Stop: no more buttons + stable");
610 |       break;
611 |     }
612 | 
613 |     const reachedExpected =
614 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
615 |     if (reachedExpected && stableEnough && !moreBtns) {
616 |       log.dev("EXTRACT", "Stop: expected reached + stable");
617 |       break;
618 |     }
619 | 
620 |     if (stableEnough && moreBtns) {
621 |       log.debug("EXTRACT", "Rescue: stable but buttons ‚Üí deep scroll");
622 |       await scrollPost(page, 520).catch(() => {});
623 |       await sleepRandom(1000, 1600);
624 |       stable = 0;
625 |       continue;
626 |     }
627 | 
628 |     if (noProgress >= MAX_NO_PROGRESS) {
629 |       if (moreBtns) {
630 |         log.debug("EXTRACT", "Last-rescue: no-progress but buttons ‚Üí deep scroll");
631 |         await scrollPost(page, 650).catch(() => {});
632 |         await sleepRandom(1400, 1900);
633 |         stable = 0;
634 |         noProgress = 0;
635 |         continue;
636 |       }
637 | 
638 |       log.dev("EXTRACT", "Stop: too many no-progress rounds");
639 |       break;
640 |     }
641 | 
642 |     anchors = nextAnchors;
643 |     nodes = nextNodes;
644 |   }
645 | 
646 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
647 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
648 |   log.dev("EXTRACT", `Load done: ${finalAnchors} anchors, ${finalNodes} nodes`);
649 | }
650 | 
651 | /* ============================================================
652 |    ===================  PUBLIC API (ROUTED)  ===================
653 |    ============================================================ */
654 | 
655 | export async function prepare(page, url) {
656 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
657 |   const ui = pickUiHandler(url);
658 |   const fast = resolveFastFlag(url, opts, ui);
659 | 
660 |   if (ui?.prepare) {
661 |     log.dev("NAV", `UI ‚Üí ${ui.type || "unknown"} prepare`, { fast });
662 |     return ui.prepare(page, url, { ...(opts || {}), fast });
663 |   }
664 | 
665 |   log.dev("NAV", "UI ‚Üí legacy prepare");
666 |   return prepareLegacy(page, url);
667 | }
668 | 
669 | export async function getCommentCount(page, url) {
670 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
671 |   const finalUrl = url || page.url();
672 |   const ui = pickUiHandler(finalUrl);
673 |   const fast = resolveFastFlag(finalUrl, opts, ui);
674 | 
675 |   if (ui?.getCommentCount) {
676 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} getCommentCount`);
677 |     return ui.getCommentCount(page, finalUrl, { ...(opts || {}), fast });
678 |   }
679 | 
680 |   log.debug("EXTRACT", "UI ‚Üí legacy getCommentCount");
681 |   return getCommentCountLegacy(page);
682 | }
683 | 
684 | export async function loadAllComments(page, opts = {}, url = null) {
685 |   if (!EXPAND_COMMENTS) return;
686 | 
687 |   const finalUrl = url || page.url();
688 |   const ui = pickUiHandler(finalUrl);
689 |   const fast = resolveFastFlag(finalUrl, opts, ui);
690 | 
691 |   if (ui?.loadAllComments) {
692 |     log.dev("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} loadAllComments`);
693 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal, ...(opts || {}), fast });
694 |   }
695 | 
696 |   log.dev("EXTRACT", "UI ‚Üí legacy loadAllComments");
697 |   return loadAllCommentsLegacy(page, opts);
698 | }
699 | 
700 | export async function extractCommentsData(page, url = null) {
701 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
702 |   const finalUrl = url || page.url();
703 |   const ui = pickUiHandler(finalUrl);
704 |   const fast = resolveFastFlag(finalUrl, opts, ui);
705 | 
706 |   const getPostRef = (u) => {
707 |     if (!u) return null;
708 |     try {
709 |       const x = new URL(u);
710 | 
711 |       // permalink.php?story_fbid=...
712 |       const story = x.searchParams.get("story_fbid");
713 |       if (story) return `story_fbid:${story}`;
714 | 
715 |       // /.../posts/<id>  |  /.../videos/<id>  |  /.../photos/<id>
716 |       const parts = x.pathname.split("/").filter(Boolean);
717 |       for (let i = 0; i < parts.length - 1; i++) {
718 |         const k = parts[i];
719 |         if (k === "posts" || k === "videos" || k === "photos" || k === "reels") {
720 |           const v = parts[i + 1];
721 |           if (v) return `${k}:${v}`;
722 |         }
723 |       }
724 | 
725 |       // fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)
726 |       return null;
727 |     } catch (e) {
728 |       return null;
729 |     }
730 |   };
731 | 
732 |   const postRef = getPostRef(finalUrl);
733 | 
734 |   const filterByRef = (arr) => {
735 |     if (!Array.isArray(arr)) return [];
736 |     if (!postRef) return arr;
737 | 
738 |     let dropped = 0;
739 |     const out = [];
740 |     let sampleLogged = 0;
741 | 
742 |     // kontekst: do czego porownujemy
743 |     log.debug("DEDUP", `Context: want=${postRef || "null"}`);
744 | 
745 |     for (const c of arr) {
746 |       const permalink = c && typeof c === "object" ? c.permalink || null : null;
747 |       const cref = permalink ? getPostRef(permalink) : null;
748 | 
749 |       // pokaz 3 pierwsze permalink->cref
750 |       if (sampleLogged < 3 && permalink) {
751 |         log.debug("DEDUP", `Sample: cref=${cref || "null"}`);
752 |         sampleLogged += 1;
753 |       }
754 | 
755 |       if (cref && cref !== postRef) {
756 |         dropped += 1;
757 |         continue;
758 |       }
759 |       if (c && typeof c === "object") c.postRef = postRef;
760 |       out.push(c);
761 |     }
762 | 
763 |     if (dropped > 0) {
764 |       log.debug("DEDUP", `Dropped ${dropped} (ref mismatch)`);
765 |     }
766 | 
767 |     if (arr.length > 0 && out.length === 0 && dropped === arr.length) {
768 |       out._dedupAllDropped = true;
769 |       log.warn("DEDUP", `All ${arr.length} dropped (ref mismatch)`);
770 |     }
771 | 
772 |     return out;
773 |   };
774 | 
775 |   if (ui?.extractComments) {
776 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} extractComments`);
777 |     const out = await ui.extractComments(page, finalUrl, { ...(opts || {}), fast });
778 |     return filterByRef(out);
779 |   }
780 | 
781 |   const out = await extractCommentsFromDOM(page);
782 |   return filterByRef(out);
783 | }
784 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/cookies.js
  2 | import fs from "fs/promises";
  3 | import path from "path";
  4 | import { sleepRandom } from "../utils/sleep.js";
  5 | import log from "../utils/logger.js";
  6 | 
  7 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
  8 | const COOKIES_READ_ONLY =
  9 |   String(process.env.COOKIES_READ_ONLY || "")
 10 |     .trim()
 11 |     .toLowerCase() === "true";
 12 | 
 13 | log.debug("COOKIES", `COOKIES_READ_ONLY=${COOKIES_READ_ONLY}`, { raw: process.env.COOKIES_READ_ONLY });
 14 | 
 15 | 
 16 | /**
 17 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
 18 |  */
 19 | async function loadCookies(page) {
 20 |   try {
 21 |     const raw = await fs.readFile("cookies.json", "utf8");
 22 |     const cookies = JSON.parse(raw);
 23 | 
 24 |     if (Array.isArray(cookies) && cookies.length) {
 25 |       await page.setCookie(...cookies);
 26 |       log.dev("COOKIES", `Za≈Çadowano ${cookies.length} cookies z pliku`);
 27 |     } else {
 28 |       log.dev("COOKIES", "cookies.json istnieje, ale nie zawiera poprawnej tablicy");
 29 |     }
 30 |   } catch (err) {
 31 |     log.dev("COOKIES", `Brak cookies.json lub b≈ÇƒÖd odczytu: ${err?.message || err}`);
 32 |   }
 33 | }
 34 | 
 35 | /**
 36 |  * Atomic write dla plik√≥w JSON - zapisuje do tmp, potem rename
 37 |  * @param {string} targetPath - docelowa ≈õcie≈ºka pliku
 38 |  * @param {string} content - zawarto≈õƒá do zapisania
 39 |  */
 40 | async function atomicWriteFile(targetPath, content) {
 41 |   const dir = path.dirname(targetPath);
 42 |   const basename = path.basename(targetPath, ".json");
 43 |   const tmpFile = path.join(dir, `.${basename}.${Date.now()}.tmp`);
 44 | 
 45 |   // 1. Zapisz do pliku tymczasowego
 46 |   await fs.writeFile(tmpFile, content, "utf8");
 47 | 
 48 |   // 2. Atomic rename
 49 |   await fs.rename(tmpFile, targetPath);
 50 | }
 51 | 
 52 | /**
 53 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
 54 |  * U≈ºywa atomic write dla bezpiecze≈Ñstwa.
 55 |  */
 56 | async function saveCookies(page) {
 57 |   if (COOKIES_READ_ONLY) {
 58 |     log.debug("COOKIES", "COOKIES_READ_ONLY=true ‚Äì pomijam zapis");
 59 |     return;
 60 |   }
 61 | 
 62 |   try {
 63 |     const cookies = await page.cookies();
 64 |     const content = JSON.stringify(cookies, null, 2);
 65 | 
 66 |     await atomicWriteFile("cookies.json", content);
 67 | 
 68 |     log.dev("COOKIES", `Zapisano ${cookies.length} cookies do pliku`);
 69 |   } catch (e) {
 70 |     log.warn("COOKIES", `B≈ÇƒÖd zapisu cookies.json: ${e?.message || e}`);
 71 | 
 72 |     // Cleanup tmp files
 73 |     try {
 74 |       const files = await fs.readdir(".");
 75 |       for (const f of files) {
 76 |         if (f.startsWith(".cookies.") && f.endsWith(".tmp")) {
 77 |           await fs.unlink(f);
 78 |         }
 79 |       }
 80 |     } catch {
 81 |       // Ignoruj b≈Çƒôdy cleanup
 82 |     }
 83 |   }
 84 | }
 85 | 
 86 | 
 87 | 
 88 | /**
 89 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
 90 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
 91 |  */
 92 | async function acceptCookies(page, label = "global") {
 93 |   try {
 94 |     // chwila na pojawienie siƒô popupu
 95 |     await sleepRandom(800, 1500);
 96 | 
 97 |     const result = await page.evaluate(() => {
 98 |       const wanted = [
 99 |         "zezw√≥l na wszystkie pliki cookie",
100 |         "zezw√≥l na wszystkie pliki",
101 |         "akceptuj wszystkie pliki cookie",
102 |         "akceptuj wszystkie",
103 |         "allow all cookies",
104 |         "accept all cookies",
105 |         "accept essential and optional cookies",
106 |         "tylko niezbƒôdne pliki cookie",
107 |         "odrzuƒá opcjonalne pliki cookie",
108 |       ].map((t) => t.toLowerCase());
109 | 
110 |       const buttons = Array.from(
111 |         document.querySelectorAll("button, [role='button']")
112 |       );
113 | 
114 |       let clicked = false;
115 |       const texts = [];
116 | 
117 |       for (const btn of buttons) {
118 |         const txt = (btn.innerText || btn.textContent || "").trim();
119 |         if (!txt) continue;
120 | 
121 |         const low = txt.toLowerCase();
122 |         texts.push(txt);
123 | 
124 |         if (wanted.some((w) => low.includes(w))) {
125 |           btn.click();
126 |           clicked = true;
127 |           break;
128 |         }
129 |       }
130 | 
131 |       return { clicked, texts };
132 |     });
133 | 
134 |     if (result.clicked) {
135 |       log.debug("COOKIES", `[${label}] Klikniƒôto akceptacjƒô cookies`);
136 |       await sleepRandom(1500, 2500);
137 |     } else {
138 |       log.debug("COOKIES", `[${label}] Nie znaleziono przycisku cookies`, { texts: result.texts?.slice(0, 5) });
139 |     }
140 |   } catch (err) {
141 |     log.debug("COOKIES", `[${label}] B≈ÇƒÖd popupu: ${err?.message || err}`);
142 |   }
143 | }
144 | 
145 | export {
146 |   loadCookies,
147 |   saveCookies,
148 |   acceptCookies,
149 | };
150 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/expandButtons.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/expandButtons.js
  2 | // Centralny ‚Äûbutton classifier" dla wszystkich przycisk√≥w typu:
  3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments"
  4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies"
  5 | // - ‚ÄûZobacz wiƒôcej / See more" (bez ‚ÄûZobacz t≈Çumaczenie").
  6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
  7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
  8 | 
  9 | import { INCLUDE_REPLIES } from "../config.js";
 10 | import { humanDelay } from "../utils/sleep.js";
 11 | import log from "../utils/logger.js";
 12 | 
 13 | async function clickOneExpandButton(page) {
 14 |   // Human behavior: ma≈Çe op√≥≈∫nienie przed szukaniem przycisku
 15 |   await humanDelay(150, 0.4);
 16 | 
 17 |   const res = await page.evaluate((includeReplies) => {
 18 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 19 |       location.href
 20 |     );
 21 |     const isWatchView = /\/watch\//i.test(location.href);
 22 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
 23 | 
 24 |     function getPostRoot() {
 25 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 26 |       const postDialog = dialogs.find((dlg) => {
 27 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 28 |         if (!text) return false;
 29 |         const hasCommentWord =
 30 |           text.includes("komentarz") || text.includes("comment");
 31 |         const hasActions =
 32 |           text.includes("lubiƒô to") ||
 33 |           text.includes("komentarz") ||
 34 |           text.includes("udostƒôpnij") ||
 35 |           text.includes("napisz komentarz") ||
 36 |           text.includes("comment");
 37 |         const looksLikeNotifications =
 38 |           text.startsWith("powiadomienia") &&
 39 |           text.includes("wszystkie") &&
 40 |           text.includes("nieprzeczytane");
 41 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 42 |       });
 43 |       if (postDialog) return postDialog;
 44 |       const main = document.querySelector("div[role='main']");
 45 |       if (main) {
 46 |         const article = main.querySelector("article");
 47 |         return article || main;
 48 |       }
 49 |       return document.body;
 50 |     }
 51 | 
 52 |     function isVisible(el) {
 53 |       if (!el) return false;
 54 |       const style = window.getComputedStyle(el);
 55 |       if (!style) return false;
 56 |       if (style.display === "none" || style.visibility === "hidden") return false;
 57 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
 58 |       if (style.pointerEvents === "none") return false;
 59 |       const rect = el.getBoundingClientRect();
 60 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
 61 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
 62 |       return true;
 63 |     }
 64 | 
 65 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
 66 |     const root =
 67 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
 68 |     // (widok /watch/ jest traktowany jak video)
 69 | 
 70 |     const buttons = Array.from(
 71 |       root.querySelectorAll(
 72 |         "button, a, div[role='button'], span[role='button']"
 73 |       )
 74 |     );
 75 | 
 76 |     function classifyButton(raw) {
 77 |       const text = raw.toLowerCase();
 78 |       const hasCommentWord =
 79 |         text.includes("komentarz") ||
 80 |         text.includes("comments") ||
 81 |         text.includes("comment");
 82 |       const hasReplyWord =
 83 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
 84 |         text.includes("reply") ||
 85 |         text.includes("replies") ||
 86 |         text.includes("repl");
 87 |       const hasMoreWord =
 88 |         text.includes("wy≈õwietl") ||
 89 |         text.includes("zobacz") ||
 90 |         text.includes("poka≈º") ||
 91 |         text.includes("view") ||
 92 |         text.includes("show") ||
 93 |         text.includes("see") ||
 94 |         text.includes("wszystkie") ||
 95 |         text.includes("all") ||
 96 |         text.includes("previous");
 97 |       const hasTranslationWord =
 98 |         text.includes("t≈Çumaczenie") || text.includes("translation");
 99 |       if (hasTranslationWord) return null;
100 |       if (
101 |         text === "komentarz" ||
102 |         text === "comment" ||
103 |         text === "lubiƒô to" ||
104 |         text === "lubiƒô to!" ||
105 |         text === "like" ||
106 |         text === "odpowiedz" ||
107 |         text === "reply"
108 |       ) {
109 |         return null;
110 |       }
111 |       if (
112 |         hasCommentWord &&
113 |         hasMoreWord &&
114 |         (text.includes("wiƒôcej") ||
115 |           text.includes("more") ||
116 |           text.includes("poprzednie") ||
117 |           text.includes("previous"))
118 |       ) {
119 |         return { kind: "more-comments", priority: 3 };
120 |       }
121 | 
122 |       // ‚úÖ ON/OFF odpowiedzi
123 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
124 |         return { kind: "more-replies", priority: 2 };
125 |       }
126 | 
127 |       if (
128 |         text === "zobacz wiƒôcej" ||
129 |         text === "see more" ||
130 |         text.startsWith("zobacz wiƒôcej ") ||
131 |         text.startsWith("see more ")
132 |       ) {
133 |         return { kind: "see-more-text", priority: 1 };
134 |       }
135 |       return null;
136 |     }
137 | 
138 |     const candidates = [];
139 | 
140 |     for (const el of buttons) {
141 |       if (!isVisible(el)) continue;
142 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
143 |       if (!raw) continue;
144 |       const cls = classifyButton(raw);
145 |       if (!cls) continue;
146 |       const rect = el.getBoundingClientRect();
147 |       candidates.push({
148 |         el,
149 |         kind: cls.kind,
150 |         priority: cls.priority,
151 |         top: rect.top,
152 |         text: raw,
153 |       });
154 |     }
155 | 
156 |     if (!candidates.length) {
157 |       return { clicked: false };
158 |     }
159 | 
160 |     candidates.sort((a, b) => {
161 |       if (a.priority !== b.priority) return b.priority - a.priority;
162 |       return a.top - b.top;
163 |     });
164 | 
165 |     const chosen = candidates[0];
166 |     try {
167 |       chosen.el.click();
168 |       return {
169 |         clicked: true,
170 |         kind: chosen.kind,
171 |         text: chosen.text,
172 |       };
173 |     } catch (e) {
174 |       return { clicked: false };
175 |     }
176 |   }, INCLUDE_REPLIES);
177 | 
178 |   if (res && res.clicked) {
179 |     log.debug("EXPAND", `Klik '${res.text}' (${res.kind})`);
180 |     // Human behavior: op√≥≈∫nienie po klikniƒôciu (czekaj na reakcjƒô UI)
181 |     await humanDelay(400, 0.3);
182 |   }
183 |   return !!(res && res.clicked);
184 | }
185 | 
186 | export { clickOneExpandButton };
187 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/legacy/comments.legacy.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
   1 | // src/fb/comments.js
   2 | // src/fb/legacy/comments.legacy.js
   3 | import { EXPAND_COMMENTS } from "../../config.js";
   4 | import { sleepRandom } from "../../utils/sleep.js";
   5 | import { safeGoto } from "../../utils/navigation.js";
   6 | 
   7 | import { scrollPost } from "../scroll.js";
   8 | import { acceptCookies, saveCookies } from "../cookies.js";
   9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  10 | import { clickOneExpandButton } from "../expandButtons.js";
  11 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  12 | 
  13 | 
  14 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
  15 |   ? Number(process.env.NAV_TIMEOUT_MS)
  16 |   : 90000; // by≈Ço 60000, podbijamy do 90s
  17 | 
  18 | let firstPostPauseDone = false;
  19 | /* ============================================================
  20 |    =======  PRZE≈ÅƒÑCZANIE FILTRA ‚ÄûWSZYSTKIE KOMENTARZE‚Äù  ========
  21 |    ============================================================ */
  22 | 
  23 | async function switchCommentsFilterToAll(page) {
  24 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
  25 | 
  26 |   // 1) je≈õli menu ju≈º jest otwarte ‚Äì nie klikamy ponownie, tylko pr√≥bujemy wybraƒá opcjƒô "Wszystkie komentarze" z istniejƒÖcego menu
  27 |   const menuAlreadyOpen = await page.evaluate(() => {
  28 |     return !!document.querySelector("div[role='menu']");
  29 |   });
  30 | 
  31 |   if (menuAlreadyOpen) {
  32 |     console.log("[FB][filter] Menu filtra ju≈º otwarte ‚Äì pr√≥bujƒô wybraƒá opcjƒô.");
  33 | 
  34 |     const menuResult = await clickAllCommentsInMenu(page);
  35 |     if (menuResult.clicked) {
  36 |       console.log("[FB][filter] Wybrano 'Wszystkie komentarze' z otwartego menu.");
  37 |       return true;
  38 |     }
  39 |     console.log("[FB][filter] Menu otwarte, ale nie ma opcji 'Wszystkie komentarze'.");
  40 |     return false;
  41 |   }
  42 | 
  43 |   // 2) spr√≥buj znale≈∫ƒá bie≈ºƒÖcy przycisk filtra i sprawdziƒá, co jest ustawione
  44 |   const pre = await page.evaluate(() => {
  45 |     const els = Array.from(
  46 |       document.querySelectorAll("div[role='button'], span[role='button']")
  47 |     );
  48 |     let filterEl = null;
  49 |     let labelText = "";
  50 |     for (const el of els) {
  51 |       const t = (el.textContent || "").trim();
  52 |       if (!t) continue;
  53 |       const low = t.toLowerCase();
  54 |       if (
  55 |         low === "najtrafniejsze" ||
  56 |         low === "most relevant" ||
  57 |         low === "wszystkie komentarze" ||
  58 |         low === "all comments"
  59 |       ) {
  60 |         filterEl = el;
  61 |         labelText = low;
  62 |         break;
  63 |       }
  64 |     }
  65 |     if (!filterEl) {
  66 |       return { state: "not-found" };
  67 |     }
  68 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
  69 |       return { state: "already-all" };
  70 |     }
  71 |     filterEl.click();
  72 |     return { state: "clicked-filter" };
  73 |   });
  74 | 
  75 |   if (pre.state === "not-found") {
  76 |     console.log("[FB][filter] Nie znaleziono przycisku filtra komentarzy.");
  77 |     return false;
  78 |   }
  79 |   if (pre.state === "already-all") {
  80 |     console.log("[FB][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' ‚Äì pomijam.");
  81 |     return true;
  82 |   }
  83 |   if (pre.state === "clicked-filter") {
  84 |     await sleepRandom(400, 800);
  85 |     const menuResult = await clickAllCommentsInMenu(page);
  86 |     if (!menuResult.clicked && menuResult.noMenu) {
  87 |       // fallback: mo≈ºe filtr prze≈ÇƒÖcza siƒô bez menu ‚Äì sprawdzamy label jeszcze raz
  88 |       const afterLabelIsAll = await page.evaluate(() => {
  89 |         const els = Array.from(
  90 |           document.querySelectorAll("div[role='button'], span[role='button']")
  91 |         );
  92 |         const btn = els.find((el) => {
  93 |           const t = (el.textContent || "").trim().toLowerCase();
  94 |           return t === "wszystkie komentarze" || t === "all comments";
  95 |         });
  96 |         return !!btn;
  97 |       });
  98 |       if (afterLabelIsAll) {
  99 |         console.log(
 100 |           "[FB][filter] Po klikniƒôciu filtr prze≈ÇƒÖczy≈Ç siƒô bez menu na 'Wszystkie komentarze'."
 101 |         );
 102 |         return true;
 103 |       }
 104 |       console.log(
 105 |         "[FB][filter] Klikniƒôto filtr, ale nie pojawi≈Ço siƒô menu i label nie jest 'Wszystkie komentarze'."
 106 |       );
 107 |       return false;
 108 |     }
 109 |     if (!menuResult.clicked && !menuResult.noMenu) {
 110 |       console.log("[FB][filter] Menu filtra jest, ale brak opcji 'Wszystkie komentarze'.");
 111 |       return false;
 112 |     }
 113 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze'.");
 114 |     return true;
 115 |   }
 116 |   console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);
 117 |   return false;
 118 | }
 119 | 
 120 | async function clickShowAllCommentsIfPresent(page) {
 121 |   console.log("[FB][show-all] Pr√≥ba klikniƒôcia 'Poka≈º wszystkie' (aria-label)‚Ä¶");
 122 | 
 123 |   try {
 124 |     const clicked = await page.evaluate(() => {
 125 |       // Je≈õli filtr ju≈º jest, to znaczy ≈ºe "Poka≈º wszystkie" zosta≈Ço klikniƒôte / niepotrzebne
 126 |       const bodyText = (document.body.innerText || "").toLowerCase();
 127 |       if (
 128 |         bodyText.includes("najtrafniejsze") ||
 129 |         bodyText.includes("najnowsze") ||
 130 |         bodyText.includes("wszystkie komentarze") ||
 131 |         bodyText.includes("all comments") ||
 132 |         bodyText.includes("ukryj komentarze") ||
 133 |         bodyText.includes("hide comments")
 134 |       ) {
 135 |         return false;
 136 |       }
 137 |       const selectors = [
 138 |         "div[aria-label='Poka≈º wszystkie'][role='button']",
 139 |         "div[aria-label='Wy≈õwietl wszystkie'][role='button']",
 140 |         "div[aria-label='Show all'][role='button']",
 141 |         "div[aria-label='View all'][role='button']",
 142 |       ];
 143 |       let el = null;
 144 |       for (const sel of selectors) {
 145 |         el = document.querySelector(sel);
 146 |         if (el) break;
 147 |       }
 148 |       if (!el) return false;
 149 |       try {
 150 |         el.scrollIntoView({ block: "center", inline: "nearest" });
 151 |       } catch (e) {
 152 |         // scrollIntoView nie musi siƒô udaƒá
 153 |       }
 154 |       if (typeof el.click === "function") {
 155 |         el.click();
 156 |         return true;
 157 |       }
 158 |       return false;
 159 |     });
 160 |     if (!clicked) {
 161 |       console.log(
 162 |         "[FB][show-all] Nie znaleziono aria-label='Poka≈º wszystkie' albo filtr ju≈º widoczny ‚Äì pomijam."
 163 |       );
 164 |       return false;
 165 |     }
 166 |     console.log("[FB][show-all] Klikniƒôto 'Poka≈º wszystkie' (aria-label).");
 167 |     await sleepRandom(900, 1600);
 168 |     return true;
 169 |   } catch (err) {
 170 |     console.log(
 171 |       "[FB][show-all] B≈ÇƒÖd podczas klikania 'Poka≈º wszystkie':",
 172 |       err?.message || err
 173 |     );
 174 |     return false;
 175 |   }
 176 | }
 177 | import fs from 'fs';
 178 | 
 179 | async function extractCommentsFromDOM(page) {
 180 |   const data = await page.evaluate(() => {
 181 |     function extractCommentId(url) {
 182 |       const match = url?.match(/comment_id=([^&]+)/);
 183 |       return match ? decodeURIComponent(match[1]) : null;
 184 |     }
 185 | 
 186 |     // Mapa commentId -> time
 187 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 188 |     const idToTimeMap = {};
 189 | 
 190 |     for (let i = 0; i < allLinks.length; i++) {
 191 |       const link = allLinks[i];
 192 |       const href = link.getAttribute('href') || '';
 193 |       const id = extractCommentId(href);
 194 | 
 195 |       if (id) {
 196 |         // Szukamy nastƒôpnego linka z tekstem typu "1 godz.", "2 dni" itd.
 197 |         for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
 198 |           const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
 199 |           if (timeText && /^\d+\s?(min|godz|sek|dni|tyg)/.test(timeText)) {
 200 |             idToTimeMap[id] = timeText;
 201 |             break;
 202 |           }
 203 |         }
 204 |       }
 205 |     }
 206 | 
 207 |     const commentNodes = Array.from(
 208 |       document.querySelectorAll('div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k')
 209 |     );
 210 | 
 211 |     const extracted = commentNodes.map((node) => {
 212 |       try {
 213 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim();
 214 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim();
 215 |         const linkEl = node.querySelector('a[role="link"]');
 216 |         const href = linkEl?.getAttribute('href');
 217 |         const permalink = href?.startsWith('http') ? href : `https://www.facebook.com${href}`;
 218 |         const id = extractCommentId(permalink) || null;
 219 | 
 220 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
 221 | 
 222 |         if (!author || !text) return null;
 223 | 
 224 |         return { id, author, text, permalink, time };
 225 |       } catch (err) {
 226 |         return null;
 227 |       }
 228 |     }).filter(Boolean);
 229 | 
 230 |     return extracted;
 231 |   });
 232 | 
 233 |   console.log('[FB] extractCommentsFromDOM ‚Äì wyciƒÖgniƒôto komentarzy:', data.length);
 234 |   console.log('[DBG] Komentarze:', JSON.stringify(data, null, 2));
 235 | 
 236 |   return data;
 237 | }
 238 | 
 239 | 
 240 | 
 241 | 
 242 | /* ============================================================
 243 |    =========== POST ROOT (DIALOG / MAIN / FALLBACK) ============
 244 |    ============================================================ */
 245 | 
 246 | async function clickAllCommentsInMenu(page) {
 247 |   const result = await page.evaluate(() => {
 248 |     const menu =
 249 |       document.querySelector("div[role='menu']") ||
 250 |       document.querySelector("div[role='dialog']");
 251 |     if (!menu) {
 252 |       return { clicked: false, noMenu: true };
 253 |     }
 254 |     const items = Array.from(
 255 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 256 |     );
 257 |     const opt = items.find((el) => {
 258 |       const t = (el.textContent || "").trim().toLowerCase();
 259 |       return (
 260 |         t.startsWith("wszystkie komentarze") ||
 261 |         t.startsWith("all comments")
 262 |       );
 263 |     });
 264 |     if (!opt) {
 265 |       return { clicked: false, noMenu: false };
 266 |     }
 267 |     opt.click();
 268 |     setTimeout(() => {
 269 |       try {
 270 |         document.body.click();
 271 |       } catch {}
 272 |     }, 50);
 273 |     return { clicked: true, noMenu: false };
 274 |   });
 275 |   if (result.clicked) {
 276 |     await sleepRandom(300, 600);
 277 |     await page
 278 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 279 |         timeout: 2000,
 280 |       })
 281 |       .catch(() => {});
 282 |   }
 283 |   return result;
 284 | }
 285 | 
 286 | /* ============================================================
 287 |    ===== POMOCNICZE: LICZENIE ID KOMENTARZY ====================
 288 |    ============================================================ */
 289 | 
 290 | function postRootScript() {
 291 |   return `
 292 |     function getPostRoot() {
 293 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 294 |       const postDialog = dialogs.find((dlg) => {
 295 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 296 |         if (!text) return false;
 297 |         const hasCommentWord =
 298 |           text.includes("komentarz") || text.includes("comment");
 299 |         const hasActions =
 300 |           text.includes("lubiƒô to") ||
 301 |           text.includes("komentarz") ||
 302 |           text.includes("udostƒôpnij") ||
 303 |           text.includes("napisz komentarz") ||
 304 |           text.includes("comment");
 305 |         const looksLikeNotifications =
 306 |           text.startsWith("powiadomienia") &&
 307 |           text.includes("wszystkie") &&
 308 |           text.includes("nieprzeczytane");
 309 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 310 |       });
 311 |       if (postDialog) return postDialog;
 312 |       const main = document.querySelector("div[role='main']");
 313 |       if (main) {
 314 |         const article = main.querySelector("article");
 315 |         return article || main;
 316 |       }
 317 |       return document.body;
 318 |     }
 319 |   `;
 320 | }
 321 | 
 322 | async function getCurrentCommentAnchorCount(page) {
 323 |   const count = await page.evaluate(() => {
 324 |     const anchors = Array.from(
 325 |       document.querySelectorAll(
 326 |         "a[href*='comment_id'], a[href*='reply_comment_id']"
 327 |       )
 328 |     );
 329 |     const ids = new Set();
 330 |     for (const a of anchors) {
 331 |       try {
 332 |         const url = new URL(a.href);
 333 |         const cid = url.searchParams.get("comment_id");
 334 |         const rid = url.searchParams.get("reply_comment_id");
 335 |         let raw = rid || cid;
 336 |         if (!raw) continue;
 337 |         if (!/^\d+$/.test(raw)) {
 338 |           try {
 339 |             const dec = atob(raw);
 340 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 341 |             if (m) raw = m[2];
 342 |           } catch {}
 343 |         }
 344 |         if (raw) ids.add(raw);
 345 |       } catch {}
 346 |     }
 347 |     return ids.size;
 348 |   });
 349 |   return count || 0;
 350 | }
 351 | 
 352 | /* ============================================================
 353 |    ======= SCROLL W OBRƒòBIE POSTA (DIALOG/MAIN/FALLBACK) =======
 354 |    ============================================================ */
 355 | 
 356 | async function scrollWithinPost(page, label, factor = 0.3) {
 357 |   const info = await page.evaluate(
 358 |     (factorArg, labelArg, postRootCode) => {
 359 |       const href = location.href;
 360 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 361 |         href
 362 |       );
 363 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 364 |       // wstrzykujemy funkcjƒô getPostRoot
 365 |       // eslint-disable-next-line no-eval
 366 |       eval(postRootCode);
 367 |       // @ts-ignore
 368 |       const rootFn =
 369 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 370 |       function pushIfScrollable(list, el, labelName) {
 371 |         if (!el) return;
 372 |         const style = window.getComputedStyle(el);
 373 |         if (!style) return;
 374 |         const oy = style.overflowY;
 375 |         const clientH = el.clientHeight || 0;
 376 |         const scrollH = el.scrollHeight || 0;
 377 |         const delta = scrollH - clientH;
 378 |         if (
 379 |           clientH > 0 &&
 380 |           delta > 10 &&
 381 |           (oy === "auto" ||
 382 |             oy === "scroll" ||
 383 |             oy === "overlay" ||
 384 |             oy === "hidden")
 385 |         ) {
 386 |           list.push({ el, label: labelName, delta });
 387 |         }
 388 |       }
 389 |       let container = null;
 390 |       let containerType = null;
 391 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 392 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 393 |       if (cached) {
 394 |         container = cached;
 395 |         containerType = "cached-comments";
 396 |       }
 397 |       // ===== PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy "oficjalny" panel komentarzy =====
 398 |       if (!container && (isPhotoView || isVideoView)) {
 399 |         const moreCommentsBtn = Array.from(
 400 |           document.querySelectorAll(
 401 |             "button, div[role='button'], span[role='button']"
 402 |           )
 403 |         ).find((el) => {
 404 |           const t = (el.textContent || "").toLowerCase();
 405 |           return (
 406 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 407 |             t.includes("zobacz wiƒôcej komentarzy") ||
 408 |             t.includes("view more comments") ||
 409 |             t.includes("view previous comments")
 410 |           );
 411 |         });
 412 |         if (moreCommentsBtn) {
 413 |           let p = moreCommentsBtn.parentElement;
 414 |           while (p && p !== document.body && p !== document.documentElement) {
 415 |             const style = window.getComputedStyle(p);
 416 |             const oy = style.overflowY;
 417 |             const ch = p.clientHeight || 0;
 418 |             const sh = p.scrollHeight || 0;
 419 |             const delta = sh - ch;
 420 |             if (
 421 |               ch > 0 &&
 422 |               delta > 10 &&
 423 |               (oy === "auto" ||
 424 |                 oy === "scroll" ||
 425 |                 oy === "overlay" ||
 426 |                 oy === "hidden")
 427 |             ) {
 428 |               container = p;
 429 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 430 |               break;
 431 |             }
 432 |             p = p.parentElement;
 433 |           }
 434 |         }
 435 |         // VIDEO ‚Äì dodatkowa pr√≥ba: po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 436 |         if (!container && isVideoView) {
 437 |           const commentsHeader = Array.from(
 438 |             document.querySelectorAll("div, span")
 439 |           ).find((el) => {
 440 |             const t = (el.textContent || "").toLowerCase();
 441 |             return (
 442 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 443 |               (t.includes("comments") && t.includes("most relevant")) ||
 444 |               t.trim() === "komentarze" ||
 445 |               t.trim() === "comments"
 446 |             );
 447 |           });
 448 |           if (commentsHeader) {
 449 |             let p = commentsHeader.parentElement;
 450 |             while (p && p !== document.body && p !== document.documentElement) {
 451 |               const style = window.getComputedStyle(p);
 452 |               const oy = style.overflowY;
 453 |               const ch = p.clientHeight || 0;
 454 |               const sh = p.scrollHeight || 0;
 455 |               const delta = sh - ch;
 456 |               if (
 457 |                 ch > 0 &&
 458 |                 delta > 10 &&
 459 |                 (oy === "auto" ||
 460 |                   oy === "scroll" ||
 461 |                   oy === "overlay" ||
 462 |                   oy === "hidden")
 463 |               ) {
 464 |                 container = p;
 465 |                 containerType = "video-comments-header";
 466 |                 break;
 467 |               }
 468 |               p = p.parentElement;
 469 |             }
 470 |           }
 471 |         }
 472 |         // dodatkowy fallback na VIDEO ‚Äì po polu "Napisz komentarz..."
 473 |         if (!container && isVideoView) {
 474 |           const commentBox = Array.from(
 475 |             document.querySelectorAll("div[role='textbox'], textarea")
 476 |           ).find((el) => {
 477 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 478 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 479 |             const txt = (el.textContent || "").toLowerCase();
 480 |             const needles = [
 481 |               "napisz komentarz",
 482 |               "write a comment",
 483 |               "escribe un comentario",
 484 |               "schreibe einen kommentar",
 485 |             ];
 486 |             return needles.some((n) =>
 487 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 488 |             );
 489 |           });
 490 |           if (commentBox) {
 491 |             let p = commentBox.parentElement;
 492 |             while (p && p !== document.body && p !== document.documentElement) {
 493 |               const style = window.getComputedStyle(p);
 494 |               const oy = style.overflowY;
 495 |               const ch = p.clientHeight || 0;
 496 |               const sh = p.scrollHeight || 0;
 497 |               const delta = sh - ch;
 498 |               if (
 499 |                 ch > 0 &&
 500 |                 delta > 10 &&
 501 |                 (oy === "auto" ||
 502 |                   oy === "scroll" ||
 503 |                   oy === "overlay" ||
 504 |                   oy === "hidden")
 505 |               ) {
 506 |                 container = p;
 507 |                 containerType = "video-comments-textbox";
 508 |                 break;
 509 |               }
 510 |               p = p.parentElement;
 511 |             }
 512 |           }
 513 |         }
 514 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì nie ruszamy okna
 515 |         if (isVideoView && !container) {
 516 |           const cur = window.scrollY || 0;
 517 |           return {
 518 |             before: cur,
 519 |             after: cur,
 520 |             container: "video-no-scroll",
 521 |             label: labelArg,
 522 |           };
 523 |         }
 524 |       }
 525 |       // ===== Standardowa heurystyka (permalink / photo fallback) =====
 526 |       if (!container) {
 527 |         const root = rootFn() || document.body;
 528 |         const candidates = [];
 529 |         pushIfScrollable(candidates, root, "root");
 530 |         const dialog =
 531 |           root.closest("div[role='dialog']") ||
 532 |           document.querySelector("div[role='dialog']");
 533 |         if (dialog) {
 534 |           pushIfScrollable(candidates, dialog, "dialog");
 535 |         }
 536 |         const scope = dialog || root;
 537 |         const blocks = Array.from(
 538 |           scope.querySelectorAll("div, section, main, article")
 539 |         );
 540 |         for (const el of blocks) {
 541 |           pushIfScrollable(candidates, el, "auto");
 542 |         }
 543 |         let best = null;
 544 |         for (const c of candidates) {
 545 |           if (!best || c.delta > best.delta) best = c;
 546 |         }
 547 |         if (best) {
 548 |           container = best.el;
 549 |           containerType = best.label;
 550 |         } else {
 551 |           container =
 552 |             document.scrollingElement ||
 553 |             document.documentElement ||
 554 |             document.body;
 555 |           const delta =
 556 |             (container.scrollHeight || 0) - (container.clientHeight || 0);
 557 |           if (delta <= 0) {
 558 |             const cur = container.scrollTop || window.scrollY || 0;
 559 |             return {
 560 |               before: cur,
 561 |               after: cur,
 562 |               container: "window-no-scroll",
 563 |               label: labelArg,
 564 |             };
 565 |           }
 566 |           containerType = "window";
 567 |         }
 568 |       }
 569 |       // Zapamiƒôtujemy kontener komentarzy (≈ºeby kolejne wywo≈Çania go u≈ºy≈Çy)
 570 |       if (container) {
 571 |         const isRootContainer =
 572 |           container === document.body ||
 573 |           container === document.documentElement ||
 574 |           container === document.scrollingElement;
 575 |         if (!isRootContainer) {
 576 |           try {
 577 |             container.setAttribute("data-fbwatcher-comments", "1");
 578 |           } catch {}
 579 |         }
 580 |       }
 581 |       const isWindowContainer =
 582 |         container === document.body ||
 583 |         container === document.documentElement ||
 584 |         container === document.scrollingElement;
 585 |       // na watch nie scrollujemy okna, tylko panel komentarzy
 586 |       if (isVideoView && isWindowContainer) {
 587 |         const cur = window.scrollY || 0;
 588 |         return {
 589 |           before: cur,
 590 |           after: cur,
 591 |           container: "video-window-blocked",
 592 |           label: labelArg,
 593 |         };
 594 |       }
 595 |       const before = isWindowContainer
 596 |         ? window.scrollY || 0
 597 |         : container.scrollTop || 0;
 598 |       const maxScroll =
 599 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 600 |       if (maxScroll <= 0) {
 601 |         return {
 602 |           before,
 603 |           after: before,
 604 |           container: (containerType || "unknown") + "-no-scroll",
 605 |           label: labelArg,
 606 |         };
 607 |       }
 608 |       const factor = factorArg || 0.3;
 609 |       const sign = factor < 0 ? -1 : 1;
 610 |       const magnitude = Math.min(Math.abs(factor), 1);
 611 |       const baseStep =
 612 |         (container.clientHeight || window.innerHeight || 600) * magnitude;
 613 |       // na VIDEO robimy mniejszy krok, ≈ºeby nie przeskakiwaƒá przycisk√≥w
 614 |       let step = Math.max(30, Math.min(baseStep, isVideoView ? 180 : 220));
 615 |       let target;
 616 |       if (sign < 0) {
 617 |         target = Math.max(0, before - step);
 618 |       } else {
 619 |         target = Math.min(maxScroll, before + step);
 620 |       }
 621 |       if (isWindowContainer) {
 622 |         window.scrollTo(0, target);
 623 |       } else {
 624 |         container.scrollTop = target;
 625 |       }
 626 |       const after = isWindowContainer
 627 |         ? window.scrollY || 0
 628 |         : container.scrollTop || 0;
 629 |       return {
 630 |         before,
 631 |         after,
 632 |         container: containerType || "unknown",
 633 |         label: labelArg,
 634 |       };
 635 |     },
 636 |     factor,
 637 |     label,
 638 |     postRootScript()
 639 |   );
 640 |   return info;
 641 | }
 642 | 
 643 | /* ============================================================
 644 |    ======= DOCIƒÑGNIƒòCIE DO ABSOLUTNEGO DO≈ÅU KOMENTARZY =========
 645 |    ============================================================ */
 646 | 
 647 | async function scrollToAbsoluteBottom(page, label = "bottom") {
 648 |   const info = await page.evaluate(
 649 |     (labelArg, postRootCode) => {
 650 |       const href = location.href;
 651 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 652 |         href
 653 |       );
 654 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 655 |       // wstrzykujemy funkcjƒô getPostRoot
 656 |       // eslint-disable-next-line no-eval
 657 |       eval(postRootCode);
 658 |       // @ts-ignore
 659 |       const rootFn =
 660 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 661 |       function pushIfScrollable(list, el, labelName) {
 662 |         if (!el) return;
 663 |         const style = window.getComputedStyle(el);
 664 |         if (!style) return;
 665 |         const oy = style.overflowY;
 666 |         const clientH = el.clientHeight || 0;
 667 |         const scrollH = el.scrollHeight || 0;
 668 |         const delta = scrollH - clientH;
 669 |         if (
 670 |           clientH > 0 &&
 671 |           delta > 10 &&
 672 |           (oy === "auto" ||
 673 |             oy === "scroll" ||
 674 |             oy === "overlay" ||
 675 |             oy === "hidden")
 676 |         ) {
 677 |           list.push({ el, label: labelName, delta });
 678 |         }
 679 |       }
 680 |       let container = null;
 681 |       let containerType = null;
 682 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 683 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 684 |       if (cached) {
 685 |         container = cached;
 686 |         containerType = "cached-comments";
 687 |       }
 688 |       // PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy znale≈∫ƒá panel komentarzy
 689 |       if (!container && (isPhotoView || isVideoView)) {
 690 |         const moreCommentsBtn = Array.from(
 691 |           document.querySelectorAll(
 692 |             "button, div[role='button'], span[role='button']"
 693 |           )
 694 |         ).find((el) => {
 695 |           const t = (el.textContent || "").toLowerCase();
 696 |           return (
 697 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 698 |             t.includes("zobacz wiƒôcej komentarzy") ||
 699 |             t.includes("view more comments") ||
 700 |             t.includes("view previous comments")
 701 |           );
 702 |         });
 703 |         if (moreCommentsBtn) {
 704 |           let p = moreCommentsBtn.parentElement;
 705 |           while (p && p !== document.body && p !== document.documentElement) {
 706 |             const style = window.getComputedStyle(p);
 707 |             const oy = style.overflowY;
 708 |             const ch = p.clientHeight || 0;
 709 |             const sh = p.scrollHeight || 0;
 710 |             const delta = sh - ch;
 711 |             if (
 712 |               ch > 0 &&
 713 |               delta > 10 &&
 714 |               (oy === "auto" || oy === "scroll" || oy === "overlay" || oy === "hidden")
 715 |             ) {
 716 |               container = p;
 717 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 718 |               break;
 719 |             }
 720 |             p = p.parentElement;
 721 |           }
 722 |         }
 723 |         // dodatkowa pr√≥ba po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 724 |         if (!container && isVideoView) {
 725 |           const commentsHeader = Array.from(
 726 |             document.querySelectorAll("div, span")
 727 |           ).find((el) => {
 728 |             const t = (el.textContent || "").toLowerCase();
 729 |             return (
 730 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 731 |               (t.includes("comments") && t.includes("most relevant")) ||
 732 |               t.trim() === "komentarze" ||
 733 |               t.trim() === "comments"
 734 |             );
 735 |           });
 736 |           if (commentsHeader) {
 737 |             let p = commentsHeader.parentElement;
 738 |             while (p && p !== document.body && p !== document.documentElement) {
 739 |               const style = window.getComputedStyle(p);
 740 |               const oy = style.overflowY;
 741 |               const ch = p.clientHeight || 0;
 742 |               const sh = p.scrollHeight || 0;
 743 |               const delta = sh - ch;
 744 |               if (
 745 |                 ch > 0 &&
 746 |                 delta > 10 &&
 747 |                 (oy === "auto" ||
 748 |                   oy === "scroll" ||
 749 |                   oy === "overlay" ||
 750 |                   oy === "hidden")
 751 |               ) {
 752 |                 container = p;
 753 |                 containerType = "video-comments-header";
 754 |                 break;
 755 |               }
 756 |               p = p.parentElement;
 757 |             }
 758 |           }
 759 |         }
 760 |         // NOWY FALLBACK ‚Äì po polu "Napisz komentarz..."
 761 |         if (!container) {
 762 |           const commentBox = Array.from(
 763 |             document.querySelectorAll("div[role='textbox'], textarea")
 764 |           ).find((el) => {
 765 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 766 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 767 |             const txt = (el.textContent || "").toLowerCase();
 768 |             const needles = [
 769 |               "napisz komentarz",
 770 |               "write a comment",
 771 |               "escribe un comentario",
 772 |               "schreibe einen kommentar",
 773 |             ];
 774 |             return needles.some((n) =>
 775 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 776 |             );
 777 |           });
 778 |           if (commentBox) {
 779 |             let p = commentBox.parentElement;
 780 |             while (p && p !== document.body && p !== document.documentElement) {
 781 |               const style = window.getComputedStyle(p);
 782 |               const oy = style.overflowY;
 783 |               const ch = p.clientHeight || 0;
 784 |               const sh = p.scrollHeight || 0;
 785 |               const delta = sh - ch;
 786 |               if (
 787 |                 ch > 0 &&
 788 |                 delta > 10 &&
 789 |                 (oy === "auto" ||
 790 |                   oy === "scroll" ||
 791 |                   oy === "overlay" ||
 792 |                   oy === "hidden")
 793 |               ) {
 794 |                 container = p;
 795 |                 containerType = isPhotoView
 796 |                   ? "photo-comments-textbox"
 797 |                   : "video-comments-textbox";
 798 |                 break;
 799 |               }
 800 |               p = p.parentElement;
 801 |             }
 802 |           }
 803 |         }
 804 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì dajemy spok√≥j
 805 |         if (isVideoView && !container) {
 806 |           const cur = window.scrollY || 0;
 807 |           return {
 808 |             label: labelArg,
 809 |             container: "video-no-scroll",
 810 |             steps: 0,
 811 |             final: cur,
 812 |             maxScroll: 0,
 813 |             atBottom: true,
 814 |           };
 815 |         }
 816 |       }
 817 |       // Standardowa heurystyka (permalink / photo fallback)
 818 |       if (!container) {
 819 |         const root = rootFn() || document.body;
 820 |         const candidates = [];
 821 |         pushIfScrollable(candidates, root, "root");
 822 |         const dialog =
 823 |           root.closest("div[role='dialog']") ||
 824 |           document.querySelector("div[role='dialog']");
 825 |         if (dialog) {
 826 |           pushIfScrollable(candidates, dialog, "dialog");
 827 |         }
 828 |         const scope = dialog || root;
 829 |         const blocks = Array.from(
 830 |           scope.querySelectorAll("div, section, main, article")
 831 |         );
 832 |         for (const el of blocks) {
 833 |           pushIfScrollable(candidates, el, "auto");
 834 |         }
 835 |         let best = null;
 836 |         for (const c of candidates) {
 837 |           if (!best || c.delta > best.delta) {
 838 |             best = c;
 839 |           }
 840 |         }
 841 |         if (best) {
 842 |           container = best.el;
 843 |           containerType = best.label;
 844 |         } else {
 845 |           container =
 846 |             document.scrollingElement ||
 847 |             document.documentElement ||
 848 |             document.body;
 849 |           containerType = "window";
 850 |         }
 851 |       }
 852 |       // Zapamiƒôtaj kontener komentarzy (je≈õli to nie jest globalne okno)
 853 |       if (container) {
 854 |         const isRootContainer =
 855 |           container === document.body ||
 856 |           container === document.documentElement ||
 857 |           container === document.scrollingElement;
 858 |         if (!isRootContainer) {
 859 |           try {
 860 |             container.setAttribute("data-fbwatcher-comments", "1");
 861 |           } catch {}
 862 |         }
 863 |       }
 864 |       const isWindowContainer =
 865 |         container === document.body ||
 866 |         container === document.documentElement ||
 867 |         container === document.scrollingElement;
 868 |       // na watch nie ruszamy globalnego scrolla je≈õli nie mamy innego kontenera
 869 |       if (isVideoView && isWindowContainer) {
 870 |         const cur = window.scrollY || 0;
 871 |         return {
 872 |           label: labelArg,
 873 |           container: "video-window-blocked",
 874 |           steps: 0,
 875 |           final: cur,
 876 |           maxScroll: 0,
 877 |           atBottom: true,
 878 |         };
 879 |       }
 880 |       let steps = 0;
 881 |       const maxSteps = 160;
 882 |       let lastPos = isWindowContainer
 883 |         ? window.scrollY || 0
 884 |         : container.scrollTop || 0;
 885 |       while (steps < maxSteps) {
 886 |         steps++;
 887 |         const maxScroll =
 888 |           (container.scrollHeight || 0) - (container.clientHeight || 0);
 889 |         const pos = isWindowContainer
 890 |           ? window.scrollY || 0
 891 |           : container.scrollTop || 0;
 892 |         // ju≈º na dole
 893 |         if (maxScroll <= 0 || pos >= maxScroll - 2) {
 894 |           return {
 895 |             label: labelArg,
 896 |             container: containerType || "unknown",
 897 |             steps,
 898 |             final: pos,
 899 |             maxScroll,
 900 |             atBottom: true,
 901 |           };
 902 |         }
 903 |         const baseStep =
 904 |           (container.clientHeight || window.innerHeight || 600) * 0.9;
 905 |         const step = Math.max(60, Math.min(baseStep, maxScroll - pos));
 906 |         if (isWindowContainer) {
 907 |           window.scrollTo(0, pos + step);
 908 |         } else {
 909 |           container.scrollTop = pos + step;
 910 |         }
 911 |         const afterPos = isWindowContainer
 912 |           ? window.scrollY || 0
 913 |           : container.scrollTop || 0;
 914 |         // brak ruchu mimo pr√≥by ‚Äì uznajemy ≈ºe jeste≈õmy na dole
 915 |         if (afterPos === lastPos) {
 916 |           return {
 917 |             label: labelArg,
 918 |             container: containerType || "unknown",
 919 |             steps,
 920 |             final: afterPos,
 921 |             maxScroll,
 922 |             atBottom: true,
 923 |           };
 924 |         }
 925 |         lastPos = afterPos;
 926 |       }
 927 |       const maxScrollFinal =
 928 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 929 |       const finalPos = isWindowContainer
 930 |         ? window.scrollY || 0
 931 |         : container.scrollTop || 0;
 932 |       return {
 933 |         label: labelArg,
 934 |         container: containerType || "unknown",
 935 |         steps,
 936 |         final: finalPos,
 937 |         maxScroll: maxScrollFinal,
 938 |         atBottom: finalPos >= maxScrollFinal - 2,
 939 |       };
 940 |     },
 941 |     label,
 942 |     postRootScript()
 943 |   );
 944 |   return info;
 945 | }
 946 | 
 947 | /* ============================================================
 948 |    ===================== VIDEO ‚Äì AUTO PAUSE ====================
 949 |    ============================================================ */
 950 | 
 951 | async function pauseVideoIfAny(page) {
 952 |   try {
 953 |     await page.evaluate(() => {
 954 |       const vids = Array.from(document.querySelectorAll("video"));
 955 |       for (const v of vids) {
 956 |         try {
 957 |           v.autoplay = false;
 958 |           v.removeAttribute("autoplay");
 959 |           v.muted = true;
 960 |           v.pause();
 961 |           if (!isNaN(v.currentTime) && v.currentTime === 0) {
 962 |             v.currentTime = 0.01;
 963 |           }
 964 |         } catch (e) {}
 965 |       }
 966 |     });
 967 |     console.log("[FB] Video pause: zatrzymano wszystkie <video>.");
 968 |   } catch (e) {
 969 |     console.log("[FB] Video pause ‚Äì b≈ÇƒÖd:", e?.message || e);
 970 |   }
 971 | }
 972 | 
 973 | /* ============================================================
 974 |    ======= BRUTALNA DO≈ªYNKA ‚Äì LOAD MORE NA DOLE ================
 975 |    ============================================================ */
 976 | 
 977 | async function clickAllLoadMoreAtBottom(page, view, maxClicks = 300) {
 978 |   // Brutalna do≈ºynka na dole ‚Äì bez scrolla, tylko to, co widaƒá
 979 |   return await page.evaluate(({ isVideo, max }) => {
 980 |     function normalize(text) {
 981 |       return (text || "").toLowerCase().replace(/\s+/g, " ").trim();
 982 |     }
 983 |     function findCommentsRoot() {
 984 |       // Dla watch/reel FB czƒôsto siedzi w g≈Ç√≥wnej kolumnie
 985 |       const main = document.querySelector("div[role='main']");
 986 |       if (!main) return document.body;
 987 |       const article = main.querySelector("article");
 988 |       if (article) return article;
 989 |       return main;
 990 |     }
 991 |     const root = findCommentsRoot();
 992 |     if (!root) return 0;
 993 |     let clicks = 0;
 994 |     for (let i = 0; i < max; i++) {
 995 |       const candidates = Array.from(
 996 |         root.querySelectorAll(
 997 |           "button,div[role='button'],span[role='button'],a[role='button']"
 998 |         )
 999 |       );
1000 |       const btn = candidates.find((el) => {
1001 |         const t = normalize(el.textContent);
1002 |         if (!t) return false;
1003 |         if (t.startsWith("wy≈õwietl wiƒôcej komentarzy")) return true;
1004 |         if (t === "poka≈º wiƒôcej odpowiedzi") return true;
1005 |         if (/^wy≈õwietl wszystkie \d+ odpowiedzi$/.test(t)) return true;
1006 |         if (t === "wy≈õwietl 1 odpowied≈∫") return true;
1007 |         if (/odpowiedzi$/.test(t) && /odpowiedzi/.test(t) && t.includes("odpowiedzia≈Ç")) {
1008 |           return true;
1009 |         }
1010 |         return false;
1011 |       });
1012 |       if (!btn) break;
1013 |       const rect = btn.getBoundingClientRect();
1014 |       if (rect.bottom < 0 || rect.top > window.innerHeight) break;
1015 |       btn.click();
1016 |       clicks++;
1017 |     }
1018 |     return clicks;
1019 |   }, { isVideo: !!view.isVideo, max: maxClicks });
1020 | }
1021 | 
1022 | /* ============================================================
1023 |    ======= AGRESYWNE DO≈ÅADOWANIE WSZYSTKICH KOMENTARZY =========
1024 |    ============================================================ */
1025 | 
1026 | async function ensureAllCommentsLoaded(page, expectedTotal = null) {
1027 |   // expectedTotal tylko do log√≥w ‚Äì NIE jest twardym warunkiem stopu
1028 |   const hasTarget = typeof expectedTotal === "number" && expectedTotal > 0;
1029 |   const view = await page.evaluate(() => {
1030 |     const href = location.href;
1031 |     const isWatch = href.includes("/watch/");
1032 |     const isVideo = isWatch || /\/watch\/|\/videos\/|[\?&]v=/i.test(href); // üëà dodane /videos/
1033 |     const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
1034 |       href
1035 |     );
1036 |     return { href, isWatch, isVideo, isPhoto };
1037 |   });
1038 |   console.log(
1039 |     "[FB] ensureAllCommentsLoaded ‚Äì start",
1040 |     hasTarget ? `(target=${expectedTotal})` : "(bez targetu)",
1041 |     "| view:",
1042 |     view
1043 |   );
1044 |   const MAX_ROUNDS = view.isVideo ? 1500 : 2500;
1045 |   const MAX_NO_PROGRESS = 10; // ile rund bez progresu zanim uznamy, ≈ºe koniec
1046 |   let noProgressRounds = 0;
1047 |   let roundsDone = 0;
1048 |   let lastAnchors = 0;
1049 |   let breakReason = "max-rounds";
1050 |   // helper ‚Äì czy na stronie sƒÖ jeszcze przyciski load-more/replies
1051 |   async function hasLoadMoreButtons() {
1052 |     return await page.evaluate(() => {
1053 |       const phrases = [
1054 |         "wy≈õwietl wiƒôcej komentarzy",
1055 |         "wy≈õwietl wszystkie",
1056 |         "wy≈õwietl wszystkie odpowiedzi",
1057 |         "wy≈õwietl odpowiedzi",
1058 |         "zobacz wiƒôcej komentarzy",
1059 |         "view more comments",
1060 |         "view more replies",
1061 |         "see more comments",
1062 |         "see more replies",
1063 |       ];
1064 |       const btns = Array.from(
1065 |         document.querySelectorAll("button, div[role='button'], span[role='button'], a")
1066 |       );
1067 |       return btns.some((el) => {
1068 |         const txt = (el.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
1069 |         if (!txt) return false;
1070 |         return phrases.some((p) => txt.includes(p));
1071 |       });
1072 |     });
1073 |   }
1074 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
1075 |     const beforeAnchors = await getCurrentCommentAnchorCount(page);
1076 |     // scrollujemy TYLKO przez scrollWithinPost ‚Äì on ogarnia kontener komentarzy
1077 |     const scrollInfo = await scrollWithinPost(
1078 |       page,
1079 |       `round-${round}`,
1080 |       view.isVideo ? 0.18 : 0.25
1081 |     );
1082 |     const clicks = await expandAllComments(page);
1083 |     const afterAnchors = await getCurrentCommentAnchorCount(page);
1084 |     const moreButtons = await hasLoadMoreButtons();
1085 |     const scrolled = scrollInfo.after !== scrollInfo.before;
1086 |     const progressed =
1087 |       scrolled || clicks > 0 || afterAnchors > beforeAnchors;
1088 |     if (progressed) {
1089 |       noProgressRounds = 0;
1090 |       lastAnchors = afterAnchors;
1091 |     } else {
1092 |       noProgressRounds++;
1093 |     }
1094 |     roundsDone = round;
1095 |     if (round === 1 || round % 25 === 0 || round > MAX_ROUNDS - 5) {
1096 |       console.log(
1097 |         `[FB] ensureAllCommentsLoaded ‚Äì round ${round} ` +
1098 |           `container=${scrollInfo.container} ` +
1099 |           `scrollTop: ${scrollInfo.before} ‚Üí ${scrollInfo.after} ` +
1100 |           `anchors: ${beforeAnchors} ‚Üí ${afterAnchors} ` +
1101 |           `clicks=${clicks} noProgress=${noProgressRounds} moreButtons=${moreButtons}`
1102 |       );
1103 |     }
1104 |     if (hasTarget && afterAnchors >= expectedTotal && !moreButtons) {
1105 |       breakReason = "target-reached-no-buttons";
1106 |       break;
1107 |     }
1108 |     if (!moreButtons && noProgressRounds >= MAX_NO_PROGRESS) {
1109 |       breakReason = "no-buttons-no-progress";
1110 |       break;
1111 |     }
1112 |     if (noProgressRounds >= MAX_NO_PROGRESS * 2) {
1113 |       breakReason = "hard-no-progress";
1114 |       break;
1115 |     }
1116 |     await sleepRandom(250, 600);
1117 |   }
1118 |   console.log(
1119 |     "[FB] ensureAllCommentsLoaded ‚Äì g≈Ç√≥wna pƒôtla:",
1120 |     `reason=${breakReason}, rounds=${roundsDone}, anchors=${lastAnchors}${
1121 |       hasTarget ? `/target=${expectedTotal}` : ""
1122 |     }`
1123 |   );
1124 |   // Runda kontrolna w g√≥rƒô ‚Äì domykamy expandy ‚Äûu g√≥ry‚Äù
1125 |   try {
1126 |     let ctrlReason = "max-ctrl-rounds";
1127 |     for (let i = 1; i <= 200; i++) {
1128 |       const up = await scrollWithinPost(page, `ctrl-up-${i}`, -0.55);
1129 |       const clicked = await clickOneExpandButton(page);
1130 |       await sleepRandom(160, 320);
1131 |       if (up.after === 0) {
1132 |         ctrlReason = "top-reached";
1133 |         break;
1134 |       }
1135 |       if (up.after === up.before && !clicked) {
1136 |         ctrlReason = "no-move-no-click";
1137 |         break;
1138 |       }
1139 |     }
1140 |     console.log("[FB] ensureAllCommentsLoaded ‚Äì runda kontrolna:", ctrlReason);
1141 |   } catch (e) {
1142 |     console.log(
1143 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd w rundzie kontrolnej:",
1144 |       e?.message || e
1145 |     );
1146 |   }
1147 |   let bottomClicks = 0;
1148 |   let lastBottomPos = null;
1149 |   let stableRounds = 0;
1150 |   try {
1151 |     for (let i = 1; i <= 400; i++) {
1152 |       const info = await scrollWithinPost(
1153 |         page,
1154 |         `final-bottom-${i}`,
1155 |         view.isVideo ? 0.6 : 0.8
1156 |       );
1157 |       if (lastBottomPos === info.after) {
1158 |         stableRounds++;
1159 |       } else {
1160 |         stableRounds = 0;
1161 |       }
1162 |       lastBottomPos = info.after;
1163 |       if (i === 1 || i % 50 === 0) {
1164 |         console.log(
1165 |           `[FB] ensureAllCommentsLoaded ‚Äì final-bottom step ${i}: container=${info.container}, ` +
1166 |             `scrollTop: ${info.before} ‚Üí ${info.after}`
1167 |         );
1168 |       }
1169 |       if (stableRounds >= 3) break;
1170 |       await sleepRandom(120, 260);
1171 |     }
1172 |     const bottomExpand = await expandAllComments(page);
1173 |     const extraClicks = await clickAllLoadMoreAtBottom(page, view, 300);
1174 |     bottomClicks = bottomExpand + extraClicks;
1175 |     if (bottomClicks > 0) {
1176 |       console.log(
1177 |         `[FB] ensureAllCommentsLoaded ‚Äì bottom pass: expand=${bottomExpand}, extra=${extraClicks}, total=${bottomClicks}`
1178 |       );
1179 |       await sleepRandom(700, 1300);
1180 |     }
1181 |   } catch (e) {
1182 |     console.log(
1183 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd przy final bottom:",
1184 |       e?.message || e
1185 |     );
1186 |   }
1187 |   const finalAnchors = await getCurrentCommentAnchorCount(page);
1188 |   console.log(
1189 |     "[FB] ensureAllCommentsLoaded ‚Äì koniec. anchors=",
1190 |     finalAnchors,
1191 |     "bottomClicks=",
1192 |     bottomClicks
1193 |   );
1194 | }
1195 | 
1196 | /* ============================================================
1197 |    ==================== WIƒòCEJ KOMENTARZY (VIDEO) ===============
1198 |    ============================================================ */
1199 | 
1200 | async function clickMoreCommentsButtonsVideo(page, maxLoops = 80) {
1201 |   console.log(
1202 |     "[FB][more-comments] Start klikania 'Wy≈õwietl wiƒôcej komentarzy / odpowiedzi' (video)‚Ä¶"
1203 |   );
1204 |   for (let i = 0; i < maxLoops; i++) {
1205 |     const result = await page.evaluate(() => {
1206 |       const norm = (s) =>
1207 |         (s || "")
1208 |           .replace(/\s+/g, " ")
1209 |           .trim()
1210 |           .toLowerCase();
1211 |       function getPostRoot() {
1212 |         // 1) overlay z postem / video
1213 |         const dialogs = Array.from(
1214 |           document.querySelectorAll("div[role='dialog']")
1215 |         );
1216 |         for (const dlg of dialogs) {
1217 |           const txt = (dlg.innerText || dlg.textContent || "").toLowerCase();
1218 |           if (!txt) continue;
1219 |           if (
1220 |             txt.includes("komentarz") ||
1221 |             txt.includes("comments") ||
1222 |             txt.includes("napisz komentarz")
1223 |           ) {
1224 |             const art = dlg.querySelector("article");
1225 |             return art || dlg;
1226 |           }
1227 |         }
1228 |         // 2) strona "Filmy" ‚Äì g≈Ç√≥wny artyku≈Ç
1229 |         const main = document.querySelector("main");
1230 |         if (main) {
1231 |           const art = main.querySelector("article");
1232 |           if (art) return art;
1233 |           return main;
1234 |         }
1235 |         // 3) fallback
1236 |         return document.body || document;
1237 |       }
1238 |       const root = getPostRoot();
1239 |       const MORE_COMMENTS_LABELS = [
1240 |         "wy≈õwietl wiƒôcej komentarzy",
1241 |         "zobacz wiƒôcej komentarzy",
1242 |         "view more comments",
1243 |         "view previous comments",
1244 |         "see more comments",
1245 |       ];
1246 |       const REPLY_LABELS = [
1247 |         "wy≈õwietl wiƒôcej odpowiedzi",
1248 |         "zobacz wiƒôcej odpowiedzi",
1249 |         "view more replies",
1250 |         "see more replies",
1251 |       ];
1252 |       const els = Array.from(
1253 |         root.querySelectorAll(
1254 |           "button, div[role='button'], span[role='button'], span"
1255 |         )
1256 |       );
1257 |       let target = null;
1258 |       let kind = null;
1259 |       // 1) priorytet: "Wy≈õwietl wiƒôcej komentarzy"
1260 |       for (const el of els) {
1261 |         const txt = norm(el.textContent);
1262 |         if (!txt) continue;
1263 |         if (MORE_COMMENTS_LABELS.includes(txt)) {
1264 |           const rect = el.getBoundingClientRect();
1265 |           if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1266 |           target = el;
1267 |           kind = "comments";
1268 |           break;
1269 |         }
1270 |       }
1271 |       // 2) je≈õli nie ma "wiƒôcej komentarzy" ‚Äì szukamy "wiƒôcej/X odpowiedzi"
1272 |       if (!target) {
1273 |         for (const el of els) {
1274 |           const txt = norm(el.textContent);
1275 |           if (!txt) continue;
1276 |           if (REPLY_LABELS.includes(txt)) {
1277 |             const rect = el.getBoundingClientRect();
1278 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1279 |             target = el;
1280 |             kind = "replies";
1281 |             break;
1282 |           }
1283 |           if (
1284 |             /(^|\s)\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(txt) ||
1285 |             (txt.includes(" replies") && /\d+/.test(txt))
1286 |           ) {
1287 |             const rect = el.getBoundingClientRect();
1288 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
1289 |             target = el;
1290 |             kind = "replies";
1291 |             break;
1292 |           }
1293 |         }
1294 |       }
1295 |       if (!target) {
1296 |         return { clicked: false, kind: null };
1297 |       }
1298 |       try {
1299 |         target.scrollIntoView({ block: "center", inline: "nearest" });
1300 |       } catch (e) {
1301 |         // ignorujemy
1302 |       }
1303 |       if (typeof target.click === "function") {
1304 |         target.click();
1305 |         return { clicked: true, kind };
1306 |       }
1307 |       return { clicked: false, kind: null };
1308 |     });
1309 |     if (!result || !result.clicked) {
1310 |       if (i === 0) {
1311 |         console.log(
1312 |           "[FB][more-comments] Brak przycisk√≥w 'wiƒôcej komentarzy/odpowiedzi' ‚Äì nic nie klikam."
1313 |         );
1314 |       } else {
1315 |         console.log(
1316 |           `[FB][more-comments] Brak kolejnych przycisk√≥w ‚Äì zako≈Ñczono po ${i} klikniƒôciach.`
1317 |         );
1318 |       }
1319 |       break;
1320 |     }
1321 |     const what =
1322 |       result.kind === "replies"
1323 |         ? "wiƒôcej odpowiedzi / X odpowiedzi"
1324 |         : "wiƒôcej komentarzy";
1325 |     console.log(
1326 |       `[FB][more-comments] Klikniƒôto '${what}' (iteracja ${i + 1}/${maxLoops}).`
1327 |     );
1328 |     await sleepRandom(900, 1600);
1329 |     try {
1330 |       await scrollWithinPost(page, `video-more-${i + 1}`, 0.18);
1331 |     } catch (e) {
1332 |       console.log(
1333 |         "[FB][more-comments] scrollWithinPost(video) ‚Äì b≈ÇƒÖd:",
1334 |         e?.message || e
1335 |       );
1336 |     }
1337 |     await sleepRandom(800, 1400);
1338 |   }
1339 |   console.log(
1340 |     `[FB][more-comments] Zako≈Ñczono sekwencjƒô video (maxLoops=${maxLoops}).`
1341 |   );
1342 | }
1343 | 
1344 | /* ============================================================
1345 |    ================= SEKWENCYJNY SPACER (VIDEO) =================
1346 |    ============================================================ */
1347 | 
1348 | async function walkVideoCommentsSequential(page, maxCycles = 40) {
1349 |   console.log("[FB][video-walk] start ‚Äì sekwencyjny spacer po komentarzach (VIDEO)‚Ä¶");
1350 | 
1351 |   let noProgressStreak = 0;
1352 | 
1353 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
1354 |     const result = await page.evaluate(() => {
1355 |       const norm = (s) =>
1356 |         String(s || "")
1357 |           .replace(/\u00a0/g, " ")
1358 |           .replace(/\s+/g, " ")
1359 |           .trim()
1360 |           .toLowerCase();
1361 | 
1362 |       const isVisible = (el) => {
1363 |         if (!el) return false;
1364 |         const st = window.getComputedStyle(el);
1365 |         if (!st) return true;
1366 |         if (st.display === "none" || st.visibility === "hidden") return false;
1367 |         return true;
1368 |       };
1369 | 
1370 |       function getLabel(el) {
1371 |         if (!el) return "";
1372 |         const a = el.getAttribute?.("aria-label");
1373 |         if (a) return a;
1374 |         return el.textContent || "";
1375 |       }
1376 | 
1377 |       function findClickable(el, maxUp = 8) {
1378 |         let cur = el;
1379 |         for (let i = 0; i < maxUp && cur; i++) {
1380 |           const role = cur.getAttribute?.("role");
1381 |           const tag = (cur.tagName || "").toLowerCase();
1382 |           if (tag === "button" || tag === "a" || role === "button") return cur;
1383 |           cur = cur.parentElement;
1384 |         }
1385 |         return el; // fallback
1386 |       }
1387 | 
1388 |       function getPostRoot() {
1389 |         // 1) dialog / overlay (czƒôste przy video)
1390 |         const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
1391 |         for (const dlg of dialogs) {
1392 |           const txt = norm(dlg.innerText || dlg.textContent);
1393 |           if (!txt) continue;
1394 |           if (txt.includes("komentarz") || txt.includes("comments") || txt.includes("napisz komentarz")) {
1395 |             const art = dlg.querySelector("article");
1396 |             return art || dlg;
1397 |           }
1398 |         }
1399 | 
1400 |         // 2) klasyczny main
1401 |         const main = document.querySelector("main, div[role='main']");
1402 |         if (main) {
1403 |           const art = main.querySelector("article");
1404 |           return art || main;
1405 |         }
1406 | 
1407 |         return document.body || document.documentElement;
1408 |       }
1409 | 
1410 |       // REALNY test scrollowalno≈õci: pr√≥bujemy ruszyƒá scrollTop i sprawdzamy czy siƒô zmieni≈Ç.
1411 |       function canScrollByTest(el) {
1412 |         try {
1413 |           if (!el) return false;
1414 |           const h = el.clientHeight || 0;
1415 |           const sh = el.scrollHeight || 0;
1416 |           if (sh <= h + 40) return false;
1417 | 
1418 |           const before = el.scrollTop ?? 0;
1419 |           el.scrollTop = before + 50;
1420 |           const after = el.scrollTop ?? before;
1421 | 
1422 |           // przywr√≥ƒá (≈ºeby nie rozje≈ºd≈ºaƒá)
1423 |           el.scrollTop = before;
1424 | 
1425 |           return after !== before;
1426 |         } catch (e) {
1427 |           return false;
1428 |         }
1429 |       }
1430 | 
1431 |       function getCommentsContainerSmart(root) {
1432 |   // cache kontenera miƒôdzy cyklami (FB czƒôsto rerenderuje, ale referencja zwykle ≈ºyje chwilƒô)
1433 |   function isInDom(el) {
1434 |     try {
1435 |       return !!el && document.contains(el);
1436 |     } catch (e) {
1437 |       return false;
1438 |     }
1439 |   }
1440 | 
1441 |   function canScrollByTest(el) {
1442 |     try {
1443 |       if (!el) return false;
1444 |       const h = el.clientHeight || 0;
1445 |       const sh = el.scrollHeight || 0;
1446 |       if (sh <= h + 40) return false;
1447 | 
1448 |       const before = el.scrollTop ?? 0;
1449 |       el.scrollTop = before + 50;
1450 |       const after = el.scrollTop ?? before;
1451 |       el.scrollTop = before;
1452 | 
1453 |       return after !== before;
1454 |     } catch (e) {
1455 |       return false;
1456 |     }
1457 |   }
1458 | 
1459 |   // 0) spr√≥buj u≈ºyƒá ostatniego dobrego kontenera
1460 |   const cached = window.__FBW_VIDEO_COMMENTS_CONTAINER;
1461 |   if (isInDom(cached) && canScrollByTest(cached)) {
1462 |     return cached;
1463 |   }
1464 | 
1465 |   // 1) normalne szukanie
1466 |   const scopes = [root, document.body, document.documentElement].filter(Boolean);
1467 | 
1468 |   let best = null;
1469 |   let bestScore = -1;
1470 | 
1471 |   for (const scope of scopes) {
1472 |     const divs = Array.from(scope.querySelectorAll("div"))
1473 |       .filter(isVisible)
1474 |       .slice(0, 16000);
1475 | 
1476 |     for (const el of divs) {
1477 |       if (!canScrollByTest(el)) continue;
1478 | 
1479 |       const h = el.clientHeight || 0;
1480 |       const sh = el.scrollHeight || 0;
1481 |       const delta = sh - h;
1482 | 
1483 |       const t = norm(el.innerText || "");
1484 |       const hasCommentWords =
1485 |         t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
1486 | 
1487 |       const score = delta + (hasCommentWords ? 9000 : 0);
1488 | 
1489 |       if (score > bestScore) {
1490 |         bestScore = score;
1491 |         best = el;
1492 |       }
1493 |     }
1494 | 
1495 |     if (best) break;
1496 |   }
1497 | 
1498 |   // 2) cache
1499 |   if (best) {
1500 |     window.__FBW_VIDEO_COMMENTS_CONTAINER = best;
1501 |     return best;
1502 |   }
1503 | 
1504 |   return document.scrollingElement || document.documentElement || root;
1505 | }
1506 | 
1507 | 
1508 |       function clickMoreCommentsOnce(scope) {
1509 |         const LABELS = [
1510 |           "wy≈õwietl wiƒôcej komentarzy",
1511 |           "zobacz wiƒôcej komentarzy",
1512 |           "view more comments",
1513 |           "see more comments",
1514 |           "show more comments",
1515 |         ];
1516 | 
1517 |         const nodes = Array.from(
1518 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1519 |         )
1520 |           .filter(isVisible)
1521 |           .slice(0, 30000);
1522 | 
1523 |         for (const el of nodes) {
1524 |           const txt = norm(getLabel(el));
1525 |           if (!txt) continue;
1526 | 
1527 |           const hit = LABELS.some((w) => txt.includes(w));
1528 |           if (!hit) continue;
1529 | 
1530 |           const btn = findClickable(el);
1531 | 
1532 |           try {
1533 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1534 |           } catch (e) {}
1535 | 
1536 |           try {
1537 |             btn.click();
1538 |             return true;
1539 |           } catch (e) {}
1540 |         }
1541 |         return false;
1542 |       }
1543 | 
1544 |       function expandReplies(scope, limit = 35) {
1545 |         const nodes = Array.from(
1546 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
1547 |         )
1548 |           .filter(isVisible)
1549 |           .slice(0, 40000);
1550 | 
1551 |         let clicked = 0;
1552 | 
1553 |         for (const el of nodes) {
1554 |           const txt = norm(getLabel(el));
1555 |           if (!txt) continue;
1556 | 
1557 |           const isMoreReplies =
1558 |             txt.includes("wiƒôcej odpowiedzi") ||
1559 |             txt.includes("more replies") ||
1560 |             txt.includes("view previous replies") ||
1561 |             txt.includes("zobacz odpowiedzi") ||
1562 |             txt.includes("show replies");
1563 | 
1564 |           // ≈Çapie ‚Äú12 odpowiedzi‚Äù, ale te≈º warianty z dodatkami
1565 |           const isCountReplies = /\b\d+\s+(odpowied≈∫|odpowiedzi|repl(y|ies))\b/.test(txt);
1566 | 
1567 |           if (!isMoreReplies && !isCountReplies) continue;
1568 | 
1569 |           const btn = findClickable(el);
1570 | 
1571 |           try {
1572 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
1573 |           } catch (e) {}
1574 | 
1575 |           try {
1576 |             btn.click();
1577 |             clicked++;
1578 |             if (clicked >= limit) break;
1579 |           } catch (e) {}
1580 |         }
1581 | 
1582 |         return clicked;
1583 |       }
1584 | 
1585 |       function scrollSomewhere(container) {
1586 |         const beforeC = container?.scrollTop ?? 0;
1587 |         const beforeW = window.scrollY ?? 0;
1588 | 
1589 |         const step = Math.max(300, (container?.clientHeight || 0) * 0.8, 700);
1590 | 
1591 |         // 1) pr√≥buj na kontenerze
1592 |         try {
1593 |           if (container && typeof container.scrollTop === "number") {
1594 |             container.scrollTop = Math.min(beforeC + step, container.scrollHeight || beforeC + step);
1595 |           }
1596 |         } catch (e) {}
1597 | 
1598 |         const afterC = container?.scrollTop ?? beforeC;
1599 | 
1600 |         // 2) jak nie ruszy≈Ço ‚Äì pr√≥buj window
1601 |         if (afterC === beforeC) {
1602 |           try {
1603 |             window.scrollBy(0, step);
1604 |           } catch (e) {}
1605 |         }
1606 | 
1607 |         const afterW = window.scrollY ?? beforeW;
1608 | 
1609 |         return {
1610 |           beforeC,
1611 |           afterC,
1612 |           beforeW,
1613 |           afterW,
1614 |           scrolled: afterC !== beforeC || afterW !== beforeW,
1615 |         };
1616 |       }
1617 | 
1618 |       const root = getPostRoot();
1619 |       const container = getCommentsContainerSmart(root);
1620 | 
1621 |       // WA≈ªNE: na video czƒôsto ‚Äúwiƒôcej komentarzy‚Äù jest poza root ‚Üí szukamy i w body
1622 |       let clickedMore = clickMoreCommentsOnce(root);
1623 |       if (!clickedMore) clickedMore = clickMoreCommentsOnce(document.body);
1624 | 
1625 |       // ‚Äú12 odpowiedzi‚Äù te≈º potrafi byƒá poza root
1626 |       const repliesClickedRoot = expandReplies(root, 35);
1627 |       const repliesClickedBody = expandReplies(document.body, Math.max(0, 35 - repliesClickedRoot));
1628 |       const repliesClicked = repliesClickedRoot + repliesClickedBody;
1629 | 
1630 |       const scrollRes = scrollSomewhere(container);
1631 | 
1632 |       const hasButtons = clickedMore || repliesClicked > 0;
1633 | 
1634 |       return {
1635 |         clickedMore,
1636 |         repliesClicked,
1637 |         scrolled: scrollRes.scrolled,
1638 |         hasButtons,
1639 |         dbg: {
1640 |           beforeC: scrollRes.beforeC,
1641 |           afterC: scrollRes.afterC,
1642 |           beforeW: scrollRes.beforeW,
1643 |           afterW: scrollRes.afterW,
1644 |           containerTag: container?.tagName || null,
1645 |         },
1646 |       };
1647 |     });
1648 | 
1649 |     console.log(
1650 |       `[FB][video-walk] cycle ${cycle}: more=${result.clickedMore}, replies=${result.repliesClicked}, scrolled=${result.scrolled} | dbg=${JSON.stringify(result.dbg)}`
1651 |     );
1652 | 
1653 |     // Stop dopiero po 3 pustych cyklach (FB czƒôsto ≈Çaduje leniwie)
1654 |     if (!result.hasButtons && !result.scrolled) {
1655 |       noProgressStreak++;
1656 |       console.log(`[FB][video-walk] no-progress streak = ${noProgressStreak}/3`);
1657 |       if (noProgressStreak >= 3) {
1658 |         console.log("[FB][video-walk] stop ‚Äì 3x brak przycisk√≥w i brak scrolla.");
1659 |         break;
1660 |       }
1661 |     } else {
1662 |       noProgressStreak = 0;
1663 |     }
1664 | 
1665 |     await sleepRandom(1200, 2000);
1666 |   }
1667 | 
1668 |   console.log("[FB][video-walk] koniec spaceru po komentarzach VIDEO.");
1669 | }
1670 | 
1671 | 
1672 | 
1673 | /* ============================================================
1674 |    ==================== LICZBA KOMENTARZY ======================
1675 |    ============================================================ */
1676 | 
1677 | async function getCommentCount(page, postUrl) {
1678 |   console.log(`[FB] Otwieranie posta: ${postUrl}`);
1679 |   const ok = await safeGoto(page, postUrl, "post", {
1680 |     waitUntil: "networkidle2",
1681 |     timeout: NAV_TIMEOUT_MS,
1682 |   });
1683 |   if (!ok) {
1684 |     throw new Error("safeGoto-failed");
1685 |   }
1686 |   let currentUrl = page.url();
1687 |   if (currentUrl.includes("/login")) {
1688 |     console.log(
1689 |       "[FB] Zamiast posta wylƒÖdowa≈Çem na /login?next=... ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1690 |     );
1691 |     await fbLogin(page);
1692 |     await sleepRandom(3000, 4500);
1693 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
1694 |     console.log(
1695 |       "[FB] Stan sesji po fbLogin() z /login:",
1696 |       loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1697 |     );
1698 |     if (loggedAfterLogin) {
1699 |       await safeGoto(page, postUrl, "post", {
1700 |         waitUntil: "networkidle2",
1701 |         timeout: NAV_TIMEOUT_MS,
1702 |       });
1703 |     } else {
1704 |       console.log(
1705 |         "[FB] Po fbLogin() z /login nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1706 |       );
1707 |     }
1708 |   }
1709 |   await acceptCookies(page, "post-initial");
1710 |   let loggedOnPost = false;
1711 |   try {
1712 |     loggedOnPost = await checkIfLogged(page);
1713 |   } catch (e) {
1714 |     console.log(
1715 |       "[FB] checkIfLogged na widoku posta ‚Äì b≈ÇƒÖd:",
1716 |       e?.message || e
1717 |     );
1718 |   }
1719 |   if (!loggedOnPost) {
1720 |     console.log(
1721 |       "[FB] Na widoku posta brak aktywnej sesji (np. pasek 'Zaloguj siƒô') ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
1722 |     );
1723 |     await fbLogin(page);
1724 |     await sleepRandom(3000, 4500);
1725 |     const loggedAfterFbLogin = await checkIfLogged(page).catch(() => false);
1726 |     console.log(
1727 |       "[FB] Stan sesji po fbLogin() z widoku posta:",
1728 |       loggedAfterFbLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
1729 |     );
1730 |     if (loggedAfterFbLogin) {
1731 |       console.log(
1732 |         "[FB] Po fbLogin() wykryto zalogowanego u≈ºytkownika ‚Äì ponownie otwieram posta."
1733 |       );
1734 |       await safeGoto(page, postUrl, "post", {
1735 |         waitUntil: "networkidle2",
1736 |         timeout: NAV_TIMEOUT_MS,
1737 |       });
1738 |       await acceptCookies(page, "post-initial");
1739 |     } else {
1740 |       console.log(
1741 |         "[FB] Po fbLogin() nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
1742 |       );
1743 |     }
1744 |   }
1745 |   await ensureLoggedInOnPostOverlay(page);
1746 |   await sleepRandom(3000, 4500);
1747 |   await acceptCookies(page, "post");
1748 |   try {
1749 |     const loggedAfterPostOverlay = await checkIfLogged(page);
1750 |     if (loggedAfterPostOverlay) {
1751 |       console.log(
1752 |         "[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."
1753 |       );
1754 |       await saveCookies(page);
1755 |     } else {
1756 |       console.log(
1757 |         "[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."
1758 |       );
1759 |     }
1760 |   } catch (e) {
1761 |     console.log(
1762 |       "[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",
1763 |       e?.message || e
1764 |     );
1765 |   }
1766 |   await sleepRandom(1500, 2500);
1767 |   const isWatchView = postUrl.includes("/watch/");
1768 |   const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(postUrl);
1769 |   const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(postUrl);
1770 |   console.log(
1771 |     "[FB] getCommentCount ‚Äì view type:",
1772 |     isWatchView ? "WATCH" : isVideoView ? "VIDEO" : isPhotoView ? "PHOTO" : "POST"
1773 |   );
1774 |   if (isVideoView) {
1775 |     await pauseVideoIfAny(page);
1776 |     await clickShowAllCommentsIfPresent(page);
1777 |   }
1778 |   if (!isVideoView) {
1779 |     await scrollPost(page, 200);
1780 |     await sleepRandom(800, 1200);
1781 |   }
1782 |   try {
1783 |     const okFilter = await switchCommentsFilterToAll(page);
1784 |     console.log(
1785 |       "[FB] Pierwsza pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1786 |       okFilter
1787 |     );
1788 |     if (okFilter) await sleepRandom(1200, 2000);
1789 |   } catch (e) {
1790 |     console.log(
1791 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",
1792 |       e.message
1793 |     );
1794 |   }
1795 |   if (isVideoView) {
1796 |     await pauseVideoIfAny(page);
1797 |   }
1798 |   const uiInfo = await getUiCommentInfo(page);
1799 |   console.log("[DBG] Comments debug (skr√≥cone):", {
1800 |     source: uiInfo?.source,
1801 |     raw: uiInfo?.raw,
1802 |     viewType: uiInfo?.viewType,
1803 |     comments: uiInfo?.comments,
1804 |   });
1805 |   let expectedTotal = null;
1806 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
1807 |     expectedTotal = uiInfo.comments;
1808 |   }
1809 |   if (isVideoView) {
1810 |     await clickMoreCommentsButtonsVideo(page);
1811 |   }
1812 |   if (isVideoView) {
1813 |     await walkVideoCommentsSequential(page, expectedTotal || null);
1814 |   } else {
1815 |     await ensureAllCommentsLoaded(page, expectedTotal);
1816 |   }
1817 |   try {
1818 |     const ok2 = await switchCommentsFilterToAll(page);
1819 |     console.log(
1820 |       "[FB] Druga pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
1821 |       ok2
1822 |     );
1823 |     if (ok2) await sleepRandom(800, 1500);
1824 |   } catch (e) {
1825 |     console.log(
1826 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",
1827 |       e.message
1828 |     );
1829 |   }
1830 |   const fallback = await page.evaluate(() => {
1831 |     const root = document;
1832 |     const anchors = Array.from(
1833 |       root.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
1834 |     );
1835 |     const ids = new Set();
1836 |     for (const a of anchors) {
1837 |       try {
1838 |         const url = new URL(a.href);
1839 |         const cid = url.searchParams.get("comment_id");
1840 |         const rid = url.searchParams.get("reply_comment_id");
1841 |         let raw = rid || cid;
1842 |         if (!raw) continue;
1843 |         if (!/^\d+$/.test(raw)) {
1844 |           try {
1845 |             const dec = atob(raw);
1846 |             const m = dec.match(/:(\d+)_([0-9]+)/);
1847 |             if (m) raw = m[2];
1848 |           } catch {}
1849 |         }
1850 |         if (raw) ids.add(raw);
1851 |       } catch {}
1852 |     }
1853 |     return { count: ids.size };
1854 |   });
1855 |   console.log("[FB] Fallback ‚Äì anchor IDs:", fallback.count);
1856 |   let finalNum = uiInfo?.comments ?? null;
1857 |   if (fallback.count > 0) {
1858 |     if (finalNum == null || finalNum === 0) {
1859 |       finalNum = fallback.count;
1860 |       console.log(
1861 |         "[FB] UI puste/0 ‚Äì u≈ºywam anchor√≥w jako ≈∫r√≥d≈Ça.",
1862 |         `anchor=${fallback.count}`
1863 |       );
1864 |     } else {
1865 |       const diff = finalNum - fallback.count;
1866 |       if (diff > 5) {
1867 |         console.log(
1868 |           "[FB] UI >> anchory ‚Äì czƒô≈õƒá komentarzy niedostƒôpna, u≈ºywam anchor√≥w.",
1869 |           `ui=${finalNum}, anchor=${fallback.count}`
1870 |         );
1871 |         finalNum = fallback.count;
1872 |       } else if (fallback.count > finalNum) {
1873 |         console.log(
1874 |           "[FB] Anchory > UI ‚Äì u≈ºywam anchor√≥w jako bazowej liczby.",
1875 |           `ui=${finalNum}, anchor=${fallback.count}`
1876 |         );
1877 |         finalNum = fallback.count;
1878 |       } else {
1879 |         console.log(
1880 |           "[FB] UI ~= anchory ‚Äì zostawiam UI jako ≈∫r√≥d≈Ço.",
1881 |           `ui=${finalNum}, anchor=${fallback.count}`
1882 |         );
1883 |       }
1884 |     }
1885 |   } else {
1886 |     console.log("[FB] Anchory=0 ‚Äì opieram siƒô wy≈ÇƒÖcznie na UI:", finalNum);
1887 |   }
1888 |   if (finalNum != null) {
1889 |     console.log("[FB] Liczba komentarzy (final):", finalNum);
1890 |     return finalNum;
1891 |   }
1892 |   console.log("[FB] Brak liczby komentarzy w UI i brak anchor√≥w, zwracam 0.");
1893 |   return 0;
1894 | }
1895 | 
1896 | /* ============================================================
1897 |    ================= ROZWIJANIE KOMENTARZY ====================
1898 |    ============================================================ */
1899 | 
1900 | async function expandAllComments(page) {
1901 |   if (!EXPAND_COMMENTS) {
1902 |     console.log("[FB] EXPAND_COMMENTS=false ‚Üí pomijam rozwijanie.");
1903 |     return 0;
1904 |   }
1905 |   let clicks = 0;
1906 |   for (let i = 0; i < 30; i++) {
1907 |     const didClick = await clickOneExpandButton(page);
1908 |     if (!didClick) break;
1909 |     clicks++;
1910 |     await sleepRandom(900, 1600);
1911 |   }
1912 |   return clicks;
1913 | }
1914 | 
1915 | export async function extractCommentsData(page) {
1916 |   try {
1917 |     const comments = await extractCommentsFromDOM(page);
1918 |     return comments;
1919 |   } catch (err) {
1920 |     console.error('[FB] extractCommentsData ‚Äì b≈ÇƒÖd:', err.message);
1921 |     return [];
1922 |   }
1923 | }
1924 | 
1925 | export { getCommentCount, expandAllComments,  };
1926 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/login.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
   1 | // src/fb/login.js
   2 | import { sleepRandom, humanType } from "../utils/sleep.js";
   3 | import log from "../utils/logger.js";
   4 | import { CAPTCHA_ENABLED, CAPTCHA_API_KEY } from "../config.js";
   5 | 
   6 | /**
   7 |  * Diagnozuje typ captcha na stronie
   8 |  * @param {import('puppeteer').Page} page
   9 |  * @returns {Promise<{type: string, details: object}>}
  10 |  */
  11 | async function diagnoseCaptchaType(page) {
  12 |   log.prod("CAPTCHA", "=== DIAGNOSTYKA TYPU CAPTCHA ===");
  13 | 
  14 |   const frames = page.frames();
  15 |   log.prod("CAPTCHA", `Liczba frames: ${frames.length}`);
  16 | 
  17 |   const diagnosis = {
  18 |     type: "unknown",
  19 |     details: {
  20 |       frames: [],
  21 |       pageIndicators: [],
  22 |       sitekey: null,
  23 |       publicKey: null,
  24 |     }
  25 |   };
  26 | 
  27 |   // Sprawd≈∫ wszystkie frames
  28 |   for (const frame of frames) {
  29 |     try {
  30 |       const url = frame.url();
  31 |       if (!url || url === "about:blank") continue;
  32 | 
  33 |       const frameInfo = { url: url.substring(0, 120) };
  34 | 
  35 |       // FunCaptcha / Arkose Labs
  36 |       if (url.includes("arkoselabs") || url.includes("funcaptcha")) {
  37 |         diagnosis.type = "funcaptcha";
  38 |         frameInfo.type = "funcaptcha";
  39 | 
  40 |         // WyciƒÖgnij public key z URL
  41 |         const pkMatch = url.match(/[?&]pk=([^&]+)/);
  42 |         if (pkMatch) {
  43 |           diagnosis.details.publicKey = pkMatch[1];
  44 |           frameInfo.publicKey = pkMatch[1];
  45 |         }
  46 |       }
  47 |       // reCAPTCHA
  48 |       else if (url.includes("recaptcha") || url.includes("google.com/recaptcha")) {
  49 |         diagnosis.type = diagnosis.type === "unknown" ? "recaptcha" : diagnosis.type;
  50 |         frameInfo.type = "recaptcha";
  51 | 
  52 |         if (url.includes("/enterprise/")) {
  53 |           frameInfo.enterprise = true;
  54 |         }
  55 | 
  56 |         const keyMatch = url.match(/[?&]k=([^&]+)/);
  57 |         if (keyMatch) {
  58 |           diagnosis.details.sitekey = keyMatch[1];
  59 |           frameInfo.sitekey = keyMatch[1];
  60 |         }
  61 |       }
  62 |       // hCaptcha
  63 |       else if (url.includes("hcaptcha")) {
  64 |         diagnosis.type = diagnosis.type === "unknown" ? "hcaptcha" : diagnosis.type;
  65 |         frameInfo.type = "hcaptcha";
  66 |       }
  67 | 
  68 |       if (frameInfo.type) {
  69 |         diagnosis.details.frames.push(frameInfo);
  70 |         log.prod("CAPTCHA", `Frame: ${frameInfo.type} - ${url.substring(0, 80)}...`);
  71 |       }
  72 |     } catch {
  73 |       // Ignoruj b≈Çƒôdy
  74 |     }
  75 |   }
  76 | 
  77 |   // Sprawd≈∫ elementy na g≈Ç√≥wnej stronie + u≈ºyj skryptu 2Captcha do wykrywania reCAPTCHA
  78 |   const pageCheck = await page.evaluate(() => {
  79 |     const indicators = [];
  80 | 
  81 |     // FunCaptcha / Arkose Labs
  82 |     if (document.querySelector('#FunCaptcha, [data-callback*="funcaptcha"], iframe[src*="arkoselabs"]')) {
  83 |       indicators.push("funcaptcha_element");
  84 |     }
  85 | 
  86 |     // Szukaj enforcement script (Arkose)
  87 |     const scripts = Array.from(document.querySelectorAll('script[src]'));
  88 |     for (const s of scripts) {
  89 |       if (s.src.includes('arkoselabs') || s.src.includes('funcaptcha')) {
  90 |         indicators.push(`arkose_script: ${s.src.substring(0, 60)}`);
  91 |       }
  92 |     }
  93 | 
  94 |     // Szukaj data-callback z arkose
  95 |     const arkoseDiv = document.querySelector('[data-callback]');
  96 |     if (arkoseDiv) {
  97 |       indicators.push(`data-callback: ${arkoseDiv.getAttribute('data-callback')}`);
  98 |     }
  99 | 
 100 |     // reCAPTCHA - element na stronie
 101 |     if (document.querySelector('.g-recaptcha, [data-sitekey]')) {
 102 |       indicators.push("recaptcha_element");
 103 |       const sitekey = document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey');
 104 |       if (sitekey) indicators.push(`sitekey: ${sitekey.substring(0, 20)}...`);
 105 |     }
 106 | 
 107 |     // === SKRYPT 2CAPTCHA - wykrywanie reCAPTCHA clients ===
 108 |     // eslint-disable-next-line camelcase
 109 |     if (typeof ___grecaptcha_cfg !== 'undefined') {
 110 |       try {
 111 |         // eslint-disable-next-line camelcase, no-undef
 112 |         const clients = Object.entries(___grecaptcha_cfg.clients).map(([cid, client]) => {
 113 |           const data = { id: cid, version: cid >= 10000 ? 'V3' : 'V2' };
 114 |           const objects = Object.entries(client).filter(([_, value]) => value && typeof value === 'object');
 115 | 
 116 |           objects.forEach(([toplevelKey, toplevel]) => {
 117 |             const found = Object.entries(toplevel).find(([_, value]) => (
 118 |               value && typeof value === 'object' && 'sitekey' in value && 'size' in value
 119 |             ));
 120 | 
 121 |             if (typeof toplevel === 'object' && toplevel instanceof HTMLElement && toplevel['tagName'] === 'DIV') {
 122 |               data.pageurl = toplevel.baseURI;
 123 |             }
 124 | 
 125 |             if (found) {
 126 |               const [sublevelKey, sublevel] = found;
 127 |               data.sitekey = sublevel.sitekey;
 128 |               const callbackKey = data.version === 'V2' ? 'callback' : 'promise-callback';
 129 |               const callback = sublevel[callbackKey];
 130 |               if (callback) {
 131 |                 const keys = [cid, toplevelKey, sublevelKey, callbackKey].map((key) => `['${key}']`).join('');
 132 |                 data.callback = `___grecaptcha_cfg.clients${keys}`;
 133 |               }
 134 |             }
 135 |           });
 136 |           return data;
 137 |         });
 138 | 
 139 |         if (clients.length > 0) {
 140 |           indicators.push(`grecaptcha_clients: ${JSON.stringify(clients)}`);
 141 |         }
 142 |       } catch (e) {
 143 |         indicators.push(`grecaptcha_error: ${e.message}`);
 144 |       }
 145 |     }
 146 | 
 147 |     // Tekst na stronie
 148 |     const bodyText = (document.body?.innerText || '').toLowerCase();
 149 |     if (bodyText.includes('arkose') || bodyText.includes('funcaptcha')) {
 150 |       indicators.push("arkose_text");
 151 |     }
 152 | 
 153 |     return indicators;
 154 |   });
 155 | 
 156 |   diagnosis.details.pageIndicators = pageCheck;
 157 |   if (pageCheck.length > 0) {
 158 |     log.prod("CAPTCHA", `Wska≈∫niki na stronie: ${pageCheck.join(', ')}`);
 159 |   }
 160 | 
 161 |   // Je≈õli znaleziono funcaptcha, ustaw typ
 162 |   if (pageCheck.some(i => i.includes("funcaptcha") || i.includes("arkose"))) {
 163 |     diagnosis.type = "funcaptcha";
 164 |   }
 165 | 
 166 |   // Parsuj dane z grecaptcha_clients (skrypt 2Captcha)
 167 |   const grecaptchaMatch = pageCheck.find(i => i.startsWith("grecaptcha_clients:"));
 168 |   if (grecaptchaMatch) {
 169 |     try {
 170 |       const jsonStr = grecaptchaMatch.replace("grecaptcha_clients: ", "");
 171 |       const clients = JSON.parse(jsonStr);
 172 |       if (clients.length > 0) {
 173 |         diagnosis.type = "recaptcha";
 174 |         diagnosis.details.grecaptchaClients = clients;
 175 |         // U≈ºyj pierwszego klienta z sitekey
 176 |         const clientWithSitekey = clients.find(c => c.sitekey);
 177 |         if (clientWithSitekey) {
 178 |           diagnosis.details.sitekey = clientWithSitekey.sitekey;
 179 |           diagnosis.details.callback = clientWithSitekey.callback;
 180 |           diagnosis.details.version = clientWithSitekey.version;
 181 |           log.prod("CAPTCHA", `Znaleziono reCAPTCHA ${clientWithSitekey.version} przez ___grecaptcha_cfg`);
 182 |           log.prod("CAPTCHA", `Sitekey: ${clientWithSitekey.sitekey?.substring(0, 20)}...`);
 183 |           if (clientWithSitekey.callback) {
 184 |             log.prod("CAPTCHA", `Callback: ${clientWithSitekey.callback}`);
 185 |           }
 186 |         }
 187 |       }
 188 |     } catch (e) {
 189 |       log.debug("CAPTCHA", `B≈ÇƒÖd parsowania grecaptcha_clients: ${e.message}`);
 190 |     }
 191 |   }
 192 | 
 193 |   log.prod("CAPTCHA", `=== WYKRYTY TYP: ${diagnosis.type.toUpperCase()} ===`);
 194 | 
 195 |   return diagnosis;
 196 | }
 197 | 
 198 | /**
 199 |  * RozwiƒÖzuje FunCaptcha/Arkose Labs przez 2Captcha API
 200 |  * @param {string} publicKey - klucz publiczny Arkose (parametr pk= z URL)
 201 |  * @param {string} pageUrl - URL strony z captcha
 202 |  * @param {string} surl - opcjonalny service URL
 203 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 204 |  */
 205 | async function solveFunCaptchaViaApi(publicKey, pageUrl, surl = null) {
 206 |   if (!CAPTCHA_API_KEY || !publicKey) {
 207 |     return { ok: false, error: "missing_params" };
 208 |   }
 209 | 
 210 |   log.prod("CAPTCHA", `Wysy≈Çam FunCaptcha do 2Captcha (publicKey: ${publicKey.substring(0, 15)}...)`);
 211 | 
 212 |   try {
 213 |     const createTaskPayload = {
 214 |       clientKey: CAPTCHA_API_KEY,
 215 |       task: {
 216 |         type: "FunCaptchaTaskProxyless",
 217 |         websiteURL: pageUrl,
 218 |         websitePublicKey: publicKey,
 219 |       },
 220 |     };
 221 | 
 222 |     // Dodaj service URL je≈õli podany
 223 |     if (surl) {
 224 |       createTaskPayload.task.funcaptchaApiJSSubdomain = surl;
 225 |     }
 226 | 
 227 |     log.debug("CAPTCHA", `Payload: ${JSON.stringify(createTaskPayload).substring(0, 200)}`);
 228 | 
 229 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 230 |       method: "POST",
 231 |       headers: { "Content-Type": "application/json" },
 232 |       body: JSON.stringify(createTaskPayload),
 233 |     });
 234 |     const createData = await createRes.json();
 235 | 
 236 |     if (createData.errorId !== 0) {
 237 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 238 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 239 |     }
 240 | 
 241 |     const taskId = createData.taskId;
 242 |     log.dev("CAPTCHA", `FunCaptcha Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 243 | 
 244 |     // Polling - max 180 sekund
 245 |     const maxAttempts = 36;
 246 |     for (let i = 0; i < maxAttempts; i++) {
 247 |       await new Promise(r => setTimeout(r, 5000));
 248 | 
 249 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 250 |         method: "POST",
 251 |         headers: { "Content-Type": "application/json" },
 252 |         body: JSON.stringify({
 253 |           clientKey: CAPTCHA_API_KEY,
 254 |           taskId: taskId,
 255 |         }),
 256 |       });
 257 |       const resultData = await resultRes.json();
 258 | 
 259 |       if (resultData.errorId !== 0) {
 260 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 261 |         return { ok: false, error: resultData.errorCode };
 262 |       }
 263 | 
 264 |       if (resultData.status === "ready") {
 265 |         const token = resultData.solution?.token;
 266 |         if (token) {
 267 |           log.success("CAPTCHA", `FunCaptcha rozwiƒÖzana! (pr√≥ba ${i + 1})`);
 268 |           return { ok: true, token };
 269 |         }
 270 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi FunCaptcha");
 271 |         return { ok: false, error: "no_token" };
 272 |       }
 273 | 
 274 |       log.debug("CAPTCHA", `Czekam na FunCaptcha... (${i + 1}/${maxAttempts})`);
 275 |     }
 276 | 
 277 |     return { ok: false, error: "timeout" };
 278 |   } catch (err) {
 279 |     log.error("CAPTCHA", `B≈ÇƒÖd FunCaptcha API: ${err?.message}`);
 280 |     return { ok: false, error: err?.message };
 281 |   }
 282 | }
 283 | 
 284 | /**
 285 |  * RozwiƒÖzuje reCAPTCHA Enterprise przez API v2 2Captcha (createTask)
 286 |  * @param {string} sitekey - klucz witryny reCAPTCHA (parametr k= z URL)
 287 |  * @param {string} pageUrl - URL strony z captcha
 288 |  * @param {object} options - dodatkowe opcje
 289 |  * @param {boolean} options.isInvisible - czy to invisible captcha (domy≈õlnie false)
 290 |  * @param {boolean} options.isEnterprise - czy to Enterprise captcha (domy≈õlnie true)
 291 |  * @param {string} options.dataS - parametr data-s ze strony (dla Enterprise)
 292 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 293 |  */
 294 | async function solveRecaptchaViaApi(sitekey, pageUrl, options = {}) {
 295 |   const { isInvisible = false, isEnterprise = true, dataS = null } = options;
 296 | 
 297 |   if (!CAPTCHA_API_KEY || !sitekey) {
 298 |     return { ok: false, error: "missing_params" };
 299 |   }
 300 | 
 301 |   log.prod("CAPTCHA", `Wysy≈Çam do 2Captcha API v2 (sitekey: ${sitekey.substring(0, 10)}..., enterprise: ${isEnterprise}, dataS: ${dataS ? 'tak' : 'nie'})`);
 302 | 
 303 |   try {
 304 |     // 1. Wy≈õlij zadanie do 2Captcha (API v2)
 305 |     const taskType = isEnterprise
 306 |       ? "RecaptchaV2EnterpriseTaskProxyless"
 307 |       : "RecaptchaV2TaskProxyless";
 308 | 
 309 |     const createTaskPayload = {
 310 |       clientKey: CAPTCHA_API_KEY,
 311 |       task: {
 312 |         type: taskType,
 313 |         websiteURL: pageUrl,
 314 |         websiteKey: sitekey,
 315 |         isInvisible: isInvisible,
 316 |         // FB u≈ºywa w≈Çasnej domeny dla reCAPTCHA
 317 |         apiDomain: "www.recaptcha.net",
 318 |       },
 319 |     };
 320 | 
 321 |     // Dodaj enterprisePayload je≈õli mamy data-s
 322 |     if (isEnterprise && dataS) {
 323 |       createTaskPayload.task.enterprisePayload = { s: dataS };
 324 |       log.debug("CAPTCHA", `Dodano enterprisePayload.s: ${dataS.substring(0, 30)}...`);
 325 |     }
 326 | 
 327 |     log.debug("CAPTCHA", `Typ zadania: ${taskType}`);
 328 | 
 329 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 330 |       method: "POST",
 331 |       headers: { "Content-Type": "application/json" },
 332 |       body: JSON.stringify(createTaskPayload),
 333 |     });
 334 |     const createData = await createRes.json();
 335 | 
 336 |     if (createData.errorId !== 0) {
 337 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 338 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 339 |     }
 340 | 
 341 |     const taskId = createData.taskId;
 342 |     log.dev("CAPTCHA", `Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 343 | 
 344 |     // 2. Polling - czekaj na rozwiƒÖzanie (max 180 sekund dla Enterprise)
 345 |     const maxAttempts = 36; // 36 * 5s = 180s
 346 |     for (let i = 0; i < maxAttempts; i++) {
 347 |       await new Promise(r => setTimeout(r, 5000)); // czekaj 5 sekund
 348 | 
 349 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 350 |         method: "POST",
 351 |         headers: { "Content-Type": "application/json" },
 352 |         body: JSON.stringify({
 353 |           clientKey: CAPTCHA_API_KEY,
 354 |           taskId: taskId,
 355 |         }),
 356 |       });
 357 |       const resultData = await resultRes.json();
 358 | 
 359 |       if (resultData.errorId !== 0) {
 360 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 361 |         return { ok: false, error: resultData.errorCode };
 362 |       }
 363 | 
 364 |       if (resultData.status === "ready") {
 365 |         const token = resultData.solution?.gRecaptchaResponse;
 366 |         if (token) {
 367 |           log.success("CAPTCHA", `RozwiƒÖzano! (pr√≥ba ${i + 1})`);
 368 |           return { ok: true, token };
 369 |         }
 370 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi");
 371 |         return { ok: false, error: "no_token" };
 372 |       }
 373 | 
 374 |       log.debug("CAPTCHA", `Czekam... (${i + 1}/${maxAttempts})`);
 375 |     }
 376 | 
 377 |     return { ok: false, error: "timeout" };
 378 |   } catch (err) {
 379 |     log.error("CAPTCHA", `B≈ÇƒÖd API: ${err?.message}`);
 380 |     return { ok: false, error: err?.message };
 381 |   }
 382 | }
 383 | 
 384 | /**
 385 |  * RozwiƒÖzuje reCAPTCHA z siatkƒÖ obrazk√≥w przez GridTask (2Captcha)
 386 |  * Zamiast generowaƒá token, klika fizycznie w kwadraty wskazane przez pracownik√≥w.
 387 |  *
 388 |  * @param {Page} page - Puppeteer page
 389 |  * @returns {Promise<{ok: boolean, clicked?: number[], error?: string}>}
 390 |  */
 391 | async function solveGridCaptcha(page) {
 392 |   if (!CAPTCHA_API_KEY) {
 393 |     return { ok: false, error: "missing_api_key" };
 394 |   }
 395 | 
 396 |   log.prod("CAPTCHA", "=== GRID CAPTCHA SOLVER ===");
 397 | 
 398 |   try {
 399 |     // 1. Znajd≈∫ iframe z siatkƒÖ obrazk√≥w (bframe)
 400 |     const frames = page.frames();
 401 |     let gridFrame = null;
 402 |     let gridFrameUrl = null;
 403 | 
 404 |     for (const frame of frames) {
 405 |       const url = frame.url();
 406 |       if (url.includes('recaptcha') && url.includes('bframe')) {
 407 |         gridFrame = frame;
 408 |         gridFrameUrl = url;
 409 |         log.dev("CAPTCHA", `Znaleziono bframe: ${url.substring(0, 80)}...`);
 410 |         break;
 411 |       }
 412 |     }
 413 | 
 414 |     if (!gridFrame) {
 415 |       log.warn("CAPTCHA", "Nie znaleziono iframe z siatkƒÖ obrazk√≥w");
 416 |       return { ok: false, error: "no_grid_frame" };
 417 |     }
 418 | 
 419 |     // 2. Poczekaj na za≈Çadowanie siatki
 420 |     await sleepRandom(1500, 2500);
 421 | 
 422 |     // 3. WyciƒÖgnij instrukcjƒô (np. "Wybierz wszystkie kwadraty z przej≈õciami dla pieszych")
 423 |     let instruction = "";
 424 |     try {
 425 |       instruction = await gridFrame.evaluate(() => {
 426 |         // Szukaj instrukcji w r√≥≈ºnych miejscach
 427 |         const selectors = [
 428 |           '.rc-imageselect-desc-wrapper',
 429 |           '.rc-imageselect-desc',
 430 |           '.rc-imageselect-instructions',
 431 |           'strong',
 432 |           '.rc-imageselect-desc-no-canonical'
 433 |         ];
 434 |         for (const sel of selectors) {
 435 |           const el = document.querySelector(sel);
 436 |           if (el && el.textContent.trim()) {
 437 |             return el.textContent.trim();
 438 |           }
 439 |         }
 440 |         return "";
 441 |       });
 442 |       log.prod("CAPTCHA", `Instrukcja: "${instruction.substring(0, 60)}..."`);
 443 |     } catch (err) {
 444 |       log.warn("CAPTCHA", `Nie mo≈ºna wyciƒÖgnƒÖƒá instrukcji: ${err?.message}`);
 445 |     }
 446 | 
 447 |     // Przet≈Çumacz instrukcjƒô na angielski dla 2Captcha (pracownicy lepiej rozumiejƒÖ)
 448 |     const instructionEn = translateInstruction(instruction);
 449 |     log.dev("CAPTCHA", `Instrukcja EN: "${instructionEn}"`);
 450 | 
 451 |     // 4. Zr√≥b screenshot siatki obrazk√≥w
 452 |     let screenshotBase64 = null;
 453 |     try {
 454 |       // Znajd≈∫ element z siatkƒÖ
 455 |       const gridElement = await gridFrame.$('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44, .rc-imageselect');
 456 | 
 457 |       if (gridElement) {
 458 |         const screenshotBuffer = await gridElement.screenshot({ encoding: 'base64' });
 459 |         screenshotBase64 = screenshotBuffer;
 460 |         log.prod("CAPTCHA", `Screenshot siatki: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 461 |       } else {
 462 |         // Fallback - screenshot ca≈Çego iframe
 463 |         const frameElement = await page.$('iframe[src*="bframe"]');
 464 |         if (frameElement) {
 465 |           const screenshotBuffer = await frameElement.screenshot({ encoding: 'base64' });
 466 |           screenshotBase64 = screenshotBuffer;
 467 |           log.prod("CAPTCHA", `Screenshot iframe: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 468 |         }
 469 |       }
 470 |     } catch (err) {
 471 |       log.error("CAPTCHA", `B≈ÇƒÖd screenshot: ${err?.message}`);
 472 |       return { ok: false, error: "screenshot_failed" };
 473 |     }
 474 | 
 475 |     if (!screenshotBase64) {
 476 |       return { ok: false, error: "no_screenshot" };
 477 |     }
 478 | 
 479 |     // 5. Sprawd≈∫ rozmiar siatki (3x3 lub 4x4)
 480 |     let gridSize = "3x3";
 481 |     try {
 482 |       gridSize = await gridFrame.evaluate(() => {
 483 |         if (document.querySelector('.rc-imageselect-table-44')) return "4x4";
 484 |         if (document.querySelector('.rc-imageselect-table-33')) return "3x3";
 485 |         // Policz kwadraty
 486 |         const tiles = document.querySelectorAll('.rc-imageselect-tile');
 487 |         if (tiles.length === 16) return "4x4";
 488 |         return "3x3";
 489 |       });
 490 |       log.dev("CAPTCHA", `Rozmiar siatki: ${gridSize}`);
 491 |     } catch {}
 492 | 
 493 |     // 6. Wy≈õlij do 2Captcha GridTask
 494 |     log.prod("CAPTCHA", "Wysy≈Çam GridTask do 2Captcha...");
 495 | 
 496 |     const createTaskPayload = {
 497 |       clientKey: CAPTCHA_API_KEY,
 498 |       task: {
 499 |         type: "GridTask",
 500 |         body: screenshotBase64,
 501 |         comment: instructionEn || "Select all squares that match the description",
 502 |         rows: gridSize === "4x4" ? 4 : 3,
 503 |         columns: gridSize === "4x4" ? 4 : 3,
 504 |       },
 505 |     };
 506 | 
 507 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 508 |       method: "POST",
 509 |       headers: { "Content-Type": "application/json" },
 510 |       body: JSON.stringify(createTaskPayload),
 511 |     });
 512 |     const createData = await createRes.json();
 513 | 
 514 |     if (createData.errorId !== 0) {
 515 |       log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${createData.errorCode} - ${createData.errorDescription}`);
 516 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 517 |     }
 518 | 
 519 |     const taskId = createData.taskId;
 520 |     log.dev("CAPTCHA", `GridTask ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 521 | 
 522 |     // 7. Polling - czekaj na rozwiƒÖzanie (max 120 sekund)
 523 |     const maxAttempts = 24; // 24 * 5s = 120s
 524 |     let clickIndices = [];
 525 | 
 526 |     for (let i = 0; i < maxAttempts; i++) {
 527 |       await new Promise(r => setTimeout(r, 5000));
 528 | 
 529 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 530 |         method: "POST",
 531 |         headers: { "Content-Type": "application/json" },
 532 |         body: JSON.stringify({
 533 |           clientKey: CAPTCHA_API_KEY,
 534 |           taskId: taskId,
 535 |         }),
 536 |       });
 537 |       const resultData = await resultRes.json();
 538 | 
 539 |       if (resultData.errorId !== 0) {
 540 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 541 |         return { ok: false, error: resultData.errorCode };
 542 |       }
 543 | 
 544 |       if (resultData.status === "ready") {
 545 |         clickIndices = resultData.solution?.click || [];
 546 |         log.success("CAPTCHA", `GridTask rozwiƒÖzany! Kwadraty: [${clickIndices.join(', ')}]`);
 547 |         break;
 548 |       }
 549 | 
 550 |       log.debug("CAPTCHA", `Czekam na GridTask... (${i + 1}/${maxAttempts})`);
 551 |     }
 552 | 
 553 |     if (!clickIndices.length) {
 554 |       log.warn("CAPTCHA", "Brak kwadrat√≥w do klikniƒôcia (mo≈ºe 'Pomi≈Ñ'?)");
 555 |       // Mo≈ºe trzeba kliknƒÖƒá "Pomi≈Ñ" je≈õli nie ma pasujƒÖcych obrazk√≥w
 556 |       try {
 557 |         const skipBtn = await gridFrame.$('.rc-imageselect-incorrect-response, button:has-text("Pomi≈Ñ"), button:has-text("Skip")');
 558 |         if (skipBtn) {
 559 |           await skipBtn.click();
 560 |           await sleepRandom(1000, 2000);
 561 |           return { ok: true, clicked: [], skipped: true };
 562 |         }
 563 |       } catch {}
 564 |       return { ok: false, error: "no_tiles_to_click" };
 565 |     }
 566 | 
 567 |     // 8. Kliknij wskazane kwadraty
 568 |     log.prod("CAPTCHA", `Klikam ${clickIndices.length} kwadrat√≥w...`);
 569 | 
 570 |     for (const index of clickIndices) {
 571 |       try {
 572 |         // Indeksy z 2Captcha sƒÖ 1-based (1 = g√≥rny lewy)
 573 |         const tileIndex = index - 1; // konwertuj na 0-based
 574 | 
 575 |         const clicked = await gridFrame.evaluate((idx) => {
 576 |           const tiles = document.querySelectorAll('.rc-imageselect-tile');
 577 |           if (tiles[idx]) {
 578 |             tiles[idx].click();
 579 |             return true;
 580 |           }
 581 |           // Alternatywny selektor
 582 |           const cells = document.querySelectorAll('td.rc-imageselect-tile');
 583 |           if (cells[idx]) {
 584 |             cells[idx].click();
 585 |             return true;
 586 |           }
 587 |           return false;
 588 |         }, tileIndex);
 589 | 
 590 |         if (clicked) {
 591 |           log.dev("CAPTCHA", `Klikniƒôto kwadrat ${index}`);
 592 |         } else {
 593 |           log.warn("CAPTCHA", `Nie znaleziono kwadratu ${index}`);
 594 |         }
 595 | 
 596 |         // Kr√≥tka pauza miƒôdzy klikniƒôciami (human-like)
 597 |         await sleepRandom(200, 500);
 598 |       } catch (err) {
 599 |         log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia kwadratu ${index}: ${err?.message}`);
 600 |       }
 601 |     }
 602 | 
 603 |     // 9. Kliknij przycisk "Sprawd≈∫" / "Verify"
 604 |     await sleepRandom(500, 1000);
 605 | 
 606 |     try {
 607 |       const verifyBtn = await gridFrame.$('#recaptcha-verify-button, .rc-button-default, button[id*="verify"]');
 608 |       if (verifyBtn) {
 609 |         log.prod("CAPTCHA", "Klikam 'Sprawd≈∫'...");
 610 |         await verifyBtn.click();
 611 |         await sleepRandom(2000, 3000);
 612 |       }
 613 |     } catch (err) {
 614 |       log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia Verify: ${err?.message}`);
 615 |     }
 616 | 
 617 |     return { ok: true, clicked: clickIndices };
 618 | 
 619 |   } catch (err) {
 620 |     log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${err?.message}`);
 621 |     return { ok: false, error: err?.message };
 622 |   }
 623 | }
 624 | 
 625 | /**
 626 |  * T≈Çumaczy polskƒÖ instrukcjƒô reCAPTCHA na angielski
 627 |  */
 628 | function translateInstruction(pl) {
 629 |   const translations = {
 630 |     "przej≈õciami dla pieszych": "crosswalks",
 631 |     "przej≈õcia dla pieszych": "crosswalks",
 632 |     "sygnalizatorami ≈õwietlnymi": "traffic lights",
 633 |     "sygnalizatory ≈õwietlne": "traffic lights",
 634 |     "≈õwiat≈Çami": "traffic lights",
 635 |     "samochodami": "cars",
 636 |     "samochody": "cars",
 637 |     "autobusami": "buses",
 638 |     "autobusy": "buses",
 639 |     "motocyklami": "motorcycles",
 640 |     "motocykle": "motorcycles",
 641 |     "rowerami": "bicycles",
 642 |     "rowery": "bicycles",
 643 |     "hydrantami": "fire hydrants",
 644 |     "hydranty": "fire hydrants",
 645 |     "mostami": "bridges",
 646 |     "mosty": "bridges",
 647 |     "schodami": "stairs",
 648 |     "schody": "stairs",
 649 |     "g√≥rami": "mountains",
 650 |     "g√≥ry": "mountains",
 651 |     "palmami": "palm trees",
 652 |     "palmy": "palm trees",
 653 |     "≈Çodziami": "boats",
 654 |     "≈Çodzie": "boats",
 655 |     "taks√≥wkami": "taxis",
 656 |     "taks√≥wki": "taxis",
 657 |     "chimneys": "chimneys",
 658 |     "kominami": "chimneys",
 659 |     "kominy": "chimneys",
 660 |     "parking meters": "parking meters",
 661 |     "parkomatami": "parking meters",
 662 |     "parkomaty": "parking meters",
 663 |   };
 664 | 
 665 |   let en = pl.toLowerCase();
 666 | 
 667 |   // Zamie≈Ñ polskie frazy na angielskie
 668 |   for (const [plPhrase, enPhrase] of Object.entries(translations)) {
 669 |     if (en.includes(plPhrase.toLowerCase())) {
 670 |       return `Select all squares with ${enPhrase}`;
 671 |     }
 672 |   }
 673 | 
 674 |   // Je≈õli nie znaleziono t≈Çumaczenia, zwr√≥ƒá oryginalnƒÖ instrukcjƒô
 675 |   return pl || "Select all matching images";
 676 | }
 677 | 
 678 | /**
 679 |  * Sprawdza czy pojawi≈Ça siƒô siatka obrazk√≥w (po klikniƒôciu checkboxa)
 680 |  */
 681 | async function hasImageGrid(page) {
 682 |   try {
 683 |     const frames = page.frames();
 684 |     for (const frame of frames) {
 685 |       if (frame.url().includes('recaptcha') && frame.url().includes('bframe')) {
 686 |         // Sprawd≈∫ czy siatka jest widoczna
 687 |         const hasGrid = await frame.evaluate(() => {
 688 |           const grid = document.querySelector('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44');
 689 |           return grid && grid.offsetHeight > 0;
 690 |         }).catch(() => false);
 691 | 
 692 |         if (hasGrid) {
 693 |           return true;
 694 |         }
 695 |       }
 696 |     }
 697 |     return false;
 698 |   } catch {
 699 |     return false;
 700 |   }
 701 | }
 702 | 
 703 | /**
 704 |  * FB login helpers ‚Äì PRO (NO COOLDOWN)
 705 |  *
 706 |  * Najwa≈ºniejsze:
 707 |  * - G≈Ç√≥wne logowanie: https://www.facebook.com/login.php?next=<postUrl>
 708 |  * - Best-effort (zero throw, zero crashy)
 709 |  * - Dwa tryby:
 710 |  *    1) login.php?next (najstabilniejsze)
 711 |  *    2) fallback: loginViaVisibleForm (overlay / r√≥≈ºne layouty)
 712 |  *
 713 |  * Kompatybilno≈õƒá:
 714 |  * - eksportujemy te≈º clickByText, acceptLoginCookies, loginViaVisibleForm (jak w wersji lokalnej)
 715 |  */
 716 | 
 717 | function norm(s) {
 718 |   return String(s || "")
 719 |     .replace(/\u00a0/g, " ")
 720 |     .replace(/\s+/g, " ")
 721 |     .trim();
 722 | }
 723 | 
 724 | /**
 725 |  * Cookies popup ‚Äì wersja "mark + click" (jak lokalnie), ale best-effort.
 726 |  */
 727 | async function acceptLoginCookies(page) {
 728 |   try {
 729 |     log.debug("LOGIN", "Szukam popupu cookies...");
 730 | 
 731 |     await sleepRandom(300, 900);
 732 | 
 733 |     const found = await page.evaluate(() => {
 734 |       const wanted = [
 735 |         "Zezw√≥l na wszystkie pliki cookie",
 736 |         "Zezw√≥l na wszystkie pliki",
 737 |         "Allow all cookies",
 738 |         "Accept all cookies",
 739 |         "Akceptuj wszystkie",
 740 |         "Odrzuƒá opcjonalne pliki cookie",
 741 |         "Odrzuc opcjonalne pliki cookie",
 742 |       ].map((t) => t.toLowerCase());
 743 | 
 744 |       const buttons = Array.from(
 745 |         document.querySelectorAll("button, [role='button']")
 746 |       );
 747 | 
 748 |       for (const btn of buttons) {
 749 |         const txt = (btn.innerText || btn.textContent || "").trim();
 750 |         if (!txt) continue;
 751 |         const low = txt.toLowerCase();
 752 | 
 753 |         if (wanted.some((w) => low.includes(w))) {
 754 |           btn.setAttribute("data-fb-cookie-btn", "1");
 755 |           return true;
 756 |         }
 757 |       }
 758 | 
 759 |       return false;
 760 |     });
 761 | 
 762 |     if (!found) {
 763 |       return false;
 764 |     }
 765 | 
 766 |     await page
 767 |       .click('[data-fb-cookie-btn="1"]')
 768 |       .catch(() => {});
 769 | 
 770 |     log.debug("LOGIN", "Klikniƒôto cookies popup");
 771 | 
 772 |     await sleepRandom(600, 1200);
 773 |     return true;
 774 |   } catch (err) {
 775 |     log.debug("LOGIN", `B≈ÇƒÖd cookies popup: ${err?.message || err}`);
 776 |     return false;
 777 |   }
 778 | }
 779 | 
 780 | /**
 781 |  * Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).
 782 |  */
 783 | async function acceptCookiesIfPresent(page) {
 784 |   try {
 785 |     await sleepRandom(250, 650);
 786 | 
 787 |     const clicked = await page.evaluate(() => {
 788 |       const wanted = [
 789 |         "Zezw√≤l na wszystkie pliki cookie",
 790 |         "Zezw√≥l na wszystkie pliki cookie",
 791 |         "Zezw√≤l na wszystkie pliki",
 792 |         "Zezw√≥l na wszystkie pliki",
 793 |         "Allow all cookies",
 794 |         "Accept all cookies",
 795 |         "Akceptuj wszystkie",
 796 |       ].map((x) => x.toLowerCase());
 797 | 
 798 |       const btns = Array.from(
 799 |         document.querySelectorAll("button, [role='button']")
 800 |       );
 801 | 
 802 |       for (const b of btns) {
 803 |         const t = (b.innerText || b.textContent || "").trim();
 804 |         if (!t) continue;
 805 |         const low = t.toLowerCase();
 806 |         if (wanted.some((w) => low.includes(w))) {
 807 |           b.click();
 808 |           return true;
 809 |         }
 810 |       }
 811 |       return false;
 812 |     });
 813 | 
 814 |     if (clicked) {
 815 |       log.debug("LOGIN", "Klikniƒôto accept cookies (fallback)");
 816 |       await sleepRandom(500, 1100);
 817 |     }
 818 |     return !!clicked;
 819 |   } catch {
 820 |     return false;
 821 |   }
 822 | }
 823 | 
 824 | /**
 825 |  * Helper: kliknij przycisk submit po rozwiƒÖzaniu captcha
 826 |  */
 827 | async function clickSubmitButton(page) {
 828 |   // Rozszerzone selektory dla FB two_step_verification
 829 |   const submitSelectors = [
 830 |     // FB specyficzne
 831 |     'div[aria-label="Kontynuuj"]',
 832 |     'div[aria-label="Continue"]',
 833 |     'span[dir="auto"]:has-text("Kontynuuj")',
 834 |     // Standardowe
 835 |     'button[type="submit"]',
 836 |     'input[type="submit"]',
 837 |     'button[name="submit"]',
 838 |     'div[role="button"][tabindex="0"]',
 839 |     'button:not([type])',
 840 |     '[data-testid="royal_login_button"]',
 841 |   ];
 842 | 
 843 |   let submitBtn = null;
 844 |   for (const sel of submitSelectors) {
 845 |     try {
 846 |       submitBtn = await page.$(sel);
 847 |       if (submitBtn) {
 848 |         log.debug("CAPTCHA", `Znaleziono przycisk: ${sel}`);
 849 |         break;
 850 |       }
 851 |     } catch {}
 852 |   }
 853 | 
 854 |   // Fallback - szukaj przycisku po tek≈õcie (rozszerzone dla FB)
 855 |   if (!submitBtn) {
 856 |     log.debug("CAPTCHA", "Szukam przycisku po tek≈õcie...");
 857 | 
 858 |     // Diagnostyka - poka≈º wszystkie klikalne elementy
 859 |     const buttons = await page.evaluate(() => {
 860 |       const els = Array.from(document.querySelectorAll(
 861 |         'button, div[role="button"], a[role="button"], span[role="button"], div[tabindex="0"]'
 862 |       ));
 863 |       return els.slice(0, 15).map(el => ({
 864 |         tag: el.tagName,
 865 |         text: (el.innerText || '').substring(0, 50).trim(),
 866 |         role: el.getAttribute('role'),
 867 |         ariaLabel: el.getAttribute('aria-label'),
 868 |       })).filter(x => x.text || x.ariaLabel);
 869 |     });
 870 |     log.debug("CAPTCHA", `Dostƒôpne przyciski: ${JSON.stringify(buttons, null, 2)}`);
 871 | 
 872 |     submitBtn = await page.evaluateHandle(() => {
 873 |       // Szukaj we wszystkich mo≈ºliwych elementach
 874 |       const allElements = Array.from(document.querySelectorAll(
 875 |         'button, div[role="button"], a[role="button"], span[role="button"], ' +
 876 |         'div[tabindex="0"], span[tabindex="0"], a[tabindex="0"]'
 877 |       ));
 878 | 
 879 |       const texts = [
 880 |         'kontynuuj', 'continue', 'submit', 'dalej', 'wy≈õlij', 'potwierd≈∫',
 881 |         'prze≈õlij', 'zatwierd≈∫', 'weryfikuj', 'verify', 'next', 'ok'
 882 |       ];
 883 | 
 884 |       for (const el of allElements) {
 885 |         const t = (el.innerText || el.textContent || '').toLowerCase().trim();
 886 |         if (!t) continue;
 887 | 
 888 |         // Szukaj dok≈Çadnego dopasowania lub zawierania
 889 |         if (texts.some(x => t === x || t.includes(x))) {
 890 |           console.log('[Submit] Znaleziono:', t, el.tagName);
 891 |           return el;
 892 |         }
 893 |       }
 894 | 
 895 |       // Ostatnia szansa - szukaj niebieskiego przycisku FB (primary button)
 896 |       const primaryBtn = document.querySelector(
 897 |         'div[style*="background-color: rgb(24, 119, 242)"], ' +
 898 |         'div[class*="primary"], ' +
 899 |         'div[class*="layerConfirm"]'
 900 |       );
 901 |       if (primaryBtn) {
 902 |         console.log('[Submit] Znaleziono primary button');
 903 |         return primaryBtn;
 904 |       }
 905 | 
 906 |       return null;
 907 |     });
 908 | 
 909 |     if (submitBtn?.asElement()) {
 910 |       submitBtn = submitBtn.asElement();
 911 |     } else {
 912 |       submitBtn = null;
 913 |     }
 914 |   }
 915 | 
 916 |   if (submitBtn) {
 917 |     log.prod("CAPTCHA", "Klikam przycisk submit...");
 918 |     await submitBtn.click();
 919 |     await sleepRandom(1000, 2000);
 920 |     await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
 921 |     await sleepRandom(2000, 3000);
 922 |   } else {
 923 |     // Spr√≥buj kliknƒÖƒá w ≈õrodek ekranu gdzie zwykle jest przycisk
 924 |     log.warn("CAPTCHA", "Nie znaleziono przycisku - pr√≥bujƒô Tab + Enter");
 925 |     await page.keyboard.press('Tab');
 926 |     await sleepRandom(300, 500);
 927 |     await page.keyboard.press('Tab');
 928 |     await sleepRandom(300, 500);
 929 |     await page.keyboard.press('Enter');
 930 |     await sleepRandom(3000, 4000);
 931 |   }
 932 | }
 933 | 
 934 | /**
 935 |  * Pomocnik: wpisz login/has≈Ço + kliknij login. Best-effort.
 936 |  */
 937 | async function fillLoginFormBestEffort(page) {
 938 |   const email = process.env.FB_EMAIL || "";
 939 |   const password = process.env.FB_PASSWORD || "";
 940 | 
 941 |   if (!email || !password) {
 942 |     log.dev("LOGIN", "Brak FB_EMAIL / FB_PASSWORD ‚Äì pomijam");
 943 |     return false;
 944 |   }
 945 | 
 946 |   const emailSel = [
 947 |     "input#email",
 948 |     "input[name='email']",
 949 |     "input[name='email_or_phone']",
 950 |     "input[type='text']",
 951 |   ].join(",");
 952 | 
 953 |   const passSel = [
 954 |     "input#pass",
 955 |     "input[name='pass']",
 956 |     "input[type='password']",
 957 |   ].join(",");
 958 | 
 959 |   const emailInput = await page.$(emailSel).catch(() => null);
 960 |   const passInput = await page.$(passSel).catch(() => null);
 961 | 
 962 |   if (!emailInput || !passInput) {
 963 |     log.debug("LOGIN", "Brak p√≥l email/has≈Ço na stronie");
 964 |     return false;
 965 |   }
 966 | 
 967 |   log.dev("LOGIN", "Wpisujƒô email i has≈Ço (human-like typing)...");
 968 | 
 969 |   await emailInput.click({ clickCount: 3 }).catch(() => {});
 970 |   await page.keyboard.press("Backspace").catch(() => {});
 971 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 972 |   await humanType(emailInput, email, page).catch(() => {});
 973 | 
 974 |   await passInput.click({ clickCount: 3 }).catch(() => {});
 975 |   await page.keyboard.press("Backspace").catch(() => {});
 976 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 977 |   await humanType(passInput, password, page).catch(() => {});
 978 | 
 979 |   const loginButton =
 980 |     (await page.$('button[name="login"]')) ||
 981 |     (await page.$('button[type="submit"]')) ||
 982 |     (await page.$('div[role="button"][tabindex="0"]')) ||
 983 |     (await page.$("button")) ||
 984 |     null;
 985 | 
 986 |   if (!loginButton) {
 987 |     log.debug("LOGIN", "Brak przycisku logowania");
 988 |     return false;
 989 |   }
 990 | 
 991 |   log.dev("LOGIN", "Klikam logowanie...");
 992 | 
 993 |   await Promise.all([
 994 |     loginButton.click().catch(() => {}),
 995 |     page
 996 |       .waitForNavigation({ waitUntil: "networkidle2", timeout: 60000 })
 997 |       .catch(() => {}),
 998 |   ]);
 999 | 
1000 |   await sleepRandom(1400, 2400);
1001 | 
1002 |   // Sprawd≈∫ URL - czy jeste≈õmy na stronie 2FA/weryfikacji
1003 |   const currentUrl = page.url();
1004 |   log.dev("LOGIN", `URL po logowaniu: ${currentUrl.substring(0, 80)}...`);
1005 | 
1006 |   // Je≈õli jeste≈õmy na stronie weryfikacji, spr√≥buj rozwiƒÖzaƒá captcha
1007 |   if (currentUrl.includes('two_step_verification') ||
1008 |       currentUrl.includes('checkpoint') ||
1009 |       currentUrl.includes('authentication')) {
1010 |     log.prod("LOGIN", "Wykryto stronƒô weryfikacji - pr√≥bujƒô rozwiƒÖzaƒá captcha...");
1011 | 
1012 |     // Poczekaj na za≈Çadowanie element√≥w
1013 |     await sleepRandom(4000, 6000);
1014 | 
1015 |     // NOWA DIAGNOSTYKA - wykryj typ captcha
1016 |     const diagnosis = await diagnoseCaptchaType(page);
1017 | 
1018 |     if (!CAPTCHA_ENABLED) {
1019 |       log.warn("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
1020 |       await sleepRandom(1000, 2000);
1021 |       return true;
1022 |     }
1023 | 
1024 |     let apiResult = { ok: false };
1025 | 
1026 |     // === FUNCAPTCHA / ARKOSE LABS ===
1027 |     if (diagnosis.type === "funcaptcha" && diagnosis.details.publicKey) {
1028 |       log.prod("CAPTCHA", "U≈ºywam solvera FunCaptcha...");
1029 | 
1030 |       const maxRetries = 2;
1031 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
1032 |         log.prod("CAPTCHA", `FunCaptcha pr√≥ba ${attempt}/${maxRetries}...`);
1033 | 
1034 |         apiResult = await solveFunCaptchaViaApi(
1035 |           diagnosis.details.publicKey,
1036 |           currentUrl
1037 |         );
1038 | 
1039 |         if (apiResult.ok) break;
1040 | 
1041 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
1042 |           log.warn("CAPTCHA", "FunCaptcha nierozwiƒÖzywalna - od≈õwie≈ºam...");
1043 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
1044 |           await sleepRandom(3000, 5000);
1045 |           // Po reload ponownie zdiagnozuj
1046 |           const newDiag = await diagnoseCaptchaType(page);
1047 |           if (newDiag.details.publicKey) {
1048 |             diagnosis.details.publicKey = newDiag.details.publicKey;
1049 |           }
1050 |         } else if (apiResult.error) {
1051 |           break;
1052 |         }
1053 |       }
1054 | 
1055 |       if (apiResult.ok && apiResult.token) {
1056 |         log.success("CAPTCHA", "Otrzymano token FunCaptcha!");
1057 | 
1058 |         // Wstrzyknij token FunCaptcha
1059 |         try {
1060 |           const injected = await page.evaluate((token) => {
1061 |             let success = false;
1062 | 
1063 |             // FunCaptcha callback - r√≥≈ºne warianty
1064 |             const callbacks = [
1065 |               () => window.ArkoseEnforcement?.setSessionToken?.(token),
1066 |               () => window.fc_callback?.(token),
1067 |               () => window.funcaptchaCallback?.(token),
1068 |               () => window.onFunCaptchaSuccess?.(token),
1069 |               // Szukaj ukrytego inputa
1070 |               () => {
1071 |                 const input = document.querySelector('input[name="fc-token"], input[name="verification_token"]');
1072 |                 if (input) {
1073 |                   input.value = token;
1074 |                   success = true;
1075 |                 }
1076 |               },
1077 |               // Wywo≈Çaj event submit
1078 |               () => {
1079 |                 const form = document.querySelector('form');
1080 |                 if (form) {
1081 |                   const hiddenInput = document.createElement('input');
1082 |                   hiddenInput.type = 'hidden';
1083 |                   hiddenInput.name = 'fc-token';
1084 |                   hiddenInput.value = token;
1085 |                   form.appendChild(hiddenInput);
1086 |                   success = true;
1087 |                 }
1088 |               },
1089 |             ];
1090 | 
1091 |             for (const tryCallback of callbacks) {
1092 |               try {
1093 |                 tryCallback();
1094 |               } catch {}
1095 |             }
1096 | 
1097 |             return success;
1098 |           }, apiResult.token);
1099 | 
1100 |           log.dev("CAPTCHA", `Token FunCaptcha wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
1101 |           await sleepRandom(1500, 2500);
1102 | 
1103 |           // Kliknij przycisk submit
1104 |           await clickSubmitButton(page);
1105 |           return true;
1106 |         } catch (err) {
1107 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu FunCaptcha: ${err?.message}`);
1108 |         }
1109 |       }
1110 |     }
1111 |     // === RECAPTCHA ===
1112 |     else if (diagnosis.type === "recaptcha" && diagnosis.details.sitekey) {
1113 |       log.prod("CAPTCHA", "U≈ºywam solvera reCAPTCHA...");
1114 | 
1115 |       // Sprawd≈∫ czy Enterprise
1116 |       const isEnterprise = diagnosis.details.frames.some(f => f.enterprise);
1117 | 
1118 |       // KROK 1: Kliknij checkbox "Nie jestem robotem" je≈õli istnieje
1119 |       try {
1120 |         const frames = page.frames();
1121 |         for (const frame of frames) {
1122 |           if (frame.url().includes('recaptcha') && frame.url().includes('anchor')) {
1123 |             log.prod("CAPTCHA", "Szukam checkboxa reCAPTCHA...");
1124 |             const checkbox = await frame.$('.recaptcha-checkbox-border, .recaptcha-checkbox, #recaptcha-anchor');
1125 |             if (checkbox) {
1126 |               log.prod("CAPTCHA", "Klikam checkbox 'Nie jestem robotem'...");
1127 |               await checkbox.click();
1128 |               await sleepRandom(2000, 3000);
1129 |               break;
1130 |             }
1131 |           }
1132 |         }
1133 |       } catch (err) {
1134 |         log.debug("CAPTCHA", `B≈ÇƒÖd klikniƒôcia checkboxa: ${err?.message}`);
1135 |       }
1136 | 
1137 |       // KROK 2: Sprawd≈∫ czy pojawi≈Ça siƒô siatka obrazk√≥w
1138 |       await sleepRandom(1000, 2000);
1139 |       const gridDetected = await hasImageGrid(page);
1140 | 
1141 |       if (gridDetected) {
1142 |         log.prod("CAPTCHA", "Wykryto siatkƒô obrazk√≥w - u≈ºywam GridTask...");
1143 | 
1144 |         // Pr√≥by rozwiƒÖzania przez GridTask (FB czƒôsto wymaga 4-6 rund)
1145 |         const maxGridRetries = 6;
1146 |         for (let gridAttempt = 1; gridAttempt <= maxGridRetries; gridAttempt++) {
1147 |           log.prod("CAPTCHA", `GridTask pr√≥ba ${gridAttempt}/${maxGridRetries}...`);
1148 | 
1149 |           const gridResult = await solveGridCaptcha(page);
1150 | 
1151 |           if (gridResult.ok) {
1152 |             log.success("CAPTCHA", `GridTask sukces! Klikniƒôto: [${gridResult.clicked?.join(', ') || 'pominiƒôto'}]`);
1153 | 
1154 |             // Sprawd≈∫ czy captcha zniknƒô≈Ça (sukces)
1155 |             await sleepRandom(2000, 3000);
1156 |             const stillHasGrid = await hasImageGrid(page);
1157 | 
1158 |             if (!stillHasGrid) {
1159 |               log.success("CAPTCHA", "Siatka zniknƒô≈Ça - captcha rozwiƒÖzana!");
1160 |               // Kliknij submit je≈õli trzeba
1161 |               await clickSubmitButton(page);
1162 |               return true;
1163 |             } else {
1164 |               log.warn("CAPTCHA", "Siatka nadal widoczna - pr√≥bujƒô ponownie...");
1165 |               // Mo≈ºe pojawi≈Ça siƒô nowa siatka - kontynuuj
1166 |             }
1167 |           } else {
1168 |             log.warn("CAPTCHA", `GridTask b≈ÇƒÖd: ${gridResult.error}`);
1169 | 
1170 |             if (gridResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && gridAttempt < maxGridRetries) {
1171 |               // Kliknij "Nowy obrazek" je≈õli dostƒôpny
1172 |               try {
1173 |                 const frames = page.frames();
1174 |                 for (const frame of frames) {
1175 |                   if (frame.url().includes('bframe')) {
1176 |                     const newImageBtn = await frame.$('#recaptcha-reload-button, .rc-button-reload');
1177 |                     if (newImageBtn) {
1178 |                       log.prod("CAPTCHA", "Klikam 'Nowy obrazek'...");
1179 |                       await newImageBtn.click();
1180 |                       await sleepRandom(2000, 3000);
1181 |                     }
1182 |                     break;
1183 |                   }
1184 |                 }
1185 |               } catch {}
1186 |             }
1187 |           }
1188 |         }
1189 | 
1190 |         // GridTask nie zadzia≈Ça≈Ç - fallback do token method
1191 |         log.warn("CAPTCHA", "GridTask wyczerpany - pr√≥bujƒô metodƒô tokenowƒÖ...");
1192 |       }
1193 | 
1194 |       // KROK 3 (fallback): Metoda tokenowa (dla przypadk√≥w bez siatki lub gdy GridTask nie zadzia≈Ça≈Ç)
1195 |       // WyciƒÖgnij data-s
1196 |       let dataS = null;
1197 |       try {
1198 |         dataS = await page.evaluate(() => {
1199 |           const recaptchaDiv = document.querySelector('.g-recaptcha, [data-sitekey], #recaptcha');
1200 |           if (recaptchaDiv?.dataset?.s) return recaptchaDiv.dataset.s;
1201 |           const iframes = document.querySelectorAll('iframe[src*="recaptcha"]');
1202 |           for (const iframe of iframes) {
1203 |             const match = (iframe.src || '').match(/[?&]s=([^&]+)/);
1204 |             if (match) return decodeURIComponent(match[1]);
1205 |           }
1206 |           return null;
1207 |         });
1208 |       } catch {}
1209 | 
1210 |       const maxRetries = 2;
1211 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
1212 |         log.prod("CAPTCHA", `reCAPTCHA pr√≥ba ${attempt}/${maxRetries}...`);
1213 | 
1214 |         apiResult = await solveRecaptchaViaApi(diagnosis.details.sitekey, currentUrl, {
1215 |           isEnterprise,
1216 |           isInvisible: false,
1217 |           dataS,
1218 |         });
1219 | 
1220 |         if (apiResult.ok) break;
1221 | 
1222 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
1223 |           log.warn("CAPTCHA", "reCAPTCHA nierozwiƒÖzywalna - od≈õwie≈ºam...");
1224 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
1225 |           await sleepRandom(3000, 5000);
1226 |         } else if (apiResult.error) {
1227 |           break;
1228 |         }
1229 |       }
1230 | 
1231 |       if (apiResult.ok && apiResult.token) {
1232 |         log.success("CAPTCHA", "Otrzymano token reCAPTCHA!");
1233 | 
1234 |         // Wstrzyknij token reCAPTCHA - u≈ºyj wykrytego callbacka je≈õli dostƒôpny
1235 |         const callbackPath = diagnosis.details.callback;
1236 |         try {
1237 |           const injected = await page.evaluate((token, cbPath) => {
1238 |             let success = false;
1239 | 
1240 |             // 1. Ustaw warto≈õƒá w textarea
1241 |             const textareas = document.querySelectorAll(
1242 |               'textarea[name="g-recaptcha-response"], #g-recaptcha-response'
1243 |             );
1244 |             textareas.forEach(ta => {
1245 |               ta.value = token;
1246 |               ta.innerHTML = token;
1247 |               success = true;
1248 |             });
1249 | 
1250 |             // 2. Wywo≈Çaj callback wykryty przez skrypt 2Captcha
1251 |             if (cbPath) {
1252 |               try {
1253 |                 // cbPath ma format: ___grecaptcha_cfg.clients['0']['X']['Y']['callback']
1254 |                 const callback = eval(cbPath);
1255 |                 if (typeof callback === 'function') {
1256 |                   callback(token);
1257 |                   success = true;
1258 |                   console.log('[2Captcha] Callback wywo≈Çany:', cbPath);
1259 |                 }
1260 |               } catch (e) {
1261 |                 console.log('[2Captcha] B≈ÇƒÖd callbacka:', e.message);
1262 |               }
1263 |             }
1264 | 
1265 |             // 3. Fallback - standardowe callbacki
1266 |             try { window.onCaptchaSuccess?.(token); } catch {}
1267 |             try { window.captchaCallback?.(token); } catch {}
1268 | 
1269 |             // 4. Szukaj callbacku w ___grecaptcha_cfg (g≈Çƒôboko)
1270 |             try {
1271 |               const cfg = window.___grecaptcha_cfg;
1272 |               if (cfg?.clients) {
1273 |                 for (const [cid, client] of Object.entries(cfg.clients)) {
1274 |                   for (const [key, obj] of Object.entries(client)) {
1275 |                     if (obj && typeof obj === 'object') {
1276 |                       for (const [subkey, subobj] of Object.entries(obj)) {
1277 |                         if (subobj && typeof subobj === 'object') {
1278 |                           if (typeof subobj.callback === 'function') {
1279 |                             subobj.callback(token);
1280 |                             success = true;
1281 |                             console.log('[2Captcha] Callback znaleziony w:', cid, key, subkey);
1282 |                           }
1283 |                         }
1284 |                       }
1285 |                     }
1286 |                   }
1287 |                 }
1288 |               }
1289 |             } catch {}
1290 | 
1291 |             return success;
1292 |           }, apiResult.token, callbackPath);
1293 | 
1294 |           log.dev("CAPTCHA", `Token reCAPTCHA wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
1295 |           await sleepRandom(1500, 2500);
1296 | 
1297 |           // Kliknij przycisk submit
1298 |           await clickSubmitButton(page);
1299 |           return true;
1300 |         } catch (err) {
1301 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu reCAPTCHA: ${err?.message}`);
1302 |         }
1303 |       }
1304 |     }
1305 |     // === NIEZNANY TYP ===
1306 |     else {
1307 |       log.warn("CAPTCHA", `Nieobs≈Çugiwany typ captcha: ${diagnosis.type}`);
1308 |       log.prod("CAPTCHA", "Szczeg√≥≈Çy diagnozy:", JSON.stringify(diagnosis.details, null, 2));
1309 |     }
1310 | 
1311 |     await sleepRandom(1000, 2000);
1312 |   }
1313 | 
1314 |   // Standardowe sprawdzenie captcha
1315 |   const captchaResult = await solveCaptchaIfPresent(page);
1316 |   if (captchaResult.solved) {
1317 |     log.success("LOGIN", "Captcha rozwiƒÖzana po logowaniu!");
1318 |     await sleepRandom(2000, 3000);
1319 | 
1320 |     // Po rozwiƒÖzaniu captcha, mo≈ºe trzeba kliknƒÖƒá submit ponownie
1321 |     const submitAfterCaptcha = await page.$('button[type="submit"], button[name="login"]');
1322 |     if (submitAfterCaptcha) {
1323 |       await submitAfterCaptcha.click().catch(() => {});
1324 |       await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
1325 |       await sleepRandom(1000, 2000);
1326 |     }
1327 |   }
1328 | 
1329 |   return true;
1330 | }
1331 | 
1332 | /**
1333 |  * Pr√≥ba logowania na dowolnym widocznym formularzu (z lokalnej wersji),
1334 |  * ale z lekkimi ulepszeniami i bez crashy.
1335 |  */
1336 | async function loginViaVisibleForm(page, context = "visible-form") {
1337 |   try {
1338 |     log.debug("LOGIN", `Szukam formularza (${context})...`);
1339 | 
1340 |     await acceptLoginCookies(page).catch(() => {});
1341 |     await acceptCookiesIfPresent(page).catch(() => {});
1342 | 
1343 |     const emailSelector = [
1344 |       "input#email",
1345 |       "input[name='email']",
1346 |       "input[name='email_or_phone']",
1347 |       "input[aria-label*='Adres e-mail']",
1348 |       "input[placeholder*='Adres e-mail']",
1349 |       "input[placeholder*='adres e-mail']",
1350 |       "input[placeholder*='Email']",
1351 |       "input[placeholder*='email']",
1352 |       "input[type='text']",
1353 |     ].join(",");
1354 | 
1355 |     const passSelector = [
1356 |       "input#pass",
1357 |       "input[name='pass']",
1358 |       "input[aria-label*='Has≈Ço']",
1359 |       "input[placeholder*='Has≈Ço']",
1360 |       "input[placeholder*='has≈Ço']",
1361 |       "input[placeholder*='Password']",
1362 |       "input[placeholder*='password']",
1363 |       "input[type='password']",
1364 |     ].join(",");
1365 | 
1366 |     const emailInput = await page.$(emailSelector).catch(() => null);
1367 |     const passInput = await page.$(passSelector).catch(() => null);
1368 | 
1369 |     if (!emailInput || !passInput) {
1370 |       log.debug("LOGIN", "Brak pe≈Çnego formularza na stronie");
1371 |       return false;
1372 |     }
1373 | 
1374 |     const ok = await fillLoginFormBestEffort(page);
1375 |     if (!ok) return false;
1376 | 
1377 |     log.dev("LOGIN", "Formularz logowania wys≈Çany");
1378 |     return true;
1379 |   } catch (err) {
1380 |     log.debug("LOGIN", `B≈ÇƒÖd formularza: ${err?.message || err}`);
1381 |     return false;
1382 |   }
1383 | }
1384 | 
1385 | /**
1386 |  * G≈Ç√≥wne logowanie ‚Äì NAJSTABILNIEJSZE: login.php?next=<URL>
1387 |  * Param nextUrl: URL posta, do kt√≥rego FB ma wr√≥ciƒá po loginie.
1388 |  */
1389 | async function fbLogin(page, nextUrl = "") {
1390 |   try {
1391 |     log.dev("LOGIN", "Start logowania...");
1392 | 
1393 |     const next = nextUrl ? `?next=${encodeURIComponent(nextUrl)}` : "";
1394 |     const url = `https://www.facebook.com/login.php${next}`;
1395 | 
1396 |     await page
1397 |       .goto(url, { waitUntil: "networkidle2", timeout: 60000 })
1398 |       .catch(() => {});
1399 | 
1400 |     await sleepRandom(900, 1400);
1401 | 
1402 |     // cookies ‚Äì dwie metody (mark+click oraz szybki fallback)
1403 |     await acceptLoginCookies(page).catch(() => {});
1404 |     await acceptCookiesIfPresent(page).catch(() => {});
1405 | 
1406 |     const ok = await fillLoginFormBestEffort(page);
1407 |     if (!ok) return false;
1408 | 
1409 |     // FB czasem zostaje na tej samej stronie ‚Äì dodatkowa pauza
1410 |     await sleepRandom(1200, 2000);
1411 | 
1412 |     return true;
1413 |   } catch (e) {
1414 |     log.debug("LOGIN", `B≈ÇƒÖd logowania: ${e?.message || e}`);
1415 |     return false;
1416 |   }
1417 | }
1418 | 
1419 | /**
1420 |  * Heurystyczny check sesji (jak serwer).
1421 |  */
1422 | async function checkIfLogged(page) {
1423 |   try {
1424 |     return await page.evaluate(() => {
1425 |       return !!(
1426 |         document.querySelector('input[aria-label*="Szukaj"]') ||
1427 |         document.querySelector('input[placeholder*="Szukaj"]') ||
1428 |         document.querySelector('a[aria-label*="Profil"]') ||
1429 |         document.querySelector('div[aria-label*="Konto"]')
1430 |       );
1431 |     });
1432 |   } catch {
1433 |     return false;
1434 |   }
1435 | }
1436 | 
1437 | /**
1438 |  * Klikniƒôcie elementu po dok≈Çadnym tek≈õcie (lokalny helper).
1439 |  */
1440 | async function clickByText(page, text) {
1441 |   const res = await page.evaluate((label) => {
1442 |     const els = Array.from(
1443 |       document.querySelectorAll("button, a, div[role='button'], span[role='button']")
1444 |     );
1445 |     const lowLabel = String(label || "").toLowerCase();
1446 |     for (const el of els) {
1447 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
1448 |       if (!t) continue;
1449 |       if (t === lowLabel) {
1450 |         el.click();
1451 |         return true;
1452 |       }
1453 |     }
1454 |     return false;
1455 |   }, text);
1456 |   return res;
1457 | }
1458 | 
1459 | /**
1460 |  * Heurystyka login-wall (serwerowa).
1461 |  * Uwaga: "Log In" czasem jest widoczne mimo, ≈ºe da siƒô czytaƒá komentarze,
1462 |  * wiƒôc to powinno odpalaƒá siƒô dopiero gdy UI nie potrafi odczytaƒá danych.
1463 |  */
1464 | async function looksLikeLoginWall(page) {
1465 |   try {
1466 |     return await page.evaluate(() => {
1467 |       const txt = (document.body?.innerText || "").toLowerCase();
1468 |       if (!txt) return false;
1469 | 
1470 |       const hasLoginWords =
1471 |         txt.includes("log in") ||
1472 |         txt.includes("sign up") ||
1473 |         txt.includes("create new account") ||
1474 |         txt.includes("zaloguj") ||
1475 |         txt.includes("zarejestruj");
1476 | 
1477 |       if (!hasLoginWords) return false;
1478 | 
1479 |       const hasLoginForm =
1480 |         !!document.querySelector("input[type='password']") ||
1481 |         !!document.querySelector("input#email") ||
1482 |         !!document.querySelector("input[name='email']");
1483 | 
1484 |       const hasPostWords =
1485 |         txt.includes("comment") ||
1486 |         txt.includes("comments") ||
1487 |         txt.includes("komentarz") ||
1488 |         txt.includes("lubiƒô to") ||
1489 |         txt.includes("like") ||
1490 |         txt.includes("reply") ||
1491 |         txt.includes("replied");
1492 | 
1493 |       return hasLoginForm || (hasLoginWords && !hasPostWords);
1494 |     });
1495 |   } catch {
1496 |     return false;
1497 |   }
1498 | }
1499 | 
1500 | /**
1501 |  * G≈Ç√≥wny ‚Äûw≈ÇƒÖcznik‚Äù do u≈ºycia w UI handlerach:
1502 |  * - je≈õli wyglƒÖda na login-wall -> login.php?next -> wr√≥ƒá na post
1503 |  * - fallback: pr√≥ba loginViaVisibleForm (gdyby FB zrobi≈Ç overlay)
1504 |  *
1505 |  * Param postUrl: najlepiej podaƒá URL posta (≈ºeby next= dzia≈Ça≈Ço idealnie)
1506 |  */
1507 | async function ensureLoggedInOnPostOverlay(page, postUrl = "") {
1508 |   try {
1509 |     const cur = page.url();
1510 |     const target = postUrl || cur;
1511 | 
1512 |     const wall = await looksLikeLoginWall(page);
1513 |     if (!wall) return false;
1514 | 
1515 |     log.dev("LOGIN", "Wykryto login-wall ‚Üí pr√≥ba logowania");
1516 | 
1517 |     const tried = await fbLogin(page, target);
1518 | 
1519 |     let logged = await checkIfLogged(page);
1520 |     log.dev("LOGIN", `Sesja po fbLogin: ${logged ? "OK" : "BRAK"}`);
1521 | 
1522 |     // je≈õli FB nie przerzuci≈Ç automatycznie, wr√≥ƒá na post
1523 |     if (target && norm(page.url()) !== norm(target)) {
1524 |       await page
1525 |         .goto(target, { waitUntil: "networkidle2", timeout: 60000 })
1526 |         .catch(() => {});
1527 |       await sleepRandom(900, 1400);
1528 |     }
1529 | 
1530 |     // jeszcze raz sprawd≈∫ sesjƒô po powrocie
1531 |     logged = await checkIfLogged(page);
1532 | 
1533 |     // fallback: gdyby FB nadal siedzia≈Ç na overlayu, spr√≥buj visible-form
1534 |     if (!logged) {
1535 |       const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
1536 |       if (usedInline) {
1537 |         logged = await checkIfLogged(page);
1538 |         log.dev("LOGIN", `Sesja po visible-form: ${logged ? "OK" : "BRAK"}`);
1539 |       }
1540 |     }
1541 | 
1542 |     return tried && logged;
1543 |   } catch (e) {
1544 |     log.debug("LOGIN", `ensureLoggedInOnPostOverlay error: ${e?.message || e}`);
1545 |     return false;
1546 |   }
1547 | }
1548 | 
1549 | /**
1550 |  * Wykrywa obecno≈õƒá captcha na stronie (reCAPTCHA, hCaptcha, itp.)
1551 |  */
1552 | async function hasCaptcha(page) {
1553 |   try {
1554 |     const result = await page.evaluate(() => {
1555 |       // reCAPTCHA v2/v3 - rozszerzone selektory
1556 |       const recaptchaSelectors = [
1557 |         'iframe[src*="recaptcha"]',
1558 |         'iframe[src*="google.com/recaptcha"]',
1559 |         'iframe[title*="reCAPTCHA"]',
1560 |         'iframe[title*="recaptcha"]',
1561 |         '.g-recaptcha',
1562 |         '#recaptcha',
1563 |         '[data-sitekey]',
1564 |         '.rc-anchor',
1565 |         '.recaptcha-checkbox',
1566 |       ].join(',');
1567 | 
1568 |       const recaptcha = document.querySelector(recaptchaSelectors);
1569 | 
1570 |       // hCaptcha
1571 |       const hcaptcha = document.querySelector(
1572 |         'iframe[src*="hcaptcha"], .h-captcha'
1573 |       );
1574 | 
1575 |       // Facebook image captcha
1576 |       const fbCaptcha = document.querySelector(
1577 |         'img[src*="captcha"], input[name*="captcha"]'
1578 |       );
1579 | 
1580 |       // Tekst "Nie jestem robotem" / "I'm not a robot" na stronie
1581 |       const bodyText = (document.body?.innerText || '').toLowerCase();
1582 |       const hasRobotText = bodyText.includes('nie jestem robotem') ||
1583 |                           bodyText.includes("i'm not a robot") ||
1584 |                           bodyText.includes('recaptcha');
1585 | 
1586 |       // URL zawiera verification/authentication z recaptcha
1587 |       const url = window.location.href.toLowerCase();
1588 |       const isVerificationPage = url.includes('two_step_verification') ||
1589 |                                   url.includes('checkpoint');
1590 | 
1591 |       return {
1592 |         found: !!(recaptcha || hcaptcha || fbCaptcha || (hasRobotText && isVerificationPage)),
1593 |         details: {
1594 |           recaptcha: !!recaptcha,
1595 |           hcaptcha: !!hcaptcha,
1596 |           fbCaptcha: !!fbCaptcha,
1597 |           robotText: hasRobotText,
1598 |           verificationPage: isVerificationPage
1599 |         }
1600 |       };
1601 |     });
1602 | 
1603 |     if (result.found) {
1604 |       log.debug("CAPTCHA", "Wykryto captcha", result.details);
1605 |     }
1606 | 
1607 |     return result.found;
1608 |   } catch {
1609 |     return false;
1610 |   }
1611 | }
1612 | 
1613 | /**
1614 |  * Pr√≥buje rozwiƒÖzaƒá captcha na stronie (je≈õli plugin 2Captcha jest w≈ÇƒÖczony).
1615 |  * Wymaga puppeteer-extra-plugin-recaptcha.
1616 |  * @returns {Promise<{solved: boolean, error?: string}>}
1617 |  */
1618 | async function solveCaptchaIfPresent(page) {
1619 |   if (!CAPTCHA_ENABLED) {
1620 |     log.debug("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
1621 |     return { solved: false, error: "disabled" };
1622 |   }
1623 | 
1624 |   try {
1625 |     const detected = await hasCaptcha(page);
1626 |     if (!detected) {
1627 |       log.debug("CAPTCHA", "Brak captcha na stronie");
1628 |       return { solved: false, error: "no_captcha" };
1629 |     }
1630 | 
1631 |     log.prod("CAPTCHA", "Wykryto captcha - rozpoczynam rozwiƒÖzywanie...");
1632 | 
1633 |     // puppeteer-extra-plugin-recaptcha dodaje metodƒô solveRecaptchas() do page
1634 |     if (typeof page.solveRecaptchas !== "function") {
1635 |       log.warn("CAPTCHA", "Plugin recaptcha nie jest za≈Çadowany");
1636 |       return { solved: false, error: "plugin_not_loaded" };
1637 |     }
1638 | 
1639 |     const result = await page.solveRecaptchas();
1640 | 
1641 |     if (result.solved && result.solved.length > 0) {
1642 |       log.prod("CAPTCHA", `RozwiƒÖzano ${result.solved.length} captcha!`);
1643 |       await sleepRandom(1000, 2000);
1644 |       return { solved: true };
1645 |     } else if (result.error) {
1646 |       log.warn("CAPTCHA", `B≈ÇƒÖd rozwiƒÖzywania: ${result.error}`);
1647 |       return { solved: false, error: result.error };
1648 |     } else {
1649 |       log.debug("CAPTCHA", "Brak captcha do rozwiƒÖzania (lub nieobs≈Çugiwany typ)");
1650 |       return { solved: false, error: "unsupported_or_none" };
1651 |     }
1652 |   } catch (err) {
1653 |     log.warn("CAPTCHA", `WyjƒÖtek: ${err?.message || err}`);
1654 |     return { solved: false, error: err?.message || "unknown" };
1655 |   }
1656 | }
1657 | 
1658 | export {
1659 |   fbLogin,
1660 |   checkIfLogged,
1661 |   ensureLoggedInOnPostOverlay,
1662 |   clickByText,
1663 |   acceptLoginCookies,
1664 |   loginViaVisibleForm,
1665 |   hasCaptcha,
1666 |   solveCaptchaIfPresent,
1667 | };
1668 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/scroll.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
 1 | import { gaussianRandom, sleep } from "../utils/sleep.js";
 2 | 
 3 | /**
 4 |  * Scrollowanie posta - p≈Çynne, human-like
 5 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
 6 |  * - scrollujemy w ma≈Çych krokach z losowymi op√≥≈∫nieniami
 7 |  */
 8 | async function scrollPost(page, amount = 450) {
 9 |   // Human behavior: scrolluj w ma≈Çych krokach (jak k√≥≈Çko myszy)
10 |   const steps = Math.max(3, Math.ceil(amount / 80)); // ~80px na krok
11 |   const stepAmount = Math.round(amount / steps);
12 | 
13 |   for (let i = 0; i < steps; i++) {
14 |     await page.evaluate((dy) => {
15 |       function findScrollableAncestor(start) {
16 |         let el = start;
17 |         while (el) {
18 |           const style = window.getComputedStyle(el);
19 |           const canScrollY =
20 |             style.overflowY === "auto" || style.overflowY === "scroll";
21 |           if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
22 |             return el;
23 |           }
24 |           el = el.parentElement;
25 |         }
26 |         return null;
27 |       }
28 | 
29 |       // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
30 |       const centerEl = document.elementFromPoint(
31 |         window.innerWidth / 2,
32 |         window.innerHeight / 2
33 |       );
34 | 
35 |       let target = centerEl ? findScrollableAncestor(centerEl) : null;
36 | 
37 |       // fallback: dialog
38 |       if (!target) {
39 |         const dialog = document.querySelector("div[role='dialog']");
40 |         if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
41 |           target = dialog;
42 |         }
43 |       }
44 | 
45 |       // ostateczny fallback: dokument
46 |       if (!target) {
47 |         target =
48 |           document.scrollingElement || document.documentElement || document.body;
49 |       }
50 | 
51 |       if (
52 |         target === document.body ||
53 |         target === document.documentElement ||
54 |         target === document.scrollingElement
55 |       ) {
56 |         const before = window.scrollY;
57 |         window.scrollTo(0, before + dy);
58 |       } else {
59 |         target.scrollTop += dy;
60 |       }
61 |     }, stepAmount);
62 | 
63 |     // Human delay miƒôdzy krokami scrollowania (30-80ms)
64 |     if (i < steps - 1) {
65 |       const delay = gaussianRandom(50, 15);
66 |       await sleep(Math.max(20, Math.min(100, delay)));
67 |     }
68 |   }
69 | }
70 | 
71 | export { scrollPost };
72 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
 1 | // src/fb/ui/index.js
 2 | import * as PostUI from "./post.js";
 3 | import * as PhotoUI from "./photo.js";
 4 | import * as WatchUI from "./watch.js";
 5 | import * as VideosUI from "./videos.js";
 6 | 
 7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
 8 | 
 9 | export function pickUiHandler(url) {
10 |   const u = String(url || "");
11 |   for (const h of HANDLERS) {
12 |     try {
13 |       if (h.matchesUrl(u)) return h;
14 |     } catch {}
15 |   }
16 |   return PostUI;
17 | }
18 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/photo.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
   1 | // src/fb/ui/photo.js
   2 | import { safeGoto } from "../../utils/navigation.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { scrollPost } from "../scroll.js";
   5 | import { acceptCookies, saveCookies } from "../cookies.js";
   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
   7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
   8 | import log from "../../utils/logger.js";
   9 | 
  10 | export const type = "photo";
  11 | 
  12 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
  13 | 
  14 | /**
  15 |  * WA≈ªNE:
  16 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
  17 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
  18 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
  19 |  */
  20 | const PACE_CFG =
  21 |   PACE === "server"
  22 |     ? {
  23 |         // delikatnie wolniej na serwerze (render/CPU)
  24 |         stepJitterMinMs: 140,
  25 |         stepJitterMaxMs: 260,
  26 | 
  27 |         afterScrollMinMs: 260,
  28 |         afterScrollMaxMs: 520,
  29 | 
  30 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
  31 |         effectWaitMs: 5200,
  32 | 
  33 |         scrollPx: 140,
  34 | 
  35 |         // bonusowe kliki, ale event-driven
  36 |         bonusClickTries: 2,
  37 |         bonusClickDelayMinMs: 120,
  38 |         bonusClickDelayMaxMs: 220,
  39 | 
  40 |         // HARD BOTTOM (sprawdzane rzadko)
  41 |         hardBottomEpsPx: 10,
  42 |         hardBottomStableNeed: 4,
  43 |         hardBottomStableDelayMinMs: 320,
  44 |         hardBottomStableDelayMaxMs: 560,
  45 |       }
  46 |     : {
  47 |         // lokalnie szybciej
  48 |         stepJitterMinMs: 90,
  49 |         stepJitterMaxMs: 190,
  50 | 
  51 |         afterScrollMinMs: 180,
  52 |         afterScrollMaxMs: 420,
  53 | 
  54 |         effectWaitMs: 4200,
  55 | 
  56 |         scrollPx: 160,
  57 | 
  58 |         bonusClickTries: 2,
  59 |         bonusClickDelayMinMs: 90,
  60 |         bonusClickDelayMaxMs: 180,
  61 | 
  62 |         hardBottomEpsPx: 10,
  63 |         hardBottomStableNeed: 4,
  64 |         hardBottomStableDelayMinMs: 240,
  65 |         hardBottomStableDelayMaxMs: 420,
  66 |       };
  67 | 
  68 | export function matchesUrl(url) {
  69 |   try {
  70 |     const u = new URL(url);
  71 |     const path = (u.pathname || "").toLowerCase();
  72 | 
  73 |     if (path.includes("photo.php")) return true;
  74 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
  75 |     if (u.searchParams.has("fbid")) return true;
  76 | 
  77 |     return false;
  78 |   } catch {
  79 |     const lower = (url || "").toLowerCase();
  80 |     if (lower.includes("photo.php")) return true;
  81 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
  82 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
  83 |     return false;
  84 |   }
  85 | }
  86 | 
  87 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
  88 | 
  89 | async function clickAllCommentsInMenu(page) {
  90 |   const result = await page.evaluate(() => {
  91 |     const menu =
  92 |       document.querySelector("div[role='menu']") ||
  93 |       document.querySelector("div[role='dialog']");
  94 | 
  95 |     if (!menu) return { clicked: false, noMenu: true };
  96 | 
  97 |     const items = Array.from(
  98 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
  99 |     );
 100 | 
 101 |     const opt = items.find((el) => {
 102 |       const t = (el.textContent || "").trim().toLowerCase();
 103 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
 104 |     });
 105 | 
 106 |     if (!opt) return { clicked: false, noMenu: false };
 107 | 
 108 |     opt.click();
 109 |     setTimeout(() => {
 110 |       try {
 111 |         document.body.click();
 112 |       } catch {}
 113 |     }, 50);
 114 | 
 115 |     return { clicked: true, noMenu: false };
 116 |   });
 117 | 
 118 |   if (result.clicked) {
 119 |     await sleepRandom(180, 320);
 120 |     await page
 121 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
 122 |       .catch(() => {});
 123 |   }
 124 | 
 125 |   return result;
 126 | }
 127 | 
 128 | async function switchCommentsFilterToAll(page) {
 129 |   log.debug("UI:photo", "Prze≈ÇƒÖczam filtr ‚Üí wszystkie komentarze");
 130 | 
 131 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 132 |   if (menuAlreadyOpen) {
 133 |     const r = await clickAllCommentsInMenu(page);
 134 |     return !!r.clicked;
 135 |   }
 136 | 
 137 |   const pre = await page.evaluate(() => {
 138 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 139 |     let filterEl = null;
 140 |     let labelText = "";
 141 | 
 142 |     for (const el of els) {
 143 |       const t = (el.textContent || "").trim();
 144 |       if (!t) continue;
 145 |       const low = t.toLowerCase();
 146 |       if (
 147 |         low === "najtrafniejsze" ||
 148 |         low === "most relevant" ||
 149 |         low === "wszystkie komentarze" ||
 150 |         low === "all comments"
 151 |       ) {
 152 |         filterEl = el;
 153 |         labelText = low;
 154 |         break;
 155 |       }
 156 |     }
 157 | 
 158 |     if (!filterEl) return { state: "not-found" };
 159 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 160 |       return { state: "already-all" };
 161 |     }
 162 | 
 163 |     filterEl.click();
 164 |     return { state: "clicked-filter" };
 165 |   });
 166 | 
 167 |   if (pre.state === "not-found") return false;
 168 |   if (pre.state === "already-all") return true;
 169 | 
 170 |   await sleepRandom(120, 220);
 171 |   const r = await clickAllCommentsInMenu(page);
 172 |   if (r.clicked) return true;
 173 | 
 174 |   const afterLabelIsAll = await page.evaluate(() => {
 175 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 176 |     return els.some((el) => {
 177 |       const t = (el.textContent || "").trim().toLowerCase();
 178 |       return t === "wszystkie komentarze" || t === "all comments";
 179 |     });
 180 |   });
 181 | 
 182 |   return afterLabelIsAll;
 183 | }
 184 | 
 185 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
 186 | 
 187 | async function getCommentsRootHandle(page) {
 188 |   const handle = await page.evaluateHandle(() => {
 189 |     const norm = (s) =>
 190 |       String(s || "")
 191 |         .replace(/\u00a0/g, " ")
 192 |         .replace(/\s+/g, " ")
 193 |         .trim()
 194 |         .toLowerCase();
 195 | 
 196 |     const isVisible = (el) => {
 197 |       if (!el) return false;
 198 |       try {
 199 |         const r = el.getBoundingClientRect();
 200 |         return r.width > 2 && r.height > 2;
 201 |       } catch {
 202 |         return true;
 203 |       }
 204 |     };
 205 | 
 206 |     const isMoreCommentsBtn = (el) => {
 207 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 208 |       if (!t) return false;
 209 |       return (
 210 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 211 |         t.includes("zobacz wiƒôcej komentarzy") ||
 212 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
 213 |         t.includes("view more comments") ||
 214 |         t.includes("view previous comments")
 215 |       );
 216 |     };
 217 | 
 218 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
 219 |       isVisible
 220 |     );
 221 |     const keyBtn = btns.find(isMoreCommentsBtn);
 222 | 
 223 |     if (keyBtn) {
 224 |       const dlg = keyBtn.closest?.("div[role='dialog']");
 225 |       if (dlg) return dlg;
 226 | 
 227 |       let cur = keyBtn.parentElement;
 228 |       for (let i = 0; i < 20 && cur; i++) {
 229 |         if (cur.matches?.("article,main,section,div")) return cur;
 230 |         cur = cur.parentElement;
 231 |       }
 232 |     }
 233 | 
 234 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 235 |     const dlg2 = dialogs.find((d) => {
 236 |       const t = norm(d.innerText || d.textContent);
 237 |       if (!t) return false;
 238 |       if (t.includes("powiadomienia")) return false;
 239 |       if (t.includes("szukaj znajomych")) return false;
 240 |       return (
 241 |         t.includes("najtrafniejsze") ||
 242 |         t.includes("most relevant") ||
 243 |         t.includes("komentarz") ||
 244 |         t.includes("comment")
 245 |       );
 246 |     });
 247 |     if (dlg2) return dlg2;
 248 | 
 249 |     return document.body;
 250 |   });
 251 | 
 252 |   return handle;
 253 | }
 254 | 
 255 | async function getCommentsScrollHandle(page, rootHandle) {
 256 |   const handle = await page.evaluateHandle((root) => {
 257 |     const isVisible = (el) => {
 258 |       if (!el) return false;
 259 |       try {
 260 |         const r = el.getBoundingClientRect();
 261 |         return r.width > 2 && r.height > 2;
 262 |       } catch {
 263 |         return true;
 264 |       }
 265 |     };
 266 | 
 267 |     const canScrollByTest = (el) => {
 268 |       try {
 269 |         if (!el) return false;
 270 |         const h = el.clientHeight || 0;
 271 |         const sh = el.scrollHeight || 0;
 272 |         if (sh <= h + 40) return false;
 273 | 
 274 |         const before = el.scrollTop ?? 0;
 275 |         el.scrollTop = before + 80;
 276 |         const after = el.scrollTop ?? before;
 277 |         el.scrollTop = before;
 278 | 
 279 |         return after !== before;
 280 |       } catch {
 281 |         return false;
 282 |       }
 283 |     };
 284 | 
 285 |     const closestScrollable = (start) => {
 286 |       let cur = start;
 287 |       for (let i = 0; i < 28 && cur; i++) {
 288 |         if (canScrollByTest(cur)) return cur;
 289 |         cur = cur.parentElement;
 290 |       }
 291 |       return null;
 292 |     };
 293 | 
 294 |     const scope = root || document;
 295 | 
 296 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
 297 |     if (outer) {
 298 |       const sc = closestScrollable(outer);
 299 |       if (sc) return sc;
 300 |     }
 301 | 
 302 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
 303 |       .filter(isVisible)
 304 |       .slice(0, 25000);
 305 | 
 306 |     let best = null;
 307 |     let bestDelta = -1;
 308 |     for (const el of candidates) {
 309 |       if (!canScrollByTest(el)) continue;
 310 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
 311 |       if (delta > bestDelta) {
 312 |         bestDelta = delta;
 313 |         best = el;
 314 |       }
 315 |     }
 316 | 
 317 |     return best || null;
 318 |   }, rootHandle);
 319 | 
 320 |   return handle;
 321 | }
 322 | 
 323 | /* ======================================================================== */
 324 | 
 325 | export async function prepare(page, url) {
 326 |   log.dev("UI:photo", `Prepare: ${url}`);
 327 | 
 328 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 329 |   if (!ok) throw new Error("safeGoto-failed");
 330 | 
 331 |   if (page.url().includes("/login")) {
 332 |     log.dev("UI:photo", "/login ‚Äì fbLogin + re-enter");
 333 |     await fbLogin(page);
 334 |     await sleepRandom(2500, 4000);
 335 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 336 |   }
 337 | 
 338 |   await acceptCookies(page, "photo-initial");
 339 | 
 340 |   const logged = await checkIfLogged(page).catch(() => false);
 341 |   if (!logged) {
 342 |     log.dev("UI:photo", "Brak sesji ‚Äì fbLogin()");
 343 |     await fbLogin(page);
 344 |     await sleepRandom(2500, 4000);
 345 |   }
 346 | 
 347 |   await ensureLoggedInOnPostOverlay(page);
 348 |   await acceptCookies(page, "photo");
 349 | 
 350 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
 351 |   if (loggedFinal) await saveCookies(page);
 352 | }
 353 | 
 354 | function parseNumberLikeNode(str) {
 355 |   if (!str) return null;
 356 | 
 357 |   const cleaned = String(str)
 358 |     .toLowerCase()
 359 |     .replace(/\u00a0/g, " ")
 360 |     .replace(/\s+/g, " ")
 361 |     .trim();
 362 | 
 363 |   const plain = cleaned.replace(/[^\d]/g, "");
 364 |   if (/^\d+$/.test(plain)) {
 365 |     const n = Number(plain);
 366 |     return Number.isFinite(n) ? n : null;
 367 |   }
 368 | 
 369 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 370 |   if (m) {
 371 |     const base = Number(m[1].replace(",", "."));
 372 |     if (Number.isFinite(base)) return Math.round(base * 1000);
 373 |   }
 374 | 
 375 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 376 |   if (m2) {
 377 |     const base = Number(m2[1].replace(",", "."));
 378 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
 379 |   }
 380 | 
 381 |   return null;
 382 | }
 383 | 
 384 | async function getPhotoUiCountFromChip(page, rootHandle) {
 385 |   const res = await page
 386 |     .evaluate((root) => {
 387 |       const scope = root || document;
 388 | 
 389 |       const norm = (s) =>
 390 |         String(s || "")
 391 |           .replace(/\u00a0/g, " ")
 392 |           .replace(/\s+/g, " ")
 393 |           .trim();
 394 | 
 395 |       const parseNum = (s) => {
 396 |         const t = norm(s);
 397 |         if (!t) return null;
 398 | 
 399 |         const plain = t.replace(/[^\d]/g, "");
 400 |         if (/^\d+$/.test(plain)) return Number(plain);
 401 | 
 402 |         const lower = t.toLowerCase();
 403 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 404 |         if (m) {
 405 |           const base = Number(m[1].replace(",", "."));
 406 |           if (Number.isFinite(base)) return Math.round(base * 1000);
 407 |         }
 408 | 
 409 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 410 |         if (m2) {
 411 |           const base = Number(m2[1].replace(",", "."));
 412 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
 413 |         }
 414 | 
 415 |         return null;
 416 |       };
 417 | 
 418 |       const isVisible = (el) => {
 419 |         if (!el) return false;
 420 |         const r = el.getBoundingClientRect();
 421 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
 422 |       };
 423 | 
 424 |       const commentBtn = Array.from(
 425 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
 426 |       ).find((el) => {
 427 |         const t = norm(el.textContent).toLowerCase();
 428 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
 429 |       });
 430 | 
 431 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
 432 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
 433 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
 434 | 
 435 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
 436 |         .filter(isVisible)
 437 |         .slice(0, 5000);
 438 | 
 439 |       let best = null;
 440 |       let bestScore = -Infinity;
 441 | 
 442 |       for (const el of candidates) {
 443 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
 444 |         if (!hasIcon) continue;
 445 | 
 446 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
 447 |         let num = null;
 448 |         let raw = null;
 449 | 
 450 |         for (const sp of spans) {
 451 |           const t = norm(sp.textContent);
 452 |           if (!t) continue;
 453 |           if (t.length > 24) continue;
 454 | 
 455 |           const n = parseNum(t);
 456 |           if (typeof n === "number" && Number.isFinite(n)) {
 457 |             if (n <= 0 || n > 10000000) continue;
 458 |             num = n;
 459 |             raw = t;
 460 |             break;
 461 |           }
 462 |         }
 463 | 
 464 |         if (num == null) continue;
 465 | 
 466 |         const r = el.getBoundingClientRect();
 467 |         const cx = r.left + r.width / 2;
 468 |         const cy = r.top + r.height / 2;
 469 | 
 470 |         let score = 0;
 471 | 
 472 |         if (anchorCx != null && anchorCy != null) {
 473 |           const dx = cx - anchorCx;
 474 |           const dy = cy - anchorCy;
 475 |           const dist = Math.sqrt(dx * dx + dy * dy);
 476 |           score -= dist;
 477 |         }
 478 | 
 479 |         const textLen = norm(el.textContent).length;
 480 |         score -= Math.min(400, textLen);
 481 | 
 482 |         score += Math.min(200, Math.log10(num + 1) * 120);
 483 | 
 484 |         if (score > bestScore) {
 485 |           bestScore = score;
 486 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
 487 |         }
 488 |       }
 489 | 
 490 |       return best;
 491 |     }, rootHandle)
 492 |     .catch(() => null);
 493 | 
 494 |   if (!res || typeof res.count !== "number") return null;
 495 |   return { count: res.count, raw: res.raw, dbg: res };
 496 | }
 497 | 
 498 | export async function getCommentCount(page, url) {
 499 |   log.dev("UI:photo", "Liczƒô komentarze...");
 500 | 
 501 |   await scrollPost(page, 220);
 502 |   await sleepRandom(220, 420);
 503 | 
 504 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
 505 |   log.debug("UI:photo", `Filtr all comments: ${okFilter}`);
 506 | 
 507 |   // mikro settle po filtrze (bez mulenia)
 508 |   await sleepRandom(220, 420);
 509 | 
 510 |   const rootHandle = await getCommentsRootHandle(page);
 511 | 
 512 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
 513 |   if (chip?.count != null) {
 514 |     log.debug("UI:photo", "UI count (chip)", chip);
 515 |   }
 516 | 
 517 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
 518 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
 519 | 
 520 |   const loaded = await page
 521 |     .evaluate((root) => {
 522 |       const scope = root || document;
 523 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 524 |       const ids = new Set();
 525 |       for (const a of as) {
 526 |         const href = a.getAttribute("href") || "";
 527 |         const m = href.match(/comment_id=([^&]+)/);
 528 |         if (m && m[1]) ids.add(m[1]);
 529 |       }
 530 |       return ids.size || null;
 531 |     }, rootHandle)
 532 |     .catch(() => null);
 533 | 
 534 |   let total = null;
 535 |   let source = "none";
 536 | 
 537 |   if (chip?.count != null) {
 538 |     total = chip.count;
 539 |     source = "ui-photo-chip";
 540 |   } else if (infoCount != null) {
 541 |     total = infoCount;
 542 |     source = uiInfo?.source || "uicommentinfo";
 543 |   } else if (loaded != null) {
 544 |     total = loaded;
 545 |     source = "loaded-comment_id";
 546 |   }
 547 | 
 548 |   log.debug("UI:photo", "UI comments", {
 549 |     source,
 550 |     chip: chip?.count ?? null,
 551 |     uiInfoSource: uiInfo?.source ?? null,
 552 |     uiInfoRaw: uiInfo?.raw ?? null,
 553 |     uiInfoCount: infoCount,
 554 |     loaded,
 555 |     chosen: total,
 556 |   });
 557 | 
 558 |   try {
 559 |     await rootHandle.dispose?.();
 560 |   } catch {}
 561 | 
 562 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
 563 |   await sleepRandom(180, 340);
 564 | 
 565 |   return total;
 566 | }
 567 | 
 568 | export async function loadAllComments(page, { expectedTotal } = {}) {
 569 |   log.dev("UI:photo", `loadAllComments expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
 570 | 
 571 |   const MAX_STEPS = 900;
 572 |   const MAX_NO_PROGRESS = 28;
 573 | 
 574 |   let noProgress = 0;
 575 | 
 576 |   const rootHandle = await getCommentsRootHandle(page);
 577 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
 578 | 
 579 |   const shortBtn = (t) => {
 580 |     const s = String(t || "").replace(/\s+/g, " ").trim();
 581 |     if (s.length <= 90) return s;
 582 |     return s.slice(0, 90) + "‚Ä¶";
 583 |   };
 584 | 
 585 |   async function countAnchors() {
 586 |     return page.evaluate((root) => {
 587 |       const scope = root || document;
 588 | 
 589 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 590 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
 591 | 
 592 |       const uniq = (arr, param) => {
 593 |         const ids = new Set();
 594 |         for (const a of arr) {
 595 |           const href = a.getAttribute("href") || "";
 596 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
 597 |           if (m && m[1]) ids.add(m[1]);
 598 |         }
 599 |         return ids.size;
 600 |       };
 601 | 
 602 |       return {
 603 |         commentsAnchors: uniq(commentAs, "comment_id"),
 604 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
 605 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
 606 |       };
 607 |     }, rootHandle);
 608 |   }
 609 | 
 610 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
 611 |     try {
 612 |       const info = await page.evaluate((root, scroller, px) => {
 613 |         const pick =
 614 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
 615 | 
 616 |         const before =
 617 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 618 | 
 619 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
 620 |         else window.scrollBy(0, px);
 621 | 
 622 |         const after =
 623 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 624 | 
 625 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
 626 |       }, rootHandle, scrollHandle, pixels);
 627 | 
 628 |       if (!info?.moved) {
 629 |         log.debug("UI:photo", `Scroll NO-MOVE tag=${info?.tag} ${info?.before}‚Üí${info?.after}`);
 630 |       }
 631 |     } catch {
 632 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
 633 |     }
 634 | 
 635 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
 636 |   }
 637 | 
 638 |   async function getScrollMetrics() {
 639 |     return page.evaluate((root, scroller) => {
 640 |       const pick =
 641 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 642 | 
 643 |       const isEl = pick && typeof pick.scrollHeight === "number";
 644 | 
 645 |       if (!isEl) {
 646 |         const se = document.scrollingElement || document.documentElement || document.body;
 647 |         return {
 648 |           tag: "WINDOW",
 649 |           scrollTop: window.scrollY || 0,
 650 |           scrollHeight: se?.scrollHeight || 0,
 651 |           clientHeight: window.innerHeight || 0,
 652 |         };
 653 |       }
 654 | 
 655 |       return {
 656 |         tag: pick.tagName || "UNKNOWN",
 657 |         scrollTop: pick.scrollTop || 0,
 658 |         scrollHeight: pick.scrollHeight || 0,
 659 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
 660 |       };
 661 |     }, rootHandle, scrollHandle);
 662 |   }
 663 | 
 664 |   async function hasLoadMoreButtons() {
 665 |     return page.evaluate((root) => {
 666 |       const scope = root || document;
 667 | 
 668 |       const norm = (s) =>
 669 |         String(s || "")
 670 |           .replace(/\u00a0/g, " ")
 671 |           .replace(/\s+/g, " ")
 672 |           .trim()
 673 |           .toLowerCase();
 674 | 
 675 |       const isVisible = (el) => {
 676 |         if (!el) return false;
 677 |         const r = el.getBoundingClientRect();
 678 |         if (r.width < 2 || r.height < 2) return false;
 679 |         return r.bottom > 0 && r.top < window.innerHeight;
 680 |       };
 681 | 
 682 |       const nodesBtn = Array.from(
 683 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 684 |       ).filter(isVisible);
 685 | 
 686 |       return nodesBtn.some((el) => {
 687 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 688 | 
 689 |         if (
 690 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 691 |           t.includes("zobacz wiƒôcej komentarzy") ||
 692 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 693 |           t.includes("view more comments") ||
 694 |           t.includes("view previous comments")
 695 |         )
 696 |           return true;
 697 | 
 698 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 699 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 700 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 701 |         if (t.includes("view") && t.includes("repl")) return true;
 702 |         if (t.includes("see") && t.includes("repl")) return true;
 703 | 
 704 |         return false;
 705 |       });
 706 |     }, rootHandle);
 707 |   }
 708 | 
 709 |   function isHardBottom(m) {
 710 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
 711 |     const top = Number(m?.scrollTop || 0);
 712 |     const ch = Number(m?.clientHeight || 0);
 713 |     const sh = Number(m?.scrollHeight || 0);
 714 |     if (!sh || !ch) return false;
 715 |     return top + ch >= sh - eps;
 716 |   }
 717 | 
 718 |   let bottomStable = 0;
 719 |   let lastBottomScrollHeight = null;
 720 | 
 721 |   async function updateHardBottomStability() {
 722 |     const m1 = await getScrollMetrics().catch(() => null);
 723 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
 724 | 
 725 |     const atBottom = isHardBottom(m1);
 726 | 
 727 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
 728 | 
 729 |     const m2 = await getScrollMetrics().catch(() => m1);
 730 |     const atBottom2 = isHardBottom(m2);
 731 | 
 732 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
 733 | 
 734 |     const sh = Number(m2?.scrollHeight || 0);
 735 |     const shStable =
 736 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
 737 | 
 738 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
 739 |     else bottomStable = 0;
 740 | 
 741 |     lastBottomScrollHeight = sh;
 742 | 
 743 |     return {
 744 |       atBottom: atBottom && atBottom2,
 745 |       stable: bottomStable,
 746 |       tag: m2?.tag || "UNKNOWN",
 747 |       anyMore,
 748 |       scrollTop: m2?.scrollTop,
 749 |       clientHeight: m2?.clientHeight,
 750 |       scrollHeight: m2?.scrollHeight,
 751 |     };
 752 |   }
 753 | 
 754 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
 755 |   async function waitForEffect(beforeCounts, kind) {
 756 |     const timeout = PACE_CFG.effectWaitMs;
 757 | 
 758 |     const ok = await page
 759 |       .waitForFunction(
 760 |         (root, before, kindArg) => {
 761 |           const scope = root || document;
 762 | 
 763 |           const countUniq = (sel, param) => {
 764 |             const as = Array.from(scope.querySelectorAll(sel));
 765 |             const ids = new Set();
 766 |             for (const a of as) {
 767 |               const href = a.getAttribute("href") || "";
 768 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
 769 |               if (m && m[1]) ids.add(m[1]);
 770 |             }
 771 |             return ids.size;
 772 |           };
 773 | 
 774 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
 775 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
 776 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
 777 | 
 778 |           if (
 779 |             commentsAnchors > (before?.commentsAnchors || 0) ||
 780 |             replyAnchors > (before?.replyAnchors || 0) ||
 781 |             nodes > (before?.nodes || 0)
 782 |           ) {
 783 |             return true;
 784 |           }
 785 | 
 786 |           const norm = (s) =>
 787 |             String(s || "")
 788 |               .replace(/\u00a0/g, " ")
 789 |               .replace(/\s+/g, " ")
 790 |               .trim()
 791 |               .toLowerCase();
 792 | 
 793 |           const isVisible = (el) => {
 794 |             if (!el) return false;
 795 |             const r = el.getBoundingClientRect();
 796 |             if (r.width < 2 || r.height < 2) return false;
 797 |             return r.bottom > 0 && r.top < window.innerHeight;
 798 |           };
 799 | 
 800 |           const nodesBtn = Array.from(
 801 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 802 |           ).filter(isVisible);
 803 | 
 804 |           const stillThere =
 805 |             kindArg === "comments"
 806 |               ? nodesBtn.some((el) => {
 807 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 808 |                   return (
 809 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 810 |                     t.includes("zobacz wiƒôcej komentarzy") ||
 811 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
 812 |                     t.includes("view more comments") ||
 813 |                     t.includes("view previous comments")
 814 |                   );
 815 |                 })
 816 |               : nodesBtn.some((el) => {
 817 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 818 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 819 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 820 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
 821 |                   if (t.includes("view") && t.includes("repl")) return true;
 822 |                   if (t.includes("see") && t.includes("repl")) return true;
 823 |                   return false;
 824 |                 });
 825 | 
 826 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
 827 |           return !stillThere;
 828 |         },
 829 |         { timeout, polling: 120 },
 830 |         rootHandle,
 831 |         beforeCounts,
 832 |         kind
 833 |       )
 834 |       .then(() => true)
 835 |       .catch(() => false);
 836 | 
 837 |     return ok;
 838 |   }
 839 | 
 840 |   async function bonusClicks(kind, beforeCounts) {
 841 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
 842 |     if (!tries) return 0;
 843 | 
 844 |     let clicked = 0;
 845 |     let curBefore = beforeCounts;
 846 | 
 847 |     for (let i = 0; i < tries; i++) {
 848 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
 849 | 
 850 |       const res =
 851 |         kind === "replies"
 852 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
 853 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 854 | 
 855 |       if (!res?.clicked) break;
 856 | 
 857 |       clicked++;
 858 | 
 859 |       // mikro-oddech, potem czekamy na efekt
 860 |       await sleepRandom(80, 140);
 861 |       await waitForEffect(curBefore, kind);
 862 | 
 863 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
 864 |       curBefore = await countAnchors().catch(() => curBefore);
 865 | 
 866 |       // minimalny settle po do≈Çadowaniu
 867 |       await sleepRandom(90, 170);
 868 |     }
 869 | 
 870 |     return clicked;
 871 |   }
 872 | 
 873 |     async function clickOneReplyButton() {
 874 |     const res = await page.evaluate((root) => {
 875 |       const scope = root || document;
 876 | 
 877 |       const norm = (s) =>
 878 |         String(s || "")
 879 |           .replace(/\u00a0/g, " ")
 880 |           .replace(/\s+/g, " ")
 881 |           .trim()
 882 |           .toLowerCase();
 883 | 
 884 |       const isVisible = (el) => {
 885 |         if (!el) return false;
 886 |         try {
 887 |           const r = el.getBoundingClientRect();
 888 |           if (r.width < 2 || r.height < 2) return false;
 889 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
 890 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
 891 |         } catch {
 892 |           return true;
 893 |         }
 894 |       };
 895 | 
 896 |       const isReplyExpanderText = (t) => {
 897 |         if (!t) return false;
 898 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 899 |         if (t.length > 220) return false;
 900 | 
 901 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
 902 |         if (t === "odpowiedz" || t === "reply") return false;
 903 |         if (t.startsWith("odpowiedz ")) return false;
 904 |         if (t.startsWith("reply ")) return false;
 905 | 
 906 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
 907 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 908 | 
 909 |         // warianty opisowe
 910 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 911 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 912 |         if (t.includes("view") && t.includes("repl")) return true;
 913 |         if (t.includes("see") && t.includes("repl")) return true;
 914 | 
 915 |         return false;
 916 |       };
 917 | 
 918 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
 919 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
 920 |       const allTextCandidates = Array.from(
 921 |         scope.querySelectorAll("a,button,div,span")
 922 |       )
 923 |         .filter(isVisible)
 924 |         .slice(0, 35000);
 925 | 
 926 |       let best = null;
 927 |       let bestScore = -Infinity;
 928 | 
 929 |       for (const el of allTextCandidates) {
 930 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
 931 |         const t = norm(tRaw);
 932 |         if (!isReplyExpanderText(t)) continue;
 933 | 
 934 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
 935 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 936 |         if (t.includes("udost") || t.includes("share")) continue;
 937 | 
 938 |         const r = el.getBoundingClientRect();
 939 |         let score = 0;
 940 | 
 941 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
 942 |         score += Math.max(0, r.top);
 943 | 
 944 |         // preferuj te z liczbƒÖ odpowiedzi
 945 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
 946 | 
 947 |         // preferuj ‚Äúwszystkie/all‚Äù
 948 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
 949 | 
 950 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
 951 |         score -= Math.min(500, t.length * 3);
 952 | 
 953 |         if (score > bestScore) {
 954 |           bestScore = score;
 955 |           best = el;
 956 |         }
 957 |       }
 958 | 
 959 |       if (!best) return { clicked: false };
 960 | 
 961 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
 962 |       const clickable =
 963 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
 964 | 
 965 |       try {
 966 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 967 |       } catch {}
 968 | 
 969 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 970 | 
 971 |       const hardClick = (node) => {
 972 |         try {
 973 |           node.click();
 974 |           return true;
 975 |         } catch {}
 976 |         try {
 977 |           const r = node.getBoundingClientRect();
 978 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
 979 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
 980 |           const target = document.elementFromPoint(x, y) || node;
 981 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
 982 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
 983 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
 984 |           return true;
 985 |         } catch {}
 986 |         return false;
 987 |       };
 988 | 
 989 |       const ok = hardClick(clickable);
 990 |       return { clicked: ok, text: txt };
 991 |     }, rootHandle);
 992 | 
 993 |     return res || { clicked: false };
 994 |   }
 995 | 
 996 | 
 997 |   async function clickMoreCommentsButton() {
 998 |     const res = await page.evaluate((root) => {
 999 |       const scope = root || document;
1000 | 
1001 |       const norm = (s) =>
1002 |         String(s || "")
1003 |           .replace(/\u00a0/g, " ")
1004 |           .replace(/\s+/g, " ")
1005 |           .trim()
1006 |           .toLowerCase();
1007 | 
1008 |       const isVisible = (el) => {
1009 |         if (!el) return false;
1010 |         const r = el.getBoundingClientRect();
1011 |         if (r.width < 2 || r.height < 2) return false;
1012 |         return r.bottom > 0 && r.top < window.innerHeight;
1013 |       };
1014 | 
1015 |       const isMore = (t) => {
1016 |         if (!t) return false;
1017 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1018 |         if (t.length > 140) return false;
1019 | 
1020 |         return (
1021 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
1022 |           t.includes("zobacz wiƒôcej komentarzy") ||
1023 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
1024 |           t.includes("view more comments") ||
1025 |           t.includes("view previous comments")
1026 |         );
1027 |       };
1028 | 
1029 |       const candidates = Array.from(
1030 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
1031 |       ).filter(isVisible);
1032 | 
1033 |       let best = null;
1034 |       let bestY = -1;
1035 | 
1036 |       for (const el of candidates) {
1037 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1038 |         if (!isMore(t)) continue;
1039 |         const r = el.getBoundingClientRect();
1040 |         if (r.top > bestY) {
1041 |           bestY = r.top;
1042 |           best = el;
1043 |         }
1044 |       }
1045 | 
1046 |       if (!best) return { clicked: false };
1047 | 
1048 |       try {
1049 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
1050 |       } catch {}
1051 | 
1052 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
1053 | 
1054 |       try {
1055 |         best.click();
1056 |         return { clicked: true, text: txt };
1057 |       } catch {
1058 |         return { clicked: false, text: txt };
1059 |       }
1060 |     }, rootHandle);
1061 | 
1062 |     return res || { clicked: false };
1063 |   }
1064 | 
1065 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
1066 | 
1067 |   async function hasAnyReplyExpanders(page, rootHandle) {
1068 |     return page.evaluate((root) => {
1069 |       const scope = root || document;
1070 | 
1071 |       const norm = (s) =>
1072 |         String(s || "")
1073 |           .replace(/\u00a0/g, " ")
1074 |           .replace(/\s+/g, " ")
1075 |           .trim()
1076 |           .toLowerCase();
1077 | 
1078 |       const isVisible = (el) => {
1079 |         if (!el) return false;
1080 |         try {
1081 |           const r = el.getBoundingClientRect();
1082 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
1083 |         } catch {
1084 |           return true;
1085 |         }
1086 |       };
1087 | 
1088 |       const isReplyExpanderText = (t) => {
1089 |         if (!t) return false;
1090 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1091 |         if (t.length > 220) return false;
1092 | 
1093 |         if (t === "odpowiedz" || t === "reply") return false;
1094 |         if (t.startsWith("odpowiedz ")) return false;
1095 |         if (t.startsWith("reply ")) return false;
1096 | 
1097 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1098 | 
1099 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1100 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
1101 |         if (t.includes("view") && t.includes("repl")) return true;
1102 |         if (t.includes("see") && t.includes("repl")) return true;
1103 | 
1104 |         return false;
1105 |       };
1106 | 
1107 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
1108 | 
1109 |       for (const el of nodes) {
1110 |         if (!isVisible(el)) continue;
1111 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1112 |         if (!t) continue;
1113 | 
1114 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
1115 |         if (t.includes("udost") || t.includes("share")) continue;
1116 | 
1117 |         if (isReplyExpanderText(t)) return true;
1118 |       }
1119 | 
1120 |       return false;
1121 |     }, rootHandle);
1122 |   }
1123 | 
1124 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
1125 |     const res = await page.evaluate(
1126 |       (root, limit) => {
1127 |         const scope = root || document;
1128 | 
1129 |         const norm = (s) =>
1130 |           String(s || "")
1131 |             .replace(/\u00a0/g, " ")
1132 |             .replace(/\s+/g, " ")
1133 |             .trim()
1134 |             .toLowerCase();
1135 | 
1136 |         const isVisible = (el) => {
1137 |           if (!el) return false;
1138 |           try {
1139 |             const r = el.getBoundingClientRect();
1140 |             if (r.width < 2 || r.height < 2) return false;
1141 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
1142 |           } catch {
1143 |             return true;
1144 |           }
1145 |         };
1146 | 
1147 |         const isReplyExpanderText = (t) => {
1148 |           if (!t) return false;
1149 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
1150 |           if (t.length > 220) return false;
1151 | 
1152 |           if (t === "odpowiedz" || t === "reply") return false;
1153 |           if (t.startsWith("odpowiedz ")) return false;
1154 |           if (t.startsWith("reply ")) return false;
1155 | 
1156 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
1157 | 
1158 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
1159 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
1160 |           if (t.includes("view") && t.includes("repl")) return true;
1161 |           if (t.includes("see") && t.includes("repl")) return true;
1162 | 
1163 |           return false;
1164 |         };
1165 | 
1166 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
1167 |           .filter(isVisible)
1168 |           .slice(0, 35000)
1169 |           .map((el) => {
1170 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
1171 |             return { el, t };
1172 |           })
1173 |           .filter((x) => {
1174 |             if (!x.t) return false;
1175 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
1176 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
1177 |             return isReplyExpanderText(x.t);
1178 |           });
1179 | 
1180 |         // preferuj elementy ni≈ºej w widoku
1181 |         candidates.sort((a, b) => {
1182 |           const ra = a.el.getBoundingClientRect();
1183 |           const rb = b.el.getBoundingClientRect();
1184 |           return rb.top - ra.top;
1185 |         });
1186 | 
1187 |         const hardClick = (node) => {
1188 |           try {
1189 |             node.click();
1190 |             return true;
1191 |           } catch {}
1192 |           try {
1193 |             const r = node.getBoundingClientRect();
1194 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
1195 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
1196 |             const target = document.elementFromPoint(x, y) || node;
1197 |             target.dispatchEvent(
1198 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
1199 |             );
1200 |             target.dispatchEvent(
1201 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
1202 |             );
1203 |             target.dispatchEvent(
1204 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
1205 |             );
1206 |             return true;
1207 |           } catch {}
1208 |           return false;
1209 |         };
1210 | 
1211 |         let clicked = 0;
1212 |         const sample = [];
1213 | 
1214 |         for (const item of candidates) {
1215 |           if (clicked >= limit) break;
1216 | 
1217 |           const clickable =
1218 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
1219 | 
1220 |           try {
1221 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
1222 |           } catch {}
1223 | 
1224 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
1225 | 
1226 |           const ok = hardClick(clickable);
1227 |           if (ok) {
1228 |             clicked++;
1229 |             if (sample.length < 5) sample.push(txt);
1230 |           }
1231 |         }
1232 | 
1233 |         return { clicked, sample };
1234 |       },
1235 |       rootHandle,
1236 |       maxPerPass
1237 |     );
1238 | 
1239 |     return res || { clicked: 0, sample: [] };
1240 |   }
1241 | 
1242 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
1243 |     await page.evaluate((root, scroller) => {
1244 |       const pick =
1245 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
1246 | 
1247 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
1248 |       else window.scrollTo(0, 0);
1249 |     }, rootHandle, scrollHandle);
1250 |   }
1251 | 
1252 |   async function sweepRepliesTopDown(
1253 |     page,
1254 |     rootHandle,
1255 |     scrollHandle,
1256 |     {
1257 |       maxPasses = 3,
1258 |       stepsPerPass = 40,
1259 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
1260 |       maxClicksPerStep = 12,
1261 |     } = {}
1262 |   ) {
1263 |     let totalClicked = 0;
1264 | 
1265 |     for (let pass = 1; pass <= maxPasses; pass++) {
1266 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
1267 |       await sleepRandom(140, 240);
1268 | 
1269 |       let staleSteps = 0;
1270 | 
1271 |       for (let step = 1; step <= stepsPerPass; step++) {
1272 |         const before = await countAnchors().catch(() => null);
1273 | 
1274 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
1275 |           () => ({ clicked: 0, sample: [] })
1276 |         );
1277 | 
1278 |         if (r.clicked > 0) {
1279 |           totalClicked += r.clicked;
1280 | 
1281 |           if (before) {
1282 |             await sleepRandom(60, 120);
1283 |             await waitForEffect(before, "replies");
1284 |           }
1285 | 
1286 |           await sleepRandom(90, 160);
1287 |           staleSteps = 0;
1288 |         } else {
1289 |           staleSteps++;
1290 |         }
1291 | 
1292 |         const m1 = await getScrollMetrics().catch(() => null);
1293 |         await gentleScrollKick(scrollPx);
1294 |         const m2 = await getScrollMetrics().catch(() => null);
1295 | 
1296 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
1297 | 
1298 |         if (!moved && staleSteps >= 4) break;
1299 |         if (staleSteps >= 8) break;
1300 |       }
1301 | 
1302 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1303 |       if (!any) break;
1304 |     }
1305 | 
1306 |     return totalClicked;
1307 |   }
1308 | 
1309 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
1310 |   let lastLogAt = 0;
1311 |   let lastLogKey = "";
1312 |   const LOG_EVERY_N_STEPS = 6;
1313 |   const LOG_MIN_MS = 800;
1314 |   const shouldLog = (step, key, force = false) => {
1315 |     const now = Date.now();
1316 |     if (force) {
1317 |       lastLogAt = now;
1318 |       lastLogKey = key;
1319 |       return true;
1320 |     }
1321 |     if (step % LOG_EVERY_N_STEPS === 0) {
1322 |       lastLogAt = now;
1323 |       lastLogKey = key;
1324 |       return true;
1325 |     }
1326 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
1327 |       lastLogAt = now;
1328 |       lastLogKey = key;
1329 |       return true;
1330 |     }
1331 |     return false;
1332 |   };
1333 | 
1334 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
1335 |   log.debug("UI:photo", "startCounts", cur);
1336 | 
1337 |   for (let step = 1; step <= MAX_STEPS; step++) {
1338 |     const before = cur;
1339 |     let action = "scroll";
1340 |     let clickInfo = null;
1341 |     let effectOk = false;
1342 |     let bonus = 0;
1343 | 
1344 |     // 1) REPLIES
1345 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
1346 |     if (r1?.clicked) {
1347 |       action = "replies";
1348 |       clickInfo = r1;
1349 | 
1350 |       await sleepRandom(80, 140);
1351 |       effectOk = await waitForEffect(before, "replies");
1352 |       await sleepRandom(90, 170);
1353 | 
1354 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
1355 |       if (effectOk) {
1356 |         bonus = await bonusClicks("replies", before);
1357 |       } else {
1358 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
1359 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1360 |       }
1361 |     } else {
1362 |       // 2) MORE COMMENTS
1363 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
1364 |       if (c1?.clicked) {
1365 |         action = "comments";
1366 |         clickInfo = c1;
1367 | 
1368 |         await sleepRandom(80, 140);
1369 |         effectOk = await waitForEffect(before, "comments");
1370 |         await sleepRandom(90, 170);
1371 | 
1372 |         if (effectOk) {
1373 |           bonus = await bonusClicks("comments", before);
1374 |         } else {
1375 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
1376 |         }
1377 |       } else {
1378 |         // 3) SCROLL
1379 |         action = "scroll";
1380 |         await gentleScrollKick(PACE_CFG.scrollPx);
1381 |       }
1382 |     }
1383 | 
1384 |     cur = await countAnchors().catch(() => before);
1385 | 
1386 |     const progressed =
1387 |       cur.commentsAnchors > before.commentsAnchors ||
1388 |       cur.replyAnchors > before.replyAnchors ||
1389 |       cur.nodes > before.nodes;
1390 | 
1391 |     if (!progressed) noProgress++;
1392 |     else noProgress = 0;
1393 | 
1394 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
1395 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
1396 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
1397 |     if (shouldCheckHB) {
1398 |       hb = await updateHardBottomStability().catch(() => ({
1399 |         atBottom: false,
1400 |         stable: bottomStable,
1401 |         tag: "NA",
1402 |         anyMore: true,
1403 |       }));
1404 |     }
1405 | 
1406 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
1407 |     const key =
1408 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
1409 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
1410 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
1411 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
1412 | 
1413 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
1414 |     if (shouldLog(step, key, forceLog)) {
1415 |       log.debug("UI:photo", `step=${step} ${action} cA ${before.commentsAnchors}‚Üí${cur.commentsAnchors} rA ${before.replyAnchors}‚Üí${cur.replyAnchors} np=${noProgress}/${MAX_NO_PROGRESS}`);
1416 |     }
1417 | 
1418 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
1419 |       log.debug("UI:photo", "Stop: hard-bottom-stable");
1420 |       break;
1421 |     }
1422 | 
1423 |     if (noProgress >= MAX_NO_PROGRESS) {
1424 |       log.debug("UI:photo", "Stop: too many no-progress steps");
1425 |       break;
1426 |     }
1427 | 
1428 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
1429 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
1430 |   }
1431 | 
1432 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
1433 |   let final = await countAnchors().catch(() => cur);
1434 |   log.debug("UI:photo", "Done", final);
1435 | 
1436 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
1437 |   if (needSweep) {
1438 |     log.debug("UI:photo", "Sweep: reply expanders -> top-down...");
1439 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
1440 |     log.debug("UI:photo", `Sweep: clicked=${clicked}`);
1441 |     final = await countAnchors().catch(() => final);
1442 |     log.debug("UI:photo", "After sweep", final);
1443 |   } else {
1444 |     log.debug("UI:photo", "Sweep: brak reply expanders");
1445 |   }
1446 | 
1447 |   try {
1448 |     await scrollHandle.dispose?.();
1449 |   } catch {}
1450 |   try {
1451 |     await rootHandle.dispose?.();
1452 |   } catch {}
1453 | }
1454 | 
1455 | /* =====================
1456 |    Analiza za≈Ço≈ºe≈Ñ
1457 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
1458 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
1459 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
1460 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
1461 | 
1462 |    Co powiedzia≈Çby sceptyk?
1463 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
1464 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
1465 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
1466 | 
1467 |    ===================== */
1468 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/post.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
   1 | // src/fb/ui/post.js
   2 | import { EXPAND_COMMENTS } from "../../config.js";
   3 | import { sleepRandom } from "../../utils/sleep.js";
   4 | import { safeGoto } from "../../utils/navigation.js";
   5 | import log from "../../utils/logger.js";
   6 | 
   7 | import { scrollPost } from "../scroll.js";
   8 | import { acceptCookies, saveCookies } from "../cookies.js";
   9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
  10 | import { clickOneExpandButton } from "../expandButtons.js";
  11 | 
  12 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
  13 | 
  14 | export const type = "post";
  15 | 
  16 | export function matchesUrl(url) {
  17 |   if (!url) return false;
  18 |   const u = String(url);
  19 |   if (u.includes("/watch")) return false;
  20 |   if (u.includes("/videos/")) return false;
  21 |   if (u.includes("/photo")) return false;
  22 |   if (u.includes("photo.php")) return false;
  23 | 
  24 |   return (
  25 |     u.includes("/posts/") ||
  26 |     u.includes("permalink.php") ||
  27 |     u.includes("/story.php") ||
  28 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
  29 |   );
  30 | }
  31 | 
  32 | /* ============================================================
  33 |    =============== POST ROOT (DIALOG / MAIN) ===================
  34 |    ============================================================ */
  35 | 
  36 | function postRootScript() {
  37 |   return `
  38 |     function getPostRoot() {
  39 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
  40 | 
  41 |       const postDialog = dialogs.find((dlg) => {
  42 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
  43 |         if (!text) return false;
  44 | 
  45 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
  46 |         const hasActions =
  47 |           text.includes("lubiƒô to") ||
  48 |           text.includes("komentarz") ||
  49 |           text.includes("udostƒôpnij") ||
  50 |           text.includes("write a comment") ||
  51 |           text.includes("comment");
  52 | 
  53 |         const looksLikeNotifications =
  54 |           text.startsWith("powiadomienia") &&
  55 |           text.includes("wszystkie") &&
  56 |           text.includes("nieprzeczytane");
  57 | 
  58 |         return !looksLikeNotifications && hasCommentWord && hasActions;
  59 |       });
  60 | 
  61 |       if (postDialog) {
  62 |         const art = postDialog.querySelector("article");
  63 |         return art || postDialog;
  64 |       }
  65 | 
  66 |       const main = document.querySelector("div[role='main'], main");
  67 |       if (main) {
  68 |         const article = main.querySelector("article");
  69 |         return article || main;
  70 |       }
  71 | 
  72 |       return document.body;
  73 |     }
  74 |   `;
  75 | }
  76 | 
  77 | async function getPostScopeSelector(page) {
  78 |   const scope = await page.evaluate((code) => {
  79 |     // eslint-disable-next-line no-eval
  80 |     eval(code);
  81 |     // @ts-ignore
  82 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
  83 |     if (!root) return "document";
  84 | 
  85 |     const dlg = root.closest("div[role='dialog']");
  86 |     if (dlg) return "div[role='dialog']";
  87 | 
  88 |     const main = document.querySelector("div[role='main'], main");
  89 |     if (main) return "div[role='main']";
  90 | 
  91 |     return "document";
  92 |   }, postRootScript());
  93 | 
  94 |   return scope || "document";
  95 | }
  96 | 
  97 | /* ============================================================
  98 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: WSZYSTKIE / NAJNOWSZE =======
  99 |    ============================================================ */
 100 | 
 101 | async function clickMenuOptionByPattern(page, patterns) {
 102 |   const result = await page.evaluate((patterns) => {
 103 |     const norm = (s) =>
 104 |       String(s || "")
 105 |         .replace(/\u00a0/g, " ")
 106 |         .replace(/\s+/g, " ")
 107 |         .trim()
 108 |         .toLowerCase();
 109 | 
 110 |     const menu = document.querySelector("div[role='menu']");
 111 |     if (!menu) return { clicked: false, noMenu: true };
 112 | 
 113 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 114 | 
 115 |     const opt = items.find((el) => {
 116 |       const t = norm(el.textContent);
 117 |       return patterns.some((p) => t.startsWith(p));
 118 |     });
 119 | 
 120 |     if (!opt) return { clicked: false, noMenu: false, patterns };
 121 | 
 122 |     try {
 123 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 124 |     } catch {}
 125 | 
 126 |     try {
 127 |       opt.click();
 128 |       return { clicked: true, noMenu: false };
 129 |     } catch {
 130 |       return { clicked: false, noMenu: false };
 131 |     }
 132 |   }, patterns);
 133 | 
 134 |   if (result.clicked) {
 135 |     await sleepRandom(250, 450);
 136 |     await page
 137 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 138 |       .catch(() => {});
 139 |   }
 140 | 
 141 |   return result;
 142 | }
 143 | 
 144 | async function clickAllCommentsInMenu(page) {
 145 |   const result = await page.evaluate(() => {
 146 |     const norm = (s) =>
 147 |       String(s || "")
 148 |         .replace(/\u00a0/g, " ")
 149 |         .replace(/\s+/g, " ")
 150 |         .trim()
 151 |         .toLowerCase();
 152 | 
 153 |     const menu = document.querySelector("div[role='menu']");
 154 |     if (!menu) return { clicked: false, noMenu: true };
 155 | 
 156 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 157 | 
 158 |     const opt = items.find((el) => {
 159 |       const t = norm(el.textContent);
 160 |       return (
 161 |         t.startsWith("wszystkie komentarze") ||
 162 |         t.startsWith("all comments") ||
 163 |         t.startsWith("poka≈º wszystkie") ||
 164 |         t.startsWith("pokaz wszystkie") ||
 165 |         t.startsWith("show all")
 166 |       );
 167 |     });
 168 | 
 169 |     if (!opt) return { clicked: false, noMenu: false };
 170 | 
 171 |     try {
 172 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 173 |     } catch {}
 174 | 
 175 |     try {
 176 |       opt.click();
 177 |       return { clicked: true, noMenu: false };
 178 |     } catch {
 179 |       return { clicked: false, noMenu: false };
 180 |     }
 181 |   });
 182 | 
 183 |   if (result.clicked) {
 184 |     await sleepRandom(250, 450);
 185 |     await page
 186 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 187 |       .catch(() => {});
 188 |   }
 189 | 
 190 |   return result;
 191 | }
 192 | 
 193 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
 194 |   log.dev("UI:post", "Prze≈ÇƒÖczam filtr komentarzy...");
 195 |   log.debug("UI:post", `Filter scope: ${scopeSel}`);
 196 | 
 197 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
 198 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 199 |   if (menuAlreadyOpen) {
 200 |     log.debug("UI:post", "Menu ju≈º otwarte ‚Äì wybieram opcjƒô");
 201 |     const r = await clickAllCommentsInMenu(page);
 202 |     if (r?.clicked)
 203 |       log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 204 |     return !!r?.clicked;
 205 |   }
 206 | 
 207 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
 208 |   const pre = await page.evaluate(
 209 |     (scopeSel, code) => {
 210 |       const norm = (s) =>
 211 |         String(s || "")
 212 |           .replace(/\u00a0/g, " ")
 213 |           .replace(/\s+/g, " ")
 214 |           .trim()
 215 |           .toLowerCase();
 216 | 
 217 |       // eslint-disable-next-line no-eval
 218 |       eval(code);
 219 |       // @ts-ignore
 220 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 221 | 
 222 |       function getLabel(el) {
 223 |         if (!el) return "";
 224 |         const aria = el.getAttribute?.("aria-label");
 225 |         if (aria) return aria;
 226 |         return el.textContent || "";
 227 |       }
 228 | 
 229 |       function isVisibleEnough(el) {
 230 |         try {
 231 |           if (!el) return false;
 232 |           const st = window.getComputedStyle(el);
 233 |           if (!st) return true;
 234 |           if (st.display === "none" || st.visibility === "hidden") return false;
 235 |           const r = el.getBoundingClientRect();
 236 |           if (!r || r.width < 8 || r.height < 8) return false;
 237 |           return true;
 238 |         } catch {
 239 |           return true;
 240 |         }
 241 |       }
 242 | 
 243 |       function findClickableAncestor(start) {
 244 |         let el = start;
 245 |         for (let i = 0; i < 10 && el; i++) {
 246 |           const role = el.getAttribute?.("role");
 247 |           const tag = (el.tagName || "").toLowerCase();
 248 |           if (
 249 |             tag === "button" ||
 250 |             role === "button" ||
 251 |             role === "menuitem" ||
 252 |             role === "menuitemradio" ||
 253 |             role === "link"
 254 |           ) {
 255 |             return el;
 256 |           }
 257 |           el = el.parentElement;
 258 |         }
 259 |         return null;
 260 |       }
 261 | 
 262 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
 263 |       const btnsAll = Array.from(
 264 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 265 |       );
 266 |       for (const el of btnsAll) {
 267 |         const t = norm(getLabel(el));
 268 |         if (
 269 |           t === "wszystkie komentarze" ||
 270 |           t === "all comments" ||
 271 |           t === "poka≈º wszystkie" ||
 272 |           t === "pokaz wszystkie" ||
 273 |           t === "show all"
 274 |         ) {
 275 |           return { ok: true, state: "already-all", where: "document" };
 276 |         }
 277 |       }
 278 | 
 279 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 280 |       const scopes = [scopeEl, root, document].filter(Boolean);
 281 | 
 282 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
 283 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
 284 |       for (const sc of scopes) {
 285 |         const clickables = Array.from(
 286 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 287 |         );
 288 | 
 289 |         const candidates = [];
 290 |         for (const el of clickables) {
 291 |           const t = norm(getLabel(el));
 292 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
 293 |           if (!isVisibleEnough(el)) continue;
 294 | 
 295 |           let dist = 999999;
 296 |           try {
 297 |             const r = el.getBoundingClientRect();
 298 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
 299 |             dist = Math.abs(r.top - window.innerHeight / 2);
 300 |           } catch {}
 301 | 
 302 |           candidates.push({ el, dist });
 303 |         }
 304 | 
 305 |         if (candidates.length) {
 306 |           candidates.sort((a, b) => a.dist - b.dist);
 307 |           const picked = candidates[0].el;
 308 | 
 309 |           try {
 310 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 311 |           } catch {}
 312 | 
 313 |           try {
 314 |             picked.click();
 315 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
 316 |           } catch {
 317 |             // nic
 318 |           }
 319 |         }
 320 |       }
 321 | 
 322 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
 323 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
 324 |       for (const sc of scopes) {
 325 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
 326 |           .filter(isVisibleEnough)
 327 |           .slice(0, 20000);
 328 | 
 329 |         for (const n of nodes) {
 330 |           const t = norm(n.textContent);
 331 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
 332 | 
 333 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
 334 |           if (!clickable) continue;
 335 | 
 336 |           try {
 337 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 338 |           } catch {}
 339 | 
 340 |           try {
 341 |             clickable.click();
 342 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
 343 |           } catch {
 344 |             // nic
 345 |           }
 346 |         }
 347 |       }
 348 | 
 349 |       return { ok: false, state: "not-found" };
 350 |     },
 351 |     scopeSel,
 352 |     postRootScript()
 353 |   );
 354 | 
 355 |   if (!pre?.ok) {
 356 |     log.debug("UI:post", "Nie znaleziono przycisku filtra");
 357 |     return false;
 358 |   }
 359 | 
 360 |   if (pre.state === "already-all") {
 361 |     log.debug("UI:post", "Filtr ju≈º ustawiony ‚Äì pomijam");
 362 |     return true;
 363 |   }
 364 | 
 365 |   log.debug("UI:post", "Klikniƒôto filtr", pre);
 366 | 
 367 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 368 |   await sleepRandom(350, 650);
 369 | 
 370 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
 371 |   const menuResult = await clickAllCommentsInMenu(page);
 372 | 
 373 |   if (menuResult?.clicked) {
 374 |     log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 375 |     return true;
 376 |   }
 377 | 
 378 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
 379 |   const afterLabelIsAll = await page.evaluate(() => {
 380 |     const norm = (s) =>
 381 |       String(s || "")
 382 |         .replace(/\u00a0/g, " ")
 383 |         .replace(/\s+/g, " ")
 384 |         .trim()
 385 |         .toLowerCase();
 386 | 
 387 |     const els = Array.from(
 388 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 389 |     );
 390 | 
 391 |     function getLabel(el) {
 392 |       const aria = el.getAttribute?.("aria-label");
 393 |       if (aria) return aria;
 394 |       return el.textContent || "";
 395 |     }
 396 | 
 397 |     return els.some((el) => {
 398 |       const t = norm(getLabel(el));
 399 |       return (
 400 |         t === "wszystkie komentarze" ||
 401 |         t === "all comments" ||
 402 |         t === "poka≈º wszystkie" ||
 403 |         t === "pokaz wszystkie" ||
 404 |         t === "show all"
 405 |       );
 406 |     });
 407 |   });
 408 | 
 409 |   if (afterLabelIsAll) {
 410 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu");
 411 |     return true;
 412 |   }
 413 | 
 414 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá filtra", menuResult);
 415 |   return false;
 416 | }
 417 | 
 418 | /* ============================================================
 419 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: NAJNOWSZE (FAST_MODE) =======
 420 |    ============================================================ */
 421 | 
 422 | async function openFilterMenuScoped(page, scopeSel = "document") {
 423 |   const pre = await page.evaluate(
 424 |     (scopeSel, code) => {
 425 |       const norm = (s) =>
 426 |         String(s || "")
 427 |           .replace(/\u00a0/g, " ")
 428 |           .replace(/\s+/g, " ")
 429 |           .trim()
 430 |           .toLowerCase();
 431 | 
 432 |       // eslint-disable-next-line no-eval
 433 |       eval(code);
 434 |       // @ts-ignore
 435 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 436 | 
 437 |       function getLabel(el) {
 438 |         if (!el) return "";
 439 |         const aria = el.getAttribute?.("aria-label");
 440 |         if (aria) return aria;
 441 |         return el.textContent || "";
 442 |       }
 443 | 
 444 |       function isVisibleEnough(el) {
 445 |         try {
 446 |           if (!el) return false;
 447 |           const st = window.getComputedStyle(el);
 448 |           if (!st) return true;
 449 |           if (st.display === "none" || st.visibility === "hidden") return false;
 450 |           const r = el.getBoundingClientRect();
 451 |           if (!r || r.width < 8 || r.height < 8) return false;
 452 |           return true;
 453 |         } catch {
 454 |           return true;
 455 |         }
 456 |       }
 457 | 
 458 |       // Je≈õli menu ju≈º otwarte
 459 |       if (document.querySelector("div[role='menu']")) {
 460 |         return { ok: true, state: "menu-already-open" };
 461 |       }
 462 | 
 463 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 464 |       const scopes = [scopeEl, root, document].filter(Boolean);
 465 | 
 466 |       // Szukamy przycisku filtra (Najtrafniejsze/Wszystkie/Najnowsze)
 467 |       const filterLabels = [
 468 |         "najtrafniejsze", "most relevant",
 469 |         "wszystkie komentarze", "all comments",
 470 |         "najnowsze", "newest",
 471 |         "poka≈º wszystkie", "show all"
 472 |       ];
 473 | 
 474 |       for (const sc of scopes) {
 475 |         const clickables = Array.from(
 476 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 477 |         );
 478 | 
 479 |         const candidates = [];
 480 |         for (const el of clickables) {
 481 |           const t = norm(getLabel(el));
 482 |           if (!filterLabels.some((f) => t.startsWith(f))) continue;
 483 |           if (!isVisibleEnough(el)) continue;
 484 | 
 485 |           let dist = 999999;
 486 |           try {
 487 |             const r = el.getBoundingClientRect();
 488 |             dist = Math.abs(r.top - window.innerHeight / 2);
 489 |           } catch {}
 490 | 
 491 |           candidates.push({ el, dist, label: t });
 492 |         }
 493 | 
 494 |         if (candidates.length) {
 495 |           candidates.sort((a, b) => a.dist - b.dist);
 496 |           const picked = candidates[0].el;
 497 | 
 498 |           try {
 499 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 500 |           } catch {}
 501 | 
 502 |           try {
 503 |             picked.click();
 504 |             return { ok: true, state: "clicked-filter", label: candidates[0].label };
 505 |           } catch {}
 506 |         }
 507 |       }
 508 | 
 509 |       return { ok: false, state: "not-found" };
 510 |     },
 511 |     scopeSel,
 512 |     postRootScript()
 513 |   );
 514 | 
 515 |   return pre;
 516 | }
 517 | 
 518 | export async function switchCommentsFilterToNewestScoped(page, scopeSel = "document") {
 519 |   log.dev("UI:post", "Prze≈ÇƒÖczam na 'Najnowsze'...");
 520 |   log.debug("UI:post", `Newest filter scope: ${scopeSel}`);
 521 | 
 522 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Najnowsze"
 523 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 524 |   if (menuAlreadyOpen) {
 525 |     log.debug("UI:post", "Menu otwarte ‚Äì wybieram 'Najnowsze'");
 526 |     const r = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 527 |     if (r?.clicked) {
 528 |       log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 529 |       return { ok: true };
 530 |     }
 531 |     return { ok: false, reason: "option-not-found-in-open-menu" };
 532 |   }
 533 | 
 534 |   // 1) Sprawd≈∫ czy ju≈º ustawione na "Najnowsze"
 535 |   const alreadyNewest = await page.evaluate(() => {
 536 |     const norm = (s) =>
 537 |       String(s || "")
 538 |         .replace(/\u00a0/g, " ")
 539 |         .replace(/\s+/g, " ")
 540 |         .trim()
 541 |         .toLowerCase();
 542 | 
 543 |     const btns = Array.from(
 544 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 545 |     );
 546 | 
 547 |     return btns.some((el) => {
 548 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 549 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 550 |     });
 551 |   });
 552 | 
 553 |   if (alreadyNewest) {
 554 |     log.debug("UI:post", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
 555 |     return { ok: true, state: "already-newest" };
 556 |   }
 557 | 
 558 |   // 2) Otw√≥rz menu filtra
 559 |   const openResult = await openFilterMenuScoped(page, scopeSel);
 560 |   if (!openResult?.ok) {
 561 |     log.debug("UI:post", "Nie uda≈Ço siƒô otworzyƒá menu filtra");
 562 |     return { ok: false, reason: "menu-not-opened" };
 563 |   }
 564 | 
 565 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 566 |   await sleepRandom(350, 650);
 567 | 
 568 |   // 3) Wybierz "Najnowsze" z menu
 569 |   const menuResult = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 570 | 
 571 |   if (menuResult?.clicked) {
 572 |     log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 573 |     return { ok: true };
 574 |   }
 575 | 
 576 |   // 4) Fallback: sprawd≈∫ label po klikniƒôciu
 577 |   const afterLabelIsNewest = await page.evaluate(() => {
 578 |     const norm = (s) =>
 579 |       String(s || "")
 580 |         .replace(/\u00a0/g, " ")
 581 |         .replace(/\s+/g, " ")
 582 |         .trim()
 583 |         .toLowerCase();
 584 | 
 585 |     const els = Array.from(
 586 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 587 |     );
 588 | 
 589 |     return els.some((el) => {
 590 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 591 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 592 |     });
 593 |   });
 594 | 
 595 |   if (afterLabelIsNewest) {
 596 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Najnowsze'");
 597 |     return { ok: true };
 598 |   }
 599 | 
 600 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá 'Najnowsze'", menuResult);
 601 |   return { ok: false, reason: menuResult?.noMenu ? "no-menu" : "option-not-found" };
 602 | }
 603 | 
 604 | 
 605 | /* ============================================================
 606 |    =================== LICZENIE Z UI (POST) ====================
 607 |    ============================================================ */
 608 | 
 609 | /**
 610 |  * Kluczowa poprawka:
 611 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
 612 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
 613 |  */
 614 | async function getCommentCountFromUiPostRoot(page) {
 615 |   const res = await page.evaluate((code) => {
 616 |     // eslint-disable-next-line no-eval
 617 |     eval(code);
 618 | 
 619 |     const norm = (s) =>
 620 |       String(s || "")
 621 |         .replace(/\u00a0/g, " ")
 622 |         .replace(/\s+/g, " ")
 623 |         .trim();
 624 | 
 625 |     const lower = (s) => norm(s).toLowerCase();
 626 | 
 627 |     function parsePlEnCount(text) {
 628 |       const t = lower(text);
 629 |       if (!t) return null;
 630 | 
 631 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
 632 | 
 633 |       let x = t
 634 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
 635 |         .replace(/comments?/g, "")
 636 |         .replace(/[():]/g, " ")
 637 |         .replace(/\s+/g, " ")
 638 |         .trim();
 639 | 
 640 |       let mult = 1;
 641 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
 642 |         mult = 1000;
 643 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
 644 |       }
 645 |       if (/\bmln\b|\bmillion\b/.test(x)) {
 646 |         mult = 1000000;
 647 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
 648 |       }
 649 | 
 650 |       x = x.replace(/\s+/g, "");
 651 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
 652 |       x = x.replace(/[^0-9.]/g, "");
 653 |       if (!x) return null;
 654 | 
 655 |       const n = Number(x);
 656 |       if (!Number.isFinite(n)) return null;
 657 | 
 658 |       return Math.round(n * mult);
 659 |     }
 660 | 
 661 |     // @ts-ignore
 662 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 663 |     const scope = root || document;
 664 | 
 665 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
 666 |     const badBlock = (txt) => {
 667 |       const t = lower(txt);
 668 |       if (!t) return false;
 669 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
 670 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
 671 |       return false;
 672 |     };
 673 | 
 674 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
 675 |     const spans = Array.from(scope.querySelectorAll("span"));
 676 |     let best = null;
 677 | 
 678 |     for (const el of spans) {
 679 |       const raw = norm(el.textContent);
 680 |       if (!raw) continue;
 681 |       if (badBlock(raw)) continue;
 682 | 
 683 |       const val = parsePlEnCount(raw);
 684 |       if (val == null) continue;
 685 | 
 686 |       let score = 0;
 687 |       score += Math.max(0, 40 - raw.length);
 688 | 
 689 |       try {
 690 |         const r = el.getBoundingClientRect();
 691 |         if (r.width > 10 && r.height > 10) score += 10;
 692 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
 693 |       } catch {}
 694 | 
 695 |       if (!best || score > best.score) best = { raw, val, score };
 696 |     }
 697 | 
 698 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
 699 | 
 700 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
 701 |     const nodes = Array.from(
 702 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
 703 |     );
 704 | 
 705 |     for (const el of nodes) {
 706 |       const raw = norm(el.textContent);
 707 |       if (!raw) continue;
 708 |       if (badBlock(raw)) continue;
 709 | 
 710 |       const val = parsePlEnCount(raw);
 711 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
 712 |     }
 713 | 
 714 |     // 3) Ostatecznie: regex po tek≈õcie root
 715 |     const blob = norm(scope.innerText || "");
 716 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
 717 |     if (m) {
 718 |       const raw = norm(`${m[1]} ${m[2]}`);
 719 |       const val = parsePlEnCount(raw);
 720 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
 721 |     }
 722 | 
 723 |     return { ok: false, reason: "not-found" };
 724 |   }, postRootScript());
 725 | 
 726 |   return res?.ok ? res : null;
 727 | }
 728 | 
 729 | /* ============================================================
 730 |    =================== LICZENIE ANCHOR√ìW =======================
 731 |    ============================================================ */
 732 | 
 733 | async function getCurrentCommentAnchorCount(page) {
 734 |   const count = await page.evaluate(() => {
 735 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
 736 |     const ids = new Set();
 737 | 
 738 |     for (const a of anchors) {
 739 |       try {
 740 |         const url = new URL(a.href);
 741 |         const cid = url.searchParams.get("comment_id");
 742 |         const rid = url.searchParams.get("reply_comment_id");
 743 |         let raw = rid || cid;
 744 |         if (!raw) continue;
 745 | 
 746 |         if (!/^\d+$/.test(raw)) {
 747 |           try {
 748 |             const dec = atob(raw);
 749 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 750 |             if (m) raw = m[2];
 751 |           } catch {}
 752 |         }
 753 | 
 754 |         if (raw) ids.add(raw);
 755 |       } catch {}
 756 |     }
 757 | 
 758 |     return ids.size;
 759 |   });
 760 | 
 761 |   return count || 0;
 762 | }
 763 | 
 764 | /* ============================================================
 765 |    =================== SCROLL TYLKO W PO≈öCIE ===================
 766 |    ============================================================ */
 767 | 
 768 | async function scrollWithinPost(page, label, factor = 0.25) {
 769 |   const info = await page.evaluate(
 770 |     (factorArg, labelArg, code) => {
 771 |       // eslint-disable-next-line no-eval
 772 |       eval(code);
 773 |       // @ts-ignore
 774 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
 775 | 
 776 |       const norm = (s) =>
 777 |         String(s || "")
 778 |           .replace(/\u00a0/g, " ")
 779 |           .replace(/\s+/g, " ")
 780 |           .trim()
 781 |           .toLowerCase();
 782 | 
 783 |       function canScrollByTest(el) {
 784 |         try {
 785 |           if (!el) return false;
 786 |           const ch = el.clientHeight || 0;
 787 |           const sh = el.scrollHeight || 0;
 788 |           if (ch <= 0) return false;
 789 |           if (sh <= ch + 30) return false;
 790 | 
 791 |           const before = el.scrollTop ?? 0;
 792 |           el.scrollTop = before + 80;
 793 |           const after = el.scrollTop ?? before;
 794 |           el.scrollTop = before;
 795 |           return after !== before;
 796 |         } catch {
 797 |           return false;
 798 |         }
 799 |       }
 800 | 
 801 |       function isVisible(el) {
 802 |         if (!el) return false;
 803 |         const st = window.getComputedStyle(el);
 804 |         if (!st) return true;
 805 |         if (st.display === "none" || st.visibility === "hidden") return false;
 806 |         const r = el.getBoundingClientRect();
 807 |         if (!r || r.width < 5 || r.height < 5) return false;
 808 |         return true;
 809 |       }
 810 | 
 811 |       function pickContainerSmart() {
 812 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
 813 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
 814 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
 815 | 
 816 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
 817 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
 818 | 
 819 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
 820 |         let anchor = null;
 821 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
 822 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
 823 |           .filter(isVisible)
 824 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
 825 | 
 826 |         if (candAnchor) anchor = candAnchor;
 827 | 
 828 |         function score(el) {
 829 |           const ch = el.clientHeight || 0;
 830 |           const sh = el.scrollHeight || 0;
 831 |           const delta = sh - ch;
 832 | 
 833 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
 834 |           const t = norm(el.innerText || "");
 835 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
 836 |           let s = delta + (hasCommentWords ? 12000 : 0);
 837 | 
 838 |           // premia je≈õli blisko anchora
 839 |           if (anchor) {
 840 |             const ar = anchor.getBoundingClientRect();
 841 |             const er = el.getBoundingClientRect();
 842 |             const dist = Math.abs(er.top - ar.top);
 843 |             s += Math.max(0, 4000 - dist);
 844 |           }
 845 | 
 846 |           return s;
 847 |         }
 848 | 
 849 |         let best = null;
 850 |         let bestScore = -1;
 851 | 
 852 |         for (const sc of scopes) {
 853 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
 854 |             .filter(isVisible)
 855 |             .slice(0, 18000);
 856 | 
 857 |           for (const el of divs) {
 858 |             if (!canScrollByTest(el)) continue;
 859 |             const s = score(el);
 860 |             if (s > bestScore) {
 861 |               bestScore = s;
 862 |               best = el;
 863 |             }
 864 |           }
 865 |           if (best) break;
 866 |         }
 867 | 
 868 |         if (best) {
 869 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
 870 |           return { el: best, label: "smart" };
 871 |         }
 872 | 
 873 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
 874 |         return {
 875 |           el: document.scrollingElement || document.documentElement || document.body,
 876 |           label: "window",
 877 |         };
 878 |       }
 879 | 
 880 |       const picked = pickContainerSmart();
 881 |       const container = picked.el;
 882 |       const containerType = picked.label;
 883 | 
 884 |       const isWindowContainer =
 885 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
 886 | 
 887 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 888 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
 889 | 
 890 |       if (maxScroll <= 0) {
 891 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
 892 |       }
 893 | 
 894 |       const f = factorArg || 0.25;
 895 |       const sign = f < 0 ? -1 : 1;
 896 |       const magnitude = Math.min(Math.abs(f), 1);
 897 | 
 898 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
 899 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
 900 |       const step = Math.max(120, Math.min(baseStep, 520));
 901 | 
 902 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
 903 | 
 904 |       if (isWindowContainer) window.scrollTo(0, target);
 905 |       else container.scrollTop = target;
 906 | 
 907 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 908 | 
 909 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
 910 |       if (after === before) {
 911 |         try {
 912 |           window.scrollBy(0, sign * step);
 913 |         } catch {}
 914 |       }
 915 | 
 916 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 917 | 
 918 |       return { before, after: after2, container: containerType, label: labelArg };
 919 |     },
 920 |     factor,
 921 |     label,
 922 |     postRootScript()
 923 |   );
 924 | 
 925 |   return info;
 926 | }
 927 | 
 928 | /* ============================================================
 929 |    =================== EXPAND (LEGACY) =========================
 930 |    ============================================================ */
 931 | 
 932 | async function expandAllComments(page) {
 933 |   if (!EXPAND_COMMENTS) return 0;
 934 | 
 935 |   let clicks = 0;
 936 |   for (let i = 0; i < 30; i++) {
 937 |     const didClick = await clickOneExpandButton(page);
 938 |     if (!didClick) break;
 939 |     clicks++;
 940 |     await sleepRandom(900, 1600);
 941 |   }
 942 |   return clicks;
 943 | }
 944 | 
 945 | /* ============================================================
 946 |    =================== HANDLER API =============================
 947 |    ============================================================ */
 948 | 
 949 | export async function prepare(page, url) {
 950 |   log.dev("UI:post", `Prepare: ${url.slice(0, 60)}...`);
 951 | 
 952 |   const ok = await safeGoto(page, url, "post", {
 953 |     waitUntil: "networkidle2",
 954 |     timeout: NAV_TIMEOUT_MS,
 955 |   });
 956 | 
 957 |   if (!ok) throw new Error("safeGoto-failed");
 958 | 
 959 |   const currentUrl = page.url();
 960 |   if (currentUrl.includes("/login")) {
 961 |     log.dev("UI:post", "/login redirect ‚Üí fbLogin()");
 962 |     await fbLogin(page);
 963 |     await sleepRandom(3000, 4500);
 964 | 
 965 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 966 |     log.dev("UI:post", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
 967 | 
 968 |     if (loggedAfterLogin) {
 969 |       await safeGoto(page, url, "post", {
 970 |         waitUntil: "networkidle2",
 971 |         timeout: NAV_TIMEOUT_MS,
 972 |       });
 973 |     }
 974 |   }
 975 | 
 976 |   await acceptCookies(page, "post-initial");
 977 | 
 978 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
 979 |   await sleepRandom(1200, 1800);
 980 |   await acceptCookies(page, "post");
 981 | 
 982 |   try {
 983 |     const logged = await checkIfLogged(page).catch(() => false);
 984 |     if (logged) await saveCookies(page);
 985 |   } catch {}
 986 | 
 987 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
 988 |   await scrollPost(page, 120).catch(() => {});
 989 |   await sleepRandom(600, 900);
 990 | }
 991 | 
 992 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
 993 |   try {
 994 |     await page.waitForFunction(
 995 |       ({ stableMs }) => {
 996 |         const now = performance.now();
 997 |         const y = window.scrollY || 0;
 998 | 
 999 |         if (!window.__fbScrollStop) {
1000 |           window.__fbScrollStop = { lastY: y, lastChange: now };
1001 |           return false;
1002 |         }
1003 | 
1004 |         const st = window.__fbScrollStop;
1005 | 
1006 |         if (Math.abs(y - st.lastY) > 0) {
1007 |           st.lastY = y;
1008 |           st.lastChange = now;
1009 |           return false;
1010 |         }
1011 | 
1012 |         return now - st.lastChange >= stableMs;
1013 |       },
1014 |       { timeout: timeoutMs },
1015 |       { stableMs }
1016 |     );
1017 |     return true;
1018 |   } catch {
1019 |     return false;
1020 |   }
1021 | }
1022 | 
1023 | export async function getCommentCount(page, url) {
1024 |   log.debug("UI:post", "getCommentCount...");
1025 | 
1026 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
1027 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1028 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1029 | 
1030 |   const scopeSel = await getPostScopeSelector(page);
1031 | 
1032 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
1033 |   log.debug("UI:post", `Filter all comments: ${okFilter}`);
1034 | 
1035 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
1036 |   if (okFilter) {
1037 |     await sleepRandom(250, 450);
1038 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
1039 |   }
1040 | 
1041 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
1042 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
1043 | 
1044 |   log.debug("UI:post", "UI comments", {
1045 |     source: ui?.source || "none",
1046 |     comments: ui?.comments ?? null,
1047 |   });
1048 | 
1049 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
1050 |     return ui.comments;
1051 |   }
1052 | 
1053 |   const anchors = await getCurrentCommentAnchorCount(page);
1054 |   log.debug("UI:post", `Fallback anchor count: ${anchors}`);
1055 | 
1056 |   return anchors > 0 ? anchors : null;
1057 | }
1058 | 
1059 | export async function loadAllComments(page, { expectedTotal } = {}) {
1060 |   log.dev("UI:post", `loadAllComments (expected: ${expectedTotal ?? "n/a"})`);
1061 | 
1062 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
1063 | 
1064 |   const MAX_ROUNDS = 600;
1065 |   const MAX_NO_PROGRESS = 60;
1066 | 
1067 |   let noProgress = 0;
1068 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
1069 | 
1070 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
1071 |     const before = lastAnchors;
1072 | 
1073 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
1074 |     const clicks = await expandAllComments(page);
1075 |     await sleepRandom(220, 420);
1076 | 
1077 |     const after = await getCurrentCommentAnchorCount(page);
1078 | 
1079 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
1080 | 
1081 |     if (progressed) noProgress = 0;
1082 |     else noProgress++;
1083 | 
1084 |     lastAnchors = after;
1085 | 
1086 |     if (round === 1 || round % 25 === 0) {
1087 |       log.debug("UI:post", `Round ${round}`, {
1088 |         anchors: `${before}‚Üí${after}`,
1089 |         clicks,
1090 |         noProgress,
1091 |       });
1092 |     }
1093 | 
1094 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
1095 |       if (after >= expectedTotal && noProgress >= 2) {
1096 |         log.debug("UI:post", "Stop: target-reached");
1097 |         break;
1098 |       }
1099 |     }
1100 | 
1101 |     if (noProgress >= MAX_NO_PROGRESS) {
1102 |       log.debug("UI:post", "Stop: no-progress");
1103 |       break;
1104 |     }
1105 |   }
1106 | }
1107 | 
1108 | export async function extractComments(page, url) {
1109 |   const data = await page.evaluate(() => {
1110 |     function extractCommentId(u) {
1111 |       const m = u?.match(/comment_id=([^&]+)/);
1112 |       return m ? decodeURIComponent(m[1]) : null;
1113 |     }
1114 | 
1115 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
1116 |     const idToTimeMap = {};
1117 | 
1118 |     for (let i = 0; i < allLinks.length; i++) {
1119 |       const link = allLinks[i];
1120 |       const href = link.getAttribute("href") || "";
1121 |       const id = extractCommentId(href);
1122 |       if (!id) continue;
1123 | 
1124 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
1125 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
1126 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
1127 |           idToTimeMap[id] = timeText;
1128 |           break;
1129 |         }
1130 |       }
1131 |     }
1132 | 
1133 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
1134 | 
1135 |     const extracted = nodes
1136 |       .map((node, idx) => {
1137 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
1138 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
1139 | 
1140 |         const linkEl = node.querySelector('a[role="link"]');
1141 |         const href = linkEl?.getAttribute("href") || null;
1142 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
1143 | 
1144 |         const id = permalink ? extractCommentId(permalink) : null;
1145 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
1146 | 
1147 |         if (!author || !text) return null;
1148 | 
1149 |         return { id, author, text, time, permalink, pos: idx };
1150 |       })
1151 |       .filter(Boolean);
1152 | 
1153 |     return extracted;
1154 |   });
1155 | 
1156 |   log.debug("UI:post", `extractComments: ${data?.length || 0} komentarzy`);
1157 |   return Array.isArray(data) ? data : [];
1158 | }
1159 | 
1160 | export async function debugSnapshot(page) {
1161 |   const scopeSel = await getPostScopeSelector(page);
1162 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
1163 | 
1164 |   return {
1165 |     scopeSel,
1166 |     anchors,
1167 |     url: page.url(),
1168 |   };
1169 | }
1170 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/videos.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | import { safeGoto } from "../../utils/navigation.js";
  2 | import { sleepRandom } from "../../utils/sleep.js";
  3 | import log from "../../utils/logger.js";
  4 | import { acceptCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | 
  8 | /** Typ handlera UI */
  9 | export const type = "videos";
 10 | 
 11 | export function matchesUrl(url) {
 12 |   const lower = (url || "").toLowerCase();
 13 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
 14 | }
 15 | 
 16 | export async function prepare(page, url) {
 17 |   log.dev("UI:videos", `Prepare: ${url.slice(0, 50)}...`);
 18 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 19 |   if (!ok) throw new Error("safeGoto-failed");
 20 | 
 21 |   const currentUrl = page.url();
 22 |   if (currentUrl.includes("/login")) {
 23 |     log.dev("UI:videos", "Login required");
 24 |     await fbLogin(page);
 25 |     await sleepRandom(3000, 4500);
 26 | 
 27 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 28 |     log.dev("UI:videos", `Sesja po logowaniu: ${loggedAfterLogin ? "OK" : "BRAK"}`);
 29 | 
 30 |     if (loggedAfterLogin) {
 31 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 32 |     } else {
 33 |       log.warn("UI:videos", "Login failed");
 34 |     }
 35 |   }
 36 | 
 37 |   await acceptCookies(page, "videos");
 38 | 
 39 |   // stop autoplay
 40 |   try {
 41 |     await page.evaluate(() => {
 42 |       const vids = Array.from(document.querySelectorAll("video"));
 43 |       for (const v of vids) {
 44 |         try {
 45 |           v.autoplay = false;
 46 |           v.removeAttribute("autoplay");
 47 |           v.muted = true;
 48 |           v.pause();
 49 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
 50 |         } catch {}
 51 |       }
 52 |     });
 53 |     log.debug("UI:videos", "Video paused");
 54 |   } catch (e) {
 55 |     log.debug("UI:videos", `Video pause error: ${e?.message || e}`);
 56 |   }
 57 | }
 58 | 
 59 | export async function getCommentCount(page, url) {
 60 |   const uiInfo = await getUiCommentInfo(page);
 61 |   log.debug("UI:videos", "UI info", {
 62 |     source: uiInfo?.source,
 63 |     raw: uiInfo?.raw,
 64 |     viewType: uiInfo?.viewType,
 65 |     comments: uiInfo?.comments,
 66 |   });
 67 | 
 68 |   let totalComments = null;
 69 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
 70 | 
 71 |   log.dev("UI:videos", `Liczba komentarzy: ${totalComments ?? "brak danych"}`);
 72 |   return totalComments;
 73 | }
 74 | 
 75 | /* ==============================
 76 |    ======= DEBUG HELPERS ========
 77 |    ============================== */
 78 | 
 79 | function shortenHtml(html, max = 220) {
 80 |   if (!html) return null;
 81 |   const s = String(html).replace(/\s+/g, " ").trim();
 82 |   if (s.length <= max) return s;
 83 |   return s.slice(0, max) + "‚Ä¶";
 84 | }
 85 | 
 86 | async function debugDumpShowAllCandidates(page) {
 87 |   const out = await page.evaluate(() => {
 88 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
 89 |     function pick(el) {
 90 |       if (!el) return null;
 91 |       const r = el.getBoundingClientRect();
 92 |       return {
 93 |         tag: el.tagName,
 94 |         role: el.getAttribute("role"),
 95 |         aria: el.getAttribute("aria-label"),
 96 |         text: norm(el.textContent),
 97 |         top: Math.round(r.top),
 98 |         left: Math.round(r.left),
 99 |         w: Math.round(r.width),
100 |         h: Math.round(r.height),
101 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
102 |       };
103 |     }
104 | 
105 |     const headers = Array.from(document.querySelectorAll("span"))
106 |       .filter((s) => {
107 |         const t = norm(s.textContent).toLowerCase();
108 |         return t === "komentarze" || t === "comments";
109 |       })
110 |       .slice(0, 5)
111 |       .map(pick);
112 | 
113 |     const showAll = Array.from(
114 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
115 |     )
116 |       .filter((el) => {
117 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
118 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
119 |       })
120 |       .slice(0, 20)
121 |       .map(pick);
122 | 
123 |     return { headers, showAll };
124 |   });
125 | 
126 |   log.debug("UI:videos", "Candidates", out);
127 | }
128 | 
129 | /* ==========================================
130 |    ======= COMMENTS SCOPE / MARKERS =========
131 |    ========================================== */
132 | 
133 | async function markCommentsScope(page) {
134 |   return await page.evaluate(() => {
135 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
136 | 
137 |     function isVisible(el) {
138 |       if (!el) return false;
139 |       const st = getComputedStyle(el);
140 |       if (st.display === "none" || st.visibility === "hidden") return false;
141 |       const r = el.getBoundingClientRect();
142 |       return !!r && r.width > 5 && r.height > 5;
143 |     }
144 | 
145 |     function pick(el) {
146 |       if (!el) return null;
147 |       const r = el.getBoundingClientRect();
148 |       return {
149 |         tag: el.tagName,
150 |         role: el.getAttribute("role"),
151 |         aria: el.getAttribute("aria-label"),
152 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
153 |         top: Math.round(r.top),
154 |         left: Math.round(r.left),
155 |         w: Math.round(r.width),
156 |         h: Math.round(r.height),
157 |       };
158 |     }
159 | 
160 |     // clear markers
161 |     try {
162 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
163 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
164 |         n.removeAttribute("data-fbw-comments-header-row")
165 |       );
166 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
167 |         n.removeAttribute("data-fbw-comments-anchor")
168 |       );
169 |     } catch {}
170 | 
171 |     // find header
172 |     const headerSpans = Array.from(document.querySelectorAll("span"))
173 |       .filter(isVisible)
174 |       .filter((el) => {
175 |         const t = norm(el.textContent);
176 |         return t === "komentarze" || t === "comments";
177 |       });
178 | 
179 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
180 | 
181 |     // pick first visible header and mark a "root" around it
182 |     const h = headerSpans[0];
183 | 
184 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
185 |     let row = h.parentElement;
186 |     let foundRow = null;
187 | 
188 |     for (let up = 0; up < 14 && row; up++) {
189 |       const btns = Array.from(
190 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
191 |       ).filter(isVisible);
192 | 
193 |       const ok = btns.some((b) => {
194 |         const al = norm(b.getAttribute("aria-label"));
195 |         return (
196 |           al === "poka≈º wszystkie" ||
197 |           al === "wy≈õwietl wszystkie" ||
198 |           al === "show all" ||
199 |           al === "view all" ||
200 |           al === "ukryj komentarze" ||
201 |           al === "hide comments"
202 |         );
203 |       });
204 | 
205 |       if (ok) {
206 |         foundRow = row;
207 |         break;
208 |       }
209 |       row = row.parentElement;
210 |     }
211 | 
212 |     if (foundRow) {
213 |       try {
214 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
215 |       } catch {}
216 |     }
217 | 
218 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
219 |     let root = h.parentElement;
220 |     let best = null;
221 | 
222 |     for (let up = 0; up < 26 && root; up++) {
223 |       const txt = norm(root.innerText || "");
224 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
225 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
226 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
227 |       const isBigEnough = (root.clientHeight || 0) > 250;
228 | 
229 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
230 |         best = root;
231 |         break;
232 |       }
233 |       root = root.parentElement;
234 |     }
235 | 
236 |     // fallback: use header row parent
237 |     if (!best && foundRow) best = foundRow.parentElement;
238 |     if (!best) best = document.body;
239 | 
240 |     try {
241 |       best.setAttribute("data-fbw-comments-root", "1");
242 |     } catch {}
243 | 
244 |     // anchor element for scroll targeting: header span itself
245 |     try {
246 |       h.setAttribute("data-fbw-comments-anchor", "1");
247 |     } catch {}
248 | 
249 |     return {
250 |       ok: true,
251 |       reason: "marked",
252 |       header: pick(h),
253 |       row: foundRow ? pick(foundRow) : null,
254 |       root: pick(best),
255 |     };
256 |   });
257 | }
258 | 
259 | async function clickShowAllFromMarkedRow(page) {
260 |   const res = await page.evaluate(() => {
261 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
262 | 
263 |     function isVisible(el) {
264 |       if (!el) return false;
265 |       const st = getComputedStyle(el);
266 |       if (st.display === "none" || st.visibility === "hidden") return false;
267 |       const r = el.getBoundingClientRect();
268 |       return !!r && r.width > 5 && r.height > 5;
269 |     }
270 | 
271 |     function pick(el) {
272 |       if (!el) return null;
273 |       const r = el.getBoundingClientRect();
274 |       return {
275 |         tag: el.tagName,
276 |         role: el.getAttribute("role"),
277 |         aria: el.getAttribute("aria-label"),
278 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
279 |         top: Math.round(r.top),
280 |         left: Math.round(r.left),
281 |         w: Math.round(r.width),
282 |         h: Math.round(r.height),
283 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
284 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
285 |       };
286 |     }
287 | 
288 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
289 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
290 | 
291 |     const candidates = Array.from(
292 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
293 |     ).filter(isVisible);
294 | 
295 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
296 |     for (const c of candidates) {
297 |       const al = norm(c.getAttribute("aria-label"));
298 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
299 |         try {
300 |           c.scrollIntoView({ block: "center", inline: "nearest" });
301 |         } catch {}
302 |         try {
303 |           c.click();
304 |         } catch {}
305 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
306 |       }
307 |     }
308 | 
309 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
310 |   });
311 | 
312 |   log.debug("UI:videos", "Show-all click", res);
313 |   return !!res?.clicked;
314 | }
315 | 
316 | /* ==========================================
317 |    ======= FILTER/SORT (Najtrafniejsze) ======
318 |    ========================================== */
319 | 
320 | async function ensureAllCommentsFilter(page) {
321 |   const res = await page.evaluate(() => {
322 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
323 | 
324 |     function isVisible(el) {
325 |       if (!el) return false;
326 |       const st = getComputedStyle(el);
327 |       if (st.display === "none" || st.visibility === "hidden") return false;
328 |       const r = el.getBoundingClientRect();
329 |       return !!r && r.width > 5 && r.height > 5;
330 |     }
331 | 
332 |     function pick(el) {
333 |       if (!el) return null;
334 |       const r = el.getBoundingClientRect();
335 |       return {
336 |         tag: el.tagName,
337 |         role: el.getAttribute("role"),
338 |         aria: el.getAttribute("aria-label"),
339 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
340 |         top: Math.round(r.top),
341 |         left: Math.round(r.left),
342 |         w: Math.round(r.width),
343 |         h: Math.round(r.height),
344 |       };
345 |     }
346 | 
347 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
348 | 
349 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
350 |     const rootTxt = norm(root.innerText || "");
351 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
352 |       return { ok: true, action: "already-all", dbg: null };
353 |     }
354 | 
355 |     // find the sort dropdown button in root
356 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
357 | 
358 |     const sortBtn = btns.find((b) => {
359 |       const t = norm(b.textContent);
360 |       return (
361 |         t === "najtrafniejsze" ||
362 |         t === "most relevant" ||
363 |         t === "top comments" ||
364 |         t === "najlepsze" ||
365 |         t === "newest" ||
366 |         t === "najnowsze"
367 |       );
368 |     });
369 | 
370 |     if (!sortBtn) {
371 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
372 |     }
373 | 
374 |     try {
375 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
376 |     } catch {}
377 |     try {
378 |       sortBtn.click();
379 |     } catch {}
380 | 
381 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
382 |   });
383 | 
384 |   log.debug("UI:videos", "Filter step#1", res);
385 | 
386 |   if (!res?.ok || res.action !== "opened-menu") return false;
387 | 
388 |   await sleepRandom(400, 700);
389 | 
390 |   const res2 = await page.evaluate(() => {
391 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
392 | 
393 |     function isVisible(el) {
394 |       if (!el) return false;
395 |       const st = getComputedStyle(el);
396 |       if (st.display === "none" || st.visibility === "hidden") return false;
397 |       const r = el.getBoundingClientRect();
398 |       return !!r && r.width > 5 && r.height > 5;
399 |     }
400 | 
401 |     function pick(el) {
402 |       if (!el) return null;
403 |       const r = el.getBoundingClientRect();
404 |       return {
405 |         tag: el.tagName,
406 |         role: el.getAttribute("role"),
407 |         aria: el.getAttribute("aria-label"),
408 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
409 |         top: Math.round(r.top),
410 |         left: Math.round(r.left),
411 |         w: Math.round(r.width),
412 |         h: Math.round(r.height),
413 |       };
414 |     }
415 | 
416 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
417 | 
418 |     if (!menu) return { ok: false, action: "no-menu" };
419 | 
420 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
421 |       .filter(isVisible)
422 |       .slice(0, 200);
423 | 
424 |     // Prefer: "Wszystkie komentarze" / "All comments"
425 |     let target =
426 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
427 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
428 | 
429 |     // Fallback: "Najnowsze" / "Newest"
430 |     if (!target) {
431 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
432 |     }
433 | 
434 |     if (!target) {
435 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
436 |     }
437 | 
438 |     try {
439 |       target.scrollIntoView({ block: "center", inline: "nearest" });
440 |     } catch {}
441 |     try {
442 |       target.click();
443 |     } catch {}
444 | 
445 |     // close menu
446 |     try {
447 |       setTimeout(() => document.body.click(), 40);
448 |     } catch {}
449 | 
450 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
451 |   });
452 | 
453 |   log.debug("UI:videos", "Filter step#2", res2);
454 | 
455 |   await sleepRandom(500, 900);
456 | 
457 |   return !!res2?.ok;
458 | }
459 | 
460 | /* ==========================================
461 |    ======= FAST_MODE: SORTOWANIE "NAJNOWSZE" ==
462 |    ========================================== */
463 | 
464 | export async function switchCommentsFilterToNewestScoped(page) {
465 |   log.dev("UI:videos", "Prze≈ÇƒÖczam na 'Najnowsze'...");
466 | 
467 |   // ZAWSZE najpierw spr√≥buj kliknƒÖƒá "Poka≈º wszystkie" ≈ºeby otworzyƒá pe≈Çny panel komentarzy
468 |   log.debug("UI:videos", "Otwieranie panelu komentarzy...");
469 | 
470 |   const clickedShowAll = await page.evaluate(() => {
471 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
472 | 
473 |     function isVisible(el) {
474 |       if (!el) return false;
475 |       const st = getComputedStyle(el);
476 |       if (st.display === "none" || st.visibility === "hidden") return false;
477 |       const r = el.getBoundingClientRect();
478 |       return !!r && r.width > 5 && r.height > 5;
479 |     }
480 | 
481 |     // Szukaj przycisku "Poka≈º wszystkie" / "Show all"
482 |     const btns = Array.from(
483 |       document.querySelectorAll("div[role='button'][aria-label], button[aria-label], a[aria-label]")
484 |     ).filter(isVisible);
485 | 
486 |     for (const btn of btns) {
487 |       const al = norm(btn.getAttribute("aria-label"));
488 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
489 |         try {
490 |           btn.scrollIntoView({ block: "center", inline: "nearest" });
491 |         } catch {}
492 |         try {
493 |           btn.click();
494 |           return { clicked: true, label: al };
495 |         } catch {}
496 |       }
497 |     }
498 |     return { clicked: false };
499 |   });
500 | 
501 |   if (clickedShowAll?.clicked) {
502 |     log.debug("UI:videos", `Klikniƒôto '${clickedShowAll.label}'`);
503 |     await sleepRandom(1500, 2200);
504 |   } else {
505 |     log.debug("UI:videos", "Nie znaleziono 'Poka≈º wszystkie' - mo≈ºe ju≈º rozwiniƒôte");
506 |   }
507 | 
508 |   // Oznacz scope komentarzy
509 |   const mark = await markCommentsScope(page).catch(() => null);
510 |   log.debug("UI:videos", `markCommentsScope: ${mark?.ok ? "OK" : mark?.reason}`);
511 | 
512 |   if (!mark?.ok) {
513 |     log.debug("UI:videos", "Nie znaleziono sekcji komentarzy");
514 |     return { ok: false, reason: "no-comments-scope" };
515 |   }
516 | 
517 |   await sleepRandom(200, 400);
518 | 
519 |   // Sprawd≈∫ czy ju≈º "Najnowsze"
520 |   const alreadyNewest = await page.evaluate(() => {
521 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
522 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
523 |     const rootTxt = norm(root.innerText || "");
524 | 
525 |     // Szukamy przycisku z labelem "Najnowsze" jako aktywny filtr
526 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button"));
527 |     return btns.some((b) => {
528 |       const t = norm(b.textContent);
529 |       return t === "najnowsze" || t === "newest";
530 |     });
531 |   });
532 | 
533 |   if (alreadyNewest) {
534 |     log.debug("UI:videos", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
535 |     return { ok: true, state: "already-newest" };
536 |   }
537 | 
538 |   // Otw√≥rz menu sortowania
539 |   const openRes = await page.evaluate(() => {
540 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
541 | 
542 |     function isVisible(el) {
543 |       if (!el) return false;
544 |       const st = getComputedStyle(el);
545 |       if (st.display === "none" || st.visibility === "hidden") return false;
546 |       const r = el.getBoundingClientRect();
547 |       return !!r && r.width > 5 && r.height > 5;
548 |     }
549 | 
550 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
551 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
552 | 
553 |     // Szukaj przycisku sortowania (Najtrafniejsze/Most relevant/Top comments/Wszystkie komentarze)
554 |     const sortBtn = btns.find((b) => {
555 |       const t = norm(b.textContent);
556 |       return (
557 |         t === "najtrafniejsze" ||
558 |         t === "most relevant" ||
559 |         t === "top comments" ||
560 |         t === "najlepsze" ||
561 |         t === "wszystkie komentarze" ||
562 |         t === "all comments"
563 |       );
564 |     });
565 | 
566 |     if (!sortBtn) {
567 |       return { ok: false, reason: "no-sortbtn" };
568 |     }
569 | 
570 |     try {
571 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
572 |     } catch {}
573 |     try {
574 |       sortBtn.click();
575 |     } catch {}
576 | 
577 |     return { ok: true, action: "opened-menu" };
578 |   });
579 | 
580 |   if (!openRes?.ok) {
581 |     log.debug("UI:videos", "Nie znaleziono przycisku sortowania");
582 |     return { ok: false, reason: openRes?.reason || "no-sortbtn" };
583 |   }
584 | 
585 |   await sleepRandom(400, 700);
586 | 
587 |   // Wybierz "Najnowsze" z menu
588 |   const selectRes = await page.evaluate(() => {
589 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
590 | 
591 |     function isVisible(el) {
592 |       if (!el) return false;
593 |       const st = getComputedStyle(el);
594 |       if (st.display === "none" || st.visibility === "hidden") return false;
595 |       const r = el.getBoundingClientRect();
596 |       return !!r && r.width > 5 && r.height > 5;
597 |     }
598 | 
599 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
600 |     if (!menu) return { ok: false, reason: "no-menu" };
601 | 
602 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
603 |       .filter(isVisible);
604 | 
605 |     // Szukaj "Najnowsze" / "Newest"
606 |     const target = items.find((el) => {
607 |       const t = norm(el.textContent);
608 |       return t.startsWith("najnowsze") || t.startsWith("newest") || t.startsWith("od najnowszych") || t.startsWith("most recent");
609 |     });
610 | 
611 |     if (!target) {
612 |       return { ok: false, reason: "no-newest-option" };
613 |     }
614 | 
615 |     try {
616 |       target.scrollIntoView({ block: "center", inline: "nearest" });
617 |     } catch {}
618 |     try {
619 |       target.click();
620 |     } catch {}
621 | 
622 |     // Zamknij menu
623 |     try {
624 |       setTimeout(() => document.body.click(), 40);
625 |     } catch {}
626 | 
627 |     return { ok: true, action: "clicked-newest" };
628 |   });
629 | 
630 |   if (selectRes?.ok) {
631 |     log.dev("UI:videos", "Filtr ustawiony: 'Najnowsze'");
632 |     await sleepRandom(400, 700);
633 |     return { ok: true };
634 |   }
635 | 
636 |   log.debug("UI:videos", `Nie uda≈Ço siƒô wybraƒá 'Najnowsze': ${selectRes?.reason}`);
637 |   return { ok: false, reason: selectRes?.reason || "select-failed" };
638 | }
639 | 
640 | /* ==========================================
641 |    ======= SEQUENTIAL ACTION LOOP ============
642 |    ========================================== */
643 | 
644 | async function oneSequentialAction(page) {
645 |   const res = await page.evaluate(() => {
646 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
647 | 
648 |     function isVisible(el) {
649 |       if (!el) return false;
650 |       const st = getComputedStyle(el);
651 |       if (st.display === "none" || st.visibility === "hidden") return false;
652 |       const r = el.getBoundingClientRect();
653 |       return !!r && r.width > 5 && r.height > 5;
654 |     }
655 | 
656 |     function pick(el) {
657 |       if (!el) return null;
658 |       const r = el.getBoundingClientRect();
659 |       return {
660 |         tag: el.tagName,
661 |         role: el.getAttribute("role"),
662 |         aria: el.getAttribute("aria-label"),
663 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
664 |         top: Math.round(r.top),
665 |         left: Math.round(r.left),
666 |         w: Math.round(r.width),
667 |         h: Math.round(r.height),
668 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
669 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
670 |       };
671 |     }
672 | 
673 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
674 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
675 | 
676 |     const composer =
677 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
678 |       root.querySelector("[aria-label^='Write a comment']") ||
679 |       root.querySelector("[role='textbox'][contenteditable='true']");
680 | 
681 |     let scope = root;
682 |     if (composer) {
683 |       let p = composer.parentElement;
684 |       for (let up = 0; up < 14 && p; up++) {
685 |         const bigEnough = (p.clientHeight || 0) > 220;
686 |         const t = norm(p.innerText || "");
687 |         const looksCommenty =
688 |           t.includes("najtrafniejsze") ||
689 |           t.includes("most relevant") ||
690 |           t.includes("wszystkie komentarze") ||
691 |           t.includes("all comments") ||
692 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
693 |           t.includes("view more comments");
694 |         if (bigEnough && looksCommenty) {
695 |           scope = p;
696 |           break;
697 |         }
698 |         p = p.parentElement;
699 |       }
700 |     }
701 | 
702 |     // UWAGA: klikamy TYLKO elementy klikalne
703 |     const clickables = Array.from(
704 |       scope.querySelectorAll(
705 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
706 |       )
707 |     )
708 |       .filter(isVisible)
709 |       .slice(0, 12000);
710 | 
711 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
712 | 
713 |     const moreCommentNeedles = [
714 |       "wy≈õwietl wiƒôcej komentarzy",
715 |       "zobacz wiƒôcej komentarzy",
716 |       "view more comments",
717 |       "view previous comments",
718 |       "see more comments",
719 |     ];
720 | 
721 |     // 1) MORE COMMENTS ‚Äì tylko clickables
722 |     for (const el of clickables) {
723 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
724 |       if (!t) continue;
725 |       if (bannedExact.has(t)) continue;
726 | 
727 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
728 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
729 |         try { el.click(); } catch {}
730 |         return { acted: true, action: "more-comments", dbg: pick(el) };
731 |       }
732 |     }
733 | 
734 |     // 2) REPLIES ‚Äì tylko clickables
735 |     for (const el of clickables) {
736 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
737 |       if (!t) continue;
738 |       if (bannedExact.has(t)) continue;
739 | 
740 |       const isReply =
741 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
742 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
743 |         t.includes("view more replies") ||
744 |         t.includes("see more replies") ||
745 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
746 | 
747 |       if (isReply) {
748 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
749 |         try { el.click(); } catch {}
750 |         return { acted: true, action: "replies", dbg: pick(el) };
751 |       }
752 |     }
753 | 
754 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
755 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
756 | 
757 |     const beforeScope = scope.scrollTop || 0;
758 |     try {
759 |       if (scope && typeof scope.scrollTop === "number") {
760 |         scope.scrollTop = beforeScope + step;
761 |         const afterScope = scope.scrollTop || beforeScope;
762 |         if (afterScope > beforeScope) {
763 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
764 |         }
765 |       }
766 |     } catch {}
767 | 
768 |     const beforeWin = window.scrollY || 0;
769 |     window.scrollBy(0, step);
770 |     const afterWin = window.scrollY || 0;
771 | 
772 |     return {
773 |       acted: afterWin > beforeWin,
774 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
775 |       dbg: { beforeWin, afterWin, step },
776 |     };
777 |   });
778 | 
779 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
780 |   log.debug("UI:videos", "step", res);
781 |   return res || { acted: false, action: "none", dbg: null };
782 | }
783 | 
784 | 
785 | 
786 | /**
787 |  * Wczytuje wszystkie komentarze dla posta wideo.
788 |  */
789 | export async function loadAllComments(page, { expectedTotal } = {}) {
790 |   log.dev("UI:videos", "≈Åadujƒô komentarze...");
791 | 
792 |   await debugDumpShowAllCandidates(page).catch(() => {});
793 | 
794 |   const mark1 = await markCommentsScope(page).catch(() => null);
795 |   log.debug("UI:videos", "mark#1", mark1);
796 | 
797 |   await sleepRandom(250, 500);
798 | 
799 |   // klik show-all z header-row
800 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
801 |   if (clickedAll) {
802 |     await sleepRandom(900, 1400);
803 |     const mark2 = await markCommentsScope(page).catch(() => null);
804 |     log.debug("UI:videos", "mark#2", mark2);
805 |   } else {
806 |     log.debug("UI:videos", "show-all: nie klikniƒôto");
807 |   }
808 | 
809 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
810 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
811 |   log.debug("UI:videos", `filter ensure: ${filterOk}`);
812 | 
813 |   // policz cykle dynamicznie
814 |   let maxCycles = 180;
815 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
816 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
817 |   }
818 | 
819 |   let noProgress = 0;
820 | 
821 |   for (let i = 1; i <= maxCycles; i++) {
822 |     // jedna akcja na cykl
823 |     const r = await oneSequentialAction(page);
824 | 
825 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
826 |     if (!didProgress) noProgress++;
827 |     else noProgress = 0;
828 | 
829 |     if (i === 1 || i % 20 === 0) {
830 |       log.debug("UI:videos", `Cycle ${i}/${maxCycles}`, { action: r?.action, acted: !!r?.acted, noProgress });
831 |     }
832 | 
833 |     if (noProgress >= 10) {
834 |       log.debug("UI:videos", "Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie");
835 |       break;
836 |     }
837 | 
838 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
839 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
840 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
841 |     else await sleepRandom(450, 850);
842 |   }
843 | 
844 |   log.dev("UI:videos", "Komentarze za≈Çadowane");
845 | }
846 | 
847 | /**
848 |  * Ekstrahuje komentarze z posta wideo.
849 |  */
850 | export async function extractComments(page, url) {
851 |   const comments = await page.evaluate(() => {
852 |     function getCommentId(href) {
853 |       try {
854 |         const u = new URL(href, location.origin);
855 |         const cid = u.searchParams.get("comment_id");
856 |         const rid = u.searchParams.get("reply_comment_id");
857 |         return rid || cid;
858 |       } catch {
859 |         return null;
860 |       }
861 |     }
862 | 
863 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
864 |     const idToTime = {};
865 | 
866 |     for (let i = 0; i < allLinks.length; i++) {
867 |       const id = getCommentId(allLinks[i].href || "");
868 |       if (id) {
869 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
870 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
871 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
872 |             idToTime[id] = txt;
873 |             break;
874 |           }
875 |         }
876 |       }
877 |     }
878 | 
879 |     const commentBlocks = Array.from(
880 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
881 |     );
882 | 
883 |     const data = commentBlocks
884 |       .map((node) => {
885 |         try {
886 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
887 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
888 |           const linkEl = node.querySelector('a[role="link"]');
889 |           const href = linkEl?.getAttribute("href");
890 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
891 |           const id = permalink ? getCommentId(permalink) : null;
892 |           const time = id && idToTime[id] ? idToTime[id] : null;
893 | 
894 |           if (!author && !text) return null;
895 |           return { id, author, text, permalink, time };
896 |         } catch {
897 |           return null;
898 |         }
899 |       })
900 |       .filter(Boolean);
901 | 
902 |     return data;
903 |   });
904 | 
905 |   log.debug("UI:videos", `Wyekstrahowano ${comments.length} komentarzy`);
906 |   return comments;
907 | }
908 | 
909 | export async function debugSnapshot(page) {
910 |   try {
911 |     const path = `snapshot-videos.png`;
912 |     await page.screenshot({ path });
913 |     log.debug("UI:videos", `Zapisano zrzut: ${path}`);
914 |   } catch (e) {
915 |     log.error("UI:videos", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
916 |   }
917 | }
918 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/ui/watch.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/ui/watch.js
  2 | import { safeGoto } from "../../utils/navigation.js";
  3 | import { sleepRandom } from "../../utils/sleep.js";
  4 | import { acceptCookies, saveCookies } from "../cookies.js";
  5 | import { fbLogin, checkIfLogged } from "../login.js";
  6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
  7 | import log from "../../utils/logger.js";
  8 | 
  9 | /** Typ handlera UI */
 10 | export const type = "watch";
 11 | 
 12 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
 13 | export function matchesUrl(url) {
 14 |   try {
 15 |     const u = new URL(url);
 16 |     return (u.pathname || "").toLowerCase().includes("/watch");
 17 |   } catch {
 18 |     return String(url || "").toLowerCase().includes("/watch");
 19 |   }
 20 | }
 21 | 
 22 | /* ============================================================
 23 |    ======================= DEBUG HELPERS ======================
 24 |    ============================================================ */
 25 | 
 26 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
 27 | 
 28 | async function safeShot(page, path, clip = null) {
 29 |   if (!DEBUG_WATCH) return;
 30 |   try {
 31 |     const opts = clip ? { path, clip } : { path, fullPage: false };
 32 |     await page.screenshot(opts);
 33 |     log.debug("UI:watch", `Screenshot ‚Üí ${path}`);
 34 |   } catch (e) {
 35 |     log.debug("UI:watch", `Screenshot failed: ${e?.message || e}`);
 36 |   }
 37 | }
 38 | 
 39 | async function shotElement(page, handle, path) {
 40 |   if (!DEBUG_WATCH) return;
 41 |   try {
 42 |     if (!handle) return;
 43 |     const box = await handle.boundingBox().catch(() => null);
 44 |     if (!box || box.width < 5 || box.height < 5) {
 45 |       log.debug("UI:watch", "shotElement: no bbox");
 46 |       return;
 47 |     }
 48 |     const clip = {
 49 |       x: Math.max(0, box.x),
 50 |       y: Math.max(0, box.y),
 51 |       width: Math.max(1, Math.min(box.width, 1920)),
 52 |       height: Math.max(1, Math.min(box.height, 1080)),
 53 |     };
 54 |     await safeShot(page, path, clip);
 55 |   } catch (e) {
 56 |     log.debug("UI:watch", `shotElement failed: ${e?.message || e}`);
 57 |   }
 58 | }
 59 | 
 60 | async function debugOuterStats(page, outerHandle) {
 61 |   if (!DEBUG_WATCH) return null;
 62 |   if (!outerHandle) return null;
 63 | 
 64 |   return page.evaluate((outer) => {
 65 |     const norm = (s) =>
 66 |       String(s || "")
 67 |         .replace(/\u00a0/g, " ")
 68 |         .replace(/\s+/g, " ")
 69 |         .trim();
 70 | 
 71 |     const r = outer.getBoundingClientRect();
 72 |     const style = getComputedStyle(outer);
 73 | 
 74 |     const anchors = Array.from(
 75 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 76 |     );
 77 | 
 78 |     const allText = (outer.innerText || "").toLowerCase();
 79 |     const moreHits =
 80 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
 81 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
 82 |       (allText.match(/view more comments/g) || []).length +
 83 |       (allText.match(/see more comments/g) || []).length;
 84 | 
 85 |     const labels = [];
 86 |     const nodes = Array.from(
 87 |       outer.querySelectorAll(
 88 |         "button,div[role='button'],span[role='button'],a,abbr,[role='article'],div,span"
 89 |       )
 90 |     ).slice(0, 4000);
 91 | 
 92 |     for (const el of nodes) {
 93 |       const a = el.getAttribute?.("aria-label");
 94 |       const t = norm(a);
 95 |       if (t) labels.push(t);
 96 |     }
 97 | 
 98 |     const freq = new Map();
 99 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
100 |     const topLabels = Array.from(freq.entries())
101 |       .sort((a, b) => b[1] - a[1])
102 |       .slice(0, 15)
103 |       .map(([k, v]) => ({ label: k, n: v }));
104 | 
105 |     return {
106 |       tag: outer.tagName,
107 |       className: outer.className || "",
108 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
109 |       style: {
110 |         overflowY: style.overflowY,
111 |         position: style.position,
112 |       },
113 |       counts: {
114 |         anchors: anchors.length,
115 |         moreHits,
116 |       },
117 |       topLabels,
118 |     };
119 |   }, outerHandle);
120 | }
121 | 
122 | async function debugScrollerStats(page, scrollerHandle) {
123 |   if (!DEBUG_WATCH) return null;
124 |   if (!scrollerHandle) return null;
125 | 
126 |   return page.evaluate((s) => {
127 |     const r = s.getBoundingClientRect();
128 |     const st = getComputedStyle(s);
129 |     return {
130 |       tag: s.tagName,
131 |       className: s.className || "",
132 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
133 |       style: { overflowY: st.overflowY, overflow: st.overflow },
134 |       scroll: {
135 |         scrollTop: s.scrollTop,
136 |         clientHeight: s.clientHeight,
137 |         scrollHeight: s.scrollHeight,
138 |       },
139 |     };
140 |   }, scrollerHandle);
141 | }
142 | 
143 | /* ============================================================
144 |    ======================= PARSING COUNT =======================
145 |    ============================================================ */
146 | 
147 | function parseCountFromText(str) {
148 |   if (!str) return null;
149 | 
150 |   const raw = String(str)
151 |     .toLowerCase()
152 |     .replace(/\u00a0/g, " ")
153 |     .replace(/\s+/g, " ")
154 |     .trim();
155 | 
156 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
157 |   if (!m) return null;
158 | 
159 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
160 |   const suf = (m[2] || "").trim();
161 | 
162 |   const hasDecimal = /[.,]\d/.test(numStr);
163 |   if (hasDecimal) numStr = numStr.replace(",", ".");
164 |   else numStr = numStr.replace(/[.,]/g, "");
165 | 
166 |   let n = Number(numStr);
167 |   if (!Number.isFinite(n)) return null;
168 | 
169 |   if (suf === "k") n *= 1000;
170 |   if (suf === "tys" || suf === "tys.") n *= 1000;
171 |   if (suf === "m" || suf === "mln") n *= 1000000;
172 | 
173 |   n = Math.round(n);
174 |   if (n <= 0) return null;
175 |   return n;
176 | }
177 | 
178 | function parseBestCommentsCountFromBlob(blobStr) {
179 |   if (!blobStr) return null;
180 | 
181 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
182 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
183 | 
184 |   let best = null;
185 |   let match;
186 |   while ((match = re.exec(raw)) !== null) {
187 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
188 |     const n = parseCountFromText(candidate);
189 |     if (n && (!best || n > best)) best = n;
190 |   }
191 |   return best;
192 | }
193 | 
194 | function pickBestCount(candidates) {
195 |   const nums = candidates.filter((v) => typeof v === "number" && Number.isFinite(v) && v > 0);
196 |   if (!nums.length) return null;
197 | 
198 |   nums.sort((a, b) => b - a);
199 |   const best = nums[0];
200 |   const second = nums[1];
201 | 
202 |   if (second && best >= 2 * second && second < 150) return best;
203 | 
204 |   return best;
205 | }
206 | 
207 | /* ============================================================
208 |    =================== COMMENTS CONTAINER FIND =================
209 |    ============================================================ */
210 | 
211 | /**
212 |  * WATCH FIX:
213 |  * - NIE polegamy na h2 "Komentarze" (czƒôsto go nie ma w Watch).
214 |  * - Szukamy najwiƒôkszego klastra link√≥w comment_id/reply_comment_id na stronie.
215 |  */
216 | async function findCommentsOuter(page) {
217 |   const handle = await page.evaluateHandle(() => {
218 |     const nodes = Array.from(document.querySelectorAll("div, section, main, article")).slice(0, 30000);
219 | 
220 |     const visible = (el) => {
221 |       if (!el) return false;
222 |       const r = el.getBoundingClientRect?.();
223 |       return r && r.width >= 220 && r.height >= 220;
224 |     };
225 | 
226 |     let best = null;
227 |     let bestScore = -1;
228 | 
229 |     for (const el of nodes) {
230 |       if (!visible(el)) continue;
231 | 
232 |       const anchors = el.querySelectorAll?.("a[href*='comment_id'], a[href*='reply_comment_id']");
233 |       const aCount = anchors ? anchors.length : 0;
234 |       if (aCount < 3) continue;
235 | 
236 |       const txt = (el.innerText || "").toLowerCase();
237 |       const hasWords =
238 |         txt.includes("komentarz") || txt.includes("komentarzy") || txt.includes("comments") || txt.includes("comment");
239 | 
240 |       // score: anchor count + bonus za s≈Çowa ‚Äúkomentarz‚Äù
241 |       const score = aCount + (hasWords ? 12 : 0);
242 | 
243 |       if (score > bestScore) {
244 |         bestScore = score;
245 |         best = el;
246 |       }
247 |     }
248 | 
249 |     return best || null;
250 |   });
251 | 
252 |   const el = handle?.asElement?.() || null;
253 |   if (!el) return null;
254 | 
255 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
256 |   return ok ? el : null;
257 | }
258 | 
259 | async function findScrollableInOuter(page, outerHandle) {
260 |   if (!outerHandle) return null;
261 | 
262 |   const scrollerHandle = await page.evaluateHandle((outer) => {
263 |     function isVisible(el) {
264 |       if (!el) return false;
265 |       const r = el.getBoundingClientRect();
266 |       return r.width > 2 && r.height > 2;
267 |     }
268 | 
269 |     function canScroll(el) {
270 |       try {
271 |         if (!el) return false;
272 |         const st = getComputedStyle(el);
273 |         const oy = (st.overflowY || "").toLowerCase();
274 |         if (!(oy === "auto" || oy === "scroll")) return false;
275 |         const h = el.clientHeight || 0;
276 |         const sh = el.scrollHeight || 0;
277 |         return sh > h + 80;
278 |       } catch {
279 |         return false;
280 |       }
281 |     }
282 | 
283 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
284 |       .filter(isVisible)
285 |       .slice(0, 20000);
286 | 
287 |     let best = null;
288 |     let bestScore = -1;
289 | 
290 |     for (const el of nodes) {
291 |       if (!canScroll(el)) continue;
292 | 
293 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
294 |       const txt = (el.innerText || "").toLowerCase();
295 | 
296 |       const hasMore =
297 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
298 |         txt.includes("view more comments") ||
299 |         txt.includes("see more comments") ||
300 |         txt.includes("zobacz wiƒôcej komentarzy") ||
301 |         txt.includes("zobacz wcze≈õniejsze komentarze");
302 | 
303 |       const score = delta + (hasMore ? 100000 : 0);
304 |       if (score > bestScore) {
305 |         bestScore = score;
306 |         best = el;
307 |       }
308 |     }
309 | 
310 |     return best || null;
311 |   }, outerHandle);
312 | 
313 |   const el = scrollerHandle?.asElement?.() || null;
314 |   if (!el) return null;
315 | 
316 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
317 |   return ok ? el : null;
318 | }
319 | 
320 | async function clickMoreCommentsIfPresent(page, outerHandle) {
321 |   if (!outerHandle) return false;
322 | 
323 |   const labels = [
324 |     "wy≈õwietl wiƒôcej komentarzy",
325 |     "zobacz wiƒôcej komentarzy",
326 |     "zobacz wcze≈õniejsze komentarze",
327 |     "view more comments",
328 |     "see more comments",
329 |     "show more comments",
330 |     "view previous comments",
331 |   ];
332 | 
333 |   const clicked = await page.evaluate(
334 |     (outer, labelsArr) => {
335 |       const norm = (s) =>
336 |         String(s || "")
337 |           .replace(/\u00a0/g, " ")
338 |           .replace(/\s+/g, " ")
339 |           .trim()
340 |           .toLowerCase();
341 | 
342 |       const isVisible = (el) => {
343 |         if (!el) return false;
344 |         const r = el.getBoundingClientRect();
345 |         return r.width > 2 && r.height > 2;
346 |       };
347 | 
348 |       const nodes = Array.from(
349 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
350 |       ).filter(isVisible);
351 | 
352 |       for (const el of nodes) {
353 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
354 |         if (!t) continue;
355 |         if (labelsArr.some((x) => t.includes(x))) {
356 |           try {
357 |             el.scrollIntoView({ block: "center" });
358 |           } catch {}
359 |           const clickable =
360 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
361 |           try {
362 |             clickable.click();
363 |             return true;
364 |           } catch {}
365 |         }
366 |       }
367 |       return false;
368 |     },
369 |     outerHandle,
370 |     labels
371 |   );
372 | 
373 |   return !!clicked;
374 | }
375 | 
376 | async function getAnchorsCount(page, outerHandle) {
377 |   if (!outerHandle) return 0;
378 |   return page
379 |     .evaluate((outer) => {
380 |       const as = Array.from(
381 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
382 |       );
383 |       const ids = new Set();
384 |       for (const a of as) {
385 |         try {
386 |           const u = new URL(a.href, location.origin);
387 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
388 |           if (id) ids.add(id);
389 |         } catch {}
390 |       }
391 |       return ids.size;
392 |     }, outerHandle)
393 |     .catch(() => 0);
394 | }
395 | 
396 | async function getCommentRootsCount(page, outerHandle) {
397 |   if (!outerHandle) return 0;
398 |   return page
399 |     .evaluate((outer) => {
400 |       const as = Array.from(
401 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
402 |       );
403 |       const roots = new Set();
404 |       for (const a of as) {
405 |         const root = a.closest?.("[role='article']") || a.closest?.("div");
406 |         if (root) roots.add(root);
407 |       }
408 |       return roots.size;
409 |     }, outerHandle)
410 |     .catch(() => 0);
411 | }
412 | 
413 | /* ============================================================
414 |    ============================ API ============================
415 |    ============================================================ */
416 | 
417 | export async function prepare(page, url) {
418 |   log.dev("UI:watch", `Prepare: ${url}`);
419 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
420 |   if (!ok) throw new Error("safeGoto-failed");
421 | 
422 |   await acceptCookies(page, "watch-initial");
423 | 
424 |   const currentUrl = page.url();
425 |   if (currentUrl.includes("/login")) {
426 |     log.dev("UI:watch", "Login wymagany...");
427 |     await fbLogin(page);
428 |     await sleepRandom(3000, 4500);
429 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
430 |     log.dev("UI:watch", `Sesja po login: ${loggedAfterLogin ? "OK" : "BRAK"}`);
431 |     if (loggedAfterLogin) {
432 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
433 |       await acceptCookies(page, "watch-post-login");
434 |     } else {
435 |       log.dev("UI:watch", "Login failed ‚Äì kontynuujƒô bez sesji");
436 |     }
437 |   } else {
438 |     const logged = await checkIfLogged(page).catch(() => false);
439 |     if (!logged) {
440 |       log.dev("UI:watch", "Brak sesji ‚Äì fbLogin()");
441 |       await fbLogin(page);
442 |       await sleepRandom(3000, 4500);
443 |       await acceptCookies(page, "watch-after-login");
444 |       const logged2 = await checkIfLogged(page).catch(() => false);
445 |       log.dev("UI:watch", `Sesja po login: ${logged2 ? "OK" : "BRAK"}`);
446 |     }
447 |   }
448 | 
449 |   try {
450 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
451 |     if (loggedFinal) await saveCookies(page);
452 |   } catch {}
453 | 
454 |   await acceptCookies(page, "watch");
455 | 
456 |   try {
457 |     await page.evaluate(() => {
458 |       const vids = Array.from(document.querySelectorAll("video"));
459 |       for (const v of vids) {
460 |         try {
461 |           v.autoplay = false;
462 |           v.removeAttribute("autoplay");
463 |           v.muted = true;
464 |           v.pause();
465 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
466 |         } catch {}
467 |       }
468 |     });
469 |     log.debug("UI:watch", "Wideo wstrzymane");
470 |   } catch (e) {
471 |     log.debug("UI:watch", `B≈ÇƒÖd wstrzymania wideo: ${e?.message || e}`);
472 |   }
473 | 
474 |   if (DEBUG_WATCH) {
475 |     await safeShot(page, "watch-prepare.png");
476 |   }
477 | }
478 | 
479 | export async function getCommentCount(page, url) {
480 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
481 | 
482 |   const parsedFromUiRaw = uiInfo?.raw ? parseBestCommentsCountFromBlob(uiInfo.raw) : null;
483 | 
484 |   let parsedFromOuter = null;
485 |   const outer = await findCommentsOuter(page).catch(() => null);
486 |   if (outer) {
487 |     parsedFromOuter = await page
488 |       .evaluate((o) => (o.innerText || "").replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim(), outer)
489 |       .then((txt) => parseBestCommentsCountFromBlob(txt))
490 |       .catch(() => null);
491 |   }
492 | 
493 |   const uiDirect =
494 |     uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0 ? uiInfo.comments : null;
495 | 
496 |   const totalComments = pickBestCount([parsedFromOuter, parsedFromUiRaw, uiDirect]);
497 | 
498 |   log.debug("UI:watch", "Count sources", {
499 |     ui_source: uiInfo?.source || null,
500 |     ui_viewType: uiInfo?.viewType || null,
501 |     ui_comments: uiDirect,
502 |     parsedFromUiRaw,
503 |     parsedFromOuter,
504 |     picked: totalComments,
505 |   });
506 | 
507 |   let final = totalComments;
508 | 
509 |   log.dev("UI:watch", `Liczba komentarzy: ${final ?? "brak danych"}`);
510 |   return final;
511 | }
512 | 
513 | export async function loadAllComments(page, { expectedTotal } = {}) {
514 |   log.dev("UI:watch", "≈Åadujƒô komentarze...");
515 | 
516 |   let maxCycles = 40;
517 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
518 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
519 |   }
520 |   log.debug("UI:watch", `maxCycles=${maxCycles}`);
521 | 
522 |   const outer = await findCommentsOuter(page);
523 |   if (!outer) {
524 |     log.debug("UI:watch", "OUTER NOT FOUND");
525 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
526 |     return;
527 |   }
528 | 
529 |   if (DEBUG_WATCH) {
530 |     const stats = await debugOuterStats(page, outer);
531 |     log.debug("UI:watch", "OUTER stats", stats);
532 |     await shotElement(page, outer, "watch-outer.png");
533 |   }
534 | 
535 |   const scroller = await findScrollableInOuter(page, outer);
536 | 
537 |   if (DEBUG_WATCH) {
538 |     if (scroller) {
539 |       const sstats = await debugScrollerStats(page, scroller);
540 |       log.debug("UI:watch", "SCROLLER stats", sstats);
541 |       await shotElement(page, scroller, "watch-scroller.png");
542 |     } else {
543 |       log.debug("UI:watch", "SCROLLER NOT FOUND -> window scroll fallback");
544 |       await safeShot(page, "watch-no-scroller.png");
545 |     }
546 |   }
547 | 
548 |   let prevAnchors = await getAnchorsCount(page, outer);
549 |   let prevRoots = await getCommentRootsCount(page, outer);
550 |   let noProgress = 0;
551 | 
552 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
553 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
554 | 
555 |     let wheeled = false;
556 |     let beforeST = 0;
557 |     let afterST = 0;
558 | 
559 |     if (scroller) {
560 |       try {
561 |         beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
562 |       } catch {}
563 | 
564 |       try {
565 |         const box = await scroller.boundingBox();
566 |         if (box && box.width > 5 && box.height > 5) {
567 |           await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
568 |           await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
569 |           wheeled = true;
570 |         }
571 |       } catch {}
572 | 
573 |       await sleepRandom(450, 850);
574 | 
575 |       try {
576 |         afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
577 |       } catch {}
578 |     } else {
579 |       try {
580 |         beforeST = await page.evaluate(() => {
581 |           const el = document.scrollingElement || document.documentElement;
582 |           return el ? el.scrollTop || 0 : 0;
583 |         });
584 |       } catch {}
585 |       try {
586 |         await page.mouse.wheel({ deltaY: 900 });
587 |         wheeled = true;
588 |       } catch {}
589 |       await sleepRandom(450, 850);
590 |       try {
591 |         afterST = await page.evaluate(() => {
592 |           const el = document.scrollingElement || document.documentElement;
593 |           return el ? el.scrollTop || 0 : 0;
594 |         });
595 |       } catch {}
596 |     }
597 | 
598 |     const curAnchors = await getAnchorsCount(page, outer);
599 |     const curRoots = await getCommentRootsCount(page, outer);
600 | 
601 |     const progressed = curAnchors > prevAnchors || curRoots > prevRoots;
602 | 
603 |     if (progressed) {
604 |       prevAnchors = curAnchors;
605 |       prevRoots = curRoots;
606 |       noProgress = 0;
607 |     } else {
608 |       noProgress++;
609 |     }
610 | 
611 |     if (cycle === 1 || cycle % 10 === 0) {
612 |       log.debug("UI:watch", `cycle ${cycle}/${maxCycles}: anchors=${curAnchors}, roots=${curRoots}, np=${noProgress}`);
613 |     }
614 | 
615 |     if (DEBUG_WATCH && cycle === 5) {
616 |       await safeShot(page, "watch-after-5.png");
617 |     }
618 | 
619 |     if (noProgress >= 8) {
620 |       log.debug("UI:watch", "Brak postƒôpu ‚Äì przerywam");
621 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
622 |       break;
623 |     }
624 |   }
625 | 
626 |   log.dev("UI:watch", "Komentarze za≈Çadowane");
627 | }
628 | 
629 | export async function extractComments(page, url) {
630 |   const outer = await findCommentsOuter(page).catch(() => null);
631 |   if (!outer) {
632 |     log.debug("UI:watch", "extractComments: OUTER NOT FOUND");
633 |     if (DEBUG_WATCH) await safeShot(page, "watch-extract-no-outer.png");
634 |     return [];
635 |   }
636 | 
637 |   const comments = await page.evaluate((outerEl) => {
638 |     function norm(s) {
639 |       return String(s || "")
640 |         .replace(/\u00a0/g, " ")
641 |         .replace(/\s+/g, " ")
642 |         .trim();
643 |     }
644 | 
645 |     function toAbsHref(href) {
646 |       if (!href) return null;
647 |       if (href.startsWith("http")) return href;
648 |       if (href.startsWith("/")) return `${location.origin}${href}`;
649 |       return href;
650 |     }
651 | 
652 |     function getCommentId(href) {
653 |       try {
654 |         const u = new URL(href, location.origin);
655 |         return u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
656 |       } catch {
657 |         return null;
658 |       }
659 |     }
660 | 
661 |     function normalizeTime(text) {
662 |       if (!text) return null;
663 | 
664 |       const t = norm(text).toLowerCase();
665 |       if (!t) return null;
666 | 
667 |       if (t.includes("przed chwilƒÖ")) return "0 min";
668 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
669 |       if (t.includes("wczoraj") || t.includes("yesterday")) return "wczoraj";
670 | 
671 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
672 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô)\b/.test(t)) return t;
673 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
674 |       if (/^\d+\s*(dzie≈Ñ|dni|d)\b/.test(t)) return t;
675 |       if (/^\d+\s*(tyg|tyg\.|week|weeks)\b/.test(t)) return t;
676 | 
677 |       return null;
678 |     }
679 | 
680 |     function findTimeInRoot(root) {
681 |       if (!root) return null;
682 | 
683 |       const els = Array.from(root.querySelectorAll("abbr, a, span")).slice(0, 250);
684 |       for (const el of els) {
685 |         const aria = el.getAttribute?.("aria-label");
686 |         const t1 = normalizeTime(aria);
687 |         if (t1) return t1;
688 | 
689 |         const title = el.getAttribute?.("title");
690 |         const t2 = normalizeTime(title);
691 |         if (t2) return t2;
692 | 
693 |         const txt = el.textContent;
694 |         const t3 = normalizeTime(txt);
695 |         if (t3) return t3;
696 |       }
697 |       return null;
698 |     }
699 | 
700 |     const anchors = Array.from(
701 |       outerEl.querySelectorAll("a[href*='comment_id='], a[href*='reply_comment_id=']")
702 |     );
703 | 
704 |     const seenRoots = new Set();
705 |     const out = [];
706 | 
707 |     for (const a of anchors) {
708 |       const href = a.getAttribute("href") || a.href || null;
709 |       const absHref = toAbsHref(href);
710 | 
711 |       const id = absHref ? getCommentId(absHref) : null;
712 |       if (!id) continue;
713 | 
714 |       const root = a.closest?.("[role='article']") || a.closest?.("div") || null;
715 |       if (!root) continue;
716 |       if (seenRoots.has(root)) continue;
717 |       seenRoots.add(root);
718 | 
719 |       const author =
720 |         norm(root.querySelector("a[role='link'] span")?.textContent) ||
721 |         norm(root.querySelector("strong")?.textContent) ||
722 |         null;
723 | 
724 |       const autos = Array.from(root.querySelectorAll("[dir='auto']"))
725 |         .map((el) => norm(el.textContent))
726 |         .filter(Boolean);
727 | 
728 |       let text = "";
729 |       if (autos.length) text = autos[autos.length - 1];
730 | 
731 |       const time = findTimeInRoot(root);
732 | 
733 |       if (!author && !text) continue;
734 | 
735 |       out.push({
736 |         id,
737 |         author,
738 |         text,
739 |         permalink: absHref,
740 |         time: time || null,
741 |       });
742 |     }
743 | 
744 |     return out;
745 |   }, outer);
746 | 
747 |   log.debug("UI:watch", `Wyekstrahowano ${comments.length} komentarzy`);
748 |   return comments;
749 | }
750 | 
751 | export async function debugSnapshot(page) {
752 |   try {
753 |     const path = `snapshot-watch.png`;
754 |     await page.screenshot({ path });
755 |     log.debug("UI:watch", `Zapisano zrzut: ${path}`);
756 |   } catch (e) {
757 |     log.error("UI:watch", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
758 |   }
759 | }
760 | 
```

---

### üìÑ ≈öcie≈ºka: `src/fb/uiCommentInfo.js`
**Typ:** JavaScript/tekst  
**Opis:** Logika Facebook/Puppeteer (UI, komentarze, logowanie).  

```js
  1 | // src/fb/uiCommentInfo.js
  2 | // UI: wykrywanie typu widoku + wyciƒÖganie liczby komentarzy z meta-linii (reakcje | komentarze | udostƒôpnienia)
  3 | // FIX: photo view -> meta row + filtr sklejonych liczb typu "287368".
  4 | // VIDEO/WATCH: komentarze czƒôsto sƒÖ jako: [LICZBA] + [IKONKA], bez tekstu "Komentarz" -> bierzemy z button√≥w z ikonkƒÖ.
  5 | 
  6 | export async function getUiCommentInfo(page) {
  7 |   return page.evaluate(() => {
  8 |     function norm(str) {
  9 |       if (!str) return "";
 10 |       return String(str).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
 11 |     }
 12 | 
 13 |     function detectViewType() {
 14 |       const href = location.href || "";
 15 |       const isWatch = href.includes("/watch");
 16 |       const isVideo = isWatch || /\/videos\/|[?&]v=/i.test(href);
 17 |       const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(href);
 18 | 
 19 |       if (isWatch) return "watch";
 20 |       if (isVideo) return "video";
 21 |       if (isPhoto) return "photo";
 22 |       return "permalink";
 23 |     }
 24 | 
 25 |     function isVisibleRough(el) {
 26 |       if (!el) return false;
 27 |       const st = window.getComputedStyle(el);
 28 |       if (!st) return true;
 29 |       if (st.display === "none" || st.visibility === "hidden") return false;
 30 |       return true;
 31 |     }
 32 | 
 33 |     // pojedynczy token liczbowy (np. "286", "7,8 tys.") ‚Äì odrzuca wieloliczbowe i "x z y"
 34 |     function parseSingleCount(str) {
 35 |       const s = norm(str).toLowerCase();
 36 |       if (!s) return null;
 37 | 
 38 |       // odrzuƒá "x z y"
 39 |       if (/\b\d+\s*z\s*\d+\b/i.test(s)) return null;
 40 | 
 41 |       // je≈õli sƒÖ >=2 grupy cyfr -> odrzucamy (ubija "7,8", "286 368", "1 234")
 42 |       const groups = s.match(/\d+/g);
 43 |       if (groups && groups.length > 1) return null;
 44 | 
 45 |       const m = s.match(/^(\d[\d.,]*)\s*(k|tys|ty≈õ|mln|m)?$/i);
 46 |       if (!m) return null;
 47 | 
 48 |       const raw = m[1];
 49 |       const suf = (m[2] || "").toLowerCase();
 50 | 
 51 |       let value = parseInt(raw.replace(/[^\d]/g, ""), 10);
 52 |       if (!Number.isFinite(value)) return null;
 53 | 
 54 |       if (suf === "k" || suf === "tys" || suf === "ty≈õ") value *= 1000;
 55 |       else if (suf === "mln" || suf === "m") value *= 1000000;
 56 | 
 57 |       return Math.round(value);
 58 |     }
 59 | 
 60 |     function findActionBarRoot() {
 61 |       const candidates = Array.from(document.querySelectorAll("div, section, footer"))
 62 |         .filter(isVisibleRough)
 63 |         .slice(0, 12000);
 64 | 
 65 |       for (const el of candidates) {
 66 |         const t = norm(el.innerText).toLowerCase();
 67 |         if (!t) continue;
 68 | 
 69 |         const hasLike = t.includes("lubiƒô to") || t.includes("like");
 70 |         const hasComment = t.includes("komentarz") || t.includes("comment");
 71 |         const hasShare = t.includes("udostƒôpnij") || t.includes("share");
 72 | 
 73 |         if (hasLike && hasComment && hasShare) {
 74 |           if (t.length > 2200) continue;
 75 |           return el;
 76 |         }
 77 |       }
 78 |       return null;
 79 |     }
 80 | 
 81 |     // usuwa tokeny typu "287368", je≈õli w tym samym zbiorze istniejƒÖ "287" i "368"
 82 |     function dropConcatenations(list) {
 83 |       const strSet = new Set(list.map((x) => String(x.v)));
 84 | 
 85 |       function isConcatOfTwoExisting(vStr) {
 86 |         if (vStr.length < 5) return false;
 87 |         for (let i = 1; i < vStr.length; i++) {
 88 |           const left = vStr.slice(0, i);
 89 |           const right = vStr.slice(i);
 90 |           if (left.length < 2 || right.length < 2) continue;
 91 |           if (strSet.has(left) && strSet.has(right)) return true;
 92 |         }
 93 |         return false;
 94 |       }
 95 | 
 96 |       const out = [];
 97 |       for (const x of list) {
 98 |         const vStr = String(x.v);
 99 |         if (isConcatOfTwoExisting(vStr)) continue;
100 |         out.push(x);
101 |       }
102 |       return out;
103 |     }
104 | 
105 |     function extractFromMetaRow(actionRoot) {
106 |       if (!actionRoot) return { comments: null, shares: null, raw: null };
107 | 
108 |       const badWords = [
109 |         "odpowiedz",
110 |         "wy≈õwietl",
111 |         "zobacz",
112 |         "najtrafniejsze",
113 |         "najnowsze",
114 |         "lider",
115 |         "edytowano",
116 |       ];
117 | 
118 |       const divs = Array.from(actionRoot.querySelectorAll("div"))
119 |         .filter(isVisibleRough)
120 |         .slice(0, 6000);
121 | 
122 |       const scored = [];
123 | 
124 |       for (const d of divs) {
125 |         const text = norm(d.innerText);
126 |         if (!text) continue;
127 | 
128 |         const low = text.toLowerCase();
129 |         const hasReactions = low.includes("wszystkie reakcje") || low.includes("all reactions");
130 |         if (!hasReactions) continue;
131 | 
132 |         if (low.length > 260) continue;
133 |         if (badWords.some((w) => low.includes(w))) continue;
134 | 
135 |         const atoms = Array.from(d.querySelectorAll("span, a, div"))
136 |           .filter(isVisibleRough)
137 |           .map((el) => norm(el.textContent))
138 |           .filter((s) => s && s.length <= 20);
139 | 
140 |         let nums = [];
141 |         for (const s of atoms) {
142 |           const v = parseSingleCount(s);
143 |           if (v == null) continue;
144 |           nums.push({ v, s });
145 |         }
146 | 
147 |         const seen = new Set();
148 |         let uniq = [];
149 |         for (const n of nums) {
150 |           const key = `${n.v}:${n.s}`;
151 |           if (seen.has(key)) continue;
152 |           seen.add(key);
153 |           uniq.push(n);
154 |         }
155 | 
156 |         uniq = dropConcatenations(uniq);
157 | 
158 |         if (uniq.length < 2) continue;
159 | 
160 |         let score = 0;
161 |         score += uniq.length === 2 ? 300 : 0;
162 |         score += Math.max(0, 260 - low.length);
163 | 
164 |         scored.push({ uniq, score, lowLen: low.length });
165 |       }
166 | 
167 |       scored.sort((a, b) => b.score - a.score);
168 |       const best = scored[0];
169 |       if (!best) return { comments: null, shares: null, raw: null };
170 | 
171 |       const comments = best.uniq[0]?.v ?? null;
172 |       const shares = best.uniq[1]?.v ?? null;
173 | 
174 |       const raw = `metaRow len=${best.lowLen} nums=${best.uniq
175 |         .map((x) => `${x.v}:${x.s}`)
176 |         .join(" | ")} -> comments=${comments} shares=${shares}`;
177 | 
178 |       return { comments, shares, raw };
179 |     }
180 | 
181 |     // VIDEO/WATCH: wyciƒÖgnij komentarze z przycisku "liczba + ikonka"
182 |     function extractVideoCommentsFromIconButtons() {
183 |       const btns = Array.from(document.querySelectorAll('[role="button"][tabindex="0"]'))
184 |         .filter(isVisibleRough)
185 |         .slice(0, 12000);
186 | 
187 |       function hasSuffixToken(t) {
188 |         const s = norm(t).toLowerCase();
189 |         return /\b(tys|ty≈õ|k|mln|m)\b/.test(s);
190 |       }
191 | 
192 |       const candidates = [];
193 | 
194 |       for (const b of btns) {
195 |         // wariant 1: ikona jako <i data-visualcompletion="css-img">
196 |         const iconI = b.querySelector('i[data-visualcompletion="css-img"]');
197 |         // wariant 2 (na przysz≈Ço≈õƒá): ikona jako svg
198 |         const iconSvg = b.querySelector("svg");
199 | 
200 |         if (!iconI && !iconSvg) continue;
201 | 
202 |         const toks = Array.from(b.querySelectorAll("span, a, div"))
203 |           .filter(isVisibleRough)
204 |           .map((el) => norm(el.textContent))
205 |           .filter((t) => t && t.length <= 20);
206 | 
207 |         if (!toks.length) continue;
208 | 
209 |         // odetnij tys/mln (np. 496 tys.)
210 |         if (toks.some(hasSuffixToken)) continue;
211 | 
212 |         // szukamy czystej liczby (np. 127)
213 |         let value = null;
214 |         let rawToken = null;
215 | 
216 |         for (const t of toks) {
217 |           if (!/^\d[\d.,]*$/.test(t)) continue;
218 |           const v = parseSingleCount(t);
219 |           if (v == null) continue;
220 |           value = v;
221 |           rawToken = t;
222 |           break;
223 |         }
224 | 
225 |         if (value == null) continue;
226 | 
227 |         const aria =
228 |           norm(b.getAttribute("aria-label")) +
229 |           " " +
230 |           norm((iconI && iconI.getAttribute && iconI.getAttribute("aria-label")) || "");
231 | 
232 |         const lowAria = aria.toLowerCase();
233 | 
234 |         let score = 0;
235 | 
236 |         // je≈õli gdziekolwiek pada "komentarz/comment" -> z≈Çoto
237 |         if (/\b(comment|comments|komentarz|komentarze)\b/.test(lowAria)) score += 120;
238 | 
239 |         // komentarze raczej nie sƒÖ mikro (1..9) w takim przycisku
240 |         if (value <= 9) score -= 60;
241 | 
242 |         // komentarze czƒôsto sƒÖ 10..5000+ -> lekka premia
243 |         if (value >= 10 && value <= 500000) score += 20;
244 | 
245 |         candidates.push({
246 |           value,
247 |           score,
248 |           raw: `iconBtn token=${rawToken} toks=${toks.join(" | ")} aria=${aria}`.slice(0, 500),
249 |         });
250 |       }
251 | 
252 |       if (!candidates.length) {
253 |         return { comments: null, raw: "videoIconButtons: not-found" };
254 |       }
255 | 
256 |       candidates.sort((a, b) => b.score - a.score || b.value - a.value);
257 |       const best = candidates[0];
258 | 
259 |       return {
260 |         comments: best.value,
261 |         raw: `videoIconButtons best=${best.value} score=${best.score} ${best.raw}`,
262 |       };
263 |     }
264 | 
265 |     // VIDEO/WATCH: fallback ‚Äì pr√≥ba klasycznego "near labels" (u Ciebie)
266 |     function extractNearLabels(actionRoot) {
267 |       const LIKE_WORDS = ["lubiƒô to", "like"];
268 |       const COMMENT_WORDS = ["komentarz", "comment"];
269 |       const SHARE_WORDS = ["udostƒôpnij", "share"];
270 | 
271 |       function hasAny(low, arr) {
272 |         return arr.some((w) => low.includes(w));
273 |       }
274 | 
275 |       function getNodeLabel(el) {
276 |         if (!el) return "";
277 |         const a = norm(el.getAttribute?.("aria-label"));
278 |         if (a) return a;
279 |         return norm(el.textContent);
280 |       }
281 | 
282 |       function findActionRowContainer(startEl) {
283 |         let cur = startEl;
284 |         for (let up = 0; up < 8 && cur; up++) {
285 |           const t = norm(cur.innerText).toLowerCase();
286 |           if (
287 |             t &&
288 |             hasAny(t, LIKE_WORDS) &&
289 |             hasAny(t, COMMENT_WORDS) &&
290 |             hasAny(t, SHARE_WORDS)
291 |           ) {
292 |             return cur;
293 |           }
294 |           cur = cur.parentElement;
295 |         }
296 |         return null;
297 |       }
298 | 
299 |       const scope = document.body;
300 | 
301 |       const clickable = Array.from(scope.querySelectorAll('[role="button"], a, span, div'))
302 |         .filter(isVisibleRough)
303 |         .slice(0, 20000);
304 | 
305 |       const commentNodes = [];
306 |       for (const el of clickable) {
307 |         const low = getNodeLabel(el).toLowerCase();
308 |         if (!low) continue;
309 |         if (hasAny(low, COMMENT_WORDS)) commentNodes.push(el);
310 |       }
311 | 
312 |       const scored = [];
313 |       for (const cn of commentNodes) {
314 |         const row = findActionRowContainer(cn);
315 |         if (!row) continue;
316 | 
317 |         const rowText = norm(row.innerText).toLowerCase();
318 |         if (!rowText) continue;
319 | 
320 |         if (rowText.includes("wszystkie reakcje") || rowText.includes("all reactions")) continue;
321 | 
322 |         const parts = Array.from(row.querySelectorAll("span, a, div, [role='button']"))
323 |           .filter(isVisibleRough)
324 |           .map((n) => getNodeLabel(n))
325 |           .map((s) => norm(s))
326 |           .filter((s) => s && s.length <= 40);
327 | 
328 |         const anyNum = parts.some((s) => parseSingleCount(s) != null);
329 |         if (!anyNum) continue;
330 | 
331 |         let score = 0;
332 |         score += Math.max(0, 600 - rowText.length);
333 |         score += Math.max(0, 120 - parts.length);
334 | 
335 |         scored.push({ row, parts, rowLen: rowText.length, score });
336 |       }
337 | 
338 |       scored.sort((a, b) => b.score - a.score);
339 |       const best = scored[0];
340 | 
341 |       if (!best) {
342 |         return { comments: null, shares: null, raw: "nearLabels: no-action-row-found" };
343 |       }
344 | 
345 |       const tokensLow = best.parts.map((s) => s.toLowerCase());
346 | 
347 |       const idxLike = tokensLow.findIndex((t) => hasAny(t, LIKE_WORDS));
348 |       const idxComment = tokensLow.findIndex((t) => hasAny(t, COMMENT_WORDS));
349 |       const idxShare = tokensLow.findIndex((t) => hasAny(t, SHARE_WORDS));
350 | 
351 |       function scanLeftForNumber(fromIdx) {
352 |         if (fromIdx == null || fromIdx < 0) return null;
353 |         for (let i = fromIdx - 1; i >= 0 && i >= fromIdx - 14; i--) {
354 |           const v = parseSingleCount(best.parts[i]);
355 |           if (v != null) return { v, at: i, token: best.parts[i] };
356 |         }
357 |         return null;
358 |       }
359 | 
360 |       let cPick = scanLeftForNumber(idxComment);
361 |       if (!cPick) cPick = scanLeftForNumber(idxLike);
362 | 
363 |       let sPick = scanLeftForNumber(idxShare);
364 |       if (cPick && sPick && sPick.v === cPick.v) sPick = null;
365 | 
366 |       const raw = `nearLabels[actionRow] len=${best.rowLen} tokens=${best.parts.join(
367 |         " | "
368 |       )} -> idxLike=${idxLike} idxComment=${idxComment} idxShare=${idxShare} | comments=${
369 |         cPick ? `${cPick.v}(${cPick.token})@${cPick.at}` : "null"
370 |       } | shares=${sPick ? `${sPick.v}(${sPick.token})@${sPick.at}` : "null"}`;
371 | 
372 |       return {
373 |         comments: cPick ? cPick.v : null,
374 |         shares: sPick ? sPick.v : null,
375 |         raw,
376 |       };
377 |     }
378 | 
379 |     const viewType = detectViewType();
380 |     const actionRoot = findActionBarRoot();
381 | 
382 |     let meta;
383 | 
384 |     if (viewType === "video" || viewType === "watch") {
385 |       // 1) pr√≥buj najpierw ikonki (to jest Tw√≥j przypadek z 127 / 496 tys.)
386 |       meta = extractVideoCommentsFromIconButtons();
387 | 
388 |       // 2) fallback: near labels (jak w Twoim kodzie)
389 |       if (meta.comments == null) {
390 |         const near = extractNearLabels(actionRoot);
391 |         meta = { comments: near.comments, raw: near.raw };
392 |       }
393 |     } else {
394 |       // photo/permalink stabilne -> nie ruszamy
395 |       meta = extractFromMetaRow(actionRoot);
396 |     }
397 | 
398 |     return {
399 |       source: `ui-${viewType}`,
400 |       viewType,
401 |       comments: meta.comments,
402 |       raw: meta.raw,
403 |     };
404 |   });
405 | }
406 | 
```

---

### üìÑ ≈öcie≈ºka: `src/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | if (process.env.__WATCHER_LOCKED__) {
 2 |   console.error("WATCHER DUPLICATE START ‚Äî EXIT");
 3 |   process.exit(1);
 4 | }
 5 | process.env.__WATCHER_LOCKED__ = "1";
 6 | 
 7 | const __log = console.log;
 8 | console.log = (...args) => {
 9 |   const ts = new Date().toISOString().replace("T"," ").replace("Z","");
10 |   __log(`[${ts}]`, ...args);
11 | };
12 | 
13 | // src/index.js
14 | import "dotenv/config";
15 | import fs from "fs";
16 | import path from "path";
17 | import { startWatcher } from "./watcher.js";
18 | import { sendOwnerAlert } from "./telegram.js";
19 | 
20 | function ensureDir(p) {
21 |   try {
22 |     fs.mkdirSync(p, { recursive: true });
23 |   } catch {}
24 | }
25 | 
26 | // Ustal katalogi serwerowe (≈ºeby nie wali≈Ço w /tmp losowo)
27 | const DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), "data");
28 | const TMP_DIR = process.env.TMP_DIR || path.join(process.cwd(), "tmp");
29 | ensureDir(DATA_DIR);
30 | ensureDir(TMP_DIR);
31 | 
32 | // czas + logi
33 | console.log("[BOOT] NODE_ENV =", process.env.NODE_ENV || "dev");
34 | console.log("[BOOT] TZ =", process.env.TZ || "system");
35 | console.log("[BOOT] DATA_DIR =", DATA_DIR);
36 | console.log("[BOOT] TMP_DIR =", TMP_DIR);
37 | console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);
38 | 
39 | // helper
40 | function safeToString(x) {
41 |   try {
42 |     if (x instanceof Error) return `${x.message}\n${x.stack || ""}`;
43 |     if (typeof x === "string") return x;
44 |     return JSON.stringify(x, null, 2);
45 |   } catch {
46 |     return String(x);
47 |   }
48 | }
49 | 
50 | // anti-loop
51 | let _inAlert = false;
52 | function fireAlert(title, message) {
53 |   if (_inAlert) return;
54 |   _inAlert = true;
55 |   sendOwnerAlert(title, message).catch(() => {}).finally(() => (_inAlert = false));
56 | }
57 | 
58 | // HOOKI na b≈Çƒôdy (muszƒÖ byƒá przed startWatcher)
59 | const _origErr = console.error.bind(console);
60 | console.error = (...args) => {
61 |   _origErr(...args);
62 |   fireAlert("console.error", args.map(safeToString).join(" "));
63 | };
64 | 
65 | process.on("unhandledRejection", (reason) => {
66 |   _origErr("[unhandledRejection]", reason);
67 |   fireAlert("unhandledRejection", safeToString(reason));
68 | });
69 | 
70 | process.on("uncaughtException", (err) => {
71 |   _origErr("[uncaughtException]", err);
72 |   fireAlert("uncaughtException", safeToString(err));
73 |   // Daj czas na wys≈Çanie alertu, potem exit (PM2 zrestartuje)
74 |   setTimeout(() => process.exit(1), 3000);
75 | });
76 | 
77 | // ping ‚Äú≈ºyjƒô‚Äù
78 | sendOwnerAlert("ALERTS ONLINE", `FB_Watcher start: ${new Date().toISOString()}`)
79 |   .then(() => console.log("[ALERTS] startup ping sent"))
80 |   .catch(() => console.log("[ALERTS] startup ping failed (ignored)"));
81 | 
82 | startWatcher().catch((err) => {
83 |   console.error("Fatal error:", err);
84 |   process.exit(1);
85 | });
86 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/api.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
  1 | // panel/api.js
  2 | import http from "http";
  3 | import { exec } from "child_process";
  4 | import fs from "fs";
  5 | import path from "path";
  6 | import crypto from "crypto";
  7 | import dotenv from "dotenv";
  8 | 
  9 | // ---- BASE DIR (dev vs exe) ----
 10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 11 | 
 12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 15 | 
 16 | // UI: dev -> src/panel/ui, exe -> ./ui
 17 | const UI_DIR = process.pkg
 18 |   ? path.join(BASE_DIR, "ui")
 19 |   : path.join(BASE_DIR, "src", "panel", "ui");
 20 | 
 21 | // New React UI: dev -> src/panel/web/dist, exe -> ./web
 22 | const NEW_UI_DIR = process.pkg
 23 |   ? path.join(BASE_DIR, "web")
 24 |   : path.join(BASE_DIR, "src", "panel", "web", "dist");
 25 | 
 26 | const PORT = Number(process.env.PANEL_PORT || 3180);
 27 | const TOKEN = process.env.PANEL_TOKEN;
 28 | 
 29 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 30 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 31 | 
 32 | // ---- CACHE (performance) ----
 33 | let cachedProjectDir = null;
 34 | let cachedNodeVersion = null;
 35 | let cachedPm2Version = null;
 36 | let cachedLogPaths = null;
 37 | 
 38 | if (!TOKEN) {
 39 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 40 |   process.exit(1);
 41 | }
 42 | 
 43 | function auth(req, res) {
 44 |   const h = req.headers["authorization"] || "";
 45 |   if (h !== `Bearer ${TOKEN}`) {
 46 |     res.writeHead(401);
 47 |     res.end("Unauthorized");
 48 |     return false;
 49 |   }
 50 |   return true;
 51 | }
 52 | 
 53 | function json(res, obj, code = 200) {
 54 |   res.writeHead(code, { "Content-Type": "application/json" });
 55 |   res.end(JSON.stringify(obj, null, 2));
 56 | }
 57 | 
 58 | function sh(cmd) {
 59 |   return new Promise((resolve) => {
 60 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 61 |       resolve({
 62 |         ok: !err,
 63 |         stdout: (stdout || "").trim(),
 64 |         stderr: (stderr || "").trim(),
 65 |         code: err?.code ?? 0,
 66 |       });
 67 |     });
 68 |   });
 69 | }
 70 | 
 71 | 
 72 | async function getProjectDir() {
 73 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 74 |   if (cachedProjectDir) return cachedProjectDir;
 75 | 
 76 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 77 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 78 |   if (!m)
 79 |     throw new Error(
 80 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 81 |     );
 82 |   cachedProjectDir = m[1].trim();
 83 |   return cachedProjectDir;
 84 | }
 85 | 
 86 | function readBody(req) {
 87 |   return new Promise((resolve) => {
 88 |     let d = "";
 89 |     req.on("data", (c) => (d += c));
 90 |     req.on("end", () => resolve(d));
 91 |   });
 92 | }
 93 | 
 94 | function safeJsonParse(s) {
 95 |   try {
 96 |     return { ok: true, value: JSON.parse(s) };
 97 |   } catch (e) {
 98 |     return { ok: false, error: e?.message || "Invalid JSON" };
 99 |   }
100 | }
101 | 
102 | function ensureDir(p) {
103 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
104 | }
105 | 
106 | function atomicWriteFile(filePath, content) {
107 |   const dir = path.dirname(filePath);
108 |   ensureDir(dir);
109 | 
110 |   const tmp = path.join(
111 |     dir,
112 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
113 |   );
114 |   fs.writeFileSync(tmp, content, "utf8");
115 |   fs.renameSync(tmp, filePath);
116 | }
117 | 
118 | function normalizeUrl(u) {
119 |   if (!u) return "";
120 |   const x = String(u).trim();
121 |   if (!/^https?:\/\/.+/i.test(x)) return "";
122 |   return x;
123 | }
124 | 
125 | function normalizeOptionalUrl(u) {
126 |   if (!u) return "";
127 |   const x = String(u).trim();
128 |   if (x === "") return "";
129 |   if (!/^https?:\/\/.+/i.test(x)) return "";
130 |   return x;
131 | }
132 | 
133 | function nowIso() {
134 |   return new Date().toISOString();
135 | }
136 | 
137 | function stripAnsi(str) {
138 |   return (str || "").replace(/\x1b\[[0-9;]*m/g, "");
139 | }
140 | 
141 | function setEnvKey(envText, key, value) {
142 |   const re = new RegExp(`^${key}=.*$`, "m");
143 |   const line = `${key}=${value}`;
144 |   if (re.test(envText)) return envText.replace(re, line);
145 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
146 | }
147 | 
148 | function pickPostsFile(projectDir) {
149 |   return path.join(projectDir, "data", "posts.json");
150 | }
151 | 
152 | function readPosts(postsPath) {
153 |   if (!fs.existsSync(postsPath)) return [];
154 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
155 |   if (!raw) return [];
156 |   const parsed = safeJsonParse(raw);
157 |   if (!parsed.ok || !Array.isArray(parsed.value))
158 |     throw new Error("posts.json invalid (expected array)");
159 |   return parsed.value;
160 | }
161 | 
162 | function writePosts(postsPath, posts) {
163 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
164 | }
165 | 
166 | function genId() {
167 |   return crypto.randomBytes(8).toString("hex");
168 | }
169 | 
170 | function route(req) {
171 |   const url = new URL(req.url, "http://localhost");
172 |   const pathname = url.pathname;
173 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
174 | }
175 | 
176 | function match(pathname, pattern) {
177 |   const a = pathname.split("/").filter(Boolean);
178 |   const b = pattern.split("/").filter(Boolean);
179 |   if (a.length !== b.length) return null;
180 |   const params = {};
181 |   for (let i = 0; i < a.length; i++) {
182 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
183 |     else if (a[i] !== b[i]) return null;
184 |   }
185 |   return params;
186 | }
187 | 
188 | // ---------- LOGS (dynamic from pm2 describe) ----------
189 | function parsePm2LogPaths(pm2DescribeText) {
190 |   const out =
191 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
192 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
193 |     "";
194 |   const err =
195 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
196 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
197 |     "";
198 |   return { out, err };
199 | }
200 | 
201 | async function getPm2LogPaths(appName) {
202 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
203 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
204 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
205 | 
206 |   if (cachedLogPaths) return cachedLogPaths;
207 | 
208 |   const d = await sh(`pm2 describe ${appName}`);
209 |   if (!d.ok)
210 |     return {
211 |       out: "",
212 |       err: "",
213 |       source: "pm2_error",
214 |       pm2: d.stderr || d.stdout || "",
215 |     };
216 | 
217 |   const p = parsePm2LogPaths(d.stdout);
218 |   cachedLogPaths = { out: p.out || "", err: p.err || "", source: "pm2_describe" };
219 |   return cachedLogPaths;
220 | }
221 | 
222 | async function readTailLog(filePath, lines) {
223 |   try {
224 |     if (!filePath) {
225 |       return {
226 |         ok: false,
227 |         error:
228 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
229 |         path: filePath,
230 |       };
231 |     }
232 | 
233 |     if (!fs.existsSync(filePath)) {
234 |       return {
235 |         ok: false,
236 |         error:
237 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
238 |         path: filePath,
239 |       };
240 |     }
241 | 
242 |     const st = fs.statSync(filePath);
243 |     if (!st || !st.isFile()) {
244 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
245 |     }
246 | 
247 |     if (st.size === 0) {
248 |       return {
249 |         ok: false,
250 |         error:
251 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
252 |         path: filePath,
253 |       };
254 |     }
255 | 
256 |     // Use tail command on Linux (fast, doesn't load entire file into memory)
257 |     const tailResult = await sh(`tail -n ${lines} "${filePath}"`);
258 |     if (tailResult.ok && tailResult.stdout) {
259 |       const txt = (tailResult.stdout || "").trim();
260 |       if (txt) {
261 |         return { ok: true, log: tailResult.stdout, path: filePath, via: "tail" };
262 |       }
263 |     }
264 | 
265 |     // Fallback: read last portion of file (max 512KB) for large files
266 |     const MAX_READ = 512 * 1024;
267 |     if (st.size > MAX_READ) {
268 |       const fd = fs.openSync(filePath, "r");
269 |       const buffer = Buffer.alloc(MAX_READ);
270 |       fs.readSync(fd, buffer, 0, MAX_READ, st.size - MAX_READ);
271 |       fs.closeSync(fd);
272 |       const raw = buffer.toString("utf8");
273 |       const arr = raw.split(/\r?\n/);
274 |       // Skip first line (might be partial)
275 |       const slice = arr.slice(Math.max(1, arr.length - lines)).join("\n");
276 |       const txt = (slice || "").trim();
277 |       if (txt) {
278 |         return { ok: true, log: slice, path: filePath, via: "partial" };
279 |       }
280 |     }
281 | 
282 |     // Small files: read entirely
283 |     const raw = fs.readFileSync(filePath, "utf8");
284 |     const arr = raw.split(/\r?\n/);
285 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
286 |     const txt = (slice || "").trim();
287 | 
288 |     if (!txt) {
289 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
290 |     }
291 | 
292 |     return { ok: true, log: slice, path: filePath, via: "js" };
293 |   } catch (e) {
294 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
295 |   }
296 | }
297 | 
298 | http
299 |   .createServer(async (req, res) => {
300 |     const { pathname, query } = route(req);
301 |     if (req.method === "GET" && pathname === "/ping") {
302 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
303 |   res.end("pong");
304 |   return;
305 | }
306 | 
307 | 
308 |     // ---------- NEW REACT UI (/new/) ----------
309 |     if (req.method === "GET" && pathname.startsWith("/new")) {
310 |       const MIME_TYPES = {
311 |         ".html": "text/html",
312 |         ".js": "application/javascript",
313 |         ".css": "text/css",
314 |         ".json": "application/json",
315 |         ".png": "image/png",
316 |         ".jpg": "image/jpeg",
317 |         ".svg": "image/svg+xml",
318 |         ".ico": "image/x-icon",
319 |         ".woff": "font/woff",
320 |         ".woff2": "font/woff2",
321 |       };
322 | 
323 |       // Remove /new prefix
324 |       let filePath = pathname.replace(/^\/new\/?/, "") || "index.html";
325 | 
326 |       // Try to serve the file
327 |       let fullPath = path.join(NEW_UI_DIR, filePath);
328 | 
329 |       // If file doesn't exist and it's not a static asset, serve index.html (SPA fallback)
330 |       if (!fs.existsSync(fullPath) || fs.statSync(fullPath).isDirectory()) {
331 |         const ext = path.extname(filePath);
332 |         if (!ext || ext === ".html") {
333 |           fullPath = path.join(NEW_UI_DIR, "index.html");
334 |         }
335 |       }
336 | 
337 |       if (fs.existsSync(fullPath) && fs.statSync(fullPath).isFile()) {
338 |         const ext = path.extname(fullPath);
339 |         const contentType = MIME_TYPES[ext] || "application/octet-stream";
340 |         const content = fs.readFileSync(fullPath);
341 |         res.writeHead(200, { "Content-Type": `${contentType}; charset=utf-8` });
342 |         res.end(content);
343 |         return;
344 |       }
345 |     }
346 | 
347 |     // ---------- PUBLIC UI (legacy) ----------
348 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
349 |       const p = path.join(UI_DIR, "index.html");
350 |       const html = fs.readFileSync(p, "utf8");
351 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
352 |       res.end(html);
353 |       return;
354 |     }
355 | 
356 |     if (req.method === "GET" && pathname === "/app.js") {
357 |       const p = path.join(UI_DIR, "app.js");
358 |       const js = fs.readFileSync(p, "utf8");
359 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
360 |       res.end(js);
361 |       return;
362 |     }
363 | 
364 |     // ---------- AUTH for API ----------
365 |     if (pathname.startsWith("/api/")) {
366 |       if (!auth(req, res)) return;
367 |     }
368 | 
369 |     try {
370 |       const PROJECT_DIR = await getProjectDir();
371 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
372 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
373 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
374 | 
375 |       // ===== STATUS =====
376 |       if (req.method === "GET" && pathname === "/api/status") {
377 |         // Cache node/pm2 versions (don't change during runtime)
378 |         if (!cachedNodeVersion) {
379 |           const node = await sh("node -v");
380 |           cachedNodeVersion = node.stdout;
381 |         }
382 |         if (!cachedPm2Version) {
383 |           const pm2v = await sh("pm2 -v");
384 |           cachedPm2Version = pm2v.stdout;
385 |         }
386 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
387 |         json(res, {
388 |           ok: true,
389 |           projectDir: PROJECT_DIR,
390 |           envPath: ENV_PATH,
391 |           cookiesPath: COOKIES_PATH,
392 |           postsPath: POSTS_PATH,
393 |           node: cachedNodeVersion,
394 |           pm2: cachedPm2Version,
395 |           pm2Status: stripAnsi(pm2s.stdout),
396 |           time: nowIso(),
397 |         });
398 |         return;
399 |       }
400 | 
401 |       // ===== ENV GET (selected keys) =====
402 |       if (req.method === "GET" && pathname === "/api/env/get") {
403 |         if (!fs.existsSync(ENV_PATH)) {
404 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
405 |           return;
406 |         }
407 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
408 |         const wanted = [
409 |           // Facebook
410 |           "FB_EMAIL",
411 |           "FB_PASSWORD",
412 |           // Watcher
413 |           "CHECK_INTERVAL_MS",
414 |           "FAST_MODE",
415 |           "INCLUDE_REPLIES",
416 |           // Logi
417 |           "LOG_LEVEL",
418 |           // Puppeteer
419 |           "HEADLESS_BROWSER",
420 |           "USE_UI_HANDLERS",
421 |           "COOKIES_READ_ONLY",
422 |           // ≈πr√≥d≈Ça post√≥w
423 |           "POSTS_SHEET_URL",
424 |           "POSTS_API_URL",
425 |           "POSTS_API_TOKEN",
426 |           // Telegram Owner
427 |           "TELEGRAM_SEND_TO_OWNER",
428 |           "TELEGRAM_BOT_TOKEN_OWNER",
429 |           "TELEGRAM_CHAT_ID_OWNER",
430 |           // Telegram Client
431 |           "TELEGRAM_SEND_TO_CLIENT",
432 |           "TELEGRAM_BOT_TOKEN_CLIENT",
433 |           "TELEGRAM_CHAT_ID_CLIENT",
434 |           // Telegram Format
435 |           "TELEGRAM_USE_PHOTO",
436 |           "TELEGRAM_DISABLE_WEB_PAGE_PREVIEW",
437 |           // Telegram Alerty
438 |           "TG_ALERTS_ENABLED",
439 |           "TG_ALERTS_COOLDOWN_SEC",
440 |           "TG_ALERTS_MAXLEN",
441 |           // Legacy
442 |           "WEBHOOK_URL",
443 |         ];
444 |         const values = {};
445 |         for (const k of wanted) {
446 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
447 |           values[k] = m ? m[1] : "";
448 |         }
449 |         json(res, { ok: true, values });
450 |         return;
451 |       }
452 | 
453 |       // ===== ENV SET MULTIPLE =====
454 |       if (req.method === "POST" && pathname === "/api/env/set") {
455 |         const bodyRaw = await readBody(req);
456 |         const parsed = safeJsonParse(bodyRaw || "{}");
457 |         if (!parsed.ok) {
458 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
459 |           return;
460 |         }
461 | 
462 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
463 |         const restart = Boolean(parsed.value.restart);
464 | 
465 |         if (!set) {
466 |           json(res, { ok: false, error: "Missing set object" }, 400);
467 |           return;
468 |         }
469 |         if (!fs.existsSync(ENV_PATH)) {
470 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
471 |           return;
472 |         }
473 | 
474 |         let env = fs.readFileSync(ENV_PATH, "utf8");
475 |         const updated = [];
476 | 
477 |         for (const [k, v] of Object.entries(set)) {
478 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
479 |           env = setEnvKey(env, k, String(v));
480 |           updated.push(k);
481 |         }
482 | 
483 |         atomicWriteFile(ENV_PATH, env);
484 | 
485 |         let pm2Action = null;
486 |         if (restart) {
487 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
488 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
489 |         }
490 | 
491 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
492 |         return;
493 |       }
494 | 
495 |       // ===== POSTS: LIST =====
496 |       if (req.method === "GET" && pathname === "/api/posts") {
497 |         const posts = readPosts(POSTS_PATH);
498 | 
499 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
500 |         const norm = (posts || []).map((p) => ({
501 |           id: String(p.id || "").trim(),
502 |           url: String(p.url || "").trim(),
503 |           active: p.active !== undefined ? Boolean(p.active) : true,
504 |           name: String(p.name || "").trim(),
505 |           image: String(p.image || "").trim(),
506 |           description: String(p.description || "").trim(),
507 |           createdAt: p.createdAt || "",
508 |           updatedAt: p.updatedAt || "",
509 |         }));
510 | 
511 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
512 |         json(res, { ok: true, posts: norm });
513 |         return;
514 |       }
515 | 
516 |       // ===== POSTS: ADD =====
517 |       if (req.method === "POST" && pathname === "/api/posts") {
518 |         const bodyRaw = await readBody(req);
519 |         const parsed = safeJsonParse(bodyRaw || "{}");
520 |         if (!parsed.ok) {
521 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
522 |           return;
523 |         }
524 | 
525 |         const url = normalizeUrl(parsed.value.url);
526 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
527 | 
528 |         const name = String(parsed.value.name || "").trim();
529 |         const imageRaw = String(parsed.value.image || "").trim();
530 |         const image = normalizeOptionalUrl(imageRaw);
531 |         const description = String(parsed.value.description || "").trim();
532 | 
533 |         if (!url) {
534 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
535 |           return;
536 |         }
537 |         if (imageRaw !== "" && !image) {
538 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
539 |           return;
540 |         }
541 | 
542 |         const posts = readPosts(POSTS_PATH);
543 |         const existing = posts.find((p) => p.url === url);
544 |         if (existing) {
545 |           existing.active = active;
546 |           existing.name = name;
547 |           existing.image = image;
548 |           existing.description = description;
549 |           existing.updatedAt = nowIso();
550 |           writePosts(POSTS_PATH, posts);
551 |           json(res, { ok: true, post: existing, deduped: true });
552 |           return;
553 |         }
554 | 
555 |         const post = {
556 |           id: genId(),
557 |           url,
558 |           active,
559 |           name,
560 |           image,
561 |           description,
562 |           createdAt: nowIso(),
563 |           updatedAt: nowIso(),
564 |         };
565 |         posts.push(post);
566 |         writePosts(POSTS_PATH, posts);
567 | 
568 |         json(res, { ok: true, post });
569 |         return;
570 |       }
571 | 
572 |       // ===== POSTS: PATCH =====
573 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
574 |       if (mPatch) {
575 |         const id = mPatch.id;
576 |         const bodyRaw = await readBody(req);
577 |         const parsed = safeJsonParse(bodyRaw || "{}");
578 |         if (!parsed.ok) {
579 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
580 |           return;
581 |         }
582 | 
583 |         const posts = readPosts(POSTS_PATH);
584 |         const post = posts.find((p) => p.id === id);
585 |         if (!post) {
586 |           json(res, { ok: false, error: "Post not found" }, 404);
587 |           return;
588 |         }
589 | 
590 |         if (parsed.value.url !== undefined) {
591 |           const nextUrl = normalizeUrl(parsed.value.url);
592 |           if (!nextUrl) {
593 |             json(res, { ok: false, error: "Invalid url" }, 400);
594 |             return;
595 |           }
596 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
597 |           if (dup) {
598 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
599 |             return;
600 |           }
601 |           post.url = nextUrl;
602 |         }
603 | 
604 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
605 | 
606 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
607 | 
608 |         if (parsed.value.image !== undefined) {
609 |           const raw = String(parsed.value.image || "").trim();
610 |           const img = normalizeOptionalUrl(raw);
611 |           if (raw !== "" && !img) {
612 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
613 |             return;
614 |           }
615 |           post.image = img;
616 |         }
617 | 
618 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
619 | 
620 |         post.updatedAt = nowIso();
621 |         writePosts(POSTS_PATH, posts);
622 |         json(res, { ok: true, post });
623 |         return;
624 |       }
625 | 
626 |       // ===== POSTS: DELETE =====
627 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
628 |       if (mDel) {
629 |         const id = mDel.id;
630 |         const posts = readPosts(POSTS_PATH);
631 |         const idx = posts.findIndex((p) => p.id === id);
632 |         if (idx === -1) {
633 |           json(res, { ok: false, error: "Post not found" }, 404);
634 |           return;
635 |         }
636 |         const removed = posts.splice(idx, 1)[0];
637 |         writePosts(POSTS_PATH, posts);
638 |         json(res, { ok: true, removed });
639 |         return;
640 |       }
641 | 
642 |       // ===== COOKIES: CLEAR =====
643 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
644 |         const bodyRaw = await readBody(req);
645 |         const parsed = safeJsonParse(bodyRaw || "{}");
646 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
647 | 
648 |         if (!confirm) {
649 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
650 |           return;
651 |         }
652 | 
653 |         atomicWriteFile(COOKIES_PATH, "[]\n");
654 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
655 |         return;
656 |       }
657 | 
658 |       // ===== PM2 =====
659 |       function okOrErr(r, fallbackErr = "Command failed") {
660 |         if (r.ok) return { ok: true, output: stripAnsi(r.stdout || r.stderr || "") };
661 |         return { ok: false, error: stripAnsi(r.stderr || r.stdout || fallbackErr) };
662 |       }
663 |       async function pm2Describe(name) {
664 |         return await sh(`pm2 describe ${name}`);
665 |       }
666 | 
667 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
668 |       const WATCH_NAME = PM2_APP || "fbwatcher";
669 | 
670 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
671 |         const d = await pm2Describe(WATCH_NAME);
672 |         if (d.ok) {
673 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
674 |           json(res, okOrErr(r, "PM2 start failed"));
675 |           return;
676 |         }
677 | 
678 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
679 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
680 |         return;
681 |       }
682 | 
683 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
684 |         const d = await pm2Describe(WATCH_NAME);
685 |         if (!d.ok) {
686 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
687 |           return;
688 |         }
689 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
690 |         json(res, okOrErr(r, "PM2 restart failed"));
691 |         return;
692 |       }
693 | 
694 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
695 |         const d = await pm2Describe(WATCH_NAME);
696 |         if (!d.ok) {
697 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
698 |           return;
699 |         }
700 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
701 |         json(res, okOrErr(r, "PM2 stop failed"));
702 |         return;
703 |       }
704 | 
705 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
706 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
707 |         json(res, okOrErr(r, "PM2 status failed"));
708 |         return;
709 |       }
710 | 
711 |       // ===== LOGS INFO (debug) =====
712 |       if (req.method === "GET" && pathname === "/api/logs/info") {
713 |         const paths = await getPm2LogPaths(PM2_APP);
714 |         json(res, { ok: true, app: PM2_APP, ...paths });
715 |         return;
716 |       }
717 | 
718 |       // ===== LOGS =====
719 |       if (req.method === "GET" && pathname === "/api/logs/out") {
720 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
721 |         const paths = await getPm2LogPaths(PM2_APP);
722 |         const payload = await readTailLog(paths.out, lines);
723 |         json(res, { ...payload, source: paths.source });
724 |         return;
725 |       }
726 | 
727 |       if (req.method === "GET" && pathname === "/api/logs/err") {
728 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
729 |         const paths = await getPm2LogPaths(PM2_APP);
730 |         const payload = await readTailLog(paths.err, lines);
731 |         json(res, { ...payload, source: paths.source });
732 |         return;
733 |       }
734 | 
735 |       // ===== COOKIES: STATUS =====
736 |       if (req.method === "GET" && pathname === "/api/cookies/status") {
737 |         const mainExists = fs.existsSync(COOKIES_PATH);
738 |         let mainAge = undefined;
739 |         let mainSize = undefined;
740 | 
741 |         if (mainExists) {
742 |           const stat = fs.statSync(COOKIES_PATH);
743 |           mainSize = stat.size;
744 |           mainAge = (Date.now() - stat.mtimeMs) / (1000 * 60 * 60); // hours
745 |         }
746 | 
747 |         json(res, {
748 |           ok: true,
749 |           mainCookiesExists: mainExists,
750 |           mainCookiesAge: mainAge,
751 |           mainCookiesSize: mainSize,
752 |           isLoggedIn: mainExists && mainSize > 10,
753 |         });
754 |         return;
755 |       }
756 | 
757 |       json(res, { ok: false, error: "Not found" }, 404);
758 |     } catch (e) {
759 |       json(res, { ok: false, error: e.message }, 500);
760 |     }
761 |   })
762 |   .listen(PORT, "0.0.0.0", () => {
763 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
764 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
765 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
766 |   });
767 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/panel-entry.cjs`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
1 | // src/panel/panel-entry.cjs
2 | require("./api.js");
3 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/ui/app.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
  1 | (() => {
  2 |   const $ = (id) => document.getElementById(id);
  3 | 
  4 |   // ---------- state ----------
  5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
  6 |   let logAutoTimer = null;
  7 |   let lastLogMode = "out"; // 'out' | 'err'
  8 |   let logsExpanded = false;
  9 | 
 10 |   // modal state
 11 |   let modalResolve = null;
 12 | 
 13 |   // edit modal state
 14 |   let editResolve = null;
 15 | 
 16 |   // ---------- ui refs ----------
 17 |   const elToken = $("token");
 18 |   const btnSaveToken = $("saveToken");
 19 |   const btnRefresh = $("refresh");
 20 |   const elStatus = $("status");
 21 | 
 22 |   const btnSaveEnv = $("saveEnv");
 23 |   const btnPm2Start = $("pm2Start");
 24 |   const btnPm2Stop = $("pm2Stop");
 25 |   const btnPm2Restart = $("pm2Restart");
 26 |   const btnClearCookies = $("clearCookies");
 27 |   const elEnvMsg = $("envMsg");
 28 | 
 29 |   const elNewPostUrl = $("newPostUrl");
 30 |   const elNewPostName = $("newPostName");
 31 |   const elNewPostImage = $("newPostImage");
 32 |   const elNewPostActive = $("newPostActive");
 33 |   const btnAddPost = $("addPost");
 34 |   const elPostsTbody = $("posts");
 35 | 
 36 |   const btnLoadOut = $("loadOut");
 37 |   const btnLoadErr = $("loadErr");
 38 |   const elLogLines = $("logLines");
 39 |   const elLogAutoEvery = $("logAutoEvery");
 40 |   const btnLogAutoToggle = $("logAutoToggle");
 41 |   const elLogAutoScroll = $("logAutoScroll");
 42 |   const elLogs = $("logs");
 43 |   const elLogHint = $("logHint");
 44 | 
 45 |   const logsCard = $("logsCard");
 46 |   const btnToggleLogsSize = $("toggleLogsSize");
 47 | 
 48 |   // modal refs (delete + generic)
 49 |   const modalOverlay = $("modalOverlay");
 50 |   const modalBody = $("modalBody");
 51 |   const modalCancel = $("modalCancel");
 52 |   const modalOk = $("modalOk");
 53 | 
 54 |   // env fields
 55 |   const ENV_FIELDS = [
 56 |     "FB_EMAIL",
 57 |     "FB_PASSWORD",
 58 |     "WEBHOOK_URL",
 59 |     "CHECK_INTERVAL_MS",
 60 |     "POSTS_SHEET_URL",
 61 |     "HEADLESS_BROWSER",
 62 |     "USE_UI_HANDLERS",
 63 |     "INCLUDE_REPLIES",
 64 |   ];
 65 | 
 66 |   function setHint(el, msg, ok = true) {
 67 |     if (!el) return;
 68 |     el.textContent = msg || "";
 69 |     el.classList.remove("ok", "err");
 70 |     el.classList.add(ok ? "ok" : "err");
 71 |   }
 72 | 
 73 |   function fmtTime() {
 74 |     try {
 75 |       return new Date().toLocaleString();
 76 |     } catch {
 77 |       return "";
 78 |     }
 79 |   }
 80 | 
 81 |   function getAuthHeaders() {
 82 |     const t = (token || "").trim();
 83 |     return t ? { Authorization: `Bearer ${t}` } : {};
 84 |   }
 85 | 
 86 |   async function api(path, opts = {}) {
 87 |     const headers = {
 88 |       ...(opts.headers || {}),
 89 |       ...getAuthHeaders(),
 90 |     };
 91 | 
 92 |     let body = opts.body;
 93 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
 94 |       headers["Content-Type"] = "application/json";
 95 |       body = JSON.stringify(body);
 96 |     }
 97 | 
 98 |     const res = await fetch(path, {
 99 |       method: opts.method || "GET",
100 |       headers,
101 |       body,
102 |     });
103 | 
104 |     const text = await res.text();
105 |     let data = null;
106 |     try {
107 |       data = JSON.parse(text);
108 |     } catch {
109 |       data = { ok: false, error: text || `HTTP ${res.status}` };
110 |     }
111 | 
112 |     if (!res.ok) {
113 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
114 |     }
115 |     return data;
116 |   }
117 | 
118 |   // ---------- modal ----------
119 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
120 |     return new Promise((resolve) => {
121 |       modalResolve = resolve;
122 | 
123 |       $("modalTitle").textContent = title;
124 |       modalBody.innerHTML = body;
125 | 
126 |       modalOk.textContent = okText;
127 |       modalOk.classList.toggle("danger", !!danger);
128 | 
129 |       modalOverlay.classList.add("show");
130 |       modalOverlay.setAttribute("aria-hidden", "false");
131 | 
132 |       setTimeout(() => {
133 |         (danger ? modalOk : modalCancel).focus();
134 |       }, 0);
135 |     });
136 |   }
137 | 
138 |   function closeModal(result) {
139 |     modalOverlay.classList.remove("show");
140 |     modalOverlay.setAttribute("aria-hidden", "true");
141 |     const r = modalResolve;
142 |     modalResolve = null;
143 |     if (typeof r === "function") r(result);
144 |   }
145 | 
146 |   modalCancel.addEventListener("click", () => closeModal(false));
147 |   modalOk.addEventListener("click", () => closeModal(true));
148 |   modalOverlay.addEventListener("click", (e) => {
149 |     if (e.target === modalOverlay) closeModal(false);
150 |   });
151 |   window.addEventListener("keydown", (e) => {
152 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
153 |   });
154 | 
155 |   // ---------- core actions ----------
156 |   async function loadStatus() {
157 |     setHint(elStatus, "≈Åadowanie statusu...", true);
158 | 
159 |     const r = await api("/api/status");
160 |     if (!r.ok) {
161 |       setHint(
162 |         elStatus,
163 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
164 |         false
165 |       );
166 |       return null;
167 |     }
168 | 
169 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
170 |     return r;
171 |   }
172 | 
173 |   async function loadEnv() {
174 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
175 |     const r = await api("/api/env/get");
176 |     if (!r.ok) {
177 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
178 |       return;
179 |     }
180 |     const v = r.values || {};
181 |     for (const k of ENV_FIELDS) {
182 |       const el = $(k);
183 |       if (!el) continue;
184 |       el.value = (v[k] ?? "").toString();
185 |     }
186 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
187 |   }
188 | 
189 |   async function saveEnv(restart = false) {
190 |     const set = {};
191 |     for (const k of ENV_FIELDS) {
192 |       const el = $(k);
193 |       if (!el) continue;
194 |       set[k] = (el.value ?? "").toString();
195 |     }
196 | 
197 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
198 | 
199 |     const r = await api("/api/env/set", {
200 |       method: "POST",
201 |       body: { set, restart },
202 |     });
203 | 
204 |     if (!r.ok) {
205 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
206 |       return;
207 |     }
208 | 
209 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
210 |   }
211 | 
212 |   function copyIconSvg() {
213 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
214 |     return `
215 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
216 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
217 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
218 |       </svg>
219 |     `;
220 |   }
221 | 
222 |   async function loadPosts() {
223 |     const r = await api("/api/posts");
224 |     if (!r.ok) {
225 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
226 |       return;
227 |     }
228 | 
229 |     const posts = Array.isArray(r.posts) ? r.posts : [];
230 |     elPostsTbody.innerHTML = "";
231 | 
232 |     for (const p of posts) {
233 |       const tr = document.createElement("tr");
234 | 
235 |       const tdId = document.createElement("td");
236 |       tdId.className = "mono col-id";
237 |       tdId.textContent = p.id || "";
238 |       tr.appendChild(tdId);
239 | 
240 |       // LINK + IKONKA KOPIUJ PRZY LINKU
241 |       const tdUrl = document.createElement("td");
242 |       tdUrl.className = "col-url";
243 | 
244 |       if (p.url) {
245 |         const wrap = document.createElement("div");
246 |         wrap.className = "urlWrap";
247 | 
248 |         const a = document.createElement("a");
249 |         a.href = p.url;
250 |         a.target = "_blank";
251 |         a.rel = "noopener noreferrer";
252 |         a.textContent = p.url;
253 | 
254 |         const btnCopyIcon = document.createElement("button");
255 |         btnCopyIcon.className = "iconBtn";
256 |         btnCopyIcon.type = "button";
257 |         btnCopyIcon.title = "Kopiuj link";
258 |         btnCopyIcon.innerHTML = copyIconSvg();
259 | 
260 |         btnCopyIcon.addEventListener("click", async (e) => {
261 |           e.preventDefault();
262 |           e.stopPropagation();
263 | 
264 |           const ok = await copyToClipboard(p.url);
265 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
266 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
267 |         });
268 | 
269 |         wrap.appendChild(a);
270 |         wrap.appendChild(btnCopyIcon);
271 |         tdUrl.appendChild(wrap);
272 |       }
273 | 
274 |       tr.appendChild(tdUrl);
275 | 
276 |       const tdName = document.createElement("td");
277 |       tdName.className = "col-name";
278 |       tdName.textContent = p.name || "";
279 |       tr.appendChild(tdName);
280 | 
281 |       const tdImg = document.createElement("td");
282 |       tdImg.className = "col-img";
283 |       if (p.image) {
284 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
285 |       } else {
286 |         tdImg.textContent = "";
287 |       }
288 |       tr.appendChild(tdImg);
289 | 
290 | 
291 |       const tdActive = document.createElement("td");
292 |       tdActive.className = "col-act";
293 |       const chk = document.createElement("input");
294 |       chk.type = "checkbox";
295 |       chk.checked = !!p.active;
296 |       chk.addEventListener("change", async () => {
297 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
298 |           method: "PATCH",
299 |           body: { active: chk.checked },
300 |         });
301 |         await loadPosts();
302 |       });
303 |       tdActive.appendChild(chk);
304 |       tr.appendChild(tdActive);
305 | 
306 |       // AKCJE: EDYTUJ + USU≈É
307 |       const tdActions = document.createElement("td");
308 |       tdActions.className = "col-btn";
309 | 
310 |       const actions = document.createElement("div");
311 |       actions.className = "actionsWrap";
312 | 
313 |       const btnEdit = document.createElement("button");
314 |       btnEdit.className = "small";
315 |       btnEdit.type = "button";
316 |       btnEdit.textContent = "Edytuj";
317 |       btnEdit.addEventListener("click", async () => {
318 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
319 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
320 |         const ok = await showModal({
321 |           title: "Edytuj post",
322 |           body:
323 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
324 |             `<div style="margin-top:10px">
325 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
326 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
327 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
328 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
329 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
330 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
331 |             </div>`,
332 |           okText: "Zapisz",
333 |           danger: false,
334 |         });
335 | 
336 |         if (!ok) return;
337 | 
338 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
339 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
340 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
341 | 
342 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
343 |           method: "PATCH",
344 |           body: { url: newUrl, name: newName, image: newImg },
345 |         });
346 | 
347 |         if (!rr.ok) {
348 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
349 |           return;
350 |         }
351 | 
352 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
353 |         await loadPosts();
354 |       });
355 | 
356 |       const btnDel = document.createElement("button");
357 |       btnDel.className = "danger";
358 |       btnDel.type = "button";
359 |       btnDel.textContent = "Usu≈Ñ";
360 |       btnDel.addEventListener("click", async () => {
361 |         const ok = await showModal({
362 |           title: "UsunƒÖƒá post?",
363 |           body:
364 |             `<div>Ta operacja jest nieodwracalna.</div>` +
365 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
366 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
367 |           okText: "Usu≈Ñ",
368 |           danger: true,
369 |         });
370 |         if (!ok) return;
371 | 
372 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
373 |         if (!rr.ok) {
374 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
375 |           return;
376 |         }
377 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
378 |         await loadPosts();
379 |       });
380 | 
381 |       actions.appendChild(btnEdit);
382 |       actions.appendChild(btnDel);
383 | 
384 |       tdActions.appendChild(actions);
385 |       tr.appendChild(tdActions);
386 | 
387 |       elPostsTbody.appendChild(tr);
388 |     }
389 |   }
390 | 
391 |   async function addPost() {
392 |     const url = (elNewPostUrl.value || "").trim();
393 |     const name = (elNewPostName.value || "").trim();
394 |     const image = (elNewPostImage.value || "").trim();
395 |     const active = !!elNewPostActive.checked;
396 | 
397 |     const r = await api("/api/posts", {
398 |       method: "POST",
399 |       body: { url, name, image, active },
400 |     });
401 | 
402 |     if (!r.ok) {
403 |       await showModal({
404 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
405 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
406 |         okText: "OK",
407 |         danger: false,
408 |       });
409 |       return;
410 |     }
411 | 
412 |     elNewPostUrl.value = "";
413 |     elNewPostName.value = "";
414 |     elNewPostImage.value = "";
415 |     elNewPostActive.checked = true;
416 | 
417 |     setHint(elEnvMsg, "Dodano post.", true);
418 |     await loadPosts();
419 |   }
420 | 
421 |   async function pm2Call(which) {
422 |     const map = {
423 |       start: "/api/pm2/start",
424 |       stop: "/api/pm2/stop",
425 |       restart: "/api/pm2/restart",
426 |       status: "/api/pm2/status",
427 |     };
428 |     const path = map[which];
429 |     if (!path) return;
430 | 
431 |     const label =
432 |       which === "start" ? "Startujƒô watchera..."
433 |         : which === "stop" ? "Zatrzymujƒô watchera..."
434 |           : which === "restart" ? "Restartujƒô watchera..."
435 |             : "Sprawdzam status...";
436 | 
437 |     setHint(elEnvMsg, label, true);
438 | 
439 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
440 |     if (!r.ok) {
441 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
442 |       return;
443 |     }
444 | 
445 |     const okMsg =
446 |       which === "start" ? "Watcher uruchomiony."
447 |         : which === "stop" ? "Watcher zatrzymany."
448 |           : which === "restart" ? "Watcher zrestartowany."
449 |             : "Status pobrany.";
450 | 
451 |     setHint(elEnvMsg, okMsg, true);
452 | 
453 |     if (which !== "status") await loadStatus();
454 |   }
455 | 
456 |   async function clearCookies() {
457 |     const ok = await showModal({
458 |       title: "Wyczy≈õciƒá cookies?",
459 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
460 |       okText: "Wyczy≈õƒá",
461 |       danger: true,
462 |     });
463 |     if (!ok) return;
464 | 
465 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
466 | 
467 |     const r = await api("/api/cookies/clear", {
468 |       method: "POST",
469 |       body: { confirm: true },
470 |     });
471 | 
472 |     if (!r.ok) {
473 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
474 |       return;
475 |     }
476 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
477 |   }
478 | 
479 |   // ---------- logs ----------
480 |   function getLines() {
481 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
482 |     if (!isFinite(n)) return 200;
483 |     return Math.max(20, Math.min(2000, n));
484 |   }
485 | 
486 |   async function loadLogs(mode) {
487 |     lastLogMode = mode;
488 |     const lines = getLines();
489 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
490 | 
491 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
492 |     if (!r.ok) {
493 |       elLogs.value = "";
494 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
495 |       return;
496 |     }
497 | 
498 |     elLogs.value = (r.log || "").toString().replace(/\x1b\[[0-9;]*m/g, "");
499 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
500 | 
501 |     if (elLogAutoScroll.checked) {
502 |       elLogs.scrollTop = elLogs.scrollHeight;
503 |     }
504 |   }
505 | 
506 |   function stopAutoLogs() {
507 |     if (logAutoTimer) {
508 |       clearInterval(logAutoTimer);
509 |       logAutoTimer = null;
510 |     }
511 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
512 |     btnLogAutoToggle.classList.remove("primary");
513 |   }
514 | 
515 |   function startAutoLogs() {
516 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
517 |     if (every <= 0) {
518 |       stopAutoLogs();
519 |       return;
520 |     }
521 | 
522 |     stopAutoLogs();
523 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
524 |     btnLogAutoToggle.classList.add("primary");
525 | 
526 |     logAutoTimer = setInterval(() => {
527 |       loadLogs(lastLogMode).catch(() => {});
528 |     }, every);
529 |   }
530 | 
531 |   function toggleLogsSize() {
532 |     logsExpanded = !logsExpanded;
533 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
534 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
535 |   }
536 | 
537 |   // ---------- utils ----------
538 |   async function copyToClipboard(text) {
539 |     try {
540 |       await navigator.clipboard.writeText(text);
541 |       return true;
542 |     } catch (e) {
543 |       const ta = document.createElement("textarea");
544 |       ta.value = text;
545 |       ta.style.position = "fixed";
546 |       ta.style.opacity = "0";
547 |       document.body.appendChild(ta);
548 |       ta.select();
549 |       try {
550 |         document.execCommand("copy");
551 |         document.body.removeChild(ta);
552 |         return true;
553 |       } catch {
554 |         document.body.removeChild(ta);
555 |         return false;
556 |       }
557 |     }
558 |   }
559 | 
560 |   function escapeHtml(s) {
561 |     return String(s || "")
562 |       .replaceAll("&", "&amp;")
563 |       .replaceAll("<", "&lt;")
564 |       .replaceAll(">", "&gt;")
565 |       .replaceAll('"', "&quot;")
566 |       .replaceAll("'", "&#039;");
567 |   }
568 | 
569 |   // ---------- wire events ----------
570 |   function wire() {
571 |     elToken.value = token;
572 | 
573 |     btnSaveToken.addEventListener("click", async () => {
574 |       token = (elToken.value || "").trim();
575 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
576 |       await hardRefresh();
577 |     });
578 | 
579 |     btnRefresh.addEventListener("click", async () => {
580 |       await hardRefresh();
581 |     });
582 | 
583 |     btnSaveEnv.addEventListener("click", async () => {
584 |       await saveEnv(false);
585 |     });
586 | 
587 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
588 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
589 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
590 | 
591 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
592 | 
593 |     btnAddPost.addEventListener("click", async () => await addPost());
594 | 
595 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
596 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
597 | 
598 |     btnLogAutoToggle.addEventListener("click", () => {
599 |       if (logAutoTimer) stopAutoLogs();
600 |       else startAutoLogs();
601 |     });
602 | 
603 |     elLogAutoEvery.addEventListener("change", () => {
604 |       if (logAutoTimer) startAutoLogs();
605 |     });
606 | 
607 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
608 |   }
609 | 
610 |   async function hardRefresh() {
611 |     // Parallel requests for better performance
612 |     const promises = [loadStatus(), loadEnv(), loadPosts()];
613 | 
614 |     if (elLogs.value && elLogs.value.trim().length > 0) {
615 |       promises.push(loadLogs(lastLogMode));
616 |     }
617 | 
618 |     await Promise.all(promises);
619 |   }
620 | 
621 |   // ---------- init ----------
622 |   wire();
623 |   hardRefresh().catch(() => {
624 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
625 |   });
626 | })();
627 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/ui/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>Panel FB Watcher</title>
  7 | 
  8 |   <style>
  9 |     :root{
 10 |       --bg:#0b0f14;
 11 |       --card:#121926;
 12 |       --card2:#0b1220;
 13 |       --border:#223047;
 14 |       --border2:#2a3a55;
 15 |       --text:#e7eef7;
 16 |       --muted:rgba(231,238,247,.75);
 17 |       --primary:#2563eb;
 18 |       --danger:#b91c1c;
 19 |       --ok:#34d399;
 20 |       --err:#f87171;
 21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
 22 |       --radius:14px;
 23 |     }
 24 | 
 25 |     * { box-sizing:border-box; }
 26 |     body {
 27 |       font-family: system-ui, Arial;
 28 |       margin: 16px;
 29 |       background: var(--bg);
 30 |       color: var(--text);
 31 |     }
 32 | 
 33 |     h2 { margin: 6px 0 6px; }
 34 |     h3 { margin: 6px 0 12px; }
 35 | 
 36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
 37 |     .card {
 38 |       background: var(--card);
 39 |       border:1px solid var(--border);
 40 |       border-radius: var(--radius);
 41 |       padding:14px;
 42 |       margin:12px 0;
 43 |       box-shadow: var(--shadow);
 44 |     }
 45 | 
 46 |     input, textarea, button, select {
 47 |       font: inherit;
 48 |       border-radius:12px;
 49 |       border:1px solid var(--border2);
 50 |       background: var(--card2);
 51 |       color: var(--text);
 52 |       padding:10px 12px;
 53 |       outline: none;
 54 |     }
 55 |     input:focus, textarea:focus, select:focus {
 56 |       border-color: rgba(37, 99, 235, .75);
 57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
 58 |     }
 59 | 
 60 |     input, textarea { width: 100%; }
 61 |     textarea { resize: vertical; min-height: 90px; }
 62 | 
 63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
 64 |     button:active { transform: translateY(1px); }
 65 |     button.primary { background: var(--primary); border-color: var(--primary); }
 66 |     button.danger { background: var(--danger); border-color: var(--danger); }
 67 |     button.ghost { background: transparent; }
 68 |     button.small { padding:8px 10px; border-radius: 10px; }
 69 | 
 70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 71 | 
 72 |     .muted { opacity:0.78; font-size:12px; }
 73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 74 | 
 75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
 76 | 
 77 |     .thumb {
 78 |       width:200px; height:120px;
 79 |       object-fit:cover;
 80 |       border-radius:10px;
 81 |       border:1px solid var(--border);
 82 |       background: var(--card2);
 83 |     }
 84 | 
 85 |     /* ===== tabela ===== */
 86 |     .tableWrap {
 87 |       width: 100%;
 88 |       /* by≈Ço: overflow-x; teraz robimy pe≈Çny scroll + limit wysoko≈õci */
 89 |       max-height: calc(100vh - 260px);
 90 |       overflow: auto;
 91 | 
 92 |       border-radius: 12px;
 93 |       border: 1px solid rgba(34,48,71,.45);
 94 |       background: rgba(11,18,32,.25);
 95 |     }
 96 | 
 97 |     /* opcjonalnie: ≈Çadniejsze scrollbary */
 98 |     .tableWrap::-webkit-scrollbar { height: 10px; width: 10px; }
 99 |     .tableWrap::-webkit-scrollbar-thumb { background: rgba(42,58,85,.9); border-radius: 999px; }
100 |     .tableWrap::-webkit-scrollbar-track { background: rgba(11,18,32,.35); border-radius: 999px; }
101 | 
102 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
103 |     th, td {
104 |       border-bottom:1px solid rgba(34,48,71,.7);
105 |       padding:10px;
106 |       text-align:left;
107 |       vertical-align:top;
108 |       overflow-wrap:anywhere;
109 |       word-break:break-word;
110 |     }
111 | 
112 |     /* sticky head */
113 |     th {
114 |       font-size: 12px;
115 |       opacity:.9;
116 |       position: sticky;
117 |       top: 0;
118 |       z-index: 5;
119 |       background: rgba(18,25,38,.96);
120 |       backdrop-filter: blur(8px);
121 |     }
122 | 
123 |     /* delikatny hover, ≈ºeby to "oddycha≈Ço" */
124 |     tbody tr:hover td {
125 |       background: rgba(37,99,235,.06);
126 |     }
127 | 
128 |     /* kolumny */
129 |     th.col-id,  td.col-id  { width: 170px; }
130 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
131 |     th.col-name,td.col-name{ width: 170px; }
132 |     th.col-img, td.col-img { width: 220px; }
133 |     th.col-act, td.col-act { width: 110px; text-align:center; }
134 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
135 | 
136 |     /* URL: kolor */
137 |     td.col-url a{
138 |       color: #93c5fd;
139 |       text-decoration: underline;
140 |     }
141 | 
142 |     /* wrapper dla linka + ikonki kopiuj */
143 |     .urlWrap{
144 |       display:flex;
145 |       align-items:flex-start;
146 |       gap:10px;
147 |     }
148 | 
149 |     /* KLUCZ: niech link nie robi ≈õciany (max 2 linie) */
150 | .urlWrap a{
151 |   flex: 1;
152 |   min-width: 0;
153 | 
154 |   /* clamp (Chromium/WebKit) */
155 |   display: -webkit-box;
156 |   -webkit-box-orient: vertical;
157 |   -webkit-line-clamp: 2;
158 | 
159 |   /* clamp (standard / future) */
160 |   line-clamp: 2;
161 | 
162 |   overflow: hidden;
163 | 
164 |   word-break: break-word;
165 |   overflow-wrap: anywhere;
166 |   line-height: 1.25;
167 | 
168 |   /* fallback gdy clamp nie dzia≈Ça */
169 |   max-height: 2.5em;
170 | }
171 | 
172 | 
173 | 
174 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
175 |     .iconBtn{
176 |       width: 28px;
177 |       height: 28px;
178 |       padding: 0;
179 |       display:inline-flex;
180 |       align-items:center;
181 |       justify-content:center;
182 |       border-radius: 10px;
183 |       background: transparent;
184 |       border: 1px solid rgba(42,58,85,.9);
185 |       opacity: .9;
186 |       flex: 0 0 auto;
187 |     }
188 |     .iconBtn:hover{
189 |       opacity: 1;
190 |       background: rgba(37,99,235,.15);
191 |     }
192 |     .iconBtn:active{
193 |       transform: translateY(1px);
194 |     }
195 |     .iconBtn svg{
196 |       width: 16px;
197 |       height: 16px;
198 |       fill: none;
199 |       stroke: rgba(231,238,247,.95);
200 |       stroke-width: 2;
201 |       stroke-linecap: round;
202 |       stroke-linejoin: round;
203 |     }
204 | 
205 |     /* akcje w tabeli */
206 |     .actionsWrap{
207 |       display:flex;
208 |       gap:10px;
209 |       align-items:center;
210 |       justify-content:flex-start;
211 |       flex-wrap:nowrap;
212 |     }
213 | 
214 |     /* ===== status ===== */
215 |     .hint { margin-top:10px; }
216 |     .hint.ok { color: #a7f3d0; }
217 |     .hint.err { color: #fca5a5; }
218 | 
219 |     /* ===== logi: proporcje ===== */
220 |     .logsBox {
221 |       display:flex;
222 |       flex-direction: column;
223 |       gap:10px;
224 |     }
225 |     #logs {
226 |       height: 200px;
227 |       min-height: 160px;
228 |       max-height: 520px;
229 |     }
230 |     .logsExpanded #logs { height: 420px; }
231 | 
232 |     /* ===== modal ===== */
233 |     .modalOverlay{
234 |       position: fixed;
235 |       inset: 0;
236 |       background: rgba(0,0,0,.55);
237 |       display:none;
238 |       align-items:center;
239 |       justify-content:center;
240 |       padding: 18px;
241 |       z-index: 9999;
242 |     }
243 |     .modalOverlay.show{ display:flex; }
244 |     .modal{
245 |       width: min(640px, 100%);
246 |       border-radius: 16px;
247 |       border: 1px solid rgba(34,48,71,.9);
248 |       background: rgba(18,25,38,.98);
249 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
250 |       padding: 16px;
251 |     }
252 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
253 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
254 |     .modal .modalActions{
255 |       display:flex;
256 |       justify-content:flex-end;
257 |       gap:10px;
258 |       margin-top: 14px;
259 |     }
260 |     .kbd{
261 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
262 |       font-size: 12px;
263 |       opacity:.9;
264 |       padding: 2px 6px;
265 |       border:1px solid rgba(42,58,85,.9);
266 |       border-radius: 8px;
267 |       background: rgba(11,18,32,.55);
268 |     }
269 | 
270 |     @media (max-width: 860px){
271 |       table { min-width: 980px; }
272 |       .tableWrap { max-height: calc(100vh - 220px); }
273 |     }
274 |   </style>
275 | </head>
276 | 
277 | <body>
278 |   <h2>FB Watcher ‚Äî Panel</h2>
279 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
280 | 
281 |   <div class="card">
282 |     <div class="row">
283 |       <div style="flex:1; min-width:260px;">
284 |         <label>Token panelu</label>
285 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
286 |       </div>
287 |       <div style="display:flex; gap:10px; align-items:flex-end;">
288 |         <button class="primary" id="saveToken">Zapisz token</button>
289 |         <button id="refresh">Od≈õwie≈º</button>
290 |       </div>
291 |     </div>
292 | 
293 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
294 |   </div>
295 | 
296 |   <div class="card">
297 |     <h3>Ustawienia (.env)</h3>
298 | 
299 |     <div class="row">
300 |       <div style="flex:1; min-width:260px;">
301 |         <label>E-mail Facebook</label>
302 |         <input id="FB_EMAIL" />
303 |       </div>
304 |       <div style="flex:1; min-width:260px;">
305 |         <label>Has≈Ço Facebook</label>
306 |         <input id="FB_PASSWORD" type="password" />
307 |       </div>
308 |     </div>
309 | 
310 |     <label>Webhook (URL)</label>
311 |     <input id="WEBHOOK_URL" />
312 | 
313 |     <div class="row">
314 |       <div style="flex:1; min-width:220px;">
315 |         <label>Interwa≈Ç sprawdzania (ms)</label>
316 |         <input id="CHECK_INTERVAL_MS" />
317 |       </div>
318 |       <div style="flex:2; min-width:260px;">
319 |         <label>Arkusz z postami (CSV export)</label>
320 |         <input id="POSTS_SHEET_URL" />
321 |       </div>
322 |     </div>
323 | 
324 |     <div class="row">
325 |       <div style="flex:1; min-width:220px;">
326 |         <label>Tryb bez okna (headless)</label>
327 |         <select id="HEADLESS_BROWSER">
328 |           <option value="true">true</option>
329 |           <option value="false">false</option>
330 |         </select>
331 |       </div>
332 |       <div style="flex:1; min-width:220px;">
333 |         <label>Obs≈Çuga UI (handlery)</label>
334 |         <select id="USE_UI_HANDLERS">
335 |           <option value="true">true</option>
336 |           <option value="false">false</option>
337 |         </select>
338 |       </div>
339 |       <div style="flex:1; min-width:220px;">
340 |         <label>Uwzglƒôdniaj odpowiedzi</label>
341 |         <select id="INCLUDE_REPLIES">
342 |           <option value="true">true</option>
343 |           <option value="false">false</option>
344 |         </select>
345 |       </div>
346 |     </div>
347 | 
348 |     <div class="row" style="margin-top:10px;">
349 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
350 |       <button id="pm2Start">Start watchera</button>
351 |       <button id="pm2Stop">Stop watchera</button>
352 |       <button id="pm2Restart">Restart watchera</button>
353 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
354 |     </div>
355 | 
356 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
357 |   </div>
358 | 
359 |   <div class="card">
360 |     <h3>Posty (data/posts.json)</h3>
361 | 
362 |     <div class="row">
363 |       <div style="flex:2; min-width:260px;">
364 |         <label>Nowy URL posta</label>
365 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
366 |       </div>
367 | 
368 |       <div style="flex:1; min-width:220px;">
369 |         <label>Nazwa</label>
370 |         <input id="newPostName" placeholder="np. A1" />
371 |       </div>
372 | 
373 |       <div style="flex:1; min-width:260px;">
374 |         <label>URL zdjƒôcia</label>
375 |         <input id="newPostImage" placeholder="https://...jpg" />
376 |       </div>
377 |     </div>
378 | 
379 |     <div class="row" style="margin-top:10px;">
380 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
381 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
382 |           <input type="checkbox" id="newPostActive" checked /> aktywny
383 |         </label>
384 |         <button class="primary" id="addPost">Dodaj</button>
385 |       </div>
386 |     </div>
387 | 
388 |     <div style="margin-top:12px;" class="tableWrap">
389 |       <table>
390 |         <thead>
391 |           <tr>
392 |             <th class="col-id">ID</th>
393 |             <th class="col-url">Link</th>
394 |             <th class="col-name">Nazwa</th>
395 |             <th class="col-img">Zdjƒôcie</th>
396 |             <th class="col-act">Aktywny</th>
397 |             <th class="col-btn">Akcje</th>
398 |           </tr>
399 |         </thead>
400 |         <tbody id="posts"></tbody>
401 |       </table>
402 |     </div>
403 |   </div>
404 | 
405 |   <div class="card" id="logsCard">
406 |     <div class="row" style="justify-content:space-between; align-items:center;">
407 |       <h3 style="margin:0;">Logi</h3>
408 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
409 |         Rozwi≈Ñ
410 |       </button>
411 |     </div>
412 | 
413 |     <div class="logsBox">
414 |       <div class="row">
415 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
416 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
417 | 
418 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
419 | 
420 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
421 |           <option value="0">auto: wy≈Ç.</option>
422 |           <option value="1000">co 1 s</option>
423 |           <option value="2000" selected>co 2 s</option>
424 |           <option value="5000">co 5 s</option>
425 |           <option value="10000">co 10 s</option>
426 |         </select>
427 | 
428 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
429 | 
430 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
431 |           <input type="checkbox" id="logAutoScroll" checked />
432 |           auto-scroll
433 |         </label>
434 |       </div>
435 | 
436 |       <div class="sep"></div>
437 | 
438 |       <textarea
439 |         id="logs"
440 |         class="mono"
441 |         readonly
442 |         spellcheck="false"
443 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
444 | 
445 |       <div id="logHint" class="muted hint"></div>
446 |     </div>
447 |   </div>
448 | 
449 |   <!-- modal -->
450 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
451 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
452 |       <h4 id="modalTitle">Potwierdzenie</h4>
453 |       <div class="modalBody" id="modalBody"></div>
454 |       <div class="modalActions">
455 |         <button id="modalCancel">Anuluj</button>
456 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
457 |       </div>
458 |       <div class="muted" style="margin-top:10px;">
459 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
460 |       </div>
461 |     </div>
462 |   </div>
463 | 
464 |   <script src="/app.js"></script>
465 | </body>
466 | </html>
467 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```html
 1 | <!DOCTYPE html>
 2 | <html lang="pl" class="dark">
 3 |   <head>
 4 |     <meta charset="UTF-8" />
 5 |     <link rel="icon" type="image/svg+xml" href="/vite.svg" />
 6 |     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 7 |     <title>FB Watcher - Panel</title>
 8 |   </head>
 9 |   <body>
10 |     <div id="root"></div>
11 |     <script type="module" src="/src/main.tsx"></script>
12 |   </body>
13 | </html>
14 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/package-lock.json`
**Typ:** JSON  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```json
   1 | {
   2 |   "name": "fbwatcher-panel",
   3 |   "version": "0.0.1",
   4 |   "lockfileVersion": 3,
   5 |   "requires": true,
   6 |   "packages": {
   7 |     "": {
   8 |       "name": "fbwatcher-panel",
   9 |       "version": "0.0.1",
  10 |       "dependencies": {
  11 |         "class-variance-authority": "^0.7.1",
  12 |         "clsx": "^2.1.1",
  13 |         "lucide-react": "^0.469.0",
  14 |         "react": "^18.3.1",
  15 |         "react-dom": "^18.3.1",
  16 |         "react-router-dom": "^7.1.1",
  17 |         "tailwind-merge": "^2.6.0"
  18 |       },
  19 |       "devDependencies": {
  20 |         "@types/react": "^18.3.18",
  21 |         "@types/react-dom": "^18.3.5",
  22 |         "@vitejs/plugin-react": "^4.3.4",
  23 |         "autoprefixer": "^10.4.20",
  24 |         "postcss": "^8.4.49",
  25 |         "tailwindcss": "^3.4.17",
  26 |         "typescript": "~5.6.2",
  27 |         "vite": "^6.0.5"
  28 |       }
  29 |     },
  30 |     "node_modules/@alloc/quick-lru": {
  31 |       "version": "5.2.0",
  32 |       "resolved": "https://registry.npmjs.org/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
  33 |       "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
  34 |       "dev": true,
  35 |       "license": "MIT",
  36 |       "engines": {
  37 |         "node": ">=10"
  38 |       },
  39 |       "funding": {
  40 |         "url": "https://github.com/sponsors/sindresorhus"
  41 |       }
  42 |     },
  43 |     "node_modules/@babel/code-frame": {
  44 |       "version": "7.28.6",
  45 |       "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.28.6.tgz",
  46 |       "integrity": "sha512-JYgintcMjRiCvS8mMECzaEn+m3PfoQiyqukOMCCVQtoJGYJw8j/8LBJEiqkHLkfwCcs74E3pbAUFNg7d9VNJ+Q==",
  47 |       "dev": true,
  48 |       "license": "MIT",
  49 |       "dependencies": {
  50 |         "@babel/helper-validator-identifier": "^7.28.5",
  51 |         "js-tokens": "^4.0.0",
  52 |         "picocolors": "^1.1.1"
  53 |       },
  54 |       "engines": {
  55 |         "node": ">=6.9.0"
  56 |       }
  57 |     },
  58 |     "node_modules/@babel/compat-data": {
  59 |       "version": "7.28.6",
  60 |       "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.6.tgz",
  61 |       "integrity": "sha512-2lfu57JtzctfIrcGMz992hyLlByuzgIk58+hhGCxjKZ3rWI82NnVLjXcaTqkI2NvlcvOskZaiZ5kjUALo3Lpxg==",
  62 |       "dev": true,
  63 |       "license": "MIT",
  64 |       "engines": {
  65 |         "node": ">=6.9.0"
  66 |       }
  67 |     },
  68 |     "node_modules/@babel/core": {
  69 |       "version": "7.28.6",
  70 |       "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.6.tgz",
  71 |       "integrity": "sha512-H3mcG6ZDLTlYfaSNi0iOKkigqMFvkTKlGUYlD8GW7nNOYRrevuA46iTypPyv+06V3fEmvvazfntkBU34L0azAw==",
  72 |       "dev": true,
  73 |       "license": "MIT",
  74 |       "peer": true,
  75 |       "dependencies": {
  76 |         "@babel/code-frame": "^7.28.6",
  77 |         "@babel/generator": "^7.28.6",
  78 |         "@babel/helper-compilation-targets": "^7.28.6",
  79 |         "@babel/helper-module-transforms": "^7.28.6",
  80 |         "@babel/helpers": "^7.28.6",
  81 |         "@babel/parser": "^7.28.6",
  82 |         "@babel/template": "^7.28.6",
  83 |         "@babel/traverse": "^7.28.6",
  84 |         "@babel/types": "^7.28.6",
  85 |         "@jridgewell/remapping": "^2.3.5",
  86 |         "convert-source-map": "^2.0.0",
  87 |         "debug": "^4.1.0",
  88 |         "gensync": "^1.0.0-beta.2",
  89 |         "json5": "^2.2.3",
  90 |         "semver": "^6.3.1"
  91 |       },
  92 |       "engines": {
  93 |         "node": ">=6.9.0"
  94 |       },
  95 |       "funding": {
  96 |         "type": "opencollective",
  97 |         "url": "https://opencollective.com/babel"
  98 |       }
  99 |     },
 100 |     "node_modules/@babel/generator": {
 101 |       "version": "7.28.6",
 102 |       "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.6.tgz",
 103 |       "integrity": "sha512-lOoVRwADj8hjf7al89tvQ2a1lf53Z+7tiXMgpZJL3maQPDxh0DgLMN62B2MKUOFcoodBHLMbDM6WAbKgNy5Suw==",
 104 |       "dev": true,
 105 |       "license": "MIT",
 106 |       "dependencies": {
 107 |         "@babel/parser": "^7.28.6",
 108 |         "@babel/types": "^7.28.6",
 109 |         "@jridgewell/gen-mapping": "^0.3.12",
 110 |         "@jridgewell/trace-mapping": "^0.3.28",
 111 |         "jsesc": "^3.0.2"
 112 |       },
 113 |       "engines": {
 114 |         "node": ">=6.9.0"
 115 |       }
 116 |     },
 117 |     "node_modules/@babel/helper-compilation-targets": {
 118 |       "version": "7.28.6",
 119 |       "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.28.6.tgz",
 120 |       "integrity": "sha512-JYtls3hqi15fcx5GaSNL7SCTJ2MNmjrkHXg4FSpOA/grxK8KwyZ5bubHsCq8FXCkua6xhuaaBit+3b7+VZRfcA==",
 121 |       "dev": true,
 122 |       "license": "MIT",
 123 |       "dependencies": {
 124 |         "@babel/compat-data": "^7.28.6",
 125 |         "@babel/helper-validator-option": "^7.27.1",
 126 |         "browserslist": "^4.24.0",
 127 |         "lru-cache": "^5.1.1",
 128 |         "semver": "^6.3.1"
 129 |       },
 130 |       "engines": {
 131 |         "node": ">=6.9.0"
 132 |       }
 133 |     },
 134 |     "node_modules/@babel/helper-globals": {
 135 |       "version": "7.28.0",
 136 |       "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
 137 |       "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
 138 |       "dev": true,
 139 |       "license": "MIT",
 140 |       "engines": {
 141 |         "node": ">=6.9.0"
 142 |       }
 143 |     },
 144 |     "node_modules/@babel/helper-module-imports": {
 145 |       "version": "7.28.6",
 146 |       "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.28.6.tgz",
 147 |       "integrity": "sha512-l5XkZK7r7wa9LucGw9LwZyyCUscb4x37JWTPz7swwFE/0FMQAGpiWUZn8u9DzkSBWEcK25jmvubfpw2dnAMdbw==",
 148 |       "dev": true,
 149 |       "license": "MIT",
 150 |       "dependencies": {
 151 |         "@babel/traverse": "^7.28.6",
 152 |         "@babel/types": "^7.28.6"
 153 |       },
 154 |       "engines": {
 155 |         "node": ">=6.9.0"
 156 |       }
 157 |     },
 158 |     "node_modules/@babel/helper-module-transforms": {
 159 |       "version": "7.28.6",
 160 |       "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.6.tgz",
 161 |       "integrity": "sha512-67oXFAYr2cDLDVGLXTEABjdBJZ6drElUSI7WKp70NrpyISso3plG9SAGEF6y7zbha/wOzUByWWTJvEDVNIUGcA==",
 162 |       "dev": true,
 163 |       "license": "MIT",
 164 |       "dependencies": {
 165 |         "@babel/helper-module-imports": "^7.28.6",
 166 |         "@babel/helper-validator-identifier": "^7.28.5",
 167 |         "@babel/traverse": "^7.28.6"
 168 |       },
 169 |       "engines": {
 170 |         "node": ">=6.9.0"
 171 |       },
 172 |       "peerDependencies": {
 173 |         "@babel/core": "^7.0.0"
 174 |       }
 175 |     },
 176 |     "node_modules/@babel/helper-plugin-utils": {
 177 |       "version": "7.28.6",
 178 |       "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.28.6.tgz",
 179 |       "integrity": "sha512-S9gzZ/bz83GRysI7gAD4wPT/AI3uCnY+9xn+Mx/KPs2JwHJIz1W8PZkg2cqyt3RNOBM8ejcXhV6y8Og7ly/Dug==",
 180 |       "dev": true,
 181 |       "license": "MIT",
 182 |       "engines": {
 183 |         "node": ">=6.9.0"
 184 |       }
 185 |     },
 186 |     "node_modules/@babel/helper-string-parser": {
 187 |       "version": "7.27.1",
 188 |       "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
 189 |       "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
 190 |       "dev": true,
 191 |       "license": "MIT",
 192 |       "engines": {
 193 |         "node": ">=6.9.0"
 194 |       }
 195 |     },
 196 |     "node_modules/@babel/helper-validator-identifier": {
 197 |       "version": "7.28.5",
 198 |       "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
 199 |       "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
 200 |       "dev": true,
 201 |       "license": "MIT",
 202 |       "engines": {
 203 |         "node": ">=6.9.0"
 204 |       }
 205 |     },
 206 |     "node_modules/@babel/helper-validator-option": {
 207 |       "version": "7.27.1",
 208 |       "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
 209 |       "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
 210 |       "dev": true,
 211 |       "license": "MIT",
 212 |       "engines": {
 213 |         "node": ">=6.9.0"
 214 |       }
 215 |     },
 216 |     "node_modules/@babel/helpers": {
 217 |       "version": "7.28.6",
 218 |       "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.6.tgz",
 219 |       "integrity": "sha512-xOBvwq86HHdB7WUDTfKfT/Vuxh7gElQ+Sfti2Cy6yIWNW05P8iUslOVcZ4/sKbE+/jQaukQAdz/gf3724kYdqw==",
 220 |       "dev": true,
 221 |       "license": "MIT",
 222 |       "dependencies": {
 223 |         "@babel/template": "^7.28.6",
 224 |         "@babel/types": "^7.28.6"
 225 |       },
 226 |       "engines": {
 227 |         "node": ">=6.9.0"
 228 |       }
 229 |     },
 230 |     "node_modules/@babel/parser": {
 231 |       "version": "7.28.6",
 232 |       "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.6.tgz",
 233 |       "integrity": "sha512-TeR9zWR18BvbfPmGbLampPMW+uW1NZnJlRuuHso8i87QZNq2JRF9i6RgxRqtEq+wQGsS19NNTWr2duhnE49mfQ==",
 234 |       "dev": true,
 235 |       "license": "MIT",
 236 |       "dependencies": {
 237 |         "@babel/types": "^7.28.6"
 238 |       },
 239 |       "bin": {
 240 |         "parser": "bin/babel-parser.js"
 241 |       },
 242 |       "engines": {
 243 |         "node": ">=6.0.0"
 244 |       }
 245 |     },
 246 |     "node_modules/@babel/plugin-transform-react-jsx-self": {
 247 |       "version": "7.27.1",
 248 |       "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
 249 |       "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
 250 |       "dev": true,
 251 |       "license": "MIT",
 252 |       "dependencies": {
 253 |         "@babel/helper-plugin-utils": "^7.27.1"
 254 |       },
 255 |       "engines": {
 256 |         "node": ">=6.9.0"
 257 |       },
 258 |       "peerDependencies": {
 259 |         "@babel/core": "^7.0.0-0"
 260 |       }
 261 |     },
 262 |     "node_modules/@babel/plugin-transform-react-jsx-source": {
 263 |       "version": "7.27.1",
 264 |       "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
 265 |       "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
 266 |       "dev": true,
 267 |       "license": "MIT",
 268 |       "dependencies": {
 269 |         "@babel/helper-plugin-utils": "^7.27.1"
 270 |       },
 271 |       "engines": {
 272 |         "node": ">=6.9.0"
 273 |       },
 274 |       "peerDependencies": {
 275 |         "@babel/core": "^7.0.0-0"
 276 |       }
 277 |     },
 278 |     "node_modules/@babel/template": {
 279 |       "version": "7.28.6",
 280 |       "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.28.6.tgz",
 281 |       "integrity": "sha512-YA6Ma2KsCdGb+WC6UpBVFJGXL58MDA6oyONbjyF/+5sBgxY/dwkhLogbMT2GXXyU84/IhRw/2D1Os1B/giz+BQ==",
 282 |       "dev": true,
 283 |       "license": "MIT",
 284 |       "dependencies": {
 285 |         "@babel/code-frame": "^7.28.6",
 286 |         "@babel/parser": "^7.28.6",
 287 |         "@babel/types": "^7.28.6"
 288 |       },
 289 |       "engines": {
 290 |         "node": ">=6.9.0"
 291 |       }
 292 |     },
 293 |     "node_modules/@babel/traverse": {
 294 |       "version": "7.28.6",
 295 |       "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.6.tgz",
 296 |       "integrity": "sha512-fgWX62k02qtjqdSNTAGxmKYY/7FSL9WAS1o2Hu5+I5m9T0yxZzr4cnrfXQ/MX0rIifthCSs6FKTlzYbJcPtMNg==",
 297 |       "dev": true,
 298 |       "license": "MIT",
 299 |       "dependencies": {
 300 |         "@babel/code-frame": "^7.28.6",
 301 |         "@babel/generator": "^7.28.6",
 302 |         "@babel/helper-globals": "^7.28.0",
 303 |         "@babel/parser": "^7.28.6",
 304 |         "@babel/template": "^7.28.6",
 305 |         "@babel/types": "^7.28.6",
 306 |         "debug": "^4.3.1"
 307 |       },
 308 |       "engines": {
 309 |         "node": ">=6.9.0"
 310 |       }
 311 |     },
 312 |     "node_modules/@babel/types": {
 313 |       "version": "7.28.6",
 314 |       "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.6.tgz",
 315 |       "integrity": "sha512-0ZrskXVEHSWIqZM/sQZ4EV3jZJXRkio/WCxaqKZP1g//CEWEPSfeZFcms4XeKBCHU0ZKnIkdJeU/kF+eRp5lBg==",
 316 |       "dev": true,
 317 |       "license": "MIT",
 318 |       "dependencies": {
 319 |         "@babel/helper-string-parser": "^7.27.1",
 320 |         "@babel/helper-validator-identifier": "^7.28.5"
 321 |       },
 322 |       "engines": {
 323 |         "node": ">=6.9.0"
 324 |       }
 325 |     },
 326 |     "node_modules/@esbuild/aix-ppc64": {
 327 |       "version": "0.25.12",
 328 |       "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.25.12.tgz",
 329 |       "integrity": "sha512-Hhmwd6CInZ3dwpuGTF8fJG6yoWmsToE+vYgD4nytZVxcu1ulHpUQRAB1UJ8+N1Am3Mz4+xOByoQoSZf4D+CpkA==",
 330 |       "cpu": [
 331 |         "ppc64"
 332 |       ],
 333 |       "dev": true,
 334 |       "license": "MIT",
 335 |       "optional": true,
 336 |       "os": [
 337 |         "aix"
 338 |       ],
 339 |       "engines": {
 340 |         "node": ">=18"
 341 |       }
 342 |     },
 343 |     "node_modules/@esbuild/android-arm": {
 344 |       "version": "0.25.12",
 345 |       "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.25.12.tgz",
 346 |       "integrity": "sha512-VJ+sKvNA/GE7Ccacc9Cha7bpS8nyzVv0jdVgwNDaR4gDMC/2TTRc33Ip8qrNYUcpkOHUT5OZ0bUcNNVZQ9RLlg==",
 347 |       "cpu": [
 348 |         "arm"
 349 |       ],
 350 |       "dev": true,
 351 |       "license": "MIT",
 352 |       "optional": true,
 353 |       "os": [
 354 |         "android"
 355 |       ],
 356 |       "engines": {
 357 |         "node": ">=18"
 358 |       }
 359 |     },
 360 |     "node_modules/@esbuild/android-arm64": {
 361 |       "version": "0.25.12",
 362 |       "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.25.12.tgz",
 363 |       "integrity": "sha512-6AAmLG7zwD1Z159jCKPvAxZd4y/VTO0VkprYy+3N2FtJ8+BQWFXU+OxARIwA46c5tdD9SsKGZ/1ocqBS/gAKHg==",
 364 |       "cpu": [
 365 |         "arm64"
 366 |       ],
 367 |       "dev": true,
 368 |       "license": "MIT",
 369 |       "optional": true,
 370 |       "os": [
 371 |         "android"
 372 |       ],
 373 |       "engines": {
 374 |         "node": ">=18"
 375 |       }
 376 |     },
 377 |     "node_modules/@esbuild/android-x64": {
 378 |       "version": "0.25.12",
 379 |       "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.25.12.tgz",
 380 |       "integrity": "sha512-5jbb+2hhDHx5phYR2By8GTWEzn6I9UqR11Kwf22iKbNpYrsmRB18aX/9ivc5cabcUiAT/wM+YIZ6SG9QO6a8kg==",
 381 |       "cpu": [
 382 |         "x64"
 383 |       ],
 384 |       "dev": true,
 385 |       "license": "MIT",
 386 |       "optional": true,
 387 |       "os": [
 388 |         "android"
 389 |       ],
 390 |       "engines": {
 391 |         "node": ">=18"
 392 |       }
 393 |     },
 394 |     "node_modules/@esbuild/darwin-arm64": {
 395 |       "version": "0.25.12",
 396 |       "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.25.12.tgz",
 397 |       "integrity": "sha512-N3zl+lxHCifgIlcMUP5016ESkeQjLj/959RxxNYIthIg+CQHInujFuXeWbWMgnTo4cp5XVHqFPmpyu9J65C1Yg==",
 398 |       "cpu": [
 399 |         "arm64"
 400 |       ],
 401 |       "dev": true,
 402 |       "license": "MIT",
 403 |       "optional": true,
 404 |       "os": [
 405 |         "darwin"
 406 |       ],
 407 |       "engines": {
 408 |         "node": ">=18"
 409 |       }
 410 |     },
 411 |     "node_modules/@esbuild/darwin-x64": {
 412 |       "version": "0.25.12",
 413 |       "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.25.12.tgz",
 414 |       "integrity": "sha512-HQ9ka4Kx21qHXwtlTUVbKJOAnmG1ipXhdWTmNXiPzPfWKpXqASVcWdnf2bnL73wgjNrFXAa3yYvBSd9pzfEIpA==",
 415 |       "cpu": [
 416 |         "x64"
 417 |       ],
 418 |       "dev": true,
 419 |       "license": "MIT",
 420 |       "optional": true,
 421 |       "os": [
 422 |         "darwin"
 423 |       ],
 424 |       "engines": {
 425 |         "node": ">=18"
 426 |       }
 427 |     },
 428 |     "node_modules/@esbuild/freebsd-arm64": {
 429 |       "version": "0.25.12",
 430 |       "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.25.12.tgz",
 431 |       "integrity": "sha512-gA0Bx759+7Jve03K1S0vkOu5Lg/85dou3EseOGUes8flVOGxbhDDh/iZaoek11Y8mtyKPGF3vP8XhnkDEAmzeg==",
 432 |       "cpu": [
 433 |         "arm64"
 434 |       ],
 435 |       "dev": true,
 436 |       "license": "MIT",
 437 |       "optional": true,
 438 |       "os": [
 439 |         "freebsd"
 440 |       ],
 441 |       "engines": {
 442 |         "node": ">=18"
 443 |       }
 444 |     },
 445 |     "node_modules/@esbuild/freebsd-x64": {
 446 |       "version": "0.25.12",
 447 |       "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.25.12.tgz",
 448 |       "integrity": "sha512-TGbO26Yw2xsHzxtbVFGEXBFH0FRAP7gtcPE7P5yP7wGy7cXK2oO7RyOhL5NLiqTlBh47XhmIUXuGciXEqYFfBQ==",
 449 |       "cpu": [
 450 |         "x64"
 451 |       ],
 452 |       "dev": true,
 453 |       "license": "MIT",
 454 |       "optional": true,
 455 |       "os": [
 456 |         "freebsd"
 457 |       ],
 458 |       "engines": {
 459 |         "node": ">=18"
 460 |       }
 461 |     },
 462 |     "node_modules/@esbuild/linux-arm": {
 463 |       "version": "0.25.12",
 464 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.25.12.tgz",
 465 |       "integrity": "sha512-lPDGyC1JPDou8kGcywY0YILzWlhhnRjdof3UlcoqYmS9El818LLfJJc3PXXgZHrHCAKs/Z2SeZtDJr5MrkxtOw==",
 466 |       "cpu": [
 467 |         "arm"
 468 |       ],
 469 |       "dev": true,
 470 |       "license": "MIT",
 471 |       "optional": true,
 472 |       "os": [
 473 |         "linux"
 474 |       ],
 475 |       "engines": {
 476 |         "node": ">=18"
 477 |       }
 478 |     },
 479 |     "node_modules/@esbuild/linux-arm64": {
 480 |       "version": "0.25.12",
 481 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.25.12.tgz",
 482 |       "integrity": "sha512-8bwX7a8FghIgrupcxb4aUmYDLp8pX06rGh5HqDT7bB+8Rdells6mHvrFHHW2JAOPZUbnjUpKTLg6ECyzvas2AQ==",
 483 |       "cpu": [
 484 |         "arm64"
 485 |       ],
 486 |       "dev": true,
 487 |       "license": "MIT",
 488 |       "optional": true,
 489 |       "os": [
 490 |         "linux"
 491 |       ],
 492 |       "engines": {
 493 |         "node": ">=18"
 494 |       }
 495 |     },
 496 |     "node_modules/@esbuild/linux-ia32": {
 497 |       "version": "0.25.12",
 498 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.25.12.tgz",
 499 |       "integrity": "sha512-0y9KrdVnbMM2/vG8KfU0byhUN+EFCny9+8g202gYqSSVMonbsCfLjUO+rCci7pM0WBEtz+oK/PIwHkzxkyharA==",
 500 |       "cpu": [
 501 |         "ia32"
 502 |       ],
 503 |       "dev": true,
 504 |       "license": "MIT",
 505 |       "optional": true,
 506 |       "os": [
 507 |         "linux"
 508 |       ],
 509 |       "engines": {
 510 |         "node": ">=18"
 511 |       }
 512 |     },
 513 |     "node_modules/@esbuild/linux-loong64": {
 514 |       "version": "0.25.12",
 515 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.25.12.tgz",
 516 |       "integrity": "sha512-h///Lr5a9rib/v1GGqXVGzjL4TMvVTv+s1DPoxQdz7l/AYv6LDSxdIwzxkrPW438oUXiDtwM10o9PmwS/6Z0Ng==",
 517 |       "cpu": [
 518 |         "loong64"
 519 |       ],
 520 |       "dev": true,
 521 |       "license": "MIT",
 522 |       "optional": true,
 523 |       "os": [
 524 |         "linux"
 525 |       ],
 526 |       "engines": {
 527 |         "node": ">=18"
 528 |       }
 529 |     },
 530 |     "node_modules/@esbuild/linux-mips64el": {
 531 |       "version": "0.25.12",
 532 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.25.12.tgz",
 533 |       "integrity": "sha512-iyRrM1Pzy9GFMDLsXn1iHUm18nhKnNMWscjmp4+hpafcZjrr2WbT//d20xaGljXDBYHqRcl8HnxbX6uaA/eGVw==",
 534 |       "cpu": [
 535 |         "mips64el"
 536 |       ],
 537 |       "dev": true,
 538 |       "license": "MIT",
 539 |       "optional": true,
 540 |       "os": [
 541 |         "linux"
 542 |       ],
 543 |       "engines": {
 544 |         "node": ">=18"
 545 |       }
 546 |     },
 547 |     "node_modules/@esbuild/linux-ppc64": {
 548 |       "version": "0.25.12",
 549 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.25.12.tgz",
 550 |       "integrity": "sha512-9meM/lRXxMi5PSUqEXRCtVjEZBGwB7P/D4yT8UG/mwIdze2aV4Vo6U5gD3+RsoHXKkHCfSxZKzmDssVlRj1QQA==",
 551 |       "cpu": [
 552 |         "ppc64"
 553 |       ],
 554 |       "dev": true,
 555 |       "license": "MIT",
 556 |       "optional": true,
 557 |       "os": [
 558 |         "linux"
 559 |       ],
 560 |       "engines": {
 561 |         "node": ">=18"
 562 |       }
 563 |     },
 564 |     "node_modules/@esbuild/linux-riscv64": {
 565 |       "version": "0.25.12",
 566 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.25.12.tgz",
 567 |       "integrity": "sha512-Zr7KR4hgKUpWAwb1f3o5ygT04MzqVrGEGXGLnj15YQDJErYu/BGg+wmFlIDOdJp0PmB0lLvxFIOXZgFRrdjR0w==",
 568 |       "cpu": [
 569 |         "riscv64"
 570 |       ],
 571 |       "dev": true,
 572 |       "license": "MIT",
 573 |       "optional": true,
 574 |       "os": [
 575 |         "linux"
 576 |       ],
 577 |       "engines": {
 578 |         "node": ">=18"
 579 |       }
 580 |     },
 581 |     "node_modules/@esbuild/linux-s390x": {
 582 |       "version": "0.25.12",
 583 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.25.12.tgz",
 584 |       "integrity": "sha512-MsKncOcgTNvdtiISc/jZs/Zf8d0cl/t3gYWX8J9ubBnVOwlk65UIEEvgBORTiljloIWnBzLs4qhzPkJcitIzIg==",
 585 |       "cpu": [
 586 |         "s390x"
 587 |       ],
 588 |       "dev": true,
 589 |       "license": "MIT",
 590 |       "optional": true,
 591 |       "os": [
 592 |         "linux"
 593 |       ],
 594 |       "engines": {
 595 |         "node": ">=18"
 596 |       }
 597 |     },
 598 |     "node_modules/@esbuild/linux-x64": {
 599 |       "version": "0.25.12",
 600 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.25.12.tgz",
 601 |       "integrity": "sha512-uqZMTLr/zR/ed4jIGnwSLkaHmPjOjJvnm6TVVitAa08SLS9Z0VM8wIRx7gWbJB5/J54YuIMInDquWyYvQLZkgw==",
 602 |       "cpu": [
 603 |         "x64"
 604 |       ],
 605 |       "dev": true,
 606 |       "license": "MIT",
 607 |       "optional": true,
 608 |       "os": [
 609 |         "linux"
 610 |       ],
 611 |       "engines": {
 612 |         "node": ">=18"
 613 |       }
 614 |     },
 615 |     "node_modules/@esbuild/netbsd-arm64": {
 616 |       "version": "0.25.12",
 617 |       "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.25.12.tgz",
 618 |       "integrity": "sha512-xXwcTq4GhRM7J9A8Gv5boanHhRa/Q9KLVmcyXHCTaM4wKfIpWkdXiMog/KsnxzJ0A1+nD+zoecuzqPmCRyBGjg==",
 619 |       "cpu": [
 620 |         "arm64"
 621 |       ],
 622 |       "dev": true,
 623 |       "license": "MIT",
 624 |       "optional": true,
 625 |       "os": [
 626 |         "netbsd"
 627 |       ],
 628 |       "engines": {
 629 |         "node": ">=18"
 630 |       }
 631 |     },
 632 |     "node_modules/@esbuild/netbsd-x64": {
 633 |       "version": "0.25.12",
 634 |       "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.25.12.tgz",
 635 |       "integrity": "sha512-Ld5pTlzPy3YwGec4OuHh1aCVCRvOXdH8DgRjfDy/oumVovmuSzWfnSJg+VtakB9Cm0gxNO9BzWkj6mtO1FMXkQ==",
 636 |       "cpu": [
 637 |         "x64"
 638 |       ],
 639 |       "dev": true,
 640 |       "license": "MIT",
 641 |       "optional": true,
 642 |       "os": [
 643 |         "netbsd"
 644 |       ],
 645 |       "engines": {
 646 |         "node": ">=18"
 647 |       }
 648 |     },
 649 |     "node_modules/@esbuild/openbsd-arm64": {
 650 |       "version": "0.25.12",
 651 |       "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.25.12.tgz",
 652 |       "integrity": "sha512-fF96T6KsBo/pkQI950FARU9apGNTSlZGsv1jZBAlcLL1MLjLNIWPBkj5NlSz8aAzYKg+eNqknrUJ24QBybeR5A==",
 653 |       "cpu": [
 654 |         "arm64"
 655 |       ],
 656 |       "dev": true,
 657 |       "license": "MIT",
 658 |       "optional": true,
 659 |       "os": [
 660 |         "openbsd"
 661 |       ],
 662 |       "engines": {
 663 |         "node": ">=18"
 664 |       }
 665 |     },
 666 |     "node_modules/@esbuild/openbsd-x64": {
 667 |       "version": "0.25.12",
 668 |       "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.25.12.tgz",
 669 |       "integrity": "sha512-MZyXUkZHjQxUvzK7rN8DJ3SRmrVrke8ZyRusHlP+kuwqTcfWLyqMOE3sScPPyeIXN/mDJIfGXvcMqCgYKekoQw==",
 670 |       "cpu": [
 671 |         "x64"
 672 |       ],
 673 |       "dev": true,
 674 |       "license": "MIT",
 675 |       "optional": true,
 676 |       "os": [
 677 |         "openbsd"
 678 |       ],
 679 |       "engines": {
 680 |         "node": ">=18"
 681 |       }
 682 |     },
 683 |     "node_modules/@esbuild/openharmony-arm64": {
 684 |       "version": "0.25.12",
 685 |       "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.25.12.tgz",
 686 |       "integrity": "sha512-rm0YWsqUSRrjncSXGA7Zv78Nbnw4XL6/dzr20cyrQf7ZmRcsovpcRBdhD43Nuk3y7XIoW2OxMVvwuRvk9XdASg==",
 687 |       "cpu": [
 688 |         "arm64"
 689 |       ],
 690 |       "dev": true,
 691 |       "license": "MIT",
 692 |       "optional": true,
 693 |       "os": [
 694 |         "openharmony"
 695 |       ],
 696 |       "engines": {
 697 |         "node": ">=18"
 698 |       }
 699 |     },
 700 |     "node_modules/@esbuild/sunos-x64": {
 701 |       "version": "0.25.12",
 702 |       "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.25.12.tgz",
 703 |       "integrity": "sha512-3wGSCDyuTHQUzt0nV7bocDy72r2lI33QL3gkDNGkod22EsYl04sMf0qLb8luNKTOmgF/eDEDP5BFNwoBKH441w==",
 704 |       "cpu": [
 705 |         "x64"
 706 |       ],
 707 |       "dev": true,
 708 |       "license": "MIT",
 709 |       "optional": true,
 710 |       "os": [
 711 |         "sunos"
 712 |       ],
 713 |       "engines": {
 714 |         "node": ">=18"
 715 |       }
 716 |     },
 717 |     "node_modules/@esbuild/win32-arm64": {
 718 |       "version": "0.25.12",
 719 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.25.12.tgz",
 720 |       "integrity": "sha512-rMmLrur64A7+DKlnSuwqUdRKyd3UE7oPJZmnljqEptesKM8wx9J8gx5u0+9Pq0fQQW8vqeKebwNXdfOyP+8Bsg==",
 721 |       "cpu": [
 722 |         "arm64"
 723 |       ],
 724 |       "dev": true,
 725 |       "license": "MIT",
 726 |       "optional": true,
 727 |       "os": [
 728 |         "win32"
 729 |       ],
 730 |       "engines": {
 731 |         "node": ">=18"
 732 |       }
 733 |     },
 734 |     "node_modules/@esbuild/win32-ia32": {
 735 |       "version": "0.25.12",
 736 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.25.12.tgz",
 737 |       "integrity": "sha512-HkqnmmBoCbCwxUKKNPBixiWDGCpQGVsrQfJoVGYLPT41XWF8lHuE5N6WhVia2n4o5QK5M4tYr21827fNhi4byQ==",
 738 |       "cpu": [
 739 |         "ia32"
 740 |       ],
 741 |       "dev": true,
 742 |       "license": "MIT",
 743 |       "optional": true,
 744 |       "os": [
 745 |         "win32"
 746 |       ],
 747 |       "engines": {
 748 |         "node": ">=18"
 749 |       }
 750 |     },
 751 |     "node_modules/@esbuild/win32-x64": {
 752 |       "version": "0.25.12",
 753 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.25.12.tgz",
 754 |       "integrity": "sha512-alJC0uCZpTFrSL0CCDjcgleBXPnCrEAhTBILpeAp7M/OFgoqtAetfBzX0xM00MUsVVPpVjlPuMbREqnZCXaTnA==",
 755 |       "cpu": [
 756 |         "x64"
 757 |       ],
 758 |       "dev": true,
 759 |       "license": "MIT",
 760 |       "optional": true,
 761 |       "os": [
 762 |         "win32"
 763 |       ],
 764 |       "engines": {
 765 |         "node": ">=18"
 766 |       }
 767 |     },
 768 |     "node_modules/@jridgewell/gen-mapping": {
 769 |       "version": "0.3.13",
 770 |       "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
 771 |       "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
 772 |       "dev": true,
 773 |       "license": "MIT",
 774 |       "dependencies": {
 775 |         "@jridgewell/sourcemap-codec": "^1.5.0",
 776 |         "@jridgewell/trace-mapping": "^0.3.24"
 777 |       }
 778 |     },
 779 |     "node_modules/@jridgewell/remapping": {
 780 |       "version": "2.3.5",
 781 |       "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
 782 |       "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
 783 |       "dev": true,
 784 |       "license": "MIT",
 785 |       "dependencies": {
 786 |         "@jridgewell/gen-mapping": "^0.3.5",
 787 |         "@jridgewell/trace-mapping": "^0.3.24"
 788 |       }
 789 |     },
 790 |     "node_modules/@jridgewell/resolve-uri": {
 791 |       "version": "3.1.2",
 792 |       "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
 793 |       "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
 794 |       "dev": true,
 795 |       "license": "MIT",
 796 |       "engines": {
 797 |         "node": ">=6.0.0"
 798 |       }
 799 |     },
 800 |     "node_modules/@jridgewell/sourcemap-codec": {
 801 |       "version": "1.5.5",
 802 |       "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
 803 |       "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
 804 |       "dev": true,
 805 |       "license": "MIT"
 806 |     },
 807 |     "node_modules/@jridgewell/trace-mapping": {
 808 |       "version": "0.3.31",
 809 |       "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
 810 |       "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
 811 |       "dev": true,
 812 |       "license": "MIT",
 813 |       "dependencies": {
 814 |         "@jridgewell/resolve-uri": "^3.1.0",
 815 |         "@jridgewell/sourcemap-codec": "^1.4.14"
 816 |       }
 817 |     },
 818 |     "node_modules/@nodelib/fs.scandir": {
 819 |       "version": "2.1.5",
 820 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
 821 |       "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
 822 |       "dev": true,
 823 |       "license": "MIT",
 824 |       "dependencies": {
 825 |         "@nodelib/fs.stat": "2.0.5",
 826 |         "run-parallel": "^1.1.9"
 827 |       },
 828 |       "engines": {
 829 |         "node": ">= 8"
 830 |       }
 831 |     },
 832 |     "node_modules/@nodelib/fs.stat": {
 833 |       "version": "2.0.5",
 834 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
 835 |       "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
 836 |       "dev": true,
 837 |       "license": "MIT",
 838 |       "engines": {
 839 |         "node": ">= 8"
 840 |       }
 841 |     },
 842 |     "node_modules/@nodelib/fs.walk": {
 843 |       "version": "1.2.8",
 844 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
 845 |       "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
 846 |       "dev": true,
 847 |       "license": "MIT",
 848 |       "dependencies": {
 849 |         "@nodelib/fs.scandir": "2.1.5",
 850 |         "fastq": "^1.6.0"
 851 |       },
 852 |       "engines": {
 853 |         "node": ">= 8"
 854 |       }
 855 |     },
 856 |     "node_modules/@rolldown/pluginutils": {
 857 |       "version": "1.0.0-beta.27",
 858 |       "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.27.tgz",
 859 |       "integrity": "sha512-+d0F4MKMCbeVUJwG96uQ4SgAznZNSq93I3V+9NHA4OpvqG8mRCpGdKmK8l/dl02h2CCDHwW2FqilnTyDcAnqjA==",
 860 |       "dev": true,
 861 |       "license": "MIT"
 862 |     },
 863 |     "node_modules/@rollup/rollup-android-arm-eabi": {
 864 |       "version": "4.55.2",
 865 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.55.2.tgz",
 866 |       "integrity": "sha512-21J6xzayjy3O6NdnlO6aXi/urvSRjm6nCI6+nF6ra2YofKruGixN9kfT+dt55HVNwfDmpDHJcaS3JuP/boNnlA==",
 867 |       "cpu": [
 868 |         "arm"
 869 |       ],
 870 |       "dev": true,
 871 |       "license": "MIT",
 872 |       "optional": true,
 873 |       "os": [
 874 |         "android"
 875 |       ]
 876 |     },
 877 |     "node_modules/@rollup/rollup-android-arm64": {
 878 |       "version": "4.55.2",
 879 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.55.2.tgz",
 880 |       "integrity": "sha512-eXBg7ibkNUZ+sTwbFiDKou0BAckeV6kIigK7y5Ko4mB/5A1KLhuzEKovsmfvsL8mQorkoincMFGnQuIT92SKqA==",
 881 |       "cpu": [
 882 |         "arm64"
 883 |       ],
 884 |       "dev": true,
 885 |       "license": "MIT",
 886 |       "optional": true,
 887 |       "os": [
 888 |         "android"
 889 |       ]
 890 |     },
 891 |     "node_modules/@rollup/rollup-darwin-arm64": {
 892 |       "version": "4.55.2",
 893 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.55.2.tgz",
 894 |       "integrity": "sha512-UCbaTklREjrc5U47ypLulAgg4njaqfOVLU18VrCrI+6E5MQjuG0lSWaqLlAJwsD7NpFV249XgB0Bi37Zh5Sz4g==",
 895 |       "cpu": [
 896 |         "arm64"
 897 |       ],
 898 |       "dev": true,
 899 |       "license": "MIT",
 900 |       "optional": true,
 901 |       "os": [
 902 |         "darwin"
 903 |       ]
 904 |     },
 905 |     "node_modules/@rollup/rollup-darwin-x64": {
 906 |       "version": "4.55.2",
 907 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.55.2.tgz",
 908 |       "integrity": "sha512-dP67MA0cCMHFT2g5XyjtpVOtp7y4UyUxN3dhLdt11at5cPKnSm4lY+EhwNvDXIMzAMIo2KU+mc9wxaAQJTn7sQ==",
 909 |       "cpu": [
 910 |         "x64"
 911 |       ],
 912 |       "dev": true,
 913 |       "license": "MIT",
 914 |       "optional": true,
 915 |       "os": [
 916 |         "darwin"
 917 |       ]
 918 |     },
 919 |     "node_modules/@rollup/rollup-freebsd-arm64": {
 920 |       "version": "4.55.2",
 921 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.55.2.tgz",
 922 |       "integrity": "sha512-WDUPLUwfYV9G1yxNRJdXcvISW15mpvod1Wv3ok+Ws93w1HjIVmCIFxsG2DquO+3usMNCpJQ0wqO+3GhFdl6Fow==",
 923 |       "cpu": [
 924 |         "arm64"
 925 |       ],
 926 |       "dev": true,
 927 |       "license": "MIT",
 928 |       "optional": true,
 929 |       "os": [
 930 |         "freebsd"
 931 |       ]
 932 |     },
 933 |     "node_modules/@rollup/rollup-freebsd-x64": {
 934 |       "version": "4.55.2",
 935 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.55.2.tgz",
 936 |       "integrity": "sha512-Ng95wtHVEulRwn7R0tMrlUuiLVL/HXA8Lt/MYVpy88+s5ikpntzZba1qEulTuPnPIZuOPcW9wNEiqvZxZmgmqQ==",
 937 |       "cpu": [
 938 |         "x64"
 939 |       ],
 940 |       "dev": true,
 941 |       "license": "MIT",
 942 |       "optional": true,
 943 |       "os": [
 944 |         "freebsd"
 945 |       ]
 946 |     },
 947 |     "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
 948 |       "version": "4.55.2",
 949 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.55.2.tgz",
 950 |       "integrity": "sha512-AEXMESUDWWGqD6LwO/HkqCZgUE1VCJ1OhbvYGsfqX2Y6w5quSXuyoy/Fg3nRqiwro+cJYFxiw5v4kB2ZDLhxrw==",
 951 |       "cpu": [
 952 |         "arm"
 953 |       ],
 954 |       "dev": true,
 955 |       "license": "MIT",
 956 |       "optional": true,
 957 |       "os": [
 958 |         "linux"
 959 |       ]
 960 |     },
 961 |     "node_modules/@rollup/rollup-linux-arm-musleabihf": {
 962 |       "version": "4.55.2",
 963 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.55.2.tgz",
 964 |       "integrity": "sha512-ZV7EljjBDwBBBSv570VWj0hiNTdHt9uGznDtznBB4Caj3ch5rgD4I2K1GQrtbvJ/QiB+663lLgOdcADMNVC29Q==",
 965 |       "cpu": [
 966 |         "arm"
 967 |       ],
 968 |       "dev": true,
 969 |       "license": "MIT",
 970 |       "optional": true,
 971 |       "os": [
 972 |         "linux"
 973 |       ]
 974 |     },
 975 |     "node_modules/@rollup/rollup-linux-arm64-gnu": {
 976 |       "version": "4.55.2",
 977 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.55.2.tgz",
 978 |       "integrity": "sha512-uvjwc8NtQVPAJtq4Tt7Q49FOodjfbf6NpqXyW/rjXoV+iZ3EJAHLNAnKT5UJBc6ffQVgmXTUL2ifYiLABlGFqA==",
 979 |       "cpu": [
 980 |         "arm64"
 981 |       ],
 982 |       "dev": true,
 983 |       "license": "MIT",
 984 |       "optional": true,
 985 |       "os": [
 986 |         "linux"
 987 |       ]
 988 |     },
 989 |     "node_modules/@rollup/rollup-linux-arm64-musl": {
 990 |       "version": "4.55.2",
 991 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.55.2.tgz",
 992 |       "integrity": "sha512-s3KoWVNnye9mm/2WpOZ3JeUiediUVw6AvY/H7jNA6qgKA2V2aM25lMkVarTDfiicn/DLq3O0a81jncXszoyCFA==",
 993 |       "cpu": [
 994 |         "arm64"
 995 |       ],
 996 |       "dev": true,
 997 |       "license": "MIT",
 998 |       "optional": true,
 999 |       "os": [
1000 |         "linux"
1001 |       ]
1002 |     },
1003 |     "node_modules/@rollup/rollup-linux-loong64-gnu": {
1004 |       "version": "4.55.2",
1005 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.55.2.tgz",
1006 |       "integrity": "sha512-gi21faacK+J8aVSyAUptML9VQN26JRxe484IbF+h3hpG+sNVoMXPduhREz2CcYr5my0NE3MjVvQ5bMKX71pfVA==",
1007 |       "cpu": [
1008 |         "loong64"
1009 |       ],
1010 |       "dev": true,
1011 |       "license": "MIT",
1012 |       "optional": true,
1013 |       "os": [
1014 |         "linux"
1015 |       ]
1016 |     },
1017 |     "node_modules/@rollup/rollup-linux-loong64-musl": {
1018 |       "version": "4.55.2",
1019 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-musl/-/rollup-linux-loong64-musl-4.55.2.tgz",
1020 |       "integrity": "sha512-qSlWiXnVaS/ceqXNfnoFZh4IiCA0EwvCivivTGbEu1qv2o+WTHpn1zNmCTAoOG5QaVr2/yhCoLScQtc/7RxshA==",
1021 |       "cpu": [
1022 |         "loong64"
1023 |       ],
1024 |       "dev": true,
1025 |       "license": "MIT",
1026 |       "optional": true,
1027 |       "os": [
1028 |         "linux"
1029 |       ]
1030 |     },
1031 |     "node_modules/@rollup/rollup-linux-ppc64-gnu": {
1032 |       "version": "4.55.2",
1033 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.55.2.tgz",
1034 |       "integrity": "sha512-rPyuLFNoF1B0+wolH277E780NUKf+KoEDb3OyoLbAO18BbeKi++YN6gC/zuJoPPDlQRL3fIxHxCxVEWiem2yXw==",
1035 |       "cpu": [
1036 |         "ppc64"
1037 |       ],
1038 |       "dev": true,
1039 |       "license": "MIT",
1040 |       "optional": true,
1041 |       "os": [
1042 |         "linux"
1043 |       ]
1044 |     },
1045 |     "node_modules/@rollup/rollup-linux-ppc64-musl": {
1046 |       "version": "4.55.2",
1047 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-musl/-/rollup-linux-ppc64-musl-4.55.2.tgz",
1048 |       "integrity": "sha512-g+0ZLMook31iWV4PvqKU0i9E78gaZgYpSrYPed/4Bu+nGTgfOPtfs1h11tSSRPXSjC5EzLTjV/1A7L2Vr8pJoQ==",
1049 |       "cpu": [
1050 |         "ppc64"
1051 |       ],
1052 |       "dev": true,
1053 |       "license": "MIT",
1054 |       "optional": true,
1055 |       "os": [
1056 |         "linux"
1057 |       ]
1058 |     },
1059 |     "node_modules/@rollup/rollup-linux-riscv64-gnu": {
1060 |       "version": "4.55.2",
1061 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.55.2.tgz",
1062 |       "integrity": "sha512-i+sGeRGsjKZcQRh3BRfpLsM3LX3bi4AoEVqmGDyc50L6KfYsN45wVCSz70iQMwPWr3E5opSiLOwsC9WB4/1pqg==",
1063 |       "cpu": [
1064 |         "riscv64"
1065 |       ],
1066 |       "dev": true,
1067 |       "license": "MIT",
1068 |       "optional": true,
1069 |       "os": [
1070 |         "linux"
1071 |       ]
1072 |     },
1073 |     "node_modules/@rollup/rollup-linux-riscv64-musl": {
1074 |       "version": "4.55.2",
1075 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.55.2.tgz",
1076 |       "integrity": "sha512-C1vLcKc4MfFV6I0aWsC7B2Y9QcsiEcvKkfxprwkPfLaN8hQf0/fKHwSF2lcYzA9g4imqnhic729VB9Fo70HO3Q==",
1077 |       "cpu": [
1078 |         "riscv64"
1079 |       ],
1080 |       "dev": true,
1081 |       "license": "MIT",
1082 |       "optional": true,
1083 |       "os": [
1084 |         "linux"
1085 |       ]
1086 |     },
1087 |     "node_modules/@rollup/rollup-linux-s390x-gnu": {
1088 |       "version": "4.55.2",
1089 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.55.2.tgz",
1090 |       "integrity": "sha512-68gHUK/howpQjh7g7hlD9DvTTt4sNLp1Bb+Yzw2Ki0xvscm2cOdCLZNJNhd2jW8lsTPrHAHuF751BygifW4bkQ==",
1091 |       "cpu": [
1092 |         "s390x"
1093 |       ],
1094 |       "dev": true,
1095 |       "license": "MIT",
1096 |       "optional": true,
1097 |       "os": [
1098 |         "linux"
1099 |       ]
1100 |     },
1101 |     "node_modules/@rollup/rollup-linux-x64-gnu": {
1102 |       "version": "4.55.2",
1103 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.55.2.tgz",
1104 |       "integrity": "sha512-1e30XAuaBP1MAizaOBApsgeGZge2/Byd6wV4a8oa6jPdHELbRHBiw7wvo4dp7Ie2PE8TZT4pj9RLGZv9N4qwlw==",
1105 |       "cpu": [
1106 |         "x64"
1107 |       ],
1108 |       "dev": true,
1109 |       "license": "MIT",
1110 |       "optional": true,
1111 |       "os": [
1112 |         "linux"
1113 |       ]
1114 |     },
1115 |     "node_modules/@rollup/rollup-linux-x64-musl": {
1116 |       "version": "4.55.2",
1117 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.55.2.tgz",
1118 |       "integrity": "sha512-4BJucJBGbuGnH6q7kpPqGJGzZnYrpAzRd60HQSt3OpX/6/YVgSsJnNzR8Ot74io50SeVT4CtCWe/RYIAymFPwA==",
1119 |       "cpu": [
1120 |         "x64"
1121 |       ],
1122 |       "dev": true,
1123 |       "license": "MIT",
1124 |       "optional": true,
1125 |       "os": [
1126 |         "linux"
1127 |       ]
1128 |     },
1129 |     "node_modules/@rollup/rollup-openbsd-x64": {
1130 |       "version": "4.55.2",
1131 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-openbsd-x64/-/rollup-openbsd-x64-4.55.2.tgz",
1132 |       "integrity": "sha512-cT2MmXySMo58ENv8p6/O6wI/h/gLnD3D6JoajwXFZH6X9jz4hARqUhWpGuQhOgLNXscfZYRQMJvZDtWNzMAIDw==",
1133 |       "cpu": [
1134 |         "x64"
1135 |       ],
1136 |       "dev": true,
1137 |       "license": "MIT",
1138 |       "optional": true,
1139 |       "os": [
1140 |         "openbsd"
1141 |       ]
1142 |     },
1143 |     "node_modules/@rollup/rollup-openharmony-arm64": {
1144 |       "version": "4.55.2",
1145 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.55.2.tgz",
1146 |       "integrity": "sha512-sZnyUgGkuzIXaK3jNMPmUIyJrxu/PjmATQrocpGA1WbCPX8H5tfGgRSuYtqBYAvLuIGp8SPRb1O4d1Fkb5fXaQ==",
1147 |       "cpu": [
1148 |         "arm64"
1149 |       ],
1150 |       "dev": true,
1151 |       "license": "MIT",
1152 |       "optional": true,
1153 |       "os": [
1154 |         "openharmony"
1155 |       ]
1156 |     },
1157 |     "node_modules/@rollup/rollup-win32-arm64-msvc": {
1158 |       "version": "4.55.2",
1159 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.55.2.tgz",
1160 |       "integrity": "sha512-sDpFbenhmWjNcEbBcoTV0PWvW5rPJFvu+P7XoTY0YLGRupgLbFY0XPfwIbJOObzO7QgkRDANh65RjhPmgSaAjQ==",
1161 |       "cpu": [
1162 |         "arm64"
1163 |       ],
1164 |       "dev": true,
1165 |       "license": "MIT",
1166 |       "optional": true,
1167 |       "os": [
1168 |         "win32"
1169 |       ]
1170 |     },
1171 |     "node_modules/@rollup/rollup-win32-ia32-msvc": {
1172 |       "version": "4.55.2",
1173 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.55.2.tgz",
1174 |       "integrity": "sha512-GvJ03TqqaweWCigtKQVBErw2bEhu1tyfNQbarwr94wCGnczA9HF8wqEe3U/Lfu6EdeNP0p6R+APeHVwEqVxpUQ==",
1175 |       "cpu": [
1176 |         "ia32"
1177 |       ],
1178 |       "dev": true,
1179 |       "license": "MIT",
1180 |       "optional": true,
1181 |       "os": [
1182 |         "win32"
1183 |       ]
1184 |     },
1185 |     "node_modules/@rollup/rollup-win32-x64-gnu": {
1186 |       "version": "4.55.2",
1187 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.55.2.tgz",
1188 |       "integrity": "sha512-KvXsBvp13oZz9JGe5NYS7FNizLe99Ny+W8ETsuCyjXiKdiGrcz2/J/N8qxZ/RSwivqjQguug07NLHqrIHrqfYw==",
1189 |       "cpu": [
1190 |         "x64"
1191 |       ],
1192 |       "dev": true,
1193 |       "license": "MIT",
1194 |       "optional": true,
1195 |       "os": [
1196 |         "win32"
1197 |       ]
1198 |     },
1199 |     "node_modules/@rollup/rollup-win32-x64-msvc": {
1200 |       "version": "4.55.2",
1201 |       "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.55.2.tgz",
1202 |       "integrity": "sha512-xNO+fksQhsAckRtDSPWaMeT1uIM+JrDRXlerpnWNXhn1TdB3YZ6uKBMBTKP0eX9XtYEP978hHk1f8332i2AW8Q==",
1203 |       "cpu": [
1204 |         "x64"
1205 |       ],
1206 |       "dev": true,
1207 |       "license": "MIT",
1208 |       "optional": true,
1209 |       "os": [
1210 |         "win32"
1211 |       ]
1212 |     },
1213 |     "node_modules/@types/babel__core": {
1214 |       "version": "7.20.5",
1215 |       "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
1216 |       "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
1217 |       "dev": true,
1218 |       "license": "MIT",
1219 |       "dependencies": {
1220 |         "@babel/parser": "^7.20.7",
1221 |         "@babel/types": "^7.20.7",
1222 |         "@types/babel__generator": "*",
1223 |         "@types/babel__template": "*",
1224 |         "@types/babel__traverse": "*"
1225 |       }
1226 |     },
1227 |     "node_modules/@types/babel__generator": {
1228 |       "version": "7.27.0",
1229 |       "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
1230 |       "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
1231 |       "dev": true,
1232 |       "license": "MIT",
1233 |       "dependencies": {
1234 |         "@babel/types": "^7.0.0"
1235 |       }
1236 |     },
1237 |     "node_modules/@types/babel__template": {
1238 |       "version": "7.4.4",
1239 |       "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
1240 |       "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
1241 |       "dev": true,
1242 |       "license": "MIT",
1243 |       "dependencies": {
1244 |         "@babel/parser": "^7.1.0",
1245 |         "@babel/types": "^7.0.0"
1246 |       }
1247 |     },
1248 |     "node_modules/@types/babel__traverse": {
1249 |       "version": "7.28.0",
1250 |       "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
1251 |       "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
1252 |       "dev": true,
1253 |       "license": "MIT",
1254 |       "dependencies": {
1255 |         "@babel/types": "^7.28.2"
1256 |       }
1257 |     },
1258 |     "node_modules/@types/estree": {
1259 |       "version": "1.0.8",
1260 |       "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
1261 |       "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
1262 |       "dev": true,
1263 |       "license": "MIT"
1264 |     },
1265 |     "node_modules/@types/prop-types": {
1266 |       "version": "15.7.15",
1267 |       "resolved": "https://registry.npmjs.org/@types/prop-types/-/prop-types-15.7.15.tgz",
1268 |       "integrity": "sha512-F6bEyamV9jKGAFBEmlQnesRPGOQqS2+Uwi0Em15xenOxHaf2hv6L8YCVn3rPdPJOiJfPiCnLIRyvwVaqMY3MIw==",
1269 |       "dev": true,
1270 |       "license": "MIT"
1271 |     },
1272 |     "node_modules/@types/react": {
1273 |       "version": "18.3.27",
1274 |       "resolved": "https://registry.npmjs.org/@types/react/-/react-18.3.27.tgz",
1275 |       "integrity": "sha512-cisd7gxkzjBKU2GgdYrTdtQx1SORymWyaAFhaxQPK9bYO9ot3Y5OikQRvY0VYQtvwjeQnizCINJAenh/V7MK2w==",
1276 |       "dev": true,
1277 |       "license": "MIT",
1278 |       "peer": true,
1279 |       "dependencies": {
1280 |         "@types/prop-types": "*",
1281 |         "csstype": "^3.2.2"
1282 |       }
1283 |     },
1284 |     "node_modules/@types/react-dom": {
1285 |       "version": "18.3.7",
1286 |       "resolved": "https://registry.npmjs.org/@types/react-dom/-/react-dom-18.3.7.tgz",
1287 |       "integrity": "sha512-MEe3UeoENYVFXzoXEWsvcpg6ZvlrFNlOQ7EOsvhI3CfAXwzPfO8Qwuxd40nepsYKqyyVQnTdEfv68q91yLcKrQ==",
1288 |       "dev": true,
1289 |       "license": "MIT",
1290 |       "peerDependencies": {
1291 |         "@types/react": "^18.0.0"
1292 |       }
1293 |     },
1294 |     "node_modules/@vitejs/plugin-react": {
1295 |       "version": "4.7.0",
1296 |       "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.7.0.tgz",
1297 |       "integrity": "sha512-gUu9hwfWvvEDBBmgtAowQCojwZmJ5mcLn3aufeCsitijs3+f2NsrPtlAWIR6OPiqljl96GVCUbLe0HyqIpVaoA==",
1298 |       "dev": true,
1299 |       "license": "MIT",
1300 |       "dependencies": {
1301 |         "@babel/core": "^7.28.0",
1302 |         "@babel/plugin-transform-react-jsx-self": "^7.27.1",
1303 |         "@babel/plugin-transform-react-jsx-source": "^7.27.1",
1304 |         "@rolldown/pluginutils": "1.0.0-beta.27",
1305 |         "@types/babel__core": "^7.20.5",
1306 |         "react-refresh": "^0.17.0"
1307 |       },
1308 |       "engines": {
1309 |         "node": "^14.18.0 || >=16.0.0"
1310 |       },
1311 |       "peerDependencies": {
1312 |         "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
1313 |       }
1314 |     },
1315 |     "node_modules/any-promise": {
1316 |       "version": "1.3.0",
1317 |       "resolved": "https://registry.npmjs.org/any-promise/-/any-promise-1.3.0.tgz",
1318 |       "integrity": "sha512-7UvmKalWRt1wgjL1RrGxoSJW/0QZFIegpeGvZG9kjp8vrRu55XTHbwnqq2GpXm9uLbcuhxm3IqX9OB4MZR1b2A==",
1319 |       "dev": true,
1320 |       "license": "MIT"
1321 |     },
1322 |     "node_modules/anymatch": {
1323 |       "version": "3.1.3",
1324 |       "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
1325 |       "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
1326 |       "dev": true,
1327 |       "license": "ISC",
1328 |       "dependencies": {
1329 |         "normalize-path": "^3.0.0",
1330 |         "picomatch": "^2.0.4"
1331 |       },
1332 |       "engines": {
1333 |         "node": ">= 8"
1334 |       }
1335 |     },
1336 |     "node_modules/arg": {
1337 |       "version": "5.0.2",
1338 |       "resolved": "https://registry.npmjs.org/arg/-/arg-5.0.2.tgz",
1339 |       "integrity": "sha512-PYjyFOLKQ9y57JvQ6QLo8dAgNqswh8M1RMJYdQduT6xbWSgK36P/Z/v+p888pM69jMMfS8Xd8F6I1kQ/I9HUGg==",
1340 |       "dev": true,
1341 |       "license": "MIT"
1342 |     },
1343 |     "node_modules/autoprefixer": {
1344 |       "version": "10.4.23",
1345 |       "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.23.tgz",
1346 |       "integrity": "sha512-YYTXSFulfwytnjAPlw8QHncHJmlvFKtczb8InXaAx9Q0LbfDnfEYDE55omerIJKihhmU61Ft+cAOSzQVaBUmeA==",
1347 |       "dev": true,
1348 |       "funding": [
1349 |         {
1350 |           "type": "opencollective",
1351 |           "url": "https://opencollective.com/postcss/"
1352 |         },
1353 |         {
1354 |           "type": "tidelift",
1355 |           "url": "https://tidelift.com/funding/github/npm/autoprefixer"
1356 |         },
1357 |         {
1358 |           "type": "github",
1359 |           "url": "https://github.com/sponsors/ai"
1360 |         }
1361 |       ],
1362 |       "license": "MIT",
1363 |       "dependencies": {
1364 |         "browserslist": "^4.28.1",
1365 |         "caniuse-lite": "^1.0.30001760",
1366 |         "fraction.js": "^5.3.4",
1367 |         "picocolors": "^1.1.1",
1368 |         "postcss-value-parser": "^4.2.0"
1369 |       },
1370 |       "bin": {
1371 |         "autoprefixer": "bin/autoprefixer"
1372 |       },
1373 |       "engines": {
1374 |         "node": "^10 || ^12 || >=14"
1375 |       },
1376 |       "peerDependencies": {
1377 |         "postcss": "^8.1.0"
1378 |       }
1379 |     },
1380 |     "node_modules/baseline-browser-mapping": {
1381 |       "version": "2.9.15",
1382 |       "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.9.15.tgz",
1383 |       "integrity": "sha512-kX8h7K2srmDyYnXRIppo4AH/wYgzWVCs+eKr3RusRSQ5PvRYoEFmR/I0PbdTjKFAoKqp5+kbxnNTFO9jOfSVJg==",
1384 |       "dev": true,
1385 |       "license": "Apache-2.0",
1386 |       "bin": {
1387 |         "baseline-browser-mapping": "dist/cli.js"
1388 |       }
1389 |     },
1390 |     "node_modules/binary-extensions": {
1391 |       "version": "2.3.0",
1392 |       "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
1393 |       "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
1394 |       "dev": true,
1395 |       "license": "MIT",
1396 |       "engines": {
1397 |         "node": ">=8"
1398 |       },
1399 |       "funding": {
1400 |         "url": "https://github.com/sponsors/sindresorhus"
1401 |       }
1402 |     },
1403 |     "node_modules/braces": {
1404 |       "version": "3.0.3",
1405 |       "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
1406 |       "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
1407 |       "dev": true,
1408 |       "license": "MIT",
1409 |       "dependencies": {
1410 |         "fill-range": "^7.1.1"
1411 |       },
1412 |       "engines": {
1413 |         "node": ">=8"
1414 |       }
1415 |     },
1416 |     "node_modules/browserslist": {
1417 |       "version": "4.28.1",
1418 |       "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.1.tgz",
1419 |       "integrity": "sha512-ZC5Bd0LgJXgwGqUknZY/vkUQ04r8NXnJZ3yYi4vDmSiZmC/pdSN0NbNRPxZpbtO4uAfDUAFffO8IZoM3Gj8IkA==",
1420 |       "dev": true,
1421 |       "funding": [
1422 |         {
1423 |           "type": "opencollective",
1424 |           "url": "https://opencollective.com/browserslist"
1425 |         },
1426 |         {
1427 |           "type": "tidelift",
1428 |           "url": "https://tidelift.com/funding/github/npm/browserslist"
1429 |         },
1430 |         {
1431 |           "type": "github",
1432 |           "url": "https://github.com/sponsors/ai"
1433 |         }
1434 |       ],
1435 |       "license": "MIT",
1436 |       "peer": true,
1437 |       "dependencies": {
1438 |         "baseline-browser-mapping": "^2.9.0",
1439 |         "caniuse-lite": "^1.0.30001759",
1440 |         "electron-to-chromium": "^1.5.263",
1441 |         "node-releases": "^2.0.27",
1442 |         "update-browserslist-db": "^1.2.0"
1443 |       },
1444 |       "bin": {
1445 |         "browserslist": "cli.js"
1446 |       },
1447 |       "engines": {
1448 |         "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
1449 |       }
1450 |     },
1451 |     "node_modules/camelcase-css": {
1452 |       "version": "2.0.1",
1453 |       "resolved": "https://registry.npmjs.org/camelcase-css/-/camelcase-css-2.0.1.tgz",
1454 |       "integrity": "sha512-QOSvevhslijgYwRx6Rv7zKdMF8lbRmx+uQGx2+vDc+KI/eBnsy9kit5aj23AgGu3pa4t9AgwbnXWqS+iOY+2aA==",
1455 |       "dev": true,
1456 |       "license": "MIT",
1457 |       "engines": {
1458 |         "node": ">= 6"
1459 |       }
1460 |     },
1461 |     "node_modules/caniuse-lite": {
1462 |       "version": "1.0.30001765",
1463 |       "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001765.tgz",
1464 |       "integrity": "sha512-LWcNtSyZrakjECqmpP4qdg0MMGdN368D7X8XvvAqOcqMv0RxnlqVKZl2V6/mBR68oYMxOZPLw/gO7DuisMHUvQ==",
1465 |       "dev": true,
1466 |       "funding": [
1467 |         {
1468 |           "type": "opencollective",
1469 |           "url": "https://opencollective.com/browserslist"
1470 |         },
1471 |         {
1472 |           "type": "tidelift",
1473 |           "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
1474 |         },
1475 |         {
1476 |           "type": "github",
1477 |           "url": "https://github.com/sponsors/ai"
1478 |         }
1479 |       ],
1480 |       "license": "CC-BY-4.0"
1481 |     },
1482 |     "node_modules/chokidar": {
1483 |       "version": "3.6.0",
1484 |       "resolved": "https://registry.npmjs.org/chokidar/-/chokidar-3.6.0.tgz",
1485 |       "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
1486 |       "dev": true,
1487 |       "license": "MIT",
1488 |       "dependencies": {
1489 |         "anymatch": "~3.1.2",
1490 |         "braces": "~3.0.2",
1491 |         "glob-parent": "~5.1.2",
1492 |         "is-binary-path": "~2.1.0",
1493 |         "is-glob": "~4.0.1",
1494 |         "normalize-path": "~3.0.0",
1495 |         "readdirp": "~3.6.0"
1496 |       },
1497 |       "engines": {
1498 |         "node": ">= 8.10.0"
1499 |       },
1500 |       "funding": {
1501 |         "url": "https://paulmillr.com/funding/"
1502 |       },
1503 |       "optionalDependencies": {
1504 |         "fsevents": "~2.3.2"
1505 |       }
1506 |     },
1507 |     "node_modules/chokidar/node_modules/glob-parent": {
1508 |       "version": "5.1.2",
1509 |       "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
1510 |       "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
1511 |       "dev": true,
1512 |       "license": "ISC",
1513 |       "dependencies": {
1514 |         "is-glob": "^4.0.1"
1515 |       },
1516 |       "engines": {
1517 |         "node": ">= 6"
1518 |       }
1519 |     },
1520 |     "node_modules/class-variance-authority": {
1521 |       "version": "0.7.1",
1522 |       "resolved": "https://registry.npmjs.org/class-variance-authority/-/class-variance-authority-0.7.1.tgz",
1523 |       "integrity": "sha512-Ka+9Trutv7G8M6WT6SeiRWz792K5qEqIGEGzXKhAE6xOWAY6pPH8U+9IY3oCMv6kqTmLsv7Xh/2w2RigkePMsg==",
1524 |       "license": "Apache-2.0",
1525 |       "dependencies": {
1526 |         "clsx": "^2.1.1"
1527 |       },
1528 |       "funding": {
1529 |         "url": "https://polar.sh/cva"
1530 |       }
1531 |     },
1532 |     "node_modules/clsx": {
1533 |       "version": "2.1.1",
1534 |       "resolved": "https://registry.npmjs.org/clsx/-/clsx-2.1.1.tgz",
1535 |       "integrity": "sha512-eYm0QWBtUrBWZWG0d386OGAw16Z995PiOVo2B7bjWSbHedGl5e0ZWaq65kOGgUSNesEIDkB9ISbTg/JK9dhCZA==",
1536 |       "license": "MIT",
1537 |       "engines": {
1538 |         "node": ">=6"
1539 |       }
1540 |     },
1541 |     "node_modules/commander": {
1542 |       "version": "4.1.1",
1543 |       "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
1544 |       "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA==",
1545 |       "dev": true,
1546 |       "license": "MIT",
1547 |       "engines": {
1548 |         "node": ">= 6"
1549 |       }
1550 |     },
1551 |     "node_modules/convert-source-map": {
1552 |       "version": "2.0.0",
1553 |       "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
1554 |       "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
1555 |       "dev": true,
1556 |       "license": "MIT"
1557 |     },
1558 |     "node_modules/cookie": {
1559 |       "version": "1.1.1",
1560 |       "resolved": "https://registry.npmjs.org/cookie/-/cookie-1.1.1.tgz",
1561 |       "integrity": "sha512-ei8Aos7ja0weRpFzJnEA9UHJ/7XQmqglbRwnf2ATjcB9Wq874VKH9kfjjirM6UhU2/E5fFYadylyhFldcqSidQ==",
1562 |       "license": "MIT",
1563 |       "engines": {
1564 |         "node": ">=18"
1565 |       },
1566 |       "funding": {
1567 |         "type": "opencollective",
1568 |         "url": "https://opencollective.com/express"
1569 |       }
1570 |     },
1571 |     "node_modules/cssesc": {
1572 |       "version": "3.0.0",
1573 |       "resolved": "https://registry.npmjs.org/cssesc/-/cssesc-3.0.0.tgz",
1574 |       "integrity": "sha512-/Tb/JcjK111nNScGob5MNtsntNM1aCNUDipB/TkwZFhyDrrE47SOx/18wF2bbjgc3ZzCSKW1T5nt5EbFoAz/Vg==",
1575 |       "dev": true,
1576 |       "license": "MIT",
1577 |       "bin": {
1578 |         "cssesc": "bin/cssesc"
1579 |       },
1580 |       "engines": {
1581 |         "node": ">=4"
1582 |       }
1583 |     },
1584 |     "node_modules/csstype": {
1585 |       "version": "3.2.3",
1586 |       "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.2.3.tgz",
1587 |       "integrity": "sha512-z1HGKcYy2xA8AGQfwrn0PAy+PB7X/GSj3UVJW9qKyn43xWa+gl5nXmU4qqLMRzWVLFC8KusUX8T/0kCiOYpAIQ==",
1588 |       "dev": true,
1589 |       "license": "MIT"
1590 |     },
1591 |     "node_modules/debug": {
1592 |       "version": "4.4.3",
1593 |       "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
1594 |       "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
1595 |       "dev": true,
1596 |       "license": "MIT",
1597 |       "dependencies": {
1598 |         "ms": "^2.1.3"
1599 |       },
1600 |       "engines": {
1601 |         "node": ">=6.0"
1602 |       },
1603 |       "peerDependenciesMeta": {
1604 |         "supports-color": {
1605 |           "optional": true
1606 |         }
1607 |       }
1608 |     },
1609 |     "node_modules/didyoumean": {
1610 |       "version": "1.2.2",
1611 |       "resolved": "https://registry.npmjs.org/didyoumean/-/didyoumean-1.2.2.tgz",
1612 |       "integrity": "sha512-gxtyfqMg7GKyhQmb056K7M3xszy/myH8w+B4RT+QXBQsvAOdc3XymqDDPHx1BgPgsdAA5SIifona89YtRATDzw==",
1613 |       "dev": true,
1614 |       "license": "Apache-2.0"
1615 |     },
1616 |     "node_modules/dlv": {
1617 |       "version": "1.1.3",
1618 |       "resolved": "https://registry.npmjs.org/dlv/-/dlv-1.1.3.tgz",
1619 |       "integrity": "sha512-+HlytyjlPKnIG8XuRG8WvmBP8xs8P71y+SKKS6ZXWoEgLuePxtDoUEiH7WkdePWrQ5JBpE6aoVqfZfJUQkjXwA==",
1620 |       "dev": true,
1621 |       "license": "MIT"
1622 |     },
1623 |     "node_modules/electron-to-chromium": {
1624 |       "version": "1.5.267",
1625 |       "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.267.tgz",
1626 |       "integrity": "sha512-0Drusm6MVRXSOJpGbaSVgcQsuB4hEkMpHXaVstcPmhu5LIedxs1xNK/nIxmQIU/RPC0+1/o0AVZfBTkTNJOdUw==",
1627 |       "dev": true,
1628 |       "license": "ISC"
1629 |     },
1630 |     "node_modules/esbuild": {
1631 |       "version": "0.25.12",
1632 |       "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.25.12.tgz",
1633 |       "integrity": "sha512-bbPBYYrtZbkt6Os6FiTLCTFxvq4tt3JKall1vRwshA3fdVztsLAatFaZobhkBC8/BrPetoa0oksYoKXoG4ryJg==",
1634 |       "dev": true,
1635 |       "hasInstallScript": true,
1636 |       "license": "MIT",
1637 |       "bin": {
1638 |         "esbuild": "bin/esbuild"
1639 |       },
1640 |       "engines": {
1641 |         "node": ">=18"
1642 |       },
1643 |       "optionalDependencies": {
1644 |         "@esbuild/aix-ppc64": "0.25.12",
1645 |         "@esbuild/android-arm": "0.25.12",
1646 |         "@esbuild/android-arm64": "0.25.12",
1647 |         "@esbuild/android-x64": "0.25.12",
1648 |         "@esbuild/darwin-arm64": "0.25.12",
1649 |         "@esbuild/darwin-x64": "0.25.12",
1650 |         "@esbuild/freebsd-arm64": "0.25.12",
1651 |         "@esbuild/freebsd-x64": "0.25.12",
1652 |         "@esbuild/linux-arm": "0.25.12",
1653 |         "@esbuild/linux-arm64": "0.25.12",
1654 |         "@esbuild/linux-ia32": "0.25.12",
1655 |         "@esbuild/linux-loong64": "0.25.12",
1656 |         "@esbuild/linux-mips64el": "0.25.12",
1657 |         "@esbuild/linux-ppc64": "0.25.12",
1658 |         "@esbuild/linux-riscv64": "0.25.12",
1659 |         "@esbuild/linux-s390x": "0.25.12",
1660 |         "@esbuild/linux-x64": "0.25.12",
1661 |         "@esbuild/netbsd-arm64": "0.25.12",
1662 |         "@esbuild/netbsd-x64": "0.25.12",
1663 |         "@esbuild/openbsd-arm64": "0.25.12",
1664 |         "@esbuild/openbsd-x64": "0.25.12",
1665 |         "@esbuild/openharmony-arm64": "0.25.12",
1666 |         "@esbuild/sunos-x64": "0.25.12",
1667 |         "@esbuild/win32-arm64": "0.25.12",
1668 |         "@esbuild/win32-ia32": "0.25.12",
1669 |         "@esbuild/win32-x64": "0.25.12"
1670 |       }
1671 |     },
1672 |     "node_modules/escalade": {
1673 |       "version": "3.2.0",
1674 |       "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
1675 |       "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
1676 |       "dev": true,
1677 |       "license": "MIT",
1678 |       "engines": {
1679 |         "node": ">=6"
1680 |       }
1681 |     },
1682 |     "node_modules/fast-glob": {
1683 |       "version": "3.3.3",
1684 |       "resolved": "https://registry.npmjs.org/fast-glob/-/fast-glob-3.3.3.tgz",
1685 |       "integrity": "sha512-7MptL8U0cqcFdzIzwOTHoilX9x5BrNqye7Z/LuC7kCMRio1EMSyqRK3BEAUD7sXRq4iT4AzTVuZdhgQ2TCvYLg==",
1686 |       "dev": true,
1687 |       "license": "MIT",
1688 |       "dependencies": {
1689 |         "@nodelib/fs.stat": "^2.0.2",
1690 |         "@nodelib/fs.walk": "^1.2.3",
1691 |         "glob-parent": "^5.1.2",
1692 |         "merge2": "^1.3.0",
1693 |         "micromatch": "^4.0.8"
1694 |       },
1695 |       "engines": {
1696 |         "node": ">=8.6.0"
1697 |       }
1698 |     },
1699 |     "node_modules/fast-glob/node_modules/glob-parent": {
1700 |       "version": "5.1.2",
1701 |       "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
1702 |       "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
1703 |       "dev": true,
1704 |       "license": "ISC",
1705 |       "dependencies": {
1706 |         "is-glob": "^4.0.1"
1707 |       },
1708 |       "engines": {
1709 |         "node": ">= 6"
1710 |       }
1711 |     },
1712 |     "node_modules/fastq": {
1713 |       "version": "1.20.1",
1714 |       "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.20.1.tgz",
1715 |       "integrity": "sha512-GGToxJ/w1x32s/D2EKND7kTil4n8OVk/9mycTc4VDza13lOvpUZTGX3mFSCtV9ksdGBVzvsyAVLM6mHFThxXxw==",
1716 |       "dev": true,
1717 |       "license": "ISC",
1718 |       "dependencies": {
1719 |         "reusify": "^1.0.4"
1720 |       }
1721 |     },
1722 |     "node_modules/fill-range": {
1723 |       "version": "7.1.1",
1724 |       "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
1725 |       "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
1726 |       "dev": true,
1727 |       "license": "MIT",
1728 |       "dependencies": {
1729 |         "to-regex-range": "^5.0.1"
1730 |       },
1731 |       "engines": {
1732 |         "node": ">=8"
1733 |       }
1734 |     },
1735 |     "node_modules/fraction.js": {
1736 |       "version": "5.3.4",
1737 |       "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-5.3.4.tgz",
1738 |       "integrity": "sha512-1X1NTtiJphryn/uLQz3whtY6jK3fTqoE3ohKs0tT+Ujr1W59oopxmoEh7Lu5p6vBaPbgoM0bzveAW4Qi5RyWDQ==",
1739 |       "dev": true,
1740 |       "license": "MIT",
1741 |       "engines": {
1742 |         "node": "*"
1743 |       },
1744 |       "funding": {
1745 |         "type": "github",
1746 |         "url": "https://github.com/sponsors/rawify"
1747 |       }
1748 |     },
1749 |     "node_modules/fsevents": {
1750 |       "version": "2.3.3",
1751 |       "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
1752 |       "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
1753 |       "dev": true,
1754 |       "hasInstallScript": true,
1755 |       "license": "MIT",
1756 |       "optional": true,
1757 |       "os": [
1758 |         "darwin"
1759 |       ],
1760 |       "engines": {
1761 |         "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
1762 |       }
1763 |     },
1764 |     "node_modules/function-bind": {
1765 |       "version": "1.1.2",
1766 |       "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
1767 |       "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
1768 |       "dev": true,
1769 |       "license": "MIT",
1770 |       "funding": {
1771 |         "url": "https://github.com/sponsors/ljharb"
1772 |       }
1773 |     },
1774 |     "node_modules/gensync": {
1775 |       "version": "1.0.0-beta.2",
1776 |       "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
1777 |       "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
1778 |       "dev": true,
1779 |       "license": "MIT",
1780 |       "engines": {
1781 |         "node": ">=6.9.0"
1782 |       }
1783 |     },
1784 |     "node_modules/glob-parent": {
1785 |       "version": "6.0.2",
1786 |       "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-6.0.2.tgz",
1787 |       "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
1788 |       "dev": true,
1789 |       "license": "ISC",
1790 |       "dependencies": {
1791 |         "is-glob": "^4.0.3"
1792 |       },
1793 |       "engines": {
1794 |         "node": ">=10.13.0"
1795 |       }
1796 |     },
1797 |     "node_modules/hasown": {
1798 |       "version": "2.0.2",
1799 |       "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
1800 |       "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
1801 |       "dev": true,
1802 |       "license": "MIT",
1803 |       "dependencies": {
1804 |         "function-bind": "^1.1.2"
1805 |       },
1806 |       "engines": {
1807 |         "node": ">= 0.4"
1808 |       }
1809 |     },
1810 |     "node_modules/is-binary-path": {
1811 |       "version": "2.1.0",
1812 |       "resolved": "https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz",
1813 |       "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
1814 |       "dev": true,
1815 |       "license": "MIT",
1816 |       "dependencies": {
1817 |         "binary-extensions": "^2.0.0"
1818 |       },
1819 |       "engines": {
1820 |         "node": ">=8"
1821 |       }
1822 |     },
1823 |     "node_modules/is-core-module": {
1824 |       "version": "2.16.1",
1825 |       "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.16.1.tgz",
1826 |       "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
1827 |       "dev": true,
1828 |       "license": "MIT",
1829 |       "dependencies": {
1830 |         "hasown": "^2.0.2"
1831 |       },
1832 |       "engines": {
1833 |         "node": ">= 0.4"
1834 |       },
1835 |       "funding": {
1836 |         "url": "https://github.com/sponsors/ljharb"
1837 |       }
1838 |     },
1839 |     "node_modules/is-extglob": {
1840 |       "version": "2.1.1",
1841 |       "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
1842 |       "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
1843 |       "dev": true,
1844 |       "license": "MIT",
1845 |       "engines": {
1846 |         "node": ">=0.10.0"
1847 |       }
1848 |     },
1849 |     "node_modules/is-glob": {
1850 |       "version": "4.0.3",
1851 |       "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
1852 |       "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
1853 |       "dev": true,
1854 |       "license": "MIT",
1855 |       "dependencies": {
1856 |         "is-extglob": "^2.1.1"
1857 |       },
1858 |       "engines": {
1859 |         "node": ">=0.10.0"
1860 |       }
1861 |     },
1862 |     "node_modules/is-number": {
1863 |       "version": "7.0.0",
1864 |       "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
1865 |       "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
1866 |       "dev": true,
1867 |       "license": "MIT",
1868 |       "engines": {
1869 |         "node": ">=0.12.0"
1870 |       }
1871 |     },
1872 |     "node_modules/jiti": {
1873 |       "version": "1.21.7",
1874 |       "resolved": "https://registry.npmjs.org/jiti/-/jiti-1.21.7.tgz",
1875 |       "integrity": "sha512-/imKNG4EbWNrVjoNC/1H5/9GFy+tqjGBHCaSsN+P2RnPqjsLmv6UD3Ej+Kj8nBWaRAwyk7kK5ZUc+OEatnTR3A==",
1876 |       "dev": true,
1877 |       "license": "MIT",
1878 |       "peer": true,
1879 |       "bin": {
1880 |         "jiti": "bin/jiti.js"
1881 |       }
1882 |     },
1883 |     "node_modules/js-tokens": {
1884 |       "version": "4.0.0",
1885 |       "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
1886 |       "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
1887 |       "license": "MIT"
1888 |     },
1889 |     "node_modules/jsesc": {
1890 |       "version": "3.1.0",
1891 |       "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
1892 |       "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
1893 |       "dev": true,
1894 |       "license": "MIT",
1895 |       "bin": {
1896 |         "jsesc": "bin/jsesc"
1897 |       },
1898 |       "engines": {
1899 |         "node": ">=6"
1900 |       }
1901 |     },
1902 |     "node_modules/json5": {
1903 |       "version": "2.2.3",
1904 |       "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
1905 |       "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
1906 |       "dev": true,
1907 |       "license": "MIT",
1908 |       "bin": {
1909 |         "json5": "lib/cli.js"
1910 |       },
1911 |       "engines": {
1912 |         "node": ">=6"
1913 |       }
1914 |     },
1915 |     "node_modules/lilconfig": {
1916 |       "version": "3.1.3",
1917 |       "resolved": "https://registry.npmjs.org/lilconfig/-/lilconfig-3.1.3.tgz",
1918 |       "integrity": "sha512-/vlFKAoH5Cgt3Ie+JLhRbwOsCQePABiU3tJ1egGvyQ+33R/vcwM2Zl2QR/LzjsBeItPt3oSVXapn+m4nQDvpzw==",
1919 |       "dev": true,
1920 |       "license": "MIT",
1921 |       "engines": {
1922 |         "node": ">=14"
1923 |       },
1924 |       "funding": {
1925 |         "url": "https://github.com/sponsors/antonk52"
1926 |       }
1927 |     },
1928 |     "node_modules/lines-and-columns": {
1929 |       "version": "1.2.4",
1930 |       "resolved": "https://registry.npmjs.org/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
1931 |       "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
1932 |       "dev": true,
1933 |       "license": "MIT"
1934 |     },
1935 |     "node_modules/loose-envify": {
1936 |       "version": "1.4.0",
1937 |       "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
1938 |       "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
1939 |       "license": "MIT",
1940 |       "dependencies": {
1941 |         "js-tokens": "^3.0.0 || ^4.0.0"
1942 |       },
1943 |       "bin": {
1944 |         "loose-envify": "cli.js"
1945 |       }
1946 |     },
1947 |     "node_modules/lru-cache": {
1948 |       "version": "5.1.1",
1949 |       "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
1950 |       "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
1951 |       "dev": true,
1952 |       "license": "ISC",
1953 |       "dependencies": {
1954 |         "yallist": "^3.0.2"
1955 |       }
1956 |     },
1957 |     "node_modules/lucide-react": {
1958 |       "version": "0.469.0",
1959 |       "resolved": "https://registry.npmjs.org/lucide-react/-/lucide-react-0.469.0.tgz",
1960 |       "integrity": "sha512-28vvUnnKQ/dBwiCQtwJw7QauYnE7yd2Cyp4tTTJpvglX4EMpbflcdBgrgToX2j71B3YvugK/NH3BGUk+E/p/Fw==",
1961 |       "license": "ISC",
1962 |       "peerDependencies": {
1963 |         "react": "^16.5.1 || ^17.0.0 || ^18.0.0 || ^19.0.0"
1964 |       }
1965 |     },
1966 |     "node_modules/merge2": {
1967 |       "version": "1.4.1",
1968 |       "resolved": "https://registry.npmjs.org/merge2/-/merge2-1.4.1.tgz",
1969 |       "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
1970 |       "dev": true,
1971 |       "license": "MIT",
1972 |       "engines": {
1973 |         "node": ">= 8"
1974 |       }
1975 |     },
1976 |     "node_modules/micromatch": {
1977 |       "version": "4.0.8",
1978 |       "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
1979 |       "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
1980 |       "dev": true,
1981 |       "license": "MIT",
1982 |       "dependencies": {
1983 |         "braces": "^3.0.3",
1984 |         "picomatch": "^2.3.1"
1985 |       },
1986 |       "engines": {
1987 |         "node": ">=8.6"
1988 |       }
1989 |     },
1990 |     "node_modules/ms": {
1991 |       "version": "2.1.3",
1992 |       "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
1993 |       "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
1994 |       "dev": true,
1995 |       "license": "MIT"
1996 |     },
1997 |     "node_modules/mz": {
1998 |       "version": "2.7.0",
1999 |       "resolved": "https://registry.npmjs.org/mz/-/mz-2.7.0.tgz",
2000 |       "integrity": "sha512-z81GNO7nnYMEhrGh9LeymoE4+Yr0Wn5McHIZMK5cfQCl+NDX08sCZgUc9/6MHni9IWuFLm1Z3HTCXu2z9fN62Q==",
2001 |       "dev": true,
2002 |       "license": "MIT",
2003 |       "dependencies": {
2004 |         "any-promise": "^1.0.0",
2005 |         "object-assign": "^4.0.1",
2006 |         "thenify-all": "^1.0.0"
2007 |       }
2008 |     },
2009 |     "node_modules/nanoid": {
2010 |       "version": "3.3.11",
2011 |       "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
2012 |       "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
2013 |       "dev": true,
2014 |       "funding": [
2015 |         {
2016 |           "type": "github",
2017 |           "url": "https://github.com/sponsors/ai"
2018 |         }
2019 |       ],
2020 |       "license": "MIT",
2021 |       "bin": {
2022 |         "nanoid": "bin/nanoid.cjs"
2023 |       },
2024 |       "engines": {
2025 |         "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
2026 |       }
2027 |     },
2028 |     "node_modules/node-releases": {
2029 |       "version": "2.0.27",
2030 |       "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
2031 |       "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
2032 |       "dev": true,
2033 |       "license": "MIT"
2034 |     },
2035 |     "node_modules/normalize-path": {
2036 |       "version": "3.0.0",
2037 |       "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
2038 |       "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
2039 |       "dev": true,
2040 |       "license": "MIT",
2041 |       "engines": {
2042 |         "node": ">=0.10.0"
2043 |       }
2044 |     },
2045 |     "node_modules/object-assign": {
2046 |       "version": "4.1.1",
2047 |       "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
2048 |       "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
2049 |       "dev": true,
2050 |       "license": "MIT",
2051 |       "engines": {
2052 |         "node": ">=0.10.0"
2053 |       }
2054 |     },
2055 |     "node_modules/object-hash": {
2056 |       "version": "3.0.0",
2057 |       "resolved": "https://registry.npmjs.org/object-hash/-/object-hash-3.0.0.tgz",
2058 |       "integrity": "sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==",
2059 |       "dev": true,
2060 |       "license": "MIT",
2061 |       "engines": {
2062 |         "node": ">= 6"
2063 |       }
2064 |     },
2065 |     "node_modules/path-parse": {
2066 |       "version": "1.0.7",
2067 |       "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
2068 |       "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
2069 |       "dev": true,
2070 |       "license": "MIT"
2071 |     },
2072 |     "node_modules/picocolors": {
2073 |       "version": "1.1.1",
2074 |       "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
2075 |       "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
2076 |       "dev": true,
2077 |       "license": "ISC"
2078 |     },
2079 |     "node_modules/picomatch": {
2080 |       "version": "2.3.1",
2081 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
2082 |       "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
2083 |       "dev": true,
2084 |       "license": "MIT",
2085 |       "engines": {
2086 |         "node": ">=8.6"
2087 |       },
2088 |       "funding": {
2089 |         "url": "https://github.com/sponsors/jonschlinkert"
2090 |       }
2091 |     },
2092 |     "node_modules/pify": {
2093 |       "version": "2.3.0",
2094 |       "resolved": "https://registry.npmjs.org/pify/-/pify-2.3.0.tgz",
2095 |       "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
2096 |       "dev": true,
2097 |       "license": "MIT",
2098 |       "engines": {
2099 |         "node": ">=0.10.0"
2100 |       }
2101 |     },
2102 |     "node_modules/pirates": {
2103 |       "version": "4.0.7",
2104 |       "resolved": "https://registry.npmjs.org/pirates/-/pirates-4.0.7.tgz",
2105 |       "integrity": "sha512-TfySrs/5nm8fQJDcBDuUng3VOUKsd7S+zqvbOTiGXHfxX4wK31ard+hoNuvkicM/2YFzlpDgABOevKSsB4G/FA==",
2106 |       "dev": true,
2107 |       "license": "MIT",
2108 |       "engines": {
2109 |         "node": ">= 6"
2110 |       }
2111 |     },
2112 |     "node_modules/postcss": {
2113 |       "version": "8.5.6",
2114 |       "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
2115 |       "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
2116 |       "dev": true,
2117 |       "funding": [
2118 |         {
2119 |           "type": "opencollective",
2120 |           "url": "https://opencollective.com/postcss/"
2121 |         },
2122 |         {
2123 |           "type": "tidelift",
2124 |           "url": "https://tidelift.com/funding/github/npm/postcss"
2125 |         },
2126 |         {
2127 |           "type": "github",
2128 |           "url": "https://github.com/sponsors/ai"
2129 |         }
2130 |       ],
2131 |       "license": "MIT",
2132 |       "peer": true,
2133 |       "dependencies": {
2134 |         "nanoid": "^3.3.11",
2135 |         "picocolors": "^1.1.1",
2136 |         "source-map-js": "^1.2.1"
2137 |       },
2138 |       "engines": {
2139 |         "node": "^10 || ^12 || >=14"
2140 |       }
2141 |     },
2142 |     "node_modules/postcss-import": {
2143 |       "version": "15.1.0",
2144 |       "resolved": "https://registry.npmjs.org/postcss-import/-/postcss-import-15.1.0.tgz",
2145 |       "integrity": "sha512-hpr+J05B2FVYUAXHeK1YyI267J/dDDhMU6B6civm8hSY1jYJnBXxzKDKDswzJmtLHryrjhnDjqqp/49t8FALew==",
2146 |       "dev": true,
2147 |       "license": "MIT",
2148 |       "dependencies": {
2149 |         "postcss-value-parser": "^4.0.0",
2150 |         "read-cache": "^1.0.0",
2151 |         "resolve": "^1.1.7"
2152 |       },
2153 |       "engines": {
2154 |         "node": ">=14.0.0"
2155 |       },
2156 |       "peerDependencies": {
2157 |         "postcss": "^8.0.0"
2158 |       }
2159 |     },
2160 |     "node_modules/postcss-js": {
2161 |       "version": "4.1.0",
2162 |       "resolved": "https://registry.npmjs.org/postcss-js/-/postcss-js-4.1.0.tgz",
2163 |       "integrity": "sha512-oIAOTqgIo7q2EOwbhb8UalYePMvYoIeRY2YKntdpFQXNosSu3vLrniGgmH9OKs/qAkfoj5oB3le/7mINW1LCfw==",
2164 |       "dev": true,
2165 |       "funding": [
2166 |         {
2167 |           "type": "opencollective",
2168 |           "url": "https://opencollective.com/postcss/"
2169 |         },
2170 |         {
2171 |           "type": "github",
2172 |           "url": "https://github.com/sponsors/ai"
2173 |         }
2174 |       ],
2175 |       "license": "MIT",
2176 |       "dependencies": {
2177 |         "camelcase-css": "^2.0.1"
2178 |       },
2179 |       "engines": {
2180 |         "node": "^12 || ^14 || >= 16"
2181 |       },
2182 |       "peerDependencies": {
2183 |         "postcss": "^8.4.21"
2184 |       }
2185 |     },
2186 |     "node_modules/postcss-load-config": {
2187 |       "version": "6.0.1",
2188 |       "resolved": "https://registry.npmjs.org/postcss-load-config/-/postcss-load-config-6.0.1.tgz",
2189 |       "integrity": "sha512-oPtTM4oerL+UXmx+93ytZVN82RrlY/wPUV8IeDxFrzIjXOLF1pN+EmKPLbubvKHT2HC20xXsCAH2Z+CKV6Oz/g==",
2190 |       "dev": true,
2191 |       "funding": [
2192 |         {
2193 |           "type": "opencollective",
2194 |           "url": "https://opencollective.com/postcss/"
2195 |         },
2196 |         {
2197 |           "type": "github",
2198 |           "url": "https://github.com/sponsors/ai"
2199 |         }
2200 |       ],
2201 |       "license": "MIT",
2202 |       "dependencies": {
2203 |         "lilconfig": "^3.1.1"
2204 |       },
2205 |       "engines": {
2206 |         "node": ">= 18"
2207 |       },
2208 |       "peerDependencies": {
2209 |         "jiti": ">=1.21.0",
2210 |         "postcss": ">=8.0.9",
2211 |         "tsx": "^4.8.1",
2212 |         "yaml": "^2.4.2"
2213 |       },
2214 |       "peerDependenciesMeta": {
2215 |         "jiti": {
2216 |           "optional": true
2217 |         },
2218 |         "postcss": {
2219 |           "optional": true
2220 |         },
2221 |         "tsx": {
2222 |           "optional": true
2223 |         },
2224 |         "yaml": {
2225 |           "optional": true
2226 |         }
2227 |       }
2228 |     },
2229 |     "node_modules/postcss-nested": {
2230 |       "version": "6.2.0",
2231 |       "resolved": "https://registry.npmjs.org/postcss-nested/-/postcss-nested-6.2.0.tgz",
2232 |       "integrity": "sha512-HQbt28KulC5AJzG+cZtj9kvKB93CFCdLvog1WFLf1D+xmMvPGlBstkpTEZfK5+AN9hfJocyBFCNiqyS48bpgzQ==",
2233 |       "dev": true,
2234 |       "funding": [
2235 |         {
2236 |           "type": "opencollective",
2237 |           "url": "https://opencollective.com/postcss/"
2238 |         },
2239 |         {
2240 |           "type": "github",
2241 |           "url": "https://github.com/sponsors/ai"
2242 |         }
2243 |       ],
2244 |       "license": "MIT",
2245 |       "dependencies": {
2246 |         "postcss-selector-parser": "^6.1.1"
2247 |       },
2248 |       "engines": {
2249 |         "node": ">=12.0"
2250 |       },
2251 |       "peerDependencies": {
2252 |         "postcss": "^8.2.14"
2253 |       }
2254 |     },
2255 |     "node_modules/postcss-selector-parser": {
2256 |       "version": "6.1.2",
2257 |       "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.2.tgz",
2258 |       "integrity": "sha512-Q8qQfPiZ+THO/3ZrOrO0cJJKfpYCagtMUkXbnEfmgUjwXg6z/WBeOyS9APBBPCTSiDV+s4SwQGu8yFsiMRIudg==",
2259 |       "dev": true,
2260 |       "license": "MIT",
2261 |       "dependencies": {
2262 |         "cssesc": "^3.0.0",
2263 |         "util-deprecate": "^1.0.2"
2264 |       },
2265 |       "engines": {
2266 |         "node": ">=4"
2267 |       }
2268 |     },
2269 |     "node_modules/postcss-value-parser": {
2270 |       "version": "4.2.0",
2271 |       "resolved": "https://registry.npmjs.org/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
2272 |       "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
2273 |       "dev": true,
2274 |       "license": "MIT"
2275 |     },
2276 |     "node_modules/queue-microtask": {
2277 |       "version": "1.2.3",
2278 |       "resolved": "https://registry.npmjs.org/queue-microtask/-/queue-microtask-1.2.3.tgz",
2279 |       "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
2280 |       "dev": true,
2281 |       "funding": [
2282 |         {
2283 |           "type": "github",
2284 |           "url": "https://github.com/sponsors/feross"
2285 |         },
2286 |         {
2287 |           "type": "patreon",
2288 |           "url": "https://www.patreon.com/feross"
2289 |         },
2290 |         {
2291 |           "type": "consulting",
2292 |           "url": "https://feross.org/support"
2293 |         }
2294 |       ],
2295 |       "license": "MIT"
2296 |     },
2297 |     "node_modules/react": {
2298 |       "version": "18.3.1",
2299 |       "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
2300 |       "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
2301 |       "license": "MIT",
2302 |       "peer": true,
2303 |       "dependencies": {
2304 |         "loose-envify": "^1.1.0"
2305 |       },
2306 |       "engines": {
2307 |         "node": ">=0.10.0"
2308 |       }
2309 |     },
2310 |     "node_modules/react-dom": {
2311 |       "version": "18.3.1",
2312 |       "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
2313 |       "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
2314 |       "license": "MIT",
2315 |       "peer": true,
2316 |       "dependencies": {
2317 |         "loose-envify": "^1.1.0",
2318 |         "scheduler": "^0.23.2"
2319 |       },
2320 |       "peerDependencies": {
2321 |         "react": "^18.3.1"
2322 |       }
2323 |     },
2324 |     "node_modules/react-refresh": {
2325 |       "version": "0.17.0",
2326 |       "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.17.0.tgz",
2327 |       "integrity": "sha512-z6F7K9bV85EfseRCp2bzrpyQ0Gkw1uLoCel9XBVWPg/TjRj94SkJzUTGfOa4bs7iJvBWtQG0Wq7wnI0syw3EBQ==",
2328 |       "dev": true,
2329 |       "license": "MIT",
2330 |       "engines": {
2331 |         "node": ">=0.10.0"
2332 |       }
2333 |     },
2334 |     "node_modules/react-router": {
2335 |       "version": "7.12.0",
2336 |       "resolved": "https://registry.npmjs.org/react-router/-/react-router-7.12.0.tgz",
2337 |       "integrity": "sha512-kTPDYPFzDVGIIGNLS5VJykK0HfHLY5MF3b+xj0/tTyNYL1gF1qs7u67Z9jEhQk2sQ98SUaHxlG31g1JtF7IfVw==",
2338 |       "license": "MIT",
2339 |       "dependencies": {
2340 |         "cookie": "^1.0.1",
2341 |         "set-cookie-parser": "^2.6.0"
2342 |       },
2343 |       "engines": {
2344 |         "node": ">=20.0.0"
2345 |       },
2346 |       "peerDependencies": {
2347 |         "react": ">=18",
2348 |         "react-dom": ">=18"
2349 |       },
2350 |       "peerDependenciesMeta": {
2351 |         "react-dom": {
2352 |           "optional": true
2353 |         }
2354 |       }
2355 |     },
2356 |     "node_modules/react-router-dom": {
2357 |       "version": "7.12.0",
2358 |       "resolved": "https://registry.npmjs.org/react-router-dom/-/react-router-dom-7.12.0.tgz",
2359 |       "integrity": "sha512-pfO9fiBcpEfX4Tx+iTYKDtPbrSLLCbwJ5EqP+SPYQu1VYCXdy79GSj0wttR0U4cikVdlImZuEZ/9ZNCgoaxwBA==",
2360 |       "license": "MIT",
2361 |       "dependencies": {
2362 |         "react-router": "7.12.0"
2363 |       },
2364 |       "engines": {
2365 |         "node": ">=20.0.0"
2366 |       },
2367 |       "peerDependencies": {
2368 |         "react": ">=18",
2369 |         "react-dom": ">=18"
2370 |       }
2371 |     },
2372 |     "node_modules/read-cache": {
2373 |       "version": "1.0.0",
2374 |       "resolved": "https://registry.npmjs.org/read-cache/-/read-cache-1.0.0.tgz",
2375 |       "integrity": "sha512-Owdv/Ft7IjOgm/i0xvNDZ1LrRANRfew4b2prF3OWMQLxLfu3bS8FVhCsrSCMK4lR56Y9ya+AThoTpDCTxCmpRA==",
2376 |       "dev": true,
2377 |       "license": "MIT",
2378 |       "dependencies": {
2379 |         "pify": "^2.3.0"
2380 |       }
2381 |     },
2382 |     "node_modules/readdirp": {
2383 |       "version": "3.6.0",
2384 |       "resolved": "https://registry.npmjs.org/readdirp/-/readdirp-3.6.0.tgz",
2385 |       "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
2386 |       "dev": true,
2387 |       "license": "MIT",
2388 |       "dependencies": {
2389 |         "picomatch": "^2.2.1"
2390 |       },
2391 |       "engines": {
2392 |         "node": ">=8.10.0"
2393 |       }
2394 |     },
2395 |     "node_modules/resolve": {
2396 |       "version": "1.22.11",
2397 |       "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.11.tgz",
2398 |       "integrity": "sha512-RfqAvLnMl313r7c9oclB1HhUEAezcpLjz95wFH4LVuhk9JF/r22qmVP9AMmOU4vMX7Q8pN8jwNg/CSpdFnMjTQ==",
2399 |       "dev": true,
2400 |       "license": "MIT",
2401 |       "dependencies": {
2402 |         "is-core-module": "^2.16.1",
2403 |         "path-parse": "^1.0.7",
2404 |         "supports-preserve-symlinks-flag": "^1.0.0"
2405 |       },
2406 |       "bin": {
2407 |         "resolve": "bin/resolve"
2408 |       },
2409 |       "engines": {
2410 |         "node": ">= 0.4"
2411 |       },
2412 |       "funding": {
2413 |         "url": "https://github.com/sponsors/ljharb"
2414 |       }
2415 |     },
2416 |     "node_modules/reusify": {
2417 |       "version": "1.1.0",
2418 |       "resolved": "https://registry.npmjs.org/reusify/-/reusify-1.1.0.tgz",
2419 |       "integrity": "sha512-g6QUff04oZpHs0eG5p83rFLhHeV00ug/Yf9nZM6fLeUrPguBTkTQOdpAWWspMh55TZfVQDPaN3NQJfbVRAxdIw==",
2420 |       "dev": true,
2421 |       "license": "MIT",
2422 |       "engines": {
2423 |         "iojs": ">=1.0.0",
2424 |         "node": ">=0.10.0"
2425 |       }
2426 |     },
2427 |     "node_modules/rollup": {
2428 |       "version": "4.55.2",
2429 |       "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.55.2.tgz",
2430 |       "integrity": "sha512-PggGy4dhwx5qaW+CKBilA/98Ql9keyfnb7lh4SR6shQ91QQQi1ORJ1v4UinkdP2i87OBs9AQFooQylcrrRfIcg==",
2431 |       "dev": true,
2432 |       "license": "MIT",
2433 |       "dependencies": {
2434 |         "@types/estree": "1.0.8"
2435 |       },
2436 |       "bin": {
2437 |         "rollup": "dist/bin/rollup"
2438 |       },
2439 |       "engines": {
2440 |         "node": ">=18.0.0",
2441 |         "npm": ">=8.0.0"
2442 |       },
2443 |       "optionalDependencies": {
2444 |         "@rollup/rollup-android-arm-eabi": "4.55.2",
2445 |         "@rollup/rollup-android-arm64": "4.55.2",
2446 |         "@rollup/rollup-darwin-arm64": "4.55.2",
2447 |         "@rollup/rollup-darwin-x64": "4.55.2",
2448 |         "@rollup/rollup-freebsd-arm64": "4.55.2",
2449 |         "@rollup/rollup-freebsd-x64": "4.55.2",
2450 |         "@rollup/rollup-linux-arm-gnueabihf": "4.55.2",
2451 |         "@rollup/rollup-linux-arm-musleabihf": "4.55.2",
2452 |         "@rollup/rollup-linux-arm64-gnu": "4.55.2",
2453 |         "@rollup/rollup-linux-arm64-musl": "4.55.2",
2454 |         "@rollup/rollup-linux-loong64-gnu": "4.55.2",
2455 |         "@rollup/rollup-linux-loong64-musl": "4.55.2",
2456 |         "@rollup/rollup-linux-ppc64-gnu": "4.55.2",
2457 |         "@rollup/rollup-linux-ppc64-musl": "4.55.2",
2458 |         "@rollup/rollup-linux-riscv64-gnu": "4.55.2",
2459 |         "@rollup/rollup-linux-riscv64-musl": "4.55.2",
2460 |         "@rollup/rollup-linux-s390x-gnu": "4.55.2",
2461 |         "@rollup/rollup-linux-x64-gnu": "4.55.2",
2462 |         "@rollup/rollup-linux-x64-musl": "4.55.2",
2463 |         "@rollup/rollup-openbsd-x64": "4.55.2",
2464 |         "@rollup/rollup-openharmony-arm64": "4.55.2",
2465 |         "@rollup/rollup-win32-arm64-msvc": "4.55.2",
2466 |         "@rollup/rollup-win32-ia32-msvc": "4.55.2",
2467 |         "@rollup/rollup-win32-x64-gnu": "4.55.2",
2468 |         "@rollup/rollup-win32-x64-msvc": "4.55.2",
2469 |         "fsevents": "~2.3.2"
2470 |       }
2471 |     },
2472 |     "node_modules/run-parallel": {
2473 |       "version": "1.2.0",
2474 |       "resolved": "https://registry.npmjs.org/run-parallel/-/run-parallel-1.2.0.tgz",
2475 |       "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
2476 |       "dev": true,
2477 |       "funding": [
2478 |         {
2479 |           "type": "github",
2480 |           "url": "https://github.com/sponsors/feross"
2481 |         },
2482 |         {
2483 |           "type": "patreon",
2484 |           "url": "https://www.patreon.com/feross"
2485 |         },
2486 |         {
2487 |           "type": "consulting",
2488 |           "url": "https://feross.org/support"
2489 |         }
2490 |       ],
2491 |       "license": "MIT",
2492 |       "dependencies": {
2493 |         "queue-microtask": "^1.2.2"
2494 |       }
2495 |     },
2496 |     "node_modules/scheduler": {
2497 |       "version": "0.23.2",
2498 |       "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
2499 |       "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
2500 |       "license": "MIT",
2501 |       "dependencies": {
2502 |         "loose-envify": "^1.1.0"
2503 |       }
2504 |     },
2505 |     "node_modules/semver": {
2506 |       "version": "6.3.1",
2507 |       "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
2508 |       "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
2509 |       "dev": true,
2510 |       "license": "ISC",
2511 |       "bin": {
2512 |         "semver": "bin/semver.js"
2513 |       }
2514 |     },
2515 |     "node_modules/set-cookie-parser": {
2516 |       "version": "2.7.2",
2517 |       "resolved": "https://registry.npmjs.org/set-cookie-parser/-/set-cookie-parser-2.7.2.tgz",
2518 |       "integrity": "sha512-oeM1lpU/UvhTxw+g3cIfxXHyJRc/uidd3yK1P242gzHds0udQBYzs3y8j4gCCW+ZJ7ad0yctld8RYO+bdurlvw==",
2519 |       "license": "MIT"
2520 |     },
2521 |     "node_modules/source-map-js": {
2522 |       "version": "1.2.1",
2523 |       "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
2524 |       "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
2525 |       "dev": true,
2526 |       "license": "BSD-3-Clause",
2527 |       "engines": {
2528 |         "node": ">=0.10.0"
2529 |       }
2530 |     },
2531 |     "node_modules/sucrase": {
2532 |       "version": "3.35.1",
2533 |       "resolved": "https://registry.npmjs.org/sucrase/-/sucrase-3.35.1.tgz",
2534 |       "integrity": "sha512-DhuTmvZWux4H1UOnWMB3sk0sbaCVOoQZjv8u1rDoTV0HTdGem9hkAZtl4JZy8P2z4Bg0nT+YMeOFyVr4zcG5Tw==",
2535 |       "dev": true,
2536 |       "license": "MIT",
2537 |       "dependencies": {
2538 |         "@jridgewell/gen-mapping": "^0.3.2",
2539 |         "commander": "^4.0.0",
2540 |         "lines-and-columns": "^1.1.6",
2541 |         "mz": "^2.7.0",
2542 |         "pirates": "^4.0.1",
2543 |         "tinyglobby": "^0.2.11",
2544 |         "ts-interface-checker": "^0.1.9"
2545 |       },
2546 |       "bin": {
2547 |         "sucrase": "bin/sucrase",
2548 |         "sucrase-node": "bin/sucrase-node"
2549 |       },
2550 |       "engines": {
2551 |         "node": ">=16 || 14 >=14.17"
2552 |       }
2553 |     },
2554 |     "node_modules/supports-preserve-symlinks-flag": {
2555 |       "version": "1.0.0",
2556 |       "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
2557 |       "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
2558 |       "dev": true,
2559 |       "license": "MIT",
2560 |       "engines": {
2561 |         "node": ">= 0.4"
2562 |       },
2563 |       "funding": {
2564 |         "url": "https://github.com/sponsors/ljharb"
2565 |       }
2566 |     },
2567 |     "node_modules/tailwind-merge": {
2568 |       "version": "2.6.0",
2569 |       "resolved": "https://registry.npmjs.org/tailwind-merge/-/tailwind-merge-2.6.0.tgz",
2570 |       "integrity": "sha512-P+Vu1qXfzediirmHOC3xKGAYeZtPcV9g76X+xg2FD4tYgR71ewMA35Y3sCz3zhiN/dwefRpJX0yBcgwi1fXNQA==",
2571 |       "license": "MIT",
2572 |       "funding": {
2573 |         "type": "github",
2574 |         "url": "https://github.com/sponsors/dcastil"
2575 |       }
2576 |     },
2577 |     "node_modules/tailwindcss": {
2578 |       "version": "3.4.19",
2579 |       "resolved": "https://registry.npmjs.org/tailwindcss/-/tailwindcss-3.4.19.tgz",
2580 |       "integrity": "sha512-3ofp+LL8E+pK/JuPLPggVAIaEuhvIz4qNcf3nA1Xn2o/7fb7s/TYpHhwGDv1ZU3PkBluUVaF8PyCHcm48cKLWQ==",
2581 |       "dev": true,
2582 |       "license": "MIT",
2583 |       "dependencies": {
2584 |         "@alloc/quick-lru": "^5.2.0",
2585 |         "arg": "^5.0.2",
2586 |         "chokidar": "^3.6.0",
2587 |         "didyoumean": "^1.2.2",
2588 |         "dlv": "^1.1.3",
2589 |         "fast-glob": "^3.3.2",
2590 |         "glob-parent": "^6.0.2",
2591 |         "is-glob": "^4.0.3",
2592 |         "jiti": "^1.21.7",
2593 |         "lilconfig": "^3.1.3",
2594 |         "micromatch": "^4.0.8",
2595 |         "normalize-path": "^3.0.0",
2596 |         "object-hash": "^3.0.0",
2597 |         "picocolors": "^1.1.1",
2598 |         "postcss": "^8.4.47",
2599 |         "postcss-import": "^15.1.0",
2600 |         "postcss-js": "^4.0.1",
2601 |         "postcss-load-config": "^4.0.2 || ^5.0 || ^6.0",
2602 |         "postcss-nested": "^6.2.0",
2603 |         "postcss-selector-parser": "^6.1.2",
2604 |         "resolve": "^1.22.8",
2605 |         "sucrase": "^3.35.0"
2606 |       },
2607 |       "bin": {
2608 |         "tailwind": "lib/cli.js",
2609 |         "tailwindcss": "lib/cli.js"
2610 |       },
2611 |       "engines": {
2612 |         "node": ">=14.0.0"
2613 |       }
2614 |     },
2615 |     "node_modules/thenify": {
2616 |       "version": "3.3.1",
2617 |       "resolved": "https://registry.npmjs.org/thenify/-/thenify-3.3.1.tgz",
2618 |       "integrity": "sha512-RVZSIV5IG10Hk3enotrhvz0T9em6cyHBLkH/YAZuKqd8hRkKhSfCGIcP2KUY0EPxndzANBmNllzWPwak+bheSw==",
2619 |       "dev": true,
2620 |       "license": "MIT",
2621 |       "dependencies": {
2622 |         "any-promise": "^1.0.0"
2623 |       }
2624 |     },
2625 |     "node_modules/thenify-all": {
2626 |       "version": "1.6.0",
2627 |       "resolved": "https://registry.npmjs.org/thenify-all/-/thenify-all-1.6.0.tgz",
2628 |       "integrity": "sha512-RNxQH/qI8/t3thXJDwcstUO4zeqo64+Uy/+sNVRBx4Xn2OX+OZ9oP+iJnNFqplFra2ZUVeKCSa2oVWi3T4uVmA==",
2629 |       "dev": true,
2630 |       "license": "MIT",
2631 |       "dependencies": {
2632 |         "thenify": ">= 3.1.0 < 4"
2633 |       },
2634 |       "engines": {
2635 |         "node": ">=0.8"
2636 |       }
2637 |     },
2638 |     "node_modules/tinyglobby": {
2639 |       "version": "0.2.15",
2640 |       "resolved": "https://registry.npmjs.org/tinyglobby/-/tinyglobby-0.2.15.tgz",
2641 |       "integrity": "sha512-j2Zq4NyQYG5XMST4cbs02Ak8iJUdxRM0XI5QyxXuZOzKOINmWurp3smXu3y5wDcJrptwpSjgXHzIQxR0omXljQ==",
2642 |       "dev": true,
2643 |       "license": "MIT",
2644 |       "dependencies": {
2645 |         "fdir": "^6.5.0",
2646 |         "picomatch": "^4.0.3"
2647 |       },
2648 |       "engines": {
2649 |         "node": ">=12.0.0"
2650 |       },
2651 |       "funding": {
2652 |         "url": "https://github.com/sponsors/SuperchupuDev"
2653 |       }
2654 |     },
2655 |     "node_modules/tinyglobby/node_modules/fdir": {
2656 |       "version": "6.5.0",
2657 |       "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
2658 |       "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
2659 |       "dev": true,
2660 |       "license": "MIT",
2661 |       "engines": {
2662 |         "node": ">=12.0.0"
2663 |       },
2664 |       "peerDependencies": {
2665 |         "picomatch": "^3 || ^4"
2666 |       },
2667 |       "peerDependenciesMeta": {
2668 |         "picomatch": {
2669 |           "optional": true
2670 |         }
2671 |       }
2672 |     },
2673 |     "node_modules/tinyglobby/node_modules/picomatch": {
2674 |       "version": "4.0.3",
2675 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
2676 |       "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
2677 |       "dev": true,
2678 |       "license": "MIT",
2679 |       "peer": true,
2680 |       "engines": {
2681 |         "node": ">=12"
2682 |       },
2683 |       "funding": {
2684 |         "url": "https://github.com/sponsors/jonschlinkert"
2685 |       }
2686 |     },
2687 |     "node_modules/to-regex-range": {
2688 |       "version": "5.0.1",
2689 |       "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
2690 |       "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
2691 |       "dev": true,
2692 |       "license": "MIT",
2693 |       "dependencies": {
2694 |         "is-number": "^7.0.0"
2695 |       },
2696 |       "engines": {
2697 |         "node": ">=8.0"
2698 |       }
2699 |     },
2700 |     "node_modules/ts-interface-checker": {
2701 |       "version": "0.1.13",
2702 |       "resolved": "https://registry.npmjs.org/ts-interface-checker/-/ts-interface-checker-0.1.13.tgz",
2703 |       "integrity": "sha512-Y/arvbn+rrz3JCKl9C4kVNfTfSm2/mEp5FSz5EsZSANGPSlQrpRI5M4PKF+mJnE52jOO90PnPSc3Ur3bTQw0gA==",
2704 |       "dev": true,
2705 |       "license": "Apache-2.0"
2706 |     },
2707 |     "node_modules/typescript": {
2708 |       "version": "5.6.3",
2709 |       "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.6.3.tgz",
2710 |       "integrity": "sha512-hjcS1mhfuyi4WW8IWtjP7brDrG2cuDZukyrYrSauoXGNgx0S7zceP07adYkJycEr56BOUTNPzbInooiN3fn1qw==",
2711 |       "dev": true,
2712 |       "license": "Apache-2.0",
2713 |       "bin": {
2714 |         "tsc": "bin/tsc",
2715 |         "tsserver": "bin/tsserver"
2716 |       },
2717 |       "engines": {
2718 |         "node": ">=14.17"
2719 |       }
2720 |     },
2721 |     "node_modules/update-browserslist-db": {
2722 |       "version": "1.2.3",
2723 |       "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.2.3.tgz",
2724 |       "integrity": "sha512-Js0m9cx+qOgDxo0eMiFGEueWztz+d4+M3rGlmKPT+T4IS/jP4ylw3Nwpu6cpTTP8R1MAC1kF4VbdLt3ARf209w==",
2725 |       "dev": true,
2726 |       "funding": [
2727 |         {
2728 |           "type": "opencollective",
2729 |           "url": "https://opencollective.com/browserslist"
2730 |         },
2731 |         {
2732 |           "type": "tidelift",
2733 |           "url": "https://tidelift.com/funding/github/npm/browserslist"
2734 |         },
2735 |         {
2736 |           "type": "github",
2737 |           "url": "https://github.com/sponsors/ai"
2738 |         }
2739 |       ],
2740 |       "license": "MIT",
2741 |       "dependencies": {
2742 |         "escalade": "^3.2.0",
2743 |         "picocolors": "^1.1.1"
2744 |       },
2745 |       "bin": {
2746 |         "update-browserslist-db": "cli.js"
2747 |       },
2748 |       "peerDependencies": {
2749 |         "browserslist": ">= 4.21.0"
2750 |       }
2751 |     },
2752 |     "node_modules/util-deprecate": {
2753 |       "version": "1.0.2",
2754 |       "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
2755 |       "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
2756 |       "dev": true,
2757 |       "license": "MIT"
2758 |     },
2759 |     "node_modules/vite": {
2760 |       "version": "6.4.1",
2761 |       "resolved": "https://registry.npmjs.org/vite/-/vite-6.4.1.tgz",
2762 |       "integrity": "sha512-+Oxm7q9hDoLMyJOYfUYBuHQo+dkAloi33apOPP56pzj+vsdJDzr+j1NISE5pyaAuKL4A3UD34qd0lx5+kfKp2g==",
2763 |       "dev": true,
2764 |       "license": "MIT",
2765 |       "peer": true,
2766 |       "dependencies": {
2767 |         "esbuild": "^0.25.0",
2768 |         "fdir": "^6.4.4",
2769 |         "picomatch": "^4.0.2",
2770 |         "postcss": "^8.5.3",
2771 |         "rollup": "^4.34.9",
2772 |         "tinyglobby": "^0.2.13"
2773 |       },
2774 |       "bin": {
2775 |         "vite": "bin/vite.js"
2776 |       },
2777 |       "engines": {
2778 |         "node": "^18.0.0 || ^20.0.0 || >=22.0.0"
2779 |       },
2780 |       "funding": {
2781 |         "url": "https://github.com/vitejs/vite?sponsor=1"
2782 |       },
2783 |       "optionalDependencies": {
2784 |         "fsevents": "~2.3.3"
2785 |       },
2786 |       "peerDependencies": {
2787 |         "@types/node": "^18.0.0 || ^20.0.0 || >=22.0.0",
2788 |         "jiti": ">=1.21.0",
2789 |         "less": "*",
2790 |         "lightningcss": "^1.21.0",
2791 |         "sass": "*",
2792 |         "sass-embedded": "*",
2793 |         "stylus": "*",
2794 |         "sugarss": "*",
2795 |         "terser": "^5.16.0",
2796 |         "tsx": "^4.8.1",
2797 |         "yaml": "^2.4.2"
2798 |       },
2799 |       "peerDependenciesMeta": {
2800 |         "@types/node": {
2801 |           "optional": true
2802 |         },
2803 |         "jiti": {
2804 |           "optional": true
2805 |         },
2806 |         "less": {
2807 |           "optional": true
2808 |         },
2809 |         "lightningcss": {
2810 |           "optional": true
2811 |         },
2812 |         "sass": {
2813 |           "optional": true
2814 |         },
2815 |         "sass-embedded": {
2816 |           "optional": true
2817 |         },
2818 |         "stylus": {
2819 |           "optional": true
2820 |         },
2821 |         "sugarss": {
2822 |           "optional": true
2823 |         },
2824 |         "terser": {
2825 |           "optional": true
2826 |         },
2827 |         "tsx": {
2828 |           "optional": true
2829 |         },
2830 |         "yaml": {
2831 |           "optional": true
2832 |         }
2833 |       }
2834 |     },
2835 |     "node_modules/vite/node_modules/fdir": {
2836 |       "version": "6.5.0",
2837 |       "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
2838 |       "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
2839 |       "dev": true,
2840 |       "license": "MIT",
2841 |       "engines": {
2842 |         "node": ">=12.0.0"
2843 |       },
2844 |       "peerDependencies": {
2845 |         "picomatch": "^3 || ^4"
2846 |       },
2847 |       "peerDependenciesMeta": {
2848 |         "picomatch": {
2849 |           "optional": true
2850 |         }
2851 |       }
2852 |     },
2853 |     "node_modules/vite/node_modules/picomatch": {
2854 |       "version": "4.0.3",
2855 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
2856 |       "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
2857 |       "dev": true,
2858 |       "license": "MIT",
2859 |       "peer": true,
2860 |       "engines": {
2861 |         "node": ">=12"
2862 |       },
2863 |       "funding": {
2864 |         "url": "https://github.com/sponsors/jonschlinkert"
2865 |       }
2866 |     },
2867 |     "node_modules/yallist": {
2868 |       "version": "3.1.1",
2869 |       "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
2870 |       "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
2871 |       "dev": true,
2872 |       "license": "ISC"
2873 |     }
2874 |   }
2875 | }
2876 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/package.json`
**Typ:** JSON  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```json
 1 | {
 2 |   "name": "fbwatcher-panel",
 3 |   "private": true,
 4 |   "version": "0.0.1",
 5 |   "type": "module",
 6 |   "scripts": {
 7 |     "dev": "vite",
 8 |     "build": "tsc -b && vite build",
 9 |     "lint": "eslint .",
10 |     "preview": "vite preview"
11 |   },
12 |   "dependencies": {
13 |     "react": "^18.3.1",
14 |     "react-dom": "^18.3.1",
15 |     "react-router-dom": "^7.1.1",
16 |     "lucide-react": "^0.469.0",
17 |     "clsx": "^2.1.1",
18 |     "tailwind-merge": "^2.6.0",
19 |     "class-variance-authority": "^0.7.1"
20 |   },
21 |   "devDependencies": {
22 |     "@types/react": "^18.3.18",
23 |     "@types/react-dom": "^18.3.5",
24 |     "@vitejs/plugin-react": "^4.3.4",
25 |     "autoprefixer": "^10.4.20",
26 |     "postcss": "^8.4.49",
27 |     "tailwindcss": "^3.4.17",
28 |     "typescript": "~5.6.2",
29 |     "vite": "^6.0.5"
30 |   }
31 | }
32 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/App.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { BrowserRouter, Routes, Route } from 'react-router-dom'
 2 | import { AuthProvider } from '@/hooks/useAuth'
 3 | import { DashboardLayout } from '@/components/layout/DashboardLayout'
 4 | import { Dashboard } from '@/pages/Dashboard'
 5 | import { Watched } from '@/pages/Watched'
 6 | import { Sources } from '@/pages/Sources'
 7 | import { Discoveries } from '@/pages/Discoveries'
 8 | import { Campaigns } from '@/pages/Campaigns'
 9 | import { Cookies } from '@/pages/Cookies'
10 | import { Settings } from '@/pages/Settings'
11 | import { Logs } from '@/pages/Logs'
12 | 
13 | export default function App() {
14 |   return (
15 |     <AuthProvider>
16 |       <BrowserRouter basename="/new">
17 |         <Routes>
18 |           <Route element={<DashboardLayout />}>
19 |             <Route path="/" element={<Dashboard />} />
20 |             <Route path="/watched" element={<Watched />} />
21 |             <Route path="/sources" element={<Sources />} />
22 |             <Route path="/discoveries" element={<Discoveries />} />
23 |             <Route path="/campaigns" element={<Campaigns />} />
24 |             <Route path="/cookies" element={<Cookies />} />
25 |             <Route path="/settings" element={<Settings />} />
26 |             <Route path="/logs" element={<Logs />} />
27 |           </Route>
28 |         </Routes>
29 |       </BrowserRouter>
30 |     </AuthProvider>
31 |   )
32 | }
33 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/DashboardLayout.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { useState, useEffect } from 'react'
 2 | import { Outlet, useLocation } from 'react-router-dom'
 3 | import { Sidebar } from './Sidebar'
 4 | import { Header } from './Header'
 5 | import { MobileNav } from './MobileNav'
 6 | 
 7 | const PAGE_TITLES: Record<string, string> = {
 8 |   '/': 'Dashboard',
 9 |   '/watched': 'Obserwowane posty',
10 |   '/sources': 'Zrodla',
11 |   '/discoveries': 'Wykrycia',
12 |   '/campaigns': 'Kampanie',
13 |   '/cookies': 'Sesje / Cookies',
14 |   '/settings': 'Ustawienia',
15 |   '/logs': 'Logi',
16 | }
17 | 
18 | export function DashboardLayout() {
19 |   const [mobileNavOpen, setMobileNavOpen] = useState(false)
20 |   const location = useLocation()
21 | 
22 |   const pageTitle = PAGE_TITLES[location.pathname] || 'FB Watcher'
23 | 
24 |   // Close mobile nav on route change
25 |   useEffect(() => {
26 |     setMobileNavOpen(false)
27 |   }, [location.pathname])
28 | 
29 |   return (
30 |     <div className="grid min-h-screen w-full md:grid-cols-[220px_1fr] lg:grid-cols-[280px_1fr]">
31 |       {/* Desktop sidebar */}
32 |       <div className="hidden border-r bg-muted/40 md:block">
33 |         <Sidebar />
34 |       </div>
35 | 
36 |       {/* Mobile nav */}
37 |       <MobileNav open={mobileNavOpen} onClose={() => setMobileNavOpen(false)} />
38 | 
39 |       {/* Main content */}
40 |       <div className="flex flex-col">
41 |         <Header title={pageTitle} onMenuClick={() => setMobileNavOpen(true)} />
42 |         <main className="flex flex-1 flex-col gap-4 p-4 lg:gap-6 lg:p-6">
43 |           <Outlet />
44 |         </main>
45 |       </div>
46 |     </div>
47 |   )
48 | }
49 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Header.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { Menu } from 'lucide-react'
 2 | import { Button } from '@/components/ui/button'
 3 | 
 4 | interface HeaderProps {
 5 |   title: string
 6 |   onMenuClick?: () => void
 7 | }
 8 | 
 9 | export function Header({ title, onMenuClick }: HeaderProps) {
10 |   return (
11 |     <header className="flex h-14 items-center gap-4 border-b bg-background px-4 lg:h-[60px] lg:px-6">
12 |       <Button
13 |         variant="ghost"
14 |         size="icon"
15 |         className="shrink-0 md:hidden"
16 |         onClick={onMenuClick}
17 |       >
18 |         <Menu className="h-5 w-5" />
19 |         <span className="sr-only">Menu</span>
20 |       </Button>
21 |       <div className="flex-1">
22 |         <h1 className="text-lg font-semibold md:text-xl">{title}</h1>
23 |       </div>
24 |     </header>
25 |   )
26 | }
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/MobileNav.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { X } from 'lucide-react'
 2 | import { Button } from '@/components/ui/button'
 3 | import { Sidebar } from './Sidebar'
 4 | import { cn } from '@/lib/utils'
 5 | 
 6 | interface MobileNavProps {
 7 |   open: boolean
 8 |   onClose: () => void
 9 | }
10 | 
11 | export function MobileNav({ open, onClose }: MobileNavProps) {
12 |   return (
13 |     <>
14 |       {/* Overlay */}
15 |       <div
16 |         className={cn(
17 |           'fixed inset-0 z-40 bg-black/80 transition-opacity md:hidden',
18 |           open ? 'opacity-100' : 'opacity-0 pointer-events-none'
19 |         )}
20 |         onClick={onClose}
21 |       />
22 | 
23 |       {/* Sidebar */}
24 |       <div
25 |         className={cn(
26 |           'fixed inset-y-0 left-0 z-50 w-72 bg-background transition-transform md:hidden',
27 |           open ? 'translate-x-0' : '-translate-x-full'
28 |         )}
29 |       >
30 |         <Button
31 |           variant="ghost"
32 |           size="icon"
33 |           className="absolute right-2 top-2"
34 |           onClick={onClose}
35 |         >
36 |           <X className="h-5 w-5" />
37 |         </Button>
38 |         <Sidebar />
39 |       </div>
40 |     </>
41 |   )
42 | }
43 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Sidebar.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { NavLink } from 'react-router-dom'
  2 | import {
  3 |   Home,
  4 |   Bell,
  5 |   Eye,
  6 |   Globe,
  7 |   Megaphone,
  8 |   Cookie,
  9 |   Settings,
 10 |   Terminal,
 11 | } from 'lucide-react'
 12 | import { cn } from '@/lib/utils'
 13 | import { Badge } from '@/components/ui/badge'
 14 | import { Separator } from '@/components/ui/separator'
 15 | 
 16 | interface NavItemProps {
 17 |   to: string
 18 |   icon: React.ReactNode
 19 |   label: string
 20 |   badge?: number
 21 |   disabled?: boolean
 22 | }
 23 | 
 24 | function NavItem({ to, icon, label, badge, disabled }: NavItemProps) {
 25 |   if (disabled) {
 26 |     return (
 27 |       <div className="flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground/50 cursor-not-allowed">
 28 |         {icon}
 29 |         <span className="flex-1">{label}</span>
 30 |         <Badge variant="outline" className="text-xs opacity-50">
 31 |           Wkrotce
 32 |         </Badge>
 33 |       </div>
 34 |     )
 35 |   }
 36 | 
 37 |   return (
 38 |     <NavLink
 39 |       to={to}
 40 |       className={({ isActive }) =>
 41 |         cn(
 42 |           'flex items-center gap-3 rounded-lg px-3 py-2 transition-colors',
 43 |           isActive
 44 |             ? 'bg-secondary text-secondary-foreground'
 45 |             : 'text-muted-foreground hover:bg-secondary/50 hover:text-secondary-foreground'
 46 |         )
 47 |       }
 48 |     >
 49 |       {icon}
 50 |       <span className="flex-1">{label}</span>
 51 |       {badge !== undefined && badge > 0 && (
 52 |         <Badge variant="destructive" className="text-xs">
 53 |           {badge}
 54 |         </Badge>
 55 |       )}
 56 |     </NavLink>
 57 |   )
 58 | }
 59 | 
 60 | interface SidebarProps {
 61 |   className?: string
 62 | }
 63 | 
 64 | export function Sidebar({ className }: SidebarProps) {
 65 |   return (
 66 |     <div className={cn('flex h-full flex-col gap-2', className)}>
 67 |       <div className="flex h-14 items-center border-b px-4 lg:h-[60px] lg:px-6">
 68 |         <span className="flex items-center gap-2 font-semibold">
 69 |           <Eye className="h-6 w-6" />
 70 |           <span>FB Watcher</span>
 71 |         </span>
 72 |       </div>
 73 |       <div className="flex-1 overflow-auto">
 74 |         <nav className="grid items-start gap-1 px-2 text-sm font-medium lg:px-4">
 75 |           <div className="py-2">
 76 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
 77 |               Glowne
 78 |             </p>
 79 |           </div>
 80 |           <NavItem to="/" icon={<Home className="h-4 w-4" />} label="Dashboard" />
 81 |           <NavItem
 82 |             to="/discoveries"
 83 |             icon={<Bell className="h-4 w-4" />}
 84 |             label="Wykrycia"
 85 |             disabled
 86 |           />
 87 | 
 88 |           <Separator className="my-3" />
 89 | 
 90 |           <div className="py-2">
 91 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
 92 |               Monitoring
 93 |             </p>
 94 |           </div>
 95 |           <NavItem to="/watched" icon={<Eye className="h-4 w-4" />} label="Obserwowane" />
 96 |           <NavItem
 97 |             to="/sources"
 98 |             icon={<Globe className="h-4 w-4" />}
 99 |             label="Zrodla"
100 |             disabled
101 |           />
102 | 
103 |           <Separator className="my-3" />
104 | 
105 |           <div className="py-2">
106 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
107 |               Automatyzacja
108 |             </p>
109 |           </div>
110 |           <NavItem
111 |             to="/campaigns"
112 |             icon={<Megaphone className="h-4 w-4" />}
113 |             label="Kampanie"
114 |             disabled
115 |           />
116 | 
117 |           <Separator className="my-3" />
118 | 
119 |           <div className="py-2">
120 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
121 |               System
122 |             </p>
123 |           </div>
124 |           <NavItem to="/cookies" icon={<Cookie className="h-4 w-4" />} label="Sesje" />
125 |           <NavItem to="/settings" icon={<Settings className="h-4 w-4" />} label="Ustawienia" />
126 |           <NavItem to="/logs" icon={<Terminal className="h-4 w-4" />} label="Logi" />
127 |         </nav>
128 |       </div>
129 |     </div>
130 |   )
131 | }
132 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/badge.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const badgeVariants = cva(
 6 |   'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
 7 |   {
 8 |     variants: {
 9 |       variant: {
10 |         default: 'border-transparent bg-primary text-primary-foreground hover:bg-primary/80',
11 |         secondary: 'border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80',
12 |         destructive: 'border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80',
13 |         outline: 'text-foreground',
14 |         success: 'border-transparent bg-green-600 text-white hover:bg-green-600/80',
15 |         warning: 'border-transparent bg-yellow-600 text-white hover:bg-yellow-600/80',
16 |       },
17 |     },
18 |     defaultVariants: {
19 |       variant: 'default',
20 |     },
21 |   }
22 | )
23 | 
24 | export interface BadgeProps
25 |   extends React.HTMLAttributes<HTMLDivElement>,
26 |     VariantProps<typeof badgeVariants> {}
27 | 
28 | function Badge({ className, variant, ...props }: BadgeProps) {
29 |   return <div className={cn(badgeVariants({ variant }), className)} {...props} />
30 | }
31 | 
32 | export { Badge, badgeVariants }
33 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/button.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const buttonVariants = cva(
 6 |   'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0',
 7 |   {
 8 |     variants: {
 9 |       variant: {
10 |         default: 'bg-primary text-primary-foreground hover:bg-primary/90',
11 |         destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
12 |         outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
13 |         secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
14 |         ghost: 'hover:bg-accent hover:text-accent-foreground',
15 |         link: 'text-primary underline-offset-4 hover:underline',
16 |       },
17 |       size: {
18 |         default: 'h-10 px-4 py-2',
19 |         sm: 'h-9 rounded-md px-3',
20 |         lg: 'h-11 rounded-md px-8',
21 |         icon: 'h-10 w-10',
22 |       },
23 |     },
24 |     defaultVariants: {
25 |       variant: 'default',
26 |       size: 'default',
27 |     },
28 |   }
29 | )
30 | 
31 | export interface ButtonProps
32 |   extends React.ButtonHTMLAttributes<HTMLButtonElement>,
33 |     VariantProps<typeof buttonVariants> {}
34 | 
35 | const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
36 |   ({ className, variant, size, ...props }, ref) => {
37 |     return (
38 |       <button
39 |         className={cn(buttonVariants({ variant, size, className }))}
40 |         ref={ref}
41 |         {...props}
42 |       />
43 |     )
44 |   }
45 | )
46 | Button.displayName = 'Button'
47 | 
48 | export { Button, buttonVariants }
49 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/card.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 5 |   ({ className, ...props }, ref) => (
 6 |     <div
 7 |       ref={ref}
 8 |       className={cn('rounded-lg border bg-card text-card-foreground shadow-sm', className)}
 9 |       {...props}
10 |     />
11 |   )
12 | )
13 | Card.displayName = 'Card'
14 | 
15 | const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
16 |   ({ className, ...props }, ref) => (
17 |     <div ref={ref} className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
18 |   )
19 | )
20 | CardHeader.displayName = 'CardHeader'
21 | 
22 | const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
23 |   ({ className, ...props }, ref) => (
24 |     <h3
25 |       ref={ref}
26 |       className={cn('text-2xl font-semibold leading-none tracking-tight', className)}
27 |       {...props}
28 |     />
29 |   )
30 | )
31 | CardTitle.displayName = 'CardTitle'
32 | 
33 | const CardDescription = React.forwardRef<
34 |   HTMLParagraphElement,
35 |   React.HTMLAttributes<HTMLParagraphElement>
36 | >(({ className, ...props }, ref) => (
37 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
38 | ))
39 | CardDescription.displayName = 'CardDescription'
40 | 
41 | const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
42 |   ({ className, ...props }, ref) => (
43 |     <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
44 |   )
45 | )
46 | CardContent.displayName = 'CardContent'
47 | 
48 | const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
49 |   ({ className, ...props }, ref) => (
50 |     <div ref={ref} className={cn('flex items-center p-6 pt-0', className)} {...props} />
51 |   )
52 | )
53 | CardFooter.displayName = 'CardFooter'
54 | 
55 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
56 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/checkbox.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { Check } from 'lucide-react'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | export interface CheckboxProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
 6 |   onCheckedChange?: (checked: boolean) => void
 7 | }
 8 | 
 9 | const Checkbox = React.forwardRef<HTMLInputElement, CheckboxProps>(
10 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
11 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
12 |       onChange?.(e)
13 |       onCheckedChange?.(e.target.checked)
14 |     }
15 | 
16 |     return (
17 |       <div className="relative inline-flex items-center">
18 |         <input
19 |           type="checkbox"
20 |           ref={ref}
21 |           checked={checked}
22 |           onChange={handleChange}
23 |           className="sr-only peer"
24 |           {...props}
25 |         />
26 |         <div
27 |           className={cn(
28 |             'h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary peer-checked:text-primary-foreground flex items-center justify-center cursor-pointer',
29 |             className
30 |           )}
31 |           onClick={() => {
32 |             const input = ref && 'current' in ref ? ref.current : null
33 |             if (input) {
34 |               input.click()
35 |             }
36 |           }}
37 |         >
38 |           {checked && <Check className="h-3 w-3" />}
39 |         </div>
40 |       </div>
41 |     )
42 |   }
43 | )
44 | Checkbox.displayName = 'Checkbox'
45 | 
46 | export { Checkbox }
47 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/dialog.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import * as React from 'react'
  2 | import { X } from 'lucide-react'
  3 | import { cn } from '@/lib/utils'
  4 | 
  5 | interface DialogContextValue {
  6 |   open: boolean
  7 |   onOpenChange: (open: boolean) => void
  8 | }
  9 | 
 10 | const DialogContext = React.createContext<DialogContextValue | null>(null)
 11 | 
 12 | interface DialogProps {
 13 |   open?: boolean
 14 |   onOpenChange?: (open: boolean) => void
 15 |   children: React.ReactNode
 16 | }
 17 | 
 18 | function Dialog({ open = false, onOpenChange, children }: DialogProps) {
 19 |   const handleOpenChange = React.useCallback(
 20 |     (newOpen: boolean) => {
 21 |       onOpenChange?.(newOpen)
 22 |     },
 23 |     [onOpenChange]
 24 |   )
 25 | 
 26 |   return (
 27 |     <DialogContext.Provider value={{ open, onOpenChange: handleOpenChange }}>
 28 |       {children}
 29 |     </DialogContext.Provider>
 30 |   )
 31 | }
 32 | 
 33 | interface DialogTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
 34 |   asChild?: boolean
 35 | }
 36 | 
 37 | const DialogTrigger = React.forwardRef<HTMLButtonElement, DialogTriggerProps>(
 38 |   ({ onClick, children, ...props }, ref) => {
 39 |     const context = React.useContext(DialogContext)
 40 |     return (
 41 |       <button
 42 |         ref={ref}
 43 |         onClick={(e) => {
 44 |           onClick?.(e)
 45 |           context?.onOpenChange(true)
 46 |         }}
 47 |         {...props}
 48 |       >
 49 |         {children}
 50 |       </button>
 51 |     )
 52 |   }
 53 | )
 54 | DialogTrigger.displayName = 'DialogTrigger'
 55 | 
 56 | interface DialogPortalProps {
 57 |   children: React.ReactNode
 58 | }
 59 | 
 60 | function DialogPortal({ children }: DialogPortalProps) {
 61 |   const context = React.useContext(DialogContext)
 62 |   if (!context?.open) return null
 63 |   return <>{children}</>
 64 | }
 65 | 
 66 | const DialogOverlay = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 67 |   ({ className, ...props }, ref) => {
 68 |     const context = React.useContext(DialogContext)
 69 |     return (
 70 |       <div
 71 |         ref={ref}
 72 |         className={cn(
 73 |           'fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
 74 |           className
 75 |         )}
 76 |         data-state={context?.open ? 'open' : 'closed'}
 77 |         onClick={() => context?.onOpenChange(false)}
 78 |         {...props}
 79 |       />
 80 |     )
 81 |   }
 82 | )
 83 | DialogOverlay.displayName = 'DialogOverlay'
 84 | 
 85 | const DialogContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 86 |   ({ className, children, ...props }, ref) => {
 87 |     const context = React.useContext(DialogContext)
 88 | 
 89 |     React.useEffect(() => {
 90 |       const handleEscape = (e: KeyboardEvent) => {
 91 |         if (e.key === 'Escape') {
 92 |           context?.onOpenChange(false)
 93 |         }
 94 |       }
 95 |       if (context?.open) {
 96 |         document.addEventListener('keydown', handleEscape)
 97 |         return () => document.removeEventListener('keydown', handleEscape)
 98 |       }
 99 |     }, [context])
100 | 
101 |     return (
102 |       <DialogPortal>
103 |         <DialogOverlay />
104 |         <div
105 |           ref={ref}
106 |           className={cn(
107 |             'fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg',
108 |             className
109 |           )}
110 |           data-state={context?.open ? 'open' : 'closed'}
111 |           onClick={(e) => e.stopPropagation()}
112 |           {...props}
113 |         >
114 |           {children}
115 |           <button
116 |             className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none"
117 |             onClick={() => context?.onOpenChange(false)}
118 |           >
119 |             <X className="h-4 w-4" />
120 |             <span className="sr-only">Zamknij</span>
121 |           </button>
122 |         </div>
123 |       </DialogPortal>
124 |     )
125 |   }
126 | )
127 | DialogContent.displayName = 'DialogContent'
128 | 
129 | const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
130 |   <div className={cn('flex flex-col space-y-1.5 text-center sm:text-left', className)} {...props} />
131 | )
132 | DialogHeader.displayName = 'DialogHeader'
133 | 
134 | const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
135 |   <div
136 |     className={cn('flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2', className)}
137 |     {...props}
138 |   />
139 | )
140 | DialogFooter.displayName = 'DialogFooter'
141 | 
142 | const DialogTitle = React.forwardRef<
143 |   HTMLHeadingElement,
144 |   React.HTMLAttributes<HTMLHeadingElement>
145 | >(({ className, ...props }, ref) => (
146 |   <h2
147 |     ref={ref}
148 |     className={cn('text-lg font-semibold leading-none tracking-tight', className)}
149 |     {...props}
150 |   />
151 | ))
152 | DialogTitle.displayName = 'DialogTitle'
153 | 
154 | const DialogDescription = React.forwardRef<
155 |   HTMLParagraphElement,
156 |   React.HTMLAttributes<HTMLParagraphElement>
157 | >(({ className, ...props }, ref) => (
158 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
159 | ))
160 | DialogDescription.displayName = 'DialogDescription'
161 | 
162 | export {
163 |   Dialog,
164 |   DialogPortal,
165 |   DialogOverlay,
166 |   DialogTrigger,
167 |   DialogContent,
168 |   DialogHeader,
169 |   DialogFooter,
170 |   DialogTitle,
171 |   DialogDescription,
172 | }
173 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/input.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {}
 5 | 
 6 | const Input = React.forwardRef<HTMLInputElement, InputProps>(
 7 |   ({ className, type, ...props }, ref) => {
 8 |     return (
 9 |       <input
10 |         type={type}
11 |         className={cn(
12 |           'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
13 |           className
14 |         )}
15 |         ref={ref}
16 |         {...props}
17 |       />
18 |     )
19 |   }
20 | )
21 | Input.displayName = 'Input'
22 | 
23 | export { Input }
24 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/label.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cva, type VariantProps } from 'class-variance-authority'
 3 | import { cn } from '@/lib/utils'
 4 | 
 5 | const labelVariants = cva(
 6 |   'text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70'
 7 | )
 8 | 
 9 | export interface LabelProps
10 |   extends React.LabelHTMLAttributes<HTMLLabelElement>,
11 |     VariantProps<typeof labelVariants> {}
12 | 
13 | const Label = React.forwardRef<HTMLLabelElement, LabelProps>(
14 |   ({ className, ...props }, ref) => (
15 |     <label ref={ref} className={cn(labelVariants(), className)} {...props} />
16 |   )
17 | )
18 | Label.displayName = 'Label'
19 | 
20 | export { Label }
21 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/separator.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | interface SeparatorProps extends React.HTMLAttributes<HTMLDivElement> {
 5 |   orientation?: 'horizontal' | 'vertical'
 6 |   decorative?: boolean
 7 | }
 8 | 
 9 | const Separator = React.forwardRef<HTMLDivElement, SeparatorProps>(
10 |   ({ className, orientation = 'horizontal', decorative = true, ...props }, ref) => (
11 |     <div
12 |       ref={ref}
13 |       role={decorative ? 'none' : 'separator'}
14 |       aria-orientation={decorative ? undefined : orientation}
15 |       className={cn(
16 |         'shrink-0 bg-border',
17 |         orientation === 'horizontal' ? 'h-[1px] w-full' : 'h-full w-[1px]',
18 |         className
19 |       )}
20 |       {...props}
21 |     />
22 |   )
23 | )
24 | Separator.displayName = 'Separator'
25 | 
26 | export { Separator }
27 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/switch.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface SwitchProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
 5 |   onCheckedChange?: (checked: boolean) => void
 6 | }
 7 | 
 8 | const Switch = React.forwardRef<HTMLInputElement, SwitchProps>(
 9 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
10 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
11 |       onChange?.(e)
12 |       onCheckedChange?.(e.target.checked)
13 |     }
14 | 
15 |     return (
16 |       <label className="relative inline-flex cursor-pointer items-center">
17 |         <input
18 |           type="checkbox"
19 |           ref={ref}
20 |           checked={checked}
21 |           onChange={handleChange}
22 |           className="sr-only peer"
23 |           {...props}
24 |         />
25 |         <div
26 |           className={cn(
27 |             'peer h-6 w-11 rounded-full bg-input ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary',
28 |             className
29 |           )}
30 |         >
31 |           <div
32 |             className={cn(
33 |               'absolute left-[2px] top-[2px] h-5 w-5 rounded-full bg-background transition-transform',
34 |               checked && 'translate-x-5'
35 |             )}
36 |           />
37 |         </div>
38 |       </label>
39 |     )
40 |   }
41 | )
42 | Switch.displayName = 'Switch'
43 | 
44 | export { Switch }
45 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/table.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import * as React from 'react'
  2 | import { cn } from '@/lib/utils'
  3 | 
  4 | const Table = React.forwardRef<HTMLTableElement, React.HTMLAttributes<HTMLTableElement>>(
  5 |   ({ className, ...props }, ref) => (
  6 |     <div className="relative w-full overflow-auto">
  7 |       <table
  8 |         ref={ref}
  9 |         className={cn('w-full caption-bottom text-sm', className)}
 10 |         {...props}
 11 |       />
 12 |     </div>
 13 |   )
 14 | )
 15 | Table.displayName = 'Table'
 16 | 
 17 | const TableHeader = React.forwardRef<
 18 |   HTMLTableSectionElement,
 19 |   React.HTMLAttributes<HTMLTableSectionElement>
 20 | >(({ className, ...props }, ref) => (
 21 |   <thead ref={ref} className={cn('[&_tr]:border-b', className)} {...props} />
 22 | ))
 23 | TableHeader.displayName = 'TableHeader'
 24 | 
 25 | const TableBody = React.forwardRef<
 26 |   HTMLTableSectionElement,
 27 |   React.HTMLAttributes<HTMLTableSectionElement>
 28 | >(({ className, ...props }, ref) => (
 29 |   <tbody ref={ref} className={cn('[&_tr:last-child]:border-0', className)} {...props} />
 30 | ))
 31 | TableBody.displayName = 'TableBody'
 32 | 
 33 | const TableFooter = React.forwardRef<
 34 |   HTMLTableSectionElement,
 35 |   React.HTMLAttributes<HTMLTableSectionElement>
 36 | >(({ className, ...props }, ref) => (
 37 |   <tfoot
 38 |     ref={ref}
 39 |     className={cn('border-t bg-muted/50 font-medium [&>tr]:last:border-b-0', className)}
 40 |     {...props}
 41 |   />
 42 | ))
 43 | TableFooter.displayName = 'TableFooter'
 44 | 
 45 | const TableRow = React.forwardRef<HTMLTableRowElement, React.HTMLAttributes<HTMLTableRowElement>>(
 46 |   ({ className, ...props }, ref) => (
 47 |     <tr
 48 |       ref={ref}
 49 |       className={cn(
 50 |         'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted',
 51 |         className
 52 |       )}
 53 |       {...props}
 54 |     />
 55 |   )
 56 | )
 57 | TableRow.displayName = 'TableRow'
 58 | 
 59 | const TableHead = React.forwardRef<
 60 |   HTMLTableCellElement,
 61 |   React.ThHTMLAttributes<HTMLTableCellElement>
 62 | >(({ className, ...props }, ref) => (
 63 |   <th
 64 |     ref={ref}
 65 |     className={cn(
 66 |       'h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0',
 67 |       className
 68 |     )}
 69 |     {...props}
 70 |   />
 71 | ))
 72 | TableHead.displayName = 'TableHead'
 73 | 
 74 | const TableCell = React.forwardRef<
 75 |   HTMLTableCellElement,
 76 |   React.TdHTMLAttributes<HTMLTableCellElement>
 77 | >(({ className, ...props }, ref) => (
 78 |   <td
 79 |     ref={ref}
 80 |     className={cn('p-4 align-middle [&:has([role=checkbox])]:pr-0', className)}
 81 |     {...props}
 82 |   />
 83 | ))
 84 | TableCell.displayName = 'TableCell'
 85 | 
 86 | const TableCaption = React.forwardRef<
 87 |   HTMLTableCaptionElement,
 88 |   React.HTMLAttributes<HTMLTableCaptionElement>
 89 | >(({ className, ...props }, ref) => (
 90 |   <caption ref={ref} className={cn('mt-4 text-sm text-muted-foreground', className)} {...props} />
 91 | ))
 92 | TableCaption.displayName = 'TableCaption'
 93 | 
 94 | export {
 95 |   Table,
 96 |   TableHeader,
 97 |   TableBody,
 98 |   TableFooter,
 99 |   TableHead,
100 |   TableRow,
101 |   TableCell,
102 |   TableCaption,
103 | }
104 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/tabs.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import * as React from 'react'
  2 | import { cn } from '@/lib/utils'
  3 | 
  4 | interface TabsContextValue {
  5 |   value: string
  6 |   onValueChange: (value: string) => void
  7 | }
  8 | 
  9 | const TabsContext = React.createContext<TabsContextValue | null>(null)
 10 | 
 11 | interface TabsProps extends React.HTMLAttributes<HTMLDivElement> {
 12 |   value?: string
 13 |   defaultValue?: string
 14 |   onValueChange?: (value: string) => void
 15 | }
 16 | 
 17 | const Tabs = React.forwardRef<HTMLDivElement, TabsProps>(
 18 |   ({ className, value, defaultValue, onValueChange, children, ...props }, ref) => {
 19 |     const [internalValue, setInternalValue] = React.useState(defaultValue || '')
 20 |     const currentValue = value !== undefined ? value : internalValue
 21 | 
 22 |     const handleValueChange = React.useCallback(
 23 |       (newValue: string) => {
 24 |         if (value === undefined) {
 25 |           setInternalValue(newValue)
 26 |         }
 27 |         onValueChange?.(newValue)
 28 |       },
 29 |       [value, onValueChange]
 30 |     )
 31 | 
 32 |     return (
 33 |       <TabsContext.Provider value={{ value: currentValue, onValueChange: handleValueChange }}>
 34 |         <div ref={ref} className={cn('', className)} {...props}>
 35 |           {children}
 36 |         </div>
 37 |       </TabsContext.Provider>
 38 |     )
 39 |   }
 40 | )
 41 | Tabs.displayName = 'Tabs'
 42 | 
 43 | const TabsList = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
 44 |   ({ className, ...props }, ref) => (
 45 |     <div
 46 |       ref={ref}
 47 |       className={cn(
 48 |         'inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground',
 49 |         className
 50 |       )}
 51 |       {...props}
 52 |     />
 53 |   )
 54 | )
 55 | TabsList.displayName = 'TabsList'
 56 | 
 57 | interface TabsTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
 58 |   value: string
 59 | }
 60 | 
 61 | const TabsTrigger = React.forwardRef<HTMLButtonElement, TabsTriggerProps>(
 62 |   ({ className, value, ...props }, ref) => {
 63 |     const context = React.useContext(TabsContext)
 64 |     const isActive = context?.value === value
 65 | 
 66 |     return (
 67 |       <button
 68 |         ref={ref}
 69 |         className={cn(
 70 |           'inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
 71 |           isActive && 'bg-background text-foreground shadow-sm',
 72 |           className
 73 |         )}
 74 |         onClick={() => context?.onValueChange(value)}
 75 |         data-state={isActive ? 'active' : 'inactive'}
 76 |         {...props}
 77 |       />
 78 |     )
 79 |   }
 80 | )
 81 | TabsTrigger.displayName = 'TabsTrigger'
 82 | 
 83 | interface TabsContentProps extends React.HTMLAttributes<HTMLDivElement> {
 84 |   value: string
 85 | }
 86 | 
 87 | const TabsContent = React.forwardRef<HTMLDivElement, TabsContentProps>(
 88 |   ({ className, value, ...props }, ref) => {
 89 |     const context = React.useContext(TabsContext)
 90 |     const isActive = context?.value === value
 91 | 
 92 |     if (!isActive) return null
 93 | 
 94 |     return (
 95 |       <div
 96 |         ref={ref}
 97 |         className={cn(
 98 |           'mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
 99 |           className
100 |         )}
101 |         data-state={isActive ? 'active' : 'inactive'}
102 |         {...props}
103 |       />
104 |     )
105 |   }
106 | )
107 | TabsContent.displayName = 'TabsContent'
108 | 
109 | export { Tabs, TabsList, TabsTrigger, TabsContent }
110 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/textarea.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import * as React from 'react'
 2 | import { cn } from '@/lib/utils'
 3 | 
 4 | export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}
 5 | 
 6 | const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
 7 |   ({ className, ...props }, ref) => {
 8 |     return (
 9 |       <textarea
10 |         className={cn(
11 |           'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
12 |           className
13 |         )}
14 |         ref={ref}
15 |         {...props}
16 |       />
17 |     )
18 |   }
19 | )
20 | Textarea.displayName = 'Textarea'
21 | 
22 | export { Textarea }
23 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useApi.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
 1 | import { useState, useCallback } from 'react'
 2 | 
 3 | interface UseApiOptions<T> {
 4 |   onSuccess?: (data: T) => void
 5 |   onError?: (error: string) => void
 6 | }
 7 | 
 8 | interface UseApiResult<T, Args extends unknown[]> {
 9 |   data: T | null
10 |   loading: boolean
11 |   error: string | null
12 |   execute: (...args: Args) => Promise<T | null>
13 |   reset: () => void
14 | }
15 | 
16 | export function useApi<T, Args extends unknown[] = []>(
17 |   apiFn: (...args: Args) => Promise<T & { ok: boolean; error?: string }>,
18 |   options: UseApiOptions<T> = {}
19 | ): UseApiResult<T, Args> {
20 |   const [data, setData] = useState<T | null>(null)
21 |   const [loading, setLoading] = useState(false)
22 |   const [error, setError] = useState<string | null>(null)
23 | 
24 |   const execute = useCallback(
25 |     async (...args: Args): Promise<T | null> => {
26 |       setLoading(true)
27 |       setError(null)
28 | 
29 |       try {
30 |         const result = await apiFn(...args)
31 |         if (result.ok) {
32 |           setData(result)
33 |           options.onSuccess?.(result)
34 |           return result
35 |         } else {
36 |           const errorMsg = result.error || 'Unknown error'
37 |           setError(errorMsg)
38 |           options.onError?.(errorMsg)
39 |           return null
40 |         }
41 |       } catch (err) {
42 |         const errorMsg = err instanceof Error ? err.message : 'Network error'
43 |         setError(errorMsg)
44 |         options.onError?.(errorMsg)
45 |         return null
46 |       } finally {
47 |         setLoading(false)
48 |       }
49 |     },
50 |     [apiFn, options]
51 |   )
52 | 
53 |   const reset = useCallback(() => {
54 |     setData(null)
55 |     setError(null)
56 |     setLoading(false)
57 |   }, [])
58 | 
59 |   return { data, loading, error, execute, reset }
60 | }
61 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useAuth.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { createContext, useContext, useState, useCallback, ReactNode } from 'react'
 2 | import { getToken, setToken as saveToken } from '@/lib/api'
 3 | 
 4 | interface AuthContextValue {
 5 |   token: string
 6 |   setToken: (token: string) => void
 7 |   isAuthenticated: boolean
 8 | }
 9 | 
10 | const AuthContext = createContext<AuthContextValue | null>(null)
11 | 
12 | export function AuthProvider({ children }: { children: ReactNode }) {
13 |   const [token, setTokenState] = useState(() => getToken())
14 | 
15 |   const setToken = useCallback((newToken: string) => {
16 |     saveToken(newToken)
17 |     setTokenState(newToken)
18 |   }, [])
19 | 
20 |   const value: AuthContextValue = {
21 |     token,
22 |     setToken,
23 |     isAuthenticated: token.length > 0,
24 |   }
25 | 
26 |   return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
27 | }
28 | 
29 | export function useAuth() {
30 |   const context = useContext(AuthContext)
31 |   if (!context) {
32 |     throw new Error('useAuth must be used within AuthProvider')
33 |   }
34 |   return context
35 | }
36 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useLogs.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
 1 | import { useState, useCallback, useRef, useEffect } from 'react'
 2 | import { getLogsOut, getLogsErr } from '@/lib/api'
 3 | 
 4 | type LogMode = 'out' | 'err'
 5 | 
 6 | interface UseLogsResult {
 7 |   logs: string
 8 |   loading: boolean
 9 |   error: string | null
10 |   mode: LogMode
11 |   autoRefresh: number
12 |   setAutoRefresh: (interval: number) => void
13 |   loadLogs: (mode?: LogMode, lines?: number) => Promise<void>
14 |   setMode: (mode: LogMode) => void
15 | }
16 | 
17 | export function useLogs(initialLines = 200): UseLogsResult {
18 |   const [logs, setLogs] = useState('')
19 |   const [loading, setLoading] = useState(false)
20 |   const [error, setError] = useState<string | null>(null)
21 |   const [mode, setMode] = useState<LogMode>('out')
22 |   const [autoRefresh, setAutoRefresh] = useState(0)
23 |   const intervalRef = useRef<number | null>(null)
24 | 
25 |   const loadLogs = useCallback(
26 |     async (logMode?: LogMode, lines = initialLines) => {
27 |       const targetMode = logMode ?? mode
28 |       setLoading(true)
29 |       setError(null)
30 | 
31 |       try {
32 |         const fn = targetMode === 'out' ? getLogsOut : getLogsErr
33 |         const result = await fn(lines)
34 | 
35 |         if (result.ok && result.log) {
36 |           // Strip ANSI codes
37 |           const cleanLog = result.log.replace(/\x1b\[[0-9;]*m/g, '')
38 |           setLogs(cleanLog)
39 |         } else {
40 |           setError(result.error || 'Nie udalo sie wczytac logow')
41 |           setLogs('')
42 |         }
43 |       } catch (err) {
44 |         setError(err instanceof Error ? err.message : 'Blad sieci')
45 |         setLogs('')
46 |       } finally {
47 |         setLoading(false)
48 |       }
49 |     },
50 |     [mode, initialLines]
51 |   )
52 | 
53 |   // Handle auto-refresh
54 |   useEffect(() => {
55 |     if (intervalRef.current) {
56 |       clearInterval(intervalRef.current)
57 |       intervalRef.current = null
58 |     }
59 | 
60 |     if (autoRefresh > 0) {
61 |       intervalRef.current = window.setInterval(() => {
62 |         loadLogs()
63 |       }, autoRefresh)
64 |     }
65 | 
66 |     return () => {
67 |       if (intervalRef.current) {
68 |         clearInterval(intervalRef.current)
69 |       }
70 |     }
71 |   }, [autoRefresh, loadLogs])
72 | 
73 |   const handleModeChange = useCallback(
74 |     (newMode: LogMode) => {
75 |       setMode(newMode)
76 |       loadLogs(newMode)
77 |     },
78 |     [loadLogs]
79 |   )
80 | 
81 |   return {
82 |     logs,
83 |     loading,
84 |     error,
85 |     mode,
86 |     autoRefresh,
87 |     setAutoRefresh,
88 |     loadLogs,
89 |     setMode: handleModeChange,
90 |   }
91 | }
92 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/index.css`
**Typ:** CSS  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```css
 1 | @tailwind base;
 2 | @tailwind components;
 3 | @tailwind utilities;
 4 | 
 5 | @layer base {
 6 |   :root {
 7 |     --background: 0 0% 100%;
 8 |     --foreground: 222.2 84% 4.9%;
 9 |     --card: 0 0% 100%;
10 |     --card-foreground: 222.2 84% 4.9%;
11 |     --popover: 0 0% 100%;
12 |     --popover-foreground: 222.2 84% 4.9%;
13 |     --primary: 222.2 47.4% 11.2%;
14 |     --primary-foreground: 210 40% 98%;
15 |     --secondary: 210 40% 96.1%;
16 |     --secondary-foreground: 222.2 47.4% 11.2%;
17 |     --muted: 210 40% 96.1%;
18 |     --muted-foreground: 215.4 16.3% 46.9%;
19 |     --accent: 210 40% 96.1%;
20 |     --accent-foreground: 222.2 47.4% 11.2%;
21 |     --destructive: 0 84.2% 60.2%;
22 |     --destructive-foreground: 210 40% 98%;
23 |     --border: 214.3 31.8% 91.4%;
24 |     --input: 214.3 31.8% 91.4%;
25 |     --ring: 222.2 84% 4.9%;
26 |     --radius: 0.5rem;
27 |   }
28 | 
29 |   .dark {
30 |     --background: 222.2 84% 4.9%;
31 |     --foreground: 210 40% 98%;
32 |     --card: 222.2 84% 4.9%;
33 |     --card-foreground: 210 40% 98%;
34 |     --popover: 222.2 84% 4.9%;
35 |     --popover-foreground: 210 40% 98%;
36 |     --primary: 210 40% 98%;
37 |     --primary-foreground: 222.2 47.4% 11.2%;
38 |     --secondary: 217.2 32.6% 17.5%;
39 |     --secondary-foreground: 210 40% 98%;
40 |     --muted: 217.2 32.6% 17.5%;
41 |     --muted-foreground: 215 20.2% 65.1%;
42 |     --accent: 217.2 32.6% 17.5%;
43 |     --accent-foreground: 210 40% 98%;
44 |     --destructive: 0 62.8% 30.6%;
45 |     --destructive-foreground: 210 40% 98%;
46 |     --border: 217.2 32.6% 17.5%;
47 |     --input: 217.2 32.6% 17.5%;
48 |     --ring: 212.7 26.8% 83.9%;
49 |   }
50 | }
51 | 
52 | @layer base {
53 |   * {
54 |     @apply border-border;
55 |   }
56 |   body {
57 |     @apply bg-background text-foreground;
58 |   }
59 | }
60 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/api.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
  1 | import type {
  2 |   SystemStatus,
  3 |   PostsResponse,
  4 |   EnvResponse,
  5 |   LogsResponse,
  6 |   Post,
  7 |   SessionStatus,
  8 | } from './types'
  9 | 
 10 | const TOKEN_KEY = 'FBW_PANEL_TOKEN'
 11 | 
 12 | export function getToken(): string {
 13 |   return localStorage.getItem(TOKEN_KEY) || ''
 14 | }
 15 | 
 16 | export function setToken(token: string): void {
 17 |   localStorage.setItem(TOKEN_KEY, token)
 18 | }
 19 | 
 20 | function getAuthHeaders(): HeadersInit {
 21 |   const token = getToken()
 22 |   return token ? { Authorization: `Bearer ${token}` } : {}
 23 | }
 24 | 
 25 | async function request<T>(
 26 |   path: string,
 27 |   options: RequestInit = {}
 28 | ): Promise<T & { ok: boolean; error?: string }> {
 29 |   const headers: Record<string, string> = {
 30 |     ...(getAuthHeaders() as Record<string, string>),
 31 |     ...((options.headers || {}) as Record<string, string>),
 32 |   }
 33 | 
 34 |   if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
 35 |     headers['Content-Type'] = 'application/json'
 36 |     options.body = JSON.stringify(options.body)
 37 |   }
 38 | 
 39 |   try {
 40 |     const res = await fetch(path, {
 41 |       ...options,
 42 |       headers,
 43 |     })
 44 | 
 45 |     const text = await res.text()
 46 |     let data: T & { ok: boolean; error?: string }
 47 | 
 48 |     try {
 49 |       data = JSON.parse(text)
 50 |     } catch {
 51 |       data = { ok: false, error: text || `HTTP ${res.status}` } as T & { ok: boolean; error?: string }
 52 |     }
 53 | 
 54 |     if (!res.ok && data.ok !== false) {
 55 |       data.ok = false
 56 |       data.error = data.error || `HTTP ${res.status}`
 57 |     }
 58 | 
 59 |     return data
 60 |   } catch (err) {
 61 |     return { ok: false, error: err instanceof Error ? err.message : 'Network error' } as T & { ok: boolean; error?: string }
 62 |   }
 63 | }
 64 | 
 65 | // Status
 66 | export async function getStatus(): Promise<SystemStatus & { ok: boolean; error?: string }> {
 67 |   return request<SystemStatus>('/api/status')
 68 | }
 69 | 
 70 | // Env
 71 | export async function getEnv(): Promise<EnvResponse> {
 72 |   return request<EnvResponse>('/api/env/get')
 73 | }
 74 | 
 75 | export async function setEnv(set: Record<string, string>, restart = false): Promise<{ ok: boolean; error?: string }> {
 76 |   return request('/api/env/set', {
 77 |     method: 'POST',
 78 |     body: JSON.stringify({ set, restart }),
 79 |   })
 80 | }
 81 | 
 82 | // Posts
 83 | export async function getPosts(): Promise<PostsResponse> {
 84 |   return request<PostsResponse>('/api/posts')
 85 | }
 86 | 
 87 | export async function addPost(post: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
 88 |   return request('/api/posts', {
 89 |     method: 'POST',
 90 |     body: JSON.stringify(post),
 91 |   })
 92 | }
 93 | 
 94 | export async function updatePost(id: string, data: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
 95 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
 96 |     method: 'PATCH',
 97 |     body: JSON.stringify(data),
 98 |   })
 99 | }
100 | 
101 | export async function deletePost(id: string): Promise<{ ok: boolean; error?: string }> {
102 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
103 |     method: 'DELETE',
104 |   })
105 | }
106 | 
107 | // PM2
108 | export async function pm2Start(): Promise<{ ok: boolean; output?: string; error?: string }> {
109 |   return request('/api/pm2/start', { method: 'POST' })
110 | }
111 | 
112 | export async function pm2Stop(): Promise<{ ok: boolean; output?: string; error?: string }> {
113 |   return request('/api/pm2/stop', { method: 'POST' })
114 | }
115 | 
116 | export async function pm2Restart(): Promise<{ ok: boolean; output?: string; error?: string }> {
117 |   return request('/api/pm2/restart', { method: 'POST' })
118 | }
119 | 
120 | export async function pm2Status(): Promise<{ ok: boolean; output?: string; error?: string }> {
121 |   return request('/api/pm2/status')
122 | }
123 | 
124 | // Logs
125 | export async function getLogsOut(lines = 200): Promise<LogsResponse> {
126 |   return request<LogsResponse>(`/api/logs/out?lines=${lines}`)
127 | }
128 | 
129 | export async function getLogsErr(lines = 200): Promise<LogsResponse> {
130 |   return request<LogsResponse>(`/api/logs/err?lines=${lines}`)
131 | }
132 | 
133 | // Cookies
134 | export async function clearCookies(): Promise<{ ok: boolean; error?: string }> {
135 |   return request('/api/cookies/clear', {
136 |     method: 'POST',
137 |     body: JSON.stringify({ confirm: true }),
138 |   })
139 | }
140 | 
141 | export async function getCookiesStatus(): Promise<SessionStatus & { ok: boolean; error?: string }> {
142 |   return request<SessionStatus>('/api/cookies/status')
143 | }
144 | 
145 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/types.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
  1 | // Post monitorowany
  2 | export interface Post {
  3 |   id: string
  4 |   url: string
  5 |   active: boolean
  6 |   name: string
  7 |   image: string
  8 |   description: string
  9 |   createdAt: string
 10 |   updatedAt: string
 11 | }
 12 | 
 13 | // Status systemu
 14 | export interface SystemStatus {
 15 |   ok: boolean
 16 |   projectDir: string
 17 |   envPath: string
 18 |   cookiesPath: string
 19 |   postsPath: string
 20 |   node: string
 21 |   pm2: string
 22 |   pm2Status: string
 23 |   time: string
 24 | }
 25 | 
 26 | // Ustawienia .env
 27 | export interface EnvValues {
 28 |   // Facebook
 29 |   FB_EMAIL: string
 30 |   FB_PASSWORD: string
 31 |   // Watcher
 32 |   CHECK_INTERVAL_MS: string
 33 |   FAST_MODE: string
 34 |   INCLUDE_REPLIES: string
 35 |   // Logi
 36 |   LOG_LEVEL: string
 37 |   // Puppeteer
 38 |   HEADLESS_BROWSER: string
 39 |   USE_UI_HANDLERS: string
 40 |   COOKIES_READ_ONLY: string
 41 |   // ≈πr√≥d≈Ça post√≥w
 42 |   POSTS_SHEET_URL: string
 43 |   POSTS_API_URL: string
 44 |   POSTS_API_TOKEN: string
 45 |   // Telegram Owner
 46 |   TELEGRAM_SEND_TO_OWNER: string
 47 |   TELEGRAM_BOT_TOKEN_OWNER: string
 48 |   TELEGRAM_CHAT_ID_OWNER: string
 49 |   // Telegram Client
 50 |   TELEGRAM_SEND_TO_CLIENT: string
 51 |   TELEGRAM_BOT_TOKEN_CLIENT: string
 52 |   TELEGRAM_CHAT_ID_CLIENT: string
 53 |   // Telegram Format
 54 |   TELEGRAM_USE_PHOTO: string
 55 |   TELEGRAM_DISABLE_WEB_PAGE_PREVIEW: string
 56 |   // Telegram Alerty
 57 |   TG_ALERTS_ENABLED: string
 58 |   TG_ALERTS_COOLDOWN_SEC: string
 59 |   TG_ALERTS_MAXLEN: string
 60 |   // Legacy
 61 |   WEBHOOK_URL: string
 62 | }
 63 | 
 64 | // Status sesji cookies
 65 | export interface SessionStatus {
 66 |   mainCookiesExists: boolean
 67 |   mainCookiesAge?: number
 68 |   mainCookiesSize?: number
 69 |   isLoggedIn?: boolean
 70 | }
 71 | 
 72 | // ≈πr√≥d≈Ço monitorowania (przysz≈Ço≈õƒá)
 73 | export interface Source {
 74 |   id: string
 75 |   type: 'home_feed' | 'group' | 'meta_ads'
 76 |   name: string
 77 |   keywords: string[]
 78 |   active: boolean
 79 |   groupUrl?: string
 80 | }
 81 | 
 82 | // Wykrycie do zatwierdzenia (przysz≈Ço≈õƒá)
 83 | export interface Discovery {
 84 |   id: string
 85 |   sourceId: string
 86 |   postUrl: string
 87 |   content: string
 88 |   status: 'pending' | 'approved' | 'rejected'
 89 |   matchedKeywords: string[]
 90 |   discoveredAt: string
 91 | }
 92 | 
 93 | // API Response types
 94 | export interface ApiResponse<T = unknown> {
 95 |   ok: boolean
 96 |   error?: string
 97 |   data?: T
 98 | }
 99 | 
100 | export interface PostsResponse {
101 |   ok: boolean
102 |   posts: Post[]
103 |   error?: string
104 | }
105 | 
106 | export interface EnvResponse {
107 |   ok: boolean
108 |   values: EnvValues
109 |   error?: string
110 | }
111 | 
112 | export interface LogsResponse {
113 |   ok: boolean
114 |   log?: string
115 |   path?: string
116 |   error?: string
117 |   source?: string
118 | }
119 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/utils.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
1 | import { type ClassValue, clsx } from 'clsx'
2 | import { twMerge } from 'tailwind-merge'
3 | 
4 | export function cn(...inputs: ClassValue[]) {
5 |   return twMerge(clsx(inputs))
6 | }
7 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/main.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { StrictMode } from 'react'
 2 | import { createRoot } from 'react-dom/client'
 3 | import './index.css'
 4 | import App from './App'
 5 | 
 6 | createRoot(document.getElementById('root')!).render(
 7 |   <StrictMode>
 8 |     <App />
 9 |   </StrictMode>,
10 | )
11 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Campaigns.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Megaphone, Clock } from 'lucide-react'
 3 | 
 4 | export function Campaigns() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Megaphone className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Kampanie</CardTitle>
15 |               <CardDescription>Automatyzacja odpowiedzi na komentarze</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na automatyczne odpowiadanie na wykryte komentarze
25 |               wedlug zdefiniowanych regul i szablonow.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Tworzenie kampanii z szablonami odpowiedzi</li>
38 |             <li>‚Ä¢ Reguly triggerowan (slowa kluczowe, czas)</li>
39 |             <li>‚Ä¢ Harmonogram wysylki</li>
40 |             <li>‚Ä¢ A/B testy odpowiedzi</li>
41 |             <li>‚Ä¢ Statystyki skutecznosci</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Cookies.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { useEffect, useState, useCallback } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import {
  5 |   Dialog,
  6 |   DialogContent,
  7 |   DialogDescription,
  8 |   DialogFooter,
  9 |   DialogHeader,
 10 |   DialogTitle,
 11 | } from '@/components/ui/dialog'
 12 | import {
 13 |   Cookie,
 14 |   RefreshCw,
 15 |   Trash2,
 16 |   CheckCircle,
 17 |   XCircle,
 18 |   AlertTriangle,
 19 |   HardDrive,
 20 | } from 'lucide-react'
 21 | import { getCookiesStatus, clearCookies } from '@/lib/api'
 22 | import type { SessionStatus } from '@/lib/types'
 23 | 
 24 | function formatAge(hours: number): string {
 25 |   if (hours < 1) return 'teraz'
 26 |   if (hours < 24) return `${Math.round(hours)}h temu`
 27 |   const days = Math.floor(hours / 24)
 28 |   return `${days}d temu`
 29 | }
 30 | 
 31 | function formatSize(bytes: number): string {
 32 |   if (bytes < 1024) return `${bytes} B`
 33 |   return `${(bytes / 1024).toFixed(1)} KB`
 34 | }
 35 | 
 36 | export function Cookies() {
 37 |   const [status, setStatus] = useState<SessionStatus | null>(null)
 38 |   const [loading, setLoading] = useState(false)
 39 |   const [error, setError] = useState<string | null>(null)
 40 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
 41 | 
 42 |   // Dialog states
 43 |   const [clearDialogOpen, setClearDialogOpen] = useState(false)
 44 |   const [actionLoading, setActionLoading] = useState(false)
 45 | 
 46 |   const showMessage = (text: string, type: 'success' | 'error') => {
 47 |     setMessage({ text, type })
 48 |     setTimeout(() => setMessage(null), 4000)
 49 |   }
 50 | 
 51 |   const loadStatus = useCallback(async () => {
 52 |     setLoading(true)
 53 |     setError(null)
 54 |     try {
 55 |       const result = await getCookiesStatus()
 56 |       if (result.ok) {
 57 |         setStatus(result)
 58 |       } else {
 59 |         setError(result.error || 'Nie udalo sie pobrac statusu cookies')
 60 |       }
 61 |     } catch {
 62 |       setError('Blad polaczenia')
 63 |     } finally {
 64 |       setLoading(false)
 65 |     }
 66 |   }, [])
 67 | 
 68 |   useEffect(() => {
 69 |     loadStatus()
 70 |   }, [loadStatus])
 71 | 
 72 |   const handleClear = async () => {
 73 |     setActionLoading(true)
 74 |     try {
 75 |       const result = await clearCookies()
 76 |       if (result.ok) {
 77 |         showMessage('Cookies wyczyszczone', 'success')
 78 |         setClearDialogOpen(false)
 79 |         loadStatus()
 80 |       } else {
 81 |         showMessage(result.error || 'Nie udalo sie wyczyscic cookies', 'error')
 82 |       }
 83 |     } catch {
 84 |       showMessage('Blad polaczenia', 'error')
 85 |     } finally {
 86 |       setActionLoading(false)
 87 |     }
 88 |   }
 89 | 
 90 |   return (
 91 |     <div className="flex flex-col gap-4">
 92 |       {message && (
 93 |         <div
 94 |           className={`p-3 rounded-md text-sm ${
 95 |             message.type === 'success'
 96 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
 97 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
 98 |           }`}
 99 |         >
100 |           {message.text}
101 |         </div>
102 |       )}
103 | 
104 |       {error && (
105 |         <Card className="border-destructive">
106 |           <CardContent className="pt-6">
107 |             <p className="text-destructive">{error}</p>
108 |           </CardContent>
109 |         </Card>
110 |       )}
111 | 
112 |       {/* Status */}
113 |       <Card>
114 |         <CardHeader className="flex flex-row items-center justify-between">
115 |           <div>
116 |             <CardTitle>Status sesji</CardTitle>
117 |             <CardDescription>Informacje o aktualnych cookies</CardDescription>
118 |           </div>
119 |           <Button variant="outline" size="sm" onClick={loadStatus} disabled={loading}>
120 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
121 |             Odswiez
122 |           </Button>
123 |         </CardHeader>
124 |         <CardContent>
125 |           {status && (
126 |             <div className="space-y-4">
127 |               <div className="flex items-center gap-3">
128 |                 <div className="flex items-center gap-2">
129 |                   {status.isLoggedIn ? (
130 |                     <>
131 |                       <CheckCircle className="h-5 w-5 text-green-500" />
132 |                       <span className="font-medium">Zalogowany</span>
133 |                     </>
134 |                   ) : status.mainCookiesExists ? (
135 |                     <>
136 |                       <AlertTriangle className="h-5 w-5 text-yellow-500" />
137 |                       <span className="font-medium">Cookies istnieja (status nieznany)</span>
138 |                     </>
139 |                   ) : (
140 |                     <>
141 |                       <XCircle className="h-5 w-5 text-red-500" />
142 |                       <span className="font-medium">Brak cookies</span>
143 |                     </>
144 |                   )}
145 |                 </div>
146 |               </div>
147 | 
148 |               <div className="text-sm text-muted-foreground">
149 |                 {status.mainCookiesAge !== undefined && (
150 |                   <p>Wiek: {formatAge(status.mainCookiesAge)}</p>
151 |                 )}
152 |                 {status.mainCookiesSize !== undefined && (
153 |                   <p>Rozmiar: {formatSize(status.mainCookiesSize)}</p>
154 |                 )}
155 |               </div>
156 |             </div>
157 |           )}
158 |         </CardContent>
159 |       </Card>
160 | 
161 |       {/* Main cookies */}
162 |       <Card>
163 |         <CardHeader>
164 |           <CardTitle className="text-lg flex items-center gap-2">
165 |             <Cookie className="h-5 w-5" />
166 |             Plik cookies
167 |           </CardTitle>
168 |         </CardHeader>
169 |         <CardContent>
170 |           <div className="flex items-center justify-between p-4 bg-muted rounded-lg">
171 |             <div className="flex items-center gap-3">
172 |               <HardDrive className="h-5 w-5 text-muted-foreground" />
173 |               <div>
174 |                 <p className="font-mono text-sm">cookies.json</p>
175 |                 {status && (
176 |                   <p className="text-xs text-muted-foreground">
177 |                     {status.mainCookiesExists
178 |                       ? `${status.mainCookiesSize ? formatSize(status.mainCookiesSize) : ''} ${status.mainCookiesAge !== undefined ? '‚Ä¢ ' + formatAge(status.mainCookiesAge) : ''}`
179 |                       : 'Plik nie istnieje'}
180 |                   </p>
181 |                 )}
182 |               </div>
183 |             </div>
184 |             <Button
185 |               variant="outline"
186 |               size="sm"
187 |               onClick={() => setClearDialogOpen(true)}
188 |               disabled={actionLoading || !status?.mainCookiesExists}
189 |               className="text-destructive hover:text-destructive"
190 |             >
191 |               <Trash2 className="h-4 w-4 mr-1" />
192 |               Wyczysc
193 |             </Button>
194 |           </div>
195 |         </CardContent>
196 |       </Card>
197 | 
198 |       {/* Clear dialog */}
199 |       <Dialog open={clearDialogOpen} onOpenChange={setClearDialogOpen}>
200 |         <DialogContent>
201 |           <DialogHeader>
202 |             <DialogTitle>Wyczyscic cookies?</DialogTitle>
203 |             <DialogDescription>
204 |               To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu watchera.
205 |             </DialogDescription>
206 |           </DialogHeader>
207 |           <DialogFooter>
208 |             <Button variant="outline" onClick={() => setClearDialogOpen(false)}>
209 |               Anuluj
210 |             </Button>
211 |             <Button variant="destructive" onClick={handleClear} disabled={actionLoading}>
212 |               {actionLoading ? 'Czyszczenie...' : 'Wyczysc'}
213 |             </Button>
214 |           </DialogFooter>
215 |         </DialogContent>
216 |       </Dialog>
217 |     </div>
218 |   )
219 | }
220 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Dashboard.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { useEffect, useState } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Badge } from '@/components/ui/badge'
  4 | import { Button } from '@/components/ui/button'
  5 | import { Input } from '@/components/ui/input'
  6 | import { Label } from '@/components/ui/label'
  7 | import { RefreshCw, Server, FolderOpen, FileText, Cookie } from 'lucide-react'
  8 | import { getStatus } from '@/lib/api'
  9 | import { useAuth } from '@/hooks/useAuth'
 10 | import type { SystemStatus } from '@/lib/types'
 11 | 
 12 | function TokenForm() {
 13 |   const { token, setToken } = useAuth()
 14 |   const [inputValue, setInputValue] = useState(token)
 15 | 
 16 |   const handleSave = () => {
 17 |     setToken(inputValue.trim())
 18 |     window.location.reload()
 19 |   }
 20 | 
 21 |   return (
 22 |     <Card>
 23 |       <CardHeader>
 24 |         <CardTitle>Autoryzacja</CardTitle>
 25 |         <CardDescription>
 26 |           Wprowadz token PANEL_TOKEN aby uzyskac dostep do API
 27 |         </CardDescription>
 28 |       </CardHeader>
 29 |       <CardContent>
 30 |         <div className="flex gap-2">
 31 |           <div className="flex-1">
 32 |             <Label htmlFor="token" className="sr-only">
 33 |               Token
 34 |             </Label>
 35 |             <Input
 36 |               id="token"
 37 |               type="password"
 38 |               placeholder="Wprowadz PANEL_TOKEN..."
 39 |               value={inputValue}
 40 |               onChange={(e) => setInputValue(e.target.value)}
 41 |               onKeyDown={(e) => e.key === 'Enter' && handleSave()}
 42 |             />
 43 |           </div>
 44 |           <Button onClick={handleSave}>Zapisz</Button>
 45 |         </div>
 46 |       </CardContent>
 47 |     </Card>
 48 |   )
 49 | }
 50 | 
 51 | function parsePm2Status(statusText: string): { status: string; uptime?: string } {
 52 |   // Parse PM2 status table
 53 |   const lines = statusText.split('\n')
 54 |   for (const line of lines) {
 55 |     if (line.includes('fbwatcher') || line.includes('fb-watcher')) {
 56 |       if (line.includes('online')) {
 57 |         const uptimeMatch = line.match(/(\d+[smhd])/i)
 58 |         return { status: 'online', uptime: uptimeMatch?.[1] }
 59 |       }
 60 |       if (line.includes('stopped')) {
 61 |         return { status: 'stopped' }
 62 |       }
 63 |       if (line.includes('errored')) {
 64 |         return { status: 'errored' }
 65 |       }
 66 |     }
 67 |   }
 68 |   return { status: 'unknown' }
 69 | }
 70 | 
 71 | export function Dashboard() {
 72 |   const { isAuthenticated } = useAuth()
 73 |   const [status, setStatus] = useState<SystemStatus | null>(null)
 74 |   const [loading, setLoading] = useState(false)
 75 |   const [error, setError] = useState<string | null>(null)
 76 | 
 77 |   const loadStatus = async () => {
 78 |     setLoading(true)
 79 |     setError(null)
 80 |     try {
 81 |       const result = await getStatus()
 82 |       if (result.ok) {
 83 |         setStatus(result)
 84 |       } else {
 85 |         setError(result.error || 'Nie udalo sie pobrac statusu')
 86 |       }
 87 |     } catch {
 88 |       setError('Blad polaczenia z API')
 89 |     } finally {
 90 |       setLoading(false)
 91 |     }
 92 |   }
 93 | 
 94 |   useEffect(() => {
 95 |     if (isAuthenticated) {
 96 |       loadStatus()
 97 |     }
 98 |   }, [isAuthenticated])
 99 | 
100 |   if (!isAuthenticated) {
101 |     return (
102 |       <div className="flex flex-col gap-4">
103 |         <TokenForm />
104 |       </div>
105 |     )
106 |   }
107 | 
108 |   const pm2Info = status?.pm2Status ? parsePm2Status(status.pm2Status) : null
109 | 
110 |   return (
111 |     <div className="flex flex-col gap-4">
112 |       <div className="flex items-center justify-between">
113 |         <div>
114 |           <h2 className="text-2xl font-bold tracking-tight">Status systemu</h2>
115 |           <p className="text-muted-foreground">Przeglad stanu FB Watcher</p>
116 |         </div>
117 |         <Button variant="outline" onClick={loadStatus} disabled={loading}>
118 |           <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
119 |           Odswiez
120 |         </Button>
121 |       </div>
122 | 
123 |       {error && (
124 |         <Card className="border-destructive">
125 |           <CardContent className="pt-6">
126 |             <p className="text-destructive">{error}</p>
127 |             <TokenForm />
128 |           </CardContent>
129 |         </Card>
130 |       )}
131 | 
132 |       {status && (
133 |         <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
134 |           <Card>
135 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
136 |               <CardTitle className="text-sm font-medium">Watcher PM2</CardTitle>
137 |               <Server className="h-4 w-4 text-muted-foreground" />
138 |             </CardHeader>
139 |             <CardContent>
140 |               <div className="flex items-center gap-2">
141 |                 <Badge
142 |                   variant={
143 |                     pm2Info?.status === 'online'
144 |                       ? 'success'
145 |                       : pm2Info?.status === 'stopped'
146 |                         ? 'secondary'
147 |                         : 'destructive'
148 |                   }
149 |                 >
150 |                   {pm2Info?.status || 'unknown'}
151 |                 </Badge>
152 |                 {pm2Info?.uptime && (
153 |                   <span className="text-sm text-muted-foreground">
154 |                     {pm2Info.uptime}
155 |                   </span>
156 |                 )}
157 |               </div>
158 |             </CardContent>
159 |           </Card>
160 | 
161 |           <Card>
162 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
163 |               <CardTitle className="text-sm font-medium">Node.js</CardTitle>
164 |               <Server className="h-4 w-4 text-muted-foreground" />
165 |             </CardHeader>
166 |             <CardContent>
167 |               <div className="text-2xl font-bold">{status.node || 'N/A'}</div>
168 |               <p className="text-xs text-muted-foreground">PM2: {status.pm2 || 'N/A'}</p>
169 |             </CardContent>
170 |           </Card>
171 | 
172 |           <Card>
173 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
174 |               <CardTitle className="text-sm font-medium">Katalog projektu</CardTitle>
175 |               <FolderOpen className="h-4 w-4 text-muted-foreground" />
176 |             </CardHeader>
177 |             <CardContent>
178 |               <p className="text-xs text-muted-foreground break-all">{status.projectDir}</p>
179 |             </CardContent>
180 |           </Card>
181 | 
182 |           <Card>
183 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
184 |               <CardTitle className="text-sm font-medium">Pliki konfiguracji</CardTitle>
185 |               <FileText className="h-4 w-4 text-muted-foreground" />
186 |             </CardHeader>
187 |             <CardContent className="space-y-1">
188 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
189 |                 <FileText className="h-3 w-3" /> .env
190 |               </p>
191 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
192 |                 <Cookie className="h-3 w-3" /> cookies.json
193 |               </p>
194 |             </CardContent>
195 |           </Card>
196 |         </div>
197 |       )}
198 | 
199 |       {status && (
200 |         <Card>
201 |           <CardHeader>
202 |             <CardTitle className="text-sm font-medium">PM2 Status</CardTitle>
203 |           </CardHeader>
204 |           <CardContent>
205 |             <pre className="text-xs bg-muted p-4 rounded-md overflow-x-auto whitespace-pre">
206 |               {status.pm2Status}
207 |             </pre>
208 |           </CardContent>
209 |         </Card>
210 |       )}
211 | 
212 |       <TokenForm />
213 |     </div>
214 |   )
215 | }
216 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Discoveries.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Bell, Clock } from 'lucide-react'
 3 | 
 4 | export function Discoveries() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Bell className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Wykrycia</CardTitle>
15 |               <CardDescription>Przegladaj i zatwierdzaj wykryte posty</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na przegladanie automatycznie wykrytych postow
25 |               i zatwierdzanie ich do monitorowania.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Lista wykrytych postow oczekujacych na zatwierdzenie</li>
38 |             <li>‚Ä¢ Podglad tresci posta przed zatwierdzeniem</li>
39 |             <li>‚Ä¢ Masowe zatwierdzanie / odrzucanie</li>
40 |             <li>‚Ä¢ Historia wykryc</li>
41 |             <li>‚Ä¢ Statystyki skutecznosci filtrow</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Logs.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { useEffect, useRef } from 'react'
  2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'
  7 | import { Textarea } from '@/components/ui/textarea'
  8 | import { Checkbox } from '@/components/ui/checkbox'
  9 | import { RefreshCw, Maximize2, Minimize2 } from 'lucide-react'
 10 | import { useLogs } from '@/hooks/useLogs'
 11 | import { useState } from 'react'
 12 | 
 13 | export function Logs() {
 14 |   const {
 15 |     logs,
 16 |     loading,
 17 |     error,
 18 |     mode,
 19 |     autoRefresh,
 20 |     setAutoRefresh,
 21 |     loadLogs,
 22 |     setMode,
 23 |   } = useLogs(200)
 24 | 
 25 |   const [lines, setLines] = useState(200)
 26 |   const [autoScroll, setAutoScroll] = useState(true)
 27 |   const [expanded, setExpanded] = useState(false)
 28 |   const textareaRef = useRef<HTMLTextAreaElement>(null)
 29 | 
 30 |   useEffect(() => {
 31 |     loadLogs()
 32 |   }, []) // eslint-disable-line react-hooks/exhaustive-deps
 33 | 
 34 |   useEffect(() => {
 35 |     if (autoScroll && textareaRef.current) {
 36 |       textareaRef.current.scrollTop = textareaRef.current.scrollHeight
 37 |     }
 38 |   }, [logs, autoScroll])
 39 | 
 40 |   const handleRefresh = () => {
 41 |     loadLogs(mode, lines)
 42 |   }
 43 | 
 44 |   const handleModeChange = (newMode: string) => {
 45 |     setMode(newMode as 'out' | 'err')
 46 |   }
 47 | 
 48 |   const toggleAutoRefresh = () => {
 49 |     if (autoRefresh > 0) {
 50 |       setAutoRefresh(0)
 51 |     } else {
 52 |       setAutoRefresh(5000) // 5 seconds
 53 |     }
 54 |   }
 55 | 
 56 |   return (
 57 |     <div className="flex flex-col gap-4 h-full">
 58 |       <Card className={expanded ? 'fixed inset-4 z-50 flex flex-col' : 'flex-1 flex flex-col'}>
 59 |         <CardHeader className="flex flex-row items-center justify-between shrink-0">
 60 |           <CardTitle>Logi PM2</CardTitle>
 61 |           <div className="flex items-center gap-2">
 62 |             <Tabs value={mode} onValueChange={handleModeChange}>
 63 |               <TabsList>
 64 |                 <TabsTrigger value="out">stdout</TabsTrigger>
 65 |                 <TabsTrigger value="err">stderr</TabsTrigger>
 66 |               </TabsList>
 67 |             </Tabs>
 68 |             <Button variant="outline" size="icon" onClick={() => setExpanded(!expanded)}>
 69 |               {expanded ? <Minimize2 className="h-4 w-4" /> : <Maximize2 className="h-4 w-4" />}
 70 |             </Button>
 71 |           </div>
 72 |         </CardHeader>
 73 |         <CardContent className="flex-1 flex flex-col gap-4 min-h-0">
 74 |           {/* Controls */}
 75 |           <div className="flex flex-wrap items-end gap-4 shrink-0">
 76 |             <div className="space-y-2">
 77 |               <Label htmlFor="lines">Liczba linii</Label>
 78 |               <Input
 79 |                 id="lines"
 80 |                 type="number"
 81 |                 className="w-24"
 82 |                 value={lines}
 83 |                 onChange={(e) => setLines(Number(e.target.value) || 200)}
 84 |                 min={20}
 85 |                 max={2000}
 86 |               />
 87 |             </div>
 88 | 
 89 |             <Button variant="outline" onClick={handleRefresh} disabled={loading}>
 90 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
 91 |               Wczytaj
 92 |             </Button>
 93 | 
 94 |             <Button
 95 |               variant={autoRefresh > 0 ? 'default' : 'outline'}
 96 |               onClick={toggleAutoRefresh}
 97 |             >
 98 |               Auto: {autoRefresh > 0 ? 'WL' : 'WYL'}
 99 |             </Button>
100 | 
101 |             <div className="flex items-center gap-2">
102 |               <Checkbox
103 |                 id="autoScroll"
104 |                 checked={autoScroll}
105 |                 onCheckedChange={(checked) => setAutoScroll(!!checked)}
106 |               />
107 |               <Label htmlFor="autoScroll">Auto-scroll</Label>
108 |             </div>
109 |           </div>
110 | 
111 |           {error && (
112 |             <p className="text-destructive text-sm shrink-0">{error}</p>
113 |           )}
114 | 
115 |           {/* Log content */}
116 |           <Textarea
117 |             ref={textareaRef}
118 |             className="flex-1 font-mono text-xs resize-none min-h-[300px]"
119 |             value={logs}
120 |             readOnly
121 |             placeholder="Brak logow do wyswietlenia..."
122 |           />
123 | 
124 |           <p className="text-xs text-muted-foreground shrink-0">
125 |             Tryb: {mode.toUpperCase()} | Linii: {lines} | Auto-refresh: {autoRefresh > 0 ? `${autoRefresh / 1000}s` : 'wyl'}
126 |           </p>
127 |         </CardContent>
128 |       </Card>
129 |     </div>
130 |   )
131 | }
132 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Settings.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { useEffect, useState } from 'react'
  2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Switch } from '@/components/ui/switch'
  7 | import { Separator } from '@/components/ui/separator'
  8 | import {
  9 |   Play, Square, RotateCw, Save, RefreshCw,
 10 |   User, Bot, Zap, Terminal, Eye, Send, Bell, Link
 11 | } from 'lucide-react'
 12 | import { getEnv, setEnv, pm2Start, pm2Stop, pm2Restart } from '@/lib/api'
 13 | import type { EnvValues } from '@/lib/types'
 14 | 
 15 | interface FieldConfig {
 16 |   key: keyof EnvValues
 17 |   label: string
 18 |   type?: 'text' | 'password' | 'number' | 'switch' | 'select'
 19 |   placeholder?: string
 20 |   options?: { value: string; label: string }[]
 21 |   description?: string
 22 | }
 23 | 
 24 | interface SectionConfig {
 25 |   title: string
 26 |   icon: React.ReactNode
 27 |   description?: string
 28 |   fields: FieldConfig[]
 29 | }
 30 | 
 31 | const SECTIONS: SectionConfig[] = [
 32 |   {
 33 |     title: 'Watcher',
 34 |     icon: <Zap className="h-5 w-5" />,
 35 |     description: 'Ustawienia monitorowania komentarzy',
 36 |     fields: [
 37 |       { key: 'CHECK_INTERVAL_MS', label: 'Interwal sprawdzania (ms)', type: 'number', placeholder: '60000', description: 'Co ile ms sprawdzaƒá posty' },
 38 |       { key: 'FAST_MODE', label: 'Fast Mode', type: 'switch', description: 'Sortowanie "Najnowsze" dla szybszego wykrywania' },
 39 |       { key: 'INCLUDE_REPLIES', label: 'Uwzglƒôdniaj odpowiedzi', type: 'switch', description: 'Czy monitorowaƒá odpowiedzi na komentarze' },
 40 |     ],
 41 |   },
 42 |   {
 43 |     title: 'Logowanie',
 44 |     icon: <Terminal className="h-5 w-5" />,
 45 |     description: 'Poziom szczeg√≥≈Çowo≈õci log√≥w',
 46 |     fields: [
 47 |       {
 48 |         key: 'LOG_LEVEL',
 49 |         label: 'Poziom log√≥w',
 50 |         type: 'select',
 51 |         options: [
 52 |           { value: 'silent', label: 'Silent - brak log√≥w' },
 53 |           { value: 'production', label: 'Production - tylko wa≈ºne' },
 54 |           { value: 'dev', label: 'Dev - szczeg√≥≈Çowe' },
 55 |           { value: 'debug', label: 'Debug - wszystko' },
 56 |         ],
 57 |       },
 58 |     ],
 59 |   },
 60 |   {
 61 |     title: 'Puppeteer / Browser',
 62 |     icon: <Eye className="h-5 w-5" />,
 63 |     description: 'Ustawienia przeglƒÖdarki',
 64 |     fields: [
 65 |       { key: 'HEADLESS_BROWSER', label: 'Tryb headless', type: 'switch', description: 'Uruchamiaj bez widocznego okna' },
 66 |       { key: 'USE_UI_HANDLERS', label: 'UI Handlers', type: 'switch', description: 'U≈ºywaj handler√≥w UI do interakcji' },
 67 |       { key: 'COOKIES_READ_ONLY', label: 'Cookies tylko do odczytu', type: 'switch', description: 'Nie zapisuj zmian w cookies' },
 68 |     ],
 69 |   },
 70 |   {
 71 |     title: 'Facebook',
 72 |     icon: <User className="h-5 w-5" />,
 73 |     description: 'Dane logowania do FB',
 74 |     fields: [
 75 |       { key: 'FB_EMAIL', label: 'Email', placeholder: 'email@example.com' },
 76 |       { key: 'FB_PASSWORD', label: 'Has≈Ço', type: 'password', placeholder: '********' },
 77 |     ],
 78 |   },
 79 |   {
 80 |     title: '≈πr√≥d≈Ça post√≥w',
 81 |     icon: <Link className="h-5 w-5" />,
 82 |     description: 'SkƒÖd pobieraƒá listƒô post√≥w',
 83 |     fields: [
 84 |       { key: 'POSTS_API_URL', label: 'API URL', placeholder: 'http://server:3180/api/posts', description: 'Remote API panelu' },
 85 |       { key: 'POSTS_API_TOKEN', label: 'API Token', type: 'password', placeholder: 'fbw_xxx...' },
 86 |       { key: 'POSTS_SHEET_URL', label: 'Google Sheet URL', placeholder: 'https://docs.google.com/...', description: 'Fallback gdy API niedostƒôpne' },
 87 |     ],
 88 |   },
 89 |   {
 90 |     title: 'Telegram - W≈Ça≈õciciel',
 91 |     icon: <Send className="h-5 w-5" />,
 92 |     description: 'Powiadomienia do Ciebie',
 93 |     fields: [
 94 |       { key: 'TELEGRAM_SEND_TO_OWNER', label: 'Wysy≈Çaj do w≈Ça≈õciciela', type: 'switch' },
 95 |       { key: 'TELEGRAM_BOT_TOKEN_OWNER', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
 96 |       { key: 'TELEGRAM_CHAT_ID_OWNER', label: 'Chat ID', placeholder: '123456789' },
 97 |     ],
 98 |   },
 99 |   {
100 |     title: 'Telegram - Klient',
101 |     icon: <Bot className="h-5 w-5" />,
102 |     description: 'Powiadomienia do klienta',
103 |     fields: [
104 |       { key: 'TELEGRAM_SEND_TO_CLIENT', label: 'Wysy≈Çaj do klienta', type: 'switch' },
105 |       { key: 'TELEGRAM_BOT_TOKEN_CLIENT', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
106 |       { key: 'TELEGRAM_CHAT_ID_CLIENT', label: 'Chat ID', placeholder: '123456789' },
107 |     ],
108 |   },
109 |   {
110 |     title: 'Telegram - Format',
111 |     icon: <Send className="h-5 w-5" />,
112 |     description: 'Formatowanie wiadomo≈õci',
113 |     fields: [
114 |       { key: 'TELEGRAM_USE_PHOTO', label: 'Wysy≈Çaj ze zdjƒôciem', type: 'switch', description: 'Do≈ÇƒÖcz miniaturƒô posta' },
115 |       { key: 'TELEGRAM_DISABLE_WEB_PAGE_PREVIEW', label: 'Wy≈ÇƒÖcz podglƒÖd link√≥w', type: 'switch' },
116 |     ],
117 |   },
118 |   {
119 |     title: 'Telegram - Alerty',
120 |     icon: <Bell className="h-5 w-5" />,
121 |     description: 'Alerty o b≈Çƒôdach z log√≥w',
122 |     fields: [
123 |       { key: 'TG_ALERTS_ENABLED', label: 'W≈ÇƒÖcz alerty', type: 'switch' },
124 |       { key: 'TG_ALERTS_COOLDOWN_SEC', label: 'Cooldown (sek)', type: 'number', placeholder: '120', description: 'Minimalny odstƒôp miƒôdzy alertami' },
125 |       { key: 'TG_ALERTS_MAXLEN', label: 'Max d≈Çugo≈õƒá', type: 'number', placeholder: '3500', description: 'Maksymalna d≈Çugo≈õƒá wiadomo≈õci' },
126 |     ],
127 |   },
128 | ]
129 | 
130 | function isTruthy(val: string): boolean {
131 |   return val === 'true' || val === '1' || val === 'yes'
132 | }
133 | 
134 | function boolToEnv(val: boolean): string {
135 |   return val ? 'true' : 'false'
136 | }
137 | 
138 | export function Settings() {
139 |   const [values, setValues] = useState<EnvValues | null>(null)
140 |   const [loading, setLoading] = useState(false)
141 |   const [saving, setSaving] = useState(false)
142 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
143 |   const [pm2Loading, setPm2Loading] = useState<string | null>(null)
144 | 
145 |   const showMessage = (text: string, type: 'success' | 'error') => {
146 |     setMessage({ text, type })
147 |     setTimeout(() => setMessage(null), 3000)
148 |   }
149 | 
150 |   const loadEnv = async () => {
151 |     setLoading(true)
152 |     try {
153 |       const result = await getEnv()
154 |       if (result.ok) {
155 |         setValues(result.values)
156 |       } else {
157 |         showMessage(result.error || 'Nie udalo sie wczytac ustawien', 'error')
158 |       }
159 |     } catch {
160 |       showMessage('Blad polaczenia', 'error')
161 |     } finally {
162 |       setLoading(false)
163 |     }
164 |   }
165 | 
166 |   useEffect(() => {
167 |     loadEnv()
168 |   }, [])
169 | 
170 |   const handleChange = (key: keyof EnvValues, value: string) => {
171 |     if (values) {
172 |       setValues({ ...values, [key]: value })
173 |     }
174 |   }
175 | 
176 |   const handleSwitchChange = (key: keyof EnvValues, checked: boolean) => {
177 |     if (values) {
178 |       setValues({ ...values, [key]: boolToEnv(checked) })
179 |     }
180 |   }
181 | 
182 |   const handleSave = async (restart = false) => {
183 |     if (!values) return
184 | 
185 |     setSaving(true)
186 |     try {
187 |       const envRecord: Record<string, string> = {}
188 |       for (const key of Object.keys(values) as (keyof typeof values)[]) {
189 |         envRecord[key] = values[key]
190 |       }
191 |       const result = await setEnv(envRecord, restart)
192 |       if (result.ok) {
193 |         showMessage(restart ? 'Zapisano i zrestartowano' : 'Zapisano ustawienia', 'success')
194 |       } else {
195 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
196 |       }
197 |     } catch {
198 |       showMessage('Blad polaczenia', 'error')
199 |     } finally {
200 |       setSaving(false)
201 |     }
202 |   }
203 | 
204 |   const handlePm2Action = async (action: 'start' | 'stop' | 'restart') => {
205 |     setPm2Loading(action)
206 |     try {
207 |       const fn = action === 'start' ? pm2Start : action === 'stop' ? pm2Stop : pm2Restart
208 |       const result = await fn()
209 |       if (result.ok) {
210 |         const labels = { start: 'Uruchomiono', stop: 'Zatrzymano', restart: 'Zrestartowano' }
211 |         showMessage(labels[action], 'success')
212 |       } else {
213 |         showMessage(result.error || `Nie udalo sie ${action}`, 'error')
214 |       }
215 |     } catch {
216 |       showMessage('Blad polaczenia', 'error')
217 |     } finally {
218 |       setPm2Loading(null)
219 |     }
220 |   }
221 | 
222 |   const renderField = (field: FieldConfig) => {
223 |     if (!values) return null
224 |     const value = values[field.key] || ''
225 | 
226 |     if (field.type === 'switch') {
227 |       return (
228 |         <div key={field.key} className="flex items-center justify-between py-2">
229 |           <div className="space-y-0.5">
230 |             <Label htmlFor={field.key}>{field.label}</Label>
231 |             {field.description && (
232 |               <p className="text-xs text-muted-foreground">{field.description}</p>
233 |             )}
234 |           </div>
235 |           <Switch
236 |             id={field.key}
237 |             checked={isTruthy(value)}
238 |             onCheckedChange={(checked) => handleSwitchChange(field.key, checked)}
239 |           />
240 |         </div>
241 |       )
242 |     }
243 | 
244 |     if (field.type === 'select' && field.options) {
245 |       return (
246 |         <div key={field.key} className="space-y-2">
247 |           <Label htmlFor={field.key}>{field.label}</Label>
248 |           <select
249 |             id={field.key}
250 |             value={value}
251 |             onChange={(e) => handleChange(field.key, e.target.value)}
252 |             className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
253 |           >
254 |             {field.options.map((opt) => (
255 |               <option key={opt.value} value={opt.value}>
256 |                 {opt.label}
257 |               </option>
258 |             ))}
259 |           </select>
260 |         </div>
261 |       )
262 |     }
263 | 
264 |     return (
265 |       <div key={field.key} className="space-y-2">
266 |         <Label htmlFor={field.key}>{field.label}</Label>
267 |         <Input
268 |           id={field.key}
269 |           type={field.type || 'text'}
270 |           placeholder={field.placeholder}
271 |           value={value}
272 |           onChange={(e) => handleChange(field.key, e.target.value)}
273 |         />
274 |         {field.description && (
275 |           <p className="text-xs text-muted-foreground">{field.description}</p>
276 |         )}
277 |       </div>
278 |     )
279 |   }
280 | 
281 |   return (
282 |     <div className="flex flex-col gap-4">
283 |       {message && (
284 |         <div
285 |           className={`p-3 rounded-md text-sm ${
286 |             message.type === 'success'
287 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
288 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
289 |           }`}
290 |         >
291 |           {message.text}
292 |         </div>
293 |       )}
294 | 
295 |       {/* PM2 Controls */}
296 |       <Card>
297 |         <CardHeader>
298 |           <CardTitle>PM2 Controls</CardTitle>
299 |           <CardDescription>Zarzadzanie procesem watchera</CardDescription>
300 |         </CardHeader>
301 |         <CardContent>
302 |           <div className="flex flex-wrap gap-2">
303 |             <Button
304 |               variant="outline"
305 |               onClick={() => handlePm2Action('start')}
306 |               disabled={!!pm2Loading}
307 |             >
308 |               <Play className="h-4 w-4 mr-2" />
309 |               {pm2Loading === 'start' ? 'Uruchamianie...' : 'Start'}
310 |             </Button>
311 |             <Button
312 |               variant="outline"
313 |               onClick={() => handlePm2Action('stop')}
314 |               disabled={!!pm2Loading}
315 |             >
316 |               <Square className="h-4 w-4 mr-2" />
317 |               {pm2Loading === 'stop' ? 'Zatrzymywanie...' : 'Stop'}
318 |             </Button>
319 |             <Button
320 |               variant="outline"
321 |               onClick={() => handlePm2Action('restart')}
322 |               disabled={!!pm2Loading}
323 |             >
324 |               <RotateCw className="h-4 w-4 mr-2" />
325 |               {pm2Loading === 'restart' ? 'Restartowanie...' : 'Restart'}
326 |             </Button>
327 |           </div>
328 |         </CardContent>
329 |       </Card>
330 | 
331 |       {/* Save buttons - sticky */}
332 |       <Card className="sticky top-4 z-10 border-primary/50">
333 |         <CardContent className="pt-4">
334 |           <div className="flex flex-wrap items-center justify-between gap-2">
335 |             <Button variant="outline" size="sm" onClick={loadEnv} disabled={loading}>
336 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
337 |               Wczytaj ponownie
338 |             </Button>
339 |             <div className="flex gap-2">
340 |               <Button onClick={() => handleSave(false)} disabled={saving}>
341 |                 <Save className="h-4 w-4 mr-2" />
342 |                 {saving ? 'Zapisywanie...' : 'Zapisz'}
343 |               </Button>
344 |               <Button variant="secondary" onClick={() => handleSave(true)} disabled={saving}>
345 |                 <RotateCw className="h-4 w-4 mr-2" />
346 |                 Zapisz i restartuj
347 |               </Button>
348 |             </div>
349 |           </div>
350 |         </CardContent>
351 |       </Card>
352 | 
353 |       {/* Settings sections */}
354 |       {values && SECTIONS.map((section) => (
355 |         <Card key={section.title}>
356 |           <CardHeader>
357 |             <CardTitle className="flex items-center gap-2 text-lg">
358 |               {section.icon}
359 |               {section.title}
360 |             </CardTitle>
361 |             {section.description && (
362 |               <CardDescription>{section.description}</CardDescription>
363 |             )}
364 |           </CardHeader>
365 |           <CardContent className="space-y-4">
366 |             {section.fields.map((field, idx) => (
367 |               <div key={field.key}>
368 |                 {renderField(field)}
369 |                 {idx < section.fields.length - 1 && field.type !== 'switch' && (
370 |                   <Separator className="mt-4" />
371 |                 )}
372 |               </div>
373 |             ))}
374 |           </CardContent>
375 |         </Card>
376 |       ))}
377 |     </div>
378 |   )
379 | }
380 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Sources.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
 1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
 2 | import { Globe, Clock } from 'lucide-react'
 3 | 
 4 | export function Sources() {
 5 |   return (
 6 |     <div className="flex flex-col gap-4">
 7 |       <Card>
 8 |         <CardHeader>
 9 |           <div className="flex items-center gap-3">
10 |             <div className="p-2 bg-muted rounded-lg">
11 |               <Globe className="h-6 w-6" />
12 |             </div>
13 |             <div>
14 |               <CardTitle>Zrodla monitorowania</CardTitle>
15 |               <CardDescription>Zarzadzaj zrodlami postow do monitorowania</CardDescription>
16 |             </div>
17 |           </div>
18 |         </CardHeader>
19 |         <CardContent>
20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
23 |             <p className="text-muted-foreground max-w-md">
24 |               Ta funkcja pozwoli na automatyczne wykrywanie postow z roznych zrodel:
25 |               glownego feedu, grup, czy Meta Ads Library.
26 |             </p>
27 |           </div>
28 |         </CardContent>
29 |       </Card>
30 | 
31 |       <Card>
32 |         <CardHeader>
33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
34 |         </CardHeader>
35 |         <CardContent>
36 |           <ul className="space-y-2 text-sm text-muted-foreground">
37 |             <li>‚Ä¢ Monitorowanie glownego feedu FB</li>
38 |             <li>‚Ä¢ Monitorowanie wybranych grup</li>
39 |             <li>‚Ä¢ Integracja z Meta Ads Library</li>
40 |             <li>‚Ä¢ Filtrowanie po slowach kluczowych</li>
41 |             <li>‚Ä¢ Automatyczne dodawanie wykrytych postow</li>
42 |           </ul>
43 |         </CardContent>
44 |       </Card>
45 |     </div>
46 |   )
47 | }
48 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Watched.tsx`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```tsx
  1 | import { useEffect, useState, useCallback } from 'react'
  2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
  3 | import { Button } from '@/components/ui/button'
  4 | import { Input } from '@/components/ui/input'
  5 | import { Label } from '@/components/ui/label'
  6 | import { Checkbox } from '@/components/ui/checkbox'
  7 | import {
  8 |   Table,
  9 |   TableBody,
 10 |   TableCell,
 11 |   TableHead,
 12 |   TableHeader,
 13 |   TableRow,
 14 | } from '@/components/ui/table'
 15 | import {
 16 |   Dialog,
 17 |   DialogContent,
 18 |   DialogDescription,
 19 |   DialogFooter,
 20 |   DialogHeader,
 21 |   DialogTitle,
 22 | } from '@/components/ui/dialog'
 23 | import { Plus, Pencil, Trash2, ExternalLink, Copy, RefreshCw } from 'lucide-react'
 24 | import { getPosts, addPost, updatePost, deletePost } from '@/lib/api'
 25 | import type { Post } from '@/lib/types'
 26 | 
 27 | export function Watched() {
 28 |   const [posts, setPosts] = useState<Post[]>([])
 29 |   const [loading, setLoading] = useState(false)
 30 |   const [error, setError] = useState<string | null>(null)
 31 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
 32 | 
 33 |   // Add form state
 34 |   const [newUrl, setNewUrl] = useState('')
 35 |   const [newName, setNewName] = useState('')
 36 |   const [newImage, setNewImage] = useState('')
 37 |   const [newActive, setNewActive] = useState(true)
 38 |   const [adding, setAdding] = useState(false)
 39 | 
 40 |   // Edit dialog state
 41 |   const [editPost, setEditPost] = useState<Post | null>(null)
 42 |   const [editUrl, setEditUrl] = useState('')
 43 |   const [editName, setEditName] = useState('')
 44 |   const [editImage, setEditImage] = useState('')
 45 |   const [saving, setSaving] = useState(false)
 46 | 
 47 |   // Delete dialog state
 48 |   const [deleteTarget, setDeleteTarget] = useState<Post | null>(null)
 49 |   const [deleting, setDeleting] = useState(false)
 50 | 
 51 |   const loadPosts = useCallback(async () => {
 52 |     setLoading(true)
 53 |     setError(null)
 54 |     try {
 55 |       const result = await getPosts()
 56 |       if (result.ok) {
 57 |         setPosts(result.posts)
 58 |       } else {
 59 |         setError(result.error || 'Nie udalo sie pobrac postow')
 60 |       }
 61 |     } catch {
 62 |       setError('Blad polaczenia')
 63 |     } finally {
 64 |       setLoading(false)
 65 |     }
 66 |   }, [])
 67 | 
 68 |   useEffect(() => {
 69 |     loadPosts()
 70 |   }, [loadPosts])
 71 | 
 72 |   const showMessage = (text: string, type: 'success' | 'error') => {
 73 |     setMessage({ text, type })
 74 |     setTimeout(() => setMessage(null), 3000)
 75 |   }
 76 | 
 77 |   const handleAdd = async () => {
 78 |     if (!newUrl.trim()) {
 79 |       showMessage('Podaj URL posta', 'error')
 80 |       return
 81 |     }
 82 | 
 83 |     setAdding(true)
 84 |     try {
 85 |       const result = await addPost({
 86 |         url: newUrl.trim(),
 87 |         name: newName.trim(),
 88 |         image: newImage.trim(),
 89 |         active: newActive,
 90 |       })
 91 | 
 92 |       if (result.ok) {
 93 |         showMessage('Post dodany', 'success')
 94 |         setNewUrl('')
 95 |         setNewName('')
 96 |         setNewImage('')
 97 |         setNewActive(true)
 98 |         loadPosts()
 99 |       } else {
100 |         showMessage(result.error || 'Nie udalo sie dodac posta', 'error')
101 |       }
102 |     } catch {
103 |       showMessage('Blad polaczenia', 'error')
104 |     } finally {
105 |       setAdding(false)
106 |     }
107 |   }
108 | 
109 |   const handleToggleActive = async (post: Post) => {
110 |     try {
111 |       const result = await updatePost(post.id, { active: !post.active })
112 |       if (result.ok) {
113 |         loadPosts()
114 |       } else {
115 |         showMessage(result.error || 'Nie udalo sie zmienic statusu', 'error')
116 |       }
117 |     } catch {
118 |       showMessage('Blad polaczenia', 'error')
119 |     }
120 |   }
121 | 
122 |   const openEditDialog = (post: Post) => {
123 |     setEditPost(post)
124 |     setEditUrl(post.url)
125 |     setEditName(post.name)
126 |     setEditImage(post.image)
127 |   }
128 | 
129 |   const handleEdit = async () => {
130 |     if (!editPost) return
131 | 
132 |     setSaving(true)
133 |     try {
134 |       const result = await updatePost(editPost.id, {
135 |         url: editUrl.trim(),
136 |         name: editName.trim(),
137 |         image: editImage.trim(),
138 |       })
139 | 
140 |       if (result.ok) {
141 |         showMessage('Zapisano zmiany', 'success')
142 |         setEditPost(null)
143 |         loadPosts()
144 |       } else {
145 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
146 |       }
147 |     } catch {
148 |       showMessage('Blad polaczenia', 'error')
149 |     } finally {
150 |       setSaving(false)
151 |     }
152 |   }
153 | 
154 |   const handleDelete = async () => {
155 |     if (!deleteTarget) return
156 | 
157 |     setDeleting(true)
158 |     try {
159 |       const result = await deletePost(deleteTarget.id)
160 |       if (result.ok) {
161 |         showMessage('Post usuniety', 'success')
162 |         setDeleteTarget(null)
163 |         loadPosts()
164 |       } else {
165 |         showMessage(result.error || 'Nie udalo sie usunac', 'error')
166 |       }
167 |     } catch {
168 |       showMessage('Blad polaczenia', 'error')
169 |     } finally {
170 |       setDeleting(false)
171 |     }
172 |   }
173 | 
174 |   const copyToClipboard = async (text: string) => {
175 |     try {
176 |       await navigator.clipboard.writeText(text)
177 |       showMessage('Skopiowano do schowka', 'success')
178 |     } catch {
179 |       showMessage('Nie udalo sie skopiowac', 'error')
180 |     }
181 |   }
182 | 
183 |   return (
184 |     <div className="flex flex-col gap-4">
185 |       {message && (
186 |         <div
187 |           className={`p-3 rounded-md text-sm ${
188 |             message.type === 'success'
189 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
190 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
191 |           }`}
192 |         >
193 |           {message.text}
194 |         </div>
195 |       )}
196 | 
197 |       {/* Add form */}
198 |       <Card>
199 |         <CardHeader>
200 |           <CardTitle className="text-lg">Dodaj nowy post</CardTitle>
201 |         </CardHeader>
202 |         <CardContent>
203 |           <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
204 |             <div className="space-y-2">
205 |               <Label htmlFor="newUrl">URL posta *</Label>
206 |               <Input
207 |                 id="newUrl"
208 |                 placeholder="https://www.facebook.com/..."
209 |                 value={newUrl}
210 |                 onChange={(e) => setNewUrl(e.target.value)}
211 |               />
212 |             </div>
213 |             <div className="space-y-2">
214 |               <Label htmlFor="newName">Nazwa</Label>
215 |               <Input
216 |                 id="newName"
217 |                 placeholder="Opcjonalna nazwa"
218 |                 value={newName}
219 |                 onChange={(e) => setNewName(e.target.value)}
220 |               />
221 |             </div>
222 |             <div className="space-y-2">
223 |               <Label htmlFor="newImage">URL obrazka</Label>
224 |               <Input
225 |                 id="newImage"
226 |                 placeholder="https://..."
227 |                 value={newImage}
228 |                 onChange={(e) => setNewImage(e.target.value)}
229 |               />
230 |             </div>
231 |             <div className="flex items-end gap-4">
232 |               <div className="flex items-center gap-2">
233 |                 <Checkbox
234 |                   id="newActive"
235 |                   checked={newActive}
236 |                   onCheckedChange={(checked) => setNewActive(!!checked)}
237 |                 />
238 |                 <Label htmlFor="newActive">Aktywny</Label>
239 |               </div>
240 |               <Button onClick={handleAdd} disabled={adding}>
241 |                 <Plus className="h-4 w-4 mr-2" />
242 |                 {adding ? 'Dodawanie...' : 'Dodaj'}
243 |               </Button>
244 |             </div>
245 |           </div>
246 |         </CardContent>
247 |       </Card>
248 | 
249 |       {/* Posts table */}
250 |       <Card>
251 |         <CardHeader className="flex flex-row items-center justify-between">
252 |           <CardTitle className="text-lg">Obserwowane posty ({posts.length})</CardTitle>
253 |           <Button variant="outline" size="sm" onClick={loadPosts} disabled={loading}>
254 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
255 |             Odswiez
256 |           </Button>
257 |         </CardHeader>
258 |         <CardContent>
259 |           {error && <p className="text-destructive mb-4">{error}</p>}
260 | 
261 |           <Table>
262 |             <TableHeader>
263 |               <TableRow>
264 |                 <TableHead className="w-[60px]">ID</TableHead>
265 |                 <TableHead>URL</TableHead>
266 |                 <TableHead>Nazwa</TableHead>
267 |                 <TableHead className="w-[260px]">Obrazek</TableHead>
268 |                 <TableHead className="w-[80px]">Aktywny</TableHead>
269 |                 <TableHead className="w-[120px]">Akcje</TableHead>
270 |               </TableRow>
271 |             </TableHeader>
272 |             <TableBody>
273 |               {posts.map((post) => (
274 |                 <TableRow key={post.id}>
275 |                   <TableCell className="font-mono text-xs">{post.id.slice(0, 6)}</TableCell>
276 |                   <TableCell>
277 |                     <div className="flex items-center gap-2 max-w-md">
278 |                       <a
279 |                         href={post.url}
280 |                         target="_blank"
281 |                         rel="noopener noreferrer"
282 |                         className="text-blue-400 hover:underline truncate text-sm"
283 |                       >
284 |                         {post.url}
285 |                       </a>
286 |                       <Button
287 |                         variant="ghost"
288 |                         size="icon"
289 |                         className="h-6 w-6 shrink-0"
290 |                         onClick={() => copyToClipboard(post.url)}
291 |                       >
292 |                         <Copy className="h-3 w-3" />
293 |                       </Button>
294 |                       <a
295 |                         href={post.url}
296 |                         target="_blank"
297 |                         rel="noopener noreferrer"
298 |                         className="shrink-0"
299 |                       >
300 |                         <ExternalLink className="h-3 w-3 text-muted-foreground" />
301 |                       </a>
302 |                     </div>
303 |                   </TableCell>
304 |                   <TableCell className="max-w-[150px] truncate">{post.name || '-'}</TableCell>
305 |                   <TableCell>
306 |                     {post.image ? (
307 |                       <img
308 |   src={post.image}
309 |   alt=""
310 |   className="w-[220px] h-[120px] object-contain rounded-md bg-black/20 transition-transform duration-200 hover:scale-[1.03] cursor-zoom-in"
311 | />
312 | 
313 |                     ) : (
314 |                       '-'
315 |                     )}
316 |                   </TableCell>
317 |                   <TableCell>
318 |                     <Checkbox
319 |                       checked={post.active}
320 |                       onCheckedChange={() => handleToggleActive(post)}
321 |                     />
322 |                   </TableCell>
323 |                   <TableCell>
324 |                     <div className="flex items-center gap-1">
325 |                       <Button
326 |                         variant="ghost"
327 |                         size="icon"
328 |                         className="h-8 w-8"
329 |                         onClick={() => openEditDialog(post)}
330 |                       >
331 |                         <Pencil className="h-4 w-4" />
332 |                       </Button>
333 |                       <Button
334 |                         variant="ghost"
335 |                         size="icon"
336 |                         className="h-8 w-8 text-destructive hover:text-destructive"
337 |                         onClick={() => setDeleteTarget(post)}
338 |                       >
339 |                         <Trash2 className="h-4 w-4" />
340 |                       </Button>
341 |                     </div>
342 |                   </TableCell>
343 |                 </TableRow>
344 |               ))}
345 |               {posts.length === 0 && !loading && (
346 |                 <TableRow>
347 |                   <TableCell colSpan={6} className="text-center text-muted-foreground py-8">
348 |                     Brak obserwowanych postow. Dodaj pierwszy powyzej.
349 |                   </TableCell>
350 |                 </TableRow>
351 |               )}
352 |             </TableBody>
353 |           </Table>
354 |         </CardContent>
355 |       </Card>
356 | 
357 |       {/* Edit dialog */}
358 |       <Dialog open={!!editPost} onOpenChange={(open) => !open && setEditPost(null)}>
359 |         <DialogContent>
360 |           <DialogHeader>
361 |             <DialogTitle>Edytuj post</DialogTitle>
362 |             <DialogDescription>Zmien dane obserwowanego posta</DialogDescription>
363 |           </DialogHeader>
364 |           <div className="grid gap-4 py-4">
365 |             <div className="space-y-2">
366 |               <Label htmlFor="editUrl">URL</Label>
367 |               <Input
368 |                 id="editUrl"
369 |                 value={editUrl}
370 |                 onChange={(e) => setEditUrl(e.target.value)}
371 |               />
372 |             </div>
373 |             <div className="space-y-2">
374 |               <Label htmlFor="editName">Nazwa</Label>
375 |               <Input
376 |                 id="editName"
377 |                 value={editName}
378 |                 onChange={(e) => setEditName(e.target.value)}
379 |               />
380 |             </div>
381 |             <div className="space-y-2">
382 |               <Label htmlFor="editImage">URL obrazka</Label>
383 |               <Input
384 |                 id="editImage"
385 |                 value={editImage}
386 |                 onChange={(e) => setEditImage(e.target.value)}
387 |               />
388 |             </div>
389 |           </div>
390 |           <DialogFooter>
391 |             <Button variant="outline" onClick={() => setEditPost(null)}>
392 |               Anuluj
393 |             </Button>
394 |             <Button onClick={handleEdit} disabled={saving}>
395 |               {saving ? 'Zapisywanie...' : 'Zapisz'}
396 |             </Button>
397 |           </DialogFooter>
398 |         </DialogContent>
399 |       </Dialog>
400 | 
401 |       {/* Delete confirmation dialog */}
402 |       <Dialog open={!!deleteTarget} onOpenChange={(open) => !open && setDeleteTarget(null)}>
403 |         <DialogContent>
404 |           <DialogHeader>
405 |             <DialogTitle>Usunac post?</DialogTitle>
406 |             <DialogDescription>Ta operacja jest nieodwracalna.</DialogDescription>
407 |           </DialogHeader>
408 |           {deleteTarget && (
409 |             <div className="py-4">
410 |               <p className="font-medium">{deleteTarget.name || 'Bez nazwy'}</p>
411 |               <p className="text-sm text-muted-foreground break-all mt-1">
412 |                 {deleteTarget.url}
413 |               </p>
414 |             </div>
415 |           )}
416 |           <DialogFooter>
417 |             <Button variant="outline" onClick={() => setDeleteTarget(null)}>
418 |               Anuluj
419 |             </Button>
420 |             <Button variant="destructive" onClick={handleDelete} disabled={deleting}>
421 |               {deleting ? 'Usuwanie...' : 'Usun'}
422 |             </Button>
423 |           </DialogFooter>
424 |         </DialogContent>
425 |       </Dialog>
426 |     </div>
427 |   )
428 | }
429 | 
```

---

### üìÑ ≈öcie≈ºka: `src/panel/web/src/vite-env.d.ts`
**Typ:** TypeScript  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```ts
1 | /// <reference types="vite/client" />
2 | 
```

---

### üìÑ ≈öcie≈ºka: `src/telegram.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/telegram.js
  2 | import axios from "axios";
  3 | import log from "./utils/logger.js";
  4 | 
  5 | /* ============================================================
  6 |    FILTR WIEKU KOMENTARZA (TELEGRAM)
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 |   const t = String(raw).toLowerCase().trim();
 12 |   const now = new Date();
 13 | 
 14 |   if (t.includes("przed chwilƒÖ")) return now;
 15 |   if (t.includes("w≈Ça≈õnie teraz") || t === "teraz" || t === "now" || t === "just now") return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   // Obs≈Çugujemy polskie i angielskie skr√≥ty
 24 |   // np: 15 sek., 5 min, 2 godz., 1 dzie≈Ñ, 4 tyg., 4 weeks
 25 |   const m = t.match(/(\d+)\s*(sek\.?|s|sec|secs|second|seconds|min\.?|m|minut|minuty|minutƒô|godz\.?|h|hr|hour|hours|dni|dzie≈Ñ|d|tyg\.?|week|weeks)\b/);
 26 |   if (!m) return null;
 27 | 
 28 |   const value = parseInt(m[1], 10);
 29 |   if (!Number.isFinite(value)) return null;
 30 | 
 31 |   const unit = m[2];
 32 |   const d = new Date(now);
 33 | 
 34 |   if (unit.startsWith("sek") || unit === "s" || unit.startsWith("sec") || unit.startsWith("second")) d.setSeconds(d.getSeconds() - value);
 35 |   else if (unit.startsWith("min") || unit === "m") d.setMinutes(d.getMinutes() - value);
 36 |   else if (unit.startsWith("godz") || unit === "h" || unit === "hr" || unit.startsWith("hour")) d.setHours(d.getHours() - value);
 37 |   else if (unit.startsWith("dni") || unit.startsWith("dzie") || unit === "d") d.setDate(d.getDate() - value);
 38 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
 39 | 
 40 |   return d;
 41 | }
 42 | 
 43 | function shouldSendByAge(comment) {
 44 |   // ENV:
 45 |   // TELEGRAM_MAX_AGE_MIN=60
 46 |   // TELEGRAM_DROP_IF_NO_TIME=1  (domy≈õlnie: 1)
 47 |   const maxAgeMin = Number(process.env.TELEGRAM_MAX_AGE_MIN || 60);
 48 |   const dropIfNoTime = envBool("TELEGRAM_DROP_IF_NO_TIME", true);
 49 | 
 50 |   const rel = String(comment?.fb_time_raw || comment?.time || comment?.relative_time || "").trim();
 51 |   if (!rel) return !dropIfNoTime;
 52 | 
 53 |   const abs = parseFbRelativeTime(rel);
 54 |   if (!abs) return !dropIfNoTime;
 55 | 
 56 |   const ageMinutes = (Date.now() - abs.getTime()) / 60000;
 57 |   return ageMinutes <= maxAgeMin;
 58 | }
 59 | 
 60 | function envBool(name, def = false) {
 61 |   const v = String(process.env[name] ?? "").trim().toLowerCase();
 62 |   if (!v) return def;
 63 |   return ["1", "true", "yes", "tak", "y", "on"].includes(v);
 64 | }
 65 | 
 66 | function escapeHtml(s) {
 67 |   if (s == null) return "";
 68 |   return String(s)
 69 |     .replaceAll("&", "&amp;")
 70 |     .replaceAll("<", "&lt;")
 71 |     .replaceAll(">", "&gt;")
 72 |     .replaceAll('"', "&quot;");
 73 | }
 74 | 
 75 | function buildCaptionHtml(post, c) {
 76 |   const postName = escapeHtml(post?.name || "");
 77 |   const postDesc = escapeHtml(post?.description || "");
 78 |   const author = escapeHtml(c?.author || c?.name || "");
 79 |   const text = escapeHtml(c?.text || c?.message || "");
 80 |   const rel = escapeHtml(c?.fb_time_raw || c?.time || c?.relative_time || "");
 81 |   const url = String(post?.url || "").trim();
 82 | 
 83 |   const postLine = postDesc ? `${postName} ‚Äî ${postDesc}` : postName;
 84 | 
 85 |   return (
 86 |     `<b>üì© Nowy komentarz na Facebooku</b>\n\n` +
 87 |     `<b>üë§ Autor:</b>\n${author || "-"}\n\n` +
 88 |     `<b>üïí Czas:</b>\n${rel || "-"}\n\n` +
 89 |     `<b>üìù Tre≈õƒá:</b>\n${text || "-"}\n\n` +
 90 |     `<b>üìå Post:</b>\n${postLine || "-"}\n\n` +
 91 |     (url ? `<a href="${escapeHtml(url)}">üëâ Otw√≥rz post</a>` : "")
 92 |   );
 93 | }
 94 | 
 95 | async function tgRequest(token, method, payload) {
 96 |   const t = String(token || "").trim();
 97 |   if (!t) return { ok: false, error: "Brak tokena bota" };
 98 | 
 99 |   const endpoint = `https://api.telegram.org/bot${t}/${method}`;
100 | 
101 |   try {
102 |     const res = await axios.post(endpoint, payload, { timeout: 15000 });
103 |     if (res?.data?.ok) return { ok: true, data: res.data };
104 |     return { ok: false, error: res?.data?.description || "Telegram error" };
105 |   } catch (e) {
106 |     return {
107 |       ok: false,
108 |       error: e?.response?.data?.description || e?.message || String(e),
109 |     };
110 |   }
111 | }
112 | 
113 | async function sendMessage(token, chat_id, text, opts = {}) {
114 |   const parse_mode = opts.parse_mode || "HTML";
115 |   const disable_web_page_preview = !!opts.disable_web_page_preview;
116 | 
117 |   return tgRequest(token, "sendMessage", {
118 |     chat_id,
119 |     text,
120 |     parse_mode,
121 |     disable_web_page_preview,
122 |   });
123 | }
124 | 
125 | async function sendPhoto(token, chat_id, photo, caption, opts = {}) {
126 |   const parse_mode = opts.parse_mode || "HTML";
127 |   return tgRequest(token, "sendPhoto", {
128 |     chat_id,
129 |     photo,
130 |     caption,
131 |     parse_mode,
132 |   });
133 | }
134 | 
135 | function getTargets() {
136 |   const sendOwner = envBool("TELEGRAM_SEND_TO_OWNER", true);
137 |   const sendClient = envBool("TELEGRAM_SEND_TO_CLIENT", true);
138 | 
139 |   const ownerToken = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
140 |   const ownerChat = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
141 | 
142 |   const clientToken = String(process.env.TELEGRAM_BOT_TOKEN_CLIENT || "").trim();
143 |   const clientChat = String(process.env.TELEGRAM_CHAT_ID_CLIENT || "").trim();
144 | 
145 |   const targets = [];
146 |   log.debug("TELEGRAM", "Targets config", {
147 |     sendOwner,
148 |     sendClient,
149 |     ownerToken: ownerToken ? ownerToken.slice(0, 12) + "..." : null,
150 |     ownerChat: ownerChat || null,
151 |     clientToken: clientToken ? clientToken.slice(0, 12) + "..." : null,
152 |     clientChat: clientChat || null,
153 |   });
154 | 
155 |   if (sendOwner && ownerToken && ownerChat) {
156 |     targets.push({ label: "OWNER", token: ownerToken, chat_id: ownerChat });
157 |   } else if (sendOwner) {
158 |     log.warn("TELEGRAM", "OWNER w≈ÇƒÖczony, ale brak tokena lub chat_id");
159 |   }
160 | 
161 |   if (sendClient && clientToken && clientChat) {
162 |     targets.push({ label: "CLIENT", token: clientToken, chat_id: clientChat });
163 |   } else if (sendClient) {
164 |     log.warn("TELEGRAM", "CLIENT w≈ÇƒÖczony, ale brak tokena lub chat_id");
165 |   }
166 | 
167 |   return targets;
168 | }
169 | 
170 | /**
171 |  * 1 komentarz => wysy≈Çka na 2 Telegramy:
172 |  * - Tw√≥j (Twoim botem)
173 |  * - Klienta (botem klienta)
174 |  */
175 | async function sendTelegramLead(post, comment) {
176 |   const targets = getTargets();
177 |   if (!targets.length) return;
178 | 
179 |   const usePhoto = envBool("TELEGRAM_USE_PHOTO", true);
180 |   const disablePreview = envBool("TELEGRAM_DISABLE_WEB_PAGE_PREVIEW", true);
181 | 
182 |   const caption = buildCaptionHtml(post, comment);
183 |   const img = String(post?.image || "").trim();
184 | 
185 |   for (const t of targets) {
186 |     if (usePhoto && img) {
187 |       const r1 = await sendPhoto(t.token, t.chat_id, img, caption, {
188 |         parse_mode: "HTML",
189 |       });
190 |       if (r1.ok) {
191 |         log.dev("TELEGRAM", `Wys≈Çano lead (photo) ‚Üí ${t.label}`);
192 |         await new Promise((r) => setTimeout(r, 350));
193 |         continue;
194 |       }
195 |       log.dev("TELEGRAM", `sendPhoto failed (${t.label}) ‚Üí fallback`, { error: r1.error });
196 |     }
197 | 
198 |     const r2 = await sendMessage(t.token, t.chat_id, caption, {
199 |       parse_mode: "HTML",
200 |       disable_web_page_preview: disablePreview,
201 |     });
202 | 
203 |     if (r2.ok) log.dev("TELEGRAM", `Wys≈Çano lead (message) ‚Üí ${t.label}`);
204 |     else log.error("TELEGRAM", `sendMessage error (${t.label}): ${r2.error}`);
205 | 
206 |     await new Promise((r) => setTimeout(r, 350));
207 |   }
208 | }
209 | 
210 | async function sendTelegramLeads(post, comments = []) {
211 |   for (const c of comments) {
212 |     await sendTelegramLead(post, c);
213 |     await new Promise((r) => setTimeout(r, 250));
214 |   }
215 | }
216 | 
217 | /* ============================================================
218 |    =======================  ALERTY OWNER  ======================
219 |    ============================================================ */
220 | 
221 | let _lastAlertAt = 0;
222 | let _lastAlertKey = "";
223 | let _repeatCount = 0;
224 | 
225 | function shorten(s, max) {
226 |   const x = String(s ?? "");
227 |   if (x.length <= max) return x;
228 |   return x.slice(0, max - 12) + "\n‚Ä¶(obciƒôto)‚Ä¶";
229 | }
230 | 
231 | function makeAlertKey(title, msg) {
232 |   const a = String(title || "").slice(0, 80);
233 |   const b = String(msg || "").slice(0, 200);
234 |   return `${a}::${b}`;
235 | }
236 | 
237 | async function sendOwnerAlert(title, message, opts = {}) {
238 |   if (!envBool("TG_ALERTS_ENABLED", true)) return;
239 | 
240 |   const token = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
241 |   const chatId = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
242 |   if (!token || !chatId) return;
243 | 
244 |   const cooldownSec = Number(process.env.TG_ALERTS_COOLDOWN_SEC || "120");
245 |   const maxLen = Number(process.env.TG_ALERTS_MAXLEN || "3500");
246 |   const tz = String(process.env.TG_ALERTS_TIMEZONE || "Europe/Warsaw").trim();
247 | 
248 |   const now = Date.now();
249 |   const key = makeAlertKey(title, message);
250 | 
251 |   // Anti-spam: je≈õli to samo w k√≥≈Çko w cooldownie, nie spamuj ‚Äî tylko licz
252 |   if (key === _lastAlertKey && now - _lastAlertAt < cooldownSec * 1000) {
253 |     _repeatCount++;
254 |     return;
255 |   }
256 | 
257 |   // Je≈õli wcze≈õniej co≈õ siƒô powtarza≈Ço, do≈õlij podsumowanie
258 |   if (_repeatCount > 0) {
259 |     const summary = `<b>‚ö†Ô∏è PowtarzajƒÖce siƒô b≈Çƒôdy</b>\n\nPoprzedni alert powt√≥rzy≈Ç siƒô <b>${_repeatCount}</b> razy w kr√≥tkim czasie.`;
260 |     await sendMessage(token, chatId, summary, { parse_mode: "HTML" }).catch(
261 |       () => {}
262 |     );
263 |     _repeatCount = 0;
264 |   }
265 | 
266 |   _lastAlertAt = now;
267 |   _lastAlertKey = key;
268 | 
269 |   // Lokalny czas PL (nie UTC)
270 |   const dt = new Date();
271 |   const tsLocal = new Intl.DateTimeFormat("pl-PL", {
272 |     timeZone: tz,
273 |     year: "numeric",
274 |     month: "2-digit",
275 |     day: "2-digit",
276 |     hour: "2-digit",
277 |     minute: "2-digit",
278 |     second: "2-digit",
279 |   }).format(dt);
280 | 
281 |   // Dla pewno≈õci dopisujemy te≈º UTC (kr√≥tkie), ≈ºeby ≈Çatwiej by≈Ço debugowaƒá serwer
282 |   const tsUtc = dt.toISOString().replace("T", " ").replace("Z", " UTC");
283 | 
284 |   const text =
285 |     `<b>üö® FB_Watcher ‚Äì ALERT</b>\n` +
286 |     `<b>üïí</b> ${escapeHtml(tsLocal)} (${escapeHtml(tz)})\n` +
287 |     `<b>üåç</b> ${escapeHtml(tsUtc)}\n\n` +
288 |     `<b>${escapeHtml(title || "B≈ÇƒÖd")}</b>\n\n` +
289 |     `<pre>${escapeHtml(shorten(message, maxLen))}</pre>`;
290 | 
291 |   const r = await sendMessage(token, chatId, text, {
292 |     parse_mode: "HTML",
293 |     disable_web_page_preview: true,
294 |   });
295 | 
296 |   if (!r.ok) {
297 |     // nie r√≥b pƒôtli error->alert->error
298 |     log.dev("TELEGRAM", `Alert nie wys≈Çany: ${r.error}`);
299 |   }
300 | }
301 | 
302 | 
303 | export { sendTelegramLead, sendTelegramLeads, sendOwnerAlert };
304 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/logger.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, itp.).  

```js
  1 | // src/utils/logger.js
  2 | // Ujednolicony system logowania z poziomami: SILENT(0), PROD(1), DEV(2), DEBUG(3)
  3 | 
  4 | /**
  5 |  * LOG_LEVEL:
  6 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
  7 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny)
  8 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings
  9 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info
 10 |  */
 11 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
 12 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
 13 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
 14 | 
 15 | // ANSI kolory
 16 | const colors = {
 17 |   reset: "\x1b[0m",
 18 |   dim: "\x1b[2m",
 19 |   red: "\x1b[31m",
 20 |   green: "\x1b[32m",
 21 |   yellow: "\x1b[33m",
 22 |   blue: "\x1b[34m",
 23 |   magenta: "\x1b[35m",
 24 |   cyan: "\x1b[36m",
 25 |   white: "\x1b[37m",
 26 |   gray: "\x1b[90m",
 27 | };
 28 | 
 29 | // Kolory dla modu≈Ç√≥w
 30 | const moduleColors = {
 31 |   WATCHER: colors.cyan,
 32 |   NAV: colors.blue,
 33 |   "UI:post": colors.magenta,
 34 |   "UI:videos": colors.magenta,
 35 |   "UI:photo": colors.magenta,
 36 |   "UI:watch": colors.magenta,
 37 |   FILTER: colors.yellow,
 38 |   EXTRACT: colors.green,
 39 |   DEDUP: colors.gray,
 40 |   TELEGRAM: colors.blue,
 41 |   WEBHOOK: colors.blue,
 42 |   API: colors.cyan,
 43 |   COOKIES: colors.gray,
 44 |   LOGIN: colors.yellow,
 45 |   ERROR: colors.red,
 46 |   FAST: colors.green,
 47 | };
 48 | 
 49 | function c(color, text) {
 50 |   if (!LOG_COLORS) return text;
 51 |   return `${color}${text}${colors.reset}`;
 52 | }
 53 | 
 54 | function timestamp() {
 55 |   if (!LOG_TIMESTAMPS) return "";
 56 |   const now = new Date();
 57 |   const hh = String(now.getHours()).padStart(2, "0");
 58 |   const mm = String(now.getMinutes()).padStart(2, "0");
 59 |   const ss = String(now.getSeconds()).padStart(2, "0");
 60 |   return c(colors.dim, `[${hh}:${mm}:${ss}]`) + " ";
 61 | }
 62 | 
 63 | function formatModule(mod) {
 64 |   const color = moduleColors[mod] || colors.white;
 65 |   return c(color, `[${mod}]`);
 66 | }
 67 | 
 68 | function formatData(data) {
 69 |   if (data === undefined || data === null) return "";
 70 |   if (typeof data === "string") return ` ${c(colors.dim, data)}`;
 71 |   if (typeof data === "number") return ` ${c(colors.dim, String(data))}`;
 72 | 
 73 |   // Object - poka≈º kluczowe info
 74 |   try {
 75 |     const keys = Object.keys(data);
 76 |     if (keys.length === 0) return "";
 77 | 
 78 |     const parts = [];
 79 |     for (const k of keys.slice(0, 5)) {
 80 |       const v = data[k];
 81 |       if (v === undefined || v === null) continue;
 82 |       if (typeof v === "string" && v.length > 50) {
 83 |         parts.push(`${k}:"${v.slice(0, 47)}..."`);
 84 |       } else if (typeof v === "object") {
 85 |         parts.push(`${k}:{...}`);
 86 |       } else {
 87 |         parts.push(`${k}:${JSON.stringify(v)}`);
 88 |       }
 89 |     }
 90 |     if (keys.length > 5) parts.push(`+${keys.length - 5} more`);
 91 |     return ` ${c(colors.dim, `(${parts.join(", ")})`)}`;
 92 |   } catch {
 93 |     return "";
 94 |   }
 95 | }
 96 | 
 97 | function formatDataFull(data) {
 98 |   if (data === undefined || data === null) return "";
 99 |   try {
100 |     return `\n${c(colors.dim, JSON.stringify(data, null, 2))}`;
101 |   } catch {
102 |     return "";
103 |   }
104 | }
105 | 
106 | /**
107 |  * Logger g≈Ç√≥wny
108 |  */
109 | const log = {
110 |   /** Poziom 0+ - B≈Çƒôdy krytyczne (zawsze pokazywane) */
111 |   error(mod, msg, data) {
112 |     const prefix = timestamp() + formatModule(mod || "ERROR");
113 |     console.error(`${prefix} ${c(colors.red, "‚úó")} ${msg}${formatData(data)}`);
114 |   },
115 | 
116 |   /** Poziom 0+ - Ostrze≈ºenia (zawsze pokazywane) */
117 |   warn(mod, msg, data) {
118 |     const prefix = timestamp() + formatModule(mod || "WARN");
119 |     console.warn(`${prefix} ${c(colors.yellow, "‚ö†")} ${msg}${formatData(data)}`);
120 |   },
121 | 
122 |   /** Poziom 1+ - PROD: Status cykli, nowe komentarze, kluczowe zdarzenia */
123 |   prod(mod, msg, data) {
124 |     if (LOG_LEVEL < 1) return;
125 |     const prefix = timestamp() + formatModule(mod);
126 |     console.log(`${prefix} ${msg}${formatData(data)}`);
127 |   },
128 | 
129 |   /** Poziom 1+ - PROD z ikonƒÖ sukcesu */
130 |   success(mod, msg, data) {
131 |     if (LOG_LEVEL < 1) return;
132 |     const prefix = timestamp() + formatModule(mod);
133 |     console.log(`${prefix} ${c(colors.green, "‚úì")} ${msg}${formatData(data)}`);
134 |   },
135 | 
136 |   /** Poziom 2+ - DEV: Szczeg√≥≈Çy operacji, timings */
137 |   dev(mod, msg, data) {
138 |     if (LOG_LEVEL < 2) return;
139 |     const prefix = timestamp() + formatModule(mod);
140 |     console.log(`${prefix} ${msg}${formatData(data)}`);
141 |   },
142 | 
143 |   /** Poziom 3+ - DEBUG: Pe≈Çne dumpy, payloady, DOM info */
144 |   debug(mod, msg, data) {
145 |     if (LOG_LEVEL < 3) return;
146 |     const prefix = timestamp() + formatModule(mod);
147 |     console.log(`${prefix} ${c(colors.gray, "[DBG]")} ${msg}${formatDataFull(data)}`);
148 |   },
149 | 
150 |   /** Separator wizualny (poziom 1+) */
151 |   separator(char = "‚îÄ", length = 50) {
152 |     if (LOG_LEVEL < 1) return;
153 |     console.log(c(colors.dim, char.repeat(length)));
154 |   },
155 | 
156 |   /** Nag≈Ç√≥wek sekcji (poziom 1+) */
157 |   header(title) {
158 |     if (LOG_LEVEL < 1) return;
159 |     console.log("");
160 |     console.log(c(colors.cyan, `‚ïê‚ïê‚ïê ${title} ${"‚ïê".repeat(Math.max(0, 44 - title.length))}`));
161 |   },
162 | 
163 |   /** Podsumowanie cyklu (poziom 1+) */
164 |   cycleSummary({ cycle, posts, newComments, duration, errors = 0, cacheSize = 0, cacheEntries = 0, totalKnownIds = 0 }) {
165 |     if (LOG_LEVEL < 1) return;
166 |     const prefix = timestamp() + formatModule("WATCHER");
167 |     const status = errors > 0 ? c(colors.yellow, `‚ö† ${errors} err`) : c(colors.green, "‚úì");
168 |     const durationStr = duration ? ` (${(duration / 1000).toFixed(1)}s)` : "";
169 |     console.log(
170 |       `${prefix} Cykl #${cycle} done: ${posts} post√≥w, ${c(colors.green, `+${newComments}`)} nowych${durationStr} ${status}`
171 |     );
172 | 
173 |     // Metryki cache (poziom 2+ - DEV)
174 |     if (LOG_LEVEL >= 2 && (cacheSize > 0 || totalKnownIds > 0)) {
175 |       const cacheSizeStr = cacheSize > 0 ? `${Math.round(cacheSize / 1024)}KB` : "0KB";
176 |       console.log(
177 |         `${prefix} ${c(colors.dim, `Cache: ${cacheSizeStr}, ${cacheEntries} post√≥w, ${totalKnownIds} knownIds`)}`
178 |       );
179 |     }
180 |   },
181 | 
182 |   /** Aktualny poziom logowania */
183 |   get level() {
184 |     return LOG_LEVEL;
185 |   },
186 | 
187 |   /** Czy dany poziom jest w≈ÇƒÖczony */
188 |   isEnabled(level) {
189 |     return LOG_LEVEL >= level;
190 |   },
191 | };
192 | 
193 | // Sta≈Çe poziom√≥w do eksportu
194 | const LEVELS = {
195 |   SILENT: 0,
196 |   PROD: 1,
197 |   DEV: 2,
198 |   DEBUG: 3,
199 | };
200 | 
201 | export { log, LEVELS };
202 | export default log;
203 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/mouse.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, itp.).  

```js
  1 | // src/utils/mouse.js
  2 | // Human Behavior Mode - symulacja ruch√≥w myszy krzywymi Beziera
  3 | 
  4 | import { gaussianRandom, sleep } from "./sleep.js";
  5 | 
  6 | /**
  7 |  * Oblicza punkt na krzywej Beziera (3. stopnia)
  8 |  * @param {number} t - parametr 0-1
  9 |  * @param {number} p0 - punkt startowy
 10 |  * @param {number} p1 - punkt kontrolny 1
 11 |  * @param {number} p2 - punkt kontrolny 2
 12 |  * @param {number} p3 - punkt ko≈Ñcowy
 13 |  * @returns {number}
 14 |  */
 15 | function bezierPoint(t, p0, p1, p2, p3) {
 16 |   const u = 1 - t;
 17 |   return (
 18 |     u * u * u * p0 +
 19 |     3 * u * u * t * p1 +
 20 |     3 * u * t * t * p2 +
 21 |     t * t * t * p3
 22 |   );
 23 | }
 24 | 
 25 | /**
 26 |  * Generuje ≈õcie≈ºkƒô ruchu myszy miƒôdzy dwoma punktami
 27 |  * u≈ºywajƒÖc krzywej Beziera z losowymi punktami kontrolnymi
 28 |  * @param {number} startX
 29 |  * @param {number} startY
 30 |  * @param {number} endX
 31 |  * @param {number} endY
 32 |  * @param {number} steps - liczba krok√≥w (wiƒôcej = p≈Çynniej)
 33 |  * @returns {Array<{x: number, y: number}>}
 34 |  */
 35 | function generateBezierPath(startX, startY, endX, endY, steps = 25) {
 36 |   const path = [];
 37 | 
 38 |   // Losowe punkty kontrolne - dodajƒÖ "ludzkƒÖ" krzywo≈õƒá
 39 |   const dx = endX - startX;
 40 |   const dy = endY - startY;
 41 |   const distance = Math.sqrt(dx * dx + dy * dy);
 42 | 
 43 |   // Punkty kontrolne odsuniƒôte o 20-40% odleg≈Ço≈õci w losowym kierunku
 44 |   const offset1 = gaussianRandom(distance * 0.3, distance * 0.1);
 45 |   const angle1 = Math.random() * Math.PI * 2;
 46 |   const cp1x = startX + dx * 0.3 + Math.cos(angle1) * offset1;
 47 |   const cp1y = startY + dy * 0.3 + Math.sin(angle1) * offset1;
 48 | 
 49 |   const offset2 = gaussianRandom(distance * 0.3, distance * 0.1);
 50 |   const angle2 = Math.random() * Math.PI * 2;
 51 |   const cp2x = startX + dx * 0.7 + Math.cos(angle2) * offset2;
 52 |   const cp2y = startY + dy * 0.7 + Math.sin(angle2) * offset2;
 53 | 
 54 |   for (let i = 0; i <= steps; i++) {
 55 |     const t = i / steps;
 56 | 
 57 |     // Easing - wolniej na poczƒÖtku i ko≈Ñcu (naturalny ruch)
 58 |     const easedT = t < 0.5
 59 |       ? 2 * t * t
 60 |       : 1 - Math.pow(-2 * t + 2, 2) / 2;
 61 | 
 62 |     const x = bezierPoint(easedT, startX, cp1x, cp2x, endX);
 63 |     const y = bezierPoint(easedT, startY, cp1y, cp2y, endY);
 64 | 
 65 |     path.push({ x: Math.round(x), y: Math.round(y) });
 66 |   }
 67 | 
 68 |   return path;
 69 | }
 70 | 
 71 | /**
 72 |  * Przesuwa mysz wzd≈Çu≈º ≈õcie≈ºki Beziera
 73 |  * @param {import('puppeteer').Page} page
 74 |  * @param {number} startX
 75 |  * @param {number} startY
 76 |  * @param {number} endX
 77 |  * @param {number} endY
 78 |  * @returns {Promise<void>}
 79 |  */
 80 | async function moveMouse(page, startX, startY, endX, endY) {
 81 |   const distance = Math.sqrt(
 82 |     Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)
 83 |   );
 84 | 
 85 |   // Wiƒôcej krok√≥w dla d≈Çu≈ºszych ruch√≥w
 86 |   const steps = Math.max(15, Math.min(50, Math.round(distance / 15)));
 87 |   const path = generateBezierPath(startX, startY, endX, endY, steps);
 88 | 
 89 |   for (const point of path) {
 90 |     await page.mouse.move(point.x, point.y);
 91 | 
 92 |     // Losowe op√≥≈∫nienie miƒôdzy ruchami (5-15ms)
 93 |     const moveDelay = gaussianRandom(10, 3);
 94 |     await sleep(Math.max(3, Math.min(20, moveDelay)));
 95 |   }
 96 | }
 97 | 
 98 | /**
 99 |  * Pobiera pozycjƒô ≈õrodka elementu
100 |  * @param {import('puppeteer').ElementHandle} element
101 |  * @returns {Promise<{x: number, y: number}>}
102 |  */
103 | async function getElementCenter(element) {
104 |   const box = await element.boundingBox();
105 |   if (!box) return null;
106 | 
107 |   return {
108 |     x: box.x + box.width / 2,
109 |     y: box.y + box.height / 2,
110 |   };
111 | }
112 | 
113 | /**
114 |  * Przesuwa mysz do elementu u≈ºywajƒÖc krzywej Beziera
115 |  * @param {import('puppeteer').Page} page
116 |  * @param {import('puppeteer').ElementHandle} element
117 |  * @returns {Promise<boolean>} - true je≈õli sukces
118 |  */
119 | async function moveToElement(page, element) {
120 |   try {
121 |     const target = await getElementCenter(element);
122 |     if (!target) return false;
123 | 
124 |     // Pobierz aktualnƒÖ pozycjƒô myszy (domy≈õlnie ≈õrodek ekranu)
125 |     const viewport = page.viewport();
126 |     const currentX = viewport ? viewport.width / 2 : 500;
127 |     const currentY = viewport ? viewport.height / 2 : 300;
128 | 
129 |     // Dodaj ma≈ÇƒÖ losowo≈õƒá do punktu docelowego (nie celuj idealnie w ≈õrodek)
130 |     const offsetX = gaussianRandom(0, 3);
131 |     const offsetY = gaussianRandom(0, 3);
132 | 
133 |     await moveMouse(
134 |       page,
135 |       currentX,
136 |       currentY,
137 |       target.x + offsetX,
138 |       target.y + offsetY
139 |     );
140 | 
141 |     return true;
142 |   } catch {
143 |     return false;
144 |   }
145 | }
146 | 
147 | /**
148 |  * Human-like klikniƒôcie - ruch myszy + klik z ma≈Çym op√≥≈∫nieniem
149 |  * @param {import('puppeteer').Page} page
150 |  * @param {import('puppeteer').ElementHandle} element
151 |  * @returns {Promise<boolean>} - true je≈õli sukces
152 |  */
153 | async function humanClick(page, element) {
154 |   try {
155 |     // Ruch do elementu
156 |     const moved = await moveToElement(page, element);
157 |     if (!moved) {
158 |       // Fallback do normalnego kliku
159 |       await element.click().catch(() => {});
160 |       return true;
161 |     }
162 | 
163 |     // Ma≈Çe op√≥≈∫nienie przed klikiem (50-150ms)
164 |     const preClickDelay = gaussianRandom(100, 30);
165 |     await sleep(Math.max(40, Math.min(200, preClickDelay)));
166 | 
167 |     // Klik
168 |     await page.mouse.click(
169 |       (await getElementCenter(element)).x,
170 |       (await getElementCenter(element)).y
171 |     );
172 | 
173 |     // Ma≈Çe op√≥≈∫nienie po kliku (30-100ms)
174 |     const postClickDelay = gaussianRandom(60, 20);
175 |     await sleep(Math.max(20, Math.min(120, postClickDelay)));
176 | 
177 |     return true;
178 |   } catch {
179 |     // Fallback
180 |     await element.click().catch(() => {});
181 |     return true;
182 |   }
183 | }
184 | 
185 | /**
186 |  * Losowy ruch myszy - symuluje "rozglƒÖdanie siƒô" po stronie
187 |  * @param {import('puppeteer').Page} page
188 |  * @returns {Promise<void>}
189 |  */
190 | async function randomMouseMovement(page) {
191 |   try {
192 |     const viewport = page.viewport();
193 |     if (!viewport) return;
194 | 
195 |     // Losowy punkt na stronie
196 |     const targetX = gaussianRandom(viewport.width / 2, viewport.width / 4);
197 |     const targetY = gaussianRandom(viewport.height / 2, viewport.height / 4);
198 | 
199 |     // Clamp do viewport
200 |     const clampedX = Math.max(50, Math.min(viewport.width - 50, targetX));
201 |     const clampedY = Math.max(50, Math.min(viewport.height - 50, targetY));
202 | 
203 |     const currentX = viewport.width / 2;
204 |     const currentY = viewport.height / 2;
205 | 
206 |     await moveMouse(page, currentX, currentY, clampedX, clampedY);
207 |   } catch {
208 |     // Ignoruj b≈Çƒôdy - to tylko dodatkowa symulacja
209 |   }
210 | }
211 | 
212 | export {
213 |   generateBezierPath,
214 |   moveMouse,
215 |   moveToElement,
216 |   humanClick,
217 |   randomMouseMovement,
218 | };
219 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/navigation.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, itp.).  

```js
 1 | // src/utils/navigation.js
 2 | import { sleepRandom } from "./sleep.js";
 3 | import log from "./logger.js";
 4 | 
 5 | /**
 6 |  * Bezpieczne page.goto z retry.
 7 |  * - pr√≥buje kilka razy
 8 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
 9 |  */
10 | export async function safeGoto(page, url, label = "goto", options = {}) {
11 |   const MAX_ATTEMPTS = 3;
12 | 
13 |   const finalOptions = {
14 |     waitUntil: "networkidle2",
15 |     timeout: 90000, // 90s
16 |     ...options,
17 |   };
18 | 
19 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
20 |     try {
21 |       log.debug("NAV", `[${label}] Pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`);
22 | 
23 |       // === FORCE DESKTOP PROFILE (SERVER FIX) ===
24 |       await page.setViewport({ width: 1366, height: 768 });
25 |       // DISABLED UA // === END FORCE DESKTOP PROFILE ===
26 | 
27 |       await page.goto(url, finalOptions);
28 | 
29 |       log.debug("NAV", `[${label}] OK na pr√≥bie ${attempt}`);
30 |       return true;
31 |     } catch (err) {
32 |       log.warn("NAV", `[${label}] B≈ÇƒÖd pr√≥ba ${attempt}: ${err.message}`);
33 | 
34 |       if (attempt === MAX_ATTEMPTS) {
35 |         return false;
36 |       }
37 | 
38 |       await sleepRandom(3000, 7000);
39 | 
40 |       try {
41 |         log.debug("NAV", "Pr√≥ba od≈õwie≈ºenia FB...");
42 |         await page
43 |           .goto("https://www.facebook.com/", {
44 |             waitUntil: "load",
45 |             timeout: 45000,
46 |           })
47 |           .catch(() => {});
48 |       } catch (e2) {
49 |         log.warn("NAV", `Od≈õwie≈ºenie FB te≈º b≈ÇƒÖd: ${e2.message}`);
50 |       }
51 |     }
52 |   }
53 | 
54 |   // tu w praktyce nie dojdziemy
55 |   return false;
56 | }
57 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/sleep.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, itp.).  

```js
  1 | // src/utils/sleep.js
  2 | // Human Behavior Mode - op√≥≈∫nienia symulujƒÖce cz≈Çowieka
  3 | 
  4 | /**
  5 |  * Podstawowy sleep
  6 |  */
  7 | function sleep(ms) {
  8 |   return new Promise((res) => setTimeout(res, ms));
  9 | }
 10 | 
 11 | /**
 12 |  * Sleep z losowym op√≥≈∫nieniem (jednolity rozk≈Çad)
 13 |  */
 14 | function sleepRandom(minMs, maxMs) {
 15 |   const delta = maxMs - minMs;
 16 |   const extra = Math.random() * delta;
 17 |   return sleep(minMs + extra);
 18 | }
 19 | 
 20 | /**
 21 |  * Generuje losowƒÖ warto≈õƒá z rozk≈Çadu normalnego (Gaussa)
 22 |  * Box-Muller transform
 23 |  * @param {number} mean - ≈õrednia
 24 |  * @param {number} stdDev - odchylenie standardowe
 25 |  * @returns {number}
 26 |  */
 27 | function gaussianRandom(mean, stdDev) {
 28 |   let u1, u2;
 29 |   do {
 30 |     u1 = Math.random();
 31 |     u2 = Math.random();
 32 |   } while (u1 === 0); // u1 nie mo≈ºe byƒá 0
 33 | 
 34 |   const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
 35 |   return mean + z * stdDev;
 36 | }
 37 | 
 38 | /**
 39 |  * Ludzkie op√≥≈∫nienie z rozk≈Çadem Gaussa
 40 |  * @param {number} baseMs - bazowe op√≥≈∫nienie (≈õrednia)
 41 |  * @param {number} variance - wariancja jako procent (0.0-1.0)
 42 |  * @returns {Promise<void>}
 43 |  */
 44 | async function humanDelay(baseMs, variance = 0.3) {
 45 |   const stdDev = baseMs * variance;
 46 |   let delay = gaussianRandom(baseMs, stdDev);
 47 | 
 48 |   // Clamp do rozsƒÖdnych warto≈õci (50% - 200% ≈õredniej)
 49 |   delay = Math.max(baseMs * 0.5, Math.min(baseMs * 2, delay));
 50 | 
 51 |   return sleep(delay);
 52 | }
 53 | 
 54 | /**
 55 |  * Op√≥≈∫nienie przy pisaniu - symuluje ludzkƒÖ szybko≈õƒá
 56 |  * ≈örednio ~120ms na znak, z mikro-pauzami
 57 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
 58 |  */
 59 | async function humanTypingDelay() {
 60 |   // Rozk≈Çad: ≈õrednia 120ms, stdDev 40ms
 61 |   let delay = gaussianRandom(120, 40);
 62 | 
 63 |   // Clamp: 60-250ms na znak
 64 |   delay = Math.max(60, Math.min(250, delay));
 65 | 
 66 |   // 5% szansa na mikro-pauzƒô (jakby cz≈Çowiek my≈õla≈Ç)
 67 |   if (Math.random() < 0.05) {
 68 |     delay += gaussianRandom(300, 100);
 69 |   }
 70 | 
 71 |   await sleep(delay);
 72 |   return delay;
 73 | }
 74 | 
 75 | /**
 76 |  * Pauza miƒôdzy postami - 3-8 sekund z rozk≈Çadem Gaussa
 77 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
 78 |  */
 79 | async function betweenPostsPause() {
 80 |   // ≈örednia 5.5s, stdDev 1.2s ‚Üí wiƒôkszo≈õƒá w zakresie 3-8s
 81 |   let delay = gaussianRandom(5500, 1200);
 82 | 
 83 |   // Clamp: 3-10 sekund
 84 |   delay = Math.max(3000, Math.min(10000, delay));
 85 | 
 86 |   await sleep(delay);
 87 |   return delay;
 88 | }
 89 | 
 90 | /**
 91 |  * Wpisuje tekst znak po znaku z ludzkimi op√≥≈∫nieniami
 92 |  * @param {import('puppeteer').ElementHandle} element - input element
 93 |  * @param {string} text - tekst do wpisania
 94 |  * @param {import('puppeteer').Page} page - strona (do keyboard)
 95 |  * @returns {Promise<void>}
 96 |  */
 97 | async function humanType(element, text, page) {
 98 |   for (let i = 0; i < text.length; i++) {
 99 |     const char = text[i];
100 | 
101 |     // Wpisz znak
102 |     await page.keyboard.type(char);
103 | 
104 |     // Op√≥≈∫nienie miƒôdzy znakami
105 |     await humanTypingDelay();
106 |   }
107 | }
108 | 
109 | /**
110 |  * Fisher-Yates shuffle - randomizacja tablicy
111 |  * @param {Array} array - tablica do pomieszania
112 |  * @returns {Array} - nowa, pomieszana tablica
113 |  */
114 | function shuffleArray(array) {
115 |   const shuffled = [...array];
116 |   for (let i = shuffled.length - 1; i > 0; i--) {
117 |     const j = Math.floor(Math.random() * (i + 1));
118 |     [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
119 |   }
120 |   return shuffled;
121 | }
122 | 
123 | export {
124 |   sleep,
125 |   sleepRandom,
126 |   gaussianRandom,
127 |   humanDelay,
128 |   humanTypingDelay,
129 |   betweenPostsPause,
130 |   humanType,
131 |   shuffleArray,
132 | };
133 | 
```

---

### üìÑ ≈öcie≈ºka: `src/utils/time.js`
**Typ:** JavaScript/tekst  
**Opis:** Utility helpers (sleep, nawigacja, itp.).  

```js
 1 | // src/utils/time.js
 2 | import log from "./logger.js";
 3 | 
 4 | /**
 5 |  * Parser wzglƒôdnego czasu FB ‚Üí Date
 6 |  * np. "2 min", "3 godz", "wczoraj"
 7 |  */
 8 | export function parseFbRelativeTime(raw) {
 9 |   if (!raw) return null;
10 | 
11 |   const t = raw.toLowerCase().trim();
12 |   const now = new Date();
13 | 
14 |   if (t.includes("przed chwilƒÖ") || t === "teraz" || t === "now" || t === "just now") {
15 |     return now;
16 |   }
17 | 
18 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
19 |     const d = new Date(now);
20 |     d.setDate(d.getDate() - 1);
21 |     return d;
22 |   }
23 | 
24 |   const m = t.match(/(\d+)\s*(sek|sec|min|minut|godz|hour|h|dni|day|tyg|week)/i);
25 |   if (!m) return null;
26 | 
27 |   const value = parseInt(m[1], 10);
28 |   if (!Number.isFinite(value)) return null;
29 | 
30 |   const unit = m[2].toLowerCase();
31 |   const d = new Date(now);
32 | 
33 |   if (unit.startsWith("sek") || unit.startsWith("sec")) d.setSeconds(d.getSeconds() - value);
34 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
35 |   else if (unit.startsWith("godz") || unit.startsWith("hour") || unit === "h") d.setHours(d.getHours() - value);
36 |   else if (unit.startsWith("dni") || unit.startsWith("day")) d.setDate(d.getDate() - value);
37 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
38 | 
39 |   return d;
40 | }
41 | 
42 | /**
43 |  * Filtruje komentarze - zostawia tylko te m≈Çodsze ni≈º maxAgeMin
44 |  */
45 | export function filterByAge(comments, maxAgeMin = 60) {
46 |   const now = Date.now();
47 | 
48 |   return comments.filter((c) => {
49 |     const rel = (c?.fb_time_raw || c?.time || "").trim();
50 |     if (!rel) return false;
51 | 
52 |     const abs = parseFbRelativeTime(rel);
53 |     if (!abs) return false;
54 | 
55 |     const ageMinutes = (now - abs.getTime()) / 60000;
56 |     log.debug("TIME", "Age filter", {
57 |       raw: rel,
58 |       ageMin: Math.round(ageMinutes * 10) / 10,
59 |       maxAgeMin,
60 |     });
61 |     return ageMinutes <= maxAgeMin;
62 |   });
63 | }
64 | 
```

---

### üìÑ ≈öcie≈ºka: `src/watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: cykle, cache, webhook/telegram.  

```js
   1 | // src/watcher.js
   2 | import puppeteer from "puppeteer-extra";
   3 | import StealthPlugin from "puppeteer-extra-plugin-stealth";
   4 | import RecaptchaPlugin from "puppeteer-extra-plugin-recaptcha";
   5 | 
   6 | // Stealth Plugin - ukrywa automatyzacjƒô (ZAWSZE pierwszy)
   7 | puppeteer.use(StealthPlugin());
   8 | console.log("[STEALTH] Plugin stealth w≈ÇƒÖczony");
   9 | import fs from "fs";
  10 | import path from "path";
  11 | import {
  12 |   EXPAND_COMMENTS,
  13 |   CHECK_INTERVAL_MS,
  14 |   POSTS_SHEET_URL,
  15 |   POSTS_REFRESH_MS,
  16 |   FAST_MODE,
  17 |   FAST_MAX_AGE_MIN,
  18 |   POSTS_API_URL,
  19 |   POSTS_API_TOKEN,
  20 |   CAPTCHA_API_KEY,
  21 |   CAPTCHA_ENABLED,
  22 |   REMOTE_DEBUG_PORT,
  23 |   HUMAN_MODE,
  24 |   PROXY_URL,
  25 | } from "./config.js";
  26 | 
  27 | // Konfiguracja captcha solver (2Captcha)
  28 | if (CAPTCHA_ENABLED && CAPTCHA_API_KEY) {
  29 |   puppeteer.use(
  30 |     RecaptchaPlugin({
  31 |       provider: {
  32 |         id: "2captcha",
  33 |         token: CAPTCHA_API_KEY,
  34 |       },
  35 |       visualFeedback: true,
  36 |     })
  37 |   );
  38 |   console.log("[CAPTCHA] 2Captcha solver w≈ÇƒÖczony");
  39 | }
  40 | 
  41 | import {
  42 |   prepare,
  43 |   getCommentCount,
  44 |   loadAllComments,
  45 |   extractCommentsData,
  46 |   switchCommentsFilterToNewest,
  47 | } from "./fb/comments.js";
  48 | 
  49 | import { loadCookies, saveCookies } from "./fb/cookies.js";
  50 | import { checkIfLogged, fbLogin, solveCaptchaIfPresent } from "./fb/login.js";
  51 | import { isCheckpoint, getCheckpointType } from "./fb/checkpoint.js";
  52 | import { parseFbRelativeTime, filterByAge } from "./utils/time.js";
  53 | import { shuffleArray, betweenPostsPause } from "./utils/sleep.js";
  54 | import { loadCache, saveCache, getCacheSize, getCacheEntryCount } from "./db/cache.js";
  55 | import { sendTelegramLeads, sendOwnerAlert } from "./telegram.js";
  56 | import log from "./utils/logger.js";
  57 | 
  58 | /**
  59 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
  60 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
  61 |  */
  62 | const POSTS_FILE =
  63 |   process.env.POSTS_FILE || path.join(process.cwd(), "data", "posts.json");
  64 | 
  65 | /**
  66 |  * CACHE DYSKOWY
  67 |  */
  68 | const commentsCache = loadCache();
  69 | const lastCounts = new Map();
  70 | const knownCommentsPerPost = new Map();
  71 | 
  72 | // Limity dla knownIds - zapobiega memory leak
  73 | const MAX_KNOWN_IDS_PER_POST = 1000;  // max komentarzy na post w pamiƒôci
  74 | const KNOWN_IDS_TRIM_TO = 800;        // do ilu przycinaƒá gdy przekroczy limit
  75 | 
  76 | for (const [url, entry] of Object.entries(commentsCache)) {
  77 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
  78 |   if (Array.isArray(entry?.knownIds)) {
  79 |     // Przytnij podczas ≈Çadowania je≈õli za du≈ºo
  80 |     const ids = entry.knownIds.slice(-MAX_KNOWN_IDS_PER_POST);
  81 |     knownCommentsPerPost.set(url, new Set(ids));
  82 |   }
  83 | }
  84 | 
  85 | let currentPosts = [];
  86 | let lastRefreshAny = 0;
  87 | let cycleNumber = 0;
  88 | 
  89 | let navErrorCount = 0;
  90 | const MAX_NAV_ERRORS = 5;
  91 | 
  92 | function isNavigationError(err) {
  93 |   if (!err) return false;
  94 |   const msg = String(err.message || err).toLowerCase();
  95 |   return (
  96 |     msg.includes("safegoto-failed") ||
  97 |     msg.includes("navigation timeout") ||
  98 |     msg.includes("net::err_connection_timed_out") ||
  99 |     msg.includes("net::err_timed_out")
 100 |   );
 101 | }
 102 | 
 103 | function envBool(name, def = false) {
 104 |   const raw = String(process.env[name] ?? "").trim().toLowerCase();
 105 |   if (raw === "") return def;
 106 |   return ["1", "true", "yes", "y", "tak", "on"].includes(raw);
 107 | }
 108 | 
 109 | // ================== FAST_MODE HELPER ==================
 110 | function getCommentAgeMinutes(timeStr) {
 111 |   if (!timeStr) return null;
 112 |   const abs = parseFbRelativeTime(timeStr);
 113 |   if (!abs) return null;
 114 |   return (Date.now() - abs.getTime()) / 60000;
 115 | }
 116 | 
 117 | // ================== TELEGRAM (FILTER AGE) ==================
 118 | async function sendTelegramIfFresh(post, comments, ctx = "normal") {
 119 |   const list = Array.isArray(comments) ? comments : [];
 120 |   if (list.length === 0) return;
 121 | 
 122 |   const now = Date.now();
 123 | 
 124 |   const normalized = list.map((c) => {
 125 |     const rel = String(c?.fb_time_raw || c?.time || "").trim();
 126 |     const abs = parseFbRelativeTime(rel);
 127 |     const iso = abs ? abs.toISOString() : (c?.fb_time_iso || null);
 128 |     const ageMin = abs ? Math.round(((now - abs.getTime()) / 60000) * 10) / 10 : null;
 129 | 
 130 |     return {
 131 |       ...c,
 132 |       fb_time_raw: rel || null,
 133 |       fb_time_iso: iso,
 134 |       _ageMin: ageMin,
 135 |     };
 136 |   });
 137 | 
 138 |   // log wieku komentarzy (tylko DEBUG)
 139 |   for (const c of normalized) {
 140 |     log.debug("TELEGRAM", `Komentarz ${c?.id}`, {
 141 |       ctx,
 142 |       author: c?.author || c?.name,
 143 |       rel: c?.fb_time_raw,
 144 |       ageMin: c?._ageMin,
 145 |     });
 146 |   }
 147 | 
 148 |   const fresh = filterByAge(normalized);
 149 |   const maxAge = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 150 | 
 151 |   log.dev("TELEGRAM", `Filtr wieku: ${normalized.length} ‚Üí ${fresh.length}`, { ctx, maxAge });
 152 | 
 153 |   if (fresh.length > 0) {
 154 |     await sendTelegramLeads(post, fresh);
 155 |   } else {
 156 |     log.dev("TELEGRAM", "Brak ≈õwie≈ºych komentarzy - nic nie wysy≈Çam");
 157 |   }
 158 | }
 159 | 
 160 | /* ============================================================
 161 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
 162 |    ============================================================ */
 163 | 
 164 | async function applyStealth(page) {
 165 |   await page.evaluateOnNewDocument(() => {
 166 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
 167 |     window.chrome = window.chrome || { runtime: {} };
 168 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
 169 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
 170 | 
 171 |     const permissions = window.navigator.permissions;
 172 |     if (permissions && permissions.query) {
 173 |       const originalQuery = permissions.query.bind(permissions);
 174 |       permissions.query = (parameters) => {
 175 |         if (parameters && parameters.name === "notifications" && window.Notification) {
 176 |           return Promise.resolve({ state: window.Notification.permission });
 177 |         }
 178 |         return originalQuery(parameters);
 179 |       };
 180 |     }
 181 |   });
 182 | }
 183 | 
 184 | /* ============================================================
 185 |    ===============   PANEL POSTS (data/posts.json)   ===========
 186 |    ============================================================ */
 187 | 
 188 | function safeJsonParse(s) {
 189 |   try {
 190 |     return { ok: true, value: JSON.parse(s) };
 191 |   } catch (e) {
 192 |     return { ok: false, error: e?.message || "Invalid JSON" };
 193 |   }
 194 | }
 195 | 
 196 | function normalizeUrl(u) {
 197 |   if (!u) return "";
 198 |   const x = String(u).trim();
 199 |   if (!/^https?:\/\/.+/i.test(x)) return "";
 200 |   return x;
 201 | }
 202 | 
 203 | function makePostKey(url) {
 204 |   try {
 205 |     const u = new URL(String(url || "").trim());
 206 |     for (const k of Array.from(u.searchParams.keys())) {
 207 |       if (k.startsWith("__") || ["ref", "notif_id", "notif_t", "refid"].includes(k)) {
 208 |         u.searchParams.delete(k);
 209 |       }
 210 |     }
 211 |     if (u.pathname.includes("permalink.php")) {
 212 |       const s = u.searchParams.get("story_fbid");
 213 |       const id = u.searchParams.get("id");
 214 |       if (s && id) return `permalink:${id}:${s}`;
 215 |     }
 216 |     if (u.pathname.includes("story.php")) {
 217 |       const s = u.searchParams.get("story_fbid");
 218 |       const id = u.searchParams.get("id");
 219 |       if (s && id) return `story:${id}:${s}`;
 220 |     }
 221 |     const mPosts = u.pathname.match(/\/posts\/([^/?#]+)/i);
 222 |     if (mPosts?.[1]) return `posts:${mPosts[1]}`;
 223 |     const v = u.searchParams.get("v");
 224 |     if (u.pathname.includes("/watch") && v) return `watch:${v}`;
 225 |     const mVid = u.pathname.match(/\/videos\/([^/?#]+)/i);
 226 |     if (mVid?.[1]) return `videos:${mVid[1]}`;
 227 |     const q = u.searchParams.toString();
 228 |     return `url:${u.host}${u.pathname}${q ? "?" + q : ""}`;
 229 |   } catch {
 230 |     return `url:${String(url || "").trim()}`;
 231 |   }
 232 | }
 233 | 
 234 | function readPanelPosts() {
 235 |   try {
 236 |     if (!fs.existsSync(POSTS_FILE)) {
 237 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
 238 |     }
 239 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
 240 |     if (!raw) {
 241 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
 242 |     }
 243 | 
 244 |     const parsed = safeJsonParse(raw);
 245 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
 246 |       return { ok: false, error: "posts.json ma z≈Çy format", posts: [], path: POSTS_FILE };
 247 |     }
 248 | 
 249 |     const posts = parsed.value
 250 |       .map((p) => {
 251 |         const url = normalizeUrl(p?.url);
 252 |         const active = Boolean(p?.active);
 253 |         if (!url) return null;
 254 |         return {
 255 |           id: String(p?.id || url),
 256 |           url,
 257 |           active,
 258 |           name: p?.name ? String(p.name) : "",
 259 |           image: p?.image ? String(p.image) : "",
 260 |           description: p?.description ? String(p.description) : "",
 261 |         };
 262 |       })
 263 |       .filter(Boolean);
 264 | 
 265 |     const activePosts = posts.filter((p) => p.active);
 266 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
 267 |   } catch (e) {
 268 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
 269 |   }
 270 | }
 271 | 
 272 | /* ============================================================
 273 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
 274 |    ============================================================ */
 275 | 
 276 | function parseSheetCsv(text) {
 277 |   const lines = text
 278 |     .split(/\r?\n/)
 279 |     .map((l) => l.trim())
 280 |     .filter((l) => l.length > 0);
 281 | 
 282 |   if (!lines.length) {
 283 |     log.warn("SHEET", "Pusty CSV z arkusza");
 284 |     return [];
 285 |   }
 286 | 
 287 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
 288 |   const idxUrl = header.findIndex((h) => h === "url");
 289 |   const idxActive = header.findIndex((h) => h === "active");
 290 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
 291 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
 292 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
 293 | 
 294 |   if (idxUrl === -1) {
 295 |     log.error("SHEET", "Brak kolumny 'url' w arkuszu");
 296 |     return [];
 297 |   }
 298 | 
 299 |   const posts = [];
 300 |   for (let i = 1; i < lines.length; i++) {
 301 |     const row = lines[i].split(",");
 302 |     const rawUrl = (row[idxUrl] || "").trim();
 303 |     if (!rawUrl) continue;
 304 | 
 305 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
 306 |     const activeNorm = activeRaw.toLowerCase();
 307 |     const isActive = idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
 308 | 
 309 |     if (!isActive) continue;
 310 | 
 311 |     posts.push({
 312 |       id: `sheet-${i}`,
 313 |       url: rawUrl,
 314 |       name: idxName !== -1 ? (row[idxName] || "").trim() : "",
 315 |       image: idxImage !== -1 ? (row[idxImage] || "").trim() : "",
 316 |       description: idxDesc !== -1 ? (row[idxDesc] || "").trim() : "",
 317 |     });
 318 |   }
 319 | 
 320 |   return posts;
 321 | }
 322 | 
 323 | /* ============================================================
 324 |    ===============   POSTS FROM REMOTE API   ====================
 325 |    ============================================================ */
 326 | 
 327 | async function fetchPostsFromApi() {
 328 |   if (!POSTS_API_URL) return { ok: false, reason: "no-url" };
 329 | 
 330 |   log.dev("API", `Pobieram posty z: ${POSTS_API_URL}`);
 331 | 
 332 |   try {
 333 |     const headers = { "Content-Type": "application/json" };
 334 |     if (POSTS_API_TOKEN) {
 335 |       headers["Authorization"] = `Bearer ${POSTS_API_TOKEN}`;
 336 |     }
 337 | 
 338 |     const res = await fetch(POSTS_API_URL, {
 339 |       method: "GET",
 340 |       headers,
 341 |       timeout: 10000,
 342 |     });
 343 | 
 344 |     if (!res.ok) {
 345 |       log.error("API", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
 346 |       return { ok: false, reason: "http-error", status: res.status };
 347 |     }
 348 | 
 349 |     const data = await res.json();
 350 | 
 351 |     if (!data.ok || !Array.isArray(data.posts)) {
 352 |       log.error("API", "Nieprawid≈Çowa odpowied≈∫ (brak ok/posts)");
 353 |       return { ok: false, reason: "invalid-response" };
 354 |     }
 355 | 
 356 |     const posts = data.posts
 357 |       .filter((p) => p.active !== false)
 358 |       .map((p) => ({
 359 |         id: String(p.id || "").trim(),
 360 |         url: String(p.url || "").trim(),
 361 |         active: true,
 362 |         name: String(p.name || "").trim(),
 363 |         image: String(p.image || "").trim(),
 364 |         description: String(p.description || "").trim(),
 365 |       }))
 366 |       .filter((p) => p.url);
 367 | 
 368 |     return { ok: true, posts, total: data.posts.length };
 369 |   } catch (err) {
 370 |     log.error("API", `B≈ÇƒÖd pobierania post√≥w: ${err.message}`);
 371 |     return { ok: false, reason: "fetch-error", error: err.message };
 372 |   }
 373 | }
 374 | 
 375 | /* ============================================================
 376 |    ===============   POSTS REFRESH   ===========================
 377 |    ============================================================ */
 378 | 
 379 | async function refreshPostsIfNeeded(force = false) {
 380 |   const now = Date.now();
 381 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
 382 |   lastRefreshAny = now;
 383 | 
 384 |   // 1) PRIMARY: Remote API
 385 |   if (POSTS_API_URL) {
 386 |     const api = await fetchPostsFromApi();
 387 |     if (api.ok && api.posts.length > 0) {
 388 |       const newPosts = api.posts;
 389 |       const oldJson = JSON.stringify(currentPosts);
 390 |       const newJson = JSON.stringify(newPosts);
 391 | 
 392 |       if (oldJson !== newJson) {
 393 |         log.prod("API", `Za≈Çadowano ${newPosts.length} post√≥w`, { total: api.total });
 394 |         currentPosts = newPosts;
 395 |       } else {
 396 |         log.dev("API", `Bez zmian (${newPosts.length} aktywnych)`);
 397 |       }
 398 |       return;
 399 |     }
 400 | 
 401 |     log.dev("API", `Fallback do lokalnego pliku (${api.reason || "unknown"})`);
 402 |   }
 403 | 
 404 |   // 2) SECONDARY: lokalny panel posts.json
 405 |   const panel = readPanelPosts();
 406 |   if (panel.ok && panel.posts.length > 0) {
 407 |     const newPosts = panel.posts;
 408 |     const oldJson = JSON.stringify(currentPosts);
 409 |     const newJson = JSON.stringify(newPosts);
 410 | 
 411 |     if (oldJson !== newJson) {
 412 |       log.prod("POSTS", `Za≈Çadowano ${newPosts.length} post√≥w z pliku`, { total: panel.total });
 413 |       currentPosts = newPosts;
 414 |     } else {
 415 |       log.dev("POSTS", `Bez zmian (${newPosts.length} aktywnych)`);
 416 |     }
 417 |     return;
 418 |   }
 419 | 
 420 |   log.dev("POSTS", "Panel bez post√≥w ‚Üí fallback: Sheets");
 421 | 
 422 |   // 3) FALLBACK: Sheets
 423 |   if (!POSTS_SHEET_URL) {
 424 |     log.warn("SHEET", "POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w");
 425 |     currentPosts = [];
 426 |     return;
 427 |   }
 428 | 
 429 |   log.dev("SHEET", "Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
 430 | 
 431 |   try {
 432 |     const res = await fetch(POSTS_SHEET_URL);
 433 |     if (!res.ok) {
 434 |       log.error("SHEET", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
 435 |       currentPosts = [];
 436 |       return;
 437 |     }
 438 | 
 439 |     const csvText = await res.text();
 440 |     const newPosts = parseSheetCsv(csvText);
 441 | 
 442 |     if (!newPosts.length) {
 443 |       log.warn("SHEET", "Arkusz nie zwr√≥ci≈Ç aktywnych post√≥w");
 444 |       currentPosts = [];
 445 |       return;
 446 |     }
 447 | 
 448 |     const oldJson = JSON.stringify(currentPosts);
 449 |     const newJson = JSON.stringify(newPosts);
 450 | 
 451 |     if (oldJson !== newJson) {
 452 |       log.prod("SHEET", `Za≈Çadowano ${newPosts.length} post√≥w`);
 453 |       currentPosts = newPosts;
 454 |     } else {
 455 |       log.dev("SHEET", "Bez zmian");
 456 |     }
 457 |   } catch (err) {
 458 |     log.error("SHEET", `B≈ÇƒÖd pobierania CSV: ${err.message}`);
 459 |     currentPosts = [];
 460 |   }
 461 | }
 462 | 
 463 | /* ============================================================
 464 |    =====================   CACHE HELPERS   =====================
 465 |    ============================================================ */
 466 | 
 467 | function getCacheKey(post) {
 468 |   return post.url;
 469 | }
 470 | 
 471 | function getKnownSetForPost(cacheKey) {
 472 |   let set = knownCommentsPerPost.get(cacheKey);
 473 |   if (!set) {
 474 |     const entry = commentsCache[cacheKey];
 475 |     set = entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
 476 |     knownCommentsPerPost.set(cacheKey, set);
 477 |   }
 478 |   return set;
 479 | }
 480 | 
 481 | /**
 482 |  * Przycina Set knownIds gdy przekroczy limit (FIFO - usuwa najstarsze).
 483 |  * Zapobiega memory leak przy d≈Çugim dzia≈Çaniu.
 484 |  */
 485 | function cleanupKnownIds(set) {
 486 |   if (set.size <= MAX_KNOWN_IDS_PER_POST) return;
 487 | 
 488 |   const arr = Array.from(set);
 489 |   const toRemove = arr.slice(0, arr.length - KNOWN_IDS_TRIM_TO);
 490 |   for (const id of toRemove) {
 491 |     set.delete(id);
 492 |   }
 493 | 
 494 |   log.debug("CACHE", `Przyciƒôto knownIds: ${arr.length} ‚Üí ${set.size}`);
 495 | }
 496 | 
 497 | 
 498 | /**
 499 |  * Zwraca ca≈ÇkowitƒÖ liczbƒô knownIds w pamiƒôci (dla monitoringu)
 500 |  */
 501 | function getTotalKnownIdsCount() {
 502 |   let total = 0;
 503 |   for (const set of knownCommentsPerPost.values()) {
 504 |     total += set.size;
 505 |   }
 506 |   return total;
 507 | }
 508 | 
 509 | function flushCacheToDisk() {
 510 |   const out = { ...commentsCache };
 511 | 
 512 |   for (const [cacheKey, count] of lastCounts.entries()) {
 513 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
 514 |     out[cacheKey].lastCount = count;
 515 |   }
 516 | 
 517 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
 518 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
 519 |     out[cacheKey].knownIds = Array.from(set);
 520 |   }
 521 | 
 522 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
 523 |   Object.assign(commentsCache, out);
 524 |   saveCache(out);
 525 | }
 526 | 
 527 | /* ============================================================
 528 |    =====================   G≈Å√ìWNY WATCHER   ===================
 529 |    ============================================================ */
 530 | 
 531 | const isDev = process.env.NODE_ENV !== "production";
 532 | 
 533 | function getExecutablePath() {
 534 |   const p =
 535 |     process.env.PUPPETEER_EXECUTABLE_PATH ||
 536 |     process.env.CHROME_PATH ||
 537 |     process.env.CHROMIUM_PATH ||
 538 |     "";
 539 |   return String(p || "").trim() || undefined;
 540 | }
 541 | 
 542 | async function startWatcher() {
 543 |   log.header("FB Comment Watcher");
 544 |   log.prod("WATCHER", `Start - interwa≈Ç: ${Math.round(CHECK_INTERVAL_MS / 1000)}s`, {
 545 |     fastMode: FAST_MODE,
 546 |     logLevel: log.level,
 547 |   });
 548 | 
 549 |   const loop = async () => {
 550 |     let browser = null;
 551 |     let page = null;
 552 |     let hadNavErrorThisRound = false;
 553 |     const cycleStart = Date.now();
 554 |     cycleNumber++;
 555 |     let newCommentsTotal = 0;
 556 |     let errorsCount = 0;
 557 | 
 558 |     try {
 559 |       log.prod("WATCHER", `Cykl #${cycleNumber} start`, { posts: currentPosts.length });
 560 | 
 561 |       const wantHeadless = envBool("HEADLESS_BROWSER", true);
 562 |       const headlessMode = wantHeadless ? (isDev ? true : "new") : false;
 563 | 
 564 |       const linux = process.platform === "linux";
 565 |       const executablePath = getExecutablePath();
 566 | 
 567 |       const args = [
 568 |         "--disable-notifications",
 569 |         "--disable-blink-features=AutomationControlled",
 570 |       ];
 571 | 
 572 |       if (linux) {
 573 |         args.push("--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage");
 574 |       }
 575 | 
 576 |       // Remote debugging - pozwala pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
 577 |       if (REMOTE_DEBUG_PORT > 0) {
 578 |         args.push(`--remote-debugging-port=${REMOTE_DEBUG_PORT}`);
 579 |         args.push("--remote-debugging-address=127.0.0.1");
 580 |         log.prod("DEBUG", `Remote debugging na porcie ${REMOTE_DEBUG_PORT} - po≈ÇƒÖcz przez: ssh -L ${REMOTE_DEBUG_PORT}:localhost:${REMOTE_DEBUG_PORT} user@server`);
 581 |       }
 582 | 
 583 |       // Proxy - residential rotating proxy zmniejsza ryzyko ban√≥w
 584 |       if (PROXY_URL) {
 585 |         args.push(`--proxy-server=${PROXY_URL}`);
 586 |         // Ukryj credentials w logu
 587 |         const safeProxyUrl = PROXY_URL.replace(/\/\/([^:]+):([^@]+)@/, "//***:***@");
 588 |         log.prod("PROXY", `U≈ºywam proxy: ${safeProxyUrl}`);
 589 |       }
 590 | 
 591 |       // Human Mode info
 592 |       if (HUMAN_MODE) {
 593 |         log.prod("HUMAN", "Human Behavior Mode w≈ÇƒÖczony");
 594 |       }
 595 | 
 596 |       browser = await puppeteer.launch({
 597 |         headless: headlessMode,
 598 |         defaultViewport: null,
 599 |         executablePath,
 600 |         args,
 601 |         ignoreDefaultArgs: ["--enable-automation"],
 602 |       });
 603 | 
 604 |       page = await browser.newPage();
 605 |       await applyStealth(page);
 606 | 
 607 |       page.setDefaultNavigationTimeout(90000);
 608 |       page.setDefaultTimeout(90000);
 609 |       await page.setViewport({ width: 1280, height: 720 });
 610 | 
 611 |       // cookies + login
 612 |       await loadCookies(page);
 613 |       await page.goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 }).catch(() => {});
 614 | 
 615 |       let loggedIn = await checkIfLogged(page);
 616 | 
 617 |       // === CHECKPOINT DETECTION (tylko alert) ===
 618 |       const checkpoint = await isCheckpoint(page);
 619 |       if (checkpoint) {
 620 |         const checkpointType = await getCheckpointType(page);
 621 |         log.warn("CHECKPOINT", `Wykryto checkpoint: ${checkpointType}`);
 622 | 
 623 |         // Pr√≥ba rozwiƒÖzania captcha (je≈õli to captcha, nie 2FA)
 624 |         if (CAPTCHA_ENABLED) {
 625 |           const captchaResult = await solveCaptchaIfPresent(page);
 626 |           if (captchaResult.solved) {
 627 |             log.success("CAPTCHA", "Captcha rozwiƒÖzana!");
 628 |             await new Promise(r => setTimeout(r, 2000));
 629 |             loggedIn = await checkIfLogged(page);
 630 |             if (!loggedIn) {
 631 |               await fbLogin(page);
 632 |               loggedIn = await checkIfLogged(page);
 633 |             }
 634 |           }
 635 |         }
 636 | 
 637 |         // Je≈õli nadal nie zalogowany - alert i stop (lub czekaj przy remote debug)
 638 |         if (!loggedIn) {
 639 |           await sendOwnerAlert(
 640 |             "CHECKPOINT - Wymagana interwencja",
 641 |             `Facebook wymaga weryfikacji to≈ºsamo≈õci.\n\n` +
 642 |             `Typ: ${checkpointType}\n\n` +
 643 |             `Wymagane dzia≈Çanie:\n` +
 644 |             `1. Zaloguj siƒô rƒôcznie i zaktualizuj cookies.json\n` +
 645 |             `2. Zmie≈Ñ dane logowania w .env je≈õli potrzeba\n` +
 646 |             `3. PM2 automatycznie wznowi pracƒô`
 647 |           );
 648 | 
 649 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô zamiast wychodziƒá
 650 |           if (REMOTE_DEBUG_PORT > 0) {
 651 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
 652 |             log.warn("CHECKPOINT", "PrzeglƒÖdarka czeka na rƒôcznƒÖ interwencjƒô.");
 653 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect, potem naci≈õnij Ctrl+C i uruchom ponownie.");
 654 |             log.warn("CHECKPOINT", "Sprawdzam co 30s czy jeste≈õ zalogowany...");
 655 | 
 656 |             // Czekaj w pƒôtli a≈º u≈ºytkownik rƒôcznie rozwiƒÖ≈ºe checkpoint (max 30 min)
 657 |             const MAX_WAIT_2FA_MS = 30 * 60 * 1000; // 30 minut
 658 |             const startWait2FA = Date.now();
 659 |             while (true) {
 660 |               if (Date.now() - startWait2FA > MAX_WAIT_2FA_MS) {
 661 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA (30 min) - restart procesu");
 662 |                 await sendOwnerAlert("TIMEOUT 2FA", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô. Proces zostanie zrestartowany.");
 663 |                 process.exit(1);
 664 |               }
 665 |               await new Promise(r => setTimeout(r, 30000));
 666 |               const nowLogged = await checkIfLogged(page).catch(() => false);
 667 |               if (nowLogged) {
 668 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
 669 |                 await saveCookies(page);
 670 |                 loggedIn = true;
 671 |                 break;
 672 |               }
 673 |               const remainingMin = Math.round((MAX_WAIT_2FA_MS - (Date.now() - startWait2FA)) / 60000);
 674 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMin} min)`);
 675 |             }
 676 |           } else {
 677 |             log.error("CHECKPOINT", "Wymagana interwencja - zatrzymujƒô proces");
 678 |             process.exit(1);
 679 |           }
 680 |         }
 681 |       }
 682 |       // === KONIEC CHECKPOINT DETECTION ===
 683 | 
 684 |       if (!loggedIn) {
 685 |         log.dev("LOGIN", "Brak sesji ‚Äì logowanie...");
 686 |         const LOGIN_TIMEOUT_MS = 120000; // 2 minuty na login
 687 |         try {
 688 |           await Promise.race([
 689 |             fbLogin(page),
 690 |             new Promise((_, reject) => setTimeout(() => reject(new Error('Login timeout (2 min)')), LOGIN_TIMEOUT_MS))
 691 |           ]);
 692 |         } catch (loginErr) {
 693 |           log.error("LOGIN", `B≈ÇƒÖd logowania: ${loginErr.message}`);
 694 |           await sendOwnerAlert("LOGIN ERROR", `Logowanie nie powiod≈Ço siƒô: ${loginErr.message}`);
 695 |           throw loginErr;
 696 |         }
 697 |         loggedIn = await checkIfLogged(page);
 698 | 
 699 |         // Sprawd≈∫ checkpoint po pr√≥bie logowania
 700 |         const checkpointAfterLogin = await isCheckpoint(page);
 701 |         if (checkpointAfterLogin) {
 702 |           const checkpointType = await getCheckpointType(page);
 703 |           log.warn("CHECKPOINT", `Checkpoint po logowaniu: ${checkpointType}`);
 704 | 
 705 |           await sendOwnerAlert(
 706 |             "CHECKPOINT po logowaniu",
 707 |             `Facebook wymaga weryfikacji po pr√≥bie logowania.\n\nTyp: ${checkpointType}`
 708 |           );
 709 | 
 710 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô (max 30 min)
 711 |           if (REMOTE_DEBUG_PORT > 0) {
 712 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
 713 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect. Sprawdzam co 30s...");
 714 | 
 715 |             const MAX_WAIT_2FA_MS_LOGIN = 30 * 60 * 1000; // 30 minut
 716 |             const startWait2FALogin = Date.now();
 717 |             while (true) {
 718 |               if (Date.now() - startWait2FALogin > MAX_WAIT_2FA_MS_LOGIN) {
 719 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA po logowaniu (30 min) - restart procesu");
 720 |                 await sendOwnerAlert("TIMEOUT 2FA LOGIN", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô po logowaniu. Proces zostanie zrestartowany.");
 721 |                 process.exit(1);
 722 |               }
 723 |               await new Promise(r => setTimeout(r, 30000));
 724 |               const nowLogged = await checkIfLogged(page).catch(() => false);
 725 |               if (nowLogged) {
 726 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
 727 |                 await saveCookies(page);
 728 |                 loggedIn = true;
 729 |                 break;
 730 |               }
 731 |               const remainingMinLogin = Math.round((MAX_WAIT_2FA_MS_LOGIN - (Date.now() - startWait2FALogin)) / 60000);
 732 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMinLogin} min)`);
 733 |             }
 734 |           } else {
 735 |             process.exit(1);
 736 |           }
 737 |         }
 738 | 
 739 |         if (loggedIn) {
 740 |           log.success("LOGIN", "Zalogowano pomy≈õlnie");
 741 |           await saveCookies(page);
 742 |         } else {
 743 |           log.error("LOGIN", "Logowanie nieudane");
 744 |         }
 745 |       } else {
 746 |         log.dev("LOGIN", "U≈ºyto istniejƒÖcej sesji");
 747 |       }
 748 | 
 749 |       // posts
 750 |       await refreshPostsIfNeeded(true);
 751 | 
 752 |       if (!currentPosts.length) {
 753 |         log.warn("WATCHER", "Brak aktywnych post√≥w do monitorowania");
 754 |       } else {
 755 |         // Human Behavior: randomizacja kolejno≈õci post√≥w
 756 |         const shuffledPosts = shuffleArray(currentPosts);
 757 |         const postOrder = shuffledPosts.map(p => p.name || p.id.slice(0, 8)).join(" ‚Üí ");
 758 |         log.dev("HUMAN", `Kolejno≈õƒá post√≥w: ${postOrder}`);
 759 | 
 760 |         let postIndex = 0;
 761 |         for (const post of shuffledPosts) {
 762 |           // Human Behavior: pauza PRZED ka≈ºdym postem (poza pierwszym)
 763 |           if (postIndex > 0) {
 764 |             const pauseMs = await betweenPostsPause();
 765 |             log.dev("HUMAN", `Pauza: ${(pauseMs / 1000).toFixed(1)}s`);
 766 |           }
 767 |           postIndex++;
 768 | 
 769 |           const cacheKey = getCacheKey(post);
 770 |           const postLabel = post.name || post.id.slice(0, 8);
 771 | 
 772 |           try {
 773 |             log.dev("NAV", `‚Üí ${postLabel}`);
 774 |             await prepare(page, post.url);
 775 | 
 776 |             // ==================== FAST_MODE BRANCH ====================
 777 |             if (FAST_MODE) {
 778 |               const knownSet = getKnownSetForPost(cacheKey);
 779 |               const isFirstRun = !lastCounts.has(cacheKey);
 780 | 
 781 |               // 1. Prze≈ÇƒÖcz na "Najnowsze"
 782 |               const switchResult = await switchCommentsFilterToNewest(page, post.url).catch(() => ({ ok: false }));
 783 | 
 784 |               if (!switchResult.ok) {
 785 |                 log.dev("FAST", `${postLabel}: Fallback do normalnego trybu`, { reason: switchResult.reason });
 786 |               } else {
 787 |                 await new Promise((r) => setTimeout(r, 600 + Math.random() * 400));
 788 | 
 789 |                 const snapshot = await extractCommentsData(page, post.url).catch(() => []);
 790 |                 const sample = snapshot.slice(0, 30);
 791 | 
 792 |                 log.dev("FAST", `${postLabel}: ${sample.length} komentarzy (sort=Najnowsze)`);
 793 | 
 794 |                 // Inicjalizacja
 795 |                 if (isFirstRun) {
 796 |                   lastCounts.set(cacheKey, sample.length);
 797 |                   for (const c of sample) if (c?.id) knownSet.add(c.id);
 798 |                   log.dev("FAST", `${postLabel}: Inicjalizacja - zapamiƒôtano ${sample.length}`);
 799 |                   continue;
 800 |                 }
 801 | 
 802 |                 // Early skip
 803 |                 if (sample.length > 0) {
 804 |                   const newestTime = sample[0]?.time || sample[0]?.fb_time_raw;
 805 |                   const newestAge = getCommentAgeMinutes(newestTime);
 806 | 
 807 |                   if (newestAge !== null && newestAge > FAST_MAX_AGE_MIN) {
 808 |                     log.dev("FAST", `${postLabel}: SKIP - najnowszy ${Math.round(newestAge)} min`, { limit: FAST_MAX_AGE_MIN });
 809 |                     continue;
 810 |                   }
 811 |                 }
 812 | 
 813 |                 // Dedup
 814 |                 const newComments = [];
 815 |                 for (const c of sample) {
 816 |                   if (!c?.id) continue;
 817 |                   if (!knownSet.has(c.id)) {
 818 |                     knownSet.add(c.id);
 819 |                     newComments.push(c);
 820 |                     c.__postId = post.id;
 821 |                     c.__postUrl = post.url;
 822 |                   }
 823 |                 }
 824 | 
 825 |                 // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
 826 |                 cleanupKnownIds(knownSet);
 827 | 
 828 |                 // Wysy≈Çka
 829 |                 if (newComments.length > 0) {
 830 |                   log.success("FAST", `${postLabel}: +${newComments.length} nowych`);
 831 |                   newCommentsTotal += newComments.length;
 832 | 
 833 |                   const safeComments = newComments.filter((c) => c.__postId === post.id);
 834 |                   if (safeComments.length !== newComments.length) {
 835 |                     log.warn("FAST", "Odfiltrowano komentarze spoza posta", {
 836 |                       before: newComments.length,
 837 |                       after: safeComments.length,
 838 |                     });
 839 |                   }
 840 |                   await sendTelegramIfFresh(post, safeComments, "fast");
 841 |                 } else {
 842 |                   log.dev("FAST", `${postLabel}: Brak nowych`);
 843 |                 }
 844 | 
 845 |                 continue;
 846 |               }
 847 |             }
 848 |             // ==================== KONIEC FAST_MODE ====================
 849 | 
 850 |             const count = await getCommentCount(page, post.url);
 851 |             const hasCount = typeof count === "number" && Number.isFinite(count);
 852 | 
 853 |             if (!hasCount) {
 854 |               log.dev("WATCHER", `${postLabel}: Brak licznika - tryb awaryjny`);
 855 |             }
 856 | 
 857 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
 858 |             const knownSet = getKnownSetForPost(cacheKey);
 859 | 
 860 |             // Pierwsze wej≈õcie
 861 |             if (prev === null) {
 862 |               const initialCount = hasCount ? count : 0;
 863 |               lastCounts.set(cacheKey, initialCount);
 864 | 
 865 |               log.dev("WATCHER", `${postLabel}: Inicjalizacja (${initialCount} komentarzy)`);
 866 | 
 867 |               if (EXPAND_COMMENTS) {
 868 |                 await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }, post.url).catch(() => {});
 869 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
 870 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
 871 |                 log.dev("WATCHER", `${postLabel}: Zapamiƒôtano ${snap.length} istniejƒÖcych`);
 872 |               }
 873 | 
 874 |               continue;
 875 |             }
 876 | 
 877 |             if (hasCount) {
 878 |               if (count !== prev) {
 879 |                 log.dev("WATCHER", `${postLabel}: Zmiana ${prev} ‚Üí ${count}`);
 880 |                 lastCounts.set(cacheKey, count);
 881 |               } else {
 882 |                 log.dev("WATCHER", `${postLabel}: Bez zmian (${count})`);
 883 |               }
 884 |             }
 885 | 
 886 |             if (!EXPAND_COMMENTS) continue;
 887 | 
 888 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(() => {});
 889 |             const snapshot = await extractCommentsData(page, post.url).catch(() => []);
 890 | 
 891 |             const newComments = [];
 892 |             for (const c of snapshot) {
 893 |               if (!c?.id) continue;
 894 |               if (!knownSet.has(c.id)) {
 895 |                 knownSet.add(c.id);
 896 |                 newComments.push(c);
 897 |                 c.__postId = post.id;
 898 |                 c.__postUrl = post.url;
 899 |               }
 900 |             }
 901 | 
 902 |             // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
 903 |             cleanupKnownIds(knownSet);
 904 | 
 905 |             log.debug("DEDUP", `${postLabel}: context`, {
 906 |               snapshotLen: snapshot.length,
 907 |               newLen: newComments.length,
 908 |             });
 909 | 
 910 |             // Fallback
 911 |             if (hasCount && newComments.length === 0 && count > prev) {
 912 |               const diff = Math.max(1, count - prev);
 913 |               const tail = snapshot.slice(-diff);
 914 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
 915 | 
 916 |               log.dev("WATCHER", `${postLabel}: Fallback - biorƒô ostatnie ${diff}`);
 917 |               await sendTelegramIfFresh(post, tail, "fallback");
 918 |               newCommentsTotal += tail.length;
 919 |               continue;
 920 |             }
 921 | 
 922 |             if (newComments.length > 0) {
 923 |               log.success("WATCHER", `${postLabel}: +${newComments.length} nowych`);
 924 |               newCommentsTotal += newComments.length;
 925 | 
 926 |               const safeComments = newComments.filter((c) => c.__postId === post.id);
 927 |               if (safeComments.length !== newComments.length) {
 928 |                 log.warn("WATCHER", "Odfiltrowano komentarze spoza posta", {
 929 |                   before: newComments.length,
 930 |                   after: safeComments.length,
 931 |                 });
 932 |               }
 933 |               await sendTelegramIfFresh(post, safeComments, "normal");
 934 |             }
 935 |           } catch (err) {
 936 |             errorsCount++;
 937 |             log.error("WATCHER", `B≈ÇƒÖd przy ${postLabel}: ${err?.message || err}`);
 938 |             log.debug("WATCHER", "Stack", { stack: err?.stack });
 939 | 
 940 |             if (isNavigationError(err)) {
 941 |               hadNavErrorThisRound = true;
 942 |               navErrorCount++;
 943 |               log.warn("WATCHER", `B≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`);
 944 |             }
 945 |           }
 946 |         }
 947 |       }
 948 |     } catch (err) {
 949 |       errorsCount++;
 950 |       log.error("WATCHER", `B≈ÇƒÖd w cyklu: ${err?.message || err}`);
 951 |     } finally {
 952 |       flushCacheToDisk();
 953 | 
 954 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
 955 |         log.dev("WATCHER", `Reset licznika b≈Çƒôd√≥w nawigacji (by≈Ço ${navErrorCount})`);
 956 |         navErrorCount = 0;
 957 |       }
 958 | 
 959 |       if (browser) {
 960 |         try {
 961 |           await browser.close();
 962 |           log.dev("WATCHER", "Zamkniƒôto przeglƒÖdarkƒô");
 963 |         } catch (e) {
 964 |           log.warn("WATCHER", `B≈ÇƒÖd zamykania przeglƒÖdarki: ${e?.message}`);
 965 |         }
 966 |       }
 967 | 
 968 |       const duration = Date.now() - cycleStart;
 969 |       const cacheSize = getCacheSize();
 970 |       const cacheEntries = getCacheEntryCount();
 971 |       const totalKnownIds = getTotalKnownIdsCount();
 972 | 
 973 |       log.cycleSummary({
 974 |         cycle: cycleNumber,
 975 |         posts: currentPosts.length,
 976 |         newComments: newCommentsTotal,
 977 |         duration,
 978 |         errors: errorsCount,
 979 |         cacheSize,
 980 |         cacheEntries,
 981 |         totalKnownIds,
 982 |       });
 983 | 
 984 |       // Alert je≈õli cache przekroczy≈Ç 10MB
 985 |       if (cacheSize > 10 * 1024 * 1024) {
 986 |         log.warn("CACHE", `Rozmiar cache przekroczy≈Ç 10MB: ${Math.round(cacheSize / 1024 / 1024)}MB`);
 987 |       }
 988 | 
 989 |       if (navErrorCount >= MAX_NAV_ERRORS) {
 990 |         log.error("WATCHER", "Za du≈ºo b≈Çƒôd√≥w nawigacji ‚Äì ko≈Ñczƒô proces");
 991 |         process.exit(1);
 992 |       }
 993 | 
 994 |       const jitter = Math.floor(Math.random() * 5000);
 995 |       const delay = CHECK_INTERVAL_MS + jitter;
 996 |       log.dev("WATCHER", `Nastƒôpny cykl za ${Math.round(delay / 1000)}s`);
 997 |       setTimeout(loop, delay);
 998 |     }
 999 |   };
1000 | 
1001 |   loop();
1002 | }
1003 | 
1004 | export { startWatcher };
1005 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/api.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
  1 | import http from "http";
  2 | import { exec } from "child_process";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import crypto from "crypto";
  6 | import dotenv from "dotenv";
  7 | 
  8 | // ---- BASE DIR (dev vs exe) ----
  9 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
 10 | 
 11 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
 12 | dotenv.config({ path: path.join(process.cwd(), ".env") });
 13 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
 14 | 
 15 | // UI: dev -> src/panel/ui, exe -> ./ui
 16 | const UI_DIR = process.pkg
 17 |   ? path.join(BASE_DIR, "ui")
 18 |   : path.join(BASE_DIR, "src", "panel", "ui");
 19 | 
 20 | const PORT = Number(process.env.PANEL_PORT || 3180);
 21 | const TOKEN = process.env.PANEL_TOKEN;
 22 | 
 23 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
 24 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
 25 | 
 26 | if (!TOKEN) {
 27 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
 28 |   process.exit(1);
 29 | }
 30 | 
 31 | function auth(req, res) {
 32 |   const h = req.headers["authorization"] || "";
 33 |   if (h !== `Bearer ${TOKEN}`) {
 34 |     res.writeHead(401);
 35 |     res.end("Unauthorized");
 36 |     return false;
 37 |   }
 38 |   return true;
 39 | }
 40 | 
 41 | function json(res, obj, code = 200) {
 42 |   res.writeHead(code, { "Content-Type": "application/json" });
 43 |   res.end(JSON.stringify(obj, null, 2));
 44 | }
 45 | 
 46 | function sh(cmd) {
 47 |   return new Promise((resolve) => {
 48 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
 49 |       resolve({
 50 |         ok: !err,
 51 |         stdout: (stdout || "").trim(),
 52 |         stderr: (stderr || "").trim(),
 53 |         code: err?.code ?? 0,
 54 |       });
 55 |     });
 56 |   });
 57 | }
 58 | 
 59 | async function getProjectDir() {
 60 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
 61 | 
 62 |   const r = await sh(`pm2 describe ${PM2_APP}`);
 63 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
 64 |   if (!m)
 65 |     throw new Error(
 66 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
 67 |     );
 68 |   return m[1].trim();
 69 | }
 70 | 
 71 | function readBody(req) {
 72 |   return new Promise((resolve) => {
 73 |     let d = "";
 74 |     req.on("data", (c) => (d += c));
 75 |     req.on("end", () => resolve(d));
 76 |   });
 77 | }
 78 | 
 79 | function safeJsonParse(s) {
 80 |   try {
 81 |     return { ok: true, value: JSON.parse(s) };
 82 |   } catch (e) {
 83 |     return { ok: false, error: e?.message || "Invalid JSON" };
 84 |   }
 85 | }
 86 | 
 87 | function ensureDir(p) {
 88 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
 89 | }
 90 | 
 91 | function atomicWriteFile(filePath, content) {
 92 |   const dir = path.dirname(filePath);
 93 |   ensureDir(dir);
 94 | 
 95 |   const tmp = path.join(
 96 |     dir,
 97 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
 98 |   );
 99 |   fs.writeFileSync(tmp, content, "utf8");
100 |   fs.renameSync(tmp, filePath);
101 | }
102 | 
103 | function normalizeUrl(u) {
104 |   if (!u) return "";
105 |   const x = String(u).trim();
106 |   if (!/^https?:\/\/.+/i.test(x)) return "";
107 |   return x;
108 | }
109 | 
110 | function normalizeOptionalUrl(u) {
111 |   if (!u) return "";
112 |   const x = String(u).trim();
113 |   if (x === "") return "";
114 |   if (!/^https?:\/\/.+/i.test(x)) return "";
115 |   return x;
116 | }
117 | 
118 | function nowIso() {
119 |   return new Date().toISOString();
120 | }
121 | 
122 | function setEnvKey(envText, key, value) {
123 |   const re = new RegExp(`^${key}=.*$`, "m");
124 |   const line = `${key}=${value}`;
125 |   if (re.test(envText)) return envText.replace(re, line);
126 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
127 | }
128 | 
129 | function pickPostsFile(projectDir) {
130 |   return path.join(projectDir, "data", "posts.json");
131 | }
132 | 
133 | function readPosts(postsPath) {
134 |   if (!fs.existsSync(postsPath)) return [];
135 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
136 |   if (!raw) return [];
137 |   const parsed = safeJsonParse(raw);
138 |   if (!parsed.ok || !Array.isArray(parsed.value))
139 |     throw new Error("posts.json invalid (expected array)");
140 |   return parsed.value;
141 | }
142 | 
143 | function writePosts(postsPath, posts) {
144 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
145 | }
146 | 
147 | function genId() {
148 |   return crypto.randomBytes(8).toString("hex");
149 | }
150 | 
151 | function route(req) {
152 |   const url = new URL(req.url, "http://localhost");
153 |   const pathname = url.pathname;
154 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
155 | }
156 | 
157 | function match(pathname, pattern) {
158 |   const a = pathname.split("/").filter(Boolean);
159 |   const b = pattern.split("/").filter(Boolean);
160 |   if (a.length !== b.length) return null;
161 |   const params = {};
162 |   for (let i = 0; i < a.length; i++) {
163 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
164 |     else if (a[i] !== b[i]) return null;
165 |   }
166 |   return params;
167 | }
168 | 
169 | // ---------- LOGS (dynamic from pm2 describe) ----------
170 | function parsePm2LogPaths(pm2DescribeText) {
171 |   const out =
172 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
173 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
174 |     "";
175 |   const err =
176 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
177 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
178 |     "";
179 |   return { out, err };
180 | }
181 | 
182 | async function getPm2LogPaths(appName) {
183 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
184 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
185 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
186 | 
187 |   const d = await sh(`pm2 describe ${appName}`);
188 |   if (!d.ok)
189 |     return {
190 |       out: "",
191 |       err: "",
192 |       source: "pm2_error",
193 |       pm2: d.stderr || d.stdout || "",
194 |     };
195 | 
196 |   const p = parsePm2LogPaths(d.stdout);
197 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
198 | }
199 | 
200 | async function readTailLog(filePath, lines) {
201 |   try {
202 |     if (!filePath) {
203 |       return {
204 |         ok: false,
205 |         error:
206 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
207 |         path: filePath,
208 |       };
209 |     }
210 | 
211 |     if (!fs.existsSync(filePath)) {
212 |       return {
213 |         ok: false,
214 |         error:
215 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
216 |         path: filePath,
217 |       };
218 |     }
219 | 
220 |     const st = fs.statSync(filePath);
221 |     if (!st || !st.isFile()) {
222 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
223 |     }
224 | 
225 |     if (st.size === 0) {
226 |       return {
227 |         ok: false,
228 |         error:
229 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
230 |         path: filePath,
231 |       };
232 |     }
233 | 
234 |     const tailCmd = `tail -n ${lines} "${filePath}"`;
235 |     const r = await sh(tailCmd);
236 | 
237 |     if (r.ok && (r.stdout || "").trim()) {
238 |       return { ok: true, log: r.stdout, path: filePath, via: "tail" };
239 |     }
240 | 
241 |     // fallback JS
242 |     const raw = fs.readFileSync(filePath, "utf8");
243 |     const arr = raw.split(/\r?\n/);
244 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
245 |     const txt = (slice || "").trim();
246 | 
247 |     if (!txt) {
248 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
249 |     }
250 | 
251 |     return { ok: true, log: slice, path: filePath, via: "js" };
252 |   } catch (e) {
253 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
254 |   }
255 | }
256 | 
257 | http
258 |   .createServer(async (req, res) => {
259 |     const { pathname, query } = route(req);
260 | 
261 |     // ---------- PUBLIC UI ----------
262 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
263 |       const p = path.join(UI_DIR, "index.html");
264 |       const html = fs.readFileSync(p, "utf8");
265 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
266 |       res.end(html);
267 |       return;
268 |     }
269 | 
270 |     if (req.method === "GET" && pathname === "/app.js") {
271 |       const p = path.join(UI_DIR, "app.js");
272 |       const js = fs.readFileSync(p, "utf8");
273 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
274 |       res.end(js);
275 |       return;
276 |     }
277 | 
278 |     // ---------- AUTH for API ----------
279 |     if (pathname.startsWith("/api/")) {
280 |       if (!auth(req, res)) return;
281 |     }
282 | 
283 |     try {
284 |       const PROJECT_DIR = await getProjectDir();
285 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
286 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
287 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
288 | 
289 |       // ===== STATUS =====
290 |       if (req.method === "GET" && pathname === "/api/status") {
291 |         const node = await sh("node -v");
292 |         const pm2v = await sh("pm2 -v");
293 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
294 |         json(res, {
295 |           ok: true,
296 |           projectDir: PROJECT_DIR,
297 |           envPath: ENV_PATH,
298 |           cookiesPath: COOKIES_PATH,
299 |           postsPath: POSTS_PATH,
300 |           node: node.stdout,
301 |           pm2: pm2v.stdout,
302 |           pm2Status: pm2s.stdout,
303 |           time: nowIso(),
304 |         });
305 |         return;
306 |       }
307 | 
308 |       // ===== ENV GET (selected keys) =====
309 |       if (req.method === "GET" && pathname === "/api/env/get") {
310 |         if (!fs.existsSync(ENV_PATH)) {
311 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
312 |           return;
313 |         }
314 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
315 |         const wanted = [
316 |           "FB_EMAIL",
317 |           "FB_PASSWORD",
318 |           "WEBHOOK_URL",
319 |           "CHECK_INTERVAL_MS",
320 |           "POSTS_SHEET_URL",
321 |           "HEADLESS_BROWSER",
322 |           "USE_UI_HANDLERS",
323 |           "INCLUDE_REPLIES",
324 |         ];
325 |         const values = {};
326 |         for (const k of wanted) {
327 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
328 |           values[k] = m ? m[1] : "";
329 |         }
330 |         json(res, { ok: true, values });
331 |         return;
332 |       }
333 | 
334 |       // ===== ENV SET MULTIPLE =====
335 |       if (req.method === "POST" && pathname === "/api/env/set") {
336 |         const bodyRaw = await readBody(req);
337 |         const parsed = safeJsonParse(bodyRaw || "{}");
338 |         if (!parsed.ok) {
339 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
340 |           return;
341 |         }
342 | 
343 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
344 |         const restart = Boolean(parsed.value.restart);
345 | 
346 |         if (!set) {
347 |           json(res, { ok: false, error: "Missing set object" }, 400);
348 |           return;
349 |         }
350 |         if (!fs.existsSync(ENV_PATH)) {
351 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
352 |           return;
353 |         }
354 | 
355 |         let env = fs.readFileSync(ENV_PATH, "utf8");
356 |         const updated = [];
357 | 
358 |         for (const [k, v] of Object.entries(set)) {
359 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
360 |           env = setEnvKey(env, k, String(v));
361 |           updated.push(k);
362 |         }
363 | 
364 |         atomicWriteFile(ENV_PATH, env);
365 | 
366 |         let pm2Action = null;
367 |         if (restart) {
368 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
369 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
370 |         }
371 | 
372 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
373 |         return;
374 |       }
375 | 
376 |       // ===== POSTS: LIST =====
377 |       if (req.method === "GET" && pathname === "/api/posts") {
378 |         const posts = readPosts(POSTS_PATH);
379 | 
380 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
381 |         const norm = (posts || []).map((p) => ({
382 |           id: String(p.id || "").trim(),
383 |           url: String(p.url || "").trim(),
384 |           active: p.active !== undefined ? Boolean(p.active) : true,
385 |           name: String(p.name || "").trim(),
386 |           image: String(p.image || "").trim(),
387 |           description: String(p.description || "").trim(),
388 |           createdAt: p.createdAt || "",
389 |           updatedAt: p.updatedAt || "",
390 |         }));
391 | 
392 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
393 |         json(res, { ok: true, posts: norm });
394 |         return;
395 |       }
396 | 
397 |       // ===== POSTS: ADD =====
398 |       if (req.method === "POST" && pathname === "/api/posts") {
399 |         const bodyRaw = await readBody(req);
400 |         const parsed = safeJsonParse(bodyRaw || "{}");
401 |         if (!parsed.ok) {
402 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
403 |           return;
404 |         }
405 | 
406 |         const url = normalizeUrl(parsed.value.url);
407 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
408 | 
409 |         const name = String(parsed.value.name || "").trim();
410 |         const imageRaw = String(parsed.value.image || "").trim();
411 |         const image = normalizeOptionalUrl(imageRaw);
412 |         const description = String(parsed.value.description || "").trim();
413 | 
414 |         if (!url) {
415 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
416 |           return;
417 |         }
418 |         if (imageRaw !== "" && !image) {
419 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
420 |           return;
421 |         }
422 | 
423 |         const posts = readPosts(POSTS_PATH);
424 |         const existing = posts.find((p) => p.url === url);
425 |         if (existing) {
426 |           existing.active = active;
427 |           existing.name = name;
428 |           existing.image = image;
429 |           existing.description = description;
430 |           existing.updatedAt = nowIso();
431 |           writePosts(POSTS_PATH, posts);
432 |           json(res, { ok: true, post: existing, deduped: true });
433 |           return;
434 |         }
435 | 
436 |         const post = {
437 |           id: genId(),
438 |           url,
439 |           active,
440 |           name,
441 |           image,
442 |           description,
443 |           createdAt: nowIso(),
444 |           updatedAt: nowIso(),
445 |         };
446 |         posts.push(post);
447 |         writePosts(POSTS_PATH, posts);
448 | 
449 |         json(res, { ok: true, post });
450 |         return;
451 |       }
452 | 
453 |       // ===== POSTS: PATCH =====
454 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
455 |       if (mPatch) {
456 |         const id = mPatch.id;
457 |         const bodyRaw = await readBody(req);
458 |         const parsed = safeJsonParse(bodyRaw || "{}");
459 |         if (!parsed.ok) {
460 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
461 |           return;
462 |         }
463 | 
464 |         const posts = readPosts(POSTS_PATH);
465 |         const post = posts.find((p) => p.id === id);
466 |         if (!post) {
467 |           json(res, { ok: false, error: "Post not found" }, 404);
468 |           return;
469 |         }
470 | 
471 |         if (parsed.value.url !== undefined) {
472 |           const nextUrl = normalizeUrl(parsed.value.url);
473 |           if (!nextUrl) {
474 |             json(res, { ok: false, error: "Invalid url" }, 400);
475 |             return;
476 |           }
477 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
478 |           if (dup) {
479 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
480 |             return;
481 |           }
482 |           post.url = nextUrl;
483 |         }
484 | 
485 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
486 | 
487 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
488 | 
489 |         if (parsed.value.image !== undefined) {
490 |           const raw = String(parsed.value.image || "").trim();
491 |           const img = normalizeOptionalUrl(raw);
492 |           if (raw !== "" && !img) {
493 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
494 |             return;
495 |           }
496 |           post.image = img;
497 |         }
498 | 
499 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
500 | 
501 |         post.updatedAt = nowIso();
502 |         writePosts(POSTS_PATH, posts);
503 |         json(res, { ok: true, post });
504 |         return;
505 |       }
506 | 
507 |       // ===== POSTS: DELETE =====
508 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
509 |       if (mDel) {
510 |         const id = mDel.id;
511 |         const posts = readPosts(POSTS_PATH);
512 |         const idx = posts.findIndex((p) => p.id === id);
513 |         if (idx === -1) {
514 |           json(res, { ok: false, error: "Post not found" }, 404);
515 |           return;
516 |         }
517 |         const removed = posts.splice(idx, 1)[0];
518 |         writePosts(POSTS_PATH, posts);
519 |         json(res, { ok: true, removed });
520 |         return;
521 |       }
522 | 
523 |       // ===== COOKIES: CLEAR =====
524 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
525 |         const bodyRaw = await readBody(req);
526 |         const parsed = safeJsonParse(bodyRaw || "{}");
527 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
528 | 
529 |         if (!confirm) {
530 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
531 |           return;
532 |         }
533 | 
534 |         atomicWriteFile(COOKIES_PATH, "[]\n");
535 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
536 |         return;
537 |       }
538 | 
539 |       // ===== PM2 =====
540 |       function okOrErr(r, fallbackErr = "Command failed") {
541 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
542 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
543 |       }
544 |       async function pm2Describe(name) {
545 |         return await sh(`pm2 describe ${name}`);
546 |       }
547 | 
548 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
549 |       const WATCH_NAME = PM2_APP || "fbwatcher";
550 | 
551 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
552 |         const d = await pm2Describe(WATCH_NAME);
553 |         if (d.ok) {
554 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
555 |           json(res, okOrErr(r, "PM2 start failed"));
556 |           return;
557 |         }
558 | 
559 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
560 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
561 |         return;
562 |       }
563 | 
564 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
565 |         const d = await pm2Describe(WATCH_NAME);
566 |         if (!d.ok) {
567 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
568 |           return;
569 |         }
570 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
571 |         json(res, okOrErr(r, "PM2 restart failed"));
572 |         return;
573 |       }
574 | 
575 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
576 |         const d = await pm2Describe(WATCH_NAME);
577 |         if (!d.ok) {
578 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
579 |           return;
580 |         }
581 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
582 |         json(res, okOrErr(r, "PM2 stop failed"));
583 |         return;
584 |       }
585 | 
586 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
587 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
588 |         json(res, okOrErr(r, "PM2 status failed"));
589 |         return;
590 |       }
591 | 
592 |       // ===== LOGS INFO (debug) =====
593 |       if (req.method === "GET" && pathname === "/api/logs/info") {
594 |         const paths = await getPm2LogPaths(PM2_APP);
595 |         json(res, { ok: true, app: PM2_APP, ...paths });
596 |         return;
597 |       }
598 | 
599 |       // ===== LOGS =====
600 |       if (req.method === "GET" && pathname === "/api/logs/out") {
601 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
602 |         const paths = await getPm2LogPaths(PM2_APP);
603 |         const payload = await readTailLog(paths.out, lines);
604 |         json(res, { ...payload, source: paths.source });
605 |         return;
606 |       }
607 | 
608 |       if (req.method === "GET" && pathname === "/api/logs/err") {
609 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
610 |         const paths = await getPm2LogPaths(PM2_APP);
611 |         const payload = await readTailLog(paths.err, lines);
612 |         json(res, { ...payload, source: paths.source });
613 |         return;
614 |       }
615 | 
616 |       json(res, { ok: false, error: "Not found" }, 404);
617 |     } catch (e) {
618 |       json(res, { ok: false, error: e.message }, 500);
619 |     }
620 |   })
621 |   .listen(PORT, "127.0.0.1", () => {
622 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
623 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
624 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
625 |   });
626 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/panel-entry.cjs`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
1 | // src/panel/panel-entry.cjs
2 | require("./api.js");
3 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/app.js`
**Typ:** JavaScript/tekst  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```js
  1 | const $ = (id) => document.getElementById(id);
  2 | 
  3 | /* =========================
  4 |    AUTH / API
  5 | ========================= */
  6 | 
  7 | function getToken() {
  8 |   return localStorage.getItem("panel_token") || "";
  9 | }
 10 | function setToken(t) {
 11 |   localStorage.setItem("panel_token", t || "");
 12 | }
 13 | 
 14 | async function api(path, opts = {}) {
 15 |   const token = getToken();
 16 |   const headers = Object.assign({}, opts.headers || {}, {
 17 |     Authorization: `Bearer ${token}`,
 18 |   });
 19 | 
 20 |   const res = await fetch(path, { ...opts, headers });
 21 |   const text = await res.text();
 22 | 
 23 |   let json;
 24 |   try {
 25 |     json = JSON.parse(text);
 26 |   } catch {
 27 |     json = { ok: false, error: "Non-JSON response", raw: text };
 28 |   }
 29 | 
 30 |   if (!res.ok || json.ok === false) {
 31 |     throw new Error(
 32 |       json.error ||
 33 |         json.output ||
 34 |         json.raw ||
 35 |         `HTTP ${res.status}`
 36 |     );
 37 |   }
 38 | 
 39 |   return json;
 40 | }
 41 | 
 42 | function msg(el, s) {
 43 |   el.textContent = s;
 44 | }
 45 | 
 46 | /* =========================
 47 |    STATUS / ENV
 48 | ========================= */
 49 | 
 50 | async function refreshAll() {
 51 |   try {
 52 |     const st = await api("/api/status");
 53 |     msg(
 54 |       $("status"),
 55 |       `OK ‚Ä¢ ${st.time} ‚Ä¢ node=${st.node} ‚Ä¢ pm2=${(st.pm2 || "").trim()}`
 56 |     );
 57 | 
 58 |     const env = await api("/api/env/get");
 59 |     const keys = [
 60 |       "FB_EMAIL",
 61 |       "FB_PASSWORD",
 62 |       "WEBHOOK_URL",
 63 |       "CHECK_INTERVAL_MS",
 64 |       "POSTS_SHEET_URL",
 65 |       "HEADLESS_BROWSER",
 66 |       "USE_UI_HANDLERS",
 67 |       "INCLUDE_REPLIES",
 68 |     ];
 69 |     for (const k of keys) {
 70 |       if ($(k)) $(k).value = env.values[k] ?? "";
 71 |     }
 72 | 
 73 |     await loadPosts();
 74 |   } catch (e) {
 75 |     msg($("status"), `B≈ÅƒÑD: ${e.message}`);
 76 |   }
 77 | }
 78 | 
 79 | /* =========================
 80 |    POSTS
 81 | ========================= */
 82 | 
 83 | function esc(s) {
 84 |   return String(s || "")
 85 |     .replaceAll("&", "&amp;")
 86 |     .replaceAll("<", "&lt;")
 87 |     .replaceAll(">", "&gt;");
 88 | }
 89 | 
 90 | async function loadPosts() {
 91 |   const r = await api("/api/posts");
 92 |   const tbody = $("posts");
 93 |   tbody.innerHTML = "";
 94 | 
 95 |   for (const p of r.posts || []) {
 96 |     const tr = document.createElement("tr");
 97 | 
 98 |     tr.innerHTML = `
 99 |       <td class="mono">${esc(p.id)}</td>
100 |       <td><a href="${esc(p.url)}" target="_blank">${esc(p.url)}</a></td>
101 |       <td>${esc(p.name || "")}</td>
102 |       <td>
103 |         ${p.image ? `<img src="${esc(p.image)}" style="width:60px;border-radius:6px;">` : "‚Äî"}
104 |       </td>
105 |       <td>${esc(p.description || "")}</td>
106 |       <td>
107 |         <input type="checkbox" ${p.active ? "checked" : ""} data-id="${p.id}" class="toggleActive">
108 |       </td>
109 |       <td>
110 |         <button data-id="${p.id}" class="edit">Edytuj</button>
111 |         <button data-id="${p.id}" class="del">Usu≈Ñ</button>
112 |       </td>
113 |     `;
114 | 
115 |     tbody.appendChild(tr);
116 |   }
117 | 
118 |   /* aktywno≈õƒá */
119 |   document.querySelectorAll(".toggleActive").forEach((cb) => {
120 |     cb.addEventListener("change", async (e) => {
121 |       await api(`/api/posts/${e.target.dataset.id}`, {
122 |         method: "PATCH",
123 |         headers: { "Content-Type": "application/json" },
124 |         body: JSON.stringify({ active: e.target.checked }),
125 |       });
126 |     });
127 |   });
128 | 
129 |   /* usu≈Ñ */
130 |   document.querySelectorAll(".del").forEach((btn) => {
131 |     btn.addEventListener("click", async () => {
132 |       await api(`/api/posts/${btn.dataset.id}`, { method: "DELETE" });
133 |       await loadPosts();
134 |     });
135 |   });
136 | 
137 |   /* EDYCJA ‚Äî TU JEST FIX */
138 |   document.querySelectorAll(".edit").forEach((btn) => {
139 |     btn.addEventListener("click", async () => {
140 |       const r2 = await api("/api/posts");
141 |       const post = r2.posts.find((x) => x.id === btn.dataset.id);
142 |       if (!post) return;
143 | 
144 |       const nameInput = prompt("Name (nazwa):", post.name || "");
145 |       const imageInput = prompt("Image URL (zdjƒôcie):", post.image || "");
146 |       const descInput = prompt("Description (opis):", post.description || "");
147 | 
148 |       const name =
149 |         nameInput === null ? post.name || "" : nameInput;
150 |       const image =
151 |         imageInput === null ? post.image || "" : imageInput;
152 |       const description =
153 |         descInput === null ? post.description || "" : descInput;
154 | 
155 |       await api(`/api/posts/${post.id}`, {
156 |         method: "PATCH",
157 |         headers: { "Content-Type": "application/json" },
158 |         body: JSON.stringify({
159 |           name: String(name).trim(),
160 |           image: String(image).trim(),
161 |           description: String(description).trim(),
162 |         }),
163 |       });
164 | 
165 |       await loadPosts();
166 |     });
167 |   });
168 | }
169 | 
170 | /* =========================
171 |    ADD POST
172 | ========================= */
173 | 
174 | $("addPost").addEventListener("click", async () => {
175 |   await api("/api/posts", {
176 |     method: "POST",
177 |     headers: { "Content-Type": "application/json" },
178 |     body: JSON.stringify({
179 |       url: $("newPostUrl").value.trim(),
180 |       name: $("newPostName").value.trim(),
181 |       image: $("newPostImage").value.trim(),
182 |       description: $("newPostDescription").value.trim(),
183 |       active: $("newPostActive").checked,
184 |     }),
185 |   });
186 | 
187 |   $("newPostUrl").value = "";
188 |   $("newPostName").value = "";
189 |   $("newPostImage").value = "";
190 |   $("newPostDescription").value = "";
191 | 
192 |   await loadPosts();
193 | });
194 | 
195 | /* =========================
196 |    INIT
197 | ========================= */
198 | 
199 | $("saveToken").addEventListener("click", () => {
200 |   setToken($("token").value.trim());
201 |   refreshAll();
202 | });
203 | 
204 | $("refresh").addEventListener("click", refreshAll);
205 | 
206 | (function init() {
207 |   $("token").value = getToken();
208 |   refreshAll();
209 | })();
210 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/index.html`
**Typ:** HTML  
**Opis:** Panel (frontend/backend) do zarzƒÖdzania watcherem.  

```html
  1 | <!doctype html>
  2 | <html lang="pl">
  3 | <head>
  4 |   <meta charset="utf-8" />
  5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
  6 |   <title>FB Watcher Panel</title>
  7 |   <style>
  8 |     body { font-family: system-ui, Arial; margin: 16px; background:#0b0f14; color:#e7eef7; }
  9 |     .row { display:flex; gap:12px; flex-wrap:wrap; }
 10 |     .card { background:#121926; border:1px solid #223047; border-radius:12px; padding:14px; margin:12px 0; }
 11 |     input, textarea, button, select { font: inherit; border-radius:10px; border:1px solid #2a3a55; background:#0b1220; color:#e7eef7; padding:10px; }
 12 |     input, textarea { width: 100%; box-sizing:border-box; }
 13 |     button { cursor:pointer; }
 14 |     button.primary { background:#2563eb; border-color:#2563eb; }
 15 |     button.danger { background:#b91c1c; border-color:#b91c1c; }
 16 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
 17 |     table { width:100%; border-collapse: collapse; }
 18 |     th, td { border-bottom:1px solid #223047; padding:8px; text-align:left; vertical-align:top; }
 19 |     .muted { opacity:0.75; font-size:12px; }
 20 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
 21 |     .sep { height:1px; background:#223047; margin:10px 0; opacity:0.8; }
 22 |     .thumb { width:64px; height:40px; object-fit:cover; border-radius:8px; border:1px solid #223047; background:#0b1220; }
 23 |   </style>
 24 | </head>
 25 | <body>
 26 |   <h2>FB Watcher ‚Äî Panel</h2>
 27 |   <div class="muted">Panel dzia≈Ça lokalnie. Token wymagany do akcji.</div>
 28 | 
 29 |   <div class="card">
 30 |     <div class="row">
 31 |       <div style="flex:1; min-width:260px;">
 32 |         <label>Token panelu</label>
 33 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
 34 |       </div>
 35 |       <div style="display:flex; gap:10px; align-items:flex-end;">
 36 |         <button class="primary" id="saveToken">Zapisz token</button>
 37 |         <button id="refresh">Od≈õwie≈º</button>
 38 |       </div>
 39 |     </div>
 40 |     <div id="status" class="muted" style="margin-top:10px;"></div>
 41 |   </div>
 42 | 
 43 |   <div class="card">
 44 |     <h3>Ustawienia (.env)</h3>
 45 | 
 46 |     <div class="row">
 47 |       <div style="flex:1; min-width:260px;">
 48 |         <label>FB_EMAIL</label>
 49 |         <input id="FB_EMAIL" />
 50 |       </div>
 51 |       <div style="flex:1; min-width:260px;">
 52 |         <label>FB_PASSWORD</label>
 53 |         <input id="FB_PASSWORD" type="password" />
 54 |       </div>
 55 |     </div>
 56 | 
 57 |     <label>WEBHOOK_URL</label>
 58 |     <input id="WEBHOOK_URL" />
 59 | 
 60 |     <div class="row">
 61 |       <div style="flex:1; min-width:200px;">
 62 |         <label>CHECK_INTERVAL_MS</label>
 63 |         <input id="CHECK_INTERVAL_MS" />
 64 |       </div>
 65 |       <div style="flex:2; min-width:260px;">
 66 |         <label>POSTS_SHEET_URL (csv export)</label>
 67 |         <input id="POSTS_SHEET_URL" />
 68 |       </div>
 69 |     </div>
 70 | 
 71 |     <div class="row">
 72 |       <div style="flex:1; min-width:200px;">
 73 |         <label>HEADLESS_BROWSER</label>
 74 |         <select id="HEADLESS_BROWSER">
 75 |           <option value="true">true</option>
 76 |           <option value="false">false</option>
 77 |         </select>
 78 |       </div>
 79 |       <div style="flex:1; min-width:200px;">
 80 |         <label>USE_UI_HANDLERS</label>
 81 |         <select id="USE_UI_HANDLERS">
 82 |           <option value="true">true</option>
 83 |           <option value="false">false</option>
 84 |         </select>
 85 |       </div>
 86 |       <div style="flex:1; min-width:200px;">
 87 |         <label>INCLUDE_REPLIES</label>
 88 |         <select id="INCLUDE_REPLIES">
 89 |           <option value="true">true</option>
 90 |           <option value="false">false</option>
 91 |         </select>
 92 |       </div>
 93 |     </div>
 94 | 
 95 |     <div class="row" style="margin-top:10px;">
 96 |       <button class="primary" id="saveEnv">Zapisz ENV</button>
 97 |       <button id="pm2Start">PM2 Start</button>
 98 |       <button id="pm2Stop">PM2 Stop</button>
 99 |       <button id="pm2Restart">PM2 Restart</button>
100 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
101 |     </div>
102 | 
103 |     <div id="envMsg" class="muted" style="margin-top:10px;"></div>
104 |   </div>
105 | 
106 |   <div class="card">
107 |     <h3>Posty (data/posts.json)</h3>
108 | 
109 |     <div class="row">
110 |       <div style="flex:2; min-width:260px;">
111 |         <label>Nowy URL posta</label>
112 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
113 |       </div>
114 | 
115 |       <div style="flex:1; min-width:220px;">
116 |         <label>Name (nazwa)</label>
117 |         <input id="newPostName" placeholder="np. A1" />
118 |       </div>
119 | 
120 |       <div style="flex:1; min-width:260px;">
121 |         <label>Image URL (zdjƒôcie)</label>
122 |         <input id="newPostImage" placeholder="https://...jpg" />
123 |       </div>
124 |     </div>
125 | 
126 |     <label>Description (opis)</label>
127 |     <textarea id="newPostDescription" style="height:90px;" placeholder="Kr√≥tki opis..."></textarea>
128 | 
129 |     <div class="row" style="margin-top:10px;">
130 |       <div style="min-width:160px; display:flex; align-items:center; gap:10px;">
131 |         <label style="margin:0;">
132 |           <input type="checkbox" id="newPostActive" checked /> aktywny
133 |         </label>
134 |         <button class="primary" id="addPost">Dodaj</button>
135 |       </div>
136 |     </div>
137 | 
138 |     <div style="margin-top:12px;">
139 |       <table>
140 |         <thead>
141 |           <tr>
142 |             <th>ID</th>
143 |             <th>URL</th>
144 |             <th>Name</th>
145 |             <th>Image</th>
146 |             <th>Description</th>
147 |             <th>Active</th>
148 |             <th>Akcje</th>
149 |           </tr>
150 |         </thead>
151 |         <tbody id="posts"></tbody>
152 |       </table>
153 |     </div>
154 |   </div>
155 | 
156 |   <div class="card">
157 |     <h3>Logi</h3>
158 | 
159 |     <div class="row">
160 |       <button id="loadOut">OUT</button>
161 |       <button id="loadErr">ERR</button>
162 | 
163 |       <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
164 | 
165 |       <select id="logAutoEvery" style="width:140px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
166 |         <option value="0">auto: off</option>
167 |         <option value="1000">co 1s</option>
168 |         <option value="2000" selected>co 2s</option>
169 |         <option value="5000">co 5s</option>
170 |         <option value="10000">co 10s</option>
171 |       </select>
172 | 
173 |       <button class="primary" id="logAutoToggle">Auto: OFF</button>
174 | 
175 |       <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
176 |         <input type="checkbox" id="logAutoScroll" checked />
177 |         auto-scroll
178 |       </label>
179 |     </div>
180 | 
181 |     <div class="sep"></div>
182 | 
183 |     <textarea
184 |       id="logs"
185 |       class="mono"
186 |       style="height:320px; margin-top:10px;"
187 |       readonly
188 |       spellcheck="false"
189 |       placeholder="Kliknij OUT albo ERR, ≈ºeby wczytaƒá logi..."></textarea>
190 | 
191 |     <div id="logHint" class="muted" style="margin-top:8px;"></div>
192 |   </div>
193 | 
194 |   <script src="/app.js"></script>
195 | </body>
196 | </html>
197 | 
```

---

### üìÑ ≈öcie≈ºka: `CLAUDE.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

```md
  1 | # FB_Watcher - Kontekst projektu
  2 | 
  3 | ## Opis projektu
  4 | Bot monitorujƒÖcy komentarze na postach Facebook za pomocƒÖ Puppeteer. Wykrywa nowe komentarze i wysy≈Ça powiadomienia przez Telegram.
  5 | 
  6 | ## Mapa plik√≥w (dla oszczƒôdno≈õci token√≥w)
  7 | 
  8 | | Plik | Linie | G≈Ç√≥wne funkcje | Opis |
  9 | |------|-------|----------------|------|
 10 | | `src/watcher.js` | ~895 | `startWatcher()`, `processPost()`, `fetchPosts()` | g≈Ç√≥wna pƒôtla |
 11 | | `src/fb/login.js` | ~824 | `doLogin()`, `setupCaptchaSolver()` | logowanie + 2Captcha |
 12 | | `src/fb/comments.js` | ~782 | `extractComments()`, `parseComment()` | ekstrakcja komentarzy |
 13 | | `src/telegram.js` | ~303 | `sendNotification()`, `formatMessage()` | powiadomienia |
 14 | | `src/utils/logger.js` | ~202 | `log()`, `logLevel` | logowanie |
 15 | | `src/fb/checkpoint.js` | ~180 | `detectCheckpoint()`, `handleCheckpoint()` | wykrywanie 2FA |
 16 | | `src/config.js` | ~172 | eksport zmiennych | env variables |
 17 | | `src/fb/cookies.js` | ~149 | `loadCookies()`, `saveCookies()` | zarzƒÖdzanie sesjƒÖ |
 18 | | `src/db/cache.js` | ~116 | `getCache()`, `updateCache()` | deduplikacja |
 19 | | `src/index.js` | ~83 | `main()` | punkt wej≈õcia |
 20 | | `src/utils/time.js` | ~63 | `parseRelativeTime()` | parsowanie "2 godz." |
 21 | | `src/utils/sleep.js` | ~132 | `humanDelay()`, `shuffleArray()`, `humanType()` | human behavior delays |
 22 | | `src/utils/mouse.js` | ~195 | `humanClick()`, `moveToElement()` | ruchy myszy Bezier |
 23 | 
 24 | ## Czƒôste operacje (gdzie edytowaƒá)
 25 | 
 26 | | Chcƒô zmieniƒá... | Edytuj plik | Funkcja |
 27 | |-----------------|-------------|---------|
 28 | | Format powiadomie≈Ñ | `src/telegram.js` | `formatMessage()` |
 29 | | Logikƒô logowania | `src/fb/login.js` | `doLogin()` |
 30 | | Ekstrakcjƒô komentarzy | `src/fb/comments.js` | `extractComments()` |
 31 | | Interwa≈Ç sprawdzania | `src/config.js` | `CHECK_INTERVAL_MS` |
 32 | | Obs≈Çugƒô checkpoint | `src/fb/checkpoint.js` | `handleCheckpoint()` |
 33 | | Cache komentarzy | `src/db/cache.js` | `updateCache()` |
 34 | | Op√≥≈∫nienia human-like | `src/utils/sleep.js` | `humanTypingDelay()` |
 35 | | Ruchy myszy | `src/utils/mouse.js` | `humanClick()` |
 36 | 
 37 | ## Architektura
 38 | 
 39 | ### ≈πr√≥d≈Ça post√≥w (priorytet)
 40 | 1. **Remote API** (`POSTS_API_URL`) - panel administracyjny
 41 | 2. **Lokalny plik** (`data/posts.json`) - fallback
 42 | 3. **Google Sheets** (`POSTS_SHEET_URL`) - ostateczny fallback
 43 | 
 44 | ## Ostatnia sesja (2026-01-20)
 45 | 
 46 | ### Branch: `feat/react-admin-panel`
 47 | 
 48 | ### Co zosta≈Ço zrobione
 49 | - **2Captcha solver** - automatyczne rozwiƒÖzywanie captcha przy logowaniu:
 50 |   - Plugin `puppeteer-extra-plugin-recaptcha`
 51 |   - Konfiguracja: `CAPTCHA_API_KEY` w .env
 52 |   - Dzia≈Ça dla reCAPTCHA v2/v3
 53 | - **Uproszczenie logiki cookies** - usuniƒôto rotacjƒô backup cookies:
 54 |   - Usuniƒôto soft ban detection
 55 |   - Usuniƒôto automatycznƒÖ rotacjƒô cookies przy checkpoint
 56 |   - Checkpoint = alert Telegram + stop (wymaga rƒôcznej interwencji)
 57 | - **Czyszczenie kodu** - usuniƒôto ~400 linii niepotrzebnego kodu
 58 | 
 59 | ### Konfiguracja 2Captcha (.env)
 60 | ```
 61 | CAPTCHA_API_KEY=twoj_klucz_2captcha
 62 | ```
 63 | 
 64 | ### Logika checkpoint (uproszczona)
 65 | ```
 66 | Checkpoint/2FA wykryty
 67 |     ‚Üì
 68 | Pr√≥ba rozwiƒÖzania captcha (2Captcha)
 69 |     ‚Üì
 70 | Je≈õli sukces ‚Üí kontynuuj
 71 | Je≈õli 2FA/blokada ‚Üí Alert Telegram + Stop
 72 |     ‚Üì
 73 | Rƒôczna interwencja:
 74 |   - Zmie≈Ñ login/has≈Ço w .env
 75 |   - Lub zaktualizuj cookies.json
 76 |     ‚Üì
 77 | PM2 restartuje automatycznie
 78 | ```
 79 | 
 80 | ## Konfiguracja (.env)
 81 | 
 82 | ### Podstawowe
 83 | ```
 84 | FB_EMAIL=email@example.com
 85 | FB_PASSWORD=haslo
 86 | CHECK_INTERVAL_MS=60000
 87 | ```
 88 | 
 89 | ### FAST_MODE
 90 | ```
 91 | FAST_MODE=true           # w≈ÇƒÖcza tryb szybki
 92 | FAST_MAX_AGE_MIN=180     # limit wieku komentarzy (minuty)
 93 | ```
 94 | 
 95 | ### Captcha
 96 | ```
 97 | CAPTCHA_API_KEY=klucz_2captcha
 98 | ```
 99 | 
100 | ### Logi
101 | ```
102 | LOG_LEVEL=1              # 0=silent, 1=prod, 2=dev, 3=debug
103 | ```
104 | 
105 | ### Remote Debug
106 | ```
107 | REMOTE_DEBUG_PORT=9222   # port do podglƒÖdu przeglƒÖdarki (0=wy≈ÇƒÖczony)
108 | ```
109 | 
110 | ### Human Behavior Mode
111 | ```
112 | HUMAN_MODE=true                    # w≈ÇƒÖcza symulacjƒô cz≈Çowieka (domy≈õlnie true)
113 | PROXY_URL=http://user:pass@host:port  # rotating residential proxy (opcjonalne)
114 | ```
115 | 
116 | ## Wa≈ºne informacje techniczne
117 | 
118 | ### Stealth
119 | Bot u≈ºywa technik ukrywania automatyzacji:
120 | - `navigator.webdriver = false`
121 | - Usuniƒôcie flag Chromium automation
122 | - Losowe op√≥≈∫nienia miƒôdzy akcjami
123 | - Plugin `puppeteer-extra-plugin-stealth` (aktywowany!)
124 | 
125 | ### Human Behavior Mode
126 | Symulacja zachowa≈Ñ cz≈Çowieka dla zmniejszenia ryzyka wykrycia:
127 | - **Stealth Plugin**: ukrywa webdriver, plugins, WebGL, canvas fingerprint
128 | - **Wolne pisanie**: ~120ms/znak z mikro-pauzami (zamiast 35ms)
129 | - **Rozk≈Çad Gaussa**: naturalne op√≥≈∫nienia zamiast jednolitych
130 | - **Shuffle post√≥w**: losowa kolejno≈õƒá sprawdzania (Fisher-Yates)
131 | - **Pauzy miƒôdzy postami**: 3-8 sekund z rozk≈Çadem normalnym
132 | - **Ruchy myszy**: krzywe Beziera (opcjonalne)
133 | - **Proxy support**: residential rotating proxy
134 | 
135 | Logi przy `LOG_LEVEL=2`:
136 | ```
137 | [STEALTH] Plugin stealth w≈ÇƒÖczony
138 | [PROXY] U≈ºywam proxy: http://***@host:port
139 | [HUMAN] Human Behavior Mode w≈ÇƒÖczony
140 | [HUMAN] Kolejno≈õƒá post√≥w: post3 ‚Üí post1 ‚Üí post2
141 | [HUMAN] Pauza: 5.2s
142 | ```
143 | 
144 | ### Cache
145 | - Plik: `data/comments-cache.json`
146 | - Struktura: `{ [postUrl]: { lastCount, knownIds: [] } }`
147 | - Deduplikacja przez ID komentarzy
148 | - Auto-cleanup gdy > 1000 IDs na post
149 | 
150 | ### Cookies
151 | - Plik: `cookies.json` w g≈Ç√≥wnym katalogu
152 | - Format: tablica cookies z Puppeteer
153 | - Atomic write (bezpieczny zapis)
154 | 
155 | ### Captcha Solver
156 | - Serwis: 2Captcha.com
157 | - Plugin: `puppeteer-extra-plugin-recaptcha`
158 | - Obs≈Çuguje: reCAPTCHA v2, v3, hCaptcha
159 | - Czas rozwiƒÖzania: ~30-60 sekund
160 | 
161 | ### Remote Debug (podglƒÖd przeglƒÖdarki na ≈ºywo)
162 | Pozwala pod≈ÇƒÖczyƒá siƒô do przeglƒÖdarki bota i rƒôcznie zrobiƒá 2FA/checkpoint.
163 | 
164 | ```bash
165 | # 1. Na serwerze - uruchom z portem debug
166 | REMOTE_DEBUG_PORT=9222 node src/index.js
167 | 
168 | # 2. Na PC - tunel SSH
169 | ssh -L 9222:localhost:9222 root@162.55.188.103
170 | 
171 | # 3. W Chrome na PC
172 | chrome://inspect/#devices ‚Üí Configure ‚Üí localhost:9222
173 | ```
174 | 
175 | Kliknij "inspect" przy facebook.com - masz pe≈ÇnƒÖ kontrolƒô nad przeglƒÖdarkƒÖ.
176 | 
177 | ### Proxy (opcjonalne)
178 | Zmniejsza ryzyko ban√≥w przez zmianƒô IP:
179 | - **Format**: `http://user:pass@host:port` lub `socks5://host:port`
180 | - **Zalecane**: Residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
181 | - Facebook flaguje: datacenter IP, ciƒÖg≈ÇƒÖ aktywno≈õƒá z jednego IP
182 | - Residential IP wyglƒÖdajƒÖ jak zwykli u≈ºytkownicy
183 | 
184 | ## Serwer produkcyjny
185 | 
186 | | Parametr | Warto≈õƒá |
187 | |----------|---------|
188 | | IP | `162.55.188.103` |
189 | | User | `root` |
190 | | System | Ubuntu 24.04.3 LTS |
191 | | ≈öcie≈ºka | `/opt/fb-watcher` |
192 | 
193 | ```bash
194 | # Po≈ÇƒÖczenie SSH
195 | ssh root@162.55.188.103
196 | 
197 | # SSH z tunelem do remote debug
198 | ssh -L 9222:localhost:9222 root@162.55.188.103
199 | ```
200 | 
201 | ## Komendy
202 | 
203 | ```bash
204 | # Uruchomienie
205 | node src/index.js
206 | 
207 | # PM2 (produkcja)
208 | pm2 start ecosystem.config.cjs
209 | 
210 | # Logi
211 | pm2 logs fb-watcher
212 | 
213 | # Generowanie cookies rƒôcznie
214 | node scripts/generate-cookies.js
215 | 
216 | # Uruchomienie z remote debug (podglƒÖd przeglƒÖdarki)
217 | REMOTE_DEBUG_PORT=9222 node src/index.js
218 | ```
219 | 
220 | ## Skrypty pomocnicze
221 | 
222 | ### `scripts/generate-cookies.js`
223 | Rƒôczne generowanie cookies przez logowanie w przeglƒÖdarce.
224 | ```bash
225 | node scripts/generate-cookies.js           # zapisz cookies.json
226 | node scripts/generate-cookies.js --list    # poka≈º istniejƒÖce
227 | ```
228 | 
229 | ## Workflow - wrzucanie na serwer
230 | 
231 | **ZASADA:** Zawsze tworzyƒá nowy branch przed wrzuceniem na serwer.
232 | 
233 | ```bash
234 | # 1. Nowy branch z timestampem
235 | git checkout -b deploy/YYYYMMDD-HHMMSS
236 | 
237 | # 2. Commit + push
238 | git add . && git commit -m "opis zmian"
239 | git push -u origin HEAD
240 | 
241 | # 3. Na serwerze
242 | ssh root@162.55.188.103
243 | cd /opt/fb-watcher
244 | git fetch && git checkout <branch>
245 | pm2 restart fb-watcher
246 | ```
247 | 
248 | ## Jak zadawaƒá pytania (oszczƒôdno≈õƒá token√≥w)
249 | 
250 | ### Dobrze
251 | ```
252 | "W src/telegram.js:120 formatMessage() - dodaj link do posta"
253 | "src/fb/login.js:45-60 - dodaj 3 retry przy b≈Çƒôdzie"
254 | "Czy w watcher.js:200-220 jest memory leak?"
255 | ```
256 | 
257 | ### ≈πle
258 | ```
259 | "Znajd≈∫ gdzie jest sendNotification"
260 | "Sprawd≈∫ czy watcher.js jest OK"
261 | "Poka≈º mi ca≈Çy plik login.js"
262 | ```
263 | 
264 | ### Zasady
265 | 1. **Podawaj ≈õcie≈ºkƒô + numer linii** je≈õli znasz
266 | 2. **Jedno pytanie = jeden temat** ‚Üí potem `/clear`
267 | 3. **Unikaj "poka≈º mi" / "wyja≈õnij ca≈Çy plik"**
268 | 4. **Po zako≈Ñczeniu zadania** ‚Üí `/clear` ‚Üí nowe zadanie
269 | 5. **Aktualizuj mapƒô plik√≥w** gdy dodasz nowy plik
270 | 
271 | ## Do zrobienia / Potencjalne usprawnienia
272 | - [ ] Testy 2Captcha na produkcji przy rzeczywistym checkpoint
273 | - [ ] Obs≈Çuga b≈Çƒôd√≥w gdy FB zmieni UI
274 | - [ ] Rate limiting dla Telegram
275 | - [ ] Metryki/statystyki wykrywania
276 | 
```

---

### üìÑ ≈öcie≈ºka: `cookies.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768949166457%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "c_user",
 18 |     "value": "61586902376231",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800484179.134967,
 22 |     "size": 20,
 23 |     "httpOnly": false,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "wd",
 33 |     "value": "1366x768",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1769553966,
 37 |     "size": 10,
 38 |     "httpOnly": false,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "Lax",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "xs",
 48 |     "value": "30%3AQpODUJy18dEViA%3A2%3A1768947868%3A-1%3A-1%3A%3AAcyvJd0PSoHqZgkPeeum7BDwv6SnDC8w49TCKBXWtA",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1800484179.135037,
 52 |     "size": 96,
 53 |     "httpOnly": true,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "None",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "oo",
 63 |     "value": "v1%7C3%3A1768947870",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1803507869.854458,
 67 |     "size": 21,
 68 |     "httpOnly": true,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "kQBwad5GZLHhirX_vA4H-M5I",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803507869.651363,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "kQBwaZbB9A8fcEdDLaEr2T1d",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803507860.517749,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_1.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821583937%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "29%3A0TI_s65lTO3qzg%3A2%3A1768821578%3A-1%3A-1%3A%3AAcxaLgNbdpNWTjDF0y56iMggsdBM_j9nH4pbE8YgFg",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800357582.420874,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768821581",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803381581.604868,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769426383,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61586902376231",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800357582.420761,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "LRNuadcWAD_nJokuImU0LXvJ",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803381581.404045,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "LRNuaTIVfVkEK0ALCqTBXrbX",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803381551.714364,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_2.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821704911%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "15%3A5aJJDn3N950RaA%3A2%3A1768821699%3A-1%3A-1%3A%3AAcyULKKMWvRSHdia6ASG6JHmVdDYRIt6UMSLrv0jaQ",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800357702.405451,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768821701",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803381701.372198,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769426504,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61584544438252",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800357702.405334,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "phNuaVpJfP45vjR5_9Z3ww0u",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803381700.950217,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "phNuafrGqbN4eXv7NV-JPKnJ",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803381673.692538,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_3.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768822164105%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "12%3Ar5MWBSq2el_6cA%3A2%3A1768822161%3A-1%3A-1%3A%3AAcwVwvqQ6SZ4-1toGi9O2R8-9M-Hp0pkMGAQlGJhHg",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800358163.45879,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768822162",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803382162.846874,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "c_user",
 48 |     "value": "100003588756313",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1800358163.458665,
 52 |     "size": 21,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "None",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "wd",
 63 |     "value": "1920x945",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1769426963,
 67 |     "size": 10,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "Lax",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "QxVuaaOR9rdA5NlSfrHD1EfX",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803382162.597484,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "QxVuadPVWi05FhOfQNVLWqGr",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803382085.502047,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_4.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "name": "presence",
  4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768852924758%2C%22v%22%3A1%7D",
  5 |     "domain": ".facebook.com",
  6 |     "path": "/",
  7 |     "expires": -1,
  8 |     "size": 75,
  9 |     "httpOnly": false,
 10 |     "secure": true,
 11 |     "session": true,
 12 |     "priority": "Medium",
 13 |     "sameParty": false,
 14 |     "sourceScheme": "Secure"
 15 |   },
 16 |   {
 17 |     "name": "xs",
 18 |     "value": "22%3ALWafh4jINN69qw%3A2%3A1768852919%3A-1%3A-1%3A%3AAcx_l28-lOf1k4OIIYDNmw-No6DzjAvqpIsUYtw8ZA",
 19 |     "domain": ".facebook.com",
 20 |     "path": "/",
 21 |     "expires": 1800388921.700278,
 22 |     "size": 96,
 23 |     "httpOnly": true,
 24 |     "secure": true,
 25 |     "session": false,
 26 |     "sameSite": "None",
 27 |     "priority": "Medium",
 28 |     "sameParty": false,
 29 |     "sourceScheme": "Secure"
 30 |   },
 31 |   {
 32 |     "name": "oo",
 33 |     "value": "v1%7C3%3A1768852921",
 34 |     "domain": ".facebook.com",
 35 |     "path": "/",
 36 |     "expires": 1803412920.650126,
 37 |     "size": 21,
 38 |     "httpOnly": true,
 39 |     "secure": true,
 40 |     "session": false,
 41 |     "sameSite": "None",
 42 |     "priority": "Medium",
 43 |     "sameParty": false,
 44 |     "sourceScheme": "Secure"
 45 |   },
 46 |   {
 47 |     "name": "wd",
 48 |     "value": "1920x945",
 49 |     "domain": ".facebook.com",
 50 |     "path": "/",
 51 |     "expires": 1769457724,
 52 |     "size": 10,
 53 |     "httpOnly": false,
 54 |     "secure": true,
 55 |     "session": false,
 56 |     "sameSite": "Lax",
 57 |     "priority": "Medium",
 58 |     "sameParty": false,
 59 |     "sourceScheme": "Secure"
 60 |   },
 61 |   {
 62 |     "name": "c_user",
 63 |     "value": "61584544438252",
 64 |     "domain": ".facebook.com",
 65 |     "path": "/",
 66 |     "expires": 1800388921.700174,
 67 |     "size": 20,
 68 |     "httpOnly": false,
 69 |     "secure": true,
 70 |     "session": false,
 71 |     "sameSite": "None",
 72 |     "priority": "Medium",
 73 |     "sameParty": false,
 74 |     "sourceScheme": "Secure"
 75 |   },
 76 |   {
 77 |     "name": "sb",
 78 |     "value": "o41uaWpt5tiPEsycxXtK4Cbs",
 79 |     "domain": ".facebook.com",
 80 |     "path": "/",
 81 |     "expires": 1803412920.412847,
 82 |     "size": 26,
 83 |     "httpOnly": true,
 84 |     "secure": true,
 85 |     "session": false,
 86 |     "sameSite": "None",
 87 |     "priority": "Medium",
 88 |     "sameParty": false,
 89 |     "sourceScheme": "Secure"
 90 |   },
 91 |   {
 92 |     "name": "datr",
 93 |     "value": "o41uaXMjjzfbjImZRgyLijUq",
 94 |     "domain": ".facebook.com",
 95 |     "path": "/",
 96 |     "expires": 1803412902.086271,
 97 |     "size": 28,
 98 |     "httpOnly": true,
 99 |     "secure": true,
100 |     "session": false,
101 |     "sameSite": "None",
102 |     "priority": "Medium",
103 |     "sameParty": false,
104 |     "sourceScheme": "Secure"
105 |   }
106 | ]
```

---

### üìÑ ≈öcie≈ºka: `data/comments-cache.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | {
  2 |   "test": {
  3 |     "lastCount": 5,
  4 |     "knownIds": [
  5 |       "a",
  6 |       "b",
  7 |       "c"
  8 |     ]
  9 |   },
 10 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R": {
 11 |     "lastCount": 10,
 12 |     "knownIds": [
 13 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjI5OTI2MTgzMDU0NzUxNw==",
 14 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTk2MTEyNzAwNzgyMDg3MA==",
 15 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIwMjkwODkxMTM4NjA0OQ==",
 16 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTg5OTY1NjQ1MDc1NzE5Ng==",
 17 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTM5MDY4MjkwMjc4MTI0Nw==",
 18 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjY1ODQzNjM2NDU0MzExMg==",
 19 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIxOTMyNjE4NjE5NzY0OQ==",
 20 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfNzA1OTk0MTA1OTI1MDMz",
 21 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfODk1NzE3NDY2MzIyMTMx",
 22 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTYxMzAxNzY0NjUzMzExNQ=="
 23 |     ]
 24 |   },
 25 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R": {
 26 |     "lastCount": 10,
 27 |     "knownIds": [
 28 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0MTI4NTk3NTA0OTc4MjM=",
 29 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzc0NjA4Njc1ODU1MjMxNQ==",
 30 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDczODQ2NTI5NzU0Mw==",
 31 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEzODI2NjExNTM1OTc5OTE=",
 32 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0Mjg4OTg4Mjg5NjgyNjE=",
 33 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDI4MzMwODQxNzU0OA==",
 34 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg5NDAyMDg3NjQ3MDI3Nw==",
 35 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEyNDczMDE4MzM4ODMyMDQ=",
 36 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQyMDk4MTIyMzkyMzI0NzY=",
 37 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQxMDc0Mjk0NTI3MzU2Njg="
 38 |     ]
 39 |   },
 40 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R": {
 41 |     "lastCount": 10,
 42 |     "knownIds": [
 43 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NTM5MjgxMjU4Mzk3Mjg=",
 44 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzg2MzE3NDIyOTY2MDQ2NQ==",
 45 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0OTA0NTAzMzk0NjA1NDk=",
 46 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MDY4MTE3OTEyMzI5NTQ=",
 47 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE5NDU4MDYyMjYzMTMxMTk=",
 48 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzc1MzMyOTk5NzI0MzE4MA==",
 49 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzExODM2NzcyNjAxNDA5ODI=",
 50 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzgyMzI2MTI1MDY5NTAzNA==",
 51 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MjU3MjI3NzI1MTQzMTk=",
 52 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NjMxOTcwNjQ3MjMwMDU="
 53 |     ]
 54 |   },
 55 |   "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R": {
 56 |     "lastCount": 4,
 57 |     "knownIds": [
 58 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfOTE2MjYzNjI4MDE4ODI2",
 59 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTQwNTc1MzE2MTI1NTAwNg==",
 60 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMzY4MDUyNTM3MjA3ODY5OQ==",
 61 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTYyNDA2MjUzNTYyMjI2Mg=="
 62 |     ]
 63 |   },
 64 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R": {
 65 |     "lastCount": 10,
 66 |     "knownIds": [
 67 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODk3NjcyMTg2Mjg2MzY5",
 68 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNDM1NTcyMDk1ODAzNjk1Mg==",
 69 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTA4MDAwMjI3NzU4NTE2MQ==",
 70 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTk2NTI0MzkwMTA4NDYxOA==",
 71 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNzA3MDcxMjcyMjMwOTYx",
 72 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI3OTQ4OTgyNDIxNzQwMQ==",
 73 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI2NTE4NTYwODc3Mzg4MQ==",
 74 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTQwNzc0MTg2NDExNzM2NA==",
 75 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODI0MzQ2NjcwMzk5NTg2",
 76 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTM1OTI5NDg4NTk0OTgwNg=="
 77 |     ]
 78 |   },
 79 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0318uW2Wb8gH4No2tudirSDVbDij3MCM1VM4nZ38mb3Kw9d8SDF8A8TyruVv5QLrTZl&id=61578702383044&__cft__[0]=AZZwCrt1G5eyASBVhdpuf3DZgoV_-CNIVqBzw1O4tN4UccEme5c6PCwt95Pjdcru2GOJ_QGzfYHeCwiZDvRdu5ZDS5zqeNlIs6DOvcIO9dWuWUhH1EyHO4LoMrF_sNYg_MD67DxNEzI60tDW7tXUTUVQx011P1sGO3cBu0EUOvcgTw&__tn__=%2CO%2CP-R": {
 80 |     "lastCount": 4,
 81 |     "knownIds": [
 82 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjMyNzE4MzE4NzcyMzY5NA==",
 83 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfODY5MjM1NjU1ODkyMTE1",
 84 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMTYwOTQ1Mjc3MzU2NDk1NA==",
 85 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjU5NTQ2MTQ4Njc1MjU5NTQ="
 86 |     ]
 87 |   },
 88 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R": {
 89 |     "lastCount": 10,
 90 |     "knownIds": [
 91 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfOTM3ODA2OTYxOTU3MTgz",
 92 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODk2MjY0MTA2NDc2MzY2",
 93 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODQ4MzM0MTI0ODQ5MzIz",
 94 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjQ5NTY5Mzg3MDg0NjExOQ==",
 95 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTkzMTA1ODYzNzU5OTY4MQ==",
 96 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU3NzI4NjUzNzg5OTk2NDI=",
 97 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTA5NzM4OTAwMjQ2ODM1Ng==",
 98 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU2NTAwMDc1MzQ2NjUzMDk=",
 99 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTMxMDU0OTUwNDE3MTQyOQ==",
100 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTEzNDgxNDg1NTIyNDUwNg=="
101 |     ]
102 |   },
103 |   "https://www.facebook.com/AtelierGaragee/posts/pfbid02ATAxGye5dbcaG8bzAD8EQEyri7aFgm9XUsE1t342j4HSCkQcD1YT7F51WYMpfyN8l?__cft__[0]=AZaBEG6ksRywUu51yRCMwmNgFY1VReoKiSP1kUwfY6mLCTmDV38xiPUIOEXLvFrOuTxnrAihkxHoIISVh7TG6Sk5MrH9R_MPM4m55j_FtuMP6EIJQNZW28aSELdSa8vTZH8cIM1gr0GoAvuJ5jLiTjB2mXfIkn6n06IHHpR4RQ0vKQ&__tn__=%2CO%2CP-R": {
104 |     "lastCount": 7,
105 |     "knownIds": [
106 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMjEzNjU5NDY2Mzc3MTQxMw==",
107 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDIzODgyODc0MzAzMDU1NQ==",
108 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTQxOTY3OTkzNjE3NDUxNg==",
109 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNzI5ODE3NTg2NTU1NzA2",
110 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfODY4NTU1OTA1OTExNzAy",
111 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTkzMDU4NjIzNDE1ODk0OQ==",
112 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDE3MTI3NzM5MzEzMjA5Ng=="
113 |     ]
114 |   },
115 |   "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R": {
116 |     "lastCount": 5,
117 |     "knownIds": [
118 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfODgzNzMxMzY3MzczNzkw",
119 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMjU0MDU5Nzk3NTI0MTkwODA=",
120 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfNzY3MTI1NDY5MDY2NTYy",
121 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTY0OTYyODk4OTgxODA3OA==",
122 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTIzNTA4MDQwMTg1ODQ1OA=="
123 |     ]
124 |   },
125 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R": {
126 |     "lastCount": 9,
127 |     "knownIds": [
128 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTE3ODcwODMxNDQyODkxOQ==",
129 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODc4Mzc3NzgxNzkwNTcz",
130 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTk1Njg5ODk4MTkxMzI5NA==",
131 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTU2ODIyNzI2NDQ5ODkxNQ==",
132 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMjU2NTg0ODY4NzE0OTcyNw==",
133 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODcxNDA2NjYyNTM1NjE5",
134 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODM4NDYxNjYyNTIwODkw",
135 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMzA2Njk2NzUzNjg0NDc3NA==",
136 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTIxNDM0MTQxMzk2OTE4Mw=="
137 |     ]
138 |   },
139 |   "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R": {
140 |     "lastCount": 0,
141 |     "knownIds": []
142 |   },
143 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid035w4oCt6cS3n6zCdxYeYVhu5MrLm6gJo2MKPPtVK1R7APfTpPVkzyHnvfu9NkmFypl&id=100064116006584&__cft__[0]=AZZCqTstO-EyvwQuGR3_itqZZ0EVlzOHdSUCmBUvadLGqfz1-MvpYyJYlRhSiV4CynwiO_uaRpQvKHRhvksK3_ImJjibd6qWne7eOgOYHmrdmGx2u8SHjUsVoP7CM42LZ-9X3Hr-P5rtAtX7QFrXXK9ImMiiySJFt9BCw-Gfdw3p7Q&__tn__=%2CO%2CP-R": {
144 |     "lastCount": 0,
145 |     "knownIds": []
146 |   },
147 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R": {
148 |     "lastCount": 10,
149 |     "knownIds": [
150 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzczMDAwMjU1MzQ5NzAwOQ==",
151 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE0MzE2MDA4MDE4OTIzODM=",
152 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg1NDAzMTU2MzkwMzE0OA==",
153 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzIzMDI3NzY3NjY4ODMxNTI=",
154 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTY3NzkyNTUzNTk3NjM=",
155 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTc1ODg4OTU2NDA1MjA=",
156 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg3NTIzMTg3NTA4OTgyMQ==",
157 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE1MjU2NDUwNjU4MTQwNzA=",
158 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzEzOTAzMjg1OTU5MTIzOTg=",
159 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE5MzI1ODM1MTEwMjI5MzE="
160 |     ]
161 |   },
162 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02haCDE2RQqyVm3F9U2L7EXaAYoG4RMur5QoH814aVLbwhedNQJmNzxzpXNovZAeCil&id=100079527351401&__cft__[0]=AZZ4KqKhcAuigo35JEfdAJdl-sieDCm5aMX0PjuHk9MRO70fMmx66wJ43grMxUBvlsyMszWGovTDK-g5CigEof4_bJv5sgo0GKxq6CxWtc14BF6hi4xRwTNM1E-fw5rHkQ7KHKEYD6D8I4aKRS55tDd2EX1CtC6sJyT4va_X2uhnjw&__tn__=%2CO%2CP-R": {
163 |     "lastCount": 10,
164 |     "knownIds": [
165 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjUwMzE2MTA2Njc0NDcyOQ==",
166 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTA1MDI0Njg3NzI4NTg5OA==",
167 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODIxNTgzMDI0MjU5MjM2",
168 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYwNDAyMjc4ODIyODAxNTI=",
169 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTg1MzA2ODY4NTMzMDk4Mw==",
170 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYxMTMzODY3NTE1OTEwOTU=",
171 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODc4MDY0MDU0OTQ1Nzg5",
172 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMzE4NzA3NTg4ODEzMjk2Mw==",
173 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODgzMTMzNjc3NTA0Njk5",
174 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfNjM4NTU4MjU5MzE0MDk4"
175 |     ]
176 |   },
177 |   "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R": {
178 |     "lastCount": 2,
179 |     "knownIds": [
180 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfODQ3Mjg0NTYxNDU5MzA1",
181 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfMTU2MDAyNjY1ODY1NzI0OQ=="
182 |     ]
183 |   },
184 |   "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R": {
185 |     "lastCount": 2,
186 |     "knownIds": [
187 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfNDM4NjgwMjEwODMwODM1NA==",
188 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfOTEzMjIwMzU0NzI5MjAx"
189 |     ]
190 |   },
191 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R": {
192 |     "lastCount": 10,
193 |     "knownIds": [
194 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1Mzg2MzIwMjU3NzE5NjA4",
195 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzE2NjE0NjUyMTgyMDI2MzU=",
196 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg2NTk4NTAxMjk4NjUyNA==",
197 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkxMDg1MDc0ODEwNzYzMg==",
198 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkwNDM4NjQzMjE2MDQ4OQ==",
199 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI0NjI3Nzk3NDA4NDQ2MTU=",
200 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzExODIwMjI3NDc0NTIyNzY=",
201 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1NjcyNTI5NDU5MDc0Nzc2",
202 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI5Mjc5MzAwMDczOTU3MjI=",
203 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg1NDAyOTY5MDc3NDkwMA=="
204 |     ]
205 |   },
206 |   "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R": {
207 |     "lastCount": 10,
208 |     "knownIds": [
209 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzEzNjk2NDAyMzc3MTAzMjY=",
210 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MzI3MTM2NzQ2MjkyMjY=",
211 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzIwMDM4MTM0OTAxNjU0NzY=",
212 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1ODAxNzQ0OTYzNTUzNTc=",
213 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzg4NzY4NjAzNzAwODIyOA==",
214 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE4MTgwNjk5OTIyMDI5OTE=",
215 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzcyNzEwMjU5Mzc3Njk0NA==",
216 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzY0ODg1MjQxMTY0Njk5NQ==",
217 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MTA5NzMwMTAxMDg4Mzk=",
218 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzgzMzM2NDU3NjI4MjQ0MQ=="
219 |     ]
220 |   },
221 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R": {
222 |     "lastCount": 10,
223 |     "knownIds": [
224 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMzg4MTg2ODc1ODc3MzExNQ==",
225 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjM3NzQyNzI4NjA0MjE0NQ==",
226 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTgxOTIwMjk4NTQyODAwMw==",
227 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTIwNzMwMzEwNzU2NDU3NA==",
228 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfOTM3ODM3NTI4ODI0ODUw",
229 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTM2MDk5NzQ5OTEwMzM3NQ==",
230 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjQ0OTIzMTQ1MjE0MTU1NA==",
231 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODIyMjQ0NjgwNDc4NDk4",
232 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfNDIxMjE3MzAxOTA5OTcyMQ==",
233 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODI1MzgyNDEzMTYxOTYz"
234 |     ]
235 |   },
236 |   "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R": {
237 |     "lastCount": 10,
238 |     "knownIds": [
239 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzk2NDgzNzYxNjcwODQ1Nw==",
240 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE0MTE4NDE1MTA1ODY4Nzk=",
241 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzg3MjE3MDExNTY4MDIyNg==",
242 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzUxMjU3NDcyNTA5ODQ0MzA=",
243 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE1Njg3MDUyODc3NjY4MTQ=",
244 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NzY3MjA4NTk2MDY2Mzg=",
245 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE3OTA3NjgxMjE2MjQyOTE=",
246 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzkxMTAxNjg4NDYxNDc5Mw==",
247 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NDMxNTY5MTY2MDE3Nzc=",
248 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzIyODI0Njk5NzIyMzI3MjE="
249 |     ]
250 |   },
251 |   "https://www.facebook.com/robstal.garaze.blaszane/posts/pfbid02aFFtjSkLZXQWiEowiS52Lx2Zht7M9Te5f4xosriFySu9BuP1WKFfV39MhKbyhJR9l?__cft__[0]=AZZTxMcsG7gI2gK2OOuyPJBa-_ZVrPQ0uZc0Idu_beS_85zVc7_fFP7OtcVuHUiEeboigKm2al5IpzDUlqiHmZcUoivzhkJnh-BH1WQnoDlIjfJ6sY-wVYcFBcsDyg5jl_4Fxm8yCGC8LhH_Qr0loqh2E5AlspC1TJZ6CkBU-pG6Iw&__tn__=%2CO%2CP-R": {
252 |     "lastCount": 6,
253 |     "knownIds": [
254 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzI1NDk5NTIyMjE2MzIzNzMy",
255 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE3NDE0NTIwNjAxNDQ2NDA=",
256 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE0NjQ4MjgwMzUyNjg5NDE=",
257 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzgyMTY3MDczNDIwMzM2Mg==",
258 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE1NjE1NDQyNDQ5Mjk2NjM=",
259 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzEzNjM4MDY5MjE0Mzc1NjE="
260 |     ]
261 |   },
262 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R": {
263 |     "lastCount": 8,
264 |     "knownIds": [
265 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTg5NTQ0Mjc0MTA2NzkzOA==",
266 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjUzMTM3NjcyNDE2MjkxNjA=",
267 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfODU2NDcxNDAzODM5NTA5",
268 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTk0NDYwMTI0MzE0OTEzOA==",
269 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTU0ODg1OTk0NjM2NDYzMw==",
270 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTM1OTYyODIyODgyMDI1MA==",
271 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTQ0MTY1NTkyNzU1NTI1Ng==",
272 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjQ1Njk3OTU5ODA5MjI5Nw=="
273 |     ]
274 |   },
275 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R": {
276 |     "lastCount": 10,
277 |     "knownIds": [
278 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTM3NjMzMjEwMzc0MzI4Mg==",
279 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTc4Mzg4MjE2ODk2NzA3Mg==",
280 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTU1NDIzNTU0OTAwMzM4OQ==",
281 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjExODcwMjk1ODY2NDk3MA==",
282 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTI3NzEzMTQ2MTAyMDM5OA==",
283 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjUyODYxNTQyMzQzMzkzOTQ=",
284 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODU0ODg2Mzk3NDM1Njk0",
285 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTQzODM3ODYxNDUyMzA2Mg==",
286 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODcwMTMxNjY5MDg0NTUw",
287 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMzUyNzkxNDE3NzM3MTA1Ng=="
288 |     ]
289 |   },
290 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R": {
291 |     "lastCount": 10,
292 |     "knownIds": [
293 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTYzMjEwMjg3NzkyNTA1Ng==",
294 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTg0NjA1NDE3OTM2NDc1MA==",
295 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODYxMTk2NDAzMzcyMDA3",
296 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODQwMTIxMjU4ODU0MDM3",
297 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMjM0NTE2MjM3OTI5Mjk5NQ==",
298 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU2MTUzMTI3ODM4MjA3Nw==",
299 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfOTA3NDY3NzU1MDc0MTQ2",
300 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY0NzE2MzYwNjI0NjE0MQ==",
301 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU5MjE5NTg2NTQ2NDUzNg==",
302 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY1Njk1NjI5ODYwOTEzMA=="
303 |     ]
304 |   },
305 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R": {
306 |     "lastCount": 4,
307 |     "knownIds": [
308 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjIzMTI2MDAxMDYxMjkyMQ==",
309 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjQ4NzcxNjk1NTAxOTYzNQ==",
310 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTYwNjA4OTk3Mzk4MjE2Nw==",
311 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTE2NDg1MjIwMjUwNTgyMA=="
312 |     ]
313 |   },
314 |   "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R": {
315 |     "lastCount": 2,
316 |     "knownIds": [
317 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODg1NzkwMzI0MTk3NTI0",
318 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODc0NDkwNDI4NjcyNDgz"
319 |     ]
320 |   },
321 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R": {
322 |     "lastCount": 10,
323 |     "knownIds": [
324 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTYwODEzNDExMDUzMDY2Nw==",
325 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODg0OTEyMjk3OTc0NA==",
326 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfODc3OTA1NjU0ODgxNTk3",
327 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTE0NjQyMDYwOTExMzMz",
328 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTk0ODU3ODk4MjY4MDM1Ng==",
329 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTIxMjU4MDUzNTc4Njc0",
330 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjA4MzQzOTAwMjQwNzI2MQ==",
331 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfNDI1NjIzOTI5NDY2NDYzNw==",
332 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjMzMzU5OTUyNzExNDk5OA==",
333 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODQ2MTcyMzEyMzkxOA=="
334 |     ]
335 |   },
336 |   "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R": {
337 |     "lastCount": 10,
338 |     "knownIds": [
339 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTYxOTcyMzkxMjUzNjQyMA==",
340 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTkxNjUxNTY5OTc0NzE2NA==",
341 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMjU3MDQyMjY4NTkyMDg1MzQ=",
342 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQ5NjYwNTE0MTQwMjQyOQ==",
343 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQzNDU2OTA2NDc1MjYyMg==",
344 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTU3NjUwODE2MzUwMjUxNg==",
345 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM4MDgzNDU2Mzc4OTI3Nw==",
346 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM5MTcxNTQ0MjQ2NTIwNQ==",
347 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfODY0ODIyNjU2NDEwMDUz",
348 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM3MjM5MjIzMTM1MjUyNg=="
349 |     ]
350 |   },
351 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R": {
352 |     "lastCount": 10,
353 |     "knownIds": [
354 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTE5MTg1MzA0OTgwNTgzOQ==",
355 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfOTA0NDI0NjQ4Nzg2MzU2",
356 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkwNDM1MTkwMzgwMTc5Ng==",
357 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkyMDUyMTMwMjAwODYyNw==",
358 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfODY0NDI3OTczMDA1Njkz",
359 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfNzcxMTI5Mjc4NjAxMTQw",
360 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTExNjg1NTg2NzA4NjM3Nw==",
361 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTUzNTA0MTM5MTE2NzAzMA==",
362 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTg0NTI2MjE1Mjc2NTk1Mg==",
363 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTU5MjIxNjQ2NTI0MTQ1OA=="
364 |     ]
365 |   },
366 |   "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R": {
367 |     "lastCount": 10,
368 |     "knownIds": [
369 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzg2MzU5NjM0Mjk2MTAwNA==",
370 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0ODE1OTI1MzM1NjE5MTQ=",
371 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzQxMjA4ODA3MDE1MTIxODA=",
372 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzExMjk4MjU4MzI0Mzc3NTU=",
373 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIzNjYzNzYzMTcxMzQ2MDg=",
374 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIxOTEzNjEyMjc5NDAzNzk=",
375 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIwNzI3NDQzMzM1MTU3NjU=",
376 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzM4Mjg1NTU0NzQxMTI0NDQ=",
377 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE3MDI1NzY5MTczODIyMTY=",
378 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0NDUwNTQ3MTA1MjA2MDA="
379 |     ]
380 |   },
381 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02WfKaSL6M75BrEuCFRhtbwaGifhdusk9fv1C6z7Uy2qjtgxnegr9eUSJ5DidUSTTBl&id=100083286129696&__cft__[0]=AZZWKYTrBrADgzl3D3vEiZ2tkuDzBlEy155fy0Pj_wYpv8qMioPu5zZ-DvHIiydZXWjg4kuZP08TLxcprCd_rL6InDXOEqNMpLWVreiSsfMojqV5ZfOigeJksjxDIjo0CT7lw0xOVDiT5_addtlk6SXi&__tn__=%2CO%2CP-R": {
382 |     "lastCount": 10,
383 |     "knownIds": [
384 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE5ODIyMTY4MjUxODgxNA==",
385 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTU2Mjc2NDgwODMyNTg2NA==",
386 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMjQwMTAwNzI0ODIwMjQxMDI=",
387 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM0MjcyNjQyNDI5MjExOQ==",
388 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM5MzQyNDc0NTU4NjE4Ng==",
389 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE2MzE2MjUwOTEzOTA5NQ==",
390 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTUyNjMyNDIyNTMyNTE0Mg==",
391 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTQ5ODQzNzU5MTI1MzM1MQ==",
392 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTczNTEyMTk5NDUyMTEyNg==",
393 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfNzQ1Njk2NDMxNDMzMjgx"
394 |     ]
395 |   },
396 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R": {
397 |     "lastCount": 10,
398 |     "knownIds": [
399 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk1NDE5MDM5MDQwMzg=",
400 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExOTcyNDc0NjU5MDYyODA=",
401 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzI2NTEwNDMzMzI4NTQwNzYx",
402 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzcyOTcxODI2MDIwNzg3OA==",
403 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzczMjI4MTA3Mjg5NzY1NA==",
404 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExNDQ2MTM5ODc1NjgwNTU=",
405 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzgwOTIwMzM4NTQ3MzgxMQ==",
406 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzIxNDE1MTY0Nzk5NDg3MzM=",
407 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk0OTA3NjcyNTU4NjQ=",
408 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzMwMzQyODMxMDAyOTMyMTU="
409 |     ]
410 |   }
411 | }
```

---

### üìÑ ≈öcie≈ºka: `data/posts.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
  1 | [
  2 |   {
  3 |     "id": "20d407e350f43063",
  4 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R",
  5 |     "active": true,
  6 |     "name": "A1",
  7 |     "image": "",
  8 |     "description": "",
  9 |     "createdAt": "2026-01-13T12:01:58.668Z",
 10 |     "updatedAt": "2026-01-13T12:01:58.668Z"
 11 |   },
 12 |   {
 13 |     "id": "f689bed37d549bed",
 14 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R",
 15 |     "active": true,
 16 |     "name": "A1",
 17 |     "image": "",
 18 |     "description": "",
 19 |     "createdAt": "2026-01-13T12:02:19.900Z",
 20 |     "updatedAt": "2026-01-13T12:02:19.900Z"
 21 |   },
 22 |   {
 23 |     "id": "71bb210aa5589b65",
 24 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R",
 25 |     "active": true,
 26 |     "name": "A1",
 27 |     "image": "",
 28 |     "description": "",
 29 |     "createdAt": "2026-01-13T12:02:38.054Z",
 30 |     "updatedAt": "2026-01-13T12:02:38.054Z"
 31 |   },
 32 |   {
 33 |     "id": "993164c73c6c2f3a",
 34 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R",
 35 |     "active": true,
 36 |     "name": "A1",
 37 |     "image": "",
 38 |     "description": "",
 39 |     "createdAt": "2026-01-13T12:02:47.316Z",
 40 |     "updatedAt": "2026-01-13T12:02:47.316Z"
 41 |   },
 42 |   {
 43 |     "id": "2313d315e854c69d",
 44 |     "url": "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R",
 45 |     "active": true,
 46 |     "name": "A1",
 47 |     "image": "",
 48 |     "description": "",
 49 |     "createdAt": "2026-01-13T12:02:56.964Z",
 50 |     "updatedAt": "2026-01-13T12:02:56.964Z"
 51 |   },
 52 |   {
 53 |     "id": "6b805b9f4cbaeaea",
 54 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R",
 55 |     "active": true,
 56 |     "name": "A1",
 57 |     "image": "",
 58 |     "description": "",
 59 |     "createdAt": "2026-01-13T12:03:12.748Z",
 60 |     "updatedAt": "2026-01-13T12:03:12.748Z"
 61 |   },
 62 |   {
 63 |     "id": "98187316e5c997d2",
 64 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R",
 65 |     "active": true,
 66 |     "name": "A1",
 67 |     "image": "",
 68 |     "description": "",
 69 |     "createdAt": "2026-01-13T12:03:23.490Z",
 70 |     "updatedAt": "2026-01-13T12:03:23.490Z"
 71 |   },
 72 |   {
 73 |     "id": "eaf757d67c85db01",
 74 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R",
 75 |     "active": true,
 76 |     "name": "A1",
 77 |     "image": "",
 78 |     "description": "",
 79 |     "createdAt": "2026-01-13T12:03:40.087Z",
 80 |     "updatedAt": "2026-01-13T12:03:40.087Z"
 81 |   },
 82 |   {
 83 |     "id": "5da859b41dc6453b",
 84 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R",
 85 |     "active": true,
 86 |     "name": "A1",
 87 |     "image": "",
 88 |     "description": "",
 89 |     "createdAt": "2026-01-13T12:03:48.543Z",
 90 |     "updatedAt": "2026-01-13T12:03:48.543Z"
 91 |   },
 92 |   {
 93 |     "id": "74d177191382a1f2",
 94 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R",
 95 |     "active": true,
 96 |     "name": "A1",
 97 |     "image": "",
 98 |     "description": "",
 99 |     "createdAt": "2026-01-13T12:04:09.163Z",
100 |     "updatedAt": "2026-01-13T12:04:09.163Z"
101 |   },
102 |   {
103 |     "id": "43712b5c70dd5b63",
104 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R",
105 |     "active": true,
106 |     "name": "A1",
107 |     "image": "",
108 |     "description": "",
109 |     "createdAt": "2026-01-13T12:04:18.203Z",
110 |     "updatedAt": "2026-01-13T12:04:18.203Z"
111 |   },
112 |   {
113 |     "id": "1bb8d3d9d5817ba7",
114 |     "url": "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R",
115 |     "active": true,
116 |     "name": "A1",
117 |     "image": "",
118 |     "description": "",
119 |     "createdAt": "2026-01-13T12:04:27.086Z",
120 |     "updatedAt": "2026-01-13T12:04:27.086Z"
121 |   },
122 |   {
123 |     "id": "6ef3c021b443c50a",
124 |     "url": "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R",
125 |     "active": true,
126 |     "name": "A4",
127 |     "image": "",
128 |     "description": "",
129 |     "createdAt": "2026-01-13T12:04:38.682Z",
130 |     "updatedAt": "2026-01-13T12:04:38.682Z"
131 |   },
132 |   {
133 |     "id": "8116e13c116116c8",
134 |     "url": "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R",
135 |     "active": true,
136 |     "name": "A4",
137 |     "image": "",
138 |     "description": "",
139 |     "createdAt": "2026-01-13T12:04:46.680Z",
140 |     "updatedAt": "2026-01-13T12:04:46.680Z"
141 |   },
142 |   {
143 |     "id": "3b6cfa43309ffe8d",
144 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R",
145 |     "active": true,
146 |     "name": "A4",
147 |     "image": "",
148 |     "description": "",
149 |     "createdAt": "2026-01-13T12:04:54.365Z",
150 |     "updatedAt": "2026-01-13T12:04:54.365Z"
151 |   },
152 |   {
153 |     "id": "0c50963c372aabab",
154 |     "url": "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R",
155 |     "active": true,
156 |     "name": "A4",
157 |     "image": "",
158 |     "description": "",
159 |     "createdAt": "2026-01-13T12:05:02.328Z",
160 |     "updatedAt": "2026-01-13T12:05:02.328Z"
161 |   },
162 |   {
163 |     "id": "4fe4b13eaed47ede",
164 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R",
165 |     "active": true,
166 |     "name": "A4",
167 |     "image": "",
168 |     "description": "",
169 |     "createdAt": "2026-01-13T12:05:10.668Z",
170 |     "updatedAt": "2026-01-13T12:05:10.668Z"
171 |   },
172 |   {
173 |     "id": "b46ca54914eebf06",
174 |     "url": "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R",
175 |     "active": true,
176 |     "name": "A4",
177 |     "image": "",
178 |     "description": "",
179 |     "createdAt": "2026-01-13T12:05:18.631Z",
180 |     "updatedAt": "2026-01-13T12:05:18.631Z"
181 |   },
182 |   {
183 |     "id": "d2ca2a803d8fc150",
184 |     "url": "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R",
185 |     "active": true,
186 |     "name": "A4",
187 |     "image": "",
188 |     "description": "",
189 |     "createdAt": "2026-01-13T12:05:28.201Z",
190 |     "updatedAt": "2026-01-13T12:05:28.201Z"
191 |   },
192 |   {
193 |     "id": "b5304298e34e0a96",
194 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R",
195 |     "active": true,
196 |     "name": "A6",
197 |     "image": "",
198 |     "description": "",
199 |     "createdAt": "2026-01-13T12:05:36.647Z",
200 |     "updatedAt": "2026-01-13T12:05:44.651Z"
201 |   },
202 |   {
203 |     "id": "c96523ed0496d6a6",
204 |     "url": "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R",
205 |     "active": true,
206 |     "name": "A6",
207 |     "image": "",
208 |     "description": "",
209 |     "createdAt": "2026-01-13T12:05:57.251Z",
210 |     "updatedAt": "2026-01-13T12:05:57.251Z"
211 |   },
212 |   {
213 |     "id": "bf549948402a600d",
214 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R",
215 |     "active": true,
216 |     "name": "A6",
217 |     "image": "",
218 |     "description": "",
219 |     "createdAt": "2026-01-13T12:06:00.841Z",
220 |     "updatedAt": "2026-01-13T12:06:00.841Z"
221 |   },
222 |   {
223 |     "id": "e60b5d49e8733062",
224 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R",
225 |     "active": true,
226 |     "name": "A6",
227 |     "image": "",
228 |     "description": "",
229 |     "createdAt": "2026-01-13T12:06:12.701Z",
230 |     "updatedAt": "2026-01-13T12:06:12.701Z"
231 |   },
232 |   {
233 |     "id": "f8cccfff57b15d13",
234 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R",
235 |     "active": true,
236 |     "name": "B5",
237 |     "image": "",
238 |     "description": "",
239 |     "createdAt": "2026-01-13T12:06:21.505Z",
240 |     "updatedAt": "2026-01-13T12:06:21.505Z"
241 |   },
242 |   {
243 |     "id": "2ba4e8d680acf0fc",
244 |     "url": "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R",
245 |     "active": true,
246 |     "name": "B5",
247 |     "image": "",
248 |     "description": "",
249 |     "createdAt": "2026-01-13T12:06:31.521Z",
250 |     "updatedAt": "2026-01-13T12:06:31.521Z"
251 |   },
252 |   {
253 |     "id": "03d290a9d31ca2b5",
254 |     "url": "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R",
255 |     "active": true,
256 |     "name": "B5",
257 |     "image": "",
258 |     "description": "",
259 |     "createdAt": "2026-01-13T12:06:41.365Z",
260 |     "updatedAt": "2026-01-13T12:06:41.365Z"
261 |   }
262 | ]
263 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/.env`
**Typ:** ENV  
**Opis:** Plik projektu (kod/konfiguracja).  

```dotenv
 1 | FB_EMAIL=Test@Test.pl
 2 | FB_PASSWORD=test
 3 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
 4 | CHECK_INTERVAL_MS=60000
 5 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
 6 | COOKIES_READ_ONLY=false
 7 | HEADLESS_BROWSER=true
 8 | USE_UI_HANDLERS=false
 9 | INCLUDE_REPLIES=true
10 | 
11 | PROJECT_DIR="C:/Projekty vs/FB_Watcher"
12 | PANEL_TOKEN=TEST_TOKEN_123
13 | PANEL_PORT=3180
14 | PM2_APP=fbwatcher
15 | 
16 | PM2_LOG_OUT=C:\Users\zorro\.pm2\logs\fbwatcher-out.log
17 | PM2_LOG_ERR=C:\Users\zorro\.pm2\logs\fbwatcher-error.log
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/package.json`
**Typ:** JSON  
**Opis:** Metadane projektu i zale≈ºno≈õci (npm).  

```json
 1 | {
 2 |   "name": "fb_puppeteer",
 3 |   "version": "1.0.0",
 4 |   "description": "Watcher komentarzy FB + webhook do Make",
 5 |   "main": "src/index.js",
 6 |   "type": "module",
 7 |   "scripts": {
 8 |     "start": "node src/index.js",
 9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs"
11 |   },
12 |   "keywords": [],
13 |   "author": "",
14 |   "license": "ISC",
15 |   "dependencies": {
16 |     "axios": "^1.13.2",
17 |     "dotenv": "^17.2.3",
18 |     "puppeteer": "^24.31.0"
19 |   },
20 |   "devDependencies": {
21 |     "@yao-pkg/pkg": "^6.11.0",
22 |     "esbuild": "^0.27.2",
23 |     "nexe": "^5.0.0-beta.4",
24 |     "pkg": "^5.8.1"
25 |   },
26 |   "pkg": {
27 |     "assets": [
28 |       "src/panel/api.js",
29 |       "src/panel/**/*.js",
30 |       ".env",
31 |       "data/**/*"
32 |     ]
33 |   }
34 | }
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/index.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | // index.js
 2 | import { startWatcher } from "./watcher.js";
 3 | 
 4 | console.log("[CFG] HEADLESS_BROWSER (process.env) =", process.env.HEADLESS_BROWSER);
 5 | 
 6 | startWatcher().catch((err) => {
 7 |   console.error("Fatal error:", err);
 8 |   process.exit(1);
 9 | });
10 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/watcher.js`
**Typ:** JavaScript/tekst  
**Opis:** G≈Ç√≥wna pƒôtla watchera: cykle, cache, webhook/telegram.  

```js
  1 | // src/watcher.js
  2 | import puppeteer from "puppeteer";
  3 | import fs from "fs";
  4 | import path from "path";
  5 | import {
  6 |   EXPAND_COMMENTS,
  7 |   CHECK_INTERVAL_MS,
  8 |   POSTS_SHEET_URL,
  9 |   POSTS_REFRESH_MS,
 10 | } from "./config.js";
 11 | 
 12 | import {
 13 |   prepare,
 14 |   getCommentCount,
 15 |   loadAllComments,
 16 |   extractCommentsData,
 17 | } from "./fb/comments.js";
 18 | 
 19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
 20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
 21 | import { sendWebhook } from "./webhook.js";
 22 | import { loadCache, saveCache } from "./db/cache.js";
 23 | 
 24 | /**
 25 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
 26 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
 27 |  *
 28 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
 29 |  * POSTS_FILE=C:\Projekty vs\FB_Watcher\data\posts.json
 30 |  */
 31 | const POSTS_FILE =
 32 |   process.env.POSTS_FILE ||
 33 |   path.join(process.cwd(), "data", "posts.json");
 34 | 
 35 | /**
 36 |  * CACHE DYSKOWY:
 37 |  * {
 38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
 39 |  * }
 40 |  */
 41 | const commentsCache = loadCache();
 42 | const lastCounts = new Map(); // url -> lastCount
 43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
 44 | 
 45 | for (const [url, entry] of Object.entries(commentsCache)) {
 46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
 47 |   if (Array.isArray(entry?.knownIds))
 48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
 49 | }
 50 | 
 51 | let currentPosts = [];
 52 | let lastRefreshAny = 0; // wsp√≥lny zegar od≈õwie≈ºania ≈∫r√≥de≈Ç
 53 | 
 54 | let navErrorCount = 0;
 55 | const MAX_NAV_ERRORS = 5;
 56 | 
 57 | function isNavigationError(err) {
 58 |   if (!err) return false;
 59 |   const msg = String(err.message || err).toLowerCase();
 60 |   return (
 61 |     msg.includes("safegoto-failed") ||
 62 |     msg.includes("navigation timeout") ||
 63 |     msg.includes("net::err_connection_timed_out") ||
 64 |     msg.includes("net::err_timed_out")
 65 |   );
 66 | }
 67 | 
 68 | /* ============================================================
 69 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
 70 |    ============================================================ */
 71 | 
 72 | async function applyStealth(page) {
 73 |   await page.evaluateOnNewDocument(() => {
 74 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
 75 |     // @ts-ignore
 76 |     window.chrome = window.chrome || { runtime: {} };
 77 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
 78 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
 79 | 
 80 |     const permissions = window.navigator.permissions;
 81 |     if (permissions && permissions.query) {
 82 |       const originalQuery = permissions.query.bind(permissions);
 83 |       permissions.query = (parameters) => {
 84 |         if (
 85 |           parameters &&
 86 |           parameters.name === "notifications" &&
 87 |           window.Notification
 88 |         ) {
 89 |           return Promise.resolve({ state: window.Notification.permission });
 90 |         }
 91 |         return originalQuery(parameters);
 92 |       };
 93 |     }
 94 |   });
 95 | }
 96 | 
 97 | /* ============================================================
 98 |    ===============   PANEL POSTS (data/posts.json)   ===========
 99 |    ============================================================ */
100 | 
101 | function safeJsonParse(s) {
102 |   try {
103 |     return { ok: true, value: JSON.parse(s) };
104 |   } catch (e) {
105 |     return { ok: false, error: e?.message || "Invalid JSON" };
106 |   }
107 | }
108 | 
109 | function normalizeUrl(u) {
110 |   if (!u) return "";
111 |   const x = String(u).trim();
112 |   if (!/^https?:\/\/.+/i.test(x)) return "";
113 |   return x;
114 | }
115 | 
116 | function readPanelPosts() {
117 |   try {
118 |     if (!fs.existsSync(POSTS_FILE)) {
119 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
120 |     }
121 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
122 |     if (!raw) {
123 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
124 |     }
125 |     const parsed = safeJsonParse(raw);
126 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
127 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
128 |     }
129 | 
130 |     const posts = parsed.value
131 |       .map((p) => {
132 |         const url = normalizeUrl(p?.url);
133 |         const active = Boolean(p?.active);
134 |         if (!url) return null;
135 |         return {
136 |           id: String(p?.id || url),
137 |           url,
138 |           active,
139 |           name: p?.name ? String(p.name) : "",
140 |           image: p?.image ? String(p.image) : "",
141 |           description: p?.description ? String(p.description) : "",
142 |         };
143 |       })
144 |       .filter(Boolean);
145 | 
146 |     const activePosts = posts.filter((p) => p.active);
147 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
148 |   } catch (e) {
149 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
150 |   }
151 | }
152 | 
153 | /* ============================================================
154 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
155 |    ============================================================ */
156 | 
157 | function parseSheetCsv(text) {
158 |   const lines = text
159 |     .split(/\r?\n/)
160 |     .map((l) => l.trim())
161 |     .filter((l) => l.length > 0);
162 | 
163 |   if (!lines.length) {
164 |     console.warn("[Sheet] Pusty CSV z arkusza.");
165 |     return [];
166 |   }
167 | 
168 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
169 | 
170 |   const idxUrl = header.findIndex((h) => h === "url");
171 |   const idxActive = header.findIndex((h) => h === "active");
172 | 
173 |   // nowe kolumny od klienta
174 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
175 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
176 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
177 | 
178 |   if (idxUrl === -1) {
179 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
180 |     return [];
181 |   }
182 | 
183 |   const posts = [];
184 | 
185 |   for (let i = 1; i < lines.length; i++) {
186 |     const row = lines[i].split(",");
187 |     const rawUrl = (row[idxUrl] || "").trim();
188 |     if (!rawUrl) continue;
189 | 
190 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
191 |     const activeNorm = activeRaw.toLowerCase();
192 |     const isActive =
193 |       idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
194 | 
195 |     if (!isActive) continue;
196 | 
197 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
198 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
199 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
200 | 
201 |     posts.push({
202 |       id: `sheet-${i}`,
203 |       url: rawUrl,
204 |       name,
205 |       image,
206 |       description,
207 |     });
208 |   }
209 | 
210 |   return posts;
211 | }
212 | 
213 | /* ============================================================
214 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
215 |    ============================================================ */
216 | 
217 | async function refreshPostsIfNeeded(force = false) {
218 |   const now = Date.now();
219 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
220 |   lastRefreshAny = now;
221 | 
222 |   // 1) PRIMARY: panel posts.json
223 |   const panel = readPanelPosts();
224 |   if (panel.ok && panel.posts.length > 0) {
225 |     const newPosts = panel.posts;
226 | 
227 |     const oldJson = JSON.stringify(currentPosts);
228 |     const newJson = JSON.stringify(newPosts);
229 | 
230 |     if (oldJson !== newJson) {
231 |       console.log(
232 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
233 |       );
234 |       currentPosts = newPosts;
235 |     } else {
236 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
237 |     }
238 |     return;
239 |   }
240 | 
241 |   console.log(
242 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
243 |   );
244 | 
245 |   // 2) FALLBACK: Sheets
246 |   if (!POSTS_SHEET_URL) {
247 |     console.warn(
248 |       "[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza."
249 |     );
250 |     currentPosts = [];
251 |     return;
252 |   }
253 | 
254 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
255 | 
256 |   try {
257 |     const res = await fetch(POSTS_SHEET_URL);
258 |     if (!res.ok) {
259 |       console.error(
260 |         "[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:",
261 |         res.status,
262 |         res.statusText
263 |       );
264 |       currentPosts = [];
265 |       return;
266 |     }
267 | 
268 |     const csvText = await res.text();
269 |     const newPosts = parseSheetCsv(csvText);
270 | 
271 |     if (!newPosts.length) {
272 |       console.warn(
273 |         "[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE)."
274 |       );
275 |       currentPosts = [];
276 |       return;
277 |     }
278 | 
279 |     const oldJson = JSON.stringify(currentPosts);
280 |     const newJson = JSON.stringify(newPosts);
281 | 
282 |     if (oldJson !== newJson) {
283 |       console.log(
284 |         `[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`
285 |       );
286 |       currentPosts = newPosts;
287 |     } else {
288 |       console.log("[Sheet] Lista post√≥w bez zmian.");
289 |     }
290 |   } catch (err) {
291 |     console.error(
292 |       "[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:",
293 |       err.message
294 |     );
295 |     currentPosts = [];
296 |   }
297 | }
298 | 
299 | /* ============================================================
300 |    =====================   CACHE HELPERS   =====================
301 |    ============================================================ */
302 | 
303 | function getCacheKey(post) {
304 |   return post.url;
305 | }
306 | 
307 | function getKnownSetForPost(cacheKey) {
308 |   let set = knownCommentsPerPost.get(cacheKey);
309 |   if (!set) {
310 |     const entry = commentsCache[cacheKey];
311 |     set =
312 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
313 |     knownCommentsPerPost.set(cacheKey, set);
314 |   }
315 |   return set;
316 | }
317 | 
318 | function flushCacheToDisk() {
319 |   const out = { ...commentsCache };
320 | 
321 |   for (const [cacheKey, count] of lastCounts.entries()) {
322 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
323 |     out[cacheKey].lastCount = count;
324 |   }
325 | 
326 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
327 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
328 |     out[cacheKey].knownIds = Array.from(set);
329 |   }
330 | 
331 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
332 |   Object.assign(commentsCache, out);
333 |   saveCache(out);
334 | }
335 | 
336 | /* ============================================================
337 |    =====================   G≈Å√ìWNY WATCHER   ===================
338 |    ============================================================ */
339 | 
340 | const isDev = process.env.NODE_ENV !== "production";
341 | 
342 | async function startWatcher() {
343 |   console.log(
344 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
345 |     Math.round(CHECK_INTERVAL_MS / 1000),
346 |     "sekund."
347 |   );
348 | 
349 |   const loop = async () => {
350 |     let browser = null;
351 |     let page = null;
352 |     let hadNavErrorThisRound = false;
353 | 
354 |     try {
355 |       console.log(
356 |         "[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="
357 |       );
358 | 
359 |       browser = await puppeteer.launch({
360 |         headless: isDev ? true : "new",
361 |         defaultViewport: null,
362 |         args: [
363 |           "--no-sandbox",
364 |           "--disable-setuid-sandbox",
365 |           "--disable-dev-shm-usage",
366 |           "--disable-notifications",
367 |           "--disable-blink-features=AutomationControlled",
368 |         ],
369 |         ignoreDefaultArgs: ["--enable-automation"],
370 |       });
371 | 
372 |       page = await browser.newPage();
373 |       await applyStealth(page);
374 | 
375 |       page.setDefaultNavigationTimeout(90000);
376 |       page.setDefaultTimeout(90000);
377 | 
378 |       await page.setViewport({ width: 1280, height: 720 });
379 | 
380 |       // cookies + login
381 |       await loadCookies(page);
382 |       await page
383 |         .goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 })
384 |         .catch(() => {});
385 | 
386 |       let loggedIn = await checkIfLogged(page);
387 |       if (!loggedIn) {
388 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
389 |         await fbLogin(page);
390 |         loggedIn = await checkIfLogged(page);
391 | 
392 |         if (loggedIn) {
393 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
394 |           await saveCookies(page);
395 |         } else {
396 |           console.error(
397 |             "[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone)."
398 |           );
399 |         }
400 |       } else {
401 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
402 |       }
403 | 
404 |       // posts
405 |       await refreshPostsIfNeeded(true);
406 | 
407 |       if (!currentPosts.length) {
408 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
409 |       } else {
410 |         for (const post of currentPosts) {
411 |           const cacheKey = getCacheKey(post);
412 | 
413 |           try {
414 |             // zawsze prepare przed liczeniem/scrollowaniem/ekstrakcjƒÖ
415 |             await prepare(page, post.url);
416 | 
417 |             const count = await getCommentCount(page, post.url);
418 |             const hasCount = typeof count === "number" && Number.isFinite(count);
419 | 
420 |             if (!hasCount) {
421 |               console.log(
422 |                 `[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`
423 |               );
424 |             }
425 | 
426 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
427 |             const knownSet = getKnownSetForPost(cacheKey);
428 | 
429 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
430 |             if (prev === null) {
431 |               const initialCount = hasCount ? count : 0;
432 |               lastCounts.set(cacheKey, initialCount);
433 | 
434 |               console.log(
435 |                 hasCount
436 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
437 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
438 |               );
439 | 
440 |               if (EXPAND_COMMENTS) {
441 |                 await loadAllComments(
442 |                   page,
443 |                   { expectedTotal: hasCount ? count : undefined },
444 |                   post.url
445 |                 ).catch(() => {});
446 | 
447 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
448 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
449 |                 console.log(
450 |                   `[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`
451 |                 );
452 |               } else {
453 |                 console.log(
454 |                   `[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`
455 |                 );
456 |               }
457 | 
458 |               continue;
459 |             }
460 | 
461 |             // licznik: aktualizuj tylko je≈õli mamy twarde dane
462 |             if (hasCount) {
463 |               if (count !== prev) {
464 |                 console.log(
465 |                   `[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`
466 |                 );
467 |                 lastCounts.set(cacheKey, count);
468 |               } else {
469 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
470 |               }
471 |             } else {
472 |               console.log(
473 |                 `[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`
474 |               );
475 |             }
476 | 
477 |             if (!EXPAND_COMMENTS) continue;
478 | 
479 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(
480 |               () => {}
481 |             );
482 | 
483 |             let snapshot = await extractCommentsData(page, post.url).catch(() => []);
484 | 
485 |             // nowe ID
486 |             const newComments = [];
487 |             for (const c of snapshot) {
488 |               if (!c?.id) continue;
489 |               if (!knownSet.has(c.id)) {
490 |                 knownSet.add(c.id);
491 |                 newComments.push(c);
492 |               }
493 |             }
494 | 
495 |             // fallback "tail" tylko je≈õli mamy wiarygodny licznik i wzrost
496 |             if (hasCount && newComments.length === 0 && count > prev) {
497 |               const diff = Math.max(1, count - prev);
498 |               const tail = snapshot.slice(-diff);
499 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
500 | 
501 |               console.log(
502 |                 `[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`
503 |               );
504 |               await sendWebhook(post, tail, count, prev);
505 |               continue;
506 |             }
507 | 
508 |             if (newComments.length > 0) {
509 |               console.log(
510 |                 `[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`
511 |               );
512 |               await sendWebhook(
513 |                 post,
514 |                 newComments,
515 |                 hasCount ? count : null,
516 |                 hasCount ? prev : null
517 |               );
518 |             } else {
519 |               console.log(
520 |                 `[Watcher] Post ${post.id}: Brak nowych komentarzy (po ID i fallbacku).`
521 |               );
522 |             }
523 |           } catch (err) {
524 |             console.error(
525 |               `[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`,
526 |               err?.message || err
527 |             );
528 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
529 | 
530 |             if (isNavigationError(err)) {
531 |               hadNavErrorThisRound = true;
532 |               navErrorCount++;
533 |               console.log(
534 |                 `[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`
535 |               );
536 |             }
537 |           }
538 |         }
539 |       }
540 |     } catch (err) {
541 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
542 |     } finally {
543 |       flushCacheToDisk();
544 | 
545 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
546 |         console.log(
547 |           `[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`
548 |         );
549 |         navErrorCount = 0;
550 |       }
551 | 
552 |       if (browser) {
553 |         try {
554 |           await browser.close();
555 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
556 |         } catch (e) {
557 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
558 |         }
559 |       }
560 | 
561 |       if (navErrorCount >= MAX_NAV_ERRORS) {
562 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
563 |         process.exit(1);
564 |       }
565 | 
566 |       const jitter = Math.floor(Math.random() * 5000);
567 |       const delay = CHECK_INTERVAL_MS + jitter;
568 |       console.log(
569 |         `[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`
570 |       );
571 |       setTimeout(loop, delay);
572 |     }
573 |   };
574 | 
575 |   loop();
576 | }
577 | 
578 | export { startWatcher };
579 | 
```

---

### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/webhook.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | // src/webhook.js
  2 | import axios from "axios";
  3 | import { POST_LABELS } from "./config.js";
  4 | 
  5 | /* ============================================================
  6 |    PARSER CZASU FB ‚Üí ISO
  7 |    ============================================================ */
  8 | 
  9 | function parseFbRelativeTime(raw) {
 10 |   if (!raw) return null;
 11 | 
 12 |   const t = raw.toLowerCase().trim();
 13 |   const now = new Date();
 14 | 
 15 |   if (t.includes("przed chwilƒÖ")) return now;
 16 | 
 17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
 18 |     const d = new Date(now);
 19 |     d.setDate(d.getDate() - 1);
 20 |     return d;
 21 |   }
 22 | 
 23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
 24 |   if (!m) return null;
 25 | 
 26 |   const value = parseInt(m[1], 10);
 27 |   if (!Number.isFinite(value)) return null;
 28 | 
 29 |   const unit = m[2];
 30 |   const d = new Date(now);
 31 | 
 32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
 33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
 34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
 35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
 36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
 37 | 
 38 |   return d;
 39 | }
 40 | 
 41 | /* ============================================================
 42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
 43 |    ============================================================ */
 44 | 
 45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
 46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
 47 | 
 48 | function filterByAge(comments) {
 49 |   const now = Date.now();
 50 | 
 51 |   return comments.filter((c) => {
 52 |     if (!c.time || c.time.trim() === "") return false;
 53 | 
 54 |     const abs = parseFbRelativeTime(c.time);
 55 |     if (!abs) return false;
 56 | 
 57 |     const ageMinutes = (now - abs.getTime()) / 60000;
 58 |     return ageMinutes <= MAX_AGE_MIN;
 59 |   });
 60 | }
 61 | 
 62 | /* ============================================================
 63 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
 64 |    ============================================================ */
 65 | 
 66 | async function sendWebhook(post, newComments, newCount, oldCount) {
 67 |   const url = process.env.WEBHOOK_URL;
 68 |   if (!url) {
 69 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
 70 |     return;
 71 |   }
 72 | 
 73 |   // meta posta (panel/sheets/env fallback)
 74 |   const postName =
 75 |     (post?.name && String(post.name).trim()) ||
 76 |     POST_LABELS[post?.id] ||
 77 |     post?.id ||
 78 |     "post";
 79 | 
 80 |   const postImage =
 81 |     (post?.image && String(post.image).trim()) || null;
 82 | 
 83 |   const postDescription =
 84 |     (post?.description && String(post.description).trim()) || null;
 85 | 
 86 |   /* --------------------------------------------
 87 |        1) Normalizacja czasu i dodanie p√≥l ISO
 88 |      -------------------------------------------- */
 89 | 
 90 |   const normalized = newComments.map((c) => {
 91 |     const iso = parseFbRelativeTime(c.time);
 92 |     return {
 93 |       ...c,
 94 |       fb_time_raw: c.time || null,
 95 |       fb_time_iso: iso ? iso.toISOString() : null,
 96 |     };
 97 |   });
 98 | 
 99 |   /* --------------------------------------------
100 |        2) Filtrowanie komentarzy po wieku
101 |      -------------------------------------------- */
102 | 
103 |   const freshOnly = filterByAge(normalized);
104 | 
105 |   console.log("[Webhook] Filtr wieku komentarzy:", {
106 |     before: normalized.length,
107 |     after: freshOnly.length,
108 |     maxAgeMin: MAX_AGE_MIN,
109 |   });
110 | 
111 |   if (freshOnly.length === 0) {
112 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
113 |     return;
114 |   }
115 | 
116 |   /* --------------------------------------------
117 |        3) Payload do webhooka
118 |      -------------------------------------------- */
119 | 
120 |   const payload = {
121 |     post: {
122 |       id: post?.id || null,
123 |       url: post?.url || null,
124 |       name: postName,
125 |       image: postImage,
126 |       description: postDescription,
127 |     },
128 |     commentCount: newCount,
129 |     previousCommentCount: oldCount,
130 |     newComments: freshOnly,
131 |     timestamp: new Date().toISOString(),
132 |   };
133 | 
134 |   console.log("[Webhook] Wysy≈Çanie danych o nowych komentarzach:", payload);
135 | 
136 |   /* --------------------------------------------
137 |        4) Wysy≈Çka do Make / webhooka
138 |      -------------------------------------------- */
139 | 
140 |   try {
141 |     await axios.post(url, payload, { timeout: 10000 });
142 |     console.log("[Webhook] Wys≈Çano nowe komentarze do webhooka.");
143 |   } catch (err) {
144 |     console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err.message);
145 |   }
146 | }
147 | 
148 | export { sendWebhook };
149 | 
```

---

### üìÑ ≈öcie≈ºka: `debug-login.mjs`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | import fs from "fs/promises";
 2 | import puppeteer from "puppeteer";
 3 | 
 4 | const email = process.env.FB_EMAIL;
 5 | const pass = process.env.FB_PASSWORD;
 6 | 
 7 | if (!email || !pass) {
 8 |   console.log("Brak FB_EMAIL/FB_PASSWORD w env (.env lub zmienne).");
 9 |   process.exit(1);
10 | }
11 | 
12 | const executablePath = process.env.PUPPETEER_EXECUTABLE_PATH || "/usr/bin/chromium-browser";
13 | 
14 | const browser = await puppeteer.launch({
15 |   headless: true,
16 |   executablePath,
17 |   args: [
18 |     "--no-sandbox",
19 |     "--disable-setuid-sandbox",
20 |     "--disable-dev-shm-usage",
21 |     "--disable-notifications",
22 |     "--lang=en-US,en",
23 |   ],
24 | });
25 | 
26 | const page = await browser.newPage();
27 | page.setDefaultTimeout(60000);
28 | 
29 | await page.goto("https://www.facebook.com/login", { waitUntil: "domcontentloaded" });
30 | await page.waitForSelector("#email", { timeout: 60000 });
31 | await page.type("#email", email, { delay: 30 });
32 | await page.type("#pass", pass, { delay: 30 });
33 | 
34 | await Promise.all([
35 |   page.click('button[name="login"]'),
36 |   page.waitForNavigation({ waitUntil: "domcontentloaded" }).catch(() => null),
37 | ]);
38 | 
39 | const url = page.url();
40 | const title = await page.title().catch(() => "");
41 | const bodyText = await page.evaluate(() => document.body?.innerText?.slice(0, 2000) || "");
42 | 
43 | await page.screenshot({ path: "/tmp/fb-login.png", fullPage: true }).catch(() => null);
44 | 
45 | console.log("URL:", url);
46 | console.log("TITLE:", title);
47 | console.log("BODY_SNIPPET:\n", bodyText);
48 | 
49 | await browser.close();
50 | 
```

---

### üìÑ ≈öcie≈ºka: `EXPORT_PROJEKTU_PLUS.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

**UWAGA:** pominiƒôto tre≈õƒá ‚Üí Za du≈ºy (3454884 B > 2000000 B)  

---

### üìÑ ≈öcie≈ºka: `EXPORT_PROJEKTU.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

```md
    1 | # üì¶ EXPORT PROJEKTU: FB_Watcher
    2 | 
    3 | **Root:** `C:\Projekty vs\FB_Watcher`  
    4 | **Wygenerowano:** `2026-01-21T20:47:54.106Z`  
    5 | **Liczba plik√≥w:** `144`  
    6 | **Max rozmiar pliku:** `2000000 B`  
    7 | 
    8 | ## üß≠ Spis tre≈õci
    9 | - [package.json](#≈õcie≈ºka-packagejson)
   10 | - [.env](#≈õcie≈ºka-env)
   11 | - [config/links.js](#≈õcie≈ºka-config-linksjs)
   12 | - [config/links.json](#≈õcie≈ºka-config-linksjson)
   13 | - [DEBUG_EXPORT/src/config.js](#≈õcie≈ºka-debugexport-src-configjs)
   14 | - [export_chat_context/03__config.js](#≈õcie≈ºka-exportchatcontext-03configjs)
   15 | - [export_fb_watcher/config.js](#≈õcie≈ºka-exportfbwatcher-configjs)
   16 | - [src/config.js](#≈õcie≈ºka-src-configjs)
   17 | - [src/panel/web/postcss.config.js](#≈õcie≈ºka-src-panel-web-postcssconfigjs)
   18 | - [src/panel/web/tailwind.config.js](#≈õcie≈ºka-src-panel-web-tailwindconfigjs)
   19 | - [src/panel/web/tsconfig.json](#≈õcie≈ºka-src-panel-web-tsconfigjson)
   20 | - [src/panel/web/vite.config.ts](#≈õcie≈ºka-src-panel-web-viteconfigts)
   21 | - [src/db/cache.js](#≈õcie≈ºka-src-db-cachejs)
   22 | - [src/fb/checkpoint.js](#≈õcie≈ºka-src-fb-checkpointjs)
   23 | - [src/fb/comments.js](#≈õcie≈ºka-src-fb-commentsjs)
   24 | - [src/fb/cookies.js](#≈õcie≈ºka-src-fb-cookiesjs)
   25 | - [src/fb/expandButtons.js](#≈õcie≈ºka-src-fb-expandbuttonsjs)
   26 | - [src/fb/legacy/comments.legacy.js](#≈õcie≈ºka-src-fb-legacy-commentslegacyjs)
   27 | - [src/fb/login.js](#≈õcie≈ºka-src-fb-loginjs)
   28 | - [src/fb/scroll.js](#≈õcie≈ºka-src-fb-scrolljs)
   29 | - [src/fb/ui/index.js](#≈õcie≈ºka-src-fb-ui-indexjs)
   30 | - [src/fb/ui/photo.js](#≈õcie≈ºka-src-fb-ui-photojs)
   31 | - [src/fb/ui/post.js](#≈õcie≈ºka-src-fb-ui-postjs)
   32 | - [src/fb/ui/videos.js](#≈õcie≈ºka-src-fb-ui-videosjs)
   33 | - [src/fb/ui/watch.js](#≈õcie≈ºka-src-fb-ui-watchjs)
   34 | - [src/fb/uiCommentInfo.js](#≈õcie≈ºka-src-fb-uicommentinfojs)
   35 | - [src/index.js](#≈õcie≈ºka-src-indexjs)
   36 | - [src/panel/api.js](#≈õcie≈ºka-src-panel-apijs)
   37 | - [src/panel/panel-entry.cjs](#≈õcie≈ºka-src-panel-panel-entrycjs)
   38 | - [src/panel/ui/app.js](#≈õcie≈ºka-src-panel-ui-appjs)
   39 | - [src/panel/ui/index.html](#≈õcie≈ºka-src-panel-ui-indexhtml)
   40 | - [src/panel/web/index.html](#≈õcie≈ºka-src-panel-web-indexhtml)
   41 | - [src/panel/web/package.json](#≈õcie≈ºka-src-panel-web-packagejson)
   42 | - [src/panel/web/src/App.tsx](#≈õcie≈ºka-src-panel-web-src-apptsx)
   43 | - [src/panel/web/src/components/layout/DashboardLayout.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-dashboardlayouttsx)
   44 | - [src/panel/web/src/components/layout/Header.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-headertsx)
   45 | - [src/panel/web/src/components/layout/MobileNav.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-mobilenavtsx)
   46 | - [src/panel/web/src/components/layout/Sidebar.tsx](#≈õcie≈ºka-src-panel-web-src-components-layout-sidebartsx)
   47 | - [src/panel/web/src/components/ui/badge.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-badgetsx)
   48 | - [src/panel/web/src/components/ui/button.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-buttontsx)
   49 | - [src/panel/web/src/components/ui/card.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-cardtsx)
   50 | - [src/panel/web/src/components/ui/checkbox.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-checkboxtsx)
   51 | - [src/panel/web/src/components/ui/dialog.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-dialogtsx)
   52 | - [src/panel/web/src/components/ui/input.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-inputtsx)
   53 | - [src/panel/web/src/components/ui/label.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-labeltsx)
   54 | - [src/panel/web/src/components/ui/separator.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-separatortsx)
   55 | - [src/panel/web/src/components/ui/switch.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-switchtsx)
   56 | - [src/panel/web/src/components/ui/table.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabletsx)
   57 | - [src/panel/web/src/components/ui/tabs.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-tabstsx)
   58 | - [src/panel/web/src/components/ui/textarea.tsx](#≈õcie≈ºka-src-panel-web-src-components-ui-textareatsx)
   59 | - [src/panel/web/src/hooks/useApi.ts](#≈õcie≈ºka-src-panel-web-src-hooks-useapits)
   60 | - [src/panel/web/src/hooks/useAuth.tsx](#≈õcie≈ºka-src-panel-web-src-hooks-useauthtsx)
   61 | - [src/panel/web/src/hooks/useLogs.ts](#≈õcie≈ºka-src-panel-web-src-hooks-uselogsts)
   62 | - [src/panel/web/src/index.css](#≈õcie≈ºka-src-panel-web-src-indexcss)
   63 | - [src/panel/web/src/lib/api.ts](#≈õcie≈ºka-src-panel-web-src-lib-apits)
   64 | - [src/panel/web/src/lib/types.ts](#≈õcie≈ºka-src-panel-web-src-lib-typests)
   65 | - [src/panel/web/src/lib/utils.ts](#≈õcie≈ºka-src-panel-web-src-lib-utilsts)
   66 | - [src/panel/web/src/main.tsx](#≈õcie≈ºka-src-panel-web-src-maintsx)
   67 | - [src/panel/web/src/pages/Campaigns.tsx](#≈õcie≈ºka-src-panel-web-src-pages-campaignstsx)
   68 | - [src/panel/web/src/pages/Cookies.tsx](#≈õcie≈ºka-src-panel-web-src-pages-cookiestsx)
   69 | - [src/panel/web/src/pages/Dashboard.tsx](#≈õcie≈ºka-src-panel-web-src-pages-dashboardtsx)
   70 | - [src/panel/web/src/pages/Discoveries.tsx](#≈õcie≈ºka-src-panel-web-src-pages-discoveriestsx)
   71 | - [src/panel/web/src/pages/Logs.tsx](#≈õcie≈ºka-src-panel-web-src-pages-logstsx)
   72 | - [src/panel/web/src/pages/Settings.tsx](#≈õcie≈ºka-src-panel-web-src-pages-settingstsx)
   73 | - [src/panel/web/src/pages/Sources.tsx](#≈õcie≈ºka-src-panel-web-src-pages-sourcestsx)
   74 | - [src/panel/web/src/pages/Watched.tsx](#≈õcie≈ºka-src-panel-web-src-pages-watchedtsx)
   75 | - [src/panel/web/src/vite-env.d.ts](#≈õcie≈ºka-src-panel-web-src-vite-envdts)
   76 | - [src/telegram.js](#≈õcie≈ºka-src-telegramjs)
   77 | - [src/utils/logger.js](#≈õcie≈ºka-src-utils-loggerjs)
   78 | - [src/utils/mouse.js](#≈õcie≈ºka-src-utils-mousejs)
   79 | - [src/utils/navigation.js](#≈õcie≈ºka-src-utils-navigationjs)
   80 | - [src/utils/sleep.js](#≈õcie≈ºka-src-utils-sleepjs)
   81 | - [src/utils/time.js](#≈õcie≈ºka-src-utils-timejs)
   82 | - [src/watcher.js](#≈õcie≈ºka-src-watcherjs)
   83 | - [DEBUG_EXPORT/src/panel/api.js](#≈õcie≈ºka-debugexport-src-panel-apijs)
   84 | - [DEBUG_EXPORT/src/panel/panel-entry.cjs](#≈õcie≈ºka-debugexport-src-panel-panel-entrycjs)
   85 | - [DEBUG_EXPORT/src/panel/ui/app.js](#≈õcie≈ºka-debugexport-src-panel-ui-appjs)
   86 | - [DEBUG_EXPORT/src/panel/ui/index.html](#≈õcie≈ºka-debugexport-src-panel-ui-indexhtml)
   87 | - [export_fb_watcher/panel-entry.cjs](#≈õcie≈ºka-exportfbwatcher-panel-entrycjs)
   88 | - [CLAUDE.md](#≈õcie≈ºka-claudemd)
   89 | - [cookies.json](#≈õcie≈ºka-cookiesjson)
   90 | - [data/backup_cookies/cookies_1.json](#≈õcie≈ºka-data-backupcookies-cookies1json)
   91 | - [data/backup_cookies/cookies_2.json](#≈õcie≈ºka-data-backupcookies-cookies2json)
   92 | - [data/backup_cookies/cookies_3.json](#≈õcie≈ºka-data-backupcookies-cookies3json)
   93 | - [data/backup_cookies/cookies_4.json](#≈õcie≈ºka-data-backupcookies-cookies4json)
   94 | - [data/comments-cache.json](#≈õcie≈ºka-data-comments-cachejson)
   95 | - [data/posts.json](#≈õcie≈ºka-data-postsjson)
   96 | - [DEBUG_EXPORT/.env](#≈õcie≈ºka-debugexport-env)
   97 | - [DEBUG_EXPORT/package.json](#≈õcie≈ºka-debugexport-packagejson)
   98 | - [DEBUG_EXPORT/src/index.js](#≈õcie≈ºka-debugexport-src-indexjs)
   99 | - [DEBUG_EXPORT/src/watcher.js](#≈õcie≈ºka-debugexport-src-watcherjs)
  100 | - [DEBUG_EXPORT/src/webhook.js](#≈õcie≈ºka-debugexport-src-webhookjs)
  101 | - [debug-login.mjs](#≈õcie≈ºka-debug-loginmjs)
  102 | - [export_chat_context/01__index.js](#≈õcie≈ºka-exportchatcontext-01indexjs)
  103 | - [export_chat_context/02__watcher.js](#≈õcie≈ºka-exportchatcontext-02watcherjs)
  104 | - [export_chat_context/04__telegram.js](#≈õcie≈ºka-exportchatcontext-04telegramjs)
  105 | - [export_chat_context/05__webhook.js](#≈õcie≈ºka-exportchatcontext-05webhookjs)
  106 | - [export_chat_context/06__comments.js](#≈õcie≈ºka-exportchatcontext-06commentsjs)
  107 | - [export_chat_context/07__scroll.js](#≈õcie≈ºka-exportchatcontext-07scrolljs)
  108 | - [export_chat_context/08__login.js](#≈õcie≈ºka-exportchatcontext-08loginjs)
  109 | - [export_chat_context/09__cookies.js](#≈õcie≈ºka-exportchatcontext-09cookiesjs)
  110 | - [export_chat_context/10__expandButtons.js](#≈õcie≈ºka-exportchatcontext-10expandbuttonsjs)
  111 | - [export_chat_context/11__index.js](#≈õcie≈ºka-exportchatcontext-11indexjs)
  112 | - [export_chat_context/12__post.js](#≈õcie≈ºka-exportchatcontext-12postjs)
  113 | - [export_chat_context/13__photo.js](#≈õcie≈ºka-exportchatcontext-13photojs)
  114 | - [export_chat_context/14__watch.js](#≈õcie≈ºka-exportchatcontext-14watchjs)
  115 | - [export_chat_context/15__videos.js](#≈õcie≈ºka-exportchatcontext-15videosjs)
  116 | - [export_chat_context/16__navigation.js](#≈õcie≈ºka-exportchatcontext-16navigationjs)
  117 | - [export_chat_context/17__sleep.js](#≈õcie≈ºka-exportchatcontext-17sleepjs)
  118 | - [export_chat_context/18__api.js](#≈õcie≈ºka-exportchatcontext-18apijs)
  119 | - [export_chat_context/19__index.html](#≈õcie≈ºka-exportchatcontext-19indexhtml)
  120 | - [export_chat_context/20__app.js](#≈õcie≈ºka-exportchatcontext-20appjs)
  121 | - [export_fb_watcher/.env](#≈õcie≈ºka-exportfbwatcher-env)
  122 | - [export_fb_watcher/api.js](#≈õcie≈ºka-exportfbwatcher-apijs)
  123 | - [export_fb_watcher/app.js](#≈õcie≈ºka-exportfbwatcher-appjs)
  124 | - [export_fb_watcher/cache.js](#≈õcie≈ºka-exportfbwatcher-cachejs)
  125 | - [export_fb_watcher/comments-cache.json](#≈õcie≈ºka-exportfbwatcher-comments-cachejson)
  126 | - [export_fb_watcher/comments.js](#≈õcie≈ºka-exportfbwatcher-commentsjs)
  127 | - [export_fb_watcher/comments.legacy.js](#≈õcie≈ºka-exportfbwatcher-commentslegacyjs)
  128 | - [export_fb_watcher/cookies.js](#≈õcie≈ºka-exportfbwatcher-cookiesjs)
  129 | - [export_fb_watcher/cookies.json](#≈õcie≈ºka-exportfbwatcher-cookiesjson)
  130 | - [export_fb_watcher/expandButtons.js](#≈õcie≈ºka-exportfbwatcher-expandbuttonsjs)
  131 | - [export_fb_watcher/export_files.js](#≈õcie≈ºka-exportfbwatcher-exportfilesjs)
  132 | - [export_fb_watcher/index.html](#≈õcie≈ºka-exportfbwatcher-indexhtml)
  133 | - [export_fb_watcher/index.js](#≈õcie≈ºka-exportfbwatcher-indexjs)
  134 | - [export_fb_watcher/links.js](#≈õcie≈ºka-exportfbwatcher-linksjs)
  135 | - [export_fb_watcher/links.json](#≈õcie≈ºka-exportfbwatcher-linksjson)
  136 | - [export_fb_watcher/login.js](#≈õcie≈ºka-exportfbwatcher-loginjs)
  137 | - [export_fb_watcher/navigation.js](#≈õcie≈ºka-exportfbwatcher-navigationjs)
  138 | - [export_fb_watcher/package.json](#≈õcie≈ºka-exportfbwatcher-packagejson)
  139 | - [export_fb_watcher/photo.js](#≈õcie≈ºka-exportfbwatcher-photojs)
  140 | - [export_fb_watcher/post.js](#≈õcie≈ºka-exportfbwatcher-postjs)
  141 | - [export_fb_watcher/scroll.js](#≈õcie≈ºka-exportfbwatcher-scrolljs)
  142 | - [export_fb_watcher/sleep.js](#≈õcie≈ºka-exportfbwatcher-sleepjs)
  143 | - [export_fb_watcher/uicommentinfo.js](#≈õcie≈ºka-exportfbwatcher-uicommentinfojs)
  144 | - [export_fb_watcher/videos.js](#≈õcie≈ºka-exportfbwatcher-videosjs)
  145 | - [export_fb_watcher/watch.js](#≈õcie≈ºka-exportfbwatcher-watchjs)
  146 | - [export_fb_watcher/watcher.js](#≈õcie≈ºka-exportfbwatcher-watcherjs)
  147 | - [export_fb_watcher/webhook.js](#≈õcie≈ºka-exportfbwatcher-webhookjs)
  148 | - [export_files.js](#≈õcie≈ºka-exportfilesjs)
  149 | - [Rozwoj.md](#≈õcie≈ºka-rozwojmd)
  150 | - [scripts/generate-cookies.js](#≈õcie≈ºka-scripts-generate-cookiesjs)
  151 | - [test-telegram.mjs](#≈õcie≈ºka-test-telegrammjs)
  152 | - [tools/export-project-to-md.js](#≈õcie≈ºka-tools-export-project-to-mdjs)
  153 | 
  154 | ---
  155 | 
  156 | ### üìÑ ≈öcie≈ºka: `package.json`
  157 | **Typ:** JSON  
  158 | **Opis:** Metadane projektu i zale≈ºno≈õci (npm).  
  159 | 
  160 | ```json
  161 |  1 | {
  162 |  2 |   "name": "fb_puppeteer",
  163 |  3 |   "version": "1.0.0",
  164 |  4 |   "description": "Watcher komentarzy FB + webhook do Make",
  165 |  5 |   "main": "src/index.js",
  166 |  6 |   "type": "module",
  167 |  7 |   "scripts": {
  168 |  8 |     "start": "node src/index.js",
  169 |  9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
  170 | 10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs",
  171 | 11 |     "panel:web:install": "cd src/panel/web && npm install",
  172 | 12 |     "panel:web:dev": "cd src/panel/web && npm run dev",
  173 | 13 |     "panel:web:build": "cd src/panel/web && npm run build"
  174 | 14 |   },
  175 | 15 |   "keywords": [],
  176 | 16 |   "author": "",
  177 | 17 |   "license": "ISC",
  178 | 18 |   "dependencies": {
  179 | 19 |     "axios": "^1.13.2",
  180 | 20 |     "dotenv": "^17.2.3",
  181 | 21 |     "puppeteer": "^24.31.0",
  182 | 22 |     "puppeteer-extra": "^3.3.6",
  183 | 23 |     "puppeteer-extra-plugin-recaptcha": "^3.6.8",
  184 | 24 |     "puppeteer-extra-plugin-stealth": "^2.11.2"
  185 | 25 |   },
  186 | 26 |   "devDependencies": {
  187 | 27 |     "@yao-pkg/pkg": "^6.11.0",
  188 | 28 |     "esbuild": "^0.27.2",
  189 | 29 |     "nexe": "^5.0.0-beta.4",
  190 | 30 |     "pkg": "^5.8.1"
  191 | 31 |   },
  192 | 32 |   "pkg": {
  193 | 33 |     "assets": [
  194 | 34 |       "src/panel/api.js",
  195 | 35 |       "src/panel/**/*.js",
  196 | 36 |       ".env",
  197 | 37 |       "data/**/*"
  198 | 38 |     ]
  199 | 39 |   }
  200 | 40 | }
  201 | 41 | 
  202 | ```
  203 | 
  204 | ---
  205 | 
  206 | ### üìÑ ≈öcie≈ºka: `.env`
  207 | **Typ:** ENV  
  208 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
  209 | 
  210 | ```dotenv
  211 |  1 | # === FB WATCHER ===
  212 |  2 | FB_EMAIL=fbwatcher1@gmail.com
  213 |  3 | FB_PASSWORD=FbWatcher123!
  214 |  4 | 
  215 |  5 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
  216 |  6 | CHECK_INTERVAL_MS=60000
  217 |  7 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
  218 |  8 | 
  219 |  9 | # cookies
  220 | 10 | COOKIES_READ_ONLY=false
  221 | 11 | 
  222 | 12 | # puppeteer
  223 | 13 | HEADLESS_BROWSER=true
  224 | 14 | USE_UI_HANDLERS=true
  225 | 15 | INCLUDE_REPLIES=false
  226 | 16 | 
  227 | 17 | # runtime
  228 | 18 | NODE_ENV=production
  229 | 19 | TZ=Europe/Warsaw
  230 | 20 | 
  231 | 21 | # logi: silent | production | dev | debug
  232 | 22 | LOG_LEVEL=production
  233 | 23 | 
  234 | 24 | # ≈õcie≈ºki serwerowe (produkcja Linux)
  235 | 25 | # PROJECT_DIR=/opt/fb-watcher
  236 | 26 | # POSTS_FILE=/opt/fb-watcher/data/posts.json
  237 | 27 | 
  238 | 28 | # lokalne testy (Windows)
  239 | 29 | PROJECT_DIR=C:/Projekty vs/FB_Watcher
  240 | 30 | 
  241 | 31 | # === POSTS Z REMOTE API (lokalny watcher ‚Üê panel na serwerze) ===
  242 | 32 | # Ustaw adres IP/domenƒô serwera gdzie dzia≈Ça panel
  243 | 33 | POSTS_API_URL=http://162.55.188.103:3180/api/posts
  244 | 34 | POSTS_API_TOKEN=fbw_3c9e8a2d7f4b1a6c9d5e0f8a2b7c4e9d1f6a0b5c8e2d9a4f7
  245 | 35 | 
  246 | 36 | # === PANEL ===
  247 | 37 | PANEL_TOKEN=TEST_TOKEN_123
  248 | 38 | PANEL_PORT=3180
  249 | 39 | PANEL_BIND=0.0.0.0
  250 | 40 | 
  251 | 41 | # === PM2 ===
  252 | 42 | PM2_APP=fbwatcher
  253 | 43 | PM2_LOG_OUT=/root/.pm2/logs/fbwatcher-out.log
  254 | 44 | PM2_LOG_ERR=/root/.pm2/logs/fbwatcher-error.log
  255 | 45 | 
  256 | 46 | # === TELEGRAM (2 boty) ===
  257 | 47 | 
  258 | 48 | # Tw√≥j bot + Tw√≥j prywatny chat
  259 | 49 | TELEGRAM_BOT_TOKEN_OWNER=8561327207:AAHgjWbwCNtPGJSa5pwVcP2mMJm9T_bh6HM
  260 | 50 | TELEGRAM_CHAT_ID_OWNER=6774389439
  261 | 51 | 
  262 | 52 | # Bot klienta + prywatny chat klienta
  263 | 53 | TELEGRAM_BOT_TOKEN_CLIENT=8504080014:AAHoxXLDe90hIP4efHouoKX4pb7kXSwDgS8
  264 | 54 | TELEGRAM_CHAT_ID_CLIENT=7081837522
  265 | 55 | 
  266 | 56 | # prze≈ÇƒÖczniki
  267 | 57 | TELEGRAM_SEND_TO_OWNER=1
  268 | 58 | TELEGRAM_SEND_TO_CLIENT=0
  269 | 59 | 
  270 | 60 | # formatowanie
  271 | 61 | TELEGRAM_USE_PHOTO=1
  272 | 62 | TELEGRAM_DISABLE_WEB_PAGE_PREVIEW=1
  273 | 63 | 
  274 | 64 | # alerty z log√≥w
  275 | 65 | TG_ALERTS_ENABLED=1
  276 | 66 | TG_ALERTS_COOLDOWN_SEC=120
  277 | 67 | TG_ALERTS_MAXLEN=3500
  278 | 68 | 
  279 | 69 | 
  280 | 70 | FAST_MODE=true
  281 | 71 | 
  282 | 72 | # === 2CAPTCHA ===
  283 | 73 | CAPTCHA_API_KEY=bc82e530a13e72887acbbdfd9cc0fdee
  284 | ```
  285 | 
  286 | ---
  287 | 
  288 | ### üìÑ ≈öcie≈ºka: `config/links.js`
  289 | **Typ:** JavaScript/tekst  
  290 | **Opis:** Plik projektu (kod/konfiguracja).  
  291 | 
  292 | ```js
  293 |   1 | // src/config/links.js
  294 |   2 | import fs from "fs";
  295 |   3 | import path from "path";
  296 |   4 | 
  297 |   5 | // Je≈õli masz Node <18, odkomentuj te dwie linijki:
  298 |   6 | // import fetch from "node-fetch";
  299 |   7 | // global.fetch = fetch;
  300 |   8 | 
  301 |   9 | const LINKS_SHEET_URL = process.env.LINKS_SHEET_URL;
  302 |  10 | const LOCAL_FILE = path.join(process.cwd(), "config", "links.json");
  303 |  11 | 
  304 |  12 | let linksCache = [];
  305 |  13 | let lastHash = null;
  306 |  14 | 
  307 |  15 | /* ============================================
  308 |  16 |    Prost y "hash" listy link√≥w
  309 |  17 |    ============================================ */
  310 |  18 | function calcHash(urls) {
  311 |  19 |   return urls.join("|");
  312 |  20 | }
  313 |  21 | 
  314 |  22 | /* ============================================
  315 |  23 |    Wczytanie lokalnego pliku JSON
  316 |  24 |    ============================================ */
  317 |  25 | function loadLinksFromLocalFile() {
  318 |  26 |   try {
  319 |  27 |     const raw = fs.readFileSync(LOCAL_FILE, "utf8");
  320 |  28 |     const data = JSON.parse(raw);
  321 |  29 | 
  322 |  30 |     if (Array.isArray(data.links)) {
  323 |  31 |       const cleaned = data.links
  324 |  32 |         .filter((u) => typeof u === "string")
  325 |  33 |         .map((u) => u.trim())
  326 |  34 |         .filter((u) => u.startsWith("http"));
  327 |  35 | 
  328 |  36 |       console.log("[CFG] Za≈Çadowane linki z lokalnego pliku:", cleaned);
  329 |  37 |       return cleaned;
  330 |  38 |     }
  331 |  39 | 
  332 |  40 |     console.warn("[CFG] Lokalny links.json nie zawiera poprawnego pola 'links'");
  333 |  41 |     return [];
  334 |  42 |   } catch (err) {
  335 |  43 |     console.warn("[CFG] Brak / b≈ÇƒÖd wczytywania links.json:", err.message);
  336 |  44 |     return [];
  337 |  45 |   }
  338 |  46 | }
  339 |  47 | 
  340 |  48 | /* ============================================
  341 |  49 |    Parser CSV z Sheetsa
  342 |  50 |    ============================================ */
  343 |  51 | function parseCsv(text) {
  344 |  52 |   const hasSemicolon = text.includes(";");
  345 |  53 |   const delimiter = hasSemicolon ? ";" : ",";
  346 |  54 | 
  347 |  55 |   const lines = text
  348 |  56 |     .split(/\r?\n/)
  349 |  57 |     .map((l) => l.trim())
  350 |  58 |     .filter(Boolean);
  351 |  59 | 
  352 |  60 |   if (!lines.length) {
  353 |  61 |     return [];
  354 |  62 |   }
  355 |  63 | 
  356 |  64 |   const header = lines[0].split(delimiter).map((h) => h.trim().toLowerCase());
  357 |  65 | 
  358 |  66 |   const idxActive = header.indexOf("active");
  359 |  67 |   const idxUrl = header.indexOf("url");
  360 |  68 | 
  361 |  69 |   if (idxUrl === -1) {
  362 |  70 |     console.warn("[CFG] W CSV nie znaleziono kolumny 'url'");
  363 |  71 |     return [];
  364 |  72 |   }
  365 |  73 | 
  366 |  74 |   const rows = [];
  367 |  75 | 
  368 |  76 |   for (let i = 1; i < lines.length; i++) {
  369 |  77 |     const cols = lines[i].split(delimiter).map((c) => c.trim());
  370 |  78 | 
  371 |  79 |     const url = cols[idxUrl] || "";
  372 |  80 |     if (!url || !url.startsWith("http")) continue;
  373 |  81 | 
  374 |  82 |     let active = true;
  375 |  83 | 
  376 |  84 |     if (idxActive !== -1) {
  377 |  85 |       const val = (cols[idxActive] || "").toLowerCase();
  378 |  86 |       active = val === "true" || val === "1" || val === "yes" || val === "y";
  379 |  87 |     }
  380 |  88 | 
  381 |  89 |     if (!active) continue;
  382 |  90 | 
  383 |  91 |     rows.push(url);
  384 |  92 |   }
  385 |  93 | 
  386 |  94 |   return rows;
  387 |  95 | }
  388 |  96 | 
  389 |  97 | /* ============================================
  390 |  98 |    Pobranie link√≥w z Sheeta lub lokalnie
  391 |  99 |    ============================================ */
  392 | 100 | async function fetchLinks() {
  393 | 101 |   if (!LINKS_SHEET_URL) {
  394 | 102 |     console.warn("[CFG] Brak LINKS_SHEET_URL w .env ‚Äì u≈ºywam lokalnego pliku");
  395 | 103 |     return loadLinksFromLocalFile();
  396 | 104 |   }
  397 | 105 | 
  398 | 106 |   try {
  399 | 107 |     console.log("[CFG] Pobieram linki z Google Sheeta...");
  400 | 108 |     const res = await fetch(LINKS_SHEET_URL);
  401 | 109 | 
  402 | 110 |     if (!res.ok) {
  403 | 111 |       console.warn("[CFG] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
  404 | 112 |       return loadLinksFromLocalFile();
  405 | 113 |     }
  406 | 114 | 
  407 | 115 |     const text = await res.text();
  408 | 116 |     const urls = parseCsv(text);
  409 | 117 |     const unique = [...new Set(urls)];
  410 | 118 | 
  411 | 119 |     // backup
  412 | 120 |     const payload = { links: unique };
  413 | 121 |     fs.mkdirSync(path.dirname(LOCAL_FILE), { recursive: true });
  414 | 122 |     fs.writeFileSync(LOCAL_FILE, JSON.stringify(payload, null, 2), "utf8");
  415 | 123 |     console.log("[CFG] Zapisano backup do links.json");
  416 | 124 | 
  417 | 125 |     return unique;
  418 | 126 |   } catch (err) {
  419 | 127 |     console.error("[CFG] B≈ÇƒÖd przy pobieraniu link√≥w z Sheeta:", err.message);
  420 | 128 |     console.warn("[CFG] Pr√≥ba u≈ºycia lokalnego links.json jako fallback");
  421 | 129 |     return loadLinksFromLocalFile();
  422 | 130 |   }
  423 | 131 | }
  424 | 132 | 
  425 | 133 | /* ============================================
  426 | 134 |    Reload z por√≥wnaniem hashy
  427 | 135 |    ============================================ */
  428 | 136 | async function reloadLinks() {
  429 | 137 |   const urls = await fetchLinks();
  430 | 138 |   const hash = calcHash(urls);
  431 | 139 | 
  432 | 140 |   if (hash === lastHash) {
  433 | 141 |     console.log("[CFG] Linki bez zmian (hash taki sam)");
  434 | 142 |     return;
  435 | 143 |   }
  436 | 144 | 
  437 | 145 |   lastHash = hash;
  438 | 146 |   linksCache = urls;
  439 | 147 | 
  440 | 148 |   console.log("[CFG] Zaktualizowane linki:", linksCache);
  441 | 149 | }
  442 | 150 | 
  443 | 151 | /* ============================================
  444 | 152 |    API eksportowane dla reszty programu
  445 | 153 |    ============================================ */
  446 | 154 | export async function initLinks(autoRefreshMs = 0) {
  447 | 155 |   await reloadLinks(); // pierwszy load
  448 | 156 | 
  449 | 157 |   if (autoRefreshMs > 0) {
  450 | 158 |     console.log(
  451 | 159 |       `[CFG] Auto-refresh link√≥w co ${Math.round(autoRefreshMs / 1000)}s`
  452 | 160 |     );
  453 | 161 | 
  454 | 162 |     setInterval(() => {
  455 | 163 |       reloadLinks().catch((err) =>
  456 | 164 |         console.error("[CFG] B≈ÇƒÖd przy auto-refresh link√≥w:", err.message)
  457 | 165 |       );
  458 | 166 |     }, autoRefreshMs);
  459 | 167 |   }
  460 | 168 | }
  461 | 169 | 
  462 | 170 | export function getLinks() {
  463 | 171 |   return linksCache;
  464 | 172 | }
  465 | 173 | 
  466 | ```
  467 | 
  468 | ---
  469 | 
  470 | ### üìÑ ≈öcie≈ºka: `config/links.json`
  471 | **Typ:** JSON  
  472 | **Opis:** Plik projektu (kod/konfiguracja).  
  473 | 
  474 | ```json
  475 | 1 | {
  476 | 2 |   "links": [
  477 | 3 |     "https://www.facebook.com/post1",
  478 | 4 |     "https://www.facebook.com/post2"
  479 | 5 |   ]
  480 | 6 | }
  481 | 7 | 
  482 | ```
  483 | 
  484 | ---
  485 | 
  486 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/config.js`
  487 | **Typ:** JavaScript/tekst  
  488 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
  489 | 
  490 | ```js
  491 |   1 | import "dotenv/config";
  492 |   2 | 
  493 |   3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  494 |   4 | /**
  495 |   5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  496 |   6 |  */
  497 |   7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  498 |   8 | 
  499 |   9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
  500 |  10 | /**
  501 |  11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
  502 |  12 |  * Np.:
  503 |  13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
  504 |  14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
  505 |  15 |  */
  506 |  16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
  507 |  17 | 
  508 |  18 | /**
  509 |  19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
  510 |  20 |  * Np. domy≈õlnie co 5 minut.
  511 |  21 |  */
  512 |  22 | const POSTS_REFRESH_MS = Number(
  513 |  23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
  514 |  24 | );
  515 |  25 | 
  516 |  26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
  517 |  27 | /**
  518 |  28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
  519 |  29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
  520 |  30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
  521 |  31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
  522 |  32 |  */
  523 |  33 | 
  524 |  34 | function getPostsFromEnv() {
  525 |  35 |   const raw = process.env.FB_POST_URLS || "";
  526 |  36 |   const urls = raw
  527 |  37 |     .split(",")
  528 |  38 |     .map((s) => s.trim())
  529 |  39 |     .filter(Boolean);
  530 |  40 | 
  531 |  41 |   return urls.map((url, index) => ({
  532 |  42 |     id: `post${index + 1}`,
  533 |  43 |     url,
  534 |  44 |   }));
  535 |  45 | }
  536 |  46 | 
  537 |  47 | function getPostLabelsFromEnv(posts) {
  538 |  48 |   const raw = process.env.FB_POST_LABELS || "";
  539 |  49 |   const labels = raw.split(",").map((s) => s.trim());
  540 |  50 | 
  541 |  51 |   const map = {};
  542 |  52 |   posts.forEach((post, idx) => {
  543 |  53 |     map[post.id] = labels[idx] || post.id;
  544 |  54 |   });
  545 |  55 |   return map;
  546 |  56 | }
  547 |  57 | 
  548 |  58 | const POSTS = getPostsFromEnv();
  549 |  59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
  550 |  60 | 
  551 |  61 | /**
  552 |  62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
  553 |  63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
  554 |  64 |  * dop√≥ki nie dodasz post√≥w w panelu.
  555 |  65 |  */
  556 |  66 | if (!POSTS.length && !POSTS_SHEET_URL) {
  557 |  67 |   console.warn(
  558 |  68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
  559 |  69 |   );
  560 |  70 | }
  561 |  71 | 
  562 |  72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
  563 |  73 | 
  564 |  74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
  565 |  75 | const EXPAND_COMMENTS =
  566 |  76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
  567 |  77 | 
  568 |  78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
  569 |  79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
  570 |  80 | const USE_UI_HANDLERS =
  571 |  81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
  572 |  82 | 
  573 |  83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
  574 |  84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
  575 |  85 | const INCLUDE_REPLIES =
  576 |  86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
  577 |  87 | 
  578 |  88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
  579 |  89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
  580 |  90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
  581 |  91 | 
  582 |  92 | export {
  583 |  93 |   // stary system ‚Äì optional
  584 |  94 |   POSTS,
  585 |  95 |   POST_LABELS,
  586 |  96 | 
  587 |  97 |   // u≈ºywane przez watcher.js / comments.js
  588 |  98 |   EXPAND_COMMENTS,
  589 |  99 |   USE_UI_HANDLERS,
  590 | 100 |   INCLUDE_REPLIES,
  591 | 101 |   CHECK_INTERVAL_MS,
  592 | 102 | 
  593 | 103 |   // ≈∫r√≥d≈Ça post√≥w
  594 | 104 |   POSTS_JSON_PATH,
  595 | 105 |   POSTS_SHEET_URL,
  596 | 106 |   POSTS_REFRESH_MS,
  597 | 107 | };
  598 | 108 | 
  599 | ```
  600 | 
  601 | ---
  602 | 
  603 | ### üìÑ ≈öcie≈ºka: `export_chat_context/03__config.js`
  604 | **Typ:** JavaScript/tekst  
  605 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
  606 | 
  607 | ```js
  608 |   1 | import "dotenv/config";
  609 |   2 | 
  610 |   3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  611 |   4 | /**
  612 |   5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  613 |   6 |  */
  614 |   7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  615 |   8 | 
  616 |   9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
  617 |  10 | /**
  618 |  11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
  619 |  12 |  * Np.:
  620 |  13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
  621 |  14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
  622 |  15 |  */
  623 |  16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
  624 |  17 | 
  625 |  18 | /**
  626 |  19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
  627 |  20 |  * Np. domy≈õlnie co 5 minut.
  628 |  21 |  */
  629 |  22 | const POSTS_REFRESH_MS = Number(
  630 |  23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
  631 |  24 | );
  632 |  25 | 
  633 |  26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
  634 |  27 | /**
  635 |  28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
  636 |  29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
  637 |  30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
  638 |  31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
  639 |  32 |  */
  640 |  33 | 
  641 |  34 | function getPostsFromEnv() {
  642 |  35 |   const raw = process.env.FB_POST_URLS || "";
  643 |  36 |   const urls = raw
  644 |  37 |     .split(",")
  645 |  38 |     .map((s) => s.trim())
  646 |  39 |     .filter(Boolean);
  647 |  40 | 
  648 |  41 |   return urls.map((url, index) => ({
  649 |  42 |     id: `post${index + 1}`,
  650 |  43 |     url,
  651 |  44 |   }));
  652 |  45 | }
  653 |  46 | 
  654 |  47 | function getPostLabelsFromEnv(posts) {
  655 |  48 |   const raw = process.env.FB_POST_LABELS || "";
  656 |  49 |   const labels = raw.split(",").map((s) => s.trim());
  657 |  50 | 
  658 |  51 |   const map = {};
  659 |  52 |   posts.forEach((post, idx) => {
  660 |  53 |     map[post.id] = labels[idx] || post.id;
  661 |  54 |   });
  662 |  55 |   return map;
  663 |  56 | }
  664 |  57 | 
  665 |  58 | const POSTS = getPostsFromEnv();
  666 |  59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
  667 |  60 | 
  668 |  61 | /**
  669 |  62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
  670 |  63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
  671 |  64 |  * dop√≥ki nie dodasz post√≥w w panelu.
  672 |  65 |  */
  673 |  66 | if (!POSTS.length && !POSTS_SHEET_URL) {
  674 |  67 |   console.warn(
  675 |  68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
  676 |  69 |   );
  677 |  70 | }
  678 |  71 | 
  679 |  72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
  680 |  73 | 
  681 |  74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
  682 |  75 | const EXPAND_COMMENTS =
  683 |  76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
  684 |  77 | 
  685 |  78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
  686 |  79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
  687 |  80 | const USE_UI_HANDLERS =
  688 |  81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
  689 |  82 | 
  690 |  83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
  691 |  84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
  692 |  85 | const INCLUDE_REPLIES =
  693 |  86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
  694 |  87 | 
  695 |  88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
  696 |  89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
  697 |  90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
  698 |  91 | 
  699 |  92 | export {
  700 |  93 |   // stary system ‚Äì optional
  701 |  94 |   POSTS,
  702 |  95 |   POST_LABELS,
  703 |  96 | 
  704 |  97 |   // u≈ºywane przez watcher.js / comments.js
  705 |  98 |   EXPAND_COMMENTS,
  706 |  99 |   USE_UI_HANDLERS,
  707 | 100 |   INCLUDE_REPLIES,
  708 | 101 |   CHECK_INTERVAL_MS,
  709 | 102 | 
  710 | 103 |   // ≈∫r√≥d≈Ça post√≥w
  711 | 104 |   POSTS_JSON_PATH,
  712 | 105 |   POSTS_SHEET_URL,
  713 | 106 |   POSTS_REFRESH_MS,
  714 | 107 | };
  715 | 108 | 
  716 | ```
  717 | 
  718 | ---
  719 | 
  720 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/config.js`
  721 | **Typ:** JavaScript/tekst  
  722 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
  723 | 
  724 | ```js
  725 |   1 | import "dotenv/config";
  726 |   2 | 
  727 |   3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  728 |   4 | /**
  729 |   5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  730 |   6 |  */
  731 |   7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  732 |   8 | 
  733 |   9 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
  734 |  10 | /**
  735 |  11 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
  736 |  12 |  * Np.:
  737 |  13 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
  738 |  14 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
  739 |  15 |  */
  740 |  16 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
  741 |  17 | 
  742 |  18 | /**
  743 |  19 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
  744 |  20 |  * Np. domy≈õlnie co 5 minut.
  745 |  21 |  */
  746 |  22 | const POSTS_REFRESH_MS = Number(
  747 |  23 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
  748 |  24 | );
  749 |  25 | 
  750 |  26 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
  751 |  27 | /**
  752 |  28 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
  753 |  29 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
  754 |  30 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
  755 |  31 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
  756 |  32 |  */
  757 |  33 | 
  758 |  34 | function getPostsFromEnv() {
  759 |  35 |   const raw = process.env.FB_POST_URLS || "";
  760 |  36 |   const urls = raw
  761 |  37 |     .split(",")
  762 |  38 |     .map((s) => s.trim())
  763 |  39 |     .filter(Boolean);
  764 |  40 | 
  765 |  41 |   return urls.map((url, index) => ({
  766 |  42 |     id: `post${index + 1}`,
  767 |  43 |     url,
  768 |  44 |   }));
  769 |  45 | }
  770 |  46 | 
  771 |  47 | function getPostLabelsFromEnv(posts) {
  772 |  48 |   const raw = process.env.FB_POST_LABELS || "";
  773 |  49 |   const labels = raw.split(",").map((s) => s.trim());
  774 |  50 | 
  775 |  51 |   const map = {};
  776 |  52 |   posts.forEach((post, idx) => {
  777 |  53 |     map[post.id] = labels[idx] || post.id;
  778 |  54 |   });
  779 |  55 |   return map;
  780 |  56 | }
  781 |  57 | 
  782 |  58 | const POSTS = getPostsFromEnv();
  783 |  59 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
  784 |  60 | 
  785 |  61 | /**
  786 |  62 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
  787 |  63 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
  788 |  64 |  * dop√≥ki nie dodasz post√≥w w panelu.
  789 |  65 |  */
  790 |  66 | if (!POSTS.length && !POSTS_SHEET_URL) {
  791 |  67 |   console.warn(
  792 |  68 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
  793 |  69 |   );
  794 |  70 | }
  795 |  71 | 
  796 |  72 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
  797 |  73 | 
  798 |  74 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
  799 |  75 | const EXPAND_COMMENTS =
  800 |  76 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
  801 |  77 | 
  802 |  78 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
  803 |  79 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
  804 |  80 | const USE_UI_HANDLERS =
  805 |  81 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
  806 |  82 | 
  807 |  83 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
  808 |  84 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
  809 |  85 | const INCLUDE_REPLIES =
  810 |  86 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
  811 |  87 | 
  812 |  88 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
  813 |  89 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
  814 |  90 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
  815 |  91 | 
  816 |  92 | export {
  817 |  93 |   // stary system ‚Äì optional
  818 |  94 |   POSTS,
  819 |  95 |   POST_LABELS,
  820 |  96 | 
  821 |  97 |   // u≈ºywane przez watcher.js / comments.js
  822 |  98 |   EXPAND_COMMENTS,
  823 |  99 |   USE_UI_HANDLERS,
  824 | 100 |   INCLUDE_REPLIES,
  825 | 101 |   CHECK_INTERVAL_MS,
  826 | 102 | 
  827 | 103 |   // ≈∫r√≥d≈Ça post√≥w
  828 | 104 |   POSTS_JSON_PATH,
  829 | 105 |   POSTS_SHEET_URL,
  830 | 106 |   POSTS_REFRESH_MS,
  831 | 107 | };
  832 | 108 | 
  833 | ```
  834 | 
  835 | ---
  836 | 
  837 | ### üìÑ ≈öcie≈ºka: `src/config.js`
  838 | **Typ:** JavaScript/tekst  
  839 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
  840 | 
  841 | ```js
  842 |   1 | import "dotenv/config";
  843 |   2 | 
  844 |   3 | /* ==================== PANEL ‚Äì NOWY SYSTEM ==================== */
  845 |   4 | /**
  846 |   5 |  * POSTS_JSON_PATH ‚Äì ≈õcie≈ºka do pliku z postami zarzƒÖdzanymi przez panel (domy≈õlnie data/posts.json)
  847 |   6 |  */
  848 |   7 | const POSTS_JSON_PATH = process.env.POSTS_JSON_PATH || "data/posts.json";
  849 |   8 | 
  850 |   9 | /* ==================== PANEL API ‚Äì ZDALNE POSTY ==================== */
  851 |  10 | /**
  852 |  11 |  * POSTS_API_URL ‚Äì URL do API panelu (endpoint GET /api/posts)
  853 |  12 |  * Np.: POSTS_API_URL=http://twoj-serwer:3180/api/posts
  854 |  13 |  * Je≈õli ustawione, watcher pobiera posty z panelu przez HTTP (priorytet nad plikiem i Sheets)
  855 |  14 |  */
  856 |  15 | const POSTS_API_URL = (process.env.POSTS_API_URL || "").trim();
  857 |  16 | 
  858 |  17 | /**
  859 |  18 |  * POSTS_API_TOKEN ‚Äì Bearer token do autoryzacji API panelu
  860 |  19 |  * Musi byƒá taki sam jak PANEL_TOKEN na serwerze
  861 |  20 |  */
  862 |  21 | const POSTS_API_TOKEN = (process.env.POSTS_API_TOKEN || "").trim();
  863 |  22 | 
  864 |  23 | /* ==================== GOOGLE SHEETS ‚Äì NOWY SYSTEM ==================== */
  865 |  24 | /**
  866 |  25 |  * POSTS_SHEET_URL ‚Äì URL do opublikowanego jako CSV arkusza z postami.
  867 |  26 |  * Np.:
  868 |  27 |  *  - w Google Sheets: Plik ‚Üí Opublikuj w internecie ‚Üí CSV
  869 |  28 |  *  - w .env: POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/....../pub?output=csv
  870 |  29 |  */
  871 |  30 | const POSTS_SHEET_URL = process.env.POSTS_SHEET_URL || "";
  872 |  31 | 
  873 |  32 | /**
  874 |  33 |  * POSTS_REFRESH_MS ‚Äì co ile MILISEKUND watcher ma od≈õwie≈ºaƒá listƒô post√≥w (panel/sheets).
  875 |  34 |  * Np. domy≈õlnie co 5 minut.
  876 |  35 |  */
  877 |  36 | const POSTS_REFRESH_MS = Number(
  878 |  37 |   process.env.POSTS_REFRESH_MS || 5 * 60 * 1000
  879 |  38 | );
  880 |  39 | 
  881 |  40 | /* ==================== STARY SYSTEM Z ENV (opcjonalny) ==================== */
  882 |  41 | /**
  883 |  42 |  * FB_POST_URLS = url1,url2,url3  (opcjonalne)
  884 |  43 |  * FB_POST_LABELS = nazwa1,nazwa2,nazwa3 (opcjonalne)
  885 |  44 |  * ‚Äì tego teraz nie u≈ºywa watcher, ale zostawiamy, ≈ºeby nic siƒô nie wysypa≈Ço,
  886 |  45 |  *   jakby≈õ kiedy≈õ chcia≈Ç to jeszcze wykorzystaƒá.
  887 |  46 |  */
  888 |  47 | 
  889 |  48 | function getPostsFromEnv() {
  890 |  49 |   const raw = process.env.FB_POST_URLS || "";
  891 |  50 |   const urls = raw
  892 |  51 |     .split(",")
  893 |  52 |     .map((s) => s.trim())
  894 |  53 |     .filter(Boolean);
  895 |  54 | 
  896 |  55 |   return urls.map((url, index) => ({
  897 |  56 |     id: `post${index + 1}`,
  898 |  57 |     url,
  899 |  58 |   }));
  900 |  59 | }
  901 |  60 | 
  902 |  61 | function getPostLabelsFromEnv(posts) {
  903 |  62 |   const raw = process.env.FB_POST_LABELS || "";
  904 |  63 |   const labels = raw.split(",").map((s) => s.trim());
  905 |  64 | 
  906 |  65 |   const map = {};
  907 |  66 |   posts.forEach((post, idx) => {
  908 |  67 |     map[post.id] = labels[idx] || post.id;
  909 |  68 |   });
  910 |  69 |   return map;
  911 |  70 | }
  912 |  71 | 
  913 |  72 | const POSTS = getPostsFromEnv();
  914 |  73 | const POST_LABELS = getPostLabelsFromEnv(POSTS);
  915 |  74 | 
  916 |  75 | /**
  917 |  76 |  * UWAGA: Przy panelu (posts.json) brak ≈∫r√≥de≈Ç jest normalny na start.
  918 |  77 |  * Nie robimy twardego exit ‚Äî watcher ma ≈ºyƒá i po prostu nie monitorowaƒá niczego,
  919 |  78 |  * dop√≥ki nie dodasz post√≥w w panelu.
  920 |  79 |  */
  921 |  80 | if (!POSTS.length && !POSTS_SHEET_URL) {
  922 |  81 |   console.warn(
  923 |  82 |     "[CONFIG] Brak FB_POST_URLS i POSTS_SHEET_URL. Je≈õli u≈ºywasz panelu, dodaj posty w data/posts.json. Watcher bƒôdzie dzia≈Ça≈Ç, ale nie ma co monitorowaƒá."
  924 |  83 |   );
  925 |  84 | }
  926 |  85 | 
  927 |  86 | /* ==================== OG√ìLNE OPCJE WATCHERA ==================== */
  928 |  87 | 
  929 |  88 | // EXPAND_COMMENTS=false ‚Üí tylko licznik komentarzy
  930 |  89 | const EXPAND_COMMENTS =
  931 |  90 |   process.env.EXPAND_COMMENTS === "false" ? false : true;
  932 |  91 | 
  933 |  92 | // NOWE: prze≈ÇƒÖcznik refaktoru UI handlers
  934 |  93 | // USE_UI_HANDLERS=false ‚Üí jedzie legacy
  935 |  94 | const USE_UI_HANDLERS =
  936 |  95 |   process.env.USE_UI_HANDLERS === "false" ? false : true;
  937 |  96 | 
  938 |  97 | // NOWE: prze≈ÇƒÖcznik rozwijania odpowiedzi (replies)
  939 |  98 | // INCLUDE_REPLIES=false ‚Üí nie klikamy "Wy≈õwietl X odpowiedzi / replies"
  940 |  99 | const INCLUDE_REPLIES =
  941 | 100 |   process.env.INCLUDE_REPLIES === "false" ? false : true;
  942 | 101 | 
  943 | 102 | // co ile sekund lecimy po postach (podstawowy interwa≈Ç)
  944 | 103 | // mo≈ºna nadpisaƒá w .env: CHECK_INTERVAL_MS=60000
  945 | 104 | const CHECK_INTERVAL_MS = Number(process.env.CHECK_INTERVAL_MS || 60000);
  946 | 105 | 
  947 | 106 | // FAST_MODE: szybki tryb - sortowanie "Najnowsze", bez loadAllComments
  948 | 107 | // FAST_MODE=true w≈ÇƒÖcza, domy≈õlnie false (stabilny tryb dedup)
  949 | 108 | const FAST_MODE = process.env.FAST_MODE === "true";
  950 | 109 | 
  951 | 110 | // FAST_MAX_AGE_MIN: limit wieku komentarzy w FAST_MODE (minuty)
  952 | 111 | // Komentarze starsze ni≈º limit ‚Üí skip posta (je≈õli sort=Najnowsze)
  953 | 112 | const FAST_MAX_AGE_MIN = Number(process.env.FAST_MAX_AGE_MIN || 180);
  954 | 113 | 
  955 | 114 | /* ==================== LOGOWANIE ==================== */
  956 | 115 | /**
  957 | 116 |  * LOG_LEVEL ‚Äì poziom szczeg√≥≈Çowo≈õci log√≥w:
  958 | 117 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
  959 | 118 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny, do pracy na serwerze)
  960 | 119 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings (do pracy przy kodzie)
  961 | 120 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info (hard debug)
  962 | 121 |  *
  963 | 122 |  * LOG_TIMESTAMPS ‚Äì czy dodawaƒá [HH:MM:SS] prefix (domy≈õlnie true)
  964 | 123 |  * LOG_COLORS ‚Äì czy kolorowaƒá logi w konsoli (domy≈õlnie true)
  965 | 124 |  */
  966 | 125 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
  967 | 126 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
  968 | 127 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
  969 | 128 | 
  970 | 129 | /* ==================== CAPTCHA SOLVER ==================== */
  971 | 130 | /**
  972 | 131 |  * CAPTCHA_API_KEY ‚Äì klucz API do 2Captcha
  973 | 132 |  * U≈ºywany do automatycznego rozwiƒÖzywania captcha przy logowaniu
  974 | 133 |  */
  975 | 134 | const CAPTCHA_API_KEY = (process.env.CAPTCHA_API_KEY || "").trim();
  976 | 135 | 
  977 | 136 | /**
  978 | 137 |  * CAPTCHA_ENABLED ‚Äì czy w≈ÇƒÖczyƒá automatyczne rozwiƒÖzywanie captcha
  979 | 138 |  * Domy≈õlnie: true je≈õli CAPTCHA_API_KEY jest ustawiony
  980 | 139 |  */
  981 | 140 | const CAPTCHA_ENABLED = process.env.CAPTCHA_ENABLED !== "false" && !!CAPTCHA_API_KEY;
  982 | 141 | 
  983 | 142 | /* ==================== REMOTE DEBUG ==================== */
  984 | 143 | /**
  985 | 144 |  * REMOTE_DEBUG_PORT ‚Äì port do zdalnego debugowania Chrome
  986 | 145 |  * Gdy ustawiony, mo≈ºesz pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
  987 | 146 |  * i widzieƒá/kontrolowaƒá przeglƒÖdarkƒô na ≈ºywo (2FA, checkpoint)
  988 | 147 |  *
  989 | 148 |  * U≈ºycie:
  990 | 149 |  *   1. REMOTE_DEBUG_PORT=9222 node src/index.js
  991 | 150 |  *   2. SSH tunel: ssh -L 9222:localhost:9222 user@server
  992 | 151 |  *   3. W Chrome: chrome://inspect ‚Üí Configure ‚Üí localhost:9222
  993 | 152 |  */
  994 | 153 | const REMOTE_DEBUG_PORT = Number(process.env.REMOTE_DEBUG_PORT || 0);
  995 | 154 | 
  996 | 155 | /* ==================== HUMAN BEHAVIOR MODE ==================== */
  997 | 156 | /**
  998 | 157 |  * HUMAN_MODE ‚Äì w≈ÇƒÖcza symulacjƒô zachowa≈Ñ cz≈Çowieka
  999 | 158 |  * - Wolniejsze wpisywanie (~120ms/znak zamiast 35ms)
 1000 | 159 |  * - Losowa kolejno≈õƒá post√≥w
 1001 | 160 |  * - Pauzy miƒôdzy postami (3-8 sekund)
 1002 | 161 |  * Domy≈õlnie: true
 1003 | 162 |  */
 1004 | 163 | const HUMAN_MODE = process.env.HUMAN_MODE !== "false";
 1005 | 164 | 
 1006 | 165 | /**
 1007 | 166 |  * PROXY_URL ‚Äì URL do proxy HTTP/SOCKS5
 1008 | 167 |  * Format: http://user:pass@host:port lub socks5://host:port
 1009 | 168 |  * Zalecane: residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
 1010 | 169 |  */
 1011 | 170 | const PROXY_URL = (process.env.PROXY_URL || "").trim();
 1012 | 171 | 
 1013 | 172 | export {
 1014 | 173 |   // stary system ‚Äì optional
 1015 | 174 |   POSTS,
 1016 | 175 |   POST_LABELS,
 1017 | 176 | 
 1018 | 177 |   // u≈ºywane przez watcher.js / comments.js
 1019 | 178 |   EXPAND_COMMENTS,
 1020 | 179 |   USE_UI_HANDLERS,
 1021 | 180 |   INCLUDE_REPLIES,
 1022 | 181 |   CHECK_INTERVAL_MS,
 1023 | 182 | 
 1024 | 183 |   // FAST_MODE
 1025 | 184 |   FAST_MODE,
 1026 | 185 |   FAST_MAX_AGE_MIN,
 1027 | 186 | 
 1028 | 187 |   // ≈∫r√≥d≈Ça post√≥w
 1029 | 188 |   POSTS_JSON_PATH,
 1030 | 189 |   POSTS_SHEET_URL,
 1031 | 190 |   POSTS_REFRESH_MS,
 1032 | 191 |   POSTS_API_URL,
 1033 | 192 |   POSTS_API_TOKEN,
 1034 | 193 | 
 1035 | 194 |   // logowanie
 1036 | 195 |   LOG_LEVEL,
 1037 | 196 |   LOG_TIMESTAMPS,
 1038 | 197 |   LOG_COLORS,
 1039 | 198 | 
 1040 | 199 |   // captcha solver
 1041 | 200 |   CAPTCHA_API_KEY,
 1042 | 201 |   CAPTCHA_ENABLED,
 1043 | 202 | 
 1044 | 203 |   // remote debug
 1045 | 204 |   REMOTE_DEBUG_PORT,
 1046 | 205 | 
 1047 | 206 |   // human behavior mode
 1048 | 207 |   HUMAN_MODE,
 1049 | 208 |   PROXY_URL,
 1050 | 209 | };
 1051 | 210 | 
 1052 | ```
 1053 | 
 1054 | ---
 1055 | 
 1056 | ### üìÑ ≈öcie≈ºka: `src/panel/web/postcss.config.js`
 1057 | **Typ:** JavaScript/tekst  
 1058 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
 1059 | 
 1060 | ```js
 1061 | 1 | export default {
 1062 | 2 |   plugins: {
 1063 | 3 |     tailwindcss: {},
 1064 | 4 |     autoprefixer: {},
 1065 | 5 |   },
 1066 | 6 | }
 1067 | 7 | 
 1068 | ```
 1069 | 
 1070 | ---
 1071 | 
 1072 | ### üìÑ ≈öcie≈ºka: `src/panel/web/tailwind.config.js`
 1073 | **Typ:** JavaScript/tekst  
 1074 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
 1075 | 
 1076 | ```js
 1077 |  1 | /** @type {import('tailwindcss').Config} */
 1078 |  2 | export default {
 1079 |  3 |   darkMode: 'class',
 1080 |  4 |   content: [
 1081 |  5 |     './index.html',
 1082 |  6 |     './src/**/*.{js,ts,jsx,tsx}',
 1083 |  7 |   ],
 1084 |  8 |   theme: {
 1085 |  9 |     extend: {
 1086 | 10 |       colors: {
 1087 | 11 |         border: 'hsl(var(--border))',
 1088 | 12 |         input: 'hsl(var(--input))',
 1089 | 13 |         ring: 'hsl(var(--ring))',
 1090 | 14 |         background: 'hsl(var(--background))',
 1091 | 15 |         foreground: 'hsl(var(--foreground))',
 1092 | 16 |         primary: {
 1093 | 17 |           DEFAULT: 'hsl(var(--primary))',
 1094 | 18 |           foreground: 'hsl(var(--primary-foreground))',
 1095 | 19 |         },
 1096 | 20 |         secondary: {
 1097 | 21 |           DEFAULT: 'hsl(var(--secondary))',
 1098 | 22 |           foreground: 'hsl(var(--secondary-foreground))',
 1099 | 23 |         },
 1100 | 24 |         destructive: {
 1101 | 25 |           DEFAULT: 'hsl(var(--destructive))',
 1102 | 26 |           foreground: 'hsl(var(--destructive-foreground))',
 1103 | 27 |         },
 1104 | 28 |         muted: {
 1105 | 29 |           DEFAULT: 'hsl(var(--muted))',
 1106 | 30 |           foreground: 'hsl(var(--muted-foreground))',
 1107 | 31 |         },
 1108 | 32 |         accent: {
 1109 | 33 |           DEFAULT: 'hsl(var(--accent))',
 1110 | 34 |           foreground: 'hsl(var(--accent-foreground))',
 1111 | 35 |         },
 1112 | 36 |         popover: {
 1113 | 37 |           DEFAULT: 'hsl(var(--popover))',
 1114 | 38 |           foreground: 'hsl(var(--popover-foreground))',
 1115 | 39 |         },
 1116 | 40 |         card: {
 1117 | 41 |           DEFAULT: 'hsl(var(--card))',
 1118 | 42 |           foreground: 'hsl(var(--card-foreground))',
 1119 | 43 |         },
 1120 | 44 |       },
 1121 | 45 |       borderRadius: {
 1122 | 46 |         lg: 'var(--radius)',
 1123 | 47 |         md: 'calc(var(--radius) - 2px)',
 1124 | 48 |         sm: 'calc(var(--radius) - 4px)',
 1125 | 49 |       },
 1126 | 50 |     },
 1127 | 51 |   },
 1128 | 52 |   plugins: [],
 1129 | 53 | }
 1130 | 54 | 
 1131 | ```
 1132 | 
 1133 | ---
 1134 | 
 1135 | ### üìÑ ≈öcie≈ºka: `src/panel/web/tsconfig.json`
 1136 | **Typ:** JSON  
 1137 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
 1138 | 
 1139 | ```json
 1140 |  1 | {
 1141 |  2 |   "compilerOptions": {
 1142 |  3 |     "target": "ES2020",
 1143 |  4 |     "useDefineForClassFields": true,
 1144 |  5 |     "lib": ["ES2020", "DOM", "DOM.Iterable"],
 1145 |  6 |     "module": "ESNext",
 1146 |  7 |     "skipLibCheck": true,
 1147 |  8 | 
 1148 |  9 |     "moduleResolution": "bundler",
 1149 | 10 |     "allowImportingTsExtensions": true,
 1150 | 11 |     "isolatedModules": true,
 1151 | 12 |     "moduleDetection": "force",
 1152 | 13 |     "noEmit": true,
 1153 | 14 |     "jsx": "react-jsx",
 1154 | 15 | 
 1155 | 16 |     "strict": true,
 1156 | 17 |     "noUnusedLocals": true,
 1157 | 18 |     "noUnusedParameters": true,
 1158 | 19 |     "noFallthroughCasesInSwitch": true,
 1159 | 20 |     "noUncheckedSideEffectImports": true,
 1160 | 21 | 
 1161 | 22 |     "baseUrl": ".",
 1162 | 23 |     "paths": {
 1163 | 24 |       "@/*": ["./src/*"]
 1164 | 25 |     }
 1165 | 26 |   },
 1166 | 27 |   "include": ["src"]
 1167 | 28 | }
 1168 | 29 | 
 1169 | ```
 1170 | 
 1171 | ---
 1172 | 
 1173 | ### üìÑ ≈öcie≈ºka: `src/panel/web/vite.config.ts`
 1174 | **Typ:** TypeScript  
 1175 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
 1176 | 
 1177 | ```ts
 1178 |  1 | import { defineConfig } from 'vite'
 1179 |  2 | import react from '@vitejs/plugin-react'
 1180 |  3 | import path from 'path'
 1181 |  4 | 
 1182 |  5 | export default defineConfig({
 1183 |  6 |   plugins: [react()],
 1184 |  7 |   base: '/new/',
 1185 |  8 |   resolve: {
 1186 |  9 |     alias: {
 1187 | 10 |       '@': path.resolve(__dirname, './src'),
 1188 | 11 |     },
 1189 | 12 |   },
 1190 | 13 |   server: {
 1191 | 14 |     port: 5173,
 1192 | 15 |     proxy: {
 1193 | 16 |       '/api': {
 1194 | 17 |         target: 'http://localhost:3180',
 1195 | 18 |         changeOrigin: true,
 1196 | 19 |       },
 1197 | 20 |     },
 1198 | 21 |   },
 1199 | 22 |   build: {
 1200 | 23 |     outDir: 'dist',
 1201 | 24 |     emptyOutDir: true,
 1202 | 25 |   },
 1203 | 26 | })
 1204 | 27 | 
 1205 | ```
 1206 | 
 1207 | ---
 1208 | 
 1209 | ### üìÑ ≈öcie≈ºka: `src/db/cache.js`
 1210 | **Typ:** JavaScript/tekst  
 1211 | **Opis:** Plik projektu (kod/konfiguracja).  
 1212 | 
 1213 | ```js
 1214 |   1 | // src/db/cache.js
 1215 |   2 | import fs from "fs";
 1216 |   3 | import path from "path";
 1217 |   4 | import log from "../utils/logger.js";
 1218 |   5 | 
 1219 |   6 | const DATA_DIR = "./data";
 1220 |   7 | const FILE = path.join(DATA_DIR, "comments-cache.json");
 1221 |   8 | 
 1222 |   9 | /**
 1223 |  10 |  * Upewnia siƒô, ≈ºe istnieje katalog ./data
 1224 |  11 |  */
 1225 |  12 | function ensureDir() {
 1226 |  13 |   if (!fs.existsSync(DATA_DIR)) {
 1227 |  14 |     fs.mkdirSync(DATA_DIR, { recursive: true });
 1228 |  15 |   }
 1229 |  16 | }
 1230 |  17 | 
 1231 |  18 | export function loadCache() {
 1232 |  19 |   try {
 1233 |  20 |     ensureDir();
 1234 |  21 |     if (!fs.existsSync(FILE)) return {};
 1235 |  22 |     const raw = fs.readFileSync(FILE, "utf8");
 1236 |  23 |     if (!raw.trim()) return {};
 1237 |  24 |     return JSON.parse(raw);
 1238 |  25 |   } catch (e) {
 1239 |  26 |     log.warn("CACHE", `B≈ÇƒÖd ≈Çadowania: ${e.message}`);
 1240 |  27 | 
 1241 |  28 |     // Pr√≥ba odczytu backup je≈õli g≈Ç√≥wny plik uszkodzony
 1242 |  29 |     const backupFile = FILE + ".backup";
 1243 |  30 |     if (fs.existsSync(backupFile)) {
 1244 |  31 |       try {
 1245 |  32 |         const backupRaw = fs.readFileSync(backupFile, "utf8");
 1246 |  33 |         if (backupRaw.trim()) {
 1247 |  34 |           log.warn("CACHE", "Odtworzono z backup");
 1248 |  35 |           return JSON.parse(backupRaw);
 1249 |  36 |         }
 1250 |  37 |       } catch (backupErr) {
 1251 |  38 |         log.warn("CACHE", `B≈ÇƒÖd odczytu backup: ${backupErr.message}`);
 1252 |  39 |       }
 1253 |  40 |     }
 1254 |  41 | 
 1255 |  42 |     return {};
 1256 |  43 |   }
 1257 |  44 | }
 1258 |  45 | 
 1259 |  46 | /**
 1260 |  47 |  * Atomic write - zapisuje do pliku tymczasowego, potem rename.
 1261 |  48 |  * Zapobiega uszkodzeniu cache przy przerwaniu procesu.
 1262 |  49 |  */
 1263 |  50 | export function saveCache(cache) {
 1264 |  51 |   try {
 1265 |  52 |     ensureDir();
 1266 |  53 | 
 1267 |  54 |     const tmpFile = path.join(DATA_DIR, `.comments-cache.${Date.now()}.tmp`);
 1268 |  55 |     const content = JSON.stringify(cache, null, 2);
 1269 |  56 | 
 1270 |  57 |     // 1. Zapisz do pliku tymczasowego
 1271 |  58 |     fs.writeFileSync(tmpFile, content, "utf8");
 1272 |  59 | 
 1273 |  60 |     // 2. Utw√≥rz backup aktualnego pliku (je≈õli istnieje)
 1274 |  61 |     if (fs.existsSync(FILE)) {
 1275 |  62 |       try {
 1276 |  63 |         fs.copyFileSync(FILE, FILE + ".backup");
 1277 |  64 |       } catch {
 1278 |  65 |         // Ignoruj b≈ÇƒÖd backup - nie krytyczny
 1279 |  66 |       }
 1280 |  67 |     }
 1281 |  68 | 
 1282 |  69 |     // 3. Atomic rename (atomowa operacja na wiƒôkszo≈õci system√≥w plik√≥w)
 1283 |  70 |     fs.renameSync(tmpFile, FILE);
 1284 |  71 | 
 1285 |  72 |   } catch (e) {
 1286 |  73 |     log.warn("CACHE", `B≈ÇƒÖd zapisu: ${e.message}`);
 1287 |  74 | 
 1288 |  75 |     // Spr√≥buj usunƒÖƒá plik tmp je≈õli zosta≈Ç
 1289 |  76 |     try {
 1290 |  77 |       const tmpPattern = path.join(DATA_DIR, ".comments-cache.*.tmp");
 1291 |  78 |       const files = fs.readdirSync(DATA_DIR);
 1292 |  79 |       for (const f of files) {
 1293 |  80 |         if (f.startsWith(".comments-cache.") && f.endsWith(".tmp")) {
 1294 |  81 |           fs.unlinkSync(path.join(DATA_DIR, f));
 1295 |  82 |         }
 1296 |  83 |       }
 1297 |  84 |     } catch {
 1298 |  85 |       // Ignoruj b≈Çƒôdy cleanup
 1299 |  86 |     }
 1300 |  87 |   }
 1301 |  88 | }
 1302 |  89 | 
 1303 |  90 | /**
 1304 |  91 |  * Zwraca rozmiar cache w bajtach (dla monitoringu)
 1305 |  92 |  */
 1306 |  93 | export function getCacheSize() {
 1307 |  94 |   try {
 1308 |  95 |     if (!fs.existsSync(FILE)) return 0;
 1309 |  96 |     const stats = fs.statSync(FILE);
 1310 |  97 |     return stats.size;
 1311 |  98 |   } catch {
 1312 |  99 |     return 0;
 1313 | 100 |   }
 1314 | 101 | }
 1315 | 102 | 
 1316 | 103 | /**
 1317 | 104 |  * Zwraca liczbƒô wpis√≥w w cache (dla monitoringu)
 1318 | 105 |  */
 1319 | 106 | export function getCacheEntryCount() {
 1320 | 107 |   try {
 1321 | 108 |     if (!fs.existsSync(FILE)) return 0;
 1322 | 109 |     const raw = fs.readFileSync(FILE, "utf8");
 1323 | 110 |     if (!raw.trim()) return 0;
 1324 | 111 |     const data = JSON.parse(raw);
 1325 | 112 |     return Object.keys(data).length;
 1326 | 113 |   } catch {
 1327 | 114 |     return 0;
 1328 | 115 |   }
 1329 | 116 | }
 1330 | 117 | 
 1331 | ```
 1332 | 
 1333 | ---
 1334 | 
 1335 | ### üìÑ ≈öcie≈ºka: `src/fb/checkpoint.js`
 1336 | **Typ:** JavaScript/tekst  
 1337 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 1338 | 
 1339 | ```js
 1340 |   1 | // src/fb/checkpoint.js
 1341 |   2 | import log from "../utils/logger.js";
 1342 |   3 | 
 1343 |   4 | /**
 1344 |   5 |  * Wykrywanie i obs≈Çuga checkpoint√≥w/2FA Facebooka
 1345 |   6 |  */
 1346 |   7 | 
 1347 |   8 | // URL patterns wskazujƒÖce na checkpoint/2FA
 1348 |   9 | const CHECKPOINT_URL_PATTERNS = [
 1349 |  10 |   "/checkpoint/",
 1350 |  11 |   "/two_factor/",
 1351 |  12 |   "/login/identify",
 1352 |  13 |   "/recover/initiate",
 1353 |  14 |   "/login/device-based/",
 1354 |  15 |   "/checkpoint/block/",
 1355 |  16 |   "/checkpoint/601/",
 1356 |  17 | ];
 1357 |  18 | 
 1358 |  19 | // DOM selektory wskazujƒÖce na checkpoint/2FA
 1359 |  20 | const CHECKPOINT_DOM_SELECTORS = [
 1360 |  21 |   // 2FA
 1361 |  22 |   'input[name="approvals_code"]',
 1362 |  23 |   'input[autocomplete="one-time-code"]',
 1363 |  24 |   'form[id*="two_factor"]',
 1364 |  25 |   // Checkpoint
 1365 |  26 |   '[data-testid="checkpoint_container"]',
 1366 |  27 |   'form[action*="checkpoint"]',
 1367 |  28 |   // Weryfikacja konta
 1368 |  29 |   'input[name="captcha_response"]',
 1369 |  30 |   '[role="dialog"][aria-label*="weryfikacja"]',
 1370 |  31 |   '[role="dialog"][aria-label*="verification"]',
 1371 |  32 |   // Podejrzana aktywno≈õƒá
 1372 |  33 |   'div[data-testid="login_challenge"]',
 1373 |  34 | ];
 1374 |  35 | 
 1375 |  36 | // Teksty wskazujƒÖce na checkpoint (polskie i angielskie)
 1376 |  37 | const CHECKPOINT_TEXT_PATTERNS = [
 1377 |  38 |   "wprowad≈∫ kod",
 1378 |  39 |   "enter code",
 1379 |  40 |   "two-factor",
 1380 |  41 |   "dwuetapow",
 1381 |  42 |   "weryfikacja",
 1382 |  43 |   "verification required",
 1383 |  44 |   "suspicious activity",
 1384 |  45 |   "podejrzana aktywno≈õƒá",
 1385 |  46 |   "confirm your identity",
 1386 |  47 |   "potwierd≈∫ swojƒÖ to≈ºsamo≈õƒá",
 1387 |  48 |   "potwierd≈∫, ≈ºe to ty",
 1388 |  49 |   "we need to confirm",
 1389 |  50 |   "security check",
 1390 |  51 |   "sprawdzenie zabezpiecze≈Ñ",
 1391 |  52 |   "account verification",
 1392 |  53 |   "weryfikacja konta",
 1393 |  54 |   "enter the code",
 1394 |  55 |   "wpisz kod",
 1395 |  56 |   "approve your login",
 1396 |  57 |   "zatwierd≈∫ logowanie",
 1397 |  58 | ];
 1398 |  59 | 
 1399 |  60 | /**
 1400 |  61 |  * Sprawdza czy URL wskazuje na checkpoint
 1401 |  62 |  */
 1402 |  63 | function isCheckpointUrl(url) {
 1403 |  64 |   if (!url) return false;
 1404 |  65 |   const lower = url.toLowerCase();
 1405 |  66 |   return CHECKPOINT_URL_PATTERNS.some((p) => lower.includes(p));
 1406 |  67 | }
 1407 |  68 | 
 1408 |  69 | /**
 1409 |  70 |  * Sprawdza czy strona zawiera elementy checkpoint/2FA
 1410 |  71 |  */
 1411 |  72 | async function hasCheckpointElements(page) {
 1412 |  73 |   try {
 1413 |  74 |     const result = await page.evaluate((selectors) => {
 1414 |  75 |       for (const sel of selectors) {
 1415 |  76 |         if (document.querySelector(sel)) return true;
 1416 |  77 |       }
 1417 |  78 |       return false;
 1418 |  79 |     }, CHECKPOINT_DOM_SELECTORS);
 1419 |  80 |     return result;
 1420 |  81 |   } catch {
 1421 |  82 |     return false;
 1422 |  83 |   }
 1423 |  84 | }
 1424 |  85 | 
 1425 |  86 | /**
 1426 |  87 |  * Sprawdza czy strona zawiera tekst wskazujƒÖcy na checkpoint
 1427 |  88 |  */
 1428 |  89 | async function hasCheckpointText(page) {
 1429 |  90 |   try {
 1430 |  91 |     const result = await page.evaluate((patterns) => {
 1431 |  92 |       const bodyText = (document.body?.innerText || "").toLowerCase();
 1432 |  93 |       return patterns.some((p) => bodyText.includes(p.toLowerCase()));
 1433 |  94 |     }, CHECKPOINT_TEXT_PATTERNS);
 1434 |  95 |     return result;
 1435 |  96 |   } catch {
 1436 |  97 |     return false;
 1437 |  98 |   }
 1438 |  99 | }
 1439 | 100 | 
 1440 | 101 | /**
 1441 | 102 |  * G≈Ç√≥wna funkcja wykrywania checkpoint
 1442 | 103 |  * @param {Page} page - Puppeteer page
 1443 | 104 |  * @returns {Promise<boolean>} - true je≈õli wykryto checkpoint
 1444 | 105 |  */
 1445 | 106 | async function isCheckpoint(page) {
 1446 | 107 |   try {
 1447 | 108 |     const url = page.url();
 1448 | 109 | 
 1449 | 110 |     // 1. Sprawd≈∫ URL
 1450 | 111 |     if (isCheckpointUrl(url)) {
 1451 | 112 |       log.dev("CHECKPOINT", `Wykryto checkpoint w URL: ${url}`);
 1452 | 113 |       return true;
 1453 | 114 |     }
 1454 | 115 | 
 1455 | 116 |     // 2. Sprawd≈∫ elementy DOM
 1456 | 117 |     const hasElements = await hasCheckpointElements(page);
 1457 | 118 |     if (hasElements) {
 1458 | 119 |       log.dev("CHECKPOINT", "Wykryto elementy checkpoint w DOM");
 1459 | 120 |       return true;
 1460 | 121 |     }
 1461 | 122 | 
 1462 | 123 |     // 3. Sprawd≈∫ tekst strony (tylko je≈õli nie jeste≈õmy zalogowani)
 1463 | 124 |     // Unikamy false positive na normalnych stronach
 1464 | 125 |     const hasText = await hasCheckpointText(page);
 1465 | 126 |     if (hasText) {
 1466 | 127 |       // Dodatkowa weryfikacja - czy to nie normalna strona FB?
 1467 | 128 |       const isNormalPage = await page.evaluate(() => {
 1468 | 129 |         // Szukamy element√≥w normalnej strony FB
 1469 | 130 |         const hasNewsFeed = !!document.querySelector('[role="feed"]');
 1470 | 131 |         const hasSearch = !!document.querySelector('input[aria-label*="Szukaj"], input[placeholder*="Szukaj"]');
 1471 | 132 |         return hasNewsFeed || hasSearch;
 1472 | 133 |       });
 1473 | 134 | 
 1474 | 135 |       if (!isNormalPage) {
 1475 | 136 |         log.dev("CHECKPOINT", "Wykryto tekst checkpoint na stronie");
 1476 | 137 |         return true;
 1477 | 138 |       }
 1478 | 139 |     }
 1479 | 140 | 
 1480 | 141 |     return false;
 1481 | 142 |   } catch (err) {
 1482 | 143 |     log.debug("CHECKPOINT", `B≈ÇƒÖd detekcji: ${err?.message}`);
 1483 | 144 |     return false;
 1484 | 145 |   }
 1485 | 146 | }
 1486 | 147 | 
 1487 | 148 | /**
 1488 | 149 |  * Okre≈õla typ checkpoint
 1489 | 150 |  * @param {Page} page - Puppeteer page
 1490 | 151 |  * @returns {Promise<string>} - typ checkpoint
 1491 | 152 |  */
 1492 | 153 | async function getCheckpointType(page) {
 1493 | 154 |   try {
 1494 | 155 |     const url = page.url();
 1495 | 156 | 
 1496 | 157 |     if (url.includes("/two_factor/")) return "2FA";
 1497 | 158 |     if (url.includes("/checkpoint/block/")) return "BLOCKED";
 1498 | 159 |     if (url.includes("/checkpoint/")) return "CHECKPOINT";
 1499 | 160 |     if (url.includes("/login/identify")) return "IDENTIFY";
 1500 | 161 |     if (url.includes("/recover/")) return "RECOVERY";
 1501 | 162 | 
 1502 | 163 |     const has2faInput = await page
 1503 | 164 |       .evaluate(() => {
 1504 | 165 |         return !!(
 1505 | 166 |           document.querySelector('input[name="approvals_code"]') ||
 1506 | 167 |           document.querySelector('input[autocomplete="one-time-code"]')
 1507 | 168 |         );
 1508 | 169 |       })
 1509 | 170 |       .catch(() => false);
 1510 | 171 | 
 1511 | 172 |     if (has2faInput) return "2FA";
 1512 | 173 | 
 1513 | 174 |     return "UNKNOWN";
 1514 | 175 |   } catch {
 1515 | 176 |     return "UNKNOWN";
 1516 | 177 |   }
 1517 | 178 | }
 1518 | 179 | 
 1519 | 180 | export { isCheckpoint, getCheckpointType, isCheckpointUrl };
 1520 | 181 | 
 1521 | ```
 1522 | 
 1523 | ---
 1524 | 
 1525 | ### üìÑ ≈öcie≈ºka: `src/fb/comments.js`
 1526 | **Typ:** JavaScript/tekst  
 1527 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 1528 | 
 1529 | ```js
 1530 |   1 | // src/fb/comments.js
 1531 |   2 | import { EXPAND_COMMENTS } from "../config.js";
 1532 |   3 | import { sleepRandom, humanDelay } from "../utils/sleep.js";
 1533 |   4 | import { scrollPost } from "./scroll.js";
 1534 |   5 | import { acceptCookies, saveCookies } from "./cookies.js";
 1535 |   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
 1536 |   7 | import { clickOneExpandButton } from "./expandButtons.js";
 1537 |   8 | import { safeGoto } from "../utils/navigation.js";
 1538 |   9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
 1539 |  10 | import log from "../utils/logger.js";
 1540 |  11 | 
 1541 |  12 | import * as uiPhoto from "./ui/photo.js";
 1542 |  13 | import * as uiPost from "./ui/post.js";
 1543 |  14 | import * as uiVideos from "./ui/videos.js";
 1544 |  15 | import * as uiWatch from "./ui/watch.js";
 1545 |  16 | 
 1546 |  17 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 1547 |  18 |   ? Number(process.env.NAV_TIMEOUT_MS)
 1548 |  19 |   : 90000;
 1549 |  20 | 
 1550 |  21 | /* ============================================================
 1551 |  22 |    ===================== UI ROUTER ============================
 1552 |  23 |    ============================================================ */
 1553 |  24 | 
 1554 |  25 | function pickUiHandler(url) {
 1555 |  26 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
 1556 |  27 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
 1557 |  28 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
 1558 |  29 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
 1559 |  30 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
 1560 |  31 |   return null;
 1561 |  32 | }
 1562 |  33 | 
 1563 |  34 | function resolveFastFlag(url, opts, ui) {
 1564 |  35 |   const wantFast = Boolean(opts && opts.fast);
 1565 |  36 |   if (!wantFast) return false;
 1566 |  37 |   // Minimalny zakres FAST: tylko UI "post" (permalink/story/posts)
 1567 |  38 |   if (!ui || ui.type !== "post") return false;
 1568 |  39 |   return true;
 1569 |  40 | }
 1570 |  41 | 
 1571 |  42 | /* ============================================================
 1572 |  43 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
 1573 |  44 |    ============================================================ */
 1574 |  45 | 
 1575 |  46 | async function openCommentsMenu(page) {
 1576 |  47 |   const r = await page.evaluate(() => {
 1577 |  48 |     const norm = (s) =>
 1578 |  49 |       String(s || "")
 1579 |  50 |         .replace(/\u00a0/g, " ")
 1580 |  51 |         .replace(/\s+/g, " ")
 1581 |  52 |         .trim()
 1582 |  53 |         .toLowerCase();
 1583 |  54 | 
 1584 |  55 |     function getLabel(el) {
 1585 |  56 |       return el.getAttribute?.("aria-label") || el.textContent || "";
 1586 |  57 |     }
 1587 |  58 | 
 1588 |  59 |     if (document.querySelector("div[role='menu']"))
 1589 |  60 |       return { ok: true, state: "menu-already-open" };
 1590 |  61 | 
 1591 |  62 |     const els = Array.from(
 1592 |  63 |       document.querySelectorAll(
 1593 |  64 |         "button,div[role='button'],span[role='button'],a[role='button']"
 1594 |  65 |       )
 1595 |  66 |     );
 1596 |  67 | 
 1597 |  68 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
 1598 |  69 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
 1599 |  70 |     const btn = els.find((el) => {
 1600 |  71 |       const t = norm(getLabel(el));
 1601 |  72 |       return (
 1602 |  73 |         t === "najtrafniejsze" ||
 1603 |  74 |         t === "most relevant" ||
 1604 |  75 |         t === "wszystkie komentarze" ||
 1605 |  76 |         t === "all comments" ||
 1606 |  77 |         t === "najnowsze" ||
 1607 |  78 |         t === "newest" ||
 1608 |  79 |         t === "poka≈º wszystkie" ||
 1609 |  80 |         t === "show all" ||
 1610 |  81 |         t === "wy≈õwietl wszystkie" ||
 1611 |  82 |         t === "view all"
 1612 |  83 |       );
 1613 |  84 |     });
 1614 |  85 | 
 1615 |  86 |     if (!btn) return { ok: false, reason: "no-trigger" };
 1616 |  87 | 
 1617 |  88 |     try {
 1618 |  89 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
 1619 |  90 |     } catch {}
 1620 |  91 | 
 1621 |  92 |     try {
 1622 |  93 |       btn.click();
 1623 |  94 |       return { ok: true, state: "clicked-trigger" };
 1624 |  95 |     } catch {
 1625 |  96 |       return { ok: false, reason: "click-failed" };
 1626 |  97 |     }
 1627 |  98 |   });
 1628 |  99 | 
 1629 | 100 |   return r?.ok === true;
 1630 | 101 | }
 1631 | 102 | 
 1632 | 103 | async function clickMenuOptionByPrefix(page, prefixes) {
 1633 | 104 |   return page.evaluate(
 1634 | 105 |     (prefixes) => {
 1635 | 106 |       const norm = (s) =>
 1636 | 107 |         String(s || "")
 1637 | 108 |           .replace(/\u00a0/g, " ")
 1638 | 109 |           .replace(/\s+/g, " ")
 1639 | 110 |           .trim()
 1640 | 111 |           .toLowerCase();
 1641 | 112 | 
 1642 | 113 |       const menu =
 1643 | 114 |         document.querySelector("div[role='menu']") ||
 1644 | 115 |         document.querySelector("div[role='dialog']");
 1645 | 116 |       if (!menu) return { ok: false, reason: "no-menu" };
 1646 | 117 | 
 1647 | 118 |       const items = Array.from(
 1648 | 119 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 1649 | 120 |       );
 1650 | 121 | 
 1651 | 122 |       const opt = items.find((el) => {
 1652 | 123 |         const t = norm(el.textContent);
 1653 | 124 |         return prefixes.some((p) => t.startsWith(p));
 1654 | 125 |       });
 1655 | 126 | 
 1656 | 127 |       if (!opt) return { ok: false, reason: "no-opt" };
 1657 | 128 | 
 1658 | 129 |       try {
 1659 | 130 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 1660 | 131 |       } catch {}
 1661 | 132 | 
 1662 | 133 |       try {
 1663 | 134 |         opt.click();
 1664 | 135 |         return { ok: true };
 1665 | 136 |       } catch {
 1666 | 137 |         return { ok: false, reason: "click-failed" };
 1667 | 138 |       }
 1668 | 139 |     },
 1669 | 140 |     prefixes
 1670 | 141 |   );
 1671 | 142 | }
 1672 | 143 | 
 1673 | 144 | async function switchCommentsFilterToAllLegacy(page) {
 1674 | 145 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Wszystkie komentarze'...");
 1675 | 146 | 
 1676 | 147 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
 1677 | 148 |     await humanDelay(200, 0.3); // Human: pauza przed otwarciem menu
 1678 | 149 |     const opened = await openCommentsMenu(page);
 1679 | 150 |     if (opened) await humanDelay(500, 0.3); // Human: czekaj na animacjƒô menu
 1680 | 151 |   }
 1681 | 152 | 
 1682 | 153 |   const picked = await clickMenuOptionByPrefix(page, [
 1683 | 154 |     "wszystkie komentarze",
 1684 | 155 |     "all comments",
 1685 | 156 |     "poka≈º wszystkie",
 1686 | 157 |     "show all",
 1687 | 158 |     "wy≈õwietl wszystkie",
 1688 | 159 |     "view all",
 1689 | 160 |   ]);
 1690 | 161 | 
 1691 | 162 |   if (picked?.ok) {
 1692 | 163 |     await humanDelay(400, 0.3);
 1693 | 164 |     await page
 1694 | 165 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 1695 | 166 |         timeout: 2500,
 1696 | 167 |       })
 1697 | 168 |       .catch(() => {});
 1698 | 169 |     log.dev("FILTER", "Ustawiono 'Wszystkie komentarze'");
 1699 | 170 |     return true;
 1700 | 171 |   }
 1701 | 172 | 
 1702 | 173 |   log.dev("FILTER", "Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze'");
 1703 | 174 |   return false;
 1704 | 175 | }
 1705 | 176 | 
 1706 | 177 | /* ============================================================
 1707 | 178 |    =======  FAST_MODE: SORTOWANIE "NAJNOWSZE"  =================
 1708 | 179 |    ============================================================ */
 1709 | 180 | 
 1710 | 181 | export async function switchCommentsFilterToNewest(page, url = null) {
 1711 | 182 |   const finalUrl = url || page.url();
 1712 | 183 |   const ui = pickUiHandler(finalUrl);
 1713 | 184 | 
 1714 | 185 |   // Dla UI "post" u≈ºywamy scope-aware wersji
 1715 | 186 |   if (ui?.type === "post" && typeof uiPost.switchCommentsFilterToNewestScoped === "function") {
 1716 | 187 |     log.dev("FILTER", "UI ‚Üí post switchCommentsFilterToNewestScoped");
 1717 | 188 |     return uiPost.switchCommentsFilterToNewestScoped(page);
 1718 | 189 |   }
 1719 | 190 | 
 1720 | 191 |   // Dla UI "videos" u≈ºywamy scope-aware wersji
 1721 | 192 |   if (ui?.type === "videos" && typeof uiVideos.switchCommentsFilterToNewestScoped === "function") {
 1722 | 193 |     log.dev("FILTER", "UI ‚Üí videos switchCommentsFilterToNewestScoped");
 1723 | 194 |     return uiVideos.switchCommentsFilterToNewestScoped(page);
 1724 | 195 |   }
 1725 | 196 | 
 1726 | 197 |   // Legacy/fallback dla innych UI
 1727 | 198 |   log.dev("FILTER", "Prze≈ÇƒÖczam na 'Najnowsze' (legacy)...");
 1728 | 199 | 
 1729 | 200 |   // Otw√≥rz menu je≈õli zamkniƒôte
 1730 | 201 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
 1731 | 202 |     const opened = await openCommentsMenu(page);
 1732 | 203 |     if (!opened) {
 1733 | 204 |       log.dev("FILTER", "Nie uda≈Ço siƒô otworzyƒá menu sortowania");
 1734 | 205 |       return { ok: false, reason: "menu-not-opened" };
 1735 | 206 |     }
 1736 | 207 |     await humanDelay(400, 0.3);
 1737 | 208 |   }
 1738 | 209 | 
 1739 | 210 |   // Kliknij "Najnowsze" / "Newest"
 1740 | 211 |   const picked = await clickMenuOptionByPrefix(page, [
 1741 | 212 |     "najnowsze",
 1742 | 213 |     "newest",
 1743 | 214 |     "od najnowszych",
 1744 | 215 |     "most recent",
 1745 | 216 |   ]);
 1746 | 217 | 
 1747 | 218 |   if (picked?.ok) {
 1748 | 219 |     await humanDelay(400, 0.3);
 1749 | 220 |     await page
 1750 | 221 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 1751 | 222 |         timeout: 2500,
 1752 | 223 |       })
 1753 | 224 |       .catch(() => {});
 1754 | 225 |     log.dev("FILTER", "Ustawiono 'Najnowsze'");
 1755 | 226 |     return { ok: true };
 1756 | 227 |   }
 1757 | 228 | 
 1758 | 229 |   log.dev("FILTER", "Nie uda≈Ço siƒô wybraƒá 'Najnowsze'");
 1759 | 230 |   return { ok: false, reason: picked?.reason || "option-not-found" };
 1760 | 231 | }
 1761 | 232 | 
 1762 | 233 | /* ============================================================
 1763 | 234 |    ===================  EXPAND (LEGACY)  =======================
 1764 | 235 |    ============================================================ */
 1765 | 236 | 
 1766 | 237 | export async function expandAllComments(page) {
 1767 | 238 |   if (!EXPAND_COMMENTS) return 0;
 1768 | 239 | 
 1769 | 240 |   let clicks = 0;
 1770 | 241 |   for (let i = 0; i < 30; i++) {
 1771 | 242 |     const didClick = await clickOneExpandButton(page);
 1772 | 243 |     if (!didClick) break;
 1773 | 244 |     clicks++;
 1774 | 245 |     await humanDelay(700, 0.3);
 1775 | 246 |   }
 1776 | 247 |   return clicks;
 1777 | 248 | }
 1778 | 249 | 
 1779 | 250 | /* ============================================================
 1780 | 251 |    ===================  LICZNIK KOMENTARZY  ====================
 1781 | 252 |    ============================================================ */
 1782 | 253 | 
 1783 | 254 | async function getCommentCountLegacy(page) {
 1784 | 255 |   const ui = await getUiCommentInfo(page).catch(() => null);
 1785 | 256 | 
 1786 | 257 |   const uiCandidates = [
 1787 | 258 |     ui?.comments,
 1788 | 259 |     ui?.count,
 1789 | 260 |     ui?.commentCount,
 1790 | 261 |     ui?.commentsCount,
 1791 | 262 |     ui?.totalComments,
 1792 | 263 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
 1793 | 264 | 
 1794 | 265 |   if (uiCandidates.length) {
 1795 | 266 |     const best = Math.max(...uiCandidates);
 1796 | 267 |     log.debug("EXTRACT", "UI count", {
 1797 | 268 |       best,
 1798 | 269 |       candidates: uiCandidates,
 1799 | 270 |       source: ui?.source || "ui",
 1800 | 271 |       raw: ui?.raw || null,
 1801 | 272 |       viewType: ui?.viewType || null,
 1802 | 273 |     });
 1803 | 274 |     return best;
 1804 | 275 |   }
 1805 | 276 | 
 1806 | 277 |   const uiLoose = await page
 1807 | 278 |     .evaluate(() => {
 1808 | 279 |       const texts = [];
 1809 | 280 |       const pushText = (t) => {
 1810 | 281 |         if (!t) return;
 1811 | 282 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
 1812 | 283 |         if (s) texts.push(s);
 1813 | 284 |       };
 1814 | 285 | 
 1815 | 286 |       const els = Array.from(
 1816 | 287 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
 1817 | 288 |       );
 1818 | 289 |       for (const el of els) {
 1819 | 290 |         pushText(el.getAttribute?.("aria-label"));
 1820 | 291 |         pushText(el.textContent);
 1821 | 292 |       }
 1822 | 293 | 
 1823 | 294 |       const nums = [];
 1824 | 295 |       for (const t of texts) {
 1825 | 296 |         const low = t.toLowerCase();
 1826 | 297 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
 1827 | 298 |         if (m) nums.push(Number(m[1]));
 1828 | 299 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
 1829 | 300 |         if (m) nums.push(Number(m[1]));
 1830 | 301 |       }
 1831 | 302 | 
 1832 | 303 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
 1833 | 304 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
 1834 | 305 |     })
 1835 | 306 |     .catch(() => ({ count: null, sample: [] }));
 1836 | 307 | 
 1837 | 308 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
 1838 | 309 |     log.debug("EXTRACT", `UI-loose count: ${uiLoose.count}`);
 1839 | 310 |     return uiLoose.count;
 1840 | 311 |   }
 1841 | 312 | 
 1842 | 313 |   if (ui) {
 1843 | 314 |     log.debug("EXTRACT", "UI object (no number)", { keys: Object.keys(ui) });
 1844 | 315 |   } else {
 1845 | 316 |     log.debug("EXTRACT", "UI object: null");
 1846 | 317 |   }
 1847 | 318 | 
 1848 | 319 |   const anchors = await page.evaluate(() => {
 1849 | 320 |     const as = Array.from(
 1850 | 321 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 1851 | 322 |     );
 1852 | 323 |     const ids = new Set();
 1853 | 324 |     for (const a of as) {
 1854 | 325 |       try {
 1855 | 326 |         const u = new URL(a.href);
 1856 | 327 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
 1857 | 328 |         if (raw) ids.add(raw);
 1858 | 329 |       } catch {}
 1859 | 330 |     }
 1860 | 331 |     return ids.size;
 1861 | 332 |   });
 1862 | 333 | 
 1863 | 334 |   if (anchors > 0) log.debug("EXTRACT", `Anchors-fallback: ${anchors}`);
 1864 | 335 |   return anchors > 0 ? anchors : null;
 1865 | 336 | }
 1866 | 337 | 
 1867 | 338 | /* ============================================================
 1868 | 339 |    ===================  EKSTRAKCJA KOMENTARZY  =================
 1869 | 340 |    ============================================================ */
 1870 | 341 | 
 1871 | 342 | async function extractCommentsFromDOM(page) {
 1872 | 343 |   const data = await page.evaluate(() => {
 1873 | 344 |     function extractCommentIdRaw(url) {
 1874 | 345 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
 1875 | 346 |       return m ? decodeURIComponent(m[1]) : null;
 1876 | 347 |     }
 1877 | 348 | 
 1878 | 349 |     function safeAtob(input) {
 1879 | 350 |       try {
 1880 | 351 |         let s = String(input || "");
 1881 | 352 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
 1882 | 353 |         while (s.length % 4) s += "=";
 1883 | 354 |         return atob(s);
 1884 | 355 |       } catch {
 1885 | 356 |         return null;
 1886 | 357 |       }
 1887 | 358 |     }
 1888 | 359 | 
 1889 | 360 |     function idNumFromRaw(idRaw) {
 1890 | 361 |       if (!idRaw) return null;
 1891 | 362 |       const s = String(idRaw).trim();
 1892 | 363 |       if (/^\d+$/.test(s)) return s;
 1893 | 364 | 
 1894 | 365 |       const dec = safeAtob(s);
 1895 | 366 |       if (dec) {
 1896 | 367 |         const m = String(dec).match(/(\d{6,})\s*$/);
 1897 | 368 |         if (m) return m[1];
 1898 | 369 |       }
 1899 | 370 |       const m2 = s.match(/_(\d+)\b/);
 1900 | 371 |       return m2 ? m2[1] : null;
 1901 | 372 |     }
 1902 | 373 | 
 1903 | 374 |     function normalizeTime(text) {
 1904 | 375 |       if (!text) return null;
 1905 | 376 | 
 1906 | 377 |       const t = String(text)
 1907 | 378 |         .toLowerCase()
 1908 | 379 |         .replace(/\u00a0/g, " ")
 1909 | 380 |         .replace(/\s+/g, " ")
 1910 | 381 |         .trim();
 1911 | 382 | 
 1912 | 383 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
 1913 | 384 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
 1914 | 385 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
 1915 | 386 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
 1916 | 387 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
 1917 | 388 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
 1918 | 389 | 
 1919 | 390 |       return null;
 1920 | 391 |     }
 1921 | 392 | 
 1922 | 393 |     function findTimeAround(linkEl, fallbackNode) {
 1923 | 394 |       const root =
 1924 | 395 |         linkEl?.closest?.("div[role='article']") ||
 1925 | 396 |         linkEl?.closest?.("div[aria-label]") ||
 1926 | 397 |         linkEl?.closest?.("div") ||
 1927 | 398 |         fallbackNode;
 1928 | 399 | 
 1929 | 400 |       if (!root) return null;
 1930 | 401 | 
 1931 | 402 |       const els = root.querySelectorAll("a, abbr, span");
 1932 | 403 |       for (const el of els) {
 1933 | 404 |         const aria = el.getAttribute?.("aria-label");
 1934 | 405 |         const t1 = normalizeTime(aria);
 1935 | 406 |         if (t1) return t1;
 1936 | 407 | 
 1937 | 408 |         const txt = el.textContent?.trim();
 1938 | 409 |         const t2 = normalizeTime(txt);
 1939 | 410 |         if (t2) return t2;
 1940 | 411 |       }
 1941 | 412 |       return null;
 1942 | 413 |     }
 1943 | 414 | 
 1944 | 415 |     const nodes = Array.from(
 1945 | 416 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
 1946 | 417 |     );
 1947 | 418 | 
 1948 | 419 |     const extracted = nodes
 1949 | 420 |       .map((node, idx) => {
 1950 | 421 |         const author = node.querySelector("a[role=\"link\"] span span")?.textContent?.trim() || null;
 1951 | 422 |         const text = node.querySelector("div[dir=\"auto\"]")?.textContent?.trim() || null;
 1952 | 423 | 
 1953 | 424 |         const linkEl = node.querySelector("a[href*=\"reply_comment_id\"]") ||
 1954 | 425 |           node.querySelector("a[href*=\"comment_id\"]") ||
 1955 | 426 |           node.querySelector("a[role=\"link\"]");
 1956 | 427 | 
 1957 | 428 |         const href = linkEl?.getAttribute("href") || null;
 1958 | 429 |         const permalink = href
 1959 | 430 |           ? href.startsWith("http")
 1960 | 431 |             ? href
 1961 | 432 |             : `https://www.facebook.com${href}`
 1962 | 433 |           : null;
 1963 | 434 | 
 1964 | 435 |         const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
 1965 | 436 |         const id = id_raw ? String(id_raw).trim() : null;
 1966 | 437 |         const id_num = id_raw ? idNumFromRaw(id_raw) : null;
 1967 | 438 |         const time = findTimeAround(linkEl, node);
 1968 | 439 | 
 1969 | 440 |         if (!author || !text || !id) return null;
 1970 | 441 | 
 1971 | 442 |         return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
 1972 | 443 |       })
 1973 | 444 |       .filter(Boolean);
 1974 | 445 | 
 1975 | 446 |     return extracted;
 1976 | 447 |   });
 1977 | 448 | 
 1978 | 449 |   return Array.isArray(data) ? data : [];
 1979 | 450 | }
 1980 | 451 | 
 1981 | 452 | /* ============================================================
 1982 | 453 |    ===================  PREPARE / LOAD (LEGACY)  ===============
 1983 | 454 |    ============================================================ */
 1984 | 455 | 
 1985 | 456 | async function prepareLegacy(page, url) {
 1986 | 457 |   const ok = await safeGoto(page, url, "comments", {
 1987 | 458 |     waitUntil: "networkidle2",
 1988 | 459 |     timeout: NAV_TIMEOUT_MS,
 1989 | 460 |   });
 1990 | 461 | 
 1991 | 462 |   if (!ok) throw new Error("safeGoto-failed");
 1992 | 463 | 
 1993 | 464 |   const currentUrl = page.url();
 1994 | 465 |   if (currentUrl.includes("/login")) {
 1995 | 466 |     log.dev("LOGIN", "/login redirect ‚Üí fbLogin()");
 1996 | 467 |     await fbLogin(page);
 1997 | 468 |     await sleepRandom(3000, 4500);
 1998 | 469 | 
 1999 | 470 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 2000 | 471 |     log.dev("LOGIN", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
 2001 | 472 | 
 2002 | 473 |     if (loggedAfterLogin) {
 2003 | 474 |       await safeGoto(page, url, "comments", {
 2004 | 475 |         waitUntil: "networkidle2",
 2005 | 476 |         timeout: NAV_TIMEOUT_MS,
 2006 | 477 |       });
 2007 | 478 |     }
 2008 | 479 |   }
 2009 | 480 | 
 2010 | 481 |   await acceptCookies(page, "post-initial");
 2011 | 482 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
 2012 | 483 |   await sleepRandom(900, 1400);
 2013 | 484 |   await acceptCookies(page, "post");
 2014 | 485 | 
 2015 | 486 |   try {
 2016 | 487 |     const logged = await checkIfLogged(page).catch(() => false);
 2017 | 488 |     if (logged) await saveCookies(page);
 2018 | 489 |   } catch {}
 2019 | 490 | 
 2020 | 491 |   await scrollPost(page, 140).catch(() => {});
 2021 | 492 |   await sleepRandom(500, 800);
 2022 | 493 | 
 2023 | 494 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
 2024 | 495 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
 2025 | 496 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
 2026 | 497 |   await humanDelay(400, 0.3);
 2027 | 498 | }
 2028 | 499 | 
 2029 | 500 | async function loadAllCommentsLegacy(page, opts = {}) {
 2030 | 501 |   if (!EXPAND_COMMENTS) return;
 2031 | 502 | 
 2032 | 503 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
 2033 | 504 | 
 2034 | 505 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
 2035 | 506 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
 2036 | 507 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
 2037 | 508 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
 2038 | 509 | 
 2039 | 510 |   log.dev("EXTRACT", "Load start", { expected });
 2040 | 511 | 
 2041 | 512 |   function uniqAnchorCountEval() {
 2042 | 513 |     return page.evaluate(() => {
 2043 | 514 |       const as = Array.from(
 2044 | 515 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 2045 | 516 |       );
 2046 | 517 |       const ids = new Set();
 2047 | 518 |       for (const a of as) {
 2048 | 519 |         const href = a.getAttribute("href") || "";
 2049 | 520 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
 2050 | 521 |         if (m && m[1]) ids.add(m[1]);
 2051 | 522 |       }
 2052 | 523 |       return ids.size;
 2053 | 524 |     });
 2054 | 525 |   }
 2055 | 526 | 
 2056 | 527 |   function commentNodesCountEval() {
 2057 | 528 |     return page.evaluate(() => {
 2058 | 529 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
 2059 | 530 |       return nodes ? nodes.length : 0;
 2060 | 531 |     });
 2061 | 532 |   }
 2062 | 533 | 
 2063 | 534 |   function hasMoreButtonsEval() {
 2064 | 535 |     return page.evaluate(() => {
 2065 | 536 |       const norm = (s) =>
 2066 | 537 |         String(s || "")
 2067 | 538 |           .replace(/\u00a0/g, " ")
 2068 | 539 |           .replace(/\s+/g, " ")
 2069 | 540 |           .trim()
 2070 | 541 |           .toLowerCase();
 2071 | 542 | 
 2072 | 543 |       const btns = Array.from(
 2073 | 544 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
 2074 | 545 |       );
 2075 | 546 |       return btns.some((b) => {
 2076 | 547 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
 2077 | 548 |         return (
 2078 | 549 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 2079 | 550 |           t.includes("zobacz wiƒôcej komentarzy") ||
 2080 | 551 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 2081 | 552 |           t.includes("more comments") ||
 2082 | 553 |           t.includes("view more comments") ||
 2083 | 554 |           t.includes("view previous comments") ||
 2084 | 555 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
 2085 | 556 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
 2086 | 557 |           t.includes("more replies") ||
 2087 | 558 |           t.includes("view more replies")
 2088 | 559 |         );
 2089 | 560 |       });
 2090 | 561 |     });
 2091 | 562 |   }
 2092 | 563 | 
 2093 | 564 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
 2094 | 565 |   let nodes = await commentNodesCountEval().catch(() => 0);
 2095 | 566 | 
 2096 | 567 |   let stable = 0;
 2097 | 568 |   let noProgress = 0;
 2098 | 569 | 
 2099 | 570 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
 2100 | 571 |     let clicks = 0;
 2101 | 572 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
 2102 | 573 |       const did = await clickOneExpandButton(page).catch(() => false);
 2103 | 574 |       if (!did) break;
 2104 | 575 |       clicks++;
 2105 | 576 |       await humanDelay(400, 0.3);
 2106 | 577 |     }
 2107 | 578 | 
 2108 | 579 |     await scrollPost(page, 220).catch(() => {});
 2109 | 580 |     await sleepRandom(400, 700);
 2110 | 581 | 
 2111 | 582 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
 2112 | 583 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
 2113 | 584 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
 2114 | 585 | 
 2115 | 586 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
 2116 | 587 | 
 2117 | 588 |     if (progressed) {
 2118 | 589 |       anchors = nextAnchors;
 2119 | 590 |       nodes = nextNodes;
 2120 | 591 |       stable = 0;
 2121 | 592 |       noProgress = 0;
 2122 | 593 |     } else {
 2123 | 594 |       stable++;
 2124 | 595 |       noProgress++;
 2125 | 596 |     }
 2126 | 597 | 
 2127 | 598 |     log.debug("EXTRACT", `Round ${round}`, {
 2128 | 599 |       anchors: `${anchors}‚Üí${nextAnchors}`,
 2129 | 600 |       nodes: `${nodes}‚Üí${nextNodes}`,
 2130 | 601 |       clicks,
 2131 | 602 |       stable: `${stable}/${STABLE_ROUNDS}`,
 2132 | 603 |       moreBtns,
 2133 | 604 |     });
 2134 | 605 | 
 2135 | 606 |     const stableEnough = stable >= STABLE_ROUNDS;
 2136 | 607 | 
 2137 | 608 |     if (!moreBtns && stableEnough) {
 2138 | 609 |       log.dev("EXTRACT", "Stop: no more buttons + stable");
 2139 | 610 |       break;
 2140 | 611 |     }
 2141 | 612 | 
 2142 | 613 |     const reachedExpected =
 2143 | 614 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
 2144 | 615 |     if (reachedExpected && stableEnough && !moreBtns) {
 2145 | 616 |       log.dev("EXTRACT", "Stop: expected reached + stable");
 2146 | 617 |       break;
 2147 | 618 |     }
 2148 | 619 | 
 2149 | 620 |     if (stableEnough && moreBtns) {
 2150 | 621 |       log.debug("EXTRACT", "Rescue: stable but buttons ‚Üí deep scroll");
 2151 | 622 |       await scrollPost(page, 520).catch(() => {});
 2152 | 623 |       await sleepRandom(1000, 1600);
 2153 | 624 |       stable = 0;
 2154 | 625 |       continue;
 2155 | 626 |     }
 2156 | 627 | 
 2157 | 628 |     if (noProgress >= MAX_NO_PROGRESS) {
 2158 | 629 |       if (moreBtns) {
 2159 | 630 |         log.debug("EXTRACT", "Last-rescue: no-progress but buttons ‚Üí deep scroll");
 2160 | 631 |         await scrollPost(page, 650).catch(() => {});
 2161 | 632 |         await sleepRandom(1400, 1900);
 2162 | 633 |         stable = 0;
 2163 | 634 |         noProgress = 0;
 2164 | 635 |         continue;
 2165 | 636 |       }
 2166 | 637 | 
 2167 | 638 |       log.dev("EXTRACT", "Stop: too many no-progress rounds");
 2168 | 639 |       break;
 2169 | 640 |     }
 2170 | 641 | 
 2171 | 642 |     anchors = nextAnchors;
 2172 | 643 |     nodes = nextNodes;
 2173 | 644 |   }
 2174 | 645 | 
 2175 | 646 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
 2176 | 647 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
 2177 | 648 |   log.dev("EXTRACT", `Load done: ${finalAnchors} anchors, ${finalNodes} nodes`);
 2178 | 649 | }
 2179 | 650 | 
 2180 | 651 | /* ============================================================
 2181 | 652 |    ===================  PUBLIC API (ROUTED)  ===================
 2182 | 653 |    ============================================================ */
 2183 | 654 | 
 2184 | 655 | export async function prepare(page, url) {
 2185 | 656 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
 2186 | 657 |   const ui = pickUiHandler(url);
 2187 | 658 |   const fast = resolveFastFlag(url, opts, ui);
 2188 | 659 | 
 2189 | 660 |   if (ui?.prepare) {
 2190 | 661 |     log.dev("NAV", `UI ‚Üí ${ui.type || "unknown"} prepare`, { fast });
 2191 | 662 |     return ui.prepare(page, url, { ...(opts || {}), fast });
 2192 | 663 |   }
 2193 | 664 | 
 2194 | 665 |   log.dev("NAV", "UI ‚Üí legacy prepare");
 2195 | 666 |   return prepareLegacy(page, url);
 2196 | 667 | }
 2197 | 668 | 
 2198 | 669 | export async function getCommentCount(page, url) {
 2199 | 670 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
 2200 | 671 |   const finalUrl = url || page.url();
 2201 | 672 |   const ui = pickUiHandler(finalUrl);
 2202 | 673 |   const fast = resolveFastFlag(finalUrl, opts, ui);
 2203 | 674 | 
 2204 | 675 |   if (ui?.getCommentCount) {
 2205 | 676 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} getCommentCount`);
 2206 | 677 |     return ui.getCommentCount(page, finalUrl, { ...(opts || {}), fast });
 2207 | 678 |   }
 2208 | 679 | 
 2209 | 680 |   log.debug("EXTRACT", "UI ‚Üí legacy getCommentCount");
 2210 | 681 |   return getCommentCountLegacy(page);
 2211 | 682 | }
 2212 | 683 | 
 2213 | 684 | export async function loadAllComments(page, opts = {}, url = null) {
 2214 | 685 |   if (!EXPAND_COMMENTS) return;
 2215 | 686 | 
 2216 | 687 |   const finalUrl = url || page.url();
 2217 | 688 |   const ui = pickUiHandler(finalUrl);
 2218 | 689 |   const fast = resolveFastFlag(finalUrl, opts, ui);
 2219 | 690 | 
 2220 | 691 |   if (ui?.loadAllComments) {
 2221 | 692 |     log.dev("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} loadAllComments`);
 2222 | 693 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal, ...(opts || {}), fast });
 2223 | 694 |   }
 2224 | 695 | 
 2225 | 696 |   log.dev("EXTRACT", "UI ‚Üí legacy loadAllComments");
 2226 | 697 |   return loadAllCommentsLegacy(page, opts);
 2227 | 698 | }
 2228 | 699 | 
 2229 | 700 | export async function extractCommentsData(page, url = null) {
 2230 | 701 |   const opts = arguments.length >= 3 ? arguments[2] : undefined;
 2231 | 702 |   const finalUrl = url || page.url();
 2232 | 703 |   const ui = pickUiHandler(finalUrl);
 2233 | 704 |   const fast = resolveFastFlag(finalUrl, opts, ui);
 2234 | 705 | 
 2235 | 706 |   const getPostRef = (u) => {
 2236 | 707 |     if (!u) return null;
 2237 | 708 |     try {
 2238 | 709 |       const x = new URL(u);
 2239 | 710 | 
 2240 | 711 |       // permalink.php?story_fbid=...
 2241 | 712 |       const story = x.searchParams.get("story_fbid");
 2242 | 713 |       if (story) return `story_fbid:${story}`;
 2243 | 714 | 
 2244 | 715 |       // /.../posts/<id>  |  /.../videos/<id>  |  /.../photos/<id>
 2245 | 716 |       const parts = x.pathname.split("/").filter(Boolean);
 2246 | 717 |       for (let i = 0; i < parts.length - 1; i++) {
 2247 | 718 |         const k = parts[i];
 2248 | 719 |         if (k === "posts" || k === "videos" || k === "photos" || k === "reels") {
 2249 | 720 |           const v = parts[i + 1];
 2250 | 721 |           if (v) return `${k}:${v}`;
 2251 | 722 |         }
 2252 | 723 |       }
 2253 | 724 | 
 2254 | 725 |       // fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)
 2255 | 726 |       return null;
 2256 | 727 |     } catch (e) {
 2257 | 728 |       return null;
 2258 | 729 |     }
 2259 | 730 |   };
 2260 | 731 | 
 2261 | 732 |   const postRef = getPostRef(finalUrl);
 2262 | 733 | 
 2263 | 734 |   const filterByRef = (arr) => {
 2264 | 735 |     if (!Array.isArray(arr)) return [];
 2265 | 736 |     if (!postRef) return arr;
 2266 | 737 | 
 2267 | 738 |     let dropped = 0;
 2268 | 739 |     const out = [];
 2269 | 740 |     let sampleLogged = 0;
 2270 | 741 | 
 2271 | 742 |     // kontekst: do czego porownujemy
 2272 | 743 |     log.debug("DEDUP", `Context: want=${postRef || "null"}`);
 2273 | 744 | 
 2274 | 745 |     for (const c of arr) {
 2275 | 746 |       const permalink = c && typeof c === "object" ? c.permalink || null : null;
 2276 | 747 |       const cref = permalink ? getPostRef(permalink) : null;
 2277 | 748 | 
 2278 | 749 |       // pokaz 3 pierwsze permalink->cref
 2279 | 750 |       if (sampleLogged < 3 && permalink) {
 2280 | 751 |         log.debug("DEDUP", `Sample: cref=${cref || "null"}`);
 2281 | 752 |         sampleLogged += 1;
 2282 | 753 |       }
 2283 | 754 | 
 2284 | 755 |       if (cref && cref !== postRef) {
 2285 | 756 |         dropped += 1;
 2286 | 757 |         continue;
 2287 | 758 |       }
 2288 | 759 |       if (c && typeof c === "object") c.postRef = postRef;
 2289 | 760 |       out.push(c);
 2290 | 761 |     }
 2291 | 762 | 
 2292 | 763 |     if (dropped > 0) {
 2293 | 764 |       log.debug("DEDUP", `Dropped ${dropped} (ref mismatch)`);
 2294 | 765 |     }
 2295 | 766 | 
 2296 | 767 |     if (arr.length > 0 && out.length === 0 && dropped === arr.length) {
 2297 | 768 |       out._dedupAllDropped = true;
 2298 | 769 |       log.warn("DEDUP", `All ${arr.length} dropped (ref mismatch)`);
 2299 | 770 |     }
 2300 | 771 | 
 2301 | 772 |     return out;
 2302 | 773 |   };
 2303 | 774 | 
 2304 | 775 |   if (ui?.extractComments) {
 2305 | 776 |     log.debug("EXTRACT", `UI ‚Üí ${ui.type || "unknown"} extractComments`);
 2306 | 777 |     const out = await ui.extractComments(page, finalUrl, { ...(opts || {}), fast });
 2307 | 778 |     return filterByRef(out);
 2308 | 779 |   }
 2309 | 780 | 
 2310 | 781 |   const out = await extractCommentsFromDOM(page);
 2311 | 782 |   return filterByRef(out);
 2312 | 783 | }
 2313 | 784 | 
 2314 | ```
 2315 | 
 2316 | ---
 2317 | 
 2318 | ### üìÑ ≈öcie≈ºka: `src/fb/cookies.js`
 2319 | **Typ:** JavaScript/tekst  
 2320 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 2321 | 
 2322 | ```js
 2323 |   1 | // src/fb/cookies.js
 2324 |   2 | import fs from "fs/promises";
 2325 |   3 | import path from "path";
 2326 |   4 | import { sleepRandom } from "../utils/sleep.js";
 2327 |   5 | import log from "../utils/logger.js";
 2328 |   6 | 
 2329 |   7 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
 2330 |   8 | const COOKIES_READ_ONLY =
 2331 |   9 |   String(process.env.COOKIES_READ_ONLY || "")
 2332 |  10 |     .trim()
 2333 |  11 |     .toLowerCase() === "true";
 2334 |  12 | 
 2335 |  13 | log.debug("COOKIES", `COOKIES_READ_ONLY=${COOKIES_READ_ONLY}`, { raw: process.env.COOKIES_READ_ONLY });
 2336 |  14 | 
 2337 |  15 | 
 2338 |  16 | /**
 2339 |  17 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
 2340 |  18 |  */
 2341 |  19 | async function loadCookies(page) {
 2342 |  20 |   try {
 2343 |  21 |     const raw = await fs.readFile("cookies.json", "utf8");
 2344 |  22 |     const cookies = JSON.parse(raw);
 2345 |  23 | 
 2346 |  24 |     if (Array.isArray(cookies) && cookies.length) {
 2347 |  25 |       await page.setCookie(...cookies);
 2348 |  26 |       log.dev("COOKIES", `Za≈Çadowano ${cookies.length} cookies z pliku`);
 2349 |  27 |     } else {
 2350 |  28 |       log.dev("COOKIES", "cookies.json istnieje, ale nie zawiera poprawnej tablicy");
 2351 |  29 |     }
 2352 |  30 |   } catch (err) {
 2353 |  31 |     log.dev("COOKIES", `Brak cookies.json lub b≈ÇƒÖd odczytu: ${err?.message || err}`);
 2354 |  32 |   }
 2355 |  33 | }
 2356 |  34 | 
 2357 |  35 | /**
 2358 |  36 |  * Atomic write dla plik√≥w JSON - zapisuje do tmp, potem rename
 2359 |  37 |  * @param {string} targetPath - docelowa ≈õcie≈ºka pliku
 2360 |  38 |  * @param {string} content - zawarto≈õƒá do zapisania
 2361 |  39 |  */
 2362 |  40 | async function atomicWriteFile(targetPath, content) {
 2363 |  41 |   const dir = path.dirname(targetPath);
 2364 |  42 |   const basename = path.basename(targetPath, ".json");
 2365 |  43 |   const tmpFile = path.join(dir, `.${basename}.${Date.now()}.tmp`);
 2366 |  44 | 
 2367 |  45 |   // 1. Zapisz do pliku tymczasowego
 2368 |  46 |   await fs.writeFile(tmpFile, content, "utf8");
 2369 |  47 | 
 2370 |  48 |   // 2. Atomic rename
 2371 |  49 |   await fs.rename(tmpFile, targetPath);
 2372 |  50 | }
 2373 |  51 | 
 2374 |  52 | /**
 2375 |  53 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
 2376 |  54 |  * U≈ºywa atomic write dla bezpiecze≈Ñstwa.
 2377 |  55 |  */
 2378 |  56 | async function saveCookies(page) {
 2379 |  57 |   if (COOKIES_READ_ONLY) {
 2380 |  58 |     log.debug("COOKIES", "COOKIES_READ_ONLY=true ‚Äì pomijam zapis");
 2381 |  59 |     return;
 2382 |  60 |   }
 2383 |  61 | 
 2384 |  62 |   try {
 2385 |  63 |     const cookies = await page.cookies();
 2386 |  64 |     const content = JSON.stringify(cookies, null, 2);
 2387 |  65 | 
 2388 |  66 |     await atomicWriteFile("cookies.json", content);
 2389 |  67 | 
 2390 |  68 |     log.dev("COOKIES", `Zapisano ${cookies.length} cookies do pliku`);
 2391 |  69 |   } catch (e) {
 2392 |  70 |     log.warn("COOKIES", `B≈ÇƒÖd zapisu cookies.json: ${e?.message || e}`);
 2393 |  71 | 
 2394 |  72 |     // Cleanup tmp files
 2395 |  73 |     try {
 2396 |  74 |       const files = await fs.readdir(".");
 2397 |  75 |       for (const f of files) {
 2398 |  76 |         if (f.startsWith(".cookies.") && f.endsWith(".tmp")) {
 2399 |  77 |           await fs.unlink(f);
 2400 |  78 |         }
 2401 |  79 |       }
 2402 |  80 |     } catch {
 2403 |  81 |       // Ignoruj b≈Çƒôdy cleanup
 2404 |  82 |     }
 2405 |  83 |   }
 2406 |  84 | }
 2407 |  85 | 
 2408 |  86 | 
 2409 |  87 | 
 2410 |  88 | /**
 2411 |  89 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
 2412 |  90 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
 2413 |  91 |  */
 2414 |  92 | async function acceptCookies(page, label = "global") {
 2415 |  93 |   try {
 2416 |  94 |     // chwila na pojawienie siƒô popupu
 2417 |  95 |     await sleepRandom(800, 1500);
 2418 |  96 | 
 2419 |  97 |     const result = await page.evaluate(() => {
 2420 |  98 |       const wanted = [
 2421 |  99 |         "zezw√≥l na wszystkie pliki cookie",
 2422 | 100 |         "zezw√≥l na wszystkie pliki",
 2423 | 101 |         "akceptuj wszystkie pliki cookie",
 2424 | 102 |         "akceptuj wszystkie",
 2425 | 103 |         "allow all cookies",
 2426 | 104 |         "accept all cookies",
 2427 | 105 |         "accept essential and optional cookies",
 2428 | 106 |         "tylko niezbƒôdne pliki cookie",
 2429 | 107 |         "odrzuƒá opcjonalne pliki cookie",
 2430 | 108 |       ].map((t) => t.toLowerCase());
 2431 | 109 | 
 2432 | 110 |       const buttons = Array.from(
 2433 | 111 |         document.querySelectorAll("button, [role='button']")
 2434 | 112 |       );
 2435 | 113 | 
 2436 | 114 |       let clicked = false;
 2437 | 115 |       const texts = [];
 2438 | 116 | 
 2439 | 117 |       for (const btn of buttons) {
 2440 | 118 |         const txt = (btn.innerText || btn.textContent || "").trim();
 2441 | 119 |         if (!txt) continue;
 2442 | 120 | 
 2443 | 121 |         const low = txt.toLowerCase();
 2444 | 122 |         texts.push(txt);
 2445 | 123 | 
 2446 | 124 |         if (wanted.some((w) => low.includes(w))) {
 2447 | 125 |           btn.click();
 2448 | 126 |           clicked = true;
 2449 | 127 |           break;
 2450 | 128 |         }
 2451 | 129 |       }
 2452 | 130 | 
 2453 | 131 |       return { clicked, texts };
 2454 | 132 |     });
 2455 | 133 | 
 2456 | 134 |     if (result.clicked) {
 2457 | 135 |       log.debug("COOKIES", `[${label}] Klikniƒôto akceptacjƒô cookies`);
 2458 | 136 |       await sleepRandom(1500, 2500);
 2459 | 137 |     } else {
 2460 | 138 |       log.debug("COOKIES", `[${label}] Nie znaleziono przycisku cookies`, { texts: result.texts?.slice(0, 5) });
 2461 | 139 |     }
 2462 | 140 |   } catch (err) {
 2463 | 141 |     log.debug("COOKIES", `[${label}] B≈ÇƒÖd popupu: ${err?.message || err}`);
 2464 | 142 |   }
 2465 | 143 | }
 2466 | 144 | 
 2467 | 145 | export {
 2468 | 146 |   loadCookies,
 2469 | 147 |   saveCookies,
 2470 | 148 |   acceptCookies,
 2471 | 149 | };
 2472 | 150 | 
 2473 | ```
 2474 | 
 2475 | ---
 2476 | 
 2477 | ### üìÑ ≈öcie≈ºka: `src/fb/expandButtons.js`
 2478 | **Typ:** JavaScript/tekst  
 2479 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 2480 | 
 2481 | ```js
 2482 |   1 | // src/fb/expandButtons.js
 2483 |   2 | // Centralny ‚Äûbutton classifier" dla wszystkich przycisk√≥w typu:
 2484 |   3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments"
 2485 |   4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies"
 2486 |   5 | // - ‚ÄûZobacz wiƒôcej / See more" (bez ‚ÄûZobacz t≈Çumaczenie").
 2487 |   6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
 2488 |   7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
 2489 |   8 | 
 2490 |   9 | import { INCLUDE_REPLIES } from "../config.js";
 2491 |  10 | import { humanDelay } from "../utils/sleep.js";
 2492 |  11 | import log from "../utils/logger.js";
 2493 |  12 | 
 2494 |  13 | async function clickOneExpandButton(page) {
 2495 |  14 |   // Human behavior: ma≈Çe op√≥≈∫nienie przed szukaniem przycisku
 2496 |  15 |   await humanDelay(150, 0.4);
 2497 |  16 | 
 2498 |  17 |   const res = await page.evaluate((includeReplies) => {
 2499 |  18 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 2500 |  19 |       location.href
 2501 |  20 |     );
 2502 |  21 |     const isWatchView = /\/watch\//i.test(location.href);
 2503 |  22 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
 2504 |  23 | 
 2505 |  24 |     function getPostRoot() {
 2506 |  25 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 2507 |  26 |       const postDialog = dialogs.find((dlg) => {
 2508 |  27 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 2509 |  28 |         if (!text) return false;
 2510 |  29 |         const hasCommentWord =
 2511 |  30 |           text.includes("komentarz") || text.includes("comment");
 2512 |  31 |         const hasActions =
 2513 |  32 |           text.includes("lubiƒô to") ||
 2514 |  33 |           text.includes("komentarz") ||
 2515 |  34 |           text.includes("udostƒôpnij") ||
 2516 |  35 |           text.includes("napisz komentarz") ||
 2517 |  36 |           text.includes("comment");
 2518 |  37 |         const looksLikeNotifications =
 2519 |  38 |           text.startsWith("powiadomienia") &&
 2520 |  39 |           text.includes("wszystkie") &&
 2521 |  40 |           text.includes("nieprzeczytane");
 2522 |  41 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 2523 |  42 |       });
 2524 |  43 |       if (postDialog) return postDialog;
 2525 |  44 |       const main = document.querySelector("div[role='main']");
 2526 |  45 |       if (main) {
 2527 |  46 |         const article = main.querySelector("article");
 2528 |  47 |         return article || main;
 2529 |  48 |       }
 2530 |  49 |       return document.body;
 2531 |  50 |     }
 2532 |  51 | 
 2533 |  52 |     function isVisible(el) {
 2534 |  53 |       if (!el) return false;
 2535 |  54 |       const style = window.getComputedStyle(el);
 2536 |  55 |       if (!style) return false;
 2537 |  56 |       if (style.display === "none" || style.visibility === "hidden") return false;
 2538 |  57 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
 2539 |  58 |       if (style.pointerEvents === "none") return false;
 2540 |  59 |       const rect = el.getBoundingClientRect();
 2541 |  60 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
 2542 |  61 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
 2543 |  62 |       return true;
 2544 |  63 |     }
 2545 |  64 | 
 2546 |  65 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
 2547 |  66 |     const root =
 2548 |  67 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
 2549 |  68 |     // (widok /watch/ jest traktowany jak video)
 2550 |  69 | 
 2551 |  70 |     const buttons = Array.from(
 2552 |  71 |       root.querySelectorAll(
 2553 |  72 |         "button, a, div[role='button'], span[role='button']"
 2554 |  73 |       )
 2555 |  74 |     );
 2556 |  75 | 
 2557 |  76 |     function classifyButton(raw) {
 2558 |  77 |       const text = raw.toLowerCase();
 2559 |  78 |       const hasCommentWord =
 2560 |  79 |         text.includes("komentarz") ||
 2561 |  80 |         text.includes("comments") ||
 2562 |  81 |         text.includes("comment");
 2563 |  82 |       const hasReplyWord =
 2564 |  83 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
 2565 |  84 |         text.includes("reply") ||
 2566 |  85 |         text.includes("replies") ||
 2567 |  86 |         text.includes("repl");
 2568 |  87 |       const hasMoreWord =
 2569 |  88 |         text.includes("wy≈õwietl") ||
 2570 |  89 |         text.includes("zobacz") ||
 2571 |  90 |         text.includes("poka≈º") ||
 2572 |  91 |         text.includes("view") ||
 2573 |  92 |         text.includes("show") ||
 2574 |  93 |         text.includes("see") ||
 2575 |  94 |         text.includes("wszystkie") ||
 2576 |  95 |         text.includes("all") ||
 2577 |  96 |         text.includes("previous");
 2578 |  97 |       const hasTranslationWord =
 2579 |  98 |         text.includes("t≈Çumaczenie") || text.includes("translation");
 2580 |  99 |       if (hasTranslationWord) return null;
 2581 | 100 |       if (
 2582 | 101 |         text === "komentarz" ||
 2583 | 102 |         text === "comment" ||
 2584 | 103 |         text === "lubiƒô to" ||
 2585 | 104 |         text === "lubiƒô to!" ||
 2586 | 105 |         text === "like" ||
 2587 | 106 |         text === "odpowiedz" ||
 2588 | 107 |         text === "reply"
 2589 | 108 |       ) {
 2590 | 109 |         return null;
 2591 | 110 |       }
 2592 | 111 |       if (
 2593 | 112 |         hasCommentWord &&
 2594 | 113 |         hasMoreWord &&
 2595 | 114 |         (text.includes("wiƒôcej") ||
 2596 | 115 |           text.includes("more") ||
 2597 | 116 |           text.includes("poprzednie") ||
 2598 | 117 |           text.includes("previous"))
 2599 | 118 |       ) {
 2600 | 119 |         return { kind: "more-comments", priority: 3 };
 2601 | 120 |       }
 2602 | 121 | 
 2603 | 122 |       // ‚úÖ ON/OFF odpowiedzi
 2604 | 123 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
 2605 | 124 |         return { kind: "more-replies", priority: 2 };
 2606 | 125 |       }
 2607 | 126 | 
 2608 | 127 |       if (
 2609 | 128 |         text === "zobacz wiƒôcej" ||
 2610 | 129 |         text === "see more" ||
 2611 | 130 |         text.startsWith("zobacz wiƒôcej ") ||
 2612 | 131 |         text.startsWith("see more ")
 2613 | 132 |       ) {
 2614 | 133 |         return { kind: "see-more-text", priority: 1 };
 2615 | 134 |       }
 2616 | 135 |       return null;
 2617 | 136 |     }
 2618 | 137 | 
 2619 | 138 |     const candidates = [];
 2620 | 139 | 
 2621 | 140 |     for (const el of buttons) {
 2622 | 141 |       if (!isVisible(el)) continue;
 2623 | 142 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
 2624 | 143 |       if (!raw) continue;
 2625 | 144 |       const cls = classifyButton(raw);
 2626 | 145 |       if (!cls) continue;
 2627 | 146 |       const rect = el.getBoundingClientRect();
 2628 | 147 |       candidates.push({
 2629 | 148 |         el,
 2630 | 149 |         kind: cls.kind,
 2631 | 150 |         priority: cls.priority,
 2632 | 151 |         top: rect.top,
 2633 | 152 |         text: raw,
 2634 | 153 |       });
 2635 | 154 |     }
 2636 | 155 | 
 2637 | 156 |     if (!candidates.length) {
 2638 | 157 |       return { clicked: false };
 2639 | 158 |     }
 2640 | 159 | 
 2641 | 160 |     candidates.sort((a, b) => {
 2642 | 161 |       if (a.priority !== b.priority) return b.priority - a.priority;
 2643 | 162 |       return a.top - b.top;
 2644 | 163 |     });
 2645 | 164 | 
 2646 | 165 |     const chosen = candidates[0];
 2647 | 166 |     try {
 2648 | 167 |       chosen.el.click();
 2649 | 168 |       return {
 2650 | 169 |         clicked: true,
 2651 | 170 |         kind: chosen.kind,
 2652 | 171 |         text: chosen.text,
 2653 | 172 |       };
 2654 | 173 |     } catch (e) {
 2655 | 174 |       return { clicked: false };
 2656 | 175 |     }
 2657 | 176 |   }, INCLUDE_REPLIES);
 2658 | 177 | 
 2659 | 178 |   if (res && res.clicked) {
 2660 | 179 |     log.debug("EXPAND", `Klik '${res.text}' (${res.kind})`);
 2661 | 180 |     // Human behavior: op√≥≈∫nienie po klikniƒôciu (czekaj na reakcjƒô UI)
 2662 | 181 |     await humanDelay(400, 0.3);
 2663 | 182 |   }
 2664 | 183 |   return !!(res && res.clicked);
 2665 | 184 | }
 2666 | 185 | 
 2667 | 186 | export { clickOneExpandButton };
 2668 | 187 | 
 2669 | ```
 2670 | 
 2671 | ---
 2672 | 
 2673 | ### üìÑ ≈öcie≈ºka: `src/fb/legacy/comments.legacy.js`
 2674 | **Typ:** JavaScript/tekst  
 2675 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 2676 | 
 2677 | ```js
 2678 |    1 | // src/fb/comments.js
 2679 |    2 | // src/fb/legacy/comments.legacy.js
 2680 |    3 | import { EXPAND_COMMENTS } from "../../config.js";
 2681 |    4 | import { sleepRandom } from "../../utils/sleep.js";
 2682 |    5 | import { safeGoto } from "../../utils/navigation.js";
 2683 |    6 | 
 2684 |    7 | import { scrollPost } from "../scroll.js";
 2685 |    8 | import { acceptCookies, saveCookies } from "../cookies.js";
 2686 |    9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
 2687 |   10 | import { clickOneExpandButton } from "../expandButtons.js";
 2688 |   11 | import { getUiCommentInfo } from "../uiCommentInfo.js";
 2689 |   12 | 
 2690 |   13 | 
 2691 |   14 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
 2692 |   15 |   ? Number(process.env.NAV_TIMEOUT_MS)
 2693 |   16 |   : 90000; // by≈Ço 60000, podbijamy do 90s
 2694 |   17 | 
 2695 |   18 | let firstPostPauseDone = false;
 2696 |   19 | /* ============================================================
 2697 |   20 |    =======  PRZE≈ÅƒÑCZANIE FILTRA ‚ÄûWSZYSTKIE KOMENTARZE‚Äù  ========
 2698 |   21 |    ============================================================ */
 2699 |   22 | 
 2700 |   23 | async function switchCommentsFilterToAll(page) {
 2701 |   24 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
 2702 |   25 | 
 2703 |   26 |   // 1) je≈õli menu ju≈º jest otwarte ‚Äì nie klikamy ponownie, tylko pr√≥bujemy wybraƒá opcjƒô "Wszystkie komentarze" z istniejƒÖcego menu
 2704 |   27 |   const menuAlreadyOpen = await page.evaluate(() => {
 2705 |   28 |     return !!document.querySelector("div[role='menu']");
 2706 |   29 |   });
 2707 |   30 | 
 2708 |   31 |   if (menuAlreadyOpen) {
 2709 |   32 |     console.log("[FB][filter] Menu filtra ju≈º otwarte ‚Äì pr√≥bujƒô wybraƒá opcjƒô.");
 2710 |   33 | 
 2711 |   34 |     const menuResult = await clickAllCommentsInMenu(page);
 2712 |   35 |     if (menuResult.clicked) {
 2713 |   36 |       console.log("[FB][filter] Wybrano 'Wszystkie komentarze' z otwartego menu.");
 2714 |   37 |       return true;
 2715 |   38 |     }
 2716 |   39 |     console.log("[FB][filter] Menu otwarte, ale nie ma opcji 'Wszystkie komentarze'.");
 2717 |   40 |     return false;
 2718 |   41 |   }
 2719 |   42 | 
 2720 |   43 |   // 2) spr√≥buj znale≈∫ƒá bie≈ºƒÖcy przycisk filtra i sprawdziƒá, co jest ustawione
 2721 |   44 |   const pre = await page.evaluate(() => {
 2722 |   45 |     const els = Array.from(
 2723 |   46 |       document.querySelectorAll("div[role='button'], span[role='button']")
 2724 |   47 |     );
 2725 |   48 |     let filterEl = null;
 2726 |   49 |     let labelText = "";
 2727 |   50 |     for (const el of els) {
 2728 |   51 |       const t = (el.textContent || "").trim();
 2729 |   52 |       if (!t) continue;
 2730 |   53 |       const low = t.toLowerCase();
 2731 |   54 |       if (
 2732 |   55 |         low === "najtrafniejsze" ||
 2733 |   56 |         low === "most relevant" ||
 2734 |   57 |         low === "wszystkie komentarze" ||
 2735 |   58 |         low === "all comments"
 2736 |   59 |       ) {
 2737 |   60 |         filterEl = el;
 2738 |   61 |         labelText = low;
 2739 |   62 |         break;
 2740 |   63 |       }
 2741 |   64 |     }
 2742 |   65 |     if (!filterEl) {
 2743 |   66 |       return { state: "not-found" };
 2744 |   67 |     }
 2745 |   68 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 2746 |   69 |       return { state: "already-all" };
 2747 |   70 |     }
 2748 |   71 |     filterEl.click();
 2749 |   72 |     return { state: "clicked-filter" };
 2750 |   73 |   });
 2751 |   74 | 
 2752 |   75 |   if (pre.state === "not-found") {
 2753 |   76 |     console.log("[FB][filter] Nie znaleziono przycisku filtra komentarzy.");
 2754 |   77 |     return false;
 2755 |   78 |   }
 2756 |   79 |   if (pre.state === "already-all") {
 2757 |   80 |     console.log("[FB][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' ‚Äì pomijam.");
 2758 |   81 |     return true;
 2759 |   82 |   }
 2760 |   83 |   if (pre.state === "clicked-filter") {
 2761 |   84 |     await sleepRandom(400, 800);
 2762 |   85 |     const menuResult = await clickAllCommentsInMenu(page);
 2763 |   86 |     if (!menuResult.clicked && menuResult.noMenu) {
 2764 |   87 |       // fallback: mo≈ºe filtr prze≈ÇƒÖcza siƒô bez menu ‚Äì sprawdzamy label jeszcze raz
 2765 |   88 |       const afterLabelIsAll = await page.evaluate(() => {
 2766 |   89 |         const els = Array.from(
 2767 |   90 |           document.querySelectorAll("div[role='button'], span[role='button']")
 2768 |   91 |         );
 2769 |   92 |         const btn = els.find((el) => {
 2770 |   93 |           const t = (el.textContent || "").trim().toLowerCase();
 2771 |   94 |           return t === "wszystkie komentarze" || t === "all comments";
 2772 |   95 |         });
 2773 |   96 |         return !!btn;
 2774 |   97 |       });
 2775 |   98 |       if (afterLabelIsAll) {
 2776 |   99 |         console.log(
 2777 |  100 |           "[FB][filter] Po klikniƒôciu filtr prze≈ÇƒÖczy≈Ç siƒô bez menu na 'Wszystkie komentarze'."
 2778 |  101 |         );
 2779 |  102 |         return true;
 2780 |  103 |       }
 2781 |  104 |       console.log(
 2782 |  105 |         "[FB][filter] Klikniƒôto filtr, ale nie pojawi≈Ço siƒô menu i label nie jest 'Wszystkie komentarze'."
 2783 |  106 |       );
 2784 |  107 |       return false;
 2785 |  108 |     }
 2786 |  109 |     if (!menuResult.clicked && !menuResult.noMenu) {
 2787 |  110 |       console.log("[FB][filter] Menu filtra jest, ale brak opcji 'Wszystkie komentarze'.");
 2788 |  111 |       return false;
 2789 |  112 |     }
 2790 |  113 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze'.");
 2791 |  114 |     return true;
 2792 |  115 |   }
 2793 |  116 |   console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);
 2794 |  117 |   return false;
 2795 |  118 | }
 2796 |  119 | 
 2797 |  120 | async function clickShowAllCommentsIfPresent(page) {
 2798 |  121 |   console.log("[FB][show-all] Pr√≥ba klikniƒôcia 'Poka≈º wszystkie' (aria-label)‚Ä¶");
 2799 |  122 | 
 2800 |  123 |   try {
 2801 |  124 |     const clicked = await page.evaluate(() => {
 2802 |  125 |       // Je≈õli filtr ju≈º jest, to znaczy ≈ºe "Poka≈º wszystkie" zosta≈Ço klikniƒôte / niepotrzebne
 2803 |  126 |       const bodyText = (document.body.innerText || "").toLowerCase();
 2804 |  127 |       if (
 2805 |  128 |         bodyText.includes("najtrafniejsze") ||
 2806 |  129 |         bodyText.includes("najnowsze") ||
 2807 |  130 |         bodyText.includes("wszystkie komentarze") ||
 2808 |  131 |         bodyText.includes("all comments") ||
 2809 |  132 |         bodyText.includes("ukryj komentarze") ||
 2810 |  133 |         bodyText.includes("hide comments")
 2811 |  134 |       ) {
 2812 |  135 |         return false;
 2813 |  136 |       }
 2814 |  137 |       const selectors = [
 2815 |  138 |         "div[aria-label='Poka≈º wszystkie'][role='button']",
 2816 |  139 |         "div[aria-label='Wy≈õwietl wszystkie'][role='button']",
 2817 |  140 |         "div[aria-label='Show all'][role='button']",
 2818 |  141 |         "div[aria-label='View all'][role='button']",
 2819 |  142 |       ];
 2820 |  143 |       let el = null;
 2821 |  144 |       for (const sel of selectors) {
 2822 |  145 |         el = document.querySelector(sel);
 2823 |  146 |         if (el) break;
 2824 |  147 |       }
 2825 |  148 |       if (!el) return false;
 2826 |  149 |       try {
 2827 |  150 |         el.scrollIntoView({ block: "center", inline: "nearest" });
 2828 |  151 |       } catch (e) {
 2829 |  152 |         // scrollIntoView nie musi siƒô udaƒá
 2830 |  153 |       }
 2831 |  154 |       if (typeof el.click === "function") {
 2832 |  155 |         el.click();
 2833 |  156 |         return true;
 2834 |  157 |       }
 2835 |  158 |       return false;
 2836 |  159 |     });
 2837 |  160 |     if (!clicked) {
 2838 |  161 |       console.log(
 2839 |  162 |         "[FB][show-all] Nie znaleziono aria-label='Poka≈º wszystkie' albo filtr ju≈º widoczny ‚Äì pomijam."
 2840 |  163 |       );
 2841 |  164 |       return false;
 2842 |  165 |     }
 2843 |  166 |     console.log("[FB][show-all] Klikniƒôto 'Poka≈º wszystkie' (aria-label).");
 2844 |  167 |     await sleepRandom(900, 1600);
 2845 |  168 |     return true;
 2846 |  169 |   } catch (err) {
 2847 |  170 |     console.log(
 2848 |  171 |       "[FB][show-all] B≈ÇƒÖd podczas klikania 'Poka≈º wszystkie':",
 2849 |  172 |       err?.message || err
 2850 |  173 |     );
 2851 |  174 |     return false;
 2852 |  175 |   }
 2853 |  176 | }
 2854 |  177 | import fs from 'fs';
 2855 |  178 | 
 2856 |  179 | async function extractCommentsFromDOM(page) {
 2857 |  180 |   const data = await page.evaluate(() => {
 2858 |  181 |     function extractCommentId(url) {
 2859 |  182 |       const match = url?.match(/comment_id=([^&]+)/);
 2860 |  183 |       return match ? decodeURIComponent(match[1]) : null;
 2861 |  184 |     }
 2862 |  185 | 
 2863 |  186 |     // Mapa commentId -> time
 2864 |  187 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 2865 |  188 |     const idToTimeMap = {};
 2866 |  189 | 
 2867 |  190 |     for (let i = 0; i < allLinks.length; i++) {
 2868 |  191 |       const link = allLinks[i];
 2869 |  192 |       const href = link.getAttribute('href') || '';
 2870 |  193 |       const id = extractCommentId(href);
 2871 |  194 | 
 2872 |  195 |       if (id) {
 2873 |  196 |         // Szukamy nastƒôpnego linka z tekstem typu "1 godz.", "2 dni" itd.
 2874 |  197 |         for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
 2875 |  198 |           const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
 2876 |  199 |           if (timeText && /^\d+\s?(min|godz|sek|dni|tyg)/.test(timeText)) {
 2877 |  200 |             idToTimeMap[id] = timeText;
 2878 |  201 |             break;
 2879 |  202 |           }
 2880 |  203 |         }
 2881 |  204 |       }
 2882 |  205 |     }
 2883 |  206 | 
 2884 |  207 |     const commentNodes = Array.from(
 2885 |  208 |       document.querySelectorAll('div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k')
 2886 |  209 |     );
 2887 |  210 | 
 2888 |  211 |     const extracted = commentNodes.map((node) => {
 2889 |  212 |       try {
 2890 |  213 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim();
 2891 |  214 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim();
 2892 |  215 |         const linkEl = node.querySelector('a[role="link"]');
 2893 |  216 |         const href = linkEl?.getAttribute('href');
 2894 |  217 |         const permalink = href?.startsWith('http') ? href : `https://www.facebook.com${href}`;
 2895 |  218 |         const id = extractCommentId(permalink) || null;
 2896 |  219 | 
 2897 |  220 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
 2898 |  221 | 
 2899 |  222 |         if (!author || !text) return null;
 2900 |  223 | 
 2901 |  224 |         return { id, author, text, permalink, time };
 2902 |  225 |       } catch (err) {
 2903 |  226 |         return null;
 2904 |  227 |       }
 2905 |  228 |     }).filter(Boolean);
 2906 |  229 | 
 2907 |  230 |     return extracted;
 2908 |  231 |   });
 2909 |  232 | 
 2910 |  233 |   console.log('[FB] extractCommentsFromDOM ‚Äì wyciƒÖgniƒôto komentarzy:', data.length);
 2911 |  234 |   console.log('[DBG] Komentarze:', JSON.stringify(data, null, 2));
 2912 |  235 | 
 2913 |  236 |   return data;
 2914 |  237 | }
 2915 |  238 | 
 2916 |  239 | 
 2917 |  240 | 
 2918 |  241 | 
 2919 |  242 | /* ============================================================
 2920 |  243 |    =========== POST ROOT (DIALOG / MAIN / FALLBACK) ============
 2921 |  244 |    ============================================================ */
 2922 |  245 | 
 2923 |  246 | async function clickAllCommentsInMenu(page) {
 2924 |  247 |   const result = await page.evaluate(() => {
 2925 |  248 |     const menu =
 2926 |  249 |       document.querySelector("div[role='menu']") ||
 2927 |  250 |       document.querySelector("div[role='dialog']");
 2928 |  251 |     if (!menu) {
 2929 |  252 |       return { clicked: false, noMenu: true };
 2930 |  253 |     }
 2931 |  254 |     const items = Array.from(
 2932 |  255 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 2933 |  256 |     );
 2934 |  257 |     const opt = items.find((el) => {
 2935 |  258 |       const t = (el.textContent || "").trim().toLowerCase();
 2936 |  259 |       return (
 2937 |  260 |         t.startsWith("wszystkie komentarze") ||
 2938 |  261 |         t.startsWith("all comments")
 2939 |  262 |       );
 2940 |  263 |     });
 2941 |  264 |     if (!opt) {
 2942 |  265 |       return { clicked: false, noMenu: false };
 2943 |  266 |     }
 2944 |  267 |     opt.click();
 2945 |  268 |     setTimeout(() => {
 2946 |  269 |       try {
 2947 |  270 |         document.body.click();
 2948 |  271 |       } catch {}
 2949 |  272 |     }, 50);
 2950 |  273 |     return { clicked: true, noMenu: false };
 2951 |  274 |   });
 2952 |  275 |   if (result.clicked) {
 2953 |  276 |     await sleepRandom(300, 600);
 2954 |  277 |     await page
 2955 |  278 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
 2956 |  279 |         timeout: 2000,
 2957 |  280 |       })
 2958 |  281 |       .catch(() => {});
 2959 |  282 |   }
 2960 |  283 |   return result;
 2961 |  284 | }
 2962 |  285 | 
 2963 |  286 | /* ============================================================
 2964 |  287 |    ===== POMOCNICZE: LICZENIE ID KOMENTARZY ====================
 2965 |  288 |    ============================================================ */
 2966 |  289 | 
 2967 |  290 | function postRootScript() {
 2968 |  291 |   return `
 2969 |  292 |     function getPostRoot() {
 2970 |  293 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 2971 |  294 |       const postDialog = dialogs.find((dlg) => {
 2972 |  295 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 2973 |  296 |         if (!text) return false;
 2974 |  297 |         const hasCommentWord =
 2975 |  298 |           text.includes("komentarz") || text.includes("comment");
 2976 |  299 |         const hasActions =
 2977 |  300 |           text.includes("lubiƒô to") ||
 2978 |  301 |           text.includes("komentarz") ||
 2979 |  302 |           text.includes("udostƒôpnij") ||
 2980 |  303 |           text.includes("napisz komentarz") ||
 2981 |  304 |           text.includes("comment");
 2982 |  305 |         const looksLikeNotifications =
 2983 |  306 |           text.startsWith("powiadomienia") &&
 2984 |  307 |           text.includes("wszystkie") &&
 2985 |  308 |           text.includes("nieprzeczytane");
 2986 |  309 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 2987 |  310 |       });
 2988 |  311 |       if (postDialog) return postDialog;
 2989 |  312 |       const main = document.querySelector("div[role='main']");
 2990 |  313 |       if (main) {
 2991 |  314 |         const article = main.querySelector("article");
 2992 |  315 |         return article || main;
 2993 |  316 |       }
 2994 |  317 |       return document.body;
 2995 |  318 |     }
 2996 |  319 |   `;
 2997 |  320 | }
 2998 |  321 | 
 2999 |  322 | async function getCurrentCommentAnchorCount(page) {
 3000 |  323 |   const count = await page.evaluate(() => {
 3001 |  324 |     const anchors = Array.from(
 3002 |  325 |       document.querySelectorAll(
 3003 |  326 |         "a[href*='comment_id'], a[href*='reply_comment_id']"
 3004 |  327 |       )
 3005 |  328 |     );
 3006 |  329 |     const ids = new Set();
 3007 |  330 |     for (const a of anchors) {
 3008 |  331 |       try {
 3009 |  332 |         const url = new URL(a.href);
 3010 |  333 |         const cid = url.searchParams.get("comment_id");
 3011 |  334 |         const rid = url.searchParams.get("reply_comment_id");
 3012 |  335 |         let raw = rid || cid;
 3013 |  336 |         if (!raw) continue;
 3014 |  337 |         if (!/^\d+$/.test(raw)) {
 3015 |  338 |           try {
 3016 |  339 |             const dec = atob(raw);
 3017 |  340 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 3018 |  341 |             if (m) raw = m[2];
 3019 |  342 |           } catch {}
 3020 |  343 |         }
 3021 |  344 |         if (raw) ids.add(raw);
 3022 |  345 |       } catch {}
 3023 |  346 |     }
 3024 |  347 |     return ids.size;
 3025 |  348 |   });
 3026 |  349 |   return count || 0;
 3027 |  350 | }
 3028 |  351 | 
 3029 |  352 | /* ============================================================
 3030 |  353 |    ======= SCROLL W OBRƒòBIE POSTA (DIALOG/MAIN/FALLBACK) =======
 3031 |  354 |    ============================================================ */
 3032 |  355 | 
 3033 |  356 | async function scrollWithinPost(page, label, factor = 0.3) {
 3034 |  357 |   const info = await page.evaluate(
 3035 |  358 |     (factorArg, labelArg, postRootCode) => {
 3036 |  359 |       const href = location.href;
 3037 |  360 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 3038 |  361 |         href
 3039 |  362 |       );
 3040 |  363 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 3041 |  364 |       // wstrzykujemy funkcjƒô getPostRoot
 3042 |  365 |       // eslint-disable-next-line no-eval
 3043 |  366 |       eval(postRootCode);
 3044 |  367 |       // @ts-ignore
 3045 |  368 |       const rootFn =
 3046 |  369 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 3047 |  370 |       function pushIfScrollable(list, el, labelName) {
 3048 |  371 |         if (!el) return;
 3049 |  372 |         const style = window.getComputedStyle(el);
 3050 |  373 |         if (!style) return;
 3051 |  374 |         const oy = style.overflowY;
 3052 |  375 |         const clientH = el.clientHeight || 0;
 3053 |  376 |         const scrollH = el.scrollHeight || 0;
 3054 |  377 |         const delta = scrollH - clientH;
 3055 |  378 |         if (
 3056 |  379 |           clientH > 0 &&
 3057 |  380 |           delta > 10 &&
 3058 |  381 |           (oy === "auto" ||
 3059 |  382 |             oy === "scroll" ||
 3060 |  383 |             oy === "overlay" ||
 3061 |  384 |             oy === "hidden")
 3062 |  385 |         ) {
 3063 |  386 |           list.push({ el, label: labelName, delta });
 3064 |  387 |         }
 3065 |  388 |       }
 3066 |  389 |       let container = null;
 3067 |  390 |       let containerType = null;
 3068 |  391 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 3069 |  392 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 3070 |  393 |       if (cached) {
 3071 |  394 |         container = cached;
 3072 |  395 |         containerType = "cached-comments";
 3073 |  396 |       }
 3074 |  397 |       // ===== PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy "oficjalny" panel komentarzy =====
 3075 |  398 |       if (!container && (isPhotoView || isVideoView)) {
 3076 |  399 |         const moreCommentsBtn = Array.from(
 3077 |  400 |           document.querySelectorAll(
 3078 |  401 |             "button, div[role='button'], span[role='button']"
 3079 |  402 |           )
 3080 |  403 |         ).find((el) => {
 3081 |  404 |           const t = (el.textContent || "").toLowerCase();
 3082 |  405 |           return (
 3083 |  406 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 3084 |  407 |             t.includes("zobacz wiƒôcej komentarzy") ||
 3085 |  408 |             t.includes("view more comments") ||
 3086 |  409 |             t.includes("view previous comments")
 3087 |  410 |           );
 3088 |  411 |         });
 3089 |  412 |         if (moreCommentsBtn) {
 3090 |  413 |           let p = moreCommentsBtn.parentElement;
 3091 |  414 |           while (p && p !== document.body && p !== document.documentElement) {
 3092 |  415 |             const style = window.getComputedStyle(p);
 3093 |  416 |             const oy = style.overflowY;
 3094 |  417 |             const ch = p.clientHeight || 0;
 3095 |  418 |             const sh = p.scrollHeight || 0;
 3096 |  419 |             const delta = sh - ch;
 3097 |  420 |             if (
 3098 |  421 |               ch > 0 &&
 3099 |  422 |               delta > 10 &&
 3100 |  423 |               (oy === "auto" ||
 3101 |  424 |                 oy === "scroll" ||
 3102 |  425 |                 oy === "overlay" ||
 3103 |  426 |                 oy === "hidden")
 3104 |  427 |             ) {
 3105 |  428 |               container = p;
 3106 |  429 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 3107 |  430 |               break;
 3108 |  431 |             }
 3109 |  432 |             p = p.parentElement;
 3110 |  433 |           }
 3111 |  434 |         }
 3112 |  435 |         // VIDEO ‚Äì dodatkowa pr√≥ba: po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 3113 |  436 |         if (!container && isVideoView) {
 3114 |  437 |           const commentsHeader = Array.from(
 3115 |  438 |             document.querySelectorAll("div, span")
 3116 |  439 |           ).find((el) => {
 3117 |  440 |             const t = (el.textContent || "").toLowerCase();
 3118 |  441 |             return (
 3119 |  442 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 3120 |  443 |               (t.includes("comments") && t.includes("most relevant")) ||
 3121 |  444 |               t.trim() === "komentarze" ||
 3122 |  445 |               t.trim() === "comments"
 3123 |  446 |             );
 3124 |  447 |           });
 3125 |  448 |           if (commentsHeader) {
 3126 |  449 |             let p = commentsHeader.parentElement;
 3127 |  450 |             while (p && p !== document.body && p !== document.documentElement) {
 3128 |  451 |               const style = window.getComputedStyle(p);
 3129 |  452 |               const oy = style.overflowY;
 3130 |  453 |               const ch = p.clientHeight || 0;
 3131 |  454 |               const sh = p.scrollHeight || 0;
 3132 |  455 |               const delta = sh - ch;
 3133 |  456 |               if (
 3134 |  457 |                 ch > 0 &&
 3135 |  458 |                 delta > 10 &&
 3136 |  459 |                 (oy === "auto" ||
 3137 |  460 |                   oy === "scroll" ||
 3138 |  461 |                   oy === "overlay" ||
 3139 |  462 |                   oy === "hidden")
 3140 |  463 |               ) {
 3141 |  464 |                 container = p;
 3142 |  465 |                 containerType = "video-comments-header";
 3143 |  466 |                 break;
 3144 |  467 |               }
 3145 |  468 |               p = p.parentElement;
 3146 |  469 |             }
 3147 |  470 |           }
 3148 |  471 |         }
 3149 |  472 |         // dodatkowy fallback na VIDEO ‚Äì po polu "Napisz komentarz..."
 3150 |  473 |         if (!container && isVideoView) {
 3151 |  474 |           const commentBox = Array.from(
 3152 |  475 |             document.querySelectorAll("div[role='textbox'], textarea")
 3153 |  476 |           ).find((el) => {
 3154 |  477 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 3155 |  478 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 3156 |  479 |             const txt = (el.textContent || "").toLowerCase();
 3157 |  480 |             const needles = [
 3158 |  481 |               "napisz komentarz",
 3159 |  482 |               "write a comment",
 3160 |  483 |               "escribe un comentario",
 3161 |  484 |               "schreibe einen kommentar",
 3162 |  485 |             ];
 3163 |  486 |             return needles.some((n) =>
 3164 |  487 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 3165 |  488 |             );
 3166 |  489 |           });
 3167 |  490 |           if (commentBox) {
 3168 |  491 |             let p = commentBox.parentElement;
 3169 |  492 |             while (p && p !== document.body && p !== document.documentElement) {
 3170 |  493 |               const style = window.getComputedStyle(p);
 3171 |  494 |               const oy = style.overflowY;
 3172 |  495 |               const ch = p.clientHeight || 0;
 3173 |  496 |               const sh = p.scrollHeight || 0;
 3174 |  497 |               const delta = sh - ch;
 3175 |  498 |               if (
 3176 |  499 |                 ch > 0 &&
 3177 |  500 |                 delta > 10 &&
 3178 |  501 |                 (oy === "auto" ||
 3179 |  502 |                   oy === "scroll" ||
 3180 |  503 |                   oy === "overlay" ||
 3181 |  504 |                   oy === "hidden")
 3182 |  505 |               ) {
 3183 |  506 |                 container = p;
 3184 |  507 |                 containerType = "video-comments-textbox";
 3185 |  508 |                 break;
 3186 |  509 |               }
 3187 |  510 |               p = p.parentElement;
 3188 |  511 |             }
 3189 |  512 |           }
 3190 |  513 |         }
 3191 |  514 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì nie ruszamy okna
 3192 |  515 |         if (isVideoView && !container) {
 3193 |  516 |           const cur = window.scrollY || 0;
 3194 |  517 |           return {
 3195 |  518 |             before: cur,
 3196 |  519 |             after: cur,
 3197 |  520 |             container: "video-no-scroll",
 3198 |  521 |             label: labelArg,
 3199 |  522 |           };
 3200 |  523 |         }
 3201 |  524 |       }
 3202 |  525 |       // ===== Standardowa heurystyka (permalink / photo fallback) =====
 3203 |  526 |       if (!container) {
 3204 |  527 |         const root = rootFn() || document.body;
 3205 |  528 |         const candidates = [];
 3206 |  529 |         pushIfScrollable(candidates, root, "root");
 3207 |  530 |         const dialog =
 3208 |  531 |           root.closest("div[role='dialog']") ||
 3209 |  532 |           document.querySelector("div[role='dialog']");
 3210 |  533 |         if (dialog) {
 3211 |  534 |           pushIfScrollable(candidates, dialog, "dialog");
 3212 |  535 |         }
 3213 |  536 |         const scope = dialog || root;
 3214 |  537 |         const blocks = Array.from(
 3215 |  538 |           scope.querySelectorAll("div, section, main, article")
 3216 |  539 |         );
 3217 |  540 |         for (const el of blocks) {
 3218 |  541 |           pushIfScrollable(candidates, el, "auto");
 3219 |  542 |         }
 3220 |  543 |         let best = null;
 3221 |  544 |         for (const c of candidates) {
 3222 |  545 |           if (!best || c.delta > best.delta) best = c;
 3223 |  546 |         }
 3224 |  547 |         if (best) {
 3225 |  548 |           container = best.el;
 3226 |  549 |           containerType = best.label;
 3227 |  550 |         } else {
 3228 |  551 |           container =
 3229 |  552 |             document.scrollingElement ||
 3230 |  553 |             document.documentElement ||
 3231 |  554 |             document.body;
 3232 |  555 |           const delta =
 3233 |  556 |             (container.scrollHeight || 0) - (container.clientHeight || 0);
 3234 |  557 |           if (delta <= 0) {
 3235 |  558 |             const cur = container.scrollTop || window.scrollY || 0;
 3236 |  559 |             return {
 3237 |  560 |               before: cur,
 3238 |  561 |               after: cur,
 3239 |  562 |               container: "window-no-scroll",
 3240 |  563 |               label: labelArg,
 3241 |  564 |             };
 3242 |  565 |           }
 3243 |  566 |           containerType = "window";
 3244 |  567 |         }
 3245 |  568 |       }
 3246 |  569 |       // Zapamiƒôtujemy kontener komentarzy (≈ºeby kolejne wywo≈Çania go u≈ºy≈Çy)
 3247 |  570 |       if (container) {
 3248 |  571 |         const isRootContainer =
 3249 |  572 |           container === document.body ||
 3250 |  573 |           container === document.documentElement ||
 3251 |  574 |           container === document.scrollingElement;
 3252 |  575 |         if (!isRootContainer) {
 3253 |  576 |           try {
 3254 |  577 |             container.setAttribute("data-fbwatcher-comments", "1");
 3255 |  578 |           } catch {}
 3256 |  579 |         }
 3257 |  580 |       }
 3258 |  581 |       const isWindowContainer =
 3259 |  582 |         container === document.body ||
 3260 |  583 |         container === document.documentElement ||
 3261 |  584 |         container === document.scrollingElement;
 3262 |  585 |       // na watch nie scrollujemy okna, tylko panel komentarzy
 3263 |  586 |       if (isVideoView && isWindowContainer) {
 3264 |  587 |         const cur = window.scrollY || 0;
 3265 |  588 |         return {
 3266 |  589 |           before: cur,
 3267 |  590 |           after: cur,
 3268 |  591 |           container: "video-window-blocked",
 3269 |  592 |           label: labelArg,
 3270 |  593 |         };
 3271 |  594 |       }
 3272 |  595 |       const before = isWindowContainer
 3273 |  596 |         ? window.scrollY || 0
 3274 |  597 |         : container.scrollTop || 0;
 3275 |  598 |       const maxScroll =
 3276 |  599 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 3277 |  600 |       if (maxScroll <= 0) {
 3278 |  601 |         return {
 3279 |  602 |           before,
 3280 |  603 |           after: before,
 3281 |  604 |           container: (containerType || "unknown") + "-no-scroll",
 3282 |  605 |           label: labelArg,
 3283 |  606 |         };
 3284 |  607 |       }
 3285 |  608 |       const factor = factorArg || 0.3;
 3286 |  609 |       const sign = factor < 0 ? -1 : 1;
 3287 |  610 |       const magnitude = Math.min(Math.abs(factor), 1);
 3288 |  611 |       const baseStep =
 3289 |  612 |         (container.clientHeight || window.innerHeight || 600) * magnitude;
 3290 |  613 |       // na VIDEO robimy mniejszy krok, ≈ºeby nie przeskakiwaƒá przycisk√≥w
 3291 |  614 |       let step = Math.max(30, Math.min(baseStep, isVideoView ? 180 : 220));
 3292 |  615 |       let target;
 3293 |  616 |       if (sign < 0) {
 3294 |  617 |         target = Math.max(0, before - step);
 3295 |  618 |       } else {
 3296 |  619 |         target = Math.min(maxScroll, before + step);
 3297 |  620 |       }
 3298 |  621 |       if (isWindowContainer) {
 3299 |  622 |         window.scrollTo(0, target);
 3300 |  623 |       } else {
 3301 |  624 |         container.scrollTop = target;
 3302 |  625 |       }
 3303 |  626 |       const after = isWindowContainer
 3304 |  627 |         ? window.scrollY || 0
 3305 |  628 |         : container.scrollTop || 0;
 3306 |  629 |       return {
 3307 |  630 |         before,
 3308 |  631 |         after,
 3309 |  632 |         container: containerType || "unknown",
 3310 |  633 |         label: labelArg,
 3311 |  634 |       };
 3312 |  635 |     },
 3313 |  636 |     factor,
 3314 |  637 |     label,
 3315 |  638 |     postRootScript()
 3316 |  639 |   );
 3317 |  640 |   return info;
 3318 |  641 | }
 3319 |  642 | 
 3320 |  643 | /* ============================================================
 3321 |  644 |    ======= DOCIƒÑGNIƒòCIE DO ABSOLUTNEGO DO≈ÅU KOMENTARZY =========
 3322 |  645 |    ============================================================ */
 3323 |  646 | 
 3324 |  647 | async function scrollToAbsoluteBottom(page, label = "bottom") {
 3325 |  648 |   const info = await page.evaluate(
 3326 |  649 |     (labelArg, postRootCode) => {
 3327 |  650 |       const href = location.href;
 3328 |  651 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 3329 |  652 |         href
 3330 |  653 |       );
 3331 |  654 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
 3332 |  655 |       // wstrzykujemy funkcjƒô getPostRoot
 3333 |  656 |       // eslint-disable-next-line no-eval
 3334 |  657 |       eval(postRootCode);
 3335 |  658 |       // @ts-ignore
 3336 |  659 |       const rootFn =
 3337 |  660 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
 3338 |  661 |       function pushIfScrollable(list, el, labelName) {
 3339 |  662 |         if (!el) return;
 3340 |  663 |         const style = window.getComputedStyle(el);
 3341 |  664 |         if (!style) return;
 3342 |  665 |         const oy = style.overflowY;
 3343 |  666 |         const clientH = el.clientHeight || 0;
 3344 |  667 |         const scrollH = el.scrollHeight || 0;
 3345 |  668 |         const delta = scrollH - clientH;
 3346 |  669 |         if (
 3347 |  670 |           clientH > 0 &&
 3348 |  671 |           delta > 10 &&
 3349 |  672 |           (oy === "auto" ||
 3350 |  673 |             oy === "scroll" ||
 3351 |  674 |             oy === "overlay" ||
 3352 |  675 |             oy === "hidden")
 3353 |  676 |         ) {
 3354 |  677 |           list.push({ el, label: labelName, delta });
 3355 |  678 |         }
 3356 |  679 |       }
 3357 |  680 |       let container = null;
 3358 |  681 |       let containerType = null;
 3359 |  682 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
 3360 |  683 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
 3361 |  684 |       if (cached) {
 3362 |  685 |         container = cached;
 3363 |  686 |         containerType = "cached-comments";
 3364 |  687 |       }
 3365 |  688 |       // PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy znale≈∫ƒá panel komentarzy
 3366 |  689 |       if (!container && (isPhotoView || isVideoView)) {
 3367 |  690 |         const moreCommentsBtn = Array.from(
 3368 |  691 |           document.querySelectorAll(
 3369 |  692 |             "button, div[role='button'], span[role='button']"
 3370 |  693 |           )
 3371 |  694 |         ).find((el) => {
 3372 |  695 |           const t = (el.textContent || "").toLowerCase();
 3373 |  696 |           return (
 3374 |  697 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 3375 |  698 |             t.includes("zobacz wiƒôcej komentarzy") ||
 3376 |  699 |             t.includes("view more comments") ||
 3377 |  700 |             t.includes("view previous comments")
 3378 |  701 |           );
 3379 |  702 |         });
 3380 |  703 |         if (moreCommentsBtn) {
 3381 |  704 |           let p = moreCommentsBtn.parentElement;
 3382 |  705 |           while (p && p !== document.body && p !== document.documentElement) {
 3383 |  706 |             const style = window.getComputedStyle(p);
 3384 |  707 |             const oy = style.overflowY;
 3385 |  708 |             const ch = p.clientHeight || 0;
 3386 |  709 |             const sh = p.scrollHeight || 0;
 3387 |  710 |             const delta = sh - ch;
 3388 |  711 |             if (
 3389 |  712 |               ch > 0 &&
 3390 |  713 |               delta > 10 &&
 3391 |  714 |               (oy === "auto" || oy === "scroll" || oy === "overlay" || oy === "hidden")
 3392 |  715 |             ) {
 3393 |  716 |               container = p;
 3394 |  717 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
 3395 |  718 |               break;
 3396 |  719 |             }
 3397 |  720 |             p = p.parentElement;
 3398 |  721 |           }
 3399 |  722 |         }
 3400 |  723 |         // dodatkowa pr√≥ba po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
 3401 |  724 |         if (!container && isVideoView) {
 3402 |  725 |           const commentsHeader = Array.from(
 3403 |  726 |             document.querySelectorAll("div, span")
 3404 |  727 |           ).find((el) => {
 3405 |  728 |             const t = (el.textContent || "").toLowerCase();
 3406 |  729 |             return (
 3407 |  730 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
 3408 |  731 |               (t.includes("comments") && t.includes("most relevant")) ||
 3409 |  732 |               t.trim() === "komentarze" ||
 3410 |  733 |               t.trim() === "comments"
 3411 |  734 |             );
 3412 |  735 |           });
 3413 |  736 |           if (commentsHeader) {
 3414 |  737 |             let p = commentsHeader.parentElement;
 3415 |  738 |             while (p && p !== document.body && p !== document.documentElement) {
 3416 |  739 |               const style = window.getComputedStyle(p);
 3417 |  740 |               const oy = style.overflowY;
 3418 |  741 |               const ch = p.clientHeight || 0;
 3419 |  742 |               const sh = p.scrollHeight || 0;
 3420 |  743 |               const delta = sh - ch;
 3421 |  744 |               if (
 3422 |  745 |                 ch > 0 &&
 3423 |  746 |                 delta > 10 &&
 3424 |  747 |                 (oy === "auto" ||
 3425 |  748 |                   oy === "scroll" ||
 3426 |  749 |                   oy === "overlay" ||
 3427 |  750 |                   oy === "hidden")
 3428 |  751 |               ) {
 3429 |  752 |                 container = p;
 3430 |  753 |                 containerType = "video-comments-header";
 3431 |  754 |                 break;
 3432 |  755 |               }
 3433 |  756 |               p = p.parentElement;
 3434 |  757 |             }
 3435 |  758 |           }
 3436 |  759 |         }
 3437 |  760 |         // NOWY FALLBACK ‚Äì po polu "Napisz komentarz..."
 3438 |  761 |         if (!container) {
 3439 |  762 |           const commentBox = Array.from(
 3440 |  763 |             document.querySelectorAll("div[role='textbox'], textarea")
 3441 |  764 |           ).find((el) => {
 3442 |  765 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
 3443 |  766 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
 3444 |  767 |             const txt = (el.textContent || "").toLowerCase();
 3445 |  768 |             const needles = [
 3446 |  769 |               "napisz komentarz",
 3447 |  770 |               "write a comment",
 3448 |  771 |               "escribe un comentario",
 3449 |  772 |               "schreibe einen kommentar",
 3450 |  773 |             ];
 3451 |  774 |             return needles.some((n) =>
 3452 |  775 |               label.includes(n) || ph.includes(n) || txt.includes(n)
 3453 |  776 |             );
 3454 |  777 |           });
 3455 |  778 |           if (commentBox) {
 3456 |  779 |             let p = commentBox.parentElement;
 3457 |  780 |             while (p && p !== document.body && p !== document.documentElement) {
 3458 |  781 |               const style = window.getComputedStyle(p);
 3459 |  782 |               const oy = style.overflowY;
 3460 |  783 |               const ch = p.clientHeight || 0;
 3461 |  784 |               const sh = p.scrollHeight || 0;
 3462 |  785 |               const delta = sh - ch;
 3463 |  786 |               if (
 3464 |  787 |                 ch > 0 &&
 3465 |  788 |                 delta > 10 &&
 3466 |  789 |                 (oy === "auto" ||
 3467 |  790 |                   oy === "scroll" ||
 3468 |  791 |                   oy === "overlay" ||
 3469 |  792 |                   oy === "hidden")
 3470 |  793 |               ) {
 3471 |  794 |                 container = p;
 3472 |  795 |                 containerType = isPhotoView
 3473 |  796 |                   ? "photo-comments-textbox"
 3474 |  797 |                   : "video-comments-textbox";
 3475 |  798 |                 break;
 3476 |  799 |               }
 3477 |  800 |               p = p.parentElement;
 3478 |  801 |             }
 3479 |  802 |           }
 3480 |  803 |         }
 3481 |  804 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì dajemy spok√≥j
 3482 |  805 |         if (isVideoView && !container) {
 3483 |  806 |           const cur = window.scrollY || 0;
 3484 |  807 |           return {
 3485 |  808 |             label: labelArg,
 3486 |  809 |             container: "video-no-scroll",
 3487 |  810 |             steps: 0,
 3488 |  811 |             final: cur,
 3489 |  812 |             maxScroll: 0,
 3490 |  813 |             atBottom: true,
 3491 |  814 |           };
 3492 |  815 |         }
 3493 |  816 |       }
 3494 |  817 |       // Standardowa heurystyka (permalink / photo fallback)
 3495 |  818 |       if (!container) {
 3496 |  819 |         const root = rootFn() || document.body;
 3497 |  820 |         const candidates = [];
 3498 |  821 |         pushIfScrollable(candidates, root, "root");
 3499 |  822 |         const dialog =
 3500 |  823 |           root.closest("div[role='dialog']") ||
 3501 |  824 |           document.querySelector("div[role='dialog']");
 3502 |  825 |         if (dialog) {
 3503 |  826 |           pushIfScrollable(candidates, dialog, "dialog");
 3504 |  827 |         }
 3505 |  828 |         const scope = dialog || root;
 3506 |  829 |         const blocks = Array.from(
 3507 |  830 |           scope.querySelectorAll("div, section, main, article")
 3508 |  831 |         );
 3509 |  832 |         for (const el of blocks) {
 3510 |  833 |           pushIfScrollable(candidates, el, "auto");
 3511 |  834 |         }
 3512 |  835 |         let best = null;
 3513 |  836 |         for (const c of candidates) {
 3514 |  837 |           if (!best || c.delta > best.delta) {
 3515 |  838 |             best = c;
 3516 |  839 |           }
 3517 |  840 |         }
 3518 |  841 |         if (best) {
 3519 |  842 |           container = best.el;
 3520 |  843 |           containerType = best.label;
 3521 |  844 |         } else {
 3522 |  845 |           container =
 3523 |  846 |             document.scrollingElement ||
 3524 |  847 |             document.documentElement ||
 3525 |  848 |             document.body;
 3526 |  849 |           containerType = "window";
 3527 |  850 |         }
 3528 |  851 |       }
 3529 |  852 |       // Zapamiƒôtaj kontener komentarzy (je≈õli to nie jest globalne okno)
 3530 |  853 |       if (container) {
 3531 |  854 |         const isRootContainer =
 3532 |  855 |           container === document.body ||
 3533 |  856 |           container === document.documentElement ||
 3534 |  857 |           container === document.scrollingElement;
 3535 |  858 |         if (!isRootContainer) {
 3536 |  859 |           try {
 3537 |  860 |             container.setAttribute("data-fbwatcher-comments", "1");
 3538 |  861 |           } catch {}
 3539 |  862 |         }
 3540 |  863 |       }
 3541 |  864 |       const isWindowContainer =
 3542 |  865 |         container === document.body ||
 3543 |  866 |         container === document.documentElement ||
 3544 |  867 |         container === document.scrollingElement;
 3545 |  868 |       // na watch nie ruszamy globalnego scrolla je≈õli nie mamy innego kontenera
 3546 |  869 |       if (isVideoView && isWindowContainer) {
 3547 |  870 |         const cur = window.scrollY || 0;
 3548 |  871 |         return {
 3549 |  872 |           label: labelArg,
 3550 |  873 |           container: "video-window-blocked",
 3551 |  874 |           steps: 0,
 3552 |  875 |           final: cur,
 3553 |  876 |           maxScroll: 0,
 3554 |  877 |           atBottom: true,
 3555 |  878 |         };
 3556 |  879 |       }
 3557 |  880 |       let steps = 0;
 3558 |  881 |       const maxSteps = 160;
 3559 |  882 |       let lastPos = isWindowContainer
 3560 |  883 |         ? window.scrollY || 0
 3561 |  884 |         : container.scrollTop || 0;
 3562 |  885 |       while (steps < maxSteps) {
 3563 |  886 |         steps++;
 3564 |  887 |         const maxScroll =
 3565 |  888 |           (container.scrollHeight || 0) - (container.clientHeight || 0);
 3566 |  889 |         const pos = isWindowContainer
 3567 |  890 |           ? window.scrollY || 0
 3568 |  891 |           : container.scrollTop || 0;
 3569 |  892 |         // ju≈º na dole
 3570 |  893 |         if (maxScroll <= 0 || pos >= maxScroll - 2) {
 3571 |  894 |           return {
 3572 |  895 |             label: labelArg,
 3573 |  896 |             container: containerType || "unknown",
 3574 |  897 |             steps,
 3575 |  898 |             final: pos,
 3576 |  899 |             maxScroll,
 3577 |  900 |             atBottom: true,
 3578 |  901 |           };
 3579 |  902 |         }
 3580 |  903 |         const baseStep =
 3581 |  904 |           (container.clientHeight || window.innerHeight || 600) * 0.9;
 3582 |  905 |         const step = Math.max(60, Math.min(baseStep, maxScroll - pos));
 3583 |  906 |         if (isWindowContainer) {
 3584 |  907 |           window.scrollTo(0, pos + step);
 3585 |  908 |         } else {
 3586 |  909 |           container.scrollTop = pos + step;
 3587 |  910 |         }
 3588 |  911 |         const afterPos = isWindowContainer
 3589 |  912 |           ? window.scrollY || 0
 3590 |  913 |           : container.scrollTop || 0;
 3591 |  914 |         // brak ruchu mimo pr√≥by ‚Äì uznajemy ≈ºe jeste≈õmy na dole
 3592 |  915 |         if (afterPos === lastPos) {
 3593 |  916 |           return {
 3594 |  917 |             label: labelArg,
 3595 |  918 |             container: containerType || "unknown",
 3596 |  919 |             steps,
 3597 |  920 |             final: afterPos,
 3598 |  921 |             maxScroll,
 3599 |  922 |             atBottom: true,
 3600 |  923 |           };
 3601 |  924 |         }
 3602 |  925 |         lastPos = afterPos;
 3603 |  926 |       }
 3604 |  927 |       const maxScrollFinal =
 3605 |  928 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
 3606 |  929 |       const finalPos = isWindowContainer
 3607 |  930 |         ? window.scrollY || 0
 3608 |  931 |         : container.scrollTop || 0;
 3609 |  932 |       return {
 3610 |  933 |         label: labelArg,
 3611 |  934 |         container: containerType || "unknown",
 3612 |  935 |         steps,
 3613 |  936 |         final: finalPos,
 3614 |  937 |         maxScroll: maxScrollFinal,
 3615 |  938 |         atBottom: finalPos >= maxScrollFinal - 2,
 3616 |  939 |       };
 3617 |  940 |     },
 3618 |  941 |     label,
 3619 |  942 |     postRootScript()
 3620 |  943 |   );
 3621 |  944 |   return info;
 3622 |  945 | }
 3623 |  946 | 
 3624 |  947 | /* ============================================================
 3625 |  948 |    ===================== VIDEO ‚Äì AUTO PAUSE ====================
 3626 |  949 |    ============================================================ */
 3627 |  950 | 
 3628 |  951 | async function pauseVideoIfAny(page) {
 3629 |  952 |   try {
 3630 |  953 |     await page.evaluate(() => {
 3631 |  954 |       const vids = Array.from(document.querySelectorAll("video"));
 3632 |  955 |       for (const v of vids) {
 3633 |  956 |         try {
 3634 |  957 |           v.autoplay = false;
 3635 |  958 |           v.removeAttribute("autoplay");
 3636 |  959 |           v.muted = true;
 3637 |  960 |           v.pause();
 3638 |  961 |           if (!isNaN(v.currentTime) && v.currentTime === 0) {
 3639 |  962 |             v.currentTime = 0.01;
 3640 |  963 |           }
 3641 |  964 |         } catch (e) {}
 3642 |  965 |       }
 3643 |  966 |     });
 3644 |  967 |     console.log("[FB] Video pause: zatrzymano wszystkie <video>.");
 3645 |  968 |   } catch (e) {
 3646 |  969 |     console.log("[FB] Video pause ‚Äì b≈ÇƒÖd:", e?.message || e);
 3647 |  970 |   }
 3648 |  971 | }
 3649 |  972 | 
 3650 |  973 | /* ============================================================
 3651 |  974 |    ======= BRUTALNA DO≈ªYNKA ‚Äì LOAD MORE NA DOLE ================
 3652 |  975 |    ============================================================ */
 3653 |  976 | 
 3654 |  977 | async function clickAllLoadMoreAtBottom(page, view, maxClicks = 300) {
 3655 |  978 |   // Brutalna do≈ºynka na dole ‚Äì bez scrolla, tylko to, co widaƒá
 3656 |  979 |   return await page.evaluate(({ isVideo, max }) => {
 3657 |  980 |     function normalize(text) {
 3658 |  981 |       return (text || "").toLowerCase().replace(/\s+/g, " ").trim();
 3659 |  982 |     }
 3660 |  983 |     function findCommentsRoot() {
 3661 |  984 |       // Dla watch/reel FB czƒôsto siedzi w g≈Ç√≥wnej kolumnie
 3662 |  985 |       const main = document.querySelector("div[role='main']");
 3663 |  986 |       if (!main) return document.body;
 3664 |  987 |       const article = main.querySelector("article");
 3665 |  988 |       if (article) return article;
 3666 |  989 |       return main;
 3667 |  990 |     }
 3668 |  991 |     const root = findCommentsRoot();
 3669 |  992 |     if (!root) return 0;
 3670 |  993 |     let clicks = 0;
 3671 |  994 |     for (let i = 0; i < max; i++) {
 3672 |  995 |       const candidates = Array.from(
 3673 |  996 |         root.querySelectorAll(
 3674 |  997 |           "button,div[role='button'],span[role='button'],a[role='button']"
 3675 |  998 |         )
 3676 |  999 |       );
 3677 | 1000 |       const btn = candidates.find((el) => {
 3678 | 1001 |         const t = normalize(el.textContent);
 3679 | 1002 |         if (!t) return false;
 3680 | 1003 |         if (t.startsWith("wy≈õwietl wiƒôcej komentarzy")) return true;
 3681 | 1004 |         if (t === "poka≈º wiƒôcej odpowiedzi") return true;
 3682 | 1005 |         if (/^wy≈õwietl wszystkie \d+ odpowiedzi$/.test(t)) return true;
 3683 | 1006 |         if (t === "wy≈õwietl 1 odpowied≈∫") return true;
 3684 | 1007 |         if (/odpowiedzi$/.test(t) && /odpowiedzi/.test(t) && t.includes("odpowiedzia≈Ç")) {
 3685 | 1008 |           return true;
 3686 | 1009 |         }
 3687 | 1010 |         return false;
 3688 | 1011 |       });
 3689 | 1012 |       if (!btn) break;
 3690 | 1013 |       const rect = btn.getBoundingClientRect();
 3691 | 1014 |       if (rect.bottom < 0 || rect.top > window.innerHeight) break;
 3692 | 1015 |       btn.click();
 3693 | 1016 |       clicks++;
 3694 | 1017 |     }
 3695 | 1018 |     return clicks;
 3696 | 1019 |   }, { isVideo: !!view.isVideo, max: maxClicks });
 3697 | 1020 | }
 3698 | 1021 | 
 3699 | 1022 | /* ============================================================
 3700 | 1023 |    ======= AGRESYWNE DO≈ÅADOWANIE WSZYSTKICH KOMENTARZY =========
 3701 | 1024 |    ============================================================ */
 3702 | 1025 | 
 3703 | 1026 | async function ensureAllCommentsLoaded(page, expectedTotal = null) {
 3704 | 1027 |   // expectedTotal tylko do log√≥w ‚Äì NIE jest twardym warunkiem stopu
 3705 | 1028 |   const hasTarget = typeof expectedTotal === "number" && expectedTotal > 0;
 3706 | 1029 |   const view = await page.evaluate(() => {
 3707 | 1030 |     const href = location.href;
 3708 | 1031 |     const isWatch = href.includes("/watch/");
 3709 | 1032 |     const isVideo = isWatch || /\/watch\/|\/videos\/|[\?&]v=/i.test(href); // üëà dodane /videos/
 3710 | 1033 |     const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
 3711 | 1034 |       href
 3712 | 1035 |     );
 3713 | 1036 |     return { href, isWatch, isVideo, isPhoto };
 3714 | 1037 |   });
 3715 | 1038 |   console.log(
 3716 | 1039 |     "[FB] ensureAllCommentsLoaded ‚Äì start",
 3717 | 1040 |     hasTarget ? `(target=${expectedTotal})` : "(bez targetu)",
 3718 | 1041 |     "| view:",
 3719 | 1042 |     view
 3720 | 1043 |   );
 3721 | 1044 |   const MAX_ROUNDS = view.isVideo ? 1500 : 2500;
 3722 | 1045 |   const MAX_NO_PROGRESS = 10; // ile rund bez progresu zanim uznamy, ≈ºe koniec
 3723 | 1046 |   let noProgressRounds = 0;
 3724 | 1047 |   let roundsDone = 0;
 3725 | 1048 |   let lastAnchors = 0;
 3726 | 1049 |   let breakReason = "max-rounds";
 3727 | 1050 |   // helper ‚Äì czy na stronie sƒÖ jeszcze przyciski load-more/replies
 3728 | 1051 |   async function hasLoadMoreButtons() {
 3729 | 1052 |     return await page.evaluate(() => {
 3730 | 1053 |       const phrases = [
 3731 | 1054 |         "wy≈õwietl wiƒôcej komentarzy",
 3732 | 1055 |         "wy≈õwietl wszystkie",
 3733 | 1056 |         "wy≈õwietl wszystkie odpowiedzi",
 3734 | 1057 |         "wy≈õwietl odpowiedzi",
 3735 | 1058 |         "zobacz wiƒôcej komentarzy",
 3736 | 1059 |         "view more comments",
 3737 | 1060 |         "view more replies",
 3738 | 1061 |         "see more comments",
 3739 | 1062 |         "see more replies",
 3740 | 1063 |       ];
 3741 | 1064 |       const btns = Array.from(
 3742 | 1065 |         document.querySelectorAll("button, div[role='button'], span[role='button'], a")
 3743 | 1066 |       );
 3744 | 1067 |       return btns.some((el) => {
 3745 | 1068 |         const txt = (el.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
 3746 | 1069 |         if (!txt) return false;
 3747 | 1070 |         return phrases.some((p) => txt.includes(p));
 3748 | 1071 |       });
 3749 | 1072 |     });
 3750 | 1073 |   }
 3751 | 1074 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
 3752 | 1075 |     const beforeAnchors = await getCurrentCommentAnchorCount(page);
 3753 | 1076 |     // scrollujemy TYLKO przez scrollWithinPost ‚Äì on ogarnia kontener komentarzy
 3754 | 1077 |     const scrollInfo = await scrollWithinPost(
 3755 | 1078 |       page,
 3756 | 1079 |       `round-${round}`,
 3757 | 1080 |       view.isVideo ? 0.18 : 0.25
 3758 | 1081 |     );
 3759 | 1082 |     const clicks = await expandAllComments(page);
 3760 | 1083 |     const afterAnchors = await getCurrentCommentAnchorCount(page);
 3761 | 1084 |     const moreButtons = await hasLoadMoreButtons();
 3762 | 1085 |     const scrolled = scrollInfo.after !== scrollInfo.before;
 3763 | 1086 |     const progressed =
 3764 | 1087 |       scrolled || clicks > 0 || afterAnchors > beforeAnchors;
 3765 | 1088 |     if (progressed) {
 3766 | 1089 |       noProgressRounds = 0;
 3767 | 1090 |       lastAnchors = afterAnchors;
 3768 | 1091 |     } else {
 3769 | 1092 |       noProgressRounds++;
 3770 | 1093 |     }
 3771 | 1094 |     roundsDone = round;
 3772 | 1095 |     if (round === 1 || round % 25 === 0 || round > MAX_ROUNDS - 5) {
 3773 | 1096 |       console.log(
 3774 | 1097 |         `[FB] ensureAllCommentsLoaded ‚Äì round ${round} ` +
 3775 | 1098 |           `container=${scrollInfo.container} ` +
 3776 | 1099 |           `scrollTop: ${scrollInfo.before} ‚Üí ${scrollInfo.after} ` +
 3777 | 1100 |           `anchors: ${beforeAnchors} ‚Üí ${afterAnchors} ` +
 3778 | 1101 |           `clicks=${clicks} noProgress=${noProgressRounds} moreButtons=${moreButtons}`
 3779 | 1102 |       );
 3780 | 1103 |     }
 3781 | 1104 |     if (hasTarget && afterAnchors >= expectedTotal && !moreButtons) {
 3782 | 1105 |       breakReason = "target-reached-no-buttons";
 3783 | 1106 |       break;
 3784 | 1107 |     }
 3785 | 1108 |     if (!moreButtons && noProgressRounds >= MAX_NO_PROGRESS) {
 3786 | 1109 |       breakReason = "no-buttons-no-progress";
 3787 | 1110 |       break;
 3788 | 1111 |     }
 3789 | 1112 |     if (noProgressRounds >= MAX_NO_PROGRESS * 2) {
 3790 | 1113 |       breakReason = "hard-no-progress";
 3791 | 1114 |       break;
 3792 | 1115 |     }
 3793 | 1116 |     await sleepRandom(250, 600);
 3794 | 1117 |   }
 3795 | 1118 |   console.log(
 3796 | 1119 |     "[FB] ensureAllCommentsLoaded ‚Äì g≈Ç√≥wna pƒôtla:",
 3797 | 1120 |     `reason=${breakReason}, rounds=${roundsDone}, anchors=${lastAnchors}${
 3798 | 1121 |       hasTarget ? `/target=${expectedTotal}` : ""
 3799 | 1122 |     }`
 3800 | 1123 |   );
 3801 | 1124 |   // Runda kontrolna w g√≥rƒô ‚Äì domykamy expandy ‚Äûu g√≥ry‚Äù
 3802 | 1125 |   try {
 3803 | 1126 |     let ctrlReason = "max-ctrl-rounds";
 3804 | 1127 |     for (let i = 1; i <= 200; i++) {
 3805 | 1128 |       const up = await scrollWithinPost(page, `ctrl-up-${i}`, -0.55);
 3806 | 1129 |       const clicked = await clickOneExpandButton(page);
 3807 | 1130 |       await sleepRandom(160, 320);
 3808 | 1131 |       if (up.after === 0) {
 3809 | 1132 |         ctrlReason = "top-reached";
 3810 | 1133 |         break;
 3811 | 1134 |       }
 3812 | 1135 |       if (up.after === up.before && !clicked) {
 3813 | 1136 |         ctrlReason = "no-move-no-click";
 3814 | 1137 |         break;
 3815 | 1138 |       }
 3816 | 1139 |     }
 3817 | 1140 |     console.log("[FB] ensureAllCommentsLoaded ‚Äì runda kontrolna:", ctrlReason);
 3818 | 1141 |   } catch (e) {
 3819 | 1142 |     console.log(
 3820 | 1143 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd w rundzie kontrolnej:",
 3821 | 1144 |       e?.message || e
 3822 | 1145 |     );
 3823 | 1146 |   }
 3824 | 1147 |   let bottomClicks = 0;
 3825 | 1148 |   let lastBottomPos = null;
 3826 | 1149 |   let stableRounds = 0;
 3827 | 1150 |   try {
 3828 | 1151 |     for (let i = 1; i <= 400; i++) {
 3829 | 1152 |       const info = await scrollWithinPost(
 3830 | 1153 |         page,
 3831 | 1154 |         `final-bottom-${i}`,
 3832 | 1155 |         view.isVideo ? 0.6 : 0.8
 3833 | 1156 |       );
 3834 | 1157 |       if (lastBottomPos === info.after) {
 3835 | 1158 |         stableRounds++;
 3836 | 1159 |       } else {
 3837 | 1160 |         stableRounds = 0;
 3838 | 1161 |       }
 3839 | 1162 |       lastBottomPos = info.after;
 3840 | 1163 |       if (i === 1 || i % 50 === 0) {
 3841 | 1164 |         console.log(
 3842 | 1165 |           `[FB] ensureAllCommentsLoaded ‚Äì final-bottom step ${i}: container=${info.container}, ` +
 3843 | 1166 |             `scrollTop: ${info.before} ‚Üí ${info.after}`
 3844 | 1167 |         );
 3845 | 1168 |       }
 3846 | 1169 |       if (stableRounds >= 3) break;
 3847 | 1170 |       await sleepRandom(120, 260);
 3848 | 1171 |     }
 3849 | 1172 |     const bottomExpand = await expandAllComments(page);
 3850 | 1173 |     const extraClicks = await clickAllLoadMoreAtBottom(page, view, 300);
 3851 | 1174 |     bottomClicks = bottomExpand + extraClicks;
 3852 | 1175 |     if (bottomClicks > 0) {
 3853 | 1176 |       console.log(
 3854 | 1177 |         `[FB] ensureAllCommentsLoaded ‚Äì bottom pass: expand=${bottomExpand}, extra=${extraClicks}, total=${bottomClicks}`
 3855 | 1178 |       );
 3856 | 1179 |       await sleepRandom(700, 1300);
 3857 | 1180 |     }
 3858 | 1181 |   } catch (e) {
 3859 | 1182 |     console.log(
 3860 | 1183 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd przy final bottom:",
 3861 | 1184 |       e?.message || e
 3862 | 1185 |     );
 3863 | 1186 |   }
 3864 | 1187 |   const finalAnchors = await getCurrentCommentAnchorCount(page);
 3865 | 1188 |   console.log(
 3866 | 1189 |     "[FB] ensureAllCommentsLoaded ‚Äì koniec. anchors=",
 3867 | 1190 |     finalAnchors,
 3868 | 1191 |     "bottomClicks=",
 3869 | 1192 |     bottomClicks
 3870 | 1193 |   );
 3871 | 1194 | }
 3872 | 1195 | 
 3873 | 1196 | /* ============================================================
 3874 | 1197 |    ==================== WIƒòCEJ KOMENTARZY (VIDEO) ===============
 3875 | 1198 |    ============================================================ */
 3876 | 1199 | 
 3877 | 1200 | async function clickMoreCommentsButtonsVideo(page, maxLoops = 80) {
 3878 | 1201 |   console.log(
 3879 | 1202 |     "[FB][more-comments] Start klikania 'Wy≈õwietl wiƒôcej komentarzy / odpowiedzi' (video)‚Ä¶"
 3880 | 1203 |   );
 3881 | 1204 |   for (let i = 0; i < maxLoops; i++) {
 3882 | 1205 |     const result = await page.evaluate(() => {
 3883 | 1206 |       const norm = (s) =>
 3884 | 1207 |         (s || "")
 3885 | 1208 |           .replace(/\s+/g, " ")
 3886 | 1209 |           .trim()
 3887 | 1210 |           .toLowerCase();
 3888 | 1211 |       function getPostRoot() {
 3889 | 1212 |         // 1) overlay z postem / video
 3890 | 1213 |         const dialogs = Array.from(
 3891 | 1214 |           document.querySelectorAll("div[role='dialog']")
 3892 | 1215 |         );
 3893 | 1216 |         for (const dlg of dialogs) {
 3894 | 1217 |           const txt = (dlg.innerText || dlg.textContent || "").toLowerCase();
 3895 | 1218 |           if (!txt) continue;
 3896 | 1219 |           if (
 3897 | 1220 |             txt.includes("komentarz") ||
 3898 | 1221 |             txt.includes("comments") ||
 3899 | 1222 |             txt.includes("napisz komentarz")
 3900 | 1223 |           ) {
 3901 | 1224 |             const art = dlg.querySelector("article");
 3902 | 1225 |             return art || dlg;
 3903 | 1226 |           }
 3904 | 1227 |         }
 3905 | 1228 |         // 2) strona "Filmy" ‚Äì g≈Ç√≥wny artyku≈Ç
 3906 | 1229 |         const main = document.querySelector("main");
 3907 | 1230 |         if (main) {
 3908 | 1231 |           const art = main.querySelector("article");
 3909 | 1232 |           if (art) return art;
 3910 | 1233 |           return main;
 3911 | 1234 |         }
 3912 | 1235 |         // 3) fallback
 3913 | 1236 |         return document.body || document;
 3914 | 1237 |       }
 3915 | 1238 |       const root = getPostRoot();
 3916 | 1239 |       const MORE_COMMENTS_LABELS = [
 3917 | 1240 |         "wy≈õwietl wiƒôcej komentarzy",
 3918 | 1241 |         "zobacz wiƒôcej komentarzy",
 3919 | 1242 |         "view more comments",
 3920 | 1243 |         "view previous comments",
 3921 | 1244 |         "see more comments",
 3922 | 1245 |       ];
 3923 | 1246 |       const REPLY_LABELS = [
 3924 | 1247 |         "wy≈õwietl wiƒôcej odpowiedzi",
 3925 | 1248 |         "zobacz wiƒôcej odpowiedzi",
 3926 | 1249 |         "view more replies",
 3927 | 1250 |         "see more replies",
 3928 | 1251 |       ];
 3929 | 1252 |       const els = Array.from(
 3930 | 1253 |         root.querySelectorAll(
 3931 | 1254 |           "button, div[role='button'], span[role='button'], span"
 3932 | 1255 |         )
 3933 | 1256 |       );
 3934 | 1257 |       let target = null;
 3935 | 1258 |       let kind = null;
 3936 | 1259 |       // 1) priorytet: "Wy≈õwietl wiƒôcej komentarzy"
 3937 | 1260 |       for (const el of els) {
 3938 | 1261 |         const txt = norm(el.textContent);
 3939 | 1262 |         if (!txt) continue;
 3940 | 1263 |         if (MORE_COMMENTS_LABELS.includes(txt)) {
 3941 | 1264 |           const rect = el.getBoundingClientRect();
 3942 | 1265 |           if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
 3943 | 1266 |           target = el;
 3944 | 1267 |           kind = "comments";
 3945 | 1268 |           break;
 3946 | 1269 |         }
 3947 | 1270 |       }
 3948 | 1271 |       // 2) je≈õli nie ma "wiƒôcej komentarzy" ‚Äì szukamy "wiƒôcej/X odpowiedzi"
 3949 | 1272 |       if (!target) {
 3950 | 1273 |         for (const el of els) {
 3951 | 1274 |           const txt = norm(el.textContent);
 3952 | 1275 |           if (!txt) continue;
 3953 | 1276 |           if (REPLY_LABELS.includes(txt)) {
 3954 | 1277 |             const rect = el.getBoundingClientRect();
 3955 | 1278 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
 3956 | 1279 |             target = el;
 3957 | 1280 |             kind = "replies";
 3958 | 1281 |             break;
 3959 | 1282 |           }
 3960 | 1283 |           if (
 3961 | 1284 |             /(^|\s)\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(txt) ||
 3962 | 1285 |             (txt.includes(" replies") && /\d+/.test(txt))
 3963 | 1286 |           ) {
 3964 | 1287 |             const rect = el.getBoundingClientRect();
 3965 | 1288 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
 3966 | 1289 |             target = el;
 3967 | 1290 |             kind = "replies";
 3968 | 1291 |             break;
 3969 | 1292 |           }
 3970 | 1293 |         }
 3971 | 1294 |       }
 3972 | 1295 |       if (!target) {
 3973 | 1296 |         return { clicked: false, kind: null };
 3974 | 1297 |       }
 3975 | 1298 |       try {
 3976 | 1299 |         target.scrollIntoView({ block: "center", inline: "nearest" });
 3977 | 1300 |       } catch (e) {
 3978 | 1301 |         // ignorujemy
 3979 | 1302 |       }
 3980 | 1303 |       if (typeof target.click === "function") {
 3981 | 1304 |         target.click();
 3982 | 1305 |         return { clicked: true, kind };
 3983 | 1306 |       }
 3984 | 1307 |       return { clicked: false, kind: null };
 3985 | 1308 |     });
 3986 | 1309 |     if (!result || !result.clicked) {
 3987 | 1310 |       if (i === 0) {
 3988 | 1311 |         console.log(
 3989 | 1312 |           "[FB][more-comments] Brak przycisk√≥w 'wiƒôcej komentarzy/odpowiedzi' ‚Äì nic nie klikam."
 3990 | 1313 |         );
 3991 | 1314 |       } else {
 3992 | 1315 |         console.log(
 3993 | 1316 |           `[FB][more-comments] Brak kolejnych przycisk√≥w ‚Äì zako≈Ñczono po ${i} klikniƒôciach.`
 3994 | 1317 |         );
 3995 | 1318 |       }
 3996 | 1319 |       break;
 3997 | 1320 |     }
 3998 | 1321 |     const what =
 3999 | 1322 |       result.kind === "replies"
 4000 | 1323 |         ? "wiƒôcej odpowiedzi / X odpowiedzi"
 4001 | 1324 |         : "wiƒôcej komentarzy";
 4002 | 1325 |     console.log(
 4003 | 1326 |       `[FB][more-comments] Klikniƒôto '${what}' (iteracja ${i + 1}/${maxLoops}).`
 4004 | 1327 |     );
 4005 | 1328 |     await sleepRandom(900, 1600);
 4006 | 1329 |     try {
 4007 | 1330 |       await scrollWithinPost(page, `video-more-${i + 1}`, 0.18);
 4008 | 1331 |     } catch (e) {
 4009 | 1332 |       console.log(
 4010 | 1333 |         "[FB][more-comments] scrollWithinPost(video) ‚Äì b≈ÇƒÖd:",
 4011 | 1334 |         e?.message || e
 4012 | 1335 |       );
 4013 | 1336 |     }
 4014 | 1337 |     await sleepRandom(800, 1400);
 4015 | 1338 |   }
 4016 | 1339 |   console.log(
 4017 | 1340 |     `[FB][more-comments] Zako≈Ñczono sekwencjƒô video (maxLoops=${maxLoops}).`
 4018 | 1341 |   );
 4019 | 1342 | }
 4020 | 1343 | 
 4021 | 1344 | /* ============================================================
 4022 | 1345 |    ================= SEKWENCYJNY SPACER (VIDEO) =================
 4023 | 1346 |    ============================================================ */
 4024 | 1347 | 
 4025 | 1348 | async function walkVideoCommentsSequential(page, maxCycles = 40) {
 4026 | 1349 |   console.log("[FB][video-walk] start ‚Äì sekwencyjny spacer po komentarzach (VIDEO)‚Ä¶");
 4027 | 1350 | 
 4028 | 1351 |   let noProgressStreak = 0;
 4029 | 1352 | 
 4030 | 1353 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
 4031 | 1354 |     const result = await page.evaluate(() => {
 4032 | 1355 |       const norm = (s) =>
 4033 | 1356 |         String(s || "")
 4034 | 1357 |           .replace(/\u00a0/g, " ")
 4035 | 1358 |           .replace(/\s+/g, " ")
 4036 | 1359 |           .trim()
 4037 | 1360 |           .toLowerCase();
 4038 | 1361 | 
 4039 | 1362 |       const isVisible = (el) => {
 4040 | 1363 |         if (!el) return false;
 4041 | 1364 |         const st = window.getComputedStyle(el);
 4042 | 1365 |         if (!st) return true;
 4043 | 1366 |         if (st.display === "none" || st.visibility === "hidden") return false;
 4044 | 1367 |         return true;
 4045 | 1368 |       };
 4046 | 1369 | 
 4047 | 1370 |       function getLabel(el) {
 4048 | 1371 |         if (!el) return "";
 4049 | 1372 |         const a = el.getAttribute?.("aria-label");
 4050 | 1373 |         if (a) return a;
 4051 | 1374 |         return el.textContent || "";
 4052 | 1375 |       }
 4053 | 1376 | 
 4054 | 1377 |       function findClickable(el, maxUp = 8) {
 4055 | 1378 |         let cur = el;
 4056 | 1379 |         for (let i = 0; i < maxUp && cur; i++) {
 4057 | 1380 |           const role = cur.getAttribute?.("role");
 4058 | 1381 |           const tag = (cur.tagName || "").toLowerCase();
 4059 | 1382 |           if (tag === "button" || tag === "a" || role === "button") return cur;
 4060 | 1383 |           cur = cur.parentElement;
 4061 | 1384 |         }
 4062 | 1385 |         return el; // fallback
 4063 | 1386 |       }
 4064 | 1387 | 
 4065 | 1388 |       function getPostRoot() {
 4066 | 1389 |         // 1) dialog / overlay (czƒôste przy video)
 4067 | 1390 |         const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 4068 | 1391 |         for (const dlg of dialogs) {
 4069 | 1392 |           const txt = norm(dlg.innerText || dlg.textContent);
 4070 | 1393 |           if (!txt) continue;
 4071 | 1394 |           if (txt.includes("komentarz") || txt.includes("comments") || txt.includes("napisz komentarz")) {
 4072 | 1395 |             const art = dlg.querySelector("article");
 4073 | 1396 |             return art || dlg;
 4074 | 1397 |           }
 4075 | 1398 |         }
 4076 | 1399 | 
 4077 | 1400 |         // 2) klasyczny main
 4078 | 1401 |         const main = document.querySelector("main, div[role='main']");
 4079 | 1402 |         if (main) {
 4080 | 1403 |           const art = main.querySelector("article");
 4081 | 1404 |           return art || main;
 4082 | 1405 |         }
 4083 | 1406 | 
 4084 | 1407 |         return document.body || document.documentElement;
 4085 | 1408 |       }
 4086 | 1409 | 
 4087 | 1410 |       // REALNY test scrollowalno≈õci: pr√≥bujemy ruszyƒá scrollTop i sprawdzamy czy siƒô zmieni≈Ç.
 4088 | 1411 |       function canScrollByTest(el) {
 4089 | 1412 |         try {
 4090 | 1413 |           if (!el) return false;
 4091 | 1414 |           const h = el.clientHeight || 0;
 4092 | 1415 |           const sh = el.scrollHeight || 0;
 4093 | 1416 |           if (sh <= h + 40) return false;
 4094 | 1417 | 
 4095 | 1418 |           const before = el.scrollTop ?? 0;
 4096 | 1419 |           el.scrollTop = before + 50;
 4097 | 1420 |           const after = el.scrollTop ?? before;
 4098 | 1421 | 
 4099 | 1422 |           // przywr√≥ƒá (≈ºeby nie rozje≈ºd≈ºaƒá)
 4100 | 1423 |           el.scrollTop = before;
 4101 | 1424 | 
 4102 | 1425 |           return after !== before;
 4103 | 1426 |         } catch (e) {
 4104 | 1427 |           return false;
 4105 | 1428 |         }
 4106 | 1429 |       }
 4107 | 1430 | 
 4108 | 1431 |       function getCommentsContainerSmart(root) {
 4109 | 1432 |   // cache kontenera miƒôdzy cyklami (FB czƒôsto rerenderuje, ale referencja zwykle ≈ºyje chwilƒô)
 4110 | 1433 |   function isInDom(el) {
 4111 | 1434 |     try {
 4112 | 1435 |       return !!el && document.contains(el);
 4113 | 1436 |     } catch (e) {
 4114 | 1437 |       return false;
 4115 | 1438 |     }
 4116 | 1439 |   }
 4117 | 1440 | 
 4118 | 1441 |   function canScrollByTest(el) {
 4119 | 1442 |     try {
 4120 | 1443 |       if (!el) return false;
 4121 | 1444 |       const h = el.clientHeight || 0;
 4122 | 1445 |       const sh = el.scrollHeight || 0;
 4123 | 1446 |       if (sh <= h + 40) return false;
 4124 | 1447 | 
 4125 | 1448 |       const before = el.scrollTop ?? 0;
 4126 | 1449 |       el.scrollTop = before + 50;
 4127 | 1450 |       const after = el.scrollTop ?? before;
 4128 | 1451 |       el.scrollTop = before;
 4129 | 1452 | 
 4130 | 1453 |       return after !== before;
 4131 | 1454 |     } catch (e) {
 4132 | 1455 |       return false;
 4133 | 1456 |     }
 4134 | 1457 |   }
 4135 | 1458 | 
 4136 | 1459 |   // 0) spr√≥buj u≈ºyƒá ostatniego dobrego kontenera
 4137 | 1460 |   const cached = window.__FBW_VIDEO_COMMENTS_CONTAINER;
 4138 | 1461 |   if (isInDom(cached) && canScrollByTest(cached)) {
 4139 | 1462 |     return cached;
 4140 | 1463 |   }
 4141 | 1464 | 
 4142 | 1465 |   // 1) normalne szukanie
 4143 | 1466 |   const scopes = [root, document.body, document.documentElement].filter(Boolean);
 4144 | 1467 | 
 4145 | 1468 |   let best = null;
 4146 | 1469 |   let bestScore = -1;
 4147 | 1470 | 
 4148 | 1471 |   for (const scope of scopes) {
 4149 | 1472 |     const divs = Array.from(scope.querySelectorAll("div"))
 4150 | 1473 |       .filter(isVisible)
 4151 | 1474 |       .slice(0, 16000);
 4152 | 1475 | 
 4153 | 1476 |     for (const el of divs) {
 4154 | 1477 |       if (!canScrollByTest(el)) continue;
 4155 | 1478 | 
 4156 | 1479 |       const h = el.clientHeight || 0;
 4157 | 1480 |       const sh = el.scrollHeight || 0;
 4158 | 1481 |       const delta = sh - h;
 4159 | 1482 | 
 4160 | 1483 |       const t = norm(el.innerText || "");
 4161 | 1484 |       const hasCommentWords =
 4162 | 1485 |         t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
 4163 | 1486 | 
 4164 | 1487 |       const score = delta + (hasCommentWords ? 9000 : 0);
 4165 | 1488 | 
 4166 | 1489 |       if (score > bestScore) {
 4167 | 1490 |         bestScore = score;
 4168 | 1491 |         best = el;
 4169 | 1492 |       }
 4170 | 1493 |     }
 4171 | 1494 | 
 4172 | 1495 |     if (best) break;
 4173 | 1496 |   }
 4174 | 1497 | 
 4175 | 1498 |   // 2) cache
 4176 | 1499 |   if (best) {
 4177 | 1500 |     window.__FBW_VIDEO_COMMENTS_CONTAINER = best;
 4178 | 1501 |     return best;
 4179 | 1502 |   }
 4180 | 1503 | 
 4181 | 1504 |   return document.scrollingElement || document.documentElement || root;
 4182 | 1505 | }
 4183 | 1506 | 
 4184 | 1507 | 
 4185 | 1508 |       function clickMoreCommentsOnce(scope) {
 4186 | 1509 |         const LABELS = [
 4187 | 1510 |           "wy≈õwietl wiƒôcej komentarzy",
 4188 | 1511 |           "zobacz wiƒôcej komentarzy",
 4189 | 1512 |           "view more comments",
 4190 | 1513 |           "see more comments",
 4191 | 1514 |           "show more comments",
 4192 | 1515 |         ];
 4193 | 1516 | 
 4194 | 1517 |         const nodes = Array.from(
 4195 | 1518 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
 4196 | 1519 |         )
 4197 | 1520 |           .filter(isVisible)
 4198 | 1521 |           .slice(0, 30000);
 4199 | 1522 | 
 4200 | 1523 |         for (const el of nodes) {
 4201 | 1524 |           const txt = norm(getLabel(el));
 4202 | 1525 |           if (!txt) continue;
 4203 | 1526 | 
 4204 | 1527 |           const hit = LABELS.some((w) => txt.includes(w));
 4205 | 1528 |           if (!hit) continue;
 4206 | 1529 | 
 4207 | 1530 |           const btn = findClickable(el);
 4208 | 1531 | 
 4209 | 1532 |           try {
 4210 | 1533 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
 4211 | 1534 |           } catch (e) {}
 4212 | 1535 | 
 4213 | 1536 |           try {
 4214 | 1537 |             btn.click();
 4215 | 1538 |             return true;
 4216 | 1539 |           } catch (e) {}
 4217 | 1540 |         }
 4218 | 1541 |         return false;
 4219 | 1542 |       }
 4220 | 1543 | 
 4221 | 1544 |       function expandReplies(scope, limit = 35) {
 4222 | 1545 |         const nodes = Array.from(
 4223 | 1546 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
 4224 | 1547 |         )
 4225 | 1548 |           .filter(isVisible)
 4226 | 1549 |           .slice(0, 40000);
 4227 | 1550 | 
 4228 | 1551 |         let clicked = 0;
 4229 | 1552 | 
 4230 | 1553 |         for (const el of nodes) {
 4231 | 1554 |           const txt = norm(getLabel(el));
 4232 | 1555 |           if (!txt) continue;
 4233 | 1556 | 
 4234 | 1557 |           const isMoreReplies =
 4235 | 1558 |             txt.includes("wiƒôcej odpowiedzi") ||
 4236 | 1559 |             txt.includes("more replies") ||
 4237 | 1560 |             txt.includes("view previous replies") ||
 4238 | 1561 |             txt.includes("zobacz odpowiedzi") ||
 4239 | 1562 |             txt.includes("show replies");
 4240 | 1563 | 
 4241 | 1564 |           // ≈Çapie ‚Äú12 odpowiedzi‚Äù, ale te≈º warianty z dodatkami
 4242 | 1565 |           const isCountReplies = /\b\d+\s+(odpowied≈∫|odpowiedzi|repl(y|ies))\b/.test(txt);
 4243 | 1566 | 
 4244 | 1567 |           if (!isMoreReplies && !isCountReplies) continue;
 4245 | 1568 | 
 4246 | 1569 |           const btn = findClickable(el);
 4247 | 1570 | 
 4248 | 1571 |           try {
 4249 | 1572 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
 4250 | 1573 |           } catch (e) {}
 4251 | 1574 | 
 4252 | 1575 |           try {
 4253 | 1576 |             btn.click();
 4254 | 1577 |             clicked++;
 4255 | 1578 |             if (clicked >= limit) break;
 4256 | 1579 |           } catch (e) {}
 4257 | 1580 |         }
 4258 | 1581 | 
 4259 | 1582 |         return clicked;
 4260 | 1583 |       }
 4261 | 1584 | 
 4262 | 1585 |       function scrollSomewhere(container) {
 4263 | 1586 |         const beforeC = container?.scrollTop ?? 0;
 4264 | 1587 |         const beforeW = window.scrollY ?? 0;
 4265 | 1588 | 
 4266 | 1589 |         const step = Math.max(300, (container?.clientHeight || 0) * 0.8, 700);
 4267 | 1590 | 
 4268 | 1591 |         // 1) pr√≥buj na kontenerze
 4269 | 1592 |         try {
 4270 | 1593 |           if (container && typeof container.scrollTop === "number") {
 4271 | 1594 |             container.scrollTop = Math.min(beforeC + step, container.scrollHeight || beforeC + step);
 4272 | 1595 |           }
 4273 | 1596 |         } catch (e) {}
 4274 | 1597 | 
 4275 | 1598 |         const afterC = container?.scrollTop ?? beforeC;
 4276 | 1599 | 
 4277 | 1600 |         // 2) jak nie ruszy≈Ço ‚Äì pr√≥buj window
 4278 | 1601 |         if (afterC === beforeC) {
 4279 | 1602 |           try {
 4280 | 1603 |             window.scrollBy(0, step);
 4281 | 1604 |           } catch (e) {}
 4282 | 1605 |         }
 4283 | 1606 | 
 4284 | 1607 |         const afterW = window.scrollY ?? beforeW;
 4285 | 1608 | 
 4286 | 1609 |         return {
 4287 | 1610 |           beforeC,
 4288 | 1611 |           afterC,
 4289 | 1612 |           beforeW,
 4290 | 1613 |           afterW,
 4291 | 1614 |           scrolled: afterC !== beforeC || afterW !== beforeW,
 4292 | 1615 |         };
 4293 | 1616 |       }
 4294 | 1617 | 
 4295 | 1618 |       const root = getPostRoot();
 4296 | 1619 |       const container = getCommentsContainerSmart(root);
 4297 | 1620 | 
 4298 | 1621 |       // WA≈ªNE: na video czƒôsto ‚Äúwiƒôcej komentarzy‚Äù jest poza root ‚Üí szukamy i w body
 4299 | 1622 |       let clickedMore = clickMoreCommentsOnce(root);
 4300 | 1623 |       if (!clickedMore) clickedMore = clickMoreCommentsOnce(document.body);
 4301 | 1624 | 
 4302 | 1625 |       // ‚Äú12 odpowiedzi‚Äù te≈º potrafi byƒá poza root
 4303 | 1626 |       const repliesClickedRoot = expandReplies(root, 35);
 4304 | 1627 |       const repliesClickedBody = expandReplies(document.body, Math.max(0, 35 - repliesClickedRoot));
 4305 | 1628 |       const repliesClicked = repliesClickedRoot + repliesClickedBody;
 4306 | 1629 | 
 4307 | 1630 |       const scrollRes = scrollSomewhere(container);
 4308 | 1631 | 
 4309 | 1632 |       const hasButtons = clickedMore || repliesClicked > 0;
 4310 | 1633 | 
 4311 | 1634 |       return {
 4312 | 1635 |         clickedMore,
 4313 | 1636 |         repliesClicked,
 4314 | 1637 |         scrolled: scrollRes.scrolled,
 4315 | 1638 |         hasButtons,
 4316 | 1639 |         dbg: {
 4317 | 1640 |           beforeC: scrollRes.beforeC,
 4318 | 1641 |           afterC: scrollRes.afterC,
 4319 | 1642 |           beforeW: scrollRes.beforeW,
 4320 | 1643 |           afterW: scrollRes.afterW,
 4321 | 1644 |           containerTag: container?.tagName || null,
 4322 | 1645 |         },
 4323 | 1646 |       };
 4324 | 1647 |     });
 4325 | 1648 | 
 4326 | 1649 |     console.log(
 4327 | 1650 |       `[FB][video-walk] cycle ${cycle}: more=${result.clickedMore}, replies=${result.repliesClicked}, scrolled=${result.scrolled} | dbg=${JSON.stringify(result.dbg)}`
 4328 | 1651 |     );
 4329 | 1652 | 
 4330 | 1653 |     // Stop dopiero po 3 pustych cyklach (FB czƒôsto ≈Çaduje leniwie)
 4331 | 1654 |     if (!result.hasButtons && !result.scrolled) {
 4332 | 1655 |       noProgressStreak++;
 4333 | 1656 |       console.log(`[FB][video-walk] no-progress streak = ${noProgressStreak}/3`);
 4334 | 1657 |       if (noProgressStreak >= 3) {
 4335 | 1658 |         console.log("[FB][video-walk] stop ‚Äì 3x brak przycisk√≥w i brak scrolla.");
 4336 | 1659 |         break;
 4337 | 1660 |       }
 4338 | 1661 |     } else {
 4339 | 1662 |       noProgressStreak = 0;
 4340 | 1663 |     }
 4341 | 1664 | 
 4342 | 1665 |     await sleepRandom(1200, 2000);
 4343 | 1666 |   }
 4344 | 1667 | 
 4345 | 1668 |   console.log("[FB][video-walk] koniec spaceru po komentarzach VIDEO.");
 4346 | 1669 | }
 4347 | 1670 | 
 4348 | 1671 | 
 4349 | 1672 | 
 4350 | 1673 | /* ============================================================
 4351 | 1674 |    ==================== LICZBA KOMENTARZY ======================
 4352 | 1675 |    ============================================================ */
 4353 | 1676 | 
 4354 | 1677 | async function getCommentCount(page, postUrl) {
 4355 | 1678 |   console.log(`[FB] Otwieranie posta: ${postUrl}`);
 4356 | 1679 |   const ok = await safeGoto(page, postUrl, "post", {
 4357 | 1680 |     waitUntil: "networkidle2",
 4358 | 1681 |     timeout: NAV_TIMEOUT_MS,
 4359 | 1682 |   });
 4360 | 1683 |   if (!ok) {
 4361 | 1684 |     throw new Error("safeGoto-failed");
 4362 | 1685 |   }
 4363 | 1686 |   let currentUrl = page.url();
 4364 | 1687 |   if (currentUrl.includes("/login")) {
 4365 | 1688 |     console.log(
 4366 | 1689 |       "[FB] Zamiast posta wylƒÖdowa≈Çem na /login?next=... ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
 4367 | 1690 |     );
 4368 | 1691 |     await fbLogin(page);
 4369 | 1692 |     await sleepRandom(3000, 4500);
 4370 | 1693 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 4371 | 1694 |     console.log(
 4372 | 1695 |       "[FB] Stan sesji po fbLogin() z /login:",
 4373 | 1696 |       loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
 4374 | 1697 |     );
 4375 | 1698 |     if (loggedAfterLogin) {
 4376 | 1699 |       await safeGoto(page, postUrl, "post", {
 4377 | 1700 |         waitUntil: "networkidle2",
 4378 | 1701 |         timeout: NAV_TIMEOUT_MS,
 4379 | 1702 |       });
 4380 | 1703 |     } else {
 4381 | 1704 |       console.log(
 4382 | 1705 |         "[FB] Po fbLogin() z /login nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
 4383 | 1706 |       );
 4384 | 1707 |     }
 4385 | 1708 |   }
 4386 | 1709 |   await acceptCookies(page, "post-initial");
 4387 | 1710 |   let loggedOnPost = false;
 4388 | 1711 |   try {
 4389 | 1712 |     loggedOnPost = await checkIfLogged(page);
 4390 | 1713 |   } catch (e) {
 4391 | 1714 |     console.log(
 4392 | 1715 |       "[FB] checkIfLogged na widoku posta ‚Äì b≈ÇƒÖd:",
 4393 | 1716 |       e?.message || e
 4394 | 1717 |     );
 4395 | 1718 |   }
 4396 | 1719 |   if (!loggedOnPost) {
 4397 | 1720 |     console.log(
 4398 | 1721 |       "[FB] Na widoku posta brak aktywnej sesji (np. pasek 'Zaloguj siƒô') ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
 4399 | 1722 |     );
 4400 | 1723 |     await fbLogin(page);
 4401 | 1724 |     await sleepRandom(3000, 4500);
 4402 | 1725 |     const loggedAfterFbLogin = await checkIfLogged(page).catch(() => false);
 4403 | 1726 |     console.log(
 4404 | 1727 |       "[FB] Stan sesji po fbLogin() z widoku posta:",
 4405 | 1728 |       loggedAfterFbLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
 4406 | 1729 |     );
 4407 | 1730 |     if (loggedAfterFbLogin) {
 4408 | 1731 |       console.log(
 4409 | 1732 |         "[FB] Po fbLogin() wykryto zalogowanego u≈ºytkownika ‚Äì ponownie otwieram posta."
 4410 | 1733 |       );
 4411 | 1734 |       await safeGoto(page, postUrl, "post", {
 4412 | 1735 |         waitUntil: "networkidle2",
 4413 | 1736 |         timeout: NAV_TIMEOUT_MS,
 4414 | 1737 |       });
 4415 | 1738 |       await acceptCookies(page, "post-initial");
 4416 | 1739 |     } else {
 4417 | 1740 |       console.log(
 4418 | 1741 |         "[FB] Po fbLogin() nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
 4419 | 1742 |       );
 4420 | 1743 |     }
 4421 | 1744 |   }
 4422 | 1745 |   await ensureLoggedInOnPostOverlay(page);
 4423 | 1746 |   await sleepRandom(3000, 4500);
 4424 | 1747 |   await acceptCookies(page, "post");
 4425 | 1748 |   try {
 4426 | 1749 |     const loggedAfterPostOverlay = await checkIfLogged(page);
 4427 | 1750 |     if (loggedAfterPostOverlay) {
 4428 | 1751 |       console.log(
 4429 | 1752 |         "[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."
 4430 | 1753 |       );
 4431 | 1754 |       await saveCookies(page);
 4432 | 1755 |     } else {
 4433 | 1756 |       console.log(
 4434 | 1757 |         "[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."
 4435 | 1758 |       );
 4436 | 1759 |     }
 4437 | 1760 |   } catch (e) {
 4438 | 1761 |     console.log(
 4439 | 1762 |       "[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",
 4440 | 1763 |       e?.message || e
 4441 | 1764 |     );
 4442 | 1765 |   }
 4443 | 1766 |   await sleepRandom(1500, 2500);
 4444 | 1767 |   const isWatchView = postUrl.includes("/watch/");
 4445 | 1768 |   const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(postUrl);
 4446 | 1769 |   const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(postUrl);
 4447 | 1770 |   console.log(
 4448 | 1771 |     "[FB] getCommentCount ‚Äì view type:",
 4449 | 1772 |     isWatchView ? "WATCH" : isVideoView ? "VIDEO" : isPhotoView ? "PHOTO" : "POST"
 4450 | 1773 |   );
 4451 | 1774 |   if (isVideoView) {
 4452 | 1775 |     await pauseVideoIfAny(page);
 4453 | 1776 |     await clickShowAllCommentsIfPresent(page);
 4454 | 1777 |   }
 4455 | 1778 |   if (!isVideoView) {
 4456 | 1779 |     await scrollPost(page, 200);
 4457 | 1780 |     await sleepRandom(800, 1200);
 4458 | 1781 |   }
 4459 | 1782 |   try {
 4460 | 1783 |     const okFilter = await switchCommentsFilterToAll(page);
 4461 | 1784 |     console.log(
 4462 | 1785 |       "[FB] Pierwsza pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
 4463 | 1786 |       okFilter
 4464 | 1787 |     );
 4465 | 1788 |     if (okFilter) await sleepRandom(1200, 2000);
 4466 | 1789 |   } catch (e) {
 4467 | 1790 |     console.log(
 4468 | 1791 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",
 4469 | 1792 |       e.message
 4470 | 1793 |     );
 4471 | 1794 |   }
 4472 | 1795 |   if (isVideoView) {
 4473 | 1796 |     await pauseVideoIfAny(page);
 4474 | 1797 |   }
 4475 | 1798 |   const uiInfo = await getUiCommentInfo(page);
 4476 | 1799 |   console.log("[DBG] Comments debug (skr√≥cone):", {
 4477 | 1800 |     source: uiInfo?.source,
 4478 | 1801 |     raw: uiInfo?.raw,
 4479 | 1802 |     viewType: uiInfo?.viewType,
 4480 | 1803 |     comments: uiInfo?.comments,
 4481 | 1804 |   });
 4482 | 1805 |   let expectedTotal = null;
 4483 | 1806 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
 4484 | 1807 |     expectedTotal = uiInfo.comments;
 4485 | 1808 |   }
 4486 | 1809 |   if (isVideoView) {
 4487 | 1810 |     await clickMoreCommentsButtonsVideo(page);
 4488 | 1811 |   }
 4489 | 1812 |   if (isVideoView) {
 4490 | 1813 |     await walkVideoCommentsSequential(page, expectedTotal || null);
 4491 | 1814 |   } else {
 4492 | 1815 |     await ensureAllCommentsLoaded(page, expectedTotal);
 4493 | 1816 |   }
 4494 | 1817 |   try {
 4495 | 1818 |     const ok2 = await switchCommentsFilterToAll(page);
 4496 | 1819 |     console.log(
 4497 | 1820 |       "[FB] Druga pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
 4498 | 1821 |       ok2
 4499 | 1822 |     );
 4500 | 1823 |     if (ok2) await sleepRandom(800, 1500);
 4501 | 1824 |   } catch (e) {
 4502 | 1825 |     console.log(
 4503 | 1826 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",
 4504 | 1827 |       e.message
 4505 | 1828 |     );
 4506 | 1829 |   }
 4507 | 1830 |   const fallback = await page.evaluate(() => {
 4508 | 1831 |     const root = document;
 4509 | 1832 |     const anchors = Array.from(
 4510 | 1833 |       root.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
 4511 | 1834 |     );
 4512 | 1835 |     const ids = new Set();
 4513 | 1836 |     for (const a of anchors) {
 4514 | 1837 |       try {
 4515 | 1838 |         const url = new URL(a.href);
 4516 | 1839 |         const cid = url.searchParams.get("comment_id");
 4517 | 1840 |         const rid = url.searchParams.get("reply_comment_id");
 4518 | 1841 |         let raw = rid || cid;
 4519 | 1842 |         if (!raw) continue;
 4520 | 1843 |         if (!/^\d+$/.test(raw)) {
 4521 | 1844 |           try {
 4522 | 1845 |             const dec = atob(raw);
 4523 | 1846 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 4524 | 1847 |             if (m) raw = m[2];
 4525 | 1848 |           } catch {}
 4526 | 1849 |         }
 4527 | 1850 |         if (raw) ids.add(raw);
 4528 | 1851 |       } catch {}
 4529 | 1852 |     }
 4530 | 1853 |     return { count: ids.size };
 4531 | 1854 |   });
 4532 | 1855 |   console.log("[FB] Fallback ‚Äì anchor IDs:", fallback.count);
 4533 | 1856 |   let finalNum = uiInfo?.comments ?? null;
 4534 | 1857 |   if (fallback.count > 0) {
 4535 | 1858 |     if (finalNum == null || finalNum === 0) {
 4536 | 1859 |       finalNum = fallback.count;
 4537 | 1860 |       console.log(
 4538 | 1861 |         "[FB] UI puste/0 ‚Äì u≈ºywam anchor√≥w jako ≈∫r√≥d≈Ça.",
 4539 | 1862 |         `anchor=${fallback.count}`
 4540 | 1863 |       );
 4541 | 1864 |     } else {
 4542 | 1865 |       const diff = finalNum - fallback.count;
 4543 | 1866 |       if (diff > 5) {
 4544 | 1867 |         console.log(
 4545 | 1868 |           "[FB] UI >> anchory ‚Äì czƒô≈õƒá komentarzy niedostƒôpna, u≈ºywam anchor√≥w.",
 4546 | 1869 |           `ui=${finalNum}, anchor=${fallback.count}`
 4547 | 1870 |         );
 4548 | 1871 |         finalNum = fallback.count;
 4549 | 1872 |       } else if (fallback.count > finalNum) {
 4550 | 1873 |         console.log(
 4551 | 1874 |           "[FB] Anchory > UI ‚Äì u≈ºywam anchor√≥w jako bazowej liczby.",
 4552 | 1875 |           `ui=${finalNum}, anchor=${fallback.count}`
 4553 | 1876 |         );
 4554 | 1877 |         finalNum = fallback.count;
 4555 | 1878 |       } else {
 4556 | 1879 |         console.log(
 4557 | 1880 |           "[FB] UI ~= anchory ‚Äì zostawiam UI jako ≈∫r√≥d≈Ço.",
 4558 | 1881 |           `ui=${finalNum}, anchor=${fallback.count}`
 4559 | 1882 |         );
 4560 | 1883 |       }
 4561 | 1884 |     }
 4562 | 1885 |   } else {
 4563 | 1886 |     console.log("[FB] Anchory=0 ‚Äì opieram siƒô wy≈ÇƒÖcznie na UI:", finalNum);
 4564 | 1887 |   }
 4565 | 1888 |   if (finalNum != null) {
 4566 | 1889 |     console.log("[FB] Liczba komentarzy (final):", finalNum);
 4567 | 1890 |     return finalNum;
 4568 | 1891 |   }
 4569 | 1892 |   console.log("[FB] Brak liczby komentarzy w UI i brak anchor√≥w, zwracam 0.");
 4570 | 1893 |   return 0;
 4571 | 1894 | }
 4572 | 1895 | 
 4573 | 1896 | /* ============================================================
 4574 | 1897 |    ================= ROZWIJANIE KOMENTARZY ====================
 4575 | 1898 |    ============================================================ */
 4576 | 1899 | 
 4577 | 1900 | async function expandAllComments(page) {
 4578 | 1901 |   if (!EXPAND_COMMENTS) {
 4579 | 1902 |     console.log("[FB] EXPAND_COMMENTS=false ‚Üí pomijam rozwijanie.");
 4580 | 1903 |     return 0;
 4581 | 1904 |   }
 4582 | 1905 |   let clicks = 0;
 4583 | 1906 |   for (let i = 0; i < 30; i++) {
 4584 | 1907 |     const didClick = await clickOneExpandButton(page);
 4585 | 1908 |     if (!didClick) break;
 4586 | 1909 |     clicks++;
 4587 | 1910 |     await sleepRandom(900, 1600);
 4588 | 1911 |   }
 4589 | 1912 |   return clicks;
 4590 | 1913 | }
 4591 | 1914 | 
 4592 | 1915 | export async function extractCommentsData(page) {
 4593 | 1916 |   try {
 4594 | 1917 |     const comments = await extractCommentsFromDOM(page);
 4595 | 1918 |     return comments;
 4596 | 1919 |   } catch (err) {
 4597 | 1920 |     console.error('[FB] extractCommentsData ‚Äì b≈ÇƒÖd:', err.message);
 4598 | 1921 |     return [];
 4599 | 1922 |   }
 4600 | 1923 | }
 4601 | 1924 | 
 4602 | 1925 | export { getCommentCount, expandAllComments,  };
 4603 | 1926 | 
 4604 | ```
 4605 | 
 4606 | ---
 4607 | 
 4608 | ### üìÑ ≈öcie≈ºka: `src/fb/login.js`
 4609 | **Typ:** JavaScript/tekst  
 4610 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 4611 | 
 4612 | ```js
 4613 |    1 | // src/fb/login.js
 4614 |    2 | import { sleepRandom, humanType } from "../utils/sleep.js";
 4615 |    3 | import log from "../utils/logger.js";
 4616 |    4 | import { CAPTCHA_ENABLED, CAPTCHA_API_KEY } from "../config.js";
 4617 |    5 | 
 4618 |    6 | /**
 4619 |    7 |  * Diagnozuje typ captcha na stronie
 4620 |    8 |  * @param {import('puppeteer').Page} page
 4621 |    9 |  * @returns {Promise<{type: string, details: object}>}
 4622 |   10 |  */
 4623 |   11 | async function diagnoseCaptchaType(page) {
 4624 |   12 |   log.prod("CAPTCHA", "=== DIAGNOSTYKA TYPU CAPTCHA ===");
 4625 |   13 | 
 4626 |   14 |   const frames = page.frames();
 4627 |   15 |   log.prod("CAPTCHA", `Liczba frames: ${frames.length}`);
 4628 |   16 | 
 4629 |   17 |   const diagnosis = {
 4630 |   18 |     type: "unknown",
 4631 |   19 |     details: {
 4632 |   20 |       frames: [],
 4633 |   21 |       pageIndicators: [],
 4634 |   22 |       sitekey: null,
 4635 |   23 |       publicKey: null,
 4636 |   24 |     }
 4637 |   25 |   };
 4638 |   26 | 
 4639 |   27 |   // Sprawd≈∫ wszystkie frames
 4640 |   28 |   for (const frame of frames) {
 4641 |   29 |     try {
 4642 |   30 |       const url = frame.url();
 4643 |   31 |       if (!url || url === "about:blank") continue;
 4644 |   32 | 
 4645 |   33 |       const frameInfo = { url: url.substring(0, 120) };
 4646 |   34 | 
 4647 |   35 |       // FunCaptcha / Arkose Labs
 4648 |   36 |       if (url.includes("arkoselabs") || url.includes("funcaptcha")) {
 4649 |   37 |         diagnosis.type = "funcaptcha";
 4650 |   38 |         frameInfo.type = "funcaptcha";
 4651 |   39 | 
 4652 |   40 |         // WyciƒÖgnij public key z URL
 4653 |   41 |         const pkMatch = url.match(/[?&]pk=([^&]+)/);
 4654 |   42 |         if (pkMatch) {
 4655 |   43 |           diagnosis.details.publicKey = pkMatch[1];
 4656 |   44 |           frameInfo.publicKey = pkMatch[1];
 4657 |   45 |         }
 4658 |   46 |       }
 4659 |   47 |       // reCAPTCHA
 4660 |   48 |       else if (url.includes("recaptcha") || url.includes("google.com/recaptcha")) {
 4661 |   49 |         diagnosis.type = diagnosis.type === "unknown" ? "recaptcha" : diagnosis.type;
 4662 |   50 |         frameInfo.type = "recaptcha";
 4663 |   51 | 
 4664 |   52 |         if (url.includes("/enterprise/")) {
 4665 |   53 |           frameInfo.enterprise = true;
 4666 |   54 |         }
 4667 |   55 | 
 4668 |   56 |         const keyMatch = url.match(/[?&]k=([^&]+)/);
 4669 |   57 |         if (keyMatch) {
 4670 |   58 |           diagnosis.details.sitekey = keyMatch[1];
 4671 |   59 |           frameInfo.sitekey = keyMatch[1];
 4672 |   60 |         }
 4673 |   61 |       }
 4674 |   62 |       // hCaptcha
 4675 |   63 |       else if (url.includes("hcaptcha")) {
 4676 |   64 |         diagnosis.type = diagnosis.type === "unknown" ? "hcaptcha" : diagnosis.type;
 4677 |   65 |         frameInfo.type = "hcaptcha";
 4678 |   66 |       }
 4679 |   67 | 
 4680 |   68 |       if (frameInfo.type) {
 4681 |   69 |         diagnosis.details.frames.push(frameInfo);
 4682 |   70 |         log.prod("CAPTCHA", `Frame: ${frameInfo.type} - ${url.substring(0, 80)}...`);
 4683 |   71 |       }
 4684 |   72 |     } catch {
 4685 |   73 |       // Ignoruj b≈Çƒôdy
 4686 |   74 |     }
 4687 |   75 |   }
 4688 |   76 | 
 4689 |   77 |   // Sprawd≈∫ elementy na g≈Ç√≥wnej stronie + u≈ºyj skryptu 2Captcha do wykrywania reCAPTCHA
 4690 |   78 |   const pageCheck = await page.evaluate(() => {
 4691 |   79 |     const indicators = [];
 4692 |   80 | 
 4693 |   81 |     // FunCaptcha / Arkose Labs
 4694 |   82 |     if (document.querySelector('#FunCaptcha, [data-callback*="funcaptcha"], iframe[src*="arkoselabs"]')) {
 4695 |   83 |       indicators.push("funcaptcha_element");
 4696 |   84 |     }
 4697 |   85 | 
 4698 |   86 |     // Szukaj enforcement script (Arkose)
 4699 |   87 |     const scripts = Array.from(document.querySelectorAll('script[src]'));
 4700 |   88 |     for (const s of scripts) {
 4701 |   89 |       if (s.src.includes('arkoselabs') || s.src.includes('funcaptcha')) {
 4702 |   90 |         indicators.push(`arkose_script: ${s.src.substring(0, 60)}`);
 4703 |   91 |       }
 4704 |   92 |     }
 4705 |   93 | 
 4706 |   94 |     // Szukaj data-callback z arkose
 4707 |   95 |     const arkoseDiv = document.querySelector('[data-callback]');
 4708 |   96 |     if (arkoseDiv) {
 4709 |   97 |       indicators.push(`data-callback: ${arkoseDiv.getAttribute('data-callback')}`);
 4710 |   98 |     }
 4711 |   99 | 
 4712 |  100 |     // reCAPTCHA - element na stronie
 4713 |  101 |     if (document.querySelector('.g-recaptcha, [data-sitekey]')) {
 4714 |  102 |       indicators.push("recaptcha_element");
 4715 |  103 |       const sitekey = document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey');
 4716 |  104 |       if (sitekey) indicators.push(`sitekey: ${sitekey.substring(0, 20)}...`);
 4717 |  105 |     }
 4718 |  106 | 
 4719 |  107 |     // === SKRYPT 2CAPTCHA - wykrywanie reCAPTCHA clients ===
 4720 |  108 |     // eslint-disable-next-line camelcase
 4721 |  109 |     if (typeof ___grecaptcha_cfg !== 'undefined') {
 4722 |  110 |       try {
 4723 |  111 |         // eslint-disable-next-line camelcase, no-undef
 4724 |  112 |         const clients = Object.entries(___grecaptcha_cfg.clients).map(([cid, client]) => {
 4725 |  113 |           const data = { id: cid, version: cid >= 10000 ? 'V3' : 'V2' };
 4726 |  114 |           const objects = Object.entries(client).filter(([_, value]) => value && typeof value === 'object');
 4727 |  115 | 
 4728 |  116 |           objects.forEach(([toplevelKey, toplevel]) => {
 4729 |  117 |             const found = Object.entries(toplevel).find(([_, value]) => (
 4730 |  118 |               value && typeof value === 'object' && 'sitekey' in value && 'size' in value
 4731 |  119 |             ));
 4732 |  120 | 
 4733 |  121 |             if (typeof toplevel === 'object' && toplevel instanceof HTMLElement && toplevel['tagName'] === 'DIV') {
 4734 |  122 |               data.pageurl = toplevel.baseURI;
 4735 |  123 |             }
 4736 |  124 | 
 4737 |  125 |             if (found) {
 4738 |  126 |               const [sublevelKey, sublevel] = found;
 4739 |  127 |               data.sitekey = sublevel.sitekey;
 4740 |  128 |               const callbackKey = data.version === 'V2' ? 'callback' : 'promise-callback';
 4741 |  129 |               const callback = sublevel[callbackKey];
 4742 |  130 |               if (callback) {
 4743 |  131 |                 const keys = [cid, toplevelKey, sublevelKey, callbackKey].map((key) => `['${key}']`).join('');
 4744 |  132 |                 data.callback = `___grecaptcha_cfg.clients${keys}`;
 4745 |  133 |               }
 4746 |  134 |             }
 4747 |  135 |           });
 4748 |  136 |           return data;
 4749 |  137 |         });
 4750 |  138 | 
 4751 |  139 |         if (clients.length > 0) {
 4752 |  140 |           indicators.push(`grecaptcha_clients: ${JSON.stringify(clients)}`);
 4753 |  141 |         }
 4754 |  142 |       } catch (e) {
 4755 |  143 |         indicators.push(`grecaptcha_error: ${e.message}`);
 4756 |  144 |       }
 4757 |  145 |     }
 4758 |  146 | 
 4759 |  147 |     // Tekst na stronie
 4760 |  148 |     const bodyText = (document.body?.innerText || '').toLowerCase();
 4761 |  149 |     if (bodyText.includes('arkose') || bodyText.includes('funcaptcha')) {
 4762 |  150 |       indicators.push("arkose_text");
 4763 |  151 |     }
 4764 |  152 | 
 4765 |  153 |     return indicators;
 4766 |  154 |   });
 4767 |  155 | 
 4768 |  156 |   diagnosis.details.pageIndicators = pageCheck;
 4769 |  157 |   if (pageCheck.length > 0) {
 4770 |  158 |     log.prod("CAPTCHA", `Wska≈∫niki na stronie: ${pageCheck.join(', ')}`);
 4771 |  159 |   }
 4772 |  160 | 
 4773 |  161 |   // Je≈õli znaleziono funcaptcha, ustaw typ
 4774 |  162 |   if (pageCheck.some(i => i.includes("funcaptcha") || i.includes("arkose"))) {
 4775 |  163 |     diagnosis.type = "funcaptcha";
 4776 |  164 |   }
 4777 |  165 | 
 4778 |  166 |   // Parsuj dane z grecaptcha_clients (skrypt 2Captcha)
 4779 |  167 |   const grecaptchaMatch = pageCheck.find(i => i.startsWith("grecaptcha_clients:"));
 4780 |  168 |   if (grecaptchaMatch) {
 4781 |  169 |     try {
 4782 |  170 |       const jsonStr = grecaptchaMatch.replace("grecaptcha_clients: ", "");
 4783 |  171 |       const clients = JSON.parse(jsonStr);
 4784 |  172 |       if (clients.length > 0) {
 4785 |  173 |         diagnosis.type = "recaptcha";
 4786 |  174 |         diagnosis.details.grecaptchaClients = clients;
 4787 |  175 |         // U≈ºyj pierwszego klienta z sitekey
 4788 |  176 |         const clientWithSitekey = clients.find(c => c.sitekey);
 4789 |  177 |         if (clientWithSitekey) {
 4790 |  178 |           diagnosis.details.sitekey = clientWithSitekey.sitekey;
 4791 |  179 |           diagnosis.details.callback = clientWithSitekey.callback;
 4792 |  180 |           diagnosis.details.version = clientWithSitekey.version;
 4793 |  181 |           log.prod("CAPTCHA", `Znaleziono reCAPTCHA ${clientWithSitekey.version} przez ___grecaptcha_cfg`);
 4794 |  182 |           log.prod("CAPTCHA", `Sitekey: ${clientWithSitekey.sitekey?.substring(0, 20)}...`);
 4795 |  183 |           if (clientWithSitekey.callback) {
 4796 |  184 |             log.prod("CAPTCHA", `Callback: ${clientWithSitekey.callback}`);
 4797 |  185 |           }
 4798 |  186 |         }
 4799 |  187 |       }
 4800 |  188 |     } catch (e) {
 4801 |  189 |       log.debug("CAPTCHA", `B≈ÇƒÖd parsowania grecaptcha_clients: ${e.message}`);
 4802 |  190 |     }
 4803 |  191 |   }
 4804 |  192 | 
 4805 |  193 |   log.prod("CAPTCHA", `=== WYKRYTY TYP: ${diagnosis.type.toUpperCase()} ===`);
 4806 |  194 | 
 4807 |  195 |   return diagnosis;
 4808 |  196 | }
 4809 |  197 | 
 4810 |  198 | /**
 4811 |  199 |  * RozwiƒÖzuje FunCaptcha/Arkose Labs przez 2Captcha API
 4812 |  200 |  * @param {string} publicKey - klucz publiczny Arkose (parametr pk= z URL)
 4813 |  201 |  * @param {string} pageUrl - URL strony z captcha
 4814 |  202 |  * @param {string} surl - opcjonalny service URL
 4815 |  203 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 4816 |  204 |  */
 4817 |  205 | async function solveFunCaptchaViaApi(publicKey, pageUrl, surl = null) {
 4818 |  206 |   if (!CAPTCHA_API_KEY || !publicKey) {
 4819 |  207 |     return { ok: false, error: "missing_params" };
 4820 |  208 |   }
 4821 |  209 | 
 4822 |  210 |   log.prod("CAPTCHA", `Wysy≈Çam FunCaptcha do 2Captcha (publicKey: ${publicKey.substring(0, 15)}...)`);
 4823 |  211 | 
 4824 |  212 |   try {
 4825 |  213 |     const createTaskPayload = {
 4826 |  214 |       clientKey: CAPTCHA_API_KEY,
 4827 |  215 |       task: {
 4828 |  216 |         type: "FunCaptchaTaskProxyless",
 4829 |  217 |         websiteURL: pageUrl,
 4830 |  218 |         websitePublicKey: publicKey,
 4831 |  219 |       },
 4832 |  220 |     };
 4833 |  221 | 
 4834 |  222 |     // Dodaj service URL je≈õli podany
 4835 |  223 |     if (surl) {
 4836 |  224 |       createTaskPayload.task.funcaptchaApiJSSubdomain = surl;
 4837 |  225 |     }
 4838 |  226 | 
 4839 |  227 |     log.debug("CAPTCHA", `Payload: ${JSON.stringify(createTaskPayload).substring(0, 200)}`);
 4840 |  228 | 
 4841 |  229 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 4842 |  230 |       method: "POST",
 4843 |  231 |       headers: { "Content-Type": "application/json" },
 4844 |  232 |       body: JSON.stringify(createTaskPayload),
 4845 |  233 |     });
 4846 |  234 |     const createData = await createRes.json();
 4847 |  235 | 
 4848 |  236 |     if (createData.errorId !== 0) {
 4849 |  237 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 4850 |  238 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 4851 |  239 |     }
 4852 |  240 | 
 4853 |  241 |     const taskId = createData.taskId;
 4854 |  242 |     log.dev("CAPTCHA", `FunCaptcha Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 4855 |  243 | 
 4856 |  244 |     // Polling - max 180 sekund
 4857 |  245 |     const maxAttempts = 36;
 4858 |  246 |     for (let i = 0; i < maxAttempts; i++) {
 4859 |  247 |       await new Promise(r => setTimeout(r, 5000));
 4860 |  248 | 
 4861 |  249 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 4862 |  250 |         method: "POST",
 4863 |  251 |         headers: { "Content-Type": "application/json" },
 4864 |  252 |         body: JSON.stringify({
 4865 |  253 |           clientKey: CAPTCHA_API_KEY,
 4866 |  254 |           taskId: taskId,
 4867 |  255 |         }),
 4868 |  256 |       });
 4869 |  257 |       const resultData = await resultRes.json();
 4870 |  258 | 
 4871 |  259 |       if (resultData.errorId !== 0) {
 4872 |  260 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 4873 |  261 |         return { ok: false, error: resultData.errorCode };
 4874 |  262 |       }
 4875 |  263 | 
 4876 |  264 |       if (resultData.status === "ready") {
 4877 |  265 |         const token = resultData.solution?.token;
 4878 |  266 |         if (token) {
 4879 |  267 |           log.success("CAPTCHA", `FunCaptcha rozwiƒÖzana! (pr√≥ba ${i + 1})`);
 4880 |  268 |           return { ok: true, token };
 4881 |  269 |         }
 4882 |  270 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi FunCaptcha");
 4883 |  271 |         return { ok: false, error: "no_token" };
 4884 |  272 |       }
 4885 |  273 | 
 4886 |  274 |       log.debug("CAPTCHA", `Czekam na FunCaptcha... (${i + 1}/${maxAttempts})`);
 4887 |  275 |     }
 4888 |  276 | 
 4889 |  277 |     return { ok: false, error: "timeout" };
 4890 |  278 |   } catch (err) {
 4891 |  279 |     log.error("CAPTCHA", `B≈ÇƒÖd FunCaptcha API: ${err?.message}`);
 4892 |  280 |     return { ok: false, error: err?.message };
 4893 |  281 |   }
 4894 |  282 | }
 4895 |  283 | 
 4896 |  284 | /**
 4897 |  285 |  * RozwiƒÖzuje reCAPTCHA Enterprise przez API v2 2Captcha (createTask)
 4898 |  286 |  * @param {string} sitekey - klucz witryny reCAPTCHA (parametr k= z URL)
 4899 |  287 |  * @param {string} pageUrl - URL strony z captcha
 4900 |  288 |  * @param {object} options - dodatkowe opcje
 4901 |  289 |  * @param {boolean} options.isInvisible - czy to invisible captcha (domy≈õlnie false)
 4902 |  290 |  * @param {boolean} options.isEnterprise - czy to Enterprise captcha (domy≈õlnie true)
 4903 |  291 |  * @param {string} options.dataS - parametr data-s ze strony (dla Enterprise)
 4904 |  292 |  * @returns {Promise<{ok: boolean, token?: string, error?: string}>}
 4905 |  293 |  */
 4906 |  294 | async function solveRecaptchaViaApi(sitekey, pageUrl, options = {}) {
 4907 |  295 |   const { isInvisible = false, isEnterprise = true, dataS = null } = options;
 4908 |  296 | 
 4909 |  297 |   if (!CAPTCHA_API_KEY || !sitekey) {
 4910 |  298 |     return { ok: false, error: "missing_params" };
 4911 |  299 |   }
 4912 |  300 | 
 4913 |  301 |   log.prod("CAPTCHA", `Wysy≈Çam do 2Captcha API v2 (sitekey: ${sitekey.substring(0, 10)}..., enterprise: ${isEnterprise}, dataS: ${dataS ? 'tak' : 'nie'})`);
 4914 |  302 | 
 4915 |  303 |   try {
 4916 |  304 |     // 1. Wy≈õlij zadanie do 2Captcha (API v2)
 4917 |  305 |     const taskType = isEnterprise
 4918 |  306 |       ? "RecaptchaV2EnterpriseTaskProxyless"
 4919 |  307 |       : "RecaptchaV2TaskProxyless";
 4920 |  308 | 
 4921 |  309 |     const createTaskPayload = {
 4922 |  310 |       clientKey: CAPTCHA_API_KEY,
 4923 |  311 |       task: {
 4924 |  312 |         type: taskType,
 4925 |  313 |         websiteURL: pageUrl,
 4926 |  314 |         websiteKey: sitekey,
 4927 |  315 |         isInvisible: isInvisible,
 4928 |  316 |         // FB u≈ºywa w≈Çasnej domeny dla reCAPTCHA
 4929 |  317 |         apiDomain: "www.recaptcha.net",
 4930 |  318 |       },
 4931 |  319 |     };
 4932 |  320 | 
 4933 |  321 |     // Dodaj enterprisePayload je≈õli mamy data-s
 4934 |  322 |     if (isEnterprise && dataS) {
 4935 |  323 |       createTaskPayload.task.enterprisePayload = { s: dataS };
 4936 |  324 |       log.debug("CAPTCHA", `Dodano enterprisePayload.s: ${dataS.substring(0, 30)}...`);
 4937 |  325 |     }
 4938 |  326 | 
 4939 |  327 |     log.debug("CAPTCHA", `Typ zadania: ${taskType}`);
 4940 |  328 | 
 4941 |  329 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 4942 |  330 |       method: "POST",
 4943 |  331 |       headers: { "Content-Type": "application/json" },
 4944 |  332 |       body: JSON.stringify(createTaskPayload),
 4945 |  333 |     });
 4946 |  334 |     const createData = await createRes.json();
 4947 |  335 | 
 4948 |  336 |     if (createData.errorId !== 0) {
 4949 |  337 |       log.error("CAPTCHA", `B≈ÇƒÖd createTask: ${createData.errorCode} - ${createData.errorDescription}`);
 4950 |  338 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 4951 |  339 |     }
 4952 |  340 | 
 4953 |  341 |     const taskId = createData.taskId;
 4954 |  342 |     log.dev("CAPTCHA", `Task ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 4955 |  343 | 
 4956 |  344 |     // 2. Polling - czekaj na rozwiƒÖzanie (max 180 sekund dla Enterprise)
 4957 |  345 |     const maxAttempts = 36; // 36 * 5s = 180s
 4958 |  346 |     for (let i = 0; i < maxAttempts; i++) {
 4959 |  347 |       await new Promise(r => setTimeout(r, 5000)); // czekaj 5 sekund
 4960 |  348 | 
 4961 |  349 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 4962 |  350 |         method: "POST",
 4963 |  351 |         headers: { "Content-Type": "application/json" },
 4964 |  352 |         body: JSON.stringify({
 4965 |  353 |           clientKey: CAPTCHA_API_KEY,
 4966 |  354 |           taskId: taskId,
 4967 |  355 |         }),
 4968 |  356 |       });
 4969 |  357 |       const resultData = await resultRes.json();
 4970 |  358 | 
 4971 |  359 |       if (resultData.errorId !== 0) {
 4972 |  360 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 4973 |  361 |         return { ok: false, error: resultData.errorCode };
 4974 |  362 |       }
 4975 |  363 | 
 4976 |  364 |       if (resultData.status === "ready") {
 4977 |  365 |         const token = resultData.solution?.gRecaptchaResponse;
 4978 |  366 |         if (token) {
 4979 |  367 |           log.success("CAPTCHA", `RozwiƒÖzano! (pr√≥ba ${i + 1})`);
 4980 |  368 |           return { ok: true, token };
 4981 |  369 |         }
 4982 |  370 |         log.error("CAPTCHA", "Brak tokenu w odpowiedzi");
 4983 |  371 |         return { ok: false, error: "no_token" };
 4984 |  372 |       }
 4985 |  373 | 
 4986 |  374 |       log.debug("CAPTCHA", `Czekam... (${i + 1}/${maxAttempts})`);
 4987 |  375 |     }
 4988 |  376 | 
 4989 |  377 |     return { ok: false, error: "timeout" };
 4990 |  378 |   } catch (err) {
 4991 |  379 |     log.error("CAPTCHA", `B≈ÇƒÖd API: ${err?.message}`);
 4992 |  380 |     return { ok: false, error: err?.message };
 4993 |  381 |   }
 4994 |  382 | }
 4995 |  383 | 
 4996 |  384 | /**
 4997 |  385 |  * RozwiƒÖzuje reCAPTCHA z siatkƒÖ obrazk√≥w przez GridTask (2Captcha)
 4998 |  386 |  * Zamiast generowaƒá token, klika fizycznie w kwadraty wskazane przez pracownik√≥w.
 4999 |  387 |  *
 5000 |  388 |  * @param {Page} page - Puppeteer page
 5001 |  389 |  * @returns {Promise<{ok: boolean, clicked?: number[], error?: string}>}
 5002 |  390 |  */
 5003 |  391 | async function solveGridCaptcha(page) {
 5004 |  392 |   if (!CAPTCHA_API_KEY) {
 5005 |  393 |     return { ok: false, error: "missing_api_key" };
 5006 |  394 |   }
 5007 |  395 | 
 5008 |  396 |   log.prod("CAPTCHA", "=== GRID CAPTCHA SOLVER ===");
 5009 |  397 | 
 5010 |  398 |   try {
 5011 |  399 |     // 1. Znajd≈∫ iframe z siatkƒÖ obrazk√≥w (bframe)
 5012 |  400 |     const frames = page.frames();
 5013 |  401 |     let gridFrame = null;
 5014 |  402 |     let gridFrameUrl = null;
 5015 |  403 | 
 5016 |  404 |     for (const frame of frames) {
 5017 |  405 |       const url = frame.url();
 5018 |  406 |       if (url.includes('recaptcha') && url.includes('bframe')) {
 5019 |  407 |         gridFrame = frame;
 5020 |  408 |         gridFrameUrl = url;
 5021 |  409 |         log.dev("CAPTCHA", `Znaleziono bframe: ${url.substring(0, 80)}...`);
 5022 |  410 |         break;
 5023 |  411 |       }
 5024 |  412 |     }
 5025 |  413 | 
 5026 |  414 |     if (!gridFrame) {
 5027 |  415 |       log.warn("CAPTCHA", "Nie znaleziono iframe z siatkƒÖ obrazk√≥w");
 5028 |  416 |       return { ok: false, error: "no_grid_frame" };
 5029 |  417 |     }
 5030 |  418 | 
 5031 |  419 |     // 2. Poczekaj na za≈Çadowanie siatki
 5032 |  420 |     await sleepRandom(1500, 2500);
 5033 |  421 | 
 5034 |  422 |     // 3. WyciƒÖgnij instrukcjƒô (np. "Wybierz wszystkie kwadraty z przej≈õciami dla pieszych")
 5035 |  423 |     let instruction = "";
 5036 |  424 |     try {
 5037 |  425 |       instruction = await gridFrame.evaluate(() => {
 5038 |  426 |         // Szukaj instrukcji w r√≥≈ºnych miejscach
 5039 |  427 |         const selectors = [
 5040 |  428 |           '.rc-imageselect-desc-wrapper',
 5041 |  429 |           '.rc-imageselect-desc',
 5042 |  430 |           '.rc-imageselect-instructions',
 5043 |  431 |           'strong',
 5044 |  432 |           '.rc-imageselect-desc-no-canonical'
 5045 |  433 |         ];
 5046 |  434 |         for (const sel of selectors) {
 5047 |  435 |           const el = document.querySelector(sel);
 5048 |  436 |           if (el && el.textContent.trim()) {
 5049 |  437 |             return el.textContent.trim();
 5050 |  438 |           }
 5051 |  439 |         }
 5052 |  440 |         return "";
 5053 |  441 |       });
 5054 |  442 |       log.prod("CAPTCHA", `Instrukcja: "${instruction.substring(0, 60)}..."`);
 5055 |  443 |     } catch (err) {
 5056 |  444 |       log.warn("CAPTCHA", `Nie mo≈ºna wyciƒÖgnƒÖƒá instrukcji: ${err?.message}`);
 5057 |  445 |     }
 5058 |  446 | 
 5059 |  447 |     // Przet≈Çumacz instrukcjƒô na angielski dla 2Captcha (pracownicy lepiej rozumiejƒÖ)
 5060 |  448 |     const instructionEn = translateInstruction(instruction);
 5061 |  449 |     log.dev("CAPTCHA", `Instrukcja EN: "${instructionEn}"`);
 5062 |  450 | 
 5063 |  451 |     // 4. Zr√≥b screenshot siatki obrazk√≥w
 5064 |  452 |     let screenshotBase64 = null;
 5065 |  453 |     try {
 5066 |  454 |       // Znajd≈∫ element z siatkƒÖ
 5067 |  455 |       const gridElement = await gridFrame.$('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44, .rc-imageselect');
 5068 |  456 | 
 5069 |  457 |       if (gridElement) {
 5070 |  458 |         const screenshotBuffer = await gridElement.screenshot({ encoding: 'base64' });
 5071 |  459 |         screenshotBase64 = screenshotBuffer;
 5072 |  460 |         log.prod("CAPTCHA", `Screenshot siatki: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 5073 |  461 |       } else {
 5074 |  462 |         // Fallback - screenshot ca≈Çego iframe
 5075 |  463 |         const frameElement = await page.$('iframe[src*="bframe"]');
 5076 |  464 |         if (frameElement) {
 5077 |  465 |           const screenshotBuffer = await frameElement.screenshot({ encoding: 'base64' });
 5078 |  466 |           screenshotBase64 = screenshotBuffer;
 5079 |  467 |           log.prod("CAPTCHA", `Screenshot iframe: ${(screenshotBase64.length / 1024).toFixed(1)}KB`);
 5080 |  468 |         }
 5081 |  469 |       }
 5082 |  470 |     } catch (err) {
 5083 |  471 |       log.error("CAPTCHA", `B≈ÇƒÖd screenshot: ${err?.message}`);
 5084 |  472 |       return { ok: false, error: "screenshot_failed" };
 5085 |  473 |     }
 5086 |  474 | 
 5087 |  475 |     if (!screenshotBase64) {
 5088 |  476 |       return { ok: false, error: "no_screenshot" };
 5089 |  477 |     }
 5090 |  478 | 
 5091 |  479 |     // 5. Sprawd≈∫ rozmiar siatki (3x3 lub 4x4)
 5092 |  480 |     let gridSize = "3x3";
 5093 |  481 |     try {
 5094 |  482 |       gridSize = await gridFrame.evaluate(() => {
 5095 |  483 |         if (document.querySelector('.rc-imageselect-table-44')) return "4x4";
 5096 |  484 |         if (document.querySelector('.rc-imageselect-table-33')) return "3x3";
 5097 |  485 |         // Policz kwadraty
 5098 |  486 |         const tiles = document.querySelectorAll('.rc-imageselect-tile');
 5099 |  487 |         if (tiles.length === 16) return "4x4";
 5100 |  488 |         return "3x3";
 5101 |  489 |       });
 5102 |  490 |       log.dev("CAPTCHA", `Rozmiar siatki: ${gridSize}`);
 5103 |  491 |     } catch {}
 5104 |  492 | 
 5105 |  493 |     // 6. Wy≈õlij do 2Captcha GridTask
 5106 |  494 |     log.prod("CAPTCHA", "Wysy≈Çam GridTask do 2Captcha...");
 5107 |  495 | 
 5108 |  496 |     const createTaskPayload = {
 5109 |  497 |       clientKey: CAPTCHA_API_KEY,
 5110 |  498 |       task: {
 5111 |  499 |         type: "GridTask",
 5112 |  500 |         body: screenshotBase64,
 5113 |  501 |         comment: instructionEn || "Select all squares that match the description",
 5114 |  502 |         rows: gridSize === "4x4" ? 4 : 3,
 5115 |  503 |         columns: gridSize === "4x4" ? 4 : 3,
 5116 |  504 |       },
 5117 |  505 |     };
 5118 |  506 | 
 5119 |  507 |     const createRes = await fetch("https://api.2captcha.com/createTask", {
 5120 |  508 |       method: "POST",
 5121 |  509 |       headers: { "Content-Type": "application/json" },
 5122 |  510 |       body: JSON.stringify(createTaskPayload),
 5123 |  511 |     });
 5124 |  512 |     const createData = await createRes.json();
 5125 |  513 | 
 5126 |  514 |     if (createData.errorId !== 0) {
 5127 |  515 |       log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${createData.errorCode} - ${createData.errorDescription}`);
 5128 |  516 |       return { ok: false, error: createData.errorCode || createData.errorDescription };
 5129 |  517 |     }
 5130 |  518 | 
 5131 |  519 |     const taskId = createData.taskId;
 5132 |  520 |     log.dev("CAPTCHA", `GridTask ID: ${taskId} - czekam na rozwiƒÖzanie...`);
 5133 |  521 | 
 5134 |  522 |     // 7. Polling - czekaj na rozwiƒÖzanie (max 120 sekund)
 5135 |  523 |     const maxAttempts = 24; // 24 * 5s = 120s
 5136 |  524 |     let clickIndices = [];
 5137 |  525 | 
 5138 |  526 |     for (let i = 0; i < maxAttempts; i++) {
 5139 |  527 |       await new Promise(r => setTimeout(r, 5000));
 5140 |  528 | 
 5141 |  529 |       const resultRes = await fetch("https://api.2captcha.com/getTaskResult", {
 5142 |  530 |         method: "POST",
 5143 |  531 |         headers: { "Content-Type": "application/json" },
 5144 |  532 |         body: JSON.stringify({
 5145 |  533 |           clientKey: CAPTCHA_API_KEY,
 5146 |  534 |           taskId: taskId,
 5147 |  535 |         }),
 5148 |  536 |       });
 5149 |  537 |       const resultData = await resultRes.json();
 5150 |  538 | 
 5151 |  539 |       if (resultData.errorId !== 0) {
 5152 |  540 |         log.error("CAPTCHA", `B≈ÇƒÖd getTaskResult: ${resultData.errorCode}`);
 5153 |  541 |         return { ok: false, error: resultData.errorCode };
 5154 |  542 |       }
 5155 |  543 | 
 5156 |  544 |       if (resultData.status === "ready") {
 5157 |  545 |         clickIndices = resultData.solution?.click || [];
 5158 |  546 |         log.success("CAPTCHA", `GridTask rozwiƒÖzany! Kwadraty: [${clickIndices.join(', ')}]`);
 5159 |  547 |         break;
 5160 |  548 |       }
 5161 |  549 | 
 5162 |  550 |       log.debug("CAPTCHA", `Czekam na GridTask... (${i + 1}/${maxAttempts})`);
 5163 |  551 |     }
 5164 |  552 | 
 5165 |  553 |     if (!clickIndices.length) {
 5166 |  554 |       log.warn("CAPTCHA", "Brak kwadrat√≥w do klikniƒôcia (mo≈ºe 'Pomi≈Ñ'?)");
 5167 |  555 |       // Mo≈ºe trzeba kliknƒÖƒá "Pomi≈Ñ" je≈õli nie ma pasujƒÖcych obrazk√≥w
 5168 |  556 |       try {
 5169 |  557 |         const skipBtn = await gridFrame.$('.rc-imageselect-incorrect-response, button:has-text("Pomi≈Ñ"), button:has-text("Skip")');
 5170 |  558 |         if (skipBtn) {
 5171 |  559 |           await skipBtn.click();
 5172 |  560 |           await sleepRandom(1000, 2000);
 5173 |  561 |           return { ok: true, clicked: [], skipped: true };
 5174 |  562 |         }
 5175 |  563 |       } catch {}
 5176 |  564 |       return { ok: false, error: "no_tiles_to_click" };
 5177 |  565 |     }
 5178 |  566 | 
 5179 |  567 |     // 8. Kliknij wskazane kwadraty
 5180 |  568 |     log.prod("CAPTCHA", `Klikam ${clickIndices.length} kwadrat√≥w...`);
 5181 |  569 | 
 5182 |  570 |     for (const index of clickIndices) {
 5183 |  571 |       try {
 5184 |  572 |         // Indeksy z 2Captcha sƒÖ 1-based (1 = g√≥rny lewy)
 5185 |  573 |         const tileIndex = index - 1; // konwertuj na 0-based
 5186 |  574 | 
 5187 |  575 |         const clicked = await gridFrame.evaluate((idx) => {
 5188 |  576 |           const tiles = document.querySelectorAll('.rc-imageselect-tile');
 5189 |  577 |           if (tiles[idx]) {
 5190 |  578 |             tiles[idx].click();
 5191 |  579 |             return true;
 5192 |  580 |           }
 5193 |  581 |           // Alternatywny selektor
 5194 |  582 |           const cells = document.querySelectorAll('td.rc-imageselect-tile');
 5195 |  583 |           if (cells[idx]) {
 5196 |  584 |             cells[idx].click();
 5197 |  585 |             return true;
 5198 |  586 |           }
 5199 |  587 |           return false;
 5200 |  588 |         }, tileIndex);
 5201 |  589 | 
 5202 |  590 |         if (clicked) {
 5203 |  591 |           log.dev("CAPTCHA", `Klikniƒôto kwadrat ${index}`);
 5204 |  592 |         } else {
 5205 |  593 |           log.warn("CAPTCHA", `Nie znaleziono kwadratu ${index}`);
 5206 |  594 |         }
 5207 |  595 | 
 5208 |  596 |         // Kr√≥tka pauza miƒôdzy klikniƒôciami (human-like)
 5209 |  597 |         await sleepRandom(200, 500);
 5210 |  598 |       } catch (err) {
 5211 |  599 |         log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia kwadratu ${index}: ${err?.message}`);
 5212 |  600 |       }
 5213 |  601 |     }
 5214 |  602 | 
 5215 |  603 |     // 9. Kliknij przycisk "Sprawd≈∫" / "Verify"
 5216 |  604 |     await sleepRandom(500, 1000);
 5217 |  605 | 
 5218 |  606 |     try {
 5219 |  607 |       const verifyBtn = await gridFrame.$('#recaptcha-verify-button, .rc-button-default, button[id*="verify"]');
 5220 |  608 |       if (verifyBtn) {
 5221 |  609 |         log.prod("CAPTCHA", "Klikam 'Sprawd≈∫'...");
 5222 |  610 |         await verifyBtn.click();
 5223 |  611 |         await sleepRandom(2000, 3000);
 5224 |  612 |       }
 5225 |  613 |     } catch (err) {
 5226 |  614 |       log.warn("CAPTCHA", `B≈ÇƒÖd klikniƒôcia Verify: ${err?.message}`);
 5227 |  615 |     }
 5228 |  616 | 
 5229 |  617 |     return { ok: true, clicked: clickIndices };
 5230 |  618 | 
 5231 |  619 |   } catch (err) {
 5232 |  620 |     log.error("CAPTCHA", `B≈ÇƒÖd GridTask: ${err?.message}`);
 5233 |  621 |     return { ok: false, error: err?.message };
 5234 |  622 |   }
 5235 |  623 | }
 5236 |  624 | 
 5237 |  625 | /**
 5238 |  626 |  * T≈Çumaczy polskƒÖ instrukcjƒô reCAPTCHA na angielski
 5239 |  627 |  */
 5240 |  628 | function translateInstruction(pl) {
 5241 |  629 |   const translations = {
 5242 |  630 |     "przej≈õciami dla pieszych": "crosswalks",
 5243 |  631 |     "przej≈õcia dla pieszych": "crosswalks",
 5244 |  632 |     "sygnalizatorami ≈õwietlnymi": "traffic lights",
 5245 |  633 |     "sygnalizatory ≈õwietlne": "traffic lights",
 5246 |  634 |     "≈õwiat≈Çami": "traffic lights",
 5247 |  635 |     "samochodami": "cars",
 5248 |  636 |     "samochody": "cars",
 5249 |  637 |     "autobusami": "buses",
 5250 |  638 |     "autobusy": "buses",
 5251 |  639 |     "motocyklami": "motorcycles",
 5252 |  640 |     "motocykle": "motorcycles",
 5253 |  641 |     "rowerami": "bicycles",
 5254 |  642 |     "rowery": "bicycles",
 5255 |  643 |     "hydrantami": "fire hydrants",
 5256 |  644 |     "hydranty": "fire hydrants",
 5257 |  645 |     "mostami": "bridges",
 5258 |  646 |     "mosty": "bridges",
 5259 |  647 |     "schodami": "stairs",
 5260 |  648 |     "schody": "stairs",
 5261 |  649 |     "g√≥rami": "mountains",
 5262 |  650 |     "g√≥ry": "mountains",
 5263 |  651 |     "palmami": "palm trees",
 5264 |  652 |     "palmy": "palm trees",
 5265 |  653 |     "≈Çodziami": "boats",
 5266 |  654 |     "≈Çodzie": "boats",
 5267 |  655 |     "taks√≥wkami": "taxis",
 5268 |  656 |     "taks√≥wki": "taxis",
 5269 |  657 |     "chimneys": "chimneys",
 5270 |  658 |     "kominami": "chimneys",
 5271 |  659 |     "kominy": "chimneys",
 5272 |  660 |     "parking meters": "parking meters",
 5273 |  661 |     "parkomatami": "parking meters",
 5274 |  662 |     "parkomaty": "parking meters",
 5275 |  663 |   };
 5276 |  664 | 
 5277 |  665 |   let en = pl.toLowerCase();
 5278 |  666 | 
 5279 |  667 |   // Zamie≈Ñ polskie frazy na angielskie
 5280 |  668 |   for (const [plPhrase, enPhrase] of Object.entries(translations)) {
 5281 |  669 |     if (en.includes(plPhrase.toLowerCase())) {
 5282 |  670 |       return `Select all squares with ${enPhrase}`;
 5283 |  671 |     }
 5284 |  672 |   }
 5285 |  673 | 
 5286 |  674 |   // Je≈õli nie znaleziono t≈Çumaczenia, zwr√≥ƒá oryginalnƒÖ instrukcjƒô
 5287 |  675 |   return pl || "Select all matching images";
 5288 |  676 | }
 5289 |  677 | 
 5290 |  678 | /**
 5291 |  679 |  * Sprawdza czy pojawi≈Ça siƒô siatka obrazk√≥w (po klikniƒôciu checkboxa)
 5292 |  680 |  */
 5293 |  681 | async function hasImageGrid(page) {
 5294 |  682 |   try {
 5295 |  683 |     const frames = page.frames();
 5296 |  684 |     for (const frame of frames) {
 5297 |  685 |       if (frame.url().includes('recaptcha') && frame.url().includes('bframe')) {
 5298 |  686 |         // Sprawd≈∫ czy siatka jest widoczna
 5299 |  687 |         const hasGrid = await frame.evaluate(() => {
 5300 |  688 |           const grid = document.querySelector('.rc-imageselect-challenge, .rc-imageselect-table-33, .rc-imageselect-table-44');
 5301 |  689 |           return grid && grid.offsetHeight > 0;
 5302 |  690 |         }).catch(() => false);
 5303 |  691 | 
 5304 |  692 |         if (hasGrid) {
 5305 |  693 |           return true;
 5306 |  694 |         }
 5307 |  695 |       }
 5308 |  696 |     }
 5309 |  697 |     return false;
 5310 |  698 |   } catch {
 5311 |  699 |     return false;
 5312 |  700 |   }
 5313 |  701 | }
 5314 |  702 | 
 5315 |  703 | /**
 5316 |  704 |  * FB login helpers ‚Äì PRO (NO COOLDOWN)
 5317 |  705 |  *
 5318 |  706 |  * Najwa≈ºniejsze:
 5319 |  707 |  * - G≈Ç√≥wne logowanie: https://www.facebook.com/login.php?next=<postUrl>
 5320 |  708 |  * - Best-effort (zero throw, zero crashy)
 5321 |  709 |  * - Dwa tryby:
 5322 |  710 |  *    1) login.php?next (najstabilniejsze)
 5323 |  711 |  *    2) fallback: loginViaVisibleForm (overlay / r√≥≈ºne layouty)
 5324 |  712 |  *
 5325 |  713 |  * Kompatybilno≈õƒá:
 5326 |  714 |  * - eksportujemy te≈º clickByText, acceptLoginCookies, loginViaVisibleForm (jak w wersji lokalnej)
 5327 |  715 |  */
 5328 |  716 | 
 5329 |  717 | function norm(s) {
 5330 |  718 |   return String(s || "")
 5331 |  719 |     .replace(/\u00a0/g, " ")
 5332 |  720 |     .replace(/\s+/g, " ")
 5333 |  721 |     .trim();
 5334 |  722 | }
 5335 |  723 | 
 5336 |  724 | /**
 5337 |  725 |  * Cookies popup ‚Äì wersja "mark + click" (jak lokalnie), ale best-effort.
 5338 |  726 |  */
 5339 |  727 | async function acceptLoginCookies(page) {
 5340 |  728 |   try {
 5341 |  729 |     log.debug("LOGIN", "Szukam popupu cookies...");
 5342 |  730 | 
 5343 |  731 |     await sleepRandom(300, 900);
 5344 |  732 | 
 5345 |  733 |     const found = await page.evaluate(() => {
 5346 |  734 |       const wanted = [
 5347 |  735 |         "Zezw√≥l na wszystkie pliki cookie",
 5348 |  736 |         "Zezw√≥l na wszystkie pliki",
 5349 |  737 |         "Allow all cookies",
 5350 |  738 |         "Accept all cookies",
 5351 |  739 |         "Akceptuj wszystkie",
 5352 |  740 |         "Odrzuƒá opcjonalne pliki cookie",
 5353 |  741 |         "Odrzuc opcjonalne pliki cookie",
 5354 |  742 |       ].map((t) => t.toLowerCase());
 5355 |  743 | 
 5356 |  744 |       const buttons = Array.from(
 5357 |  745 |         document.querySelectorAll("button, [role='button']")
 5358 |  746 |       );
 5359 |  747 | 
 5360 |  748 |       for (const btn of buttons) {
 5361 |  749 |         const txt = (btn.innerText || btn.textContent || "").trim();
 5362 |  750 |         if (!txt) continue;
 5363 |  751 |         const low = txt.toLowerCase();
 5364 |  752 | 
 5365 |  753 |         if (wanted.some((w) => low.includes(w))) {
 5366 |  754 |           btn.setAttribute("data-fb-cookie-btn", "1");
 5367 |  755 |           return true;
 5368 |  756 |         }
 5369 |  757 |       }
 5370 |  758 | 
 5371 |  759 |       return false;
 5372 |  760 |     });
 5373 |  761 | 
 5374 |  762 |     if (!found) {
 5375 |  763 |       return false;
 5376 |  764 |     }
 5377 |  765 | 
 5378 |  766 |     await page
 5379 |  767 |       .click('[data-fb-cookie-btn="1"]')
 5380 |  768 |       .catch(() => {});
 5381 |  769 | 
 5382 |  770 |     log.debug("LOGIN", "Klikniƒôto cookies popup");
 5383 |  771 | 
 5384 |  772 |     await sleepRandom(600, 1200);
 5385 |  773 |     return true;
 5386 |  774 |   } catch (err) {
 5387 |  775 |     log.debug("LOGIN", `B≈ÇƒÖd cookies popup: ${err?.message || err}`);
 5388 |  776 |     return false;
 5389 |  777 |   }
 5390 |  778 | }
 5391 |  779 | 
 5392 |  780 | /**
 5393 |  781 |  * Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).
 5394 |  782 |  */
 5395 |  783 | async function acceptCookiesIfPresent(page) {
 5396 |  784 |   try {
 5397 |  785 |     await sleepRandom(250, 650);
 5398 |  786 | 
 5399 |  787 |     const clicked = await page.evaluate(() => {
 5400 |  788 |       const wanted = [
 5401 |  789 |         "Zezw√≤l na wszystkie pliki cookie",
 5402 |  790 |         "Zezw√≥l na wszystkie pliki cookie",
 5403 |  791 |         "Zezw√≤l na wszystkie pliki",
 5404 |  792 |         "Zezw√≥l na wszystkie pliki",
 5405 |  793 |         "Allow all cookies",
 5406 |  794 |         "Accept all cookies",
 5407 |  795 |         "Akceptuj wszystkie",
 5408 |  796 |       ].map((x) => x.toLowerCase());
 5409 |  797 | 
 5410 |  798 |       const btns = Array.from(
 5411 |  799 |         document.querySelectorAll("button, [role='button']")
 5412 |  800 |       );
 5413 |  801 | 
 5414 |  802 |       for (const b of btns) {
 5415 |  803 |         const t = (b.innerText || b.textContent || "").trim();
 5416 |  804 |         if (!t) continue;
 5417 |  805 |         const low = t.toLowerCase();
 5418 |  806 |         if (wanted.some((w) => low.includes(w))) {
 5419 |  807 |           b.click();
 5420 |  808 |           return true;
 5421 |  809 |         }
 5422 |  810 |       }
 5423 |  811 |       return false;
 5424 |  812 |     });
 5425 |  813 | 
 5426 |  814 |     if (clicked) {
 5427 |  815 |       log.debug("LOGIN", "Klikniƒôto accept cookies (fallback)");
 5428 |  816 |       await sleepRandom(500, 1100);
 5429 |  817 |     }
 5430 |  818 |     return !!clicked;
 5431 |  819 |   } catch {
 5432 |  820 |     return false;
 5433 |  821 |   }
 5434 |  822 | }
 5435 |  823 | 
 5436 |  824 | /**
 5437 |  825 |  * Helper: kliknij przycisk submit po rozwiƒÖzaniu captcha
 5438 |  826 |  */
 5439 |  827 | async function clickSubmitButton(page) {
 5440 |  828 |   // Rozszerzone selektory dla FB two_step_verification
 5441 |  829 |   const submitSelectors = [
 5442 |  830 |     // FB specyficzne
 5443 |  831 |     'div[aria-label="Kontynuuj"]',
 5444 |  832 |     'div[aria-label="Continue"]',
 5445 |  833 |     'span[dir="auto"]:has-text("Kontynuuj")',
 5446 |  834 |     // Standardowe
 5447 |  835 |     'button[type="submit"]',
 5448 |  836 |     'input[type="submit"]',
 5449 |  837 |     'button[name="submit"]',
 5450 |  838 |     'div[role="button"][tabindex="0"]',
 5451 |  839 |     'button:not([type])',
 5452 |  840 |     '[data-testid="royal_login_button"]',
 5453 |  841 |   ];
 5454 |  842 | 
 5455 |  843 |   let submitBtn = null;
 5456 |  844 |   for (const sel of submitSelectors) {
 5457 |  845 |     try {
 5458 |  846 |       submitBtn = await page.$(sel);
 5459 |  847 |       if (submitBtn) {
 5460 |  848 |         log.debug("CAPTCHA", `Znaleziono przycisk: ${sel}`);
 5461 |  849 |         break;
 5462 |  850 |       }
 5463 |  851 |     } catch {}
 5464 |  852 |   }
 5465 |  853 | 
 5466 |  854 |   // Fallback - szukaj przycisku po tek≈õcie (rozszerzone dla FB)
 5467 |  855 |   if (!submitBtn) {
 5468 |  856 |     log.debug("CAPTCHA", "Szukam przycisku po tek≈õcie...");
 5469 |  857 | 
 5470 |  858 |     // Diagnostyka - poka≈º wszystkie klikalne elementy
 5471 |  859 |     const buttons = await page.evaluate(() => {
 5472 |  860 |       const els = Array.from(document.querySelectorAll(
 5473 |  861 |         'button, div[role="button"], a[role="button"], span[role="button"], div[tabindex="0"]'
 5474 |  862 |       ));
 5475 |  863 |       return els.slice(0, 15).map(el => ({
 5476 |  864 |         tag: el.tagName,
 5477 |  865 |         text: (el.innerText || '').substring(0, 50).trim(),
 5478 |  866 |         role: el.getAttribute('role'),
 5479 |  867 |         ariaLabel: el.getAttribute('aria-label'),
 5480 |  868 |       })).filter(x => x.text || x.ariaLabel);
 5481 |  869 |     });
 5482 |  870 |     log.debug("CAPTCHA", `Dostƒôpne przyciski: ${JSON.stringify(buttons, null, 2)}`);
 5483 |  871 | 
 5484 |  872 |     submitBtn = await page.evaluateHandle(() => {
 5485 |  873 |       // Szukaj we wszystkich mo≈ºliwych elementach
 5486 |  874 |       const allElements = Array.from(document.querySelectorAll(
 5487 |  875 |         'button, div[role="button"], a[role="button"], span[role="button"], ' +
 5488 |  876 |         'div[tabindex="0"], span[tabindex="0"], a[tabindex="0"]'
 5489 |  877 |       ));
 5490 |  878 | 
 5491 |  879 |       const texts = [
 5492 |  880 |         'kontynuuj', 'continue', 'submit', 'dalej', 'wy≈õlij', 'potwierd≈∫',
 5493 |  881 |         'prze≈õlij', 'zatwierd≈∫', 'weryfikuj', 'verify', 'next', 'ok'
 5494 |  882 |       ];
 5495 |  883 | 
 5496 |  884 |       for (const el of allElements) {
 5497 |  885 |         const t = (el.innerText || el.textContent || '').toLowerCase().trim();
 5498 |  886 |         if (!t) continue;
 5499 |  887 | 
 5500 |  888 |         // Szukaj dok≈Çadnego dopasowania lub zawierania
 5501 |  889 |         if (texts.some(x => t === x || t.includes(x))) {
 5502 |  890 |           console.log('[Submit] Znaleziono:', t, el.tagName);
 5503 |  891 |           return el;
 5504 |  892 |         }
 5505 |  893 |       }
 5506 |  894 | 
 5507 |  895 |       // Ostatnia szansa - szukaj niebieskiego przycisku FB (primary button)
 5508 |  896 |       const primaryBtn = document.querySelector(
 5509 |  897 |         'div[style*="background-color: rgb(24, 119, 242)"], ' +
 5510 |  898 |         'div[class*="primary"], ' +
 5511 |  899 |         'div[class*="layerConfirm"]'
 5512 |  900 |       );
 5513 |  901 |       if (primaryBtn) {
 5514 |  902 |         console.log('[Submit] Znaleziono primary button');
 5515 |  903 |         return primaryBtn;
 5516 |  904 |       }
 5517 |  905 | 
 5518 |  906 |       return null;
 5519 |  907 |     });
 5520 |  908 | 
 5521 |  909 |     if (submitBtn?.asElement()) {
 5522 |  910 |       submitBtn = submitBtn.asElement();
 5523 |  911 |     } else {
 5524 |  912 |       submitBtn = null;
 5525 |  913 |     }
 5526 |  914 |   }
 5527 |  915 | 
 5528 |  916 |   if (submitBtn) {
 5529 |  917 |     log.prod("CAPTCHA", "Klikam przycisk submit...");
 5530 |  918 |     await submitBtn.click();
 5531 |  919 |     await sleepRandom(1000, 2000);
 5532 |  920 |     await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
 5533 |  921 |     await sleepRandom(2000, 3000);
 5534 |  922 |   } else {
 5535 |  923 |     // Spr√≥buj kliknƒÖƒá w ≈õrodek ekranu gdzie zwykle jest przycisk
 5536 |  924 |     log.warn("CAPTCHA", "Nie znaleziono przycisku - pr√≥bujƒô Tab + Enter");
 5537 |  925 |     await page.keyboard.press('Tab');
 5538 |  926 |     await sleepRandom(300, 500);
 5539 |  927 |     await page.keyboard.press('Tab');
 5540 |  928 |     await sleepRandom(300, 500);
 5541 |  929 |     await page.keyboard.press('Enter');
 5542 |  930 |     await sleepRandom(3000, 4000);
 5543 |  931 |   }
 5544 |  932 | }
 5545 |  933 | 
 5546 |  934 | /**
 5547 |  935 |  * Pomocnik: wpisz login/has≈Ço + kliknij login. Best-effort.
 5548 |  936 |  */
 5549 |  937 | async function fillLoginFormBestEffort(page) {
 5550 |  938 |   const email = process.env.FB_EMAIL || "";
 5551 |  939 |   const password = process.env.FB_PASSWORD || "";
 5552 |  940 | 
 5553 |  941 |   if (!email || !password) {
 5554 |  942 |     log.dev("LOGIN", "Brak FB_EMAIL / FB_PASSWORD ‚Äì pomijam");
 5555 |  943 |     return false;
 5556 |  944 |   }
 5557 |  945 | 
 5558 |  946 |   const emailSel = [
 5559 |  947 |     "input#email",
 5560 |  948 |     "input[name='email']",
 5561 |  949 |     "input[name='email_or_phone']",
 5562 |  950 |     "input[type='text']",
 5563 |  951 |   ].join(",");
 5564 |  952 | 
 5565 |  953 |   const passSel = [
 5566 |  954 |     "input#pass",
 5567 |  955 |     "input[name='pass']",
 5568 |  956 |     "input[type='password']",
 5569 |  957 |   ].join(",");
 5570 |  958 | 
 5571 |  959 |   const emailInput = await page.$(emailSel).catch(() => null);
 5572 |  960 |   const passInput = await page.$(passSel).catch(() => null);
 5573 |  961 | 
 5574 |  962 |   if (!emailInput || !passInput) {
 5575 |  963 |     log.debug("LOGIN", "Brak p√≥l email/has≈Ço na stronie");
 5576 |  964 |     return false;
 5577 |  965 |   }
 5578 |  966 | 
 5579 |  967 |   log.dev("LOGIN", "Wpisujƒô email i has≈Ço (human-like typing)...");
 5580 |  968 | 
 5581 |  969 |   await emailInput.click({ clickCount: 3 }).catch(() => {});
 5582 |  970 |   await page.keyboard.press("Backspace").catch(() => {});
 5583 |  971 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 5584 |  972 |   await humanType(emailInput, email, page).catch(() => {});
 5585 |  973 | 
 5586 |  974 |   await passInput.click({ clickCount: 3 }).catch(() => {});
 5587 |  975 |   await page.keyboard.press("Backspace").catch(() => {});
 5588 |  976 |   // Human-like typing: ~120ms/znak z mikro-pauzami
 5589 |  977 |   await humanType(passInput, password, page).catch(() => {});
 5590 |  978 | 
 5591 |  979 |   const loginButton =
 5592 |  980 |     (await page.$('button[name="login"]')) ||
 5593 |  981 |     (await page.$('button[type="submit"]')) ||
 5594 |  982 |     (await page.$('div[role="button"][tabindex="0"]')) ||
 5595 |  983 |     (await page.$("button")) ||
 5596 |  984 |     null;
 5597 |  985 | 
 5598 |  986 |   if (!loginButton) {
 5599 |  987 |     log.debug("LOGIN", "Brak przycisku logowania");
 5600 |  988 |     return false;
 5601 |  989 |   }
 5602 |  990 | 
 5603 |  991 |   log.dev("LOGIN", "Klikam logowanie...");
 5604 |  992 | 
 5605 |  993 |   await Promise.all([
 5606 |  994 |     loginButton.click().catch(() => {}),
 5607 |  995 |     page
 5608 |  996 |       .waitForNavigation({ waitUntil: "networkidle2", timeout: 60000 })
 5609 |  997 |       .catch(() => {}),
 5610 |  998 |   ]);
 5611 |  999 | 
 5612 | 1000 |   await sleepRandom(1400, 2400);
 5613 | 1001 | 
 5614 | 1002 |   // Sprawd≈∫ URL - czy jeste≈õmy na stronie 2FA/weryfikacji
 5615 | 1003 |   const currentUrl = page.url();
 5616 | 1004 |   log.dev("LOGIN", `URL po logowaniu: ${currentUrl.substring(0, 80)}...`);
 5617 | 1005 | 
 5618 | 1006 |   // Je≈õli jeste≈õmy na stronie weryfikacji, spr√≥buj rozwiƒÖzaƒá captcha
 5619 | 1007 |   if (currentUrl.includes('two_step_verification') ||
 5620 | 1008 |       currentUrl.includes('checkpoint') ||
 5621 | 1009 |       currentUrl.includes('authentication')) {
 5622 | 1010 |     log.prod("LOGIN", "Wykryto stronƒô weryfikacji - pr√≥bujƒô rozwiƒÖzaƒá captcha...");
 5623 | 1011 | 
 5624 | 1012 |     // Poczekaj na za≈Çadowanie element√≥w
 5625 | 1013 |     await sleepRandom(4000, 6000);
 5626 | 1014 | 
 5627 | 1015 |     // NOWA DIAGNOSTYKA - wykryj typ captcha
 5628 | 1016 |     const diagnosis = await diagnoseCaptchaType(page);
 5629 | 1017 | 
 5630 | 1018 |     if (!CAPTCHA_ENABLED) {
 5631 | 1019 |       log.warn("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
 5632 | 1020 |       await sleepRandom(1000, 2000);
 5633 | 1021 |       return true;
 5634 | 1022 |     }
 5635 | 1023 | 
 5636 | 1024 |     let apiResult = { ok: false };
 5637 | 1025 | 
 5638 | 1026 |     // === FUNCAPTCHA / ARKOSE LABS ===
 5639 | 1027 |     if (diagnosis.type === "funcaptcha" && diagnosis.details.publicKey) {
 5640 | 1028 |       log.prod("CAPTCHA", "U≈ºywam solvera FunCaptcha...");
 5641 | 1029 | 
 5642 | 1030 |       const maxRetries = 2;
 5643 | 1031 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
 5644 | 1032 |         log.prod("CAPTCHA", `FunCaptcha pr√≥ba ${attempt}/${maxRetries}...`);
 5645 | 1033 | 
 5646 | 1034 |         apiResult = await solveFunCaptchaViaApi(
 5647 | 1035 |           diagnosis.details.publicKey,
 5648 | 1036 |           currentUrl
 5649 | 1037 |         );
 5650 | 1038 | 
 5651 | 1039 |         if (apiResult.ok) break;
 5652 | 1040 | 
 5653 | 1041 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
 5654 | 1042 |           log.warn("CAPTCHA", "FunCaptcha nierozwiƒÖzywalna - od≈õwie≈ºam...");
 5655 | 1043 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
 5656 | 1044 |           await sleepRandom(3000, 5000);
 5657 | 1045 |           // Po reload ponownie zdiagnozuj
 5658 | 1046 |           const newDiag = await diagnoseCaptchaType(page);
 5659 | 1047 |           if (newDiag.details.publicKey) {
 5660 | 1048 |             diagnosis.details.publicKey = newDiag.details.publicKey;
 5661 | 1049 |           }
 5662 | 1050 |         } else if (apiResult.error) {
 5663 | 1051 |           break;
 5664 | 1052 |         }
 5665 | 1053 |       }
 5666 | 1054 | 
 5667 | 1055 |       if (apiResult.ok && apiResult.token) {
 5668 | 1056 |         log.success("CAPTCHA", "Otrzymano token FunCaptcha!");
 5669 | 1057 | 
 5670 | 1058 |         // Wstrzyknij token FunCaptcha
 5671 | 1059 |         try {
 5672 | 1060 |           const injected = await page.evaluate((token) => {
 5673 | 1061 |             let success = false;
 5674 | 1062 | 
 5675 | 1063 |             // FunCaptcha callback - r√≥≈ºne warianty
 5676 | 1064 |             const callbacks = [
 5677 | 1065 |               () => window.ArkoseEnforcement?.setSessionToken?.(token),
 5678 | 1066 |               () => window.fc_callback?.(token),
 5679 | 1067 |               () => window.funcaptchaCallback?.(token),
 5680 | 1068 |               () => window.onFunCaptchaSuccess?.(token),
 5681 | 1069 |               // Szukaj ukrytego inputa
 5682 | 1070 |               () => {
 5683 | 1071 |                 const input = document.querySelector('input[name="fc-token"], input[name="verification_token"]');
 5684 | 1072 |                 if (input) {
 5685 | 1073 |                   input.value = token;
 5686 | 1074 |                   success = true;
 5687 | 1075 |                 }
 5688 | 1076 |               },
 5689 | 1077 |               // Wywo≈Çaj event submit
 5690 | 1078 |               () => {
 5691 | 1079 |                 const form = document.querySelector('form');
 5692 | 1080 |                 if (form) {
 5693 | 1081 |                   const hiddenInput = document.createElement('input');
 5694 | 1082 |                   hiddenInput.type = 'hidden';
 5695 | 1083 |                   hiddenInput.name = 'fc-token';
 5696 | 1084 |                   hiddenInput.value = token;
 5697 | 1085 |                   form.appendChild(hiddenInput);
 5698 | 1086 |                   success = true;
 5699 | 1087 |                 }
 5700 | 1088 |               },
 5701 | 1089 |             ];
 5702 | 1090 | 
 5703 | 1091 |             for (const tryCallback of callbacks) {
 5704 | 1092 |               try {
 5705 | 1093 |                 tryCallback();
 5706 | 1094 |               } catch {}
 5707 | 1095 |             }
 5708 | 1096 | 
 5709 | 1097 |             return success;
 5710 | 1098 |           }, apiResult.token);
 5711 | 1099 | 
 5712 | 1100 |           log.dev("CAPTCHA", `Token FunCaptcha wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
 5713 | 1101 |           await sleepRandom(1500, 2500);
 5714 | 1102 | 
 5715 | 1103 |           // Kliknij przycisk submit
 5716 | 1104 |           await clickSubmitButton(page);
 5717 | 1105 |           return true;
 5718 | 1106 |         } catch (err) {
 5719 | 1107 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu FunCaptcha: ${err?.message}`);
 5720 | 1108 |         }
 5721 | 1109 |       }
 5722 | 1110 |     }
 5723 | 1111 |     // === RECAPTCHA ===
 5724 | 1112 |     else if (diagnosis.type === "recaptcha" && diagnosis.details.sitekey) {
 5725 | 1113 |       log.prod("CAPTCHA", "U≈ºywam solvera reCAPTCHA...");
 5726 | 1114 | 
 5727 | 1115 |       // Sprawd≈∫ czy Enterprise
 5728 | 1116 |       const isEnterprise = diagnosis.details.frames.some(f => f.enterprise);
 5729 | 1117 | 
 5730 | 1118 |       // KROK 1: Kliknij checkbox "Nie jestem robotem" je≈õli istnieje
 5731 | 1119 |       try {
 5732 | 1120 |         const frames = page.frames();
 5733 | 1121 |         for (const frame of frames) {
 5734 | 1122 |           if (frame.url().includes('recaptcha') && frame.url().includes('anchor')) {
 5735 | 1123 |             log.prod("CAPTCHA", "Szukam checkboxa reCAPTCHA...");
 5736 | 1124 |             const checkbox = await frame.$('.recaptcha-checkbox-border, .recaptcha-checkbox, #recaptcha-anchor');
 5737 | 1125 |             if (checkbox) {
 5738 | 1126 |               log.prod("CAPTCHA", "Klikam checkbox 'Nie jestem robotem'...");
 5739 | 1127 |               await checkbox.click();
 5740 | 1128 |               await sleepRandom(2000, 3000);
 5741 | 1129 |               break;
 5742 | 1130 |             }
 5743 | 1131 |           }
 5744 | 1132 |         }
 5745 | 1133 |       } catch (err) {
 5746 | 1134 |         log.debug("CAPTCHA", `B≈ÇƒÖd klikniƒôcia checkboxa: ${err?.message}`);
 5747 | 1135 |       }
 5748 | 1136 | 
 5749 | 1137 |       // KROK 2: Sprawd≈∫ czy pojawi≈Ça siƒô siatka obrazk√≥w
 5750 | 1138 |       await sleepRandom(1000, 2000);
 5751 | 1139 |       const gridDetected = await hasImageGrid(page);
 5752 | 1140 | 
 5753 | 1141 |       if (gridDetected) {
 5754 | 1142 |         log.prod("CAPTCHA", "Wykryto siatkƒô obrazk√≥w - u≈ºywam GridTask...");
 5755 | 1143 | 
 5756 | 1144 |         // Pr√≥by rozwiƒÖzania przez GridTask (FB czƒôsto wymaga 4-6 rund)
 5757 | 1145 |         const maxGridRetries = 6;
 5758 | 1146 |         for (let gridAttempt = 1; gridAttempt <= maxGridRetries; gridAttempt++) {
 5759 | 1147 |           log.prod("CAPTCHA", `GridTask pr√≥ba ${gridAttempt}/${maxGridRetries}...`);
 5760 | 1148 | 
 5761 | 1149 |           const gridResult = await solveGridCaptcha(page);
 5762 | 1150 | 
 5763 | 1151 |           if (gridResult.ok) {
 5764 | 1152 |             log.success("CAPTCHA", `GridTask sukces! Klikniƒôto: [${gridResult.clicked?.join(', ') || 'pominiƒôto'}]`);
 5765 | 1153 | 
 5766 | 1154 |             // Sprawd≈∫ czy captcha zniknƒô≈Ça (sukces)
 5767 | 1155 |             await sleepRandom(2000, 3000);
 5768 | 1156 |             const stillHasGrid = await hasImageGrid(page);
 5769 | 1157 | 
 5770 | 1158 |             if (!stillHasGrid) {
 5771 | 1159 |               log.success("CAPTCHA", "Siatka zniknƒô≈Ça - captcha rozwiƒÖzana!");
 5772 | 1160 |               // Kliknij submit je≈õli trzeba
 5773 | 1161 |               await clickSubmitButton(page);
 5774 | 1162 |               return true;
 5775 | 1163 |             } else {
 5776 | 1164 |               log.warn("CAPTCHA", "Siatka nadal widoczna - pr√≥bujƒô ponownie...");
 5777 | 1165 |               // Mo≈ºe pojawi≈Ça siƒô nowa siatka - kontynuuj
 5778 | 1166 |             }
 5779 | 1167 |           } else {
 5780 | 1168 |             log.warn("CAPTCHA", `GridTask b≈ÇƒÖd: ${gridResult.error}`);
 5781 | 1169 | 
 5782 | 1170 |             if (gridResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && gridAttempt < maxGridRetries) {
 5783 | 1171 |               // Kliknij "Nowy obrazek" je≈õli dostƒôpny
 5784 | 1172 |               try {
 5785 | 1173 |                 const frames = page.frames();
 5786 | 1174 |                 for (const frame of frames) {
 5787 | 1175 |                   if (frame.url().includes('bframe')) {
 5788 | 1176 |                     const newImageBtn = await frame.$('#recaptcha-reload-button, .rc-button-reload');
 5789 | 1177 |                     if (newImageBtn) {
 5790 | 1178 |                       log.prod("CAPTCHA", "Klikam 'Nowy obrazek'...");
 5791 | 1179 |                       await newImageBtn.click();
 5792 | 1180 |                       await sleepRandom(2000, 3000);
 5793 | 1181 |                     }
 5794 | 1182 |                     break;
 5795 | 1183 |                   }
 5796 | 1184 |                 }
 5797 | 1185 |               } catch {}
 5798 | 1186 |             }
 5799 | 1187 |           }
 5800 | 1188 |         }
 5801 | 1189 | 
 5802 | 1190 |         // GridTask nie zadzia≈Ça≈Ç - fallback do token method
 5803 | 1191 |         log.warn("CAPTCHA", "GridTask wyczerpany - pr√≥bujƒô metodƒô tokenowƒÖ...");
 5804 | 1192 |       }
 5805 | 1193 | 
 5806 | 1194 |       // KROK 3 (fallback): Metoda tokenowa (dla przypadk√≥w bez siatki lub gdy GridTask nie zadzia≈Ça≈Ç)
 5807 | 1195 |       // WyciƒÖgnij data-s
 5808 | 1196 |       let dataS = null;
 5809 | 1197 |       try {
 5810 | 1198 |         dataS = await page.evaluate(() => {
 5811 | 1199 |           const recaptchaDiv = document.querySelector('.g-recaptcha, [data-sitekey], #recaptcha');
 5812 | 1200 |           if (recaptchaDiv?.dataset?.s) return recaptchaDiv.dataset.s;
 5813 | 1201 |           const iframes = document.querySelectorAll('iframe[src*="recaptcha"]');
 5814 | 1202 |           for (const iframe of iframes) {
 5815 | 1203 |             const match = (iframe.src || '').match(/[?&]s=([^&]+)/);
 5816 | 1204 |             if (match) return decodeURIComponent(match[1]);
 5817 | 1205 |           }
 5818 | 1206 |           return null;
 5819 | 1207 |         });
 5820 | 1208 |       } catch {}
 5821 | 1209 | 
 5822 | 1210 |       const maxRetries = 2;
 5823 | 1211 |       for (let attempt = 1; attempt <= maxRetries; attempt++) {
 5824 | 1212 |         log.prod("CAPTCHA", `reCAPTCHA pr√≥ba ${attempt}/${maxRetries}...`);
 5825 | 1213 | 
 5826 | 1214 |         apiResult = await solveRecaptchaViaApi(diagnosis.details.sitekey, currentUrl, {
 5827 | 1215 |           isEnterprise,
 5828 | 1216 |           isInvisible: false,
 5829 | 1217 |           dataS,
 5830 | 1218 |         });
 5831 | 1219 | 
 5832 | 1220 |         if (apiResult.ok) break;
 5833 | 1221 | 
 5834 | 1222 |         if (apiResult.error === 'ERROR_CAPTCHA_UNSOLVABLE' && attempt < maxRetries) {
 5835 | 1223 |           log.warn("CAPTCHA", "reCAPTCHA nierozwiƒÖzywalna - od≈õwie≈ºam...");
 5836 | 1224 |           await page.reload({ waitUntil: 'networkidle2' }).catch(() => {});
 5837 | 1225 |           await sleepRandom(3000, 5000);
 5838 | 1226 |         } else if (apiResult.error) {
 5839 | 1227 |           break;
 5840 | 1228 |         }
 5841 | 1229 |       }
 5842 | 1230 | 
 5843 | 1231 |       if (apiResult.ok && apiResult.token) {
 5844 | 1232 |         log.success("CAPTCHA", "Otrzymano token reCAPTCHA!");
 5845 | 1233 | 
 5846 | 1234 |         // Wstrzyknij token reCAPTCHA - u≈ºyj wykrytego callbacka je≈õli dostƒôpny
 5847 | 1235 |         const callbackPath = diagnosis.details.callback;
 5848 | 1236 |         try {
 5849 | 1237 |           const injected = await page.evaluate((token, cbPath) => {
 5850 | 1238 |             let success = false;
 5851 | 1239 | 
 5852 | 1240 |             // 1. Ustaw warto≈õƒá w textarea
 5853 | 1241 |             const textareas = document.querySelectorAll(
 5854 | 1242 |               'textarea[name="g-recaptcha-response"], #g-recaptcha-response'
 5855 | 1243 |             );
 5856 | 1244 |             textareas.forEach(ta => {
 5857 | 1245 |               ta.value = token;
 5858 | 1246 |               ta.innerHTML = token;
 5859 | 1247 |               success = true;
 5860 | 1248 |             });
 5861 | 1249 | 
 5862 | 1250 |             // 2. Wywo≈Çaj callback wykryty przez skrypt 2Captcha
 5863 | 1251 |             if (cbPath) {
 5864 | 1252 |               try {
 5865 | 1253 |                 // cbPath ma format: ___grecaptcha_cfg.clients['0']['X']['Y']['callback']
 5866 | 1254 |                 const callback = eval(cbPath);
 5867 | 1255 |                 if (typeof callback === 'function') {
 5868 | 1256 |                   callback(token);
 5869 | 1257 |                   success = true;
 5870 | 1258 |                   console.log('[2Captcha] Callback wywo≈Çany:', cbPath);
 5871 | 1259 |                 }
 5872 | 1260 |               } catch (e) {
 5873 | 1261 |                 console.log('[2Captcha] B≈ÇƒÖd callbacka:', e.message);
 5874 | 1262 |               }
 5875 | 1263 |             }
 5876 | 1264 | 
 5877 | 1265 |             // 3. Fallback - standardowe callbacki
 5878 | 1266 |             try { window.onCaptchaSuccess?.(token); } catch {}
 5879 | 1267 |             try { window.captchaCallback?.(token); } catch {}
 5880 | 1268 | 
 5881 | 1269 |             // 4. Szukaj callbacku w ___grecaptcha_cfg (g≈Çƒôboko)
 5882 | 1270 |             try {
 5883 | 1271 |               const cfg = window.___grecaptcha_cfg;
 5884 | 1272 |               if (cfg?.clients) {
 5885 | 1273 |                 for (const [cid, client] of Object.entries(cfg.clients)) {
 5886 | 1274 |                   for (const [key, obj] of Object.entries(client)) {
 5887 | 1275 |                     if (obj && typeof obj === 'object') {
 5888 | 1276 |                       for (const [subkey, subobj] of Object.entries(obj)) {
 5889 | 1277 |                         if (subobj && typeof subobj === 'object') {
 5890 | 1278 |                           if (typeof subobj.callback === 'function') {
 5891 | 1279 |                             subobj.callback(token);
 5892 | 1280 |                             success = true;
 5893 | 1281 |                             console.log('[2Captcha] Callback znaleziony w:', cid, key, subkey);
 5894 | 1282 |                           }
 5895 | 1283 |                         }
 5896 | 1284 |                       }
 5897 | 1285 |                     }
 5898 | 1286 |                   }
 5899 | 1287 |                 }
 5900 | 1288 |               }
 5901 | 1289 |             } catch {}
 5902 | 1290 | 
 5903 | 1291 |             return success;
 5904 | 1292 |           }, apiResult.token, callbackPath);
 5905 | 1293 | 
 5906 | 1294 |           log.dev("CAPTCHA", `Token reCAPTCHA wstrzykniƒôty: ${injected ? 'OK' : 'czƒô≈õciowo'}`);
 5907 | 1295 |           await sleepRandom(1500, 2500);
 5908 | 1296 | 
 5909 | 1297 |           // Kliknij przycisk submit
 5910 | 1298 |           await clickSubmitButton(page);
 5911 | 1299 |           return true;
 5912 | 1300 |         } catch (err) {
 5913 | 1301 |           log.error("CAPTCHA", `B≈ÇƒÖd wstrzykiwania tokenu reCAPTCHA: ${err?.message}`);
 5914 | 1302 |         }
 5915 | 1303 |       }
 5916 | 1304 |     }
 5917 | 1305 |     // === NIEZNANY TYP ===
 5918 | 1306 |     else {
 5919 | 1307 |       log.warn("CAPTCHA", `Nieobs≈Çugiwany typ captcha: ${diagnosis.type}`);
 5920 | 1308 |       log.prod("CAPTCHA", "Szczeg√≥≈Çy diagnozy:", JSON.stringify(diagnosis.details, null, 2));
 5921 | 1309 |     }
 5922 | 1310 | 
 5923 | 1311 |     await sleepRandom(1000, 2000);
 5924 | 1312 |   }
 5925 | 1313 | 
 5926 | 1314 |   // Standardowe sprawdzenie captcha
 5927 | 1315 |   const captchaResult = await solveCaptchaIfPresent(page);
 5928 | 1316 |   if (captchaResult.solved) {
 5929 | 1317 |     log.success("LOGIN", "Captcha rozwiƒÖzana po logowaniu!");
 5930 | 1318 |     await sleepRandom(2000, 3000);
 5931 | 1319 | 
 5932 | 1320 |     // Po rozwiƒÖzaniu captcha, mo≈ºe trzeba kliknƒÖƒá submit ponownie
 5933 | 1321 |     const submitAfterCaptcha = await page.$('button[type="submit"], button[name="login"]');
 5934 | 1322 |     if (submitAfterCaptcha) {
 5935 | 1323 |       await submitAfterCaptcha.click().catch(() => {});
 5936 | 1324 |       await page.waitForNavigation({ waitUntil: "networkidle2", timeout: 30000 }).catch(() => {});
 5937 | 1325 |       await sleepRandom(1000, 2000);
 5938 | 1326 |     }
 5939 | 1327 |   }
 5940 | 1328 | 
 5941 | 1329 |   return true;
 5942 | 1330 | }
 5943 | 1331 | 
 5944 | 1332 | /**
 5945 | 1333 |  * Pr√≥ba logowania na dowolnym widocznym formularzu (z lokalnej wersji),
 5946 | 1334 |  * ale z lekkimi ulepszeniami i bez crashy.
 5947 | 1335 |  */
 5948 | 1336 | async function loginViaVisibleForm(page, context = "visible-form") {
 5949 | 1337 |   try {
 5950 | 1338 |     log.debug("LOGIN", `Szukam formularza (${context})...`);
 5951 | 1339 | 
 5952 | 1340 |     await acceptLoginCookies(page).catch(() => {});
 5953 | 1341 |     await acceptCookiesIfPresent(page).catch(() => {});
 5954 | 1342 | 
 5955 | 1343 |     const emailSelector = [
 5956 | 1344 |       "input#email",
 5957 | 1345 |       "input[name='email']",
 5958 | 1346 |       "input[name='email_or_phone']",
 5959 | 1347 |       "input[aria-label*='Adres e-mail']",
 5960 | 1348 |       "input[placeholder*='Adres e-mail']",
 5961 | 1349 |       "input[placeholder*='adres e-mail']",
 5962 | 1350 |       "input[placeholder*='Email']",
 5963 | 1351 |       "input[placeholder*='email']",
 5964 | 1352 |       "input[type='text']",
 5965 | 1353 |     ].join(",");
 5966 | 1354 | 
 5967 | 1355 |     const passSelector = [
 5968 | 1356 |       "input#pass",
 5969 | 1357 |       "input[name='pass']",
 5970 | 1358 |       "input[aria-label*='Has≈Ço']",
 5971 | 1359 |       "input[placeholder*='Has≈Ço']",
 5972 | 1360 |       "input[placeholder*='has≈Ço']",
 5973 | 1361 |       "input[placeholder*='Password']",
 5974 | 1362 |       "input[placeholder*='password']",
 5975 | 1363 |       "input[type='password']",
 5976 | 1364 |     ].join(",");
 5977 | 1365 | 
 5978 | 1366 |     const emailInput = await page.$(emailSelector).catch(() => null);
 5979 | 1367 |     const passInput = await page.$(passSelector).catch(() => null);
 5980 | 1368 | 
 5981 | 1369 |     if (!emailInput || !passInput) {
 5982 | 1370 |       log.debug("LOGIN", "Brak pe≈Çnego formularza na stronie");
 5983 | 1371 |       return false;
 5984 | 1372 |     }
 5985 | 1373 | 
 5986 | 1374 |     const ok = await fillLoginFormBestEffort(page);
 5987 | 1375 |     if (!ok) return false;
 5988 | 1376 | 
 5989 | 1377 |     log.dev("LOGIN", "Formularz logowania wys≈Çany");
 5990 | 1378 |     return true;
 5991 | 1379 |   } catch (err) {
 5992 | 1380 |     log.debug("LOGIN", `B≈ÇƒÖd formularza: ${err?.message || err}`);
 5993 | 1381 |     return false;
 5994 | 1382 |   }
 5995 | 1383 | }
 5996 | 1384 | 
 5997 | 1385 | /**
 5998 | 1386 |  * G≈Ç√≥wne logowanie ‚Äì NAJSTABILNIEJSZE: login.php?next=<URL>
 5999 | 1387 |  * Param nextUrl: URL posta, do kt√≥rego FB ma wr√≥ciƒá po loginie.
 6000 | 1388 |  */
 6001 | 1389 | async function fbLogin(page, nextUrl = "") {
 6002 | 1390 |   try {
 6003 | 1391 |     log.dev("LOGIN", "Start logowania...");
 6004 | 1392 | 
 6005 | 1393 |     const next = nextUrl ? `?next=${encodeURIComponent(nextUrl)}` : "";
 6006 | 1394 |     const url = `https://www.facebook.com/login.php${next}`;
 6007 | 1395 | 
 6008 | 1396 |     await page
 6009 | 1397 |       .goto(url, { waitUntil: "networkidle2", timeout: 60000 })
 6010 | 1398 |       .catch(() => {});
 6011 | 1399 | 
 6012 | 1400 |     await sleepRandom(900, 1400);
 6013 | 1401 | 
 6014 | 1402 |     // cookies ‚Äì dwie metody (mark+click oraz szybki fallback)
 6015 | 1403 |     await acceptLoginCookies(page).catch(() => {});
 6016 | 1404 |     await acceptCookiesIfPresent(page).catch(() => {});
 6017 | 1405 | 
 6018 | 1406 |     const ok = await fillLoginFormBestEffort(page);
 6019 | 1407 |     if (!ok) return false;
 6020 | 1408 | 
 6021 | 1409 |     // FB czasem zostaje na tej samej stronie ‚Äì dodatkowa pauza
 6022 | 1410 |     await sleepRandom(1200, 2000);
 6023 | 1411 | 
 6024 | 1412 |     return true;
 6025 | 1413 |   } catch (e) {
 6026 | 1414 |     log.debug("LOGIN", `B≈ÇƒÖd logowania: ${e?.message || e}`);
 6027 | 1415 |     return false;
 6028 | 1416 |   }
 6029 | 1417 | }
 6030 | 1418 | 
 6031 | 1419 | /**
 6032 | 1420 |  * Heurystyczny check sesji (jak serwer).
 6033 | 1421 |  */
 6034 | 1422 | async function checkIfLogged(page) {
 6035 | 1423 |   try {
 6036 | 1424 |     return await page.evaluate(() => {
 6037 | 1425 |       return !!(
 6038 | 1426 |         document.querySelector('input[aria-label*="Szukaj"]') ||
 6039 | 1427 |         document.querySelector('input[placeholder*="Szukaj"]') ||
 6040 | 1428 |         document.querySelector('a[aria-label*="Profil"]') ||
 6041 | 1429 |         document.querySelector('div[aria-label*="Konto"]')
 6042 | 1430 |       );
 6043 | 1431 |     });
 6044 | 1432 |   } catch {
 6045 | 1433 |     return false;
 6046 | 1434 |   }
 6047 | 1435 | }
 6048 | 1436 | 
 6049 | 1437 | /**
 6050 | 1438 |  * Klikniƒôcie elementu po dok≈Çadnym tek≈õcie (lokalny helper).
 6051 | 1439 |  */
 6052 | 1440 | async function clickByText(page, text) {
 6053 | 1441 |   const res = await page.evaluate((label) => {
 6054 | 1442 |     const els = Array.from(
 6055 | 1443 |       document.querySelectorAll("button, a, div[role='button'], span[role='button']")
 6056 | 1444 |     );
 6057 | 1445 |     const lowLabel = String(label || "").toLowerCase();
 6058 | 1446 |     for (const el of els) {
 6059 | 1447 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
 6060 | 1448 |       if (!t) continue;
 6061 | 1449 |       if (t === lowLabel) {
 6062 | 1450 |         el.click();
 6063 | 1451 |         return true;
 6064 | 1452 |       }
 6065 | 1453 |     }
 6066 | 1454 |     return false;
 6067 | 1455 |   }, text);
 6068 | 1456 |   return res;
 6069 | 1457 | }
 6070 | 1458 | 
 6071 | 1459 | /**
 6072 | 1460 |  * Heurystyka login-wall (serwerowa).
 6073 | 1461 |  * Uwaga: "Log In" czasem jest widoczne mimo, ≈ºe da siƒô czytaƒá komentarze,
 6074 | 1462 |  * wiƒôc to powinno odpalaƒá siƒô dopiero gdy UI nie potrafi odczytaƒá danych.
 6075 | 1463 |  */
 6076 | 1464 | async function looksLikeLoginWall(page) {
 6077 | 1465 |   try {
 6078 | 1466 |     return await page.evaluate(() => {
 6079 | 1467 |       const txt = (document.body?.innerText || "").toLowerCase();
 6080 | 1468 |       if (!txt) return false;
 6081 | 1469 | 
 6082 | 1470 |       const hasLoginWords =
 6083 | 1471 |         txt.includes("log in") ||
 6084 | 1472 |         txt.includes("sign up") ||
 6085 | 1473 |         txt.includes("create new account") ||
 6086 | 1474 |         txt.includes("zaloguj") ||
 6087 | 1475 |         txt.includes("zarejestruj");
 6088 | 1476 | 
 6089 | 1477 |       if (!hasLoginWords) return false;
 6090 | 1478 | 
 6091 | 1479 |       const hasLoginForm =
 6092 | 1480 |         !!document.querySelector("input[type='password']") ||
 6093 | 1481 |         !!document.querySelector("input#email") ||
 6094 | 1482 |         !!document.querySelector("input[name='email']");
 6095 | 1483 | 
 6096 | 1484 |       const hasPostWords =
 6097 | 1485 |         txt.includes("comment") ||
 6098 | 1486 |         txt.includes("comments") ||
 6099 | 1487 |         txt.includes("komentarz") ||
 6100 | 1488 |         txt.includes("lubiƒô to") ||
 6101 | 1489 |         txt.includes("like") ||
 6102 | 1490 |         txt.includes("reply") ||
 6103 | 1491 |         txt.includes("replied");
 6104 | 1492 | 
 6105 | 1493 |       return hasLoginForm || (hasLoginWords && !hasPostWords);
 6106 | 1494 |     });
 6107 | 1495 |   } catch {
 6108 | 1496 |     return false;
 6109 | 1497 |   }
 6110 | 1498 | }
 6111 | 1499 | 
 6112 | 1500 | /**
 6113 | 1501 |  * G≈Ç√≥wny ‚Äûw≈ÇƒÖcznik‚Äù do u≈ºycia w UI handlerach:
 6114 | 1502 |  * - je≈õli wyglƒÖda na login-wall -> login.php?next -> wr√≥ƒá na post
 6115 | 1503 |  * - fallback: pr√≥ba loginViaVisibleForm (gdyby FB zrobi≈Ç overlay)
 6116 | 1504 |  *
 6117 | 1505 |  * Param postUrl: najlepiej podaƒá URL posta (≈ºeby next= dzia≈Ça≈Ço idealnie)
 6118 | 1506 |  */
 6119 | 1507 | async function ensureLoggedInOnPostOverlay(page, postUrl = "") {
 6120 | 1508 |   try {
 6121 | 1509 |     const cur = page.url();
 6122 | 1510 |     const target = postUrl || cur;
 6123 | 1511 | 
 6124 | 1512 |     const wall = await looksLikeLoginWall(page);
 6125 | 1513 |     if (!wall) return false;
 6126 | 1514 | 
 6127 | 1515 |     log.dev("LOGIN", "Wykryto login-wall ‚Üí pr√≥ba logowania");
 6128 | 1516 | 
 6129 | 1517 |     const tried = await fbLogin(page, target);
 6130 | 1518 | 
 6131 | 1519 |     let logged = await checkIfLogged(page);
 6132 | 1520 |     log.dev("LOGIN", `Sesja po fbLogin: ${logged ? "OK" : "BRAK"}`);
 6133 | 1521 | 
 6134 | 1522 |     // je≈õli FB nie przerzuci≈Ç automatycznie, wr√≥ƒá na post
 6135 | 1523 |     if (target && norm(page.url()) !== norm(target)) {
 6136 | 1524 |       await page
 6137 | 1525 |         .goto(target, { waitUntil: "networkidle2", timeout: 60000 })
 6138 | 1526 |         .catch(() => {});
 6139 | 1527 |       await sleepRandom(900, 1400);
 6140 | 1528 |     }
 6141 | 1529 | 
 6142 | 1530 |     // jeszcze raz sprawd≈∫ sesjƒô po powrocie
 6143 | 1531 |     logged = await checkIfLogged(page);
 6144 | 1532 | 
 6145 | 1533 |     // fallback: gdyby FB nadal siedzia≈Ç na overlayu, spr√≥buj visible-form
 6146 | 1534 |     if (!logged) {
 6147 | 1535 |       const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
 6148 | 1536 |       if (usedInline) {
 6149 | 1537 |         logged = await checkIfLogged(page);
 6150 | 1538 |         log.dev("LOGIN", `Sesja po visible-form: ${logged ? "OK" : "BRAK"}`);
 6151 | 1539 |       }
 6152 | 1540 |     }
 6153 | 1541 | 
 6154 | 1542 |     return tried && logged;
 6155 | 1543 |   } catch (e) {
 6156 | 1544 |     log.debug("LOGIN", `ensureLoggedInOnPostOverlay error: ${e?.message || e}`);
 6157 | 1545 |     return false;
 6158 | 1546 |   }
 6159 | 1547 | }
 6160 | 1548 | 
 6161 | 1549 | /**
 6162 | 1550 |  * Wykrywa obecno≈õƒá captcha na stronie (reCAPTCHA, hCaptcha, itp.)
 6163 | 1551 |  */
 6164 | 1552 | async function hasCaptcha(page) {
 6165 | 1553 |   try {
 6166 | 1554 |     const result = await page.evaluate(() => {
 6167 | 1555 |       // reCAPTCHA v2/v3 - rozszerzone selektory
 6168 | 1556 |       const recaptchaSelectors = [
 6169 | 1557 |         'iframe[src*="recaptcha"]',
 6170 | 1558 |         'iframe[src*="google.com/recaptcha"]',
 6171 | 1559 |         'iframe[title*="reCAPTCHA"]',
 6172 | 1560 |         'iframe[title*="recaptcha"]',
 6173 | 1561 |         '.g-recaptcha',
 6174 | 1562 |         '#recaptcha',
 6175 | 1563 |         '[data-sitekey]',
 6176 | 1564 |         '.rc-anchor',
 6177 | 1565 |         '.recaptcha-checkbox',
 6178 | 1566 |       ].join(',');
 6179 | 1567 | 
 6180 | 1568 |       const recaptcha = document.querySelector(recaptchaSelectors);
 6181 | 1569 | 
 6182 | 1570 |       // hCaptcha
 6183 | 1571 |       const hcaptcha = document.querySelector(
 6184 | 1572 |         'iframe[src*="hcaptcha"], .h-captcha'
 6185 | 1573 |       );
 6186 | 1574 | 
 6187 | 1575 |       // Facebook image captcha
 6188 | 1576 |       const fbCaptcha = document.querySelector(
 6189 | 1577 |         'img[src*="captcha"], input[name*="captcha"]'
 6190 | 1578 |       );
 6191 | 1579 | 
 6192 | 1580 |       // Tekst "Nie jestem robotem" / "I'm not a robot" na stronie
 6193 | 1581 |       const bodyText = (document.body?.innerText || '').toLowerCase();
 6194 | 1582 |       const hasRobotText = bodyText.includes('nie jestem robotem') ||
 6195 | 1583 |                           bodyText.includes("i'm not a robot") ||
 6196 | 1584 |                           bodyText.includes('recaptcha');
 6197 | 1585 | 
 6198 | 1586 |       // URL zawiera verification/authentication z recaptcha
 6199 | 1587 |       const url = window.location.href.toLowerCase();
 6200 | 1588 |       const isVerificationPage = url.includes('two_step_verification') ||
 6201 | 1589 |                                   url.includes('checkpoint');
 6202 | 1590 | 
 6203 | 1591 |       return {
 6204 | 1592 |         found: !!(recaptcha || hcaptcha || fbCaptcha || (hasRobotText && isVerificationPage)),
 6205 | 1593 |         details: {
 6206 | 1594 |           recaptcha: !!recaptcha,
 6207 | 1595 |           hcaptcha: !!hcaptcha,
 6208 | 1596 |           fbCaptcha: !!fbCaptcha,
 6209 | 1597 |           robotText: hasRobotText,
 6210 | 1598 |           verificationPage: isVerificationPage
 6211 | 1599 |         }
 6212 | 1600 |       };
 6213 | 1601 |     });
 6214 | 1602 | 
 6215 | 1603 |     if (result.found) {
 6216 | 1604 |       log.debug("CAPTCHA", "Wykryto captcha", result.details);
 6217 | 1605 |     }
 6218 | 1606 | 
 6219 | 1607 |     return result.found;
 6220 | 1608 |   } catch {
 6221 | 1609 |     return false;
 6222 | 1610 |   }
 6223 | 1611 | }
 6224 | 1612 | 
 6225 | 1613 | /**
 6226 | 1614 |  * Pr√≥buje rozwiƒÖzaƒá captcha na stronie (je≈õli plugin 2Captcha jest w≈ÇƒÖczony).
 6227 | 1615 |  * Wymaga puppeteer-extra-plugin-recaptcha.
 6228 | 1616 |  * @returns {Promise<{solved: boolean, error?: string}>}
 6229 | 1617 |  */
 6230 | 1618 | async function solveCaptchaIfPresent(page) {
 6231 | 1619 |   if (!CAPTCHA_ENABLED) {
 6232 | 1620 |     log.debug("CAPTCHA", "Solver wy≈ÇƒÖczony (brak CAPTCHA_API_KEY)");
 6233 | 1621 |     return { solved: false, error: "disabled" };
 6234 | 1622 |   }
 6235 | 1623 | 
 6236 | 1624 |   try {
 6237 | 1625 |     const detected = await hasCaptcha(page);
 6238 | 1626 |     if (!detected) {
 6239 | 1627 |       log.debug("CAPTCHA", "Brak captcha na stronie");
 6240 | 1628 |       return { solved: false, error: "no_captcha" };
 6241 | 1629 |     }
 6242 | 1630 | 
 6243 | 1631 |     log.prod("CAPTCHA", "Wykryto captcha - rozpoczynam rozwiƒÖzywanie...");
 6244 | 1632 | 
 6245 | 1633 |     // puppeteer-extra-plugin-recaptcha dodaje metodƒô solveRecaptchas() do page
 6246 | 1634 |     if (typeof page.solveRecaptchas !== "function") {
 6247 | 1635 |       log.warn("CAPTCHA", "Plugin recaptcha nie jest za≈Çadowany");
 6248 | 1636 |       return { solved: false, error: "plugin_not_loaded" };
 6249 | 1637 |     }
 6250 | 1638 | 
 6251 | 1639 |     const result = await page.solveRecaptchas();
 6252 | 1640 | 
 6253 | 1641 |     if (result.solved && result.solved.length > 0) {
 6254 | 1642 |       log.prod("CAPTCHA", `RozwiƒÖzano ${result.solved.length} captcha!`);
 6255 | 1643 |       await sleepRandom(1000, 2000);
 6256 | 1644 |       return { solved: true };
 6257 | 1645 |     } else if (result.error) {
 6258 | 1646 |       log.warn("CAPTCHA", `B≈ÇƒÖd rozwiƒÖzywania: ${result.error}`);
 6259 | 1647 |       return { solved: false, error: result.error };
 6260 | 1648 |     } else {
 6261 | 1649 |       log.debug("CAPTCHA", "Brak captcha do rozwiƒÖzania (lub nieobs≈Çugiwany typ)");
 6262 | 1650 |       return { solved: false, error: "unsupported_or_none" };
 6263 | 1651 |     }
 6264 | 1652 |   } catch (err) {
 6265 | 1653 |     log.warn("CAPTCHA", `WyjƒÖtek: ${err?.message || err}`);
 6266 | 1654 |     return { solved: false, error: err?.message || "unknown" };
 6267 | 1655 |   }
 6268 | 1656 | }
 6269 | 1657 | 
 6270 | 1658 | export {
 6271 | 1659 |   fbLogin,
 6272 | 1660 |   checkIfLogged,
 6273 | 1661 |   ensureLoggedInOnPostOverlay,
 6274 | 1662 |   clickByText,
 6275 | 1663 |   acceptLoginCookies,
 6276 | 1664 |   loginViaVisibleForm,
 6277 | 1665 |   hasCaptcha,
 6278 | 1666 |   solveCaptchaIfPresent,
 6279 | 1667 | };
 6280 | 1668 | 
 6281 | ```
 6282 | 
 6283 | ---
 6284 | 
 6285 | ### üìÑ ≈öcie≈ºka: `src/fb/scroll.js`
 6286 | **Typ:** JavaScript/tekst  
 6287 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 6288 | 
 6289 | ```js
 6290 |  1 | import { gaussianRandom, sleep } from "../utils/sleep.js";
 6291 |  2 | 
 6292 |  3 | /**
 6293 |  4 |  * Scrollowanie posta - p≈Çynne, human-like
 6294 |  5 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
 6295 |  6 |  * - scrollujemy w ma≈Çych krokach z losowymi op√≥≈∫nieniami
 6296 |  7 |  */
 6297 |  8 | async function scrollPost(page, amount = 450) {
 6298 |  9 |   // Human behavior: scrolluj w ma≈Çych krokach (jak k√≥≈Çko myszy)
 6299 | 10 |   const steps = Math.max(3, Math.ceil(amount / 80)); // ~80px na krok
 6300 | 11 |   const stepAmount = Math.round(amount / steps);
 6301 | 12 | 
 6302 | 13 |   for (let i = 0; i < steps; i++) {
 6303 | 14 |     await page.evaluate((dy) => {
 6304 | 15 |       function findScrollableAncestor(start) {
 6305 | 16 |         let el = start;
 6306 | 17 |         while (el) {
 6307 | 18 |           const style = window.getComputedStyle(el);
 6308 | 19 |           const canScrollY =
 6309 | 20 |             style.overflowY === "auto" || style.overflowY === "scroll";
 6310 | 21 |           if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
 6311 | 22 |             return el;
 6312 | 23 |           }
 6313 | 24 |           el = el.parentElement;
 6314 | 25 |         }
 6315 | 26 |         return null;
 6316 | 27 |       }
 6317 | 28 | 
 6318 | 29 |       // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
 6319 | 30 |       const centerEl = document.elementFromPoint(
 6320 | 31 |         window.innerWidth / 2,
 6321 | 32 |         window.innerHeight / 2
 6322 | 33 |       );
 6323 | 34 | 
 6324 | 35 |       let target = centerEl ? findScrollableAncestor(centerEl) : null;
 6325 | 36 | 
 6326 | 37 |       // fallback: dialog
 6327 | 38 |       if (!target) {
 6328 | 39 |         const dialog = document.querySelector("div[role='dialog']");
 6329 | 40 |         if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
 6330 | 41 |           target = dialog;
 6331 | 42 |         }
 6332 | 43 |       }
 6333 | 44 | 
 6334 | 45 |       // ostateczny fallback: dokument
 6335 | 46 |       if (!target) {
 6336 | 47 |         target =
 6337 | 48 |           document.scrollingElement || document.documentElement || document.body;
 6338 | 49 |       }
 6339 | 50 | 
 6340 | 51 |       if (
 6341 | 52 |         target === document.body ||
 6342 | 53 |         target === document.documentElement ||
 6343 | 54 |         target === document.scrollingElement
 6344 | 55 |       ) {
 6345 | 56 |         const before = window.scrollY;
 6346 | 57 |         window.scrollTo(0, before + dy);
 6347 | 58 |       } else {
 6348 | 59 |         target.scrollTop += dy;
 6349 | 60 |       }
 6350 | 61 |     }, stepAmount);
 6351 | 62 | 
 6352 | 63 |     // Human delay miƒôdzy krokami scrollowania (30-80ms)
 6353 | 64 |     if (i < steps - 1) {
 6354 | 65 |       const delay = gaussianRandom(50, 15);
 6355 | 66 |       await sleep(Math.max(20, Math.min(100, delay)));
 6356 | 67 |     }
 6357 | 68 |   }
 6358 | 69 | }
 6359 | 70 | 
 6360 | 71 | export { scrollPost };
 6361 | 72 | 
 6362 | ```
 6363 | 
 6364 | ---
 6365 | 
 6366 | ### üìÑ ≈öcie≈ºka: `src/fb/ui/index.js`
 6367 | **Typ:** JavaScript/tekst  
 6368 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 6369 | 
 6370 | ```js
 6371 |  1 | // src/fb/ui/index.js
 6372 |  2 | import * as PostUI from "./post.js";
 6373 |  3 | import * as PhotoUI from "./photo.js";
 6374 |  4 | import * as WatchUI from "./watch.js";
 6375 |  5 | import * as VideosUI from "./videos.js";
 6376 |  6 | 
 6377 |  7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
 6378 |  8 | 
 6379 |  9 | export function pickUiHandler(url) {
 6380 | 10 |   const u = String(url || "");
 6381 | 11 |   for (const h of HANDLERS) {
 6382 | 12 |     try {
 6383 | 13 |       if (h.matchesUrl(u)) return h;
 6384 | 14 |     } catch {}
 6385 | 15 |   }
 6386 | 16 |   return PostUI;
 6387 | 17 | }
 6388 | 18 | 
 6389 | ```
 6390 | 
 6391 | ---
 6392 | 
 6393 | ### üìÑ ≈öcie≈ºka: `src/fb/ui/photo.js`
 6394 | **Typ:** JavaScript/tekst  
 6395 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 6396 | 
 6397 | ```js
 6398 |    1 | // src/fb/ui/photo.js
 6399 |    2 | import { safeGoto } from "../../utils/navigation.js";
 6400 |    3 | import { sleepRandom } from "../../utils/sleep.js";
 6401 |    4 | import { scrollPost } from "../scroll.js";
 6402 |    5 | import { acceptCookies, saveCookies } from "../cookies.js";
 6403 |    6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
 6404 |    7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
 6405 |    8 | import log from "../../utils/logger.js";
 6406 |    9 | 
 6407 |   10 | export const type = "photo";
 6408 |   11 | 
 6409 |   12 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
 6410 |   13 | 
 6411 |   14 | /**
 6412 |   15 |  * WA≈ªNE:
 6413 |   16 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
 6414 |   17 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
 6415 |   18 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
 6416 |   19 |  */
 6417 |   20 | const PACE_CFG =
 6418 |   21 |   PACE === "server"
 6419 |   22 |     ? {
 6420 |   23 |         // delikatnie wolniej na serwerze (render/CPU)
 6421 |   24 |         stepJitterMinMs: 140,
 6422 |   25 |         stepJitterMaxMs: 260,
 6423 |   26 | 
 6424 |   27 |         afterScrollMinMs: 260,
 6425 |   28 |         afterScrollMaxMs: 520,
 6426 |   29 | 
 6427 |   30 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
 6428 |   31 |         effectWaitMs: 5200,
 6429 |   32 | 
 6430 |   33 |         scrollPx: 140,
 6431 |   34 | 
 6432 |   35 |         // bonusowe kliki, ale event-driven
 6433 |   36 |         bonusClickTries: 2,
 6434 |   37 |         bonusClickDelayMinMs: 120,
 6435 |   38 |         bonusClickDelayMaxMs: 220,
 6436 |   39 | 
 6437 |   40 |         // HARD BOTTOM (sprawdzane rzadko)
 6438 |   41 |         hardBottomEpsPx: 10,
 6439 |   42 |         hardBottomStableNeed: 4,
 6440 |   43 |         hardBottomStableDelayMinMs: 320,
 6441 |   44 |         hardBottomStableDelayMaxMs: 560,
 6442 |   45 |       }
 6443 |   46 |     : {
 6444 |   47 |         // lokalnie szybciej
 6445 |   48 |         stepJitterMinMs: 90,
 6446 |   49 |         stepJitterMaxMs: 190,
 6447 |   50 | 
 6448 |   51 |         afterScrollMinMs: 180,
 6449 |   52 |         afterScrollMaxMs: 420,
 6450 |   53 | 
 6451 |   54 |         effectWaitMs: 4200,
 6452 |   55 | 
 6453 |   56 |         scrollPx: 160,
 6454 |   57 | 
 6455 |   58 |         bonusClickTries: 2,
 6456 |   59 |         bonusClickDelayMinMs: 90,
 6457 |   60 |         bonusClickDelayMaxMs: 180,
 6458 |   61 | 
 6459 |   62 |         hardBottomEpsPx: 10,
 6460 |   63 |         hardBottomStableNeed: 4,
 6461 |   64 |         hardBottomStableDelayMinMs: 240,
 6462 |   65 |         hardBottomStableDelayMaxMs: 420,
 6463 |   66 |       };
 6464 |   67 | 
 6465 |   68 | export function matchesUrl(url) {
 6466 |   69 |   try {
 6467 |   70 |     const u = new URL(url);
 6468 |   71 |     const path = (u.pathname || "").toLowerCase();
 6469 |   72 | 
 6470 |   73 |     if (path.includes("photo.php")) return true;
 6471 |   74 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
 6472 |   75 |     if (u.searchParams.has("fbid")) return true;
 6473 |   76 | 
 6474 |   77 |     return false;
 6475 |   78 |   } catch {
 6476 |   79 |     const lower = (url || "").toLowerCase();
 6477 |   80 |     if (lower.includes("photo.php")) return true;
 6478 |   81 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
 6479 |   82 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
 6480 |   83 |     return false;
 6481 |   84 |   }
 6482 |   85 | }
 6483 |   86 | 
 6484 |   87 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
 6485 |   88 | 
 6486 |   89 | async function clickAllCommentsInMenu(page) {
 6487 |   90 |   const result = await page.evaluate(() => {
 6488 |   91 |     const menu =
 6489 |   92 |       document.querySelector("div[role='menu']") ||
 6490 |   93 |       document.querySelector("div[role='dialog']");
 6491 |   94 | 
 6492 |   95 |     if (!menu) return { clicked: false, noMenu: true };
 6493 |   96 | 
 6494 |   97 |     const items = Array.from(
 6495 |   98 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
 6496 |   99 |     );
 6497 |  100 | 
 6498 |  101 |     const opt = items.find((el) => {
 6499 |  102 |       const t = (el.textContent || "").trim().toLowerCase();
 6500 |  103 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
 6501 |  104 |     });
 6502 |  105 | 
 6503 |  106 |     if (!opt) return { clicked: false, noMenu: false };
 6504 |  107 | 
 6505 |  108 |     opt.click();
 6506 |  109 |     setTimeout(() => {
 6507 |  110 |       try {
 6508 |  111 |         document.body.click();
 6509 |  112 |       } catch {}
 6510 |  113 |     }, 50);
 6511 |  114 | 
 6512 |  115 |     return { clicked: true, noMenu: false };
 6513 |  116 |   });
 6514 |  117 | 
 6515 |  118 |   if (result.clicked) {
 6516 |  119 |     await sleepRandom(180, 320);
 6517 |  120 |     await page
 6518 |  121 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
 6519 |  122 |       .catch(() => {});
 6520 |  123 |   }
 6521 |  124 | 
 6522 |  125 |   return result;
 6523 |  126 | }
 6524 |  127 | 
 6525 |  128 | async function switchCommentsFilterToAll(page) {
 6526 |  129 |   log.debug("UI:photo", "Prze≈ÇƒÖczam filtr ‚Üí wszystkie komentarze");
 6527 |  130 | 
 6528 |  131 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 6529 |  132 |   if (menuAlreadyOpen) {
 6530 |  133 |     const r = await clickAllCommentsInMenu(page);
 6531 |  134 |     return !!r.clicked;
 6532 |  135 |   }
 6533 |  136 | 
 6534 |  137 |   const pre = await page.evaluate(() => {
 6535 |  138 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 6536 |  139 |     let filterEl = null;
 6537 |  140 |     let labelText = "";
 6538 |  141 | 
 6539 |  142 |     for (const el of els) {
 6540 |  143 |       const t = (el.textContent || "").trim();
 6541 |  144 |       if (!t) continue;
 6542 |  145 |       const low = t.toLowerCase();
 6543 |  146 |       if (
 6544 |  147 |         low === "najtrafniejsze" ||
 6545 |  148 |         low === "most relevant" ||
 6546 |  149 |         low === "wszystkie komentarze" ||
 6547 |  150 |         low === "all comments"
 6548 |  151 |       ) {
 6549 |  152 |         filterEl = el;
 6550 |  153 |         labelText = low;
 6551 |  154 |         break;
 6552 |  155 |       }
 6553 |  156 |     }
 6554 |  157 | 
 6555 |  158 |     if (!filterEl) return { state: "not-found" };
 6556 |  159 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
 6557 |  160 |       return { state: "already-all" };
 6558 |  161 |     }
 6559 |  162 | 
 6560 |  163 |     filterEl.click();
 6561 |  164 |     return { state: "clicked-filter" };
 6562 |  165 |   });
 6563 |  166 | 
 6564 |  167 |   if (pre.state === "not-found") return false;
 6565 |  168 |   if (pre.state === "already-all") return true;
 6566 |  169 | 
 6567 |  170 |   await sleepRandom(120, 220);
 6568 |  171 |   const r = await clickAllCommentsInMenu(page);
 6569 |  172 |   if (r.clicked) return true;
 6570 |  173 | 
 6571 |  174 |   const afterLabelIsAll = await page.evaluate(() => {
 6572 |  175 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
 6573 |  176 |     return els.some((el) => {
 6574 |  177 |       const t = (el.textContent || "").trim().toLowerCase();
 6575 |  178 |       return t === "wszystkie komentarze" || t === "all comments";
 6576 |  179 |     });
 6577 |  180 |   });
 6578 |  181 | 
 6579 |  182 |   return afterLabelIsAll;
 6580 |  183 | }
 6581 |  184 | 
 6582 |  185 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
 6583 |  186 | 
 6584 |  187 | async function getCommentsRootHandle(page) {
 6585 |  188 |   const handle = await page.evaluateHandle(() => {
 6586 |  189 |     const norm = (s) =>
 6587 |  190 |       String(s || "")
 6588 |  191 |         .replace(/\u00a0/g, " ")
 6589 |  192 |         .replace(/\s+/g, " ")
 6590 |  193 |         .trim()
 6591 |  194 |         .toLowerCase();
 6592 |  195 | 
 6593 |  196 |     const isVisible = (el) => {
 6594 |  197 |       if (!el) return false;
 6595 |  198 |       try {
 6596 |  199 |         const r = el.getBoundingClientRect();
 6597 |  200 |         return r.width > 2 && r.height > 2;
 6598 |  201 |       } catch {
 6599 |  202 |         return true;
 6600 |  203 |       }
 6601 |  204 |     };
 6602 |  205 | 
 6603 |  206 |     const isMoreCommentsBtn = (el) => {
 6604 |  207 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 6605 |  208 |       if (!t) return false;
 6606 |  209 |       return (
 6607 |  210 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 6608 |  211 |         t.includes("zobacz wiƒôcej komentarzy") ||
 6609 |  212 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
 6610 |  213 |         t.includes("view more comments") ||
 6611 |  214 |         t.includes("view previous comments")
 6612 |  215 |       );
 6613 |  216 |     };
 6614 |  217 | 
 6615 |  218 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
 6616 |  219 |       isVisible
 6617 |  220 |     );
 6618 |  221 |     const keyBtn = btns.find(isMoreCommentsBtn);
 6619 |  222 | 
 6620 |  223 |     if (keyBtn) {
 6621 |  224 |       const dlg = keyBtn.closest?.("div[role='dialog']");
 6622 |  225 |       if (dlg) return dlg;
 6623 |  226 | 
 6624 |  227 |       let cur = keyBtn.parentElement;
 6625 |  228 |       for (let i = 0; i < 20 && cur; i++) {
 6626 |  229 |         if (cur.matches?.("article,main,section,div")) return cur;
 6627 |  230 |         cur = cur.parentElement;
 6628 |  231 |       }
 6629 |  232 |     }
 6630 |  233 | 
 6631 |  234 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
 6632 |  235 |     const dlg2 = dialogs.find((d) => {
 6633 |  236 |       const t = norm(d.innerText || d.textContent);
 6634 |  237 |       if (!t) return false;
 6635 |  238 |       if (t.includes("powiadomienia")) return false;
 6636 |  239 |       if (t.includes("szukaj znajomych")) return false;
 6637 |  240 |       return (
 6638 |  241 |         t.includes("najtrafniejsze") ||
 6639 |  242 |         t.includes("most relevant") ||
 6640 |  243 |         t.includes("komentarz") ||
 6641 |  244 |         t.includes("comment")
 6642 |  245 |       );
 6643 |  246 |     });
 6644 |  247 |     if (dlg2) return dlg2;
 6645 |  248 | 
 6646 |  249 |     return document.body;
 6647 |  250 |   });
 6648 |  251 | 
 6649 |  252 |   return handle;
 6650 |  253 | }
 6651 |  254 | 
 6652 |  255 | async function getCommentsScrollHandle(page, rootHandle) {
 6653 |  256 |   const handle = await page.evaluateHandle((root) => {
 6654 |  257 |     const isVisible = (el) => {
 6655 |  258 |       if (!el) return false;
 6656 |  259 |       try {
 6657 |  260 |         const r = el.getBoundingClientRect();
 6658 |  261 |         return r.width > 2 && r.height > 2;
 6659 |  262 |       } catch {
 6660 |  263 |         return true;
 6661 |  264 |       }
 6662 |  265 |     };
 6663 |  266 | 
 6664 |  267 |     const canScrollByTest = (el) => {
 6665 |  268 |       try {
 6666 |  269 |         if (!el) return false;
 6667 |  270 |         const h = el.clientHeight || 0;
 6668 |  271 |         const sh = el.scrollHeight || 0;
 6669 |  272 |         if (sh <= h + 40) return false;
 6670 |  273 | 
 6671 |  274 |         const before = el.scrollTop ?? 0;
 6672 |  275 |         el.scrollTop = before + 80;
 6673 |  276 |         const after = el.scrollTop ?? before;
 6674 |  277 |         el.scrollTop = before;
 6675 |  278 | 
 6676 |  279 |         return after !== before;
 6677 |  280 |       } catch {
 6678 |  281 |         return false;
 6679 |  282 |       }
 6680 |  283 |     };
 6681 |  284 | 
 6682 |  285 |     const closestScrollable = (start) => {
 6683 |  286 |       let cur = start;
 6684 |  287 |       for (let i = 0; i < 28 && cur; i++) {
 6685 |  288 |         if (canScrollByTest(cur)) return cur;
 6686 |  289 |         cur = cur.parentElement;
 6687 |  290 |       }
 6688 |  291 |       return null;
 6689 |  292 |     };
 6690 |  293 | 
 6691 |  294 |     const scope = root || document;
 6692 |  295 | 
 6693 |  296 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
 6694 |  297 |     if (outer) {
 6695 |  298 |       const sc = closestScrollable(outer);
 6696 |  299 |       if (sc) return sc;
 6697 |  300 |     }
 6698 |  301 | 
 6699 |  302 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
 6700 |  303 |       .filter(isVisible)
 6701 |  304 |       .slice(0, 25000);
 6702 |  305 | 
 6703 |  306 |     let best = null;
 6704 |  307 |     let bestDelta = -1;
 6705 |  308 |     for (const el of candidates) {
 6706 |  309 |       if (!canScrollByTest(el)) continue;
 6707 |  310 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
 6708 |  311 |       if (delta > bestDelta) {
 6709 |  312 |         bestDelta = delta;
 6710 |  313 |         best = el;
 6711 |  314 |       }
 6712 |  315 |     }
 6713 |  316 | 
 6714 |  317 |     return best || null;
 6715 |  318 |   }, rootHandle);
 6716 |  319 | 
 6717 |  320 |   return handle;
 6718 |  321 | }
 6719 |  322 | 
 6720 |  323 | /* ======================================================================== */
 6721 |  324 | 
 6722 |  325 | export async function prepare(page, url) {
 6723 |  326 |   log.dev("UI:photo", `Prepare: ${url}`);
 6724 |  327 | 
 6725 |  328 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 6726 |  329 |   if (!ok) throw new Error("safeGoto-failed");
 6727 |  330 | 
 6728 |  331 |   if (page.url().includes("/login")) {
 6729 |  332 |     log.dev("UI:photo", "/login ‚Äì fbLogin + re-enter");
 6730 |  333 |     await fbLogin(page);
 6731 |  334 |     await sleepRandom(2500, 4000);
 6732 |  335 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
 6733 |  336 |   }
 6734 |  337 | 
 6735 |  338 |   await acceptCookies(page, "photo-initial");
 6736 |  339 | 
 6737 |  340 |   const logged = await checkIfLogged(page).catch(() => false);
 6738 |  341 |   if (!logged) {
 6739 |  342 |     log.dev("UI:photo", "Brak sesji ‚Äì fbLogin()");
 6740 |  343 |     await fbLogin(page);
 6741 |  344 |     await sleepRandom(2500, 4000);
 6742 |  345 |   }
 6743 |  346 | 
 6744 |  347 |   await ensureLoggedInOnPostOverlay(page);
 6745 |  348 |   await acceptCookies(page, "photo");
 6746 |  349 | 
 6747 |  350 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
 6748 |  351 |   if (loggedFinal) await saveCookies(page);
 6749 |  352 | }
 6750 |  353 | 
 6751 |  354 | function parseNumberLikeNode(str) {
 6752 |  355 |   if (!str) return null;
 6753 |  356 | 
 6754 |  357 |   const cleaned = String(str)
 6755 |  358 |     .toLowerCase()
 6756 |  359 |     .replace(/\u00a0/g, " ")
 6757 |  360 |     .replace(/\s+/g, " ")
 6758 |  361 |     .trim();
 6759 |  362 | 
 6760 |  363 |   const plain = cleaned.replace(/[^\d]/g, "");
 6761 |  364 |   if (/^\d+$/.test(plain)) {
 6762 |  365 |     const n = Number(plain);
 6763 |  366 |     return Number.isFinite(n) ? n : null;
 6764 |  367 |   }
 6765 |  368 | 
 6766 |  369 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 6767 |  370 |   if (m) {
 6768 |  371 |     const base = Number(m[1].replace(",", "."));
 6769 |  372 |     if (Number.isFinite(base)) return Math.round(base * 1000);
 6770 |  373 |   }
 6771 |  374 | 
 6772 |  375 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 6773 |  376 |   if (m2) {
 6774 |  377 |     const base = Number(m2[1].replace(",", "."));
 6775 |  378 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
 6776 |  379 |   }
 6777 |  380 | 
 6778 |  381 |   return null;
 6779 |  382 | }
 6780 |  383 | 
 6781 |  384 | async function getPhotoUiCountFromChip(page, rootHandle) {
 6782 |  385 |   const res = await page
 6783 |  386 |     .evaluate((root) => {
 6784 |  387 |       const scope = root || document;
 6785 |  388 | 
 6786 |  389 |       const norm = (s) =>
 6787 |  390 |         String(s || "")
 6788 |  391 |           .replace(/\u00a0/g, " ")
 6789 |  392 |           .replace(/\s+/g, " ")
 6790 |  393 |           .trim();
 6791 |  394 | 
 6792 |  395 |       const parseNum = (s) => {
 6793 |  396 |         const t = norm(s);
 6794 |  397 |         if (!t) return null;
 6795 |  398 | 
 6796 |  399 |         const plain = t.replace(/[^\d]/g, "");
 6797 |  400 |         if (/^\d+$/.test(plain)) return Number(plain);
 6798 |  401 | 
 6799 |  402 |         const lower = t.toLowerCase();
 6800 |  403 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
 6801 |  404 |         if (m) {
 6802 |  405 |           const base = Number(m[1].replace(",", "."));
 6803 |  406 |           if (Number.isFinite(base)) return Math.round(base * 1000);
 6804 |  407 |         }
 6805 |  408 | 
 6806 |  409 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
 6807 |  410 |         if (m2) {
 6808 |  411 |           const base = Number(m2[1].replace(",", "."));
 6809 |  412 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
 6810 |  413 |         }
 6811 |  414 | 
 6812 |  415 |         return null;
 6813 |  416 |       };
 6814 |  417 | 
 6815 |  418 |       const isVisible = (el) => {
 6816 |  419 |         if (!el) return false;
 6817 |  420 |         const r = el.getBoundingClientRect();
 6818 |  421 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
 6819 |  422 |       };
 6820 |  423 | 
 6821 |  424 |       const commentBtn = Array.from(
 6822 |  425 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
 6823 |  426 |       ).find((el) => {
 6824 |  427 |         const t = norm(el.textContent).toLowerCase();
 6825 |  428 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
 6826 |  429 |       });
 6827 |  430 | 
 6828 |  431 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
 6829 |  432 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
 6830 |  433 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
 6831 |  434 | 
 6832 |  435 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
 6833 |  436 |         .filter(isVisible)
 6834 |  437 |         .slice(0, 5000);
 6835 |  438 | 
 6836 |  439 |       let best = null;
 6837 |  440 |       let bestScore = -Infinity;
 6838 |  441 | 
 6839 |  442 |       for (const el of candidates) {
 6840 |  443 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
 6841 |  444 |         if (!hasIcon) continue;
 6842 |  445 | 
 6843 |  446 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
 6844 |  447 |         let num = null;
 6845 |  448 |         let raw = null;
 6846 |  449 | 
 6847 |  450 |         for (const sp of spans) {
 6848 |  451 |           const t = norm(sp.textContent);
 6849 |  452 |           if (!t) continue;
 6850 |  453 |           if (t.length > 24) continue;
 6851 |  454 | 
 6852 |  455 |           const n = parseNum(t);
 6853 |  456 |           if (typeof n === "number" && Number.isFinite(n)) {
 6854 |  457 |             if (n <= 0 || n > 10000000) continue;
 6855 |  458 |             num = n;
 6856 |  459 |             raw = t;
 6857 |  460 |             break;
 6858 |  461 |           }
 6859 |  462 |         }
 6860 |  463 | 
 6861 |  464 |         if (num == null) continue;
 6862 |  465 | 
 6863 |  466 |         const r = el.getBoundingClientRect();
 6864 |  467 |         const cx = r.left + r.width / 2;
 6865 |  468 |         const cy = r.top + r.height / 2;
 6866 |  469 | 
 6867 |  470 |         let score = 0;
 6868 |  471 | 
 6869 |  472 |         if (anchorCx != null && anchorCy != null) {
 6870 |  473 |           const dx = cx - anchorCx;
 6871 |  474 |           const dy = cy - anchorCy;
 6872 |  475 |           const dist = Math.sqrt(dx * dx + dy * dy);
 6873 |  476 |           score -= dist;
 6874 |  477 |         }
 6875 |  478 | 
 6876 |  479 |         const textLen = norm(el.textContent).length;
 6877 |  480 |         score -= Math.min(400, textLen);
 6878 |  481 | 
 6879 |  482 |         score += Math.min(200, Math.log10(num + 1) * 120);
 6880 |  483 | 
 6881 |  484 |         if (score > bestScore) {
 6882 |  485 |           bestScore = score;
 6883 |  486 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
 6884 |  487 |         }
 6885 |  488 |       }
 6886 |  489 | 
 6887 |  490 |       return best;
 6888 |  491 |     }, rootHandle)
 6889 |  492 |     .catch(() => null);
 6890 |  493 | 
 6891 |  494 |   if (!res || typeof res.count !== "number") return null;
 6892 |  495 |   return { count: res.count, raw: res.raw, dbg: res };
 6893 |  496 | }
 6894 |  497 | 
 6895 |  498 | export async function getCommentCount(page, url) {
 6896 |  499 |   log.dev("UI:photo", "Liczƒô komentarze...");
 6897 |  500 | 
 6898 |  501 |   await scrollPost(page, 220);
 6899 |  502 |   await sleepRandom(220, 420);
 6900 |  503 | 
 6901 |  504 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
 6902 |  505 |   log.debug("UI:photo", `Filtr all comments: ${okFilter}`);
 6903 |  506 | 
 6904 |  507 |   // mikro settle po filtrze (bez mulenia)
 6905 |  508 |   await sleepRandom(220, 420);
 6906 |  509 | 
 6907 |  510 |   const rootHandle = await getCommentsRootHandle(page);
 6908 |  511 | 
 6909 |  512 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
 6910 |  513 |   if (chip?.count != null) {
 6911 |  514 |     log.debug("UI:photo", "UI count (chip)", chip);
 6912 |  515 |   }
 6913 |  516 | 
 6914 |  517 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
 6915 |  518 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
 6916 |  519 | 
 6917 |  520 |   const loaded = await page
 6918 |  521 |     .evaluate((root) => {
 6919 |  522 |       const scope = root || document;
 6920 |  523 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 6921 |  524 |       const ids = new Set();
 6922 |  525 |       for (const a of as) {
 6923 |  526 |         const href = a.getAttribute("href") || "";
 6924 |  527 |         const m = href.match(/comment_id=([^&]+)/);
 6925 |  528 |         if (m && m[1]) ids.add(m[1]);
 6926 |  529 |       }
 6927 |  530 |       return ids.size || null;
 6928 |  531 |     }, rootHandle)
 6929 |  532 |     .catch(() => null);
 6930 |  533 | 
 6931 |  534 |   let total = null;
 6932 |  535 |   let source = "none";
 6933 |  536 | 
 6934 |  537 |   if (chip?.count != null) {
 6935 |  538 |     total = chip.count;
 6936 |  539 |     source = "ui-photo-chip";
 6937 |  540 |   } else if (infoCount != null) {
 6938 |  541 |     total = infoCount;
 6939 |  542 |     source = uiInfo?.source || "uicommentinfo";
 6940 |  543 |   } else if (loaded != null) {
 6941 |  544 |     total = loaded;
 6942 |  545 |     source = "loaded-comment_id";
 6943 |  546 |   }
 6944 |  547 | 
 6945 |  548 |   log.debug("UI:photo", "UI comments", {
 6946 |  549 |     source,
 6947 |  550 |     chip: chip?.count ?? null,
 6948 |  551 |     uiInfoSource: uiInfo?.source ?? null,
 6949 |  552 |     uiInfoRaw: uiInfo?.raw ?? null,
 6950 |  553 |     uiInfoCount: infoCount,
 6951 |  554 |     loaded,
 6952 |  555 |     chosen: total,
 6953 |  556 |   });
 6954 |  557 | 
 6955 |  558 |   try {
 6956 |  559 |     await rootHandle.dispose?.();
 6957 |  560 |   } catch {}
 6958 |  561 | 
 6959 |  562 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
 6960 |  563 |   await sleepRandom(180, 340);
 6961 |  564 | 
 6962 |  565 |   return total;
 6963 |  566 | }
 6964 |  567 | 
 6965 |  568 | export async function loadAllComments(page, { expectedTotal } = {}) {
 6966 |  569 |   log.dev("UI:photo", `loadAllComments expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
 6967 |  570 | 
 6968 |  571 |   const MAX_STEPS = 900;
 6969 |  572 |   const MAX_NO_PROGRESS = 28;
 6970 |  573 | 
 6971 |  574 |   let noProgress = 0;
 6972 |  575 | 
 6973 |  576 |   const rootHandle = await getCommentsRootHandle(page);
 6974 |  577 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
 6975 |  578 | 
 6976 |  579 |   const shortBtn = (t) => {
 6977 |  580 |     const s = String(t || "").replace(/\s+/g, " ").trim();
 6978 |  581 |     if (s.length <= 90) return s;
 6979 |  582 |     return s.slice(0, 90) + "‚Ä¶";
 6980 |  583 |   };
 6981 |  584 | 
 6982 |  585 |   async function countAnchors() {
 6983 |  586 |     return page.evaluate((root) => {
 6984 |  587 |       const scope = root || document;
 6985 |  588 | 
 6986 |  589 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
 6987 |  590 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
 6988 |  591 | 
 6989 |  592 |       const uniq = (arr, param) => {
 6990 |  593 |         const ids = new Set();
 6991 |  594 |         for (const a of arr) {
 6992 |  595 |           const href = a.getAttribute("href") || "";
 6993 |  596 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
 6994 |  597 |           if (m && m[1]) ids.add(m[1]);
 6995 |  598 |         }
 6996 |  599 |         return ids.size;
 6997 |  600 |       };
 6998 |  601 | 
 6999 |  602 |       return {
 7000 |  603 |         commentsAnchors: uniq(commentAs, "comment_id"),
 7001 |  604 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
 7002 |  605 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
 7003 |  606 |       };
 7004 |  607 |     }, rootHandle);
 7005 |  608 |   }
 7006 |  609 | 
 7007 |  610 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
 7008 |  611 |     try {
 7009 |  612 |       const info = await page.evaluate((root, scroller, px) => {
 7010 |  613 |         const pick =
 7011 |  614 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
 7012 |  615 | 
 7013 |  616 |         const before =
 7014 |  617 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 7015 |  618 | 
 7016 |  619 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
 7017 |  620 |         else window.scrollBy(0, px);
 7018 |  621 | 
 7019 |  622 |         const after =
 7020 |  623 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
 7021 |  624 | 
 7022 |  625 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
 7023 |  626 |       }, rootHandle, scrollHandle, pixels);
 7024 |  627 | 
 7025 |  628 |       if (!info?.moved) {
 7026 |  629 |         log.debug("UI:photo", `Scroll NO-MOVE tag=${info?.tag} ${info?.before}‚Üí${info?.after}`);
 7027 |  630 |       }
 7028 |  631 |     } catch {
 7029 |  632 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
 7030 |  633 |     }
 7031 |  634 | 
 7032 |  635 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
 7033 |  636 |   }
 7034 |  637 | 
 7035 |  638 |   async function getScrollMetrics() {
 7036 |  639 |     return page.evaluate((root, scroller) => {
 7037 |  640 |       const pick =
 7038 |  641 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 7039 |  642 | 
 7040 |  643 |       const isEl = pick && typeof pick.scrollHeight === "number";
 7041 |  644 | 
 7042 |  645 |       if (!isEl) {
 7043 |  646 |         const se = document.scrollingElement || document.documentElement || document.body;
 7044 |  647 |         return {
 7045 |  648 |           tag: "WINDOW",
 7046 |  649 |           scrollTop: window.scrollY || 0,
 7047 |  650 |           scrollHeight: se?.scrollHeight || 0,
 7048 |  651 |           clientHeight: window.innerHeight || 0,
 7049 |  652 |         };
 7050 |  653 |       }
 7051 |  654 | 
 7052 |  655 |       return {
 7053 |  656 |         tag: pick.tagName || "UNKNOWN",
 7054 |  657 |         scrollTop: pick.scrollTop || 0,
 7055 |  658 |         scrollHeight: pick.scrollHeight || 0,
 7056 |  659 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
 7057 |  660 |       };
 7058 |  661 |     }, rootHandle, scrollHandle);
 7059 |  662 |   }
 7060 |  663 | 
 7061 |  664 |   async function hasLoadMoreButtons() {
 7062 |  665 |     return page.evaluate((root) => {
 7063 |  666 |       const scope = root || document;
 7064 |  667 | 
 7065 |  668 |       const norm = (s) =>
 7066 |  669 |         String(s || "")
 7067 |  670 |           .replace(/\u00a0/g, " ")
 7068 |  671 |           .replace(/\s+/g, " ")
 7069 |  672 |           .trim()
 7070 |  673 |           .toLowerCase();
 7071 |  674 | 
 7072 |  675 |       const isVisible = (el) => {
 7073 |  676 |         if (!el) return false;
 7074 |  677 |         const r = el.getBoundingClientRect();
 7075 |  678 |         if (r.width < 2 || r.height < 2) return false;
 7076 |  679 |         return r.bottom > 0 && r.top < window.innerHeight;
 7077 |  680 |       };
 7078 |  681 | 
 7079 |  682 |       const nodesBtn = Array.from(
 7080 |  683 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 7081 |  684 |       ).filter(isVisible);
 7082 |  685 | 
 7083 |  686 |       return nodesBtn.some((el) => {
 7084 |  687 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7085 |  688 | 
 7086 |  689 |         if (
 7087 |  690 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 7088 |  691 |           t.includes("zobacz wiƒôcej komentarzy") ||
 7089 |  692 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 7090 |  693 |           t.includes("view more comments") ||
 7091 |  694 |           t.includes("view previous comments")
 7092 |  695 |         )
 7093 |  696 |           return true;
 7094 |  697 | 
 7095 |  698 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 7096 |  699 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 7097 |  700 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 7098 |  701 |         if (t.includes("view") && t.includes("repl")) return true;
 7099 |  702 |         if (t.includes("see") && t.includes("repl")) return true;
 7100 |  703 | 
 7101 |  704 |         return false;
 7102 |  705 |       });
 7103 |  706 |     }, rootHandle);
 7104 |  707 |   }
 7105 |  708 | 
 7106 |  709 |   function isHardBottom(m) {
 7107 |  710 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
 7108 |  711 |     const top = Number(m?.scrollTop || 0);
 7109 |  712 |     const ch = Number(m?.clientHeight || 0);
 7110 |  713 |     const sh = Number(m?.scrollHeight || 0);
 7111 |  714 |     if (!sh || !ch) return false;
 7112 |  715 |     return top + ch >= sh - eps;
 7113 |  716 |   }
 7114 |  717 | 
 7115 |  718 |   let bottomStable = 0;
 7116 |  719 |   let lastBottomScrollHeight = null;
 7117 |  720 | 
 7118 |  721 |   async function updateHardBottomStability() {
 7119 |  722 |     const m1 = await getScrollMetrics().catch(() => null);
 7120 |  723 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
 7121 |  724 | 
 7122 |  725 |     const atBottom = isHardBottom(m1);
 7123 |  726 | 
 7124 |  727 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
 7125 |  728 | 
 7126 |  729 |     const m2 = await getScrollMetrics().catch(() => m1);
 7127 |  730 |     const atBottom2 = isHardBottom(m2);
 7128 |  731 | 
 7129 |  732 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
 7130 |  733 | 
 7131 |  734 |     const sh = Number(m2?.scrollHeight || 0);
 7132 |  735 |     const shStable =
 7133 |  736 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
 7134 |  737 | 
 7135 |  738 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
 7136 |  739 |     else bottomStable = 0;
 7137 |  740 | 
 7138 |  741 |     lastBottomScrollHeight = sh;
 7139 |  742 | 
 7140 |  743 |     return {
 7141 |  744 |       atBottom: atBottom && atBottom2,
 7142 |  745 |       stable: bottomStable,
 7143 |  746 |       tag: m2?.tag || "UNKNOWN",
 7144 |  747 |       anyMore,
 7145 |  748 |       scrollTop: m2?.scrollTop,
 7146 |  749 |       clientHeight: m2?.clientHeight,
 7147 |  750 |       scrollHeight: m2?.scrollHeight,
 7148 |  751 |     };
 7149 |  752 |   }
 7150 |  753 | 
 7151 |  754 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
 7152 |  755 |   async function waitForEffect(beforeCounts, kind) {
 7153 |  756 |     const timeout = PACE_CFG.effectWaitMs;
 7154 |  757 | 
 7155 |  758 |     const ok = await page
 7156 |  759 |       .waitForFunction(
 7157 |  760 |         (root, before, kindArg) => {
 7158 |  761 |           const scope = root || document;
 7159 |  762 | 
 7160 |  763 |           const countUniq = (sel, param) => {
 7161 |  764 |             const as = Array.from(scope.querySelectorAll(sel));
 7162 |  765 |             const ids = new Set();
 7163 |  766 |             for (const a of as) {
 7164 |  767 |               const href = a.getAttribute("href") || "";
 7165 |  768 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
 7166 |  769 |               if (m && m[1]) ids.add(m[1]);
 7167 |  770 |             }
 7168 |  771 |             return ids.size;
 7169 |  772 |           };
 7170 |  773 | 
 7171 |  774 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
 7172 |  775 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
 7173 |  776 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
 7174 |  777 | 
 7175 |  778 |           if (
 7176 |  779 |             commentsAnchors > (before?.commentsAnchors || 0) ||
 7177 |  780 |             replyAnchors > (before?.replyAnchors || 0) ||
 7178 |  781 |             nodes > (before?.nodes || 0)
 7179 |  782 |           ) {
 7180 |  783 |             return true;
 7181 |  784 |           }
 7182 |  785 | 
 7183 |  786 |           const norm = (s) =>
 7184 |  787 |             String(s || "")
 7185 |  788 |               .replace(/\u00a0/g, " ")
 7186 |  789 |               .replace(/\s+/g, " ")
 7187 |  790 |               .trim()
 7188 |  791 |               .toLowerCase();
 7189 |  792 | 
 7190 |  793 |           const isVisible = (el) => {
 7191 |  794 |             if (!el) return false;
 7192 |  795 |             const r = el.getBoundingClientRect();
 7193 |  796 |             if (r.width < 2 || r.height < 2) return false;
 7194 |  797 |             return r.bottom > 0 && r.top < window.innerHeight;
 7195 |  798 |           };
 7196 |  799 | 
 7197 |  800 |           const nodesBtn = Array.from(
 7198 |  801 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
 7199 |  802 |           ).filter(isVisible);
 7200 |  803 | 
 7201 |  804 |           const stillThere =
 7202 |  805 |             kindArg === "comments"
 7203 |  806 |               ? nodesBtn.some((el) => {
 7204 |  807 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7205 |  808 |                   return (
 7206 |  809 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 7207 |  810 |                     t.includes("zobacz wiƒôcej komentarzy") ||
 7208 |  811 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
 7209 |  812 |                     t.includes("view more comments") ||
 7210 |  813 |                     t.includes("view previous comments")
 7211 |  814 |                   );
 7212 |  815 |                 })
 7213 |  816 |               : nodesBtn.some((el) => {
 7214 |  817 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7215 |  818 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 7216 |  819 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 7217 |  820 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
 7218 |  821 |                   if (t.includes("view") && t.includes("repl")) return true;
 7219 |  822 |                   if (t.includes("see") && t.includes("repl")) return true;
 7220 |  823 |                   return false;
 7221 |  824 |                 });
 7222 |  825 | 
 7223 |  826 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
 7224 |  827 |           return !stillThere;
 7225 |  828 |         },
 7226 |  829 |         { timeout, polling: 120 },
 7227 |  830 |         rootHandle,
 7228 |  831 |         beforeCounts,
 7229 |  832 |         kind
 7230 |  833 |       )
 7231 |  834 |       .then(() => true)
 7232 |  835 |       .catch(() => false);
 7233 |  836 | 
 7234 |  837 |     return ok;
 7235 |  838 |   }
 7236 |  839 | 
 7237 |  840 |   async function bonusClicks(kind, beforeCounts) {
 7238 |  841 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
 7239 |  842 |     if (!tries) return 0;
 7240 |  843 | 
 7241 |  844 |     let clicked = 0;
 7242 |  845 |     let curBefore = beforeCounts;
 7243 |  846 | 
 7244 |  847 |     for (let i = 0; i < tries; i++) {
 7245 |  848 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
 7246 |  849 | 
 7247 |  850 |       const res =
 7248 |  851 |         kind === "replies"
 7249 |  852 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
 7250 |  853 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 7251 |  854 | 
 7252 |  855 |       if (!res?.clicked) break;
 7253 |  856 | 
 7254 |  857 |       clicked++;
 7255 |  858 | 
 7256 |  859 |       // mikro-oddech, potem czekamy na efekt
 7257 |  860 |       await sleepRandom(80, 140);
 7258 |  861 |       await waitForEffect(curBefore, kind);
 7259 |  862 | 
 7260 |  863 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
 7261 |  864 |       curBefore = await countAnchors().catch(() => curBefore);
 7262 |  865 | 
 7263 |  866 |       // minimalny settle po do≈Çadowaniu
 7264 |  867 |       await sleepRandom(90, 170);
 7265 |  868 |     }
 7266 |  869 | 
 7267 |  870 |     return clicked;
 7268 |  871 |   }
 7269 |  872 | 
 7270 |  873 |     async function clickOneReplyButton() {
 7271 |  874 |     const res = await page.evaluate((root) => {
 7272 |  875 |       const scope = root || document;
 7273 |  876 | 
 7274 |  877 |       const norm = (s) =>
 7275 |  878 |         String(s || "")
 7276 |  879 |           .replace(/\u00a0/g, " ")
 7277 |  880 |           .replace(/\s+/g, " ")
 7278 |  881 |           .trim()
 7279 |  882 |           .toLowerCase();
 7280 |  883 | 
 7281 |  884 |       const isVisible = (el) => {
 7282 |  885 |         if (!el) return false;
 7283 |  886 |         try {
 7284 |  887 |           const r = el.getBoundingClientRect();
 7285 |  888 |           if (r.width < 2 || r.height < 2) return false;
 7286 |  889 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
 7287 |  890 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
 7288 |  891 |         } catch {
 7289 |  892 |           return true;
 7290 |  893 |         }
 7291 |  894 |       };
 7292 |  895 | 
 7293 |  896 |       const isReplyExpanderText = (t) => {
 7294 |  897 |         if (!t) return false;
 7295 |  898 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 7296 |  899 |         if (t.length > 220) return false;
 7297 |  900 | 
 7298 |  901 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
 7299 |  902 |         if (t === "odpowiedz" || t === "reply") return false;
 7300 |  903 |         if (t.startsWith("odpowiedz ")) return false;
 7301 |  904 |         if (t.startsWith("reply ")) return false;
 7302 |  905 | 
 7303 |  906 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
 7304 |  907 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 7305 |  908 | 
 7306 |  909 |         // warianty opisowe
 7307 |  910 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 7308 |  911 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 7309 |  912 |         if (t.includes("view") && t.includes("repl")) return true;
 7310 |  913 |         if (t.includes("see") && t.includes("repl")) return true;
 7311 |  914 | 
 7312 |  915 |         return false;
 7313 |  916 |       };
 7314 |  917 | 
 7315 |  918 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
 7316 |  919 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
 7317 |  920 |       const allTextCandidates = Array.from(
 7318 |  921 |         scope.querySelectorAll("a,button,div,span")
 7319 |  922 |       )
 7320 |  923 |         .filter(isVisible)
 7321 |  924 |         .slice(0, 35000);
 7322 |  925 | 
 7323 |  926 |       let best = null;
 7324 |  927 |       let bestScore = -Infinity;
 7325 |  928 | 
 7326 |  929 |       for (const el of allTextCandidates) {
 7327 |  930 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
 7328 |  931 |         const t = norm(tRaw);
 7329 |  932 |         if (!isReplyExpanderText(t)) continue;
 7330 |  933 | 
 7331 |  934 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
 7332 |  935 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 7333 |  936 |         if (t.includes("udost") || t.includes("share")) continue;
 7334 |  937 | 
 7335 |  938 |         const r = el.getBoundingClientRect();
 7336 |  939 |         let score = 0;
 7337 |  940 | 
 7338 |  941 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
 7339 |  942 |         score += Math.max(0, r.top);
 7340 |  943 | 
 7341 |  944 |         // preferuj te z liczbƒÖ odpowiedzi
 7342 |  945 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
 7343 |  946 | 
 7344 |  947 |         // preferuj ‚Äúwszystkie/all‚Äù
 7345 |  948 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
 7346 |  949 | 
 7347 |  950 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
 7348 |  951 |         score -= Math.min(500, t.length * 3);
 7349 |  952 | 
 7350 |  953 |         if (score > bestScore) {
 7351 |  954 |           bestScore = score;
 7352 |  955 |           best = el;
 7353 |  956 |         }
 7354 |  957 |       }
 7355 |  958 | 
 7356 |  959 |       if (!best) return { clicked: false };
 7357 |  960 | 
 7358 |  961 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
 7359 |  962 |       const clickable =
 7360 |  963 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
 7361 |  964 | 
 7362 |  965 |       try {
 7363 |  966 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 7364 |  967 |       } catch {}
 7365 |  968 | 
 7366 |  969 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 7367 |  970 | 
 7368 |  971 |       const hardClick = (node) => {
 7369 |  972 |         try {
 7370 |  973 |           node.click();
 7371 |  974 |           return true;
 7372 |  975 |         } catch {}
 7373 |  976 |         try {
 7374 |  977 |           const r = node.getBoundingClientRect();
 7375 |  978 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
 7376 |  979 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
 7377 |  980 |           const target = document.elementFromPoint(x, y) || node;
 7378 |  981 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
 7379 |  982 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
 7380 |  983 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
 7381 |  984 |           return true;
 7382 |  985 |         } catch {}
 7383 |  986 |         return false;
 7384 |  987 |       };
 7385 |  988 | 
 7386 |  989 |       const ok = hardClick(clickable);
 7387 |  990 |       return { clicked: ok, text: txt };
 7388 |  991 |     }, rootHandle);
 7389 |  992 | 
 7390 |  993 |     return res || { clicked: false };
 7391 |  994 |   }
 7392 |  995 | 
 7393 |  996 | 
 7394 |  997 |   async function clickMoreCommentsButton() {
 7395 |  998 |     const res = await page.evaluate((root) => {
 7396 |  999 |       const scope = root || document;
 7397 | 1000 | 
 7398 | 1001 |       const norm = (s) =>
 7399 | 1002 |         String(s || "")
 7400 | 1003 |           .replace(/\u00a0/g, " ")
 7401 | 1004 |           .replace(/\s+/g, " ")
 7402 | 1005 |           .trim()
 7403 | 1006 |           .toLowerCase();
 7404 | 1007 | 
 7405 | 1008 |       const isVisible = (el) => {
 7406 | 1009 |         if (!el) return false;
 7407 | 1010 |         const r = el.getBoundingClientRect();
 7408 | 1011 |         if (r.width < 2 || r.height < 2) return false;
 7409 | 1012 |         return r.bottom > 0 && r.top < window.innerHeight;
 7410 | 1013 |       };
 7411 | 1014 | 
 7412 | 1015 |       const isMore = (t) => {
 7413 | 1016 |         if (!t) return false;
 7414 | 1017 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 7415 | 1018 |         if (t.length > 140) return false;
 7416 | 1019 | 
 7417 | 1020 |         return (
 7418 | 1021 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 7419 | 1022 |           t.includes("zobacz wiƒôcej komentarzy") ||
 7420 | 1023 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
 7421 | 1024 |           t.includes("view more comments") ||
 7422 | 1025 |           t.includes("view previous comments")
 7423 | 1026 |         );
 7424 | 1027 |       };
 7425 | 1028 | 
 7426 | 1029 |       const candidates = Array.from(
 7427 | 1030 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
 7428 | 1031 |       ).filter(isVisible);
 7429 | 1032 | 
 7430 | 1033 |       let best = null;
 7431 | 1034 |       let bestY = -1;
 7432 | 1035 | 
 7433 | 1036 |       for (const el of candidates) {
 7434 | 1037 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7435 | 1038 |         if (!isMore(t)) continue;
 7436 | 1039 |         const r = el.getBoundingClientRect();
 7437 | 1040 |         if (r.top > bestY) {
 7438 | 1041 |           bestY = r.top;
 7439 | 1042 |           best = el;
 7440 | 1043 |         }
 7441 | 1044 |       }
 7442 | 1045 | 
 7443 | 1046 |       if (!best) return { clicked: false };
 7444 | 1047 | 
 7445 | 1048 |       try {
 7446 | 1049 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
 7447 | 1050 |       } catch {}
 7448 | 1051 | 
 7449 | 1052 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
 7450 | 1053 | 
 7451 | 1054 |       try {
 7452 | 1055 |         best.click();
 7453 | 1056 |         return { clicked: true, text: txt };
 7454 | 1057 |       } catch {
 7455 | 1058 |         return { clicked: false, text: txt };
 7456 | 1059 |       }
 7457 | 1060 |     }, rootHandle);
 7458 | 1061 | 
 7459 | 1062 |     return res || { clicked: false };
 7460 | 1063 |   }
 7461 | 1064 | 
 7462 | 1065 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
 7463 | 1066 | 
 7464 | 1067 |   async function hasAnyReplyExpanders(page, rootHandle) {
 7465 | 1068 |     return page.evaluate((root) => {
 7466 | 1069 |       const scope = root || document;
 7467 | 1070 | 
 7468 | 1071 |       const norm = (s) =>
 7469 | 1072 |         String(s || "")
 7470 | 1073 |           .replace(/\u00a0/g, " ")
 7471 | 1074 |           .replace(/\s+/g, " ")
 7472 | 1075 |           .trim()
 7473 | 1076 |           .toLowerCase();
 7474 | 1077 | 
 7475 | 1078 |       const isVisible = (el) => {
 7476 | 1079 |         if (!el) return false;
 7477 | 1080 |         try {
 7478 | 1081 |           const r = el.getBoundingClientRect();
 7479 | 1082 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
 7480 | 1083 |         } catch {
 7481 | 1084 |           return true;
 7482 | 1085 |         }
 7483 | 1086 |       };
 7484 | 1087 | 
 7485 | 1088 |       const isReplyExpanderText = (t) => {
 7486 | 1089 |         if (!t) return false;
 7487 | 1090 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 7488 | 1091 |         if (t.length > 220) return false;
 7489 | 1092 | 
 7490 | 1093 |         if (t === "odpowiedz" || t === "reply") return false;
 7491 | 1094 |         if (t.startsWith("odpowiedz ")) return false;
 7492 | 1095 |         if (t.startsWith("reply ")) return false;
 7493 | 1096 | 
 7494 | 1097 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 7495 | 1098 | 
 7496 | 1099 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 7497 | 1100 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
 7498 | 1101 |         if (t.includes("view") && t.includes("repl")) return true;
 7499 | 1102 |         if (t.includes("see") && t.includes("repl")) return true;
 7500 | 1103 | 
 7501 | 1104 |         return false;
 7502 | 1105 |       };
 7503 | 1106 | 
 7504 | 1107 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
 7505 | 1108 | 
 7506 | 1109 |       for (const el of nodes) {
 7507 | 1110 |         if (!isVisible(el)) continue;
 7508 | 1111 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7509 | 1112 |         if (!t) continue;
 7510 | 1113 | 
 7511 | 1114 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
 7512 | 1115 |         if (t.includes("udost") || t.includes("share")) continue;
 7513 | 1116 | 
 7514 | 1117 |         if (isReplyExpanderText(t)) return true;
 7515 | 1118 |       }
 7516 | 1119 | 
 7517 | 1120 |       return false;
 7518 | 1121 |     }, rootHandle);
 7519 | 1122 |   }
 7520 | 1123 | 
 7521 | 1124 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
 7522 | 1125 |     const res = await page.evaluate(
 7523 | 1126 |       (root, limit) => {
 7524 | 1127 |         const scope = root || document;
 7525 | 1128 | 
 7526 | 1129 |         const norm = (s) =>
 7527 | 1130 |           String(s || "")
 7528 | 1131 |             .replace(/\u00a0/g, " ")
 7529 | 1132 |             .replace(/\s+/g, " ")
 7530 | 1133 |             .trim()
 7531 | 1134 |             .toLowerCase();
 7532 | 1135 | 
 7533 | 1136 |         const isVisible = (el) => {
 7534 | 1137 |           if (!el) return false;
 7535 | 1138 |           try {
 7536 | 1139 |             const r = el.getBoundingClientRect();
 7537 | 1140 |             if (r.width < 2 || r.height < 2) return false;
 7538 | 1141 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
 7539 | 1142 |           } catch {
 7540 | 1143 |             return true;
 7541 | 1144 |           }
 7542 | 1145 |         };
 7543 | 1146 | 
 7544 | 1147 |         const isReplyExpanderText = (t) => {
 7545 | 1148 |           if (!t) return false;
 7546 | 1149 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
 7547 | 1150 |           if (t.length > 220) return false;
 7548 | 1151 | 
 7549 | 1152 |           if (t === "odpowiedz" || t === "reply") return false;
 7550 | 1153 |           if (t.startsWith("odpowiedz ")) return false;
 7551 | 1154 |           if (t.startsWith("reply ")) return false;
 7552 | 1155 | 
 7553 | 1156 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
 7554 | 1157 | 
 7555 | 1158 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
 7556 | 1159 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
 7557 | 1160 |           if (t.includes("view") && t.includes("repl")) return true;
 7558 | 1161 |           if (t.includes("see") && t.includes("repl")) return true;
 7559 | 1162 | 
 7560 | 1163 |           return false;
 7561 | 1164 |         };
 7562 | 1165 | 
 7563 | 1166 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
 7564 | 1167 |           .filter(isVisible)
 7565 | 1168 |           .slice(0, 35000)
 7566 | 1169 |           .map((el) => {
 7567 | 1170 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
 7568 | 1171 |             return { el, t };
 7569 | 1172 |           })
 7570 | 1173 |           .filter((x) => {
 7571 | 1174 |             if (!x.t) return false;
 7572 | 1175 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
 7573 | 1176 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
 7574 | 1177 |             return isReplyExpanderText(x.t);
 7575 | 1178 |           });
 7576 | 1179 | 
 7577 | 1180 |         // preferuj elementy ni≈ºej w widoku
 7578 | 1181 |         candidates.sort((a, b) => {
 7579 | 1182 |           const ra = a.el.getBoundingClientRect();
 7580 | 1183 |           const rb = b.el.getBoundingClientRect();
 7581 | 1184 |           return rb.top - ra.top;
 7582 | 1185 |         });
 7583 | 1186 | 
 7584 | 1187 |         const hardClick = (node) => {
 7585 | 1188 |           try {
 7586 | 1189 |             node.click();
 7587 | 1190 |             return true;
 7588 | 1191 |           } catch {}
 7589 | 1192 |           try {
 7590 | 1193 |             const r = node.getBoundingClientRect();
 7591 | 1194 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
 7592 | 1195 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
 7593 | 1196 |             const target = document.elementFromPoint(x, y) || node;
 7594 | 1197 |             target.dispatchEvent(
 7595 | 1198 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
 7596 | 1199 |             );
 7597 | 1200 |             target.dispatchEvent(
 7598 | 1201 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
 7599 | 1202 |             );
 7600 | 1203 |             target.dispatchEvent(
 7601 | 1204 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
 7602 | 1205 |             );
 7603 | 1206 |             return true;
 7604 | 1207 |           } catch {}
 7605 | 1208 |           return false;
 7606 | 1209 |         };
 7607 | 1210 | 
 7608 | 1211 |         let clicked = 0;
 7609 | 1212 |         const sample = [];
 7610 | 1213 | 
 7611 | 1214 |         for (const item of candidates) {
 7612 | 1215 |           if (clicked >= limit) break;
 7613 | 1216 | 
 7614 | 1217 |           const clickable =
 7615 | 1218 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
 7616 | 1219 | 
 7617 | 1220 |           try {
 7618 | 1221 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 7619 | 1222 |           } catch {}
 7620 | 1223 | 
 7621 | 1224 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
 7622 | 1225 | 
 7623 | 1226 |           const ok = hardClick(clickable);
 7624 | 1227 |           if (ok) {
 7625 | 1228 |             clicked++;
 7626 | 1229 |             if (sample.length < 5) sample.push(txt);
 7627 | 1230 |           }
 7628 | 1231 |         }
 7629 | 1232 | 
 7630 | 1233 |         return { clicked, sample };
 7631 | 1234 |       },
 7632 | 1235 |       rootHandle,
 7633 | 1236 |       maxPerPass
 7634 | 1237 |     );
 7635 | 1238 | 
 7636 | 1239 |     return res || { clicked: 0, sample: [] };
 7637 | 1240 |   }
 7638 | 1241 | 
 7639 | 1242 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
 7640 | 1243 |     await page.evaluate((root, scroller) => {
 7641 | 1244 |       const pick =
 7642 | 1245 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
 7643 | 1246 | 
 7644 | 1247 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
 7645 | 1248 |       else window.scrollTo(0, 0);
 7646 | 1249 |     }, rootHandle, scrollHandle);
 7647 | 1250 |   }
 7648 | 1251 | 
 7649 | 1252 |   async function sweepRepliesTopDown(
 7650 | 1253 |     page,
 7651 | 1254 |     rootHandle,
 7652 | 1255 |     scrollHandle,
 7653 | 1256 |     {
 7654 | 1257 |       maxPasses = 3,
 7655 | 1258 |       stepsPerPass = 40,
 7656 | 1259 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
 7657 | 1260 |       maxClicksPerStep = 12,
 7658 | 1261 |     } = {}
 7659 | 1262 |   ) {
 7660 | 1263 |     let totalClicked = 0;
 7661 | 1264 | 
 7662 | 1265 |     for (let pass = 1; pass <= maxPasses; pass++) {
 7663 | 1266 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
 7664 | 1267 |       await sleepRandom(140, 240);
 7665 | 1268 | 
 7666 | 1269 |       let staleSteps = 0;
 7667 | 1270 | 
 7668 | 1271 |       for (let step = 1; step <= stepsPerPass; step++) {
 7669 | 1272 |         const before = await countAnchors().catch(() => null);
 7670 | 1273 | 
 7671 | 1274 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
 7672 | 1275 |           () => ({ clicked: 0, sample: [] })
 7673 | 1276 |         );
 7674 | 1277 | 
 7675 | 1278 |         if (r.clicked > 0) {
 7676 | 1279 |           totalClicked += r.clicked;
 7677 | 1280 | 
 7678 | 1281 |           if (before) {
 7679 | 1282 |             await sleepRandom(60, 120);
 7680 | 1283 |             await waitForEffect(before, "replies");
 7681 | 1284 |           }
 7682 | 1285 | 
 7683 | 1286 |           await sleepRandom(90, 160);
 7684 | 1287 |           staleSteps = 0;
 7685 | 1288 |         } else {
 7686 | 1289 |           staleSteps++;
 7687 | 1290 |         }
 7688 | 1291 | 
 7689 | 1292 |         const m1 = await getScrollMetrics().catch(() => null);
 7690 | 1293 |         await gentleScrollKick(scrollPx);
 7691 | 1294 |         const m2 = await getScrollMetrics().catch(() => null);
 7692 | 1295 | 
 7693 | 1296 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
 7694 | 1297 | 
 7695 | 1298 |         if (!moved && staleSteps >= 4) break;
 7696 | 1299 |         if (staleSteps >= 8) break;
 7697 | 1300 |       }
 7698 | 1301 | 
 7699 | 1302 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
 7700 | 1303 |       if (!any) break;
 7701 | 1304 |     }
 7702 | 1305 | 
 7703 | 1306 |     return totalClicked;
 7704 | 1307 |   }
 7705 | 1308 | 
 7706 | 1309 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
 7707 | 1310 |   let lastLogAt = 0;
 7708 | 1311 |   let lastLogKey = "";
 7709 | 1312 |   const LOG_EVERY_N_STEPS = 6;
 7710 | 1313 |   const LOG_MIN_MS = 800;
 7711 | 1314 |   const shouldLog = (step, key, force = false) => {
 7712 | 1315 |     const now = Date.now();
 7713 | 1316 |     if (force) {
 7714 | 1317 |       lastLogAt = now;
 7715 | 1318 |       lastLogKey = key;
 7716 | 1319 |       return true;
 7717 | 1320 |     }
 7718 | 1321 |     if (step % LOG_EVERY_N_STEPS === 0) {
 7719 | 1322 |       lastLogAt = now;
 7720 | 1323 |       lastLogKey = key;
 7721 | 1324 |       return true;
 7722 | 1325 |     }
 7723 | 1326 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
 7724 | 1327 |       lastLogAt = now;
 7725 | 1328 |       lastLogKey = key;
 7726 | 1329 |       return true;
 7727 | 1330 |     }
 7728 | 1331 |     return false;
 7729 | 1332 |   };
 7730 | 1333 | 
 7731 | 1334 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
 7732 | 1335 |   log.debug("UI:photo", "startCounts", cur);
 7733 | 1336 | 
 7734 | 1337 |   for (let step = 1; step <= MAX_STEPS; step++) {
 7735 | 1338 |     const before = cur;
 7736 | 1339 |     let action = "scroll";
 7737 | 1340 |     let clickInfo = null;
 7738 | 1341 |     let effectOk = false;
 7739 | 1342 |     let bonus = 0;
 7740 | 1343 | 
 7741 | 1344 |     // 1) REPLIES
 7742 | 1345 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
 7743 | 1346 |     if (r1?.clicked) {
 7744 | 1347 |       action = "replies";
 7745 | 1348 |       clickInfo = r1;
 7746 | 1349 | 
 7747 | 1350 |       await sleepRandom(80, 140);
 7748 | 1351 |       effectOk = await waitForEffect(before, "replies");
 7749 | 1352 |       await sleepRandom(90, 170);
 7750 | 1353 | 
 7751 | 1354 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
 7752 | 1355 |       if (effectOk) {
 7753 | 1356 |         bonus = await bonusClicks("replies", before);
 7754 | 1357 |       } else {
 7755 | 1358 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
 7756 | 1359 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
 7757 | 1360 |       }
 7758 | 1361 |     } else {
 7759 | 1362 |       // 2) MORE COMMENTS
 7760 | 1363 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
 7761 | 1364 |       if (c1?.clicked) {
 7762 | 1365 |         action = "comments";
 7763 | 1366 |         clickInfo = c1;
 7764 | 1367 | 
 7765 | 1368 |         await sleepRandom(80, 140);
 7766 | 1369 |         effectOk = await waitForEffect(before, "comments");
 7767 | 1370 |         await sleepRandom(90, 170);
 7768 | 1371 | 
 7769 | 1372 |         if (effectOk) {
 7770 | 1373 |           bonus = await bonusClicks("comments", before);
 7771 | 1374 |         } else {
 7772 | 1375 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
 7773 | 1376 |         }
 7774 | 1377 |       } else {
 7775 | 1378 |         // 3) SCROLL
 7776 | 1379 |         action = "scroll";
 7777 | 1380 |         await gentleScrollKick(PACE_CFG.scrollPx);
 7778 | 1381 |       }
 7779 | 1382 |     }
 7780 | 1383 | 
 7781 | 1384 |     cur = await countAnchors().catch(() => before);
 7782 | 1385 | 
 7783 | 1386 |     const progressed =
 7784 | 1387 |       cur.commentsAnchors > before.commentsAnchors ||
 7785 | 1388 |       cur.replyAnchors > before.replyAnchors ||
 7786 | 1389 |       cur.nodes > before.nodes;
 7787 | 1390 | 
 7788 | 1391 |     if (!progressed) noProgress++;
 7789 | 1392 |     else noProgress = 0;
 7790 | 1393 | 
 7791 | 1394 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
 7792 | 1395 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
 7793 | 1396 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
 7794 | 1397 |     if (shouldCheckHB) {
 7795 | 1398 |       hb = await updateHardBottomStability().catch(() => ({
 7796 | 1399 |         atBottom: false,
 7797 | 1400 |         stable: bottomStable,
 7798 | 1401 |         tag: "NA",
 7799 | 1402 |         anyMore: true,
 7800 | 1403 |       }));
 7801 | 1404 |     }
 7802 | 1405 | 
 7803 | 1406 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
 7804 | 1407 |     const key =
 7805 | 1408 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
 7806 | 1409 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
 7807 | 1410 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
 7808 | 1411 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
 7809 | 1412 | 
 7810 | 1413 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
 7811 | 1414 |     if (shouldLog(step, key, forceLog)) {
 7812 | 1415 |       log.debug("UI:photo", `step=${step} ${action} cA ${before.commentsAnchors}‚Üí${cur.commentsAnchors} rA ${before.replyAnchors}‚Üí${cur.replyAnchors} np=${noProgress}/${MAX_NO_PROGRESS}`);
 7813 | 1416 |     }
 7814 | 1417 | 
 7815 | 1418 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
 7816 | 1419 |       log.debug("UI:photo", "Stop: hard-bottom-stable");
 7817 | 1420 |       break;
 7818 | 1421 |     }
 7819 | 1422 | 
 7820 | 1423 |     if (noProgress >= MAX_NO_PROGRESS) {
 7821 | 1424 |       log.debug("UI:photo", "Stop: too many no-progress steps");
 7822 | 1425 |       break;
 7823 | 1426 |     }
 7824 | 1427 | 
 7825 | 1428 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
 7826 | 1429 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
 7827 | 1430 |   }
 7828 | 1431 | 
 7829 | 1432 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
 7830 | 1433 |   let final = await countAnchors().catch(() => cur);
 7831 | 1434 |   log.debug("UI:photo", "Done", final);
 7832 | 1435 | 
 7833 | 1436 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
 7834 | 1437 |   if (needSweep) {
 7835 | 1438 |     log.debug("UI:photo", "Sweep: reply expanders -> top-down...");
 7836 | 1439 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
 7837 | 1440 |     log.debug("UI:photo", `Sweep: clicked=${clicked}`);
 7838 | 1441 |     final = await countAnchors().catch(() => final);
 7839 | 1442 |     log.debug("UI:photo", "After sweep", final);
 7840 | 1443 |   } else {
 7841 | 1444 |     log.debug("UI:photo", "Sweep: brak reply expanders");
 7842 | 1445 |   }
 7843 | 1446 | 
 7844 | 1447 |   try {
 7845 | 1448 |     await scrollHandle.dispose?.();
 7846 | 1449 |   } catch {}
 7847 | 1450 |   try {
 7848 | 1451 |     await rootHandle.dispose?.();
 7849 | 1452 |   } catch {}
 7850 | 1453 | }
 7851 | 1454 | 
 7852 | 1455 | /* =====================
 7853 | 1456 |    Analiza za≈Ço≈ºe≈Ñ
 7854 | 1457 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
 7855 | 1458 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
 7856 | 1459 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
 7857 | 1460 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
 7858 | 1461 | 
 7859 | 1462 |    Co powiedzia≈Çby sceptyk?
 7860 | 1463 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
 7861 | 1464 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
 7862 | 1465 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
 7863 | 1466 | 
 7864 | 1467 |    ===================== */
 7865 | 1468 | 
 7866 | ```
 7867 | 
 7868 | ---
 7869 | 
 7870 | ### üìÑ ≈öcie≈ºka: `src/fb/ui/post.js`
 7871 | **Typ:** JavaScript/tekst  
 7872 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 7873 | 
 7874 | ```js
 7875 |    1 | // src/fb/ui/post.js
 7876 |    2 | import { EXPAND_COMMENTS } from "../../config.js";
 7877 |    3 | import { sleepRandom } from "../../utils/sleep.js";
 7878 |    4 | import { safeGoto } from "../../utils/navigation.js";
 7879 |    5 | import log from "../../utils/logger.js";
 7880 |    6 | 
 7881 |    7 | import { scrollPost } from "../scroll.js";
 7882 |    8 | import { acceptCookies, saveCookies } from "../cookies.js";
 7883 |    9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
 7884 |   10 | import { clickOneExpandButton } from "../expandButtons.js";
 7885 |   11 | 
 7886 |   12 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
 7887 |   13 | 
 7888 |   14 | export const type = "post";
 7889 |   15 | 
 7890 |   16 | export function matchesUrl(url) {
 7891 |   17 |   if (!url) return false;
 7892 |   18 |   const u = String(url);
 7893 |   19 |   if (u.includes("/watch")) return false;
 7894 |   20 |   if (u.includes("/videos/")) return false;
 7895 |   21 |   if (u.includes("/photo")) return false;
 7896 |   22 |   if (u.includes("photo.php")) return false;
 7897 |   23 | 
 7898 |   24 |   return (
 7899 |   25 |     u.includes("/posts/") ||
 7900 |   26 |     u.includes("permalink.php") ||
 7901 |   27 |     u.includes("/story.php") ||
 7902 |   28 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
 7903 |   29 |   );
 7904 |   30 | }
 7905 |   31 | 
 7906 |   32 | /* ============================================================
 7907 |   33 |    =============== POST ROOT (DIALOG / MAIN) ===================
 7908 |   34 |    ============================================================ */
 7909 |   35 | 
 7910 |   36 | function postRootScript() {
 7911 |   37 |   return `
 7912 |   38 |     function getPostRoot() {
 7913 |   39 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
 7914 |   40 | 
 7915 |   41 |       const postDialog = dialogs.find((dlg) => {
 7916 |   42 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
 7917 |   43 |         if (!text) return false;
 7918 |   44 | 
 7919 |   45 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
 7920 |   46 |         const hasActions =
 7921 |   47 |           text.includes("lubiƒô to") ||
 7922 |   48 |           text.includes("komentarz") ||
 7923 |   49 |           text.includes("udostƒôpnij") ||
 7924 |   50 |           text.includes("write a comment") ||
 7925 |   51 |           text.includes("comment");
 7926 |   52 | 
 7927 |   53 |         const looksLikeNotifications =
 7928 |   54 |           text.startsWith("powiadomienia") &&
 7929 |   55 |           text.includes("wszystkie") &&
 7930 |   56 |           text.includes("nieprzeczytane");
 7931 |   57 | 
 7932 |   58 |         return !looksLikeNotifications && hasCommentWord && hasActions;
 7933 |   59 |       });
 7934 |   60 | 
 7935 |   61 |       if (postDialog) {
 7936 |   62 |         const art = postDialog.querySelector("article");
 7937 |   63 |         return art || postDialog;
 7938 |   64 |       }
 7939 |   65 | 
 7940 |   66 |       const main = document.querySelector("div[role='main'], main");
 7941 |   67 |       if (main) {
 7942 |   68 |         const article = main.querySelector("article");
 7943 |   69 |         return article || main;
 7944 |   70 |       }
 7945 |   71 | 
 7946 |   72 |       return document.body;
 7947 |   73 |     }
 7948 |   74 |   `;
 7949 |   75 | }
 7950 |   76 | 
 7951 |   77 | async function getPostScopeSelector(page) {
 7952 |   78 |   const scope = await page.evaluate((code) => {
 7953 |   79 |     // eslint-disable-next-line no-eval
 7954 |   80 |     eval(code);
 7955 |   81 |     // @ts-ignore
 7956 |   82 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 7957 |   83 |     if (!root) return "document";
 7958 |   84 | 
 7959 |   85 |     const dlg = root.closest("div[role='dialog']");
 7960 |   86 |     if (dlg) return "div[role='dialog']";
 7961 |   87 | 
 7962 |   88 |     const main = document.querySelector("div[role='main'], main");
 7963 |   89 |     if (main) return "div[role='main']";
 7964 |   90 | 
 7965 |   91 |     return "document";
 7966 |   92 |   }, postRootScript());
 7967 |   93 | 
 7968 |   94 |   return scope || "document";
 7969 |   95 | }
 7970 |   96 | 
 7971 |   97 | /* ============================================================
 7972 |   98 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: WSZYSTKIE / NAJNOWSZE =======
 7973 |   99 |    ============================================================ */
 7974 |  100 | 
 7975 |  101 | async function clickMenuOptionByPattern(page, patterns) {
 7976 |  102 |   const result = await page.evaluate((patterns) => {
 7977 |  103 |     const norm = (s) =>
 7978 |  104 |       String(s || "")
 7979 |  105 |         .replace(/\u00a0/g, " ")
 7980 |  106 |         .replace(/\s+/g, " ")
 7981 |  107 |         .trim()
 7982 |  108 |         .toLowerCase();
 7983 |  109 | 
 7984 |  110 |     const menu = document.querySelector("div[role='menu']");
 7985 |  111 |     if (!menu) return { clicked: false, noMenu: true };
 7986 |  112 | 
 7987 |  113 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 7988 |  114 | 
 7989 |  115 |     const opt = items.find((el) => {
 7990 |  116 |       const t = norm(el.textContent);
 7991 |  117 |       return patterns.some((p) => t.startsWith(p));
 7992 |  118 |     });
 7993 |  119 | 
 7994 |  120 |     if (!opt) return { clicked: false, noMenu: false, patterns };
 7995 |  121 | 
 7996 |  122 |     try {
 7997 |  123 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 7998 |  124 |     } catch {}
 7999 |  125 | 
 8000 |  126 |     try {
 8001 |  127 |       opt.click();
 8002 |  128 |       return { clicked: true, noMenu: false };
 8003 |  129 |     } catch {
 8004 |  130 |       return { clicked: false, noMenu: false };
 8005 |  131 |     }
 8006 |  132 |   }, patterns);
 8007 |  133 | 
 8008 |  134 |   if (result.clicked) {
 8009 |  135 |     await sleepRandom(250, 450);
 8010 |  136 |     await page
 8011 |  137 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 8012 |  138 |       .catch(() => {});
 8013 |  139 |   }
 8014 |  140 | 
 8015 |  141 |   return result;
 8016 |  142 | }
 8017 |  143 | 
 8018 |  144 | async function clickAllCommentsInMenu(page) {
 8019 |  145 |   const result = await page.evaluate(() => {
 8020 |  146 |     const norm = (s) =>
 8021 |  147 |       String(s || "")
 8022 |  148 |         .replace(/\u00a0/g, " ")
 8023 |  149 |         .replace(/\s+/g, " ")
 8024 |  150 |         .trim()
 8025 |  151 |         .toLowerCase();
 8026 |  152 | 
 8027 |  153 |     const menu = document.querySelector("div[role='menu']");
 8028 |  154 |     if (!menu) return { clicked: false, noMenu: true };
 8029 |  155 | 
 8030 |  156 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
 8031 |  157 | 
 8032 |  158 |     const opt = items.find((el) => {
 8033 |  159 |       const t = norm(el.textContent);
 8034 |  160 |       return (
 8035 |  161 |         t.startsWith("wszystkie komentarze") ||
 8036 |  162 |         t.startsWith("all comments") ||
 8037 |  163 |         t.startsWith("poka≈º wszystkie") ||
 8038 |  164 |         t.startsWith("pokaz wszystkie") ||
 8039 |  165 |         t.startsWith("show all")
 8040 |  166 |       );
 8041 |  167 |     });
 8042 |  168 | 
 8043 |  169 |     if (!opt) return { clicked: false, noMenu: false };
 8044 |  170 | 
 8045 |  171 |     try {
 8046 |  172 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
 8047 |  173 |     } catch {}
 8048 |  174 | 
 8049 |  175 |     try {
 8050 |  176 |       opt.click();
 8051 |  177 |       return { clicked: true, noMenu: false };
 8052 |  178 |     } catch {
 8053 |  179 |       return { clicked: false, noMenu: false };
 8054 |  180 |     }
 8055 |  181 |   });
 8056 |  182 | 
 8057 |  183 |   if (result.clicked) {
 8058 |  184 |     await sleepRandom(250, 450);
 8059 |  185 |     await page
 8060 |  186 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
 8061 |  187 |       .catch(() => {});
 8062 |  188 |   }
 8063 |  189 | 
 8064 |  190 |   return result;
 8065 |  191 | }
 8066 |  192 | 
 8067 |  193 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
 8068 |  194 |   log.dev("UI:post", "Prze≈ÇƒÖczam filtr komentarzy...");
 8069 |  195 |   log.debug("UI:post", `Filter scope: ${scopeSel}`);
 8070 |  196 | 
 8071 |  197 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
 8072 |  198 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 8073 |  199 |   if (menuAlreadyOpen) {
 8074 |  200 |     log.debug("UI:post", "Menu ju≈º otwarte ‚Äì wybieram opcjƒô");
 8075 |  201 |     const r = await clickAllCommentsInMenu(page);
 8076 |  202 |     if (r?.clicked)
 8077 |  203 |       log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 8078 |  204 |     return !!r?.clicked;
 8079 |  205 |   }
 8080 |  206 | 
 8081 |  207 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
 8082 |  208 |   const pre = await page.evaluate(
 8083 |  209 |     (scopeSel, code) => {
 8084 |  210 |       const norm = (s) =>
 8085 |  211 |         String(s || "")
 8086 |  212 |           .replace(/\u00a0/g, " ")
 8087 |  213 |           .replace(/\s+/g, " ")
 8088 |  214 |           .trim()
 8089 |  215 |           .toLowerCase();
 8090 |  216 | 
 8091 |  217 |       // eslint-disable-next-line no-eval
 8092 |  218 |       eval(code);
 8093 |  219 |       // @ts-ignore
 8094 |  220 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 8095 |  221 | 
 8096 |  222 |       function getLabel(el) {
 8097 |  223 |         if (!el) return "";
 8098 |  224 |         const aria = el.getAttribute?.("aria-label");
 8099 |  225 |         if (aria) return aria;
 8100 |  226 |         return el.textContent || "";
 8101 |  227 |       }
 8102 |  228 | 
 8103 |  229 |       function isVisibleEnough(el) {
 8104 |  230 |         try {
 8105 |  231 |           if (!el) return false;
 8106 |  232 |           const st = window.getComputedStyle(el);
 8107 |  233 |           if (!st) return true;
 8108 |  234 |           if (st.display === "none" || st.visibility === "hidden") return false;
 8109 |  235 |           const r = el.getBoundingClientRect();
 8110 |  236 |           if (!r || r.width < 8 || r.height < 8) return false;
 8111 |  237 |           return true;
 8112 |  238 |         } catch {
 8113 |  239 |           return true;
 8114 |  240 |         }
 8115 |  241 |       }
 8116 |  242 | 
 8117 |  243 |       function findClickableAncestor(start) {
 8118 |  244 |         let el = start;
 8119 |  245 |         for (let i = 0; i < 10 && el; i++) {
 8120 |  246 |           const role = el.getAttribute?.("role");
 8121 |  247 |           const tag = (el.tagName || "").toLowerCase();
 8122 |  248 |           if (
 8123 |  249 |             tag === "button" ||
 8124 |  250 |             role === "button" ||
 8125 |  251 |             role === "menuitem" ||
 8126 |  252 |             role === "menuitemradio" ||
 8127 |  253 |             role === "link"
 8128 |  254 |           ) {
 8129 |  255 |             return el;
 8130 |  256 |           }
 8131 |  257 |           el = el.parentElement;
 8132 |  258 |         }
 8133 |  259 |         return null;
 8134 |  260 |       }
 8135 |  261 | 
 8136 |  262 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
 8137 |  263 |       const btnsAll = Array.from(
 8138 |  264 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8139 |  265 |       );
 8140 |  266 |       for (const el of btnsAll) {
 8141 |  267 |         const t = norm(getLabel(el));
 8142 |  268 |         if (
 8143 |  269 |           t === "wszystkie komentarze" ||
 8144 |  270 |           t === "all comments" ||
 8145 |  271 |           t === "poka≈º wszystkie" ||
 8146 |  272 |           t === "pokaz wszystkie" ||
 8147 |  273 |           t === "show all"
 8148 |  274 |         ) {
 8149 |  275 |           return { ok: true, state: "already-all", where: "document" };
 8150 |  276 |         }
 8151 |  277 |       }
 8152 |  278 | 
 8153 |  279 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 8154 |  280 |       const scopes = [scopeEl, root, document].filter(Boolean);
 8155 |  281 | 
 8156 |  282 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
 8157 |  283 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
 8158 |  284 |       for (const sc of scopes) {
 8159 |  285 |         const clickables = Array.from(
 8160 |  286 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8161 |  287 |         );
 8162 |  288 | 
 8163 |  289 |         const candidates = [];
 8164 |  290 |         for (const el of clickables) {
 8165 |  291 |           const t = norm(getLabel(el));
 8166 |  292 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
 8167 |  293 |           if (!isVisibleEnough(el)) continue;
 8168 |  294 | 
 8169 |  295 |           let dist = 999999;
 8170 |  296 |           try {
 8171 |  297 |             const r = el.getBoundingClientRect();
 8172 |  298 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
 8173 |  299 |             dist = Math.abs(r.top - window.innerHeight / 2);
 8174 |  300 |           } catch {}
 8175 |  301 | 
 8176 |  302 |           candidates.push({ el, dist });
 8177 |  303 |         }
 8178 |  304 | 
 8179 |  305 |         if (candidates.length) {
 8180 |  306 |           candidates.sort((a, b) => a.dist - b.dist);
 8181 |  307 |           const picked = candidates[0].el;
 8182 |  308 | 
 8183 |  309 |           try {
 8184 |  310 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 8185 |  311 |           } catch {}
 8186 |  312 | 
 8187 |  313 |           try {
 8188 |  314 |             picked.click();
 8189 |  315 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
 8190 |  316 |           } catch {
 8191 |  317 |             // nic
 8192 |  318 |           }
 8193 |  319 |         }
 8194 |  320 |       }
 8195 |  321 | 
 8196 |  322 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
 8197 |  323 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
 8198 |  324 |       for (const sc of scopes) {
 8199 |  325 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
 8200 |  326 |           .filter(isVisibleEnough)
 8201 |  327 |           .slice(0, 20000);
 8202 |  328 | 
 8203 |  329 |         for (const n of nodes) {
 8204 |  330 |           const t = norm(n.textContent);
 8205 |  331 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
 8206 |  332 | 
 8207 |  333 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
 8208 |  334 |           if (!clickable) continue;
 8209 |  335 | 
 8210 |  336 |           try {
 8211 |  337 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
 8212 |  338 |           } catch {}
 8213 |  339 | 
 8214 |  340 |           try {
 8215 |  341 |             clickable.click();
 8216 |  342 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
 8217 |  343 |           } catch {
 8218 |  344 |             // nic
 8219 |  345 |           }
 8220 |  346 |         }
 8221 |  347 |       }
 8222 |  348 | 
 8223 |  349 |       return { ok: false, state: "not-found" };
 8224 |  350 |     },
 8225 |  351 |     scopeSel,
 8226 |  352 |     postRootScript()
 8227 |  353 |   );
 8228 |  354 | 
 8229 |  355 |   if (!pre?.ok) {
 8230 |  356 |     log.debug("UI:post", "Nie znaleziono przycisku filtra");
 8231 |  357 |     return false;
 8232 |  358 |   }
 8233 |  359 | 
 8234 |  360 |   if (pre.state === "already-all") {
 8235 |  361 |     log.debug("UI:post", "Filtr ju≈º ustawiony ‚Äì pomijam");
 8236 |  362 |     return true;
 8237 |  363 |   }
 8238 |  364 | 
 8239 |  365 |   log.debug("UI:post", "Klikniƒôto filtr", pre);
 8240 |  366 | 
 8241 |  367 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 8242 |  368 |   await sleepRandom(350, 650);
 8243 |  369 | 
 8244 |  370 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
 8245 |  371 |   const menuResult = await clickAllCommentsInMenu(page);
 8246 |  372 | 
 8247 |  373 |   if (menuResult?.clicked) {
 8248 |  374 |     log.dev("UI:post", "Filtr ustawiony: 'Wszystkie komentarze'");
 8249 |  375 |     return true;
 8250 |  376 |   }
 8251 |  377 | 
 8252 |  378 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
 8253 |  379 |   const afterLabelIsAll = await page.evaluate(() => {
 8254 |  380 |     const norm = (s) =>
 8255 |  381 |       String(s || "")
 8256 |  382 |         .replace(/\u00a0/g, " ")
 8257 |  383 |         .replace(/\s+/g, " ")
 8258 |  384 |         .trim()
 8259 |  385 |         .toLowerCase();
 8260 |  386 | 
 8261 |  387 |     const els = Array.from(
 8262 |  388 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8263 |  389 |     );
 8264 |  390 | 
 8265 |  391 |     function getLabel(el) {
 8266 |  392 |       const aria = el.getAttribute?.("aria-label");
 8267 |  393 |       if (aria) return aria;
 8268 |  394 |       return el.textContent || "";
 8269 |  395 |     }
 8270 |  396 | 
 8271 |  397 |     return els.some((el) => {
 8272 |  398 |       const t = norm(getLabel(el));
 8273 |  399 |       return (
 8274 |  400 |         t === "wszystkie komentarze" ||
 8275 |  401 |         t === "all comments" ||
 8276 |  402 |         t === "poka≈º wszystkie" ||
 8277 |  403 |         t === "pokaz wszystkie" ||
 8278 |  404 |         t === "show all"
 8279 |  405 |       );
 8280 |  406 |     });
 8281 |  407 |   });
 8282 |  408 | 
 8283 |  409 |   if (afterLabelIsAll) {
 8284 |  410 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu");
 8285 |  411 |     return true;
 8286 |  412 |   }
 8287 |  413 | 
 8288 |  414 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá filtra", menuResult);
 8289 |  415 |   return false;
 8290 |  416 | }
 8291 |  417 | 
 8292 |  418 | /* ============================================================
 8293 |  419 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: NAJNOWSZE (FAST_MODE) =======
 8294 |  420 |    ============================================================ */
 8295 |  421 | 
 8296 |  422 | async function openFilterMenuScoped(page, scopeSel = "document") {
 8297 |  423 |   const pre = await page.evaluate(
 8298 |  424 |     (scopeSel, code) => {
 8299 |  425 |       const norm = (s) =>
 8300 |  426 |         String(s || "")
 8301 |  427 |           .replace(/\u00a0/g, " ")
 8302 |  428 |           .replace(/\s+/g, " ")
 8303 |  429 |           .trim()
 8304 |  430 |           .toLowerCase();
 8305 |  431 | 
 8306 |  432 |       // eslint-disable-next-line no-eval
 8307 |  433 |       eval(code);
 8308 |  434 |       // @ts-ignore
 8309 |  435 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 8310 |  436 | 
 8311 |  437 |       function getLabel(el) {
 8312 |  438 |         if (!el) return "";
 8313 |  439 |         const aria = el.getAttribute?.("aria-label");
 8314 |  440 |         if (aria) return aria;
 8315 |  441 |         return el.textContent || "";
 8316 |  442 |       }
 8317 |  443 | 
 8318 |  444 |       function isVisibleEnough(el) {
 8319 |  445 |         try {
 8320 |  446 |           if (!el) return false;
 8321 |  447 |           const st = window.getComputedStyle(el);
 8322 |  448 |           if (!st) return true;
 8323 |  449 |           if (st.display === "none" || st.visibility === "hidden") return false;
 8324 |  450 |           const r = el.getBoundingClientRect();
 8325 |  451 |           if (!r || r.width < 8 || r.height < 8) return false;
 8326 |  452 |           return true;
 8327 |  453 |         } catch {
 8328 |  454 |           return true;
 8329 |  455 |         }
 8330 |  456 |       }
 8331 |  457 | 
 8332 |  458 |       // Je≈õli menu ju≈º otwarte
 8333 |  459 |       if (document.querySelector("div[role='menu']")) {
 8334 |  460 |         return { ok: true, state: "menu-already-open" };
 8335 |  461 |       }
 8336 |  462 | 
 8337 |  463 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
 8338 |  464 |       const scopes = [scopeEl, root, document].filter(Boolean);
 8339 |  465 | 
 8340 |  466 |       // Szukamy przycisku filtra (Najtrafniejsze/Wszystkie/Najnowsze)
 8341 |  467 |       const filterLabels = [
 8342 |  468 |         "najtrafniejsze", "most relevant",
 8343 |  469 |         "wszystkie komentarze", "all comments",
 8344 |  470 |         "najnowsze", "newest",
 8345 |  471 |         "poka≈º wszystkie", "show all"
 8346 |  472 |       ];
 8347 |  473 | 
 8348 |  474 |       for (const sc of scopes) {
 8349 |  475 |         const clickables = Array.from(
 8350 |  476 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8351 |  477 |         );
 8352 |  478 | 
 8353 |  479 |         const candidates = [];
 8354 |  480 |         for (const el of clickables) {
 8355 |  481 |           const t = norm(getLabel(el));
 8356 |  482 |           if (!filterLabels.some((f) => t.startsWith(f))) continue;
 8357 |  483 |           if (!isVisibleEnough(el)) continue;
 8358 |  484 | 
 8359 |  485 |           let dist = 999999;
 8360 |  486 |           try {
 8361 |  487 |             const r = el.getBoundingClientRect();
 8362 |  488 |             dist = Math.abs(r.top - window.innerHeight / 2);
 8363 |  489 |           } catch {}
 8364 |  490 | 
 8365 |  491 |           candidates.push({ el, dist, label: t });
 8366 |  492 |         }
 8367 |  493 | 
 8368 |  494 |         if (candidates.length) {
 8369 |  495 |           candidates.sort((a, b) => a.dist - b.dist);
 8370 |  496 |           const picked = candidates[0].el;
 8371 |  497 | 
 8372 |  498 |           try {
 8373 |  499 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
 8374 |  500 |           } catch {}
 8375 |  501 | 
 8376 |  502 |           try {
 8377 |  503 |             picked.click();
 8378 |  504 |             return { ok: true, state: "clicked-filter", label: candidates[0].label };
 8379 |  505 |           } catch {}
 8380 |  506 |         }
 8381 |  507 |       }
 8382 |  508 | 
 8383 |  509 |       return { ok: false, state: "not-found" };
 8384 |  510 |     },
 8385 |  511 |     scopeSel,
 8386 |  512 |     postRootScript()
 8387 |  513 |   );
 8388 |  514 | 
 8389 |  515 |   return pre;
 8390 |  516 | }
 8391 |  517 | 
 8392 |  518 | export async function switchCommentsFilterToNewestScoped(page, scopeSel = "document") {
 8393 |  519 |   log.dev("UI:post", "Prze≈ÇƒÖczam na 'Najnowsze'...");
 8394 |  520 |   log.debug("UI:post", `Newest filter scope: ${scopeSel}`);
 8395 |  521 | 
 8396 |  522 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Najnowsze"
 8397 |  523 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
 8398 |  524 |   if (menuAlreadyOpen) {
 8399 |  525 |     log.debug("UI:post", "Menu otwarte ‚Äì wybieram 'Najnowsze'");
 8400 |  526 |     const r = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 8401 |  527 |     if (r?.clicked) {
 8402 |  528 |       log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 8403 |  529 |       return { ok: true };
 8404 |  530 |     }
 8405 |  531 |     return { ok: false, reason: "option-not-found-in-open-menu" };
 8406 |  532 |   }
 8407 |  533 | 
 8408 |  534 |   // 1) Sprawd≈∫ czy ju≈º ustawione na "Najnowsze"
 8409 |  535 |   const alreadyNewest = await page.evaluate(() => {
 8410 |  536 |     const norm = (s) =>
 8411 |  537 |       String(s || "")
 8412 |  538 |         .replace(/\u00a0/g, " ")
 8413 |  539 |         .replace(/\s+/g, " ")
 8414 |  540 |         .trim()
 8415 |  541 |         .toLowerCase();
 8416 |  542 | 
 8417 |  543 |     const btns = Array.from(
 8418 |  544 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8419 |  545 |     );
 8420 |  546 | 
 8421 |  547 |     return btns.some((el) => {
 8422 |  548 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 8423 |  549 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 8424 |  550 |     });
 8425 |  551 |   });
 8426 |  552 | 
 8427 |  553 |   if (alreadyNewest) {
 8428 |  554 |     log.debug("UI:post", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
 8429 |  555 |     return { ok: true, state: "already-newest" };
 8430 |  556 |   }
 8431 |  557 | 
 8432 |  558 |   // 2) Otw√≥rz menu filtra
 8433 |  559 |   const openResult = await openFilterMenuScoped(page, scopeSel);
 8434 |  560 |   if (!openResult?.ok) {
 8435 |  561 |     log.debug("UI:post", "Nie uda≈Ço siƒô otworzyƒá menu filtra");
 8436 |  562 |     return { ok: false, reason: "menu-not-opened" };
 8437 |  563 |   }
 8438 |  564 | 
 8439 |  565 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
 8440 |  566 |   await sleepRandom(350, 650);
 8441 |  567 | 
 8442 |  568 |   // 3) Wybierz "Najnowsze" z menu
 8443 |  569 |   const menuResult = await clickMenuOptionByPattern(page, ["najnowsze", "newest", "od najnowszych", "most recent"]);
 8444 |  570 | 
 8445 |  571 |   if (menuResult?.clicked) {
 8446 |  572 |     log.dev("UI:post", "Filtr ustawiony: 'Najnowsze'");
 8447 |  573 |     return { ok: true };
 8448 |  574 |   }
 8449 |  575 | 
 8450 |  576 |   // 4) Fallback: sprawd≈∫ label po klikniƒôciu
 8451 |  577 |   const afterLabelIsNewest = await page.evaluate(() => {
 8452 |  578 |     const norm = (s) =>
 8453 |  579 |       String(s || "")
 8454 |  580 |         .replace(/\u00a0/g, " ")
 8455 |  581 |         .replace(/\s+/g, " ")
 8456 |  582 |         .trim()
 8457 |  583 |         .toLowerCase();
 8458 |  584 | 
 8459 |  585 |     const els = Array.from(
 8460 |  586 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
 8461 |  587 |     );
 8462 |  588 | 
 8463 |  589 |     return els.some((el) => {
 8464 |  590 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent || "");
 8465 |  591 |       return t === "najnowsze" || t === "newest" || t === "od najnowszych" || t === "most recent";
 8466 |  592 |     });
 8467 |  593 |   });
 8468 |  594 | 
 8469 |  595 |   if (afterLabelIsNewest) {
 8470 |  596 |     log.debug("UI:post", "Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Najnowsze'");
 8471 |  597 |     return { ok: true };
 8472 |  598 |   }
 8473 |  599 | 
 8474 |  600 |   log.debug("UI:post", "Nie uda≈Ço siƒô ustawiƒá 'Najnowsze'", menuResult);
 8475 |  601 |   return { ok: false, reason: menuResult?.noMenu ? "no-menu" : "option-not-found" };
 8476 |  602 | }
 8477 |  603 | 
 8478 |  604 | 
 8479 |  605 | /* ============================================================
 8480 |  606 |    =================== LICZENIE Z UI (POST) ====================
 8481 |  607 |    ============================================================ */
 8482 |  608 | 
 8483 |  609 | /**
 8484 |  610 |  * Kluczowa poprawka:
 8485 |  611 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
 8486 |  612 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
 8487 |  613 |  */
 8488 |  614 | async function getCommentCountFromUiPostRoot(page) {
 8489 |  615 |   const res = await page.evaluate((code) => {
 8490 |  616 |     // eslint-disable-next-line no-eval
 8491 |  617 |     eval(code);
 8492 |  618 | 
 8493 |  619 |     const norm = (s) =>
 8494 |  620 |       String(s || "")
 8495 |  621 |         .replace(/\u00a0/g, " ")
 8496 |  622 |         .replace(/\s+/g, " ")
 8497 |  623 |         .trim();
 8498 |  624 | 
 8499 |  625 |     const lower = (s) => norm(s).toLowerCase();
 8500 |  626 | 
 8501 |  627 |     function parsePlEnCount(text) {
 8502 |  628 |       const t = lower(text);
 8503 |  629 |       if (!t) return null;
 8504 |  630 | 
 8505 |  631 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
 8506 |  632 | 
 8507 |  633 |       let x = t
 8508 |  634 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
 8509 |  635 |         .replace(/comments?/g, "")
 8510 |  636 |         .replace(/[():]/g, " ")
 8511 |  637 |         .replace(/\s+/g, " ")
 8512 |  638 |         .trim();
 8513 |  639 | 
 8514 |  640 |       let mult = 1;
 8515 |  641 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
 8516 |  642 |         mult = 1000;
 8517 |  643 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
 8518 |  644 |       }
 8519 |  645 |       if (/\bmln\b|\bmillion\b/.test(x)) {
 8520 |  646 |         mult = 1000000;
 8521 |  647 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
 8522 |  648 |       }
 8523 |  649 | 
 8524 |  650 |       x = x.replace(/\s+/g, "");
 8525 |  651 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
 8526 |  652 |       x = x.replace(/[^0-9.]/g, "");
 8527 |  653 |       if (!x) return null;
 8528 |  654 | 
 8529 |  655 |       const n = Number(x);
 8530 |  656 |       if (!Number.isFinite(n)) return null;
 8531 |  657 | 
 8532 |  658 |       return Math.round(n * mult);
 8533 |  659 |     }
 8534 |  660 | 
 8535 |  661 |     // @ts-ignore
 8536 |  662 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
 8537 |  663 |     const scope = root || document;
 8538 |  664 | 
 8539 |  665 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
 8540 |  666 |     const badBlock = (txt) => {
 8541 |  667 |       const t = lower(txt);
 8542 |  668 |       if (!t) return false;
 8543 |  669 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
 8544 |  670 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
 8545 |  671 |       return false;
 8546 |  672 |     };
 8547 |  673 | 
 8548 |  674 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
 8549 |  675 |     const spans = Array.from(scope.querySelectorAll("span"));
 8550 |  676 |     let best = null;
 8551 |  677 | 
 8552 |  678 |     for (const el of spans) {
 8553 |  679 |       const raw = norm(el.textContent);
 8554 |  680 |       if (!raw) continue;
 8555 |  681 |       if (badBlock(raw)) continue;
 8556 |  682 | 
 8557 |  683 |       const val = parsePlEnCount(raw);
 8558 |  684 |       if (val == null) continue;
 8559 |  685 | 
 8560 |  686 |       let score = 0;
 8561 |  687 |       score += Math.max(0, 40 - raw.length);
 8562 |  688 | 
 8563 |  689 |       try {
 8564 |  690 |         const r = el.getBoundingClientRect();
 8565 |  691 |         if (r.width > 10 && r.height > 10) score += 10;
 8566 |  692 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
 8567 |  693 |       } catch {}
 8568 |  694 | 
 8569 |  695 |       if (!best || score > best.score) best = { raw, val, score };
 8570 |  696 |     }
 8571 |  697 | 
 8572 |  698 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
 8573 |  699 | 
 8574 |  700 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
 8575 |  701 |     const nodes = Array.from(
 8576 |  702 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
 8577 |  703 |     );
 8578 |  704 | 
 8579 |  705 |     for (const el of nodes) {
 8580 |  706 |       const raw = norm(el.textContent);
 8581 |  707 |       if (!raw) continue;
 8582 |  708 |       if (badBlock(raw)) continue;
 8583 |  709 | 
 8584 |  710 |       const val = parsePlEnCount(raw);
 8585 |  711 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
 8586 |  712 |     }
 8587 |  713 | 
 8588 |  714 |     // 3) Ostatecznie: regex po tek≈õcie root
 8589 |  715 |     const blob = norm(scope.innerText || "");
 8590 |  716 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
 8591 |  717 |     if (m) {
 8592 |  718 |       const raw = norm(`${m[1]} ${m[2]}`);
 8593 |  719 |       const val = parsePlEnCount(raw);
 8594 |  720 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
 8595 |  721 |     }
 8596 |  722 | 
 8597 |  723 |     return { ok: false, reason: "not-found" };
 8598 |  724 |   }, postRootScript());
 8599 |  725 | 
 8600 |  726 |   return res?.ok ? res : null;
 8601 |  727 | }
 8602 |  728 | 
 8603 |  729 | /* ============================================================
 8604 |  730 |    =================== LICZENIE ANCHOR√ìW =======================
 8605 |  731 |    ============================================================ */
 8606 |  732 | 
 8607 |  733 | async function getCurrentCommentAnchorCount(page) {
 8608 |  734 |   const count = await page.evaluate(() => {
 8609 |  735 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
 8610 |  736 |     const ids = new Set();
 8611 |  737 | 
 8612 |  738 |     for (const a of anchors) {
 8613 |  739 |       try {
 8614 |  740 |         const url = new URL(a.href);
 8615 |  741 |         const cid = url.searchParams.get("comment_id");
 8616 |  742 |         const rid = url.searchParams.get("reply_comment_id");
 8617 |  743 |         let raw = rid || cid;
 8618 |  744 |         if (!raw) continue;
 8619 |  745 | 
 8620 |  746 |         if (!/^\d+$/.test(raw)) {
 8621 |  747 |           try {
 8622 |  748 |             const dec = atob(raw);
 8623 |  749 |             const m = dec.match(/:(\d+)_([0-9]+)/);
 8624 |  750 |             if (m) raw = m[2];
 8625 |  751 |           } catch {}
 8626 |  752 |         }
 8627 |  753 | 
 8628 |  754 |         if (raw) ids.add(raw);
 8629 |  755 |       } catch {}
 8630 |  756 |     }
 8631 |  757 | 
 8632 |  758 |     return ids.size;
 8633 |  759 |   });
 8634 |  760 | 
 8635 |  761 |   return count || 0;
 8636 |  762 | }
 8637 |  763 | 
 8638 |  764 | /* ============================================================
 8639 |  765 |    =================== SCROLL TYLKO W PO≈öCIE ===================
 8640 |  766 |    ============================================================ */
 8641 |  767 | 
 8642 |  768 | async function scrollWithinPost(page, label, factor = 0.25) {
 8643 |  769 |   const info = await page.evaluate(
 8644 |  770 |     (factorArg, labelArg, code) => {
 8645 |  771 |       // eslint-disable-next-line no-eval
 8646 |  772 |       eval(code);
 8647 |  773 |       // @ts-ignore
 8648 |  774 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
 8649 |  775 | 
 8650 |  776 |       const norm = (s) =>
 8651 |  777 |         String(s || "")
 8652 |  778 |           .replace(/\u00a0/g, " ")
 8653 |  779 |           .replace(/\s+/g, " ")
 8654 |  780 |           .trim()
 8655 |  781 |           .toLowerCase();
 8656 |  782 | 
 8657 |  783 |       function canScrollByTest(el) {
 8658 |  784 |         try {
 8659 |  785 |           if (!el) return false;
 8660 |  786 |           const ch = el.clientHeight || 0;
 8661 |  787 |           const sh = el.scrollHeight || 0;
 8662 |  788 |           if (ch <= 0) return false;
 8663 |  789 |           if (sh <= ch + 30) return false;
 8664 |  790 | 
 8665 |  791 |           const before = el.scrollTop ?? 0;
 8666 |  792 |           el.scrollTop = before + 80;
 8667 |  793 |           const after = el.scrollTop ?? before;
 8668 |  794 |           el.scrollTop = before;
 8669 |  795 |           return after !== before;
 8670 |  796 |         } catch {
 8671 |  797 |           return false;
 8672 |  798 |         }
 8673 |  799 |       }
 8674 |  800 | 
 8675 |  801 |       function isVisible(el) {
 8676 |  802 |         if (!el) return false;
 8677 |  803 |         const st = window.getComputedStyle(el);
 8678 |  804 |         if (!st) return true;
 8679 |  805 |         if (st.display === "none" || st.visibility === "hidden") return false;
 8680 |  806 |         const r = el.getBoundingClientRect();
 8681 |  807 |         if (!r || r.width < 5 || r.height < 5) return false;
 8682 |  808 |         return true;
 8683 |  809 |       }
 8684 |  810 | 
 8685 |  811 |       function pickContainerSmart() {
 8686 |  812 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
 8687 |  813 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
 8688 |  814 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
 8689 |  815 | 
 8690 |  816 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
 8691 |  817 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
 8692 |  818 | 
 8693 |  819 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
 8694 |  820 |         let anchor = null;
 8695 |  821 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
 8696 |  822 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
 8697 |  823 |           .filter(isVisible)
 8698 |  824 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
 8699 |  825 | 
 8700 |  826 |         if (candAnchor) anchor = candAnchor;
 8701 |  827 | 
 8702 |  828 |         function score(el) {
 8703 |  829 |           const ch = el.clientHeight || 0;
 8704 |  830 |           const sh = el.scrollHeight || 0;
 8705 |  831 |           const delta = sh - ch;
 8706 |  832 | 
 8707 |  833 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
 8708 |  834 |           const t = norm(el.innerText || "");
 8709 |  835 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
 8710 |  836 |           let s = delta + (hasCommentWords ? 12000 : 0);
 8711 |  837 | 
 8712 |  838 |           // premia je≈õli blisko anchora
 8713 |  839 |           if (anchor) {
 8714 |  840 |             const ar = anchor.getBoundingClientRect();
 8715 |  841 |             const er = el.getBoundingClientRect();
 8716 |  842 |             const dist = Math.abs(er.top - ar.top);
 8717 |  843 |             s += Math.max(0, 4000 - dist);
 8718 |  844 |           }
 8719 |  845 | 
 8720 |  846 |           return s;
 8721 |  847 |         }
 8722 |  848 | 
 8723 |  849 |         let best = null;
 8724 |  850 |         let bestScore = -1;
 8725 |  851 | 
 8726 |  852 |         for (const sc of scopes) {
 8727 |  853 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
 8728 |  854 |             .filter(isVisible)
 8729 |  855 |             .slice(0, 18000);
 8730 |  856 | 
 8731 |  857 |           for (const el of divs) {
 8732 |  858 |             if (!canScrollByTest(el)) continue;
 8733 |  859 |             const s = score(el);
 8734 |  860 |             if (s > bestScore) {
 8735 |  861 |               bestScore = s;
 8736 |  862 |               best = el;
 8737 |  863 |             }
 8738 |  864 |           }
 8739 |  865 |           if (best) break;
 8740 |  866 |         }
 8741 |  867 | 
 8742 |  868 |         if (best) {
 8743 |  869 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
 8744 |  870 |           return { el: best, label: "smart" };
 8745 |  871 |         }
 8746 |  872 | 
 8747 |  873 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
 8748 |  874 |         return {
 8749 |  875 |           el: document.scrollingElement || document.documentElement || document.body,
 8750 |  876 |           label: "window",
 8751 |  877 |         };
 8752 |  878 |       }
 8753 |  879 | 
 8754 |  880 |       const picked = pickContainerSmart();
 8755 |  881 |       const container = picked.el;
 8756 |  882 |       const containerType = picked.label;
 8757 |  883 | 
 8758 |  884 |       const isWindowContainer =
 8759 |  885 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
 8760 |  886 | 
 8761 |  887 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 8762 |  888 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
 8763 |  889 | 
 8764 |  890 |       if (maxScroll <= 0) {
 8765 |  891 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
 8766 |  892 |       }
 8767 |  893 | 
 8768 |  894 |       const f = factorArg || 0.25;
 8769 |  895 |       const sign = f < 0 ? -1 : 1;
 8770 |  896 |       const magnitude = Math.min(Math.abs(f), 1);
 8771 |  897 | 
 8772 |  898 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
 8773 |  899 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
 8774 |  900 |       const step = Math.max(120, Math.min(baseStep, 520));
 8775 |  901 | 
 8776 |  902 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
 8777 |  903 | 
 8778 |  904 |       if (isWindowContainer) window.scrollTo(0, target);
 8779 |  905 |       else container.scrollTop = target;
 8780 |  906 | 
 8781 |  907 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 8782 |  908 | 
 8783 |  909 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
 8784 |  910 |       if (after === before) {
 8785 |  911 |         try {
 8786 |  912 |           window.scrollBy(0, sign * step);
 8787 |  913 |         } catch {}
 8788 |  914 |       }
 8789 |  915 | 
 8790 |  916 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
 8791 |  917 | 
 8792 |  918 |       return { before, after: after2, container: containerType, label: labelArg };
 8793 |  919 |     },
 8794 |  920 |     factor,
 8795 |  921 |     label,
 8796 |  922 |     postRootScript()
 8797 |  923 |   );
 8798 |  924 | 
 8799 |  925 |   return info;
 8800 |  926 | }
 8801 |  927 | 
 8802 |  928 | /* ============================================================
 8803 |  929 |    =================== EXPAND (LEGACY) =========================
 8804 |  930 |    ============================================================ */
 8805 |  931 | 
 8806 |  932 | async function expandAllComments(page) {
 8807 |  933 |   if (!EXPAND_COMMENTS) return 0;
 8808 |  934 | 
 8809 |  935 |   let clicks = 0;
 8810 |  936 |   for (let i = 0; i < 30; i++) {
 8811 |  937 |     const didClick = await clickOneExpandButton(page);
 8812 |  938 |     if (!didClick) break;
 8813 |  939 |     clicks++;
 8814 |  940 |     await sleepRandom(900, 1600);
 8815 |  941 |   }
 8816 |  942 |   return clicks;
 8817 |  943 | }
 8818 |  944 | 
 8819 |  945 | /* ============================================================
 8820 |  946 |    =================== HANDLER API =============================
 8821 |  947 |    ============================================================ */
 8822 |  948 | 
 8823 |  949 | export async function prepare(page, url) {
 8824 |  950 |   log.dev("UI:post", `Prepare: ${url.slice(0, 60)}...`);
 8825 |  951 | 
 8826 |  952 |   const ok = await safeGoto(page, url, "post", {
 8827 |  953 |     waitUntil: "networkidle2",
 8828 |  954 |     timeout: NAV_TIMEOUT_MS,
 8829 |  955 |   });
 8830 |  956 | 
 8831 |  957 |   if (!ok) throw new Error("safeGoto-failed");
 8832 |  958 | 
 8833 |  959 |   const currentUrl = page.url();
 8834 |  960 |   if (currentUrl.includes("/login")) {
 8835 |  961 |     log.dev("UI:post", "/login redirect ‚Üí fbLogin()");
 8836 |  962 |     await fbLogin(page);
 8837 |  963 |     await sleepRandom(3000, 4500);
 8838 |  964 | 
 8839 |  965 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 8840 |  966 |     log.dev("UI:post", `Session after fbLogin: ${loggedAfterLogin ? "OK" : "NO"}`);
 8841 |  967 | 
 8842 |  968 |     if (loggedAfterLogin) {
 8843 |  969 |       await safeGoto(page, url, "post", {
 8844 |  970 |         waitUntil: "networkidle2",
 8845 |  971 |         timeout: NAV_TIMEOUT_MS,
 8846 |  972 |       });
 8847 |  973 |     }
 8848 |  974 |   }
 8849 |  975 | 
 8850 |  976 |   await acceptCookies(page, "post-initial");
 8851 |  977 | 
 8852 |  978 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
 8853 |  979 |   await sleepRandom(1200, 1800);
 8854 |  980 |   await acceptCookies(page, "post");
 8855 |  981 | 
 8856 |  982 |   try {
 8857 |  983 |     const logged = await checkIfLogged(page).catch(() => false);
 8858 |  984 |     if (logged) await saveCookies(page);
 8859 |  985 |   } catch {}
 8860 |  986 | 
 8861 |  987 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
 8862 |  988 |   await scrollPost(page, 120).catch(() => {});
 8863 |  989 |   await sleepRandom(600, 900);
 8864 |  990 | }
 8865 |  991 | 
 8866 |  992 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
 8867 |  993 |   try {
 8868 |  994 |     await page.waitForFunction(
 8869 |  995 |       ({ stableMs }) => {
 8870 |  996 |         const now = performance.now();
 8871 |  997 |         const y = window.scrollY || 0;
 8872 |  998 | 
 8873 |  999 |         if (!window.__fbScrollStop) {
 8874 | 1000 |           window.__fbScrollStop = { lastY: y, lastChange: now };
 8875 | 1001 |           return false;
 8876 | 1002 |         }
 8877 | 1003 | 
 8878 | 1004 |         const st = window.__fbScrollStop;
 8879 | 1005 | 
 8880 | 1006 |         if (Math.abs(y - st.lastY) > 0) {
 8881 | 1007 |           st.lastY = y;
 8882 | 1008 |           st.lastChange = now;
 8883 | 1009 |           return false;
 8884 | 1010 |         }
 8885 | 1011 | 
 8886 | 1012 |         return now - st.lastChange >= stableMs;
 8887 | 1013 |       },
 8888 | 1014 |       { timeout: timeoutMs },
 8889 | 1015 |       { stableMs }
 8890 | 1016 |     );
 8891 | 1017 |     return true;
 8892 | 1018 |   } catch {
 8893 | 1019 |     return false;
 8894 | 1020 |   }
 8895 | 1021 | }
 8896 | 1022 | 
 8897 | 1023 | export async function getCommentCount(page, url) {
 8898 | 1024 |   log.debug("UI:post", "getCommentCount...");
 8899 | 1025 | 
 8900 | 1026 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
 8901 | 1027 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
 8902 | 1028 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
 8903 | 1029 | 
 8904 | 1030 |   const scopeSel = await getPostScopeSelector(page);
 8905 | 1031 | 
 8906 | 1032 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
 8907 | 1033 |   log.debug("UI:post", `Filter all comments: ${okFilter}`);
 8908 | 1034 | 
 8909 | 1035 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
 8910 | 1036 |   if (okFilter) {
 8911 | 1037 |     await sleepRandom(250, 450);
 8912 | 1038 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
 8913 | 1039 |   }
 8914 | 1040 | 
 8915 | 1041 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
 8916 | 1042 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
 8917 | 1043 | 
 8918 | 1044 |   log.debug("UI:post", "UI comments", {
 8919 | 1045 |     source: ui?.source || "none",
 8920 | 1046 |     comments: ui?.comments ?? null,
 8921 | 1047 |   });
 8922 | 1048 | 
 8923 | 1049 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
 8924 | 1050 |     return ui.comments;
 8925 | 1051 |   }
 8926 | 1052 | 
 8927 | 1053 |   const anchors = await getCurrentCommentAnchorCount(page);
 8928 | 1054 |   log.debug("UI:post", `Fallback anchor count: ${anchors}`);
 8929 | 1055 | 
 8930 | 1056 |   return anchors > 0 ? anchors : null;
 8931 | 1057 | }
 8932 | 1058 | 
 8933 | 1059 | export async function loadAllComments(page, { expectedTotal } = {}) {
 8934 | 1060 |   log.dev("UI:post", `loadAllComments (expected: ${expectedTotal ?? "n/a"})`);
 8935 | 1061 | 
 8936 | 1062 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
 8937 | 1063 | 
 8938 | 1064 |   const MAX_ROUNDS = 600;
 8939 | 1065 |   const MAX_NO_PROGRESS = 60;
 8940 | 1066 | 
 8941 | 1067 |   let noProgress = 0;
 8942 | 1068 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
 8943 | 1069 | 
 8944 | 1070 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
 8945 | 1071 |     const before = lastAnchors;
 8946 | 1072 | 
 8947 | 1073 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
 8948 | 1074 |     const clicks = await expandAllComments(page);
 8949 | 1075 |     await sleepRandom(220, 420);
 8950 | 1076 | 
 8951 | 1077 |     const after = await getCurrentCommentAnchorCount(page);
 8952 | 1078 | 
 8953 | 1079 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
 8954 | 1080 | 
 8955 | 1081 |     if (progressed) noProgress = 0;
 8956 | 1082 |     else noProgress++;
 8957 | 1083 | 
 8958 | 1084 |     lastAnchors = after;
 8959 | 1085 | 
 8960 | 1086 |     if (round === 1 || round % 25 === 0) {
 8961 | 1087 |       log.debug("UI:post", `Round ${round}`, {
 8962 | 1088 |         anchors: `${before}‚Üí${after}`,
 8963 | 1089 |         clicks,
 8964 | 1090 |         noProgress,
 8965 | 1091 |       });
 8966 | 1092 |     }
 8967 | 1093 | 
 8968 | 1094 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
 8969 | 1095 |       if (after >= expectedTotal && noProgress >= 2) {
 8970 | 1096 |         log.debug("UI:post", "Stop: target-reached");
 8971 | 1097 |         break;
 8972 | 1098 |       }
 8973 | 1099 |     }
 8974 | 1100 | 
 8975 | 1101 |     if (noProgress >= MAX_NO_PROGRESS) {
 8976 | 1102 |       log.debug("UI:post", "Stop: no-progress");
 8977 | 1103 |       break;
 8978 | 1104 |     }
 8979 | 1105 |   }
 8980 | 1106 | }
 8981 | 1107 | 
 8982 | 1108 | export async function extractComments(page, url) {
 8983 | 1109 |   const data = await page.evaluate(() => {
 8984 | 1110 |     function extractCommentId(u) {
 8985 | 1111 |       const m = u?.match(/comment_id=([^&]+)/);
 8986 | 1112 |       return m ? decodeURIComponent(m[1]) : null;
 8987 | 1113 |     }
 8988 | 1114 | 
 8989 | 1115 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 8990 | 1116 |     const idToTimeMap = {};
 8991 | 1117 | 
 8992 | 1118 |     for (let i = 0; i < allLinks.length; i++) {
 8993 | 1119 |       const link = allLinks[i];
 8994 | 1120 |       const href = link.getAttribute("href") || "";
 8995 | 1121 |       const id = extractCommentId(href);
 8996 | 1122 |       if (!id) continue;
 8997 | 1123 | 
 8998 | 1124 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
 8999 | 1125 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
 9000 | 1126 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
 9001 | 1127 |           idToTimeMap[id] = timeText;
 9002 | 1128 |           break;
 9003 | 1129 |         }
 9004 | 1130 |       }
 9005 | 1131 |     }
 9006 | 1132 | 
 9007 | 1133 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
 9008 | 1134 | 
 9009 | 1135 |     const extracted = nodes
 9010 | 1136 |       .map((node, idx) => {
 9011 | 1137 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
 9012 | 1138 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
 9013 | 1139 | 
 9014 | 1140 |         const linkEl = node.querySelector('a[role="link"]');
 9015 | 1141 |         const href = linkEl?.getAttribute("href") || null;
 9016 | 1142 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
 9017 | 1143 | 
 9018 | 1144 |         const id = permalink ? extractCommentId(permalink) : null;
 9019 | 1145 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
 9020 | 1146 | 
 9021 | 1147 |         if (!author || !text) return null;
 9022 | 1148 | 
 9023 | 1149 |         return { id, author, text, time, permalink, pos: idx };
 9024 | 1150 |       })
 9025 | 1151 |       .filter(Boolean);
 9026 | 1152 | 
 9027 | 1153 |     return extracted;
 9028 | 1154 |   });
 9029 | 1155 | 
 9030 | 1156 |   log.debug("UI:post", `extractComments: ${data?.length || 0} komentarzy`);
 9031 | 1157 |   return Array.isArray(data) ? data : [];
 9032 | 1158 | }
 9033 | 1159 | 
 9034 | 1160 | export async function debugSnapshot(page) {
 9035 | 1161 |   const scopeSel = await getPostScopeSelector(page);
 9036 | 1162 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
 9037 | 1163 | 
 9038 | 1164 |   return {
 9039 | 1165 |     scopeSel,
 9040 | 1166 |     anchors,
 9041 | 1167 |     url: page.url(),
 9042 | 1168 |   };
 9043 | 1169 | }
 9044 | 1170 | 
 9045 | ```
 9046 | 
 9047 | ---
 9048 | 
 9049 | ### üìÑ ≈öcie≈ºka: `src/fb/ui/videos.js`
 9050 | **Typ:** JavaScript/tekst  
 9051 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 9052 | 
 9053 | ```js
 9054 |   1 | import { safeGoto } from "../../utils/navigation.js";
 9055 |   2 | import { sleepRandom } from "../../utils/sleep.js";
 9056 |   3 | import log from "../../utils/logger.js";
 9057 |   4 | import { acceptCookies } from "../cookies.js";
 9058 |   5 | import { fbLogin, checkIfLogged } from "../login.js";
 9059 |   6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
 9060 |   7 | 
 9061 |   8 | /** Typ handlera UI */
 9062 |   9 | export const type = "videos";
 9063 |  10 | 
 9064 |  11 | export function matchesUrl(url) {
 9065 |  12 |   const lower = (url || "").toLowerCase();
 9066 |  13 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
 9067 |  14 | }
 9068 |  15 | 
 9069 |  16 | export async function prepare(page, url) {
 9070 |  17 |   log.dev("UI:videos", `Prepare: ${url.slice(0, 50)}...`);
 9071 |  18 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 9072 |  19 |   if (!ok) throw new Error("safeGoto-failed");
 9073 |  20 | 
 9074 |  21 |   const currentUrl = page.url();
 9075 |  22 |   if (currentUrl.includes("/login")) {
 9076 |  23 |     log.dev("UI:videos", "Login required");
 9077 |  24 |     await fbLogin(page);
 9078 |  25 |     await sleepRandom(3000, 4500);
 9079 |  26 | 
 9080 |  27 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
 9081 |  28 |     log.dev("UI:videos", `Sesja po logowaniu: ${loggedAfterLogin ? "OK" : "BRAK"}`);
 9082 |  29 | 
 9083 |  30 |     if (loggedAfterLogin) {
 9084 |  31 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
 9085 |  32 |     } else {
 9086 |  33 |       log.warn("UI:videos", "Login failed");
 9087 |  34 |     }
 9088 |  35 |   }
 9089 |  36 | 
 9090 |  37 |   await acceptCookies(page, "videos");
 9091 |  38 | 
 9092 |  39 |   // stop autoplay
 9093 |  40 |   try {
 9094 |  41 |     await page.evaluate(() => {
 9095 |  42 |       const vids = Array.from(document.querySelectorAll("video"));
 9096 |  43 |       for (const v of vids) {
 9097 |  44 |         try {
 9098 |  45 |           v.autoplay = false;
 9099 |  46 |           v.removeAttribute("autoplay");
 9100 |  47 |           v.muted = true;
 9101 |  48 |           v.pause();
 9102 |  49 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
 9103 |  50 |         } catch {}
 9104 |  51 |       }
 9105 |  52 |     });
 9106 |  53 |     log.debug("UI:videos", "Video paused");
 9107 |  54 |   } catch (e) {
 9108 |  55 |     log.debug("UI:videos", `Video pause error: ${e?.message || e}`);
 9109 |  56 |   }
 9110 |  57 | }
 9111 |  58 | 
 9112 |  59 | export async function getCommentCount(page, url) {
 9113 |  60 |   const uiInfo = await getUiCommentInfo(page);
 9114 |  61 |   log.debug("UI:videos", "UI info", {
 9115 |  62 |     source: uiInfo?.source,
 9116 |  63 |     raw: uiInfo?.raw,
 9117 |  64 |     viewType: uiInfo?.viewType,
 9118 |  65 |     comments: uiInfo?.comments,
 9119 |  66 |   });
 9120 |  67 | 
 9121 |  68 |   let totalComments = null;
 9122 |  69 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
 9123 |  70 | 
 9124 |  71 |   log.dev("UI:videos", `Liczba komentarzy: ${totalComments ?? "brak danych"}`);
 9125 |  72 |   return totalComments;
 9126 |  73 | }
 9127 |  74 | 
 9128 |  75 | /* ==============================
 9129 |  76 |    ======= DEBUG HELPERS ========
 9130 |  77 |    ============================== */
 9131 |  78 | 
 9132 |  79 | function shortenHtml(html, max = 220) {
 9133 |  80 |   if (!html) return null;
 9134 |  81 |   const s = String(html).replace(/\s+/g, " ").trim();
 9135 |  82 |   if (s.length <= max) return s;
 9136 |  83 |   return s.slice(0, max) + "‚Ä¶";
 9137 |  84 | }
 9138 |  85 | 
 9139 |  86 | async function debugDumpShowAllCandidates(page) {
 9140 |  87 |   const out = await page.evaluate(() => {
 9141 |  88 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
 9142 |  89 |     function pick(el) {
 9143 |  90 |       if (!el) return null;
 9144 |  91 |       const r = el.getBoundingClientRect();
 9145 |  92 |       return {
 9146 |  93 |         tag: el.tagName,
 9147 |  94 |         role: el.getAttribute("role"),
 9148 |  95 |         aria: el.getAttribute("aria-label"),
 9149 |  96 |         text: norm(el.textContent),
 9150 |  97 |         top: Math.round(r.top),
 9151 |  98 |         left: Math.round(r.left),
 9152 |  99 |         w: Math.round(r.width),
 9153 | 100 |         h: Math.round(r.height),
 9154 | 101 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
 9155 | 102 |       };
 9156 | 103 |     }
 9157 | 104 | 
 9158 | 105 |     const headers = Array.from(document.querySelectorAll("span"))
 9159 | 106 |       .filter((s) => {
 9160 | 107 |         const t = norm(s.textContent).toLowerCase();
 9161 | 108 |         return t === "komentarze" || t === "comments";
 9162 | 109 |       })
 9163 | 110 |       .slice(0, 5)
 9164 | 111 |       .map(pick);
 9165 | 112 | 
 9166 | 113 |     const showAll = Array.from(
 9167 | 114 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
 9168 | 115 |     )
 9169 | 116 |       .filter((el) => {
 9170 | 117 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
 9171 | 118 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
 9172 | 119 |       })
 9173 | 120 |       .slice(0, 20)
 9174 | 121 |       .map(pick);
 9175 | 122 | 
 9176 | 123 |     return { headers, showAll };
 9177 | 124 |   });
 9178 | 125 | 
 9179 | 126 |   log.debug("UI:videos", "Candidates", out);
 9180 | 127 | }
 9181 | 128 | 
 9182 | 129 | /* ==========================================
 9183 | 130 |    ======= COMMENTS SCOPE / MARKERS =========
 9184 | 131 |    ========================================== */
 9185 | 132 | 
 9186 | 133 | async function markCommentsScope(page) {
 9187 | 134 |   return await page.evaluate(() => {
 9188 | 135 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9189 | 136 | 
 9190 | 137 |     function isVisible(el) {
 9191 | 138 |       if (!el) return false;
 9192 | 139 |       const st = getComputedStyle(el);
 9193 | 140 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9194 | 141 |       const r = el.getBoundingClientRect();
 9195 | 142 |       return !!r && r.width > 5 && r.height > 5;
 9196 | 143 |     }
 9197 | 144 | 
 9198 | 145 |     function pick(el) {
 9199 | 146 |       if (!el) return null;
 9200 | 147 |       const r = el.getBoundingClientRect();
 9201 | 148 |       return {
 9202 | 149 |         tag: el.tagName,
 9203 | 150 |         role: el.getAttribute("role"),
 9204 | 151 |         aria: el.getAttribute("aria-label"),
 9205 | 152 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
 9206 | 153 |         top: Math.round(r.top),
 9207 | 154 |         left: Math.round(r.left),
 9208 | 155 |         w: Math.round(r.width),
 9209 | 156 |         h: Math.round(r.height),
 9210 | 157 |       };
 9211 | 158 |     }
 9212 | 159 | 
 9213 | 160 |     // clear markers
 9214 | 161 |     try {
 9215 | 162 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
 9216 | 163 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
 9217 | 164 |         n.removeAttribute("data-fbw-comments-header-row")
 9218 | 165 |       );
 9219 | 166 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
 9220 | 167 |         n.removeAttribute("data-fbw-comments-anchor")
 9221 | 168 |       );
 9222 | 169 |     } catch {}
 9223 | 170 | 
 9224 | 171 |     // find header
 9225 | 172 |     const headerSpans = Array.from(document.querySelectorAll("span"))
 9226 | 173 |       .filter(isVisible)
 9227 | 174 |       .filter((el) => {
 9228 | 175 |         const t = norm(el.textContent);
 9229 | 176 |         return t === "komentarze" || t === "comments";
 9230 | 177 |       });
 9231 | 178 | 
 9232 | 179 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
 9233 | 180 | 
 9234 | 181 |     // pick first visible header and mark a "root" around it
 9235 | 182 |     const h = headerSpans[0];
 9236 | 183 | 
 9237 | 184 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
 9238 | 185 |     let row = h.parentElement;
 9239 | 186 |     let foundRow = null;
 9240 | 187 | 
 9241 | 188 |     for (let up = 0; up < 14 && row; up++) {
 9242 | 189 |       const btns = Array.from(
 9243 | 190 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
 9244 | 191 |       ).filter(isVisible);
 9245 | 192 | 
 9246 | 193 |       const ok = btns.some((b) => {
 9247 | 194 |         const al = norm(b.getAttribute("aria-label"));
 9248 | 195 |         return (
 9249 | 196 |           al === "poka≈º wszystkie" ||
 9250 | 197 |           al === "wy≈õwietl wszystkie" ||
 9251 | 198 |           al === "show all" ||
 9252 | 199 |           al === "view all" ||
 9253 | 200 |           al === "ukryj komentarze" ||
 9254 | 201 |           al === "hide comments"
 9255 | 202 |         );
 9256 | 203 |       });
 9257 | 204 | 
 9258 | 205 |       if (ok) {
 9259 | 206 |         foundRow = row;
 9260 | 207 |         break;
 9261 | 208 |       }
 9262 | 209 |       row = row.parentElement;
 9263 | 210 |     }
 9264 | 211 | 
 9265 | 212 |     if (foundRow) {
 9266 | 213 |       try {
 9267 | 214 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
 9268 | 215 |       } catch {}
 9269 | 216 |     }
 9270 | 217 | 
 9271 | 218 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
 9272 | 219 |     let root = h.parentElement;
 9273 | 220 |     let best = null;
 9274 | 221 | 
 9275 | 222 |     for (let up = 0; up < 26 && root; up++) {
 9276 | 223 |       const txt = norm(root.innerText || "");
 9277 | 224 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
 9278 | 225 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
 9279 | 226 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
 9280 | 227 |       const isBigEnough = (root.clientHeight || 0) > 250;
 9281 | 228 | 
 9282 | 229 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
 9283 | 230 |         best = root;
 9284 | 231 |         break;
 9285 | 232 |       }
 9286 | 233 |       root = root.parentElement;
 9287 | 234 |     }
 9288 | 235 | 
 9289 | 236 |     // fallback: use header row parent
 9290 | 237 |     if (!best && foundRow) best = foundRow.parentElement;
 9291 | 238 |     if (!best) best = document.body;
 9292 | 239 | 
 9293 | 240 |     try {
 9294 | 241 |       best.setAttribute("data-fbw-comments-root", "1");
 9295 | 242 |     } catch {}
 9296 | 243 | 
 9297 | 244 |     // anchor element for scroll targeting: header span itself
 9298 | 245 |     try {
 9299 | 246 |       h.setAttribute("data-fbw-comments-anchor", "1");
 9300 | 247 |     } catch {}
 9301 | 248 | 
 9302 | 249 |     return {
 9303 | 250 |       ok: true,
 9304 | 251 |       reason: "marked",
 9305 | 252 |       header: pick(h),
 9306 | 253 |       row: foundRow ? pick(foundRow) : null,
 9307 | 254 |       root: pick(best),
 9308 | 255 |     };
 9309 | 256 |   });
 9310 | 257 | }
 9311 | 258 | 
 9312 | 259 | async function clickShowAllFromMarkedRow(page) {
 9313 | 260 |   const res = await page.evaluate(() => {
 9314 | 261 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9315 | 262 | 
 9316 | 263 |     function isVisible(el) {
 9317 | 264 |       if (!el) return false;
 9318 | 265 |       const st = getComputedStyle(el);
 9319 | 266 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9320 | 267 |       const r = el.getBoundingClientRect();
 9321 | 268 |       return !!r && r.width > 5 && r.height > 5;
 9322 | 269 |     }
 9323 | 270 | 
 9324 | 271 |     function pick(el) {
 9325 | 272 |       if (!el) return null;
 9326 | 273 |       const r = el.getBoundingClientRect();
 9327 | 274 |       return {
 9328 | 275 |         tag: el.tagName,
 9329 | 276 |         role: el.getAttribute("role"),
 9330 | 277 |         aria: el.getAttribute("aria-label"),
 9331 | 278 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
 9332 | 279 |         top: Math.round(r.top),
 9333 | 280 |         left: Math.round(r.left),
 9334 | 281 |         w: Math.round(r.width),
 9335 | 282 |         h: Math.round(r.height),
 9336 | 283 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
 9337 | 284 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
 9338 | 285 |       };
 9339 | 286 |     }
 9340 | 287 | 
 9341 | 288 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
 9342 | 289 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
 9343 | 290 | 
 9344 | 291 |     const candidates = Array.from(
 9345 | 292 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
 9346 | 293 |     ).filter(isVisible);
 9347 | 294 | 
 9348 | 295 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
 9349 | 296 |     for (const c of candidates) {
 9350 | 297 |       const al = norm(c.getAttribute("aria-label"));
 9351 | 298 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
 9352 | 299 |         try {
 9353 | 300 |           c.scrollIntoView({ block: "center", inline: "nearest" });
 9354 | 301 |         } catch {}
 9355 | 302 |         try {
 9356 | 303 |           c.click();
 9357 | 304 |         } catch {}
 9358 | 305 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
 9359 | 306 |       }
 9360 | 307 |     }
 9361 | 308 | 
 9362 | 309 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
 9363 | 310 |   });
 9364 | 311 | 
 9365 | 312 |   log.debug("UI:videos", "Show-all click", res);
 9366 | 313 |   return !!res?.clicked;
 9367 | 314 | }
 9368 | 315 | 
 9369 | 316 | /* ==========================================
 9370 | 317 |    ======= FILTER/SORT (Najtrafniejsze) ======
 9371 | 318 |    ========================================== */
 9372 | 319 | 
 9373 | 320 | async function ensureAllCommentsFilter(page) {
 9374 | 321 |   const res = await page.evaluate(() => {
 9375 | 322 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9376 | 323 | 
 9377 | 324 |     function isVisible(el) {
 9378 | 325 |       if (!el) return false;
 9379 | 326 |       const st = getComputedStyle(el);
 9380 | 327 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9381 | 328 |       const r = el.getBoundingClientRect();
 9382 | 329 |       return !!r && r.width > 5 && r.height > 5;
 9383 | 330 |     }
 9384 | 331 | 
 9385 | 332 |     function pick(el) {
 9386 | 333 |       if (!el) return null;
 9387 | 334 |       const r = el.getBoundingClientRect();
 9388 | 335 |       return {
 9389 | 336 |         tag: el.tagName,
 9390 | 337 |         role: el.getAttribute("role"),
 9391 | 338 |         aria: el.getAttribute("aria-label"),
 9392 | 339 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
 9393 | 340 |         top: Math.round(r.top),
 9394 | 341 |         left: Math.round(r.left),
 9395 | 342 |         w: Math.round(r.width),
 9396 | 343 |         h: Math.round(r.height),
 9397 | 344 |       };
 9398 | 345 |     }
 9399 | 346 | 
 9400 | 347 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
 9401 | 348 | 
 9402 | 349 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
 9403 | 350 |     const rootTxt = norm(root.innerText || "");
 9404 | 351 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
 9405 | 352 |       return { ok: true, action: "already-all", dbg: null };
 9406 | 353 |     }
 9407 | 354 | 
 9408 | 355 |     // find the sort dropdown button in root
 9409 | 356 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
 9410 | 357 | 
 9411 | 358 |     const sortBtn = btns.find((b) => {
 9412 | 359 |       const t = norm(b.textContent);
 9413 | 360 |       return (
 9414 | 361 |         t === "najtrafniejsze" ||
 9415 | 362 |         t === "most relevant" ||
 9416 | 363 |         t === "top comments" ||
 9417 | 364 |         t === "najlepsze" ||
 9418 | 365 |         t === "newest" ||
 9419 | 366 |         t === "najnowsze"
 9420 | 367 |       );
 9421 | 368 |     });
 9422 | 369 | 
 9423 | 370 |     if (!sortBtn) {
 9424 | 371 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
 9425 | 372 |     }
 9426 | 373 | 
 9427 | 374 |     try {
 9428 | 375 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
 9429 | 376 |     } catch {}
 9430 | 377 |     try {
 9431 | 378 |       sortBtn.click();
 9432 | 379 |     } catch {}
 9433 | 380 | 
 9434 | 381 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
 9435 | 382 |   });
 9436 | 383 | 
 9437 | 384 |   log.debug("UI:videos", "Filter step#1", res);
 9438 | 385 | 
 9439 | 386 |   if (!res?.ok || res.action !== "opened-menu") return false;
 9440 | 387 | 
 9441 | 388 |   await sleepRandom(400, 700);
 9442 | 389 | 
 9443 | 390 |   const res2 = await page.evaluate(() => {
 9444 | 391 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9445 | 392 | 
 9446 | 393 |     function isVisible(el) {
 9447 | 394 |       if (!el) return false;
 9448 | 395 |       const st = getComputedStyle(el);
 9449 | 396 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9450 | 397 |       const r = el.getBoundingClientRect();
 9451 | 398 |       return !!r && r.width > 5 && r.height > 5;
 9452 | 399 |     }
 9453 | 400 | 
 9454 | 401 |     function pick(el) {
 9455 | 402 |       if (!el) return null;
 9456 | 403 |       const r = el.getBoundingClientRect();
 9457 | 404 |       return {
 9458 | 405 |         tag: el.tagName,
 9459 | 406 |         role: el.getAttribute("role"),
 9460 | 407 |         aria: el.getAttribute("aria-label"),
 9461 | 408 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
 9462 | 409 |         top: Math.round(r.top),
 9463 | 410 |         left: Math.round(r.left),
 9464 | 411 |         w: Math.round(r.width),
 9465 | 412 |         h: Math.round(r.height),
 9466 | 413 |       };
 9467 | 414 |     }
 9468 | 415 | 
 9469 | 416 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
 9470 | 417 | 
 9471 | 418 |     if (!menu) return { ok: false, action: "no-menu" };
 9472 | 419 | 
 9473 | 420 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
 9474 | 421 |       .filter(isVisible)
 9475 | 422 |       .slice(0, 200);
 9476 | 423 | 
 9477 | 424 |     // Prefer: "Wszystkie komentarze" / "All comments"
 9478 | 425 |     let target =
 9479 | 426 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
 9480 | 427 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
 9481 | 428 | 
 9482 | 429 |     // Fallback: "Najnowsze" / "Newest"
 9483 | 430 |     if (!target) {
 9484 | 431 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
 9485 | 432 |     }
 9486 | 433 | 
 9487 | 434 |     if (!target) {
 9488 | 435 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
 9489 | 436 |     }
 9490 | 437 | 
 9491 | 438 |     try {
 9492 | 439 |       target.scrollIntoView({ block: "center", inline: "nearest" });
 9493 | 440 |     } catch {}
 9494 | 441 |     try {
 9495 | 442 |       target.click();
 9496 | 443 |     } catch {}
 9497 | 444 | 
 9498 | 445 |     // close menu
 9499 | 446 |     try {
 9500 | 447 |       setTimeout(() => document.body.click(), 40);
 9501 | 448 |     } catch {}
 9502 | 449 | 
 9503 | 450 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
 9504 | 451 |   });
 9505 | 452 | 
 9506 | 453 |   log.debug("UI:videos", "Filter step#2", res2);
 9507 | 454 | 
 9508 | 455 |   await sleepRandom(500, 900);
 9509 | 456 | 
 9510 | 457 |   return !!res2?.ok;
 9511 | 458 | }
 9512 | 459 | 
 9513 | 460 | /* ==========================================
 9514 | 461 |    ======= FAST_MODE: SORTOWANIE "NAJNOWSZE" ==
 9515 | 462 |    ========================================== */
 9516 | 463 | 
 9517 | 464 | export async function switchCommentsFilterToNewestScoped(page) {
 9518 | 465 |   log.dev("UI:videos", "Prze≈ÇƒÖczam na 'Najnowsze'...");
 9519 | 466 | 
 9520 | 467 |   // ZAWSZE najpierw spr√≥buj kliknƒÖƒá "Poka≈º wszystkie" ≈ºeby otworzyƒá pe≈Çny panel komentarzy
 9521 | 468 |   log.debug("UI:videos", "Otwieranie panelu komentarzy...");
 9522 | 469 | 
 9523 | 470 |   const clickedShowAll = await page.evaluate(() => {
 9524 | 471 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9525 | 472 | 
 9526 | 473 |     function isVisible(el) {
 9527 | 474 |       if (!el) return false;
 9528 | 475 |       const st = getComputedStyle(el);
 9529 | 476 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9530 | 477 |       const r = el.getBoundingClientRect();
 9531 | 478 |       return !!r && r.width > 5 && r.height > 5;
 9532 | 479 |     }
 9533 | 480 | 
 9534 | 481 |     // Szukaj przycisku "Poka≈º wszystkie" / "Show all"
 9535 | 482 |     const btns = Array.from(
 9536 | 483 |       document.querySelectorAll("div[role='button'][aria-label], button[aria-label], a[aria-label]")
 9537 | 484 |     ).filter(isVisible);
 9538 | 485 | 
 9539 | 486 |     for (const btn of btns) {
 9540 | 487 |       const al = norm(btn.getAttribute("aria-label"));
 9541 | 488 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
 9542 | 489 |         try {
 9543 | 490 |           btn.scrollIntoView({ block: "center", inline: "nearest" });
 9544 | 491 |         } catch {}
 9545 | 492 |         try {
 9546 | 493 |           btn.click();
 9547 | 494 |           return { clicked: true, label: al };
 9548 | 495 |         } catch {}
 9549 | 496 |       }
 9550 | 497 |     }
 9551 | 498 |     return { clicked: false };
 9552 | 499 |   });
 9553 | 500 | 
 9554 | 501 |   if (clickedShowAll?.clicked) {
 9555 | 502 |     log.debug("UI:videos", `Klikniƒôto '${clickedShowAll.label}'`);
 9556 | 503 |     await sleepRandom(1500, 2200);
 9557 | 504 |   } else {
 9558 | 505 |     log.debug("UI:videos", "Nie znaleziono 'Poka≈º wszystkie' - mo≈ºe ju≈º rozwiniƒôte");
 9559 | 506 |   }
 9560 | 507 | 
 9561 | 508 |   // Oznacz scope komentarzy
 9562 | 509 |   const mark = await markCommentsScope(page).catch(() => null);
 9563 | 510 |   log.debug("UI:videos", `markCommentsScope: ${mark?.ok ? "OK" : mark?.reason}`);
 9564 | 511 | 
 9565 | 512 |   if (!mark?.ok) {
 9566 | 513 |     log.debug("UI:videos", "Nie znaleziono sekcji komentarzy");
 9567 | 514 |     return { ok: false, reason: "no-comments-scope" };
 9568 | 515 |   }
 9569 | 516 | 
 9570 | 517 |   await sleepRandom(200, 400);
 9571 | 518 | 
 9572 | 519 |   // Sprawd≈∫ czy ju≈º "Najnowsze"
 9573 | 520 |   const alreadyNewest = await page.evaluate(() => {
 9574 | 521 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9575 | 522 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
 9576 | 523 |     const rootTxt = norm(root.innerText || "");
 9577 | 524 | 
 9578 | 525 |     // Szukamy przycisku z labelem "Najnowsze" jako aktywny filtr
 9579 | 526 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button"));
 9580 | 527 |     return btns.some((b) => {
 9581 | 528 |       const t = norm(b.textContent);
 9582 | 529 |       return t === "najnowsze" || t === "newest";
 9583 | 530 |     });
 9584 | 531 |   });
 9585 | 532 | 
 9586 | 533 |   if (alreadyNewest) {
 9587 | 534 |     log.debug("UI:videos", "Filtr ju≈º 'Najnowsze' ‚Äì pomijam");
 9588 | 535 |     return { ok: true, state: "already-newest" };
 9589 | 536 |   }
 9590 | 537 | 
 9591 | 538 |   // Otw√≥rz menu sortowania
 9592 | 539 |   const openRes = await page.evaluate(() => {
 9593 | 540 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9594 | 541 | 
 9595 | 542 |     function isVisible(el) {
 9596 | 543 |       if (!el) return false;
 9597 | 544 |       const st = getComputedStyle(el);
 9598 | 545 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9599 | 546 |       const r = el.getBoundingClientRect();
 9600 | 547 |       return !!r && r.width > 5 && r.height > 5;
 9601 | 548 |     }
 9602 | 549 | 
 9603 | 550 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
 9604 | 551 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
 9605 | 552 | 
 9606 | 553 |     // Szukaj przycisku sortowania (Najtrafniejsze/Most relevant/Top comments/Wszystkie komentarze)
 9607 | 554 |     const sortBtn = btns.find((b) => {
 9608 | 555 |       const t = norm(b.textContent);
 9609 | 556 |       return (
 9610 | 557 |         t === "najtrafniejsze" ||
 9611 | 558 |         t === "most relevant" ||
 9612 | 559 |         t === "top comments" ||
 9613 | 560 |         t === "najlepsze" ||
 9614 | 561 |         t === "wszystkie komentarze" ||
 9615 | 562 |         t === "all comments"
 9616 | 563 |       );
 9617 | 564 |     });
 9618 | 565 | 
 9619 | 566 |     if (!sortBtn) {
 9620 | 567 |       return { ok: false, reason: "no-sortbtn" };
 9621 | 568 |     }
 9622 | 569 | 
 9623 | 570 |     try {
 9624 | 571 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
 9625 | 572 |     } catch {}
 9626 | 573 |     try {
 9627 | 574 |       sortBtn.click();
 9628 | 575 |     } catch {}
 9629 | 576 | 
 9630 | 577 |     return { ok: true, action: "opened-menu" };
 9631 | 578 |   });
 9632 | 579 | 
 9633 | 580 |   if (!openRes?.ok) {
 9634 | 581 |     log.debug("UI:videos", "Nie znaleziono przycisku sortowania");
 9635 | 582 |     return { ok: false, reason: openRes?.reason || "no-sortbtn" };
 9636 | 583 |   }
 9637 | 584 | 
 9638 | 585 |   await sleepRandom(400, 700);
 9639 | 586 | 
 9640 | 587 |   // Wybierz "Najnowsze" z menu
 9641 | 588 |   const selectRes = await page.evaluate(() => {
 9642 | 589 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9643 | 590 | 
 9644 | 591 |     function isVisible(el) {
 9645 | 592 |       if (!el) return false;
 9646 | 593 |       const st = getComputedStyle(el);
 9647 | 594 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9648 | 595 |       const r = el.getBoundingClientRect();
 9649 | 596 |       return !!r && r.width > 5 && r.height > 5;
 9650 | 597 |     }
 9651 | 598 | 
 9652 | 599 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
 9653 | 600 |     if (!menu) return { ok: false, reason: "no-menu" };
 9654 | 601 | 
 9655 | 602 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
 9656 | 603 |       .filter(isVisible);
 9657 | 604 | 
 9658 | 605 |     // Szukaj "Najnowsze" / "Newest"
 9659 | 606 |     const target = items.find((el) => {
 9660 | 607 |       const t = norm(el.textContent);
 9661 | 608 |       return t.startsWith("najnowsze") || t.startsWith("newest") || t.startsWith("od najnowszych") || t.startsWith("most recent");
 9662 | 609 |     });
 9663 | 610 | 
 9664 | 611 |     if (!target) {
 9665 | 612 |       return { ok: false, reason: "no-newest-option" };
 9666 | 613 |     }
 9667 | 614 | 
 9668 | 615 |     try {
 9669 | 616 |       target.scrollIntoView({ block: "center", inline: "nearest" });
 9670 | 617 |     } catch {}
 9671 | 618 |     try {
 9672 | 619 |       target.click();
 9673 | 620 |     } catch {}
 9674 | 621 | 
 9675 | 622 |     // Zamknij menu
 9676 | 623 |     try {
 9677 | 624 |       setTimeout(() => document.body.click(), 40);
 9678 | 625 |     } catch {}
 9679 | 626 | 
 9680 | 627 |     return { ok: true, action: "clicked-newest" };
 9681 | 628 |   });
 9682 | 629 | 
 9683 | 630 |   if (selectRes?.ok) {
 9684 | 631 |     log.dev("UI:videos", "Filtr ustawiony: 'Najnowsze'");
 9685 | 632 |     await sleepRandom(400, 700);
 9686 | 633 |     return { ok: true };
 9687 | 634 |   }
 9688 | 635 | 
 9689 | 636 |   log.debug("UI:videos", `Nie uda≈Ço siƒô wybraƒá 'Najnowsze': ${selectRes?.reason}`);
 9690 | 637 |   return { ok: false, reason: selectRes?.reason || "select-failed" };
 9691 | 638 | }
 9692 | 639 | 
 9693 | 640 | /* ==========================================
 9694 | 641 |    ======= SEQUENTIAL ACTION LOOP ============
 9695 | 642 |    ========================================== */
 9696 | 643 | 
 9697 | 644 | async function oneSequentialAction(page) {
 9698 | 645 |   const res = await page.evaluate(() => {
 9699 | 646 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
 9700 | 647 | 
 9701 | 648 |     function isVisible(el) {
 9702 | 649 |       if (!el) return false;
 9703 | 650 |       const st = getComputedStyle(el);
 9704 | 651 |       if (st.display === "none" || st.visibility === "hidden") return false;
 9705 | 652 |       const r = el.getBoundingClientRect();
 9706 | 653 |       return !!r && r.width > 5 && r.height > 5;
 9707 | 654 |     }
 9708 | 655 | 
 9709 | 656 |     function pick(el) {
 9710 | 657 |       if (!el) return null;
 9711 | 658 |       const r = el.getBoundingClientRect();
 9712 | 659 |       return {
 9713 | 660 |         tag: el.tagName,
 9714 | 661 |         role: el.getAttribute("role"),
 9715 | 662 |         aria: el.getAttribute("aria-label"),
 9716 | 663 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
 9717 | 664 |         top: Math.round(r.top),
 9718 | 665 |         left: Math.round(r.left),
 9719 | 666 |         w: Math.round(r.width),
 9720 | 667 |         h: Math.round(r.height),
 9721 | 668 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
 9722 | 669 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
 9723 | 670 |       };
 9724 | 671 |     }
 9725 | 672 | 
 9726 | 673 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
 9727 | 674 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
 9728 | 675 | 
 9729 | 676 |     const composer =
 9730 | 677 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
 9731 | 678 |       root.querySelector("[aria-label^='Write a comment']") ||
 9732 | 679 |       root.querySelector("[role='textbox'][contenteditable='true']");
 9733 | 680 | 
 9734 | 681 |     let scope = root;
 9735 | 682 |     if (composer) {
 9736 | 683 |       let p = composer.parentElement;
 9737 | 684 |       for (let up = 0; up < 14 && p; up++) {
 9738 | 685 |         const bigEnough = (p.clientHeight || 0) > 220;
 9739 | 686 |         const t = norm(p.innerText || "");
 9740 | 687 |         const looksCommenty =
 9741 | 688 |           t.includes("najtrafniejsze") ||
 9742 | 689 |           t.includes("most relevant") ||
 9743 | 690 |           t.includes("wszystkie komentarze") ||
 9744 | 691 |           t.includes("all comments") ||
 9745 | 692 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
 9746 | 693 |           t.includes("view more comments");
 9747 | 694 |         if (bigEnough && looksCommenty) {
 9748 | 695 |           scope = p;
 9749 | 696 |           break;
 9750 | 697 |         }
 9751 | 698 |         p = p.parentElement;
 9752 | 699 |       }
 9753 | 700 |     }
 9754 | 701 | 
 9755 | 702 |     // UWAGA: klikamy TYLKO elementy klikalne
 9756 | 703 |     const clickables = Array.from(
 9757 | 704 |       scope.querySelectorAll(
 9758 | 705 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
 9759 | 706 |       )
 9760 | 707 |     )
 9761 | 708 |       .filter(isVisible)
 9762 | 709 |       .slice(0, 12000);
 9763 | 710 | 
 9764 | 711 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
 9765 | 712 | 
 9766 | 713 |     const moreCommentNeedles = [
 9767 | 714 |       "wy≈õwietl wiƒôcej komentarzy",
 9768 | 715 |       "zobacz wiƒôcej komentarzy",
 9769 | 716 |       "view more comments",
 9770 | 717 |       "view previous comments",
 9771 | 718 |       "see more comments",
 9772 | 719 |     ];
 9773 | 720 | 
 9774 | 721 |     // 1) MORE COMMENTS ‚Äì tylko clickables
 9775 | 722 |     for (const el of clickables) {
 9776 | 723 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
 9777 | 724 |       if (!t) continue;
 9778 | 725 |       if (bannedExact.has(t)) continue;
 9779 | 726 | 
 9780 | 727 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
 9781 | 728 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
 9782 | 729 |         try { el.click(); } catch {}
 9783 | 730 |         return { acted: true, action: "more-comments", dbg: pick(el) };
 9784 | 731 |       }
 9785 | 732 |     }
 9786 | 733 | 
 9787 | 734 |     // 2) REPLIES ‚Äì tylko clickables
 9788 | 735 |     for (const el of clickables) {
 9789 | 736 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
 9790 | 737 |       if (!t) continue;
 9791 | 738 |       if (bannedExact.has(t)) continue;
 9792 | 739 | 
 9793 | 740 |       const isReply =
 9794 | 741 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
 9795 | 742 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
 9796 | 743 |         t.includes("view more replies") ||
 9797 | 744 |         t.includes("see more replies") ||
 9798 | 745 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
 9799 | 746 | 
 9800 | 747 |       if (isReply) {
 9801 | 748 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
 9802 | 749 |         try { el.click(); } catch {}
 9803 | 750 |         return { acted: true, action: "replies", dbg: pick(el) };
 9804 | 751 |       }
 9805 | 752 |     }
 9806 | 753 | 
 9807 | 754 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
 9808 | 755 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
 9809 | 756 | 
 9810 | 757 |     const beforeScope = scope.scrollTop || 0;
 9811 | 758 |     try {
 9812 | 759 |       if (scope && typeof scope.scrollTop === "number") {
 9813 | 760 |         scope.scrollTop = beforeScope + step;
 9814 | 761 |         const afterScope = scope.scrollTop || beforeScope;
 9815 | 762 |         if (afterScope > beforeScope) {
 9816 | 763 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
 9817 | 764 |         }
 9818 | 765 |       }
 9819 | 766 |     } catch {}
 9820 | 767 | 
 9821 | 768 |     const beforeWin = window.scrollY || 0;
 9822 | 769 |     window.scrollBy(0, step);
 9823 | 770 |     const afterWin = window.scrollY || 0;
 9824 | 771 | 
 9825 | 772 |     return {
 9826 | 773 |       acted: afterWin > beforeWin,
 9827 | 774 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
 9828 | 775 |       dbg: { beforeWin, afterWin, step },
 9829 | 776 |     };
 9830 | 777 |   });
 9831 | 778 | 
 9832 | 779 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
 9833 | 780 |   log.debug("UI:videos", "step", res);
 9834 | 781 |   return res || { acted: false, action: "none", dbg: null };
 9835 | 782 | }
 9836 | 783 | 
 9837 | 784 | 
 9838 | 785 | 
 9839 | 786 | /**
 9840 | 787 |  * Wczytuje wszystkie komentarze dla posta wideo.
 9841 | 788 |  */
 9842 | 789 | export async function loadAllComments(page, { expectedTotal } = {}) {
 9843 | 790 |   log.dev("UI:videos", "≈Åadujƒô komentarze...");
 9844 | 791 | 
 9845 | 792 |   await debugDumpShowAllCandidates(page).catch(() => {});
 9846 | 793 | 
 9847 | 794 |   const mark1 = await markCommentsScope(page).catch(() => null);
 9848 | 795 |   log.debug("UI:videos", "mark#1", mark1);
 9849 | 796 | 
 9850 | 797 |   await sleepRandom(250, 500);
 9851 | 798 | 
 9852 | 799 |   // klik show-all z header-row
 9853 | 800 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
 9854 | 801 |   if (clickedAll) {
 9855 | 802 |     await sleepRandom(900, 1400);
 9856 | 803 |     const mark2 = await markCommentsScope(page).catch(() => null);
 9857 | 804 |     log.debug("UI:videos", "mark#2", mark2);
 9858 | 805 |   } else {
 9859 | 806 |     log.debug("UI:videos", "show-all: nie klikniƒôto");
 9860 | 807 |   }
 9861 | 808 | 
 9862 | 809 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
 9863 | 810 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
 9864 | 811 |   log.debug("UI:videos", `filter ensure: ${filterOk}`);
 9865 | 812 | 
 9866 | 813 |   // policz cykle dynamicznie
 9867 | 814 |   let maxCycles = 180;
 9868 | 815 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
 9869 | 816 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
 9870 | 817 |   }
 9871 | 818 | 
 9872 | 819 |   let noProgress = 0;
 9873 | 820 | 
 9874 | 821 |   for (let i = 1; i <= maxCycles; i++) {
 9875 | 822 |     // jedna akcja na cykl
 9876 | 823 |     const r = await oneSequentialAction(page);
 9877 | 824 | 
 9878 | 825 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
 9879 | 826 |     if (!didProgress) noProgress++;
 9880 | 827 |     else noProgress = 0;
 9881 | 828 | 
 9882 | 829 |     if (i === 1 || i % 20 === 0) {
 9883 | 830 |       log.debug("UI:videos", `Cycle ${i}/${maxCycles}`, { action: r?.action, acted: !!r?.acted, noProgress });
 9884 | 831 |     }
 9885 | 832 | 
 9886 | 833 |     if (noProgress >= 10) {
 9887 | 834 |       log.debug("UI:videos", "Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie");
 9888 | 835 |       break;
 9889 | 836 |     }
 9890 | 837 | 
 9891 | 838 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
 9892 | 839 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
 9893 | 840 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
 9894 | 841 |     else await sleepRandom(450, 850);
 9895 | 842 |   }
 9896 | 843 | 
 9897 | 844 |   log.dev("UI:videos", "Komentarze za≈Çadowane");
 9898 | 845 | }
 9899 | 846 | 
 9900 | 847 | /**
 9901 | 848 |  * Ekstrahuje komentarze z posta wideo.
 9902 | 849 |  */
 9903 | 850 | export async function extractComments(page, url) {
 9904 | 851 |   const comments = await page.evaluate(() => {
 9905 | 852 |     function getCommentId(href) {
 9906 | 853 |       try {
 9907 | 854 |         const u = new URL(href, location.origin);
 9908 | 855 |         const cid = u.searchParams.get("comment_id");
 9909 | 856 |         const rid = u.searchParams.get("reply_comment_id");
 9910 | 857 |         return rid || cid;
 9911 | 858 |       } catch {
 9912 | 859 |         return null;
 9913 | 860 |       }
 9914 | 861 |     }
 9915 | 862 | 
 9916 | 863 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
 9917 | 864 |     const idToTime = {};
 9918 | 865 | 
 9919 | 866 |     for (let i = 0; i < allLinks.length; i++) {
 9920 | 867 |       const id = getCommentId(allLinks[i].href || "");
 9921 | 868 |       if (id) {
 9922 | 869 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
 9923 | 870 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
 9924 | 871 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
 9925 | 872 |             idToTime[id] = txt;
 9926 | 873 |             break;
 9927 | 874 |           }
 9928 | 875 |         }
 9929 | 876 |       }
 9930 | 877 |     }
 9931 | 878 | 
 9932 | 879 |     const commentBlocks = Array.from(
 9933 | 880 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
 9934 | 881 |     );
 9935 | 882 | 
 9936 | 883 |     const data = commentBlocks
 9937 | 884 |       .map((node) => {
 9938 | 885 |         try {
 9939 | 886 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
 9940 | 887 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
 9941 | 888 |           const linkEl = node.querySelector('a[role="link"]');
 9942 | 889 |           const href = linkEl?.getAttribute("href");
 9943 | 890 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
 9944 | 891 |           const id = permalink ? getCommentId(permalink) : null;
 9945 | 892 |           const time = id && idToTime[id] ? idToTime[id] : null;
 9946 | 893 | 
 9947 | 894 |           if (!author && !text) return null;
 9948 | 895 |           return { id, author, text, permalink, time };
 9949 | 896 |         } catch {
 9950 | 897 |           return null;
 9951 | 898 |         }
 9952 | 899 |       })
 9953 | 900 |       .filter(Boolean);
 9954 | 901 | 
 9955 | 902 |     return data;
 9956 | 903 |   });
 9957 | 904 | 
 9958 | 905 |   log.debug("UI:videos", `Wyekstrahowano ${comments.length} komentarzy`);
 9959 | 906 |   return comments;
 9960 | 907 | }
 9961 | 908 | 
 9962 | 909 | export async function debugSnapshot(page) {
 9963 | 910 |   try {
 9964 | 911 |     const path = `snapshot-videos.png`;
 9965 | 912 |     await page.screenshot({ path });
 9966 | 913 |     log.debug("UI:videos", `Zapisano zrzut: ${path}`);
 9967 | 914 |   } catch (e) {
 9968 | 915 |     log.error("UI:videos", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
 9969 | 916 |   }
 9970 | 917 | }
 9971 | 918 | 
 9972 | ```
 9973 | 
 9974 | ---
 9975 | 
 9976 | ### üìÑ ≈öcie≈ºka: `src/fb/ui/watch.js`
 9977 | **Typ:** JavaScript/tekst  
 9978 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
 9979 | 
 9980 | ```js
 9981 |   1 | // src/fb/ui/watch.js
 9982 |   2 | import { safeGoto } from "../../utils/navigation.js";
 9983 |   3 | import { sleepRandom } from "../../utils/sleep.js";
 9984 |   4 | import { acceptCookies, saveCookies } from "../cookies.js";
 9985 |   5 | import { fbLogin, checkIfLogged } from "../login.js";
 9986 |   6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
 9987 |   7 | import log from "../../utils/logger.js";
 9988 |   8 | 
 9989 |   9 | /** Typ handlera UI */
 9990 |  10 | export const type = "watch";
 9991 |  11 | 
 9992 |  12 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
 9993 |  13 | export function matchesUrl(url) {
 9994 |  14 |   try {
 9995 |  15 |     const u = new URL(url);
 9996 |  16 |     return (u.pathname || "").toLowerCase().includes("/watch");
 9997 |  17 |   } catch {
 9998 |  18 |     return String(url || "").toLowerCase().includes("/watch");
 9999 |  19 |   }
10000 |  20 | }
10001 |  21 | 
10002 |  22 | /* ============================================================
10003 |  23 |    ======================= DEBUG HELPERS ======================
10004 |  24 |    ============================================================ */
10005 |  25 | 
10006 |  26 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
10007 |  27 | 
10008 |  28 | async function safeShot(page, path, clip = null) {
10009 |  29 |   if (!DEBUG_WATCH) return;
10010 |  30 |   try {
10011 |  31 |     const opts = clip ? { path, clip } : { path, fullPage: false };
10012 |  32 |     await page.screenshot(opts);
10013 |  33 |     log.debug("UI:watch", `Screenshot ‚Üí ${path}`);
10014 |  34 |   } catch (e) {
10015 |  35 |     log.debug("UI:watch", `Screenshot failed: ${e?.message || e}`);
10016 |  36 |   }
10017 |  37 | }
10018 |  38 | 
10019 |  39 | async function shotElement(page, handle, path) {
10020 |  40 |   if (!DEBUG_WATCH) return;
10021 |  41 |   try {
10022 |  42 |     if (!handle) return;
10023 |  43 |     const box = await handle.boundingBox().catch(() => null);
10024 |  44 |     if (!box || box.width < 5 || box.height < 5) {
10025 |  45 |       log.debug("UI:watch", "shotElement: no bbox");
10026 |  46 |       return;
10027 |  47 |     }
10028 |  48 |     const clip = {
10029 |  49 |       x: Math.max(0, box.x),
10030 |  50 |       y: Math.max(0, box.y),
10031 |  51 |       width: Math.max(1, Math.min(box.width, 1920)),
10032 |  52 |       height: Math.max(1, Math.min(box.height, 1080)),
10033 |  53 |     };
10034 |  54 |     await safeShot(page, path, clip);
10035 |  55 |   } catch (e) {
10036 |  56 |     log.debug("UI:watch", `shotElement failed: ${e?.message || e}`);
10037 |  57 |   }
10038 |  58 | }
10039 |  59 | 
10040 |  60 | async function debugOuterStats(page, outerHandle) {
10041 |  61 |   if (!DEBUG_WATCH) return null;
10042 |  62 |   if (!outerHandle) return null;
10043 |  63 | 
10044 |  64 |   return page.evaluate((outer) => {
10045 |  65 |     const norm = (s) =>
10046 |  66 |       String(s || "")
10047 |  67 |         .replace(/\u00a0/g, " ")
10048 |  68 |         .replace(/\s+/g, " ")
10049 |  69 |         .trim();
10050 |  70 | 
10051 |  71 |     const r = outer.getBoundingClientRect();
10052 |  72 |     const style = getComputedStyle(outer);
10053 |  73 | 
10054 |  74 |     const anchors = Array.from(
10055 |  75 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
10056 |  76 |     );
10057 |  77 | 
10058 |  78 |     const allText = (outer.innerText || "").toLowerCase();
10059 |  79 |     const moreHits =
10060 |  80 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
10061 |  81 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
10062 |  82 |       (allText.match(/view more comments/g) || []).length +
10063 |  83 |       (allText.match(/see more comments/g) || []).length;
10064 |  84 | 
10065 |  85 |     const labels = [];
10066 |  86 |     const nodes = Array.from(
10067 |  87 |       outer.querySelectorAll(
10068 |  88 |         "button,div[role='button'],span[role='button'],a,abbr,[role='article'],div,span"
10069 |  89 |       )
10070 |  90 |     ).slice(0, 4000);
10071 |  91 | 
10072 |  92 |     for (const el of nodes) {
10073 |  93 |       const a = el.getAttribute?.("aria-label");
10074 |  94 |       const t = norm(a);
10075 |  95 |       if (t) labels.push(t);
10076 |  96 |     }
10077 |  97 | 
10078 |  98 |     const freq = new Map();
10079 |  99 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
10080 | 100 |     const topLabels = Array.from(freq.entries())
10081 | 101 |       .sort((a, b) => b[1] - a[1])
10082 | 102 |       .slice(0, 15)
10083 | 103 |       .map(([k, v]) => ({ label: k, n: v }));
10084 | 104 | 
10085 | 105 |     return {
10086 | 106 |       tag: outer.tagName,
10087 | 107 |       className: outer.className || "",
10088 | 108 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
10089 | 109 |       style: {
10090 | 110 |         overflowY: style.overflowY,
10091 | 111 |         position: style.position,
10092 | 112 |       },
10093 | 113 |       counts: {
10094 | 114 |         anchors: anchors.length,
10095 | 115 |         moreHits,
10096 | 116 |       },
10097 | 117 |       topLabels,
10098 | 118 |     };
10099 | 119 |   }, outerHandle);
10100 | 120 | }
10101 | 121 | 
10102 | 122 | async function debugScrollerStats(page, scrollerHandle) {
10103 | 123 |   if (!DEBUG_WATCH) return null;
10104 | 124 |   if (!scrollerHandle) return null;
10105 | 125 | 
10106 | 126 |   return page.evaluate((s) => {
10107 | 127 |     const r = s.getBoundingClientRect();
10108 | 128 |     const st = getComputedStyle(s);
10109 | 129 |     return {
10110 | 130 |       tag: s.tagName,
10111 | 131 |       className: s.className || "",
10112 | 132 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
10113 | 133 |       style: { overflowY: st.overflowY, overflow: st.overflow },
10114 | 134 |       scroll: {
10115 | 135 |         scrollTop: s.scrollTop,
10116 | 136 |         clientHeight: s.clientHeight,
10117 | 137 |         scrollHeight: s.scrollHeight,
10118 | 138 |       },
10119 | 139 |     };
10120 | 140 |   }, scrollerHandle);
10121 | 141 | }
10122 | 142 | 
10123 | 143 | /* ============================================================
10124 | 144 |    ======================= PARSING COUNT =======================
10125 | 145 |    ============================================================ */
10126 | 146 | 
10127 | 147 | function parseCountFromText(str) {
10128 | 148 |   if (!str) return null;
10129 | 149 | 
10130 | 150 |   const raw = String(str)
10131 | 151 |     .toLowerCase()
10132 | 152 |     .replace(/\u00a0/g, " ")
10133 | 153 |     .replace(/\s+/g, " ")
10134 | 154 |     .trim();
10135 | 155 | 
10136 | 156 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
10137 | 157 |   if (!m) return null;
10138 | 158 | 
10139 | 159 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
10140 | 160 |   const suf = (m[2] || "").trim();
10141 | 161 | 
10142 | 162 |   const hasDecimal = /[.,]\d/.test(numStr);
10143 | 163 |   if (hasDecimal) numStr = numStr.replace(",", ".");
10144 | 164 |   else numStr = numStr.replace(/[.,]/g, "");
10145 | 165 | 
10146 | 166 |   let n = Number(numStr);
10147 | 167 |   if (!Number.isFinite(n)) return null;
10148 | 168 | 
10149 | 169 |   if (suf === "k") n *= 1000;
10150 | 170 |   if (suf === "tys" || suf === "tys.") n *= 1000;
10151 | 171 |   if (suf === "m" || suf === "mln") n *= 1000000;
10152 | 172 | 
10153 | 173 |   n = Math.round(n);
10154 | 174 |   if (n <= 0) return null;
10155 | 175 |   return n;
10156 | 176 | }
10157 | 177 | 
10158 | 178 | function parseBestCommentsCountFromBlob(blobStr) {
10159 | 179 |   if (!blobStr) return null;
10160 | 180 | 
10161 | 181 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
10162 | 182 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
10163 | 183 | 
10164 | 184 |   let best = null;
10165 | 185 |   let match;
10166 | 186 |   while ((match = re.exec(raw)) !== null) {
10167 | 187 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
10168 | 188 |     const n = parseCountFromText(candidate);
10169 | 189 |     if (n && (!best || n > best)) best = n;
10170 | 190 |   }
10171 | 191 |   return best;
10172 | 192 | }
10173 | 193 | 
10174 | 194 | function pickBestCount(candidates) {
10175 | 195 |   const nums = candidates.filter((v) => typeof v === "number" && Number.isFinite(v) && v > 0);
10176 | 196 |   if (!nums.length) return null;
10177 | 197 | 
10178 | 198 |   nums.sort((a, b) => b - a);
10179 | 199 |   const best = nums[0];
10180 | 200 |   const second = nums[1];
10181 | 201 | 
10182 | 202 |   if (second && best >= 2 * second && second < 150) return best;
10183 | 203 | 
10184 | 204 |   return best;
10185 | 205 | }
10186 | 206 | 
10187 | 207 | /* ============================================================
10188 | 208 |    =================== COMMENTS CONTAINER FIND =================
10189 | 209 |    ============================================================ */
10190 | 210 | 
10191 | 211 | /**
10192 | 212 |  * WATCH FIX:
10193 | 213 |  * - NIE polegamy na h2 "Komentarze" (czƒôsto go nie ma w Watch).
10194 | 214 |  * - Szukamy najwiƒôkszego klastra link√≥w comment_id/reply_comment_id na stronie.
10195 | 215 |  */
10196 | 216 | async function findCommentsOuter(page) {
10197 | 217 |   const handle = await page.evaluateHandle(() => {
10198 | 218 |     const nodes = Array.from(document.querySelectorAll("div, section, main, article")).slice(0, 30000);
10199 | 219 | 
10200 | 220 |     const visible = (el) => {
10201 | 221 |       if (!el) return false;
10202 | 222 |       const r = el.getBoundingClientRect?.();
10203 | 223 |       return r && r.width >= 220 && r.height >= 220;
10204 | 224 |     };
10205 | 225 | 
10206 | 226 |     let best = null;
10207 | 227 |     let bestScore = -1;
10208 | 228 | 
10209 | 229 |     for (const el of nodes) {
10210 | 230 |       if (!visible(el)) continue;
10211 | 231 | 
10212 | 232 |       const anchors = el.querySelectorAll?.("a[href*='comment_id'], a[href*='reply_comment_id']");
10213 | 233 |       const aCount = anchors ? anchors.length : 0;
10214 | 234 |       if (aCount < 3) continue;
10215 | 235 | 
10216 | 236 |       const txt = (el.innerText || "").toLowerCase();
10217 | 237 |       const hasWords =
10218 | 238 |         txt.includes("komentarz") || txt.includes("komentarzy") || txt.includes("comments") || txt.includes("comment");
10219 | 239 | 
10220 | 240 |       // score: anchor count + bonus za s≈Çowa ‚Äúkomentarz‚Äù
10221 | 241 |       const score = aCount + (hasWords ? 12 : 0);
10222 | 242 | 
10223 | 243 |       if (score > bestScore) {
10224 | 244 |         bestScore = score;
10225 | 245 |         best = el;
10226 | 246 |       }
10227 | 247 |     }
10228 | 248 | 
10229 | 249 |     return best || null;
10230 | 250 |   });
10231 | 251 | 
10232 | 252 |   const el = handle?.asElement?.() || null;
10233 | 253 |   if (!el) return null;
10234 | 254 | 
10235 | 255 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
10236 | 256 |   return ok ? el : null;
10237 | 257 | }
10238 | 258 | 
10239 | 259 | async function findScrollableInOuter(page, outerHandle) {
10240 | 260 |   if (!outerHandle) return null;
10241 | 261 | 
10242 | 262 |   const scrollerHandle = await page.evaluateHandle((outer) => {
10243 | 263 |     function isVisible(el) {
10244 | 264 |       if (!el) return false;
10245 | 265 |       const r = el.getBoundingClientRect();
10246 | 266 |       return r.width > 2 && r.height > 2;
10247 | 267 |     }
10248 | 268 | 
10249 | 269 |     function canScroll(el) {
10250 | 270 |       try {
10251 | 271 |         if (!el) return false;
10252 | 272 |         const st = getComputedStyle(el);
10253 | 273 |         const oy = (st.overflowY || "").toLowerCase();
10254 | 274 |         if (!(oy === "auto" || oy === "scroll")) return false;
10255 | 275 |         const h = el.clientHeight || 0;
10256 | 276 |         const sh = el.scrollHeight || 0;
10257 | 277 |         return sh > h + 80;
10258 | 278 |       } catch {
10259 | 279 |         return false;
10260 | 280 |       }
10261 | 281 |     }
10262 | 282 | 
10263 | 283 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
10264 | 284 |       .filter(isVisible)
10265 | 285 |       .slice(0, 20000);
10266 | 286 | 
10267 | 287 |     let best = null;
10268 | 288 |     let bestScore = -1;
10269 | 289 | 
10270 | 290 |     for (const el of nodes) {
10271 | 291 |       if (!canScroll(el)) continue;
10272 | 292 | 
10273 | 293 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
10274 | 294 |       const txt = (el.innerText || "").toLowerCase();
10275 | 295 | 
10276 | 296 |       const hasMore =
10277 | 297 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
10278 | 298 |         txt.includes("view more comments") ||
10279 | 299 |         txt.includes("see more comments") ||
10280 | 300 |         txt.includes("zobacz wiƒôcej komentarzy") ||
10281 | 301 |         txt.includes("zobacz wcze≈õniejsze komentarze");
10282 | 302 | 
10283 | 303 |       const score = delta + (hasMore ? 100000 : 0);
10284 | 304 |       if (score > bestScore) {
10285 | 305 |         bestScore = score;
10286 | 306 |         best = el;
10287 | 307 |       }
10288 | 308 |     }
10289 | 309 | 
10290 | 310 |     return best || null;
10291 | 311 |   }, outerHandle);
10292 | 312 | 
10293 | 313 |   const el = scrollerHandle?.asElement?.() || null;
10294 | 314 |   if (!el) return null;
10295 | 315 | 
10296 | 316 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
10297 | 317 |   return ok ? el : null;
10298 | 318 | }
10299 | 319 | 
10300 | 320 | async function clickMoreCommentsIfPresent(page, outerHandle) {
10301 | 321 |   if (!outerHandle) return false;
10302 | 322 | 
10303 | 323 |   const labels = [
10304 | 324 |     "wy≈õwietl wiƒôcej komentarzy",
10305 | 325 |     "zobacz wiƒôcej komentarzy",
10306 | 326 |     "zobacz wcze≈õniejsze komentarze",
10307 | 327 |     "view more comments",
10308 | 328 |     "see more comments",
10309 | 329 |     "show more comments",
10310 | 330 |     "view previous comments",
10311 | 331 |   ];
10312 | 332 | 
10313 | 333 |   const clicked = await page.evaluate(
10314 | 334 |     (outer, labelsArr) => {
10315 | 335 |       const norm = (s) =>
10316 | 336 |         String(s || "")
10317 | 337 |           .replace(/\u00a0/g, " ")
10318 | 338 |           .replace(/\s+/g, " ")
10319 | 339 |           .trim()
10320 | 340 |           .toLowerCase();
10321 | 341 | 
10322 | 342 |       const isVisible = (el) => {
10323 | 343 |         if (!el) return false;
10324 | 344 |         const r = el.getBoundingClientRect();
10325 | 345 |         return r.width > 2 && r.height > 2;
10326 | 346 |       };
10327 | 347 | 
10328 | 348 |       const nodes = Array.from(
10329 | 349 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
10330 | 350 |       ).filter(isVisible);
10331 | 351 | 
10332 | 352 |       for (const el of nodes) {
10333 | 353 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
10334 | 354 |         if (!t) continue;
10335 | 355 |         if (labelsArr.some((x) => t.includes(x))) {
10336 | 356 |           try {
10337 | 357 |             el.scrollIntoView({ block: "center" });
10338 | 358 |           } catch {}
10339 | 359 |           const clickable =
10340 | 360 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
10341 | 361 |           try {
10342 | 362 |             clickable.click();
10343 | 363 |             return true;
10344 | 364 |           } catch {}
10345 | 365 |         }
10346 | 366 |       }
10347 | 367 |       return false;
10348 | 368 |     },
10349 | 369 |     outerHandle,
10350 | 370 |     labels
10351 | 371 |   );
10352 | 372 | 
10353 | 373 |   return !!clicked;
10354 | 374 | }
10355 | 375 | 
10356 | 376 | async function getAnchorsCount(page, outerHandle) {
10357 | 377 |   if (!outerHandle) return 0;
10358 | 378 |   return page
10359 | 379 |     .evaluate((outer) => {
10360 | 380 |       const as = Array.from(
10361 | 381 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
10362 | 382 |       );
10363 | 383 |       const ids = new Set();
10364 | 384 |       for (const a of as) {
10365 | 385 |         try {
10366 | 386 |           const u = new URL(a.href, location.origin);
10367 | 387 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
10368 | 388 |           if (id) ids.add(id);
10369 | 389 |         } catch {}
10370 | 390 |       }
10371 | 391 |       return ids.size;
10372 | 392 |     }, outerHandle)
10373 | 393 |     .catch(() => 0);
10374 | 394 | }
10375 | 395 | 
10376 | 396 | async function getCommentRootsCount(page, outerHandle) {
10377 | 397 |   if (!outerHandle) return 0;
10378 | 398 |   return page
10379 | 399 |     .evaluate((outer) => {
10380 | 400 |       const as = Array.from(
10381 | 401 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
10382 | 402 |       );
10383 | 403 |       const roots = new Set();
10384 | 404 |       for (const a of as) {
10385 | 405 |         const root = a.closest?.("[role='article']") || a.closest?.("div");
10386 | 406 |         if (root) roots.add(root);
10387 | 407 |       }
10388 | 408 |       return roots.size;
10389 | 409 |     }, outerHandle)
10390 | 410 |     .catch(() => 0);
10391 | 411 | }
10392 | 412 | 
10393 | 413 | /* ============================================================
10394 | 414 |    ============================ API ============================
10395 | 415 |    ============================================================ */
10396 | 416 | 
10397 | 417 | export async function prepare(page, url) {
10398 | 418 |   log.dev("UI:watch", `Prepare: ${url}`);
10399 | 419 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
10400 | 420 |   if (!ok) throw new Error("safeGoto-failed");
10401 | 421 | 
10402 | 422 |   await acceptCookies(page, "watch-initial");
10403 | 423 | 
10404 | 424 |   const currentUrl = page.url();
10405 | 425 |   if (currentUrl.includes("/login")) {
10406 | 426 |     log.dev("UI:watch", "Login wymagany...");
10407 | 427 |     await fbLogin(page);
10408 | 428 |     await sleepRandom(3000, 4500);
10409 | 429 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
10410 | 430 |     log.dev("UI:watch", `Sesja po login: ${loggedAfterLogin ? "OK" : "BRAK"}`);
10411 | 431 |     if (loggedAfterLogin) {
10412 | 432 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
10413 | 433 |       await acceptCookies(page, "watch-post-login");
10414 | 434 |     } else {
10415 | 435 |       log.dev("UI:watch", "Login failed ‚Äì kontynuujƒô bez sesji");
10416 | 436 |     }
10417 | 437 |   } else {
10418 | 438 |     const logged = await checkIfLogged(page).catch(() => false);
10419 | 439 |     if (!logged) {
10420 | 440 |       log.dev("UI:watch", "Brak sesji ‚Äì fbLogin()");
10421 | 441 |       await fbLogin(page);
10422 | 442 |       await sleepRandom(3000, 4500);
10423 | 443 |       await acceptCookies(page, "watch-after-login");
10424 | 444 |       const logged2 = await checkIfLogged(page).catch(() => false);
10425 | 445 |       log.dev("UI:watch", `Sesja po login: ${logged2 ? "OK" : "BRAK"}`);
10426 | 446 |     }
10427 | 447 |   }
10428 | 448 | 
10429 | 449 |   try {
10430 | 450 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
10431 | 451 |     if (loggedFinal) await saveCookies(page);
10432 | 452 |   } catch {}
10433 | 453 | 
10434 | 454 |   await acceptCookies(page, "watch");
10435 | 455 | 
10436 | 456 |   try {
10437 | 457 |     await page.evaluate(() => {
10438 | 458 |       const vids = Array.from(document.querySelectorAll("video"));
10439 | 459 |       for (const v of vids) {
10440 | 460 |         try {
10441 | 461 |           v.autoplay = false;
10442 | 462 |           v.removeAttribute("autoplay");
10443 | 463 |           v.muted = true;
10444 | 464 |           v.pause();
10445 | 465 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
10446 | 466 |         } catch {}
10447 | 467 |       }
10448 | 468 |     });
10449 | 469 |     log.debug("UI:watch", "Wideo wstrzymane");
10450 | 470 |   } catch (e) {
10451 | 471 |     log.debug("UI:watch", `B≈ÇƒÖd wstrzymania wideo: ${e?.message || e}`);
10452 | 472 |   }
10453 | 473 | 
10454 | 474 |   if (DEBUG_WATCH) {
10455 | 475 |     await safeShot(page, "watch-prepare.png");
10456 | 476 |   }
10457 | 477 | }
10458 | 478 | 
10459 | 479 | export async function getCommentCount(page, url) {
10460 | 480 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
10461 | 481 | 
10462 | 482 |   const parsedFromUiRaw = uiInfo?.raw ? parseBestCommentsCountFromBlob(uiInfo.raw) : null;
10463 | 483 | 
10464 | 484 |   let parsedFromOuter = null;
10465 | 485 |   const outer = await findCommentsOuter(page).catch(() => null);
10466 | 486 |   if (outer) {
10467 | 487 |     parsedFromOuter = await page
10468 | 488 |       .evaluate((o) => (o.innerText || "").replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim(), outer)
10469 | 489 |       .then((txt) => parseBestCommentsCountFromBlob(txt))
10470 | 490 |       .catch(() => null);
10471 | 491 |   }
10472 | 492 | 
10473 | 493 |   const uiDirect =
10474 | 494 |     uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0 ? uiInfo.comments : null;
10475 | 495 | 
10476 | 496 |   const totalComments = pickBestCount([parsedFromOuter, parsedFromUiRaw, uiDirect]);
10477 | 497 | 
10478 | 498 |   log.debug("UI:watch", "Count sources", {
10479 | 499 |     ui_source: uiInfo?.source || null,
10480 | 500 |     ui_viewType: uiInfo?.viewType || null,
10481 | 501 |     ui_comments: uiDirect,
10482 | 502 |     parsedFromUiRaw,
10483 | 503 |     parsedFromOuter,
10484 | 504 |     picked: totalComments,
10485 | 505 |   });
10486 | 506 | 
10487 | 507 |   let final = totalComments;
10488 | 508 | 
10489 | 509 |   log.dev("UI:watch", `Liczba komentarzy: ${final ?? "brak danych"}`);
10490 | 510 |   return final;
10491 | 511 | }
10492 | 512 | 
10493 | 513 | export async function loadAllComments(page, { expectedTotal } = {}) {
10494 | 514 |   log.dev("UI:watch", "≈Åadujƒô komentarze...");
10495 | 515 | 
10496 | 516 |   let maxCycles = 40;
10497 | 517 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
10498 | 518 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
10499 | 519 |   }
10500 | 520 |   log.debug("UI:watch", `maxCycles=${maxCycles}`);
10501 | 521 | 
10502 | 522 |   const outer = await findCommentsOuter(page);
10503 | 523 |   if (!outer) {
10504 | 524 |     log.debug("UI:watch", "OUTER NOT FOUND");
10505 | 525 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
10506 | 526 |     return;
10507 | 527 |   }
10508 | 528 | 
10509 | 529 |   if (DEBUG_WATCH) {
10510 | 530 |     const stats = await debugOuterStats(page, outer);
10511 | 531 |     log.debug("UI:watch", "OUTER stats", stats);
10512 | 532 |     await shotElement(page, outer, "watch-outer.png");
10513 | 533 |   }
10514 | 534 | 
10515 | 535 |   const scroller = await findScrollableInOuter(page, outer);
10516 | 536 | 
10517 | 537 |   if (DEBUG_WATCH) {
10518 | 538 |     if (scroller) {
10519 | 539 |       const sstats = await debugScrollerStats(page, scroller);
10520 | 540 |       log.debug("UI:watch", "SCROLLER stats", sstats);
10521 | 541 |       await shotElement(page, scroller, "watch-scroller.png");
10522 | 542 |     } else {
10523 | 543 |       log.debug("UI:watch", "SCROLLER NOT FOUND -> window scroll fallback");
10524 | 544 |       await safeShot(page, "watch-no-scroller.png");
10525 | 545 |     }
10526 | 546 |   }
10527 | 547 | 
10528 | 548 |   let prevAnchors = await getAnchorsCount(page, outer);
10529 | 549 |   let prevRoots = await getCommentRootsCount(page, outer);
10530 | 550 |   let noProgress = 0;
10531 | 551 | 
10532 | 552 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
10533 | 553 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
10534 | 554 | 
10535 | 555 |     let wheeled = false;
10536 | 556 |     let beforeST = 0;
10537 | 557 |     let afterST = 0;
10538 | 558 | 
10539 | 559 |     if (scroller) {
10540 | 560 |       try {
10541 | 561 |         beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
10542 | 562 |       } catch {}
10543 | 563 | 
10544 | 564 |       try {
10545 | 565 |         const box = await scroller.boundingBox();
10546 | 566 |         if (box && box.width > 5 && box.height > 5) {
10547 | 567 |           await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
10548 | 568 |           await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
10549 | 569 |           wheeled = true;
10550 | 570 |         }
10551 | 571 |       } catch {}
10552 | 572 | 
10553 | 573 |       await sleepRandom(450, 850);
10554 | 574 | 
10555 | 575 |       try {
10556 | 576 |         afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
10557 | 577 |       } catch {}
10558 | 578 |     } else {
10559 | 579 |       try {
10560 | 580 |         beforeST = await page.evaluate(() => {
10561 | 581 |           const el = document.scrollingElement || document.documentElement;
10562 | 582 |           return el ? el.scrollTop || 0 : 0;
10563 | 583 |         });
10564 | 584 |       } catch {}
10565 | 585 |       try {
10566 | 586 |         await page.mouse.wheel({ deltaY: 900 });
10567 | 587 |         wheeled = true;
10568 | 588 |       } catch {}
10569 | 589 |       await sleepRandom(450, 850);
10570 | 590 |       try {
10571 | 591 |         afterST = await page.evaluate(() => {
10572 | 592 |           const el = document.scrollingElement || document.documentElement;
10573 | 593 |           return el ? el.scrollTop || 0 : 0;
10574 | 594 |         });
10575 | 595 |       } catch {}
10576 | 596 |     }
10577 | 597 | 
10578 | 598 |     const curAnchors = await getAnchorsCount(page, outer);
10579 | 599 |     const curRoots = await getCommentRootsCount(page, outer);
10580 | 600 | 
10581 | 601 |     const progressed = curAnchors > prevAnchors || curRoots > prevRoots;
10582 | 602 | 
10583 | 603 |     if (progressed) {
10584 | 604 |       prevAnchors = curAnchors;
10585 | 605 |       prevRoots = curRoots;
10586 | 606 |       noProgress = 0;
10587 | 607 |     } else {
10588 | 608 |       noProgress++;
10589 | 609 |     }
10590 | 610 | 
10591 | 611 |     if (cycle === 1 || cycle % 10 === 0) {
10592 | 612 |       log.debug("UI:watch", `cycle ${cycle}/${maxCycles}: anchors=${curAnchors}, roots=${curRoots}, np=${noProgress}`);
10593 | 613 |     }
10594 | 614 | 
10595 | 615 |     if (DEBUG_WATCH && cycle === 5) {
10596 | 616 |       await safeShot(page, "watch-after-5.png");
10597 | 617 |     }
10598 | 618 | 
10599 | 619 |     if (noProgress >= 8) {
10600 | 620 |       log.debug("UI:watch", "Brak postƒôpu ‚Äì przerywam");
10601 | 621 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
10602 | 622 |       break;
10603 | 623 |     }
10604 | 624 |   }
10605 | 625 | 
10606 | 626 |   log.dev("UI:watch", "Komentarze za≈Çadowane");
10607 | 627 | }
10608 | 628 | 
10609 | 629 | export async function extractComments(page, url) {
10610 | 630 |   const outer = await findCommentsOuter(page).catch(() => null);
10611 | 631 |   if (!outer) {
10612 | 632 |     log.debug("UI:watch", "extractComments: OUTER NOT FOUND");
10613 | 633 |     if (DEBUG_WATCH) await safeShot(page, "watch-extract-no-outer.png");
10614 | 634 |     return [];
10615 | 635 |   }
10616 | 636 | 
10617 | 637 |   const comments = await page.evaluate((outerEl) => {
10618 | 638 |     function norm(s) {
10619 | 639 |       return String(s || "")
10620 | 640 |         .replace(/\u00a0/g, " ")
10621 | 641 |         .replace(/\s+/g, " ")
10622 | 642 |         .trim();
10623 | 643 |     }
10624 | 644 | 
10625 | 645 |     function toAbsHref(href) {
10626 | 646 |       if (!href) return null;
10627 | 647 |       if (href.startsWith("http")) return href;
10628 | 648 |       if (href.startsWith("/")) return `${location.origin}${href}`;
10629 | 649 |       return href;
10630 | 650 |     }
10631 | 651 | 
10632 | 652 |     function getCommentId(href) {
10633 | 653 |       try {
10634 | 654 |         const u = new URL(href, location.origin);
10635 | 655 |         return u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
10636 | 656 |       } catch {
10637 | 657 |         return null;
10638 | 658 |       }
10639 | 659 |     }
10640 | 660 | 
10641 | 661 |     function normalizeTime(text) {
10642 | 662 |       if (!text) return null;
10643 | 663 | 
10644 | 664 |       const t = norm(text).toLowerCase();
10645 | 665 |       if (!t) return null;
10646 | 666 | 
10647 | 667 |       if (t.includes("przed chwilƒÖ")) return "0 min";
10648 | 668 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
10649 | 669 |       if (t.includes("wczoraj") || t.includes("yesterday")) return "wczoraj";
10650 | 670 | 
10651 | 671 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
10652 | 672 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô)\b/.test(t)) return t;
10653 | 673 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
10654 | 674 |       if (/^\d+\s*(dzie≈Ñ|dni|d)\b/.test(t)) return t;
10655 | 675 |       if (/^\d+\s*(tyg|tyg\.|week|weeks)\b/.test(t)) return t;
10656 | 676 | 
10657 | 677 |       return null;
10658 | 678 |     }
10659 | 679 | 
10660 | 680 |     function findTimeInRoot(root) {
10661 | 681 |       if (!root) return null;
10662 | 682 | 
10663 | 683 |       const els = Array.from(root.querySelectorAll("abbr, a, span")).slice(0, 250);
10664 | 684 |       for (const el of els) {
10665 | 685 |         const aria = el.getAttribute?.("aria-label");
10666 | 686 |         const t1 = normalizeTime(aria);
10667 | 687 |         if (t1) return t1;
10668 | 688 | 
10669 | 689 |         const title = el.getAttribute?.("title");
10670 | 690 |         const t2 = normalizeTime(title);
10671 | 691 |         if (t2) return t2;
10672 | 692 | 
10673 | 693 |         const txt = el.textContent;
10674 | 694 |         const t3 = normalizeTime(txt);
10675 | 695 |         if (t3) return t3;
10676 | 696 |       }
10677 | 697 |       return null;
10678 | 698 |     }
10679 | 699 | 
10680 | 700 |     const anchors = Array.from(
10681 | 701 |       outerEl.querySelectorAll("a[href*='comment_id='], a[href*='reply_comment_id=']")
10682 | 702 |     );
10683 | 703 | 
10684 | 704 |     const seenRoots = new Set();
10685 | 705 |     const out = [];
10686 | 706 | 
10687 | 707 |     for (const a of anchors) {
10688 | 708 |       const href = a.getAttribute("href") || a.href || null;
10689 | 709 |       const absHref = toAbsHref(href);
10690 | 710 | 
10691 | 711 |       const id = absHref ? getCommentId(absHref) : null;
10692 | 712 |       if (!id) continue;
10693 | 713 | 
10694 | 714 |       const root = a.closest?.("[role='article']") || a.closest?.("div") || null;
10695 | 715 |       if (!root) continue;
10696 | 716 |       if (seenRoots.has(root)) continue;
10697 | 717 |       seenRoots.add(root);
10698 | 718 | 
10699 | 719 |       const author =
10700 | 720 |         norm(root.querySelector("a[role='link'] span")?.textContent) ||
10701 | 721 |         norm(root.querySelector("strong")?.textContent) ||
10702 | 722 |         null;
10703 | 723 | 
10704 | 724 |       const autos = Array.from(root.querySelectorAll("[dir='auto']"))
10705 | 725 |         .map((el) => norm(el.textContent))
10706 | 726 |         .filter(Boolean);
10707 | 727 | 
10708 | 728 |       let text = "";
10709 | 729 |       if (autos.length) text = autos[autos.length - 1];
10710 | 730 | 
10711 | 731 |       const time = findTimeInRoot(root);
10712 | 732 | 
10713 | 733 |       if (!author && !text) continue;
10714 | 734 | 
10715 | 735 |       out.push({
10716 | 736 |         id,
10717 | 737 |         author,
10718 | 738 |         text,
10719 | 739 |         permalink: absHref,
10720 | 740 |         time: time || null,
10721 | 741 |       });
10722 | 742 |     }
10723 | 743 | 
10724 | 744 |     return out;
10725 | 745 |   }, outer);
10726 | 746 | 
10727 | 747 |   log.debug("UI:watch", `Wyekstrahowano ${comments.length} komentarzy`);
10728 | 748 |   return comments;
10729 | 749 | }
10730 | 750 | 
10731 | 751 | export async function debugSnapshot(page) {
10732 | 752 |   try {
10733 | 753 |     const path = `snapshot-watch.png`;
10734 | 754 |     await page.screenshot({ path });
10735 | 755 |     log.debug("UI:watch", `Zapisano zrzut: ${path}`);
10736 | 756 |   } catch (e) {
10737 | 757 |     log.error("UI:watch", `B≈ÇƒÖd zapisu zrzutu: ${e?.message || e}`);
10738 | 758 |   }
10739 | 759 | }
10740 | 760 | 
10741 | ```
10742 | 
10743 | ---
10744 | 
10745 | ### üìÑ ≈öcie≈ºka: `src/fb/uiCommentInfo.js`
10746 | **Typ:** JavaScript/tekst  
10747 | **Opis:** Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).  
10748 | 
10749 | ```js
10750 |   1 | // src/fb/uiCommentInfo.js
10751 |   2 | // UI: wykrywanie typu widoku + wyciƒÖganie liczby komentarzy z meta-linii (reakcje | komentarze | udostƒôpnienia)
10752 |   3 | // FIX: photo view -> meta row + filtr sklejonych liczb typu "287368".
10753 |   4 | // VIDEO/WATCH: komentarze czƒôsto sƒÖ jako: [LICZBA] + [IKONKA], bez tekstu "Komentarz" -> bierzemy z button√≥w z ikonkƒÖ.
10754 |   5 | 
10755 |   6 | export async function getUiCommentInfo(page) {
10756 |   7 |   return page.evaluate(() => {
10757 |   8 |     function norm(str) {
10758 |   9 |       if (!str) return "";
10759 |  10 |       return String(str).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
10760 |  11 |     }
10761 |  12 | 
10762 |  13 |     function detectViewType() {
10763 |  14 |       const href = location.href || "";
10764 |  15 |       const isWatch = href.includes("/watch");
10765 |  16 |       const isVideo = isWatch || /\/videos\/|[?&]v=/i.test(href);
10766 |  17 |       const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(href);
10767 |  18 | 
10768 |  19 |       if (isWatch) return "watch";
10769 |  20 |       if (isVideo) return "video";
10770 |  21 |       if (isPhoto) return "photo";
10771 |  22 |       return "permalink";
10772 |  23 |     }
10773 |  24 | 
10774 |  25 |     function isVisibleRough(el) {
10775 |  26 |       if (!el) return false;
10776 |  27 |       const st = window.getComputedStyle(el);
10777 |  28 |       if (!st) return true;
10778 |  29 |       if (st.display === "none" || st.visibility === "hidden") return false;
10779 |  30 |       return true;
10780 |  31 |     }
10781 |  32 | 
10782 |  33 |     // pojedynczy token liczbowy (np. "286", "7,8 tys.") ‚Äì odrzuca wieloliczbowe i "x z y"
10783 |  34 |     function parseSingleCount(str) {
10784 |  35 |       const s = norm(str).toLowerCase();
10785 |  36 |       if (!s) return null;
10786 |  37 | 
10787 |  38 |       // odrzuƒá "x z y"
10788 |  39 |       if (/\b\d+\s*z\s*\d+\b/i.test(s)) return null;
10789 |  40 | 
10790 |  41 |       // je≈õli sƒÖ >=2 grupy cyfr -> odrzucamy (ubija "7,8", "286 368", "1 234")
10791 |  42 |       const groups = s.match(/\d+/g);
10792 |  43 |       if (groups && groups.length > 1) return null;
10793 |  44 | 
10794 |  45 |       const m = s.match(/^(\d[\d.,]*)\s*(k|tys|ty≈õ|mln|m)?$/i);
10795 |  46 |       if (!m) return null;
10796 |  47 | 
10797 |  48 |       const raw = m[1];
10798 |  49 |       const suf = (m[2] || "").toLowerCase();
10799 |  50 | 
10800 |  51 |       let value = parseInt(raw.replace(/[^\d]/g, ""), 10);
10801 |  52 |       if (!Number.isFinite(value)) return null;
10802 |  53 | 
10803 |  54 |       if (suf === "k" || suf === "tys" || suf === "ty≈õ") value *= 1000;
10804 |  55 |       else if (suf === "mln" || suf === "m") value *= 1000000;
10805 |  56 | 
10806 |  57 |       return Math.round(value);
10807 |  58 |     }
10808 |  59 | 
10809 |  60 |     function findActionBarRoot() {
10810 |  61 |       const candidates = Array.from(document.querySelectorAll("div, section, footer"))
10811 |  62 |         .filter(isVisibleRough)
10812 |  63 |         .slice(0, 12000);
10813 |  64 | 
10814 |  65 |       for (const el of candidates) {
10815 |  66 |         const t = norm(el.innerText).toLowerCase();
10816 |  67 |         if (!t) continue;
10817 |  68 | 
10818 |  69 |         const hasLike = t.includes("lubiƒô to") || t.includes("like");
10819 |  70 |         const hasComment = t.includes("komentarz") || t.includes("comment");
10820 |  71 |         const hasShare = t.includes("udostƒôpnij") || t.includes("share");
10821 |  72 | 
10822 |  73 |         if (hasLike && hasComment && hasShare) {
10823 |  74 |           if (t.length > 2200) continue;
10824 |  75 |           return el;
10825 |  76 |         }
10826 |  77 |       }
10827 |  78 |       return null;
10828 |  79 |     }
10829 |  80 | 
10830 |  81 |     // usuwa tokeny typu "287368", je≈õli w tym samym zbiorze istniejƒÖ "287" i "368"
10831 |  82 |     function dropConcatenations(list) {
10832 |  83 |       const strSet = new Set(list.map((x) => String(x.v)));
10833 |  84 | 
10834 |  85 |       function isConcatOfTwoExisting(vStr) {
10835 |  86 |         if (vStr.length < 5) return false;
10836 |  87 |         for (let i = 1; i < vStr.length; i++) {
10837 |  88 |           const left = vStr.slice(0, i);
10838 |  89 |           const right = vStr.slice(i);
10839 |  90 |           if (left.length < 2 || right.length < 2) continue;
10840 |  91 |           if (strSet.has(left) && strSet.has(right)) return true;
10841 |  92 |         }
10842 |  93 |         return false;
10843 |  94 |       }
10844 |  95 | 
10845 |  96 |       const out = [];
10846 |  97 |       for (const x of list) {
10847 |  98 |         const vStr = String(x.v);
10848 |  99 |         if (isConcatOfTwoExisting(vStr)) continue;
10849 | 100 |         out.push(x);
10850 | 101 |       }
10851 | 102 |       return out;
10852 | 103 |     }
10853 | 104 | 
10854 | 105 |     function extractFromMetaRow(actionRoot) {
10855 | 106 |       if (!actionRoot) return { comments: null, shares: null, raw: null };
10856 | 107 | 
10857 | 108 |       const badWords = [
10858 | 109 |         "odpowiedz",
10859 | 110 |         "wy≈õwietl",
10860 | 111 |         "zobacz",
10861 | 112 |         "najtrafniejsze",
10862 | 113 |         "najnowsze",
10863 | 114 |         "lider",
10864 | 115 |         "edytowano",
10865 | 116 |       ];
10866 | 117 | 
10867 | 118 |       const divs = Array.from(actionRoot.querySelectorAll("div"))
10868 | 119 |         .filter(isVisibleRough)
10869 | 120 |         .slice(0, 6000);
10870 | 121 | 
10871 | 122 |       const scored = [];
10872 | 123 | 
10873 | 124 |       for (const d of divs) {
10874 | 125 |         const text = norm(d.innerText);
10875 | 126 |         if (!text) continue;
10876 | 127 | 
10877 | 128 |         const low = text.toLowerCase();
10878 | 129 |         const hasReactions = low.includes("wszystkie reakcje") || low.includes("all reactions");
10879 | 130 |         if (!hasReactions) continue;
10880 | 131 | 
10881 | 132 |         if (low.length > 260) continue;
10882 | 133 |         if (badWords.some((w) => low.includes(w))) continue;
10883 | 134 | 
10884 | 135 |         const atoms = Array.from(d.querySelectorAll("span, a, div"))
10885 | 136 |           .filter(isVisibleRough)
10886 | 137 |           .map((el) => norm(el.textContent))
10887 | 138 |           .filter((s) => s && s.length <= 20);
10888 | 139 | 
10889 | 140 |         let nums = [];
10890 | 141 |         for (const s of atoms) {
10891 | 142 |           const v = parseSingleCount(s);
10892 | 143 |           if (v == null) continue;
10893 | 144 |           nums.push({ v, s });
10894 | 145 |         }
10895 | 146 | 
10896 | 147 |         const seen = new Set();
10897 | 148 |         let uniq = [];
10898 | 149 |         for (const n of nums) {
10899 | 150 |           const key = `${n.v}:${n.s}`;
10900 | 151 |           if (seen.has(key)) continue;
10901 | 152 |           seen.add(key);
10902 | 153 |           uniq.push(n);
10903 | 154 |         }
10904 | 155 | 
10905 | 156 |         uniq = dropConcatenations(uniq);
10906 | 157 | 
10907 | 158 |         if (uniq.length < 2) continue;
10908 | 159 | 
10909 | 160 |         let score = 0;
10910 | 161 |         score += uniq.length === 2 ? 300 : 0;
10911 | 162 |         score += Math.max(0, 260 - low.length);
10912 | 163 | 
10913 | 164 |         scored.push({ uniq, score, lowLen: low.length });
10914 | 165 |       }
10915 | 166 | 
10916 | 167 |       scored.sort((a, b) => b.score - a.score);
10917 | 168 |       const best = scored[0];
10918 | 169 |       if (!best) return { comments: null, shares: null, raw: null };
10919 | 170 | 
10920 | 171 |       const comments = best.uniq[0]?.v ?? null;
10921 | 172 |       const shares = best.uniq[1]?.v ?? null;
10922 | 173 | 
10923 | 174 |       const raw = `metaRow len=${best.lowLen} nums=${best.uniq
10924 | 175 |         .map((x) => `${x.v}:${x.s}`)
10925 | 176 |         .join(" | ")} -> comments=${comments} shares=${shares}`;
10926 | 177 | 
10927 | 178 |       return { comments, shares, raw };
10928 | 179 |     }
10929 | 180 | 
10930 | 181 |     // VIDEO/WATCH: wyciƒÖgnij komentarze z przycisku "liczba + ikonka"
10931 | 182 |     function extractVideoCommentsFromIconButtons() {
10932 | 183 |       const btns = Array.from(document.querySelectorAll('[role="button"][tabindex="0"]'))
10933 | 184 |         .filter(isVisibleRough)
10934 | 185 |         .slice(0, 12000);
10935 | 186 | 
10936 | 187 |       function hasSuffixToken(t) {
10937 | 188 |         const s = norm(t).toLowerCase();
10938 | 189 |         return /\b(tys|ty≈õ|k|mln|m)\b/.test(s);
10939 | 190 |       }
10940 | 191 | 
10941 | 192 |       const candidates = [];
10942 | 193 | 
10943 | 194 |       for (const b of btns) {
10944 | 195 |         // wariant 1: ikona jako <i data-visualcompletion="css-img">
10945 | 196 |         const iconI = b.querySelector('i[data-visualcompletion="css-img"]');
10946 | 197 |         // wariant 2 (na przysz≈Ço≈õƒá): ikona jako svg
10947 | 198 |         const iconSvg = b.querySelector("svg");
10948 | 199 | 
10949 | 200 |         if (!iconI && !iconSvg) continue;
10950 | 201 | 
10951 | 202 |         const toks = Array.from(b.querySelectorAll("span, a, div"))
10952 | 203 |           .filter(isVisibleRough)
10953 | 204 |           .map((el) => norm(el.textContent))
10954 | 205 |           .filter((t) => t && t.length <= 20);
10955 | 206 | 
10956 | 207 |         if (!toks.length) continue;
10957 | 208 | 
10958 | 209 |         // odetnij tys/mln (np. 496 tys.)
10959 | 210 |         if (toks.some(hasSuffixToken)) continue;
10960 | 211 | 
10961 | 212 |         // szukamy czystej liczby (np. 127)
10962 | 213 |         let value = null;
10963 | 214 |         let rawToken = null;
10964 | 215 | 
10965 | 216 |         for (const t of toks) {
10966 | 217 |           if (!/^\d[\d.,]*$/.test(t)) continue;
10967 | 218 |           const v = parseSingleCount(t);
10968 | 219 |           if (v == null) continue;
10969 | 220 |           value = v;
10970 | 221 |           rawToken = t;
10971 | 222 |           break;
10972 | 223 |         }
10973 | 224 | 
10974 | 225 |         if (value == null) continue;
10975 | 226 | 
10976 | 227 |         const aria =
10977 | 228 |           norm(b.getAttribute("aria-label")) +
10978 | 229 |           " " +
10979 | 230 |           norm((iconI && iconI.getAttribute && iconI.getAttribute("aria-label")) || "");
10980 | 231 | 
10981 | 232 |         const lowAria = aria.toLowerCase();
10982 | 233 | 
10983 | 234 |         let score = 0;
10984 | 235 | 
10985 | 236 |         // je≈õli gdziekolwiek pada "komentarz/comment" -> z≈Çoto
10986 | 237 |         if (/\b(comment|comments|komentarz|komentarze)\b/.test(lowAria)) score += 120;
10987 | 238 | 
10988 | 239 |         // komentarze raczej nie sƒÖ mikro (1..9) w takim przycisku
10989 | 240 |         if (value <= 9) score -= 60;
10990 | 241 | 
10991 | 242 |         // komentarze czƒôsto sƒÖ 10..5000+ -> lekka premia
10992 | 243 |         if (value >= 10 && value <= 500000) score += 20;
10993 | 244 | 
10994 | 245 |         candidates.push({
10995 | 246 |           value,
10996 | 247 |           score,
10997 | 248 |           raw: `iconBtn token=${rawToken} toks=${toks.join(" | ")} aria=${aria}`.slice(0, 500),
10998 | 249 |         });
10999 | 250 |       }
11000 | 251 | 
11001 | 252 |       if (!candidates.length) {
11002 | 253 |         return { comments: null, raw: "videoIconButtons: not-found" };
11003 | 254 |       }
11004 | 255 | 
11005 | 256 |       candidates.sort((a, b) => b.score - a.score || b.value - a.value);
11006 | 257 |       const best = candidates[0];
11007 | 258 | 
11008 | 259 |       return {
11009 | 260 |         comments: best.value,
11010 | 261 |         raw: `videoIconButtons best=${best.value} score=${best.score} ${best.raw}`,
11011 | 262 |       };
11012 | 263 |     }
11013 | 264 | 
11014 | 265 |     // VIDEO/WATCH: fallback ‚Äì pr√≥ba klasycznego "near labels" (u Ciebie)
11015 | 266 |     function extractNearLabels(actionRoot) {
11016 | 267 |       const LIKE_WORDS = ["lubiƒô to", "like"];
11017 | 268 |       const COMMENT_WORDS = ["komentarz", "comment"];
11018 | 269 |       const SHARE_WORDS = ["udostƒôpnij", "share"];
11019 | 270 | 
11020 | 271 |       function hasAny(low, arr) {
11021 | 272 |         return arr.some((w) => low.includes(w));
11022 | 273 |       }
11023 | 274 | 
11024 | 275 |       function getNodeLabel(el) {
11025 | 276 |         if (!el) return "";
11026 | 277 |         const a = norm(el.getAttribute?.("aria-label"));
11027 | 278 |         if (a) return a;
11028 | 279 |         return norm(el.textContent);
11029 | 280 |       }
11030 | 281 | 
11031 | 282 |       function findActionRowContainer(startEl) {
11032 | 283 |         let cur = startEl;
11033 | 284 |         for (let up = 0; up < 8 && cur; up++) {
11034 | 285 |           const t = norm(cur.innerText).toLowerCase();
11035 | 286 |           if (
11036 | 287 |             t &&
11037 | 288 |             hasAny(t, LIKE_WORDS) &&
11038 | 289 |             hasAny(t, COMMENT_WORDS) &&
11039 | 290 |             hasAny(t, SHARE_WORDS)
11040 | 291 |           ) {
11041 | 292 |             return cur;
11042 | 293 |           }
11043 | 294 |           cur = cur.parentElement;
11044 | 295 |         }
11045 | 296 |         return null;
11046 | 297 |       }
11047 | 298 | 
11048 | 299 |       const scope = document.body;
11049 | 300 | 
11050 | 301 |       const clickable = Array.from(scope.querySelectorAll('[role="button"], a, span, div'))
11051 | 302 |         .filter(isVisibleRough)
11052 | 303 |         .slice(0, 20000);
11053 | 304 | 
11054 | 305 |       const commentNodes = [];
11055 | 306 |       for (const el of clickable) {
11056 | 307 |         const low = getNodeLabel(el).toLowerCase();
11057 | 308 |         if (!low) continue;
11058 | 309 |         if (hasAny(low, COMMENT_WORDS)) commentNodes.push(el);
11059 | 310 |       }
11060 | 311 | 
11061 | 312 |       const scored = [];
11062 | 313 |       for (const cn of commentNodes) {
11063 | 314 |         const row = findActionRowContainer(cn);
11064 | 315 |         if (!row) continue;
11065 | 316 | 
11066 | 317 |         const rowText = norm(row.innerText).toLowerCase();
11067 | 318 |         if (!rowText) continue;
11068 | 319 | 
11069 | 320 |         if (rowText.includes("wszystkie reakcje") || rowText.includes("all reactions")) continue;
11070 | 321 | 
11071 | 322 |         const parts = Array.from(row.querySelectorAll("span, a, div, [role='button']"))
11072 | 323 |           .filter(isVisibleRough)
11073 | 324 |           .map((n) => getNodeLabel(n))
11074 | 325 |           .map((s) => norm(s))
11075 | 326 |           .filter((s) => s && s.length <= 40);
11076 | 327 | 
11077 | 328 |         const anyNum = parts.some((s) => parseSingleCount(s) != null);
11078 | 329 |         if (!anyNum) continue;
11079 | 330 | 
11080 | 331 |         let score = 0;
11081 | 332 |         score += Math.max(0, 600 - rowText.length);
11082 | 333 |         score += Math.max(0, 120 - parts.length);
11083 | 334 | 
11084 | 335 |         scored.push({ row, parts, rowLen: rowText.length, score });
11085 | 336 |       }
11086 | 337 | 
11087 | 338 |       scored.sort((a, b) => b.score - a.score);
11088 | 339 |       const best = scored[0];
11089 | 340 | 
11090 | 341 |       if (!best) {
11091 | 342 |         return { comments: null, shares: null, raw: "nearLabels: no-action-row-found" };
11092 | 343 |       }
11093 | 344 | 
11094 | 345 |       const tokensLow = best.parts.map((s) => s.toLowerCase());
11095 | 346 | 
11096 | 347 |       const idxLike = tokensLow.findIndex((t) => hasAny(t, LIKE_WORDS));
11097 | 348 |       const idxComment = tokensLow.findIndex((t) => hasAny(t, COMMENT_WORDS));
11098 | 349 |       const idxShare = tokensLow.findIndex((t) => hasAny(t, SHARE_WORDS));
11099 | 350 | 
11100 | 351 |       function scanLeftForNumber(fromIdx) {
11101 | 352 |         if (fromIdx == null || fromIdx < 0) return null;
11102 | 353 |         for (let i = fromIdx - 1; i >= 0 && i >= fromIdx - 14; i--) {
11103 | 354 |           const v = parseSingleCount(best.parts[i]);
11104 | 355 |           if (v != null) return { v, at: i, token: best.parts[i] };
11105 | 356 |         }
11106 | 357 |         return null;
11107 | 358 |       }
11108 | 359 | 
11109 | 360 |       let cPick = scanLeftForNumber(idxComment);
11110 | 361 |       if (!cPick) cPick = scanLeftForNumber(idxLike);
11111 | 362 | 
11112 | 363 |       let sPick = scanLeftForNumber(idxShare);
11113 | 364 |       if (cPick && sPick && sPick.v === cPick.v) sPick = null;
11114 | 365 | 
11115 | 366 |       const raw = `nearLabels[actionRow] len=${best.rowLen} tokens=${best.parts.join(
11116 | 367 |         " | "
11117 | 368 |       )} -> idxLike=${idxLike} idxComment=${idxComment} idxShare=${idxShare} | comments=${
11118 | 369 |         cPick ? `${cPick.v}(${cPick.token})@${cPick.at}` : "null"
11119 | 370 |       } | shares=${sPick ? `${sPick.v}(${sPick.token})@${sPick.at}` : "null"}`;
11120 | 371 | 
11121 | 372 |       return {
11122 | 373 |         comments: cPick ? cPick.v : null,
11123 | 374 |         shares: sPick ? sPick.v : null,
11124 | 375 |         raw,
11125 | 376 |       };
11126 | 377 |     }
11127 | 378 | 
11128 | 379 |     const viewType = detectViewType();
11129 | 380 |     const actionRoot = findActionBarRoot();
11130 | 381 | 
11131 | 382 |     let meta;
11132 | 383 | 
11133 | 384 |     if (viewType === "video" || viewType === "watch") {
11134 | 385 |       // 1) pr√≥buj najpierw ikonki (to jest Tw√≥j przypadek z 127 / 496 tys.)
11135 | 386 |       meta = extractVideoCommentsFromIconButtons();
11136 | 387 | 
11137 | 388 |       // 2) fallback: near labels (jak w Twoim kodzie)
11138 | 389 |       if (meta.comments == null) {
11139 | 390 |         const near = extractNearLabels(actionRoot);
11140 | 391 |         meta = { comments: near.comments, raw: near.raw };
11141 | 392 |       }
11142 | 393 |     } else {
11143 | 394 |       // photo/permalink stabilne -> nie ruszamy
11144 | 395 |       meta = extractFromMetaRow(actionRoot);
11145 | 396 |     }
11146 | 397 | 
11147 | 398 |     return {
11148 | 399 |       source: `ui-${viewType}`,
11149 | 400 |       viewType,
11150 | 401 |       comments: meta.comments,
11151 | 402 |       raw: meta.raw,
11152 | 403 |     };
11153 | 404 |   });
11154 | 405 | }
11155 | 406 | 
11156 | ```
11157 | 
11158 | ---
11159 | 
11160 | ### üìÑ ≈öcie≈ºka: `src/index.js`
11161 | **Typ:** JavaScript/tekst  
11162 | **Opis:** Plik projektu (kod/konfiguracja).  
11163 | 
11164 | ```js
11165 |  1 | if (process.env.__WATCHER_LOCKED__) {
11166 |  2 |   console.error("WATCHER DUPLICATE START ‚Äî EXIT");
11167 |  3 |   process.exit(1);
11168 |  4 | }
11169 |  5 | process.env.__WATCHER_LOCKED__ = "1";
11170 |  6 | 
11171 |  7 | const __log = console.log;
11172 |  8 | console.log = (...args) => {
11173 |  9 |   const ts = new Date().toISOString().replace("T"," ").replace("Z","");
11174 | 10 |   __log(`[${ts}]`, ...args);
11175 | 11 | };
11176 | 12 | 
11177 | 13 | // src/index.js
11178 | 14 | import "dotenv/config";
11179 | 15 | import fs from "fs";
11180 | 16 | import path from "path";
11181 | 17 | import { startWatcher } from "./watcher.js";
11182 | 18 | import { sendOwnerAlert } from "./telegram.js";
11183 | 19 | 
11184 | 20 | function ensureDir(p) {
11185 | 21 |   try {
11186 | 22 |     fs.mkdirSync(p, { recursive: true });
11187 | 23 |   } catch {}
11188 | 24 | }
11189 | 25 | 
11190 | 26 | // Ustal katalogi serwerowe (≈ºeby nie wali≈Ço w /tmp losowo)
11191 | 27 | const DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), "data");
11192 | 28 | const TMP_DIR = process.env.TMP_DIR || path.join(process.cwd(), "tmp");
11193 | 29 | ensureDir(DATA_DIR);
11194 | 30 | ensureDir(TMP_DIR);
11195 | 31 | 
11196 | 32 | // czas + logi
11197 | 33 | console.log("[BOOT] NODE_ENV =", process.env.NODE_ENV || "dev");
11198 | 34 | console.log("[BOOT] TZ =", process.env.TZ || "system");
11199 | 35 | console.log("[BOOT] DATA_DIR =", DATA_DIR);
11200 | 36 | console.log("[BOOT] TMP_DIR =", TMP_DIR);
11201 | 37 | console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);
11202 | 38 | 
11203 | 39 | // helper
11204 | 40 | function safeToString(x) {
11205 | 41 |   try {
11206 | 42 |     if (x instanceof Error) return `${x.message}\n${x.stack || ""}`;
11207 | 43 |     if (typeof x === "string") return x;
11208 | 44 |     return JSON.stringify(x, null, 2);
11209 | 45 |   } catch {
11210 | 46 |     return String(x);
11211 | 47 |   }
11212 | 48 | }
11213 | 49 | 
11214 | 50 | // anti-loop
11215 | 51 | let _inAlert = false;
11216 | 52 | function fireAlert(title, message) {
11217 | 53 |   if (_inAlert) return;
11218 | 54 |   _inAlert = true;
11219 | 55 |   sendOwnerAlert(title, message).catch(() => {}).finally(() => (_inAlert = false));
11220 | 56 | }
11221 | 57 | 
11222 | 58 | // HOOKI na b≈Çƒôdy (muszƒÖ byƒá przed startWatcher)
11223 | 59 | const _origErr = console.error.bind(console);
11224 | 60 | console.error = (...args) => {
11225 | 61 |   _origErr(...args);
11226 | 62 |   fireAlert("console.error", args.map(safeToString).join(" "));
11227 | 63 | };
11228 | 64 | 
11229 | 65 | process.on("unhandledRejection", (reason) => {
11230 | 66 |   _origErr("[unhandledRejection]", reason);
11231 | 67 |   fireAlert("unhandledRejection", safeToString(reason));
11232 | 68 | });
11233 | 69 | 
11234 | 70 | process.on("uncaughtException", (err) => {
11235 | 71 |   _origErr("[uncaughtException]", err);
11236 | 72 |   fireAlert("uncaughtException", safeToString(err));
11237 | 73 |   // Daj czas na wys≈Çanie alertu, potem exit (PM2 zrestartuje)
11238 | 74 |   setTimeout(() => process.exit(1), 3000);
11239 | 75 | });
11240 | 76 | 
11241 | 77 | // ping ‚Äú≈ºyjƒô‚Äù
11242 | 78 | sendOwnerAlert("ALERTS ONLINE", `FB_Watcher start: ${new Date().toISOString()}`)
11243 | 79 |   .then(() => console.log("[ALERTS] startup ping sent"))
11244 | 80 |   .catch(() => console.log("[ALERTS] startup ping failed (ignored)"));
11245 | 81 | 
11246 | 82 | startWatcher().catch((err) => {
11247 | 83 |   console.error("Fatal error:", err);
11248 | 84 |   process.exit(1);
11249 | 85 | });
11250 | 86 | 
11251 | ```
11252 | 
11253 | ---
11254 | 
11255 | ### üìÑ ≈öcie≈ºka: `src/panel/api.js`
11256 | **Typ:** JavaScript/tekst  
11257 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
11258 | 
11259 | ```js
11260 |   1 | // panel/api.js
11261 |   2 | import http from "http";
11262 |   3 | import { exec } from "child_process";
11263 |   4 | import fs from "fs";
11264 |   5 | import path from "path";
11265 |   6 | import crypto from "crypto";
11266 |   7 | import dotenv from "dotenv";
11267 |   8 | 
11268 |   9 | // ---- BASE DIR (dev vs exe) ----
11269 |  10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
11270 |  11 | 
11271 |  12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
11272 |  13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
11273 |  14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
11274 |  15 | 
11275 |  16 | // UI: dev -> src/panel/ui, exe -> ./ui
11276 |  17 | const UI_DIR = process.pkg
11277 |  18 |   ? path.join(BASE_DIR, "ui")
11278 |  19 |   : path.join(BASE_DIR, "src", "panel", "ui");
11279 |  20 | 
11280 |  21 | // New React UI: dev -> src/panel/web/dist, exe -> ./web
11281 |  22 | const NEW_UI_DIR = process.pkg
11282 |  23 |   ? path.join(BASE_DIR, "web")
11283 |  24 |   : path.join(BASE_DIR, "src", "panel", "web", "dist");
11284 |  25 | 
11285 |  26 | const PORT = Number(process.env.PANEL_PORT || 3180);
11286 |  27 | const TOKEN = process.env.PANEL_TOKEN;
11287 |  28 | 
11288 |  29 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
11289 |  30 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
11290 |  31 | 
11291 |  32 | // ---- CACHE (performance) ----
11292 |  33 | let cachedProjectDir = null;
11293 |  34 | let cachedNodeVersion = null;
11294 |  35 | let cachedPm2Version = null;
11295 |  36 | let cachedLogPaths = null;
11296 |  37 | 
11297 |  38 | if (!TOKEN) {
11298 |  39 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
11299 |  40 |   process.exit(1);
11300 |  41 | }
11301 |  42 | 
11302 |  43 | function auth(req, res) {
11303 |  44 |   const h = req.headers["authorization"] || "";
11304 |  45 |   if (h !== `Bearer ${TOKEN}`) {
11305 |  46 |     res.writeHead(401);
11306 |  47 |     res.end("Unauthorized");
11307 |  48 |     return false;
11308 |  49 |   }
11309 |  50 |   return true;
11310 |  51 | }
11311 |  52 | 
11312 |  53 | function json(res, obj, code = 200) {
11313 |  54 |   res.writeHead(code, { "Content-Type": "application/json" });
11314 |  55 |   res.end(JSON.stringify(obj, null, 2));
11315 |  56 | }
11316 |  57 | 
11317 |  58 | function sh(cmd) {
11318 |  59 |   return new Promise((resolve) => {
11319 |  60 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
11320 |  61 |       resolve({
11321 |  62 |         ok: !err,
11322 |  63 |         stdout: (stdout || "").trim(),
11323 |  64 |         stderr: (stderr || "").trim(),
11324 |  65 |         code: err?.code ?? 0,
11325 |  66 |       });
11326 |  67 |     });
11327 |  68 |   });
11328 |  69 | }
11329 |  70 | 
11330 |  71 | 
11331 |  72 | async function getProjectDir() {
11332 |  73 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
11333 |  74 |   if (cachedProjectDir) return cachedProjectDir;
11334 |  75 | 
11335 |  76 |   const r = await sh(`pm2 describe ${PM2_APP}`);
11336 |  77 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
11337 |  78 |   if (!m)
11338 |  79 |     throw new Error(
11339 |  80 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
11340 |  81 |     );
11341 |  82 |   cachedProjectDir = m[1].trim();
11342 |  83 |   return cachedProjectDir;
11343 |  84 | }
11344 |  85 | 
11345 |  86 | function readBody(req) {
11346 |  87 |   return new Promise((resolve) => {
11347 |  88 |     let d = "";
11348 |  89 |     req.on("data", (c) => (d += c));
11349 |  90 |     req.on("end", () => resolve(d));
11350 |  91 |   });
11351 |  92 | }
11352 |  93 | 
11353 |  94 | function safeJsonParse(s) {
11354 |  95 |   try {
11355 |  96 |     return { ok: true, value: JSON.parse(s) };
11356 |  97 |   } catch (e) {
11357 |  98 |     return { ok: false, error: e?.message || "Invalid JSON" };
11358 |  99 |   }
11359 | 100 | }
11360 | 101 | 
11361 | 102 | function ensureDir(p) {
11362 | 103 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
11363 | 104 | }
11364 | 105 | 
11365 | 106 | function atomicWriteFile(filePath, content) {
11366 | 107 |   const dir = path.dirname(filePath);
11367 | 108 |   ensureDir(dir);
11368 | 109 | 
11369 | 110 |   const tmp = path.join(
11370 | 111 |     dir,
11371 | 112 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
11372 | 113 |   );
11373 | 114 |   fs.writeFileSync(tmp, content, "utf8");
11374 | 115 |   fs.renameSync(tmp, filePath);
11375 | 116 | }
11376 | 117 | 
11377 | 118 | function normalizeUrl(u) {
11378 | 119 |   if (!u) return "";
11379 | 120 |   const x = String(u).trim();
11380 | 121 |   if (!/^https?:\/\/.+/i.test(x)) return "";
11381 | 122 |   return x;
11382 | 123 | }
11383 | 124 | 
11384 | 125 | function normalizeOptionalUrl(u) {
11385 | 126 |   if (!u) return "";
11386 | 127 |   const x = String(u).trim();
11387 | 128 |   if (x === "") return "";
11388 | 129 |   if (!/^https?:\/\/.+/i.test(x)) return "";
11389 | 130 |   return x;
11390 | 131 | }
11391 | 132 | 
11392 | 133 | function nowIso() {
11393 | 134 |   return new Date().toISOString();
11394 | 135 | }
11395 | 136 | 
11396 | 137 | function stripAnsi(str) {
11397 | 138 |   return (str || "").replace(/\x1b\[[0-9;]*m/g, "");
11398 | 139 | }
11399 | 140 | 
11400 | 141 | function setEnvKey(envText, key, value) {
11401 | 142 |   const re = new RegExp(`^${key}=.*$`, "m");
11402 | 143 |   const line = `${key}=${value}`;
11403 | 144 |   if (re.test(envText)) return envText.replace(re, line);
11404 | 145 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
11405 | 146 | }
11406 | 147 | 
11407 | 148 | function pickPostsFile(projectDir) {
11408 | 149 |   return path.join(projectDir, "data", "posts.json");
11409 | 150 | }
11410 | 151 | 
11411 | 152 | function readPosts(postsPath) {
11412 | 153 |   if (!fs.existsSync(postsPath)) return [];
11413 | 154 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
11414 | 155 |   if (!raw) return [];
11415 | 156 |   const parsed = safeJsonParse(raw);
11416 | 157 |   if (!parsed.ok || !Array.isArray(parsed.value))
11417 | 158 |     throw new Error("posts.json invalid (expected array)");
11418 | 159 |   return parsed.value;
11419 | 160 | }
11420 | 161 | 
11421 | 162 | function writePosts(postsPath, posts) {
11422 | 163 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
11423 | 164 | }
11424 | 165 | 
11425 | 166 | function genId() {
11426 | 167 |   return crypto.randomBytes(8).toString("hex");
11427 | 168 | }
11428 | 169 | 
11429 | 170 | function route(req) {
11430 | 171 |   const url = new URL(req.url, "http://localhost");
11431 | 172 |   const pathname = url.pathname;
11432 | 173 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
11433 | 174 | }
11434 | 175 | 
11435 | 176 | function match(pathname, pattern) {
11436 | 177 |   const a = pathname.split("/").filter(Boolean);
11437 | 178 |   const b = pattern.split("/").filter(Boolean);
11438 | 179 |   if (a.length !== b.length) return null;
11439 | 180 |   const params = {};
11440 | 181 |   for (let i = 0; i < a.length; i++) {
11441 | 182 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
11442 | 183 |     else if (a[i] !== b[i]) return null;
11443 | 184 |   }
11444 | 185 |   return params;
11445 | 186 | }
11446 | 187 | 
11447 | 188 | // ---------- LOGS (dynamic from pm2 describe) ----------
11448 | 189 | function parsePm2LogPaths(pm2DescribeText) {
11449 | 190 |   const out =
11450 | 191 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
11451 | 192 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
11452 | 193 |     "";
11453 | 194 |   const err =
11454 | 195 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
11455 | 196 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
11456 | 197 |     "";
11457 | 198 |   return { out, err };
11458 | 199 | }
11459 | 200 | 
11460 | 201 | async function getPm2LogPaths(appName) {
11461 | 202 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
11462 | 203 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
11463 | 204 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
11464 | 205 | 
11465 | 206 |   if (cachedLogPaths) return cachedLogPaths;
11466 | 207 | 
11467 | 208 |   const d = await sh(`pm2 describe ${appName}`);
11468 | 209 |   if (!d.ok)
11469 | 210 |     return {
11470 | 211 |       out: "",
11471 | 212 |       err: "",
11472 | 213 |       source: "pm2_error",
11473 | 214 |       pm2: d.stderr || d.stdout || "",
11474 | 215 |     };
11475 | 216 | 
11476 | 217 |   const p = parsePm2LogPaths(d.stdout);
11477 | 218 |   cachedLogPaths = { out: p.out || "", err: p.err || "", source: "pm2_describe" };
11478 | 219 |   return cachedLogPaths;
11479 | 220 | }
11480 | 221 | 
11481 | 222 | async function readTailLog(filePath, lines) {
11482 | 223 |   try {
11483 | 224 |     if (!filePath) {
11484 | 225 |       return {
11485 | 226 |         ok: false,
11486 | 227 |         error:
11487 | 228 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
11488 | 229 |         path: filePath,
11489 | 230 |       };
11490 | 231 |     }
11491 | 232 | 
11492 | 233 |     if (!fs.existsSync(filePath)) {
11493 | 234 |       return {
11494 | 235 |         ok: false,
11495 | 236 |         error:
11496 | 237 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
11497 | 238 |         path: filePath,
11498 | 239 |       };
11499 | 240 |     }
11500 | 241 | 
11501 | 242 |     const st = fs.statSync(filePath);
11502 | 243 |     if (!st || !st.isFile()) {
11503 | 244 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
11504 | 245 |     }
11505 | 246 | 
11506 | 247 |     if (st.size === 0) {
11507 | 248 |       return {
11508 | 249 |         ok: false,
11509 | 250 |         error:
11510 | 251 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
11511 | 252 |         path: filePath,
11512 | 253 |       };
11513 | 254 |     }
11514 | 255 | 
11515 | 256 |     // Use tail command on Linux (fast, doesn't load entire file into memory)
11516 | 257 |     const tailResult = await sh(`tail -n ${lines} "${filePath}"`);
11517 | 258 |     if (tailResult.ok && tailResult.stdout) {
11518 | 259 |       const txt = (tailResult.stdout || "").trim();
11519 | 260 |       if (txt) {
11520 | 261 |         return { ok: true, log: tailResult.stdout, path: filePath, via: "tail" };
11521 | 262 |       }
11522 | 263 |     }
11523 | 264 | 
11524 | 265 |     // Fallback: read last portion of file (max 512KB) for large files
11525 | 266 |     const MAX_READ = 512 * 1024;
11526 | 267 |     if (st.size > MAX_READ) {
11527 | 268 |       const fd = fs.openSync(filePath, "r");
11528 | 269 |       const buffer = Buffer.alloc(MAX_READ);
11529 | 270 |       fs.readSync(fd, buffer, 0, MAX_READ, st.size - MAX_READ);
11530 | 271 |       fs.closeSync(fd);
11531 | 272 |       const raw = buffer.toString("utf8");
11532 | 273 |       const arr = raw.split(/\r?\n/);
11533 | 274 |       // Skip first line (might be partial)
11534 | 275 |       const slice = arr.slice(Math.max(1, arr.length - lines)).join("\n");
11535 | 276 |       const txt = (slice || "").trim();
11536 | 277 |       if (txt) {
11537 | 278 |         return { ok: true, log: slice, path: filePath, via: "partial" };
11538 | 279 |       }
11539 | 280 |     }
11540 | 281 | 
11541 | 282 |     // Small files: read entirely
11542 | 283 |     const raw = fs.readFileSync(filePath, "utf8");
11543 | 284 |     const arr = raw.split(/\r?\n/);
11544 | 285 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
11545 | 286 |     const txt = (slice || "").trim();
11546 | 287 | 
11547 | 288 |     if (!txt) {
11548 | 289 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
11549 | 290 |     }
11550 | 291 | 
11551 | 292 |     return { ok: true, log: slice, path: filePath, via: "js" };
11552 | 293 |   } catch (e) {
11553 | 294 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
11554 | 295 |   }
11555 | 296 | }
11556 | 297 | 
11557 | 298 | http
11558 | 299 |   .createServer(async (req, res) => {
11559 | 300 |     const { pathname, query } = route(req);
11560 | 301 |     if (req.method === "GET" && pathname === "/ping") {
11561 | 302 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
11562 | 303 |   res.end("pong");
11563 | 304 |   return;
11564 | 305 | }
11565 | 306 | 
11566 | 307 | 
11567 | 308 |     // ---------- NEW REACT UI (/new/) ----------
11568 | 309 |     if (req.method === "GET" && pathname.startsWith("/new")) {
11569 | 310 |       const MIME_TYPES = {
11570 | 311 |         ".html": "text/html",
11571 | 312 |         ".js": "application/javascript",
11572 | 313 |         ".css": "text/css",
11573 | 314 |         ".json": "application/json",
11574 | 315 |         ".png": "image/png",
11575 | 316 |         ".jpg": "image/jpeg",
11576 | 317 |         ".svg": "image/svg+xml",
11577 | 318 |         ".ico": "image/x-icon",
11578 | 319 |         ".woff": "font/woff",
11579 | 320 |         ".woff2": "font/woff2",
11580 | 321 |       };
11581 | 322 | 
11582 | 323 |       // Remove /new prefix
11583 | 324 |       let filePath = pathname.replace(/^\/new\/?/, "") || "index.html";
11584 | 325 | 
11585 | 326 |       // Try to serve the file
11586 | 327 |       let fullPath = path.join(NEW_UI_DIR, filePath);
11587 | 328 | 
11588 | 329 |       // If file doesn't exist and it's not a static asset, serve index.html (SPA fallback)
11589 | 330 |       if (!fs.existsSync(fullPath) || fs.statSync(fullPath).isDirectory()) {
11590 | 331 |         const ext = path.extname(filePath);
11591 | 332 |         if (!ext || ext === ".html") {
11592 | 333 |           fullPath = path.join(NEW_UI_DIR, "index.html");
11593 | 334 |         }
11594 | 335 |       }
11595 | 336 | 
11596 | 337 |       if (fs.existsSync(fullPath) && fs.statSync(fullPath).isFile()) {
11597 | 338 |         const ext = path.extname(fullPath);
11598 | 339 |         const contentType = MIME_TYPES[ext] || "application/octet-stream";
11599 | 340 |         const content = fs.readFileSync(fullPath);
11600 | 341 |         res.writeHead(200, { "Content-Type": `${contentType}; charset=utf-8` });
11601 | 342 |         res.end(content);
11602 | 343 |         return;
11603 | 344 |       }
11604 | 345 |     }
11605 | 346 | 
11606 | 347 |     // ---------- PUBLIC UI (legacy) ----------
11607 | 348 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
11608 | 349 |       const p = path.join(UI_DIR, "index.html");
11609 | 350 |       const html = fs.readFileSync(p, "utf8");
11610 | 351 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
11611 | 352 |       res.end(html);
11612 | 353 |       return;
11613 | 354 |     }
11614 | 355 | 
11615 | 356 |     if (req.method === "GET" && pathname === "/app.js") {
11616 | 357 |       const p = path.join(UI_DIR, "app.js");
11617 | 358 |       const js = fs.readFileSync(p, "utf8");
11618 | 359 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
11619 | 360 |       res.end(js);
11620 | 361 |       return;
11621 | 362 |     }
11622 | 363 | 
11623 | 364 |     // ---------- AUTH for API ----------
11624 | 365 |     if (pathname.startsWith("/api/")) {
11625 | 366 |       if (!auth(req, res)) return;
11626 | 367 |     }
11627 | 368 | 
11628 | 369 |     try {
11629 | 370 |       const PROJECT_DIR = await getProjectDir();
11630 | 371 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
11631 | 372 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
11632 | 373 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
11633 | 374 | 
11634 | 375 |       // ===== STATUS =====
11635 | 376 |       if (req.method === "GET" && pathname === "/api/status") {
11636 | 377 |         // Cache node/pm2 versions (don't change during runtime)
11637 | 378 |         if (!cachedNodeVersion) {
11638 | 379 |           const node = await sh("node -v");
11639 | 380 |           cachedNodeVersion = node.stdout;
11640 | 381 |         }
11641 | 382 |         if (!cachedPm2Version) {
11642 | 383 |           const pm2v = await sh("pm2 -v");
11643 | 384 |           cachedPm2Version = pm2v.stdout;
11644 | 385 |         }
11645 | 386 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
11646 | 387 |         json(res, {
11647 | 388 |           ok: true,
11648 | 389 |           projectDir: PROJECT_DIR,
11649 | 390 |           envPath: ENV_PATH,
11650 | 391 |           cookiesPath: COOKIES_PATH,
11651 | 392 |           postsPath: POSTS_PATH,
11652 | 393 |           node: cachedNodeVersion,
11653 | 394 |           pm2: cachedPm2Version,
11654 | 395 |           pm2Status: stripAnsi(pm2s.stdout),
11655 | 396 |           time: nowIso(),
11656 | 397 |         });
11657 | 398 |         return;
11658 | 399 |       }
11659 | 400 | 
11660 | 401 |       // ===== ENV GET (selected keys) =====
11661 | 402 |       if (req.method === "GET" && pathname === "/api/env/get") {
11662 | 403 |         if (!fs.existsSync(ENV_PATH)) {
11663 | 404 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
11664 | 405 |           return;
11665 | 406 |         }
11666 | 407 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
11667 | 408 |         const wanted = [
11668 | 409 |           // Facebook
11669 | 410 |           "FB_EMAIL",
11670 | 411 |           "FB_PASSWORD",
11671 | 412 |           // Watcher
11672 | 413 |           "CHECK_INTERVAL_MS",
11673 | 414 |           "FAST_MODE",
11674 | 415 |           "INCLUDE_REPLIES",
11675 | 416 |           // Logi
11676 | 417 |           "LOG_LEVEL",
11677 | 418 |           // Puppeteer
11678 | 419 |           "HEADLESS_BROWSER",
11679 | 420 |           "USE_UI_HANDLERS",
11680 | 421 |           "COOKIES_READ_ONLY",
11681 | 422 |           // ≈πr√≥d≈Ça post√≥w
11682 | 423 |           "POSTS_SHEET_URL",
11683 | 424 |           "POSTS_API_URL",
11684 | 425 |           "POSTS_API_TOKEN",
11685 | 426 |           // Telegram Owner
11686 | 427 |           "TELEGRAM_SEND_TO_OWNER",
11687 | 428 |           "TELEGRAM_BOT_TOKEN_OWNER",
11688 | 429 |           "TELEGRAM_CHAT_ID_OWNER",
11689 | 430 |           // Telegram Client
11690 | 431 |           "TELEGRAM_SEND_TO_CLIENT",
11691 | 432 |           "TELEGRAM_BOT_TOKEN_CLIENT",
11692 | 433 |           "TELEGRAM_CHAT_ID_CLIENT",
11693 | 434 |           // Telegram Format
11694 | 435 |           "TELEGRAM_USE_PHOTO",
11695 | 436 |           "TELEGRAM_DISABLE_WEB_PAGE_PREVIEW",
11696 | 437 |           // Telegram Alerty
11697 | 438 |           "TG_ALERTS_ENABLED",
11698 | 439 |           "TG_ALERTS_COOLDOWN_SEC",
11699 | 440 |           "TG_ALERTS_MAXLEN",
11700 | 441 |           // Legacy
11701 | 442 |           "WEBHOOK_URL",
11702 | 443 |         ];
11703 | 444 |         const values = {};
11704 | 445 |         for (const k of wanted) {
11705 | 446 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
11706 | 447 |           values[k] = m ? m[1] : "";
11707 | 448 |         }
11708 | 449 |         json(res, { ok: true, values });
11709 | 450 |         return;
11710 | 451 |       }
11711 | 452 | 
11712 | 453 |       // ===== ENV SET MULTIPLE =====
11713 | 454 |       if (req.method === "POST" && pathname === "/api/env/set") {
11714 | 455 |         const bodyRaw = await readBody(req);
11715 | 456 |         const parsed = safeJsonParse(bodyRaw || "{}");
11716 | 457 |         if (!parsed.ok) {
11717 | 458 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
11718 | 459 |           return;
11719 | 460 |         }
11720 | 461 | 
11721 | 462 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
11722 | 463 |         const restart = Boolean(parsed.value.restart);
11723 | 464 | 
11724 | 465 |         if (!set) {
11725 | 466 |           json(res, { ok: false, error: "Missing set object" }, 400);
11726 | 467 |           return;
11727 | 468 |         }
11728 | 469 |         if (!fs.existsSync(ENV_PATH)) {
11729 | 470 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
11730 | 471 |           return;
11731 | 472 |         }
11732 | 473 | 
11733 | 474 |         let env = fs.readFileSync(ENV_PATH, "utf8");
11734 | 475 |         const updated = [];
11735 | 476 | 
11736 | 477 |         for (const [k, v] of Object.entries(set)) {
11737 | 478 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
11738 | 479 |           env = setEnvKey(env, k, String(v));
11739 | 480 |           updated.push(k);
11740 | 481 |         }
11741 | 482 | 
11742 | 483 |         atomicWriteFile(ENV_PATH, env);
11743 | 484 | 
11744 | 485 |         let pm2Action = null;
11745 | 486 |         if (restart) {
11746 | 487 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
11747 | 488 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
11748 | 489 |         }
11749 | 490 | 
11750 | 491 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
11751 | 492 |         return;
11752 | 493 |       }
11753 | 494 | 
11754 | 495 |       // ===== POSTS: LIST =====
11755 | 496 |       if (req.method === "GET" && pathname === "/api/posts") {
11756 | 497 |         const posts = readPosts(POSTS_PATH);
11757 | 498 | 
11758 | 499 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
11759 | 500 |         const norm = (posts || []).map((p) => ({
11760 | 501 |           id: String(p.id || "").trim(),
11761 | 502 |           url: String(p.url || "").trim(),
11762 | 503 |           active: p.active !== undefined ? Boolean(p.active) : true,
11763 | 504 |           name: String(p.name || "").trim(),
11764 | 505 |           image: String(p.image || "").trim(),
11765 | 506 |           description: String(p.description || "").trim(),
11766 | 507 |           createdAt: p.createdAt || "",
11767 | 508 |           updatedAt: p.updatedAt || "",
11768 | 509 |         }));
11769 | 510 | 
11770 | 511 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
11771 | 512 |         json(res, { ok: true, posts: norm });
11772 | 513 |         return;
11773 | 514 |       }
11774 | 515 | 
11775 | 516 |       // ===== POSTS: ADD =====
11776 | 517 |       if (req.method === "POST" && pathname === "/api/posts") {
11777 | 518 |         const bodyRaw = await readBody(req);
11778 | 519 |         const parsed = safeJsonParse(bodyRaw || "{}");
11779 | 520 |         if (!parsed.ok) {
11780 | 521 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
11781 | 522 |           return;
11782 | 523 |         }
11783 | 524 | 
11784 | 525 |         const url = normalizeUrl(parsed.value.url);
11785 | 526 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
11786 | 527 | 
11787 | 528 |         const name = String(parsed.value.name || "").trim();
11788 | 529 |         const imageRaw = String(parsed.value.image || "").trim();
11789 | 530 |         const image = normalizeOptionalUrl(imageRaw);
11790 | 531 |         const description = String(parsed.value.description || "").trim();
11791 | 532 | 
11792 | 533 |         if (!url) {
11793 | 534 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
11794 | 535 |           return;
11795 | 536 |         }
11796 | 537 |         if (imageRaw !== "" && !image) {
11797 | 538 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
11798 | 539 |           return;
11799 | 540 |         }
11800 | 541 | 
11801 | 542 |         const posts = readPosts(POSTS_PATH);
11802 | 543 |         const existing = posts.find((p) => p.url === url);
11803 | 544 |         if (existing) {
11804 | 545 |           existing.active = active;
11805 | 546 |           existing.name = name;
11806 | 547 |           existing.image = image;
11807 | 548 |           existing.description = description;
11808 | 549 |           existing.updatedAt = nowIso();
11809 | 550 |           writePosts(POSTS_PATH, posts);
11810 | 551 |           json(res, { ok: true, post: existing, deduped: true });
11811 | 552 |           return;
11812 | 553 |         }
11813 | 554 | 
11814 | 555 |         const post = {
11815 | 556 |           id: genId(),
11816 | 557 |           url,
11817 | 558 |           active,
11818 | 559 |           name,
11819 | 560 |           image,
11820 | 561 |           description,
11821 | 562 |           createdAt: nowIso(),
11822 | 563 |           updatedAt: nowIso(),
11823 | 564 |         };
11824 | 565 |         posts.push(post);
11825 | 566 |         writePosts(POSTS_PATH, posts);
11826 | 567 | 
11827 | 568 |         json(res, { ok: true, post });
11828 | 569 |         return;
11829 | 570 |       }
11830 | 571 | 
11831 | 572 |       // ===== POSTS: PATCH =====
11832 | 573 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
11833 | 574 |       if (mPatch) {
11834 | 575 |         const id = mPatch.id;
11835 | 576 |         const bodyRaw = await readBody(req);
11836 | 577 |         const parsed = safeJsonParse(bodyRaw || "{}");
11837 | 578 |         if (!parsed.ok) {
11838 | 579 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
11839 | 580 |           return;
11840 | 581 |         }
11841 | 582 | 
11842 | 583 |         const posts = readPosts(POSTS_PATH);
11843 | 584 |         const post = posts.find((p) => p.id === id);
11844 | 585 |         if (!post) {
11845 | 586 |           json(res, { ok: false, error: "Post not found" }, 404);
11846 | 587 |           return;
11847 | 588 |         }
11848 | 589 | 
11849 | 590 |         if (parsed.value.url !== undefined) {
11850 | 591 |           const nextUrl = normalizeUrl(parsed.value.url);
11851 | 592 |           if (!nextUrl) {
11852 | 593 |             json(res, { ok: false, error: "Invalid url" }, 400);
11853 | 594 |             return;
11854 | 595 |           }
11855 | 596 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
11856 | 597 |           if (dup) {
11857 | 598 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
11858 | 599 |             return;
11859 | 600 |           }
11860 | 601 |           post.url = nextUrl;
11861 | 602 |         }
11862 | 603 | 
11863 | 604 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
11864 | 605 | 
11865 | 606 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
11866 | 607 | 
11867 | 608 |         if (parsed.value.image !== undefined) {
11868 | 609 |           const raw = String(parsed.value.image || "").trim();
11869 | 610 |           const img = normalizeOptionalUrl(raw);
11870 | 611 |           if (raw !== "" && !img) {
11871 | 612 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
11872 | 613 |             return;
11873 | 614 |           }
11874 | 615 |           post.image = img;
11875 | 616 |         }
11876 | 617 | 
11877 | 618 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
11878 | 619 | 
11879 | 620 |         post.updatedAt = nowIso();
11880 | 621 |         writePosts(POSTS_PATH, posts);
11881 | 622 |         json(res, { ok: true, post });
11882 | 623 |         return;
11883 | 624 |       }
11884 | 625 | 
11885 | 626 |       // ===== POSTS: DELETE =====
11886 | 627 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
11887 | 628 |       if (mDel) {
11888 | 629 |         const id = mDel.id;
11889 | 630 |         const posts = readPosts(POSTS_PATH);
11890 | 631 |         const idx = posts.findIndex((p) => p.id === id);
11891 | 632 |         if (idx === -1) {
11892 | 633 |           json(res, { ok: false, error: "Post not found" }, 404);
11893 | 634 |           return;
11894 | 635 |         }
11895 | 636 |         const removed = posts.splice(idx, 1)[0];
11896 | 637 |         writePosts(POSTS_PATH, posts);
11897 | 638 |         json(res, { ok: true, removed });
11898 | 639 |         return;
11899 | 640 |       }
11900 | 641 | 
11901 | 642 |       // ===== COOKIES: CLEAR =====
11902 | 643 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
11903 | 644 |         const bodyRaw = await readBody(req);
11904 | 645 |         const parsed = safeJsonParse(bodyRaw || "{}");
11905 | 646 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
11906 | 647 | 
11907 | 648 |         if (!confirm) {
11908 | 649 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
11909 | 650 |           return;
11910 | 651 |         }
11911 | 652 | 
11912 | 653 |         atomicWriteFile(COOKIES_PATH, "[]\n");
11913 | 654 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
11914 | 655 |         return;
11915 | 656 |       }
11916 | 657 | 
11917 | 658 |       // ===== PM2 =====
11918 | 659 |       function okOrErr(r, fallbackErr = "Command failed") {
11919 | 660 |         if (r.ok) return { ok: true, output: stripAnsi(r.stdout || r.stderr || "") };
11920 | 661 |         return { ok: false, error: stripAnsi(r.stderr || r.stdout || fallbackErr) };
11921 | 662 |       }
11922 | 663 |       async function pm2Describe(name) {
11923 | 664 |         return await sh(`pm2 describe ${name}`);
11924 | 665 |       }
11925 | 666 | 
11926 | 667 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
11927 | 668 |       const WATCH_NAME = PM2_APP || "fbwatcher";
11928 | 669 | 
11929 | 670 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
11930 | 671 |         const d = await pm2Describe(WATCH_NAME);
11931 | 672 |         if (d.ok) {
11932 | 673 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
11933 | 674 |           json(res, okOrErr(r, "PM2 start failed"));
11934 | 675 |           return;
11935 | 676 |         }
11936 | 677 | 
11937 | 678 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
11938 | 679 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
11939 | 680 |         return;
11940 | 681 |       }
11941 | 682 | 
11942 | 683 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
11943 | 684 |         const d = await pm2Describe(WATCH_NAME);
11944 | 685 |         if (!d.ok) {
11945 | 686 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
11946 | 687 |           return;
11947 | 688 |         }
11948 | 689 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
11949 | 690 |         json(res, okOrErr(r, "PM2 restart failed"));
11950 | 691 |         return;
11951 | 692 |       }
11952 | 693 | 
11953 | 694 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
11954 | 695 |         const d = await pm2Describe(WATCH_NAME);
11955 | 696 |         if (!d.ok) {
11956 | 697 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
11957 | 698 |           return;
11958 | 699 |         }
11959 | 700 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
11960 | 701 |         json(res, okOrErr(r, "PM2 stop failed"));
11961 | 702 |         return;
11962 | 703 |       }
11963 | 704 | 
11964 | 705 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
11965 | 706 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
11966 | 707 |         json(res, okOrErr(r, "PM2 status failed"));
11967 | 708 |         return;
11968 | 709 |       }
11969 | 710 | 
11970 | 711 |       // ===== LOGS INFO (debug) =====
11971 | 712 |       if (req.method === "GET" && pathname === "/api/logs/info") {
11972 | 713 |         const paths = await getPm2LogPaths(PM2_APP);
11973 | 714 |         json(res, { ok: true, app: PM2_APP, ...paths });
11974 | 715 |         return;
11975 | 716 |       }
11976 | 717 | 
11977 | 718 |       // ===== LOGS =====
11978 | 719 |       if (req.method === "GET" && pathname === "/api/logs/out") {
11979 | 720 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
11980 | 721 |         const paths = await getPm2LogPaths(PM2_APP);
11981 | 722 |         const payload = await readTailLog(paths.out, lines);
11982 | 723 |         json(res, { ...payload, source: paths.source });
11983 | 724 |         return;
11984 | 725 |       }
11985 | 726 | 
11986 | 727 |       if (req.method === "GET" && pathname === "/api/logs/err") {
11987 | 728 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
11988 | 729 |         const paths = await getPm2LogPaths(PM2_APP);
11989 | 730 |         const payload = await readTailLog(paths.err, lines);
11990 | 731 |         json(res, { ...payload, source: paths.source });
11991 | 732 |         return;
11992 | 733 |       }
11993 | 734 | 
11994 | 735 |       // ===== COOKIES: STATUS =====
11995 | 736 |       if (req.method === "GET" && pathname === "/api/cookies/status") {
11996 | 737 |         const mainExists = fs.existsSync(COOKIES_PATH);
11997 | 738 |         let mainAge = undefined;
11998 | 739 |         let mainSize = undefined;
11999 | 740 | 
12000 | 741 |         if (mainExists) {
12001 | 742 |           const stat = fs.statSync(COOKIES_PATH);
12002 | 743 |           mainSize = stat.size;
12003 | 744 |           mainAge = (Date.now() - stat.mtimeMs) / (1000 * 60 * 60); // hours
12004 | 745 |         }
12005 | 746 | 
12006 | 747 |         json(res, {
12007 | 748 |           ok: true,
12008 | 749 |           mainCookiesExists: mainExists,
12009 | 750 |           mainCookiesAge: mainAge,
12010 | 751 |           mainCookiesSize: mainSize,
12011 | 752 |           isLoggedIn: mainExists && mainSize > 10,
12012 | 753 |         });
12013 | 754 |         return;
12014 | 755 |       }
12015 | 756 | 
12016 | 757 |       json(res, { ok: false, error: "Not found" }, 404);
12017 | 758 |     } catch (e) {
12018 | 759 |       json(res, { ok: false, error: e.message }, 500);
12019 | 760 |     }
12020 | 761 |   })
12021 | 762 |   .listen(PORT, "0.0.0.0", () => {
12022 | 763 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
12023 | 764 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
12024 | 765 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
12025 | 766 |   });
12026 | 767 | 
12027 | ```
12028 | 
12029 | ---
12030 | 
12031 | ### üìÑ ≈öcie≈ºka: `src/panel/panel-entry.cjs`
12032 | **Typ:** JavaScript/tekst  
12033 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
12034 | 
12035 | ```js
12036 | 1 | // src/panel/panel-entry.cjs
12037 | 2 | require("./api.js");
12038 | 3 | 
12039 | ```
12040 | 
12041 | ---
12042 | 
12043 | ### üìÑ ≈öcie≈ºka: `src/panel/ui/app.js`
12044 | **Typ:** JavaScript/tekst  
12045 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
12046 | 
12047 | ```js
12048 |   1 | (() => {
12049 |   2 |   const $ = (id) => document.getElementById(id);
12050 |   3 | 
12051 |   4 |   // ---------- state ----------
12052 |   5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
12053 |   6 |   let logAutoTimer = null;
12054 |   7 |   let lastLogMode = "out"; // 'out' | 'err'
12055 |   8 |   let logsExpanded = false;
12056 |   9 | 
12057 |  10 |   // modal state
12058 |  11 |   let modalResolve = null;
12059 |  12 | 
12060 |  13 |   // edit modal state
12061 |  14 |   let editResolve = null;
12062 |  15 | 
12063 |  16 |   // ---------- ui refs ----------
12064 |  17 |   const elToken = $("token");
12065 |  18 |   const btnSaveToken = $("saveToken");
12066 |  19 |   const btnRefresh = $("refresh");
12067 |  20 |   const elStatus = $("status");
12068 |  21 | 
12069 |  22 |   const btnSaveEnv = $("saveEnv");
12070 |  23 |   const btnPm2Start = $("pm2Start");
12071 |  24 |   const btnPm2Stop = $("pm2Stop");
12072 |  25 |   const btnPm2Restart = $("pm2Restart");
12073 |  26 |   const btnClearCookies = $("clearCookies");
12074 |  27 |   const elEnvMsg = $("envMsg");
12075 |  28 | 
12076 |  29 |   const elNewPostUrl = $("newPostUrl");
12077 |  30 |   const elNewPostName = $("newPostName");
12078 |  31 |   const elNewPostImage = $("newPostImage");
12079 |  32 |   const elNewPostActive = $("newPostActive");
12080 |  33 |   const btnAddPost = $("addPost");
12081 |  34 |   const elPostsTbody = $("posts");
12082 |  35 | 
12083 |  36 |   const btnLoadOut = $("loadOut");
12084 |  37 |   const btnLoadErr = $("loadErr");
12085 |  38 |   const elLogLines = $("logLines");
12086 |  39 |   const elLogAutoEvery = $("logAutoEvery");
12087 |  40 |   const btnLogAutoToggle = $("logAutoToggle");
12088 |  41 |   const elLogAutoScroll = $("logAutoScroll");
12089 |  42 |   const elLogs = $("logs");
12090 |  43 |   const elLogHint = $("logHint");
12091 |  44 | 
12092 |  45 |   const logsCard = $("logsCard");
12093 |  46 |   const btnToggleLogsSize = $("toggleLogsSize");
12094 |  47 | 
12095 |  48 |   // modal refs (delete + generic)
12096 |  49 |   const modalOverlay = $("modalOverlay");
12097 |  50 |   const modalBody = $("modalBody");
12098 |  51 |   const modalCancel = $("modalCancel");
12099 |  52 |   const modalOk = $("modalOk");
12100 |  53 | 
12101 |  54 |   // env fields
12102 |  55 |   const ENV_FIELDS = [
12103 |  56 |     "FB_EMAIL",
12104 |  57 |     "FB_PASSWORD",
12105 |  58 |     "WEBHOOK_URL",
12106 |  59 |     "CHECK_INTERVAL_MS",
12107 |  60 |     "POSTS_SHEET_URL",
12108 |  61 |     "HEADLESS_BROWSER",
12109 |  62 |     "USE_UI_HANDLERS",
12110 |  63 |     "INCLUDE_REPLIES",
12111 |  64 |   ];
12112 |  65 | 
12113 |  66 |   function setHint(el, msg, ok = true) {
12114 |  67 |     if (!el) return;
12115 |  68 |     el.textContent = msg || "";
12116 |  69 |     el.classList.remove("ok", "err");
12117 |  70 |     el.classList.add(ok ? "ok" : "err");
12118 |  71 |   }
12119 |  72 | 
12120 |  73 |   function fmtTime() {
12121 |  74 |     try {
12122 |  75 |       return new Date().toLocaleString();
12123 |  76 |     } catch {
12124 |  77 |       return "";
12125 |  78 |     }
12126 |  79 |   }
12127 |  80 | 
12128 |  81 |   function getAuthHeaders() {
12129 |  82 |     const t = (token || "").trim();
12130 |  83 |     return t ? { Authorization: `Bearer ${t}` } : {};
12131 |  84 |   }
12132 |  85 | 
12133 |  86 |   async function api(path, opts = {}) {
12134 |  87 |     const headers = {
12135 |  88 |       ...(opts.headers || {}),
12136 |  89 |       ...getAuthHeaders(),
12137 |  90 |     };
12138 |  91 | 
12139 |  92 |     let body = opts.body;
12140 |  93 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
12141 |  94 |       headers["Content-Type"] = "application/json";
12142 |  95 |       body = JSON.stringify(body);
12143 |  96 |     }
12144 |  97 | 
12145 |  98 |     const res = await fetch(path, {
12146 |  99 |       method: opts.method || "GET",
12147 | 100 |       headers,
12148 | 101 |       body,
12149 | 102 |     });
12150 | 103 | 
12151 | 104 |     const text = await res.text();
12152 | 105 |     let data = null;
12153 | 106 |     try {
12154 | 107 |       data = JSON.parse(text);
12155 | 108 |     } catch {
12156 | 109 |       data = { ok: false, error: text || `HTTP ${res.status}` };
12157 | 110 |     }
12158 | 111 | 
12159 | 112 |     if (!res.ok) {
12160 | 113 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
12161 | 114 |     }
12162 | 115 |     return data;
12163 | 116 |   }
12164 | 117 | 
12165 | 118 |   // ---------- modal ----------
12166 | 119 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
12167 | 120 |     return new Promise((resolve) => {
12168 | 121 |       modalResolve = resolve;
12169 | 122 | 
12170 | 123 |       $("modalTitle").textContent = title;
12171 | 124 |       modalBody.innerHTML = body;
12172 | 125 | 
12173 | 126 |       modalOk.textContent = okText;
12174 | 127 |       modalOk.classList.toggle("danger", !!danger);
12175 | 128 | 
12176 | 129 |       modalOverlay.classList.add("show");
12177 | 130 |       modalOverlay.setAttribute("aria-hidden", "false");
12178 | 131 | 
12179 | 132 |       setTimeout(() => {
12180 | 133 |         (danger ? modalOk : modalCancel).focus();
12181 | 134 |       }, 0);
12182 | 135 |     });
12183 | 136 |   }
12184 | 137 | 
12185 | 138 |   function closeModal(result) {
12186 | 139 |     modalOverlay.classList.remove("show");
12187 | 140 |     modalOverlay.setAttribute("aria-hidden", "true");
12188 | 141 |     const r = modalResolve;
12189 | 142 |     modalResolve = null;
12190 | 143 |     if (typeof r === "function") r(result);
12191 | 144 |   }
12192 | 145 | 
12193 | 146 |   modalCancel.addEventListener("click", () => closeModal(false));
12194 | 147 |   modalOk.addEventListener("click", () => closeModal(true));
12195 | 148 |   modalOverlay.addEventListener("click", (e) => {
12196 | 149 |     if (e.target === modalOverlay) closeModal(false);
12197 | 150 |   });
12198 | 151 |   window.addEventListener("keydown", (e) => {
12199 | 152 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
12200 | 153 |   });
12201 | 154 | 
12202 | 155 |   // ---------- core actions ----------
12203 | 156 |   async function loadStatus() {
12204 | 157 |     setHint(elStatus, "≈Åadowanie statusu...", true);
12205 | 158 | 
12206 | 159 |     const r = await api("/api/status");
12207 | 160 |     if (!r.ok) {
12208 | 161 |       setHint(
12209 | 162 |         elStatus,
12210 | 163 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
12211 | 164 |         false
12212 | 165 |       );
12213 | 166 |       return null;
12214 | 167 |     }
12215 | 168 | 
12216 | 169 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
12217 | 170 |     return r;
12218 | 171 |   }
12219 | 172 | 
12220 | 173 |   async function loadEnv() {
12221 | 174 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
12222 | 175 |     const r = await api("/api/env/get");
12223 | 176 |     if (!r.ok) {
12224 | 177 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
12225 | 178 |       return;
12226 | 179 |     }
12227 | 180 |     const v = r.values || {};
12228 | 181 |     for (const k of ENV_FIELDS) {
12229 | 182 |       const el = $(k);
12230 | 183 |       if (!el) continue;
12231 | 184 |       el.value = (v[k] ?? "").toString();
12232 | 185 |     }
12233 | 186 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
12234 | 187 |   }
12235 | 188 | 
12236 | 189 |   async function saveEnv(restart = false) {
12237 | 190 |     const set = {};
12238 | 191 |     for (const k of ENV_FIELDS) {
12239 | 192 |       const el = $(k);
12240 | 193 |       if (!el) continue;
12241 | 194 |       set[k] = (el.value ?? "").toString();
12242 | 195 |     }
12243 | 196 | 
12244 | 197 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
12245 | 198 | 
12246 | 199 |     const r = await api("/api/env/set", {
12247 | 200 |       method: "POST",
12248 | 201 |       body: { set, restart },
12249 | 202 |     });
12250 | 203 | 
12251 | 204 |     if (!r.ok) {
12252 | 205 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
12253 | 206 |       return;
12254 | 207 |     }
12255 | 208 | 
12256 | 209 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
12257 | 210 |   }
12258 | 211 | 
12259 | 212 |   function copyIconSvg() {
12260 | 213 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
12261 | 214 |     return `
12262 | 215 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
12263 | 216 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
12264 | 217 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
12265 | 218 |       </svg>
12266 | 219 |     `;
12267 | 220 |   }
12268 | 221 | 
12269 | 222 |   async function loadPosts() {
12270 | 223 |     const r = await api("/api/posts");
12271 | 224 |     if (!r.ok) {
12272 | 225 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
12273 | 226 |       return;
12274 | 227 |     }
12275 | 228 | 
12276 | 229 |     const posts = Array.isArray(r.posts) ? r.posts : [];
12277 | 230 |     elPostsTbody.innerHTML = "";
12278 | 231 | 
12279 | 232 |     for (const p of posts) {
12280 | 233 |       const tr = document.createElement("tr");
12281 | 234 | 
12282 | 235 |       const tdId = document.createElement("td");
12283 | 236 |       tdId.className = "mono col-id";
12284 | 237 |       tdId.textContent = p.id || "";
12285 | 238 |       tr.appendChild(tdId);
12286 | 239 | 
12287 | 240 |       // LINK + IKONKA KOPIUJ PRZY LINKU
12288 | 241 |       const tdUrl = document.createElement("td");
12289 | 242 |       tdUrl.className = "col-url";
12290 | 243 | 
12291 | 244 |       if (p.url) {
12292 | 245 |         const wrap = document.createElement("div");
12293 | 246 |         wrap.className = "urlWrap";
12294 | 247 | 
12295 | 248 |         const a = document.createElement("a");
12296 | 249 |         a.href = p.url;
12297 | 250 |         a.target = "_blank";
12298 | 251 |         a.rel = "noopener noreferrer";
12299 | 252 |         a.textContent = p.url;
12300 | 253 | 
12301 | 254 |         const btnCopyIcon = document.createElement("button");
12302 | 255 |         btnCopyIcon.className = "iconBtn";
12303 | 256 |         btnCopyIcon.type = "button";
12304 | 257 |         btnCopyIcon.title = "Kopiuj link";
12305 | 258 |         btnCopyIcon.innerHTML = copyIconSvg();
12306 | 259 | 
12307 | 260 |         btnCopyIcon.addEventListener("click", async (e) => {
12308 | 261 |           e.preventDefault();
12309 | 262 |           e.stopPropagation();
12310 | 263 | 
12311 | 264 |           const ok = await copyToClipboard(p.url);
12312 | 265 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
12313 | 266 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
12314 | 267 |         });
12315 | 268 | 
12316 | 269 |         wrap.appendChild(a);
12317 | 270 |         wrap.appendChild(btnCopyIcon);
12318 | 271 |         tdUrl.appendChild(wrap);
12319 | 272 |       }
12320 | 273 | 
12321 | 274 |       tr.appendChild(tdUrl);
12322 | 275 | 
12323 | 276 |       const tdName = document.createElement("td");
12324 | 277 |       tdName.className = "col-name";
12325 | 278 |       tdName.textContent = p.name || "";
12326 | 279 |       tr.appendChild(tdName);
12327 | 280 | 
12328 | 281 |       const tdImg = document.createElement("td");
12329 | 282 |       tdImg.className = "col-img";
12330 | 283 |       if (p.image) {
12331 | 284 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
12332 | 285 |       } else {
12333 | 286 |         tdImg.textContent = "";
12334 | 287 |       }
12335 | 288 |       tr.appendChild(tdImg);
12336 | 289 | 
12337 | 290 | 
12338 | 291 |       const tdActive = document.createElement("td");
12339 | 292 |       tdActive.className = "col-act";
12340 | 293 |       const chk = document.createElement("input");
12341 | 294 |       chk.type = "checkbox";
12342 | 295 |       chk.checked = !!p.active;
12343 | 296 |       chk.addEventListener("change", async () => {
12344 | 297 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
12345 | 298 |           method: "PATCH",
12346 | 299 |           body: { active: chk.checked },
12347 | 300 |         });
12348 | 301 |         await loadPosts();
12349 | 302 |       });
12350 | 303 |       tdActive.appendChild(chk);
12351 | 304 |       tr.appendChild(tdActive);
12352 | 305 | 
12353 | 306 |       // AKCJE: EDYTUJ + USU≈É
12354 | 307 |       const tdActions = document.createElement("td");
12355 | 308 |       tdActions.className = "col-btn";
12356 | 309 | 
12357 | 310 |       const actions = document.createElement("div");
12358 | 311 |       actions.className = "actionsWrap";
12359 | 312 | 
12360 | 313 |       const btnEdit = document.createElement("button");
12361 | 314 |       btnEdit.className = "small";
12362 | 315 |       btnEdit.type = "button";
12363 | 316 |       btnEdit.textContent = "Edytuj";
12364 | 317 |       btnEdit.addEventListener("click", async () => {
12365 | 318 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
12366 | 319 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
12367 | 320 |         const ok = await showModal({
12368 | 321 |           title: "Edytuj post",
12369 | 322 |           body:
12370 | 323 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
12371 | 324 |             `<div style="margin-top:10px">
12372 | 325 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
12373 | 326 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
12374 | 327 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
12375 | 328 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
12376 | 329 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
12377 | 330 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
12378 | 331 |             </div>`,
12379 | 332 |           okText: "Zapisz",
12380 | 333 |           danger: false,
12381 | 334 |         });
12382 | 335 | 
12383 | 336 |         if (!ok) return;
12384 | 337 | 
12385 | 338 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
12386 | 339 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
12387 | 340 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
12388 | 341 | 
12389 | 342 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
12390 | 343 |           method: "PATCH",
12391 | 344 |           body: { url: newUrl, name: newName, image: newImg },
12392 | 345 |         });
12393 | 346 | 
12394 | 347 |         if (!rr.ok) {
12395 | 348 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
12396 | 349 |           return;
12397 | 350 |         }
12398 | 351 | 
12399 | 352 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
12400 | 353 |         await loadPosts();
12401 | 354 |       });
12402 | 355 | 
12403 | 356 |       const btnDel = document.createElement("button");
12404 | 357 |       btnDel.className = "danger";
12405 | 358 |       btnDel.type = "button";
12406 | 359 |       btnDel.textContent = "Usu≈Ñ";
12407 | 360 |       btnDel.addEventListener("click", async () => {
12408 | 361 |         const ok = await showModal({
12409 | 362 |           title: "UsunƒÖƒá post?",
12410 | 363 |           body:
12411 | 364 |             `<div>Ta operacja jest nieodwracalna.</div>` +
12412 | 365 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
12413 | 366 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
12414 | 367 |           okText: "Usu≈Ñ",
12415 | 368 |           danger: true,
12416 | 369 |         });
12417 | 370 |         if (!ok) return;
12418 | 371 | 
12419 | 372 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
12420 | 373 |         if (!rr.ok) {
12421 | 374 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
12422 | 375 |           return;
12423 | 376 |         }
12424 | 377 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
12425 | 378 |         await loadPosts();
12426 | 379 |       });
12427 | 380 | 
12428 | 381 |       actions.appendChild(btnEdit);
12429 | 382 |       actions.appendChild(btnDel);
12430 | 383 | 
12431 | 384 |       tdActions.appendChild(actions);
12432 | 385 |       tr.appendChild(tdActions);
12433 | 386 | 
12434 | 387 |       elPostsTbody.appendChild(tr);
12435 | 388 |     }
12436 | 389 |   }
12437 | 390 | 
12438 | 391 |   async function addPost() {
12439 | 392 |     const url = (elNewPostUrl.value || "").trim();
12440 | 393 |     const name = (elNewPostName.value || "").trim();
12441 | 394 |     const image = (elNewPostImage.value || "").trim();
12442 | 395 |     const active = !!elNewPostActive.checked;
12443 | 396 | 
12444 | 397 |     const r = await api("/api/posts", {
12445 | 398 |       method: "POST",
12446 | 399 |       body: { url, name, image, active },
12447 | 400 |     });
12448 | 401 | 
12449 | 402 |     if (!r.ok) {
12450 | 403 |       await showModal({
12451 | 404 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
12452 | 405 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
12453 | 406 |         okText: "OK",
12454 | 407 |         danger: false,
12455 | 408 |       });
12456 | 409 |       return;
12457 | 410 |     }
12458 | 411 | 
12459 | 412 |     elNewPostUrl.value = "";
12460 | 413 |     elNewPostName.value = "";
12461 | 414 |     elNewPostImage.value = "";
12462 | 415 |     elNewPostActive.checked = true;
12463 | 416 | 
12464 | 417 |     setHint(elEnvMsg, "Dodano post.", true);
12465 | 418 |     await loadPosts();
12466 | 419 |   }
12467 | 420 | 
12468 | 421 |   async function pm2Call(which) {
12469 | 422 |     const map = {
12470 | 423 |       start: "/api/pm2/start",
12471 | 424 |       stop: "/api/pm2/stop",
12472 | 425 |       restart: "/api/pm2/restart",
12473 | 426 |       status: "/api/pm2/status",
12474 | 427 |     };
12475 | 428 |     const path = map[which];
12476 | 429 |     if (!path) return;
12477 | 430 | 
12478 | 431 |     const label =
12479 | 432 |       which === "start" ? "Startujƒô watchera..."
12480 | 433 |         : which === "stop" ? "Zatrzymujƒô watchera..."
12481 | 434 |           : which === "restart" ? "Restartujƒô watchera..."
12482 | 435 |             : "Sprawdzam status...";
12483 | 436 | 
12484 | 437 |     setHint(elEnvMsg, label, true);
12485 | 438 | 
12486 | 439 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
12487 | 440 |     if (!r.ok) {
12488 | 441 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
12489 | 442 |       return;
12490 | 443 |     }
12491 | 444 | 
12492 | 445 |     const okMsg =
12493 | 446 |       which === "start" ? "Watcher uruchomiony."
12494 | 447 |         : which === "stop" ? "Watcher zatrzymany."
12495 | 448 |           : which === "restart" ? "Watcher zrestartowany."
12496 | 449 |             : "Status pobrany.";
12497 | 450 | 
12498 | 451 |     setHint(elEnvMsg, okMsg, true);
12499 | 452 | 
12500 | 453 |     if (which !== "status") await loadStatus();
12501 | 454 |   }
12502 | 455 | 
12503 | 456 |   async function clearCookies() {
12504 | 457 |     const ok = await showModal({
12505 | 458 |       title: "Wyczy≈õciƒá cookies?",
12506 | 459 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
12507 | 460 |       okText: "Wyczy≈õƒá",
12508 | 461 |       danger: true,
12509 | 462 |     });
12510 | 463 |     if (!ok) return;
12511 | 464 | 
12512 | 465 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
12513 | 466 | 
12514 | 467 |     const r = await api("/api/cookies/clear", {
12515 | 468 |       method: "POST",
12516 | 469 |       body: { confirm: true },
12517 | 470 |     });
12518 | 471 | 
12519 | 472 |     if (!r.ok) {
12520 | 473 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
12521 | 474 |       return;
12522 | 475 |     }
12523 | 476 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
12524 | 477 |   }
12525 | 478 | 
12526 | 479 |   // ---------- logs ----------
12527 | 480 |   function getLines() {
12528 | 481 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
12529 | 482 |     if (!isFinite(n)) return 200;
12530 | 483 |     return Math.max(20, Math.min(2000, n));
12531 | 484 |   }
12532 | 485 | 
12533 | 486 |   async function loadLogs(mode) {
12534 | 487 |     lastLogMode = mode;
12535 | 488 |     const lines = getLines();
12536 | 489 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
12537 | 490 | 
12538 | 491 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
12539 | 492 |     if (!r.ok) {
12540 | 493 |       elLogs.value = "";
12541 | 494 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
12542 | 495 |       return;
12543 | 496 |     }
12544 | 497 | 
12545 | 498 |     elLogs.value = (r.log || "").toString().replace(/\x1b\[[0-9;]*m/g, "");
12546 | 499 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
12547 | 500 | 
12548 | 501 |     if (elLogAutoScroll.checked) {
12549 | 502 |       elLogs.scrollTop = elLogs.scrollHeight;
12550 | 503 |     }
12551 | 504 |   }
12552 | 505 | 
12553 | 506 |   function stopAutoLogs() {
12554 | 507 |     if (logAutoTimer) {
12555 | 508 |       clearInterval(logAutoTimer);
12556 | 509 |       logAutoTimer = null;
12557 | 510 |     }
12558 | 511 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
12559 | 512 |     btnLogAutoToggle.classList.remove("primary");
12560 | 513 |   }
12561 | 514 | 
12562 | 515 |   function startAutoLogs() {
12563 | 516 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
12564 | 517 |     if (every <= 0) {
12565 | 518 |       stopAutoLogs();
12566 | 519 |       return;
12567 | 520 |     }
12568 | 521 | 
12569 | 522 |     stopAutoLogs();
12570 | 523 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
12571 | 524 |     btnLogAutoToggle.classList.add("primary");
12572 | 525 | 
12573 | 526 |     logAutoTimer = setInterval(() => {
12574 | 527 |       loadLogs(lastLogMode).catch(() => {});
12575 | 528 |     }, every);
12576 | 529 |   }
12577 | 530 | 
12578 | 531 |   function toggleLogsSize() {
12579 | 532 |     logsExpanded = !logsExpanded;
12580 | 533 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
12581 | 534 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
12582 | 535 |   }
12583 | 536 | 
12584 | 537 |   // ---------- utils ----------
12585 | 538 |   async function copyToClipboard(text) {
12586 | 539 |     try {
12587 | 540 |       await navigator.clipboard.writeText(text);
12588 | 541 |       return true;
12589 | 542 |     } catch (e) {
12590 | 543 |       const ta = document.createElement("textarea");
12591 | 544 |       ta.value = text;
12592 | 545 |       ta.style.position = "fixed";
12593 | 546 |       ta.style.opacity = "0";
12594 | 547 |       document.body.appendChild(ta);
12595 | 548 |       ta.select();
12596 | 549 |       try {
12597 | 550 |         document.execCommand("copy");
12598 | 551 |         document.body.removeChild(ta);
12599 | 552 |         return true;
12600 | 553 |       } catch {
12601 | 554 |         document.body.removeChild(ta);
12602 | 555 |         return false;
12603 | 556 |       }
12604 | 557 |     }
12605 | 558 |   }
12606 | 559 | 
12607 | 560 |   function escapeHtml(s) {
12608 | 561 |     return String(s || "")
12609 | 562 |       .replaceAll("&", "&amp;")
12610 | 563 |       .replaceAll("<", "&lt;")
12611 | 564 |       .replaceAll(">", "&gt;")
12612 | 565 |       .replaceAll('"', "&quot;")
12613 | 566 |       .replaceAll("'", "&#039;");
12614 | 567 |   }
12615 | 568 | 
12616 | 569 |   // ---------- wire events ----------
12617 | 570 |   function wire() {
12618 | 571 |     elToken.value = token;
12619 | 572 | 
12620 | 573 |     btnSaveToken.addEventListener("click", async () => {
12621 | 574 |       token = (elToken.value || "").trim();
12622 | 575 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
12623 | 576 |       await hardRefresh();
12624 | 577 |     });
12625 | 578 | 
12626 | 579 |     btnRefresh.addEventListener("click", async () => {
12627 | 580 |       await hardRefresh();
12628 | 581 |     });
12629 | 582 | 
12630 | 583 |     btnSaveEnv.addEventListener("click", async () => {
12631 | 584 |       await saveEnv(false);
12632 | 585 |     });
12633 | 586 | 
12634 | 587 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
12635 | 588 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
12636 | 589 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
12637 | 590 | 
12638 | 591 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
12639 | 592 | 
12640 | 593 |     btnAddPost.addEventListener("click", async () => await addPost());
12641 | 594 | 
12642 | 595 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
12643 | 596 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
12644 | 597 | 
12645 | 598 |     btnLogAutoToggle.addEventListener("click", () => {
12646 | 599 |       if (logAutoTimer) stopAutoLogs();
12647 | 600 |       else startAutoLogs();
12648 | 601 |     });
12649 | 602 | 
12650 | 603 |     elLogAutoEvery.addEventListener("change", () => {
12651 | 604 |       if (logAutoTimer) startAutoLogs();
12652 | 605 |     });
12653 | 606 | 
12654 | 607 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
12655 | 608 |   }
12656 | 609 | 
12657 | 610 |   async function hardRefresh() {
12658 | 611 |     // Parallel requests for better performance
12659 | 612 |     const promises = [loadStatus(), loadEnv(), loadPosts()];
12660 | 613 | 
12661 | 614 |     if (elLogs.value && elLogs.value.trim().length > 0) {
12662 | 615 |       promises.push(loadLogs(lastLogMode));
12663 | 616 |     }
12664 | 617 | 
12665 | 618 |     await Promise.all(promises);
12666 | 619 |   }
12667 | 620 | 
12668 | 621 |   // ---------- init ----------
12669 | 622 |   wire();
12670 | 623 |   hardRefresh().catch(() => {
12671 | 624 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
12672 | 625 |   });
12673 | 626 | })();
12674 | 627 | 
12675 | ```
12676 | 
12677 | ---
12678 | 
12679 | ### üìÑ ≈öcie≈ºka: `src/panel/ui/index.html`
12680 | **Typ:** HTML  
12681 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
12682 | 
12683 | ```html
12684 |   1 | <!doctype html>
12685 |   2 | <html lang="pl">
12686 |   3 | <head>
12687 |   4 |   <meta charset="utf-8" />
12688 |   5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
12689 |   6 |   <title>Panel FB Watcher</title>
12690 |   7 | 
12691 |   8 |   <style>
12692 |   9 |     :root{
12693 |  10 |       --bg:#0b0f14;
12694 |  11 |       --card:#121926;
12695 |  12 |       --card2:#0b1220;
12696 |  13 |       --border:#223047;
12697 |  14 |       --border2:#2a3a55;
12698 |  15 |       --text:#e7eef7;
12699 |  16 |       --muted:rgba(231,238,247,.75);
12700 |  17 |       --primary:#2563eb;
12701 |  18 |       --danger:#b91c1c;
12702 |  19 |       --ok:#34d399;
12703 |  20 |       --err:#f87171;
12704 |  21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
12705 |  22 |       --radius:14px;
12706 |  23 |     }
12707 |  24 | 
12708 |  25 |     * { box-sizing:border-box; }
12709 |  26 |     body {
12710 |  27 |       font-family: system-ui, Arial;
12711 |  28 |       margin: 16px;
12712 |  29 |       background: var(--bg);
12713 |  30 |       color: var(--text);
12714 |  31 |     }
12715 |  32 | 
12716 |  33 |     h2 { margin: 6px 0 6px; }
12717 |  34 |     h3 { margin: 6px 0 12px; }
12718 |  35 | 
12719 |  36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
12720 |  37 |     .card {
12721 |  38 |       background: var(--card);
12722 |  39 |       border:1px solid var(--border);
12723 |  40 |       border-radius: var(--radius);
12724 |  41 |       padding:14px;
12725 |  42 |       margin:12px 0;
12726 |  43 |       box-shadow: var(--shadow);
12727 |  44 |     }
12728 |  45 | 
12729 |  46 |     input, textarea, button, select {
12730 |  47 |       font: inherit;
12731 |  48 |       border-radius:12px;
12732 |  49 |       border:1px solid var(--border2);
12733 |  50 |       background: var(--card2);
12734 |  51 |       color: var(--text);
12735 |  52 |       padding:10px 12px;
12736 |  53 |       outline: none;
12737 |  54 |     }
12738 |  55 |     input:focus, textarea:focus, select:focus {
12739 |  56 |       border-color: rgba(37, 99, 235, .75);
12740 |  57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
12741 |  58 |     }
12742 |  59 | 
12743 |  60 |     input, textarea { width: 100%; }
12744 |  61 |     textarea { resize: vertical; min-height: 90px; }
12745 |  62 | 
12746 |  63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
12747 |  64 |     button:active { transform: translateY(1px); }
12748 |  65 |     button.primary { background: var(--primary); border-color: var(--primary); }
12749 |  66 |     button.danger { background: var(--danger); border-color: var(--danger); }
12750 |  67 |     button.ghost { background: transparent; }
12751 |  68 |     button.small { padding:8px 10px; border-radius: 10px; }
12752 |  69 | 
12753 |  70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
12754 |  71 | 
12755 |  72 |     .muted { opacity:0.78; font-size:12px; }
12756 |  73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
12757 |  74 | 
12758 |  75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
12759 |  76 | 
12760 |  77 |     .thumb {
12761 |  78 |       width:200px; height:120px;
12762 |  79 |       object-fit:cover;
12763 |  80 |       border-radius:10px;
12764 |  81 |       border:1px solid var(--border);
12765 |  82 |       background: var(--card2);
12766 |  83 |     }
12767 |  84 | 
12768 |  85 |     /* ===== tabela ===== */
12769 |  86 |     .tableWrap {
12770 |  87 |       width: 100%;
12771 |  88 |       /* by≈Ço: overflow-x; teraz robimy pe≈Çny scroll + limit wysoko≈õci */
12772 |  89 |       max-height: calc(100vh - 260px);
12773 |  90 |       overflow: auto;
12774 |  91 | 
12775 |  92 |       border-radius: 12px;
12776 |  93 |       border: 1px solid rgba(34,48,71,.45);
12777 |  94 |       background: rgba(11,18,32,.25);
12778 |  95 |     }
12779 |  96 | 
12780 |  97 |     /* opcjonalnie: ≈Çadniejsze scrollbary */
12781 |  98 |     .tableWrap::-webkit-scrollbar { height: 10px; width: 10px; }
12782 |  99 |     .tableWrap::-webkit-scrollbar-thumb { background: rgba(42,58,85,.9); border-radius: 999px; }
12783 | 100 |     .tableWrap::-webkit-scrollbar-track { background: rgba(11,18,32,.35); border-radius: 999px; }
12784 | 101 | 
12785 | 102 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
12786 | 103 |     th, td {
12787 | 104 |       border-bottom:1px solid rgba(34,48,71,.7);
12788 | 105 |       padding:10px;
12789 | 106 |       text-align:left;
12790 | 107 |       vertical-align:top;
12791 | 108 |       overflow-wrap:anywhere;
12792 | 109 |       word-break:break-word;
12793 | 110 |     }
12794 | 111 | 
12795 | 112 |     /* sticky head */
12796 | 113 |     th {
12797 | 114 |       font-size: 12px;
12798 | 115 |       opacity:.9;
12799 | 116 |       position: sticky;
12800 | 117 |       top: 0;
12801 | 118 |       z-index: 5;
12802 | 119 |       background: rgba(18,25,38,.96);
12803 | 120 |       backdrop-filter: blur(8px);
12804 | 121 |     }
12805 | 122 | 
12806 | 123 |     /* delikatny hover, ≈ºeby to "oddycha≈Ço" */
12807 | 124 |     tbody tr:hover td {
12808 | 125 |       background: rgba(37,99,235,.06);
12809 | 126 |     }
12810 | 127 | 
12811 | 128 |     /* kolumny */
12812 | 129 |     th.col-id,  td.col-id  { width: 170px; }
12813 | 130 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
12814 | 131 |     th.col-name,td.col-name{ width: 170px; }
12815 | 132 |     th.col-img, td.col-img { width: 220px; }
12816 | 133 |     th.col-act, td.col-act { width: 110px; text-align:center; }
12817 | 134 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
12818 | 135 | 
12819 | 136 |     /* URL: kolor */
12820 | 137 |     td.col-url a{
12821 | 138 |       color: #93c5fd;
12822 | 139 |       text-decoration: underline;
12823 | 140 |     }
12824 | 141 | 
12825 | 142 |     /* wrapper dla linka + ikonki kopiuj */
12826 | 143 |     .urlWrap{
12827 | 144 |       display:flex;
12828 | 145 |       align-items:flex-start;
12829 | 146 |       gap:10px;
12830 | 147 |     }
12831 | 148 | 
12832 | 149 |     /* KLUCZ: niech link nie robi ≈õciany (max 2 linie) */
12833 | 150 | .urlWrap a{
12834 | 151 |   flex: 1;
12835 | 152 |   min-width: 0;
12836 | 153 | 
12837 | 154 |   /* clamp (Chromium/WebKit) */
12838 | 155 |   display: -webkit-box;
12839 | 156 |   -webkit-box-orient: vertical;
12840 | 157 |   -webkit-line-clamp: 2;
12841 | 158 | 
12842 | 159 |   /* clamp (standard / future) */
12843 | 160 |   line-clamp: 2;
12844 | 161 | 
12845 | 162 |   overflow: hidden;
12846 | 163 | 
12847 | 164 |   word-break: break-word;
12848 | 165 |   overflow-wrap: anywhere;
12849 | 166 |   line-height: 1.25;
12850 | 167 | 
12851 | 168 |   /* fallback gdy clamp nie dzia≈Ça */
12852 | 169 |   max-height: 2.5em;
12853 | 170 | }
12854 | 171 | 
12855 | 172 | 
12856 | 173 | 
12857 | 174 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
12858 | 175 |     .iconBtn{
12859 | 176 |       width: 28px;
12860 | 177 |       height: 28px;
12861 | 178 |       padding: 0;
12862 | 179 |       display:inline-flex;
12863 | 180 |       align-items:center;
12864 | 181 |       justify-content:center;
12865 | 182 |       border-radius: 10px;
12866 | 183 |       background: transparent;
12867 | 184 |       border: 1px solid rgba(42,58,85,.9);
12868 | 185 |       opacity: .9;
12869 | 186 |       flex: 0 0 auto;
12870 | 187 |     }
12871 | 188 |     .iconBtn:hover{
12872 | 189 |       opacity: 1;
12873 | 190 |       background: rgba(37,99,235,.15);
12874 | 191 |     }
12875 | 192 |     .iconBtn:active{
12876 | 193 |       transform: translateY(1px);
12877 | 194 |     }
12878 | 195 |     .iconBtn svg{
12879 | 196 |       width: 16px;
12880 | 197 |       height: 16px;
12881 | 198 |       fill: none;
12882 | 199 |       stroke: rgba(231,238,247,.95);
12883 | 200 |       stroke-width: 2;
12884 | 201 |       stroke-linecap: round;
12885 | 202 |       stroke-linejoin: round;
12886 | 203 |     }
12887 | 204 | 
12888 | 205 |     /* akcje w tabeli */
12889 | 206 |     .actionsWrap{
12890 | 207 |       display:flex;
12891 | 208 |       gap:10px;
12892 | 209 |       align-items:center;
12893 | 210 |       justify-content:flex-start;
12894 | 211 |       flex-wrap:nowrap;
12895 | 212 |     }
12896 | 213 | 
12897 | 214 |     /* ===== status ===== */
12898 | 215 |     .hint { margin-top:10px; }
12899 | 216 |     .hint.ok { color: #a7f3d0; }
12900 | 217 |     .hint.err { color: #fca5a5; }
12901 | 218 | 
12902 | 219 |     /* ===== logi: proporcje ===== */
12903 | 220 |     .logsBox {
12904 | 221 |       display:flex;
12905 | 222 |       flex-direction: column;
12906 | 223 |       gap:10px;
12907 | 224 |     }
12908 | 225 |     #logs {
12909 | 226 |       height: 200px;
12910 | 227 |       min-height: 160px;
12911 | 228 |       max-height: 520px;
12912 | 229 |     }
12913 | 230 |     .logsExpanded #logs { height: 420px; }
12914 | 231 | 
12915 | 232 |     /* ===== modal ===== */
12916 | 233 |     .modalOverlay{
12917 | 234 |       position: fixed;
12918 | 235 |       inset: 0;
12919 | 236 |       background: rgba(0,0,0,.55);
12920 | 237 |       display:none;
12921 | 238 |       align-items:center;
12922 | 239 |       justify-content:center;
12923 | 240 |       padding: 18px;
12924 | 241 |       z-index: 9999;
12925 | 242 |     }
12926 | 243 |     .modalOverlay.show{ display:flex; }
12927 | 244 |     .modal{
12928 | 245 |       width: min(640px, 100%);
12929 | 246 |       border-radius: 16px;
12930 | 247 |       border: 1px solid rgba(34,48,71,.9);
12931 | 248 |       background: rgba(18,25,38,.98);
12932 | 249 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
12933 | 250 |       padding: 16px;
12934 | 251 |     }
12935 | 252 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
12936 | 253 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
12937 | 254 |     .modal .modalActions{
12938 | 255 |       display:flex;
12939 | 256 |       justify-content:flex-end;
12940 | 257 |       gap:10px;
12941 | 258 |       margin-top: 14px;
12942 | 259 |     }
12943 | 260 |     .kbd{
12944 | 261 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
12945 | 262 |       font-size: 12px;
12946 | 263 |       opacity:.9;
12947 | 264 |       padding: 2px 6px;
12948 | 265 |       border:1px solid rgba(42,58,85,.9);
12949 | 266 |       border-radius: 8px;
12950 | 267 |       background: rgba(11,18,32,.55);
12951 | 268 |     }
12952 | 269 | 
12953 | 270 |     @media (max-width: 860px){
12954 | 271 |       table { min-width: 980px; }
12955 | 272 |       .tableWrap { max-height: calc(100vh - 220px); }
12956 | 273 |     }
12957 | 274 |   </style>
12958 | 275 | </head>
12959 | 276 | 
12960 | 277 | <body>
12961 | 278 |   <h2>FB Watcher ‚Äî Panel</h2>
12962 | 279 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
12963 | 280 | 
12964 | 281 |   <div class="card">
12965 | 282 |     <div class="row">
12966 | 283 |       <div style="flex:1; min-width:260px;">
12967 | 284 |         <label>Token panelu</label>
12968 | 285 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
12969 | 286 |       </div>
12970 | 287 |       <div style="display:flex; gap:10px; align-items:flex-end;">
12971 | 288 |         <button class="primary" id="saveToken">Zapisz token</button>
12972 | 289 |         <button id="refresh">Od≈õwie≈º</button>
12973 | 290 |       </div>
12974 | 291 |     </div>
12975 | 292 | 
12976 | 293 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
12977 | 294 |   </div>
12978 | 295 | 
12979 | 296 |   <div class="card">
12980 | 297 |     <h3>Ustawienia (.env)</h3>
12981 | 298 | 
12982 | 299 |     <div class="row">
12983 | 300 |       <div style="flex:1; min-width:260px;">
12984 | 301 |         <label>E-mail Facebook</label>
12985 | 302 |         <input id="FB_EMAIL" />
12986 | 303 |       </div>
12987 | 304 |       <div style="flex:1; min-width:260px;">
12988 | 305 |         <label>Has≈Ço Facebook</label>
12989 | 306 |         <input id="FB_PASSWORD" type="password" />
12990 | 307 |       </div>
12991 | 308 |     </div>
12992 | 309 | 
12993 | 310 |     <label>Webhook (URL)</label>
12994 | 311 |     <input id="WEBHOOK_URL" />
12995 | 312 | 
12996 | 313 |     <div class="row">
12997 | 314 |       <div style="flex:1; min-width:220px;">
12998 | 315 |         <label>Interwa≈Ç sprawdzania (ms)</label>
12999 | 316 |         <input id="CHECK_INTERVAL_MS" />
13000 | 317 |       </div>
13001 | 318 |       <div style="flex:2; min-width:260px;">
13002 | 319 |         <label>Arkusz z postami (CSV export)</label>
13003 | 320 |         <input id="POSTS_SHEET_URL" />
13004 | 321 |       </div>
13005 | 322 |     </div>
13006 | 323 | 
13007 | 324 |     <div class="row">
13008 | 325 |       <div style="flex:1; min-width:220px;">
13009 | 326 |         <label>Tryb bez okna (headless)</label>
13010 | 327 |         <select id="HEADLESS_BROWSER">
13011 | 328 |           <option value="true">true</option>
13012 | 329 |           <option value="false">false</option>
13013 | 330 |         </select>
13014 | 331 |       </div>
13015 | 332 |       <div style="flex:1; min-width:220px;">
13016 | 333 |         <label>Obs≈Çuga UI (handlery)</label>
13017 | 334 |         <select id="USE_UI_HANDLERS">
13018 | 335 |           <option value="true">true</option>
13019 | 336 |           <option value="false">false</option>
13020 | 337 |         </select>
13021 | 338 |       </div>
13022 | 339 |       <div style="flex:1; min-width:220px;">
13023 | 340 |         <label>Uwzglƒôdniaj odpowiedzi</label>
13024 | 341 |         <select id="INCLUDE_REPLIES">
13025 | 342 |           <option value="true">true</option>
13026 | 343 |           <option value="false">false</option>
13027 | 344 |         </select>
13028 | 345 |       </div>
13029 | 346 |     </div>
13030 | 347 | 
13031 | 348 |     <div class="row" style="margin-top:10px;">
13032 | 349 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
13033 | 350 |       <button id="pm2Start">Start watchera</button>
13034 | 351 |       <button id="pm2Stop">Stop watchera</button>
13035 | 352 |       <button id="pm2Restart">Restart watchera</button>
13036 | 353 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
13037 | 354 |     </div>
13038 | 355 | 
13039 | 356 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
13040 | 357 |   </div>
13041 | 358 | 
13042 | 359 |   <div class="card">
13043 | 360 |     <h3>Posty (data/posts.json)</h3>
13044 | 361 | 
13045 | 362 |     <div class="row">
13046 | 363 |       <div style="flex:2; min-width:260px;">
13047 | 364 |         <label>Nowy URL posta</label>
13048 | 365 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
13049 | 366 |       </div>
13050 | 367 | 
13051 | 368 |       <div style="flex:1; min-width:220px;">
13052 | 369 |         <label>Nazwa</label>
13053 | 370 |         <input id="newPostName" placeholder="np. A1" />
13054 | 371 |       </div>
13055 | 372 | 
13056 | 373 |       <div style="flex:1; min-width:260px;">
13057 | 374 |         <label>URL zdjƒôcia</label>
13058 | 375 |         <input id="newPostImage" placeholder="https://...jpg" />
13059 | 376 |       </div>
13060 | 377 |     </div>
13061 | 378 | 
13062 | 379 |     <div class="row" style="margin-top:10px;">
13063 | 380 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
13064 | 381 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
13065 | 382 |           <input type="checkbox" id="newPostActive" checked /> aktywny
13066 | 383 |         </label>
13067 | 384 |         <button class="primary" id="addPost">Dodaj</button>
13068 | 385 |       </div>
13069 | 386 |     </div>
13070 | 387 | 
13071 | 388 |     <div style="margin-top:12px;" class="tableWrap">
13072 | 389 |       <table>
13073 | 390 |         <thead>
13074 | 391 |           <tr>
13075 | 392 |             <th class="col-id">ID</th>
13076 | 393 |             <th class="col-url">Link</th>
13077 | 394 |             <th class="col-name">Nazwa</th>
13078 | 395 |             <th class="col-img">Zdjƒôcie</th>
13079 | 396 |             <th class="col-act">Aktywny</th>
13080 | 397 |             <th class="col-btn">Akcje</th>
13081 | 398 |           </tr>
13082 | 399 |         </thead>
13083 | 400 |         <tbody id="posts"></tbody>
13084 | 401 |       </table>
13085 | 402 |     </div>
13086 | 403 |   </div>
13087 | 404 | 
13088 | 405 |   <div class="card" id="logsCard">
13089 | 406 |     <div class="row" style="justify-content:space-between; align-items:center;">
13090 | 407 |       <h3 style="margin:0;">Logi</h3>
13091 | 408 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
13092 | 409 |         Rozwi≈Ñ
13093 | 410 |       </button>
13094 | 411 |     </div>
13095 | 412 | 
13096 | 413 |     <div class="logsBox">
13097 | 414 |       <div class="row">
13098 | 415 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
13099 | 416 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
13100 | 417 | 
13101 | 418 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
13102 | 419 | 
13103 | 420 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
13104 | 421 |           <option value="0">auto: wy≈Ç.</option>
13105 | 422 |           <option value="1000">co 1 s</option>
13106 | 423 |           <option value="2000" selected>co 2 s</option>
13107 | 424 |           <option value="5000">co 5 s</option>
13108 | 425 |           <option value="10000">co 10 s</option>
13109 | 426 |         </select>
13110 | 427 | 
13111 | 428 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
13112 | 429 | 
13113 | 430 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
13114 | 431 |           <input type="checkbox" id="logAutoScroll" checked />
13115 | 432 |           auto-scroll
13116 | 433 |         </label>
13117 | 434 |       </div>
13118 | 435 | 
13119 | 436 |       <div class="sep"></div>
13120 | 437 | 
13121 | 438 |       <textarea
13122 | 439 |         id="logs"
13123 | 440 |         class="mono"
13124 | 441 |         readonly
13125 | 442 |         spellcheck="false"
13126 | 443 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
13127 | 444 | 
13128 | 445 |       <div id="logHint" class="muted hint"></div>
13129 | 446 |     </div>
13130 | 447 |   </div>
13131 | 448 | 
13132 | 449 |   <!-- modal -->
13133 | 450 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
13134 | 451 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
13135 | 452 |       <h4 id="modalTitle">Potwierdzenie</h4>
13136 | 453 |       <div class="modalBody" id="modalBody"></div>
13137 | 454 |       <div class="modalActions">
13138 | 455 |         <button id="modalCancel">Anuluj</button>
13139 | 456 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
13140 | 457 |       </div>
13141 | 458 |       <div class="muted" style="margin-top:10px;">
13142 | 459 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
13143 | 460 |       </div>
13144 | 461 |     </div>
13145 | 462 |   </div>
13146 | 463 | 
13147 | 464 |   <script src="/app.js"></script>
13148 | 465 | </body>
13149 | 466 | </html>
13150 | 467 | 
13151 | ```
13152 | 
13153 | ---
13154 | 
13155 | ### üìÑ ≈öcie≈ºka: `src/panel/web/index.html`
13156 | **Typ:** HTML  
13157 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13158 | 
13159 | ```html
13160 |  1 | <!DOCTYPE html>
13161 |  2 | <html lang="pl" class="dark">
13162 |  3 |   <head>
13163 |  4 |     <meta charset="UTF-8" />
13164 |  5 |     <link rel="icon" type="image/svg+xml" href="/vite.svg" />
13165 |  6 |     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
13166 |  7 |     <title>FB Watcher - Panel</title>
13167 |  8 |   </head>
13168 |  9 |   <body>
13169 | 10 |     <div id="root"></div>
13170 | 11 |     <script type="module" src="/src/main.tsx"></script>
13171 | 12 |   </body>
13172 | 13 | </html>
13173 | 14 | 
13174 | ```
13175 | 
13176 | ---
13177 | 
13178 | ### üìÑ ≈öcie≈ºka: `src/panel/web/package.json`
13179 | **Typ:** JSON  
13180 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13181 | 
13182 | ```json
13183 |  1 | {
13184 |  2 |   "name": "fbwatcher-panel",
13185 |  3 |   "private": true,
13186 |  4 |   "version": "0.0.1",
13187 |  5 |   "type": "module",
13188 |  6 |   "scripts": {
13189 |  7 |     "dev": "vite",
13190 |  8 |     "build": "tsc -b && vite build",
13191 |  9 |     "lint": "eslint .",
13192 | 10 |     "preview": "vite preview"
13193 | 11 |   },
13194 | 12 |   "dependencies": {
13195 | 13 |     "react": "^18.3.1",
13196 | 14 |     "react-dom": "^18.3.1",
13197 | 15 |     "react-router-dom": "^7.1.1",
13198 | 16 |     "lucide-react": "^0.469.0",
13199 | 17 |     "clsx": "^2.1.1",
13200 | 18 |     "tailwind-merge": "^2.6.0",
13201 | 19 |     "class-variance-authority": "^0.7.1"
13202 | 20 |   },
13203 | 21 |   "devDependencies": {
13204 | 22 |     "@types/react": "^18.3.18",
13205 | 23 |     "@types/react-dom": "^18.3.5",
13206 | 24 |     "@vitejs/plugin-react": "^4.3.4",
13207 | 25 |     "autoprefixer": "^10.4.20",
13208 | 26 |     "postcss": "^8.4.49",
13209 | 27 |     "tailwindcss": "^3.4.17",
13210 | 28 |     "typescript": "~5.6.2",
13211 | 29 |     "vite": "^6.0.5"
13212 | 30 |   }
13213 | 31 | }
13214 | 32 | 
13215 | ```
13216 | 
13217 | ---
13218 | 
13219 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/App.tsx`
13220 | **Typ:** TypeScript  
13221 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13222 | 
13223 | ```tsx
13224 |  1 | import { BrowserRouter, Routes, Route } from 'react-router-dom'
13225 |  2 | import { AuthProvider } from '@/hooks/useAuth'
13226 |  3 | import { DashboardLayout } from '@/components/layout/DashboardLayout'
13227 |  4 | import { Dashboard } from '@/pages/Dashboard'
13228 |  5 | import { Watched } from '@/pages/Watched'
13229 |  6 | import { Sources } from '@/pages/Sources'
13230 |  7 | import { Discoveries } from '@/pages/Discoveries'
13231 |  8 | import { Campaigns } from '@/pages/Campaigns'
13232 |  9 | import { Cookies } from '@/pages/Cookies'
13233 | 10 | import { Settings } from '@/pages/Settings'
13234 | 11 | import { Logs } from '@/pages/Logs'
13235 | 12 | 
13236 | 13 | export default function App() {
13237 | 14 |   return (
13238 | 15 |     <AuthProvider>
13239 | 16 |       <BrowserRouter basename="/new">
13240 | 17 |         <Routes>
13241 | 18 |           <Route element={<DashboardLayout />}>
13242 | 19 |             <Route path="/" element={<Dashboard />} />
13243 | 20 |             <Route path="/watched" element={<Watched />} />
13244 | 21 |             <Route path="/sources" element={<Sources />} />
13245 | 22 |             <Route path="/discoveries" element={<Discoveries />} />
13246 | 23 |             <Route path="/campaigns" element={<Campaigns />} />
13247 | 24 |             <Route path="/cookies" element={<Cookies />} />
13248 | 25 |             <Route path="/settings" element={<Settings />} />
13249 | 26 |             <Route path="/logs" element={<Logs />} />
13250 | 27 |           </Route>
13251 | 28 |         </Routes>
13252 | 29 |       </BrowserRouter>
13253 | 30 |     </AuthProvider>
13254 | 31 |   )
13255 | 32 | }
13256 | 33 | 
13257 | ```
13258 | 
13259 | ---
13260 | 
13261 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/DashboardLayout.tsx`
13262 | **Typ:** TypeScript  
13263 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13264 | 
13265 | ```tsx
13266 |  1 | import { useState, useEffect } from 'react'
13267 |  2 | import { Outlet, useLocation } from 'react-router-dom'
13268 |  3 | import { Sidebar } from './Sidebar'
13269 |  4 | import { Header } from './Header'
13270 |  5 | import { MobileNav } from './MobileNav'
13271 |  6 | 
13272 |  7 | const PAGE_TITLES: Record<string, string> = {
13273 |  8 |   '/': 'Dashboard',
13274 |  9 |   '/watched': 'Obserwowane posty',
13275 | 10 |   '/sources': 'Zrodla',
13276 | 11 |   '/discoveries': 'Wykrycia',
13277 | 12 |   '/campaigns': 'Kampanie',
13278 | 13 |   '/cookies': 'Sesje / Cookies',
13279 | 14 |   '/settings': 'Ustawienia',
13280 | 15 |   '/logs': 'Logi',
13281 | 16 | }
13282 | 17 | 
13283 | 18 | export function DashboardLayout() {
13284 | 19 |   const [mobileNavOpen, setMobileNavOpen] = useState(false)
13285 | 20 |   const location = useLocation()
13286 | 21 | 
13287 | 22 |   const pageTitle = PAGE_TITLES[location.pathname] || 'FB Watcher'
13288 | 23 | 
13289 | 24 |   // Close mobile nav on route change
13290 | 25 |   useEffect(() => {
13291 | 26 |     setMobileNavOpen(false)
13292 | 27 |   }, [location.pathname])
13293 | 28 | 
13294 | 29 |   return (
13295 | 30 |     <div className="grid min-h-screen w-full md:grid-cols-[220px_1fr] lg:grid-cols-[280px_1fr]">
13296 | 31 |       {/* Desktop sidebar */}
13297 | 32 |       <div className="hidden border-r bg-muted/40 md:block">
13298 | 33 |         <Sidebar />
13299 | 34 |       </div>
13300 | 35 | 
13301 | 36 |       {/* Mobile nav */}
13302 | 37 |       <MobileNav open={mobileNavOpen} onClose={() => setMobileNavOpen(false)} />
13303 | 38 | 
13304 | 39 |       {/* Main content */}
13305 | 40 |       <div className="flex flex-col">
13306 | 41 |         <Header title={pageTitle} onMenuClick={() => setMobileNavOpen(true)} />
13307 | 42 |         <main className="flex flex-1 flex-col gap-4 p-4 lg:gap-6 lg:p-6">
13308 | 43 |           <Outlet />
13309 | 44 |         </main>
13310 | 45 |       </div>
13311 | 46 |     </div>
13312 | 47 |   )
13313 | 48 | }
13314 | 49 | 
13315 | ```
13316 | 
13317 | ---
13318 | 
13319 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Header.tsx`
13320 | **Typ:** TypeScript  
13321 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13322 | 
13323 | ```tsx
13324 |  1 | import { Menu } from 'lucide-react'
13325 |  2 | import { Button } from '@/components/ui/button'
13326 |  3 | 
13327 |  4 | interface HeaderProps {
13328 |  5 |   title: string
13329 |  6 |   onMenuClick?: () => void
13330 |  7 | }
13331 |  8 | 
13332 |  9 | export function Header({ title, onMenuClick }: HeaderProps) {
13333 | 10 |   return (
13334 | 11 |     <header className="flex h-14 items-center gap-4 border-b bg-background px-4 lg:h-[60px] lg:px-6">
13335 | 12 |       <Button
13336 | 13 |         variant="ghost"
13337 | 14 |         size="icon"
13338 | 15 |         className="shrink-0 md:hidden"
13339 | 16 |         onClick={onMenuClick}
13340 | 17 |       >
13341 | 18 |         <Menu className="h-5 w-5" />
13342 | 19 |         <span className="sr-only">Menu</span>
13343 | 20 |       </Button>
13344 | 21 |       <div className="flex-1">
13345 | 22 |         <h1 className="text-lg font-semibold md:text-xl">{title}</h1>
13346 | 23 |       </div>
13347 | 24 |     </header>
13348 | 25 |   )
13349 | 26 | }
13350 | 27 | 
13351 | ```
13352 | 
13353 | ---
13354 | 
13355 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/MobileNav.tsx`
13356 | **Typ:** TypeScript  
13357 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13358 | 
13359 | ```tsx
13360 |  1 | import { X } from 'lucide-react'
13361 |  2 | import { Button } from '@/components/ui/button'
13362 |  3 | import { Sidebar } from './Sidebar'
13363 |  4 | import { cn } from '@/lib/utils'
13364 |  5 | 
13365 |  6 | interface MobileNavProps {
13366 |  7 |   open: boolean
13367 |  8 |   onClose: () => void
13368 |  9 | }
13369 | 10 | 
13370 | 11 | export function MobileNav({ open, onClose }: MobileNavProps) {
13371 | 12 |   return (
13372 | 13 |     <>
13373 | 14 |       {/* Overlay */}
13374 | 15 |       <div
13375 | 16 |         className={cn(
13376 | 17 |           'fixed inset-0 z-40 bg-black/80 transition-opacity md:hidden',
13377 | 18 |           open ? 'opacity-100' : 'opacity-0 pointer-events-none'
13378 | 19 |         )}
13379 | 20 |         onClick={onClose}
13380 | 21 |       />
13381 | 22 | 
13382 | 23 |       {/* Sidebar */}
13383 | 24 |       <div
13384 | 25 |         className={cn(
13385 | 26 |           'fixed inset-y-0 left-0 z-50 w-72 bg-background transition-transform md:hidden',
13386 | 27 |           open ? 'translate-x-0' : '-translate-x-full'
13387 | 28 |         )}
13388 | 29 |       >
13389 | 30 |         <Button
13390 | 31 |           variant="ghost"
13391 | 32 |           size="icon"
13392 | 33 |           className="absolute right-2 top-2"
13393 | 34 |           onClick={onClose}
13394 | 35 |         >
13395 | 36 |           <X className="h-5 w-5" />
13396 | 37 |         </Button>
13397 | 38 |         <Sidebar />
13398 | 39 |       </div>
13399 | 40 |     </>
13400 | 41 |   )
13401 | 42 | }
13402 | 43 | 
13403 | ```
13404 | 
13405 | ---
13406 | 
13407 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/layout/Sidebar.tsx`
13408 | **Typ:** TypeScript  
13409 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13410 | 
13411 | ```tsx
13412 |   1 | import { NavLink } from 'react-router-dom'
13413 |   2 | import {
13414 |   3 |   Home,
13415 |   4 |   Bell,
13416 |   5 |   Eye,
13417 |   6 |   Globe,
13418 |   7 |   Megaphone,
13419 |   8 |   Cookie,
13420 |   9 |   Settings,
13421 |  10 |   Terminal,
13422 |  11 | } from 'lucide-react'
13423 |  12 | import { cn } from '@/lib/utils'
13424 |  13 | import { Badge } from '@/components/ui/badge'
13425 |  14 | import { Separator } from '@/components/ui/separator'
13426 |  15 | 
13427 |  16 | interface NavItemProps {
13428 |  17 |   to: string
13429 |  18 |   icon: React.ReactNode
13430 |  19 |   label: string
13431 |  20 |   badge?: number
13432 |  21 |   disabled?: boolean
13433 |  22 | }
13434 |  23 | 
13435 |  24 | function NavItem({ to, icon, label, badge, disabled }: NavItemProps) {
13436 |  25 |   if (disabled) {
13437 |  26 |     return (
13438 |  27 |       <div className="flex items-center gap-3 rounded-lg px-3 py-2 text-muted-foreground/50 cursor-not-allowed">
13439 |  28 |         {icon}
13440 |  29 |         <span className="flex-1">{label}</span>
13441 |  30 |         <Badge variant="outline" className="text-xs opacity-50">
13442 |  31 |           Wkrotce
13443 |  32 |         </Badge>
13444 |  33 |       </div>
13445 |  34 |     )
13446 |  35 |   }
13447 |  36 | 
13448 |  37 |   return (
13449 |  38 |     <NavLink
13450 |  39 |       to={to}
13451 |  40 |       className={({ isActive }) =>
13452 |  41 |         cn(
13453 |  42 |           'flex items-center gap-3 rounded-lg px-3 py-2 transition-colors',
13454 |  43 |           isActive
13455 |  44 |             ? 'bg-secondary text-secondary-foreground'
13456 |  45 |             : 'text-muted-foreground hover:bg-secondary/50 hover:text-secondary-foreground'
13457 |  46 |         )
13458 |  47 |       }
13459 |  48 |     >
13460 |  49 |       {icon}
13461 |  50 |       <span className="flex-1">{label}</span>
13462 |  51 |       {badge !== undefined && badge > 0 && (
13463 |  52 |         <Badge variant="destructive" className="text-xs">
13464 |  53 |           {badge}
13465 |  54 |         </Badge>
13466 |  55 |       )}
13467 |  56 |     </NavLink>
13468 |  57 |   )
13469 |  58 | }
13470 |  59 | 
13471 |  60 | interface SidebarProps {
13472 |  61 |   className?: string
13473 |  62 | }
13474 |  63 | 
13475 |  64 | export function Sidebar({ className }: SidebarProps) {
13476 |  65 |   return (
13477 |  66 |     <div className={cn('flex h-full flex-col gap-2', className)}>
13478 |  67 |       <div className="flex h-14 items-center border-b px-4 lg:h-[60px] lg:px-6">
13479 |  68 |         <span className="flex items-center gap-2 font-semibold">
13480 |  69 |           <Eye className="h-6 w-6" />
13481 |  70 |           <span>FB Watcher</span>
13482 |  71 |         </span>
13483 |  72 |       </div>
13484 |  73 |       <div className="flex-1 overflow-auto">
13485 |  74 |         <nav className="grid items-start gap-1 px-2 text-sm font-medium lg:px-4">
13486 |  75 |           <div className="py-2">
13487 |  76 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
13488 |  77 |               Glowne
13489 |  78 |             </p>
13490 |  79 |           </div>
13491 |  80 |           <NavItem to="/" icon={<Home className="h-4 w-4" />} label="Dashboard" />
13492 |  81 |           <NavItem
13493 |  82 |             to="/discoveries"
13494 |  83 |             icon={<Bell className="h-4 w-4" />}
13495 |  84 |             label="Wykrycia"
13496 |  85 |             disabled
13497 |  86 |           />
13498 |  87 | 
13499 |  88 |           <Separator className="my-3" />
13500 |  89 | 
13501 |  90 |           <div className="py-2">
13502 |  91 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
13503 |  92 |               Monitoring
13504 |  93 |             </p>
13505 |  94 |           </div>
13506 |  95 |           <NavItem to="/watched" icon={<Eye className="h-4 w-4" />} label="Obserwowane" />
13507 |  96 |           <NavItem
13508 |  97 |             to="/sources"
13509 |  98 |             icon={<Globe className="h-4 w-4" />}
13510 |  99 |             label="Zrodla"
13511 | 100 |             disabled
13512 | 101 |           />
13513 | 102 | 
13514 | 103 |           <Separator className="my-3" />
13515 | 104 | 
13516 | 105 |           <div className="py-2">
13517 | 106 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
13518 | 107 |               Automatyzacja
13519 | 108 |             </p>
13520 | 109 |           </div>
13521 | 110 |           <NavItem
13522 | 111 |             to="/campaigns"
13523 | 112 |             icon={<Megaphone className="h-4 w-4" />}
13524 | 113 |             label="Kampanie"
13525 | 114 |             disabled
13526 | 115 |           />
13527 | 116 | 
13528 | 117 |           <Separator className="my-3" />
13529 | 118 | 
13530 | 119 |           <div className="py-2">
13531 | 120 |             <p className="px-3 text-xs font-semibold uppercase text-muted-foreground/70 tracking-wider">
13532 | 121 |               System
13533 | 122 |             </p>
13534 | 123 |           </div>
13535 | 124 |           <NavItem to="/cookies" icon={<Cookie className="h-4 w-4" />} label="Sesje" />
13536 | 125 |           <NavItem to="/settings" icon={<Settings className="h-4 w-4" />} label="Ustawienia" />
13537 | 126 |           <NavItem to="/logs" icon={<Terminal className="h-4 w-4" />} label="Logi" />
13538 | 127 |         </nav>
13539 | 128 |       </div>
13540 | 129 |     </div>
13541 | 130 |   )
13542 | 131 | }
13543 | 132 | 
13544 | ```
13545 | 
13546 | ---
13547 | 
13548 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/badge.tsx`
13549 | **Typ:** TypeScript  
13550 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13551 | 
13552 | ```tsx
13553 |  1 | import * as React from 'react'
13554 |  2 | import { cva, type VariantProps } from 'class-variance-authority'
13555 |  3 | import { cn } from '@/lib/utils'
13556 |  4 | 
13557 |  5 | const badgeVariants = cva(
13558 |  6 |   'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
13559 |  7 |   {
13560 |  8 |     variants: {
13561 |  9 |       variant: {
13562 | 10 |         default: 'border-transparent bg-primary text-primary-foreground hover:bg-primary/80',
13563 | 11 |         secondary: 'border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80',
13564 | 12 |         destructive: 'border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80',
13565 | 13 |         outline: 'text-foreground',
13566 | 14 |         success: 'border-transparent bg-green-600 text-white hover:bg-green-600/80',
13567 | 15 |         warning: 'border-transparent bg-yellow-600 text-white hover:bg-yellow-600/80',
13568 | 16 |       },
13569 | 17 |     },
13570 | 18 |     defaultVariants: {
13571 | 19 |       variant: 'default',
13572 | 20 |     },
13573 | 21 |   }
13574 | 22 | )
13575 | 23 | 
13576 | 24 | export interface BadgeProps
13577 | 25 |   extends React.HTMLAttributes<HTMLDivElement>,
13578 | 26 |     VariantProps<typeof badgeVariants> {}
13579 | 27 | 
13580 | 28 | function Badge({ className, variant, ...props }: BadgeProps) {
13581 | 29 |   return <div className={cn(badgeVariants({ variant }), className)} {...props} />
13582 | 30 | }
13583 | 31 | 
13584 | 32 | export { Badge, badgeVariants }
13585 | 33 | 
13586 | ```
13587 | 
13588 | ---
13589 | 
13590 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/button.tsx`
13591 | **Typ:** TypeScript  
13592 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13593 | 
13594 | ```tsx
13595 |  1 | import * as React from 'react'
13596 |  2 | import { cva, type VariantProps } from 'class-variance-authority'
13597 |  3 | import { cn } from '@/lib/utils'
13598 |  4 | 
13599 |  5 | const buttonVariants = cva(
13600 |  6 |   'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0',
13601 |  7 |   {
13602 |  8 |     variants: {
13603 |  9 |       variant: {
13604 | 10 |         default: 'bg-primary text-primary-foreground hover:bg-primary/90',
13605 | 11 |         destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
13606 | 12 |         outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
13607 | 13 |         secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
13608 | 14 |         ghost: 'hover:bg-accent hover:text-accent-foreground',
13609 | 15 |         link: 'text-primary underline-offset-4 hover:underline',
13610 | 16 |       },
13611 | 17 |       size: {
13612 | 18 |         default: 'h-10 px-4 py-2',
13613 | 19 |         sm: 'h-9 rounded-md px-3',
13614 | 20 |         lg: 'h-11 rounded-md px-8',
13615 | 21 |         icon: 'h-10 w-10',
13616 | 22 |       },
13617 | 23 |     },
13618 | 24 |     defaultVariants: {
13619 | 25 |       variant: 'default',
13620 | 26 |       size: 'default',
13621 | 27 |     },
13622 | 28 |   }
13623 | 29 | )
13624 | 30 | 
13625 | 31 | export interface ButtonProps
13626 | 32 |   extends React.ButtonHTMLAttributes<HTMLButtonElement>,
13627 | 33 |     VariantProps<typeof buttonVariants> {}
13628 | 34 | 
13629 | 35 | const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
13630 | 36 |   ({ className, variant, size, ...props }, ref) => {
13631 | 37 |     return (
13632 | 38 |       <button
13633 | 39 |         className={cn(buttonVariants({ variant, size, className }))}
13634 | 40 |         ref={ref}
13635 | 41 |         {...props}
13636 | 42 |       />
13637 | 43 |     )
13638 | 44 |   }
13639 | 45 | )
13640 | 46 | Button.displayName = 'Button'
13641 | 47 | 
13642 | 48 | export { Button, buttonVariants }
13643 | 49 | 
13644 | ```
13645 | 
13646 | ---
13647 | 
13648 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/card.tsx`
13649 | **Typ:** TypeScript  
13650 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13651 | 
13652 | ```tsx
13653 |  1 | import * as React from 'react'
13654 |  2 | import { cn } from '@/lib/utils'
13655 |  3 | 
13656 |  4 | const Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13657 |  5 |   ({ className, ...props }, ref) => (
13658 |  6 |     <div
13659 |  7 |       ref={ref}
13660 |  8 |       className={cn('rounded-lg border bg-card text-card-foreground shadow-sm', className)}
13661 |  9 |       {...props}
13662 | 10 |     />
13663 | 11 |   )
13664 | 12 | )
13665 | 13 | Card.displayName = 'Card'
13666 | 14 | 
13667 | 15 | const CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13668 | 16 |   ({ className, ...props }, ref) => (
13669 | 17 |     <div ref={ref} className={cn('flex flex-col space-y-1.5 p-6', className)} {...props} />
13670 | 18 |   )
13671 | 19 | )
13672 | 20 | CardHeader.displayName = 'CardHeader'
13673 | 21 | 
13674 | 22 | const CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(
13675 | 23 |   ({ className, ...props }, ref) => (
13676 | 24 |     <h3
13677 | 25 |       ref={ref}
13678 | 26 |       className={cn('text-2xl font-semibold leading-none tracking-tight', className)}
13679 | 27 |       {...props}
13680 | 28 |     />
13681 | 29 |   )
13682 | 30 | )
13683 | 31 | CardTitle.displayName = 'CardTitle'
13684 | 32 | 
13685 | 33 | const CardDescription = React.forwardRef<
13686 | 34 |   HTMLParagraphElement,
13687 | 35 |   React.HTMLAttributes<HTMLParagraphElement>
13688 | 36 | >(({ className, ...props }, ref) => (
13689 | 37 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
13690 | 38 | ))
13691 | 39 | CardDescription.displayName = 'CardDescription'
13692 | 40 | 
13693 | 41 | const CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13694 | 42 |   ({ className, ...props }, ref) => (
13695 | 43 |     <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
13696 | 44 |   )
13697 | 45 | )
13698 | 46 | CardContent.displayName = 'CardContent'
13699 | 47 | 
13700 | 48 | const CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13701 | 49 |   ({ className, ...props }, ref) => (
13702 | 50 |     <div ref={ref} className={cn('flex items-center p-6 pt-0', className)} {...props} />
13703 | 51 |   )
13704 | 52 | )
13705 | 53 | CardFooter.displayName = 'CardFooter'
13706 | 54 | 
13707 | 55 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
13708 | 56 | 
13709 | ```
13710 | 
13711 | ---
13712 | 
13713 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/checkbox.tsx`
13714 | **Typ:** TypeScript  
13715 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13716 | 
13717 | ```tsx
13718 |  1 | import * as React from 'react'
13719 |  2 | import { Check } from 'lucide-react'
13720 |  3 | import { cn } from '@/lib/utils'
13721 |  4 | 
13722 |  5 | export interface CheckboxProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
13723 |  6 |   onCheckedChange?: (checked: boolean) => void
13724 |  7 | }
13725 |  8 | 
13726 |  9 | const Checkbox = React.forwardRef<HTMLInputElement, CheckboxProps>(
13727 | 10 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
13728 | 11 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
13729 | 12 |       onChange?.(e)
13730 | 13 |       onCheckedChange?.(e.target.checked)
13731 | 14 |     }
13732 | 15 | 
13733 | 16 |     return (
13734 | 17 |       <div className="relative inline-flex items-center">
13735 | 18 |         <input
13736 | 19 |           type="checkbox"
13737 | 20 |           ref={ref}
13738 | 21 |           checked={checked}
13739 | 22 |           onChange={handleChange}
13740 | 23 |           className="sr-only peer"
13741 | 24 |           {...props}
13742 | 25 |         />
13743 | 26 |         <div
13744 | 27 |           className={cn(
13745 | 28 |             'h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary peer-checked:text-primary-foreground flex items-center justify-center cursor-pointer',
13746 | 29 |             className
13747 | 30 |           )}
13748 | 31 |           onClick={() => {
13749 | 32 |             const input = ref && 'current' in ref ? ref.current : null
13750 | 33 |             if (input) {
13751 | 34 |               input.click()
13752 | 35 |             }
13753 | 36 |           }}
13754 | 37 |         >
13755 | 38 |           {checked && <Check className="h-3 w-3" />}
13756 | 39 |         </div>
13757 | 40 |       </div>
13758 | 41 |     )
13759 | 42 |   }
13760 | 43 | )
13761 | 44 | Checkbox.displayName = 'Checkbox'
13762 | 45 | 
13763 | 46 | export { Checkbox }
13764 | 47 | 
13765 | ```
13766 | 
13767 | ---
13768 | 
13769 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/dialog.tsx`
13770 | **Typ:** TypeScript  
13771 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13772 | 
13773 | ```tsx
13774 |   1 | import * as React from 'react'
13775 |   2 | import { X } from 'lucide-react'
13776 |   3 | import { cn } from '@/lib/utils'
13777 |   4 | 
13778 |   5 | interface DialogContextValue {
13779 |   6 |   open: boolean
13780 |   7 |   onOpenChange: (open: boolean) => void
13781 |   8 | }
13782 |   9 | 
13783 |  10 | const DialogContext = React.createContext<DialogContextValue | null>(null)
13784 |  11 | 
13785 |  12 | interface DialogProps {
13786 |  13 |   open?: boolean
13787 |  14 |   onOpenChange?: (open: boolean) => void
13788 |  15 |   children: React.ReactNode
13789 |  16 | }
13790 |  17 | 
13791 |  18 | function Dialog({ open = false, onOpenChange, children }: DialogProps) {
13792 |  19 |   const handleOpenChange = React.useCallback(
13793 |  20 |     (newOpen: boolean) => {
13794 |  21 |       onOpenChange?.(newOpen)
13795 |  22 |     },
13796 |  23 |     [onOpenChange]
13797 |  24 |   )
13798 |  25 | 
13799 |  26 |   return (
13800 |  27 |     <DialogContext.Provider value={{ open, onOpenChange: handleOpenChange }}>
13801 |  28 |       {children}
13802 |  29 |     </DialogContext.Provider>
13803 |  30 |   )
13804 |  31 | }
13805 |  32 | 
13806 |  33 | interface DialogTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
13807 |  34 |   asChild?: boolean
13808 |  35 | }
13809 |  36 | 
13810 |  37 | const DialogTrigger = React.forwardRef<HTMLButtonElement, DialogTriggerProps>(
13811 |  38 |   ({ onClick, children, ...props }, ref) => {
13812 |  39 |     const context = React.useContext(DialogContext)
13813 |  40 |     return (
13814 |  41 |       <button
13815 |  42 |         ref={ref}
13816 |  43 |         onClick={(e) => {
13817 |  44 |           onClick?.(e)
13818 |  45 |           context?.onOpenChange(true)
13819 |  46 |         }}
13820 |  47 |         {...props}
13821 |  48 |       >
13822 |  49 |         {children}
13823 |  50 |       </button>
13824 |  51 |     )
13825 |  52 |   }
13826 |  53 | )
13827 |  54 | DialogTrigger.displayName = 'DialogTrigger'
13828 |  55 | 
13829 |  56 | interface DialogPortalProps {
13830 |  57 |   children: React.ReactNode
13831 |  58 | }
13832 |  59 | 
13833 |  60 | function DialogPortal({ children }: DialogPortalProps) {
13834 |  61 |   const context = React.useContext(DialogContext)
13835 |  62 |   if (!context?.open) return null
13836 |  63 |   return <>{children}</>
13837 |  64 | }
13838 |  65 | 
13839 |  66 | const DialogOverlay = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13840 |  67 |   ({ className, ...props }, ref) => {
13841 |  68 |     const context = React.useContext(DialogContext)
13842 |  69 |     return (
13843 |  70 |       <div
13844 |  71 |         ref={ref}
13845 |  72 |         className={cn(
13846 |  73 |           'fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
13847 |  74 |           className
13848 |  75 |         )}
13849 |  76 |         data-state={context?.open ? 'open' : 'closed'}
13850 |  77 |         onClick={() => context?.onOpenChange(false)}
13851 |  78 |         {...props}
13852 |  79 |       />
13853 |  80 |     )
13854 |  81 |   }
13855 |  82 | )
13856 |  83 | DialogOverlay.displayName = 'DialogOverlay'
13857 |  84 | 
13858 |  85 | const DialogContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
13859 |  86 |   ({ className, children, ...props }, ref) => {
13860 |  87 |     const context = React.useContext(DialogContext)
13861 |  88 | 
13862 |  89 |     React.useEffect(() => {
13863 |  90 |       const handleEscape = (e: KeyboardEvent) => {
13864 |  91 |         if (e.key === 'Escape') {
13865 |  92 |           context?.onOpenChange(false)
13866 |  93 |         }
13867 |  94 |       }
13868 |  95 |       if (context?.open) {
13869 |  96 |         document.addEventListener('keydown', handleEscape)
13870 |  97 |         return () => document.removeEventListener('keydown', handleEscape)
13871 |  98 |       }
13872 |  99 |     }, [context])
13873 | 100 | 
13874 | 101 |     return (
13875 | 102 |       <DialogPortal>
13876 | 103 |         <DialogOverlay />
13877 | 104 |         <div
13878 | 105 |           ref={ref}
13879 | 106 |           className={cn(
13880 | 107 |             'fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg',
13881 | 108 |             className
13882 | 109 |           )}
13883 | 110 |           data-state={context?.open ? 'open' : 'closed'}
13884 | 111 |           onClick={(e) => e.stopPropagation()}
13885 | 112 |           {...props}
13886 | 113 |         >
13887 | 114 |           {children}
13888 | 115 |           <button
13889 | 116 |             className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none"
13890 | 117 |             onClick={() => context?.onOpenChange(false)}
13891 | 118 |           >
13892 | 119 |             <X className="h-4 w-4" />
13893 | 120 |             <span className="sr-only">Zamknij</span>
13894 | 121 |           </button>
13895 | 122 |         </div>
13896 | 123 |       </DialogPortal>
13897 | 124 |     )
13898 | 125 |   }
13899 | 126 | )
13900 | 127 | DialogContent.displayName = 'DialogContent'
13901 | 128 | 
13902 | 129 | const DialogHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
13903 | 130 |   <div className={cn('flex flex-col space-y-1.5 text-center sm:text-left', className)} {...props} />
13904 | 131 | )
13905 | 132 | DialogHeader.displayName = 'DialogHeader'
13906 | 133 | 
13907 | 134 | const DialogFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
13908 | 135 |   <div
13909 | 136 |     className={cn('flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2', className)}
13910 | 137 |     {...props}
13911 | 138 |   />
13912 | 139 | )
13913 | 140 | DialogFooter.displayName = 'DialogFooter'
13914 | 141 | 
13915 | 142 | const DialogTitle = React.forwardRef<
13916 | 143 |   HTMLHeadingElement,
13917 | 144 |   React.HTMLAttributes<HTMLHeadingElement>
13918 | 145 | >(({ className, ...props }, ref) => (
13919 | 146 |   <h2
13920 | 147 |     ref={ref}
13921 | 148 |     className={cn('text-lg font-semibold leading-none tracking-tight', className)}
13922 | 149 |     {...props}
13923 | 150 |   />
13924 | 151 | ))
13925 | 152 | DialogTitle.displayName = 'DialogTitle'
13926 | 153 | 
13927 | 154 | const DialogDescription = React.forwardRef<
13928 | 155 |   HTMLParagraphElement,
13929 | 156 |   React.HTMLAttributes<HTMLParagraphElement>
13930 | 157 | >(({ className, ...props }, ref) => (
13931 | 158 |   <p ref={ref} className={cn('text-sm text-muted-foreground', className)} {...props} />
13932 | 159 | ))
13933 | 160 | DialogDescription.displayName = 'DialogDescription'
13934 | 161 | 
13935 | 162 | export {
13936 | 163 |   Dialog,
13937 | 164 |   DialogPortal,
13938 | 165 |   DialogOverlay,
13939 | 166 |   DialogTrigger,
13940 | 167 |   DialogContent,
13941 | 168 |   DialogHeader,
13942 | 169 |   DialogFooter,
13943 | 170 |   DialogTitle,
13944 | 171 |   DialogDescription,
13945 | 172 | }
13946 | 173 | 
13947 | ```
13948 | 
13949 | ---
13950 | 
13951 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/input.tsx`
13952 | **Typ:** TypeScript  
13953 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13954 | 
13955 | ```tsx
13956 |  1 | import * as React from 'react'
13957 |  2 | import { cn } from '@/lib/utils'
13958 |  3 | 
13959 |  4 | export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {}
13960 |  5 | 
13961 |  6 | const Input = React.forwardRef<HTMLInputElement, InputProps>(
13962 |  7 |   ({ className, type, ...props }, ref) => {
13963 |  8 |     return (
13964 |  9 |       <input
13965 | 10 |         type={type}
13966 | 11 |         className={cn(
13967 | 12 |           'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
13968 | 13 |           className
13969 | 14 |         )}
13970 | 15 |         ref={ref}
13971 | 16 |         {...props}
13972 | 17 |       />
13973 | 18 |     )
13974 | 19 |   }
13975 | 20 | )
13976 | 21 | Input.displayName = 'Input'
13977 | 22 | 
13978 | 23 | export { Input }
13979 | 24 | 
13980 | ```
13981 | 
13982 | ---
13983 | 
13984 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/label.tsx`
13985 | **Typ:** TypeScript  
13986 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
13987 | 
13988 | ```tsx
13989 |  1 | import * as React from 'react'
13990 |  2 | import { cva, type VariantProps } from 'class-variance-authority'
13991 |  3 | import { cn } from '@/lib/utils'
13992 |  4 | 
13993 |  5 | const labelVariants = cva(
13994 |  6 |   'text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70'
13995 |  7 | )
13996 |  8 | 
13997 |  9 | export interface LabelProps
13998 | 10 |   extends React.LabelHTMLAttributes<HTMLLabelElement>,
13999 | 11 |     VariantProps<typeof labelVariants> {}
14000 | 12 | 
14001 | 13 | const Label = React.forwardRef<HTMLLabelElement, LabelProps>(
14002 | 14 |   ({ className, ...props }, ref) => (
14003 | 15 |     <label ref={ref} className={cn(labelVariants(), className)} {...props} />
14004 | 16 |   )
14005 | 17 | )
14006 | 18 | Label.displayName = 'Label'
14007 | 19 | 
14008 | 20 | export { Label }
14009 | 21 | 
14010 | ```
14011 | 
14012 | ---
14013 | 
14014 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/separator.tsx`
14015 | **Typ:** TypeScript  
14016 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14017 | 
14018 | ```tsx
14019 |  1 | import * as React from 'react'
14020 |  2 | import { cn } from '@/lib/utils'
14021 |  3 | 
14022 |  4 | interface SeparatorProps extends React.HTMLAttributes<HTMLDivElement> {
14023 |  5 |   orientation?: 'horizontal' | 'vertical'
14024 |  6 |   decorative?: boolean
14025 |  7 | }
14026 |  8 | 
14027 |  9 | const Separator = React.forwardRef<HTMLDivElement, SeparatorProps>(
14028 | 10 |   ({ className, orientation = 'horizontal', decorative = true, ...props }, ref) => (
14029 | 11 |     <div
14030 | 12 |       ref={ref}
14031 | 13 |       role={decorative ? 'none' : 'separator'}
14032 | 14 |       aria-orientation={decorative ? undefined : orientation}
14033 | 15 |       className={cn(
14034 | 16 |         'shrink-0 bg-border',
14035 | 17 |         orientation === 'horizontal' ? 'h-[1px] w-full' : 'h-full w-[1px]',
14036 | 18 |         className
14037 | 19 |       )}
14038 | 20 |       {...props}
14039 | 21 |     />
14040 | 22 |   )
14041 | 23 | )
14042 | 24 | Separator.displayName = 'Separator'
14043 | 25 | 
14044 | 26 | export { Separator }
14045 | 27 | 
14046 | ```
14047 | 
14048 | ---
14049 | 
14050 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/switch.tsx`
14051 | **Typ:** TypeScript  
14052 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14053 | 
14054 | ```tsx
14055 |  1 | import * as React from 'react'
14056 |  2 | import { cn } from '@/lib/utils'
14057 |  3 | 
14058 |  4 | export interface SwitchProps extends Omit<React.InputHTMLAttributes<HTMLInputElement>, 'type'> {
14059 |  5 |   onCheckedChange?: (checked: boolean) => void
14060 |  6 | }
14061 |  7 | 
14062 |  8 | const Switch = React.forwardRef<HTMLInputElement, SwitchProps>(
14063 |  9 |   ({ className, checked, onCheckedChange, onChange, ...props }, ref) => {
14064 | 10 |     const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
14065 | 11 |       onChange?.(e)
14066 | 12 |       onCheckedChange?.(e.target.checked)
14067 | 13 |     }
14068 | 14 | 
14069 | 15 |     return (
14070 | 16 |       <label className="relative inline-flex cursor-pointer items-center">
14071 | 17 |         <input
14072 | 18 |           type="checkbox"
14073 | 19 |           ref={ref}
14074 | 20 |           checked={checked}
14075 | 21 |           onChange={handleChange}
14076 | 22 |           className="sr-only peer"
14077 | 23 |           {...props}
14078 | 24 |         />
14079 | 25 |         <div
14080 | 26 |           className={cn(
14081 | 27 |             'peer h-6 w-11 rounded-full bg-input ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 peer-checked:bg-primary',
14082 | 28 |             className
14083 | 29 |           )}
14084 | 30 |         >
14085 | 31 |           <div
14086 | 32 |             className={cn(
14087 | 33 |               'absolute left-[2px] top-[2px] h-5 w-5 rounded-full bg-background transition-transform',
14088 | 34 |               checked && 'translate-x-5'
14089 | 35 |             )}
14090 | 36 |           />
14091 | 37 |         </div>
14092 | 38 |       </label>
14093 | 39 |     )
14094 | 40 |   }
14095 | 41 | )
14096 | 42 | Switch.displayName = 'Switch'
14097 | 43 | 
14098 | 44 | export { Switch }
14099 | 45 | 
14100 | ```
14101 | 
14102 | ---
14103 | 
14104 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/table.tsx`
14105 | **Typ:** TypeScript  
14106 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14107 | 
14108 | ```tsx
14109 |   1 | import * as React from 'react'
14110 |   2 | import { cn } from '@/lib/utils'
14111 |   3 | 
14112 |   4 | const Table = React.forwardRef<HTMLTableElement, React.HTMLAttributes<HTMLTableElement>>(
14113 |   5 |   ({ className, ...props }, ref) => (
14114 |   6 |     <div className="relative w-full overflow-auto">
14115 |   7 |       <table
14116 |   8 |         ref={ref}
14117 |   9 |         className={cn('w-full caption-bottom text-sm', className)}
14118 |  10 |         {...props}
14119 |  11 |       />
14120 |  12 |     </div>
14121 |  13 |   )
14122 |  14 | )
14123 |  15 | Table.displayName = 'Table'
14124 |  16 | 
14125 |  17 | const TableHeader = React.forwardRef<
14126 |  18 |   HTMLTableSectionElement,
14127 |  19 |   React.HTMLAttributes<HTMLTableSectionElement>
14128 |  20 | >(({ className, ...props }, ref) => (
14129 |  21 |   <thead ref={ref} className={cn('[&_tr]:border-b', className)} {...props} />
14130 |  22 | ))
14131 |  23 | TableHeader.displayName = 'TableHeader'
14132 |  24 | 
14133 |  25 | const TableBody = React.forwardRef<
14134 |  26 |   HTMLTableSectionElement,
14135 |  27 |   React.HTMLAttributes<HTMLTableSectionElement>
14136 |  28 | >(({ className, ...props }, ref) => (
14137 |  29 |   <tbody ref={ref} className={cn('[&_tr:last-child]:border-0', className)} {...props} />
14138 |  30 | ))
14139 |  31 | TableBody.displayName = 'TableBody'
14140 |  32 | 
14141 |  33 | const TableFooter = React.forwardRef<
14142 |  34 |   HTMLTableSectionElement,
14143 |  35 |   React.HTMLAttributes<HTMLTableSectionElement>
14144 |  36 | >(({ className, ...props }, ref) => (
14145 |  37 |   <tfoot
14146 |  38 |     ref={ref}
14147 |  39 |     className={cn('border-t bg-muted/50 font-medium [&>tr]:last:border-b-0', className)}
14148 |  40 |     {...props}
14149 |  41 |   />
14150 |  42 | ))
14151 |  43 | TableFooter.displayName = 'TableFooter'
14152 |  44 | 
14153 |  45 | const TableRow = React.forwardRef<HTMLTableRowElement, React.HTMLAttributes<HTMLTableRowElement>>(
14154 |  46 |   ({ className, ...props }, ref) => (
14155 |  47 |     <tr
14156 |  48 |       ref={ref}
14157 |  49 |       className={cn(
14158 |  50 |         'border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted',
14159 |  51 |         className
14160 |  52 |       )}
14161 |  53 |       {...props}
14162 |  54 |     />
14163 |  55 |   )
14164 |  56 | )
14165 |  57 | TableRow.displayName = 'TableRow'
14166 |  58 | 
14167 |  59 | const TableHead = React.forwardRef<
14168 |  60 |   HTMLTableCellElement,
14169 |  61 |   React.ThHTMLAttributes<HTMLTableCellElement>
14170 |  62 | >(({ className, ...props }, ref) => (
14171 |  63 |   <th
14172 |  64 |     ref={ref}
14173 |  65 |     className={cn(
14174 |  66 |       'h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0',
14175 |  67 |       className
14176 |  68 |     )}
14177 |  69 |     {...props}
14178 |  70 |   />
14179 |  71 | ))
14180 |  72 | TableHead.displayName = 'TableHead'
14181 |  73 | 
14182 |  74 | const TableCell = React.forwardRef<
14183 |  75 |   HTMLTableCellElement,
14184 |  76 |   React.TdHTMLAttributes<HTMLTableCellElement>
14185 |  77 | >(({ className, ...props }, ref) => (
14186 |  78 |   <td
14187 |  79 |     ref={ref}
14188 |  80 |     className={cn('p-4 align-middle [&:has([role=checkbox])]:pr-0', className)}
14189 |  81 |     {...props}
14190 |  82 |   />
14191 |  83 | ))
14192 |  84 | TableCell.displayName = 'TableCell'
14193 |  85 | 
14194 |  86 | const TableCaption = React.forwardRef<
14195 |  87 |   HTMLTableCaptionElement,
14196 |  88 |   React.HTMLAttributes<HTMLTableCaptionElement>
14197 |  89 | >(({ className, ...props }, ref) => (
14198 |  90 |   <caption ref={ref} className={cn('mt-4 text-sm text-muted-foreground', className)} {...props} />
14199 |  91 | ))
14200 |  92 | TableCaption.displayName = 'TableCaption'
14201 |  93 | 
14202 |  94 | export {
14203 |  95 |   Table,
14204 |  96 |   TableHeader,
14205 |  97 |   TableBody,
14206 |  98 |   TableFooter,
14207 |  99 |   TableHead,
14208 | 100 |   TableRow,
14209 | 101 |   TableCell,
14210 | 102 |   TableCaption,
14211 | 103 | }
14212 | 104 | 
14213 | ```
14214 | 
14215 | ---
14216 | 
14217 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/tabs.tsx`
14218 | **Typ:** TypeScript  
14219 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14220 | 
14221 | ```tsx
14222 |   1 | import * as React from 'react'
14223 |   2 | import { cn } from '@/lib/utils'
14224 |   3 | 
14225 |   4 | interface TabsContextValue {
14226 |   5 |   value: string
14227 |   6 |   onValueChange: (value: string) => void
14228 |   7 | }
14229 |   8 | 
14230 |   9 | const TabsContext = React.createContext<TabsContextValue | null>(null)
14231 |  10 | 
14232 |  11 | interface TabsProps extends React.HTMLAttributes<HTMLDivElement> {
14233 |  12 |   value?: string
14234 |  13 |   defaultValue?: string
14235 |  14 |   onValueChange?: (value: string) => void
14236 |  15 | }
14237 |  16 | 
14238 |  17 | const Tabs = React.forwardRef<HTMLDivElement, TabsProps>(
14239 |  18 |   ({ className, value, defaultValue, onValueChange, children, ...props }, ref) => {
14240 |  19 |     const [internalValue, setInternalValue] = React.useState(defaultValue || '')
14241 |  20 |     const currentValue = value !== undefined ? value : internalValue
14242 |  21 | 
14243 |  22 |     const handleValueChange = React.useCallback(
14244 |  23 |       (newValue: string) => {
14245 |  24 |         if (value === undefined) {
14246 |  25 |           setInternalValue(newValue)
14247 |  26 |         }
14248 |  27 |         onValueChange?.(newValue)
14249 |  28 |       },
14250 |  29 |       [value, onValueChange]
14251 |  30 |     )
14252 |  31 | 
14253 |  32 |     return (
14254 |  33 |       <TabsContext.Provider value={{ value: currentValue, onValueChange: handleValueChange }}>
14255 |  34 |         <div ref={ref} className={cn('', className)} {...props}>
14256 |  35 |           {children}
14257 |  36 |         </div>
14258 |  37 |       </TabsContext.Provider>
14259 |  38 |     )
14260 |  39 |   }
14261 |  40 | )
14262 |  41 | Tabs.displayName = 'Tabs'
14263 |  42 | 
14264 |  43 | const TabsList = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(
14265 |  44 |   ({ className, ...props }, ref) => (
14266 |  45 |     <div
14267 |  46 |       ref={ref}
14268 |  47 |       className={cn(
14269 |  48 |         'inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground',
14270 |  49 |         className
14271 |  50 |       )}
14272 |  51 |       {...props}
14273 |  52 |     />
14274 |  53 |   )
14275 |  54 | )
14276 |  55 | TabsList.displayName = 'TabsList'
14277 |  56 | 
14278 |  57 | interface TabsTriggerProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
14279 |  58 |   value: string
14280 |  59 | }
14281 |  60 | 
14282 |  61 | const TabsTrigger = React.forwardRef<HTMLButtonElement, TabsTriggerProps>(
14283 |  62 |   ({ className, value, ...props }, ref) => {
14284 |  63 |     const context = React.useContext(TabsContext)
14285 |  64 |     const isActive = context?.value === value
14286 |  65 | 
14287 |  66 |     return (
14288 |  67 |       <button
14289 |  68 |         ref={ref}
14290 |  69 |         className={cn(
14291 |  70 |           'inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
14292 |  71 |           isActive && 'bg-background text-foreground shadow-sm',
14293 |  72 |           className
14294 |  73 |         )}
14295 |  74 |         onClick={() => context?.onValueChange(value)}
14296 |  75 |         data-state={isActive ? 'active' : 'inactive'}
14297 |  76 |         {...props}
14298 |  77 |       />
14299 |  78 |     )
14300 |  79 |   }
14301 |  80 | )
14302 |  81 | TabsTrigger.displayName = 'TabsTrigger'
14303 |  82 | 
14304 |  83 | interface TabsContentProps extends React.HTMLAttributes<HTMLDivElement> {
14305 |  84 |   value: string
14306 |  85 | }
14307 |  86 | 
14308 |  87 | const TabsContent = React.forwardRef<HTMLDivElement, TabsContentProps>(
14309 |  88 |   ({ className, value, ...props }, ref) => {
14310 |  89 |     const context = React.useContext(TabsContext)
14311 |  90 |     const isActive = context?.value === value
14312 |  91 | 
14313 |  92 |     if (!isActive) return null
14314 |  93 | 
14315 |  94 |     return (
14316 |  95 |       <div
14317 |  96 |         ref={ref}
14318 |  97 |         className={cn(
14319 |  98 |           'mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2',
14320 |  99 |           className
14321 | 100 |         )}
14322 | 101 |         data-state={isActive ? 'active' : 'inactive'}
14323 | 102 |         {...props}
14324 | 103 |       />
14325 | 104 |     )
14326 | 105 |   }
14327 | 106 | )
14328 | 107 | TabsContent.displayName = 'TabsContent'
14329 | 108 | 
14330 | 109 | export { Tabs, TabsList, TabsTrigger, TabsContent }
14331 | 110 | 
14332 | ```
14333 | 
14334 | ---
14335 | 
14336 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/components/ui/textarea.tsx`
14337 | **Typ:** TypeScript  
14338 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14339 | 
14340 | ```tsx
14341 |  1 | import * as React from 'react'
14342 |  2 | import { cn } from '@/lib/utils'
14343 |  3 | 
14344 |  4 | export interface TextareaProps extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}
14345 |  5 | 
14346 |  6 | const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
14347 |  7 |   ({ className, ...props }, ref) => {
14348 |  8 |     return (
14349 |  9 |       <textarea
14350 | 10 |         className={cn(
14351 | 11 |           'flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
14352 | 12 |           className
14353 | 13 |         )}
14354 | 14 |         ref={ref}
14355 | 15 |         {...props}
14356 | 16 |       />
14357 | 17 |     )
14358 | 18 |   }
14359 | 19 | )
14360 | 20 | Textarea.displayName = 'Textarea'
14361 | 21 | 
14362 | 22 | export { Textarea }
14363 | 23 | 
14364 | ```
14365 | 
14366 | ---
14367 | 
14368 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useApi.ts`
14369 | **Typ:** TypeScript  
14370 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14371 | 
14372 | ```ts
14373 |  1 | import { useState, useCallback } from 'react'
14374 |  2 | 
14375 |  3 | interface UseApiOptions<T> {
14376 |  4 |   onSuccess?: (data: T) => void
14377 |  5 |   onError?: (error: string) => void
14378 |  6 | }
14379 |  7 | 
14380 |  8 | interface UseApiResult<T, Args extends unknown[]> {
14381 |  9 |   data: T | null
14382 | 10 |   loading: boolean
14383 | 11 |   error: string | null
14384 | 12 |   execute: (...args: Args) => Promise<T | null>
14385 | 13 |   reset: () => void
14386 | 14 | }
14387 | 15 | 
14388 | 16 | export function useApi<T, Args extends unknown[] = []>(
14389 | 17 |   apiFn: (...args: Args) => Promise<T & { ok: boolean; error?: string }>,
14390 | 18 |   options: UseApiOptions<T> = {}
14391 | 19 | ): UseApiResult<T, Args> {
14392 | 20 |   const [data, setData] = useState<T | null>(null)
14393 | 21 |   const [loading, setLoading] = useState(false)
14394 | 22 |   const [error, setError] = useState<string | null>(null)
14395 | 23 | 
14396 | 24 |   const execute = useCallback(
14397 | 25 |     async (...args: Args): Promise<T | null> => {
14398 | 26 |       setLoading(true)
14399 | 27 |       setError(null)
14400 | 28 | 
14401 | 29 |       try {
14402 | 30 |         const result = await apiFn(...args)
14403 | 31 |         if (result.ok) {
14404 | 32 |           setData(result)
14405 | 33 |           options.onSuccess?.(result)
14406 | 34 |           return result
14407 | 35 |         } else {
14408 | 36 |           const errorMsg = result.error || 'Unknown error'
14409 | 37 |           setError(errorMsg)
14410 | 38 |           options.onError?.(errorMsg)
14411 | 39 |           return null
14412 | 40 |         }
14413 | 41 |       } catch (err) {
14414 | 42 |         const errorMsg = err instanceof Error ? err.message : 'Network error'
14415 | 43 |         setError(errorMsg)
14416 | 44 |         options.onError?.(errorMsg)
14417 | 45 |         return null
14418 | 46 |       } finally {
14419 | 47 |         setLoading(false)
14420 | 48 |       }
14421 | 49 |     },
14422 | 50 |     [apiFn, options]
14423 | 51 |   )
14424 | 52 | 
14425 | 53 |   const reset = useCallback(() => {
14426 | 54 |     setData(null)
14427 | 55 |     setError(null)
14428 | 56 |     setLoading(false)
14429 | 57 |   }, [])
14430 | 58 | 
14431 | 59 |   return { data, loading, error, execute, reset }
14432 | 60 | }
14433 | 61 | 
14434 | ```
14435 | 
14436 | ---
14437 | 
14438 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useAuth.tsx`
14439 | **Typ:** TypeScript  
14440 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14441 | 
14442 | ```tsx
14443 |  1 | import { createContext, useContext, useState, useCallback, ReactNode } from 'react'
14444 |  2 | import { getToken, setToken as saveToken } from '@/lib/api'
14445 |  3 | 
14446 |  4 | interface AuthContextValue {
14447 |  5 |   token: string
14448 |  6 |   setToken: (token: string) => void
14449 |  7 |   isAuthenticated: boolean
14450 |  8 | }
14451 |  9 | 
14452 | 10 | const AuthContext = createContext<AuthContextValue | null>(null)
14453 | 11 | 
14454 | 12 | export function AuthProvider({ children }: { children: ReactNode }) {
14455 | 13 |   const [token, setTokenState] = useState(() => getToken())
14456 | 14 | 
14457 | 15 |   const setToken = useCallback((newToken: string) => {
14458 | 16 |     saveToken(newToken)
14459 | 17 |     setTokenState(newToken)
14460 | 18 |   }, [])
14461 | 19 | 
14462 | 20 |   const value: AuthContextValue = {
14463 | 21 |     token,
14464 | 22 |     setToken,
14465 | 23 |     isAuthenticated: token.length > 0,
14466 | 24 |   }
14467 | 25 | 
14468 | 26 |   return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>
14469 | 27 | }
14470 | 28 | 
14471 | 29 | export function useAuth() {
14472 | 30 |   const context = useContext(AuthContext)
14473 | 31 |   if (!context) {
14474 | 32 |     throw new Error('useAuth must be used within AuthProvider')
14475 | 33 |   }
14476 | 34 |   return context
14477 | 35 | }
14478 | 36 | 
14479 | ```
14480 | 
14481 | ---
14482 | 
14483 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/hooks/useLogs.ts`
14484 | **Typ:** TypeScript  
14485 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14486 | 
14487 | ```ts
14488 |  1 | import { useState, useCallback, useRef, useEffect } from 'react'
14489 |  2 | import { getLogsOut, getLogsErr } from '@/lib/api'
14490 |  3 | 
14491 |  4 | type LogMode = 'out' | 'err'
14492 |  5 | 
14493 |  6 | interface UseLogsResult {
14494 |  7 |   logs: string
14495 |  8 |   loading: boolean
14496 |  9 |   error: string | null
14497 | 10 |   mode: LogMode
14498 | 11 |   autoRefresh: number
14499 | 12 |   setAutoRefresh: (interval: number) => void
14500 | 13 |   loadLogs: (mode?: LogMode, lines?: number) => Promise<void>
14501 | 14 |   setMode: (mode: LogMode) => void
14502 | 15 | }
14503 | 16 | 
14504 | 17 | export function useLogs(initialLines = 200): UseLogsResult {
14505 | 18 |   const [logs, setLogs] = useState('')
14506 | 19 |   const [loading, setLoading] = useState(false)
14507 | 20 |   const [error, setError] = useState<string | null>(null)
14508 | 21 |   const [mode, setMode] = useState<LogMode>('out')
14509 | 22 |   const [autoRefresh, setAutoRefresh] = useState(0)
14510 | 23 |   const intervalRef = useRef<number | null>(null)
14511 | 24 | 
14512 | 25 |   const loadLogs = useCallback(
14513 | 26 |     async (logMode?: LogMode, lines = initialLines) => {
14514 | 27 |       const targetMode = logMode ?? mode
14515 | 28 |       setLoading(true)
14516 | 29 |       setError(null)
14517 | 30 | 
14518 | 31 |       try {
14519 | 32 |         const fn = targetMode === 'out' ? getLogsOut : getLogsErr
14520 | 33 |         const result = await fn(lines)
14521 | 34 | 
14522 | 35 |         if (result.ok && result.log) {
14523 | 36 |           // Strip ANSI codes
14524 | 37 |           const cleanLog = result.log.replace(/\x1b\[[0-9;]*m/g, '')
14525 | 38 |           setLogs(cleanLog)
14526 | 39 |         } else {
14527 | 40 |           setError(result.error || 'Nie udalo sie wczytac logow')
14528 | 41 |           setLogs('')
14529 | 42 |         }
14530 | 43 |       } catch (err) {
14531 | 44 |         setError(err instanceof Error ? err.message : 'Blad sieci')
14532 | 45 |         setLogs('')
14533 | 46 |       } finally {
14534 | 47 |         setLoading(false)
14535 | 48 |       }
14536 | 49 |     },
14537 | 50 |     [mode, initialLines]
14538 | 51 |   )
14539 | 52 | 
14540 | 53 |   // Handle auto-refresh
14541 | 54 |   useEffect(() => {
14542 | 55 |     if (intervalRef.current) {
14543 | 56 |       clearInterval(intervalRef.current)
14544 | 57 |       intervalRef.current = null
14545 | 58 |     }
14546 | 59 | 
14547 | 60 |     if (autoRefresh > 0) {
14548 | 61 |       intervalRef.current = window.setInterval(() => {
14549 | 62 |         loadLogs()
14550 | 63 |       }, autoRefresh)
14551 | 64 |     }
14552 | 65 | 
14553 | 66 |     return () => {
14554 | 67 |       if (intervalRef.current) {
14555 | 68 |         clearInterval(intervalRef.current)
14556 | 69 |       }
14557 | 70 |     }
14558 | 71 |   }, [autoRefresh, loadLogs])
14559 | 72 | 
14560 | 73 |   const handleModeChange = useCallback(
14561 | 74 |     (newMode: LogMode) => {
14562 | 75 |       setMode(newMode)
14563 | 76 |       loadLogs(newMode)
14564 | 77 |     },
14565 | 78 |     [loadLogs]
14566 | 79 |   )
14567 | 80 | 
14568 | 81 |   return {
14569 | 82 |     logs,
14570 | 83 |     loading,
14571 | 84 |     error,
14572 | 85 |     mode,
14573 | 86 |     autoRefresh,
14574 | 87 |     setAutoRefresh,
14575 | 88 |     loadLogs,
14576 | 89 |     setMode: handleModeChange,
14577 | 90 |   }
14578 | 91 | }
14579 | 92 | 
14580 | ```
14581 | 
14582 | ---
14583 | 
14584 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/index.css`
14585 | **Typ:** CSS  
14586 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14587 | 
14588 | ```css
14589 |  1 | @tailwind base;
14590 |  2 | @tailwind components;
14591 |  3 | @tailwind utilities;
14592 |  4 | 
14593 |  5 | @layer base {
14594 |  6 |   :root {
14595 |  7 |     --background: 0 0% 100%;
14596 |  8 |     --foreground: 222.2 84% 4.9%;
14597 |  9 |     --card: 0 0% 100%;
14598 | 10 |     --card-foreground: 222.2 84% 4.9%;
14599 | 11 |     --popover: 0 0% 100%;
14600 | 12 |     --popover-foreground: 222.2 84% 4.9%;
14601 | 13 |     --primary: 222.2 47.4% 11.2%;
14602 | 14 |     --primary-foreground: 210 40% 98%;
14603 | 15 |     --secondary: 210 40% 96.1%;
14604 | 16 |     --secondary-foreground: 222.2 47.4% 11.2%;
14605 | 17 |     --muted: 210 40% 96.1%;
14606 | 18 |     --muted-foreground: 215.4 16.3% 46.9%;
14607 | 19 |     --accent: 210 40% 96.1%;
14608 | 20 |     --accent-foreground: 222.2 47.4% 11.2%;
14609 | 21 |     --destructive: 0 84.2% 60.2%;
14610 | 22 |     --destructive-foreground: 210 40% 98%;
14611 | 23 |     --border: 214.3 31.8% 91.4%;
14612 | 24 |     --input: 214.3 31.8% 91.4%;
14613 | 25 |     --ring: 222.2 84% 4.9%;
14614 | 26 |     --radius: 0.5rem;
14615 | 27 |   }
14616 | 28 | 
14617 | 29 |   .dark {
14618 | 30 |     --background: 222.2 84% 4.9%;
14619 | 31 |     --foreground: 210 40% 98%;
14620 | 32 |     --card: 222.2 84% 4.9%;
14621 | 33 |     --card-foreground: 210 40% 98%;
14622 | 34 |     --popover: 222.2 84% 4.9%;
14623 | 35 |     --popover-foreground: 210 40% 98%;
14624 | 36 |     --primary: 210 40% 98%;
14625 | 37 |     --primary-foreground: 222.2 47.4% 11.2%;
14626 | 38 |     --secondary: 217.2 32.6% 17.5%;
14627 | 39 |     --secondary-foreground: 210 40% 98%;
14628 | 40 |     --muted: 217.2 32.6% 17.5%;
14629 | 41 |     --muted-foreground: 215 20.2% 65.1%;
14630 | 42 |     --accent: 217.2 32.6% 17.5%;
14631 | 43 |     --accent-foreground: 210 40% 98%;
14632 | 44 |     --destructive: 0 62.8% 30.6%;
14633 | 45 |     --destructive-foreground: 210 40% 98%;
14634 | 46 |     --border: 217.2 32.6% 17.5%;
14635 | 47 |     --input: 217.2 32.6% 17.5%;
14636 | 48 |     --ring: 212.7 26.8% 83.9%;
14637 | 49 |   }
14638 | 50 | }
14639 | 51 | 
14640 | 52 | @layer base {
14641 | 53 |   * {
14642 | 54 |     @apply border-border;
14643 | 55 |   }
14644 | 56 |   body {
14645 | 57 |     @apply bg-background text-foreground;
14646 | 58 |   }
14647 | 59 | }
14648 | 60 | 
14649 | ```
14650 | 
14651 | ---
14652 | 
14653 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/api.ts`
14654 | **Typ:** TypeScript  
14655 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14656 | 
14657 | ```ts
14658 |   1 | import type {
14659 |   2 |   SystemStatus,
14660 |   3 |   PostsResponse,
14661 |   4 |   EnvResponse,
14662 |   5 |   LogsResponse,
14663 |   6 |   Post,
14664 |   7 |   SessionStatus,
14665 |   8 | } from './types'
14666 |   9 | 
14667 |  10 | const TOKEN_KEY = 'FBW_PANEL_TOKEN'
14668 |  11 | 
14669 |  12 | export function getToken(): string {
14670 |  13 |   return localStorage.getItem(TOKEN_KEY) || ''
14671 |  14 | }
14672 |  15 | 
14673 |  16 | export function setToken(token: string): void {
14674 |  17 |   localStorage.setItem(TOKEN_KEY, token)
14675 |  18 | }
14676 |  19 | 
14677 |  20 | function getAuthHeaders(): HeadersInit {
14678 |  21 |   const token = getToken()
14679 |  22 |   return token ? { Authorization: `Bearer ${token}` } : {}
14680 |  23 | }
14681 |  24 | 
14682 |  25 | async function request<T>(
14683 |  26 |   path: string,
14684 |  27 |   options: RequestInit = {}
14685 |  28 | ): Promise<T & { ok: boolean; error?: string }> {
14686 |  29 |   const headers: Record<string, string> = {
14687 |  30 |     ...(getAuthHeaders() as Record<string, string>),
14688 |  31 |     ...((options.headers || {}) as Record<string, string>),
14689 |  32 |   }
14690 |  33 | 
14691 |  34 |   if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
14692 |  35 |     headers['Content-Type'] = 'application/json'
14693 |  36 |     options.body = JSON.stringify(options.body)
14694 |  37 |   }
14695 |  38 | 
14696 |  39 |   try {
14697 |  40 |     const res = await fetch(path, {
14698 |  41 |       ...options,
14699 |  42 |       headers,
14700 |  43 |     })
14701 |  44 | 
14702 |  45 |     const text = await res.text()
14703 |  46 |     let data: T & { ok: boolean; error?: string }
14704 |  47 | 
14705 |  48 |     try {
14706 |  49 |       data = JSON.parse(text)
14707 |  50 |     } catch {
14708 |  51 |       data = { ok: false, error: text || `HTTP ${res.status}` } as T & { ok: boolean; error?: string }
14709 |  52 |     }
14710 |  53 | 
14711 |  54 |     if (!res.ok && data.ok !== false) {
14712 |  55 |       data.ok = false
14713 |  56 |       data.error = data.error || `HTTP ${res.status}`
14714 |  57 |     }
14715 |  58 | 
14716 |  59 |     return data
14717 |  60 |   } catch (err) {
14718 |  61 |     return { ok: false, error: err instanceof Error ? err.message : 'Network error' } as T & { ok: boolean; error?: string }
14719 |  62 |   }
14720 |  63 | }
14721 |  64 | 
14722 |  65 | // Status
14723 |  66 | export async function getStatus(): Promise<SystemStatus & { ok: boolean; error?: string }> {
14724 |  67 |   return request<SystemStatus>('/api/status')
14725 |  68 | }
14726 |  69 | 
14727 |  70 | // Env
14728 |  71 | export async function getEnv(): Promise<EnvResponse> {
14729 |  72 |   return request<EnvResponse>('/api/env/get')
14730 |  73 | }
14731 |  74 | 
14732 |  75 | export async function setEnv(set: Record<string, string>, restart = false): Promise<{ ok: boolean; error?: string }> {
14733 |  76 |   return request('/api/env/set', {
14734 |  77 |     method: 'POST',
14735 |  78 |     body: JSON.stringify({ set, restart }),
14736 |  79 |   })
14737 |  80 | }
14738 |  81 | 
14739 |  82 | // Posts
14740 |  83 | export async function getPosts(): Promise<PostsResponse> {
14741 |  84 |   return request<PostsResponse>('/api/posts')
14742 |  85 | }
14743 |  86 | 
14744 |  87 | export async function addPost(post: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
14745 |  88 |   return request('/api/posts', {
14746 |  89 |     method: 'POST',
14747 |  90 |     body: JSON.stringify(post),
14748 |  91 |   })
14749 |  92 | }
14750 |  93 | 
14751 |  94 | export async function updatePost(id: string, data: Partial<Post>): Promise<{ ok: boolean; post?: Post; error?: string }> {
14752 |  95 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
14753 |  96 |     method: 'PATCH',
14754 |  97 |     body: JSON.stringify(data),
14755 |  98 |   })
14756 |  99 | }
14757 | 100 | 
14758 | 101 | export async function deletePost(id: string): Promise<{ ok: boolean; error?: string }> {
14759 | 102 |   return request(`/api/posts/${encodeURIComponent(id)}`, {
14760 | 103 |     method: 'DELETE',
14761 | 104 |   })
14762 | 105 | }
14763 | 106 | 
14764 | 107 | // PM2
14765 | 108 | export async function pm2Start(): Promise<{ ok: boolean; output?: string; error?: string }> {
14766 | 109 |   return request('/api/pm2/start', { method: 'POST' })
14767 | 110 | }
14768 | 111 | 
14769 | 112 | export async function pm2Stop(): Promise<{ ok: boolean; output?: string; error?: string }> {
14770 | 113 |   return request('/api/pm2/stop', { method: 'POST' })
14771 | 114 | }
14772 | 115 | 
14773 | 116 | export async function pm2Restart(): Promise<{ ok: boolean; output?: string; error?: string }> {
14774 | 117 |   return request('/api/pm2/restart', { method: 'POST' })
14775 | 118 | }
14776 | 119 | 
14777 | 120 | export async function pm2Status(): Promise<{ ok: boolean; output?: string; error?: string }> {
14778 | 121 |   return request('/api/pm2/status')
14779 | 122 | }
14780 | 123 | 
14781 | 124 | // Logs
14782 | 125 | export async function getLogsOut(lines = 200): Promise<LogsResponse> {
14783 | 126 |   return request<LogsResponse>(`/api/logs/out?lines=${lines}`)
14784 | 127 | }
14785 | 128 | 
14786 | 129 | export async function getLogsErr(lines = 200): Promise<LogsResponse> {
14787 | 130 |   return request<LogsResponse>(`/api/logs/err?lines=${lines}`)
14788 | 131 | }
14789 | 132 | 
14790 | 133 | // Cookies
14791 | 134 | export async function clearCookies(): Promise<{ ok: boolean; error?: string }> {
14792 | 135 |   return request('/api/cookies/clear', {
14793 | 136 |     method: 'POST',
14794 | 137 |     body: JSON.stringify({ confirm: true }),
14795 | 138 |   })
14796 | 139 | }
14797 | 140 | 
14798 | 141 | export async function getCookiesStatus(): Promise<SessionStatus & { ok: boolean; error?: string }> {
14799 | 142 |   return request<SessionStatus>('/api/cookies/status')
14800 | 143 | }
14801 | 144 | 
14802 | 145 | 
14803 | ```
14804 | 
14805 | ---
14806 | 
14807 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/types.ts`
14808 | **Typ:** TypeScript  
14809 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14810 | 
14811 | ```ts
14812 |   1 | // Post monitorowany
14813 |   2 | export interface Post {
14814 |   3 |   id: string
14815 |   4 |   url: string
14816 |   5 |   active: boolean
14817 |   6 |   name: string
14818 |   7 |   image: string
14819 |   8 |   description: string
14820 |   9 |   createdAt: string
14821 |  10 |   updatedAt: string
14822 |  11 | }
14823 |  12 | 
14824 |  13 | // Status systemu
14825 |  14 | export interface SystemStatus {
14826 |  15 |   ok: boolean
14827 |  16 |   projectDir: string
14828 |  17 |   envPath: string
14829 |  18 |   cookiesPath: string
14830 |  19 |   postsPath: string
14831 |  20 |   node: string
14832 |  21 |   pm2: string
14833 |  22 |   pm2Status: string
14834 |  23 |   time: string
14835 |  24 | }
14836 |  25 | 
14837 |  26 | // Ustawienia .env
14838 |  27 | export interface EnvValues {
14839 |  28 |   // Facebook
14840 |  29 |   FB_EMAIL: string
14841 |  30 |   FB_PASSWORD: string
14842 |  31 |   // Watcher
14843 |  32 |   CHECK_INTERVAL_MS: string
14844 |  33 |   FAST_MODE: string
14845 |  34 |   INCLUDE_REPLIES: string
14846 |  35 |   // Logi
14847 |  36 |   LOG_LEVEL: string
14848 |  37 |   // Puppeteer
14849 |  38 |   HEADLESS_BROWSER: string
14850 |  39 |   USE_UI_HANDLERS: string
14851 |  40 |   COOKIES_READ_ONLY: string
14852 |  41 |   // ≈πr√≥d≈Ça post√≥w
14853 |  42 |   POSTS_SHEET_URL: string
14854 |  43 |   POSTS_API_URL: string
14855 |  44 |   POSTS_API_TOKEN: string
14856 |  45 |   // Telegram Owner
14857 |  46 |   TELEGRAM_SEND_TO_OWNER: string
14858 |  47 |   TELEGRAM_BOT_TOKEN_OWNER: string
14859 |  48 |   TELEGRAM_CHAT_ID_OWNER: string
14860 |  49 |   // Telegram Client
14861 |  50 |   TELEGRAM_SEND_TO_CLIENT: string
14862 |  51 |   TELEGRAM_BOT_TOKEN_CLIENT: string
14863 |  52 |   TELEGRAM_CHAT_ID_CLIENT: string
14864 |  53 |   // Telegram Format
14865 |  54 |   TELEGRAM_USE_PHOTO: string
14866 |  55 |   TELEGRAM_DISABLE_WEB_PAGE_PREVIEW: string
14867 |  56 |   // Telegram Alerty
14868 |  57 |   TG_ALERTS_ENABLED: string
14869 |  58 |   TG_ALERTS_COOLDOWN_SEC: string
14870 |  59 |   TG_ALERTS_MAXLEN: string
14871 |  60 |   // Legacy
14872 |  61 |   WEBHOOK_URL: string
14873 |  62 | }
14874 |  63 | 
14875 |  64 | // Status sesji cookies
14876 |  65 | export interface SessionStatus {
14877 |  66 |   mainCookiesExists: boolean
14878 |  67 |   mainCookiesAge?: number
14879 |  68 |   mainCookiesSize?: number
14880 |  69 |   isLoggedIn?: boolean
14881 |  70 | }
14882 |  71 | 
14883 |  72 | // ≈πr√≥d≈Ço monitorowania (przysz≈Ço≈õƒá)
14884 |  73 | export interface Source {
14885 |  74 |   id: string
14886 |  75 |   type: 'home_feed' | 'group' | 'meta_ads'
14887 |  76 |   name: string
14888 |  77 |   keywords: string[]
14889 |  78 |   active: boolean
14890 |  79 |   groupUrl?: string
14891 |  80 | }
14892 |  81 | 
14893 |  82 | // Wykrycie do zatwierdzenia (przysz≈Ço≈õƒá)
14894 |  83 | export interface Discovery {
14895 |  84 |   id: string
14896 |  85 |   sourceId: string
14897 |  86 |   postUrl: string
14898 |  87 |   content: string
14899 |  88 |   status: 'pending' | 'approved' | 'rejected'
14900 |  89 |   matchedKeywords: string[]
14901 |  90 |   discoveredAt: string
14902 |  91 | }
14903 |  92 | 
14904 |  93 | // API Response types
14905 |  94 | export interface ApiResponse<T = unknown> {
14906 |  95 |   ok: boolean
14907 |  96 |   error?: string
14908 |  97 |   data?: T
14909 |  98 | }
14910 |  99 | 
14911 | 100 | export interface PostsResponse {
14912 | 101 |   ok: boolean
14913 | 102 |   posts: Post[]
14914 | 103 |   error?: string
14915 | 104 | }
14916 | 105 | 
14917 | 106 | export interface EnvResponse {
14918 | 107 |   ok: boolean
14919 | 108 |   values: EnvValues
14920 | 109 |   error?: string
14921 | 110 | }
14922 | 111 | 
14923 | 112 | export interface LogsResponse {
14924 | 113 |   ok: boolean
14925 | 114 |   log?: string
14926 | 115 |   path?: string
14927 | 116 |   error?: string
14928 | 117 |   source?: string
14929 | 118 | }
14930 | 119 | 
14931 | ```
14932 | 
14933 | ---
14934 | 
14935 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/lib/utils.ts`
14936 | **Typ:** TypeScript  
14937 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14938 | 
14939 | ```ts
14940 | 1 | import { type ClassValue, clsx } from 'clsx'
14941 | 2 | import { twMerge } from 'tailwind-merge'
14942 | 3 | 
14943 | 4 | export function cn(...inputs: ClassValue[]) {
14944 | 5 |   return twMerge(clsx(inputs))
14945 | 6 | }
14946 | 7 | 
14947 | ```
14948 | 
14949 | ---
14950 | 
14951 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/main.tsx`
14952 | **Typ:** TypeScript  
14953 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14954 | 
14955 | ```tsx
14956 |  1 | import { StrictMode } from 'react'
14957 |  2 | import { createRoot } from 'react-dom/client'
14958 |  3 | import './index.css'
14959 |  4 | import App from './App'
14960 |  5 | 
14961 |  6 | createRoot(document.getElementById('root')!).render(
14962 |  7 |   <StrictMode>
14963 |  8 |     <App />
14964 |  9 |   </StrictMode>,
14965 | 10 | )
14966 | 11 | 
14967 | ```
14968 | 
14969 | ---
14970 | 
14971 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Campaigns.tsx`
14972 | **Typ:** TypeScript  
14973 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
14974 | 
14975 | ```tsx
14976 |  1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
14977 |  2 | import { Megaphone, Clock } from 'lucide-react'
14978 |  3 | 
14979 |  4 | export function Campaigns() {
14980 |  5 |   return (
14981 |  6 |     <div className="flex flex-col gap-4">
14982 |  7 |       <Card>
14983 |  8 |         <CardHeader>
14984 |  9 |           <div className="flex items-center gap-3">
14985 | 10 |             <div className="p-2 bg-muted rounded-lg">
14986 | 11 |               <Megaphone className="h-6 w-6" />
14987 | 12 |             </div>
14988 | 13 |             <div>
14989 | 14 |               <CardTitle>Kampanie</CardTitle>
14990 | 15 |               <CardDescription>Automatyzacja odpowiedzi na komentarze</CardDescription>
14991 | 16 |             </div>
14992 | 17 |           </div>
14993 | 18 |         </CardHeader>
14994 | 19 |         <CardContent>
14995 | 20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
14996 | 21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
14997 | 22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
14998 | 23 |             <p className="text-muted-foreground max-w-md">
14999 | 24 |               Ta funkcja pozwoli na automatyczne odpowiadanie na wykryte komentarze
15000 | 25 |               wedlug zdefiniowanych regul i szablonow.
15001 | 26 |             </p>
15002 | 27 |           </div>
15003 | 28 |         </CardContent>
15004 | 29 |       </Card>
15005 | 30 | 
15006 | 31 |       <Card>
15007 | 32 |         <CardHeader>
15008 | 33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
15009 | 34 |         </CardHeader>
15010 | 35 |         <CardContent>
15011 | 36 |           <ul className="space-y-2 text-sm text-muted-foreground">
15012 | 37 |             <li>‚Ä¢ Tworzenie kampanii z szablonami odpowiedzi</li>
15013 | 38 |             <li>‚Ä¢ Reguly triggerowan (slowa kluczowe, czas)</li>
15014 | 39 |             <li>‚Ä¢ Harmonogram wysylki</li>
15015 | 40 |             <li>‚Ä¢ A/B testy odpowiedzi</li>
15016 | 41 |             <li>‚Ä¢ Statystyki skutecznosci</li>
15017 | 42 |           </ul>
15018 | 43 |         </CardContent>
15019 | 44 |       </Card>
15020 | 45 |     </div>
15021 | 46 |   )
15022 | 47 | }
15023 | 48 | 
15024 | ```
15025 | 
15026 | ---
15027 | 
15028 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Cookies.tsx`
15029 | **Typ:** TypeScript  
15030 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
15031 | 
15032 | ```tsx
15033 |   1 | import { useEffect, useState, useCallback } from 'react'
15034 |   2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
15035 |   3 | import { Button } from '@/components/ui/button'
15036 |   4 | import {
15037 |   5 |   Dialog,
15038 |   6 |   DialogContent,
15039 |   7 |   DialogDescription,
15040 |   8 |   DialogFooter,
15041 |   9 |   DialogHeader,
15042 |  10 |   DialogTitle,
15043 |  11 | } from '@/components/ui/dialog'
15044 |  12 | import {
15045 |  13 |   Cookie,
15046 |  14 |   RefreshCw,
15047 |  15 |   Trash2,
15048 |  16 |   CheckCircle,
15049 |  17 |   XCircle,
15050 |  18 |   AlertTriangle,
15051 |  19 |   HardDrive,
15052 |  20 | } from 'lucide-react'
15053 |  21 | import { getCookiesStatus, clearCookies } from '@/lib/api'
15054 |  22 | import type { SessionStatus } from '@/lib/types'
15055 |  23 | 
15056 |  24 | function formatAge(hours: number): string {
15057 |  25 |   if (hours < 1) return 'teraz'
15058 |  26 |   if (hours < 24) return `${Math.round(hours)}h temu`
15059 |  27 |   const days = Math.floor(hours / 24)
15060 |  28 |   return `${days}d temu`
15061 |  29 | }
15062 |  30 | 
15063 |  31 | function formatSize(bytes: number): string {
15064 |  32 |   if (bytes < 1024) return `${bytes} B`
15065 |  33 |   return `${(bytes / 1024).toFixed(1)} KB`
15066 |  34 | }
15067 |  35 | 
15068 |  36 | export function Cookies() {
15069 |  37 |   const [status, setStatus] = useState<SessionStatus | null>(null)
15070 |  38 |   const [loading, setLoading] = useState(false)
15071 |  39 |   const [error, setError] = useState<string | null>(null)
15072 |  40 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
15073 |  41 | 
15074 |  42 |   // Dialog states
15075 |  43 |   const [clearDialogOpen, setClearDialogOpen] = useState(false)
15076 |  44 |   const [actionLoading, setActionLoading] = useState(false)
15077 |  45 | 
15078 |  46 |   const showMessage = (text: string, type: 'success' | 'error') => {
15079 |  47 |     setMessage({ text, type })
15080 |  48 |     setTimeout(() => setMessage(null), 4000)
15081 |  49 |   }
15082 |  50 | 
15083 |  51 |   const loadStatus = useCallback(async () => {
15084 |  52 |     setLoading(true)
15085 |  53 |     setError(null)
15086 |  54 |     try {
15087 |  55 |       const result = await getCookiesStatus()
15088 |  56 |       if (result.ok) {
15089 |  57 |         setStatus(result)
15090 |  58 |       } else {
15091 |  59 |         setError(result.error || 'Nie udalo sie pobrac statusu cookies')
15092 |  60 |       }
15093 |  61 |     } catch {
15094 |  62 |       setError('Blad polaczenia')
15095 |  63 |     } finally {
15096 |  64 |       setLoading(false)
15097 |  65 |     }
15098 |  66 |   }, [])
15099 |  67 | 
15100 |  68 |   useEffect(() => {
15101 |  69 |     loadStatus()
15102 |  70 |   }, [loadStatus])
15103 |  71 | 
15104 |  72 |   const handleClear = async () => {
15105 |  73 |     setActionLoading(true)
15106 |  74 |     try {
15107 |  75 |       const result = await clearCookies()
15108 |  76 |       if (result.ok) {
15109 |  77 |         showMessage('Cookies wyczyszczone', 'success')
15110 |  78 |         setClearDialogOpen(false)
15111 |  79 |         loadStatus()
15112 |  80 |       } else {
15113 |  81 |         showMessage(result.error || 'Nie udalo sie wyczyscic cookies', 'error')
15114 |  82 |       }
15115 |  83 |     } catch {
15116 |  84 |       showMessage('Blad polaczenia', 'error')
15117 |  85 |     } finally {
15118 |  86 |       setActionLoading(false)
15119 |  87 |     }
15120 |  88 |   }
15121 |  89 | 
15122 |  90 |   return (
15123 |  91 |     <div className="flex flex-col gap-4">
15124 |  92 |       {message && (
15125 |  93 |         <div
15126 |  94 |           className={`p-3 rounded-md text-sm ${
15127 |  95 |             message.type === 'success'
15128 |  96 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
15129 |  97 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
15130 |  98 |           }`}
15131 |  99 |         >
15132 | 100 |           {message.text}
15133 | 101 |         </div>
15134 | 102 |       )}
15135 | 103 | 
15136 | 104 |       {error && (
15137 | 105 |         <Card className="border-destructive">
15138 | 106 |           <CardContent className="pt-6">
15139 | 107 |             <p className="text-destructive">{error}</p>
15140 | 108 |           </CardContent>
15141 | 109 |         </Card>
15142 | 110 |       )}
15143 | 111 | 
15144 | 112 |       {/* Status */}
15145 | 113 |       <Card>
15146 | 114 |         <CardHeader className="flex flex-row items-center justify-between">
15147 | 115 |           <div>
15148 | 116 |             <CardTitle>Status sesji</CardTitle>
15149 | 117 |             <CardDescription>Informacje o aktualnych cookies</CardDescription>
15150 | 118 |           </div>
15151 | 119 |           <Button variant="outline" size="sm" onClick={loadStatus} disabled={loading}>
15152 | 120 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
15153 | 121 |             Odswiez
15154 | 122 |           </Button>
15155 | 123 |         </CardHeader>
15156 | 124 |         <CardContent>
15157 | 125 |           {status && (
15158 | 126 |             <div className="space-y-4">
15159 | 127 |               <div className="flex items-center gap-3">
15160 | 128 |                 <div className="flex items-center gap-2">
15161 | 129 |                   {status.isLoggedIn ? (
15162 | 130 |                     <>
15163 | 131 |                       <CheckCircle className="h-5 w-5 text-green-500" />
15164 | 132 |                       <span className="font-medium">Zalogowany</span>
15165 | 133 |                     </>
15166 | 134 |                   ) : status.mainCookiesExists ? (
15167 | 135 |                     <>
15168 | 136 |                       <AlertTriangle className="h-5 w-5 text-yellow-500" />
15169 | 137 |                       <span className="font-medium">Cookies istnieja (status nieznany)</span>
15170 | 138 |                     </>
15171 | 139 |                   ) : (
15172 | 140 |                     <>
15173 | 141 |                       <XCircle className="h-5 w-5 text-red-500" />
15174 | 142 |                       <span className="font-medium">Brak cookies</span>
15175 | 143 |                     </>
15176 | 144 |                   )}
15177 | 145 |                 </div>
15178 | 146 |               </div>
15179 | 147 | 
15180 | 148 |               <div className="text-sm text-muted-foreground">
15181 | 149 |                 {status.mainCookiesAge !== undefined && (
15182 | 150 |                   <p>Wiek: {formatAge(status.mainCookiesAge)}</p>
15183 | 151 |                 )}
15184 | 152 |                 {status.mainCookiesSize !== undefined && (
15185 | 153 |                   <p>Rozmiar: {formatSize(status.mainCookiesSize)}</p>
15186 | 154 |                 )}
15187 | 155 |               </div>
15188 | 156 |             </div>
15189 | 157 |           )}
15190 | 158 |         </CardContent>
15191 | 159 |       </Card>
15192 | 160 | 
15193 | 161 |       {/* Main cookies */}
15194 | 162 |       <Card>
15195 | 163 |         <CardHeader>
15196 | 164 |           <CardTitle className="text-lg flex items-center gap-2">
15197 | 165 |             <Cookie className="h-5 w-5" />
15198 | 166 |             Plik cookies
15199 | 167 |           </CardTitle>
15200 | 168 |         </CardHeader>
15201 | 169 |         <CardContent>
15202 | 170 |           <div className="flex items-center justify-between p-4 bg-muted rounded-lg">
15203 | 171 |             <div className="flex items-center gap-3">
15204 | 172 |               <HardDrive className="h-5 w-5 text-muted-foreground" />
15205 | 173 |               <div>
15206 | 174 |                 <p className="font-mono text-sm">cookies.json</p>
15207 | 175 |                 {status && (
15208 | 176 |                   <p className="text-xs text-muted-foreground">
15209 | 177 |                     {status.mainCookiesExists
15210 | 178 |                       ? `${status.mainCookiesSize ? formatSize(status.mainCookiesSize) : ''} ${status.mainCookiesAge !== undefined ? '‚Ä¢ ' + formatAge(status.mainCookiesAge) : ''}`
15211 | 179 |                       : 'Plik nie istnieje'}
15212 | 180 |                   </p>
15213 | 181 |                 )}
15214 | 182 |               </div>
15215 | 183 |             </div>
15216 | 184 |             <Button
15217 | 185 |               variant="outline"
15218 | 186 |               size="sm"
15219 | 187 |               onClick={() => setClearDialogOpen(true)}
15220 | 188 |               disabled={actionLoading || !status?.mainCookiesExists}
15221 | 189 |               className="text-destructive hover:text-destructive"
15222 | 190 |             >
15223 | 191 |               <Trash2 className="h-4 w-4 mr-1" />
15224 | 192 |               Wyczysc
15225 | 193 |             </Button>
15226 | 194 |           </div>
15227 | 195 |         </CardContent>
15228 | 196 |       </Card>
15229 | 197 | 
15230 | 198 |       {/* Clear dialog */}
15231 | 199 |       <Dialog open={clearDialogOpen} onOpenChange={setClearDialogOpen}>
15232 | 200 |         <DialogContent>
15233 | 201 |           <DialogHeader>
15234 | 202 |             <DialogTitle>Wyczyscic cookies?</DialogTitle>
15235 | 203 |             <DialogDescription>
15236 | 204 |               To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu watchera.
15237 | 205 |             </DialogDescription>
15238 | 206 |           </DialogHeader>
15239 | 207 |           <DialogFooter>
15240 | 208 |             <Button variant="outline" onClick={() => setClearDialogOpen(false)}>
15241 | 209 |               Anuluj
15242 | 210 |             </Button>
15243 | 211 |             <Button variant="destructive" onClick={handleClear} disabled={actionLoading}>
15244 | 212 |               {actionLoading ? 'Czyszczenie...' : 'Wyczysc'}
15245 | 213 |             </Button>
15246 | 214 |           </DialogFooter>
15247 | 215 |         </DialogContent>
15248 | 216 |       </Dialog>
15249 | 217 |     </div>
15250 | 218 |   )
15251 | 219 | }
15252 | 220 | 
15253 | ```
15254 | 
15255 | ---
15256 | 
15257 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Dashboard.tsx`
15258 | **Typ:** TypeScript  
15259 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
15260 | 
15261 | ```tsx
15262 |   1 | import { useEffect, useState } from 'react'
15263 |   2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
15264 |   3 | import { Badge } from '@/components/ui/badge'
15265 |   4 | import { Button } from '@/components/ui/button'
15266 |   5 | import { Input } from '@/components/ui/input'
15267 |   6 | import { Label } from '@/components/ui/label'
15268 |   7 | import { RefreshCw, Server, FolderOpen, FileText, Cookie } from 'lucide-react'
15269 |   8 | import { getStatus } from '@/lib/api'
15270 |   9 | import { useAuth } from '@/hooks/useAuth'
15271 |  10 | import type { SystemStatus } from '@/lib/types'
15272 |  11 | 
15273 |  12 | function TokenForm() {
15274 |  13 |   const { token, setToken } = useAuth()
15275 |  14 |   const [inputValue, setInputValue] = useState(token)
15276 |  15 | 
15277 |  16 |   const handleSave = () => {
15278 |  17 |     setToken(inputValue.trim())
15279 |  18 |     window.location.reload()
15280 |  19 |   }
15281 |  20 | 
15282 |  21 |   return (
15283 |  22 |     <Card>
15284 |  23 |       <CardHeader>
15285 |  24 |         <CardTitle>Autoryzacja</CardTitle>
15286 |  25 |         <CardDescription>
15287 |  26 |           Wprowadz token PANEL_TOKEN aby uzyskac dostep do API
15288 |  27 |         </CardDescription>
15289 |  28 |       </CardHeader>
15290 |  29 |       <CardContent>
15291 |  30 |         <div className="flex gap-2">
15292 |  31 |           <div className="flex-1">
15293 |  32 |             <Label htmlFor="token" className="sr-only">
15294 |  33 |               Token
15295 |  34 |             </Label>
15296 |  35 |             <Input
15297 |  36 |               id="token"
15298 |  37 |               type="password"
15299 |  38 |               placeholder="Wprowadz PANEL_TOKEN..."
15300 |  39 |               value={inputValue}
15301 |  40 |               onChange={(e) => setInputValue(e.target.value)}
15302 |  41 |               onKeyDown={(e) => e.key === 'Enter' && handleSave()}
15303 |  42 |             />
15304 |  43 |           </div>
15305 |  44 |           <Button onClick={handleSave}>Zapisz</Button>
15306 |  45 |         </div>
15307 |  46 |       </CardContent>
15308 |  47 |     </Card>
15309 |  48 |   )
15310 |  49 | }
15311 |  50 | 
15312 |  51 | function parsePm2Status(statusText: string): { status: string; uptime?: string } {
15313 |  52 |   // Parse PM2 status table
15314 |  53 |   const lines = statusText.split('\n')
15315 |  54 |   for (const line of lines) {
15316 |  55 |     if (line.includes('fbwatcher') || line.includes('fb-watcher')) {
15317 |  56 |       if (line.includes('online')) {
15318 |  57 |         const uptimeMatch = line.match(/(\d+[smhd])/i)
15319 |  58 |         return { status: 'online', uptime: uptimeMatch?.[1] }
15320 |  59 |       }
15321 |  60 |       if (line.includes('stopped')) {
15322 |  61 |         return { status: 'stopped' }
15323 |  62 |       }
15324 |  63 |       if (line.includes('errored')) {
15325 |  64 |         return { status: 'errored' }
15326 |  65 |       }
15327 |  66 |     }
15328 |  67 |   }
15329 |  68 |   return { status: 'unknown' }
15330 |  69 | }
15331 |  70 | 
15332 |  71 | export function Dashboard() {
15333 |  72 |   const { isAuthenticated } = useAuth()
15334 |  73 |   const [status, setStatus] = useState<SystemStatus | null>(null)
15335 |  74 |   const [loading, setLoading] = useState(false)
15336 |  75 |   const [error, setError] = useState<string | null>(null)
15337 |  76 | 
15338 |  77 |   const loadStatus = async () => {
15339 |  78 |     setLoading(true)
15340 |  79 |     setError(null)
15341 |  80 |     try {
15342 |  81 |       const result = await getStatus()
15343 |  82 |       if (result.ok) {
15344 |  83 |         setStatus(result)
15345 |  84 |       } else {
15346 |  85 |         setError(result.error || 'Nie udalo sie pobrac statusu')
15347 |  86 |       }
15348 |  87 |     } catch {
15349 |  88 |       setError('Blad polaczenia z API')
15350 |  89 |     } finally {
15351 |  90 |       setLoading(false)
15352 |  91 |     }
15353 |  92 |   }
15354 |  93 | 
15355 |  94 |   useEffect(() => {
15356 |  95 |     if (isAuthenticated) {
15357 |  96 |       loadStatus()
15358 |  97 |     }
15359 |  98 |   }, [isAuthenticated])
15360 |  99 | 
15361 | 100 |   if (!isAuthenticated) {
15362 | 101 |     return (
15363 | 102 |       <div className="flex flex-col gap-4">
15364 | 103 |         <TokenForm />
15365 | 104 |       </div>
15366 | 105 |     )
15367 | 106 |   }
15368 | 107 | 
15369 | 108 |   const pm2Info = status?.pm2Status ? parsePm2Status(status.pm2Status) : null
15370 | 109 | 
15371 | 110 |   return (
15372 | 111 |     <div className="flex flex-col gap-4">
15373 | 112 |       <div className="flex items-center justify-between">
15374 | 113 |         <div>
15375 | 114 |           <h2 className="text-2xl font-bold tracking-tight">Status systemu</h2>
15376 | 115 |           <p className="text-muted-foreground">Przeglad stanu FB Watcher</p>
15377 | 116 |         </div>
15378 | 117 |         <Button variant="outline" onClick={loadStatus} disabled={loading}>
15379 | 118 |           <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
15380 | 119 |           Odswiez
15381 | 120 |         </Button>
15382 | 121 |       </div>
15383 | 122 | 
15384 | 123 |       {error && (
15385 | 124 |         <Card className="border-destructive">
15386 | 125 |           <CardContent className="pt-6">
15387 | 126 |             <p className="text-destructive">{error}</p>
15388 | 127 |             <TokenForm />
15389 | 128 |           </CardContent>
15390 | 129 |         </Card>
15391 | 130 |       )}
15392 | 131 | 
15393 | 132 |       {status && (
15394 | 133 |         <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
15395 | 134 |           <Card>
15396 | 135 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
15397 | 136 |               <CardTitle className="text-sm font-medium">Watcher PM2</CardTitle>
15398 | 137 |               <Server className="h-4 w-4 text-muted-foreground" />
15399 | 138 |             </CardHeader>
15400 | 139 |             <CardContent>
15401 | 140 |               <div className="flex items-center gap-2">
15402 | 141 |                 <Badge
15403 | 142 |                   variant={
15404 | 143 |                     pm2Info?.status === 'online'
15405 | 144 |                       ? 'success'
15406 | 145 |                       : pm2Info?.status === 'stopped'
15407 | 146 |                         ? 'secondary'
15408 | 147 |                         : 'destructive'
15409 | 148 |                   }
15410 | 149 |                 >
15411 | 150 |                   {pm2Info?.status || 'unknown'}
15412 | 151 |                 </Badge>
15413 | 152 |                 {pm2Info?.uptime && (
15414 | 153 |                   <span className="text-sm text-muted-foreground">
15415 | 154 |                     {pm2Info.uptime}
15416 | 155 |                   </span>
15417 | 156 |                 )}
15418 | 157 |               </div>
15419 | 158 |             </CardContent>
15420 | 159 |           </Card>
15421 | 160 | 
15422 | 161 |           <Card>
15423 | 162 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
15424 | 163 |               <CardTitle className="text-sm font-medium">Node.js</CardTitle>
15425 | 164 |               <Server className="h-4 w-4 text-muted-foreground" />
15426 | 165 |             </CardHeader>
15427 | 166 |             <CardContent>
15428 | 167 |               <div className="text-2xl font-bold">{status.node || 'N/A'}</div>
15429 | 168 |               <p className="text-xs text-muted-foreground">PM2: {status.pm2 || 'N/A'}</p>
15430 | 169 |             </CardContent>
15431 | 170 |           </Card>
15432 | 171 | 
15433 | 172 |           <Card>
15434 | 173 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
15435 | 174 |               <CardTitle className="text-sm font-medium">Katalog projektu</CardTitle>
15436 | 175 |               <FolderOpen className="h-4 w-4 text-muted-foreground" />
15437 | 176 |             </CardHeader>
15438 | 177 |             <CardContent>
15439 | 178 |               <p className="text-xs text-muted-foreground break-all">{status.projectDir}</p>
15440 | 179 |             </CardContent>
15441 | 180 |           </Card>
15442 | 181 | 
15443 | 182 |           <Card>
15444 | 183 |             <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
15445 | 184 |               <CardTitle className="text-sm font-medium">Pliki konfiguracji</CardTitle>
15446 | 185 |               <FileText className="h-4 w-4 text-muted-foreground" />
15447 | 186 |             </CardHeader>
15448 | 187 |             <CardContent className="space-y-1">
15449 | 188 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
15450 | 189 |                 <FileText className="h-3 w-3" /> .env
15451 | 190 |               </p>
15452 | 191 |               <p className="text-xs text-muted-foreground flex items-center gap-1">
15453 | 192 |                 <Cookie className="h-3 w-3" /> cookies.json
15454 | 193 |               </p>
15455 | 194 |             </CardContent>
15456 | 195 |           </Card>
15457 | 196 |         </div>
15458 | 197 |       )}
15459 | 198 | 
15460 | 199 |       {status && (
15461 | 200 |         <Card>
15462 | 201 |           <CardHeader>
15463 | 202 |             <CardTitle className="text-sm font-medium">PM2 Status</CardTitle>
15464 | 203 |           </CardHeader>
15465 | 204 |           <CardContent>
15466 | 205 |             <pre className="text-xs bg-muted p-4 rounded-md overflow-x-auto whitespace-pre">
15467 | 206 |               {status.pm2Status}
15468 | 207 |             </pre>
15469 | 208 |           </CardContent>
15470 | 209 |         </Card>
15471 | 210 |       )}
15472 | 211 | 
15473 | 212 |       <TokenForm />
15474 | 213 |     </div>
15475 | 214 |   )
15476 | 215 | }
15477 | 216 | 
15478 | ```
15479 | 
15480 | ---
15481 | 
15482 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Discoveries.tsx`
15483 | **Typ:** TypeScript  
15484 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
15485 | 
15486 | ```tsx
15487 |  1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
15488 |  2 | import { Bell, Clock } from 'lucide-react'
15489 |  3 | 
15490 |  4 | export function Discoveries() {
15491 |  5 |   return (
15492 |  6 |     <div className="flex flex-col gap-4">
15493 |  7 |       <Card>
15494 |  8 |         <CardHeader>
15495 |  9 |           <div className="flex items-center gap-3">
15496 | 10 |             <div className="p-2 bg-muted rounded-lg">
15497 | 11 |               <Bell className="h-6 w-6" />
15498 | 12 |             </div>
15499 | 13 |             <div>
15500 | 14 |               <CardTitle>Wykrycia</CardTitle>
15501 | 15 |               <CardDescription>Przegladaj i zatwierdzaj wykryte posty</CardDescription>
15502 | 16 |             </div>
15503 | 17 |           </div>
15504 | 18 |         </CardHeader>
15505 | 19 |         <CardContent>
15506 | 20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
15507 | 21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
15508 | 22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
15509 | 23 |             <p className="text-muted-foreground max-w-md">
15510 | 24 |               Ta funkcja pozwoli na przegladanie automatycznie wykrytych postow
15511 | 25 |               i zatwierdzanie ich do monitorowania.
15512 | 26 |             </p>
15513 | 27 |           </div>
15514 | 28 |         </CardContent>
15515 | 29 |       </Card>
15516 | 30 | 
15517 | 31 |       <Card>
15518 | 32 |         <CardHeader>
15519 | 33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
15520 | 34 |         </CardHeader>
15521 | 35 |         <CardContent>
15522 | 36 |           <ul className="space-y-2 text-sm text-muted-foreground">
15523 | 37 |             <li>‚Ä¢ Lista wykrytych postow oczekujacych na zatwierdzenie</li>
15524 | 38 |             <li>‚Ä¢ Podglad tresci posta przed zatwierdzeniem</li>
15525 | 39 |             <li>‚Ä¢ Masowe zatwierdzanie / odrzucanie</li>
15526 | 40 |             <li>‚Ä¢ Historia wykryc</li>
15527 | 41 |             <li>‚Ä¢ Statystyki skutecznosci filtrow</li>
15528 | 42 |           </ul>
15529 | 43 |         </CardContent>
15530 | 44 |       </Card>
15531 | 45 |     </div>
15532 | 46 |   )
15533 | 47 | }
15534 | 48 | 
15535 | ```
15536 | 
15537 | ---
15538 | 
15539 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Logs.tsx`
15540 | **Typ:** TypeScript  
15541 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
15542 | 
15543 | ```tsx
15544 |   1 | import { useEffect, useRef } from 'react'
15545 |   2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
15546 |   3 | import { Button } from '@/components/ui/button'
15547 |   4 | import { Input } from '@/components/ui/input'
15548 |   5 | import { Label } from '@/components/ui/label'
15549 |   6 | import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs'
15550 |   7 | import { Textarea } from '@/components/ui/textarea'
15551 |   8 | import { Checkbox } from '@/components/ui/checkbox'
15552 |   9 | import { RefreshCw, Maximize2, Minimize2 } from 'lucide-react'
15553 |  10 | import { useLogs } from '@/hooks/useLogs'
15554 |  11 | import { useState } from 'react'
15555 |  12 | 
15556 |  13 | export function Logs() {
15557 |  14 |   const {
15558 |  15 |     logs,
15559 |  16 |     loading,
15560 |  17 |     error,
15561 |  18 |     mode,
15562 |  19 |     autoRefresh,
15563 |  20 |     setAutoRefresh,
15564 |  21 |     loadLogs,
15565 |  22 |     setMode,
15566 |  23 |   } = useLogs(200)
15567 |  24 | 
15568 |  25 |   const [lines, setLines] = useState(200)
15569 |  26 |   const [autoScroll, setAutoScroll] = useState(true)
15570 |  27 |   const [expanded, setExpanded] = useState(false)
15571 |  28 |   const textareaRef = useRef<HTMLTextAreaElement>(null)
15572 |  29 | 
15573 |  30 |   useEffect(() => {
15574 |  31 |     loadLogs()
15575 |  32 |   }, []) // eslint-disable-line react-hooks/exhaustive-deps
15576 |  33 | 
15577 |  34 |   useEffect(() => {
15578 |  35 |     if (autoScroll && textareaRef.current) {
15579 |  36 |       textareaRef.current.scrollTop = textareaRef.current.scrollHeight
15580 |  37 |     }
15581 |  38 |   }, [logs, autoScroll])
15582 |  39 | 
15583 |  40 |   const handleRefresh = () => {
15584 |  41 |     loadLogs(mode, lines)
15585 |  42 |   }
15586 |  43 | 
15587 |  44 |   const handleModeChange = (newMode: string) => {
15588 |  45 |     setMode(newMode as 'out' | 'err')
15589 |  46 |   }
15590 |  47 | 
15591 |  48 |   const toggleAutoRefresh = () => {
15592 |  49 |     if (autoRefresh > 0) {
15593 |  50 |       setAutoRefresh(0)
15594 |  51 |     } else {
15595 |  52 |       setAutoRefresh(5000) // 5 seconds
15596 |  53 |     }
15597 |  54 |   }
15598 |  55 | 
15599 |  56 |   return (
15600 |  57 |     <div className="flex flex-col gap-4 h-full">
15601 |  58 |       <Card className={expanded ? 'fixed inset-4 z-50 flex flex-col' : 'flex-1 flex flex-col'}>
15602 |  59 |         <CardHeader className="flex flex-row items-center justify-between shrink-0">
15603 |  60 |           <CardTitle>Logi PM2</CardTitle>
15604 |  61 |           <div className="flex items-center gap-2">
15605 |  62 |             <Tabs value={mode} onValueChange={handleModeChange}>
15606 |  63 |               <TabsList>
15607 |  64 |                 <TabsTrigger value="out">stdout</TabsTrigger>
15608 |  65 |                 <TabsTrigger value="err">stderr</TabsTrigger>
15609 |  66 |               </TabsList>
15610 |  67 |             </Tabs>
15611 |  68 |             <Button variant="outline" size="icon" onClick={() => setExpanded(!expanded)}>
15612 |  69 |               {expanded ? <Minimize2 className="h-4 w-4" /> : <Maximize2 className="h-4 w-4" />}
15613 |  70 |             </Button>
15614 |  71 |           </div>
15615 |  72 |         </CardHeader>
15616 |  73 |         <CardContent className="flex-1 flex flex-col gap-4 min-h-0">
15617 |  74 |           {/* Controls */}
15618 |  75 |           <div className="flex flex-wrap items-end gap-4 shrink-0">
15619 |  76 |             <div className="space-y-2">
15620 |  77 |               <Label htmlFor="lines">Liczba linii</Label>
15621 |  78 |               <Input
15622 |  79 |                 id="lines"
15623 |  80 |                 type="number"
15624 |  81 |                 className="w-24"
15625 |  82 |                 value={lines}
15626 |  83 |                 onChange={(e) => setLines(Number(e.target.value) || 200)}
15627 |  84 |                 min={20}
15628 |  85 |                 max={2000}
15629 |  86 |               />
15630 |  87 |             </div>
15631 |  88 | 
15632 |  89 |             <Button variant="outline" onClick={handleRefresh} disabled={loading}>
15633 |  90 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
15634 |  91 |               Wczytaj
15635 |  92 |             </Button>
15636 |  93 | 
15637 |  94 |             <Button
15638 |  95 |               variant={autoRefresh > 0 ? 'default' : 'outline'}
15639 |  96 |               onClick={toggleAutoRefresh}
15640 |  97 |             >
15641 |  98 |               Auto: {autoRefresh > 0 ? 'WL' : 'WYL'}
15642 |  99 |             </Button>
15643 | 100 | 
15644 | 101 |             <div className="flex items-center gap-2">
15645 | 102 |               <Checkbox
15646 | 103 |                 id="autoScroll"
15647 | 104 |                 checked={autoScroll}
15648 | 105 |                 onCheckedChange={(checked) => setAutoScroll(!!checked)}
15649 | 106 |               />
15650 | 107 |               <Label htmlFor="autoScroll">Auto-scroll</Label>
15651 | 108 |             </div>
15652 | 109 |           </div>
15653 | 110 | 
15654 | 111 |           {error && (
15655 | 112 |             <p className="text-destructive text-sm shrink-0">{error}</p>
15656 | 113 |           )}
15657 | 114 | 
15658 | 115 |           {/* Log content */}
15659 | 116 |           <Textarea
15660 | 117 |             ref={textareaRef}
15661 | 118 |             className="flex-1 font-mono text-xs resize-none min-h-[300px]"
15662 | 119 |             value={logs}
15663 | 120 |             readOnly
15664 | 121 |             placeholder="Brak logow do wyswietlenia..."
15665 | 122 |           />
15666 | 123 | 
15667 | 124 |           <p className="text-xs text-muted-foreground shrink-0">
15668 | 125 |             Tryb: {mode.toUpperCase()} | Linii: {lines} | Auto-refresh: {autoRefresh > 0 ? `${autoRefresh / 1000}s` : 'wyl'}
15669 | 126 |           </p>
15670 | 127 |         </CardContent>
15671 | 128 |       </Card>
15672 | 129 |     </div>
15673 | 130 |   )
15674 | 131 | }
15675 | 132 | 
15676 | ```
15677 | 
15678 | ---
15679 | 
15680 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Settings.tsx`
15681 | **Typ:** TypeScript  
15682 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
15683 | 
15684 | ```tsx
15685 |   1 | import { useEffect, useState } from 'react'
15686 |   2 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
15687 |   3 | import { Button } from '@/components/ui/button'
15688 |   4 | import { Input } from '@/components/ui/input'
15689 |   5 | import { Label } from '@/components/ui/label'
15690 |   6 | import { Switch } from '@/components/ui/switch'
15691 |   7 | import { Separator } from '@/components/ui/separator'
15692 |   8 | import {
15693 |   9 |   Play, Square, RotateCw, Save, RefreshCw,
15694 |  10 |   User, Bot, Zap, Terminal, Eye, Send, Bell, Link
15695 |  11 | } from 'lucide-react'
15696 |  12 | import { getEnv, setEnv, pm2Start, pm2Stop, pm2Restart } from '@/lib/api'
15697 |  13 | import type { EnvValues } from '@/lib/types'
15698 |  14 | 
15699 |  15 | interface FieldConfig {
15700 |  16 |   key: keyof EnvValues
15701 |  17 |   label: string
15702 |  18 |   type?: 'text' | 'password' | 'number' | 'switch' | 'select'
15703 |  19 |   placeholder?: string
15704 |  20 |   options?: { value: string; label: string }[]
15705 |  21 |   description?: string
15706 |  22 | }
15707 |  23 | 
15708 |  24 | interface SectionConfig {
15709 |  25 |   title: string
15710 |  26 |   icon: React.ReactNode
15711 |  27 |   description?: string
15712 |  28 |   fields: FieldConfig[]
15713 |  29 | }
15714 |  30 | 
15715 |  31 | const SECTIONS: SectionConfig[] = [
15716 |  32 |   {
15717 |  33 |     title: 'Watcher',
15718 |  34 |     icon: <Zap className="h-5 w-5" />,
15719 |  35 |     description: 'Ustawienia monitorowania komentarzy',
15720 |  36 |     fields: [
15721 |  37 |       { key: 'CHECK_INTERVAL_MS', label: 'Interwal sprawdzania (ms)', type: 'number', placeholder: '60000', description: 'Co ile ms sprawdzaƒá posty' },
15722 |  38 |       { key: 'FAST_MODE', label: 'Fast Mode', type: 'switch', description: 'Sortowanie "Najnowsze" dla szybszego wykrywania' },
15723 |  39 |       { key: 'INCLUDE_REPLIES', label: 'Uwzglƒôdniaj odpowiedzi', type: 'switch', description: 'Czy monitorowaƒá odpowiedzi na komentarze' },
15724 |  40 |     ],
15725 |  41 |   },
15726 |  42 |   {
15727 |  43 |     title: 'Logowanie',
15728 |  44 |     icon: <Terminal className="h-5 w-5" />,
15729 |  45 |     description: 'Poziom szczeg√≥≈Çowo≈õci log√≥w',
15730 |  46 |     fields: [
15731 |  47 |       {
15732 |  48 |         key: 'LOG_LEVEL',
15733 |  49 |         label: 'Poziom log√≥w',
15734 |  50 |         type: 'select',
15735 |  51 |         options: [
15736 |  52 |           { value: 'silent', label: 'Silent - brak log√≥w' },
15737 |  53 |           { value: 'production', label: 'Production - tylko wa≈ºne' },
15738 |  54 |           { value: 'dev', label: 'Dev - szczeg√≥≈Çowe' },
15739 |  55 |           { value: 'debug', label: 'Debug - wszystko' },
15740 |  56 |         ],
15741 |  57 |       },
15742 |  58 |     ],
15743 |  59 |   },
15744 |  60 |   {
15745 |  61 |     title: 'Puppeteer / Browser',
15746 |  62 |     icon: <Eye className="h-5 w-5" />,
15747 |  63 |     description: 'Ustawienia przeglƒÖdarki',
15748 |  64 |     fields: [
15749 |  65 |       { key: 'HEADLESS_BROWSER', label: 'Tryb headless', type: 'switch', description: 'Uruchamiaj bez widocznego okna' },
15750 |  66 |       { key: 'USE_UI_HANDLERS', label: 'UI Handlers', type: 'switch', description: 'U≈ºywaj handler√≥w UI do interakcji' },
15751 |  67 |       { key: 'COOKIES_READ_ONLY', label: 'Cookies tylko do odczytu', type: 'switch', description: 'Nie zapisuj zmian w cookies' },
15752 |  68 |     ],
15753 |  69 |   },
15754 |  70 |   {
15755 |  71 |     title: 'Facebook',
15756 |  72 |     icon: <User className="h-5 w-5" />,
15757 |  73 |     description: 'Dane logowania do FB',
15758 |  74 |     fields: [
15759 |  75 |       { key: 'FB_EMAIL', label: 'Email', placeholder: 'email@example.com' },
15760 |  76 |       { key: 'FB_PASSWORD', label: 'Has≈Ço', type: 'password', placeholder: '********' },
15761 |  77 |     ],
15762 |  78 |   },
15763 |  79 |   {
15764 |  80 |     title: '≈πr√≥d≈Ça post√≥w',
15765 |  81 |     icon: <Link className="h-5 w-5" />,
15766 |  82 |     description: 'SkƒÖd pobieraƒá listƒô post√≥w',
15767 |  83 |     fields: [
15768 |  84 |       { key: 'POSTS_API_URL', label: 'API URL', placeholder: 'http://server:3180/api/posts', description: 'Remote API panelu' },
15769 |  85 |       { key: 'POSTS_API_TOKEN', label: 'API Token', type: 'password', placeholder: 'fbw_xxx...' },
15770 |  86 |       { key: 'POSTS_SHEET_URL', label: 'Google Sheet URL', placeholder: 'https://docs.google.com/...', description: 'Fallback gdy API niedostƒôpne' },
15771 |  87 |     ],
15772 |  88 |   },
15773 |  89 |   {
15774 |  90 |     title: 'Telegram - W≈Ça≈õciciel',
15775 |  91 |     icon: <Send className="h-5 w-5" />,
15776 |  92 |     description: 'Powiadomienia do Ciebie',
15777 |  93 |     fields: [
15778 |  94 |       { key: 'TELEGRAM_SEND_TO_OWNER', label: 'Wysy≈Çaj do w≈Ça≈õciciela', type: 'switch' },
15779 |  95 |       { key: 'TELEGRAM_BOT_TOKEN_OWNER', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
15780 |  96 |       { key: 'TELEGRAM_CHAT_ID_OWNER', label: 'Chat ID', placeholder: '123456789' },
15781 |  97 |     ],
15782 |  98 |   },
15783 |  99 |   {
15784 | 100 |     title: 'Telegram - Klient',
15785 | 101 |     icon: <Bot className="h-5 w-5" />,
15786 | 102 |     description: 'Powiadomienia do klienta',
15787 | 103 |     fields: [
15788 | 104 |       { key: 'TELEGRAM_SEND_TO_CLIENT', label: 'Wysy≈Çaj do klienta', type: 'switch' },
15789 | 105 |       { key: 'TELEGRAM_BOT_TOKEN_CLIENT', label: 'Bot Token', type: 'password', placeholder: '123456:ABC...' },
15790 | 106 |       { key: 'TELEGRAM_CHAT_ID_CLIENT', label: 'Chat ID', placeholder: '123456789' },
15791 | 107 |     ],
15792 | 108 |   },
15793 | 109 |   {
15794 | 110 |     title: 'Telegram - Format',
15795 | 111 |     icon: <Send className="h-5 w-5" />,
15796 | 112 |     description: 'Formatowanie wiadomo≈õci',
15797 | 113 |     fields: [
15798 | 114 |       { key: 'TELEGRAM_USE_PHOTO', label: 'Wysy≈Çaj ze zdjƒôciem', type: 'switch', description: 'Do≈ÇƒÖcz miniaturƒô posta' },
15799 | 115 |       { key: 'TELEGRAM_DISABLE_WEB_PAGE_PREVIEW', label: 'Wy≈ÇƒÖcz podglƒÖd link√≥w', type: 'switch' },
15800 | 116 |     ],
15801 | 117 |   },
15802 | 118 |   {
15803 | 119 |     title: 'Telegram - Alerty',
15804 | 120 |     icon: <Bell className="h-5 w-5" />,
15805 | 121 |     description: 'Alerty o b≈Çƒôdach z log√≥w',
15806 | 122 |     fields: [
15807 | 123 |       { key: 'TG_ALERTS_ENABLED', label: 'W≈ÇƒÖcz alerty', type: 'switch' },
15808 | 124 |       { key: 'TG_ALERTS_COOLDOWN_SEC', label: 'Cooldown (sek)', type: 'number', placeholder: '120', description: 'Minimalny odstƒôp miƒôdzy alertami' },
15809 | 125 |       { key: 'TG_ALERTS_MAXLEN', label: 'Max d≈Çugo≈õƒá', type: 'number', placeholder: '3500', description: 'Maksymalna d≈Çugo≈õƒá wiadomo≈õci' },
15810 | 126 |     ],
15811 | 127 |   },
15812 | 128 | ]
15813 | 129 | 
15814 | 130 | function isTruthy(val: string): boolean {
15815 | 131 |   return val === 'true' || val === '1' || val === 'yes'
15816 | 132 | }
15817 | 133 | 
15818 | 134 | function boolToEnv(val: boolean): string {
15819 | 135 |   return val ? 'true' : 'false'
15820 | 136 | }
15821 | 137 | 
15822 | 138 | export function Settings() {
15823 | 139 |   const [values, setValues] = useState<EnvValues | null>(null)
15824 | 140 |   const [loading, setLoading] = useState(false)
15825 | 141 |   const [saving, setSaving] = useState(false)
15826 | 142 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
15827 | 143 |   const [pm2Loading, setPm2Loading] = useState<string | null>(null)
15828 | 144 | 
15829 | 145 |   const showMessage = (text: string, type: 'success' | 'error') => {
15830 | 146 |     setMessage({ text, type })
15831 | 147 |     setTimeout(() => setMessage(null), 3000)
15832 | 148 |   }
15833 | 149 | 
15834 | 150 |   const loadEnv = async () => {
15835 | 151 |     setLoading(true)
15836 | 152 |     try {
15837 | 153 |       const result = await getEnv()
15838 | 154 |       if (result.ok) {
15839 | 155 |         setValues(result.values)
15840 | 156 |       } else {
15841 | 157 |         showMessage(result.error || 'Nie udalo sie wczytac ustawien', 'error')
15842 | 158 |       }
15843 | 159 |     } catch {
15844 | 160 |       showMessage('Blad polaczenia', 'error')
15845 | 161 |     } finally {
15846 | 162 |       setLoading(false)
15847 | 163 |     }
15848 | 164 |   }
15849 | 165 | 
15850 | 166 |   useEffect(() => {
15851 | 167 |     loadEnv()
15852 | 168 |   }, [])
15853 | 169 | 
15854 | 170 |   const handleChange = (key: keyof EnvValues, value: string) => {
15855 | 171 |     if (values) {
15856 | 172 |       setValues({ ...values, [key]: value })
15857 | 173 |     }
15858 | 174 |   }
15859 | 175 | 
15860 | 176 |   const handleSwitchChange = (key: keyof EnvValues, checked: boolean) => {
15861 | 177 |     if (values) {
15862 | 178 |       setValues({ ...values, [key]: boolToEnv(checked) })
15863 | 179 |     }
15864 | 180 |   }
15865 | 181 | 
15866 | 182 |   const handleSave = async (restart = false) => {
15867 | 183 |     if (!values) return
15868 | 184 | 
15869 | 185 |     setSaving(true)
15870 | 186 |     try {
15871 | 187 |       const envRecord: Record<string, string> = {}
15872 | 188 |       for (const key of Object.keys(values) as (keyof typeof values)[]) {
15873 | 189 |         envRecord[key] = values[key]
15874 | 190 |       }
15875 | 191 |       const result = await setEnv(envRecord, restart)
15876 | 192 |       if (result.ok) {
15877 | 193 |         showMessage(restart ? 'Zapisano i zrestartowano' : 'Zapisano ustawienia', 'success')
15878 | 194 |       } else {
15879 | 195 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
15880 | 196 |       }
15881 | 197 |     } catch {
15882 | 198 |       showMessage('Blad polaczenia', 'error')
15883 | 199 |     } finally {
15884 | 200 |       setSaving(false)
15885 | 201 |     }
15886 | 202 |   }
15887 | 203 | 
15888 | 204 |   const handlePm2Action = async (action: 'start' | 'stop' | 'restart') => {
15889 | 205 |     setPm2Loading(action)
15890 | 206 |     try {
15891 | 207 |       const fn = action === 'start' ? pm2Start : action === 'stop' ? pm2Stop : pm2Restart
15892 | 208 |       const result = await fn()
15893 | 209 |       if (result.ok) {
15894 | 210 |         const labels = { start: 'Uruchomiono', stop: 'Zatrzymano', restart: 'Zrestartowano' }
15895 | 211 |         showMessage(labels[action], 'success')
15896 | 212 |       } else {
15897 | 213 |         showMessage(result.error || `Nie udalo sie ${action}`, 'error')
15898 | 214 |       }
15899 | 215 |     } catch {
15900 | 216 |       showMessage('Blad polaczenia', 'error')
15901 | 217 |     } finally {
15902 | 218 |       setPm2Loading(null)
15903 | 219 |     }
15904 | 220 |   }
15905 | 221 | 
15906 | 222 |   const renderField = (field: FieldConfig) => {
15907 | 223 |     if (!values) return null
15908 | 224 |     const value = values[field.key] || ''
15909 | 225 | 
15910 | 226 |     if (field.type === 'switch') {
15911 | 227 |       return (
15912 | 228 |         <div key={field.key} className="flex items-center justify-between py-2">
15913 | 229 |           <div className="space-y-0.5">
15914 | 230 |             <Label htmlFor={field.key}>{field.label}</Label>
15915 | 231 |             {field.description && (
15916 | 232 |               <p className="text-xs text-muted-foreground">{field.description}</p>
15917 | 233 |             )}
15918 | 234 |           </div>
15919 | 235 |           <Switch
15920 | 236 |             id={field.key}
15921 | 237 |             checked={isTruthy(value)}
15922 | 238 |             onCheckedChange={(checked) => handleSwitchChange(field.key, checked)}
15923 | 239 |           />
15924 | 240 |         </div>
15925 | 241 |       )
15926 | 242 |     }
15927 | 243 | 
15928 | 244 |     if (field.type === 'select' && field.options) {
15929 | 245 |       return (
15930 | 246 |         <div key={field.key} className="space-y-2">
15931 | 247 |           <Label htmlFor={field.key}>{field.label}</Label>
15932 | 248 |           <select
15933 | 249 |             id={field.key}
15934 | 250 |             value={value}
15935 | 251 |             onChange={(e) => handleChange(field.key, e.target.value)}
15936 | 252 |             className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
15937 | 253 |           >
15938 | 254 |             {field.options.map((opt) => (
15939 | 255 |               <option key={opt.value} value={opt.value}>
15940 | 256 |                 {opt.label}
15941 | 257 |               </option>
15942 | 258 |             ))}
15943 | 259 |           </select>
15944 | 260 |         </div>
15945 | 261 |       )
15946 | 262 |     }
15947 | 263 | 
15948 | 264 |     return (
15949 | 265 |       <div key={field.key} className="space-y-2">
15950 | 266 |         <Label htmlFor={field.key}>{field.label}</Label>
15951 | 267 |         <Input
15952 | 268 |           id={field.key}
15953 | 269 |           type={field.type || 'text'}
15954 | 270 |           placeholder={field.placeholder}
15955 | 271 |           value={value}
15956 | 272 |           onChange={(e) => handleChange(field.key, e.target.value)}
15957 | 273 |         />
15958 | 274 |         {field.description && (
15959 | 275 |           <p className="text-xs text-muted-foreground">{field.description}</p>
15960 | 276 |         )}
15961 | 277 |       </div>
15962 | 278 |     )
15963 | 279 |   }
15964 | 280 | 
15965 | 281 |   return (
15966 | 282 |     <div className="flex flex-col gap-4">
15967 | 283 |       {message && (
15968 | 284 |         <div
15969 | 285 |           className={`p-3 rounded-md text-sm ${
15970 | 286 |             message.type === 'success'
15971 | 287 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
15972 | 288 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
15973 | 289 |           }`}
15974 | 290 |         >
15975 | 291 |           {message.text}
15976 | 292 |         </div>
15977 | 293 |       )}
15978 | 294 | 
15979 | 295 |       {/* PM2 Controls */}
15980 | 296 |       <Card>
15981 | 297 |         <CardHeader>
15982 | 298 |           <CardTitle>PM2 Controls</CardTitle>
15983 | 299 |           <CardDescription>Zarzadzanie procesem watchera</CardDescription>
15984 | 300 |         </CardHeader>
15985 | 301 |         <CardContent>
15986 | 302 |           <div className="flex flex-wrap gap-2">
15987 | 303 |             <Button
15988 | 304 |               variant="outline"
15989 | 305 |               onClick={() => handlePm2Action('start')}
15990 | 306 |               disabled={!!pm2Loading}
15991 | 307 |             >
15992 | 308 |               <Play className="h-4 w-4 mr-2" />
15993 | 309 |               {pm2Loading === 'start' ? 'Uruchamianie...' : 'Start'}
15994 | 310 |             </Button>
15995 | 311 |             <Button
15996 | 312 |               variant="outline"
15997 | 313 |               onClick={() => handlePm2Action('stop')}
15998 | 314 |               disabled={!!pm2Loading}
15999 | 315 |             >
16000 | 316 |               <Square className="h-4 w-4 mr-2" />
16001 | 317 |               {pm2Loading === 'stop' ? 'Zatrzymywanie...' : 'Stop'}
16002 | 318 |             </Button>
16003 | 319 |             <Button
16004 | 320 |               variant="outline"
16005 | 321 |               onClick={() => handlePm2Action('restart')}
16006 | 322 |               disabled={!!pm2Loading}
16007 | 323 |             >
16008 | 324 |               <RotateCw className="h-4 w-4 mr-2" />
16009 | 325 |               {pm2Loading === 'restart' ? 'Restartowanie...' : 'Restart'}
16010 | 326 |             </Button>
16011 | 327 |           </div>
16012 | 328 |         </CardContent>
16013 | 329 |       </Card>
16014 | 330 | 
16015 | 331 |       {/* Save buttons - sticky */}
16016 | 332 |       <Card className="sticky top-4 z-10 border-primary/50">
16017 | 333 |         <CardContent className="pt-4">
16018 | 334 |           <div className="flex flex-wrap items-center justify-between gap-2">
16019 | 335 |             <Button variant="outline" size="sm" onClick={loadEnv} disabled={loading}>
16020 | 336 |               <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
16021 | 337 |               Wczytaj ponownie
16022 | 338 |             </Button>
16023 | 339 |             <div className="flex gap-2">
16024 | 340 |               <Button onClick={() => handleSave(false)} disabled={saving}>
16025 | 341 |                 <Save className="h-4 w-4 mr-2" />
16026 | 342 |                 {saving ? 'Zapisywanie...' : 'Zapisz'}
16027 | 343 |               </Button>
16028 | 344 |               <Button variant="secondary" onClick={() => handleSave(true)} disabled={saving}>
16029 | 345 |                 <RotateCw className="h-4 w-4 mr-2" />
16030 | 346 |                 Zapisz i restartuj
16031 | 347 |               </Button>
16032 | 348 |             </div>
16033 | 349 |           </div>
16034 | 350 |         </CardContent>
16035 | 351 |       </Card>
16036 | 352 | 
16037 | 353 |       {/* Settings sections */}
16038 | 354 |       {values && SECTIONS.map((section) => (
16039 | 355 |         <Card key={section.title}>
16040 | 356 |           <CardHeader>
16041 | 357 |             <CardTitle className="flex items-center gap-2 text-lg">
16042 | 358 |               {section.icon}
16043 | 359 |               {section.title}
16044 | 360 |             </CardTitle>
16045 | 361 |             {section.description && (
16046 | 362 |               <CardDescription>{section.description}</CardDescription>
16047 | 363 |             )}
16048 | 364 |           </CardHeader>
16049 | 365 |           <CardContent className="space-y-4">
16050 | 366 |             {section.fields.map((field, idx) => (
16051 | 367 |               <div key={field.key}>
16052 | 368 |                 {renderField(field)}
16053 | 369 |                 {idx < section.fields.length - 1 && field.type !== 'switch' && (
16054 | 370 |                   <Separator className="mt-4" />
16055 | 371 |                 )}
16056 | 372 |               </div>
16057 | 373 |             ))}
16058 | 374 |           </CardContent>
16059 | 375 |         </Card>
16060 | 376 |       ))}
16061 | 377 |     </div>
16062 | 378 |   )
16063 | 379 | }
16064 | 380 | 
16065 | ```
16066 | 
16067 | ---
16068 | 
16069 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Sources.tsx`
16070 | **Typ:** TypeScript  
16071 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
16072 | 
16073 | ```tsx
16074 |  1 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
16075 |  2 | import { Globe, Clock } from 'lucide-react'
16076 |  3 | 
16077 |  4 | export function Sources() {
16078 |  5 |   return (
16079 |  6 |     <div className="flex flex-col gap-4">
16080 |  7 |       <Card>
16081 |  8 |         <CardHeader>
16082 |  9 |           <div className="flex items-center gap-3">
16083 | 10 |             <div className="p-2 bg-muted rounded-lg">
16084 | 11 |               <Globe className="h-6 w-6" />
16085 | 12 |             </div>
16086 | 13 |             <div>
16087 | 14 |               <CardTitle>Zrodla monitorowania</CardTitle>
16088 | 15 |               <CardDescription>Zarzadzaj zrodlami postow do monitorowania</CardDescription>
16089 | 16 |             </div>
16090 | 17 |           </div>
16091 | 18 |         </CardHeader>
16092 | 19 |         <CardContent>
16093 | 20 |           <div className="flex flex-col items-center justify-center py-12 text-center">
16094 | 21 |             <Clock className="h-12 w-12 text-muted-foreground mb-4" />
16095 | 22 |             <h3 className="text-lg font-semibold mb-2">Wkrotce dostepne</h3>
16096 | 23 |             <p className="text-muted-foreground max-w-md">
16097 | 24 |               Ta funkcja pozwoli na automatyczne wykrywanie postow z roznych zrodel:
16098 | 25 |               glownego feedu, grup, czy Meta Ads Library.
16099 | 26 |             </p>
16100 | 27 |           </div>
16101 | 28 |         </CardContent>
16102 | 29 |       </Card>
16103 | 30 | 
16104 | 31 |       <Card>
16105 | 32 |         <CardHeader>
16106 | 33 |           <CardTitle className="text-sm">Planowane funkcje</CardTitle>
16107 | 34 |         </CardHeader>
16108 | 35 |         <CardContent>
16109 | 36 |           <ul className="space-y-2 text-sm text-muted-foreground">
16110 | 37 |             <li>‚Ä¢ Monitorowanie glownego feedu FB</li>
16111 | 38 |             <li>‚Ä¢ Monitorowanie wybranych grup</li>
16112 | 39 |             <li>‚Ä¢ Integracja z Meta Ads Library</li>
16113 | 40 |             <li>‚Ä¢ Filtrowanie po slowach kluczowych</li>
16114 | 41 |             <li>‚Ä¢ Automatyczne dodawanie wykrytych postow</li>
16115 | 42 |           </ul>
16116 | 43 |         </CardContent>
16117 | 44 |       </Card>
16118 | 45 |     </div>
16119 | 46 |   )
16120 | 47 | }
16121 | 48 | 
16122 | ```
16123 | 
16124 | ---
16125 | 
16126 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/pages/Watched.tsx`
16127 | **Typ:** TypeScript  
16128 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
16129 | 
16130 | ```tsx
16131 |   1 | import { useEffect, useState, useCallback } from 'react'
16132 |   2 | import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
16133 |   3 | import { Button } from '@/components/ui/button'
16134 |   4 | import { Input } from '@/components/ui/input'
16135 |   5 | import { Label } from '@/components/ui/label'
16136 |   6 | import { Checkbox } from '@/components/ui/checkbox'
16137 |   7 | import {
16138 |   8 |   Table,
16139 |   9 |   TableBody,
16140 |  10 |   TableCell,
16141 |  11 |   TableHead,
16142 |  12 |   TableHeader,
16143 |  13 |   TableRow,
16144 |  14 | } from '@/components/ui/table'
16145 |  15 | import {
16146 |  16 |   Dialog,
16147 |  17 |   DialogContent,
16148 |  18 |   DialogDescription,
16149 |  19 |   DialogFooter,
16150 |  20 |   DialogHeader,
16151 |  21 |   DialogTitle,
16152 |  22 | } from '@/components/ui/dialog'
16153 |  23 | import { Plus, Pencil, Trash2, ExternalLink, Copy, RefreshCw } from 'lucide-react'
16154 |  24 | import { getPosts, addPost, updatePost, deletePost } from '@/lib/api'
16155 |  25 | import type { Post } from '@/lib/types'
16156 |  26 | 
16157 |  27 | export function Watched() {
16158 |  28 |   const [posts, setPosts] = useState<Post[]>([])
16159 |  29 |   const [loading, setLoading] = useState(false)
16160 |  30 |   const [error, setError] = useState<string | null>(null)
16161 |  31 |   const [message, setMessage] = useState<{ text: string; type: 'success' | 'error' } | null>(null)
16162 |  32 | 
16163 |  33 |   // Add form state
16164 |  34 |   const [newUrl, setNewUrl] = useState('')
16165 |  35 |   const [newName, setNewName] = useState('')
16166 |  36 |   const [newImage, setNewImage] = useState('')
16167 |  37 |   const [newActive, setNewActive] = useState(true)
16168 |  38 |   const [adding, setAdding] = useState(false)
16169 |  39 | 
16170 |  40 |   // Edit dialog state
16171 |  41 |   const [editPost, setEditPost] = useState<Post | null>(null)
16172 |  42 |   const [editUrl, setEditUrl] = useState('')
16173 |  43 |   const [editName, setEditName] = useState('')
16174 |  44 |   const [editImage, setEditImage] = useState('')
16175 |  45 |   const [saving, setSaving] = useState(false)
16176 |  46 | 
16177 |  47 |   // Delete dialog state
16178 |  48 |   const [deleteTarget, setDeleteTarget] = useState<Post | null>(null)
16179 |  49 |   const [deleting, setDeleting] = useState(false)
16180 |  50 | 
16181 |  51 |   const loadPosts = useCallback(async () => {
16182 |  52 |     setLoading(true)
16183 |  53 |     setError(null)
16184 |  54 |     try {
16185 |  55 |       const result = await getPosts()
16186 |  56 |       if (result.ok) {
16187 |  57 |         setPosts(result.posts)
16188 |  58 |       } else {
16189 |  59 |         setError(result.error || 'Nie udalo sie pobrac postow')
16190 |  60 |       }
16191 |  61 |     } catch {
16192 |  62 |       setError('Blad polaczenia')
16193 |  63 |     } finally {
16194 |  64 |       setLoading(false)
16195 |  65 |     }
16196 |  66 |   }, [])
16197 |  67 | 
16198 |  68 |   useEffect(() => {
16199 |  69 |     loadPosts()
16200 |  70 |   }, [loadPosts])
16201 |  71 | 
16202 |  72 |   const showMessage = (text: string, type: 'success' | 'error') => {
16203 |  73 |     setMessage({ text, type })
16204 |  74 |     setTimeout(() => setMessage(null), 3000)
16205 |  75 |   }
16206 |  76 | 
16207 |  77 |   const handleAdd = async () => {
16208 |  78 |     if (!newUrl.trim()) {
16209 |  79 |       showMessage('Podaj URL posta', 'error')
16210 |  80 |       return
16211 |  81 |     }
16212 |  82 | 
16213 |  83 |     setAdding(true)
16214 |  84 |     try {
16215 |  85 |       const result = await addPost({
16216 |  86 |         url: newUrl.trim(),
16217 |  87 |         name: newName.trim(),
16218 |  88 |         image: newImage.trim(),
16219 |  89 |         active: newActive,
16220 |  90 |       })
16221 |  91 | 
16222 |  92 |       if (result.ok) {
16223 |  93 |         showMessage('Post dodany', 'success')
16224 |  94 |         setNewUrl('')
16225 |  95 |         setNewName('')
16226 |  96 |         setNewImage('')
16227 |  97 |         setNewActive(true)
16228 |  98 |         loadPosts()
16229 |  99 |       } else {
16230 | 100 |         showMessage(result.error || 'Nie udalo sie dodac posta', 'error')
16231 | 101 |       }
16232 | 102 |     } catch {
16233 | 103 |       showMessage('Blad polaczenia', 'error')
16234 | 104 |     } finally {
16235 | 105 |       setAdding(false)
16236 | 106 |     }
16237 | 107 |   }
16238 | 108 | 
16239 | 109 |   const handleToggleActive = async (post: Post) => {
16240 | 110 |     try {
16241 | 111 |       const result = await updatePost(post.id, { active: !post.active })
16242 | 112 |       if (result.ok) {
16243 | 113 |         loadPosts()
16244 | 114 |       } else {
16245 | 115 |         showMessage(result.error || 'Nie udalo sie zmienic statusu', 'error')
16246 | 116 |       }
16247 | 117 |     } catch {
16248 | 118 |       showMessage('Blad polaczenia', 'error')
16249 | 119 |     }
16250 | 120 |   }
16251 | 121 | 
16252 | 122 |   const openEditDialog = (post: Post) => {
16253 | 123 |     setEditPost(post)
16254 | 124 |     setEditUrl(post.url)
16255 | 125 |     setEditName(post.name)
16256 | 126 |     setEditImage(post.image)
16257 | 127 |   }
16258 | 128 | 
16259 | 129 |   const handleEdit = async () => {
16260 | 130 |     if (!editPost) return
16261 | 131 | 
16262 | 132 |     setSaving(true)
16263 | 133 |     try {
16264 | 134 |       const result = await updatePost(editPost.id, {
16265 | 135 |         url: editUrl.trim(),
16266 | 136 |         name: editName.trim(),
16267 | 137 |         image: editImage.trim(),
16268 | 138 |       })
16269 | 139 | 
16270 | 140 |       if (result.ok) {
16271 | 141 |         showMessage('Zapisano zmiany', 'success')
16272 | 142 |         setEditPost(null)
16273 | 143 |         loadPosts()
16274 | 144 |       } else {
16275 | 145 |         showMessage(result.error || 'Nie udalo sie zapisac', 'error')
16276 | 146 |       }
16277 | 147 |     } catch {
16278 | 148 |       showMessage('Blad polaczenia', 'error')
16279 | 149 |     } finally {
16280 | 150 |       setSaving(false)
16281 | 151 |     }
16282 | 152 |   }
16283 | 153 | 
16284 | 154 |   const handleDelete = async () => {
16285 | 155 |     if (!deleteTarget) return
16286 | 156 | 
16287 | 157 |     setDeleting(true)
16288 | 158 |     try {
16289 | 159 |       const result = await deletePost(deleteTarget.id)
16290 | 160 |       if (result.ok) {
16291 | 161 |         showMessage('Post usuniety', 'success')
16292 | 162 |         setDeleteTarget(null)
16293 | 163 |         loadPosts()
16294 | 164 |       } else {
16295 | 165 |         showMessage(result.error || 'Nie udalo sie usunac', 'error')
16296 | 166 |       }
16297 | 167 |     } catch {
16298 | 168 |       showMessage('Blad polaczenia', 'error')
16299 | 169 |     } finally {
16300 | 170 |       setDeleting(false)
16301 | 171 |     }
16302 | 172 |   }
16303 | 173 | 
16304 | 174 |   const copyToClipboard = async (text: string) => {
16305 | 175 |     try {
16306 | 176 |       await navigator.clipboard.writeText(text)
16307 | 177 |       showMessage('Skopiowano do schowka', 'success')
16308 | 178 |     } catch {
16309 | 179 |       showMessage('Nie udalo sie skopiowac', 'error')
16310 | 180 |     }
16311 | 181 |   }
16312 | 182 | 
16313 | 183 |   return (
16314 | 184 |     <div className="flex flex-col gap-4">
16315 | 185 |       {message && (
16316 | 186 |         <div
16317 | 187 |           className={`p-3 rounded-md text-sm ${
16318 | 188 |             message.type === 'success'
16319 | 189 |               ? 'bg-green-900/20 text-green-400 border border-green-900/50'
16320 | 190 |               : 'bg-red-900/20 text-red-400 border border-red-900/50'
16321 | 191 |           }`}
16322 | 192 |         >
16323 | 193 |           {message.text}
16324 | 194 |         </div>
16325 | 195 |       )}
16326 | 196 | 
16327 | 197 |       {/* Add form */}
16328 | 198 |       <Card>
16329 | 199 |         <CardHeader>
16330 | 200 |           <CardTitle className="text-lg">Dodaj nowy post</CardTitle>
16331 | 201 |         </CardHeader>
16332 | 202 |         <CardContent>
16333 | 203 |           <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
16334 | 204 |             <div className="space-y-2">
16335 | 205 |               <Label htmlFor="newUrl">URL posta *</Label>
16336 | 206 |               <Input
16337 | 207 |                 id="newUrl"
16338 | 208 |                 placeholder="https://www.facebook.com/..."
16339 | 209 |                 value={newUrl}
16340 | 210 |                 onChange={(e) => setNewUrl(e.target.value)}
16341 | 211 |               />
16342 | 212 |             </div>
16343 | 213 |             <div className="space-y-2">
16344 | 214 |               <Label htmlFor="newName">Nazwa</Label>
16345 | 215 |               <Input
16346 | 216 |                 id="newName"
16347 | 217 |                 placeholder="Opcjonalna nazwa"
16348 | 218 |                 value={newName}
16349 | 219 |                 onChange={(e) => setNewName(e.target.value)}
16350 | 220 |               />
16351 | 221 |             </div>
16352 | 222 |             <div className="space-y-2">
16353 | 223 |               <Label htmlFor="newImage">URL obrazka</Label>
16354 | 224 |               <Input
16355 | 225 |                 id="newImage"
16356 | 226 |                 placeholder="https://..."
16357 | 227 |                 value={newImage}
16358 | 228 |                 onChange={(e) => setNewImage(e.target.value)}
16359 | 229 |               />
16360 | 230 |             </div>
16361 | 231 |             <div className="flex items-end gap-4">
16362 | 232 |               <div className="flex items-center gap-2">
16363 | 233 |                 <Checkbox
16364 | 234 |                   id="newActive"
16365 | 235 |                   checked={newActive}
16366 | 236 |                   onCheckedChange={(checked) => setNewActive(!!checked)}
16367 | 237 |                 />
16368 | 238 |                 <Label htmlFor="newActive">Aktywny</Label>
16369 | 239 |               </div>
16370 | 240 |               <Button onClick={handleAdd} disabled={adding}>
16371 | 241 |                 <Plus className="h-4 w-4 mr-2" />
16372 | 242 |                 {adding ? 'Dodawanie...' : 'Dodaj'}
16373 | 243 |               </Button>
16374 | 244 |             </div>
16375 | 245 |           </div>
16376 | 246 |         </CardContent>
16377 | 247 |       </Card>
16378 | 248 | 
16379 | 249 |       {/* Posts table */}
16380 | 250 |       <Card>
16381 | 251 |         <CardHeader className="flex flex-row items-center justify-between">
16382 | 252 |           <CardTitle className="text-lg">Obserwowane posty ({posts.length})</CardTitle>
16383 | 253 |           <Button variant="outline" size="sm" onClick={loadPosts} disabled={loading}>
16384 | 254 |             <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
16385 | 255 |             Odswiez
16386 | 256 |           </Button>
16387 | 257 |         </CardHeader>
16388 | 258 |         <CardContent>
16389 | 259 |           {error && <p className="text-destructive mb-4">{error}</p>}
16390 | 260 | 
16391 | 261 |           <Table>
16392 | 262 |             <TableHeader>
16393 | 263 |               <TableRow>
16394 | 264 |                 <TableHead className="w-[60px]">ID</TableHead>
16395 | 265 |                 <TableHead>URL</TableHead>
16396 | 266 |                 <TableHead>Nazwa</TableHead>
16397 | 267 |                 <TableHead className="w-[260px]">Obrazek</TableHead>
16398 | 268 |                 <TableHead className="w-[80px]">Aktywny</TableHead>
16399 | 269 |                 <TableHead className="w-[120px]">Akcje</TableHead>
16400 | 270 |               </TableRow>
16401 | 271 |             </TableHeader>
16402 | 272 |             <TableBody>
16403 | 273 |               {posts.map((post) => (
16404 | 274 |                 <TableRow key={post.id}>
16405 | 275 |                   <TableCell className="font-mono text-xs">{post.id.slice(0, 6)}</TableCell>
16406 | 276 |                   <TableCell>
16407 | 277 |                     <div className="flex items-center gap-2 max-w-md">
16408 | 278 |                       <a
16409 | 279 |                         href={post.url}
16410 | 280 |                         target="_blank"
16411 | 281 |                         rel="noopener noreferrer"
16412 | 282 |                         className="text-blue-400 hover:underline truncate text-sm"
16413 | 283 |                       >
16414 | 284 |                         {post.url}
16415 | 285 |                       </a>
16416 | 286 |                       <Button
16417 | 287 |                         variant="ghost"
16418 | 288 |                         size="icon"
16419 | 289 |                         className="h-6 w-6 shrink-0"
16420 | 290 |                         onClick={() => copyToClipboard(post.url)}
16421 | 291 |                       >
16422 | 292 |                         <Copy className="h-3 w-3" />
16423 | 293 |                       </Button>
16424 | 294 |                       <a
16425 | 295 |                         href={post.url}
16426 | 296 |                         target="_blank"
16427 | 297 |                         rel="noopener noreferrer"
16428 | 298 |                         className="shrink-0"
16429 | 299 |                       >
16430 | 300 |                         <ExternalLink className="h-3 w-3 text-muted-foreground" />
16431 | 301 |                       </a>
16432 | 302 |                     </div>
16433 | 303 |                   </TableCell>
16434 | 304 |                   <TableCell className="max-w-[150px] truncate">{post.name || '-'}</TableCell>
16435 | 305 |                   <TableCell>
16436 | 306 |                     {post.image ? (
16437 | 307 |                       <img
16438 | 308 |   src={post.image}
16439 | 309 |   alt=""
16440 | 310 |   className="w-[220px] h-[120px] object-contain rounded-md bg-black/20 transition-transform duration-200 hover:scale-[1.03] cursor-zoom-in"
16441 | 311 | />
16442 | 312 | 
16443 | 313 |                     ) : (
16444 | 314 |                       '-'
16445 | 315 |                     )}
16446 | 316 |                   </TableCell>
16447 | 317 |                   <TableCell>
16448 | 318 |                     <Checkbox
16449 | 319 |                       checked={post.active}
16450 | 320 |                       onCheckedChange={() => handleToggleActive(post)}
16451 | 321 |                     />
16452 | 322 |                   </TableCell>
16453 | 323 |                   <TableCell>
16454 | 324 |                     <div className="flex items-center gap-1">
16455 | 325 |                       <Button
16456 | 326 |                         variant="ghost"
16457 | 327 |                         size="icon"
16458 | 328 |                         className="h-8 w-8"
16459 | 329 |                         onClick={() => openEditDialog(post)}
16460 | 330 |                       >
16461 | 331 |                         <Pencil className="h-4 w-4" />
16462 | 332 |                       </Button>
16463 | 333 |                       <Button
16464 | 334 |                         variant="ghost"
16465 | 335 |                         size="icon"
16466 | 336 |                         className="h-8 w-8 text-destructive hover:text-destructive"
16467 | 337 |                         onClick={() => setDeleteTarget(post)}
16468 | 338 |                       >
16469 | 339 |                         <Trash2 className="h-4 w-4" />
16470 | 340 |                       </Button>
16471 | 341 |                     </div>
16472 | 342 |                   </TableCell>
16473 | 343 |                 </TableRow>
16474 | 344 |               ))}
16475 | 345 |               {posts.length === 0 && !loading && (
16476 | 346 |                 <TableRow>
16477 | 347 |                   <TableCell colSpan={6} className="text-center text-muted-foreground py-8">
16478 | 348 |                     Brak obserwowanych postow. Dodaj pierwszy powyzej.
16479 | 349 |                   </TableCell>
16480 | 350 |                 </TableRow>
16481 | 351 |               )}
16482 | 352 |             </TableBody>
16483 | 353 |           </Table>
16484 | 354 |         </CardContent>
16485 | 355 |       </Card>
16486 | 356 | 
16487 | 357 |       {/* Edit dialog */}
16488 | 358 |       <Dialog open={!!editPost} onOpenChange={(open) => !open && setEditPost(null)}>
16489 | 359 |         <DialogContent>
16490 | 360 |           <DialogHeader>
16491 | 361 |             <DialogTitle>Edytuj post</DialogTitle>
16492 | 362 |             <DialogDescription>Zmien dane obserwowanego posta</DialogDescription>
16493 | 363 |           </DialogHeader>
16494 | 364 |           <div className="grid gap-4 py-4">
16495 | 365 |             <div className="space-y-2">
16496 | 366 |               <Label htmlFor="editUrl">URL</Label>
16497 | 367 |               <Input
16498 | 368 |                 id="editUrl"
16499 | 369 |                 value={editUrl}
16500 | 370 |                 onChange={(e) => setEditUrl(e.target.value)}
16501 | 371 |               />
16502 | 372 |             </div>
16503 | 373 |             <div className="space-y-2">
16504 | 374 |               <Label htmlFor="editName">Nazwa</Label>
16505 | 375 |               <Input
16506 | 376 |                 id="editName"
16507 | 377 |                 value={editName}
16508 | 378 |                 onChange={(e) => setEditName(e.target.value)}
16509 | 379 |               />
16510 | 380 |             </div>
16511 | 381 |             <div className="space-y-2">
16512 | 382 |               <Label htmlFor="editImage">URL obrazka</Label>
16513 | 383 |               <Input
16514 | 384 |                 id="editImage"
16515 | 385 |                 value={editImage}
16516 | 386 |                 onChange={(e) => setEditImage(e.target.value)}
16517 | 387 |               />
16518 | 388 |             </div>
16519 | 389 |           </div>
16520 | 390 |           <DialogFooter>
16521 | 391 |             <Button variant="outline" onClick={() => setEditPost(null)}>
16522 | 392 |               Anuluj
16523 | 393 |             </Button>
16524 | 394 |             <Button onClick={handleEdit} disabled={saving}>
16525 | 395 |               {saving ? 'Zapisywanie...' : 'Zapisz'}
16526 | 396 |             </Button>
16527 | 397 |           </DialogFooter>
16528 | 398 |         </DialogContent>
16529 | 399 |       </Dialog>
16530 | 400 | 
16531 | 401 |       {/* Delete confirmation dialog */}
16532 | 402 |       <Dialog open={!!deleteTarget} onOpenChange={(open) => !open && setDeleteTarget(null)}>
16533 | 403 |         <DialogContent>
16534 | 404 |           <DialogHeader>
16535 | 405 |             <DialogTitle>Usunac post?</DialogTitle>
16536 | 406 |             <DialogDescription>Ta operacja jest nieodwracalna.</DialogDescription>
16537 | 407 |           </DialogHeader>
16538 | 408 |           {deleteTarget && (
16539 | 409 |             <div className="py-4">
16540 | 410 |               <p className="font-medium">{deleteTarget.name || 'Bez nazwy'}</p>
16541 | 411 |               <p className="text-sm text-muted-foreground break-all mt-1">
16542 | 412 |                 {deleteTarget.url}
16543 | 413 |               </p>
16544 | 414 |             </div>
16545 | 415 |           )}
16546 | 416 |           <DialogFooter>
16547 | 417 |             <Button variant="outline" onClick={() => setDeleteTarget(null)}>
16548 | 418 |               Anuluj
16549 | 419 |             </Button>
16550 | 420 |             <Button variant="destructive" onClick={handleDelete} disabled={deleting}>
16551 | 421 |               {deleting ? 'Usuwanie...' : 'Usun'}
16552 | 422 |             </Button>
16553 | 423 |           </DialogFooter>
16554 | 424 |         </DialogContent>
16555 | 425 |       </Dialog>
16556 | 426 |     </div>
16557 | 427 |   )
16558 | 428 | }
16559 | 429 | 
16560 | ```
16561 | 
16562 | ---
16563 | 
16564 | ### üìÑ ≈öcie≈ºka: `src/panel/web/src/vite-env.d.ts`
16565 | **Typ:** TypeScript  
16566 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
16567 | 
16568 | ```ts
16569 | 1 | /// <reference types="vite/client" />
16570 | 2 | 
16571 | ```
16572 | 
16573 | ---
16574 | 
16575 | ### üìÑ ≈öcie≈ºka: `src/telegram.js`
16576 | **Typ:** JavaScript/tekst  
16577 | **Opis:** Plik projektu (kod/konfiguracja).  
16578 | 
16579 | ```js
16580 |   1 | // src/telegram.js
16581 |   2 | import axios from "axios";
16582 |   3 | import log from "./utils/logger.js";
16583 |   4 | 
16584 |   5 | /* ============================================================
16585 |   6 |    FILTR WIEKU KOMENTARZA (TELEGRAM)
16586 |   7 |    ============================================================ */
16587 |   8 | 
16588 |   9 | function parseFbRelativeTime(raw) {
16589 |  10 |   if (!raw) return null;
16590 |  11 |   const t = String(raw).toLowerCase().trim();
16591 |  12 |   const now = new Date();
16592 |  13 | 
16593 |  14 |   if (t.includes("przed chwilƒÖ")) return now;
16594 |  15 |   if (t.includes("w≈Ça≈õnie teraz") || t === "teraz" || t === "now" || t === "just now") return now;
16595 |  16 | 
16596 |  17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
16597 |  18 |     const d = new Date(now);
16598 |  19 |     d.setDate(d.getDate() - 1);
16599 |  20 |     return d;
16600 |  21 |   }
16601 |  22 | 
16602 |  23 |   // Obs≈Çugujemy polskie i angielskie skr√≥ty
16603 |  24 |   // np: 15 sek., 5 min, 2 godz., 1 dzie≈Ñ, 4 tyg., 4 weeks
16604 |  25 |   const m = t.match(/(\d+)\s*(sek\.?|s|sec|secs|second|seconds|min\.?|m|minut|minuty|minutƒô|godz\.?|h|hr|hour|hours|dni|dzie≈Ñ|d|tyg\.?|week|weeks)\b/);
16605 |  26 |   if (!m) return null;
16606 |  27 | 
16607 |  28 |   const value = parseInt(m[1], 10);
16608 |  29 |   if (!Number.isFinite(value)) return null;
16609 |  30 | 
16610 |  31 |   const unit = m[2];
16611 |  32 |   const d = new Date(now);
16612 |  33 | 
16613 |  34 |   if (unit.startsWith("sek") || unit === "s" || unit.startsWith("sec") || unit.startsWith("second")) d.setSeconds(d.getSeconds() - value);
16614 |  35 |   else if (unit.startsWith("min") || unit === "m") d.setMinutes(d.getMinutes() - value);
16615 |  36 |   else if (unit.startsWith("godz") || unit === "h" || unit === "hr" || unit.startsWith("hour")) d.setHours(d.getHours() - value);
16616 |  37 |   else if (unit.startsWith("dni") || unit.startsWith("dzie") || unit === "d") d.setDate(d.getDate() - value);
16617 |  38 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
16618 |  39 | 
16619 |  40 |   return d;
16620 |  41 | }
16621 |  42 | 
16622 |  43 | function shouldSendByAge(comment) {
16623 |  44 |   // ENV:
16624 |  45 |   // TELEGRAM_MAX_AGE_MIN=60
16625 |  46 |   // TELEGRAM_DROP_IF_NO_TIME=1  (domy≈õlnie: 1)
16626 |  47 |   const maxAgeMin = Number(process.env.TELEGRAM_MAX_AGE_MIN || 60);
16627 |  48 |   const dropIfNoTime = envBool("TELEGRAM_DROP_IF_NO_TIME", true);
16628 |  49 | 
16629 |  50 |   const rel = String(comment?.fb_time_raw || comment?.time || comment?.relative_time || "").trim();
16630 |  51 |   if (!rel) return !dropIfNoTime;
16631 |  52 | 
16632 |  53 |   const abs = parseFbRelativeTime(rel);
16633 |  54 |   if (!abs) return !dropIfNoTime;
16634 |  55 | 
16635 |  56 |   const ageMinutes = (Date.now() - abs.getTime()) / 60000;
16636 |  57 |   return ageMinutes <= maxAgeMin;
16637 |  58 | }
16638 |  59 | 
16639 |  60 | function envBool(name, def = false) {
16640 |  61 |   const v = String(process.env[name] ?? "").trim().toLowerCase();
16641 |  62 |   if (!v) return def;
16642 |  63 |   return ["1", "true", "yes", "tak", "y", "on"].includes(v);
16643 |  64 | }
16644 |  65 | 
16645 |  66 | function escapeHtml(s) {
16646 |  67 |   if (s == null) return "";
16647 |  68 |   return String(s)
16648 |  69 |     .replaceAll("&", "&amp;")
16649 |  70 |     .replaceAll("<", "&lt;")
16650 |  71 |     .replaceAll(">", "&gt;")
16651 |  72 |     .replaceAll('"', "&quot;");
16652 |  73 | }
16653 |  74 | 
16654 |  75 | function buildCaptionHtml(post, c) {
16655 |  76 |   const postName = escapeHtml(post?.name || "");
16656 |  77 |   const postDesc = escapeHtml(post?.description || "");
16657 |  78 |   const author = escapeHtml(c?.author || c?.name || "");
16658 |  79 |   const text = escapeHtml(c?.text || c?.message || "");
16659 |  80 |   const rel = escapeHtml(c?.fb_time_raw || c?.time || c?.relative_time || "");
16660 |  81 |   const url = String(post?.url || "").trim();
16661 |  82 | 
16662 |  83 |   const postLine = postDesc ? `${postName} ‚Äî ${postDesc}` : postName;
16663 |  84 | 
16664 |  85 |   return (
16665 |  86 |     `<b>üì© Nowy komentarz na Facebooku</b>\n\n` +
16666 |  87 |     `<b>üë§ Autor:</b>\n${author || "-"}\n\n` +
16667 |  88 |     `<b>üïí Czas:</b>\n${rel || "-"}\n\n` +
16668 |  89 |     `<b>üìù Tre≈õƒá:</b>\n${text || "-"}\n\n` +
16669 |  90 |     `<b>üìå Post:</b>\n${postLine || "-"}\n\n` +
16670 |  91 |     (url ? `<a href="${escapeHtml(url)}">üëâ Otw√≥rz post</a>` : "")
16671 |  92 |   );
16672 |  93 | }
16673 |  94 | 
16674 |  95 | async function tgRequest(token, method, payload) {
16675 |  96 |   const t = String(token || "").trim();
16676 |  97 |   if (!t) return { ok: false, error: "Brak tokena bota" };
16677 |  98 | 
16678 |  99 |   const endpoint = `https://api.telegram.org/bot${t}/${method}`;
16679 | 100 | 
16680 | 101 |   try {
16681 | 102 |     const res = await axios.post(endpoint, payload, { timeout: 15000 });
16682 | 103 |     if (res?.data?.ok) return { ok: true, data: res.data };
16683 | 104 |     return { ok: false, error: res?.data?.description || "Telegram error" };
16684 | 105 |   } catch (e) {
16685 | 106 |     return {
16686 | 107 |       ok: false,
16687 | 108 |       error: e?.response?.data?.description || e?.message || String(e),
16688 | 109 |     };
16689 | 110 |   }
16690 | 111 | }
16691 | 112 | 
16692 | 113 | async function sendMessage(token, chat_id, text, opts = {}) {
16693 | 114 |   const parse_mode = opts.parse_mode || "HTML";
16694 | 115 |   const disable_web_page_preview = !!opts.disable_web_page_preview;
16695 | 116 | 
16696 | 117 |   return tgRequest(token, "sendMessage", {
16697 | 118 |     chat_id,
16698 | 119 |     text,
16699 | 120 |     parse_mode,
16700 | 121 |     disable_web_page_preview,
16701 | 122 |   });
16702 | 123 | }
16703 | 124 | 
16704 | 125 | async function sendPhoto(token, chat_id, photo, caption, opts = {}) {
16705 | 126 |   const parse_mode = opts.parse_mode || "HTML";
16706 | 127 |   return tgRequest(token, "sendPhoto", {
16707 | 128 |     chat_id,
16708 | 129 |     photo,
16709 | 130 |     caption,
16710 | 131 |     parse_mode,
16711 | 132 |   });
16712 | 133 | }
16713 | 134 | 
16714 | 135 | function getTargets() {
16715 | 136 |   const sendOwner = envBool("TELEGRAM_SEND_TO_OWNER", true);
16716 | 137 |   const sendClient = envBool("TELEGRAM_SEND_TO_CLIENT", true);
16717 | 138 | 
16718 | 139 |   const ownerToken = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
16719 | 140 |   const ownerChat = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
16720 | 141 | 
16721 | 142 |   const clientToken = String(process.env.TELEGRAM_BOT_TOKEN_CLIENT || "").trim();
16722 | 143 |   const clientChat = String(process.env.TELEGRAM_CHAT_ID_CLIENT || "").trim();
16723 | 144 | 
16724 | 145 |   const targets = [];
16725 | 146 |   log.debug("TELEGRAM", "Targets config", {
16726 | 147 |     sendOwner,
16727 | 148 |     sendClient,
16728 | 149 |     ownerToken: ownerToken ? ownerToken.slice(0, 12) + "..." : null,
16729 | 150 |     ownerChat: ownerChat || null,
16730 | 151 |     clientToken: clientToken ? clientToken.slice(0, 12) + "..." : null,
16731 | 152 |     clientChat: clientChat || null,
16732 | 153 |   });
16733 | 154 | 
16734 | 155 |   if (sendOwner && ownerToken && ownerChat) {
16735 | 156 |     targets.push({ label: "OWNER", token: ownerToken, chat_id: ownerChat });
16736 | 157 |   } else if (sendOwner) {
16737 | 158 |     log.warn("TELEGRAM", "OWNER w≈ÇƒÖczony, ale brak tokena lub chat_id");
16738 | 159 |   }
16739 | 160 | 
16740 | 161 |   if (sendClient && clientToken && clientChat) {
16741 | 162 |     targets.push({ label: "CLIENT", token: clientToken, chat_id: clientChat });
16742 | 163 |   } else if (sendClient) {
16743 | 164 |     log.warn("TELEGRAM", "CLIENT w≈ÇƒÖczony, ale brak tokena lub chat_id");
16744 | 165 |   }
16745 | 166 | 
16746 | 167 |   return targets;
16747 | 168 | }
16748 | 169 | 
16749 | 170 | /**
16750 | 171 |  * 1 komentarz => wysy≈Çka na 2 Telegramy:
16751 | 172 |  * - Tw√≥j (Twoim botem)
16752 | 173 |  * - Klienta (botem klienta)
16753 | 174 |  */
16754 | 175 | async function sendTelegramLead(post, comment) {
16755 | 176 |   const targets = getTargets();
16756 | 177 |   if (!targets.length) return;
16757 | 178 | 
16758 | 179 |   const usePhoto = envBool("TELEGRAM_USE_PHOTO", true);
16759 | 180 |   const disablePreview = envBool("TELEGRAM_DISABLE_WEB_PAGE_PREVIEW", true);
16760 | 181 | 
16761 | 182 |   const caption = buildCaptionHtml(post, comment);
16762 | 183 |   const img = String(post?.image || "").trim();
16763 | 184 | 
16764 | 185 |   for (const t of targets) {
16765 | 186 |     if (usePhoto && img) {
16766 | 187 |       const r1 = await sendPhoto(t.token, t.chat_id, img, caption, {
16767 | 188 |         parse_mode: "HTML",
16768 | 189 |       });
16769 | 190 |       if (r1.ok) {
16770 | 191 |         log.dev("TELEGRAM", `Wys≈Çano lead (photo) ‚Üí ${t.label}`);
16771 | 192 |         await new Promise((r) => setTimeout(r, 350));
16772 | 193 |         continue;
16773 | 194 |       }
16774 | 195 |       log.dev("TELEGRAM", `sendPhoto failed (${t.label}) ‚Üí fallback`, { error: r1.error });
16775 | 196 |     }
16776 | 197 | 
16777 | 198 |     const r2 = await sendMessage(t.token, t.chat_id, caption, {
16778 | 199 |       parse_mode: "HTML",
16779 | 200 |       disable_web_page_preview: disablePreview,
16780 | 201 |     });
16781 | 202 | 
16782 | 203 |     if (r2.ok) log.dev("TELEGRAM", `Wys≈Çano lead (message) ‚Üí ${t.label}`);
16783 | 204 |     else log.error("TELEGRAM", `sendMessage error (${t.label}): ${r2.error}`);
16784 | 205 | 
16785 | 206 |     await new Promise((r) => setTimeout(r, 350));
16786 | 207 |   }
16787 | 208 | }
16788 | 209 | 
16789 | 210 | async function sendTelegramLeads(post, comments = []) {
16790 | 211 |   for (const c of comments) {
16791 | 212 |     await sendTelegramLead(post, c);
16792 | 213 |     await new Promise((r) => setTimeout(r, 250));
16793 | 214 |   }
16794 | 215 | }
16795 | 216 | 
16796 | 217 | /* ============================================================
16797 | 218 |    =======================  ALERTY OWNER  ======================
16798 | 219 |    ============================================================ */
16799 | 220 | 
16800 | 221 | let _lastAlertAt = 0;
16801 | 222 | let _lastAlertKey = "";
16802 | 223 | let _repeatCount = 0;
16803 | 224 | 
16804 | 225 | function shorten(s, max) {
16805 | 226 |   const x = String(s ?? "");
16806 | 227 |   if (x.length <= max) return x;
16807 | 228 |   return x.slice(0, max - 12) + "\n‚Ä¶(obciƒôto)‚Ä¶";
16808 | 229 | }
16809 | 230 | 
16810 | 231 | function makeAlertKey(title, msg) {
16811 | 232 |   const a = String(title || "").slice(0, 80);
16812 | 233 |   const b = String(msg || "").slice(0, 200);
16813 | 234 |   return `${a}::${b}`;
16814 | 235 | }
16815 | 236 | 
16816 | 237 | async function sendOwnerAlert(title, message, opts = {}) {
16817 | 238 |   if (!envBool("TG_ALERTS_ENABLED", true)) return;
16818 | 239 | 
16819 | 240 |   const token = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
16820 | 241 |   const chatId = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
16821 | 242 |   if (!token || !chatId) return;
16822 | 243 | 
16823 | 244 |   const cooldownSec = Number(process.env.TG_ALERTS_COOLDOWN_SEC || "120");
16824 | 245 |   const maxLen = Number(process.env.TG_ALERTS_MAXLEN || "3500");
16825 | 246 |   const tz = String(process.env.TG_ALERTS_TIMEZONE || "Europe/Warsaw").trim();
16826 | 247 | 
16827 | 248 |   const now = Date.now();
16828 | 249 |   const key = makeAlertKey(title, message);
16829 | 250 | 
16830 | 251 |   // Anti-spam: je≈õli to samo w k√≥≈Çko w cooldownie, nie spamuj ‚Äî tylko licz
16831 | 252 |   if (key === _lastAlertKey && now - _lastAlertAt < cooldownSec * 1000) {
16832 | 253 |     _repeatCount++;
16833 | 254 |     return;
16834 | 255 |   }
16835 | 256 | 
16836 | 257 |   // Je≈õli wcze≈õniej co≈õ siƒô powtarza≈Ço, do≈õlij podsumowanie
16837 | 258 |   if (_repeatCount > 0) {
16838 | 259 |     const summary = `<b>‚ö†Ô∏è PowtarzajƒÖce siƒô b≈Çƒôdy</b>\n\nPoprzedni alert powt√≥rzy≈Ç siƒô <b>${_repeatCount}</b> razy w kr√≥tkim czasie.`;
16839 | 260 |     await sendMessage(token, chatId, summary, { parse_mode: "HTML" }).catch(
16840 | 261 |       () => {}
16841 | 262 |     );
16842 | 263 |     _repeatCount = 0;
16843 | 264 |   }
16844 | 265 | 
16845 | 266 |   _lastAlertAt = now;
16846 | 267 |   _lastAlertKey = key;
16847 | 268 | 
16848 | 269 |   // Lokalny czas PL (nie UTC)
16849 | 270 |   const dt = new Date();
16850 | 271 |   const tsLocal = new Intl.DateTimeFormat("pl-PL", {
16851 | 272 |     timeZone: tz,
16852 | 273 |     year: "numeric",
16853 | 274 |     month: "2-digit",
16854 | 275 |     day: "2-digit",
16855 | 276 |     hour: "2-digit",
16856 | 277 |     minute: "2-digit",
16857 | 278 |     second: "2-digit",
16858 | 279 |   }).format(dt);
16859 | 280 | 
16860 | 281 |   // Dla pewno≈õci dopisujemy te≈º UTC (kr√≥tkie), ≈ºeby ≈Çatwiej by≈Ço debugowaƒá serwer
16861 | 282 |   const tsUtc = dt.toISOString().replace("T", " ").replace("Z", " UTC");
16862 | 283 | 
16863 | 284 |   const text =
16864 | 285 |     `<b>üö® FB_Watcher ‚Äì ALERT</b>\n` +
16865 | 286 |     `<b>üïí</b> ${escapeHtml(tsLocal)} (${escapeHtml(tz)})\n` +
16866 | 287 |     `<b>üåç</b> ${escapeHtml(tsUtc)}\n\n` +
16867 | 288 |     `<b>${escapeHtml(title || "B≈ÇƒÖd")}</b>\n\n` +
16868 | 289 |     `<pre>${escapeHtml(shorten(message, maxLen))}</pre>`;
16869 | 290 | 
16870 | 291 |   const r = await sendMessage(token, chatId, text, {
16871 | 292 |     parse_mode: "HTML",
16872 | 293 |     disable_web_page_preview: true,
16873 | 294 |   });
16874 | 295 | 
16875 | 296 |   if (!r.ok) {
16876 | 297 |     // nie r√≥b pƒôtli error->alert->error
16877 | 298 |     log.dev("TELEGRAM", `Alert nie wys≈Çany: ${r.error}`);
16878 | 299 |   }
16879 | 300 | }
16880 | 301 | 
16881 | 302 | 
16882 | 303 | export { sendTelegramLead, sendTelegramLeads, sendOwnerAlert };
16883 | 304 | 
16884 | ```
16885 | 
16886 | ---
16887 | 
16888 | ### üìÑ ≈öcie≈ºka: `src/utils/logger.js`
16889 | **Typ:** JavaScript/tekst  
16890 | **Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  
16891 | 
16892 | ```js
16893 |   1 | // src/utils/logger.js
16894 |   2 | // Ujednolicony system logowania z poziomami: SILENT(0), PROD(1), DEV(2), DEBUG(3)
16895 |   3 | 
16896 |   4 | /**
16897 |   5 |  * LOG_LEVEL:
16898 |   6 |  *   0 = SILENT - tylko b≈Çƒôdy krytyczne
16899 |   7 |  *   1 = PROD   - status cykli, nowe komentarze, b≈Çƒôdy (domy≈õlny)
16900 |   8 |  *   2 = DEV    - szczeg√≥≈Çy operacji, timings
16901 |   9 |  *   3 = DEBUG  - pe≈Çne dumpy, payloady, DOM info
16902 |  10 |  */
16903 |  11 | const LOG_LEVEL = Number(process.env.LOG_LEVEL ?? 1);
16904 |  12 | const LOG_TIMESTAMPS = process.env.LOG_TIMESTAMPS !== "false";
16905 |  13 | const LOG_COLORS = process.env.LOG_COLORS !== "false";
16906 |  14 | 
16907 |  15 | // ANSI kolory
16908 |  16 | const colors = {
16909 |  17 |   reset: "\x1b[0m",
16910 |  18 |   dim: "\x1b[2m",
16911 |  19 |   red: "\x1b[31m",
16912 |  20 |   green: "\x1b[32m",
16913 |  21 |   yellow: "\x1b[33m",
16914 |  22 |   blue: "\x1b[34m",
16915 |  23 |   magenta: "\x1b[35m",
16916 |  24 |   cyan: "\x1b[36m",
16917 |  25 |   white: "\x1b[37m",
16918 |  26 |   gray: "\x1b[90m",
16919 |  27 | };
16920 |  28 | 
16921 |  29 | // Kolory dla modu≈Ç√≥w
16922 |  30 | const moduleColors = {
16923 |  31 |   WATCHER: colors.cyan,
16924 |  32 |   NAV: colors.blue,
16925 |  33 |   "UI:post": colors.magenta,
16926 |  34 |   "UI:videos": colors.magenta,
16927 |  35 |   "UI:photo": colors.magenta,
16928 |  36 |   "UI:watch": colors.magenta,
16929 |  37 |   FILTER: colors.yellow,
16930 |  38 |   EXTRACT: colors.green,
16931 |  39 |   DEDUP: colors.gray,
16932 |  40 |   TELEGRAM: colors.blue,
16933 |  41 |   WEBHOOK: colors.blue,
16934 |  42 |   API: colors.cyan,
16935 |  43 |   COOKIES: colors.gray,
16936 |  44 |   LOGIN: colors.yellow,
16937 |  45 |   ERROR: colors.red,
16938 |  46 |   FAST: colors.green,
16939 |  47 | };
16940 |  48 | 
16941 |  49 | function c(color, text) {
16942 |  50 |   if (!LOG_COLORS) return text;
16943 |  51 |   return `${color}${text}${colors.reset}`;
16944 |  52 | }
16945 |  53 | 
16946 |  54 | function timestamp() {
16947 |  55 |   if (!LOG_TIMESTAMPS) return "";
16948 |  56 |   const now = new Date();
16949 |  57 |   const hh = String(now.getHours()).padStart(2, "0");
16950 |  58 |   const mm = String(now.getMinutes()).padStart(2, "0");
16951 |  59 |   const ss = String(now.getSeconds()).padStart(2, "0");
16952 |  60 |   return c(colors.dim, `[${hh}:${mm}:${ss}]`) + " ";
16953 |  61 | }
16954 |  62 | 
16955 |  63 | function formatModule(mod) {
16956 |  64 |   const color = moduleColors[mod] || colors.white;
16957 |  65 |   return c(color, `[${mod}]`);
16958 |  66 | }
16959 |  67 | 
16960 |  68 | function formatData(data) {
16961 |  69 |   if (data === undefined || data === null) return "";
16962 |  70 |   if (typeof data === "string") return ` ${c(colors.dim, data)}`;
16963 |  71 |   if (typeof data === "number") return ` ${c(colors.dim, String(data))}`;
16964 |  72 | 
16965 |  73 |   // Object - poka≈º kluczowe info
16966 |  74 |   try {
16967 |  75 |     const keys = Object.keys(data);
16968 |  76 |     if (keys.length === 0) return "";
16969 |  77 | 
16970 |  78 |     const parts = [];
16971 |  79 |     for (const k of keys.slice(0, 5)) {
16972 |  80 |       const v = data[k];
16973 |  81 |       if (v === undefined || v === null) continue;
16974 |  82 |       if (typeof v === "string" && v.length > 50) {
16975 |  83 |         parts.push(`${k}:"${v.slice(0, 47)}..."`);
16976 |  84 |       } else if (typeof v === "object") {
16977 |  85 |         parts.push(`${k}:{...}`);
16978 |  86 |       } else {
16979 |  87 |         parts.push(`${k}:${JSON.stringify(v)}`);
16980 |  88 |       }
16981 |  89 |     }
16982 |  90 |     if (keys.length > 5) parts.push(`+${keys.length - 5} more`);
16983 |  91 |     return ` ${c(colors.dim, `(${parts.join(", ")})`)}`;
16984 |  92 |   } catch {
16985 |  93 |     return "";
16986 |  94 |   }
16987 |  95 | }
16988 |  96 | 
16989 |  97 | function formatDataFull(data) {
16990 |  98 |   if (data === undefined || data === null) return "";
16991 |  99 |   try {
16992 | 100 |     return `\n${c(colors.dim, JSON.stringify(data, null, 2))}`;
16993 | 101 |   } catch {
16994 | 102 |     return "";
16995 | 103 |   }
16996 | 104 | }
16997 | 105 | 
16998 | 106 | /**
16999 | 107 |  * Logger g≈Ç√≥wny
17000 | 108 |  */
17001 | 109 | const log = {
17002 | 110 |   /** Poziom 0+ - B≈Çƒôdy krytyczne (zawsze pokazywane) */
17003 | 111 |   error(mod, msg, data) {
17004 | 112 |     const prefix = timestamp() + formatModule(mod || "ERROR");
17005 | 113 |     console.error(`${prefix} ${c(colors.red, "‚úó")} ${msg}${formatData(data)}`);
17006 | 114 |   },
17007 | 115 | 
17008 | 116 |   /** Poziom 0+ - Ostrze≈ºenia (zawsze pokazywane) */
17009 | 117 |   warn(mod, msg, data) {
17010 | 118 |     const prefix = timestamp() + formatModule(mod || "WARN");
17011 | 119 |     console.warn(`${prefix} ${c(colors.yellow, "‚ö†")} ${msg}${formatData(data)}`);
17012 | 120 |   },
17013 | 121 | 
17014 | 122 |   /** Poziom 1+ - PROD: Status cykli, nowe komentarze, kluczowe zdarzenia */
17015 | 123 |   prod(mod, msg, data) {
17016 | 124 |     if (LOG_LEVEL < 1) return;
17017 | 125 |     const prefix = timestamp() + formatModule(mod);
17018 | 126 |     console.log(`${prefix} ${msg}${formatData(data)}`);
17019 | 127 |   },
17020 | 128 | 
17021 | 129 |   /** Poziom 1+ - PROD z ikonƒÖ sukcesu */
17022 | 130 |   success(mod, msg, data) {
17023 | 131 |     if (LOG_LEVEL < 1) return;
17024 | 132 |     const prefix = timestamp() + formatModule(mod);
17025 | 133 |     console.log(`${prefix} ${c(colors.green, "‚úì")} ${msg}${formatData(data)}`);
17026 | 134 |   },
17027 | 135 | 
17028 | 136 |   /** Poziom 2+ - DEV: Szczeg√≥≈Çy operacji, timings */
17029 | 137 |   dev(mod, msg, data) {
17030 | 138 |     if (LOG_LEVEL < 2) return;
17031 | 139 |     const prefix = timestamp() + formatModule(mod);
17032 | 140 |     console.log(`${prefix} ${msg}${formatData(data)}`);
17033 | 141 |   },
17034 | 142 | 
17035 | 143 |   /** Poziom 3+ - DEBUG: Pe≈Çne dumpy, payloady, DOM info */
17036 | 144 |   debug(mod, msg, data) {
17037 | 145 |     if (LOG_LEVEL < 3) return;
17038 | 146 |     const prefix = timestamp() + formatModule(mod);
17039 | 147 |     console.log(`${prefix} ${c(colors.gray, "[DBG]")} ${msg}${formatDataFull(data)}`);
17040 | 148 |   },
17041 | 149 | 
17042 | 150 |   /** Separator wizualny (poziom 1+) */
17043 | 151 |   separator(char = "‚îÄ", length = 50) {
17044 | 152 |     if (LOG_LEVEL < 1) return;
17045 | 153 |     console.log(c(colors.dim, char.repeat(length)));
17046 | 154 |   },
17047 | 155 | 
17048 | 156 |   /** Nag≈Ç√≥wek sekcji (poziom 1+) */
17049 | 157 |   header(title) {
17050 | 158 |     if (LOG_LEVEL < 1) return;
17051 | 159 |     console.log("");
17052 | 160 |     console.log(c(colors.cyan, `‚ïê‚ïê‚ïê ${title} ${"‚ïê".repeat(Math.max(0, 44 - title.length))}`));
17053 | 161 |   },
17054 | 162 | 
17055 | 163 |   /** Podsumowanie cyklu (poziom 1+) */
17056 | 164 |   cycleSummary({ cycle, posts, newComments, duration, errors = 0, cacheSize = 0, cacheEntries = 0, totalKnownIds = 0 }) {
17057 | 165 |     if (LOG_LEVEL < 1) return;
17058 | 166 |     const prefix = timestamp() + formatModule("WATCHER");
17059 | 167 |     const status = errors > 0 ? c(colors.yellow, `‚ö† ${errors} err`) : c(colors.green, "‚úì");
17060 | 168 |     const durationStr = duration ? ` (${(duration / 1000).toFixed(1)}s)` : "";
17061 | 169 |     console.log(
17062 | 170 |       `${prefix} Cykl #${cycle} done: ${posts} post√≥w, ${c(colors.green, `+${newComments}`)} nowych${durationStr} ${status}`
17063 | 171 |     );
17064 | 172 | 
17065 | 173 |     // Metryki cache (poziom 2+ - DEV)
17066 | 174 |     if (LOG_LEVEL >= 2 && (cacheSize > 0 || totalKnownIds > 0)) {
17067 | 175 |       const cacheSizeStr = cacheSize > 0 ? `${Math.round(cacheSize / 1024)}KB` : "0KB";
17068 | 176 |       console.log(
17069 | 177 |         `${prefix} ${c(colors.dim, `Cache: ${cacheSizeStr}, ${cacheEntries} post√≥w, ${totalKnownIds} knownIds`)}`
17070 | 178 |       );
17071 | 179 |     }
17072 | 180 |   },
17073 | 181 | 
17074 | 182 |   /** Aktualny poziom logowania */
17075 | 183 |   get level() {
17076 | 184 |     return LOG_LEVEL;
17077 | 185 |   },
17078 | 186 | 
17079 | 187 |   /** Czy dany poziom jest w≈ÇƒÖczony */
17080 | 188 |   isEnabled(level) {
17081 | 189 |     return LOG_LEVEL >= level;
17082 | 190 |   },
17083 | 191 | };
17084 | 192 | 
17085 | 193 | // Sta≈Çe poziom√≥w do eksportu
17086 | 194 | const LEVELS = {
17087 | 195 |   SILENT: 0,
17088 | 196 |   PROD: 1,
17089 | 197 |   DEV: 2,
17090 | 198 |   DEBUG: 3,
17091 | 199 | };
17092 | 200 | 
17093 | 201 | export { log, LEVELS };
17094 | 202 | export default log;
17095 | 203 | 
17096 | ```
17097 | 
17098 | ---
17099 | 
17100 | ### üìÑ ≈öcie≈ºka: `src/utils/mouse.js`
17101 | **Typ:** JavaScript/tekst  
17102 | **Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  
17103 | 
17104 | ```js
17105 |   1 | // src/utils/mouse.js
17106 |   2 | // Human Behavior Mode - symulacja ruch√≥w myszy krzywymi Beziera
17107 |   3 | 
17108 |   4 | import { gaussianRandom, sleep } from "./sleep.js";
17109 |   5 | 
17110 |   6 | /**
17111 |   7 |  * Oblicza punkt na krzywej Beziera (3. stopnia)
17112 |   8 |  * @param {number} t - parametr 0-1
17113 |   9 |  * @param {number} p0 - punkt startowy
17114 |  10 |  * @param {number} p1 - punkt kontrolny 1
17115 |  11 |  * @param {number} p2 - punkt kontrolny 2
17116 |  12 |  * @param {number} p3 - punkt ko≈Ñcowy
17117 |  13 |  * @returns {number}
17118 |  14 |  */
17119 |  15 | function bezierPoint(t, p0, p1, p2, p3) {
17120 |  16 |   const u = 1 - t;
17121 |  17 |   return (
17122 |  18 |     u * u * u * p0 +
17123 |  19 |     3 * u * u * t * p1 +
17124 |  20 |     3 * u * t * t * p2 +
17125 |  21 |     t * t * t * p3
17126 |  22 |   );
17127 |  23 | }
17128 |  24 | 
17129 |  25 | /**
17130 |  26 |  * Generuje ≈õcie≈ºkƒô ruchu myszy miƒôdzy dwoma punktami
17131 |  27 |  * u≈ºywajƒÖc krzywej Beziera z losowymi punktami kontrolnymi
17132 |  28 |  * @param {number} startX
17133 |  29 |  * @param {number} startY
17134 |  30 |  * @param {number} endX
17135 |  31 |  * @param {number} endY
17136 |  32 |  * @param {number} steps - liczba krok√≥w (wiƒôcej = p≈Çynniej)
17137 |  33 |  * @returns {Array<{x: number, y: number}>}
17138 |  34 |  */
17139 |  35 | function generateBezierPath(startX, startY, endX, endY, steps = 25) {
17140 |  36 |   const path = [];
17141 |  37 | 
17142 |  38 |   // Losowe punkty kontrolne - dodajƒÖ "ludzkƒÖ" krzywo≈õƒá
17143 |  39 |   const dx = endX - startX;
17144 |  40 |   const dy = endY - startY;
17145 |  41 |   const distance = Math.sqrt(dx * dx + dy * dy);
17146 |  42 | 
17147 |  43 |   // Punkty kontrolne odsuniƒôte o 20-40% odleg≈Ço≈õci w losowym kierunku
17148 |  44 |   const offset1 = gaussianRandom(distance * 0.3, distance * 0.1);
17149 |  45 |   const angle1 = Math.random() * Math.PI * 2;
17150 |  46 |   const cp1x = startX + dx * 0.3 + Math.cos(angle1) * offset1;
17151 |  47 |   const cp1y = startY + dy * 0.3 + Math.sin(angle1) * offset1;
17152 |  48 | 
17153 |  49 |   const offset2 = gaussianRandom(distance * 0.3, distance * 0.1);
17154 |  50 |   const angle2 = Math.random() * Math.PI * 2;
17155 |  51 |   const cp2x = startX + dx * 0.7 + Math.cos(angle2) * offset2;
17156 |  52 |   const cp2y = startY + dy * 0.7 + Math.sin(angle2) * offset2;
17157 |  53 | 
17158 |  54 |   for (let i = 0; i <= steps; i++) {
17159 |  55 |     const t = i / steps;
17160 |  56 | 
17161 |  57 |     // Easing - wolniej na poczƒÖtku i ko≈Ñcu (naturalny ruch)
17162 |  58 |     const easedT = t < 0.5
17163 |  59 |       ? 2 * t * t
17164 |  60 |       : 1 - Math.pow(-2 * t + 2, 2) / 2;
17165 |  61 | 
17166 |  62 |     const x = bezierPoint(easedT, startX, cp1x, cp2x, endX);
17167 |  63 |     const y = bezierPoint(easedT, startY, cp1y, cp2y, endY);
17168 |  64 | 
17169 |  65 |     path.push({ x: Math.round(x), y: Math.round(y) });
17170 |  66 |   }
17171 |  67 | 
17172 |  68 |   return path;
17173 |  69 | }
17174 |  70 | 
17175 |  71 | /**
17176 |  72 |  * Przesuwa mysz wzd≈Çu≈º ≈õcie≈ºki Beziera
17177 |  73 |  * @param {import('puppeteer').Page} page
17178 |  74 |  * @param {number} startX
17179 |  75 |  * @param {number} startY
17180 |  76 |  * @param {number} endX
17181 |  77 |  * @param {number} endY
17182 |  78 |  * @returns {Promise<void>}
17183 |  79 |  */
17184 |  80 | async function moveMouse(page, startX, startY, endX, endY) {
17185 |  81 |   const distance = Math.sqrt(
17186 |  82 |     Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)
17187 |  83 |   );
17188 |  84 | 
17189 |  85 |   // Wiƒôcej krok√≥w dla d≈Çu≈ºszych ruch√≥w
17190 |  86 |   const steps = Math.max(15, Math.min(50, Math.round(distance / 15)));
17191 |  87 |   const path = generateBezierPath(startX, startY, endX, endY, steps);
17192 |  88 | 
17193 |  89 |   for (const point of path) {
17194 |  90 |     await page.mouse.move(point.x, point.y);
17195 |  91 | 
17196 |  92 |     // Losowe op√≥≈∫nienie miƒôdzy ruchami (5-15ms)
17197 |  93 |     const moveDelay = gaussianRandom(10, 3);
17198 |  94 |     await sleep(Math.max(3, Math.min(20, moveDelay)));
17199 |  95 |   }
17200 |  96 | }
17201 |  97 | 
17202 |  98 | /**
17203 |  99 |  * Pobiera pozycjƒô ≈õrodka elementu
17204 | 100 |  * @param {import('puppeteer').ElementHandle} element
17205 | 101 |  * @returns {Promise<{x: number, y: number}>}
17206 | 102 |  */
17207 | 103 | async function getElementCenter(element) {
17208 | 104 |   const box = await element.boundingBox();
17209 | 105 |   if (!box) return null;
17210 | 106 | 
17211 | 107 |   return {
17212 | 108 |     x: box.x + box.width / 2,
17213 | 109 |     y: box.y + box.height / 2,
17214 | 110 |   };
17215 | 111 | }
17216 | 112 | 
17217 | 113 | /**
17218 | 114 |  * Przesuwa mysz do elementu u≈ºywajƒÖc krzywej Beziera
17219 | 115 |  * @param {import('puppeteer').Page} page
17220 | 116 |  * @param {import('puppeteer').ElementHandle} element
17221 | 117 |  * @returns {Promise<boolean>} - true je≈õli sukces
17222 | 118 |  */
17223 | 119 | async function moveToElement(page, element) {
17224 | 120 |   try {
17225 | 121 |     const target = await getElementCenter(element);
17226 | 122 |     if (!target) return false;
17227 | 123 | 
17228 | 124 |     // Pobierz aktualnƒÖ pozycjƒô myszy (domy≈õlnie ≈õrodek ekranu)
17229 | 125 |     const viewport = page.viewport();
17230 | 126 |     const currentX = viewport ? viewport.width / 2 : 500;
17231 | 127 |     const currentY = viewport ? viewport.height / 2 : 300;
17232 | 128 | 
17233 | 129 |     // Dodaj ma≈ÇƒÖ losowo≈õƒá do punktu docelowego (nie celuj idealnie w ≈õrodek)
17234 | 130 |     const offsetX = gaussianRandom(0, 3);
17235 | 131 |     const offsetY = gaussianRandom(0, 3);
17236 | 132 | 
17237 | 133 |     await moveMouse(
17238 | 134 |       page,
17239 | 135 |       currentX,
17240 | 136 |       currentY,
17241 | 137 |       target.x + offsetX,
17242 | 138 |       target.y + offsetY
17243 | 139 |     );
17244 | 140 | 
17245 | 141 |     return true;
17246 | 142 |   } catch {
17247 | 143 |     return false;
17248 | 144 |   }
17249 | 145 | }
17250 | 146 | 
17251 | 147 | /**
17252 | 148 |  * Human-like klikniƒôcie - ruch myszy + klik z ma≈Çym op√≥≈∫nieniem
17253 | 149 |  * @param {import('puppeteer').Page} page
17254 | 150 |  * @param {import('puppeteer').ElementHandle} element
17255 | 151 |  * @returns {Promise<boolean>} - true je≈õli sukces
17256 | 152 |  */
17257 | 153 | async function humanClick(page, element) {
17258 | 154 |   try {
17259 | 155 |     // Ruch do elementu
17260 | 156 |     const moved = await moveToElement(page, element);
17261 | 157 |     if (!moved) {
17262 | 158 |       // Fallback do normalnego kliku
17263 | 159 |       await element.click().catch(() => {});
17264 | 160 |       return true;
17265 | 161 |     }
17266 | 162 | 
17267 | 163 |     // Ma≈Çe op√≥≈∫nienie przed klikiem (50-150ms)
17268 | 164 |     const preClickDelay = gaussianRandom(100, 30);
17269 | 165 |     await sleep(Math.max(40, Math.min(200, preClickDelay)));
17270 | 166 | 
17271 | 167 |     // Klik
17272 | 168 |     await page.mouse.click(
17273 | 169 |       (await getElementCenter(element)).x,
17274 | 170 |       (await getElementCenter(element)).y
17275 | 171 |     );
17276 | 172 | 
17277 | 173 |     // Ma≈Çe op√≥≈∫nienie po kliku (30-100ms)
17278 | 174 |     const postClickDelay = gaussianRandom(60, 20);
17279 | 175 |     await sleep(Math.max(20, Math.min(120, postClickDelay)));
17280 | 176 | 
17281 | 177 |     return true;
17282 | 178 |   } catch {
17283 | 179 |     // Fallback
17284 | 180 |     await element.click().catch(() => {});
17285 | 181 |     return true;
17286 | 182 |   }
17287 | 183 | }
17288 | 184 | 
17289 | 185 | /**
17290 | 186 |  * Losowy ruch myszy - symuluje "rozglƒÖdanie siƒô" po stronie
17291 | 187 |  * @param {import('puppeteer').Page} page
17292 | 188 |  * @returns {Promise<void>}
17293 | 189 |  */
17294 | 190 | async function randomMouseMovement(page) {
17295 | 191 |   try {
17296 | 192 |     const viewport = page.viewport();
17297 | 193 |     if (!viewport) return;
17298 | 194 | 
17299 | 195 |     // Losowy punkt na stronie
17300 | 196 |     const targetX = gaussianRandom(viewport.width / 2, viewport.width / 4);
17301 | 197 |     const targetY = gaussianRandom(viewport.height / 2, viewport.height / 4);
17302 | 198 | 
17303 | 199 |     // Clamp do viewport
17304 | 200 |     const clampedX = Math.max(50, Math.min(viewport.width - 50, targetX));
17305 | 201 |     const clampedY = Math.max(50, Math.min(viewport.height - 50, targetY));
17306 | 202 | 
17307 | 203 |     const currentX = viewport.width / 2;
17308 | 204 |     const currentY = viewport.height / 2;
17309 | 205 | 
17310 | 206 |     await moveMouse(page, currentX, currentY, clampedX, clampedY);
17311 | 207 |   } catch {
17312 | 208 |     // Ignoruj b≈Çƒôdy - to tylko dodatkowa symulacja
17313 | 209 |   }
17314 | 210 | }
17315 | 211 | 
17316 | 212 | export {
17317 | 213 |   generateBezierPath,
17318 | 214 |   moveMouse,
17319 | 215 |   moveToElement,
17320 | 216 |   humanClick,
17321 | 217 |   randomMouseMovement,
17322 | 218 | };
17323 | 219 | 
17324 | ```
17325 | 
17326 | ---
17327 | 
17328 | ### üìÑ ≈öcie≈ºka: `src/utils/navigation.js`
17329 | **Typ:** JavaScript/tekst  
17330 | **Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  
17331 | 
17332 | ```js
17333 |  1 | // src/utils/navigation.js
17334 |  2 | import { sleepRandom } from "./sleep.js";
17335 |  3 | import log from "./logger.js";
17336 |  4 | 
17337 |  5 | /**
17338 |  6 |  * Bezpieczne page.goto z retry.
17339 |  7 |  * - pr√≥buje kilka razy
17340 |  8 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
17341 |  9 |  */
17342 | 10 | export async function safeGoto(page, url, label = "goto", options = {}) {
17343 | 11 |   const MAX_ATTEMPTS = 3;
17344 | 12 | 
17345 | 13 |   const finalOptions = {
17346 | 14 |     waitUntil: "networkidle2",
17347 | 15 |     timeout: 90000, // 90s
17348 | 16 |     ...options,
17349 | 17 |   };
17350 | 18 | 
17351 | 19 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
17352 | 20 |     try {
17353 | 21 |       log.debug("NAV", `[${label}] Pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`);
17354 | 22 | 
17355 | 23 |       // === FORCE DESKTOP PROFILE (SERVER FIX) ===
17356 | 24 |       await page.setViewport({ width: 1366, height: 768 });
17357 | 25 |       // DISABLED UA // === END FORCE DESKTOP PROFILE ===
17358 | 26 | 
17359 | 27 |       await page.goto(url, finalOptions);
17360 | 28 | 
17361 | 29 |       log.debug("NAV", `[${label}] OK na pr√≥bie ${attempt}`);
17362 | 30 |       return true;
17363 | 31 |     } catch (err) {
17364 | 32 |       log.warn("NAV", `[${label}] B≈ÇƒÖd pr√≥ba ${attempt}: ${err.message}`);
17365 | 33 | 
17366 | 34 |       if (attempt === MAX_ATTEMPTS) {
17367 | 35 |         return false;
17368 | 36 |       }
17369 | 37 | 
17370 | 38 |       await sleepRandom(3000, 7000);
17371 | 39 | 
17372 | 40 |       try {
17373 | 41 |         log.debug("NAV", "Pr√≥ba od≈õwie≈ºenia FB...");
17374 | 42 |         await page
17375 | 43 |           .goto("https://www.facebook.com/", {
17376 | 44 |             waitUntil: "load",
17377 | 45 |             timeout: 45000,
17378 | 46 |           })
17379 | 47 |           .catch(() => {});
17380 | 48 |       } catch (e2) {
17381 | 49 |         log.warn("NAV", `Od≈õwie≈ºenie FB te≈º b≈ÇƒÖd: ${e2.message}`);
17382 | 50 |       }
17383 | 51 |     }
17384 | 52 |   }
17385 | 53 | 
17386 | 54 |   // tu w praktyce nie dojdziemy
17387 | 55 |   return false;
17388 | 56 | }
17389 | 57 | 
17390 | ```
17391 | 
17392 | ---
17393 | 
17394 | ### üìÑ ≈öcie≈ºka: `src/utils/sleep.js`
17395 | **Typ:** JavaScript/tekst  
17396 | **Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  
17397 | 
17398 | ```js
17399 |   1 | // src/utils/sleep.js
17400 |   2 | // Human Behavior Mode - op√≥≈∫nienia symulujƒÖce cz≈Çowieka
17401 |   3 | 
17402 |   4 | /**
17403 |   5 |  * Podstawowy sleep
17404 |   6 |  */
17405 |   7 | function sleep(ms) {
17406 |   8 |   return new Promise((res) => setTimeout(res, ms));
17407 |   9 | }
17408 |  10 | 
17409 |  11 | /**
17410 |  12 |  * Sleep z losowym op√≥≈∫nieniem (jednolity rozk≈Çad)
17411 |  13 |  */
17412 |  14 | function sleepRandom(minMs, maxMs) {
17413 |  15 |   const delta = maxMs - minMs;
17414 |  16 |   const extra = Math.random() * delta;
17415 |  17 |   return sleep(minMs + extra);
17416 |  18 | }
17417 |  19 | 
17418 |  20 | /**
17419 |  21 |  * Generuje losowƒÖ warto≈õƒá z rozk≈Çadu normalnego (Gaussa)
17420 |  22 |  * Box-Muller transform
17421 |  23 |  * @param {number} mean - ≈õrednia
17422 |  24 |  * @param {number} stdDev - odchylenie standardowe
17423 |  25 |  * @returns {number}
17424 |  26 |  */
17425 |  27 | function gaussianRandom(mean, stdDev) {
17426 |  28 |   let u1, u2;
17427 |  29 |   do {
17428 |  30 |     u1 = Math.random();
17429 |  31 |     u2 = Math.random();
17430 |  32 |   } while (u1 === 0); // u1 nie mo≈ºe byƒá 0
17431 |  33 | 
17432 |  34 |   const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
17433 |  35 |   return mean + z * stdDev;
17434 |  36 | }
17435 |  37 | 
17436 |  38 | /**
17437 |  39 |  * Ludzkie op√≥≈∫nienie z rozk≈Çadem Gaussa
17438 |  40 |  * @param {number} baseMs - bazowe op√≥≈∫nienie (≈õrednia)
17439 |  41 |  * @param {number} variance - wariancja jako procent (0.0-1.0)
17440 |  42 |  * @returns {Promise<void>}
17441 |  43 |  */
17442 |  44 | async function humanDelay(baseMs, variance = 0.3) {
17443 |  45 |   const stdDev = baseMs * variance;
17444 |  46 |   let delay = gaussianRandom(baseMs, stdDev);
17445 |  47 | 
17446 |  48 |   // Clamp do rozsƒÖdnych warto≈õci (50% - 200% ≈õredniej)
17447 |  49 |   delay = Math.max(baseMs * 0.5, Math.min(baseMs * 2, delay));
17448 |  50 | 
17449 |  51 |   return sleep(delay);
17450 |  52 | }
17451 |  53 | 
17452 |  54 | /**
17453 |  55 |  * Op√≥≈∫nienie przy pisaniu - symuluje ludzkƒÖ szybko≈õƒá
17454 |  56 |  * ≈örednio ~120ms na znak, z mikro-pauzami
17455 |  57 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
17456 |  58 |  */
17457 |  59 | async function humanTypingDelay() {
17458 |  60 |   // Rozk≈Çad: ≈õrednia 120ms, stdDev 40ms
17459 |  61 |   let delay = gaussianRandom(120, 40);
17460 |  62 | 
17461 |  63 |   // Clamp: 60-250ms na znak
17462 |  64 |   delay = Math.max(60, Math.min(250, delay));
17463 |  65 | 
17464 |  66 |   // 5% szansa na mikro-pauzƒô (jakby cz≈Çowiek my≈õla≈Ç)
17465 |  67 |   if (Math.random() < 0.05) {
17466 |  68 |     delay += gaussianRandom(300, 100);
17467 |  69 |   }
17468 |  70 | 
17469 |  71 |   await sleep(delay);
17470 |  72 |   return delay;
17471 |  73 | }
17472 |  74 | 
17473 |  75 | /**
17474 |  76 |  * Pauza miƒôdzy postami - 3-8 sekund z rozk≈Çadem Gaussa
17475 |  77 |  * @returns {Promise<number>} - zwraca u≈ºyte op√≥≈∫nienie w ms
17476 |  78 |  */
17477 |  79 | async function betweenPostsPause() {
17478 |  80 |   // ≈örednia 5.5s, stdDev 1.2s ‚Üí wiƒôkszo≈õƒá w zakresie 3-8s
17479 |  81 |   let delay = gaussianRandom(5500, 1200);
17480 |  82 | 
17481 |  83 |   // Clamp: 3-10 sekund
17482 |  84 |   delay = Math.max(3000, Math.min(10000, delay));
17483 |  85 | 
17484 |  86 |   await sleep(delay);
17485 |  87 |   return delay;
17486 |  88 | }
17487 |  89 | 
17488 |  90 | /**
17489 |  91 |  * Wpisuje tekst znak po znaku z ludzkimi op√≥≈∫nieniami
17490 |  92 |  * @param {import('puppeteer').ElementHandle} element - input element
17491 |  93 |  * @param {string} text - tekst do wpisania
17492 |  94 |  * @param {import('puppeteer').Page} page - strona (do keyboard)
17493 |  95 |  * @returns {Promise<void>}
17494 |  96 |  */
17495 |  97 | async function humanType(element, text, page) {
17496 |  98 |   for (let i = 0; i < text.length; i++) {
17497 |  99 |     const char = text[i];
17498 | 100 | 
17499 | 101 |     // Wpisz znak
17500 | 102 |     await page.keyboard.type(char);
17501 | 103 | 
17502 | 104 |     // Op√≥≈∫nienie miƒôdzy znakami
17503 | 105 |     await humanTypingDelay();
17504 | 106 |   }
17505 | 107 | }
17506 | 108 | 
17507 | 109 | /**
17508 | 110 |  * Fisher-Yates shuffle - randomizacja tablicy
17509 | 111 |  * @param {Array} array - tablica do pomieszania
17510 | 112 |  * @returns {Array} - nowa, pomieszana tablica
17511 | 113 |  */
17512 | 114 | function shuffleArray(array) {
17513 | 115 |   const shuffled = [...array];
17514 | 116 |   for (let i = shuffled.length - 1; i > 0; i--) {
17515 | 117 |     const j = Math.floor(Math.random() * (i + 1));
17516 | 118 |     [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
17517 | 119 |   }
17518 | 120 |   return shuffled;
17519 | 121 | }
17520 | 122 | 
17521 | 123 | export {
17522 | 124 |   sleep,
17523 | 125 |   sleepRandom,
17524 | 126 |   gaussianRandom,
17525 | 127 |   humanDelay,
17526 | 128 |   humanTypingDelay,
17527 | 129 |   betweenPostsPause,
17528 | 130 |   humanType,
17529 | 131 |   shuffleArray,
17530 | 132 | };
17531 | 133 | 
17532 | ```
17533 | 
17534 | ---
17535 | 
17536 | ### üìÑ ≈öcie≈ºka: `src/utils/time.js`
17537 | **Typ:** JavaScript/tekst  
17538 | **Opis:** Utility helpers (sleep, nawigacja, parsowanie, itp.).  
17539 | 
17540 | ```js
17541 |  1 | // src/utils/time.js
17542 |  2 | import log from "./logger.js";
17543 |  3 | 
17544 |  4 | /**
17545 |  5 |  * Parser wzglƒôdnego czasu FB ‚Üí Date
17546 |  6 |  * np. "2 min", "3 godz", "wczoraj"
17547 |  7 |  */
17548 |  8 | export function parseFbRelativeTime(raw) {
17549 |  9 |   if (!raw) return null;
17550 | 10 | 
17551 | 11 |   const t = raw.toLowerCase().trim();
17552 | 12 |   const now = new Date();
17553 | 13 | 
17554 | 14 |   if (t.includes("przed chwilƒÖ") || t === "teraz" || t === "now" || t === "just now") {
17555 | 15 |     return now;
17556 | 16 |   }
17557 | 17 | 
17558 | 18 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
17559 | 19 |     const d = new Date(now);
17560 | 20 |     d.setDate(d.getDate() - 1);
17561 | 21 |     return d;
17562 | 22 |   }
17563 | 23 | 
17564 | 24 |   const m = t.match(/(\d+)\s*(sek|sec|min|minut|godz|hour|h|dni|day|tyg|week)/i);
17565 | 25 |   if (!m) return null;
17566 | 26 | 
17567 | 27 |   const value = parseInt(m[1], 10);
17568 | 28 |   if (!Number.isFinite(value)) return null;
17569 | 29 | 
17570 | 30 |   const unit = m[2].toLowerCase();
17571 | 31 |   const d = new Date(now);
17572 | 32 | 
17573 | 33 |   if (unit.startsWith("sek") || unit.startsWith("sec")) d.setSeconds(d.getSeconds() - value);
17574 | 34 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
17575 | 35 |   else if (unit.startsWith("godz") || unit.startsWith("hour") || unit === "h") d.setHours(d.getHours() - value);
17576 | 36 |   else if (unit.startsWith("dni") || unit.startsWith("day")) d.setDate(d.getDate() - value);
17577 | 37 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
17578 | 38 | 
17579 | 39 |   return d;
17580 | 40 | }
17581 | 41 | 
17582 | 42 | /**
17583 | 43 |  * Filtruje komentarze - zostawia tylko te m≈Çodsze ni≈º maxAgeMin
17584 | 44 |  */
17585 | 45 | export function filterByAge(comments, maxAgeMin = 60) {
17586 | 46 |   const now = Date.now();
17587 | 47 | 
17588 | 48 |   return comments.filter((c) => {
17589 | 49 |     const rel = (c?.fb_time_raw || c?.time || "").trim();
17590 | 50 |     if (!rel) return false;
17591 | 51 | 
17592 | 52 |     const abs = parseFbRelativeTime(rel);
17593 | 53 |     if (!abs) return false;
17594 | 54 | 
17595 | 55 |     const ageMinutes = (now - abs.getTime()) / 60000;
17596 | 56 |     log.debug("TIME", "Age filter", {
17597 | 57 |       raw: rel,
17598 | 58 |       ageMin: Math.round(ageMinutes * 10) / 10,
17599 | 59 |       maxAgeMin,
17600 | 60 |     });
17601 | 61 |     return ageMinutes <= maxAgeMin;
17602 | 62 |   });
17603 | 63 | }
17604 | 64 | 
17605 | ```
17606 | 
17607 | ---
17608 | 
17609 | ### üìÑ ≈öcie≈ºka: `src/watcher.js`
17610 | **Typ:** JavaScript/tekst  
17611 | **Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  
17612 | 
17613 | ```js
17614 |    1 | // src/watcher.js
17615 |    2 | import puppeteer from "puppeteer-extra";
17616 |    3 | import StealthPlugin from "puppeteer-extra-plugin-stealth";
17617 |    4 | import RecaptchaPlugin from "puppeteer-extra-plugin-recaptcha";
17618 |    5 | 
17619 |    6 | // Stealth Plugin - ukrywa automatyzacjƒô (ZAWSZE pierwszy)
17620 |    7 | puppeteer.use(StealthPlugin());
17621 |    8 | console.log("[STEALTH] Plugin stealth w≈ÇƒÖczony");
17622 |    9 | import fs from "fs";
17623 |   10 | import path from "path";
17624 |   11 | import {
17625 |   12 |   EXPAND_COMMENTS,
17626 |   13 |   CHECK_INTERVAL_MS,
17627 |   14 |   POSTS_SHEET_URL,
17628 |   15 |   POSTS_REFRESH_MS,
17629 |   16 |   FAST_MODE,
17630 |   17 |   FAST_MAX_AGE_MIN,
17631 |   18 |   POSTS_API_URL,
17632 |   19 |   POSTS_API_TOKEN,
17633 |   20 |   CAPTCHA_API_KEY,
17634 |   21 |   CAPTCHA_ENABLED,
17635 |   22 |   REMOTE_DEBUG_PORT,
17636 |   23 |   HUMAN_MODE,
17637 |   24 |   PROXY_URL,
17638 |   25 | } from "./config.js";
17639 |   26 | 
17640 |   27 | // Konfiguracja captcha solver (2Captcha)
17641 |   28 | if (CAPTCHA_ENABLED && CAPTCHA_API_KEY) {
17642 |   29 |   puppeteer.use(
17643 |   30 |     RecaptchaPlugin({
17644 |   31 |       provider: {
17645 |   32 |         id: "2captcha",
17646 |   33 |         token: CAPTCHA_API_KEY,
17647 |   34 |       },
17648 |   35 |       visualFeedback: true,
17649 |   36 |     })
17650 |   37 |   );
17651 |   38 |   console.log("[CAPTCHA] 2Captcha solver w≈ÇƒÖczony");
17652 |   39 | }
17653 |   40 | 
17654 |   41 | import {
17655 |   42 |   prepare,
17656 |   43 |   getCommentCount,
17657 |   44 |   loadAllComments,
17658 |   45 |   extractCommentsData,
17659 |   46 |   switchCommentsFilterToNewest,
17660 |   47 | } from "./fb/comments.js";
17661 |   48 | 
17662 |   49 | import { loadCookies, saveCookies } from "./fb/cookies.js";
17663 |   50 | import { checkIfLogged, fbLogin, solveCaptchaIfPresent } from "./fb/login.js";
17664 |   51 | import { isCheckpoint, getCheckpointType } from "./fb/checkpoint.js";
17665 |   52 | import { parseFbRelativeTime, filterByAge } from "./utils/time.js";
17666 |   53 | import { shuffleArray, betweenPostsPause } from "./utils/sleep.js";
17667 |   54 | import { loadCache, saveCache, getCacheSize, getCacheEntryCount } from "./db/cache.js";
17668 |   55 | import { sendTelegramLeads, sendOwnerAlert } from "./telegram.js";
17669 |   56 | import log from "./utils/logger.js";
17670 |   57 | 
17671 |   58 | /**
17672 |   59 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
17673 |   60 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
17674 |   61 |  */
17675 |   62 | const POSTS_FILE =
17676 |   63 |   process.env.POSTS_FILE || path.join(process.cwd(), "data", "posts.json");
17677 |   64 | 
17678 |   65 | /**
17679 |   66 |  * CACHE DYSKOWY
17680 |   67 |  */
17681 |   68 | const commentsCache = loadCache();
17682 |   69 | const lastCounts = new Map();
17683 |   70 | const knownCommentsPerPost = new Map();
17684 |   71 | 
17685 |   72 | // Limity dla knownIds - zapobiega memory leak
17686 |   73 | const MAX_KNOWN_IDS_PER_POST = 1000;  // max komentarzy na post w pamiƒôci
17687 |   74 | const KNOWN_IDS_TRIM_TO = 800;        // do ilu przycinaƒá gdy przekroczy limit
17688 |   75 | 
17689 |   76 | for (const [url, entry] of Object.entries(commentsCache)) {
17690 |   77 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
17691 |   78 |   if (Array.isArray(entry?.knownIds)) {
17692 |   79 |     // Przytnij podczas ≈Çadowania je≈õli za du≈ºo
17693 |   80 |     const ids = entry.knownIds.slice(-MAX_KNOWN_IDS_PER_POST);
17694 |   81 |     knownCommentsPerPost.set(url, new Set(ids));
17695 |   82 |   }
17696 |   83 | }
17697 |   84 | 
17698 |   85 | let currentPosts = [];
17699 |   86 | let lastRefreshAny = 0;
17700 |   87 | let cycleNumber = 0;
17701 |   88 | 
17702 |   89 | let navErrorCount = 0;
17703 |   90 | const MAX_NAV_ERRORS = 5;
17704 |   91 | 
17705 |   92 | function isNavigationError(err) {
17706 |   93 |   if (!err) return false;
17707 |   94 |   const msg = String(err.message || err).toLowerCase();
17708 |   95 |   return (
17709 |   96 |     msg.includes("safegoto-failed") ||
17710 |   97 |     msg.includes("navigation timeout") ||
17711 |   98 |     msg.includes("net::err_connection_timed_out") ||
17712 |   99 |     msg.includes("net::err_timed_out")
17713 |  100 |   );
17714 |  101 | }
17715 |  102 | 
17716 |  103 | function envBool(name, def = false) {
17717 |  104 |   const raw = String(process.env[name] ?? "").trim().toLowerCase();
17718 |  105 |   if (raw === "") return def;
17719 |  106 |   return ["1", "true", "yes", "y", "tak", "on"].includes(raw);
17720 |  107 | }
17721 |  108 | 
17722 |  109 | // ================== FAST_MODE HELPER ==================
17723 |  110 | function getCommentAgeMinutes(timeStr) {
17724 |  111 |   if (!timeStr) return null;
17725 |  112 |   const abs = parseFbRelativeTime(timeStr);
17726 |  113 |   if (!abs) return null;
17727 |  114 |   return (Date.now() - abs.getTime()) / 60000;
17728 |  115 | }
17729 |  116 | 
17730 |  117 | // ================== TELEGRAM (FILTER AGE) ==================
17731 |  118 | async function sendTelegramIfFresh(post, comments, ctx = "normal") {
17732 |  119 |   const list = Array.isArray(comments) ? comments : [];
17733 |  120 |   if (list.length === 0) return;
17734 |  121 | 
17735 |  122 |   const now = Date.now();
17736 |  123 | 
17737 |  124 |   const normalized = list.map((c) => {
17738 |  125 |     const rel = String(c?.fb_time_raw || c?.time || "").trim();
17739 |  126 |     const abs = parseFbRelativeTime(rel);
17740 |  127 |     const iso = abs ? abs.toISOString() : (c?.fb_time_iso || null);
17741 |  128 |     const ageMin = abs ? Math.round(((now - abs.getTime()) / 60000) * 10) / 10 : null;
17742 |  129 | 
17743 |  130 |     return {
17744 |  131 |       ...c,
17745 |  132 |       fb_time_raw: rel || null,
17746 |  133 |       fb_time_iso: iso,
17747 |  134 |       _ageMin: ageMin,
17748 |  135 |     };
17749 |  136 |   });
17750 |  137 | 
17751 |  138 |   // log wieku komentarzy (tylko DEBUG)
17752 |  139 |   for (const c of normalized) {
17753 |  140 |     log.debug("TELEGRAM", `Komentarz ${c?.id}`, {
17754 |  141 |       ctx,
17755 |  142 |       author: c?.author || c?.name,
17756 |  143 |       rel: c?.fb_time_raw,
17757 |  144 |       ageMin: c?._ageMin,
17758 |  145 |     });
17759 |  146 |   }
17760 |  147 | 
17761 |  148 |   const fresh = filterByAge(normalized);
17762 |  149 |   const maxAge = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
17763 |  150 | 
17764 |  151 |   log.dev("TELEGRAM", `Filtr wieku: ${normalized.length} ‚Üí ${fresh.length}`, { ctx, maxAge });
17765 |  152 | 
17766 |  153 |   if (fresh.length > 0) {
17767 |  154 |     await sendTelegramLeads(post, fresh);
17768 |  155 |   } else {
17769 |  156 |     log.dev("TELEGRAM", "Brak ≈õwie≈ºych komentarzy - nic nie wysy≈Çam");
17770 |  157 |   }
17771 |  158 | }
17772 |  159 | 
17773 |  160 | /* ============================================================
17774 |  161 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
17775 |  162 |    ============================================================ */
17776 |  163 | 
17777 |  164 | async function applyStealth(page) {
17778 |  165 |   await page.evaluateOnNewDocument(() => {
17779 |  166 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
17780 |  167 |     window.chrome = window.chrome || { runtime: {} };
17781 |  168 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
17782 |  169 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
17783 |  170 | 
17784 |  171 |     const permissions = window.navigator.permissions;
17785 |  172 |     if (permissions && permissions.query) {
17786 |  173 |       const originalQuery = permissions.query.bind(permissions);
17787 |  174 |       permissions.query = (parameters) => {
17788 |  175 |         if (parameters && parameters.name === "notifications" && window.Notification) {
17789 |  176 |           return Promise.resolve({ state: window.Notification.permission });
17790 |  177 |         }
17791 |  178 |         return originalQuery(parameters);
17792 |  179 |       };
17793 |  180 |     }
17794 |  181 |   });
17795 |  182 | }
17796 |  183 | 
17797 |  184 | /* ============================================================
17798 |  185 |    ===============   PANEL POSTS (data/posts.json)   ===========
17799 |  186 |    ============================================================ */
17800 |  187 | 
17801 |  188 | function safeJsonParse(s) {
17802 |  189 |   try {
17803 |  190 |     return { ok: true, value: JSON.parse(s) };
17804 |  191 |   } catch (e) {
17805 |  192 |     return { ok: false, error: e?.message || "Invalid JSON" };
17806 |  193 |   }
17807 |  194 | }
17808 |  195 | 
17809 |  196 | function normalizeUrl(u) {
17810 |  197 |   if (!u) return "";
17811 |  198 |   const x = String(u).trim();
17812 |  199 |   if (!/^https?:\/\/.+/i.test(x)) return "";
17813 |  200 |   return x;
17814 |  201 | }
17815 |  202 | 
17816 |  203 | function makePostKey(url) {
17817 |  204 |   try {
17818 |  205 |     const u = new URL(String(url || "").trim());
17819 |  206 |     for (const k of Array.from(u.searchParams.keys())) {
17820 |  207 |       if (k.startsWith("__") || ["ref", "notif_id", "notif_t", "refid"].includes(k)) {
17821 |  208 |         u.searchParams.delete(k);
17822 |  209 |       }
17823 |  210 |     }
17824 |  211 |     if (u.pathname.includes("permalink.php")) {
17825 |  212 |       const s = u.searchParams.get("story_fbid");
17826 |  213 |       const id = u.searchParams.get("id");
17827 |  214 |       if (s && id) return `permalink:${id}:${s}`;
17828 |  215 |     }
17829 |  216 |     if (u.pathname.includes("story.php")) {
17830 |  217 |       const s = u.searchParams.get("story_fbid");
17831 |  218 |       const id = u.searchParams.get("id");
17832 |  219 |       if (s && id) return `story:${id}:${s}`;
17833 |  220 |     }
17834 |  221 |     const mPosts = u.pathname.match(/\/posts\/([^/?#]+)/i);
17835 |  222 |     if (mPosts?.[1]) return `posts:${mPosts[1]}`;
17836 |  223 |     const v = u.searchParams.get("v");
17837 |  224 |     if (u.pathname.includes("/watch") && v) return `watch:${v}`;
17838 |  225 |     const mVid = u.pathname.match(/\/videos\/([^/?#]+)/i);
17839 |  226 |     if (mVid?.[1]) return `videos:${mVid[1]}`;
17840 |  227 |     const q = u.searchParams.toString();
17841 |  228 |     return `url:${u.host}${u.pathname}${q ? "?" + q : ""}`;
17842 |  229 |   } catch {
17843 |  230 |     return `url:${String(url || "").trim()}`;
17844 |  231 |   }
17845 |  232 | }
17846 |  233 | 
17847 |  234 | function readPanelPosts() {
17848 |  235 |   try {
17849 |  236 |     if (!fs.existsSync(POSTS_FILE)) {
17850 |  237 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
17851 |  238 |     }
17852 |  239 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
17853 |  240 |     if (!raw) {
17854 |  241 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
17855 |  242 |     }
17856 |  243 | 
17857 |  244 |     const parsed = safeJsonParse(raw);
17858 |  245 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
17859 |  246 |       return { ok: false, error: "posts.json ma z≈Çy format", posts: [], path: POSTS_FILE };
17860 |  247 |     }
17861 |  248 | 
17862 |  249 |     const posts = parsed.value
17863 |  250 |       .map((p) => {
17864 |  251 |         const url = normalizeUrl(p?.url);
17865 |  252 |         const active = Boolean(p?.active);
17866 |  253 |         if (!url) return null;
17867 |  254 |         return {
17868 |  255 |           id: String(p?.id || url),
17869 |  256 |           url,
17870 |  257 |           active,
17871 |  258 |           name: p?.name ? String(p.name) : "",
17872 |  259 |           image: p?.image ? String(p.image) : "",
17873 |  260 |           description: p?.description ? String(p.description) : "",
17874 |  261 |         };
17875 |  262 |       })
17876 |  263 |       .filter(Boolean);
17877 |  264 | 
17878 |  265 |     const activePosts = posts.filter((p) => p.active);
17879 |  266 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
17880 |  267 |   } catch (e) {
17881 |  268 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
17882 |  269 |   }
17883 |  270 | }
17884 |  271 | 
17885 |  272 | /* ============================================================
17886 |  273 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
17887 |  274 |    ============================================================ */
17888 |  275 | 
17889 |  276 | function parseSheetCsv(text) {
17890 |  277 |   const lines = text
17891 |  278 |     .split(/\r?\n/)
17892 |  279 |     .map((l) => l.trim())
17893 |  280 |     .filter((l) => l.length > 0);
17894 |  281 | 
17895 |  282 |   if (!lines.length) {
17896 |  283 |     log.warn("SHEET", "Pusty CSV z arkusza");
17897 |  284 |     return [];
17898 |  285 |   }
17899 |  286 | 
17900 |  287 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
17901 |  288 |   const idxUrl = header.findIndex((h) => h === "url");
17902 |  289 |   const idxActive = header.findIndex((h) => h === "active");
17903 |  290 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
17904 |  291 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
17905 |  292 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
17906 |  293 | 
17907 |  294 |   if (idxUrl === -1) {
17908 |  295 |     log.error("SHEET", "Brak kolumny 'url' w arkuszu");
17909 |  296 |     return [];
17910 |  297 |   }
17911 |  298 | 
17912 |  299 |   const posts = [];
17913 |  300 |   for (let i = 1; i < lines.length; i++) {
17914 |  301 |     const row = lines[i].split(",");
17915 |  302 |     const rawUrl = (row[idxUrl] || "").trim();
17916 |  303 |     if (!rawUrl) continue;
17917 |  304 | 
17918 |  305 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
17919 |  306 |     const activeNorm = activeRaw.toLowerCase();
17920 |  307 |     const isActive = idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
17921 |  308 | 
17922 |  309 |     if (!isActive) continue;
17923 |  310 | 
17924 |  311 |     posts.push({
17925 |  312 |       id: `sheet-${i}`,
17926 |  313 |       url: rawUrl,
17927 |  314 |       name: idxName !== -1 ? (row[idxName] || "").trim() : "",
17928 |  315 |       image: idxImage !== -1 ? (row[idxImage] || "").trim() : "",
17929 |  316 |       description: idxDesc !== -1 ? (row[idxDesc] || "").trim() : "",
17930 |  317 |     });
17931 |  318 |   }
17932 |  319 | 
17933 |  320 |   return posts;
17934 |  321 | }
17935 |  322 | 
17936 |  323 | /* ============================================================
17937 |  324 |    ===============   POSTS FROM REMOTE API   ====================
17938 |  325 |    ============================================================ */
17939 |  326 | 
17940 |  327 | async function fetchPostsFromApi() {
17941 |  328 |   if (!POSTS_API_URL) return { ok: false, reason: "no-url" };
17942 |  329 | 
17943 |  330 |   log.dev("API", `Pobieram posty z: ${POSTS_API_URL}`);
17944 |  331 | 
17945 |  332 |   try {
17946 |  333 |     const headers = { "Content-Type": "application/json" };
17947 |  334 |     if (POSTS_API_TOKEN) {
17948 |  335 |       headers["Authorization"] = `Bearer ${POSTS_API_TOKEN}`;
17949 |  336 |     }
17950 |  337 | 
17951 |  338 |     const res = await fetch(POSTS_API_URL, {
17952 |  339 |       method: "GET",
17953 |  340 |       headers,
17954 |  341 |       timeout: 10000,
17955 |  342 |     });
17956 |  343 | 
17957 |  344 |     if (!res.ok) {
17958 |  345 |       log.error("API", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
17959 |  346 |       return { ok: false, reason: "http-error", status: res.status };
17960 |  347 |     }
17961 |  348 | 
17962 |  349 |     const data = await res.json();
17963 |  350 | 
17964 |  351 |     if (!data.ok || !Array.isArray(data.posts)) {
17965 |  352 |       log.error("API", "Nieprawid≈Çowa odpowied≈∫ (brak ok/posts)");
17966 |  353 |       return { ok: false, reason: "invalid-response" };
17967 |  354 |     }
17968 |  355 | 
17969 |  356 |     const posts = data.posts
17970 |  357 |       .filter((p) => p.active !== false)
17971 |  358 |       .map((p) => ({
17972 |  359 |         id: String(p.id || "").trim(),
17973 |  360 |         url: String(p.url || "").trim(),
17974 |  361 |         active: true,
17975 |  362 |         name: String(p.name || "").trim(),
17976 |  363 |         image: String(p.image || "").trim(),
17977 |  364 |         description: String(p.description || "").trim(),
17978 |  365 |       }))
17979 |  366 |       .filter((p) => p.url);
17980 |  367 | 
17981 |  368 |     return { ok: true, posts, total: data.posts.length };
17982 |  369 |   } catch (err) {
17983 |  370 |     log.error("API", `B≈ÇƒÖd pobierania post√≥w: ${err.message}`);
17984 |  371 |     return { ok: false, reason: "fetch-error", error: err.message };
17985 |  372 |   }
17986 |  373 | }
17987 |  374 | 
17988 |  375 | /* ============================================================
17989 |  376 |    ===============   POSTS REFRESH   ===========================
17990 |  377 |    ============================================================ */
17991 |  378 | 
17992 |  379 | async function refreshPostsIfNeeded(force = false) {
17993 |  380 |   const now = Date.now();
17994 |  381 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
17995 |  382 |   lastRefreshAny = now;
17996 |  383 | 
17997 |  384 |   // 1) PRIMARY: Remote API
17998 |  385 |   if (POSTS_API_URL) {
17999 |  386 |     const api = await fetchPostsFromApi();
18000 |  387 |     if (api.ok && api.posts.length > 0) {
18001 |  388 |       const newPosts = api.posts;
18002 |  389 |       const oldJson = JSON.stringify(currentPosts);
18003 |  390 |       const newJson = JSON.stringify(newPosts);
18004 |  391 | 
18005 |  392 |       if (oldJson !== newJson) {
18006 |  393 |         log.prod("API", `Za≈Çadowano ${newPosts.length} post√≥w`, { total: api.total });
18007 |  394 |         currentPosts = newPosts;
18008 |  395 |       } else {
18009 |  396 |         log.dev("API", `Bez zmian (${newPosts.length} aktywnych)`);
18010 |  397 |       }
18011 |  398 |       return;
18012 |  399 |     }
18013 |  400 | 
18014 |  401 |     log.dev("API", `Fallback do lokalnego pliku (${api.reason || "unknown"})`);
18015 |  402 |   }
18016 |  403 | 
18017 |  404 |   // 2) SECONDARY: lokalny panel posts.json
18018 |  405 |   const panel = readPanelPosts();
18019 |  406 |   if (panel.ok && panel.posts.length > 0) {
18020 |  407 |     const newPosts = panel.posts;
18021 |  408 |     const oldJson = JSON.stringify(currentPosts);
18022 |  409 |     const newJson = JSON.stringify(newPosts);
18023 |  410 | 
18024 |  411 |     if (oldJson !== newJson) {
18025 |  412 |       log.prod("POSTS", `Za≈Çadowano ${newPosts.length} post√≥w z pliku`, { total: panel.total });
18026 |  413 |       currentPosts = newPosts;
18027 |  414 |     } else {
18028 |  415 |       log.dev("POSTS", `Bez zmian (${newPosts.length} aktywnych)`);
18029 |  416 |     }
18030 |  417 |     return;
18031 |  418 |   }
18032 |  419 | 
18033 |  420 |   log.dev("POSTS", "Panel bez post√≥w ‚Üí fallback: Sheets");
18034 |  421 | 
18035 |  422 |   // 3) FALLBACK: Sheets
18036 |  423 |   if (!POSTS_SHEET_URL) {
18037 |  424 |     log.warn("SHEET", "POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w");
18038 |  425 |     currentPosts = [];
18039 |  426 |     return;
18040 |  427 |   }
18041 |  428 | 
18042 |  429 |   log.dev("SHEET", "Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
18043 |  430 | 
18044 |  431 |   try {
18045 |  432 |     const res = await fetch(POSTS_SHEET_URL);
18046 |  433 |     if (!res.ok) {
18047 |  434 |       log.error("SHEET", `B≈ÇƒÖd HTTP: ${res.status} ${res.statusText}`);
18048 |  435 |       currentPosts = [];
18049 |  436 |       return;
18050 |  437 |     }
18051 |  438 | 
18052 |  439 |     const csvText = await res.text();
18053 |  440 |     const newPosts = parseSheetCsv(csvText);
18054 |  441 | 
18055 |  442 |     if (!newPosts.length) {
18056 |  443 |       log.warn("SHEET", "Arkusz nie zwr√≥ci≈Ç aktywnych post√≥w");
18057 |  444 |       currentPosts = [];
18058 |  445 |       return;
18059 |  446 |     }
18060 |  447 | 
18061 |  448 |     const oldJson = JSON.stringify(currentPosts);
18062 |  449 |     const newJson = JSON.stringify(newPosts);
18063 |  450 | 
18064 |  451 |     if (oldJson !== newJson) {
18065 |  452 |       log.prod("SHEET", `Za≈Çadowano ${newPosts.length} post√≥w`);
18066 |  453 |       currentPosts = newPosts;
18067 |  454 |     } else {
18068 |  455 |       log.dev("SHEET", "Bez zmian");
18069 |  456 |     }
18070 |  457 |   } catch (err) {
18071 |  458 |     log.error("SHEET", `B≈ÇƒÖd pobierania CSV: ${err.message}`);
18072 |  459 |     currentPosts = [];
18073 |  460 |   }
18074 |  461 | }
18075 |  462 | 
18076 |  463 | /* ============================================================
18077 |  464 |    =====================   CACHE HELPERS   =====================
18078 |  465 |    ============================================================ */
18079 |  466 | 
18080 |  467 | function getCacheKey(post) {
18081 |  468 |   return post.url;
18082 |  469 | }
18083 |  470 | 
18084 |  471 | function getKnownSetForPost(cacheKey) {
18085 |  472 |   let set = knownCommentsPerPost.get(cacheKey);
18086 |  473 |   if (!set) {
18087 |  474 |     const entry = commentsCache[cacheKey];
18088 |  475 |     set = entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
18089 |  476 |     knownCommentsPerPost.set(cacheKey, set);
18090 |  477 |   }
18091 |  478 |   return set;
18092 |  479 | }
18093 |  480 | 
18094 |  481 | /**
18095 |  482 |  * Przycina Set knownIds gdy przekroczy limit (FIFO - usuwa najstarsze).
18096 |  483 |  * Zapobiega memory leak przy d≈Çugim dzia≈Çaniu.
18097 |  484 |  */
18098 |  485 | function cleanupKnownIds(set) {
18099 |  486 |   if (set.size <= MAX_KNOWN_IDS_PER_POST) return;
18100 |  487 | 
18101 |  488 |   const arr = Array.from(set);
18102 |  489 |   const toRemove = arr.slice(0, arr.length - KNOWN_IDS_TRIM_TO);
18103 |  490 |   for (const id of toRemove) {
18104 |  491 |     set.delete(id);
18105 |  492 |   }
18106 |  493 | 
18107 |  494 |   log.debug("CACHE", `Przyciƒôto knownIds: ${arr.length} ‚Üí ${set.size}`);
18108 |  495 | }
18109 |  496 | 
18110 |  497 | 
18111 |  498 | /**
18112 |  499 |  * Zwraca ca≈ÇkowitƒÖ liczbƒô knownIds w pamiƒôci (dla monitoringu)
18113 |  500 |  */
18114 |  501 | function getTotalKnownIdsCount() {
18115 |  502 |   let total = 0;
18116 |  503 |   for (const set of knownCommentsPerPost.values()) {
18117 |  504 |     total += set.size;
18118 |  505 |   }
18119 |  506 |   return total;
18120 |  507 | }
18121 |  508 | 
18122 |  509 | function flushCacheToDisk() {
18123 |  510 |   const out = { ...commentsCache };
18124 |  511 | 
18125 |  512 |   for (const [cacheKey, count] of lastCounts.entries()) {
18126 |  513 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
18127 |  514 |     out[cacheKey].lastCount = count;
18128 |  515 |   }
18129 |  516 | 
18130 |  517 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
18131 |  518 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
18132 |  519 |     out[cacheKey].knownIds = Array.from(set);
18133 |  520 |   }
18134 |  521 | 
18135 |  522 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
18136 |  523 |   Object.assign(commentsCache, out);
18137 |  524 |   saveCache(out);
18138 |  525 | }
18139 |  526 | 
18140 |  527 | /* ============================================================
18141 |  528 |    =====================   G≈Å√ìWNY WATCHER   ===================
18142 |  529 |    ============================================================ */
18143 |  530 | 
18144 |  531 | const isDev = process.env.NODE_ENV !== "production";
18145 |  532 | 
18146 |  533 | function getExecutablePath() {
18147 |  534 |   const p =
18148 |  535 |     process.env.PUPPETEER_EXECUTABLE_PATH ||
18149 |  536 |     process.env.CHROME_PATH ||
18150 |  537 |     process.env.CHROMIUM_PATH ||
18151 |  538 |     "";
18152 |  539 |   return String(p || "").trim() || undefined;
18153 |  540 | }
18154 |  541 | 
18155 |  542 | async function startWatcher() {
18156 |  543 |   log.header("FB Comment Watcher");
18157 |  544 |   log.prod("WATCHER", `Start - interwa≈Ç: ${Math.round(CHECK_INTERVAL_MS / 1000)}s`, {
18158 |  545 |     fastMode: FAST_MODE,
18159 |  546 |     logLevel: log.level,
18160 |  547 |   });
18161 |  548 | 
18162 |  549 |   const loop = async () => {
18163 |  550 |     let browser = null;
18164 |  551 |     let page = null;
18165 |  552 |     let hadNavErrorThisRound = false;
18166 |  553 |     const cycleStart = Date.now();
18167 |  554 |     cycleNumber++;
18168 |  555 |     let newCommentsTotal = 0;
18169 |  556 |     let errorsCount = 0;
18170 |  557 | 
18171 |  558 |     try {
18172 |  559 |       log.prod("WATCHER", `Cykl #${cycleNumber} start`, { posts: currentPosts.length });
18173 |  560 | 
18174 |  561 |       const wantHeadless = envBool("HEADLESS_BROWSER", true);
18175 |  562 |       const headlessMode = wantHeadless ? (isDev ? true : "new") : false;
18176 |  563 | 
18177 |  564 |       const linux = process.platform === "linux";
18178 |  565 |       const executablePath = getExecutablePath();
18179 |  566 | 
18180 |  567 |       const args = [
18181 |  568 |         "--disable-notifications",
18182 |  569 |         "--disable-blink-features=AutomationControlled",
18183 |  570 |       ];
18184 |  571 | 
18185 |  572 |       if (linux) {
18186 |  573 |         args.push("--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage");
18187 |  574 |       }
18188 |  575 | 
18189 |  576 |       // Remote debugging - pozwala pod≈ÇƒÖczyƒá siƒô przez chrome://inspect
18190 |  577 |       if (REMOTE_DEBUG_PORT > 0) {
18191 |  578 |         args.push(`--remote-debugging-port=${REMOTE_DEBUG_PORT}`);
18192 |  579 |         args.push("--remote-debugging-address=127.0.0.1");
18193 |  580 |         log.prod("DEBUG", `Remote debugging na porcie ${REMOTE_DEBUG_PORT} - po≈ÇƒÖcz przez: ssh -L ${REMOTE_DEBUG_PORT}:localhost:${REMOTE_DEBUG_PORT} user@server`);
18194 |  581 |       }
18195 |  582 | 
18196 |  583 |       // Proxy - residential rotating proxy zmniejsza ryzyko ban√≥w
18197 |  584 |       if (PROXY_URL) {
18198 |  585 |         args.push(`--proxy-server=${PROXY_URL}`);
18199 |  586 |         // Ukryj credentials w logu
18200 |  587 |         const safeProxyUrl = PROXY_URL.replace(/\/\/([^:]+):([^@]+)@/, "//***:***@");
18201 |  588 |         log.prod("PROXY", `U≈ºywam proxy: ${safeProxyUrl}`);
18202 |  589 |       }
18203 |  590 | 
18204 |  591 |       // Human Mode info
18205 |  592 |       if (HUMAN_MODE) {
18206 |  593 |         log.prod("HUMAN", "Human Behavior Mode w≈ÇƒÖczony");
18207 |  594 |       }
18208 |  595 | 
18209 |  596 |       browser = await puppeteer.launch({
18210 |  597 |         headless: headlessMode,
18211 |  598 |         defaultViewport: null,
18212 |  599 |         executablePath,
18213 |  600 |         args,
18214 |  601 |         ignoreDefaultArgs: ["--enable-automation"],
18215 |  602 |       });
18216 |  603 | 
18217 |  604 |       page = await browser.newPage();
18218 |  605 |       await applyStealth(page);
18219 |  606 | 
18220 |  607 |       page.setDefaultNavigationTimeout(90000);
18221 |  608 |       page.setDefaultTimeout(90000);
18222 |  609 |       await page.setViewport({ width: 1280, height: 720 });
18223 |  610 | 
18224 |  611 |       // cookies + login
18225 |  612 |       await loadCookies(page);
18226 |  613 |       await page.goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 }).catch(() => {});
18227 |  614 | 
18228 |  615 |       let loggedIn = await checkIfLogged(page);
18229 |  616 | 
18230 |  617 |       // === CHECKPOINT DETECTION (tylko alert) ===
18231 |  618 |       const checkpoint = await isCheckpoint(page);
18232 |  619 |       if (checkpoint) {
18233 |  620 |         const checkpointType = await getCheckpointType(page);
18234 |  621 |         log.warn("CHECKPOINT", `Wykryto checkpoint: ${checkpointType}`);
18235 |  622 | 
18236 |  623 |         // Pr√≥ba rozwiƒÖzania captcha (je≈õli to captcha, nie 2FA)
18237 |  624 |         if (CAPTCHA_ENABLED) {
18238 |  625 |           const captchaResult = await solveCaptchaIfPresent(page);
18239 |  626 |           if (captchaResult.solved) {
18240 |  627 |             log.success("CAPTCHA", "Captcha rozwiƒÖzana!");
18241 |  628 |             await new Promise(r => setTimeout(r, 2000));
18242 |  629 |             loggedIn = await checkIfLogged(page);
18243 |  630 |             if (!loggedIn) {
18244 |  631 |               await fbLogin(page);
18245 |  632 |               loggedIn = await checkIfLogged(page);
18246 |  633 |             }
18247 |  634 |           }
18248 |  635 |         }
18249 |  636 | 
18250 |  637 |         // Je≈õli nadal nie zalogowany - alert i stop (lub czekaj przy remote debug)
18251 |  638 |         if (!loggedIn) {
18252 |  639 |           await sendOwnerAlert(
18253 |  640 |             "CHECKPOINT - Wymagana interwencja",
18254 |  641 |             `Facebook wymaga weryfikacji to≈ºsamo≈õci.\n\n` +
18255 |  642 |             `Typ: ${checkpointType}\n\n` +
18256 |  643 |             `Wymagane dzia≈Çanie:\n` +
18257 |  644 |             `1. Zaloguj siƒô rƒôcznie i zaktualizuj cookies.json\n` +
18258 |  645 |             `2. Zmie≈Ñ dane logowania w .env je≈õli potrzeba\n` +
18259 |  646 |             `3. PM2 automatycznie wznowi pracƒô`
18260 |  647 |           );
18261 |  648 | 
18262 |  649 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô zamiast wychodziƒá
18263 |  650 |           if (REMOTE_DEBUG_PORT > 0) {
18264 |  651 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
18265 |  652 |             log.warn("CHECKPOINT", "PrzeglƒÖdarka czeka na rƒôcznƒÖ interwencjƒô.");
18266 |  653 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect, potem naci≈õnij Ctrl+C i uruchom ponownie.");
18267 |  654 |             log.warn("CHECKPOINT", "Sprawdzam co 30s czy jeste≈õ zalogowany...");
18268 |  655 | 
18269 |  656 |             // Czekaj w pƒôtli a≈º u≈ºytkownik rƒôcznie rozwiƒÖ≈ºe checkpoint (max 30 min)
18270 |  657 |             const MAX_WAIT_2FA_MS = 30 * 60 * 1000; // 30 minut
18271 |  658 |             const startWait2FA = Date.now();
18272 |  659 |             while (true) {
18273 |  660 |               if (Date.now() - startWait2FA > MAX_WAIT_2FA_MS) {
18274 |  661 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA (30 min) - restart procesu");
18275 |  662 |                 await sendOwnerAlert("TIMEOUT 2FA", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô. Proces zostanie zrestartowany.");
18276 |  663 |                 process.exit(1);
18277 |  664 |               }
18278 |  665 |               await new Promise(r => setTimeout(r, 30000));
18279 |  666 |               const nowLogged = await checkIfLogged(page).catch(() => false);
18280 |  667 |               if (nowLogged) {
18281 |  668 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
18282 |  669 |                 await saveCookies(page);
18283 |  670 |                 loggedIn = true;
18284 |  671 |                 break;
18285 |  672 |               }
18286 |  673 |               const remainingMin = Math.round((MAX_WAIT_2FA_MS - (Date.now() - startWait2FA)) / 60000);
18287 |  674 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMin} min)`);
18288 |  675 |             }
18289 |  676 |           } else {
18290 |  677 |             log.error("CHECKPOINT", "Wymagana interwencja - zatrzymujƒô proces");
18291 |  678 |             process.exit(1);
18292 |  679 |           }
18293 |  680 |         }
18294 |  681 |       }
18295 |  682 |       // === KONIEC CHECKPOINT DETECTION ===
18296 |  683 | 
18297 |  684 |       if (!loggedIn) {
18298 |  685 |         log.dev("LOGIN", "Brak sesji ‚Äì logowanie...");
18299 |  686 |         const LOGIN_TIMEOUT_MS = 120000; // 2 minuty na login
18300 |  687 |         try {
18301 |  688 |           await Promise.race([
18302 |  689 |             fbLogin(page),
18303 |  690 |             new Promise((_, reject) => setTimeout(() => reject(new Error('Login timeout (2 min)')), LOGIN_TIMEOUT_MS))
18304 |  691 |           ]);
18305 |  692 |         } catch (loginErr) {
18306 |  693 |           log.error("LOGIN", `B≈ÇƒÖd logowania: ${loginErr.message}`);
18307 |  694 |           await sendOwnerAlert("LOGIN ERROR", `Logowanie nie powiod≈Ço siƒô: ${loginErr.message}`);
18308 |  695 |           throw loginErr;
18309 |  696 |         }
18310 |  697 |         loggedIn = await checkIfLogged(page);
18311 |  698 | 
18312 |  699 |         // Sprawd≈∫ checkpoint po pr√≥bie logowania
18313 |  700 |         const checkpointAfterLogin = await isCheckpoint(page);
18314 |  701 |         if (checkpointAfterLogin) {
18315 |  702 |           const checkpointType = await getCheckpointType(page);
18316 |  703 |           log.warn("CHECKPOINT", `Checkpoint po logowaniu: ${checkpointType}`);
18317 |  704 | 
18318 |  705 |           await sendOwnerAlert(
18319 |  706 |             "CHECKPOINT po logowaniu",
18320 |  707 |             `Facebook wymaga weryfikacji po pr√≥bie logowania.\n\nTyp: ${checkpointType}`
18321 |  708 |           );
18322 |  709 | 
18323 |  710 |           // Gdy remote debug - czekaj na rƒôcznƒÖ interwencjƒô (max 30 min)
18324 |  711 |           if (REMOTE_DEBUG_PORT > 0) {
18325 |  712 |             log.warn("CHECKPOINT", "=== REMOTE DEBUG MODE ===");
18326 |  713 |             log.warn("CHECKPOINT", "Zr√≥b 2FA/checkpoint w chrome://inspect. Sprawdzam co 30s...");
18327 |  714 | 
18328 |  715 |             const MAX_WAIT_2FA_MS_LOGIN = 30 * 60 * 1000; // 30 minut
18329 |  716 |             const startWait2FALogin = Date.now();
18330 |  717 |             while (true) {
18331 |  718 |               if (Date.now() - startWait2FALogin > MAX_WAIT_2FA_MS_LOGIN) {
18332 |  719 |                 log.error("CHECKPOINT", "Timeout oczekiwania na 2FA po logowaniu (30 min) - restart procesu");
18333 |  720 |                 await sendOwnerAlert("TIMEOUT 2FA LOGIN", "Przekroczono 30 minut oczekiwania na rƒôcznƒÖ interwencjƒô po logowaniu. Proces zostanie zrestartowany.");
18334 |  721 |                 process.exit(1);
18335 |  722 |               }
18336 |  723 |               await new Promise(r => setTimeout(r, 30000));
18337 |  724 |               const nowLogged = await checkIfLogged(page).catch(() => false);
18338 |  725 |               if (nowLogged) {
18339 |  726 |                 log.success("CHECKPOINT", "Wykryto sesjƒô! Zapisujƒô cookies i kontynuujƒô...");
18340 |  727 |                 await saveCookies(page);
18341 |  728 |                 loggedIn = true;
18342 |  729 |                 break;
18343 |  730 |               }
18344 |  731 |               const remainingMinLogin = Math.round((MAX_WAIT_2FA_MS_LOGIN - (Date.now() - startWait2FALogin)) / 60000);
18345 |  732 |               log.dev("CHECKPOINT", `Nadal brak sesji - czekam... (pozosta≈Ço ~${remainingMinLogin} min)`);
18346 |  733 |             }
18347 |  734 |           } else {
18348 |  735 |             process.exit(1);
18349 |  736 |           }
18350 |  737 |         }
18351 |  738 | 
18352 |  739 |         if (loggedIn) {
18353 |  740 |           log.success("LOGIN", "Zalogowano pomy≈õlnie");
18354 |  741 |           await saveCookies(page);
18355 |  742 |         } else {
18356 |  743 |           log.error("LOGIN", "Logowanie nieudane");
18357 |  744 |         }
18358 |  745 |       } else {
18359 |  746 |         log.dev("LOGIN", "U≈ºyto istniejƒÖcej sesji");
18360 |  747 |       }
18361 |  748 | 
18362 |  749 |       // posts
18363 |  750 |       await refreshPostsIfNeeded(true);
18364 |  751 | 
18365 |  752 |       if (!currentPosts.length) {
18366 |  753 |         log.warn("WATCHER", "Brak aktywnych post√≥w do monitorowania");
18367 |  754 |       } else {
18368 |  755 |         // Human Behavior: randomizacja kolejno≈õci post√≥w
18369 |  756 |         const shuffledPosts = shuffleArray(currentPosts);
18370 |  757 |         const postOrder = shuffledPosts.map(p => p.name || p.id.slice(0, 8)).join(" ‚Üí ");
18371 |  758 |         log.dev("HUMAN", `Kolejno≈õƒá post√≥w: ${postOrder}`);
18372 |  759 | 
18373 |  760 |         let postIndex = 0;
18374 |  761 |         for (const post of shuffledPosts) {
18375 |  762 |           // Human Behavior: pauza PRZED ka≈ºdym postem (poza pierwszym)
18376 |  763 |           if (postIndex > 0) {
18377 |  764 |             const pauseMs = await betweenPostsPause();
18378 |  765 |             log.dev("HUMAN", `Pauza: ${(pauseMs / 1000).toFixed(1)}s`);
18379 |  766 |           }
18380 |  767 |           postIndex++;
18381 |  768 | 
18382 |  769 |           const cacheKey = getCacheKey(post);
18383 |  770 |           const postLabel = post.name || post.id.slice(0, 8);
18384 |  771 | 
18385 |  772 |           try {
18386 |  773 |             log.dev("NAV", `‚Üí ${postLabel}`);
18387 |  774 |             await prepare(page, post.url);
18388 |  775 | 
18389 |  776 |             // ==================== FAST_MODE BRANCH ====================
18390 |  777 |             if (FAST_MODE) {
18391 |  778 |               const knownSet = getKnownSetForPost(cacheKey);
18392 |  779 |               const isFirstRun = !lastCounts.has(cacheKey);
18393 |  780 | 
18394 |  781 |               // 1. Prze≈ÇƒÖcz na "Najnowsze"
18395 |  782 |               const switchResult = await switchCommentsFilterToNewest(page, post.url).catch(() => ({ ok: false }));
18396 |  783 | 
18397 |  784 |               if (!switchResult.ok) {
18398 |  785 |                 log.dev("FAST", `${postLabel}: Fallback do normalnego trybu`, { reason: switchResult.reason });
18399 |  786 |               } else {
18400 |  787 |                 await new Promise((r) => setTimeout(r, 600 + Math.random() * 400));
18401 |  788 | 
18402 |  789 |                 const snapshot = await extractCommentsData(page, post.url).catch(() => []);
18403 |  790 |                 const sample = snapshot.slice(0, 30);
18404 |  791 | 
18405 |  792 |                 log.dev("FAST", `${postLabel}: ${sample.length} komentarzy (sort=Najnowsze)`);
18406 |  793 | 
18407 |  794 |                 // Inicjalizacja
18408 |  795 |                 if (isFirstRun) {
18409 |  796 |                   lastCounts.set(cacheKey, sample.length);
18410 |  797 |                   for (const c of sample) if (c?.id) knownSet.add(c.id);
18411 |  798 |                   log.dev("FAST", `${postLabel}: Inicjalizacja - zapamiƒôtano ${sample.length}`);
18412 |  799 |                   continue;
18413 |  800 |                 }
18414 |  801 | 
18415 |  802 |                 // Early skip
18416 |  803 |                 if (sample.length > 0) {
18417 |  804 |                   const newestTime = sample[0]?.time || sample[0]?.fb_time_raw;
18418 |  805 |                   const newestAge = getCommentAgeMinutes(newestTime);
18419 |  806 | 
18420 |  807 |                   if (newestAge !== null && newestAge > FAST_MAX_AGE_MIN) {
18421 |  808 |                     log.dev("FAST", `${postLabel}: SKIP - najnowszy ${Math.round(newestAge)} min`, { limit: FAST_MAX_AGE_MIN });
18422 |  809 |                     continue;
18423 |  810 |                   }
18424 |  811 |                 }
18425 |  812 | 
18426 |  813 |                 // Dedup
18427 |  814 |                 const newComments = [];
18428 |  815 |                 for (const c of sample) {
18429 |  816 |                   if (!c?.id) continue;
18430 |  817 |                   if (!knownSet.has(c.id)) {
18431 |  818 |                     knownSet.add(c.id);
18432 |  819 |                     newComments.push(c);
18433 |  820 |                     c.__postId = post.id;
18434 |  821 |                     c.__postUrl = post.url;
18435 |  822 |                   }
18436 |  823 |                 }
18437 |  824 | 
18438 |  825 |                 // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
18439 |  826 |                 cleanupKnownIds(knownSet);
18440 |  827 | 
18441 |  828 |                 // Wysy≈Çka
18442 |  829 |                 if (newComments.length > 0) {
18443 |  830 |                   log.success("FAST", `${postLabel}: +${newComments.length} nowych`);
18444 |  831 |                   newCommentsTotal += newComments.length;
18445 |  832 | 
18446 |  833 |                   const safeComments = newComments.filter((c) => c.__postId === post.id);
18447 |  834 |                   if (safeComments.length !== newComments.length) {
18448 |  835 |                     log.warn("FAST", "Odfiltrowano komentarze spoza posta", {
18449 |  836 |                       before: newComments.length,
18450 |  837 |                       after: safeComments.length,
18451 |  838 |                     });
18452 |  839 |                   }
18453 |  840 |                   await sendTelegramIfFresh(post, safeComments, "fast");
18454 |  841 |                 } else {
18455 |  842 |                   log.dev("FAST", `${postLabel}: Brak nowych`);
18456 |  843 |                 }
18457 |  844 | 
18458 |  845 |                 continue;
18459 |  846 |               }
18460 |  847 |             }
18461 |  848 |             // ==================== KONIEC FAST_MODE ====================
18462 |  849 | 
18463 |  850 |             const count = await getCommentCount(page, post.url);
18464 |  851 |             const hasCount = typeof count === "number" && Number.isFinite(count);
18465 |  852 | 
18466 |  853 |             if (!hasCount) {
18467 |  854 |               log.dev("WATCHER", `${postLabel}: Brak licznika - tryb awaryjny`);
18468 |  855 |             }
18469 |  856 | 
18470 |  857 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
18471 |  858 |             const knownSet = getKnownSetForPost(cacheKey);
18472 |  859 | 
18473 |  860 |             // Pierwsze wej≈õcie
18474 |  861 |             if (prev === null) {
18475 |  862 |               const initialCount = hasCount ? count : 0;
18476 |  863 |               lastCounts.set(cacheKey, initialCount);
18477 |  864 | 
18478 |  865 |               log.dev("WATCHER", `${postLabel}: Inicjalizacja (${initialCount} komentarzy)`);
18479 |  866 | 
18480 |  867 |               if (EXPAND_COMMENTS) {
18481 |  868 |                 await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }, post.url).catch(() => {});
18482 |  869 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
18483 |  870 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
18484 |  871 |                 log.dev("WATCHER", `${postLabel}: Zapamiƒôtano ${snap.length} istniejƒÖcych`);
18485 |  872 |               }
18486 |  873 | 
18487 |  874 |               continue;
18488 |  875 |             }
18489 |  876 | 
18490 |  877 |             if (hasCount) {
18491 |  878 |               if (count !== prev) {
18492 |  879 |                 log.dev("WATCHER", `${postLabel}: Zmiana ${prev} ‚Üí ${count}`);
18493 |  880 |                 lastCounts.set(cacheKey, count);
18494 |  881 |               } else {
18495 |  882 |                 log.dev("WATCHER", `${postLabel}: Bez zmian (${count})`);
18496 |  883 |               }
18497 |  884 |             }
18498 |  885 | 
18499 |  886 |             if (!EXPAND_COMMENTS) continue;
18500 |  887 | 
18501 |  888 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(() => {});
18502 |  889 |             const snapshot = await extractCommentsData(page, post.url).catch(() => []);
18503 |  890 | 
18504 |  891 |             const newComments = [];
18505 |  892 |             for (const c of snapshot) {
18506 |  893 |               if (!c?.id) continue;
18507 |  894 |               if (!knownSet.has(c.id)) {
18508 |  895 |                 knownSet.add(c.id);
18509 |  896 |                 newComments.push(c);
18510 |  897 |                 c.__postId = post.id;
18511 |  898 |                 c.__postUrl = post.url;
18512 |  899 |               }
18513 |  900 |             }
18514 |  901 | 
18515 |  902 |             // Cleanup knownIds je≈õli za du≈ºo (zapobiega memory leak)
18516 |  903 |             cleanupKnownIds(knownSet);
18517 |  904 | 
18518 |  905 |             log.debug("DEDUP", `${postLabel}: context`, {
18519 |  906 |               snapshotLen: snapshot.length,
18520 |  907 |               newLen: newComments.length,
18521 |  908 |             });
18522 |  909 | 
18523 |  910 |             // Fallback
18524 |  911 |             if (hasCount && newComments.length === 0 && count > prev) {
18525 |  912 |               const diff = Math.max(1, count - prev);
18526 |  913 |               const tail = snapshot.slice(-diff);
18527 |  914 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
18528 |  915 | 
18529 |  916 |               log.dev("WATCHER", `${postLabel}: Fallback - biorƒô ostatnie ${diff}`);
18530 |  917 |               await sendTelegramIfFresh(post, tail, "fallback");
18531 |  918 |               newCommentsTotal += tail.length;
18532 |  919 |               continue;
18533 |  920 |             }
18534 |  921 | 
18535 |  922 |             if (newComments.length > 0) {
18536 |  923 |               log.success("WATCHER", `${postLabel}: +${newComments.length} nowych`);
18537 |  924 |               newCommentsTotal += newComments.length;
18538 |  925 | 
18539 |  926 |               const safeComments = newComments.filter((c) => c.__postId === post.id);
18540 |  927 |               if (safeComments.length !== newComments.length) {
18541 |  928 |                 log.warn("WATCHER", "Odfiltrowano komentarze spoza posta", {
18542 |  929 |                   before: newComments.length,
18543 |  930 |                   after: safeComments.length,
18544 |  931 |                 });
18545 |  932 |               }
18546 |  933 |               await sendTelegramIfFresh(post, safeComments, "normal");
18547 |  934 |             }
18548 |  935 |           } catch (err) {
18549 |  936 |             errorsCount++;
18550 |  937 |             log.error("WATCHER", `B≈ÇƒÖd przy ${postLabel}: ${err?.message || err}`);
18551 |  938 |             log.debug("WATCHER", "Stack", { stack: err?.stack });
18552 |  939 | 
18553 |  940 |             if (isNavigationError(err)) {
18554 |  941 |               hadNavErrorThisRound = true;
18555 |  942 |               navErrorCount++;
18556 |  943 |               log.warn("WATCHER", `B≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`);
18557 |  944 |             }
18558 |  945 |           }
18559 |  946 |         }
18560 |  947 |       }
18561 |  948 |     } catch (err) {
18562 |  949 |       errorsCount++;
18563 |  950 |       log.error("WATCHER", `B≈ÇƒÖd w cyklu: ${err?.message || err}`);
18564 |  951 |     } finally {
18565 |  952 |       flushCacheToDisk();
18566 |  953 | 
18567 |  954 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
18568 |  955 |         log.dev("WATCHER", `Reset licznika b≈Çƒôd√≥w nawigacji (by≈Ço ${navErrorCount})`);
18569 |  956 |         navErrorCount = 0;
18570 |  957 |       }
18571 |  958 | 
18572 |  959 |       if (browser) {
18573 |  960 |         try {
18574 |  961 |           await browser.close();
18575 |  962 |           log.dev("WATCHER", "Zamkniƒôto przeglƒÖdarkƒô");
18576 |  963 |         } catch (e) {
18577 |  964 |           log.warn("WATCHER", `B≈ÇƒÖd zamykania przeglƒÖdarki: ${e?.message}`);
18578 |  965 |         }
18579 |  966 |       }
18580 |  967 | 
18581 |  968 |       const duration = Date.now() - cycleStart;
18582 |  969 |       const cacheSize = getCacheSize();
18583 |  970 |       const cacheEntries = getCacheEntryCount();
18584 |  971 |       const totalKnownIds = getTotalKnownIdsCount();
18585 |  972 | 
18586 |  973 |       log.cycleSummary({
18587 |  974 |         cycle: cycleNumber,
18588 |  975 |         posts: currentPosts.length,
18589 |  976 |         newComments: newCommentsTotal,
18590 |  977 |         duration,
18591 |  978 |         errors: errorsCount,
18592 |  979 |         cacheSize,
18593 |  980 |         cacheEntries,
18594 |  981 |         totalKnownIds,
18595 |  982 |       });
18596 |  983 | 
18597 |  984 |       // Alert je≈õli cache przekroczy≈Ç 10MB
18598 |  985 |       if (cacheSize > 10 * 1024 * 1024) {
18599 |  986 |         log.warn("CACHE", `Rozmiar cache przekroczy≈Ç 10MB: ${Math.round(cacheSize / 1024 / 1024)}MB`);
18600 |  987 |       }
18601 |  988 | 
18602 |  989 |       if (navErrorCount >= MAX_NAV_ERRORS) {
18603 |  990 |         log.error("WATCHER", "Za du≈ºo b≈Çƒôd√≥w nawigacji ‚Äì ko≈Ñczƒô proces");
18604 |  991 |         process.exit(1);
18605 |  992 |       }
18606 |  993 | 
18607 |  994 |       const jitter = Math.floor(Math.random() * 5000);
18608 |  995 |       const delay = CHECK_INTERVAL_MS + jitter;
18609 |  996 |       log.dev("WATCHER", `Nastƒôpny cykl za ${Math.round(delay / 1000)}s`);
18610 |  997 |       setTimeout(loop, delay);
18611 |  998 |     }
18612 |  999 |   };
18613 | 1000 | 
18614 | 1001 |   loop();
18615 | 1002 | }
18616 | 1003 | 
18617 | 1004 | export { startWatcher };
18618 | 1005 | 
18619 | ```
18620 | 
18621 | ---
18622 | 
18623 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/api.js`
18624 | **Typ:** JavaScript/tekst  
18625 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
18626 | 
18627 | ```js
18628 |   1 | import http from "http";
18629 |   2 | import { exec } from "child_process";
18630 |   3 | import fs from "fs";
18631 |   4 | import path from "path";
18632 |   5 | import crypto from "crypto";
18633 |   6 | import dotenv from "dotenv";
18634 |   7 | 
18635 |   8 | // ---- BASE DIR (dev vs exe) ----
18636 |   9 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
18637 |  10 | 
18638 |  11 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
18639 |  12 | dotenv.config({ path: path.join(process.cwd(), ".env") });
18640 |  13 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
18641 |  14 | 
18642 |  15 | // UI: dev -> src/panel/ui, exe -> ./ui
18643 |  16 | const UI_DIR = process.pkg
18644 |  17 |   ? path.join(BASE_DIR, "ui")
18645 |  18 |   : path.join(BASE_DIR, "src", "panel", "ui");
18646 |  19 | 
18647 |  20 | const PORT = Number(process.env.PANEL_PORT || 3180);
18648 |  21 | const TOKEN = process.env.PANEL_TOKEN;
18649 |  22 | 
18650 |  23 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
18651 |  24 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
18652 |  25 | 
18653 |  26 | if (!TOKEN) {
18654 |  27 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
18655 |  28 |   process.exit(1);
18656 |  29 | }
18657 |  30 | 
18658 |  31 | function auth(req, res) {
18659 |  32 |   const h = req.headers["authorization"] || "";
18660 |  33 |   if (h !== `Bearer ${TOKEN}`) {
18661 |  34 |     res.writeHead(401);
18662 |  35 |     res.end("Unauthorized");
18663 |  36 |     return false;
18664 |  37 |   }
18665 |  38 |   return true;
18666 |  39 | }
18667 |  40 | 
18668 |  41 | function json(res, obj, code = 200) {
18669 |  42 |   res.writeHead(code, { "Content-Type": "application/json" });
18670 |  43 |   res.end(JSON.stringify(obj, null, 2));
18671 |  44 | }
18672 |  45 | 
18673 |  46 | function sh(cmd) {
18674 |  47 |   return new Promise((resolve) => {
18675 |  48 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
18676 |  49 |       resolve({
18677 |  50 |         ok: !err,
18678 |  51 |         stdout: (stdout || "").trim(),
18679 |  52 |         stderr: (stderr || "").trim(),
18680 |  53 |         code: err?.code ?? 0,
18681 |  54 |       });
18682 |  55 |     });
18683 |  56 |   });
18684 |  57 | }
18685 |  58 | 
18686 |  59 | async function getProjectDir() {
18687 |  60 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
18688 |  61 | 
18689 |  62 |   const r = await sh(`pm2 describe ${PM2_APP}`);
18690 |  63 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
18691 |  64 |   if (!m)
18692 |  65 |     throw new Error(
18693 |  66 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
18694 |  67 |     );
18695 |  68 |   return m[1].trim();
18696 |  69 | }
18697 |  70 | 
18698 |  71 | function readBody(req) {
18699 |  72 |   return new Promise((resolve) => {
18700 |  73 |     let d = "";
18701 |  74 |     req.on("data", (c) => (d += c));
18702 |  75 |     req.on("end", () => resolve(d));
18703 |  76 |   });
18704 |  77 | }
18705 |  78 | 
18706 |  79 | function safeJsonParse(s) {
18707 |  80 |   try {
18708 |  81 |     return { ok: true, value: JSON.parse(s) };
18709 |  82 |   } catch (e) {
18710 |  83 |     return { ok: false, error: e?.message || "Invalid JSON" };
18711 |  84 |   }
18712 |  85 | }
18713 |  86 | 
18714 |  87 | function ensureDir(p) {
18715 |  88 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
18716 |  89 | }
18717 |  90 | 
18718 |  91 | function atomicWriteFile(filePath, content) {
18719 |  92 |   const dir = path.dirname(filePath);
18720 |  93 |   ensureDir(dir);
18721 |  94 | 
18722 |  95 |   const tmp = path.join(
18723 |  96 |     dir,
18724 |  97 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
18725 |  98 |   );
18726 |  99 |   fs.writeFileSync(tmp, content, "utf8");
18727 | 100 |   fs.renameSync(tmp, filePath);
18728 | 101 | }
18729 | 102 | 
18730 | 103 | function normalizeUrl(u) {
18731 | 104 |   if (!u) return "";
18732 | 105 |   const x = String(u).trim();
18733 | 106 |   if (!/^https?:\/\/.+/i.test(x)) return "";
18734 | 107 |   return x;
18735 | 108 | }
18736 | 109 | 
18737 | 110 | function normalizeOptionalUrl(u) {
18738 | 111 |   if (!u) return "";
18739 | 112 |   const x = String(u).trim();
18740 | 113 |   if (x === "") return "";
18741 | 114 |   if (!/^https?:\/\/.+/i.test(x)) return "";
18742 | 115 |   return x;
18743 | 116 | }
18744 | 117 | 
18745 | 118 | function nowIso() {
18746 | 119 |   return new Date().toISOString();
18747 | 120 | }
18748 | 121 | 
18749 | 122 | function setEnvKey(envText, key, value) {
18750 | 123 |   const re = new RegExp(`^${key}=.*$`, "m");
18751 | 124 |   const line = `${key}=${value}`;
18752 | 125 |   if (re.test(envText)) return envText.replace(re, line);
18753 | 126 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
18754 | 127 | }
18755 | 128 | 
18756 | 129 | function pickPostsFile(projectDir) {
18757 | 130 |   return path.join(projectDir, "data", "posts.json");
18758 | 131 | }
18759 | 132 | 
18760 | 133 | function readPosts(postsPath) {
18761 | 134 |   if (!fs.existsSync(postsPath)) return [];
18762 | 135 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
18763 | 136 |   if (!raw) return [];
18764 | 137 |   const parsed = safeJsonParse(raw);
18765 | 138 |   if (!parsed.ok || !Array.isArray(parsed.value))
18766 | 139 |     throw new Error("posts.json invalid (expected array)");
18767 | 140 |   return parsed.value;
18768 | 141 | }
18769 | 142 | 
18770 | 143 | function writePosts(postsPath, posts) {
18771 | 144 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
18772 | 145 | }
18773 | 146 | 
18774 | 147 | function genId() {
18775 | 148 |   return crypto.randomBytes(8).toString("hex");
18776 | 149 | }
18777 | 150 | 
18778 | 151 | function route(req) {
18779 | 152 |   const url = new URL(req.url, "http://localhost");
18780 | 153 |   const pathname = url.pathname;
18781 | 154 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
18782 | 155 | }
18783 | 156 | 
18784 | 157 | function match(pathname, pattern) {
18785 | 158 |   const a = pathname.split("/").filter(Boolean);
18786 | 159 |   const b = pattern.split("/").filter(Boolean);
18787 | 160 |   if (a.length !== b.length) return null;
18788 | 161 |   const params = {};
18789 | 162 |   for (let i = 0; i < a.length; i++) {
18790 | 163 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
18791 | 164 |     else if (a[i] !== b[i]) return null;
18792 | 165 |   }
18793 | 166 |   return params;
18794 | 167 | }
18795 | 168 | 
18796 | 169 | // ---------- LOGS (dynamic from pm2 describe) ----------
18797 | 170 | function parsePm2LogPaths(pm2DescribeText) {
18798 | 171 |   const out =
18799 | 172 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
18800 | 173 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
18801 | 174 |     "";
18802 | 175 |   const err =
18803 | 176 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
18804 | 177 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
18805 | 178 |     "";
18806 | 179 |   return { out, err };
18807 | 180 | }
18808 | 181 | 
18809 | 182 | async function getPm2LogPaths(appName) {
18810 | 183 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
18811 | 184 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
18812 | 185 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
18813 | 186 | 
18814 | 187 |   const d = await sh(`pm2 describe ${appName}`);
18815 | 188 |   if (!d.ok)
18816 | 189 |     return {
18817 | 190 |       out: "",
18818 | 191 |       err: "",
18819 | 192 |       source: "pm2_error",
18820 | 193 |       pm2: d.stderr || d.stdout || "",
18821 | 194 |     };
18822 | 195 | 
18823 | 196 |   const p = parsePm2LogPaths(d.stdout);
18824 | 197 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
18825 | 198 | }
18826 | 199 | 
18827 | 200 | async function readTailLog(filePath, lines) {
18828 | 201 |   try {
18829 | 202 |     if (!filePath) {
18830 | 203 |       return {
18831 | 204 |         ok: false,
18832 | 205 |         error:
18833 | 206 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
18834 | 207 |         path: filePath,
18835 | 208 |       };
18836 | 209 |     }
18837 | 210 | 
18838 | 211 |     if (!fs.existsSync(filePath)) {
18839 | 212 |       return {
18840 | 213 |         ok: false,
18841 | 214 |         error:
18842 | 215 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
18843 | 216 |         path: filePath,
18844 | 217 |       };
18845 | 218 |     }
18846 | 219 | 
18847 | 220 |     const st = fs.statSync(filePath);
18848 | 221 |     if (!st || !st.isFile()) {
18849 | 222 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
18850 | 223 |     }
18851 | 224 | 
18852 | 225 |     if (st.size === 0) {
18853 | 226 |       return {
18854 | 227 |         ok: false,
18855 | 228 |         error:
18856 | 229 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
18857 | 230 |         path: filePath,
18858 | 231 |       };
18859 | 232 |     }
18860 | 233 | 
18861 | 234 |     const tailCmd = `tail -n ${lines} "${filePath}"`;
18862 | 235 |     const r = await sh(tailCmd);
18863 | 236 | 
18864 | 237 |     if (r.ok && (r.stdout || "").trim()) {
18865 | 238 |       return { ok: true, log: r.stdout, path: filePath, via: "tail" };
18866 | 239 |     }
18867 | 240 | 
18868 | 241 |     // fallback JS
18869 | 242 |     const raw = fs.readFileSync(filePath, "utf8");
18870 | 243 |     const arr = raw.split(/\r?\n/);
18871 | 244 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
18872 | 245 |     const txt = (slice || "").trim();
18873 | 246 | 
18874 | 247 |     if (!txt) {
18875 | 248 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
18876 | 249 |     }
18877 | 250 | 
18878 | 251 |     return { ok: true, log: slice, path: filePath, via: "js" };
18879 | 252 |   } catch (e) {
18880 | 253 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
18881 | 254 |   }
18882 | 255 | }
18883 | 256 | 
18884 | 257 | http
18885 | 258 |   .createServer(async (req, res) => {
18886 | 259 |     const { pathname, query } = route(req);
18887 | 260 | 
18888 | 261 |     // ---------- PUBLIC UI ----------
18889 | 262 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
18890 | 263 |       const p = path.join(UI_DIR, "index.html");
18891 | 264 |       const html = fs.readFileSync(p, "utf8");
18892 | 265 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
18893 | 266 |       res.end(html);
18894 | 267 |       return;
18895 | 268 |     }
18896 | 269 | 
18897 | 270 |     if (req.method === "GET" && pathname === "/app.js") {
18898 | 271 |       const p = path.join(UI_DIR, "app.js");
18899 | 272 |       const js = fs.readFileSync(p, "utf8");
18900 | 273 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
18901 | 274 |       res.end(js);
18902 | 275 |       return;
18903 | 276 |     }
18904 | 277 | 
18905 | 278 |     // ---------- AUTH for API ----------
18906 | 279 |     if (pathname.startsWith("/api/")) {
18907 | 280 |       if (!auth(req, res)) return;
18908 | 281 |     }
18909 | 282 | 
18910 | 283 |     try {
18911 | 284 |       const PROJECT_DIR = await getProjectDir();
18912 | 285 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
18913 | 286 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
18914 | 287 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
18915 | 288 | 
18916 | 289 |       // ===== STATUS =====
18917 | 290 |       if (req.method === "GET" && pathname === "/api/status") {
18918 | 291 |         const node = await sh("node -v");
18919 | 292 |         const pm2v = await sh("pm2 -v");
18920 | 293 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
18921 | 294 |         json(res, {
18922 | 295 |           ok: true,
18923 | 296 |           projectDir: PROJECT_DIR,
18924 | 297 |           envPath: ENV_PATH,
18925 | 298 |           cookiesPath: COOKIES_PATH,
18926 | 299 |           postsPath: POSTS_PATH,
18927 | 300 |           node: node.stdout,
18928 | 301 |           pm2: pm2v.stdout,
18929 | 302 |           pm2Status: pm2s.stdout,
18930 | 303 |           time: nowIso(),
18931 | 304 |         });
18932 | 305 |         return;
18933 | 306 |       }
18934 | 307 | 
18935 | 308 |       // ===== ENV GET (selected keys) =====
18936 | 309 |       if (req.method === "GET" && pathname === "/api/env/get") {
18937 | 310 |         if (!fs.existsSync(ENV_PATH)) {
18938 | 311 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
18939 | 312 |           return;
18940 | 313 |         }
18941 | 314 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
18942 | 315 |         const wanted = [
18943 | 316 |           "FB_EMAIL",
18944 | 317 |           "FB_PASSWORD",
18945 | 318 |           "WEBHOOK_URL",
18946 | 319 |           "CHECK_INTERVAL_MS",
18947 | 320 |           "POSTS_SHEET_URL",
18948 | 321 |           "HEADLESS_BROWSER",
18949 | 322 |           "USE_UI_HANDLERS",
18950 | 323 |           "INCLUDE_REPLIES",
18951 | 324 |         ];
18952 | 325 |         const values = {};
18953 | 326 |         for (const k of wanted) {
18954 | 327 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
18955 | 328 |           values[k] = m ? m[1] : "";
18956 | 329 |         }
18957 | 330 |         json(res, { ok: true, values });
18958 | 331 |         return;
18959 | 332 |       }
18960 | 333 | 
18961 | 334 |       // ===== ENV SET MULTIPLE =====
18962 | 335 |       if (req.method === "POST" && pathname === "/api/env/set") {
18963 | 336 |         const bodyRaw = await readBody(req);
18964 | 337 |         const parsed = safeJsonParse(bodyRaw || "{}");
18965 | 338 |         if (!parsed.ok) {
18966 | 339 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
18967 | 340 |           return;
18968 | 341 |         }
18969 | 342 | 
18970 | 343 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
18971 | 344 |         const restart = Boolean(parsed.value.restart);
18972 | 345 | 
18973 | 346 |         if (!set) {
18974 | 347 |           json(res, { ok: false, error: "Missing set object" }, 400);
18975 | 348 |           return;
18976 | 349 |         }
18977 | 350 |         if (!fs.existsSync(ENV_PATH)) {
18978 | 351 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
18979 | 352 |           return;
18980 | 353 |         }
18981 | 354 | 
18982 | 355 |         let env = fs.readFileSync(ENV_PATH, "utf8");
18983 | 356 |         const updated = [];
18984 | 357 | 
18985 | 358 |         for (const [k, v] of Object.entries(set)) {
18986 | 359 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
18987 | 360 |           env = setEnvKey(env, k, String(v));
18988 | 361 |           updated.push(k);
18989 | 362 |         }
18990 | 363 | 
18991 | 364 |         atomicWriteFile(ENV_PATH, env);
18992 | 365 | 
18993 | 366 |         let pm2Action = null;
18994 | 367 |         if (restart) {
18995 | 368 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
18996 | 369 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
18997 | 370 |         }
18998 | 371 | 
18999 | 372 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
19000 | 373 |         return;
19001 | 374 |       }
19002 | 375 | 
19003 | 376 |       // ===== POSTS: LIST =====
19004 | 377 |       if (req.method === "GET" && pathname === "/api/posts") {
19005 | 378 |         const posts = readPosts(POSTS_PATH);
19006 | 379 | 
19007 | 380 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
19008 | 381 |         const norm = (posts || []).map((p) => ({
19009 | 382 |           id: String(p.id || "").trim(),
19010 | 383 |           url: String(p.url || "").trim(),
19011 | 384 |           active: p.active !== undefined ? Boolean(p.active) : true,
19012 | 385 |           name: String(p.name || "").trim(),
19013 | 386 |           image: String(p.image || "").trim(),
19014 | 387 |           description: String(p.description || "").trim(),
19015 | 388 |           createdAt: p.createdAt || "",
19016 | 389 |           updatedAt: p.updatedAt || "",
19017 | 390 |         }));
19018 | 391 | 
19019 | 392 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
19020 | 393 |         json(res, { ok: true, posts: norm });
19021 | 394 |         return;
19022 | 395 |       }
19023 | 396 | 
19024 | 397 |       // ===== POSTS: ADD =====
19025 | 398 |       if (req.method === "POST" && pathname === "/api/posts") {
19026 | 399 |         const bodyRaw = await readBody(req);
19027 | 400 |         const parsed = safeJsonParse(bodyRaw || "{}");
19028 | 401 |         if (!parsed.ok) {
19029 | 402 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
19030 | 403 |           return;
19031 | 404 |         }
19032 | 405 | 
19033 | 406 |         const url = normalizeUrl(parsed.value.url);
19034 | 407 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
19035 | 408 | 
19036 | 409 |         const name = String(parsed.value.name || "").trim();
19037 | 410 |         const imageRaw = String(parsed.value.image || "").trim();
19038 | 411 |         const image = normalizeOptionalUrl(imageRaw);
19039 | 412 |         const description = String(parsed.value.description || "").trim();
19040 | 413 | 
19041 | 414 |         if (!url) {
19042 | 415 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
19043 | 416 |           return;
19044 | 417 |         }
19045 | 418 |         if (imageRaw !== "" && !image) {
19046 | 419 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
19047 | 420 |           return;
19048 | 421 |         }
19049 | 422 | 
19050 | 423 |         const posts = readPosts(POSTS_PATH);
19051 | 424 |         const existing = posts.find((p) => p.url === url);
19052 | 425 |         if (existing) {
19053 | 426 |           existing.active = active;
19054 | 427 |           existing.name = name;
19055 | 428 |           existing.image = image;
19056 | 429 |           existing.description = description;
19057 | 430 |           existing.updatedAt = nowIso();
19058 | 431 |           writePosts(POSTS_PATH, posts);
19059 | 432 |           json(res, { ok: true, post: existing, deduped: true });
19060 | 433 |           return;
19061 | 434 |         }
19062 | 435 | 
19063 | 436 |         const post = {
19064 | 437 |           id: genId(),
19065 | 438 |           url,
19066 | 439 |           active,
19067 | 440 |           name,
19068 | 441 |           image,
19069 | 442 |           description,
19070 | 443 |           createdAt: nowIso(),
19071 | 444 |           updatedAt: nowIso(),
19072 | 445 |         };
19073 | 446 |         posts.push(post);
19074 | 447 |         writePosts(POSTS_PATH, posts);
19075 | 448 | 
19076 | 449 |         json(res, { ok: true, post });
19077 | 450 |         return;
19078 | 451 |       }
19079 | 452 | 
19080 | 453 |       // ===== POSTS: PATCH =====
19081 | 454 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
19082 | 455 |       if (mPatch) {
19083 | 456 |         const id = mPatch.id;
19084 | 457 |         const bodyRaw = await readBody(req);
19085 | 458 |         const parsed = safeJsonParse(bodyRaw || "{}");
19086 | 459 |         if (!parsed.ok) {
19087 | 460 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
19088 | 461 |           return;
19089 | 462 |         }
19090 | 463 | 
19091 | 464 |         const posts = readPosts(POSTS_PATH);
19092 | 465 |         const post = posts.find((p) => p.id === id);
19093 | 466 |         if (!post) {
19094 | 467 |           json(res, { ok: false, error: "Post not found" }, 404);
19095 | 468 |           return;
19096 | 469 |         }
19097 | 470 | 
19098 | 471 |         if (parsed.value.url !== undefined) {
19099 | 472 |           const nextUrl = normalizeUrl(parsed.value.url);
19100 | 473 |           if (!nextUrl) {
19101 | 474 |             json(res, { ok: false, error: "Invalid url" }, 400);
19102 | 475 |             return;
19103 | 476 |           }
19104 | 477 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
19105 | 478 |           if (dup) {
19106 | 479 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
19107 | 480 |             return;
19108 | 481 |           }
19109 | 482 |           post.url = nextUrl;
19110 | 483 |         }
19111 | 484 | 
19112 | 485 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
19113 | 486 | 
19114 | 487 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
19115 | 488 | 
19116 | 489 |         if (parsed.value.image !== undefined) {
19117 | 490 |           const raw = String(parsed.value.image || "").trim();
19118 | 491 |           const img = normalizeOptionalUrl(raw);
19119 | 492 |           if (raw !== "" && !img) {
19120 | 493 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
19121 | 494 |             return;
19122 | 495 |           }
19123 | 496 |           post.image = img;
19124 | 497 |         }
19125 | 498 | 
19126 | 499 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
19127 | 500 | 
19128 | 501 |         post.updatedAt = nowIso();
19129 | 502 |         writePosts(POSTS_PATH, posts);
19130 | 503 |         json(res, { ok: true, post });
19131 | 504 |         return;
19132 | 505 |       }
19133 | 506 | 
19134 | 507 |       // ===== POSTS: DELETE =====
19135 | 508 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
19136 | 509 |       if (mDel) {
19137 | 510 |         const id = mDel.id;
19138 | 511 |         const posts = readPosts(POSTS_PATH);
19139 | 512 |         const idx = posts.findIndex((p) => p.id === id);
19140 | 513 |         if (idx === -1) {
19141 | 514 |           json(res, { ok: false, error: "Post not found" }, 404);
19142 | 515 |           return;
19143 | 516 |         }
19144 | 517 |         const removed = posts.splice(idx, 1)[0];
19145 | 518 |         writePosts(POSTS_PATH, posts);
19146 | 519 |         json(res, { ok: true, removed });
19147 | 520 |         return;
19148 | 521 |       }
19149 | 522 | 
19150 | 523 |       // ===== COOKIES: CLEAR =====
19151 | 524 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
19152 | 525 |         const bodyRaw = await readBody(req);
19153 | 526 |         const parsed = safeJsonParse(bodyRaw || "{}");
19154 | 527 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
19155 | 528 | 
19156 | 529 |         if (!confirm) {
19157 | 530 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
19158 | 531 |           return;
19159 | 532 |         }
19160 | 533 | 
19161 | 534 |         atomicWriteFile(COOKIES_PATH, "[]\n");
19162 | 535 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
19163 | 536 |         return;
19164 | 537 |       }
19165 | 538 | 
19166 | 539 |       // ===== PM2 =====
19167 | 540 |       function okOrErr(r, fallbackErr = "Command failed") {
19168 | 541 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
19169 | 542 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
19170 | 543 |       }
19171 | 544 |       async function pm2Describe(name) {
19172 | 545 |         return await sh(`pm2 describe ${name}`);
19173 | 546 |       }
19174 | 547 | 
19175 | 548 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
19176 | 549 |       const WATCH_NAME = PM2_APP || "fbwatcher";
19177 | 550 | 
19178 | 551 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
19179 | 552 |         const d = await pm2Describe(WATCH_NAME);
19180 | 553 |         if (d.ok) {
19181 | 554 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
19182 | 555 |           json(res, okOrErr(r, "PM2 start failed"));
19183 | 556 |           return;
19184 | 557 |         }
19185 | 558 | 
19186 | 559 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
19187 | 560 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
19188 | 561 |         return;
19189 | 562 |       }
19190 | 563 | 
19191 | 564 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
19192 | 565 |         const d = await pm2Describe(WATCH_NAME);
19193 | 566 |         if (!d.ok) {
19194 | 567 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
19195 | 568 |           return;
19196 | 569 |         }
19197 | 570 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
19198 | 571 |         json(res, okOrErr(r, "PM2 restart failed"));
19199 | 572 |         return;
19200 | 573 |       }
19201 | 574 | 
19202 | 575 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
19203 | 576 |         const d = await pm2Describe(WATCH_NAME);
19204 | 577 |         if (!d.ok) {
19205 | 578 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
19206 | 579 |           return;
19207 | 580 |         }
19208 | 581 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
19209 | 582 |         json(res, okOrErr(r, "PM2 stop failed"));
19210 | 583 |         return;
19211 | 584 |       }
19212 | 585 | 
19213 | 586 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
19214 | 587 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
19215 | 588 |         json(res, okOrErr(r, "PM2 status failed"));
19216 | 589 |         return;
19217 | 590 |       }
19218 | 591 | 
19219 | 592 |       // ===== LOGS INFO (debug) =====
19220 | 593 |       if (req.method === "GET" && pathname === "/api/logs/info") {
19221 | 594 |         const paths = await getPm2LogPaths(PM2_APP);
19222 | 595 |         json(res, { ok: true, app: PM2_APP, ...paths });
19223 | 596 |         return;
19224 | 597 |       }
19225 | 598 | 
19226 | 599 |       // ===== LOGS =====
19227 | 600 |       if (req.method === "GET" && pathname === "/api/logs/out") {
19228 | 601 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
19229 | 602 |         const paths = await getPm2LogPaths(PM2_APP);
19230 | 603 |         const payload = await readTailLog(paths.out, lines);
19231 | 604 |         json(res, { ...payload, source: paths.source });
19232 | 605 |         return;
19233 | 606 |       }
19234 | 607 | 
19235 | 608 |       if (req.method === "GET" && pathname === "/api/logs/err") {
19236 | 609 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
19237 | 610 |         const paths = await getPm2LogPaths(PM2_APP);
19238 | 611 |         const payload = await readTailLog(paths.err, lines);
19239 | 612 |         json(res, { ...payload, source: paths.source });
19240 | 613 |         return;
19241 | 614 |       }
19242 | 615 | 
19243 | 616 |       json(res, { ok: false, error: "Not found" }, 404);
19244 | 617 |     } catch (e) {
19245 | 618 |       json(res, { ok: false, error: e.message }, 500);
19246 | 619 |     }
19247 | 620 |   })
19248 | 621 |   .listen(PORT, "127.0.0.1", () => {
19249 | 622 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
19250 | 623 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
19251 | 624 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
19252 | 625 |   });
19253 | 626 | 
19254 | ```
19255 | 
19256 | ---
19257 | 
19258 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/panel-entry.cjs`
19259 | **Typ:** JavaScript/tekst  
19260 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
19261 | 
19262 | ```js
19263 | 1 | // src/panel/panel-entry.cjs
19264 | 2 | require("./api.js");
19265 | 3 | 
19266 | ```
19267 | 
19268 | ---
19269 | 
19270 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/app.js`
19271 | **Typ:** JavaScript/tekst  
19272 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
19273 | 
19274 | ```js
19275 |   1 | const $ = (id) => document.getElementById(id);
19276 |   2 | 
19277 |   3 | /* =========================
19278 |   4 |    AUTH / API
19279 |   5 | ========================= */
19280 |   6 | 
19281 |   7 | function getToken() {
19282 |   8 |   return localStorage.getItem("panel_token") || "";
19283 |   9 | }
19284 |  10 | function setToken(t) {
19285 |  11 |   localStorage.setItem("panel_token", t || "");
19286 |  12 | }
19287 |  13 | 
19288 |  14 | async function api(path, opts = {}) {
19289 |  15 |   const token = getToken();
19290 |  16 |   const headers = Object.assign({}, opts.headers || {}, {
19291 |  17 |     Authorization: `Bearer ${token}`,
19292 |  18 |   });
19293 |  19 | 
19294 |  20 |   const res = await fetch(path, { ...opts, headers });
19295 |  21 |   const text = await res.text();
19296 |  22 | 
19297 |  23 |   let json;
19298 |  24 |   try {
19299 |  25 |     json = JSON.parse(text);
19300 |  26 |   } catch {
19301 |  27 |     json = { ok: false, error: "Non-JSON response", raw: text };
19302 |  28 |   }
19303 |  29 | 
19304 |  30 |   if (!res.ok || json.ok === false) {
19305 |  31 |     throw new Error(
19306 |  32 |       json.error ||
19307 |  33 |         json.output ||
19308 |  34 |         json.raw ||
19309 |  35 |         `HTTP ${res.status}`
19310 |  36 |     );
19311 |  37 |   }
19312 |  38 | 
19313 |  39 |   return json;
19314 |  40 | }
19315 |  41 | 
19316 |  42 | function msg(el, s) {
19317 |  43 |   el.textContent = s;
19318 |  44 | }
19319 |  45 | 
19320 |  46 | /* =========================
19321 |  47 |    STATUS / ENV
19322 |  48 | ========================= */
19323 |  49 | 
19324 |  50 | async function refreshAll() {
19325 |  51 |   try {
19326 |  52 |     const st = await api("/api/status");
19327 |  53 |     msg(
19328 |  54 |       $("status"),
19329 |  55 |       `OK ‚Ä¢ ${st.time} ‚Ä¢ node=${st.node} ‚Ä¢ pm2=${(st.pm2 || "").trim()}`
19330 |  56 |     );
19331 |  57 | 
19332 |  58 |     const env = await api("/api/env/get");
19333 |  59 |     const keys = [
19334 |  60 |       "FB_EMAIL",
19335 |  61 |       "FB_PASSWORD",
19336 |  62 |       "WEBHOOK_URL",
19337 |  63 |       "CHECK_INTERVAL_MS",
19338 |  64 |       "POSTS_SHEET_URL",
19339 |  65 |       "HEADLESS_BROWSER",
19340 |  66 |       "USE_UI_HANDLERS",
19341 |  67 |       "INCLUDE_REPLIES",
19342 |  68 |     ];
19343 |  69 |     for (const k of keys) {
19344 |  70 |       if ($(k)) $(k).value = env.values[k] ?? "";
19345 |  71 |     }
19346 |  72 | 
19347 |  73 |     await loadPosts();
19348 |  74 |   } catch (e) {
19349 |  75 |     msg($("status"), `B≈ÅƒÑD: ${e.message}`);
19350 |  76 |   }
19351 |  77 | }
19352 |  78 | 
19353 |  79 | /* =========================
19354 |  80 |    POSTS
19355 |  81 | ========================= */
19356 |  82 | 
19357 |  83 | function esc(s) {
19358 |  84 |   return String(s || "")
19359 |  85 |     .replaceAll("&", "&amp;")
19360 |  86 |     .replaceAll("<", "&lt;")
19361 |  87 |     .replaceAll(">", "&gt;");
19362 |  88 | }
19363 |  89 | 
19364 |  90 | async function loadPosts() {
19365 |  91 |   const r = await api("/api/posts");
19366 |  92 |   const tbody = $("posts");
19367 |  93 |   tbody.innerHTML = "";
19368 |  94 | 
19369 |  95 |   for (const p of r.posts || []) {
19370 |  96 |     const tr = document.createElement("tr");
19371 |  97 | 
19372 |  98 |     tr.innerHTML = `
19373 |  99 |       <td class="mono">${esc(p.id)}</td>
19374 | 100 |       <td><a href="${esc(p.url)}" target="_blank">${esc(p.url)}</a></td>
19375 | 101 |       <td>${esc(p.name || "")}</td>
19376 | 102 |       <td>
19377 | 103 |         ${p.image ? `<img src="${esc(p.image)}" style="width:60px;border-radius:6px;">` : "‚Äî"}
19378 | 104 |       </td>
19379 | 105 |       <td>${esc(p.description || "")}</td>
19380 | 106 |       <td>
19381 | 107 |         <input type="checkbox" ${p.active ? "checked" : ""} data-id="${p.id}" class="toggleActive">
19382 | 108 |       </td>
19383 | 109 |       <td>
19384 | 110 |         <button data-id="${p.id}" class="edit">Edytuj</button>
19385 | 111 |         <button data-id="${p.id}" class="del">Usu≈Ñ</button>
19386 | 112 |       </td>
19387 | 113 |     `;
19388 | 114 | 
19389 | 115 |     tbody.appendChild(tr);
19390 | 116 |   }
19391 | 117 | 
19392 | 118 |   /* aktywno≈õƒá */
19393 | 119 |   document.querySelectorAll(".toggleActive").forEach((cb) => {
19394 | 120 |     cb.addEventListener("change", async (e) => {
19395 | 121 |       await api(`/api/posts/${e.target.dataset.id}`, {
19396 | 122 |         method: "PATCH",
19397 | 123 |         headers: { "Content-Type": "application/json" },
19398 | 124 |         body: JSON.stringify({ active: e.target.checked }),
19399 | 125 |       });
19400 | 126 |     });
19401 | 127 |   });
19402 | 128 | 
19403 | 129 |   /* usu≈Ñ */
19404 | 130 |   document.querySelectorAll(".del").forEach((btn) => {
19405 | 131 |     btn.addEventListener("click", async () => {
19406 | 132 |       await api(`/api/posts/${btn.dataset.id}`, { method: "DELETE" });
19407 | 133 |       await loadPosts();
19408 | 134 |     });
19409 | 135 |   });
19410 | 136 | 
19411 | 137 |   /* EDYCJA ‚Äî TU JEST FIX */
19412 | 138 |   document.querySelectorAll(".edit").forEach((btn) => {
19413 | 139 |     btn.addEventListener("click", async () => {
19414 | 140 |       const r2 = await api("/api/posts");
19415 | 141 |       const post = r2.posts.find((x) => x.id === btn.dataset.id);
19416 | 142 |       if (!post) return;
19417 | 143 | 
19418 | 144 |       const nameInput = prompt("Name (nazwa):", post.name || "");
19419 | 145 |       const imageInput = prompt("Image URL (zdjƒôcie):", post.image || "");
19420 | 146 |       const descInput = prompt("Description (opis):", post.description || "");
19421 | 147 | 
19422 | 148 |       const name =
19423 | 149 |         nameInput === null ? post.name || "" : nameInput;
19424 | 150 |       const image =
19425 | 151 |         imageInput === null ? post.image || "" : imageInput;
19426 | 152 |       const description =
19427 | 153 |         descInput === null ? post.description || "" : descInput;
19428 | 154 | 
19429 | 155 |       await api(`/api/posts/${post.id}`, {
19430 | 156 |         method: "PATCH",
19431 | 157 |         headers: { "Content-Type": "application/json" },
19432 | 158 |         body: JSON.stringify({
19433 | 159 |           name: String(name).trim(),
19434 | 160 |           image: String(image).trim(),
19435 | 161 |           description: String(description).trim(),
19436 | 162 |         }),
19437 | 163 |       });
19438 | 164 | 
19439 | 165 |       await loadPosts();
19440 | 166 |     });
19441 | 167 |   });
19442 | 168 | }
19443 | 169 | 
19444 | 170 | /* =========================
19445 | 171 |    ADD POST
19446 | 172 | ========================= */
19447 | 173 | 
19448 | 174 | $("addPost").addEventListener("click", async () => {
19449 | 175 |   await api("/api/posts", {
19450 | 176 |     method: "POST",
19451 | 177 |     headers: { "Content-Type": "application/json" },
19452 | 178 |     body: JSON.stringify({
19453 | 179 |       url: $("newPostUrl").value.trim(),
19454 | 180 |       name: $("newPostName").value.trim(),
19455 | 181 |       image: $("newPostImage").value.trim(),
19456 | 182 |       description: $("newPostDescription").value.trim(),
19457 | 183 |       active: $("newPostActive").checked,
19458 | 184 |     }),
19459 | 185 |   });
19460 | 186 | 
19461 | 187 |   $("newPostUrl").value = "";
19462 | 188 |   $("newPostName").value = "";
19463 | 189 |   $("newPostImage").value = "";
19464 | 190 |   $("newPostDescription").value = "";
19465 | 191 | 
19466 | 192 |   await loadPosts();
19467 | 193 | });
19468 | 194 | 
19469 | 195 | /* =========================
19470 | 196 |    INIT
19471 | 197 | ========================= */
19472 | 198 | 
19473 | 199 | $("saveToken").addEventListener("click", () => {
19474 | 200 |   setToken($("token").value.trim());
19475 | 201 |   refreshAll();
19476 | 202 | });
19477 | 203 | 
19478 | 204 | $("refresh").addEventListener("click", refreshAll);
19479 | 205 | 
19480 | 206 | (function init() {
19481 | 207 |   $("token").value = getToken();
19482 | 208 |   refreshAll();
19483 | 209 | })();
19484 | 210 | 
19485 | ```
19486 | 
19487 | ---
19488 | 
19489 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/panel/ui/index.html`
19490 | **Typ:** HTML  
19491 | **Opis:** Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.  
19492 | 
19493 | ```html
19494 |   1 | <!doctype html>
19495 |   2 | <html lang="pl">
19496 |   3 | <head>
19497 |   4 |   <meta charset="utf-8" />
19498 |   5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
19499 |   6 |   <title>FB Watcher Panel</title>
19500 |   7 |   <style>
19501 |   8 |     body { font-family: system-ui, Arial; margin: 16px; background:#0b0f14; color:#e7eef7; }
19502 |   9 |     .row { display:flex; gap:12px; flex-wrap:wrap; }
19503 |  10 |     .card { background:#121926; border:1px solid #223047; border-radius:12px; padding:14px; margin:12px 0; }
19504 |  11 |     input, textarea, button, select { font: inherit; border-radius:10px; border:1px solid #2a3a55; background:#0b1220; color:#e7eef7; padding:10px; }
19505 |  12 |     input, textarea { width: 100%; box-sizing:border-box; }
19506 |  13 |     button { cursor:pointer; }
19507 |  14 |     button.primary { background:#2563eb; border-color:#2563eb; }
19508 |  15 |     button.danger { background:#b91c1c; border-color:#b91c1c; }
19509 |  16 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
19510 |  17 |     table { width:100%; border-collapse: collapse; }
19511 |  18 |     th, td { border-bottom:1px solid #223047; padding:8px; text-align:left; vertical-align:top; }
19512 |  19 |     .muted { opacity:0.75; font-size:12px; }
19513 |  20 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
19514 |  21 |     .sep { height:1px; background:#223047; margin:10px 0; opacity:0.8; }
19515 |  22 |     .thumb { width:64px; height:40px; object-fit:cover; border-radius:8px; border:1px solid #223047; background:#0b1220; }
19516 |  23 |   </style>
19517 |  24 | </head>
19518 |  25 | <body>
19519 |  26 |   <h2>FB Watcher ‚Äî Panel</h2>
19520 |  27 |   <div class="muted">Panel dzia≈Ça lokalnie. Token wymagany do akcji.</div>
19521 |  28 | 
19522 |  29 |   <div class="card">
19523 |  30 |     <div class="row">
19524 |  31 |       <div style="flex:1; min-width:260px;">
19525 |  32 |         <label>Token panelu</label>
19526 |  33 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
19527 |  34 |       </div>
19528 |  35 |       <div style="display:flex; gap:10px; align-items:flex-end;">
19529 |  36 |         <button class="primary" id="saveToken">Zapisz token</button>
19530 |  37 |         <button id="refresh">Od≈õwie≈º</button>
19531 |  38 |       </div>
19532 |  39 |     </div>
19533 |  40 |     <div id="status" class="muted" style="margin-top:10px;"></div>
19534 |  41 |   </div>
19535 |  42 | 
19536 |  43 |   <div class="card">
19537 |  44 |     <h3>Ustawienia (.env)</h3>
19538 |  45 | 
19539 |  46 |     <div class="row">
19540 |  47 |       <div style="flex:1; min-width:260px;">
19541 |  48 |         <label>FB_EMAIL</label>
19542 |  49 |         <input id="FB_EMAIL" />
19543 |  50 |       </div>
19544 |  51 |       <div style="flex:1; min-width:260px;">
19545 |  52 |         <label>FB_PASSWORD</label>
19546 |  53 |         <input id="FB_PASSWORD" type="password" />
19547 |  54 |       </div>
19548 |  55 |     </div>
19549 |  56 | 
19550 |  57 |     <label>WEBHOOK_URL</label>
19551 |  58 |     <input id="WEBHOOK_URL" />
19552 |  59 | 
19553 |  60 |     <div class="row">
19554 |  61 |       <div style="flex:1; min-width:200px;">
19555 |  62 |         <label>CHECK_INTERVAL_MS</label>
19556 |  63 |         <input id="CHECK_INTERVAL_MS" />
19557 |  64 |       </div>
19558 |  65 |       <div style="flex:2; min-width:260px;">
19559 |  66 |         <label>POSTS_SHEET_URL (csv export)</label>
19560 |  67 |         <input id="POSTS_SHEET_URL" />
19561 |  68 |       </div>
19562 |  69 |     </div>
19563 |  70 | 
19564 |  71 |     <div class="row">
19565 |  72 |       <div style="flex:1; min-width:200px;">
19566 |  73 |         <label>HEADLESS_BROWSER</label>
19567 |  74 |         <select id="HEADLESS_BROWSER">
19568 |  75 |           <option value="true">true</option>
19569 |  76 |           <option value="false">false</option>
19570 |  77 |         </select>
19571 |  78 |       </div>
19572 |  79 |       <div style="flex:1; min-width:200px;">
19573 |  80 |         <label>USE_UI_HANDLERS</label>
19574 |  81 |         <select id="USE_UI_HANDLERS">
19575 |  82 |           <option value="true">true</option>
19576 |  83 |           <option value="false">false</option>
19577 |  84 |         </select>
19578 |  85 |       </div>
19579 |  86 |       <div style="flex:1; min-width:200px;">
19580 |  87 |         <label>INCLUDE_REPLIES</label>
19581 |  88 |         <select id="INCLUDE_REPLIES">
19582 |  89 |           <option value="true">true</option>
19583 |  90 |           <option value="false">false</option>
19584 |  91 |         </select>
19585 |  92 |       </div>
19586 |  93 |     </div>
19587 |  94 | 
19588 |  95 |     <div class="row" style="margin-top:10px;">
19589 |  96 |       <button class="primary" id="saveEnv">Zapisz ENV</button>
19590 |  97 |       <button id="pm2Start">PM2 Start</button>
19591 |  98 |       <button id="pm2Stop">PM2 Stop</button>
19592 |  99 |       <button id="pm2Restart">PM2 Restart</button>
19593 | 100 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
19594 | 101 |     </div>
19595 | 102 | 
19596 | 103 |     <div id="envMsg" class="muted" style="margin-top:10px;"></div>
19597 | 104 |   </div>
19598 | 105 | 
19599 | 106 |   <div class="card">
19600 | 107 |     <h3>Posty (data/posts.json)</h3>
19601 | 108 | 
19602 | 109 |     <div class="row">
19603 | 110 |       <div style="flex:2; min-width:260px;">
19604 | 111 |         <label>Nowy URL posta</label>
19605 | 112 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
19606 | 113 |       </div>
19607 | 114 | 
19608 | 115 |       <div style="flex:1; min-width:220px;">
19609 | 116 |         <label>Name (nazwa)</label>
19610 | 117 |         <input id="newPostName" placeholder="np. A1" />
19611 | 118 |       </div>
19612 | 119 | 
19613 | 120 |       <div style="flex:1; min-width:260px;">
19614 | 121 |         <label>Image URL (zdjƒôcie)</label>
19615 | 122 |         <input id="newPostImage" placeholder="https://...jpg" />
19616 | 123 |       </div>
19617 | 124 |     </div>
19618 | 125 | 
19619 | 126 |     <label>Description (opis)</label>
19620 | 127 |     <textarea id="newPostDescription" style="height:90px;" placeholder="Kr√≥tki opis..."></textarea>
19621 | 128 | 
19622 | 129 |     <div class="row" style="margin-top:10px;">
19623 | 130 |       <div style="min-width:160px; display:flex; align-items:center; gap:10px;">
19624 | 131 |         <label style="margin:0;">
19625 | 132 |           <input type="checkbox" id="newPostActive" checked /> aktywny
19626 | 133 |         </label>
19627 | 134 |         <button class="primary" id="addPost">Dodaj</button>
19628 | 135 |       </div>
19629 | 136 |     </div>
19630 | 137 | 
19631 | 138 |     <div style="margin-top:12px;">
19632 | 139 |       <table>
19633 | 140 |         <thead>
19634 | 141 |           <tr>
19635 | 142 |             <th>ID</th>
19636 | 143 |             <th>URL</th>
19637 | 144 |             <th>Name</th>
19638 | 145 |             <th>Image</th>
19639 | 146 |             <th>Description</th>
19640 | 147 |             <th>Active</th>
19641 | 148 |             <th>Akcje</th>
19642 | 149 |           </tr>
19643 | 150 |         </thead>
19644 | 151 |         <tbody id="posts"></tbody>
19645 | 152 |       </table>
19646 | 153 |     </div>
19647 | 154 |   </div>
19648 | 155 | 
19649 | 156 |   <div class="card">
19650 | 157 |     <h3>Logi</h3>
19651 | 158 | 
19652 | 159 |     <div class="row">
19653 | 160 |       <button id="loadOut">OUT</button>
19654 | 161 |       <button id="loadErr">ERR</button>
19655 | 162 | 
19656 | 163 |       <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
19657 | 164 | 
19658 | 165 |       <select id="logAutoEvery" style="width:140px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
19659 | 166 |         <option value="0">auto: off</option>
19660 | 167 |         <option value="1000">co 1s</option>
19661 | 168 |         <option value="2000" selected>co 2s</option>
19662 | 169 |         <option value="5000">co 5s</option>
19663 | 170 |         <option value="10000">co 10s</option>
19664 | 171 |       </select>
19665 | 172 | 
19666 | 173 |       <button class="primary" id="logAutoToggle">Auto: OFF</button>
19667 | 174 | 
19668 | 175 |       <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
19669 | 176 |         <input type="checkbox" id="logAutoScroll" checked />
19670 | 177 |         auto-scroll
19671 | 178 |       </label>
19672 | 179 |     </div>
19673 | 180 | 
19674 | 181 |     <div class="sep"></div>
19675 | 182 | 
19676 | 183 |     <textarea
19677 | 184 |       id="logs"
19678 | 185 |       class="mono"
19679 | 186 |       style="height:320px; margin-top:10px;"
19680 | 187 |       readonly
19681 | 188 |       spellcheck="false"
19682 | 189 |       placeholder="Kliknij OUT albo ERR, ≈ºeby wczytaƒá logi..."></textarea>
19683 | 190 | 
19684 | 191 |     <div id="logHint" class="muted" style="margin-top:8px;"></div>
19685 | 192 |   </div>
19686 | 193 | 
19687 | 194 |   <script src="/app.js"></script>
19688 | 195 | </body>
19689 | 196 | </html>
19690 | 197 | 
19691 | ```
19692 | 
19693 | ---
19694 | 
19695 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/panel-entry.cjs`
19696 | **Typ:** JavaScript/tekst  
19697 | **Opis:** Plik projektu (kod/konfiguracja).  
19698 | 
19699 | ```js
19700 | 1 | // src/panel/panel-entry.cjs
19701 | 2 | require("./api.js");
19702 | 3 | 
19703 | ```
19704 | 
19705 | ---
19706 | 
19707 | ### üìÑ ≈öcie≈ºka: `CLAUDE.md`
19708 | **Typ:** Markdown  
19709 | **Opis:** Plik projektu (kod/konfiguracja).  
19710 | 
19711 | ```md
19712 |   1 | # FB_Watcher - Kontekst projektu
19713 |   2 | 
19714 |   3 | ## Opis projektu
19715 |   4 | Bot monitorujƒÖcy komentarze na postach Facebook za pomocƒÖ Puppeteer. Wykrywa nowe komentarze i wysy≈Ça powiadomienia przez Telegram.
19716 |   5 | 
19717 |   6 | ## Mapa plik√≥w (dla oszczƒôdno≈õci token√≥w)
19718 |   7 | 
19719 |   8 | | Plik | Linie | G≈Ç√≥wne funkcje | Opis |
19720 |   9 | |------|-------|----------------|------|
19721 |  10 | | `src/watcher.js` | ~895 | `startWatcher()`, `processPost()`, `fetchPosts()` | g≈Ç√≥wna pƒôtla |
19722 |  11 | | `src/fb/login.js` | ~824 | `doLogin()`, `setupCaptchaSolver()` | logowanie + 2Captcha |
19723 |  12 | | `src/fb/comments.js` | ~782 | `extractComments()`, `parseComment()` | ekstrakcja komentarzy |
19724 |  13 | | `src/telegram.js` | ~303 | `sendNotification()`, `formatMessage()` | powiadomienia |
19725 |  14 | | `src/utils/logger.js` | ~202 | `log()`, `logLevel` | logowanie |
19726 |  15 | | `src/fb/checkpoint.js` | ~180 | `detectCheckpoint()`, `handleCheckpoint()` | wykrywanie 2FA |
19727 |  16 | | `src/config.js` | ~172 | eksport zmiennych | env variables |
19728 |  17 | | `src/fb/cookies.js` | ~149 | `loadCookies()`, `saveCookies()` | zarzƒÖdzanie sesjƒÖ |
19729 |  18 | | `src/db/cache.js` | ~116 | `getCache()`, `updateCache()` | deduplikacja |
19730 |  19 | | `src/index.js` | ~83 | `main()` | punkt wej≈õcia |
19731 |  20 | | `src/utils/time.js` | ~63 | `parseRelativeTime()` | parsowanie "2 godz." |
19732 |  21 | | `src/utils/sleep.js` | ~132 | `humanDelay()`, `shuffleArray()`, `humanType()` | human behavior delays |
19733 |  22 | | `src/utils/mouse.js` | ~195 | `humanClick()`, `moveToElement()` | ruchy myszy Bezier |
19734 |  23 | 
19735 |  24 | ## Czƒôste operacje (gdzie edytowaƒá)
19736 |  25 | 
19737 |  26 | | Chcƒô zmieniƒá... | Edytuj plik | Funkcja |
19738 |  27 | |-----------------|-------------|---------|
19739 |  28 | | Format powiadomie≈Ñ | `src/telegram.js` | `formatMessage()` |
19740 |  29 | | Logikƒô logowania | `src/fb/login.js` | `doLogin()` |
19741 |  30 | | Ekstrakcjƒô komentarzy | `src/fb/comments.js` | `extractComments()` |
19742 |  31 | | Interwa≈Ç sprawdzania | `src/config.js` | `CHECK_INTERVAL_MS` |
19743 |  32 | | Obs≈Çugƒô checkpoint | `src/fb/checkpoint.js` | `handleCheckpoint()` |
19744 |  33 | | Cache komentarzy | `src/db/cache.js` | `updateCache()` |
19745 |  34 | | Op√≥≈∫nienia human-like | `src/utils/sleep.js` | `humanTypingDelay()` |
19746 |  35 | | Ruchy myszy | `src/utils/mouse.js` | `humanClick()` |
19747 |  36 | 
19748 |  37 | ## Architektura
19749 |  38 | 
19750 |  39 | ### ≈πr√≥d≈Ça post√≥w (priorytet)
19751 |  40 | 1. **Remote API** (`POSTS_API_URL`) - panel administracyjny
19752 |  41 | 2. **Lokalny plik** (`data/posts.json`) - fallback
19753 |  42 | 3. **Google Sheets** (`POSTS_SHEET_URL`) - ostateczny fallback
19754 |  43 | 
19755 |  44 | ## Ostatnia sesja (2026-01-20)
19756 |  45 | 
19757 |  46 | ### Branch: `feat/react-admin-panel`
19758 |  47 | 
19759 |  48 | ### Co zosta≈Ço zrobione
19760 |  49 | - **2Captcha solver** - automatyczne rozwiƒÖzywanie captcha przy logowaniu:
19761 |  50 |   - Plugin `puppeteer-extra-plugin-recaptcha`
19762 |  51 |   - Konfiguracja: `CAPTCHA_API_KEY` w .env
19763 |  52 |   - Dzia≈Ça dla reCAPTCHA v2/v3
19764 |  53 | - **Uproszczenie logiki cookies** - usuniƒôto rotacjƒô backup cookies:
19765 |  54 |   - Usuniƒôto soft ban detection
19766 |  55 |   - Usuniƒôto automatycznƒÖ rotacjƒô cookies przy checkpoint
19767 |  56 |   - Checkpoint = alert Telegram + stop (wymaga rƒôcznej interwencji)
19768 |  57 | - **Czyszczenie kodu** - usuniƒôto ~400 linii niepotrzebnego kodu
19769 |  58 | 
19770 |  59 | ### Konfiguracja 2Captcha (.env)
19771 |  60 | ```
19772 |  61 | CAPTCHA_API_KEY=twoj_klucz_2captcha
19773 |  62 | ```
19774 |  63 | 
19775 |  64 | ### Logika checkpoint (uproszczona)
19776 |  65 | ```
19777 |  66 | Checkpoint/2FA wykryty
19778 |  67 |     ‚Üì
19779 |  68 | Pr√≥ba rozwiƒÖzania captcha (2Captcha)
19780 |  69 |     ‚Üì
19781 |  70 | Je≈õli sukces ‚Üí kontynuuj
19782 |  71 | Je≈õli 2FA/blokada ‚Üí Alert Telegram + Stop
19783 |  72 |     ‚Üì
19784 |  73 | Rƒôczna interwencja:
19785 |  74 |   - Zmie≈Ñ login/has≈Ço w .env
19786 |  75 |   - Lub zaktualizuj cookies.json
19787 |  76 |     ‚Üì
19788 |  77 | PM2 restartuje automatycznie
19789 |  78 | ```
19790 |  79 | 
19791 |  80 | ## Konfiguracja (.env)
19792 |  81 | 
19793 |  82 | ### Podstawowe
19794 |  83 | ```
19795 |  84 | FB_EMAIL=email@example.com
19796 |  85 | FB_PASSWORD=haslo
19797 |  86 | CHECK_INTERVAL_MS=60000
19798 |  87 | ```
19799 |  88 | 
19800 |  89 | ### FAST_MODE
19801 |  90 | ```
19802 |  91 | FAST_MODE=true           # w≈ÇƒÖcza tryb szybki
19803 |  92 | FAST_MAX_AGE_MIN=180     # limit wieku komentarzy (minuty)
19804 |  93 | ```
19805 |  94 | 
19806 |  95 | ### Captcha
19807 |  96 | ```
19808 |  97 | CAPTCHA_API_KEY=klucz_2captcha
19809 |  98 | ```
19810 |  99 | 
19811 | 100 | ### Logi
19812 | 101 | ```
19813 | 102 | LOG_LEVEL=1              # 0=silent, 1=prod, 2=dev, 3=debug
19814 | 103 | ```
19815 | 104 | 
19816 | 105 | ### Remote Debug
19817 | 106 | ```
19818 | 107 | REMOTE_DEBUG_PORT=9222   # port do podglƒÖdu przeglƒÖdarki (0=wy≈ÇƒÖczony)
19819 | 108 | ```
19820 | 109 | 
19821 | 110 | ### Human Behavior Mode
19822 | 111 | ```
19823 | 112 | HUMAN_MODE=true                    # w≈ÇƒÖcza symulacjƒô cz≈Çowieka (domy≈õlnie true)
19824 | 113 | PROXY_URL=http://user:pass@host:port  # rotating residential proxy (opcjonalne)
19825 | 114 | ```
19826 | 115 | 
19827 | 116 | ## Wa≈ºne informacje techniczne
19828 | 117 | 
19829 | 118 | ### Stealth
19830 | 119 | Bot u≈ºywa technik ukrywania automatyzacji:
19831 | 120 | - `navigator.webdriver = false`
19832 | 121 | - Usuniƒôcie flag Chromium automation
19833 | 122 | - Losowe op√≥≈∫nienia miƒôdzy akcjami
19834 | 123 | - Plugin `puppeteer-extra-plugin-stealth` (aktywowany!)
19835 | 124 | 
19836 | 125 | ### Human Behavior Mode
19837 | 126 | Symulacja zachowa≈Ñ cz≈Çowieka dla zmniejszenia ryzyka wykrycia:
19838 | 127 | - **Stealth Plugin**: ukrywa webdriver, plugins, WebGL, canvas fingerprint
19839 | 128 | - **Wolne pisanie**: ~120ms/znak z mikro-pauzami (zamiast 35ms)
19840 | 129 | - **Rozk≈Çad Gaussa**: naturalne op√≥≈∫nienia zamiast jednolitych
19841 | 130 | - **Shuffle post√≥w**: losowa kolejno≈õƒá sprawdzania (Fisher-Yates)
19842 | 131 | - **Pauzy miƒôdzy postami**: 3-8 sekund z rozk≈Çadem normalnym
19843 | 132 | - **Ruchy myszy**: krzywe Beziera (opcjonalne)
19844 | 133 | - **Proxy support**: residential rotating proxy
19845 | 134 | 
19846 | 135 | Logi przy `LOG_LEVEL=2`:
19847 | 136 | ```
19848 | 137 | [STEALTH] Plugin stealth w≈ÇƒÖczony
19849 | 138 | [PROXY] U≈ºywam proxy: http://***@host:port
19850 | 139 | [HUMAN] Human Behavior Mode w≈ÇƒÖczony
19851 | 140 | [HUMAN] Kolejno≈õƒá post√≥w: post3 ‚Üí post1 ‚Üí post2
19852 | 141 | [HUMAN] Pauza: 5.2s
19853 | 142 | ```
19854 | 143 | 
19855 | 144 | ### Cache
19856 | 145 | - Plik: `data/comments-cache.json`
19857 | 146 | - Struktura: `{ [postUrl]: { lastCount, knownIds: [] } }`
19858 | 147 | - Deduplikacja przez ID komentarzy
19859 | 148 | - Auto-cleanup gdy > 1000 IDs na post
19860 | 149 | 
19861 | 150 | ### Cookies
19862 | 151 | - Plik: `cookies.json` w g≈Ç√≥wnym katalogu
19863 | 152 | - Format: tablica cookies z Puppeteer
19864 | 153 | - Atomic write (bezpieczny zapis)
19865 | 154 | 
19866 | 155 | ### Captcha Solver
19867 | 156 | - Serwis: 2Captcha.com
19868 | 157 | - Plugin: `puppeteer-extra-plugin-recaptcha`
19869 | 158 | - Obs≈Çuguje: reCAPTCHA v2, v3, hCaptcha
19870 | 159 | - Czas rozwiƒÖzania: ~30-60 sekund
19871 | 160 | 
19872 | 161 | ### Remote Debug (podglƒÖd przeglƒÖdarki na ≈ºywo)
19873 | 162 | Pozwala pod≈ÇƒÖczyƒá siƒô do przeglƒÖdarki bota i rƒôcznie zrobiƒá 2FA/checkpoint.
19874 | 163 | 
19875 | 164 | ```bash
19876 | 165 | # 1. Na serwerze - uruchom z portem debug
19877 | 166 | REMOTE_DEBUG_PORT=9222 node src/index.js
19878 | 167 | 
19879 | 168 | # 2. Na PC - tunel SSH
19880 | 169 | ssh -L 9222:localhost:9222 root@162.55.188.103
19881 | 170 | 
19882 | 171 | # 3. W Chrome na PC
19883 | 172 | chrome://inspect/#devices ‚Üí Configure ‚Üí localhost:9222
19884 | 173 | ```
19885 | 174 | 
19886 | 175 | Kliknij "inspect" przy facebook.com - masz pe≈ÇnƒÖ kontrolƒô nad przeglƒÖdarkƒÖ.
19887 | 176 | 
19888 | 177 | ### Proxy (opcjonalne)
19889 | 178 | Zmniejsza ryzyko ban√≥w przez zmianƒô IP:
19890 | 179 | - **Format**: `http://user:pass@host:port` lub `socks5://host:port`
19891 | 180 | - **Zalecane**: Residential rotating proxy (Bright Data, Oxylabs, IPRoyal)
19892 | 181 | - Facebook flaguje: datacenter IP, ciƒÖg≈ÇƒÖ aktywno≈õƒá z jednego IP
19893 | 182 | - Residential IP wyglƒÖdajƒÖ jak zwykli u≈ºytkownicy
19894 | 183 | 
19895 | 184 | ## Serwer produkcyjny
19896 | 185 | 
19897 | 186 | | Parametr | Warto≈õƒá |
19898 | 187 | |----------|---------|
19899 | 188 | | IP | `162.55.188.103` |
19900 | 189 | | User | `root` |
19901 | 190 | | System | Ubuntu 24.04.3 LTS |
19902 | 191 | | ≈öcie≈ºka | `/opt/fb-watcher` |
19903 | 192 | 
19904 | 193 | ```bash
19905 | 194 | # Po≈ÇƒÖczenie SSH
19906 | 195 | ssh root@162.55.188.103
19907 | 196 | 
19908 | 197 | # SSH z tunelem do remote debug
19909 | 198 | ssh -L 9222:localhost:9222 root@162.55.188.103
19910 | 199 | ```
19911 | 200 | 
19912 | 201 | ## Komendy
19913 | 202 | 
19914 | 203 | ```bash
19915 | 204 | # Uruchomienie
19916 | 205 | node src/index.js
19917 | 206 | 
19918 | 207 | # PM2 (produkcja)
19919 | 208 | pm2 start ecosystem.config.cjs
19920 | 209 | 
19921 | 210 | # Logi
19922 | 211 | pm2 logs fb-watcher
19923 | 212 | 
19924 | 213 | # Generowanie cookies rƒôcznie
19925 | 214 | node scripts/generate-cookies.js
19926 | 215 | 
19927 | 216 | # Uruchomienie z remote debug (podglƒÖd przeglƒÖdarki)
19928 | 217 | REMOTE_DEBUG_PORT=9222 node src/index.js
19929 | 218 | ```
19930 | 219 | 
19931 | 220 | ## Skrypty pomocnicze
19932 | 221 | 
19933 | 222 | ### `scripts/generate-cookies.js`
19934 | 223 | Rƒôczne generowanie cookies przez logowanie w przeglƒÖdarce.
19935 | 224 | ```bash
19936 | 225 | node scripts/generate-cookies.js           # zapisz cookies.json
19937 | 226 | node scripts/generate-cookies.js --list    # poka≈º istniejƒÖce
19938 | 227 | ```
19939 | 228 | 
19940 | 229 | ## Workflow - wrzucanie na serwer
19941 | 230 | 
19942 | 231 | **ZASADA:** Zawsze tworzyƒá nowy branch przed wrzuceniem na serwer.
19943 | 232 | 
19944 | 233 | ```bash
19945 | 234 | # 1. Nowy branch z timestampem
19946 | 235 | git checkout -b deploy/YYYYMMDD-HHMMSS
19947 | 236 | 
19948 | 237 | # 2. Commit + push
19949 | 238 | git add . && git commit -m "opis zmian"
19950 | 239 | git push -u origin HEAD
19951 | 240 | 
19952 | 241 | # 3. Na serwerze
19953 | 242 | ssh root@162.55.188.103
19954 | 243 | cd /opt/fb-watcher
19955 | 244 | git fetch && git checkout <branch>
19956 | 245 | pm2 restart fb-watcher
19957 | 246 | ```
19958 | 247 | 
19959 | 248 | ## Jak zadawaƒá pytania (oszczƒôdno≈õƒá token√≥w)
19960 | 249 | 
19961 | 250 | ### Dobrze
19962 | 251 | ```
19963 | 252 | "W src/telegram.js:120 formatMessage() - dodaj link do posta"
19964 | 253 | "src/fb/login.js:45-60 - dodaj 3 retry przy b≈Çƒôdzie"
19965 | 254 | "Czy w watcher.js:200-220 jest memory leak?"
19966 | 255 | ```
19967 | 256 | 
19968 | 257 | ### ≈πle
19969 | 258 | ```
19970 | 259 | "Znajd≈∫ gdzie jest sendNotification"
19971 | 260 | "Sprawd≈∫ czy watcher.js jest OK"
19972 | 261 | "Poka≈º mi ca≈Çy plik login.js"
19973 | 262 | ```
19974 | 263 | 
19975 | 264 | ### Zasady
19976 | 265 | 1. **Podawaj ≈õcie≈ºkƒô + numer linii** je≈õli znasz
19977 | 266 | 2. **Jedno pytanie = jeden temat** ‚Üí potem `/clear`
19978 | 267 | 3. **Unikaj "poka≈º mi" / "wyja≈õnij ca≈Çy plik"**
19979 | 268 | 4. **Po zako≈Ñczeniu zadania** ‚Üí `/clear` ‚Üí nowe zadanie
19980 | 269 | 5. **Aktualizuj mapƒô plik√≥w** gdy dodasz nowy plik
19981 | 270 | 
19982 | 271 | ## Do zrobienia / Potencjalne usprawnienia
19983 | 272 | - [ ] Testy 2Captcha na produkcji przy rzeczywistym checkpoint
19984 | 273 | - [ ] Obs≈Çuga b≈Çƒôd√≥w gdy FB zmieni UI
19985 | 274 | - [ ] Rate limiting dla Telegram
19986 | 275 | - [ ] Metryki/statystyki wykrywania
19987 | 276 | 
19988 | ```
19989 | 
19990 | ---
19991 | 
19992 | ### üìÑ ≈öcie≈ºka: `cookies.json`
19993 | **Typ:** JSON  
19994 | **Opis:** Plik projektu (kod/konfiguracja).  
19995 | 
19996 | ```json
19997 |   1 | [
19998 |   2 |   {
19999 |   3 |     "name": "presence",
20000 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768949166457%2C%22v%22%3A1%7D",
20001 |   5 |     "domain": ".facebook.com",
20002 |   6 |     "path": "/",
20003 |   7 |     "expires": -1,
20004 |   8 |     "size": 75,
20005 |   9 |     "httpOnly": false,
20006 |  10 |     "secure": true,
20007 |  11 |     "session": true,
20008 |  12 |     "priority": "Medium",
20009 |  13 |     "sameParty": false,
20010 |  14 |     "sourceScheme": "Secure"
20011 |  15 |   },
20012 |  16 |   {
20013 |  17 |     "name": "c_user",
20014 |  18 |     "value": "61586902376231",
20015 |  19 |     "domain": ".facebook.com",
20016 |  20 |     "path": "/",
20017 |  21 |     "expires": 1800484179.134967,
20018 |  22 |     "size": 20,
20019 |  23 |     "httpOnly": false,
20020 |  24 |     "secure": true,
20021 |  25 |     "session": false,
20022 |  26 |     "sameSite": "None",
20023 |  27 |     "priority": "Medium",
20024 |  28 |     "sameParty": false,
20025 |  29 |     "sourceScheme": "Secure"
20026 |  30 |   },
20027 |  31 |   {
20028 |  32 |     "name": "wd",
20029 |  33 |     "value": "1366x768",
20030 |  34 |     "domain": ".facebook.com",
20031 |  35 |     "path": "/",
20032 |  36 |     "expires": 1769553966,
20033 |  37 |     "size": 10,
20034 |  38 |     "httpOnly": false,
20035 |  39 |     "secure": true,
20036 |  40 |     "session": false,
20037 |  41 |     "sameSite": "Lax",
20038 |  42 |     "priority": "Medium",
20039 |  43 |     "sameParty": false,
20040 |  44 |     "sourceScheme": "Secure"
20041 |  45 |   },
20042 |  46 |   {
20043 |  47 |     "name": "xs",
20044 |  48 |     "value": "30%3AQpODUJy18dEViA%3A2%3A1768947868%3A-1%3A-1%3A%3AAcyvJd0PSoHqZgkPeeum7BDwv6SnDC8w49TCKBXWtA",
20045 |  49 |     "domain": ".facebook.com",
20046 |  50 |     "path": "/",
20047 |  51 |     "expires": 1800484179.135037,
20048 |  52 |     "size": 96,
20049 |  53 |     "httpOnly": true,
20050 |  54 |     "secure": true,
20051 |  55 |     "session": false,
20052 |  56 |     "sameSite": "None",
20053 |  57 |     "priority": "Medium",
20054 |  58 |     "sameParty": false,
20055 |  59 |     "sourceScheme": "Secure"
20056 |  60 |   },
20057 |  61 |   {
20058 |  62 |     "name": "oo",
20059 |  63 |     "value": "v1%7C3%3A1768947870",
20060 |  64 |     "domain": ".facebook.com",
20061 |  65 |     "path": "/",
20062 |  66 |     "expires": 1803507869.854458,
20063 |  67 |     "size": 21,
20064 |  68 |     "httpOnly": true,
20065 |  69 |     "secure": true,
20066 |  70 |     "session": false,
20067 |  71 |     "sameSite": "None",
20068 |  72 |     "priority": "Medium",
20069 |  73 |     "sameParty": false,
20070 |  74 |     "sourceScheme": "Secure"
20071 |  75 |   },
20072 |  76 |   {
20073 |  77 |     "name": "sb",
20074 |  78 |     "value": "kQBwad5GZLHhirX_vA4H-M5I",
20075 |  79 |     "domain": ".facebook.com",
20076 |  80 |     "path": "/",
20077 |  81 |     "expires": 1803507869.651363,
20078 |  82 |     "size": 26,
20079 |  83 |     "httpOnly": true,
20080 |  84 |     "secure": true,
20081 |  85 |     "session": false,
20082 |  86 |     "sameSite": "None",
20083 |  87 |     "priority": "Medium",
20084 |  88 |     "sameParty": false,
20085 |  89 |     "sourceScheme": "Secure"
20086 |  90 |   },
20087 |  91 |   {
20088 |  92 |     "name": "datr",
20089 |  93 |     "value": "kQBwaZbB9A8fcEdDLaEr2T1d",
20090 |  94 |     "domain": ".facebook.com",
20091 |  95 |     "path": "/",
20092 |  96 |     "expires": 1803507860.517749,
20093 |  97 |     "size": 28,
20094 |  98 |     "httpOnly": true,
20095 |  99 |     "secure": true,
20096 | 100 |     "session": false,
20097 | 101 |     "sameSite": "None",
20098 | 102 |     "priority": "Medium",
20099 | 103 |     "sameParty": false,
20100 | 104 |     "sourceScheme": "Secure"
20101 | 105 |   }
20102 | 106 | ]
20103 | ```
20104 | 
20105 | ---
20106 | 
20107 | ### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_1.json`
20108 | **Typ:** JSON  
20109 | **Opis:** Plik projektu (kod/konfiguracja).  
20110 | 
20111 | ```json
20112 |   1 | [
20113 |   2 |   {
20114 |   3 |     "name": "presence",
20115 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821583937%2C%22v%22%3A1%7D",
20116 |   5 |     "domain": ".facebook.com",
20117 |   6 |     "path": "/",
20118 |   7 |     "expires": -1,
20119 |   8 |     "size": 75,
20120 |   9 |     "httpOnly": false,
20121 |  10 |     "secure": true,
20122 |  11 |     "session": true,
20123 |  12 |     "priority": "Medium",
20124 |  13 |     "sameParty": false,
20125 |  14 |     "sourceScheme": "Secure"
20126 |  15 |   },
20127 |  16 |   {
20128 |  17 |     "name": "xs",
20129 |  18 |     "value": "29%3A0TI_s65lTO3qzg%3A2%3A1768821578%3A-1%3A-1%3A%3AAcxaLgNbdpNWTjDF0y56iMggsdBM_j9nH4pbE8YgFg",
20130 |  19 |     "domain": ".facebook.com",
20131 |  20 |     "path": "/",
20132 |  21 |     "expires": 1800357582.420874,
20133 |  22 |     "size": 96,
20134 |  23 |     "httpOnly": true,
20135 |  24 |     "secure": true,
20136 |  25 |     "session": false,
20137 |  26 |     "sameSite": "None",
20138 |  27 |     "priority": "Medium",
20139 |  28 |     "sameParty": false,
20140 |  29 |     "sourceScheme": "Secure"
20141 |  30 |   },
20142 |  31 |   {
20143 |  32 |     "name": "oo",
20144 |  33 |     "value": "v1%7C3%3A1768821581",
20145 |  34 |     "domain": ".facebook.com",
20146 |  35 |     "path": "/",
20147 |  36 |     "expires": 1803381581.604868,
20148 |  37 |     "size": 21,
20149 |  38 |     "httpOnly": true,
20150 |  39 |     "secure": true,
20151 |  40 |     "session": false,
20152 |  41 |     "sameSite": "None",
20153 |  42 |     "priority": "Medium",
20154 |  43 |     "sameParty": false,
20155 |  44 |     "sourceScheme": "Secure"
20156 |  45 |   },
20157 |  46 |   {
20158 |  47 |     "name": "wd",
20159 |  48 |     "value": "1920x945",
20160 |  49 |     "domain": ".facebook.com",
20161 |  50 |     "path": "/",
20162 |  51 |     "expires": 1769426383,
20163 |  52 |     "size": 10,
20164 |  53 |     "httpOnly": false,
20165 |  54 |     "secure": true,
20166 |  55 |     "session": false,
20167 |  56 |     "sameSite": "Lax",
20168 |  57 |     "priority": "Medium",
20169 |  58 |     "sameParty": false,
20170 |  59 |     "sourceScheme": "Secure"
20171 |  60 |   },
20172 |  61 |   {
20173 |  62 |     "name": "c_user",
20174 |  63 |     "value": "61586902376231",
20175 |  64 |     "domain": ".facebook.com",
20176 |  65 |     "path": "/",
20177 |  66 |     "expires": 1800357582.420761,
20178 |  67 |     "size": 20,
20179 |  68 |     "httpOnly": false,
20180 |  69 |     "secure": true,
20181 |  70 |     "session": false,
20182 |  71 |     "sameSite": "None",
20183 |  72 |     "priority": "Medium",
20184 |  73 |     "sameParty": false,
20185 |  74 |     "sourceScheme": "Secure"
20186 |  75 |   },
20187 |  76 |   {
20188 |  77 |     "name": "sb",
20189 |  78 |     "value": "LRNuadcWAD_nJokuImU0LXvJ",
20190 |  79 |     "domain": ".facebook.com",
20191 |  80 |     "path": "/",
20192 |  81 |     "expires": 1803381581.404045,
20193 |  82 |     "size": 26,
20194 |  83 |     "httpOnly": true,
20195 |  84 |     "secure": true,
20196 |  85 |     "session": false,
20197 |  86 |     "sameSite": "None",
20198 |  87 |     "priority": "Medium",
20199 |  88 |     "sameParty": false,
20200 |  89 |     "sourceScheme": "Secure"
20201 |  90 |   },
20202 |  91 |   {
20203 |  92 |     "name": "datr",
20204 |  93 |     "value": "LRNuaTIVfVkEK0ALCqTBXrbX",
20205 |  94 |     "domain": ".facebook.com",
20206 |  95 |     "path": "/",
20207 |  96 |     "expires": 1803381551.714364,
20208 |  97 |     "size": 28,
20209 |  98 |     "httpOnly": true,
20210 |  99 |     "secure": true,
20211 | 100 |     "session": false,
20212 | 101 |     "sameSite": "None",
20213 | 102 |     "priority": "Medium",
20214 | 103 |     "sameParty": false,
20215 | 104 |     "sourceScheme": "Secure"
20216 | 105 |   }
20217 | 106 | ]
20218 | ```
20219 | 
20220 | ---
20221 | 
20222 | ### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_2.json`
20223 | **Typ:** JSON  
20224 | **Opis:** Plik projektu (kod/konfiguracja).  
20225 | 
20226 | ```json
20227 |   1 | [
20228 |   2 |   {
20229 |   3 |     "name": "presence",
20230 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768821704911%2C%22v%22%3A1%7D",
20231 |   5 |     "domain": ".facebook.com",
20232 |   6 |     "path": "/",
20233 |   7 |     "expires": -1,
20234 |   8 |     "size": 75,
20235 |   9 |     "httpOnly": false,
20236 |  10 |     "secure": true,
20237 |  11 |     "session": true,
20238 |  12 |     "priority": "Medium",
20239 |  13 |     "sameParty": false,
20240 |  14 |     "sourceScheme": "Secure"
20241 |  15 |   },
20242 |  16 |   {
20243 |  17 |     "name": "xs",
20244 |  18 |     "value": "15%3A5aJJDn3N950RaA%3A2%3A1768821699%3A-1%3A-1%3A%3AAcyULKKMWvRSHdia6ASG6JHmVdDYRIt6UMSLrv0jaQ",
20245 |  19 |     "domain": ".facebook.com",
20246 |  20 |     "path": "/",
20247 |  21 |     "expires": 1800357702.405451,
20248 |  22 |     "size": 96,
20249 |  23 |     "httpOnly": true,
20250 |  24 |     "secure": true,
20251 |  25 |     "session": false,
20252 |  26 |     "sameSite": "None",
20253 |  27 |     "priority": "Medium",
20254 |  28 |     "sameParty": false,
20255 |  29 |     "sourceScheme": "Secure"
20256 |  30 |   },
20257 |  31 |   {
20258 |  32 |     "name": "oo",
20259 |  33 |     "value": "v1%7C3%3A1768821701",
20260 |  34 |     "domain": ".facebook.com",
20261 |  35 |     "path": "/",
20262 |  36 |     "expires": 1803381701.372198,
20263 |  37 |     "size": 21,
20264 |  38 |     "httpOnly": true,
20265 |  39 |     "secure": true,
20266 |  40 |     "session": false,
20267 |  41 |     "sameSite": "None",
20268 |  42 |     "priority": "Medium",
20269 |  43 |     "sameParty": false,
20270 |  44 |     "sourceScheme": "Secure"
20271 |  45 |   },
20272 |  46 |   {
20273 |  47 |     "name": "wd",
20274 |  48 |     "value": "1920x945",
20275 |  49 |     "domain": ".facebook.com",
20276 |  50 |     "path": "/",
20277 |  51 |     "expires": 1769426504,
20278 |  52 |     "size": 10,
20279 |  53 |     "httpOnly": false,
20280 |  54 |     "secure": true,
20281 |  55 |     "session": false,
20282 |  56 |     "sameSite": "Lax",
20283 |  57 |     "priority": "Medium",
20284 |  58 |     "sameParty": false,
20285 |  59 |     "sourceScheme": "Secure"
20286 |  60 |   },
20287 |  61 |   {
20288 |  62 |     "name": "c_user",
20289 |  63 |     "value": "61584544438252",
20290 |  64 |     "domain": ".facebook.com",
20291 |  65 |     "path": "/",
20292 |  66 |     "expires": 1800357702.405334,
20293 |  67 |     "size": 20,
20294 |  68 |     "httpOnly": false,
20295 |  69 |     "secure": true,
20296 |  70 |     "session": false,
20297 |  71 |     "sameSite": "None",
20298 |  72 |     "priority": "Medium",
20299 |  73 |     "sameParty": false,
20300 |  74 |     "sourceScheme": "Secure"
20301 |  75 |   },
20302 |  76 |   {
20303 |  77 |     "name": "sb",
20304 |  78 |     "value": "phNuaVpJfP45vjR5_9Z3ww0u",
20305 |  79 |     "domain": ".facebook.com",
20306 |  80 |     "path": "/",
20307 |  81 |     "expires": 1803381700.950217,
20308 |  82 |     "size": 26,
20309 |  83 |     "httpOnly": true,
20310 |  84 |     "secure": true,
20311 |  85 |     "session": false,
20312 |  86 |     "sameSite": "None",
20313 |  87 |     "priority": "Medium",
20314 |  88 |     "sameParty": false,
20315 |  89 |     "sourceScheme": "Secure"
20316 |  90 |   },
20317 |  91 |   {
20318 |  92 |     "name": "datr",
20319 |  93 |     "value": "phNuafrGqbN4eXv7NV-JPKnJ",
20320 |  94 |     "domain": ".facebook.com",
20321 |  95 |     "path": "/",
20322 |  96 |     "expires": 1803381673.692538,
20323 |  97 |     "size": 28,
20324 |  98 |     "httpOnly": true,
20325 |  99 |     "secure": true,
20326 | 100 |     "session": false,
20327 | 101 |     "sameSite": "None",
20328 | 102 |     "priority": "Medium",
20329 | 103 |     "sameParty": false,
20330 | 104 |     "sourceScheme": "Secure"
20331 | 105 |   }
20332 | 106 | ]
20333 | ```
20334 | 
20335 | ---
20336 | 
20337 | ### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_3.json`
20338 | **Typ:** JSON  
20339 | **Opis:** Plik projektu (kod/konfiguracja).  
20340 | 
20341 | ```json
20342 |   1 | [
20343 |   2 |   {
20344 |   3 |     "name": "presence",
20345 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768822164105%2C%22v%22%3A1%7D",
20346 |   5 |     "domain": ".facebook.com",
20347 |   6 |     "path": "/",
20348 |   7 |     "expires": -1,
20349 |   8 |     "size": 75,
20350 |   9 |     "httpOnly": false,
20351 |  10 |     "secure": true,
20352 |  11 |     "session": true,
20353 |  12 |     "priority": "Medium",
20354 |  13 |     "sameParty": false,
20355 |  14 |     "sourceScheme": "Secure"
20356 |  15 |   },
20357 |  16 |   {
20358 |  17 |     "name": "xs",
20359 |  18 |     "value": "12%3Ar5MWBSq2el_6cA%3A2%3A1768822161%3A-1%3A-1%3A%3AAcwVwvqQ6SZ4-1toGi9O2R8-9M-Hp0pkMGAQlGJhHg",
20360 |  19 |     "domain": ".facebook.com",
20361 |  20 |     "path": "/",
20362 |  21 |     "expires": 1800358163.45879,
20363 |  22 |     "size": 96,
20364 |  23 |     "httpOnly": true,
20365 |  24 |     "secure": true,
20366 |  25 |     "session": false,
20367 |  26 |     "sameSite": "None",
20368 |  27 |     "priority": "Medium",
20369 |  28 |     "sameParty": false,
20370 |  29 |     "sourceScheme": "Secure"
20371 |  30 |   },
20372 |  31 |   {
20373 |  32 |     "name": "oo",
20374 |  33 |     "value": "v1%7C3%3A1768822162",
20375 |  34 |     "domain": ".facebook.com",
20376 |  35 |     "path": "/",
20377 |  36 |     "expires": 1803382162.846874,
20378 |  37 |     "size": 21,
20379 |  38 |     "httpOnly": true,
20380 |  39 |     "secure": true,
20381 |  40 |     "session": false,
20382 |  41 |     "sameSite": "None",
20383 |  42 |     "priority": "Medium",
20384 |  43 |     "sameParty": false,
20385 |  44 |     "sourceScheme": "Secure"
20386 |  45 |   },
20387 |  46 |   {
20388 |  47 |     "name": "c_user",
20389 |  48 |     "value": "100003588756313",
20390 |  49 |     "domain": ".facebook.com",
20391 |  50 |     "path": "/",
20392 |  51 |     "expires": 1800358163.458665,
20393 |  52 |     "size": 21,
20394 |  53 |     "httpOnly": false,
20395 |  54 |     "secure": true,
20396 |  55 |     "session": false,
20397 |  56 |     "sameSite": "None",
20398 |  57 |     "priority": "Medium",
20399 |  58 |     "sameParty": false,
20400 |  59 |     "sourceScheme": "Secure"
20401 |  60 |   },
20402 |  61 |   {
20403 |  62 |     "name": "wd",
20404 |  63 |     "value": "1920x945",
20405 |  64 |     "domain": ".facebook.com",
20406 |  65 |     "path": "/",
20407 |  66 |     "expires": 1769426963,
20408 |  67 |     "size": 10,
20409 |  68 |     "httpOnly": false,
20410 |  69 |     "secure": true,
20411 |  70 |     "session": false,
20412 |  71 |     "sameSite": "Lax",
20413 |  72 |     "priority": "Medium",
20414 |  73 |     "sameParty": false,
20415 |  74 |     "sourceScheme": "Secure"
20416 |  75 |   },
20417 |  76 |   {
20418 |  77 |     "name": "sb",
20419 |  78 |     "value": "QxVuaaOR9rdA5NlSfrHD1EfX",
20420 |  79 |     "domain": ".facebook.com",
20421 |  80 |     "path": "/",
20422 |  81 |     "expires": 1803382162.597484,
20423 |  82 |     "size": 26,
20424 |  83 |     "httpOnly": true,
20425 |  84 |     "secure": true,
20426 |  85 |     "session": false,
20427 |  86 |     "sameSite": "None",
20428 |  87 |     "priority": "Medium",
20429 |  88 |     "sameParty": false,
20430 |  89 |     "sourceScheme": "Secure"
20431 |  90 |   },
20432 |  91 |   {
20433 |  92 |     "name": "datr",
20434 |  93 |     "value": "QxVuadPVWi05FhOfQNVLWqGr",
20435 |  94 |     "domain": ".facebook.com",
20436 |  95 |     "path": "/",
20437 |  96 |     "expires": 1803382085.502047,
20438 |  97 |     "size": 28,
20439 |  98 |     "httpOnly": true,
20440 |  99 |     "secure": true,
20441 | 100 |     "session": false,
20442 | 101 |     "sameSite": "None",
20443 | 102 |     "priority": "Medium",
20444 | 103 |     "sameParty": false,
20445 | 104 |     "sourceScheme": "Secure"
20446 | 105 |   }
20447 | 106 | ]
20448 | ```
20449 | 
20450 | ---
20451 | 
20452 | ### üìÑ ≈öcie≈ºka: `data/backup_cookies/cookies_4.json`
20453 | **Typ:** JSON  
20454 | **Opis:** Plik projektu (kod/konfiguracja).  
20455 | 
20456 | ```json
20457 |   1 | [
20458 |   2 |   {
20459 |   3 |     "name": "presence",
20460 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1768852924758%2C%22v%22%3A1%7D",
20461 |   5 |     "domain": ".facebook.com",
20462 |   6 |     "path": "/",
20463 |   7 |     "expires": -1,
20464 |   8 |     "size": 75,
20465 |   9 |     "httpOnly": false,
20466 |  10 |     "secure": true,
20467 |  11 |     "session": true,
20468 |  12 |     "priority": "Medium",
20469 |  13 |     "sameParty": false,
20470 |  14 |     "sourceScheme": "Secure"
20471 |  15 |   },
20472 |  16 |   {
20473 |  17 |     "name": "xs",
20474 |  18 |     "value": "22%3ALWafh4jINN69qw%3A2%3A1768852919%3A-1%3A-1%3A%3AAcx_l28-lOf1k4OIIYDNmw-No6DzjAvqpIsUYtw8ZA",
20475 |  19 |     "domain": ".facebook.com",
20476 |  20 |     "path": "/",
20477 |  21 |     "expires": 1800388921.700278,
20478 |  22 |     "size": 96,
20479 |  23 |     "httpOnly": true,
20480 |  24 |     "secure": true,
20481 |  25 |     "session": false,
20482 |  26 |     "sameSite": "None",
20483 |  27 |     "priority": "Medium",
20484 |  28 |     "sameParty": false,
20485 |  29 |     "sourceScheme": "Secure"
20486 |  30 |   },
20487 |  31 |   {
20488 |  32 |     "name": "oo",
20489 |  33 |     "value": "v1%7C3%3A1768852921",
20490 |  34 |     "domain": ".facebook.com",
20491 |  35 |     "path": "/",
20492 |  36 |     "expires": 1803412920.650126,
20493 |  37 |     "size": 21,
20494 |  38 |     "httpOnly": true,
20495 |  39 |     "secure": true,
20496 |  40 |     "session": false,
20497 |  41 |     "sameSite": "None",
20498 |  42 |     "priority": "Medium",
20499 |  43 |     "sameParty": false,
20500 |  44 |     "sourceScheme": "Secure"
20501 |  45 |   },
20502 |  46 |   {
20503 |  47 |     "name": "wd",
20504 |  48 |     "value": "1920x945",
20505 |  49 |     "domain": ".facebook.com",
20506 |  50 |     "path": "/",
20507 |  51 |     "expires": 1769457724,
20508 |  52 |     "size": 10,
20509 |  53 |     "httpOnly": false,
20510 |  54 |     "secure": true,
20511 |  55 |     "session": false,
20512 |  56 |     "sameSite": "Lax",
20513 |  57 |     "priority": "Medium",
20514 |  58 |     "sameParty": false,
20515 |  59 |     "sourceScheme": "Secure"
20516 |  60 |   },
20517 |  61 |   {
20518 |  62 |     "name": "c_user",
20519 |  63 |     "value": "61584544438252",
20520 |  64 |     "domain": ".facebook.com",
20521 |  65 |     "path": "/",
20522 |  66 |     "expires": 1800388921.700174,
20523 |  67 |     "size": 20,
20524 |  68 |     "httpOnly": false,
20525 |  69 |     "secure": true,
20526 |  70 |     "session": false,
20527 |  71 |     "sameSite": "None",
20528 |  72 |     "priority": "Medium",
20529 |  73 |     "sameParty": false,
20530 |  74 |     "sourceScheme": "Secure"
20531 |  75 |   },
20532 |  76 |   {
20533 |  77 |     "name": "sb",
20534 |  78 |     "value": "o41uaWpt5tiPEsycxXtK4Cbs",
20535 |  79 |     "domain": ".facebook.com",
20536 |  80 |     "path": "/",
20537 |  81 |     "expires": 1803412920.412847,
20538 |  82 |     "size": 26,
20539 |  83 |     "httpOnly": true,
20540 |  84 |     "secure": true,
20541 |  85 |     "session": false,
20542 |  86 |     "sameSite": "None",
20543 |  87 |     "priority": "Medium",
20544 |  88 |     "sameParty": false,
20545 |  89 |     "sourceScheme": "Secure"
20546 |  90 |   },
20547 |  91 |   {
20548 |  92 |     "name": "datr",
20549 |  93 |     "value": "o41uaXMjjzfbjImZRgyLijUq",
20550 |  94 |     "domain": ".facebook.com",
20551 |  95 |     "path": "/",
20552 |  96 |     "expires": 1803412902.086271,
20553 |  97 |     "size": 28,
20554 |  98 |     "httpOnly": true,
20555 |  99 |     "secure": true,
20556 | 100 |     "session": false,
20557 | 101 |     "sameSite": "None",
20558 | 102 |     "priority": "Medium",
20559 | 103 |     "sameParty": false,
20560 | 104 |     "sourceScheme": "Secure"
20561 | 105 |   }
20562 | 106 | ]
20563 | ```
20564 | 
20565 | ---
20566 | 
20567 | ### üìÑ ≈öcie≈ºka: `data/comments-cache.json`
20568 | **Typ:** JSON  
20569 | **Opis:** Plik projektu (kod/konfiguracja).  
20570 | 
20571 | ```json
20572 |   1 | {
20573 |   2 |   "test": {
20574 |   3 |     "lastCount": 5,
20575 |   4 |     "knownIds": [
20576 |   5 |       "a",
20577 |   6 |       "b",
20578 |   7 |       "c"
20579 |   8 |     ]
20580 |   9 |   },
20581 |  10 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R": {
20582 |  11 |     "lastCount": 10,
20583 |  12 |     "knownIds": [
20584 |  13 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjI5OTI2MTgzMDU0NzUxNw==",
20585 |  14 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTk2MTEyNzAwNzgyMDg3MA==",
20586 |  15 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIwMjkwODkxMTM4NjA0OQ==",
20587 |  16 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTg5OTY1NjQ1MDc1NzE5Ng==",
20588 |  17 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTM5MDY4MjkwMjc4MTI0Nw==",
20589 |  18 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMjY1ODQzNjM2NDU0MzExMg==",
20590 |  19 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTIxOTMyNjE4NjE5NzY0OQ==",
20591 |  20 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfNzA1OTk0MTA1OTI1MDMz",
20592 |  21 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfODk1NzE3NDY2MzIyMTMx",
20593 |  22 |       "Y29tbWVudDoxNTM4MzY0NTMxMjY5OTVfMTYxMzAxNzY0NjUzMzExNQ=="
20594 |  23 |     ]
20595 |  24 |   },
20596 |  25 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R": {
20597 |  26 |     "lastCount": 10,
20598 |  27 |     "knownIds": [
20599 |  28 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0MTI4NTk3NTA0OTc4MjM=",
20600 |  29 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzc0NjA4Njc1ODU1MjMxNQ==",
20601 |  30 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDczODQ2NTI5NzU0Mw==",
20602 |  31 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEzODI2NjExNTM1OTc5OTE=",
20603 |  32 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzE0Mjg4OTg4Mjg5NjgyNjE=",
20604 |  33 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg3NDI4MzMwODQxNzU0OA==",
20605 |  34 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0Xzg5NDAyMDg3NjQ3MDI3Nw==",
20606 |  35 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzEyNDczMDE4MzM4ODMyMDQ=",
20607 |  36 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQyMDk4MTIyMzkyMzI0NzY=",
20608 |  37 |       "Y29tbWVudDoxMDQ4NTU1MzMzOTU4MzI0XzQxMDc0Mjk0NTI3MzU2Njg="
20609 |  38 |     ]
20610 |  39 |   },
20611 |  40 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R": {
20612 |  41 |     "lastCount": 10,
20613 |  42 |     "knownIds": [
20614 |  43 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NTM5MjgxMjU4Mzk3Mjg=",
20615 |  44 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzg2MzE3NDIyOTY2MDQ2NQ==",
20616 |  45 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0OTA0NTAzMzk0NjA1NDk=",
20617 |  46 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MDY4MTE3OTEyMzI5NTQ=",
20618 |  47 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE5NDU4MDYyMjYzMTMxMTk=",
20619 |  48 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzc1MzMyOTk5NzI0MzE4MA==",
20620 |  49 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzExODM2NzcyNjAxNDA5ODI=",
20621 |  50 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzgyMzI2MTI1MDY5NTAzNA==",
20622 |  51 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE0MjU3MjI3NzI1MTQzMTk=",
20623 |  52 |       "Y29tbWVudDoxMDQ0NDg2ODkxMDIyNjMxXzE1NjMxOTcwNjQ3MjMwMDU="
20624 |  53 |     ]
20625 |  54 |   },
20626 |  55 |   "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R": {
20627 |  56 |     "lastCount": 4,
20628 |  57 |     "knownIds": [
20629 |  58 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfOTE2MjYzNjI4MDE4ODI2",
20630 |  59 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTQwNTc1MzE2MTI1NTAwNg==",
20631 |  60 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMzY4MDUyNTM3MjA3ODY5OQ==",
20632 |  61 |       "Y29tbWVudDoxMjIxODcwNDQzMTIzMDY1NTBfMTYyNDA2MjUzNTYyMjI2Mg=="
20633 |  62 |     ]
20634 |  63 |   },
20635 |  64 |   "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R": {
20636 |  65 |     "lastCount": 10,
20637 |  66 |     "knownIds": [
20638 |  67 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODk3NjcyMTg2Mjg2MzY5",
20639 |  68 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNDM1NTcyMDk1ODAzNjk1Mg==",
20640 |  69 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTA4MDAwMjI3NzU4NTE2MQ==",
20641 |  70 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTk2NTI0MzkwMTA4NDYxOA==",
20642 |  71 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfNzA3MDcxMjcyMjMwOTYx",
20643 |  72 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI3OTQ4OTgyNDIxNzQwMQ==",
20644 |  73 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTI2NTE4NTYwODc3Mzg4MQ==",
20645 |  74 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTQwNzc0MTg2NDExNzM2NA==",
20646 |  75 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfODI0MzQ2NjcwMzk5NTg2",
20647 |  76 |       "Y29tbWVudDoxNTQ4MDE3ODY2NjU4ODJfMTM1OTI5NDg4NTk0OTgwNg=="
20648 |  77 |     ]
20649 |  78 |   },
20650 |  79 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0318uW2Wb8gH4No2tudirSDVbDij3MCM1VM4nZ38mb3Kw9d8SDF8A8TyruVv5QLrTZl&id=61578702383044&__cft__[0]=AZZwCrt1G5eyASBVhdpuf3DZgoV_-CNIVqBzw1O4tN4UccEme5c6PCwt95Pjdcru2GOJ_QGzfYHeCwiZDvRdu5ZDS5zqeNlIs6DOvcIO9dWuWUhH1EyHO4LoMrF_sNYg_MD67DxNEzI60tDW7tXUTUVQx011P1sGO3cBu0EUOvcgTw&__tn__=%2CO%2CP-R": {
20651 |  80 |     "lastCount": 4,
20652 |  81 |     "knownIds": [
20653 |  82 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjMyNzE4MzE4NzcyMzY5NA==",
20654 |  83 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfODY5MjM1NjU1ODkyMTE1",
20655 |  84 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMTYwOTQ1Mjc3MzU2NDk1NA==",
20656 |  85 |       "Y29tbWVudDoxMjIxNDM5ODg0OTI5NTY3NDZfMjU5NTQ2MTQ4Njc1MjU5NTQ="
20657 |  86 |     ]
20658 |  87 |   },
20659 |  88 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R": {
20660 |  89 |     "lastCount": 10,
20661 |  90 |     "knownIds": [
20662 |  91 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfOTM3ODA2OTYxOTU3MTgz",
20663 |  92 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODk2MjY0MTA2NDc2MzY2",
20664 |  93 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfODQ4MzM0MTI0ODQ5MzIz",
20665 |  94 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjQ5NTY5Mzg3MDg0NjExOQ==",
20666 |  95 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTkzMTA1ODYzNzU5OTY4MQ==",
20667 |  96 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU3NzI4NjUzNzg5OTk2NDI=",
20668 |  97 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTA5NzM4OTAwMjQ2ODM1Ng==",
20669 |  98 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMjU2NTAwMDc1MzQ2NjUzMDk=",
20670 |  99 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTMxMDU0OTUwNDE3MTQyOQ==",
20671 | 100 |       "Y29tbWVudDoxMjIxNTAwOTQ4OTA4Mjk1ODJfMTEzNDgxNDg1NTIyNDUwNg=="
20672 | 101 |     ]
20673 | 102 |   },
20674 | 103 |   "https://www.facebook.com/AtelierGaragee/posts/pfbid02ATAxGye5dbcaG8bzAD8EQEyri7aFgm9XUsE1t342j4HSCkQcD1YT7F51WYMpfyN8l?__cft__[0]=AZaBEG6ksRywUu51yRCMwmNgFY1VReoKiSP1kUwfY6mLCTmDV38xiPUIOEXLvFrOuTxnrAihkxHoIISVh7TG6Sk5MrH9R_MPM4m55j_FtuMP6EIJQNZW28aSELdSa8vTZH8cIM1gr0GoAvuJ5jLiTjB2mXfIkn6n06IHHpR4RQ0vKQ&__tn__=%2CO%2CP-R": {
20675 | 104 |     "lastCount": 7,
20676 | 105 |     "knownIds": [
20677 | 106 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMjEzNjU5NDY2Mzc3MTQxMw==",
20678 | 107 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDIzODgyODc0MzAzMDU1NQ==",
20679 | 108 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTQxOTY3OTkzNjE3NDUxNg==",
20680 | 109 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNzI5ODE3NTg2NTU1NzA2",
20681 | 110 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfODY4NTU1OTA1OTExNzAy",
20682 | 111 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfMTkzMDU4NjIzNDE1ODk0OQ==",
20683 | 112 |       "Y29tbWVudDoxMjIxNDk1MDczMjg5MjQ0ODZfNDE3MTI3NzM5MzEzMjA5Ng=="
20684 | 113 |     ]
20685 | 114 |   },
20686 | 115 |   "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R": {
20687 | 116 |     "lastCount": 5,
20688 | 117 |     "knownIds": [
20689 | 118 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfODgzNzMxMzY3MzczNzkw",
20690 | 119 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMjU0MDU5Nzk3NTI0MTkwODA=",
20691 | 120 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfNzY3MTI1NDY5MDY2NTYy",
20692 | 121 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTY0OTYyODk4OTgxODA3OA==",
20693 | 122 |       "Y29tbWVudDoxMjIxMjEyMDA1NTkwMzQ0NDhfMTIzNTA4MDQwMTg1ODQ1OA=="
20694 | 123 |     ]
20695 | 124 |   },
20696 | 125 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R": {
20697 | 126 |     "lastCount": 9,
20698 | 127 |     "knownIds": [
20699 | 128 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTE3ODcwODMxNDQyODkxOQ==",
20700 | 129 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODc4Mzc3NzgxNzkwNTcz",
20701 | 130 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTk1Njg5ODk4MTkxMzI5NA==",
20702 | 131 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTU2ODIyNzI2NDQ5ODkxNQ==",
20703 | 132 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMjU2NTg0ODY4NzE0OTcyNw==",
20704 | 133 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODcxNDA2NjYyNTM1NjE5",
20705 | 134 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfODM4NDYxNjYyNTIwODkw",
20706 | 135 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMzA2Njk2NzUzNjg0NDc3NA==",
20707 | 136 |       "Y29tbWVudDoxMjIxNjM5NjM3NTIxOTA3MTVfMTIxNDM0MTQxMzk2OTE4Mw=="
20708 | 137 |     ]
20709 | 138 |   },
20710 | 139 |   "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R": {
20711 | 140 |     "lastCount": 0,
20712 | 141 |     "knownIds": []
20713 | 142 |   },
20714 | 143 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid035w4oCt6cS3n6zCdxYeYVhu5MrLm6gJo2MKPPtVK1R7APfTpPVkzyHnvfu9NkmFypl&id=100064116006584&__cft__[0]=AZZCqTstO-EyvwQuGR3_itqZZ0EVlzOHdSUCmBUvadLGqfz1-MvpYyJYlRhSiV4CynwiO_uaRpQvKHRhvksK3_ImJjibd6qWne7eOgOYHmrdmGx2u8SHjUsVoP7CM42LZ-9X3Hr-P5rtAtX7QFrXXK9ImMiiySJFt9BCw-Gfdw3p7Q&__tn__=%2CO%2CP-R": {
20715 | 144 |     "lastCount": 0,
20716 | 145 |     "knownIds": []
20717 | 146 |   },
20718 | 147 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R": {
20719 | 148 |     "lastCount": 10,
20720 | 149 |     "knownIds": [
20721 | 150 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzczMDAwMjU1MzQ5NzAwOQ==",
20722 | 151 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE0MzE2MDA4MDE4OTIzODM=",
20723 | 152 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg1NDAzMTU2MzkwMzE0OA==",
20724 | 153 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzIzMDI3NzY3NjY4ODMxNTI=",
20725 | 154 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTY3NzkyNTUzNTk3NjM=",
20726 | 155 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzExOTc1ODg4OTU2NDA1MjA=",
20727 | 156 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2Xzg3NTIzMTg3NTA4OTgyMQ==",
20728 | 157 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE1MjU2NDUwNjU4MTQwNzA=",
20729 | 158 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzEzOTAzMjg1OTU5MTIzOTg=",
20730 | 159 |       "Y29tbWVudDoxMzI4MjAyMzI5MzM2MDQ2XzE5MzI1ODM1MTEwMjI5MzE="
20731 | 160 |     ]
20732 | 161 |   },
20733 | 162 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02haCDE2RQqyVm3F9U2L7EXaAYoG4RMur5QoH814aVLbwhedNQJmNzxzpXNovZAeCil&id=100079527351401&__cft__[0]=AZZ4KqKhcAuigo35JEfdAJdl-sieDCm5aMX0PjuHk9MRO70fMmx66wJ43grMxUBvlsyMszWGovTDK-g5CigEof4_bJv5sgo0GKxq6CxWtc14BF6hi4xRwTNM1E-fw5rHkQ7KHKEYD6D8I4aKRS55tDd2EX1CtC6sJyT4va_X2uhnjw&__tn__=%2CO%2CP-R": {
20734 | 163 |     "lastCount": 10,
20735 | 164 |     "knownIds": [
20736 | 165 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjUwMzE2MTA2Njc0NDcyOQ==",
20737 | 166 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTA1MDI0Njg3NzI4NTg5OA==",
20738 | 167 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODIxNTgzMDI0MjU5MjM2",
20739 | 168 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYwNDAyMjc4ODIyODAxNTI=",
20740 | 169 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMTg1MzA2ODY4NTMzMDk4Mw==",
20741 | 170 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMjYxMTMzODY3NTE1OTEwOTU=",
20742 | 171 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODc4MDY0MDU0OTQ1Nzg5",
20743 | 172 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfMzE4NzA3NTg4ODEzMjk2Mw==",
20744 | 173 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfODgzMTMzNjc3NTA0Njk5",
20745 | 174 |       "Y29tbWVudDo4NjcwMzIyMzkyOTEwMTNfNjM4NTU4MjU5MzE0MDk4"
20746 | 175 |     ]
20747 | 176 |   },
20748 | 177 |   "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R": {
20749 | 178 |     "lastCount": 2,
20750 | 179 |     "knownIds": [
20751 | 180 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfODQ3Mjg0NTYxNDU5MzA1",
20752 | 181 |       "Y29tbWVudDoxMjIxMzYyMzY1MjgyODg2NzVfMTU2MDAyNjY1ODY1NzI0OQ=="
20753 | 182 |     ]
20754 | 183 |   },
20755 | 184 |   "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R": {
20756 | 185 |     "lastCount": 2,
20757 | 186 |     "knownIds": [
20758 | 187 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfNDM4NjgwMjEwODMwODM1NA==",
20759 | 188 |       "Y29tbWVudDo3NzIyMzgwMTU4MTU5NDRfOTEzMjIwMzU0NzI5MjAx"
20760 | 189 |     ]
20761 | 190 |   },
20762 | 191 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R": {
20763 | 192 |     "lastCount": 10,
20764 | 193 |     "knownIds": [
20765 | 194 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1Mzg2MzIwMjU3NzE5NjA4",
20766 | 195 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzE2NjE0NjUyMTgyMDI2MzU=",
20767 | 196 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg2NTk4NTAxMjk4NjUyNA==",
20768 | 197 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkxMDg1MDc0ODEwNzYzMg==",
20769 | 198 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzkwNDM4NjQzMjE2MDQ4OQ==",
20770 | 199 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI0NjI3Nzk3NDA4NDQ2MTU=",
20771 | 200 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzExODIwMjI3NDc0NTIyNzY=",
20772 | 201 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI1NjcyNTI5NDU5MDc0Nzc2",
20773 | 202 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzI5Mjc5MzAwMDczOTU3MjI=",
20774 | 203 |       "Y29tbWVudDoxMzg2NTM5MjMzMTcxMzkxXzg1NDAyOTY5MDc3NDkwMA=="
20775 | 204 |     ]
20776 | 205 |   },
20777 | 206 |   "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R": {
20778 | 207 |     "lastCount": 10,
20779 | 208 |     "knownIds": [
20780 | 209 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzEzNjk2NDAyMzc3MTAzMjY=",
20781 | 210 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MzI3MTM2NzQ2MjkyMjY=",
20782 | 211 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzIwMDM4MTM0OTAxNjU0NzY=",
20783 | 212 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1ODAxNzQ0OTYzNTUzNTc=",
20784 | 213 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzg4NzY4NjAzNzAwODIyOA==",
20785 | 214 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE4MTgwNjk5OTIyMDI5OTE=",
20786 | 215 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzcyNzEwMjU5Mzc3Njk0NA==",
20787 | 216 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzY0ODg1MjQxMTY0Njk5NQ==",
20788 | 217 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzE1MTA5NzMwMTAxMDg4Mzk=",
20789 | 218 |       "Y29tbWVudDoxMTg5ODM3ODk2MjcyMDkxXzgzMzM2NDU3NjI4MjQ0MQ=="
20790 | 219 |     ]
20791 | 220 |   },
20792 | 221 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R": {
20793 | 222 |     "lastCount": 10,
20794 | 223 |     "knownIds": [
20795 | 224 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMzg4MTg2ODc1ODc3MzExNQ==",
20796 | 225 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjM3NzQyNzI4NjA0MjE0NQ==",
20797 | 226 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTgxOTIwMjk4NTQyODAwMw==",
20798 | 227 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTIwNzMwMzEwNzU2NDU3NA==",
20799 | 228 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfOTM3ODM3NTI4ODI0ODUw",
20800 | 229 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMTM2MDk5NzQ5OTEwMzM3NQ==",
20801 | 230 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfMjQ0OTIzMTQ1MjE0MTU1NA==",
20802 | 231 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODIyMjQ0NjgwNDc4NDk4",
20803 | 232 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfNDIxMjE3MzAxOTA5OTcyMQ==",
20804 | 233 |       "Y29tbWVudDo3MzEzODE4OTMyMjgyNzZfODI1MzgyNDEzMTYxOTYz"
20805 | 234 |     ]
20806 | 235 |   },
20807 | 236 |   "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R": {
20808 | 237 |     "lastCount": 10,
20809 | 238 |     "knownIds": [
20810 | 239 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzk2NDgzNzYxNjcwODQ1Nw==",
20811 | 240 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE0MTE4NDE1MTA1ODY4Nzk=",
20812 | 241 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzg3MjE3MDExNTY4MDIyNg==",
20813 | 242 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzUxMjU3NDcyNTA5ODQ0MzA=",
20814 | 243 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE1Njg3MDUyODc3NjY4MTQ=",
20815 | 244 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NzY3MjA4NTk2MDY2Mzg=",
20816 | 245 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE3OTA3NjgxMjE2MjQyOTE=",
20817 | 246 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzkxMTAxNjg4NDYxNDc5Mw==",
20818 | 247 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzE5NDMxNTY5MTY2MDE3Nzc=",
20819 | 248 |       "Y29tbWVudDoxMzk3MDg4MTAyMjExNDcwXzIyODI0Njk5NzIyMzI3MjE="
20820 | 249 |     ]
20821 | 250 |   },
20822 | 251 |   "https://www.facebook.com/robstal.garaze.blaszane/posts/pfbid02aFFtjSkLZXQWiEowiS52Lx2Zht7M9Te5f4xosriFySu9BuP1WKFfV39MhKbyhJR9l?__cft__[0]=AZZTxMcsG7gI2gK2OOuyPJBa-_ZVrPQ0uZc0Idu_beS_85zVc7_fFP7OtcVuHUiEeboigKm2al5IpzDUlqiHmZcUoivzhkJnh-BH1WQnoDlIjfJ6sY-wVYcFBcsDyg5jl_4Fxm8yCGC8LhH_Qr0loqh2E5AlspC1TJZ6CkBU-pG6Iw&__tn__=%2CO%2CP-R": {
20823 | 252 |     "lastCount": 6,
20824 | 253 |     "knownIds": [
20825 | 254 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzI1NDk5NTIyMjE2MzIzNzMy",
20826 | 255 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE3NDE0NTIwNjAxNDQ2NDA=",
20827 | 256 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE0NjQ4MjgwMzUyNjg5NDE=",
20828 | 257 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzgyMTY3MDczNDIwMzM2Mg==",
20829 | 258 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzE1NjE1NDQyNDQ5Mjk2NjM=",
20830 | 259 |       "Y29tbWVudDoxNDU2NTE2NDU5ODEwODEwXzEzNjM4MDY5MjE0Mzc1NjE="
20831 | 260 |     ]
20832 | 261 |   },
20833 | 262 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R": {
20834 | 263 |     "lastCount": 8,
20835 | 264 |     "knownIds": [
20836 | 265 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTg5NTQ0Mjc0MTA2NzkzOA==",
20837 | 266 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjUzMTM3NjcyNDE2MjkxNjA=",
20838 | 267 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfODU2NDcxNDAzODM5NTA5",
20839 | 268 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTk0NDYwMTI0MzE0OTEzOA==",
20840 | 269 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTU0ODg1OTk0NjM2NDYzMw==",
20841 | 270 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTM1OTYyODIyODgyMDI1MA==",
20842 | 271 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMTQ0MTY1NTkyNzU1NTI1Ng==",
20843 | 272 |       "Y29tbWVudDo0NzQ1OTg3Njg0NjEyMzNfMjQ1Njk3OTU5ODA5MjI5Nw=="
20844 | 273 |     ]
20845 | 274 |   },
20846 | 275 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R": {
20847 | 276 |     "lastCount": 10,
20848 | 277 |     "knownIds": [
20849 | 278 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTM3NjMzMjEwMzc0MzI4Mg==",
20850 | 279 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTc4Mzg4MjE2ODk2NzA3Mg==",
20851 | 280 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTU1NDIzNTU0OTAwMzM4OQ==",
20852 | 281 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjExODcwMjk1ODY2NDk3MA==",
20853 | 282 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTI3NzEzMTQ2MTAyMDM5OA==",
20854 | 283 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMjUyODYxNTQyMzQzMzkzOTQ=",
20855 | 284 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODU0ODg2Mzk3NDM1Njk0",
20856 | 285 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMTQzODM3ODYxNDUyMzA2Mg==",
20857 | 286 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfODcwMTMxNjY5MDg0NTUw",
20858 | 287 |       "Y29tbWVudDo1NDE4NTU3MTE4MDg2NjlfMzUyNzkxNDE3NzM3MTA1Ng=="
20859 | 288 |     ]
20860 | 289 |   },
20861 | 290 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R": {
20862 | 291 |     "lastCount": 10,
20863 | 292 |     "knownIds": [
20864 | 293 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTYzMjEwMjg3NzkyNTA1Ng==",
20865 | 294 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTg0NjA1NDE3OTM2NDc1MA==",
20866 | 295 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODYxMTk2NDAzMzcyMDA3",
20867 | 296 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfODQwMTIxMjU4ODU0MDM3",
20868 | 297 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMjM0NTE2MjM3OTI5Mjk5NQ==",
20869 | 298 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU2MTUzMTI3ODM4MjA3Nw==",
20870 | 299 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfOTA3NDY3NzU1MDc0MTQ2",
20871 | 300 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY0NzE2MzYwNjI0NjE0MQ==",
20872 | 301 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTU5MjE5NTg2NTQ2NDUzNg==",
20873 | 302 |       "Y29tbWVudDo5Mzk2OTEyMzgxNjg4NjRfMTY1Njk1NjI5ODYwOTEzMA=="
20874 | 303 |     ]
20875 | 304 |   },
20876 | 305 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R": {
20877 | 306 |     "lastCount": 4,
20878 | 307 |     "knownIds": [
20879 | 308 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjIzMTI2MDAxMDYxMjkyMQ==",
20880 | 309 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMjQ4NzcxNjk1NTAxOTYzNQ==",
20881 | 310 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTYwNjA4OTk3Mzk4MjE2Nw==",
20882 | 311 |       "Y29tbWVudDo3NDY2MDQwOTQ1Mzk0NzJfMTE2NDg1MjIwMjUwNTgyMA=="
20883 | 312 |     ]
20884 | 313 |   },
20885 | 314 |   "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R": {
20886 | 315 |     "lastCount": 2,
20887 | 316 |     "knownIds": [
20888 | 317 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODg1NzkwMzI0MTk3NTI0",
20889 | 318 |       "Y29tbWVudDo4MjczMDcwNzY5NzU3MDRfODc0NDkwNDI4NjcyNDgz"
20890 | 319 |     ]
20891 | 320 |   },
20892 | 321 |   "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R": {
20893 | 322 |     "lastCount": 10,
20894 | 323 |     "knownIds": [
20895 | 324 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTYwODEzNDExMDUzMDY2Nw==",
20896 | 325 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODg0OTEyMjk3OTc0NA==",
20897 | 326 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfODc3OTA1NjU0ODgxNTk3",
20898 | 327 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTE0NjQyMDYwOTExMzMz",
20899 | 328 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTk0ODU3ODk4MjY4MDM1Ng==",
20900 | 329 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfOTIxMjU4MDUzNTc4Njc0",
20901 | 330 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjA4MzQzOTAwMjQwNzI2MQ==",
20902 | 331 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfNDI1NjIzOTI5NDY2NDYzNw==",
20903 | 332 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMjMzMzU5OTUyNzExNDk5OA==",
20904 | 333 |       "Y29tbWVudDo4NzI0NzMwNDE5NTI1NzZfMTQxODQ2MTcyMzEyMzkxOA=="
20905 | 334 |     ]
20906 | 335 |   },
20907 | 336 |   "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R": {
20908 | 337 |     "lastCount": 10,
20909 | 338 |     "knownIds": [
20910 | 339 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTYxOTcyMzkxMjUzNjQyMA==",
20911 | 340 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTkxNjUxNTY5OTc0NzE2NA==",
20912 | 341 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMjU3MDQyMjY4NTkyMDg1MzQ=",
20913 | 342 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQ5NjYwNTE0MTQwMjQyOQ==",
20914 | 343 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTQzNDU2OTA2NDc1MjYyMg==",
20915 | 344 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTU3NjUwODE2MzUwMjUxNg==",
20916 | 345 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM4MDgzNDU2Mzc4OTI3Nw==",
20917 | 346 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM5MTcxNTQ0MjQ2NTIwNQ==",
20918 | 347 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfODY0ODIyNjU2NDEwMDUz",
20919 | 348 |       "Y29tbWVudDoxMjIxNjQ2MzQyNzA0Mjg1MjBfMTM3MjM5MjIzMTM1MjUyNg=="
20920 | 349 |     ]
20921 | 350 |   },
20922 | 351 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R": {
20923 | 352 |     "lastCount": 10,
20924 | 353 |     "knownIds": [
20925 | 354 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTE5MTg1MzA0OTgwNTgzOQ==",
20926 | 355 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfOTA0NDI0NjQ4Nzg2MzU2",
20927 | 356 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkwNDM1MTkwMzgwMTc5Ng==",
20928 | 357 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTkyMDUyMTMwMjAwODYyNw==",
20929 | 358 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfODY0NDI3OTczMDA1Njkz",
20930 | 359 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfNzcxMTI5Mjc4NjAxMTQw",
20931 | 360 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTExNjg1NTg2NzA4NjM3Nw==",
20932 | 361 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTUzNTA0MTM5MTE2NzAzMA==",
20933 | 362 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTg0NTI2MjE1Mjc2NTk1Mg==",
20934 | 363 |       "Y29tbWVudDo4NTc5MDIzMTM1MzczMzlfMTU5MjIxNjQ2NTI0MTQ1OA=="
20935 | 364 |     ]
20936 | 365 |   },
20937 | 366 |   "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R": {
20938 | 367 |     "lastCount": 10,
20939 | 368 |     "knownIds": [
20940 | 369 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzg2MzU5NjM0Mjk2MTAwNA==",
20941 | 370 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0ODE1OTI1MzM1NjE5MTQ=",
20942 | 371 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzQxMjA4ODA3MDE1MTIxODA=",
20943 | 372 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzExMjk4MjU4MzI0Mzc3NTU=",
20944 | 373 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIzNjYzNzYzMTcxMzQ2MDg=",
20945 | 374 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIxOTEzNjEyMjc5NDAzNzk=",
20946 | 375 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzIwNzI3NDQzMzM1MTU3NjU=",
20947 | 376 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzM4Mjg1NTU0NzQxMTI0NDQ=",
20948 | 377 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE3MDI1NzY5MTczODIyMTY=",
20949 | 378 |       "Y29tbWVudDoxMjk4NTE1MDQ4ODM4MDkyXzE0NDUwNTQ3MTA1MjA2MDA="
20950 | 379 |     ]
20951 | 380 |   },
20952 | 381 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02WfKaSL6M75BrEuCFRhtbwaGifhdusk9fv1C6z7Uy2qjtgxnegr9eUSJ5DidUSTTBl&id=100083286129696&__cft__[0]=AZZWKYTrBrADgzl3D3vEiZ2tkuDzBlEy155fy0Pj_wYpv8qMioPu5zZ-DvHIiydZXWjg4kuZP08TLxcprCd_rL6InDXOEqNMpLWVreiSsfMojqV5ZfOigeJksjxDIjo0CT7lw0xOVDiT5_addtlk6SXi&__tn__=%2CO%2CP-R": {
20953 | 382 |     "lastCount": 10,
20954 | 383 |     "knownIds": [
20955 | 384 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE5ODIyMTY4MjUxODgxNA==",
20956 | 385 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTU2Mjc2NDgwODMyNTg2NA==",
20957 | 386 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMjQwMTAwNzI0ODIwMjQxMDI=",
20958 | 387 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM0MjcyNjQyNDI5MjExOQ==",
20959 | 388 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTM5MzQyNDc0NTU4NjE4Ng==",
20960 | 389 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTE2MzE2MjUwOTEzOTA5NQ==",
20961 | 390 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTUyNjMyNDIyNTMyNTE0Mg==",
20962 | 391 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTQ5ODQzNzU5MTI1MzM1MQ==",
20963 | 392 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfMTczNTEyMTk5NDUyMTEyNg==",
20964 | 393 |       "Y29tbWVudDo4NDIwMjMyODE5MTcyMDJfNzQ1Njk2NDMxNDMzMjgx"
20965 | 394 |     ]
20966 | 395 |   },
20967 | 396 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R": {
20968 | 397 |     "lastCount": 10,
20969 | 398 |     "knownIds": [
20970 | 399 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk1NDE5MDM5MDQwMzg=",
20971 | 400 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExOTcyNDc0NjU5MDYyODA=",
20972 | 401 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzI2NTEwNDMzMzI4NTQwNzYx",
20973 | 402 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzcyOTcxODI2MDIwNzg3OA==",
20974 | 403 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzczMjI4MTA3Mjg5NzY1NA==",
20975 | 404 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzExNDQ2MTM5ODc1NjgwNTU=",
20976 | 405 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzgwOTIwMzM4NTQ3MzgxMQ==",
20977 | 406 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzIxNDE1MTY0Nzk5NDg3MzM=",
20978 | 407 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzEzNzk0OTA3NjcyNTU4NjQ=",
20979 | 408 |       "Y29tbWVudDoxMzQ4NDc2NjE2MjI1OTU5XzMwMzQyODMxMDAyOTMyMTU="
20980 | 409 |     ]
20981 | 410 |   }
20982 | 411 | }
20983 | ```
20984 | 
20985 | ---
20986 | 
20987 | ### üìÑ ≈öcie≈ºka: `data/posts.json`
20988 | **Typ:** JSON  
20989 | **Opis:** Plik projektu (kod/konfiguracja).  
20990 | 
20991 | ```json
20992 |   1 | [
20993 |   2 |   {
20994 |   3 |     "id": "20d407e350f43063",
20995 |   4 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02VSSYPPS1ZEjkoS6g7mgAYyhCAiBFcY9i9RcREAWagrRohVVy7RaEcTxpCxtQjwUjl&id=100063839900527&__cft__[0]=AZaCcmuCTRsym7ezBQSI-WlqTftz-JWXQzfe0fSXRa_3FOVIuk7sNLzuKc31Z0Ck-_5E2tdDkmK1nyNXzBk-5jgUoiVoLTz9Oxgs5ldywXRNh2pgSjd9Czf-i5NUrauhLTrxlYpc65E1FKwRrrvSjnSJ6d55rMujXV3dA-DeCmr86w&__tn__=%2CO%2CP-R",
20996 |   5 |     "active": true,
20997 |   6 |     "name": "A1",
20998 |   7 |     "image": "",
20999 |   8 |     "description": "",
21000 |   9 |     "createdAt": "2026-01-13T12:01:58.668Z",
21001 |  10 |     "updatedAt": "2026-01-13T12:01:58.668Z"
21002 |  11 |   },
21003 |  12 |   {
21004 |  13 |     "id": "f689bed37d549bed",
21005 |  14 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid022EMXRbsYmyNsigLS2emWKbdeEsj8GHZgHhntwxFp8D4SrBThK8FUz3LMTaBMWuDkl&id=100064116006584&__cft__[0]=AZbf6WODUb7ujwMCMlh-DEHfQH0jhVdN829Es3ksABaB80UpyTDx5SpiDsiiYIRj1xRHZzVYxi5FuM-tTASKRYXswkn8zx9TAELIC-npgHvC6y7DDNi2I6kuJ3RFWlqHHnflAxxlBwZdojN8z89j0ITF&__tn__=%2CO%2CP-R",
21006 |  15 |     "active": true,
21007 |  16 |     "name": "A1",
21008 |  17 |     "image": "",
21009 |  18 |     "description": "",
21010 |  19 |     "createdAt": "2026-01-13T12:02:19.900Z",
21011 |  20 |     "updatedAt": "2026-01-13T12:02:19.900Z"
21012 |  21 |   },
21013 |  22 |   {
21014 |  23 |     "id": "71bb210aa5589b65",
21015 |  24 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02tEksPHmCFj53QshXFhtEnYh5XuxG6rSNC4kmUjZ6vKgBU4QB6R9jdiN9qBgajX8tl&id=100077333400638&__cft__[0]=AZY8xFv7nYEDf_BFQkWWM9iE7VLWrt4w9zMxKmiuvFKntlXZ4QbVlOJRlVppsbtmIoR81uYk40j6Mqn2mpHsPJDgNMxuBCxaMVcS9tU8TDVtv1Jl4PiKrMJJgMUycS5hNpIhPi63Y9bZcnesUo2JADrQ&__tn__=%2CO%2CP-R",
21016 |  25 |     "active": true,
21017 |  26 |     "name": "A1",
21018 |  27 |     "image": "",
21019 |  28 |     "description": "",
21020 |  29 |     "createdAt": "2026-01-13T12:02:38.054Z",
21021 |  30 |     "updatedAt": "2026-01-13T12:02:38.054Z"
21022 |  31 |   },
21023 |  32 |   {
21024 |  33 |     "id": "993164c73c6c2f3a",
21025 |  34 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02i52GEtCD4P6mCvCi8i3h8b4cbQvUjCHA7AuapvdGMT7bEk3s23pRB4UWQWDQM1J5l&id=61555721463094&__cft__[0]=AZatBPxVZhhSP3EmwGZTY6QzG1kBpQpaHh_7XwDDBG1hp6v2XphO4RBSTQ6nyXTjOIDchLVavEtRayjuaToUoPZdED3TNbQGY0sLdjA9p3fgZKG-V34i0qcsHnLvz3GzYUqNv6sO0yf6rbVG8zEFuhS6Ul7xW_CO6hEpnqEQgifP4Q&__tn__=%2CO%2CP-R",
21026 |  35 |     "active": true,
21027 |  36 |     "name": "A1",
21028 |  37 |     "image": "",
21029 |  38 |     "description": "",
21030 |  39 |     "createdAt": "2026-01-13T12:02:47.316Z",
21031 |  40 |     "updatedAt": "2026-01-13T12:02:47.316Z"
21032 |  41 |   },
21033 |  42 |   {
21034 |  43 |     "id": "2313d315e854c69d",
21035 |  44 |     "url": "https://www.facebook.com/benstalgarazeblaszane/posts/pfbid02pbL2tLS7yBUJAWiTAXvYY94f9WRM4a9Eq7eNMaY7V7wVrVdUp2wFYsxFLZeDHW8vl?__cft__[0]=AZZ3C6YR5rfnTSBQNPogEwrBjXCBMkQKq7ujZD0VG2t8DF9UZ7Q9KKM_MXf8UXVJDZioXlBoQMSfJVgVKQB8_P_sPY4TvZB4VS1ID8ZIGkat7yt9FZruPS2kmTQo681yL_UQyO3fFSrYiIqsWl_NpjaRQDKorhSoy1usuvKX6rAc0A&__tn__=%2CO%2CP-R",
21036 |  45 |     "active": true,
21037 |  46 |     "name": "A1",
21038 |  47 |     "image": "",
21039 |  48 |     "description": "",
21040 |  49 |     "createdAt": "2026-01-13T12:02:56.964Z",
21041 |  50 |     "updatedAt": "2026-01-13T12:02:56.964Z"
21042 |  51 |   },
21043 |  52 |   {
21044 |  53 |     "id": "6b805b9f4cbaeaea",
21045 |  54 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02C22egJdAHG8H8DAyfDVxLtSDWfs1AgW428Ds6CPVTmU9dboCvZtrnjf1L2kKbHtdl&id=100079527351401&__cft__[0]=AZbRqbqiGzdIW5eJSBu220w3cGmKT4womqgbJkQp895EBkchOJ1nOj-msYS86aRXeKtelcqSrPIcdX96FJfBUI5Kxlf-kUp-ohXPIVniVUj3OfUrpL2cpFLCm2yu5xmxRIAaWQRQBh39Bv4Q1M7qsEcP&__tn__=%2CO%2CP-R",
21046 |  55 |     "active": true,
21047 |  56 |     "name": "A1",
21048 |  57 |     "image": "",
21049 |  58 |     "description": "",
21050 |  59 |     "createdAt": "2026-01-13T12:03:12.748Z",
21051 |  60 |     "updatedAt": "2026-01-13T12:03:12.748Z"
21052 |  61 |   },
21053 |  62 |   {
21054 |  63 |     "id": "98187316e5c997d2",
21055 |  64 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid02PTbAbiPo41JgF5b6x1WU1iV7WcgB38GfMMFHhD5YDeWF2Xwo7pNmCLh4ZY1pACQ8l?__cft__[0]=AZYLbQtzC3FGfWoZ2U8rTU6nJ1ciq7EoSFL2u7aLbeL6fpjovEY3bTezhqAV9G4k1Bh82CcT5lGN0atzbAFcCyQypyZDjn3fSWbJwBfwOo3yBp71eByvuP0u0UiON-fWePyGu9oEKQo6YCsD7oro5O982j9wJiVozmLdn3C6s3mgUQ&__tn__=%2CO%2CP-R",
21056 |  65 |     "active": true,
21057 |  66 |     "name": "A1",
21058 |  67 |     "image": "",
21059 |  68 |     "description": "",
21060 |  69 |     "createdAt": "2026-01-13T12:03:23.490Z",
21061 |  70 |     "updatedAt": "2026-01-13T12:03:23.490Z"
21062 |  71 |   },
21063 |  72 |   {
21064 |  73 |     "id": "eaf757d67c85db01",
21065 |  74 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid02YYCiDvHT1VauSgumSFDsgHqamhUsK6RN4m8NxzT5zHXviCYecsQt8URsSWSXbcXVl?comment_id=2231260010612921&__cft__[0]=AZbl2B5VvvDLSPln8wNJBrEDKPRrsNOgStc9iREsaUoxwEnBQqJPG_8ezqGtKOOrhDuNkIB09-SPP9FhIxFEnNigmR6UDcjA874KnPkKD4TSj3r_NhWBs42HO4ihWqQpsFtTiMBVDTiKDSajLPRV-R1HuUyDOeOj4wr4p-IcI6_OUeOlozf0SMScorhUu1dNQT2pfmFv-Cdf5QL0Icb8zsSkvOMS2aMOeXrvmB5iTgMKeuY8Rr8_hq0D_vYj7IMOAtSaZRkJlMb0d3YhMMKMzEVnSNfArLy6HWtqKa2G7P-PHZuPskHoiPJvEwwS4ddjEZY&__tn__=R]-R",
21066 |  75 |     "active": true,
21067 |  76 |     "name": "A1",
21068 |  77 |     "image": "",
21069 |  78 |     "description": "",
21070 |  79 |     "createdAt": "2026-01-13T12:03:40.087Z",
21071 |  80 |     "updatedAt": "2026-01-13T12:03:40.087Z"
21072 |  81 |   },
21073 |  82 |   {
21074 |  83 |     "id": "5da859b41dc6453b",
21075 |  84 |     "url": "https://www.facebook.com/GoldStalGarage/posts/pfbid0YEwsUBNpQGWJkKL2nRMqko3drTpm5XCKdoM5suW9j6RLPmHG7BoDJwdn2JzMr8gCl?__cft__[0]=AZY9omJpGglNauO-sLCRL9_spH55jI0hAleXQgNPnXnsPZqxXGEy_pPwU19a5o64vDB41eRrtSFbN3DKKC_mACYAXj0LwQnuiJbubb8ANDbZgicS_Meo6YH1_4Wg5cAWkLb2HG-gniyLldEh1fzv-rO2VL_TwkwUha6dJAbdgHbZCA&__tn__=%2CO%2CP-R",
21076 |  85 |     "active": true,
21077 |  86 |     "name": "A1",
21078 |  87 |     "image": "",
21079 |  88 |     "description": "",
21080 |  89 |     "createdAt": "2026-01-13T12:03:48.543Z",
21081 |  90 |     "updatedAt": "2026-01-13T12:03:48.543Z"
21082 |  91 |   },
21083 |  92 |   {
21084 |  93 |     "id": "74d177191382a1f2",
21085 |  94 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02aVT91ukEXnvde7c5B1qpEwiirDWvQ71XBUKmaZSi2YUbJ4877cFEbVeZqwqE6s4Al&id=100031909016617&__cft__[0]=AZauAHc5-Bk4yiUp7QdRrRUO1hxhuINY5W_Jo4B6-Yk9sKOZX76HKMidBOa9zc9YtnS3zzsGe-cv7JlO-L_taSjbR24KSUjkTL3bhp6qwDKFDJHwoRVGUsD--uhLGBceods3IkwlwfGdFdvoB-DdgzsMGM1UyHTSNzOX4ImOQ4oI0Q&__tn__=%2CO%2CP-R",
21086 |  95 |     "active": true,
21087 |  96 |     "name": "A1",
21088 |  97 |     "image": "",
21089 |  98 |     "description": "",
21090 |  99 |     "createdAt": "2026-01-13T12:04:09.163Z",
21091 | 100 |     "updatedAt": "2026-01-13T12:04:09.163Z"
21092 | 101 |   },
21093 | 102 |   {
21094 | 103 |     "id": "43712b5c70dd5b63",
21095 | 104 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0f6aeG6NEbNga66WpTVgBMrudLFAJTVJg4NJdtjuPo7VkqR635iNbELwXTtub4hGVl&id=100063839900527&__cft__[0]=AZY2ael59pruXfot0BUN75Mm6dNSG23lNl7kRTm_8b30598JQSYG8K_QFSOKZ-qL--GMO08PkqiaixdugJ9UEljS_ePvppXtuMcWXM-NqovsVT4hoJM69bIxsV-8deVX4ZZGAxqLMZGy986YnrqXVhPxw7Ne4Fb_5HFeiSZ7EJvFQA&__tn__=%2CO%2CP-R",
21096 | 105 |     "active": true,
21097 | 106 |     "name": "A1",
21098 | 107 |     "image": "",
21099 | 108 |     "description": "",
21100 | 109 |     "createdAt": "2026-01-13T12:04:18.203Z",
21101 | 110 |     "updatedAt": "2026-01-13T12:04:18.203Z"
21102 | 111 |   },
21103 | 112 |   {
21104 | 113 |     "id": "1bb8d3d9d5817ba7",
21105 | 114 |     "url": "https://www.facebook.com/61558660258572/videos/1414775895855849/?__tn__=%2CO-R",
21106 | 115 |     "active": true,
21107 | 116 |     "name": "A1",
21108 | 117 |     "image": "",
21109 | 118 |     "description": "",
21110 | 119 |     "createdAt": "2026-01-13T12:04:27.086Z",
21111 | 120 |     "updatedAt": "2026-01-13T12:04:27.086Z"
21112 | 121 |   },
21113 | 122 |   {
21114 | 123 |     "id": "6ef3c021b443c50a",
21115 | 124 |     "url": "https://www.facebook.com/garazepajakpl/posts/pfbid0iW2sokZrviExRXELAu9dh8Df43yNBt5Z8rSPNCx5iw6DE2U3uqTWYbqbfCABpRkpl?__cft__[0]=AZYoPsznJ2Srwy_wZNfG7uIX5bkT6_D6fvC936auNLr1Lh0Jekxy96dbC7H_TrtfLg6153xQ-L92nEJdPOgj1m9Rptw30MKHZolaQ8SYiG2RcAsDkTP7blYIQzofd8FUCtCxxi59Xo2qrJxqnYCtLWrG1ifJU2qzRsc1-CAp2RFJJQ&__tn__=%2CO%2CP-R",
21116 | 125 |     "active": true,
21117 | 126 |     "name": "A4",
21118 | 127 |     "image": "",
21119 | 128 |     "description": "",
21120 | 129 |     "createdAt": "2026-01-13T12:04:38.682Z",
21121 | 130 |     "updatedAt": "2026-01-13T12:04:38.682Z"
21122 | 131 |   },
21123 | 132 |   {
21124 | 133 |     "id": "8116e13c116116c8",
21125 | 134 |     "url": "https://www.facebook.com/garaze.blaszane.igopol/posts/pfbid0hhjA4avKTXz7vELJasN6CWTEDmbq1DdKPfkPqpVZy6K3RWFFii4h91SA7hmu8j1Hl?__cft__[0]=AZYLv0QjzlAbFFvW7_ouvrV72Krl9pgrW9J4nO_laRn4RooCH3RyeWA8eKhQ4LNN12mjw8CiNFetXZaHqzr2ZwuyzZaIMW2UwNJ64abMpeIF9QHuB186P3lcw71lOE3GI1hmaoC75Zh1XDWd4OeBumt6jtvLRTXSS1W2dtIIl8swMg&__tn__=%2CO%2CP-R",
21126 | 135 |     "active": true,
21127 | 136 |     "name": "A4",
21128 | 137 |     "image": "",
21129 | 138 |     "description": "",
21130 | 139 |     "createdAt": "2026-01-13T12:04:46.680Z",
21131 | 140 |     "updatedAt": "2026-01-13T12:04:46.680Z"
21132 | 141 |   },
21133 | 142 |   {
21134 | 143 |     "id": "3b6cfa43309ffe8d",
21135 | 144 |     "url": "https://www.facebook.com/BatMaxKonstrukcjeStalowe/posts/pfbid033EnHC3PurxYU9XWJ7YRXvKtuDeEyJzZ1hF9YAq1dGT86yECwPWp9Gw1mHzvSRhEql?__cft__[0]=AZZ-vNVTDGmNWri-PX-dOb3E65sBPCWe1WvTFJzPFOgYOHsL-U9u5w6bxngRNm4frrfBGxFhydv9jvLl5LJOi8bdeOIFthOVjK4P3wIrt99IUl0aLaGSq6N9NUbDc3fxKENS2x1z_Bft3RpYydr_A_AiKR0BLflI8OBf6SBwTBSXLg&__tn__=%2CO%2CP-R",
21136 | 145 |     "active": true,
21137 | 146 |     "name": "A4",
21138 | 147 |     "image": "",
21139 | 148 |     "description": "",
21140 | 149 |     "createdAt": "2026-01-13T12:04:54.365Z",
21141 | 150 |     "updatedAt": "2026-01-13T12:04:54.365Z"
21142 | 151 |   },
21143 | 152 |   {
21144 | 153 |     "id": "0c50963c372aabab",
21145 | 154 |     "url": "https://www.facebook.com/marblachgaraze/posts/pfbid02CV7Z3oSNMYy9pN5mHBFsH7rqAc7Fq2XorDT5jpduq9maNa2kiDfSHX5PT3VcdZuvl?__cft__[0]=AZbehq2BhniHy43U9jlRNstD0NDudagcxFD293vT5tItkHkzoZzUNrhEj1HPUTnVM7H0-w1uoEV1kti9gyZxTK4zRomV7qROXG-sAttnWpfxFmBVgSQSXiRkZQIA2OiYhVCFsY1g7X_VSJPglDKhOg0icN3V5uOELybzYqNd61Hhsw&__tn__=%2CO%2CP-R",
21146 | 155 |     "active": true,
21147 | 156 |     "name": "A4",
21148 | 157 |     "image": "",
21149 | 158 |     "description": "",
21150 | 159 |     "createdAt": "2026-01-13T12:05:02.328Z",
21151 | 160 |     "updatedAt": "2026-01-13T12:05:02.328Z"
21152 | 161 |   },
21153 | 162 |   {
21154 | 163 |     "id": "4fe4b13eaed47ede",
21155 | 164 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid0385frdmrTJq3XATvytoB84mZUascuQLCCskFqCxue79G78yekFLhQubcC522kBiJal&id=100054459820783&__cft__[0]=AZbUrBzxuAZLrG6AzhQrjP8WUTy2620frWZoj2Q0r4aEo9u_814glQGSfm3wYLxksKbW7ESl2y3x-MObh5-O2B1x_MEFKTTaANP8Av1JfWRk7Ntwck1m3m-Hb-zX5SdkZer2FeuSglo6gk8IWDYR_0i-BPV4l3vsmzgfxBTL4R2NgA&__tn__=%2CO%2CP-R",
21156 | 165 |     "active": true,
21157 | 166 |     "name": "A4",
21158 | 167 |     "image": "",
21159 | 168 |     "description": "",
21160 | 169 |     "createdAt": "2026-01-13T12:05:10.668Z",
21161 | 170 |     "updatedAt": "2026-01-13T12:05:10.668Z"
21162 | 171 |   },
21163 | 172 |   {
21164 | 173 |     "id": "b46ca54914eebf06",
21165 | 174 |     "url": "https://www.facebook.com/100090892584903/videos/4298264617105972/?__cft__[0]=AZZX7rBpTU2s7ybx7z7-Wdm7O-FRYEdrQlfK4mswuznrThQd2hruuFjdea0x3bSM3fMe23z4EP7oToK7WqpqKLDX4IEa50pMLbvfiiXCanqb4Dfqg7m-iWuYU8FObGHE0fRuUdZNN_Ewtui5PZQe3meEYkgVlcctAioG4kyzePVlU6ULoIkI9iga_q2Pe8NAdzk1qytEpIlzHlnGAhUBg-2H&__tn__=%2CO%2CP-R",
21166 | 175 |     "active": true,
21167 | 176 |     "name": "A4",
21168 | 177 |     "image": "",
21169 | 178 |     "description": "",
21170 | 179 |     "createdAt": "2026-01-13T12:05:18.631Z",
21171 | 180 |     "updatedAt": "2026-01-13T12:05:18.631Z"
21172 | 181 |   },
21173 | 182 |   {
21174 | 183 |     "id": "d2ca2a803d8fc150",
21175 | 184 |     "url": "https://www.facebook.com/100090892584903/videos/1163051668579679/?__cft__[0]=AZYD3gwju8gg23qKtqwHjHHB1MSezuFJFXKWNwIUcOapk5LrjyZsPeGHKIcWu4SILXusLD_svnX1QiJmv2DCnzjJ6oC2tuFXofghckRvPP95Eyg9QAXaute42gxYcGMhZMAsC-KeY9enGKBU06gIy4DQVsYJmsHqyAalc39BQby5ubnFl9u2iJVjyDkiFT9UQyLqZIED8uzt9xwqFoRbrobT&__tn__=%2CO%2CP-R",
21176 | 185 |     "active": true,
21177 | 186 |     "name": "A4",
21178 | 187 |     "image": "",
21179 | 188 |     "description": "",
21180 | 189 |     "createdAt": "2026-01-13T12:05:28.201Z",
21181 | 190 |     "updatedAt": "2026-01-13T12:05:28.201Z"
21182 | 191 |   },
21183 | 192 |   {
21184 | 193 |     "id": "b5304298e34e0a96",
21185 | 194 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02Rwreig3BGgqu9dVE1JQWaVHyChRqHt7k23jSqMkPS9tUa19FTmpuGHX34cmEWLf9l&id=100090694156429&__cft__[0]=AZaYQrQCeD-JvsyOB63GxHc8crWaPvgQILNNL8HQHSgmA8lo45qf08_bSely5-qOkQQiPgYP_rMUQATUbkoYkWRAbGaFgCfbHWdGkFjPAKGFJ08_LjucIcrMz92-9yucxXfD9NCFoiS9AdqPD3IkEsK33iA4gbSvgv9ZqFAcsni5sA&__tn__=%2CO%2CP-R",
21186 | 195 |     "active": true,
21187 | 196 |     "name": "A6",
21188 | 197 |     "image": "",
21189 | 198 |     "description": "",
21190 | 199 |     "createdAt": "2026-01-13T12:05:36.647Z",
21191 | 200 |     "updatedAt": "2026-01-13T12:05:44.651Z"
21192 | 201 |   },
21193 | 202 |   {
21194 | 203 |     "id": "c96523ed0496d6a6",
21195 | 204 |     "url": "https://www.facebook.com/ms.concept.steel/posts/pfbid0PGfrf96hKuw3V4MEqXLL4bHULTzXaQvDypp9hR9ijyjW7jtsSNX3DVRCzfzJk3V9l?__cft__[0]=AZZHFCQwlKCyb_bYD4qyawxvXXc-zoi0Czj--16bi4DRRq5KVpSYl91TuNp_ZDoR28fyx7qtLE8DQ6KaJtvKFrrx3tSmnRKPOWdX8WsZan5UwpR50aEv--X77p__OwTdCk0P8UcZ3Yz7yFyZPE5EW839d1UVOTSxqGICIwVZnHW5ww&__tn__=%2CO%2CP-R",
21196 | 205 |     "active": true,
21197 | 206 |     "name": "A6",
21198 | 207 |     "image": "",
21199 | 208 |     "description": "",
21200 | 209 |     "createdAt": "2026-01-13T12:05:57.251Z",
21201 | 210 |     "updatedAt": "2026-01-13T12:05:57.251Z"
21202 | 211 |   },
21203 | 212 |   {
21204 | 213 |     "id": "bf549948402a600d",
21205 | 214 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid037jFLce5VryC4eJdnCZYUZ9Hcp44MYnG5vxaxLjMitgThXKB2yB8yT5qkJc5RkPBFl&id=100079527351401&__cft__[0]=AZaiFtFBax1bFE8vKJkeGNyU9VVQTsHTQ16qE96-kZU03P_PTlhAKbE4RgH83-8c-EWQVxKFl7Sm-ILjfBe7eTep2zm9JzGehvdT9U6XMqX_37uGGwFzEGPW2PJo0g69j8wq9rGz1A8RP5exhqrE7CWzl_BkHgGXcW8mGm6xtgb8iQ&__tn__=%2CO%2CP-R",
21206 | 215 |     "active": true,
21207 | 216 |     "name": "A6",
21208 | 217 |     "image": "",
21209 | 218 |     "description": "",
21210 | 219 |     "createdAt": "2026-01-13T12:06:00.841Z",
21211 | 220 |     "updatedAt": "2026-01-13T12:06:00.841Z"
21212 | 221 |   },
21213 | 222 |   {
21214 | 223 |     "id": "e60b5d49e8733062",
21215 | 224 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02yJeBwuPpLR9b2mPusiw1BCiqZwHEL8Cey8aAcweU3qmQ8PN9ojhhacHYjMWY8UAbl&id=100064388730474&__cft__[0]=AZaSwoWUqjVHoprikCftt37jySmhirDB19h4H7YPiLRDtMR7cY2rgtVyREfwPTBL8k7L9oXOCKUfaVdmkq2sHLVujhW3b6Y-Z4LN0kuZsRNVRcLcL0A0muL-oUjB3BLawS-7h86bFvZoed7lzrXFuItDInUD342PaL-c6v5T3pXX6g&__tn__=%2CO%2CP-R",
21216 | 225 |     "active": true,
21217 | 226 |     "name": "A6",
21218 | 227 |     "image": "",
21219 | 228 |     "description": "",
21220 | 229 |     "createdAt": "2026-01-13T12:06:12.701Z",
21221 | 230 |     "updatedAt": "2026-01-13T12:06:12.701Z"
21222 | 231 |   },
21223 | 232 |   {
21224 | 233 |     "id": "f8cccfff57b15d13",
21225 | 234 |     "url": "https://www.facebook.com/permalink.php?story_fbid=pfbid02cQQhP4CMbZmME3DaHNXX8gU7FShQXo21vgJyP15dwPjZKfwguEB4aRgR1dJ9pbnLl&id=61574887485674&__cft__[0]=AZb6ajISHPxQgK8K7q1CMzwNjQ7KpJk46RKFgYaRj9mpXaK5fxqYIpzo8lZjJWKn2p874SdGxsIgiD9_vCC0o3OaNkx2ple38M7yDtK9tEOyLKYU0OdF5-jwxCKkn0_6lAkQOlST7zrBjO1Hr0kPKu08boHt9N2GFQT0pb98LsvyqQ&__tn__=%2CO%2CP-R-R",
21226 | 235 |     "active": true,
21227 | 236 |     "name": "B5",
21228 | 237 |     "image": "",
21229 | 238 |     "description": "",
21230 | 239 |     "createdAt": "2026-01-13T12:06:21.505Z",
21231 | 240 |     "updatedAt": "2026-01-13T12:06:21.505Z"
21232 | 241 |   },
21233 | 242 |   {
21234 | 243 |     "id": "2ba4e8d680acf0fc",
21235 | 244 |     "url": "https://www.facebook.com/Martikstal/videos/635910122384237/?__tn__=%2CO-R",
21236 | 245 |     "active": true,
21237 | 246 |     "name": "B5",
21238 | 247 |     "image": "",
21239 | 248 |     "description": "",
21240 | 249 |     "createdAt": "2026-01-13T12:06:31.521Z",
21241 | 250 |     "updatedAt": "2026-01-13T12:06:31.521Z"
21242 | 251 |   },
21243 | 252 |   {
21244 | 253 |     "id": "03d290a9d31ca2b5",
21245 | 254 |     "url": "https://www.facebook.com/RSGarage.Producent/posts/pfbid0fuDN9sH6r5eaGbMQoe35oWCeQ8QkCtVNvyMQi8sq7hxEyM1vHJWLAJicdcBaftZfl?__cft__[0]=AZYibxiLWpOlT1A-vntlkfcbYEyeCKc6g3Lbx60ZeW7Ref5CVoPEWwEX3J_qGIKXxl2ZeaLByFNwMVxDaAmJHWdf3-eMFj2Sh3zfSTgPUrUqSyqT_pwjIrpdc35_9XFpm-x_Kp9i9CuK-KE_URJ1vqh5&__tn__=%2CO%2CP-R",
21246 | 255 |     "active": true,
21247 | 256 |     "name": "B5",
21248 | 257 |     "image": "",
21249 | 258 |     "description": "",
21250 | 259 |     "createdAt": "2026-01-13T12:06:41.365Z",
21251 | 260 |     "updatedAt": "2026-01-13T12:06:41.365Z"
21252 | 261 |   }
21253 | 262 | ]
21254 | 263 | 
21255 | ```
21256 | 
21257 | ---
21258 | 
21259 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/.env`
21260 | **Typ:** JavaScript/tekst  
21261 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
21262 | 
21263 | ```dotenv
21264 |  1 | FB_EMAIL=Test@Test.pl
21265 |  2 | FB_PASSWORD=test
21266 |  3 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz
21267 |  4 | CHECK_INTERVAL_MS=60000
21268 |  5 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
21269 |  6 | COOKIES_READ_ONLY=false
21270 |  7 | HEADLESS_BROWSER=true
21271 |  8 | USE_UI_HANDLERS=false
21272 |  9 | INCLUDE_REPLIES=true
21273 | 10 | 
21274 | 11 | PROJECT_DIR="C:/Projekty vs/FB_Watcher"
21275 | 12 | PANEL_TOKEN=TEST_TOKEN_123
21276 | 13 | PANEL_PORT=3180
21277 | 14 | PM2_APP=fbwatcher
21278 | 15 | 
21279 | 16 | PM2_LOG_OUT=C:\Users\zorro\.pm2\logs\fbwatcher-out.log
21280 | 17 | PM2_LOG_ERR=C:\Users\zorro\.pm2\logs\fbwatcher-error.log
21281 | ```
21282 | 
21283 | ---
21284 | 
21285 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/package.json`
21286 | **Typ:** JSON  
21287 | **Opis:** Metadane projektu i zale≈ºno≈õci (npm).  
21288 | 
21289 | ```json
21290 |  1 | {
21291 |  2 |   "name": "fb_puppeteer",
21292 |  3 |   "version": "1.0.0",
21293 |  4 |   "description": "Watcher komentarzy FB + webhook do Make",
21294 |  5 |   "main": "src/index.js",
21295 |  6 |   "type": "module",
21296 |  7 |   "scripts": {
21297 |  8 |     "start": "node src/index.js",
21298 |  9 |     "panel:exe": "npm run panel:build && npx @yao-pkg/pkg -t node20-win-x64 dist/panel-bundle.cjs -o dist/fbwatcher-panel.exe",
21299 | 10 |     "panel:build": "npx esbuild src/panel/api.js --bundle --platform=node --format=cjs --outfile=dist/panel-bundle.cjs"
21300 | 11 |   },
21301 | 12 |   "keywords": [],
21302 | 13 |   "author": "",
21303 | 14 |   "license": "ISC",
21304 | 15 |   "dependencies": {
21305 | 16 |     "axios": "^1.13.2",
21306 | 17 |     "dotenv": "^17.2.3",
21307 | 18 |     "puppeteer": "^24.31.0"
21308 | 19 |   },
21309 | 20 |   "devDependencies": {
21310 | 21 |     "@yao-pkg/pkg": "^6.11.0",
21311 | 22 |     "esbuild": "^0.27.2",
21312 | 23 |     "nexe": "^5.0.0-beta.4",
21313 | 24 |     "pkg": "^5.8.1"
21314 | 25 |   },
21315 | 26 |   "pkg": {
21316 | 27 |     "assets": [
21317 | 28 |       "src/panel/api.js",
21318 | 29 |       "src/panel/**/*.js",
21319 | 30 |       ".env",
21320 | 31 |       "data/**/*"
21321 | 32 |     ]
21322 | 33 |   }
21323 | 34 | }
21324 | ```
21325 | 
21326 | ---
21327 | 
21328 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/index.js`
21329 | **Typ:** JavaScript/tekst  
21330 | **Opis:** Plik projektu (kod/konfiguracja).  
21331 | 
21332 | ```js
21333 |  1 | // index.js
21334 |  2 | import { startWatcher } from "./watcher.js";
21335 |  3 | 
21336 |  4 | console.log("[CFG] HEADLESS_BROWSER (process.env) =", process.env.HEADLESS_BROWSER);
21337 |  5 | 
21338 |  6 | startWatcher().catch((err) => {
21339 |  7 |   console.error("Fatal error:", err);
21340 |  8 |   process.exit(1);
21341 |  9 | });
21342 | 10 | 
21343 | ```
21344 | 
21345 | ---
21346 | 
21347 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/watcher.js`
21348 | **Typ:** JavaScript/tekst  
21349 | **Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  
21350 | 
21351 | ```js
21352 |   1 | // src/watcher.js
21353 |   2 | import puppeteer from "puppeteer";
21354 |   3 | import fs from "fs";
21355 |   4 | import path from "path";
21356 |   5 | import {
21357 |   6 |   EXPAND_COMMENTS,
21358 |   7 |   CHECK_INTERVAL_MS,
21359 |   8 |   POSTS_SHEET_URL,
21360 |   9 |   POSTS_REFRESH_MS,
21361 |  10 | } from "./config.js";
21362 |  11 | 
21363 |  12 | import {
21364 |  13 |   prepare,
21365 |  14 |   getCommentCount,
21366 |  15 |   loadAllComments,
21367 |  16 |   extractCommentsData,
21368 |  17 | } from "./fb/comments.js";
21369 |  18 | 
21370 |  19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
21371 |  20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
21372 |  21 | import { sendWebhook } from "./webhook.js";
21373 |  22 | import { loadCache, saveCache } from "./db/cache.js";
21374 |  23 | 
21375 |  24 | /**
21376 |  25 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
21377 |  26 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
21378 |  27 |  *
21379 |  28 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
21380 |  29 |  * POSTS_FILE=C:\Projekty vs\FB_Watcher\data\posts.json
21381 |  30 |  */
21382 |  31 | const POSTS_FILE =
21383 |  32 |   process.env.POSTS_FILE ||
21384 |  33 |   path.join(process.cwd(), "data", "posts.json");
21385 |  34 | 
21386 |  35 | /**
21387 |  36 |  * CACHE DYSKOWY:
21388 |  37 |  * {
21389 |  38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
21390 |  39 |  * }
21391 |  40 |  */
21392 |  41 | const commentsCache = loadCache();
21393 |  42 | const lastCounts = new Map(); // url -> lastCount
21394 |  43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
21395 |  44 | 
21396 |  45 | for (const [url, entry] of Object.entries(commentsCache)) {
21397 |  46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
21398 |  47 |   if (Array.isArray(entry?.knownIds))
21399 |  48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
21400 |  49 | }
21401 |  50 | 
21402 |  51 | let currentPosts = [];
21403 |  52 | let lastRefreshAny = 0; // wsp√≥lny zegar od≈õwie≈ºania ≈∫r√≥de≈Ç
21404 |  53 | 
21405 |  54 | let navErrorCount = 0;
21406 |  55 | const MAX_NAV_ERRORS = 5;
21407 |  56 | 
21408 |  57 | function isNavigationError(err) {
21409 |  58 |   if (!err) return false;
21410 |  59 |   const msg = String(err.message || err).toLowerCase();
21411 |  60 |   return (
21412 |  61 |     msg.includes("safegoto-failed") ||
21413 |  62 |     msg.includes("navigation timeout") ||
21414 |  63 |     msg.includes("net::err_connection_timed_out") ||
21415 |  64 |     msg.includes("net::err_timed_out")
21416 |  65 |   );
21417 |  66 | }
21418 |  67 | 
21419 |  68 | /* ============================================================
21420 |  69 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
21421 |  70 |    ============================================================ */
21422 |  71 | 
21423 |  72 | async function applyStealth(page) {
21424 |  73 |   await page.evaluateOnNewDocument(() => {
21425 |  74 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
21426 |  75 |     // @ts-ignore
21427 |  76 |     window.chrome = window.chrome || { runtime: {} };
21428 |  77 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
21429 |  78 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
21430 |  79 | 
21431 |  80 |     const permissions = window.navigator.permissions;
21432 |  81 |     if (permissions && permissions.query) {
21433 |  82 |       const originalQuery = permissions.query.bind(permissions);
21434 |  83 |       permissions.query = (parameters) => {
21435 |  84 |         if (
21436 |  85 |           parameters &&
21437 |  86 |           parameters.name === "notifications" &&
21438 |  87 |           window.Notification
21439 |  88 |         ) {
21440 |  89 |           return Promise.resolve({ state: window.Notification.permission });
21441 |  90 |         }
21442 |  91 |         return originalQuery(parameters);
21443 |  92 |       };
21444 |  93 |     }
21445 |  94 |   });
21446 |  95 | }
21447 |  96 | 
21448 |  97 | /* ============================================================
21449 |  98 |    ===============   PANEL POSTS (data/posts.json)   ===========
21450 |  99 |    ============================================================ */
21451 | 100 | 
21452 | 101 | function safeJsonParse(s) {
21453 | 102 |   try {
21454 | 103 |     return { ok: true, value: JSON.parse(s) };
21455 | 104 |   } catch (e) {
21456 | 105 |     return { ok: false, error: e?.message || "Invalid JSON" };
21457 | 106 |   }
21458 | 107 | }
21459 | 108 | 
21460 | 109 | function normalizeUrl(u) {
21461 | 110 |   if (!u) return "";
21462 | 111 |   const x = String(u).trim();
21463 | 112 |   if (!/^https?:\/\/.+/i.test(x)) return "";
21464 | 113 |   return x;
21465 | 114 | }
21466 | 115 | 
21467 | 116 | function readPanelPosts() {
21468 | 117 |   try {
21469 | 118 |     if (!fs.existsSync(POSTS_FILE)) {
21470 | 119 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
21471 | 120 |     }
21472 | 121 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
21473 | 122 |     if (!raw) {
21474 | 123 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
21475 | 124 |     }
21476 | 125 |     const parsed = safeJsonParse(raw);
21477 | 126 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
21478 | 127 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
21479 | 128 |     }
21480 | 129 | 
21481 | 130 |     const posts = parsed.value
21482 | 131 |       .map((p) => {
21483 | 132 |         const url = normalizeUrl(p?.url);
21484 | 133 |         const active = Boolean(p?.active);
21485 | 134 |         if (!url) return null;
21486 | 135 |         return {
21487 | 136 |           id: String(p?.id || url),
21488 | 137 |           url,
21489 | 138 |           active,
21490 | 139 |           name: p?.name ? String(p.name) : "",
21491 | 140 |           image: p?.image ? String(p.image) : "",
21492 | 141 |           description: p?.description ? String(p.description) : "",
21493 | 142 |         };
21494 | 143 |       })
21495 | 144 |       .filter(Boolean);
21496 | 145 | 
21497 | 146 |     const activePosts = posts.filter((p) => p.active);
21498 | 147 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
21499 | 148 |   } catch (e) {
21500 | 149 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
21501 | 150 |   }
21502 | 151 | }
21503 | 152 | 
21504 | 153 | /* ============================================================
21505 | 154 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
21506 | 155 |    ============================================================ */
21507 | 156 | 
21508 | 157 | function parseSheetCsv(text) {
21509 | 158 |   const lines = text
21510 | 159 |     .split(/\r?\n/)
21511 | 160 |     .map((l) => l.trim())
21512 | 161 |     .filter((l) => l.length > 0);
21513 | 162 | 
21514 | 163 |   if (!lines.length) {
21515 | 164 |     console.warn("[Sheet] Pusty CSV z arkusza.");
21516 | 165 |     return [];
21517 | 166 |   }
21518 | 167 | 
21519 | 168 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
21520 | 169 | 
21521 | 170 |   const idxUrl = header.findIndex((h) => h === "url");
21522 | 171 |   const idxActive = header.findIndex((h) => h === "active");
21523 | 172 | 
21524 | 173 |   // nowe kolumny od klienta
21525 | 174 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
21526 | 175 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
21527 | 176 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
21528 | 177 | 
21529 | 178 |   if (idxUrl === -1) {
21530 | 179 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
21531 | 180 |     return [];
21532 | 181 |   }
21533 | 182 | 
21534 | 183 |   const posts = [];
21535 | 184 | 
21536 | 185 |   for (let i = 1; i < lines.length; i++) {
21537 | 186 |     const row = lines[i].split(",");
21538 | 187 |     const rawUrl = (row[idxUrl] || "").trim();
21539 | 188 |     if (!rawUrl) continue;
21540 | 189 | 
21541 | 190 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
21542 | 191 |     const activeNorm = activeRaw.toLowerCase();
21543 | 192 |     const isActive =
21544 | 193 |       idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
21545 | 194 | 
21546 | 195 |     if (!isActive) continue;
21547 | 196 | 
21548 | 197 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
21549 | 198 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
21550 | 199 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
21551 | 200 | 
21552 | 201 |     posts.push({
21553 | 202 |       id: `sheet-${i}`,
21554 | 203 |       url: rawUrl,
21555 | 204 |       name,
21556 | 205 |       image,
21557 | 206 |       description,
21558 | 207 |     });
21559 | 208 |   }
21560 | 209 | 
21561 | 210 |   return posts;
21562 | 211 | }
21563 | 212 | 
21564 | 213 | /* ============================================================
21565 | 214 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
21566 | 215 |    ============================================================ */
21567 | 216 | 
21568 | 217 | async function refreshPostsIfNeeded(force = false) {
21569 | 218 |   const now = Date.now();
21570 | 219 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
21571 | 220 |   lastRefreshAny = now;
21572 | 221 | 
21573 | 222 |   // 1) PRIMARY: panel posts.json
21574 | 223 |   const panel = readPanelPosts();
21575 | 224 |   if (panel.ok && panel.posts.length > 0) {
21576 | 225 |     const newPosts = panel.posts;
21577 | 226 | 
21578 | 227 |     const oldJson = JSON.stringify(currentPosts);
21579 | 228 |     const newJson = JSON.stringify(newPosts);
21580 | 229 | 
21581 | 230 |     if (oldJson !== newJson) {
21582 | 231 |       console.log(
21583 | 232 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
21584 | 233 |       );
21585 | 234 |       currentPosts = newPosts;
21586 | 235 |     } else {
21587 | 236 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
21588 | 237 |     }
21589 | 238 |     return;
21590 | 239 |   }
21591 | 240 | 
21592 | 241 |   console.log(
21593 | 242 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
21594 | 243 |   );
21595 | 244 | 
21596 | 245 |   // 2) FALLBACK: Sheets
21597 | 246 |   if (!POSTS_SHEET_URL) {
21598 | 247 |     console.warn(
21599 | 248 |       "[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza."
21600 | 249 |     );
21601 | 250 |     currentPosts = [];
21602 | 251 |     return;
21603 | 252 |   }
21604 | 253 | 
21605 | 254 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
21606 | 255 | 
21607 | 256 |   try {
21608 | 257 |     const res = await fetch(POSTS_SHEET_URL);
21609 | 258 |     if (!res.ok) {
21610 | 259 |       console.error(
21611 | 260 |         "[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:",
21612 | 261 |         res.status,
21613 | 262 |         res.statusText
21614 | 263 |       );
21615 | 264 |       currentPosts = [];
21616 | 265 |       return;
21617 | 266 |     }
21618 | 267 | 
21619 | 268 |     const csvText = await res.text();
21620 | 269 |     const newPosts = parseSheetCsv(csvText);
21621 | 270 | 
21622 | 271 |     if (!newPosts.length) {
21623 | 272 |       console.warn(
21624 | 273 |         "[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE)."
21625 | 274 |       );
21626 | 275 |       currentPosts = [];
21627 | 276 |       return;
21628 | 277 |     }
21629 | 278 | 
21630 | 279 |     const oldJson = JSON.stringify(currentPosts);
21631 | 280 |     const newJson = JSON.stringify(newPosts);
21632 | 281 | 
21633 | 282 |     if (oldJson !== newJson) {
21634 | 283 |       console.log(
21635 | 284 |         `[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`
21636 | 285 |       );
21637 | 286 |       currentPosts = newPosts;
21638 | 287 |     } else {
21639 | 288 |       console.log("[Sheet] Lista post√≥w bez zmian.");
21640 | 289 |     }
21641 | 290 |   } catch (err) {
21642 | 291 |     console.error(
21643 | 292 |       "[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:",
21644 | 293 |       err.message
21645 | 294 |     );
21646 | 295 |     currentPosts = [];
21647 | 296 |   }
21648 | 297 | }
21649 | 298 | 
21650 | 299 | /* ============================================================
21651 | 300 |    =====================   CACHE HELPERS   =====================
21652 | 301 |    ============================================================ */
21653 | 302 | 
21654 | 303 | function getCacheKey(post) {
21655 | 304 |   return post.url;
21656 | 305 | }
21657 | 306 | 
21658 | 307 | function getKnownSetForPost(cacheKey) {
21659 | 308 |   let set = knownCommentsPerPost.get(cacheKey);
21660 | 309 |   if (!set) {
21661 | 310 |     const entry = commentsCache[cacheKey];
21662 | 311 |     set =
21663 | 312 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
21664 | 313 |     knownCommentsPerPost.set(cacheKey, set);
21665 | 314 |   }
21666 | 315 |   return set;
21667 | 316 | }
21668 | 317 | 
21669 | 318 | function flushCacheToDisk() {
21670 | 319 |   const out = { ...commentsCache };
21671 | 320 | 
21672 | 321 |   for (const [cacheKey, count] of lastCounts.entries()) {
21673 | 322 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
21674 | 323 |     out[cacheKey].lastCount = count;
21675 | 324 |   }
21676 | 325 | 
21677 | 326 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
21678 | 327 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
21679 | 328 |     out[cacheKey].knownIds = Array.from(set);
21680 | 329 |   }
21681 | 330 | 
21682 | 331 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
21683 | 332 |   Object.assign(commentsCache, out);
21684 | 333 |   saveCache(out);
21685 | 334 | }
21686 | 335 | 
21687 | 336 | /* ============================================================
21688 | 337 |    =====================   G≈Å√ìWNY WATCHER   ===================
21689 | 338 |    ============================================================ */
21690 | 339 | 
21691 | 340 | const isDev = process.env.NODE_ENV !== "production";
21692 | 341 | 
21693 | 342 | async function startWatcher() {
21694 | 343 |   console.log(
21695 | 344 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
21696 | 345 |     Math.round(CHECK_INTERVAL_MS / 1000),
21697 | 346 |     "sekund."
21698 | 347 |   );
21699 | 348 | 
21700 | 349 |   const loop = async () => {
21701 | 350 |     let browser = null;
21702 | 351 |     let page = null;
21703 | 352 |     let hadNavErrorThisRound = false;
21704 | 353 | 
21705 | 354 |     try {
21706 | 355 |       console.log(
21707 | 356 |         "[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="
21708 | 357 |       );
21709 | 358 | 
21710 | 359 |       browser = await puppeteer.launch({
21711 | 360 |         headless: isDev ? true : "new",
21712 | 361 |         defaultViewport: null,
21713 | 362 |         args: [
21714 | 363 |           "--no-sandbox",
21715 | 364 |           "--disable-setuid-sandbox",
21716 | 365 |           "--disable-dev-shm-usage",
21717 | 366 |           "--disable-notifications",
21718 | 367 |           "--disable-blink-features=AutomationControlled",
21719 | 368 |         ],
21720 | 369 |         ignoreDefaultArgs: ["--enable-automation"],
21721 | 370 |       });
21722 | 371 | 
21723 | 372 |       page = await browser.newPage();
21724 | 373 |       await applyStealth(page);
21725 | 374 | 
21726 | 375 |       page.setDefaultNavigationTimeout(90000);
21727 | 376 |       page.setDefaultTimeout(90000);
21728 | 377 | 
21729 | 378 |       await page.setViewport({ width: 1280, height: 720 });
21730 | 379 | 
21731 | 380 |       // cookies + login
21732 | 381 |       await loadCookies(page);
21733 | 382 |       await page
21734 | 383 |         .goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 })
21735 | 384 |         .catch(() => {});
21736 | 385 | 
21737 | 386 |       let loggedIn = await checkIfLogged(page);
21738 | 387 |       if (!loggedIn) {
21739 | 388 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
21740 | 389 |         await fbLogin(page);
21741 | 390 |         loggedIn = await checkIfLogged(page);
21742 | 391 | 
21743 | 392 |         if (loggedIn) {
21744 | 393 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
21745 | 394 |           await saveCookies(page);
21746 | 395 |         } else {
21747 | 396 |           console.error(
21748 | 397 |             "[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone)."
21749 | 398 |           );
21750 | 399 |         }
21751 | 400 |       } else {
21752 | 401 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
21753 | 402 |       }
21754 | 403 | 
21755 | 404 |       // posts
21756 | 405 |       await refreshPostsIfNeeded(true);
21757 | 406 | 
21758 | 407 |       if (!currentPosts.length) {
21759 | 408 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
21760 | 409 |       } else {
21761 | 410 |         for (const post of currentPosts) {
21762 | 411 |           const cacheKey = getCacheKey(post);
21763 | 412 | 
21764 | 413 |           try {
21765 | 414 |             // zawsze prepare przed liczeniem/scrollowaniem/ekstrakcjƒÖ
21766 | 415 |             await prepare(page, post.url);
21767 | 416 | 
21768 | 417 |             const count = await getCommentCount(page, post.url);
21769 | 418 |             const hasCount = typeof count === "number" && Number.isFinite(count);
21770 | 419 | 
21771 | 420 |             if (!hasCount) {
21772 | 421 |               console.log(
21773 | 422 |                 `[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`
21774 | 423 |               );
21775 | 424 |             }
21776 | 425 | 
21777 | 426 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
21778 | 427 |             const knownSet = getKnownSetForPost(cacheKey);
21779 | 428 | 
21780 | 429 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
21781 | 430 |             if (prev === null) {
21782 | 431 |               const initialCount = hasCount ? count : 0;
21783 | 432 |               lastCounts.set(cacheKey, initialCount);
21784 | 433 | 
21785 | 434 |               console.log(
21786 | 435 |                 hasCount
21787 | 436 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
21788 | 437 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
21789 | 438 |               );
21790 | 439 | 
21791 | 440 |               if (EXPAND_COMMENTS) {
21792 | 441 |                 await loadAllComments(
21793 | 442 |                   page,
21794 | 443 |                   { expectedTotal: hasCount ? count : undefined },
21795 | 444 |                   post.url
21796 | 445 |                 ).catch(() => {});
21797 | 446 | 
21798 | 447 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
21799 | 448 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
21800 | 449 |                 console.log(
21801 | 450 |                   `[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`
21802 | 451 |                 );
21803 | 452 |               } else {
21804 | 453 |                 console.log(
21805 | 454 |                   `[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`
21806 | 455 |                 );
21807 | 456 |               }
21808 | 457 | 
21809 | 458 |               continue;
21810 | 459 |             }
21811 | 460 | 
21812 | 461 |             // licznik: aktualizuj tylko je≈õli mamy twarde dane
21813 | 462 |             if (hasCount) {
21814 | 463 |               if (count !== prev) {
21815 | 464 |                 console.log(
21816 | 465 |                   `[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`
21817 | 466 |                 );
21818 | 467 |                 lastCounts.set(cacheKey, count);
21819 | 468 |               } else {
21820 | 469 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
21821 | 470 |               }
21822 | 471 |             } else {
21823 | 472 |               console.log(
21824 | 473 |                 `[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`
21825 | 474 |               );
21826 | 475 |             }
21827 | 476 | 
21828 | 477 |             if (!EXPAND_COMMENTS) continue;
21829 | 478 | 
21830 | 479 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(
21831 | 480 |               () => {}
21832 | 481 |             );
21833 | 482 | 
21834 | 483 |             let snapshot = await extractCommentsData(page, post.url).catch(() => []);
21835 | 484 | 
21836 | 485 |             // nowe ID
21837 | 486 |             const newComments = [];
21838 | 487 |             for (const c of snapshot) {
21839 | 488 |               if (!c?.id) continue;
21840 | 489 |               if (!knownSet.has(c.id)) {
21841 | 490 |                 knownSet.add(c.id);
21842 | 491 |                 newComments.push(c);
21843 | 492 |               }
21844 | 493 |             }
21845 | 494 | 
21846 | 495 |             // fallback "tail" tylko je≈õli mamy wiarygodny licznik i wzrost
21847 | 496 |             if (hasCount && newComments.length === 0 && count > prev) {
21848 | 497 |               const diff = Math.max(1, count - prev);
21849 | 498 |               const tail = snapshot.slice(-diff);
21850 | 499 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
21851 | 500 | 
21852 | 501 |               console.log(
21853 | 502 |                 `[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`
21854 | 503 |               );
21855 | 504 |               await sendWebhook(post, tail, count, prev);
21856 | 505 |               continue;
21857 | 506 |             }
21858 | 507 | 
21859 | 508 |             if (newComments.length > 0) {
21860 | 509 |               console.log(
21861 | 510 |                 `[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`
21862 | 511 |               );
21863 | 512 |               await sendWebhook(
21864 | 513 |                 post,
21865 | 514 |                 newComments,
21866 | 515 |                 hasCount ? count : null,
21867 | 516 |                 hasCount ? prev : null
21868 | 517 |               );
21869 | 518 |             } else {
21870 | 519 |               console.log(
21871 | 520 |                 `[Watcher] Post ${post.id}: Brak nowych komentarzy (po ID i fallbacku).`
21872 | 521 |               );
21873 | 522 |             }
21874 | 523 |           } catch (err) {
21875 | 524 |             console.error(
21876 | 525 |               `[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`,
21877 | 526 |               err?.message || err
21878 | 527 |             );
21879 | 528 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
21880 | 529 | 
21881 | 530 |             if (isNavigationError(err)) {
21882 | 531 |               hadNavErrorThisRound = true;
21883 | 532 |               navErrorCount++;
21884 | 533 |               console.log(
21885 | 534 |                 `[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`
21886 | 535 |               );
21887 | 536 |             }
21888 | 537 |           }
21889 | 538 |         }
21890 | 539 |       }
21891 | 540 |     } catch (err) {
21892 | 541 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
21893 | 542 |     } finally {
21894 | 543 |       flushCacheToDisk();
21895 | 544 | 
21896 | 545 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
21897 | 546 |         console.log(
21898 | 547 |           `[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`
21899 | 548 |         );
21900 | 549 |         navErrorCount = 0;
21901 | 550 |       }
21902 | 551 | 
21903 | 552 |       if (browser) {
21904 | 553 |         try {
21905 | 554 |           await browser.close();
21906 | 555 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
21907 | 556 |         } catch (e) {
21908 | 557 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
21909 | 558 |         }
21910 | 559 |       }
21911 | 560 | 
21912 | 561 |       if (navErrorCount >= MAX_NAV_ERRORS) {
21913 | 562 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
21914 | 563 |         process.exit(1);
21915 | 564 |       }
21916 | 565 | 
21917 | 566 |       const jitter = Math.floor(Math.random() * 5000);
21918 | 567 |       const delay = CHECK_INTERVAL_MS + jitter;
21919 | 568 |       console.log(
21920 | 569 |         `[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`
21921 | 570 |       );
21922 | 571 |       setTimeout(loop, delay);
21923 | 572 |     }
21924 | 573 |   };
21925 | 574 | 
21926 | 575 |   loop();
21927 | 576 | }
21928 | 577 | 
21929 | 578 | export { startWatcher };
21930 | 579 | 
21931 | ```
21932 | 
21933 | ---
21934 | 
21935 | ### üìÑ ≈öcie≈ºka: `DEBUG_EXPORT/src/webhook.js`
21936 | **Typ:** JavaScript/tekst  
21937 | **Opis:** Plik projektu (kod/konfiguracja).  
21938 | 
21939 | ```js
21940 |   1 | // src/webhook.js
21941 |   2 | import axios from "axios";
21942 |   3 | import { POST_LABELS } from "./config.js";
21943 |   4 | 
21944 |   5 | /* ============================================================
21945 |   6 |    PARSER CZASU FB ‚Üí ISO
21946 |   7 |    ============================================================ */
21947 |   8 | 
21948 |   9 | function parseFbRelativeTime(raw) {
21949 |  10 |   if (!raw) return null;
21950 |  11 | 
21951 |  12 |   const t = raw.toLowerCase().trim();
21952 |  13 |   const now = new Date();
21953 |  14 | 
21954 |  15 |   if (t.includes("przed chwilƒÖ")) return now;
21955 |  16 | 
21956 |  17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
21957 |  18 |     const d = new Date(now);
21958 |  19 |     d.setDate(d.getDate() - 1);
21959 |  20 |     return d;
21960 |  21 |   }
21961 |  22 | 
21962 |  23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
21963 |  24 |   if (!m) return null;
21964 |  25 | 
21965 |  26 |   const value = parseInt(m[1], 10);
21966 |  27 |   if (!Number.isFinite(value)) return null;
21967 |  28 | 
21968 |  29 |   const unit = m[2];
21969 |  30 |   const d = new Date(now);
21970 |  31 | 
21971 |  32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
21972 |  33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
21973 |  34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
21974 |  35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
21975 |  36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
21976 |  37 | 
21977 |  38 |   return d;
21978 |  39 | }
21979 |  40 | 
21980 |  41 | /* ============================================================
21981 |  42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
21982 |  43 |    ============================================================ */
21983 |  44 | 
21984 |  45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
21985 |  46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
21986 |  47 | 
21987 |  48 | function filterByAge(comments) {
21988 |  49 |   const now = Date.now();
21989 |  50 | 
21990 |  51 |   return comments.filter((c) => {
21991 |  52 |     if (!c.time || c.time.trim() === "") return false;
21992 |  53 | 
21993 |  54 |     const abs = parseFbRelativeTime(c.time);
21994 |  55 |     if (!abs) return false;
21995 |  56 | 
21996 |  57 |     const ageMinutes = (now - abs.getTime()) / 60000;
21997 |  58 |     return ageMinutes <= MAX_AGE_MIN;
21998 |  59 |   });
21999 |  60 | }
22000 |  61 | 
22001 |  62 | /* ============================================================
22002 |  63 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
22003 |  64 |    ============================================================ */
22004 |  65 | 
22005 |  66 | async function sendWebhook(post, newComments, newCount, oldCount) {
22006 |  67 |   const url = process.env.WEBHOOK_URL;
22007 |  68 |   if (!url) {
22008 |  69 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
22009 |  70 |     return;
22010 |  71 |   }
22011 |  72 | 
22012 |  73 |   // meta posta (panel/sheets/env fallback)
22013 |  74 |   const postName =
22014 |  75 |     (post?.name && String(post.name).trim()) ||
22015 |  76 |     POST_LABELS[post?.id] ||
22016 |  77 |     post?.id ||
22017 |  78 |     "post";
22018 |  79 | 
22019 |  80 |   const postImage =
22020 |  81 |     (post?.image && String(post.image).trim()) || null;
22021 |  82 | 
22022 |  83 |   const postDescription =
22023 |  84 |     (post?.description && String(post.description).trim()) || null;
22024 |  85 | 
22025 |  86 |   /* --------------------------------------------
22026 |  87 |        1) Normalizacja czasu i dodanie p√≥l ISO
22027 |  88 |      -------------------------------------------- */
22028 |  89 | 
22029 |  90 |   const normalized = newComments.map((c) => {
22030 |  91 |     const iso = parseFbRelativeTime(c.time);
22031 |  92 |     return {
22032 |  93 |       ...c,
22033 |  94 |       fb_time_raw: c.time || null,
22034 |  95 |       fb_time_iso: iso ? iso.toISOString() : null,
22035 |  96 |     };
22036 |  97 |   });
22037 |  98 | 
22038 |  99 |   /* --------------------------------------------
22039 | 100 |        2) Filtrowanie komentarzy po wieku
22040 | 101 |      -------------------------------------------- */
22041 | 102 | 
22042 | 103 |   const freshOnly = filterByAge(normalized);
22043 | 104 | 
22044 | 105 |   console.log("[Webhook] Filtr wieku komentarzy:", {
22045 | 106 |     before: normalized.length,
22046 | 107 |     after: freshOnly.length,
22047 | 108 |     maxAgeMin: MAX_AGE_MIN,
22048 | 109 |   });
22049 | 110 | 
22050 | 111 |   if (freshOnly.length === 0) {
22051 | 112 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
22052 | 113 |     return;
22053 | 114 |   }
22054 | 115 | 
22055 | 116 |   /* --------------------------------------------
22056 | 117 |        3) Payload do webhooka
22057 | 118 |      -------------------------------------------- */
22058 | 119 | 
22059 | 120 |   const payload = {
22060 | 121 |     post: {
22061 | 122 |       id: post?.id || null,
22062 | 123 |       url: post?.url || null,
22063 | 124 |       name: postName,
22064 | 125 |       image: postImage,
22065 | 126 |       description: postDescription,
22066 | 127 |     },
22067 | 128 |     commentCount: newCount,
22068 | 129 |     previousCommentCount: oldCount,
22069 | 130 |     newComments: freshOnly,
22070 | 131 |     timestamp: new Date().toISOString(),
22071 | 132 |   };
22072 | 133 | 
22073 | 134 |   console.log("[Webhook] Wysy≈Çanie danych o nowych komentarzach:", payload);
22074 | 135 | 
22075 | 136 |   /* --------------------------------------------
22076 | 137 |        4) Wysy≈Çka do Make / webhooka
22077 | 138 |      -------------------------------------------- */
22078 | 139 | 
22079 | 140 |   try {
22080 | 141 |     await axios.post(url, payload, { timeout: 10000 });
22081 | 142 |     console.log("[Webhook] Wys≈Çano nowe komentarze do webhooka.");
22082 | 143 |   } catch (err) {
22083 | 144 |     console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err.message);
22084 | 145 |   }
22085 | 146 | }
22086 | 147 | 
22087 | 148 | export { sendWebhook };
22088 | 149 | 
22089 | ```
22090 | 
22091 | ---
22092 | 
22093 | ### üìÑ ≈öcie≈ºka: `debug-login.mjs`
22094 | **Typ:** JavaScript/tekst  
22095 | **Opis:** Plik projektu (kod/konfiguracja).  
22096 | 
22097 | ```js
22098 |  1 | import fs from "fs/promises";
22099 |  2 | import puppeteer from "puppeteer";
22100 |  3 | 
22101 |  4 | const email = process.env.FB_EMAIL;
22102 |  5 | const pass = process.env.FB_PASSWORD;
22103 |  6 | 
22104 |  7 | if (!email || !pass) {
22105 |  8 |   console.log("Brak FB_EMAIL/FB_PASSWORD w env (.env lub zmienne).");
22106 |  9 |   process.exit(1);
22107 | 10 | }
22108 | 11 | 
22109 | 12 | const executablePath = process.env.PUPPETEER_EXECUTABLE_PATH || "/usr/bin/chromium-browser";
22110 | 13 | 
22111 | 14 | const browser = await puppeteer.launch({
22112 | 15 |   headless: true,
22113 | 16 |   executablePath,
22114 | 17 |   args: [
22115 | 18 |     "--no-sandbox",
22116 | 19 |     "--disable-setuid-sandbox",
22117 | 20 |     "--disable-dev-shm-usage",
22118 | 21 |     "--disable-notifications",
22119 | 22 |     "--lang=en-US,en",
22120 | 23 |   ],
22121 | 24 | });
22122 | 25 | 
22123 | 26 | const page = await browser.newPage();
22124 | 27 | page.setDefaultTimeout(60000);
22125 | 28 | 
22126 | 29 | await page.goto("https://www.facebook.com/login", { waitUntil: "domcontentloaded" });
22127 | 30 | await page.waitForSelector("#email", { timeout: 60000 });
22128 | 31 | await page.type("#email", email, { delay: 30 });
22129 | 32 | await page.type("#pass", pass, { delay: 30 });
22130 | 33 | 
22131 | 34 | await Promise.all([
22132 | 35 |   page.click('button[name="login"]'),
22133 | 36 |   page.waitForNavigation({ waitUntil: "domcontentloaded" }).catch(() => null),
22134 | 37 | ]);
22135 | 38 | 
22136 | 39 | const url = page.url();
22137 | 40 | const title = await page.title().catch(() => "");
22138 | 41 | const bodyText = await page.evaluate(() => document.body?.innerText?.slice(0, 2000) || "");
22139 | 42 | 
22140 | 43 | await page.screenshot({ path: "/tmp/fb-login.png", fullPage: true }).catch(() => null);
22141 | 44 | 
22142 | 45 | console.log("URL:", url);
22143 | 46 | console.log("TITLE:", title);
22144 | 47 | console.log("BODY_SNIPPET:\n", bodyText);
22145 | 48 | 
22146 | 49 | await browser.close();
22147 | 50 | 
22148 | ```
22149 | 
22150 | ---
22151 | 
22152 | ### üìÑ ≈öcie≈ºka: `export_chat_context/01__index.js`
22153 | **Typ:** JavaScript/tekst  
22154 | **Opis:** Plik projektu (kod/konfiguracja).  
22155 | 
22156 | ```js
22157 |  1 | if (process.env.__WATCHER_LOCKED__) {
22158 |  2 |   console.error("WATCHER DUPLICATE START ‚Äî EXIT");
22159 |  3 |   process.exit(1);
22160 |  4 | }
22161 |  5 | process.env.__WATCHER_LOCKED__ = "1";
22162 |  6 | 
22163 |  7 | const __log = console.log;
22164 |  8 | console.log = (...args) => {
22165 |  9 |   const ts = new Date().toISOString().replace("T"," ").replace("Z","");
22166 | 10 |   __log(`[${ts}]`, ...args);
22167 | 11 | };
22168 | 12 | 
22169 | 13 | // src/index.js
22170 | 14 | import "dotenv/config";
22171 | 15 | import fs from "fs";
22172 | 16 | import path from "path";
22173 | 17 | import { startWatcher } from "./watcher.js";
22174 | 18 | import { sendOwnerAlert } from "./telegram.js";
22175 | 19 | 
22176 | 20 | function ensureDir(p) {
22177 | 21 |   try {
22178 | 22 |     fs.mkdirSync(p, { recursive: true });
22179 | 23 |   } catch {}
22180 | 24 | }
22181 | 25 | 
22182 | 26 | // Ustal katalogi serwerowe (≈ºeby nie wali≈Ço w /tmp losowo)
22183 | 27 | const DATA_DIR = process.env.DATA_DIR || path.join(process.cwd(), "data");
22184 | 28 | const TMP_DIR = process.env.TMP_DIR || path.join(process.cwd(), "tmp");
22185 | 29 | ensureDir(DATA_DIR);
22186 | 30 | ensureDir(TMP_DIR);
22187 | 31 | 
22188 | 32 | // czas + logi
22189 | 33 | console.log("[BOOT] NODE_ENV =", process.env.NODE_ENV || "dev");
22190 | 34 | console.log("[BOOT] TZ =", process.env.TZ || "system");
22191 | 35 | console.log("[BOOT] DATA_DIR =", DATA_DIR);
22192 | 36 | console.log("[BOOT] TMP_DIR =", TMP_DIR);
22193 | 37 | console.log("[CFG] HEADLESS_BROWSER =", process.env.HEADLESS_BROWSER);
22194 | 38 | 
22195 | 39 | // helper
22196 | 40 | function safeToString(x) {
22197 | 41 |   try {
22198 | 42 |     if (x instanceof Error) return `${x.message}\n${x.stack || ""}`;
22199 | 43 |     if (typeof x === "string") return x;
22200 | 44 |     return JSON.stringify(x, null, 2);
22201 | 45 |   } catch {
22202 | 46 |     return String(x);
22203 | 47 |   }
22204 | 48 | }
22205 | 49 | 
22206 | 50 | // anti-loop
22207 | 51 | let _inAlert = false;
22208 | 52 | function fireAlert(title, message) {
22209 | 53 |   if (_inAlert) return;
22210 | 54 |   _inAlert = true;
22211 | 55 |   sendOwnerAlert(title, message).catch(() => {}).finally(() => (_inAlert = false));
22212 | 56 | }
22213 | 57 | 
22214 | 58 | // HOOKI na b≈Çƒôdy (muszƒÖ byƒá przed startWatcher)
22215 | 59 | const _origErr = console.error.bind(console);
22216 | 60 | console.error = (...args) => {
22217 | 61 |   _origErr(...args);
22218 | 62 |   fireAlert("console.error", args.map(safeToString).join(" "));
22219 | 63 | };
22220 | 64 | 
22221 | 65 | process.on("unhandledRejection", (reason) => {
22222 | 66 |   _origErr("[unhandledRejection]", reason);
22223 | 67 |   fireAlert("unhandledRejection", safeToString(reason));
22224 | 68 | });
22225 | 69 | 
22226 | 70 | process.on("uncaughtException", (err) => {
22227 | 71 |   _origErr("[uncaughtException]", err);
22228 | 72 |   fireAlert("uncaughtException", safeToString(err));
22229 | 73 | });
22230 | 74 | 
22231 | 75 | // ping ‚Äú≈ºyjƒô‚Äù
22232 | 76 | sendOwnerAlert("ALERTS ONLINE", `FB_Watcher start: ${new Date().toISOString()}`)
22233 | 77 |   .then(() => console.log("[ALERTS] startup ping sent"))
22234 | 78 |   .catch(() => console.log("[ALERTS] startup ping failed (ignored)"));
22235 | 79 | 
22236 | 80 | startWatcher().catch((err) => {
22237 | 81 |   console.error("Fatal error:", err);
22238 | 82 |   process.exit(1);
22239 | 83 | });
22240 | 84 | 
22241 | ```
22242 | 
22243 | ---
22244 | 
22245 | ### üìÑ ≈öcie≈ºka: `export_chat_context/02__watcher.js`
22246 | **Typ:** JavaScript/tekst  
22247 | **Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  
22248 | 
22249 | ```js
22250 |   1 | // src/watcher.js
22251 |   2 | import puppeteer from "puppeteer";
22252 |   3 | import fs from "fs";
22253 |   4 | import path from "path";
22254 |   5 | import {
22255 |   6 |   EXPAND_COMMENTS,
22256 |   7 |   CHECK_INTERVAL_MS,
22257 |   8 |   POSTS_SHEET_URL,
22258 |   9 |   POSTS_REFRESH_MS,
22259 |  10 | } from "./config.js";
22260 |  11 | 
22261 |  12 | import {
22262 |  13 |   prepare,
22263 |  14 |   getCommentCount,
22264 |  15 |   loadAllComments,
22265 |  16 |   extractCommentsData,
22266 |  17 | } from "./fb/comments.js";
22267 |  18 | 
22268 |  19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
22269 |  20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
22270 |  21 | import { sendWebhook, parseFbRelativeTime, filterByAge } from "./webhook.js";
22271 |  22 | import { loadCache, saveCache } from "./db/cache.js";
22272 |  23 | import { sendTelegramLeads } from "./telegram.js";
22273 |  24 | 
22274 |  25 | /**
22275 |  26 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
22276 |  27 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
22277 |  28 |  *
22278 |  29 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
22279 |  30 |  * POSTS_FILE=/opt/fb-watcher/data/posts.json
22280 |  31 |  */
22281 |  32 | const POSTS_FILE =
22282 |  33 |   process.env.POSTS_FILE || path.join(process.cwd(), "data", "posts.json");
22283 |  34 | 
22284 |  35 | /**
22285 |  36 |  * CACHE DYSKOWY:
22286 |  37 |  * {
22287 |  38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
22288 |  39 |  * }
22289 |  40 |  */
22290 |  41 | const commentsCache = loadCache();
22291 |  42 | const lastCounts = new Map(); // url -> lastCount
22292 |  43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
22293 |  44 | 
22294 |  45 | for (const [url, entry] of Object.entries(commentsCache)) {
22295 |  46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
22296 |  47 |   if (Array.isArray(entry?.knownIds))
22297 |  48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
22298 |  49 | }
22299 |  50 | 
22300 |  51 | let currentPosts = [];
22301 |  52 | let lastRefreshAny = 0;
22302 |  53 | 
22303 |  54 | let navErrorCount = 0;
22304 |  55 | const MAX_NAV_ERRORS = 5;
22305 |  56 | 
22306 |  57 | function isNavigationError(err) {
22307 |  58 |   if (!err) return false;
22308 |  59 |   const msg = String(err.message || err).toLowerCase();
22309 |  60 |   return (
22310 |  61 |     msg.includes("safegoto-failed") ||
22311 |  62 |     msg.includes("navigation timeout") ||
22312 |  63 |     msg.includes("net::err_connection_timed_out") ||
22313 |  64 |     msg.includes("net::err_timed_out")
22314 |  65 |   );
22315 |  66 | }
22316 |  67 | 
22317 |  68 | function envBool(name, def = false) {
22318 |  69 |   const raw = String(process.env[name] ?? "").trim().toLowerCase();
22319 |  70 |   if (raw === "") return def;
22320 |  71 |   return ["1", "true", "yes", "y", "tak", "on"].includes(raw);
22321 |  72 | }
22322 |  73 | 
22323 |  74 | // ================== TELEGRAM (FILTER AGE + AGE LOG) ==================
22324 |  75 | async function sendTelegramIfFresh(post, comments, ctx = "normal") {
22325 |  76 |   const list = Array.isArray(comments) ? comments : [];
22326 |  77 |   if (list.length === 0) return;
22327 |  78 | 
22328 |  79 |   const now = Date.now();
22329 |  80 | 
22330 |  81 |   const normalized = list.map((c) => {
22331 |  82 |     const rel = String(c?.fb_time_raw || c?.time || "").trim();
22332 |  83 |     const abs = parseFbRelativeTime(rel);
22333 |  84 |     const iso = abs ? abs.toISOString() : (c?.fb_time_iso || null);
22334 |  85 |     const ageMin = abs ? Math.round(((now - abs.getTime()) / 60000) * 10) / 10 : null;
22335 |  86 | 
22336 |  87 |     return {
22337 |  88 |       ...c,
22338 |  89 |       fb_time_raw: rel || null,
22339 |  90 |       fb_time_iso: iso,
22340 |  91 |       _ageMin: ageMin,
22341 |  92 |     };
22342 |  93 |   });
22343 |  94 | 
22344 |  95 |   // log wieku KA≈ªDEGO komentarza (szybki debug)
22345 |  96 |   for (const c of normalized) {
22346 |  97 |     console.log("[TG][AGE]", {
22347 |  98 |       ctx,
22348 |  99 |       id: c?.id || null,
22349 | 100 |       author: c?.author || c?.name || null,
22350 | 101 |       rel: c?.fb_time_raw || null,
22351 | 102 |       iso: c?.fb_time_iso || null,
22352 | 103 |       ageMin: c?._ageMin,
22353 | 104 |     });
22354 | 105 |   }
22355 | 106 | 
22356 | 107 |   const fresh = filterByAge(normalized);
22357 | 108 | 
22358 | 109 |   console.log("[TG] Filtr wieku komentarzy:", {
22359 | 110 |     ctx,
22360 | 111 |     before: normalized.length,
22361 | 112 |     after: fresh.length,
22362 | 113 |     maxAgeMin: Number(process.env.WEBHOOK_MAX_AGE_MIN || 60),
22363 | 114 |   });
22364 | 115 | 
22365 | 116 |   if (fresh.length > 0) {
22366 | 117 |     await sendTelegramLeads(post, fresh);
22367 | 118 |   } else {
22368 | 119 |     console.log("[TG] Brak ≈õwie≈ºych komentarzy ‚Äì nic nie wysy≈Çam.");
22369 | 120 |   }
22370 | 121 | }
22371 | 122 | // =====================================================================
22372 | 123 | 
22373 | 124 | /* ============================================================
22374 | 125 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
22375 | 126 |    ============================================================ */
22376 | 127 | 
22377 | 128 | async function applyStealth(page) {
22378 | 129 |   await page.evaluateOnNewDocument(() => {
22379 | 130 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
22380 | 131 |     // @ts-ignore
22381 | 132 |     window.chrome = window.chrome || { runtime: {} };
22382 | 133 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
22383 | 134 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
22384 | 135 | 
22385 | 136 |     const permissions = window.navigator.permissions;
22386 | 137 |     if (permissions && permissions.query) {
22387 | 138 |       const originalQuery = permissions.query.bind(permissions);
22388 | 139 |       permissions.query = (parameters) => {
22389 | 140 |         if (
22390 | 141 |           parameters &&
22391 | 142 |           parameters.name === "notifications" &&
22392 | 143 |           window.Notification
22393 | 144 |         ) {
22394 | 145 |           return Promise.resolve({ state: window.Notification.permission });
22395 | 146 |         }
22396 | 147 |         return originalQuery(parameters);
22397 | 148 |       };
22398 | 149 |     }
22399 | 150 |   });
22400 | 151 | }
22401 | 152 | 
22402 | 153 | /* ============================================================
22403 | 154 |    ===============   PANEL POSTS (data/posts.json)   ===========
22404 | 155 |    ============================================================ */
22405 | 156 | 
22406 | 157 | function safeJsonParse(s) {
22407 | 158 |   try {
22408 | 159 |     return { ok: true, value: JSON.parse(s) };
22409 | 160 |   } catch (e) {
22410 | 161 |     return { ok: false, error: e?.message || "Invalid JSON" };
22411 | 162 |   }
22412 | 163 | }
22413 | 164 | 
22414 | 165 | function normalizeUrl(u) {
22415 | 166 | 
22416 | 167 | function makePostKey(url) {
22417 | 168 |   try {
22418 | 169 |     const u = new URL(String(url || "").trim());
22419 | 170 |     for (const k of Array.from(u.searchParams.keys())) {
22420 | 171 |       if (k.startsWith("__") || ["ref","notif_id","notif_t","refid"].includes(k)) {
22421 | 172 |         u.searchParams.delete(k);
22422 | 173 |       }
22423 | 174 |     }
22424 | 175 |     if (u.pathname.includes("permalink.php")) {
22425 | 176 |       const s = u.searchParams.get("story_fbid");
22426 | 177 |       const id = u.searchParams.get("id");
22427 | 178 |       if (s && id) return `permalink:${id}:${s}`;
22428 | 179 |     }
22429 | 180 |     if (u.pathname.includes("story.php")) {
22430 | 181 |       const s = u.searchParams.get("story_fbid");
22431 | 182 |       const id = u.searchParams.get("id");
22432 | 183 |       if (s && id) return `story:${id}:${s}`;
22433 | 184 |     }
22434 | 185 |     const mPosts = u.pathname.match(/\/posts\/([^/?#]+)/i);
22435 | 186 |     if (mPosts?.[1]) return `posts:${mPosts[1]}`;
22436 | 187 |     const v = u.searchParams.get("v");
22437 | 188 |     if (u.pathname.includes("/watch") && v) return `watch:${v}`;
22438 | 189 |     const mVid = u.pathname.match(/\/videos\/([^/?#]+)/i);
22439 | 190 |     if (mVid?.[1]) return `videos:${mVid[1]}`;
22440 | 191 |     const q = u.searchParams.toString();
22441 | 192 |     return `url:${u.host}${u.pathname}${q ? "?" + q : ""}`;
22442 | 193 |   } catch {
22443 | 194 |     return `url:${String(url || "").trim()}`;
22444 | 195 |   }
22445 | 196 | }
22446 | 197 | 
22447 | 198 |   if (!u) return "";
22448 | 199 |   const x = String(u).trim();
22449 | 200 |   if (!/^https?:\/\/.+/i.test(x)) return "";
22450 | 201 |   return x;
22451 | 202 | }
22452 | 203 | 
22453 | 204 | function readPanelPosts() {
22454 | 205 |   try {
22455 | 206 |     if (!fs.existsSync(POSTS_FILE)) {
22456 | 207 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
22457 | 208 |     }
22458 | 209 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
22459 | 210 |     if (!raw) {
22460 | 211 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
22461 | 212 |     }
22462 | 213 | 
22463 | 214 |     const parsed = safeJsonParse(raw);
22464 | 215 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
22465 | 216 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
22466 | 217 |     }
22467 | 218 | 
22468 | 219 |     const posts = parsed.value
22469 | 220 |       .map((p) => {
22470 | 221 |         const url = normalizeUrl(p?.url);
22471 | 222 |         const active = Boolean(p?.active);
22472 | 223 |         if (!url) return null;
22473 | 224 |         return {
22474 | 225 |           id: String(p?.id || url),
22475 | 226 |           url,
22476 | 227 |           active,
22477 | 228 |           name: p?.name ? String(p.name) : "",
22478 | 229 |           image: p?.image ? String(p.image) : "",
22479 | 230 |           description: p?.description ? String(p.description) : "",
22480 | 231 |         };
22481 | 232 |       })
22482 | 233 |       .filter(Boolean);
22483 | 234 | 
22484 | 235 |     const activePosts = posts.filter((p) => p.active);
22485 | 236 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
22486 | 237 |   } catch (e) {
22487 | 238 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
22488 | 239 |   }
22489 | 240 | }
22490 | 241 | 
22491 | 242 | /* ============================================================
22492 | 243 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
22493 | 244 |    ============================================================ */
22494 | 245 | 
22495 | 246 | function parseSheetCsv(text) {
22496 | 247 |   const lines = text
22497 | 248 |     .split(/\r?\n/)
22498 | 249 |     .map((l) => l.trim())
22499 | 250 |     .filter((l) => l.length > 0);
22500 | 251 | 
22501 | 252 |   if (!lines.length) {
22502 | 253 |     console.warn("[Sheet] Pusty CSV z arkusza.");
22503 | 254 |     return [];
22504 | 255 |   }
22505 | 256 | 
22506 | 257 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
22507 | 258 | 
22508 | 259 |   const idxUrl = header.findIndex((h) => h === "url");
22509 | 260 |   const idxActive = header.findIndex((h) => h === "active");
22510 | 261 | 
22511 | 262 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
22512 | 263 |   const idxImage = header.findIndex(
22513 | 264 |     (h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie"
22514 | 265 |   );
22515 | 266 |   const idxDesc = header.findIndex(
22516 | 267 |     (h) => h === "description" || h === "desc" || h === "opis"
22517 | 268 |   );
22518 | 269 | 
22519 | 270 |   if (idxUrl === -1) {
22520 | 271 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
22521 | 272 |     return [];
22522 | 273 |   }
22523 | 274 | 
22524 | 275 |   const posts = [];
22525 | 276 | 
22526 | 277 |   for (let i = 1; i < lines.length; i++) {
22527 | 278 |     const row = lines[i].split(",");
22528 | 279 |     const rawUrl = (row[idxUrl] || "").trim();
22529 | 280 |     if (!rawUrl) continue;
22530 | 281 | 
22531 | 282 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
22532 | 283 |     const activeNorm = activeRaw.toLowerCase();
22533 | 284 |     const isActive =
22534 | 285 |       idxActive === -1
22535 | 286 |         ? true
22536 | 287 |         : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
22537 | 288 | 
22538 | 289 |     if (!isActive) continue;
22539 | 290 | 
22540 | 291 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
22541 | 292 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
22542 | 293 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
22543 | 294 | 
22544 | 295 |     posts.push({
22545 | 296 |       id: `sheet-${i}`,
22546 | 297 |       url: rawUrl,
22547 | 298 |       name,
22548 | 299 |       image,
22549 | 300 |       description,
22550 | 301 |     });
22551 | 302 |   }
22552 | 303 | 
22553 | 304 |   return posts;
22554 | 305 | }
22555 | 306 | 
22556 | 307 | /* ============================================================
22557 | 308 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
22558 | 309 |    ============================================================ */
22559 | 310 | 
22560 | 311 | async function refreshPostsIfNeeded(force = false) {
22561 | 312 |   const now = Date.now();
22562 | 313 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
22563 | 314 |   lastRefreshAny = now;
22564 | 315 | 
22565 | 316 |   // 1) PRIMARY: panel posts.json
22566 | 317 |   const panel = readPanelPosts();
22567 | 318 |   if (panel.ok && panel.posts.length > 0) {
22568 | 319 |     const newPosts = panel.posts;
22569 | 320 | 
22570 | 321 |     const oldJson = JSON.stringify(currentPosts);
22571 | 322 |     const newJson = JSON.stringify(newPosts);
22572 | 323 | 
22573 | 324 |     if (oldJson !== newJson) {
22574 | 325 |       console.log(
22575 | 326 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
22576 | 327 |       );
22577 | 328 |       currentPosts = newPosts;
22578 | 329 |     } else {
22579 | 330 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
22580 | 331 |     }
22581 | 332 |     return;
22582 | 333 |   }
22583 | 334 | 
22584 | 335 |   console.log(
22585 | 336 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
22586 | 337 |   );
22587 | 338 | 
22588 | 339 |   // 2) FALLBACK: Sheets
22589 | 340 |   if (!POSTS_SHEET_URL) {
22590 | 341 |     console.warn("[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza.");
22591 | 342 |     currentPosts = [];
22592 | 343 |     return;
22593 | 344 |   }
22594 | 345 | 
22595 | 346 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
22596 | 347 | 
22597 | 348 |   try {
22598 | 349 |     const res = await fetch(POSTS_SHEET_URL);
22599 | 350 |     if (!res.ok) {
22600 | 351 |       console.error("[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
22601 | 352 |       currentPosts = [];
22602 | 353 |       return;
22603 | 354 |     }
22604 | 355 | 
22605 | 356 |     const csvText = await res.text();
22606 | 357 |     const newPosts = parseSheetCsv(csvText);
22607 | 358 | 
22608 | 359 |     if (!newPosts.length) {
22609 | 360 |       console.warn("[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE).");
22610 | 361 |       currentPosts = [];
22611 | 362 |       return;
22612 | 363 |     }
22613 | 364 | 
22614 | 365 |     const oldJson = JSON.stringify(currentPosts);
22615 | 366 |     const newJson = JSON.stringify(newPosts);
22616 | 367 | 
22617 | 368 |     if (oldJson !== newJson) {
22618 | 369 |       console.log(`[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`);
22619 | 370 |       currentPosts = newPosts;
22620 | 371 |     } else {
22621 | 372 |       console.log("[Sheet] Lista post√≥w bez zmian.");
22622 | 373 |     }
22623 | 374 |   } catch (err) {
22624 | 375 |     console.error("[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:", err.message);
22625 | 376 |     currentPosts = [];
22626 | 377 |   }
22627 | 378 | }
22628 | 379 | 
22629 | 380 | /* ============================================================
22630 | 381 |    =====================   CACHE HELPERS   =====================
22631 | 382 |    ============================================================ */
22632 | 383 | 
22633 | 384 | function getCacheKey(post) {
22634 | 385 |   return post.url;
22635 | 386 | }
22636 | 387 | 
22637 | 388 | function getKnownSetForPost(cacheKey) {
22638 | 389 |   let set = knownCommentsPerPost.get(cacheKey);
22639 | 390 |   if (!set) {
22640 | 391 |     const entry = commentsCache[cacheKey];
22641 | 392 |     set =
22642 | 393 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
22643 | 394 |     knownCommentsPerPost.set(cacheKey, set);
22644 | 395 |   }
22645 | 396 |   return set;
22646 | 397 | }
22647 | 398 | 
22648 | 399 | function flushCacheToDisk() {
22649 | 400 |   const out = { ...commentsCache };
22650 | 401 | 
22651 | 402 |   for (const [cacheKey, count] of lastCounts.entries()) {
22652 | 403 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
22653 | 404 |     out[cacheKey].lastCount = count;
22654 | 405 |   }
22655 | 406 | 
22656 | 407 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
22657 | 408 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
22658 | 409 |     out[cacheKey].knownIds = Array.from(set);
22659 | 410 |   }
22660 | 411 | 
22661 | 412 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
22662 | 413 |   Object.assign(commentsCache, out);
22663 | 414 |   saveCache(out);
22664 | 415 | }
22665 | 416 | 
22666 | 417 | /* ============================================================
22667 | 418 |    =====================   G≈Å√ìWNY WATCHER   ===================
22668 | 419 |    ============================================================ */
22669 | 420 | 
22670 | 421 | const isDev = process.env.NODE_ENV !== "production";
22671 | 422 | 
22672 | 423 | function getExecutablePath() {
22673 | 424 |   const p =
22674 | 425 |     process.env.PUPPETEER_EXECUTABLE_PATH ||
22675 | 426 |     process.env.CHROME_PATH ||
22676 | 427 |     process.env.CHROMIUM_PATH ||
22677 | 428 |     "";
22678 | 429 |   return String(p || "").trim() || undefined;
22679 | 430 | }
22680 | 431 | 
22681 | 432 | async function startWatcher() {
22682 | 433 |   console.log(
22683 | 434 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
22684 | 435 |     Math.round(CHECK_INTERVAL_MS / 1000),
22685 | 436 |     "sekund."
22686 | 437 |   );
22687 | 438 | 
22688 | 439 |   const loop = async () => {
22689 | 440 |     let browser = null;
22690 | 441 |     let page = null;
22691 | 442 |     let hadNavErrorThisRound = false;
22692 | 443 | 
22693 | 444 |     try {
22694 | 445 |       console.log("[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ====");
22695 | 446 | 
22696 | 447 |       const wantHeadless = envBool("HEADLESS_BROWSER", true);
22697 | 448 |       const headlessMode = wantHeadless ? (isDev ? true : "new") : false;
22698 | 449 | 
22699 | 450 |       const linux = process.platform === "linux";
22700 | 451 |       const executablePath = getExecutablePath();
22701 | 452 | 
22702 | 453 |       const args = [
22703 | 454 |         "--disable-notifications",
22704 | 455 |         "--disable-blink-features=AutomationControlled",
22705 | 456 |       ];
22706 | 457 | 
22707 | 458 |       if (linux) {
22708 | 459 |         args.push("--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage");
22709 | 460 |       }
22710 | 461 | 
22711 | 462 |       browser = await puppeteer.launch({
22712 | 463 |         headless: headlessMode,
22713 | 464 |         defaultViewport: null,
22714 | 465 |         executablePath,
22715 | 466 |         args,
22716 | 467 |         ignoreDefaultArgs: ["--enable-automation"],
22717 | 468 |       });
22718 | 469 | 
22719 | 470 |       page = await browser.newPage();
22720 | 471 |       await applyStealth(page);
22721 | 472 | 
22722 | 473 |       page.setDefaultNavigationTimeout(90000);
22723 | 474 |       page.setDefaultTimeout(90000);
22724 | 475 | 
22725 | 476 |       await page.setViewport({ width: 1280, height: 720 });
22726 | 477 | 
22727 | 478 |       // cookies + login
22728 | 479 |       await loadCookies(page);
22729 | 480 |       await page.goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 }).catch(() => {});
22730 | 481 | 
22731 | 482 |       let loggedIn = await checkIfLogged(page);
22732 | 483 |       if (!loggedIn) {
22733 | 484 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
22734 | 485 |         await fbLogin(page);
22735 | 486 |         loggedIn = await checkIfLogged(page);
22736 | 487 | 
22737 | 488 |         if (loggedIn) {
22738 | 489 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
22739 | 490 |           await saveCookies(page);
22740 | 491 |         } else {
22741 | 492 |           console.error("[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone).");
22742 | 493 |         }
22743 | 494 |       } else {
22744 | 495 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
22745 | 496 |       }
22746 | 497 | 
22747 | 498 |       // posts
22748 | 499 |       await refreshPostsIfNeeded(true);
22749 | 500 | 
22750 | 501 |       if (!currentPosts.length) {
22751 | 502 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
22752 | 503 |       } else {
22753 | 504 |         for (const post of currentPosts) {
22754 | 505 |           const cacheKey = getCacheKey(post);
22755 | 506 | 
22756 | 507 |           try {
22757 | 508 |             await prepare(page, post.url);
22758 | 509 | 
22759 | 510 |             const count = await getCommentCount(page, post.url);
22760 | 511 |             const hasCount = typeof count === "number" && Number.isFinite(count);
22761 | 512 | 
22762 | 513 |             if (!hasCount) {
22763 | 514 |               console.log(`[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`);
22764 | 515 |             }
22765 | 516 | 
22766 | 517 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
22767 | 518 |             const knownSet = getKnownSetForPost(cacheKey);
22768 | 519 | 
22769 | 520 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
22770 | 521 |             if (prev === null) {
22771 | 522 |               const initialCount = hasCount ? count : 0;
22772 | 523 |               lastCounts.set(cacheKey, initialCount);
22773 | 524 | 
22774 | 525 |               console.log(
22775 | 526 |                 hasCount
22776 | 527 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
22777 | 528 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
22778 | 529 |               );
22779 | 530 | 
22780 | 531 |               if (EXPAND_COMMENTS) {
22781 | 532 |                 await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }, post.url).catch(() => {});
22782 | 533 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
22783 | 534 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
22784 | 535 |                 console.log(`[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`);
22785 | 536 |               } else {
22786 | 537 |                 console.log(`[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`);
22787 | 538 |               }
22788 | 539 | 
22789 | 540 |               continue;
22790 | 541 |             }
22791 | 542 | 
22792 | 543 |             if (hasCount) {
22793 | 544 |               if (count !== prev) {
22794 | 545 |                 console.log(`[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`);
22795 | 546 |                 lastCounts.set(cacheKey, count);
22796 | 547 |               } else {
22797 | 548 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
22798 | 549 |               }
22799 | 550 |             } else {
22800 | 551 |               console.log(`[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`);
22801 | 552 |             }
22802 | 553 | 
22803 | 554 |             if (!EXPAND_COMMENTS) continue;
22804 | 555 | 
22805 | 556 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(() => {});
22806 | 557 |             const snapshot = await extractCommentsData(page, post.url).catch(() => []);
22807 | 558 | 
22808 | 559 |             const newComments = [];
22809 | 560 |             for (const c of snapshot) {
22810 | 561 |               if (!c?.id) continue;
22811 | 562 |               if (!knownSet.has(c.id)) {
22812 | 563 |                 knownSet.add(c.id);
22813 | 564 |                 newComments.push(c);
22814 | 565 |       c.__postId = post.id;
22815 | 566 |       c.__postUrl = post.url;
22816 | 567 |               }
22817 | 568 |             }
22818 | 569 | 
22819 | 570 |             
22820 | 571 |             // ===== DEBUG: sanity-check skƒÖd sƒÖ komentarze =====
22821 | 572 |             console.log("[DBG][POST_CTX]", {
22822 | 573 |               postId: post?.id || null,
22823 | 574 |               postUrl: post?.url || null,
22824 | 575 |               snapshotLen: Array.isArray(snapshot) ? snapshot.length : null,
22825 | 576 |               newLen: Array.isArray(newComments) ? newComments.length : null,
22826 | 577 |               sample: (Array.isArray(newComments) ? newComments.slice(0, 3) : []).map((c) => ({
22827 | 578 |                 id: c?.id || null,
22828 | 579 |                 author: c?.author || c?.name || null,
22829 | 580 |                 time: c?.fb_time_raw || c?.time || null,
22830 | 581 |                 // poni≈ºsze pola mogƒÖ istnieƒá albo nie ‚Äî ale jak istniejƒÖ, to nam powiedzƒÖ prawdƒô:
22831 | 582 |                 link: c?.link || c?.permalink || c?.url || null,
22832 | 583 |                 postRef: c?.postUrl || c?.post_url || c?.post || null,
22833 | 584 |               })),
22834 | 585 |             });
22835 | 586 |             // ================================================
22836 | 587 | if (hasCount && newComments.length === 0 && count > prev) {
22837 | 588 |               const diff = Math.max(1, count - prev);
22838 | 589 |               const tail = snapshot.slice(-diff);
22839 | 590 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
22840 | 591 | 
22841 | 592 |               console.log(`[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`);
22842 | 593 |               await sendWebhook(post, tail, count, prev);
22843 | 594 | 
22844 | 595 |               await sendTelegramIfFresh(post, tail, "fallback");
22845 | 596 | 
22846 | 597 |               continue;
22847 | 598 |             }
22848 | 599 | 
22849 | 600 |             if (newComments.length > 0) {
22850 | 601 |               console.log(`[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`);
22851 | 602 |               await sendWebhook(post, newComments, hasCount ? count : null, hasCount ? prev : null);
22852 | 603 | 
22853 | 604 | 
22854 | 605 | 
22855 | 606 | 
22856 | 607 |     const safeComments = newComments.filter(c => c.__postId === post.id);
22857 | 608 |     if (safeComments.length !== newComments.length) {
22858 | 609 |       console.warn("[WATCHER][GUARD] Odfiltrowano komentarze spoza posta", {
22859 | 610 |         postId: post.id,
22860 | 611 |         before: newComments.length,
22861 | 612 |         after: safeComments.length
22862 | 613 |       });
22863 | 614 |     }
22864 | 615 |                 await sendTelegramIfFresh(post, safeComments, "normal");
22865 | 616 |             }
22866 | 617 |           } catch (err) {
22867 | 618 |             console.error(`[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`, err?.message || err);
22868 | 619 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
22869 | 620 | 
22870 | 621 |             if (isNavigationError(err)) {
22871 | 622 |               hadNavErrorThisRound = true;
22872 | 623 |               navErrorCount++;
22873 | 624 |               console.log(`[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`);
22874 | 625 |             }
22875 | 626 |           }
22876 | 627 |         }
22877 | 628 |       }
22878 | 629 |     } catch (err) {
22879 | 630 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
22880 | 631 |     } finally {
22881 | 632 |       flushCacheToDisk();
22882 | 633 | 
22883 | 634 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
22884 | 635 |         console.log(`[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`);
22885 | 636 |         navErrorCount = 0;
22886 | 637 |       }
22887 | 638 | 
22888 | 639 |       if (browser) {
22889 | 640 |         try {
22890 | 641 |           await browser.close();
22891 | 642 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
22892 | 643 |         } catch (e) {
22893 | 644 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
22894 | 645 |         }
22895 | 646 |       }
22896 | 647 | 
22897 | 648 |       if (navErrorCount >= MAX_NAV_ERRORS) {
22898 | 649 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
22899 | 650 |         process.exit(1);
22900 | 651 |       }
22901 | 652 | 
22902 | 653 |       const jitter = Math.floor(Math.random() * 5000);
22903 | 654 |       const delay = CHECK_INTERVAL_MS + jitter;
22904 | 655 |       console.log(`[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`);
22905 | 656 |       setTimeout(loop, delay);
22906 | 657 |     }
22907 | 658 |   };
22908 | 659 | 
22909 | 660 |   loop();
22910 | 661 | }
22911 | 662 | 
22912 | 663 | export { startWatcher };
22913 | 664 | 
22914 | ```
22915 | 
22916 | ---
22917 | 
22918 | ### üìÑ ≈öcie≈ºka: `export_chat_context/04__telegram.js`
22919 | **Typ:** JavaScript/tekst  
22920 | **Opis:** Plik projektu (kod/konfiguracja).  
22921 | 
22922 | ```js
22923 |   1 | // src/telegram.js
22924 |   2 | import axios from "axios";
22925 |   3 | 
22926 |   4 | /* ============================================================
22927 |   5 |    FILTR WIEKU KOMENTARZA (TELEGRAM)
22928 |   6 |    ============================================================ */
22929 |   7 | 
22930 |   8 | function parseFbRelativeTime(raw) {
22931 |   9 |   if (!raw) return null;
22932 |  10 |   const t = String(raw).toLowerCase().trim();
22933 |  11 |   const now = new Date();
22934 |  12 | 
22935 |  13 |   if (t.includes("przed chwilƒÖ")) return now;
22936 |  14 |   if (t.includes("w≈Ça≈õnie teraz") || t === "teraz" || t === "now" || t === "just now") return now;
22937 |  15 | 
22938 |  16 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
22939 |  17 |     const d = new Date(now);
22940 |  18 |     d.setDate(d.getDate() - 1);
22941 |  19 |     return d;
22942 |  20 |   }
22943 |  21 | 
22944 |  22 |   // Obs≈Çugujemy polskie i angielskie skr√≥ty
22945 |  23 |   // np: 15 sek., 5 min, 2 godz., 1 dzie≈Ñ, 4 tyg., 4 weeks
22946 |  24 |   const m = t.match(/(\d+)\s*(sek\.?|s|sec|secs|second|seconds|min\.?|m|minut|minuty|minutƒô|godz\.?|h|hr|hour|hours|dni|dzie≈Ñ|d|tyg\.?|week|weeks)\b/);
22947 |  25 |   if (!m) return null;
22948 |  26 | 
22949 |  27 |   const value = parseInt(m[1], 10);
22950 |  28 |   if (!Number.isFinite(value)) return null;
22951 |  29 | 
22952 |  30 |   const unit = m[2];
22953 |  31 |   const d = new Date(now);
22954 |  32 | 
22955 |  33 |   if (unit.startsWith("sek") || unit === "s" || unit.startsWith("sec") || unit.startsWith("second")) d.setSeconds(d.getSeconds() - value);
22956 |  34 |   else if (unit.startsWith("min") || unit === "m") d.setMinutes(d.getMinutes() - value);
22957 |  35 |   else if (unit.startsWith("godz") || unit === "h" || unit === "hr" || unit.startsWith("hour")) d.setHours(d.getHours() - value);
22958 |  36 |   else if (unit.startsWith("dni") || unit.startsWith("dzie") || unit === "d") d.setDate(d.getDate() - value);
22959 |  37 |   else if (unit.startsWith("tyg") || unit.startsWith("week")) d.setDate(d.getDate() - 7 * value);
22960 |  38 | 
22961 |  39 |   return d;
22962 |  40 | }
22963 |  41 | 
22964 |  42 | function shouldSendByAge(comment) {
22965 |  43 |   // ENV:
22966 |  44 |   // TELEGRAM_MAX_AGE_MIN=60
22967 |  45 |   // TELEGRAM_DROP_IF_NO_TIME=1  (domy≈õlnie: 1)
22968 |  46 |   const maxAgeMin = Number(process.env.TELEGRAM_MAX_AGE_MIN || process.env.WEBHOOK_MAX_AGE_MIN || 60);
22969 |  47 |   const dropIfNoTime = envBool("TELEGRAM_DROP_IF_NO_TIME", true);
22970 |  48 | 
22971 |  49 |   const rel = String(comment?.fb_time_raw || comment?.time || comment?.relative_time || "").trim();
22972 |  50 |   if (!rel) return !dropIfNoTime;
22973 |  51 | 
22974 |  52 |   const abs = parseFbRelativeTime(rel);
22975 |  53 |   if (!abs) return !dropIfNoTime;
22976 |  54 | 
22977 |  55 |   const ageMinutes = (Date.now() - abs.getTime()) / 60000;
22978 |  56 |   return ageMinutes <= maxAgeMin;
22979 |  57 | }
22980 |  58 | 
22981 |  59 | function envBool(name, def = false) {
22982 |  60 |   const v = String(process.env[name] ?? "").trim().toLowerCase();
22983 |  61 |   if (!v) return def;
22984 |  62 |   return ["1", "true", "yes", "tak", "y", "on"].includes(v);
22985 |  63 | }
22986 |  64 | 
22987 |  65 | function escapeHtml(s) {
22988 |  66 |   if (s == null) return "";
22989 |  67 |   return String(s)
22990 |  68 |     .replaceAll("&", "&amp;")
22991 |  69 |     .replaceAll("<", "&lt;")
22992 |  70 |     .replaceAll(">", "&gt;")
22993 |  71 |     .replaceAll('"', "&quot;");
22994 |  72 | }
22995 |  73 | 
22996 |  74 | function buildCaptionHtml(post, c) {
22997 |  75 |   const postName = escapeHtml(post?.name || "");
22998 |  76 |   const postDesc = escapeHtml(post?.description || "");
22999 |  77 |   const author = escapeHtml(c?.author || c?.name || "");
23000 |  78 |   const text = escapeHtml(c?.text || c?.message || "");
23001 |  79 |   const rel = escapeHtml(c?.fb_time_raw || c?.time || c?.relative_time || "");
23002 |  80 |   const url = String(post?.url || "").trim();
23003 |  81 | 
23004 |  82 |   const postLine = postDesc ? `${postName} ‚Äî ${postDesc}` : postName;
23005 |  83 | 
23006 |  84 |   return (
23007 |  85 |     `<b>üì© Nowy komentarz na Facebooku</b>\n\n` +
23008 |  86 |     `<b>üë§ Autor:</b>\n${author || "-"}\n\n` +
23009 |  87 |     `<b>üïí Czas:</b>\n${rel || "-"}\n\n` +
23010 |  88 |     `<b>üìù Tre≈õƒá:</b>\n${text || "-"}\n\n` +
23011 |  89 |     `<b>üìå Post:</b>\n${postLine || "-"}\n\n` +
23012 |  90 |     (url ? `<a href="${escapeHtml(url)}">üëâ Otw√≥rz post</a>` : "")
23013 |  91 |   );
23014 |  92 | }
23015 |  93 | 
23016 |  94 | async function tgRequest(token, method, payload) {
23017 |  95 |   const t = String(token || "").trim();
23018 |  96 |   if (!t) return { ok: false, error: "Brak tokena bota" };
23019 |  97 | 
23020 |  98 |   const endpoint = `https://api.telegram.org/bot${t}/${method}`;
23021 |  99 | 
23022 | 100 |   try {
23023 | 101 |     const res = await axios.post(endpoint, payload, { timeout: 15000 });
23024 | 102 |     if (res?.data?.ok) return { ok: true, data: res.data };
23025 | 103 |     return { ok: false, error: res?.data?.description || "Telegram error" };
23026 | 104 |   } catch (e) {
23027 | 105 |     return {
23028 | 106 |       ok: false,
23029 | 107 |       error: e?.response?.data?.description || e?.message || String(e),
23030 | 108 |     };
23031 | 109 |   }
23032 | 110 | }
23033 | 111 | 
23034 | 112 | async function sendMessage(token, chat_id, text, opts = {}) {
23035 | 113 |   const parse_mode = opts.parse_mode || "HTML";
23036 | 114 |   const disable_web_page_preview = !!opts.disable_web_page_preview;
23037 | 115 | 
23038 | 116 |   return tgRequest(token, "sendMessage", {
23039 | 117 |     chat_id,
23040 | 118 |     text,
23041 | 119 |     parse_mode,
23042 | 120 |     disable_web_page_preview,
23043 | 121 |   });
23044 | 122 | }
23045 | 123 | 
23046 | 124 | async function sendPhoto(token, chat_id, photo, caption, opts = {}) {
23047 | 125 |   const parse_mode = opts.parse_mode || "HTML";
23048 | 126 |   return tgRequest(token, "sendPhoto", {
23049 | 127 |     chat_id,
23050 | 128 |     photo,
23051 | 129 |     caption,
23052 | 130 |     parse_mode,
23053 | 131 |   });
23054 | 132 | }
23055 | 133 | 
23056 | 134 | function getTargets() {
23057 | 135 |   const sendOwner = envBool("TELEGRAM_SEND_TO_OWNER", true);
23058 | 136 |   const sendClient = envBool("TELEGRAM_SEND_TO_CLIENT", true);
23059 | 137 | 
23060 | 138 |   const ownerToken = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
23061 | 139 |   const ownerChat = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
23062 | 140 | 
23063 | 141 |   const clientToken = String(process.env.TELEGRAM_BOT_TOKEN_CLIENT || "").trim();
23064 | 142 |   const clientChat = String(process.env.TELEGRAM_CHAT_ID_CLIENT || "").trim();
23065 | 143 | 
23066 | 144 |   const targets = [];
23067 | 145 |   console.log("[TG][TARGETS]", {
23068 | 146 |     sendOwner,
23069 | 147 |     sendClient,
23070 | 148 |     ownerToken: ownerToken ? ownerToken.slice(0, 12) + "..." : null,
23071 | 149 |     ownerChat: ownerChat || null,
23072 | 150 |     clientToken: clientToken ? clientToken.slice(0, 12) + "..." : null,
23073 | 151 |     clientChat: clientChat || null,
23074 | 152 |   });
23075 | 153 | 
23076 | 154 | 
23077 | 155 |   if (sendOwner && ownerToken && ownerChat) {
23078 | 156 |     targets.push({ label: "OWNER", token: ownerToken, chat_id: ownerChat });
23079 | 157 |   } else if (sendOwner) {
23080 | 158 |     console.warn(
23081 | 159 |       "[TG] OWNER w≈ÇƒÖczony, ale brakuje TELEGRAM_BOT_TOKEN_OWNER lub TELEGRAM_CHAT_ID_OWNER."
23082 | 160 |     );
23083 | 161 |   }
23084 | 162 | 
23085 | 163 |   if (sendClient && clientToken && clientChat) {
23086 | 164 |     targets.push({ label: "CLIENT", token: clientToken, chat_id: clientChat });
23087 | 165 |   } else if (sendClient) {
23088 | 166 |     console.warn(
23089 | 167 |       "[TG] CLIENT w≈ÇƒÖczony, ale brakuje TELEGRAM_BOT_TOKEN_CLIENT lub TELEGRAM_CHAT_ID_CLIENT."
23090 | 168 |     );
23091 | 169 |   }
23092 | 170 | 
23093 | 171 |   return targets;
23094 | 172 | }
23095 | 173 | 
23096 | 174 | /**
23097 | 175 |  * 1 komentarz => wysy≈Çka na 2 Telegramy:
23098 | 176 |  * - Tw√≥j (Twoim botem)
23099 | 177 |  * - Klienta (botem klienta)
23100 | 178 |  */
23101 | 179 | async function sendTelegramLead(post, comment) {
23102 | 180 |   const targets = getTargets();
23103 | 181 |   if (!targets.length) return;
23104 | 182 | 
23105 | 183 |   const usePhoto = envBool("TELEGRAM_USE_PHOTO", true);
23106 | 184 |   const disablePreview = envBool("TELEGRAM_DISABLE_WEB_PAGE_PREVIEW", true);
23107 | 185 | 
23108 | 186 |   const caption = buildCaptionHtml(post, comment);
23109 | 187 |   const img = String(post?.image || "").trim();
23110 | 188 | 
23111 | 189 |   for (const t of targets) {
23112 | 190 |     if (usePhoto && img) {
23113 | 191 |       const r1 = await sendPhoto(t.token, t.chat_id, img, caption, {
23114 | 192 |         parse_mode: "HTML",
23115 | 193 |       });
23116 | 194 |       if (r1.ok) {
23117 | 195 |         console.log(`[TG] Wys≈Çano lead (photo) -> ${t.label}`);
23118 | 196 |         await new Promise((r) => setTimeout(r, 350));
23119 | 197 |         continue;
23120 | 198 |       }
23121 | 199 |       console.warn(
23122 | 200 |         `[TG] sendPhoto nie przesz≈Ço (${t.label}) -> fallback do sendMessage:`,
23123 | 201 |         r1.error
23124 | 202 |       );
23125 | 203 |     }
23126 | 204 | 
23127 | 205 |     const r2 = await sendMessage(t.token, t.chat_id, caption, {
23128 | 206 |       parse_mode: "HTML",
23129 | 207 |       disable_web_page_preview: disablePreview,
23130 | 208 |     });
23131 | 209 | 
23132 | 210 |     if (r2.ok) console.log(`[TG] Wys≈Çano lead (message) -> ${t.label}`);
23133 | 211 |     else console.error(`[TG] sendMessage error (${t.label}):`, r2.error);
23134 | 212 | 
23135 | 213 |     await new Promise((r) => setTimeout(r, 350));
23136 | 214 |   }
23137 | 215 | }
23138 | 216 | 
23139 | 217 | async function sendTelegramLeads(post, comments = []) {
23140 | 218 |   for (const c of comments) {
23141 | 219 |     await sendTelegramLead(post, c);
23142 | 220 |     await new Promise((r) => setTimeout(r, 250));
23143 | 221 |   }
23144 | 222 | }
23145 | 223 | 
23146 | 224 | /* ============================================================
23147 | 225 |    =======================  ALERTY OWNER  ======================
23148 | 226 |    ============================================================ */
23149 | 227 | 
23150 | 228 | let _lastAlertAt = 0;
23151 | 229 | let _lastAlertKey = "";
23152 | 230 | let _repeatCount = 0;
23153 | 231 | 
23154 | 232 | function shorten(s, max) {
23155 | 233 |   const x = String(s ?? "");
23156 | 234 |   if (x.length <= max) return x;
23157 | 235 |   return x.slice(0, max - 12) + "\n‚Ä¶(obciƒôto)‚Ä¶";
23158 | 236 | }
23159 | 237 | 
23160 | 238 | function makeAlertKey(title, msg) {
23161 | 239 |   const a = String(title || "").slice(0, 80);
23162 | 240 |   const b = String(msg || "").slice(0, 200);
23163 | 241 |   return `${a}::${b}`;
23164 | 242 | }
23165 | 243 | 
23166 | 244 | async function sendOwnerAlert(title, message, opts = {}) {
23167 | 245 |   if (!envBool("TG_ALERTS_ENABLED", true)) return;
23168 | 246 | 
23169 | 247 |   const token = String(process.env.TELEGRAM_BOT_TOKEN_OWNER || "").trim();
23170 | 248 |   const chatId = String(process.env.TELEGRAM_CHAT_ID_OWNER || "").trim();
23171 | 249 |   if (!token || !chatId) return;
23172 | 250 | 
23173 | 251 |   const cooldownSec = Number(process.env.TG_ALERTS_COOLDOWN_SEC || "120");
23174 | 252 |   const maxLen = Number(process.env.TG_ALERTS_MAXLEN || "3500");
23175 | 253 |   const tz = String(process.env.TG_ALERTS_TIMEZONE || "Europe/Warsaw").trim();
23176 | 254 | 
23177 | 255 |   const now = Date.now();
23178 | 256 |   const key = makeAlertKey(title, message);
23179 | 257 | 
23180 | 258 |   // Anti-spam: je≈õli to samo w k√≥≈Çko w cooldownie, nie spamuj ‚Äî tylko licz
23181 | 259 |   if (key === _lastAlertKey && now - _lastAlertAt < cooldownSec * 1000) {
23182 | 260 |     _repeatCount++;
23183 | 261 |     return;
23184 | 262 |   }
23185 | 263 | 
23186 | 264 |   // Je≈õli wcze≈õniej co≈õ siƒô powtarza≈Ço, do≈õlij podsumowanie
23187 | 265 |   if (_repeatCount > 0) {
23188 | 266 |     const summary = `<b>‚ö†Ô∏è PowtarzajƒÖce siƒô b≈Çƒôdy</b>\n\nPoprzedni alert powt√≥rzy≈Ç siƒô <b>${_repeatCount}</b> razy w kr√≥tkim czasie.`;
23189 | 267 |     await sendMessage(token, chatId, summary, { parse_mode: "HTML" }).catch(
23190 | 268 |       () => {}
23191 | 269 |     );
23192 | 270 |     _repeatCount = 0;
23193 | 271 |   }
23194 | 272 | 
23195 | 273 |   _lastAlertAt = now;
23196 | 274 |   _lastAlertKey = key;
23197 | 275 | 
23198 | 276 |   // Lokalny czas PL (nie UTC)
23199 | 277 |   const dt = new Date();
23200 | 278 |   const tsLocal = new Intl.DateTimeFormat("pl-PL", {
23201 | 279 |     timeZone: tz,
23202 | 280 |     year: "numeric",
23203 | 281 |     month: "2-digit",
23204 | 282 |     day: "2-digit",
23205 | 283 |     hour: "2-digit",
23206 | 284 |     minute: "2-digit",
23207 | 285 |     second: "2-digit",
23208 | 286 |   }).format(dt);
23209 | 287 | 
23210 | 288 |   // Dla pewno≈õci dopisujemy te≈º UTC (kr√≥tkie), ≈ºeby ≈Çatwiej by≈Ço debugowaƒá serwer
23211 | 289 |   const tsUtc = dt.toISOString().replace("T", " ").replace("Z", " UTC");
23212 | 290 | 
23213 | 291 |   const text =
23214 | 292 |     `<b>üö® FB_Watcher ‚Äì ALERT</b>\n` +
23215 | 293 |     `<b>üïí</b> ${escapeHtml(tsLocal)} (${escapeHtml(tz)})\n` +
23216 | 294 |     `<b>üåç</b> ${escapeHtml(tsUtc)}\n\n` +
23217 | 295 |     `<b>${escapeHtml(title || "B≈ÇƒÖd")}</b>\n\n` +
23218 | 296 |     `<pre>${escapeHtml(shorten(message, maxLen))}</pre>`;
23219 | 297 | 
23220 | 298 |   const r = await sendMessage(token, chatId, text, {
23221 | 299 |     parse_mode: "HTML",
23222 | 300 |     disable_web_page_preview: true,
23223 | 301 |   });
23224 | 302 | 
23225 | 303 |   if (!r.ok) {
23226 | 304 |     // nie r√≥b pƒôtli error->alert->error
23227 | 305 |     console.log("[TG ALERT] Nie uda≈Ço siƒô wys≈Çaƒá alertu:", r.error);
23228 | 306 |   }
23229 | 307 | }
23230 | 308 | 
23231 | 309 | 
23232 | 310 | export { sendTelegramLead, sendTelegramLeads, sendOwnerAlert };
23233 | 311 | 
23234 | ```
23235 | 
23236 | ---
23237 | 
23238 | ### üìÑ ≈öcie≈ºka: `export_chat_context/05__webhook.js`
23239 | **Typ:** JavaScript/tekst  
23240 | **Opis:** Plik projektu (kod/konfiguracja).  
23241 | 
23242 | ```js
23243 |   1 | // src/webhook.js
23244 |   2 | import axios from "axios";
23245 |   3 | import { POST_LABELS } from "./config.js";
23246 |   4 | 
23247 |   5 | /* ============================================================
23248 |   6 |    PARSER CZASU FB ‚Üí ISO
23249 |   7 |    ============================================================ */
23250 |   8 | 
23251 |   9 | function parseFbRelativeTime(raw) {
23252 |  10 |   if (!raw) return null;
23253 |  11 | 
23254 |  12 |   const t = raw.toLowerCase().trim();
23255 |  13 |   const now = new Date();
23256 |  14 | 
23257 |  15 |   if (t.includes("przed chwilƒÖ")) return now;
23258 |  16 | 
23259 |  17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
23260 |  18 |     const d = new Date(now);
23261 |  19 |     d.setDate(d.getDate() - 1);
23262 |  20 |     return d;
23263 |  21 |   }
23264 |  22 | 
23265 |  23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
23266 |  24 |   if (!m) return null;
23267 |  25 | 
23268 |  26 |   const value = parseInt(m[1], 10);
23269 |  27 |   if (!Number.isFinite(value)) return null;
23270 |  28 | 
23271 |  29 |   const unit = m[2];
23272 |  30 |   const d = new Date(now);
23273 |  31 | 
23274 |  32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
23275 |  33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
23276 |  34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
23277 |  35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
23278 |  36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
23279 |  37 | 
23280 |  38 |   return d;
23281 |  39 | }
23282 |  40 | 
23283 |  41 | /* ============================================================
23284 |  42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
23285 |  43 |    ============================================================ */
23286 |  44 | 
23287 |  45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
23288 |  46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
23289 |  47 | 
23290 |  48 | function filterByAge(comments) {
23291 |  49 |   const now = Date.now();
23292 |  50 | 
23293 |  51 |   return comments.filter((c) => {
23294 |  52 |     const rel = (c?.fb_time_raw || c?.time || "").trim();
23295 |  53 |     if (!rel) return false;
23296 |  54 | 
23297 |  55 |     const abs = parseFbRelativeTime(rel);
23298 |  56 |     if (!abs) return false;
23299 |  57 | 
23300 |  58 |     const ageMinutes = (now - abs.getTime()) / 60000;
23301 |  59 |       console.log("[Webhook][AGE]", { 
23302 |  60 |         raw: rel, 
23303 |  61 |         iso: abs.toISOString(), 
23304 |  62 |         ageMin: Math.round(ageMinutes * 100) / 100, 
23305 |  63 |         maxAgeMin: MAX_AGE_MIN 
23306 |  64 |       });
23307 |  65 |     return ageMinutes <= MAX_AGE_MIN;
23308 |  66 |   });
23309 |  67 | }
23310 |  68 | 
23311 |  69 | /* ============================================================
23312 |  70 |    BUILD EVENT PAYLOAD (1 komentarz = 1 obiekt)
23313 |  71 |    ============================================================ */
23314 |  72 | 
23315 |  73 | function buildEventPayload(post, c) {
23316 |  74 |   // meta posta (panel/sheets/env fallback)
23317 |  75 |   const postName =
23318 |  76 |     (post?.name && String(post.name).trim()) ||
23319 |  77 |     POST_LABELS[post?.id] ||
23320 |  78 |     post?.id ||
23321 |  79 |     "post";
23322 |  80 | 
23323 |  81 |   const postImage = (post?.image && String(post.image).trim()) || null;
23324 |  82 |   const postDescription = (post?.description && String(post.description).trim()) || null;
23325 |  83 | 
23326 |  84 |   const rel = (c?.fb_time_raw || c?.time || "").trim() || null;
23327 |  85 |   const createdAt = c?.fb_time_iso || null;
23328 |  86 | 
23329 |  87 |   return {
23330 |  88 |     event: "new_comment",
23331 |  89 | 
23332 |  90 |     post: {
23333 |  91 |       id: post?.id || null,
23334 |  92 |       name: postName,
23335 |  93 |       description: postDescription,
23336 |  94 |       image: postImage,
23337 |  95 |       url: post?.url || null,
23338 |  96 |     },
23339 |  97 | 
23340 |  98 |     comment: {
23341 |  99 |       id: c?.id || null,
23342 | 100 |       author: c?.author || c?.name || null,
23343 | 101 |       text: c?.text || c?.message || null,
23344 | 102 |       created_at: createdAt,
23345 | 103 |       relative_time: rel,
23346 | 104 |     },
23347 | 105 | 
23348 | 106 |     meta: {
23349 | 107 |       source: "facebook",
23350 | 108 |       detected_at: new Date().toISOString(),
23351 | 109 |     },
23352 | 110 |   };
23353 | 111 | }
23354 | 112 | 
23355 | 113 | /* ============================================================
23356 | 114 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
23357 | 115 |    ============================================================ */
23358 | 116 | 
23359 | 117 | async function sendWebhook(post, newComments, newCount, oldCount) {
23360 | 118 |   const url = process.env.WEBHOOK_URL;
23361 | 119 |   if (!url) {
23362 | 120 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
23363 | 121 |     return;
23364 | 122 |   }
23365 | 123 | 
23366 | 124 |   const list = Array.isArray(newComments) ? newComments : [];
23367 | 125 |   if (list.length === 0) return;
23368 | 126 | 
23369 | 127 |   /* --------------------------------------------
23370 | 128 |        1) Normalizacja czasu i dodanie p√≥l ISO
23371 | 129 |      -------------------------------------------- */
23372 | 130 | 
23373 | 131 |   const normalized = list.map((c) => {
23374 | 132 |     const rel = (c?.time || "").trim();
23375 | 133 |     const iso = parseFbRelativeTime(rel);
23376 | 134 |     return {
23377 | 135 |       ...c,
23378 | 136 |       fb_time_raw: rel || null,
23379 | 137 |       fb_time_iso: iso ? iso.toISOString() : null,
23380 | 138 |     };
23381 | 139 |   });
23382 | 140 | 
23383 | 141 |   /* --------------------------------------------
23384 | 142 |        2) Filtrowanie komentarzy po wieku
23385 | 143 |      -------------------------------------------- */
23386 | 144 | 
23387 | 145 |   const freshOnly = filterByAge(normalized);
23388 | 146 | 
23389 | 147 |   console.log("[Webhook] Filtr wieku komentarzy:", {
23390 | 148 |     before: normalized.length,
23391 | 149 |     after: freshOnly.length,
23392 | 150 |     maxAgeMin: MAX_AGE_MIN,
23393 | 151 |   });
23394 | 152 | 
23395 | 153 |   if (freshOnly.length === 0) {
23396 | 154 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
23397 | 155 |     return;
23398 | 156 |   }
23399 | 157 | 
23400 | 158 |   /* --------------------------------------------
23401 | 159 |        3) Wysy≈Çka: 1 komentarz = 1 event
23402 | 160 |      -------------------------------------------- */
23403 | 161 | 
23404 | 162 |   for (const c of freshOnly) {
23405 | 163 |     const payload = buildEventPayload(post, c);
23406 | 164 | 
23407 | 165 |     // pomocniczo: zachowujemy te≈º liczniki w logach (nie w payload)
23408 | 166 |     console.log("[Webhook] Send event:", {
23409 | 167 |       postId: payload.post.id,
23410 | 168 |       commentId: payload.comment.id,
23411 | 169 |       author: payload.comment.author,
23412 | 170 |       counts: { newCount, oldCount },
23413 | 171 |     });
23414 | 172 | 
23415 | 173 |     try {
23416 | 174 |       await axios.post(url, payload, { timeout: 10000 });
23417 | 175 |       console.log("[Webhook] Wys≈Çano event new_comment.");
23418 | 176 |     } catch (err) {
23419 | 177 |       console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err?.message || err);
23420 | 178 |     }
23421 | 179 |   }
23422 | 180 | }
23423 | 181 | 
23424 | 182 | export { sendWebhook, parseFbRelativeTime, filterByAge };
23425 | 183 | 
23426 | ```
23427 | 
23428 | ---
23429 | 
23430 | ### üìÑ ≈öcie≈ºka: `export_chat_context/06__comments.js`
23431 | **Typ:** JavaScript/tekst  
23432 | **Opis:** Plik projektu (kod/konfiguracja).  
23433 | 
23434 | ```js
23435 |   1 | // src/fb/comments.js
23436 |   2 | import { EXPAND_COMMENTS } from "../config.js";
23437 |   3 | import { sleepRandom } from "../utils/sleep.js";
23438 |   4 | import { scrollPost } from "./scroll.js";
23439 |   5 | import { acceptCookies, saveCookies } from "./cookies.js";
23440 |   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
23441 |   7 | import { clickOneExpandButton } from "./expandButtons.js";
23442 |   8 | import { safeGoto } from "../utils/navigation.js";
23443 |   9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
23444 |  10 | 
23445 |  11 | import * as uiPhoto from "./ui/photo.js";
23446 |  12 | import * as uiPost from "./ui/post.js";
23447 |  13 | import * as uiVideos from "./ui/videos.js";
23448 |  14 | import * as uiWatch from "./ui/watch.js";
23449 |  15 | 
23450 |  16 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
23451 |  17 |   ? Number(process.env.NAV_TIMEOUT_MS)
23452 |  18 |   : 90000;
23453 |  19 | 
23454 |  20 | /* ============================================================
23455 |  21 |    ===================== UI ROUTER ============================
23456 |  22 |    ============================================================ */
23457 |  23 | 
23458 |  24 | function pickUiHandler(url) {
23459 |  25 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
23460 |  26 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
23461 |  27 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
23462 |  28 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
23463 |  29 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
23464 |  30 |   return null;
23465 |  31 | }
23466 |  32 | 
23467 |  33 | 
23468 |  34 | /* ============================================================
23469 |  35 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
23470 |  36 |    ============================================================ */
23471 |  37 | 
23472 |  38 | async function openCommentsMenu(page) {
23473 |  39 |   const r = await page.evaluate(() => {
23474 |  40 |     const norm = (s) =>
23475 |  41 |       String(s || "")
23476 |  42 |         .replace(/\u00a0/g, " ")
23477 |  43 |         .replace(/\s+/g, " ")
23478 |  44 |         .trim()
23479 |  45 |         .toLowerCase();
23480 |  46 | 
23481 |  47 |     function getLabel(el) {
23482 |  48 |       return el.getAttribute?.("aria-label") || el.textContent || "";
23483 |  49 |     }
23484 |  50 | 
23485 |  51 |     if (document.querySelector("div[role='menu']"))
23486 |  52 |       return { ok: true, state: "menu-already-open" };
23487 |  53 | 
23488 |  54 |     const els = Array.from(
23489 |  55 |       document.querySelectorAll(
23490 |  56 |         "button,div[role='button'],span[role='button'],a[role='button']"
23491 |  57 |       )
23492 |  58 |     );
23493 |  59 | 
23494 |  60 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
23495 |  61 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
23496 |  62 |     const btn = els.find((el) => {
23497 |  63 |       const t = norm(getLabel(el));
23498 |  64 |       return (
23499 |  65 |         t === "najtrafniejsze" ||
23500 |  66 |         t === "most relevant" ||
23501 |  67 |         t === "wszystkie komentarze" ||
23502 |  68 |         t === "all comments" ||
23503 |  69 |         t === "najnowsze" ||
23504 |  70 |         t === "newest" ||
23505 |  71 |         t === "poka≈º wszystkie" ||
23506 |  72 |         t === "show all" ||
23507 |  73 |         t === "wy≈õwietl wszystkie" ||
23508 |  74 |         t === "view all"
23509 |  75 |       );
23510 |  76 |     });
23511 |  77 | 
23512 |  78 |     if (!btn) return { ok: false, reason: "no-trigger" };
23513 |  79 | 
23514 |  80 |     try {
23515 |  81 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
23516 |  82 |     } catch {}
23517 |  83 | 
23518 |  84 |     try {
23519 |  85 |       btn.click();
23520 |  86 |       return { ok: true, state: "clicked-trigger" };
23521 |  87 |     } catch {
23522 |  88 |       return { ok: false, reason: "click-failed" };
23523 |  89 |     }
23524 |  90 |   });
23525 |  91 | 
23526 |  92 |   return r?.ok === true;
23527 |  93 | }
23528 |  94 | 
23529 |  95 | async function clickMenuOptionByPrefix(page, prefixes) {
23530 |  96 |   return page.evaluate(
23531 |  97 |     (prefixes) => {
23532 |  98 |       const norm = (s) =>
23533 |  99 |         String(s || "")
23534 | 100 |           .replace(/\u00a0/g, " ")
23535 | 101 |           .replace(/\s+/g, " ")
23536 | 102 |           .trim()
23537 | 103 |           .toLowerCase();
23538 | 104 | 
23539 | 105 |       const menu =
23540 | 106 |         document.querySelector("div[role='menu']") ||
23541 | 107 |         document.querySelector("div[role='dialog']");
23542 | 108 |       if (!menu) return { ok: false, reason: "no-menu" };
23543 | 109 | 
23544 | 110 |       const items = Array.from(
23545 | 111 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
23546 | 112 |       );
23547 | 113 | 
23548 | 114 |       const opt = items.find((el) => {
23549 | 115 |         const t = norm(el.textContent);
23550 | 116 |         return prefixes.some((p) => t.startsWith(p));
23551 | 117 |       });
23552 | 118 | 
23553 | 119 |       if (!opt) return { ok: false, reason: "no-opt" };
23554 | 120 | 
23555 | 121 |       try {
23556 | 122 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
23557 | 123 |       } catch {}
23558 | 124 | 
23559 | 125 |       try {
23560 | 126 |         opt.click();
23561 | 127 |         return { ok: true };
23562 | 128 |       } catch {
23563 | 129 |         return { ok: false, reason: "click-failed" };
23564 | 130 |       }
23565 | 131 |     },
23566 | 132 |     prefixes
23567 | 133 |   );
23568 | 134 | }
23569 | 135 | 
23570 | 136 | async function switchCommentsFilterToAllLegacy(page) {
23571 | 137 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy na: 'Wszystkie komentarze'‚Ä¶");
23572 | 138 | 
23573 | 139 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
23574 | 140 |     const opened = await openCommentsMenu(page);
23575 | 141 |     if (opened) await sleepRandom(250, 450);
23576 | 142 |   }
23577 | 143 | 
23578 | 144 |   const picked = await clickMenuOptionByPrefix(page, [
23579 | 145 |     "wszystkie komentarze",
23580 | 146 |     "all comments",
23581 | 147 |     "poka≈º wszystkie",
23582 | 148 |     "show all",
23583 | 149 |     "wy≈õwietl wszystkie",
23584 | 150 |     "view all",
23585 | 151 |   ]);
23586 | 152 | 
23587 | 153 |   if (picked?.ok) {
23588 | 154 |     await sleepRandom(250, 450);
23589 | 155 |     await page
23590 | 156 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
23591 | 157 |         timeout: 2500,
23592 | 158 |       })
23593 | 159 |       .catch(() => {});
23594 | 160 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
23595 | 161 |     return true;
23596 | 162 |   }
23597 | 163 | 
23598 | 164 |   console.log("[FB][filter] Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze' (best-effort).");
23599 | 165 |   return false;
23600 | 166 | }
23601 | 167 | 
23602 | 168 | /* ============================================================
23603 | 169 |    ===================  EXPAND (LEGACY)  =======================
23604 | 170 |    ============================================================ */
23605 | 171 | 
23606 | 172 | export async function expandAllComments(page) {
23607 | 173 |   if (!EXPAND_COMMENTS) return 0;
23608 | 174 | 
23609 | 175 |   let clicks = 0;
23610 | 176 |   for (let i = 0; i < 30; i++) {
23611 | 177 |     const didClick = await clickOneExpandButton(page);
23612 | 178 |     if (!didClick) break;
23613 | 179 |     clicks++;
23614 | 180 |     await sleepRandom(450, 900);
23615 | 181 |   }
23616 | 182 |   return clicks;
23617 | 183 | }
23618 | 184 | 
23619 | 185 | /* ============================================================
23620 | 186 |    ===================  LICZNIK KOMENTARZY  ====================
23621 | 187 |    ============================================================ */
23622 | 188 | 
23623 | 189 | async function getCommentCountLegacy(page) {
23624 | 190 |   const ui = await getUiCommentInfo(page).catch(() => null);
23625 | 191 | 
23626 | 192 |   const uiCandidates = [
23627 | 193 |     ui?.comments,
23628 | 194 |     ui?.count,
23629 | 195 |     ui?.commentCount,
23630 | 196 |     ui?.commentsCount,
23631 | 197 |     ui?.totalComments,
23632 | 198 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
23633 | 199 | 
23634 | 200 |   if (uiCandidates.length) {
23635 | 201 |     const best = Math.max(...uiCandidates);
23636 | 202 |     console.log("[FB][count] UI:", {
23637 | 203 |       best,
23638 | 204 |       candidates: uiCandidates,
23639 | 205 |       source: ui?.source || "ui",
23640 | 206 |       raw: ui?.raw || null,
23641 | 207 |       viewType: ui?.viewType || null,
23642 | 208 |     });
23643 | 209 |     return best;
23644 | 210 |   }
23645 | 211 | 
23646 | 212 |   const uiLoose = await page
23647 | 213 |     .evaluate(() => {
23648 | 214 |       const texts = [];
23649 | 215 |       const pushText = (t) => {
23650 | 216 |         if (!t) return;
23651 | 217 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
23652 | 218 |         if (s) texts.push(s);
23653 | 219 |       };
23654 | 220 | 
23655 | 221 |       const els = Array.from(
23656 | 222 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
23657 | 223 |       );
23658 | 224 |       for (const el of els) {
23659 | 225 |         pushText(el.getAttribute?.("aria-label"));
23660 | 226 |         pushText(el.textContent);
23661 | 227 |       }
23662 | 228 | 
23663 | 229 |       const nums = [];
23664 | 230 |       for (const t of texts) {
23665 | 231 |         const low = t.toLowerCase();
23666 | 232 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
23667 | 233 |         if (m) nums.push(Number(m[1]));
23668 | 234 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
23669 | 235 |         if (m) nums.push(Number(m[1]));
23670 | 236 |       }
23671 | 237 | 
23672 | 238 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
23673 | 239 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
23674 | 240 |     })
23675 | 241 |     .catch(() => ({ count: null, sample: [] }));
23676 | 242 | 
23677 | 243 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
23678 | 244 |     console.log("[FB][count] UI-loose:", uiLoose.count);
23679 | 245 |     return uiLoose.count;
23680 | 246 |   }
23681 | 247 | 
23682 | 248 |   if (ui) {
23683 | 249 |     console.log("[FB][count] UI object (no number):", { keys: Object.keys(ui), ui });
23684 | 250 |   } else {
23685 | 251 |     console.log("[FB][count] UI object: null (getUiCommentInfo failed or returned null)");
23686 | 252 |   }
23687 | 253 | 
23688 | 254 |   const anchors = await page.evaluate(() => {
23689 | 255 |     const as = Array.from(
23690 | 256 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
23691 | 257 |     );
23692 | 258 |     const ids = new Set();
23693 | 259 |     for (const a of as) {
23694 | 260 |       try {
23695 | 261 |         const u = new URL(a.href);
23696 | 262 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
23697 | 263 |         if (raw) ids.add(raw);
23698 | 264 |       } catch {}
23699 | 265 |     }
23700 | 266 |     return ids.size;
23701 | 267 |   });
23702 | 268 | 
23703 | 269 |   if (anchors > 0) console.log("[FB][count] anchors-fallback:", anchors);
23704 | 270 |   return anchors > 0 ? anchors : null;
23705 | 271 | }
23706 | 272 | 
23707 | 273 | /* ============================================================
23708 | 274 |    ===================  EKSTRAKCJA KOMENTARZY  =================
23709 | 275 |    ============================================================ */
23710 | 276 | 
23711 | 277 | async function extractCommentsFromDOM(page) {
23712 | 278 |   const data = await page.evaluate(() => {
23713 | 279 |     function extractCommentIdRaw(url) {
23714 | 280 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
23715 | 281 |       return m ? decodeURIComponent(m[1]) : null;
23716 | 282 |     }
23717 | 283 | 
23718 | 284 |     function safeAtob(input) {
23719 | 285 |       try {
23720 | 286 |         let s = String(input || "");
23721 | 287 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
23722 | 288 |         while (s.length % 4) s += "=";
23723 | 289 |         return atob(s);
23724 | 290 |       } catch {
23725 | 291 |         return null;
23726 | 292 |       }
23727 | 293 |     }
23728 | 294 | 
23729 | 295 |     function idNumFromRaw(idRaw) {
23730 | 296 |       if (!idRaw) return null;
23731 | 297 |       const s = String(idRaw).trim();
23732 | 298 |       if (/^\d+$/.test(s)) return s;
23733 | 299 | 
23734 | 300 |       const dec = safeAtob(s);
23735 | 301 |       if (dec) {
23736 | 302 |         const m = String(dec).match(/(\d{6,})\s*$/);
23737 | 303 |         if (m) return m[1];
23738 | 304 |       }
23739 | 305 |       const m2 = s.match(/_(\d+)\b/);
23740 | 306 |       return m2 ? m2[1] : null;
23741 | 307 |     }
23742 | 308 | 
23743 | 309 |     function normalizeTime(text) {
23744 | 310 |       if (!text) return null;
23745 | 311 | 
23746 | 312 |       const t = String(text)
23747 | 313 |         .toLowerCase()
23748 | 314 |         .replace(/\u00a0/g, " ")
23749 | 315 |         .replace(/\s+/g, " ")
23750 | 316 |         .trim();
23751 | 317 | 
23752 | 318 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
23753 | 319 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
23754 | 320 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
23755 | 321 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
23756 | 322 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
23757 | 323 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
23758 | 324 | 
23759 | 325 |       return null;
23760 | 326 |     }
23761 | 327 | 
23762 | 328 |     function findTimeAround(linkEl, fallbackNode) {
23763 | 329 |       const root =
23764 | 330 |         linkEl?.closest?.("div[role='article']") ||
23765 | 331 |         linkEl?.closest?.("div[aria-label]") ||
23766 | 332 |         linkEl?.closest?.("div") ||
23767 | 333 |         fallbackNode;
23768 | 334 | 
23769 | 335 |       if (!root) return null;
23770 | 336 | 
23771 | 337 |       const els = root.querySelectorAll("a, abbr, span");
23772 | 338 |       for (const el of els) {
23773 | 339 |         const aria = el.getAttribute?.("aria-label");
23774 | 340 |         const t1 = normalizeTime(aria);
23775 | 341 |         if (t1) return t1;
23776 | 342 | 
23777 | 343 |         const txt = el.textContent?.trim();
23778 | 344 |         const t2 = normalizeTime(txt);
23779 | 345 |         if (t2) return t2;
23780 | 346 |       }
23781 | 347 |       return null;
23782 | 348 |     }
23783 | 349 | 
23784 | 350 |     const nodes = Array.from(
23785 | 351 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
23786 | 352 |     );
23787 | 353 | 
23788 | 354 |     const extracted = nodes
23789 | 355 |         .map((node, idx) => {
23790 | 356 |           const author = node.querySelector("a[role=\"link\"] span span")?.textContent?.trim() || null;
23791 | 357 |           const text = node.querySelector("div[dir=\"auto\"]")?.textContent?.trim() || null;
23792 | 358 | 
23793 | 359 |           const linkEl = node.querySelector("a[href*=\"reply_comment_id\"]") ||
23794 | 360 |                          node.querySelector("a[href*=\"comment_id\"]") ||
23795 | 361 |                          node.querySelector("a[role=\"link\"]");
23796 | 362 | 
23797 | 363 |           const href = linkEl?.getAttribute("href") || null;
23798 | 364 |           const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com`) : null;
23799 | 365 | 
23800 | 366 |           const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
23801 | 367 |           const id = id_raw ? String(id_raw).trim() : null;
23802 | 368 |           const id_num = id_raw ? idNumFromRaw(id_raw) : null;
23803 | 369 |           const time = findTimeAround(linkEl, node);
23804 | 370 | 
23805 | 371 |           if (!author || !text || !id) return null;
23806 | 372 | 
23807 | 373 |           return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
23808 | 374 |         })
23809 | 375 |         .filter(Boolean);
23810 | 376 | 
23811 | 377 |     return extracted;
23812 | 378 |   });
23813 | 379 | 
23814 | 380 |   return Array.isArray(data) ? data : [];
23815 | 381 | }
23816 | 382 | 
23817 | 383 | /* ============================================================
23818 | 384 |    ===================  PREPARE / LOAD (LEGACY)  ===============
23819 | 385 |    ============================================================ */
23820 | 386 | 
23821 | 387 | async function prepareLegacy(page, url) {
23822 | 388 |   const ok = await safeGoto(page, url, "comments", {
23823 | 389 |     waitUntil: "networkidle2",
23824 | 390 |     timeout: NAV_TIMEOUT_MS,
23825 | 391 |   });
23826 | 392 | 
23827 | 393 |   if (!ok) throw new Error("safeGoto-failed");
23828 | 394 | 
23829 | 395 |   const currentUrl = page.url();
23830 | 396 |   if (currentUrl.includes("/login")) {
23831 | 397 |     console.log("[FB] /login redirect ‚Üí fbLogin() and back");
23832 | 398 |     await fbLogin(page);
23833 | 399 |     await sleepRandom(3000, 4500);
23834 | 400 | 
23835 | 401 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
23836 | 402 |     console.log("[FB] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
23837 | 403 | 
23838 | 404 |     if (loggedAfterLogin) {
23839 | 405 |       await safeGoto(page, url, "comments", {
23840 | 406 |         waitUntil: "networkidle2",
23841 | 407 |         timeout: NAV_TIMEOUT_MS,
23842 | 408 |       });
23843 | 409 |     }
23844 | 410 |   }
23845 | 411 | 
23846 | 412 |   await acceptCookies(page, "post-initial");
23847 | 413 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
23848 | 414 |   await sleepRandom(900, 1400);
23849 | 415 |   await acceptCookies(page, "post");
23850 | 416 | 
23851 | 417 |   try {
23852 | 418 |     const logged = await checkIfLogged(page).catch(() => false);
23853 | 419 |     if (logged) await saveCookies(page);
23854 | 420 |   } catch {}
23855 | 421 | 
23856 | 422 |   await scrollPost(page, 140).catch(() => {});
23857 | 423 |   await sleepRandom(500, 800);
23858 | 424 | 
23859 | 425 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
23860 | 426 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
23861 | 427 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
23862 | 428 |   await sleepRandom(250, 450);
23863 | 429 | }
23864 | 430 | 
23865 | 431 | async function loadAllCommentsLegacy(page, opts = {}) {
23866 | 432 |   if (!EXPAND_COMMENTS) return;
23867 | 433 | 
23868 | 434 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
23869 | 435 | 
23870 | 436 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
23871 | 437 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
23872 | 438 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
23873 | 439 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
23874 | 440 | 
23875 | 441 |   console.log("[FB][load] start", { expected });
23876 | 442 | 
23877 | 443 |   function uniqAnchorCountEval() {
23878 | 444 |     return page.evaluate(() => {
23879 | 445 |       const as = Array.from(
23880 | 446 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
23881 | 447 |       );
23882 | 448 |       const ids = new Set();
23883 | 449 |       for (const a of as) {
23884 | 450 |         const href = a.getAttribute("href") || "";
23885 | 451 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
23886 | 452 |         if (m && m[1]) ids.add(m[1]);
23887 | 453 |       }
23888 | 454 |       return ids.size;
23889 | 455 |     });
23890 | 456 |   }
23891 | 457 | 
23892 | 458 |   function commentNodesCountEval() {
23893 | 459 |     return page.evaluate(() => {
23894 | 460 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
23895 | 461 |       return nodes ? nodes.length : 0;
23896 | 462 |     });
23897 | 463 |   }
23898 | 464 | 
23899 | 465 |   function hasMoreButtonsEval() {
23900 | 466 |     return page.evaluate(() => {
23901 | 467 |       const norm = (s) =>
23902 | 468 |         String(s || "")
23903 | 469 |           .replace(/\u00a0/g, " ")
23904 | 470 |           .replace(/\s+/g, " ")
23905 | 471 |           .trim()
23906 | 472 |           .toLowerCase();
23907 | 473 | 
23908 | 474 |       const btns = Array.from(
23909 | 475 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
23910 | 476 |       );
23911 | 477 |       return btns.some((b) => {
23912 | 478 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
23913 | 479 |         return (
23914 | 480 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
23915 | 481 |           t.includes("zobacz wiƒôcej komentarzy") ||
23916 | 482 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
23917 | 483 |           t.includes("more comments") ||
23918 | 484 |           t.includes("view more comments") ||
23919 | 485 |           t.includes("view previous comments") ||
23920 | 486 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
23921 | 487 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
23922 | 488 |           t.includes("more replies") ||
23923 | 489 |           t.includes("view more replies")
23924 | 490 |         );
23925 | 491 |       });
23926 | 492 |     });
23927 | 493 |   }
23928 | 494 | 
23929 | 495 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
23930 | 496 |   let nodes = await commentNodesCountEval().catch(() => 0);
23931 | 497 | 
23932 | 498 |   let stable = 0;
23933 | 499 |   let noProgress = 0;
23934 | 500 | 
23935 | 501 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
23936 | 502 |     let clicks = 0;
23937 | 503 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
23938 | 504 |       const did = await clickOneExpandButton(page).catch(() => false);
23939 | 505 |       if (!did) break;
23940 | 506 |       clicks++;
23941 | 507 |       await sleepRandom(250, 450);
23942 | 508 |     }
23943 | 509 | 
23944 | 510 |     await scrollPost(page, 220).catch(() => {});
23945 | 511 |     await sleepRandom(400, 700);
23946 | 512 | 
23947 | 513 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
23948 | 514 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
23949 | 515 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
23950 | 516 | 
23951 | 517 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
23952 | 518 | 
23953 | 519 |     if (progressed) {
23954 | 520 |       anchors = nextAnchors;
23955 | 521 |       nodes = nextNodes;
23956 | 522 |       stable = 0;
23957 | 523 |       noProgress = 0;
23958 | 524 |     } else {
23959 | 525 |       stable++;
23960 | 526 |       noProgress++;
23961 | 527 |     }
23962 | 528 | 
23963 | 529 |     console.log(
23964 | 530 |       `[FB][load] round ${round}: anchors ${anchors} -> ${nextAnchors}, nodes ${nodes} -> ${nextNodes}, clicks=${clicks}, stable=${stable}/${STABLE_ROUNDS}, moreBtns=${moreBtns}, noProgress=${noProgress}/${MAX_NO_PROGRESS}`
23965 | 531 |     );
23966 | 532 | 
23967 | 533 |     const stableEnough = stable >= STABLE_ROUNDS;
23968 | 534 | 
23969 | 535 |     if (!moreBtns && stableEnough) {
23970 | 536 |       console.log("[FB][load] stop: no more buttons + stable");
23971 | 537 |       break;
23972 | 538 |     }
23973 | 539 | 
23974 | 540 |     const reachedExpected =
23975 | 541 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
23976 | 542 |     if (reachedExpected && stableEnough && !moreBtns) {
23977 | 543 |       console.log("[FB][load] stop: expected reached (by nodes) + stable + no more buttons");
23978 | 544 |       break;
23979 | 545 |     }
23980 | 546 | 
23981 | 547 |     if (stableEnough && moreBtns) {
23982 | 548 |       console.log("[FB][load] rescue: stable but still buttons -> deep scroll + wait");
23983 | 549 |       await scrollPost(page, 520).catch(() => {});
23984 | 550 |       await sleepRandom(1000, 1600);
23985 | 551 |       stable = 0;
23986 | 552 |       continue;
23987 | 553 |     }
23988 | 554 | 
23989 | 555 |     if (noProgress >= MAX_NO_PROGRESS) {
23990 | 556 |       if (moreBtns) {
23991 | 557 |         console.log("[FB][load] last-rescue: no-progress but still buttons -> deep scroll + wait");
23992 | 558 |         await scrollPost(page, 650).catch(() => {});
23993 | 559 |         await sleepRandom(1400, 1900);
23994 | 560 |         stable = 0;
23995 | 561 |         noProgress = 0;
23996 | 562 |         continue;
23997 | 563 |       }
23998 | 564 | 
23999 | 565 |       console.log("[FB][load] stop: too many no-progress rounds");
24000 | 566 |       break;
24001 | 567 |     }
24002 | 568 | 
24003 | 569 |     anchors = nextAnchors;
24004 | 570 |     nodes = nextNodes;
24005 | 571 |   }
24006 | 572 | 
24007 | 573 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
24008 | 574 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
24009 | 575 |   console.log("[FB][load] done:", { anchors: finalAnchors, nodes: finalNodes });
24010 | 576 | }
24011 | 577 | 
24012 | 578 | /* ============================================================
24013 | 579 |    ===================  PUBLIC API (ROUTED)  ===================
24014 | 580 |    ============================================================ */
24015 | 581 | 
24016 | 582 | export async function prepare(page, url) {
24017 | 583 |   const ui = pickUiHandler(url);
24018 | 584 |   if (ui?.prepare) {
24019 | 585 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} prepare`);
24020 | 586 |     return ui.prepare(page, url);
24021 | 587 |   }
24022 | 588 |   console.log("[FB][router] UI -> legacy prepare");
24023 | 589 |   return prepareLegacy(page, url);
24024 | 590 | }
24025 | 591 | 
24026 | 592 | export async function getCommentCount(page, url) {
24027 | 593 |   const ui = pickUiHandler(url || page.url());
24028 | 594 |   if (ui?.getCommentCount) {
24029 | 595 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} getCommentCount`);
24030 | 596 |     return ui.getCommentCount(page, url);
24031 | 597 |   }
24032 | 598 |   console.log("[FB][router] UI -> legacy getCommentCount");
24033 | 599 |   return getCommentCountLegacy(page);
24034 | 600 | }
24035 | 601 | 
24036 | 602 | export async function loadAllComments(page, opts = {}, url = null) {
24037 | 603 |   if (!EXPAND_COMMENTS) return;
24038 | 604 | 
24039 | 605 |   const finalUrl = url || page.url();
24040 | 606 |   const ui = pickUiHandler(finalUrl);
24041 | 607 | 
24042 | 608 |   if (ui?.loadAllComments) {
24043 | 609 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} loadAllComments`);
24044 | 610 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal });
24045 | 611 |   }
24046 | 612 | 
24047 | 613 |   console.log("[FB][router] UI -> legacy loadAllComments");
24048 | 614 |   return loadAllCommentsLegacy(page, opts);
24049 | 615 | }
24050 | 616 | 
24051 | 617 | export async function extractCommentsData(page, url = null) {
24052 | 618 |   const finalUrl = url || page.url();
24053 | 619 |   const ui = pickUiHandler(finalUrl);
24054 | 620 | 
24055 | 621 |   const getPostRef = (u) => {
24056 | 622 |     if (!u) return null;
24057 | 623 |     try {
24058 | 624 |       const x = new URL(u);
24059 | 625 | 
24060 | 626 |       // permalink.php?story_fbid=...
24061 | 627 |       const story = x.searchParams.get("story_fbid");
24062 | 628 |       if (story) return `story_fbid:${story}`;
24063 | 629 | 
24064 | 630 |       // /.../posts/<id>  |  /.../videos/<id>  |  /.../photos/<id>
24065 | 631 |       const parts = x.pathname.split("/").filter(Boolean);
24066 | 632 |       for (let i = 0; i < parts.length - 1; i++) {
24067 | 633 |         const k = parts[i];
24068 | 634 |         if (k === "posts" || k === "videos" || k === "photos" || k === "reels") {
24069 | 635 |           const v = parts[i + 1];
24070 | 636 |           if (v) return `${k}:${v}`;
24071 | 637 |         }
24072 | 638 |       }
24073 | 639 | 
24074 | 640 |       // fallback: brak stabilnego identyfikatora posta -> null (nie dedupujemy po ref)
24075 | 641 |         return null;
24076 | 642 |     } catch (e) {
24077 | 643 |       return null;
24078 | 644 |     }
24079 | 645 |   };
24080 | 646 | 
24081 | 647 |   const postRef = getPostRef(finalUrl);
24082 | 648 | 
24083 | 649 |   const filterByRef = (arr) => {
24084 | 650 |     if (!Array.isArray(arr)) return [];
24085 | 651 |     if (!postRef) return arr;
24086 | 652 | 
24087 | 653 |     let dropped = 0;
24088 | 654 |       const out = [];
24089 | 655 |       let sampleLogged = 0;
24090 | 656 | 
24091 | 657 |       // kontekst: do czego porownujemy
24092 | 658 |       console.log(`[DEDUP][CTX] want= finalUrl=`);
24093 | 659 | 
24094 | 660 |       for (const c of arr) {
24095 | 661 |         const permalink = (c && typeof c === "object") ? (c.permalink || null) : null;
24096 | 662 |         const cref = permalink ? getPostRef(permalink) : null;
24097 | 663 | 
24098 | 664 |         // pokaz 3 pierwsze permalink->cref
24099 | 665 |         if (sampleLogged < 3 && permalink) {
24100 | 666 |           console.log(`[DEDUP][SAMPLE] permalink= cref=`);
24101 | 667 |           sampleLogged += 1;
24102 | 668 |         }
24103 | 669 | 
24104 | 670 |         if (cref && cref !== postRef) {
24105 | 671 |           dropped += 1;
24106 | 672 |           continue;
24107 | 673 |         }
24108 | 674 |         if (c && typeof c === "object") c.postRef = postRef;
24109 | 675 |         out.push(c);
24110 | 676 |       }
24111 | 677 | 
24112 | 678 |       if (dropped > 0) {
24113 | 679 |         console.log(`[DEDUP] dropped= (ref mismatch) postRef=`);
24114 | 680 |       }
24115 | 681 | 
24116 | 682 |       if (arr.length > 0 && out.length === 0 && dropped === arr.length) {
24117 | 683 |         out._dedupAllDropped = true;
24118 | 684 |         console.log(`[DEDUP][ALL_DROPPED] all= want=`);
24119 | 685 |       }
24120 | 686 | 
24121 | 687 |       return out;
24122 | 688 |   };
24123 | 689 | 
24124 | 690 |   if (ui?.extractComments) {
24125 | 691 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} extractComments`);
24126 | 692 |     const out = await ui.extractComments(page, finalUrl);
24127 | 693 |     return filterByRef(out);
24128 | 694 |   }
24129 | 695 | 
24130 | 696 |   const out = await extractCommentsFromDOM(page);
24131 | 697 |   return filterByRef(out);
24132 | 698 | }
24133 | 699 | 
24134 | ```
24135 | 
24136 | ---
24137 | 
24138 | ### üìÑ ≈öcie≈ºka: `export_chat_context/07__scroll.js`
24139 | **Typ:** JavaScript/tekst  
24140 | **Opis:** Plik projektu (kod/konfiguracja).  
24141 | 
24142 | ```js
24143 |  1 | /**
24144 |  2 |  * Scrollowanie posta:
24145 |  3 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
24146 |  4 |  * - je≈õli siƒô nie uda ‚Üí dialog ‚Üí dokument
24147 |  5 |  */
24148 |  6 | async function scrollPost(page, amount = 450) {
24149 |  7 |   await page.evaluate((dy) => {
24150 |  8 |     function findScrollableAncestor(start) {
24151 |  9 |       let el = start;
24152 | 10 |       while (el) {
24153 | 11 |         const style = window.getComputedStyle(el);
24154 | 12 |         const canScrollY =
24155 | 13 |           style.overflowY === "auto" || style.overflowY === "scroll";
24156 | 14 |         if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
24157 | 15 |           return el;
24158 | 16 |         }
24159 | 17 |         el = el.parentElement;
24160 | 18 |       }
24161 | 19 |       return null;
24162 | 20 |     }
24163 | 21 | 
24164 | 22 |     // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
24165 | 23 |     const centerEl = document.elementFromPoint(
24166 | 24 |       window.innerWidth / 2,
24167 | 25 |       window.innerHeight / 2
24168 | 26 |     );
24169 | 27 | 
24170 | 28 |     let target = centerEl ? findScrollableAncestor(centerEl) : null;
24171 | 29 | 
24172 | 30 |     // fallback: dialog
24173 | 31 |     if (!target) {
24174 | 32 |       const dialog = document.querySelector("div[role='dialog']");
24175 | 33 |       if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
24176 | 34 |         target = dialog;
24177 | 35 |       }
24178 | 36 |     }
24179 | 37 | 
24180 | 38 |     // ostateczny fallback: dokument
24181 | 39 |     if (!target) {
24182 | 40 |       target =
24183 | 41 |         document.scrollingElement || document.documentElement || document.body;
24184 | 42 |     }
24185 | 43 | 
24186 | 44 |     if (
24187 | 45 |       target === document.body ||
24188 | 46 |       target === document.documentElement ||
24189 | 47 |       target === document.scrollingElement
24190 | 48 |     ) {
24191 | 49 |       const before = window.scrollY;
24192 | 50 |       window.scrollTo(0, before + dy);
24193 | 51 |     } else {
24194 | 52 |       target.scrollTop += dy;
24195 | 53 |     }
24196 | 54 |   }, amount);
24197 | 55 | }
24198 | 56 | 
24199 | 57 | export { scrollPost };
24200 | 58 | 
24201 | ```
24202 | 
24203 | ---
24204 | 
24205 | ### üìÑ ≈öcie≈ºka: `export_chat_context/08__login.js`
24206 | **Typ:** JavaScript/tekst  
24207 | **Opis:** Plik projektu (kod/konfiguracja).  
24208 | 
24209 | ```js
24210 |   1 | // src/fb/login.js
24211 |   2 | import { sleepRandom } from "../utils/sleep.js";
24212 |   3 | 
24213 |   4 | /**
24214 |   5 |  * FB login helpers ‚Äì PRO (NO COOLDOWN)
24215 |   6 |  *
24216 |   7 |  * Najwa≈ºniejsze:
24217 |   8 |  * - G≈Ç√≥wne logowanie: https://www.facebook.com/login.php?next=<postUrl>
24218 |   9 |  * - Best-effort (zero throw, zero crashy)
24219 |  10 |  * - Dwa tryby:
24220 |  11 |  *    1) login.php?next (najstabilniejsze)
24221 |  12 |  *    2) fallback: loginViaVisibleForm (overlay / r√≥≈ºne layouty)
24222 |  13 |  *
24223 |  14 |  * Kompatybilno≈õƒá:
24224 |  15 |  * - eksportujemy te≈º clickByText, acceptLoginCookies, loginViaVisibleForm (jak w wersji lokalnej)
24225 |  16 |  */
24226 |  17 | 
24227 |  18 | function norm(s) {
24228 |  19 |   return String(s || "")
24229 |  20 |     .replace(/\u00a0/g, " ")
24230 |  21 |     .replace(/\s+/g, " ")
24231 |  22 |     .trim();
24232 |  23 | }
24233 |  24 | 
24234 |  25 | /**
24235 |  26 |  * Cookies popup ‚Äì wersja "mark + click" (jak lokalnie), ale best-effort.
24236 |  27 |  */
24237 |  28 | async function acceptLoginCookies(page) {
24238 |  29 |   try {
24239 |  30 |     console.log("[FB][login-cookies] Szukam popupu cookies...");
24240 |  31 | 
24241 |  32 |     await sleepRandom(300, 900);
24242 |  33 | 
24243 |  34 |     const found = await page.evaluate(() => {
24244 |  35 |       const wanted = [
24245 |  36 |         "Zezw√≥l na wszystkie pliki cookie",
24246 |  37 |         "Zezw√≥l na wszystkie pliki",
24247 |  38 |         "Allow all cookies",
24248 |  39 |         "Accept all cookies",
24249 |  40 |         "Akceptuj wszystkie",
24250 |  41 |         "Odrzuƒá opcjonalne pliki cookie",
24251 |  42 |         "Odrzuc opcjonalne pliki cookie",
24252 |  43 |       ].map((t) => t.toLowerCase());
24253 |  44 | 
24254 |  45 |       const buttons = Array.from(
24255 |  46 |         document.querySelectorAll("button, [role='button']")
24256 |  47 |       );
24257 |  48 | 
24258 |  49 |       for (const btn of buttons) {
24259 |  50 |         const txt = (btn.innerText || btn.textContent || "").trim();
24260 |  51 |         if (!txt) continue;
24261 |  52 |         const low = txt.toLowerCase();
24262 |  53 | 
24263 |  54 |         if (wanted.some((w) => low.includes(w))) {
24264 |  55 |           btn.setAttribute("data-fb-cookie-btn", "1");
24265 |  56 |           return true;
24266 |  57 |         }
24267 |  58 |       }
24268 |  59 | 
24269 |  60 |       return false;
24270 |  61 |     });
24271 |  62 | 
24272 |  63 |     if (!found) {
24273 |  64 |       return false;
24274 |  65 |     }
24275 |  66 | 
24276 |  67 |     await page
24277 |  68 |       .click('[data-fb-cookie-btn="1"]')
24278 |  69 |       .catch(() => {});
24279 |  70 | 
24280 |  71 |     console.log(
24281 |  72 |       '[FB][login-cookies] Klikniƒôto cookies (data-fb-cookie-btn="1").'
24282 |  73 |     );
24283 |  74 | 
24284 |  75 |     await sleepRandom(600, 1200);
24285 |  76 |     return true;
24286 |  77 |   } catch (err) {
24287 |  78 |     console.log("[FB][login-cookies] B≈ÇƒÖd (ignorowany):", err?.message || err);
24288 |  79 |     return false;
24289 |  80 |   }
24290 |  81 | }
24291 |  82 | 
24292 |  83 | /**
24293 |  84 |  * Minimalne klikniƒôcie cookies bez markowania (czasem FB blokuje atrybuty).
24294 |  85 |  */
24295 |  86 | async function acceptCookiesIfPresent(page) {
24296 |  87 |   try {
24297 |  88 |     await sleepRandom(250, 650);
24298 |  89 | 
24299 |  90 |     const clicked = await page.evaluate(() => {
24300 |  91 |       const wanted = [
24301 |  92 |         "Zezw√≤l na wszystkie pliki cookie",
24302 |  93 |         "Zezw√≥l na wszystkie pliki cookie",
24303 |  94 |         "Zezw√≤l na wszystkie pliki",
24304 |  95 |         "Zezw√≥l na wszystkie pliki",
24305 |  96 |         "Allow all cookies",
24306 |  97 |         "Accept all cookies",
24307 |  98 |         "Akceptuj wszystkie",
24308 |  99 |       ].map((x) => x.toLowerCase());
24309 | 100 | 
24310 | 101 |       const btns = Array.from(
24311 | 102 |         document.querySelectorAll("button, [role='button']")
24312 | 103 |       );
24313 | 104 | 
24314 | 105 |       for (const b of btns) {
24315 | 106 |         const t = (b.innerText || b.textContent || "").trim();
24316 | 107 |         if (!t) continue;
24317 | 108 |         const low = t.toLowerCase();
24318 | 109 |         if (wanted.some((w) => low.includes(w))) {
24319 | 110 |           b.click();
24320 | 111 |           return true;
24321 | 112 |         }
24322 | 113 |       }
24323 | 114 |       return false;
24324 | 115 |     });
24325 | 116 | 
24326 | 117 |     if (clicked) {
24327 | 118 |       console.log("[FB][cookies] Klikniƒôto accept cookies (fallback).");
24328 | 119 |       await sleepRandom(500, 1100);
24329 | 120 |     }
24330 | 121 |     return !!clicked;
24331 | 122 |   } catch {
24332 | 123 |     return false;
24333 | 124 |   }
24334 | 125 | }
24335 | 126 | 
24336 | 127 | /**
24337 | 128 |  * Pomocnik: wpisz login/has≈Ço + kliknij login. Best-effort.
24338 | 129 |  */
24339 | 130 | async function fillLoginFormBestEffort(page) {
24340 | 131 |   const email = process.env.FB_EMAIL || "";
24341 | 132 |   const password = process.env.FB_PASSWORD || "";
24342 | 133 | 
24343 | 134 |   if (!email || !password) {
24344 | 135 |     console.log("[FB][login] Brak FB_EMAIL / FB_PASSWORD ‚Äì pomijam login.");
24345 | 136 |     return false;
24346 | 137 |   }
24347 | 138 | 
24348 | 139 |   const emailSel = [
24349 | 140 |     "input#email",
24350 | 141 |     "input[name='email']",
24351 | 142 |     "input[name='email_or_phone']",
24352 | 143 |     "input[type='text']",
24353 | 144 |   ].join(",");
24354 | 145 | 
24355 | 146 |   const passSel = [
24356 | 147 |     "input#pass",
24357 | 148 |     "input[name='pass']",
24358 | 149 |     "input[type='password']",
24359 | 150 |   ].join(",");
24360 | 151 | 
24361 | 152 |   const emailInput = await page.$(emailSel).catch(() => null);
24362 | 153 |   const passInput = await page.$(passSel).catch(() => null);
24363 | 154 | 
24364 | 155 |   if (!emailInput || !passInput) {
24365 | 156 |     console.log("[FB][login] Brak p√≥l email/has≈Ço na stronie login.");
24366 | 157 |     return false;
24367 | 158 |   }
24368 | 159 | 
24369 | 160 |   console.log("[FB][login] Wpisujƒô email i has≈Ço...");
24370 | 161 | 
24371 | 162 |   await emailInput.click({ clickCount: 3 }).catch(() => {});
24372 | 163 |   await page.keyboard.press("Backspace").catch(() => {});
24373 | 164 |   await emailInput.type(email, { delay: 35 }).catch(() => {});
24374 | 165 | 
24375 | 166 |   await passInput.click({ clickCount: 3 }).catch(() => {});
24376 | 167 |   await page.keyboard.press("Backspace").catch(() => {});
24377 | 168 |   await passInput.type(password, { delay: 35 }).catch(() => {});
24378 | 169 | 
24379 | 170 |   const loginButton =
24380 | 171 |     (await page.$('button[name="login"]')) ||
24381 | 172 |     (await page.$('button[type="submit"]')) ||
24382 | 173 |     (await page.$('div[role="button"][tabindex="0"]')) ||
24383 | 174 |     (await page.$("button")) ||
24384 | 175 |     null;
24385 | 176 | 
24386 | 177 |   if (!loginButton) {
24387 | 178 |     console.log("[FB][login] Brak przycisku logowania ‚Äì ko≈Ñczƒô pr√≥bƒô.");
24388 | 179 |     return false;
24389 | 180 |   }
24390 | 181 | 
24391 | 182 |   console.log("[FB][login] Klikam logowanie‚Ä¶");
24392 | 183 | 
24393 | 184 |   await Promise.all([
24394 | 185 |     loginButton.click().catch(() => {}),
24395 | 186 |     page
24396 | 187 |       .waitForNavigation({ waitUntil: "networkidle2", timeout: 60000 })
24397 | 188 |       .catch(() => {}),
24398 | 189 |   ]);
24399 | 190 | 
24400 | 191 |   await sleepRandom(1400, 2400);
24401 | 192 |   return true;
24402 | 193 | }
24403 | 194 | 
24404 | 195 | /**
24405 | 196 |  * Pr√≥ba logowania na dowolnym widocznym formularzu (z lokalnej wersji),
24406 | 197 |  * ale z lekkimi ulepszeniami i bez crashy.
24407 | 198 |  */
24408 | 199 | async function loginViaVisibleForm(page, context = "visible-form") {
24409 | 200 |   try {
24410 | 201 |     console.log(`[FB][login-form] Szukam formularza logowania (${context})...`);
24411 | 202 | 
24412 | 203 |     await acceptLoginCookies(page).catch(() => {});
24413 | 204 |     await acceptCookiesIfPresent(page).catch(() => {});
24414 | 205 | 
24415 | 206 |     const emailSelector = [
24416 | 207 |       "input#email",
24417 | 208 |       "input[name='email']",
24418 | 209 |       "input[name='email_or_phone']",
24419 | 210 |       "input[aria-label*='Adres e-mail']",
24420 | 211 |       "input[placeholder*='Adres e-mail']",
24421 | 212 |       "input[placeholder*='adres e-mail']",
24422 | 213 |       "input[placeholder*='Email']",
24423 | 214 |       "input[placeholder*='email']",
24424 | 215 |       "input[type='text']",
24425 | 216 |     ].join(",");
24426 | 217 | 
24427 | 218 |     const passSelector = [
24428 | 219 |       "input#pass",
24429 | 220 |       "input[name='pass']",
24430 | 221 |       "input[aria-label*='Has≈Ço']",
24431 | 222 |       "input[placeholder*='Has≈Ço']",
24432 | 223 |       "input[placeholder*='has≈Ço']",
24433 | 224 |       "input[placeholder*='Password']",
24434 | 225 |       "input[placeholder*='password']",
24435 | 226 |       "input[type='password']",
24436 | 227 |     ].join(",");
24437 | 228 | 
24438 | 229 |     const emailInput = await page.$(emailSelector).catch(() => null);
24439 | 230 |     const passInput = await page.$(passSelector).catch(() => null);
24440 | 231 | 
24441 | 232 |     if (!emailInput || !passInput) {
24442 | 233 |       console.log(
24443 | 234 |         "[FB][login-form] Brak pe≈Çnego formularza (email + has≈Ço) na stronie."
24444 | 235 |       );
24445 | 236 |       return false;
24446 | 237 |     }
24447 | 238 | 
24448 | 239 |     const ok = await fillLoginFormBestEffort(page);
24449 | 240 |     if (!ok) return false;
24450 | 241 | 
24451 | 242 |     console.log("[FB][login-form] Formularz logowania wys≈Çany.");
24452 | 243 |     return true;
24453 | 244 |   } catch (err) {
24454 | 245 |     console.error("[FB][login-form] B≈ÇƒÖd (ignorowany):", err?.message || err);
24455 | 246 |     return false;
24456 | 247 |   }
24457 | 248 | }
24458 | 249 | 
24459 | 250 | /**
24460 | 251 |  * G≈Ç√≥wne logowanie ‚Äì NAJSTABILNIEJSZE: login.php?next=<URL>
24461 | 252 |  * Param nextUrl: URL posta, do kt√≥rego FB ma wr√≥ciƒá po loginie.
24462 | 253 |  */
24463 | 254 | async function fbLogin(page, nextUrl = "") {
24464 | 255 |   try {
24465 | 256 |     console.log("[FB][login] Start logowania (best-effort)");
24466 | 257 | 
24467 | 258 |     const next = nextUrl ? `?next=${encodeURIComponent(nextUrl)}` : "";
24468 | 259 |     const url = `https://www.facebook.com/login.php${next}`;
24469 | 260 | 
24470 | 261 |     await page
24471 | 262 |       .goto(url, { waitUntil: "networkidle2", timeout: 60000 })
24472 | 263 |       .catch(() => {});
24473 | 264 | 
24474 | 265 |     await sleepRandom(900, 1400);
24475 | 266 | 
24476 | 267 |     // cookies ‚Äì dwie metody (mark+click oraz szybki fallback)
24477 | 268 |     await acceptLoginCookies(page).catch(() => {});
24478 | 269 |     await acceptCookiesIfPresent(page).catch(() => {});
24479 | 270 | 
24480 | 271 |     const ok = await fillLoginFormBestEffort(page);
24481 | 272 |     if (!ok) return false;
24482 | 273 | 
24483 | 274 |     // FB czasem zostaje na tej samej stronie ‚Äì dodatkowa pauza
24484 | 275 |     await sleepRandom(1200, 2000);
24485 | 276 | 
24486 | 277 |     return true;
24487 | 278 |   } catch (e) {
24488 | 279 |     console.log("[FB][login] B≈ÇƒÖd (ignorowany):", e?.message || e);
24489 | 280 |     return false;
24490 | 281 |   }
24491 | 282 | }
24492 | 283 | 
24493 | 284 | /**
24494 | 285 |  * Heurystyczny check sesji (jak serwer).
24495 | 286 |  */
24496 | 287 | async function checkIfLogged(page) {
24497 | 288 |   try {
24498 | 289 |     return await page.evaluate(() => {
24499 | 290 |       return !!(
24500 | 291 |         document.querySelector('input[aria-label*="Szukaj"]') ||
24501 | 292 |         document.querySelector('input[placeholder*="Szukaj"]') ||
24502 | 293 |         document.querySelector('a[aria-label*="Profil"]') ||
24503 | 294 |         document.querySelector('div[aria-label*="Konto"]')
24504 | 295 |       );
24505 | 296 |     });
24506 | 297 |   } catch {
24507 | 298 |     return false;
24508 | 299 |   }
24509 | 300 | }
24510 | 301 | 
24511 | 302 | /**
24512 | 303 |  * Klikniƒôcie elementu po dok≈Çadnym tek≈õcie (lokalny helper).
24513 | 304 |  */
24514 | 305 | async function clickByText(page, text) {
24515 | 306 |   const res = await page.evaluate((label) => {
24516 | 307 |     const els = Array.from(
24517 | 308 |       document.querySelectorAll("button, a, div[role='button'], span[role='button']")
24518 | 309 |     );
24519 | 310 |     const lowLabel = String(label || "").toLowerCase();
24520 | 311 |     for (const el of els) {
24521 | 312 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
24522 | 313 |       if (!t) continue;
24523 | 314 |       if (t === lowLabel) {
24524 | 315 |         el.click();
24525 | 316 |         return true;
24526 | 317 |       }
24527 | 318 |     }
24528 | 319 |     return false;
24529 | 320 |   }, text);
24530 | 321 |   return res;
24531 | 322 | }
24532 | 323 | 
24533 | 324 | /**
24534 | 325 |  * Heurystyka login-wall (serwerowa).
24535 | 326 |  * Uwaga: "Log In" czasem jest widoczne mimo, ≈ºe da siƒô czytaƒá komentarze,
24536 | 327 |  * wiƒôc to powinno odpalaƒá siƒô dopiero gdy UI nie potrafi odczytaƒá danych.
24537 | 328 |  */
24538 | 329 | async function looksLikeLoginWall(page) {
24539 | 330 |   try {
24540 | 331 |     return await page.evaluate(() => {
24541 | 332 |       const txt = (document.body?.innerText || "").toLowerCase();
24542 | 333 |       if (!txt) return false;
24543 | 334 | 
24544 | 335 |       const hasLoginWords =
24545 | 336 |         txt.includes("log in") ||
24546 | 337 |         txt.includes("sign up") ||
24547 | 338 |         txt.includes("create new account") ||
24548 | 339 |         txt.includes("zaloguj") ||
24549 | 340 |         txt.includes("zarejestruj");
24550 | 341 | 
24551 | 342 |       if (!hasLoginWords) return false;
24552 | 343 | 
24553 | 344 |       const hasLoginForm =
24554 | 345 |         !!document.querySelector("input[type='password']") ||
24555 | 346 |         !!document.querySelector("input#email") ||
24556 | 347 |         !!document.querySelector("input[name='email']");
24557 | 348 | 
24558 | 349 |       const hasPostWords =
24559 | 350 |         txt.includes("comment") ||
24560 | 351 |         txt.includes("comments") ||
24561 | 352 |         txt.includes("komentarz") ||
24562 | 353 |         txt.includes("lubiƒô to") ||
24563 | 354 |         txt.includes("like") ||
24564 | 355 |         txt.includes("reply") ||
24565 | 356 |         txt.includes("replied");
24566 | 357 | 
24567 | 358 |       return hasLoginForm || (hasLoginWords && !hasPostWords);
24568 | 359 |     });
24569 | 360 |   } catch {
24570 | 361 |     return false;
24571 | 362 |   }
24572 | 363 | }
24573 | 364 | 
24574 | 365 | /**
24575 | 366 |  * G≈Ç√≥wny ‚Äûw≈ÇƒÖcznik‚Äù do u≈ºycia w UI handlerach:
24576 | 367 |  * - je≈õli wyglƒÖda na login-wall -> login.php?next -> wr√≥ƒá na post
24577 | 368 |  * - fallback: pr√≥ba loginViaVisibleForm (gdyby FB zrobi≈Ç overlay)
24578 | 369 |  *
24579 | 370 |  * Param postUrl: najlepiej podaƒá URL posta (≈ºeby next= dzia≈Ça≈Ço idealnie)
24580 | 371 |  */
24581 | 372 | async function ensureLoggedInOnPostOverlay(page, postUrl = "") {
24582 | 373 |   try {
24583 | 374 |     const cur = page.url();
24584 | 375 |     const target = postUrl || cur;
24585 | 376 | 
24586 | 377 |     const wall = await looksLikeLoginWall(page);
24587 | 378 |     if (!wall) return false;
24588 | 379 | 
24589 | 380 |     console.log(
24590 | 381 |       "[FB][login] Wykryto login-wall -> login.php?next i pr√≥ba logowania."
24591 | 382 |     );
24592 | 383 | 
24593 | 384 |     const tried = await fbLogin(page, target);
24594 | 385 | 
24595 | 386 |     let logged = await checkIfLogged(page);
24596 | 387 |     console.log("[FB][login] session after fbLogin:", logged ? "YES" : "NO");
24597 | 388 | 
24598 | 389 |     // je≈õli FB nie przerzuci≈Ç automatycznie, wr√≥ƒá na post
24599 | 390 |     if (target && norm(page.url()) !== norm(target)) {
24600 | 391 |       await page
24601 | 392 |         .goto(target, { waitUntil: "networkidle2", timeout: 60000 })
24602 | 393 |         .catch(() => {});
24603 | 394 |       await sleepRandom(900, 1400);
24604 | 395 |     }
24605 | 396 | 
24606 | 397 |     // jeszcze raz sprawd≈∫ sesjƒô po powrocie
24607 | 398 |     logged = await checkIfLogged(page);
24608 | 399 | 
24609 | 400 |     // fallback: gdyby FB nadal siedzia≈Ç na overlayu, spr√≥buj visible-form
24610 | 401 |     if (!logged) {
24611 | 402 |       const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
24612 | 403 |       if (usedInline) {
24613 | 404 |         logged = await checkIfLogged(page);
24614 | 405 |         console.log(
24615 | 406 |           "[FB][login] session after loginViaVisibleForm:",
24616 | 407 |           logged ? "YES" : "NO"
24617 | 408 |         );
24618 | 409 |       }
24619 | 410 |     }
24620 | 411 | 
24621 | 412 |     return tried && logged;
24622 | 413 |   } catch (e) {
24623 | 414 |     console.log(
24624 | 415 |       "[FB][login] ensureLoggedInOnPostOverlay error (ignored):",
24625 | 416 |       e?.message || e
24626 | 417 |     );
24627 | 418 |     return false;
24628 | 419 |   }
24629 | 420 | }
24630 | 421 | 
24631 | 422 | export {
24632 | 423 |   fbLogin,
24633 | 424 |   checkIfLogged,
24634 | 425 |   ensureLoggedInOnPostOverlay,
24635 | 426 |   clickByText,
24636 | 427 |   acceptLoginCookies,
24637 | 428 |   loginViaVisibleForm,
24638 | 429 | };
24639 | 430 | 
24640 | ```
24641 | 
24642 | ---
24643 | 
24644 | ### üìÑ ≈öcie≈ºka: `export_chat_context/09__cookies.js`
24645 | **Typ:** JavaScript/tekst  
24646 | **Opis:** Plik projektu (kod/konfiguracja).  
24647 | 
24648 | ```js
24649 |   1 | // src/fb/cookies.js
24650 |   2 | 
24651 |   3 | import fs from "fs/promises";
24652 |   4 | import { sleepRandom } from "../utils/sleep.js";
24653 |   5 | 
24654 |   6 | 
24655 |   7 | 
24656 |   8 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
24657 |   9 | const COOKIES_READ_ONLY =
24658 |  10 |   String(process.env.COOKIES_READ_ONLY || "")
24659 |  11 |     .trim()
24660 |  12 |     .toLowerCase() === "true";
24661 |  13 | 
24662 |  14 | console.log(
24663 |  15 |   "[FB][cookies] COOKIES_READ_ONLY =",
24664 |  16 |   COOKIES_READ_ONLY,
24665 |  17 |   "(raw:",
24666 |  18 |   process.env.COOKIES_READ_ONLY,
24667 |  19 |   ")"
24668 |  20 | );
24669 |  21 | 
24670 |  22 | 
24671 |  23 | /**
24672 |  24 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
24673 |  25 |  */
24674 |  26 | async function loadCookies(page) {
24675 |  27 |   try {
24676 |  28 |     const raw = await fs.readFile("cookies.json", "utf8");
24677 |  29 |     const cookies = JSON.parse(raw);
24678 |  30 | 
24679 |  31 |     if (Array.isArray(cookies) && cookies.length) {
24680 |  32 |       await page.setCookie(...cookies);
24681 |  33 |       console.log("[FB][cookies] Za≈Çadowano zapisane cookies (cookies.json).");
24682 |  34 |     } else {
24683 |  35 |       console.log(
24684 |  36 |         "[FB][cookies] cookies.json istnieje, ale nie zawiera poprawnej tablicy cookies."
24685 |  37 |       );
24686 |  38 |     }
24687 |  39 |   } catch (err) {
24688 |  40 |     console.log(
24689 |  41 |       "[FB][cookies] Brak zapisanych cookies lub b≈ÇƒÖd odczytu ‚Äì logowanie od zera.",
24690 |  42 |       err?.message || err
24691 |  43 |     );
24692 |  44 |   }
24693 |  45 | }
24694 |  46 | 
24695 |  47 | /**
24696 |  48 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
24697 |  49 |  * w katalogu roboczym procesu (tam, skƒÖd odpalasz node).
24698 |  50 |  */
24699 |  51 | async function saveCookies(page) {
24700 |  52 |   if (COOKIES_READ_ONLY) {
24701 |  53 |     console.log(
24702 |  54 |       "[FB][cookies] COOKIES_READ_ONLY=true ‚Äì pomijam zapis cookies.json (tylko odczyt z pliku)."
24703 |  55 |     );
24704 |  56 |     return;
24705 |  57 |   }
24706 |  58 | 
24707 |  59 |   try {
24708 |  60 |     const cookies = await page.cookies();
24709 |  61 | 
24710 |  62 |     await fs.writeFile(
24711 |  63 |       "cookies.json",
24712 |  64 |       JSON.stringify(cookies, null, 2),
24713 |  65 |       "utf8"
24714 |  66 |     );
24715 |  67 | 
24716 |  68 |     console.log(
24717 |  69 |       `[FB][cookies] Zapisano cookies.json (liczba cookies: ${cookies.length}).`
24718 |  70 |     );
24719 |  71 |   } catch (e) {
24720 |  72 |     console.log(
24721 |  73 |       "[FB][cookies] B≈ÇƒÖd przy zapisie cookies.json:",
24722 |  74 |       e?.message || e
24723 |  75 |     );
24724 |  76 |   }
24725 |  77 | }
24726 |  78 | 
24727 |  79 | 
24728 |  80 | 
24729 |  81 | /**
24730 |  82 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
24731 |  83 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
24732 |  84 |  */
24733 |  85 | async function acceptCookies(page, label = "global") {
24734 |  86 |   try {
24735 |  87 |     // chwila na pojawienie siƒô popupu
24736 |  88 |     await sleepRandom(800, 1500);
24737 |  89 | 
24738 |  90 |     const result = await page.evaluate(() => {
24739 |  91 |       const wanted = [
24740 |  92 |         "zezw√≥l na wszystkie pliki cookie",
24741 |  93 |         "zezw√≥l na wszystkie pliki",
24742 |  94 |         "akceptuj wszystkie pliki cookie",
24743 |  95 |         "akceptuj wszystkie",
24744 |  96 |         "allow all cookies",
24745 |  97 |         "accept all cookies",
24746 |  98 |         "accept essential and optional cookies",
24747 |  99 |         "tylko niezbƒôdne pliki cookie",
24748 | 100 |         "odrzuƒá opcjonalne pliki cookie",
24749 | 101 |       ].map((t) => t.toLowerCase());
24750 | 102 | 
24751 | 103 |       const buttons = Array.from(
24752 | 104 |         document.querySelectorAll("button, [role='button']")
24753 | 105 |       );
24754 | 106 | 
24755 | 107 |       let clicked = false;
24756 | 108 |       const texts = [];
24757 | 109 | 
24758 | 110 |       for (const btn of buttons) {
24759 | 111 |         const txt = (btn.innerText || btn.textContent || "").trim();
24760 | 112 |         if (!txt) continue;
24761 | 113 | 
24762 | 114 |         const low = txt.toLowerCase();
24763 | 115 |         texts.push(txt);
24764 | 116 | 
24765 | 117 |         if (wanted.some((w) => low.includes(w))) {
24766 | 118 |           btn.click();
24767 | 119 |           clicked = true;
24768 | 120 |           break;
24769 | 121 |         }
24770 | 122 |       }
24771 | 123 | 
24772 | 124 |       return { clicked, texts };
24773 | 125 |     });
24774 | 126 | 
24775 | 127 |     if (result.clicked) {
24776 | 128 |       console.log(
24777 | 129 |         `[FB][cookies-${label}] Klikniƒôto przycisk akceptacji cookies.`
24778 | 130 |       );
24779 | 131 |       await sleepRandom(1500, 2500);
24780 | 132 |     } else {
24781 | 133 |       console.log(
24782 | 134 |         `[FB][cookies-${label}] Nie znaleziono przycisku cookies. Teksty na przyciskach:`,
24783 | 135 |         result.texts
24784 | 136 |       );
24785 | 137 |     }
24786 | 138 |   } catch (err) {
24787 | 139 |     console.log(
24788 | 140 |       `[FB][cookies-${label}] B≈ÇƒÖd przy obs≈Çudze popupu cookies:`,
24789 | 141 |       err?.message || err
24790 | 142 |     );
24791 | 143 |   }
24792 | 144 | }
24793 | 145 | 
24794 | 146 | export { loadCookies, saveCookies, acceptCookies };
24795 | 147 | 
24796 | ```
24797 | 
24798 | ---
24799 | 
24800 | ### üìÑ ≈öcie≈ºka: `export_chat_context/10__expandButtons.js`
24801 | **Typ:** JavaScript/tekst  
24802 | **Opis:** Plik projektu (kod/konfiguracja).  
24803 | 
24804 | ```js
24805 |   1 | // src/fb/expandButtons.js
24806 |   2 | // Centralny ‚Äûbutton classifier‚Äù dla wszystkich przycisk√≥w typu:
24807 |   3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments‚Äù
24808 |   4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies‚Äù
24809 |   5 | // - ‚ÄûZobacz wiƒôcej / See more‚Äù (bez ‚ÄûZobacz t≈Çumaczenie‚Äù).
24810 |   6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
24811 |   7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
24812 |   8 | 
24813 |   9 | import { INCLUDE_REPLIES } from "../config.js";
24814 |  10 | 
24815 |  11 | async function clickOneExpandButton(page) {
24816 |  12 |   const res = await page.evaluate((includeReplies) => {
24817 |  13 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
24818 |  14 |       location.href
24819 |  15 |     );
24820 |  16 |     const isWatchView = /\/watch\//i.test(location.href);
24821 |  17 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
24822 |  18 | 
24823 |  19 |     function getPostRoot() {
24824 |  20 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
24825 |  21 |       const postDialog = dialogs.find((dlg) => {
24826 |  22 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
24827 |  23 |         if (!text) return false;
24828 |  24 |         const hasCommentWord =
24829 |  25 |           text.includes("komentarz") || text.includes("comment");
24830 |  26 |         const hasActions =
24831 |  27 |           text.includes("lubiƒô to") ||
24832 |  28 |           text.includes("komentarz") ||
24833 |  29 |           text.includes("udostƒôpnij") ||
24834 |  30 |           text.includes("napisz komentarz") ||
24835 |  31 |           text.includes("comment");
24836 |  32 |         const looksLikeNotifications =
24837 |  33 |           text.startsWith("powiadomienia") &&
24838 |  34 |           text.includes("wszystkie") &&
24839 |  35 |           text.includes("nieprzeczytane");
24840 |  36 |         return !looksLikeNotifications && hasCommentWord && hasActions;
24841 |  37 |       });
24842 |  38 |       if (postDialog) return postDialog;
24843 |  39 |       const main = document.querySelector("div[role='main']");
24844 |  40 |       if (main) {
24845 |  41 |         const article = main.querySelector("article");
24846 |  42 |         return article || main;
24847 |  43 |       }
24848 |  44 |       return document.body;
24849 |  45 |     }
24850 |  46 | 
24851 |  47 |     function isVisible(el) {
24852 |  48 |       if (!el) return false;
24853 |  49 |       const style = window.getComputedStyle(el);
24854 |  50 |       if (!style) return false;
24855 |  51 |       if (style.display === "none" || style.visibility === "hidden") return false;
24856 |  52 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
24857 |  53 |       if (style.pointerEvents === "none") return false;
24858 |  54 |       const rect = el.getBoundingClientRect();
24859 |  55 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
24860 |  56 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
24861 |  57 |       return true;
24862 |  58 |     }
24863 |  59 | 
24864 |  60 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
24865 |  61 |     const root =
24866 |  62 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
24867 |  63 |     // (widok /watch/ jest traktowany jak video)
24868 |  64 | 
24869 |  65 |     const buttons = Array.from(
24870 |  66 |       root.querySelectorAll(
24871 |  67 |         "button, a, div[role='button'], span[role='button']"
24872 |  68 |       )
24873 |  69 |     );
24874 |  70 | 
24875 |  71 |     function classifyButton(raw) {
24876 |  72 |       const text = raw.toLowerCase();
24877 |  73 |       const hasCommentWord =
24878 |  74 |         text.includes("komentarz") ||
24879 |  75 |         text.includes("comments") ||
24880 |  76 |         text.includes("comment");
24881 |  77 |       const hasReplyWord =
24882 |  78 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
24883 |  79 |         text.includes("reply") ||
24884 |  80 |         text.includes("replies") ||
24885 |  81 |         text.includes("repl");
24886 |  82 |       const hasMoreWord =
24887 |  83 |         text.includes("wy≈õwietl") ||
24888 |  84 |         text.includes("zobacz") ||
24889 |  85 |         text.includes("poka≈º") ||
24890 |  86 |         text.includes("view") ||
24891 |  87 |         text.includes("show") ||
24892 |  88 |         text.includes("see") ||
24893 |  89 |         text.includes("wszystkie") ||
24894 |  90 |         text.includes("all") ||
24895 |  91 |         text.includes("previous");
24896 |  92 |       const hasTranslationWord =
24897 |  93 |         text.includes("t≈Çumaczenie") || text.includes("translation");
24898 |  94 |       if (hasTranslationWord) return null;
24899 |  95 |       if (
24900 |  96 |         text === "komentarz" ||
24901 |  97 |         text === "comment" ||
24902 |  98 |         text === "lubiƒô to" ||
24903 |  99 |         text === "lubiƒô to!" ||
24904 | 100 |         text === "like" ||
24905 | 101 |         text === "odpowiedz" ||
24906 | 102 |         text === "reply"
24907 | 103 |       ) {
24908 | 104 |         return null;
24909 | 105 |       }
24910 | 106 |       if (
24911 | 107 |         hasCommentWord &&
24912 | 108 |         hasMoreWord &&
24913 | 109 |         (text.includes("wiƒôcej") ||
24914 | 110 |           text.includes("more") ||
24915 | 111 |           text.includes("poprzednie") ||
24916 | 112 |           text.includes("previous"))
24917 | 113 |       ) {
24918 | 114 |         return { kind: "more-comments", priority: 3 };
24919 | 115 |       }
24920 | 116 | 
24921 | 117 |       // ‚úÖ ON/OFF odpowiedzi
24922 | 118 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
24923 | 119 |         return { kind: "more-replies", priority: 2 };
24924 | 120 |       }
24925 | 121 | 
24926 | 122 |       if (
24927 | 123 |         text === "zobacz wiƒôcej" ||
24928 | 124 |         text === "see more" ||
24929 | 125 |         text.startsWith("zobacz wiƒôcej ") ||
24930 | 126 |         text.startsWith("see more ")
24931 | 127 |       ) {
24932 | 128 |         return { kind: "see-more-text", priority: 1 };
24933 | 129 |       }
24934 | 130 |       return null;
24935 | 131 |     }
24936 | 132 | 
24937 | 133 |     const candidates = [];
24938 | 134 | 
24939 | 135 |     for (const el of buttons) {
24940 | 136 |       if (!isVisible(el)) continue;
24941 | 137 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
24942 | 138 |       if (!raw) continue;
24943 | 139 |       const cls = classifyButton(raw);
24944 | 140 |       if (!cls) continue;
24945 | 141 |       const rect = el.getBoundingClientRect();
24946 | 142 |       candidates.push({
24947 | 143 |         el,
24948 | 144 |         kind: cls.kind,
24949 | 145 |         priority: cls.priority,
24950 | 146 |         top: rect.top,
24951 | 147 |         text: raw,
24952 | 148 |       });
24953 | 149 |     }
24954 | 150 | 
24955 | 151 |     if (!candidates.length) {
24956 | 152 |       return { clicked: false };
24957 | 153 |     }
24958 | 154 | 
24959 | 155 |     candidates.sort((a, b) => {
24960 | 156 |       if (a.priority !== b.priority) return b.priority - a.priority;
24961 | 157 |       return a.top - b.top;
24962 | 158 |     });
24963 | 159 | 
24964 | 160 |     const chosen = candidates[0];
24965 | 161 |     try {
24966 | 162 |       chosen.el.click();
24967 | 163 |       return {
24968 | 164 |         clicked: true,
24969 | 165 |         kind: chosen.kind,
24970 | 166 |         text: chosen.text,
24971 | 167 |       };
24972 | 168 |     } catch (e) {
24973 | 169 |       return { clicked: false };
24974 | 170 |     }
24975 | 171 |   }, INCLUDE_REPLIES);
24976 | 172 | 
24977 | 173 |   if (res && res.clicked) {
24978 | 174 |     console.log(
24979 | 175 |       `[FB] -> klik expand '${res.text}' (kind=${res.kind})`
24980 | 176 |     );
24981 | 177 |   }
24982 | 178 |   return !!(res && res.clicked);
24983 | 179 | }
24984 | 180 | 
24985 | 181 | export { clickOneExpandButton };
24986 | 182 | 
24987 | ```
24988 | 
24989 | ---
24990 | 
24991 | ### üìÑ ≈öcie≈ºka: `export_chat_context/11__index.js`
24992 | **Typ:** JavaScript/tekst  
24993 | **Opis:** Plik projektu (kod/konfiguracja).  
24994 | 
24995 | ```js
24996 |  1 | // src/fb/ui/index.js
24997 |  2 | import * as PostUI from "./post.js";
24998 |  3 | import * as PhotoUI from "./photo.js";
24999 |  4 | import * as WatchUI from "./watch.js";
25000 |  5 | import * as VideosUI from "./videos.js";
25001 |  6 | 
25002 |  7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
25003 |  8 | 
25004 |  9 | export function pickUiHandler(url) {
25005 | 10 |   const u = String(url || "");
25006 | 11 |   for (const h of HANDLERS) {
25007 | 12 |     try {
25008 | 13 |       if (h.matchesUrl(u)) return h;
25009 | 14 |     } catch {}
25010 | 15 |   }
25011 | 16 |   return PostUI;
25012 | 17 | }
25013 | 18 | 
25014 | ```
25015 | 
25016 | ---
25017 | 
25018 | ### üìÑ ≈öcie≈ºka: `export_chat_context/12__post.js`
25019 | **Typ:** JavaScript/tekst  
25020 | **Opis:** Plik projektu (kod/konfiguracja).  
25021 | 
25022 | ```js
25023 |   1 | // src/fb/ui/post.js
25024 |   2 | import { EXPAND_COMMENTS } from "../../config.js";
25025 |   3 | import { sleepRandom } from "../../utils/sleep.js";
25026 |   4 | import { safeGoto } from "../../utils/navigation.js";
25027 |   5 | 
25028 |   6 | import { scrollPost } from "../scroll.js";
25029 |   7 | import { acceptCookies, saveCookies } from "../cookies.js";
25030 |   8 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
25031 |   9 | import { clickOneExpandButton } from "../expandButtons.js";
25032 |  10 | 
25033 |  11 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
25034 |  12 | 
25035 |  13 | export const type = "post";
25036 |  14 | 
25037 |  15 | export function matchesUrl(url) {
25038 |  16 |   if (!url) return false;
25039 |  17 |   const u = String(url);
25040 |  18 |   if (u.includes("/watch")) return false;
25041 |  19 |   if (u.includes("/videos/")) return false;
25042 |  20 |   if (u.includes("/photo")) return false;
25043 |  21 |   if (u.includes("photo.php")) return false;
25044 |  22 | 
25045 |  23 |   return (
25046 |  24 |     u.includes("/posts/") ||
25047 |  25 |     u.includes("permalink.php") ||
25048 |  26 |     u.includes("/story.php") ||
25049 |  27 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
25050 |  28 |   );
25051 |  29 | }
25052 |  30 | 
25053 |  31 | /* ============================================================
25054 |  32 |    =============== POST ROOT (DIALOG / MAIN) ===================
25055 |  33 |    ============================================================ */
25056 |  34 | 
25057 |  35 | function postRootScript() {
25058 |  36 |   return `
25059 |  37 |     function getPostRoot() {
25060 |  38 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
25061 |  39 | 
25062 |  40 |       const postDialog = dialogs.find((dlg) => {
25063 |  41 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
25064 |  42 |         if (!text) return false;
25065 |  43 | 
25066 |  44 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
25067 |  45 |         const hasActions =
25068 |  46 |           text.includes("lubiƒô to") ||
25069 |  47 |           text.includes("komentarz") ||
25070 |  48 |           text.includes("udostƒôpnij") ||
25071 |  49 |           text.includes("write a comment") ||
25072 |  50 |           text.includes("comment");
25073 |  51 | 
25074 |  52 |         const looksLikeNotifications =
25075 |  53 |           text.startsWith("powiadomienia") &&
25076 |  54 |           text.includes("wszystkie") &&
25077 |  55 |           text.includes("nieprzeczytane");
25078 |  56 | 
25079 |  57 |         return !looksLikeNotifications && hasCommentWord && hasActions;
25080 |  58 |       });
25081 |  59 | 
25082 |  60 |       if (postDialog) {
25083 |  61 |         const art = postDialog.querySelector("article");
25084 |  62 |         return art || postDialog;
25085 |  63 |       }
25086 |  64 | 
25087 |  65 |       const main = document.querySelector("div[role='main'], main");
25088 |  66 |       if (main) {
25089 |  67 |         const article = main.querySelector("article");
25090 |  68 |         return article || main;
25091 |  69 |       }
25092 |  70 | 
25093 |  71 |       return document.body;
25094 |  72 |     }
25095 |  73 |   `;
25096 |  74 | }
25097 |  75 | 
25098 |  76 | async function getPostScopeSelector(page) {
25099 |  77 |   const scope = await page.evaluate((code) => {
25100 |  78 |     // eslint-disable-next-line no-eval
25101 |  79 |     eval(code);
25102 |  80 |     // @ts-ignore
25103 |  81 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
25104 |  82 |     if (!root) return "document";
25105 |  83 | 
25106 |  84 |     const dlg = root.closest("div[role='dialog']");
25107 |  85 |     if (dlg) return "div[role='dialog']";
25108 |  86 | 
25109 |  87 |     const main = document.querySelector("div[role='main'], main");
25110 |  88 |     if (main) return "div[role='main']";
25111 |  89 | 
25112 |  90 |     return "document";
25113 |  91 |   }, postRootScript());
25114 |  92 | 
25115 |  93 |   return scope || "document";
25116 |  94 | }
25117 |  95 | 
25118 |  96 | /* ============================================================
25119 |  97 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: ALL COMMENTS ===============
25120 |  98 |    ============================================================ */
25121 |  99 | 
25122 | 100 | async function clickAllCommentsInMenu(page) {
25123 | 101 |   const result = await page.evaluate(() => {
25124 | 102 |     const norm = (s) =>
25125 | 103 |       String(s || "")
25126 | 104 |         .replace(/\u00a0/g, " ")
25127 | 105 |         .replace(/\s+/g, " ")
25128 | 106 |         .trim()
25129 | 107 |         .toLowerCase();
25130 | 108 | 
25131 | 109 |     const menu = document.querySelector("div[role='menu']");
25132 | 110 |     if (!menu) return { clicked: false, noMenu: true };
25133 | 111 | 
25134 | 112 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
25135 | 113 | 
25136 | 114 |     const opt = items.find((el) => {
25137 | 115 |       const t = norm(el.textContent);
25138 | 116 |       return (
25139 | 117 |         t.startsWith("wszystkie komentarze") ||
25140 | 118 |         t.startsWith("all comments") ||
25141 | 119 |         t.startsWith("poka≈º wszystkie") ||
25142 | 120 |         t.startsWith("pokaz wszystkie") ||
25143 | 121 |         t.startsWith("show all")
25144 | 122 |       );
25145 | 123 |     });
25146 | 124 | 
25147 | 125 |     if (!opt) return { clicked: false, noMenu: false };
25148 | 126 | 
25149 | 127 |     try {
25150 | 128 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
25151 | 129 |     } catch {}
25152 | 130 | 
25153 | 131 |     try {
25154 | 132 |       opt.click();
25155 | 133 |       return { clicked: true, noMenu: false };
25156 | 134 |     } catch {
25157 | 135 |       return { clicked: false, noMenu: false };
25158 | 136 |     }
25159 | 137 |   });
25160 | 138 | 
25161 | 139 |   if (result.clicked) {
25162 | 140 |     await sleepRandom(250, 450);
25163 | 141 |     await page
25164 | 142 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
25165 | 143 |       .catch(() => {});
25166 | 144 |   }
25167 | 145 | 
25168 | 146 |   return result;
25169 | 147 | }
25170 | 148 | 
25171 | 149 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
25172 | 150 |   console.log("[FB][ui:post][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
25173 | 151 |   console.log("[FB][ui:post][filter] scope=", scopeSel);
25174 | 152 | 
25175 | 153 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
25176 | 154 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
25177 | 155 |   if (menuAlreadyOpen) {
25178 | 156 |     console.log("[FB][ui:post][filter] Menu ju≈º otwarte ‚Äì wybieram opcjƒô.");
25179 | 157 |     const r = await clickAllCommentsInMenu(page);
25180 | 158 |     if (r?.clicked)
25181 | 159 |       console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
25182 | 160 |     return !!r?.clicked;
25183 | 161 |   }
25184 | 162 | 
25185 | 163 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
25186 | 164 |   const pre = await page.evaluate(
25187 | 165 |     (scopeSel, code) => {
25188 | 166 |       const norm = (s) =>
25189 | 167 |         String(s || "")
25190 | 168 |           .replace(/\u00a0/g, " ")
25191 | 169 |           .replace(/\s+/g, " ")
25192 | 170 |           .trim()
25193 | 171 |           .toLowerCase();
25194 | 172 | 
25195 | 173 |       // eslint-disable-next-line no-eval
25196 | 174 |       eval(code);
25197 | 175 |       // @ts-ignore
25198 | 176 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
25199 | 177 | 
25200 | 178 |       function getLabel(el) {
25201 | 179 |         if (!el) return "";
25202 | 180 |         const aria = el.getAttribute?.("aria-label");
25203 | 181 |         if (aria) return aria;
25204 | 182 |         return el.textContent || "";
25205 | 183 |       }
25206 | 184 | 
25207 | 185 |       function isVisibleEnough(el) {
25208 | 186 |         try {
25209 | 187 |           if (!el) return false;
25210 | 188 |           const st = window.getComputedStyle(el);
25211 | 189 |           if (!st) return true;
25212 | 190 |           if (st.display === "none" || st.visibility === "hidden") return false;
25213 | 191 |           const r = el.getBoundingClientRect();
25214 | 192 |           if (!r || r.width < 8 || r.height < 8) return false;
25215 | 193 |           return true;
25216 | 194 |         } catch {
25217 | 195 |           return true;
25218 | 196 |         }
25219 | 197 |       }
25220 | 198 | 
25221 | 199 |       function findClickableAncestor(start) {
25222 | 200 |         let el = start;
25223 | 201 |         for (let i = 0; i < 10 && el; i++) {
25224 | 202 |           const role = el.getAttribute?.("role");
25225 | 203 |           const tag = (el.tagName || "").toLowerCase();
25226 | 204 |           if (
25227 | 205 |             tag === "button" ||
25228 | 206 |             role === "button" ||
25229 | 207 |             role === "menuitem" ||
25230 | 208 |             role === "menuitemradio" ||
25231 | 209 |             role === "link"
25232 | 210 |           ) {
25233 | 211 |             return el;
25234 | 212 |           }
25235 | 213 |           el = el.parentElement;
25236 | 214 |         }
25237 | 215 |         return null;
25238 | 216 |       }
25239 | 217 | 
25240 | 218 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
25241 | 219 |       const btnsAll = Array.from(
25242 | 220 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
25243 | 221 |       );
25244 | 222 |       for (const el of btnsAll) {
25245 | 223 |         const t = norm(getLabel(el));
25246 | 224 |         if (
25247 | 225 |           t === "wszystkie komentarze" ||
25248 | 226 |           t === "all comments" ||
25249 | 227 |           t === "poka≈º wszystkie" ||
25250 | 228 |           t === "pokaz wszystkie" ||
25251 | 229 |           t === "show all"
25252 | 230 |         ) {
25253 | 231 |           return { ok: true, state: "already-all", where: "document" };
25254 | 232 |         }
25255 | 233 |       }
25256 | 234 | 
25257 | 235 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
25258 | 236 |       const scopes = [scopeEl, root, document].filter(Boolean);
25259 | 237 | 
25260 | 238 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
25261 | 239 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
25262 | 240 |       for (const sc of scopes) {
25263 | 241 |         const clickables = Array.from(
25264 | 242 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
25265 | 243 |         );
25266 | 244 | 
25267 | 245 |         const candidates = [];
25268 | 246 |         for (const el of clickables) {
25269 | 247 |           const t = norm(getLabel(el));
25270 | 248 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
25271 | 249 |           if (!isVisibleEnough(el)) continue;
25272 | 250 | 
25273 | 251 |           let dist = 999999;
25274 | 252 |           try {
25275 | 253 |             const r = el.getBoundingClientRect();
25276 | 254 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
25277 | 255 |             dist = Math.abs(r.top - window.innerHeight / 2);
25278 | 256 |           } catch {}
25279 | 257 | 
25280 | 258 |           candidates.push({ el, dist });
25281 | 259 |         }
25282 | 260 | 
25283 | 261 |         if (candidates.length) {
25284 | 262 |           candidates.sort((a, b) => a.dist - b.dist);
25285 | 263 |           const picked = candidates[0].el;
25286 | 264 | 
25287 | 265 |           try {
25288 | 266 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
25289 | 267 |           } catch {}
25290 | 268 | 
25291 | 269 |           try {
25292 | 270 |             picked.click();
25293 | 271 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
25294 | 272 |           } catch {
25295 | 273 |             // nic
25296 | 274 |           }
25297 | 275 |         }
25298 | 276 |       }
25299 | 277 | 
25300 | 278 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
25301 | 279 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
25302 | 280 |       for (const sc of scopes) {
25303 | 281 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
25304 | 282 |           .filter(isVisibleEnough)
25305 | 283 |           .slice(0, 20000);
25306 | 284 | 
25307 | 285 |         for (const n of nodes) {
25308 | 286 |           const t = norm(n.textContent);
25309 | 287 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
25310 | 288 | 
25311 | 289 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
25312 | 290 |           if (!clickable) continue;
25313 | 291 | 
25314 | 292 |           try {
25315 | 293 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
25316 | 294 |           } catch {}
25317 | 295 | 
25318 | 296 |           try {
25319 | 297 |             clickable.click();
25320 | 298 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
25321 | 299 |           } catch {
25322 | 300 |             // nic
25323 | 301 |           }
25324 | 302 |         }
25325 | 303 |       }
25326 | 304 | 
25327 | 305 |       return { ok: false, state: "not-found" };
25328 | 306 |     },
25329 | 307 |     scopeSel,
25330 | 308 |     postRootScript()
25331 | 309 |   );
25332 | 310 | 
25333 | 311 |   if (!pre?.ok) {
25334 | 312 |     console.log("[FB][ui:post][filter] Nie znaleziono przycisku filtra komentarzy.");
25335 | 313 |     return false;
25336 | 314 |   }
25337 | 315 | 
25338 | 316 |   if (pre.state === "already-all") {
25339 | 317 |     console.log("[FB][ui:post][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' / 'Poka≈º wszystkie' ‚Äì pomijam.");
25340 | 318 |     return true;
25341 | 319 |   }
25342 | 320 | 
25343 | 321 |   console.log("[FB][ui:post][filter] Klikniƒôto filtr:", pre);
25344 | 322 | 
25345 | 323 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
25346 | 324 |   await sleepRandom(350, 650);
25347 | 325 | 
25348 | 326 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
25349 | 327 |   const menuResult = await clickAllCommentsInMenu(page);
25350 | 328 | 
25351 | 329 |   if (menuResult?.clicked) {
25352 | 330 |     console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
25353 | 331 |     return true;
25354 | 332 |   }
25355 | 333 | 
25356 | 334 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
25357 | 335 |   const afterLabelIsAll = await page.evaluate(() => {
25358 | 336 |     const norm = (s) =>
25359 | 337 |       String(s || "")
25360 | 338 |         .replace(/\u00a0/g, " ")
25361 | 339 |         .replace(/\s+/g, " ")
25362 | 340 |         .trim()
25363 | 341 |         .toLowerCase();
25364 | 342 | 
25365 | 343 |     const els = Array.from(
25366 | 344 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
25367 | 345 |     );
25368 | 346 | 
25369 | 347 |     function getLabel(el) {
25370 | 348 |       const aria = el.getAttribute?.("aria-label");
25371 | 349 |       if (aria) return aria;
25372 | 350 |       return el.textContent || "";
25373 | 351 |     }
25374 | 352 | 
25375 | 353 |     return els.some((el) => {
25376 | 354 |       const t = norm(getLabel(el));
25377 | 355 |       return (
25378 | 356 |         t === "wszystkie komentarze" ||
25379 | 357 |         t === "all comments" ||
25380 | 358 |         t === "poka≈º wszystkie" ||
25381 | 359 |         t === "pokaz wszystkie" ||
25382 | 360 |         t === "show all"
25383 | 361 |       );
25384 | 362 |     });
25385 | 363 |   });
25386 | 364 | 
25387 | 365 |   if (afterLabelIsAll) {
25388 | 366 |     console.log("[FB][ui:post][filter] Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
25389 | 367 |     return true;
25390 | 368 |   }
25391 | 369 | 
25392 | 370 |   console.log(
25393 | 371 |     "[FB][ui:post][filter] Nie uda≈Ço siƒô ustawiƒá filtra na 'Wszystkie komentarze' / 'Poka≈º wszystkie'. menuResult=",
25394 | 372 |     menuResult
25395 | 373 |   );
25396 | 374 |   return false;
25397 | 375 | }
25398 | 376 | 
25399 | 377 | 
25400 | 378 | /* ============================================================
25401 | 379 |    =================== LICZENIE Z UI (POST) ====================
25402 | 380 |    ============================================================ */
25403 | 381 | 
25404 | 382 | /**
25405 | 383 |  * Kluczowa poprawka:
25406 | 384 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
25407 | 385 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
25408 | 386 |  */
25409 | 387 | async function getCommentCountFromUiPostRoot(page) {
25410 | 388 |   const res = await page.evaluate((code) => {
25411 | 389 |     // eslint-disable-next-line no-eval
25412 | 390 |     eval(code);
25413 | 391 | 
25414 | 392 |     const norm = (s) =>
25415 | 393 |       String(s || "")
25416 | 394 |         .replace(/\u00a0/g, " ")
25417 | 395 |         .replace(/\s+/g, " ")
25418 | 396 |         .trim();
25419 | 397 | 
25420 | 398 |     const lower = (s) => norm(s).toLowerCase();
25421 | 399 | 
25422 | 400 |     function parsePlEnCount(text) {
25423 | 401 |       const t = lower(text);
25424 | 402 |       if (!t) return null;
25425 | 403 | 
25426 | 404 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
25427 | 405 | 
25428 | 406 |       let x = t
25429 | 407 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
25430 | 408 |         .replace(/comments?/g, "")
25431 | 409 |         .replace(/[():]/g, " ")
25432 | 410 |         .replace(/\s+/g, " ")
25433 | 411 |         .trim();
25434 | 412 | 
25435 | 413 |       let mult = 1;
25436 | 414 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
25437 | 415 |         mult = 1000;
25438 | 416 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
25439 | 417 |       }
25440 | 418 |       if (/\bmln\b|\bmillion\b/.test(x)) {
25441 | 419 |         mult = 1000000;
25442 | 420 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
25443 | 421 |       }
25444 | 422 | 
25445 | 423 |       x = x.replace(/\s+/g, "");
25446 | 424 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
25447 | 425 |       x = x.replace(/[^0-9.]/g, "");
25448 | 426 |       if (!x) return null;
25449 | 427 | 
25450 | 428 |       const n = Number(x);
25451 | 429 |       if (!Number.isFinite(n)) return null;
25452 | 430 | 
25453 | 431 |       return Math.round(n * mult);
25454 | 432 |     }
25455 | 433 | 
25456 | 434 |     // @ts-ignore
25457 | 435 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
25458 | 436 |     const scope = root || document;
25459 | 437 | 
25460 | 438 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
25461 | 439 |     const badBlock = (txt) => {
25462 | 440 |       const t = lower(txt);
25463 | 441 |       if (!t) return false;
25464 | 442 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
25465 | 443 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
25466 | 444 |       return false;
25467 | 445 |     };
25468 | 446 | 
25469 | 447 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
25470 | 448 |     const spans = Array.from(scope.querySelectorAll("span"));
25471 | 449 |     let best = null;
25472 | 450 | 
25473 | 451 |     for (const el of spans) {
25474 | 452 |       const raw = norm(el.textContent);
25475 | 453 |       if (!raw) continue;
25476 | 454 |       if (badBlock(raw)) continue;
25477 | 455 | 
25478 | 456 |       const val = parsePlEnCount(raw);
25479 | 457 |       if (val == null) continue;
25480 | 458 | 
25481 | 459 |       let score = 0;
25482 | 460 |       score += Math.max(0, 40 - raw.length);
25483 | 461 | 
25484 | 462 |       try {
25485 | 463 |         const r = el.getBoundingClientRect();
25486 | 464 |         if (r.width > 10 && r.height > 10) score += 10;
25487 | 465 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
25488 | 466 |       } catch {}
25489 | 467 | 
25490 | 468 |       if (!best || score > best.score) best = { raw, val, score };
25491 | 469 |     }
25492 | 470 | 
25493 | 471 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
25494 | 472 | 
25495 | 473 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
25496 | 474 |     const nodes = Array.from(
25497 | 475 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
25498 | 476 |     );
25499 | 477 | 
25500 | 478 |     for (const el of nodes) {
25501 | 479 |       const raw = norm(el.textContent);
25502 | 480 |       if (!raw) continue;
25503 | 481 |       if (badBlock(raw)) continue;
25504 | 482 | 
25505 | 483 |       const val = parsePlEnCount(raw);
25506 | 484 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
25507 | 485 |     }
25508 | 486 | 
25509 | 487 |     // 3) Ostatecznie: regex po tek≈õcie root
25510 | 488 |     const blob = norm(scope.innerText || "");
25511 | 489 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
25512 | 490 |     if (m) {
25513 | 491 |       const raw = norm(`${m[1]} ${m[2]}`);
25514 | 492 |       const val = parsePlEnCount(raw);
25515 | 493 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
25516 | 494 |     }
25517 | 495 | 
25518 | 496 |     return { ok: false, reason: "not-found" };
25519 | 497 |   }, postRootScript());
25520 | 498 | 
25521 | 499 |   return res?.ok ? res : null;
25522 | 500 | }
25523 | 501 | 
25524 | 502 | /* ============================================================
25525 | 503 |    =================== LICZENIE ANCHOR√ìW =======================
25526 | 504 |    ============================================================ */
25527 | 505 | 
25528 | 506 | async function getCurrentCommentAnchorCount(page) {
25529 | 507 |   const count = await page.evaluate(() => {
25530 | 508 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
25531 | 509 |     const ids = new Set();
25532 | 510 | 
25533 | 511 |     for (const a of anchors) {
25534 | 512 |       try {
25535 | 513 |         const url = new URL(a.href);
25536 | 514 |         const cid = url.searchParams.get("comment_id");
25537 | 515 |         const rid = url.searchParams.get("reply_comment_id");
25538 | 516 |         let raw = rid || cid;
25539 | 517 |         if (!raw) continue;
25540 | 518 | 
25541 | 519 |         if (!/^\d+$/.test(raw)) {
25542 | 520 |           try {
25543 | 521 |             const dec = atob(raw);
25544 | 522 |             const m = dec.match(/:(\d+)_([0-9]+)/);
25545 | 523 |             if (m) raw = m[2];
25546 | 524 |           } catch {}
25547 | 525 |         }
25548 | 526 | 
25549 | 527 |         if (raw) ids.add(raw);
25550 | 528 |       } catch {}
25551 | 529 |     }
25552 | 530 | 
25553 | 531 |     return ids.size;
25554 | 532 |   });
25555 | 533 | 
25556 | 534 |   return count || 0;
25557 | 535 | }
25558 | 536 | 
25559 | 537 | /* ============================================================
25560 | 538 |    =================== SCROLL TYLKO W PO≈öCIE ===================
25561 | 539 |    ============================================================ */
25562 | 540 | 
25563 | 541 | async function scrollWithinPost(page, label, factor = 0.25) {
25564 | 542 |   const info = await page.evaluate(
25565 | 543 |     (factorArg, labelArg, code) => {
25566 | 544 |       // eslint-disable-next-line no-eval
25567 | 545 |       eval(code);
25568 | 546 |       // @ts-ignore
25569 | 547 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
25570 | 548 | 
25571 | 549 |       const norm = (s) =>
25572 | 550 |         String(s || "")
25573 | 551 |           .replace(/\u00a0/g, " ")
25574 | 552 |           .replace(/\s+/g, " ")
25575 | 553 |           .trim()
25576 | 554 |           .toLowerCase();
25577 | 555 | 
25578 | 556 |       function canScrollByTest(el) {
25579 | 557 |         try {
25580 | 558 |           if (!el) return false;
25581 | 559 |           const ch = el.clientHeight || 0;
25582 | 560 |           const sh = el.scrollHeight || 0;
25583 | 561 |           if (ch <= 0) return false;
25584 | 562 |           if (sh <= ch + 30) return false;
25585 | 563 | 
25586 | 564 |           const before = el.scrollTop ?? 0;
25587 | 565 |           el.scrollTop = before + 80;
25588 | 566 |           const after = el.scrollTop ?? before;
25589 | 567 |           el.scrollTop = before;
25590 | 568 |           return after !== before;
25591 | 569 |         } catch {
25592 | 570 |           return false;
25593 | 571 |         }
25594 | 572 |       }
25595 | 573 | 
25596 | 574 |       function isVisible(el) {
25597 | 575 |         if (!el) return false;
25598 | 576 |         const st = window.getComputedStyle(el);
25599 | 577 |         if (!st) return true;
25600 | 578 |         if (st.display === "none" || st.visibility === "hidden") return false;
25601 | 579 |         const r = el.getBoundingClientRect();
25602 | 580 |         if (!r || r.width < 5 || r.height < 5) return false;
25603 | 581 |         return true;
25604 | 582 |       }
25605 | 583 | 
25606 | 584 |       function pickContainerSmart() {
25607 | 585 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
25608 | 586 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
25609 | 587 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
25610 | 588 | 
25611 | 589 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
25612 | 590 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
25613 | 591 | 
25614 | 592 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
25615 | 593 |         let anchor = null;
25616 | 594 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
25617 | 595 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
25618 | 596 |           .filter(isVisible)
25619 | 597 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
25620 | 598 | 
25621 | 599 |         if (candAnchor) anchor = candAnchor;
25622 | 600 | 
25623 | 601 |         function score(el) {
25624 | 602 |           const ch = el.clientHeight || 0;
25625 | 603 |           const sh = el.scrollHeight || 0;
25626 | 604 |           const delta = sh - ch;
25627 | 605 | 
25628 | 606 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
25629 | 607 |           const t = norm(el.innerText || "");
25630 | 608 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
25631 | 609 |           let s = delta + (hasCommentWords ? 12000 : 0);
25632 | 610 | 
25633 | 611 |           // premia je≈õli blisko anchora
25634 | 612 |           if (anchor) {
25635 | 613 |             const ar = anchor.getBoundingClientRect();
25636 | 614 |             const er = el.getBoundingClientRect();
25637 | 615 |             const dist = Math.abs(er.top - ar.top);
25638 | 616 |             s += Math.max(0, 4000 - dist);
25639 | 617 |           }
25640 | 618 | 
25641 | 619 |           return s;
25642 | 620 |         }
25643 | 621 | 
25644 | 622 |         let best = null;
25645 | 623 |         let bestScore = -1;
25646 | 624 | 
25647 | 625 |         for (const sc of scopes) {
25648 | 626 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
25649 | 627 |             .filter(isVisible)
25650 | 628 |             .slice(0, 18000);
25651 | 629 | 
25652 | 630 |           for (const el of divs) {
25653 | 631 |             if (!canScrollByTest(el)) continue;
25654 | 632 |             const s = score(el);
25655 | 633 |             if (s > bestScore) {
25656 | 634 |               bestScore = s;
25657 | 635 |               best = el;
25658 | 636 |             }
25659 | 637 |           }
25660 | 638 |           if (best) break;
25661 | 639 |         }
25662 | 640 | 
25663 | 641 |         if (best) {
25664 | 642 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
25665 | 643 |           return { el: best, label: "smart" };
25666 | 644 |         }
25667 | 645 | 
25668 | 646 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
25669 | 647 |         return {
25670 | 648 |           el: document.scrollingElement || document.documentElement || document.body,
25671 | 649 |           label: "window",
25672 | 650 |         };
25673 | 651 |       }
25674 | 652 | 
25675 | 653 |       const picked = pickContainerSmart();
25676 | 654 |       const container = picked.el;
25677 | 655 |       const containerType = picked.label;
25678 | 656 | 
25679 | 657 |       const isWindowContainer =
25680 | 658 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
25681 | 659 | 
25682 | 660 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
25683 | 661 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
25684 | 662 | 
25685 | 663 |       if (maxScroll <= 0) {
25686 | 664 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
25687 | 665 |       }
25688 | 666 | 
25689 | 667 |       const f = factorArg || 0.25;
25690 | 668 |       const sign = f < 0 ? -1 : 1;
25691 | 669 |       const magnitude = Math.min(Math.abs(f), 1);
25692 | 670 | 
25693 | 671 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
25694 | 672 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
25695 | 673 |       const step = Math.max(120, Math.min(baseStep, 520));
25696 | 674 | 
25697 | 675 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
25698 | 676 | 
25699 | 677 |       if (isWindowContainer) window.scrollTo(0, target);
25700 | 678 |       else container.scrollTop = target;
25701 | 679 | 
25702 | 680 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
25703 | 681 | 
25704 | 682 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
25705 | 683 |       if (after === before) {
25706 | 684 |         try {
25707 | 685 |           window.scrollBy(0, sign * step);
25708 | 686 |         } catch {}
25709 | 687 |       }
25710 | 688 | 
25711 | 689 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
25712 | 690 | 
25713 | 691 |       return { before, after: after2, container: containerType, label: labelArg };
25714 | 692 |     },
25715 | 693 |     factor,
25716 | 694 |     label,
25717 | 695 |     postRootScript()
25718 | 696 |   );
25719 | 697 | 
25720 | 698 |   return info;
25721 | 699 | }
25722 | 700 | 
25723 | 701 | /* ============================================================
25724 | 702 |    =================== EXPAND (LEGACY) =========================
25725 | 703 |    ============================================================ */
25726 | 704 | 
25727 | 705 | async function expandAllComments(page) {
25728 | 706 |   if (!EXPAND_COMMENTS) return 0;
25729 | 707 | 
25730 | 708 |   let clicks = 0;
25731 | 709 |   for (let i = 0; i < 30; i++) {
25732 | 710 |     const didClick = await clickOneExpandButton(page);
25733 | 711 |     if (!didClick) break;
25734 | 712 |     clicks++;
25735 | 713 |     await sleepRandom(900, 1600);
25736 | 714 |   }
25737 | 715 |   return clicks;
25738 | 716 | }
25739 | 717 | 
25740 | 718 | /* ============================================================
25741 | 719 |    =================== HANDLER API =============================
25742 | 720 |    ============================================================ */
25743 | 721 | 
25744 | 722 | export async function prepare(page, url) {
25745 | 723 |   console.log(`[FB][ui:post] prepare: ${url}`);
25746 | 724 | 
25747 | 725 |   const ok = await safeGoto(page, url, "post", {
25748 | 726 |     waitUntil: "networkidle2",
25749 | 727 |     timeout: NAV_TIMEOUT_MS,
25750 | 728 |   });
25751 | 729 | 
25752 | 730 |   if (!ok) throw new Error("safeGoto-failed");
25753 | 731 | 
25754 | 732 |   const currentUrl = page.url();
25755 | 733 |   if (currentUrl.includes("/login")) {
25756 | 734 |     console.log("[FB][ui:post] /login redirect ‚Üí fbLogin() and back");
25757 | 735 |     await fbLogin(page);
25758 | 736 |     await sleepRandom(3000, 4500);
25759 | 737 | 
25760 | 738 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
25761 | 739 |     console.log("[FB][ui:post] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
25762 | 740 | 
25763 | 741 |     if (loggedAfterLogin) {
25764 | 742 |       await safeGoto(page, url, "post", {
25765 | 743 |         waitUntil: "networkidle2",
25766 | 744 |         timeout: NAV_TIMEOUT_MS,
25767 | 745 |       });
25768 | 746 |     }
25769 | 747 |   }
25770 | 748 | 
25771 | 749 |   await acceptCookies(page, "post-initial");
25772 | 750 | 
25773 | 751 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
25774 | 752 |   await sleepRandom(1200, 1800);
25775 | 753 |   await acceptCookies(page, "post");
25776 | 754 | 
25777 | 755 |   try {
25778 | 756 |     const logged = await checkIfLogged(page).catch(() => false);
25779 | 757 |     if (logged) await saveCookies(page);
25780 | 758 |   } catch {}
25781 | 759 | 
25782 | 760 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
25783 | 761 |   await scrollPost(page, 120).catch(() => {});
25784 | 762 |   await sleepRandom(600, 900);
25785 | 763 | }
25786 | 764 | 
25787 | 765 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
25788 | 766 |   try {
25789 | 767 |     await page.waitForFunction(
25790 | 768 |       ({ stableMs }) => {
25791 | 769 |         const now = performance.now();
25792 | 770 |         const y = window.scrollY || 0;
25793 | 771 | 
25794 | 772 |         if (!window.__fbScrollStop) {
25795 | 773 |           window.__fbScrollStop = { lastY: y, lastChange: now };
25796 | 774 |           return false;
25797 | 775 |         }
25798 | 776 | 
25799 | 777 |         const st = window.__fbScrollStop;
25800 | 778 | 
25801 | 779 |         if (Math.abs(y - st.lastY) > 0) {
25802 | 780 |           st.lastY = y;
25803 | 781 |           st.lastChange = now;
25804 | 782 |           return false;
25805 | 783 |         }
25806 | 784 | 
25807 | 785 |         return now - st.lastChange >= stableMs;
25808 | 786 |       },
25809 | 787 |       { timeout: timeoutMs },
25810 | 788 |       { stableMs }
25811 | 789 |     );
25812 | 790 |     return true;
25813 | 791 |   } catch {
25814 | 792 |     return false;
25815 | 793 |   }
25816 | 794 | }
25817 | 795 | 
25818 | 796 | export async function getCommentCount(page, url) {
25819 | 797 |   console.log("[FB][ui:post] getCommentCount‚Ä¶");
25820 | 798 | 
25821 | 799 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
25822 | 800 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
25823 | 801 | 
25824 | 802 |   const scopeSel = await getPostScopeSelector(page);
25825 | 803 | 
25826 | 804 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
25827 | 805 |   console.log("[FB][ui:post] filter all comments:", okFilter);
25828 | 806 | 
25829 | 807 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
25830 | 808 |   if (okFilter) {
25831 | 809 |     await sleepRandom(250, 450);
25832 | 810 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
25833 | 811 |   }
25834 | 812 | 
25835 | 813 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
25836 | 814 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
25837 | 815 | 
25838 | 816 |   console.log("[FB][ui:post] UI comments:", {
25839 | 817 |     source: ui?.source || "none",
25840 | 818 |     raw: ui?.raw || null,
25841 | 819 |     comments: ui?.comments ?? null,
25842 | 820 |   });
25843 | 821 | 
25844 | 822 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
25845 | 823 |     return ui.comments;
25846 | 824 |   }
25847 | 825 | 
25848 | 826 |   const anchors = await getCurrentCommentAnchorCount(page);
25849 | 827 |   console.log("[FB][ui:post] Fallback anchor count =", anchors);
25850 | 828 | 
25851 | 829 |   return anchors > 0 ? anchors : null;
25852 | 830 | }
25853 | 831 | 
25854 | 832 | export async function loadAllComments(page, { expectedTotal } = {}) {
25855 | 833 |   console.log(`[FB][ui:post] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"}`);
25856 | 834 | 
25857 | 835 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
25858 | 836 | 
25859 | 837 |   const MAX_ROUNDS = 600;
25860 | 838 |   const MAX_NO_PROGRESS = 60;
25861 | 839 | 
25862 | 840 |   let noProgress = 0;
25863 | 841 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
25864 | 842 | 
25865 | 843 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
25866 | 844 |     const before = lastAnchors;
25867 | 845 | 
25868 | 846 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
25869 | 847 |     const clicks = await expandAllComments(page);
25870 | 848 |     await sleepRandom(220, 420);
25871 | 849 | 
25872 | 850 |     const after = await getCurrentCommentAnchorCount(page);
25873 | 851 | 
25874 | 852 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
25875 | 853 | 
25876 | 854 |     if (progressed) noProgress = 0;
25877 | 855 |     else noProgress++;
25878 | 856 | 
25879 | 857 |     lastAnchors = after;
25880 | 858 | 
25881 | 859 |     if (round === 1 || round % 25 === 0) {
25882 | 860 |       console.log(
25883 | 861 |         `[FB][ui:post] round=${round} container=${scrollInfo.container} scrollTop: ${scrollInfo.before}‚Üí${scrollInfo.after} anchors: ${before}‚Üí${after} clicks=${clicks} noProgress=${noProgress}`
25884 | 862 |       );
25885 | 863 |     }
25886 | 864 | 
25887 | 865 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
25888 | 866 |       if (after >= expectedTotal && noProgress >= 2) {
25889 | 867 |         console.log("[FB][ui:post] stop reason=target-reached");
25890 | 868 |         break;
25891 | 869 |       }
25892 | 870 |     }
25893 | 871 | 
25894 | 872 |     if (noProgress >= MAX_NO_PROGRESS) {
25895 | 873 |       console.log("[FB][ui:post] stop reason=no-progress");
25896 | 874 |       break;
25897 | 875 |     }
25898 | 876 |   }
25899 | 877 | }
25900 | 878 | 
25901 | 879 | export async function extractComments(page, url) {
25902 | 880 |   const data = await page.evaluate(() => {
25903 | 881 |     function extractCommentId(u) {
25904 | 882 |       const m = u?.match(/comment_id=([^&]+)/);
25905 | 883 |       return m ? decodeURIComponent(m[1]) : null;
25906 | 884 |     }
25907 | 885 | 
25908 | 886 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
25909 | 887 |     const idToTimeMap = {};
25910 | 888 | 
25911 | 889 |     for (let i = 0; i < allLinks.length; i++) {
25912 | 890 |       const link = allLinks[i];
25913 | 891 |       const href = link.getAttribute("href") || "";
25914 | 892 |       const id = extractCommentId(href);
25915 | 893 |       if (!id) continue;
25916 | 894 | 
25917 | 895 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
25918 | 896 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
25919 | 897 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
25920 | 898 |           idToTimeMap[id] = timeText;
25921 | 899 |           break;
25922 | 900 |         }
25923 | 901 |       }
25924 | 902 |     }
25925 | 903 | 
25926 | 904 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
25927 | 905 | 
25928 | 906 |     const extracted = nodes
25929 | 907 |       .map((node, idx) => {
25930 | 908 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
25931 | 909 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
25932 | 910 | 
25933 | 911 |         const linkEl = node.querySelector('a[role="link"]');
25934 | 912 |         const href = linkEl?.getAttribute("href") || null;
25935 | 913 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
25936 | 914 | 
25937 | 915 |         const id = permalink ? extractCommentId(permalink) : null;
25938 | 916 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
25939 | 917 | 
25940 | 918 |         if (!author || !text) return null;
25941 | 919 | 
25942 | 920 |         return { id, author, text, time, permalink, pos: idx };
25943 | 921 |       })
25944 | 922 |       .filter(Boolean);
25945 | 923 | 
25946 | 924 |     return extracted;
25947 | 925 |   });
25948 | 926 | 
25949 | 927 |   console.log("[FB][ui:post] extractComments: count =", data?.length || 0);
25950 | 928 |   return Array.isArray(data) ? data : [];
25951 | 929 | }
25952 | 930 | 
25953 | 931 | export async function debugSnapshot(page) {
25954 | 932 |   const scopeSel = await getPostScopeSelector(page);
25955 | 933 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
25956 | 934 | 
25957 | 935 |   return {
25958 | 936 |     scopeSel,
25959 | 937 |     anchors,
25960 | 938 |     url: page.url(),
25961 | 939 |   };
25962 | 940 | }
25963 | 941 | 
25964 | ```
25965 | 
25966 | ---
25967 | 
25968 | ### üìÑ ≈öcie≈ºka: `export_chat_context/13__photo.js`
25969 | **Typ:** JavaScript/tekst  
25970 | **Opis:** Plik projektu (kod/konfiguracja).  
25971 | 
25972 | ```js
25973 |    1 | // src/fb/ui/photo.js
25974 |    2 | import { safeGoto } from "../../utils/navigation.js";
25975 |    3 | import { sleepRandom } from "../../utils/sleep.js";
25976 |    4 | import { scrollPost } from "../scroll.js";
25977 |    5 | import { acceptCookies, saveCookies } from "../cookies.js";
25978 |    6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
25979 |    7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
25980 |    8 | 
25981 |    9 | export const type = "photo";
25982 |   10 | 
25983 |   11 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
25984 |   12 | 
25985 |   13 | /**
25986 |   14 |  * WA≈ªNE:
25987 |   15 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
25988 |   16 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
25989 |   17 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
25990 |   18 |  */
25991 |   19 | const PACE_CFG =
25992 |   20 |   PACE === "server"
25993 |   21 |     ? {
25994 |   22 |         // delikatnie wolniej na serwerze (render/CPU)
25995 |   23 |         stepJitterMinMs: 140,
25996 |   24 |         stepJitterMaxMs: 260,
25997 |   25 | 
25998 |   26 |         afterScrollMinMs: 260,
25999 |   27 |         afterScrollMaxMs: 520,
26000 |   28 | 
26001 |   29 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
26002 |   30 |         effectWaitMs: 5200,
26003 |   31 | 
26004 |   32 |         scrollPx: 140,
26005 |   33 | 
26006 |   34 |         // bonusowe kliki, ale event-driven
26007 |   35 |         bonusClickTries: 2,
26008 |   36 |         bonusClickDelayMinMs: 120,
26009 |   37 |         bonusClickDelayMaxMs: 220,
26010 |   38 | 
26011 |   39 |         // HARD BOTTOM (sprawdzane rzadko)
26012 |   40 |         hardBottomEpsPx: 10,
26013 |   41 |         hardBottomStableNeed: 4,
26014 |   42 |         hardBottomStableDelayMinMs: 320,
26015 |   43 |         hardBottomStableDelayMaxMs: 560,
26016 |   44 |       }
26017 |   45 |     : {
26018 |   46 |         // lokalnie szybciej
26019 |   47 |         stepJitterMinMs: 90,
26020 |   48 |         stepJitterMaxMs: 190,
26021 |   49 | 
26022 |   50 |         afterScrollMinMs: 180,
26023 |   51 |         afterScrollMaxMs: 420,
26024 |   52 | 
26025 |   53 |         effectWaitMs: 4200,
26026 |   54 | 
26027 |   55 |         scrollPx: 160,
26028 |   56 | 
26029 |   57 |         bonusClickTries: 2,
26030 |   58 |         bonusClickDelayMinMs: 90,
26031 |   59 |         bonusClickDelayMaxMs: 180,
26032 |   60 | 
26033 |   61 |         hardBottomEpsPx: 10,
26034 |   62 |         hardBottomStableNeed: 4,
26035 |   63 |         hardBottomStableDelayMinMs: 240,
26036 |   64 |         hardBottomStableDelayMaxMs: 420,
26037 |   65 |       };
26038 |   66 | 
26039 |   67 | export function matchesUrl(url) {
26040 |   68 |   try {
26041 |   69 |     const u = new URL(url);
26042 |   70 |     const path = (u.pathname || "").toLowerCase();
26043 |   71 | 
26044 |   72 |     if (path.includes("photo.php")) return true;
26045 |   73 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
26046 |   74 |     if (u.searchParams.has("fbid")) return true;
26047 |   75 | 
26048 |   76 |     return false;
26049 |   77 |   } catch {
26050 |   78 |     const lower = (url || "").toLowerCase();
26051 |   79 |     if (lower.includes("photo.php")) return true;
26052 |   80 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
26053 |   81 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
26054 |   82 |     return false;
26055 |   83 |   }
26056 |   84 | }
26057 |   85 | 
26058 |   86 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
26059 |   87 | 
26060 |   88 | async function clickAllCommentsInMenu(page) {
26061 |   89 |   const result = await page.evaluate(() => {
26062 |   90 |     const menu =
26063 |   91 |       document.querySelector("div[role='menu']") ||
26064 |   92 |       document.querySelector("div[role='dialog']");
26065 |   93 | 
26066 |   94 |     if (!menu) return { clicked: false, noMenu: true };
26067 |   95 | 
26068 |   96 |     const items = Array.from(
26069 |   97 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
26070 |   98 |     );
26071 |   99 | 
26072 |  100 |     const opt = items.find((el) => {
26073 |  101 |       const t = (el.textContent || "").trim().toLowerCase();
26074 |  102 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
26075 |  103 |     });
26076 |  104 | 
26077 |  105 |     if (!opt) return { clicked: false, noMenu: false };
26078 |  106 | 
26079 |  107 |     opt.click();
26080 |  108 |     setTimeout(() => {
26081 |  109 |       try {
26082 |  110 |         document.body.click();
26083 |  111 |       } catch {}
26084 |  112 |     }, 50);
26085 |  113 | 
26086 |  114 |     return { clicked: true, noMenu: false };
26087 |  115 |   });
26088 |  116 | 
26089 |  117 |   if (result.clicked) {
26090 |  118 |     await sleepRandom(180, 320);
26091 |  119 |     await page
26092 |  120 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
26093 |  121 |       .catch(() => {});
26094 |  122 |   }
26095 |  123 | 
26096 |  124 |   return result;
26097 |  125 | }
26098 |  126 | 
26099 |  127 | async function switchCommentsFilterToAll(page) {
26100 |  128 |   console.log("[FB][ui:photo][filter] switch -> all comments");
26101 |  129 | 
26102 |  130 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
26103 |  131 |   if (menuAlreadyOpen) {
26104 |  132 |     const r = await clickAllCommentsInMenu(page);
26105 |  133 |     return !!r.clicked;
26106 |  134 |   }
26107 |  135 | 
26108 |  136 |   const pre = await page.evaluate(() => {
26109 |  137 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
26110 |  138 |     let filterEl = null;
26111 |  139 |     let labelText = "";
26112 |  140 | 
26113 |  141 |     for (const el of els) {
26114 |  142 |       const t = (el.textContent || "").trim();
26115 |  143 |       if (!t) continue;
26116 |  144 |       const low = t.toLowerCase();
26117 |  145 |       if (
26118 |  146 |         low === "najtrafniejsze" ||
26119 |  147 |         low === "most relevant" ||
26120 |  148 |         low === "wszystkie komentarze" ||
26121 |  149 |         low === "all comments"
26122 |  150 |       ) {
26123 |  151 |         filterEl = el;
26124 |  152 |         labelText = low;
26125 |  153 |         break;
26126 |  154 |       }
26127 |  155 |     }
26128 |  156 | 
26129 |  157 |     if (!filterEl) return { state: "not-found" };
26130 |  158 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
26131 |  159 |       return { state: "already-all" };
26132 |  160 |     }
26133 |  161 | 
26134 |  162 |     filterEl.click();
26135 |  163 |     return { state: "clicked-filter" };
26136 |  164 |   });
26137 |  165 | 
26138 |  166 |   if (pre.state === "not-found") return false;
26139 |  167 |   if (pre.state === "already-all") return true;
26140 |  168 | 
26141 |  169 |   await sleepRandom(120, 220);
26142 |  170 |   const r = await clickAllCommentsInMenu(page);
26143 |  171 |   if (r.clicked) return true;
26144 |  172 | 
26145 |  173 |   const afterLabelIsAll = await page.evaluate(() => {
26146 |  174 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
26147 |  175 |     return els.some((el) => {
26148 |  176 |       const t = (el.textContent || "").trim().toLowerCase();
26149 |  177 |       return t === "wszystkie komentarze" || t === "all comments";
26150 |  178 |     });
26151 |  179 |   });
26152 |  180 | 
26153 |  181 |   return afterLabelIsAll;
26154 |  182 | }
26155 |  183 | 
26156 |  184 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
26157 |  185 | 
26158 |  186 | async function getCommentsRootHandle(page) {
26159 |  187 |   const handle = await page.evaluateHandle(() => {
26160 |  188 |     const norm = (s) =>
26161 |  189 |       String(s || "")
26162 |  190 |         .replace(/\u00a0/g, " ")
26163 |  191 |         .replace(/\s+/g, " ")
26164 |  192 |         .trim()
26165 |  193 |         .toLowerCase();
26166 |  194 | 
26167 |  195 |     const isVisible = (el) => {
26168 |  196 |       if (!el) return false;
26169 |  197 |       try {
26170 |  198 |         const r = el.getBoundingClientRect();
26171 |  199 |         return r.width > 2 && r.height > 2;
26172 |  200 |       } catch {
26173 |  201 |         return true;
26174 |  202 |       }
26175 |  203 |     };
26176 |  204 | 
26177 |  205 |     const isMoreCommentsBtn = (el) => {
26178 |  206 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
26179 |  207 |       if (!t) return false;
26180 |  208 |       return (
26181 |  209 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
26182 |  210 |         t.includes("zobacz wiƒôcej komentarzy") ||
26183 |  211 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
26184 |  212 |         t.includes("view more comments") ||
26185 |  213 |         t.includes("view previous comments")
26186 |  214 |       );
26187 |  215 |     };
26188 |  216 | 
26189 |  217 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
26190 |  218 |       isVisible
26191 |  219 |     );
26192 |  220 |     const keyBtn = btns.find(isMoreCommentsBtn);
26193 |  221 | 
26194 |  222 |     if (keyBtn) {
26195 |  223 |       const dlg = keyBtn.closest?.("div[role='dialog']");
26196 |  224 |       if (dlg) return dlg;
26197 |  225 | 
26198 |  226 |       let cur = keyBtn.parentElement;
26199 |  227 |       for (let i = 0; i < 20 && cur; i++) {
26200 |  228 |         if (cur.matches?.("article,main,section,div")) return cur;
26201 |  229 |         cur = cur.parentElement;
26202 |  230 |       }
26203 |  231 |     }
26204 |  232 | 
26205 |  233 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
26206 |  234 |     const dlg2 = dialogs.find((d) => {
26207 |  235 |       const t = norm(d.innerText || d.textContent);
26208 |  236 |       if (!t) return false;
26209 |  237 |       if (t.includes("powiadomienia")) return false;
26210 |  238 |       if (t.includes("szukaj znajomych")) return false;
26211 |  239 |       return (
26212 |  240 |         t.includes("najtrafniejsze") ||
26213 |  241 |         t.includes("most relevant") ||
26214 |  242 |         t.includes("komentarz") ||
26215 |  243 |         t.includes("comment")
26216 |  244 |       );
26217 |  245 |     });
26218 |  246 |     if (dlg2) return dlg2;
26219 |  247 | 
26220 |  248 |     return document.body;
26221 |  249 |   });
26222 |  250 | 
26223 |  251 |   return handle;
26224 |  252 | }
26225 |  253 | 
26226 |  254 | async function getCommentsScrollHandle(page, rootHandle) {
26227 |  255 |   const handle = await page.evaluateHandle((root) => {
26228 |  256 |     const isVisible = (el) => {
26229 |  257 |       if (!el) return false;
26230 |  258 |       try {
26231 |  259 |         const r = el.getBoundingClientRect();
26232 |  260 |         return r.width > 2 && r.height > 2;
26233 |  261 |       } catch {
26234 |  262 |         return true;
26235 |  263 |       }
26236 |  264 |     };
26237 |  265 | 
26238 |  266 |     const canScrollByTest = (el) => {
26239 |  267 |       try {
26240 |  268 |         if (!el) return false;
26241 |  269 |         const h = el.clientHeight || 0;
26242 |  270 |         const sh = el.scrollHeight || 0;
26243 |  271 |         if (sh <= h + 40) return false;
26244 |  272 | 
26245 |  273 |         const before = el.scrollTop ?? 0;
26246 |  274 |         el.scrollTop = before + 80;
26247 |  275 |         const after = el.scrollTop ?? before;
26248 |  276 |         el.scrollTop = before;
26249 |  277 | 
26250 |  278 |         return after !== before;
26251 |  279 |       } catch {
26252 |  280 |         return false;
26253 |  281 |       }
26254 |  282 |     };
26255 |  283 | 
26256 |  284 |     const closestScrollable = (start) => {
26257 |  285 |       let cur = start;
26258 |  286 |       for (let i = 0; i < 28 && cur; i++) {
26259 |  287 |         if (canScrollByTest(cur)) return cur;
26260 |  288 |         cur = cur.parentElement;
26261 |  289 |       }
26262 |  290 |       return null;
26263 |  291 |     };
26264 |  292 | 
26265 |  293 |     const scope = root || document;
26266 |  294 | 
26267 |  295 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
26268 |  296 |     if (outer) {
26269 |  297 |       const sc = closestScrollable(outer);
26270 |  298 |       if (sc) return sc;
26271 |  299 |     }
26272 |  300 | 
26273 |  301 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
26274 |  302 |       .filter(isVisible)
26275 |  303 |       .slice(0, 25000);
26276 |  304 | 
26277 |  305 |     let best = null;
26278 |  306 |     let bestDelta = -1;
26279 |  307 |     for (const el of candidates) {
26280 |  308 |       if (!canScrollByTest(el)) continue;
26281 |  309 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
26282 |  310 |       if (delta > bestDelta) {
26283 |  311 |         bestDelta = delta;
26284 |  312 |         best = el;
26285 |  313 |       }
26286 |  314 |     }
26287 |  315 | 
26288 |  316 |     return best || null;
26289 |  317 |   }, rootHandle);
26290 |  318 | 
26291 |  319 |   return handle;
26292 |  320 | }
26293 |  321 | 
26294 |  322 | /* ======================================================================== */
26295 |  323 | 
26296 |  324 | export async function prepare(page, url) {
26297 |  325 |   console.log(`[FB][ui:photo] prepare: ${url}`);
26298 |  326 | 
26299 |  327 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
26300 |  328 |   if (!ok) throw new Error("safeGoto-failed");
26301 |  329 | 
26302 |  330 |   if (page.url().includes("/login")) {
26303 |  331 |     console.log("[FB][ui:photo] /login ‚Äì fbLogin + re-enter.");
26304 |  332 |     await fbLogin(page);
26305 |  333 |     await sleepRandom(2500, 4000);
26306 |  334 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
26307 |  335 |   }
26308 |  336 | 
26309 |  337 |   await acceptCookies(page, "photo-initial");
26310 |  338 | 
26311 |  339 |   const logged = await checkIfLogged(page).catch(() => false);
26312 |  340 |   if (!logged) {
26313 |  341 |     console.log("[FB][ui:photo] not logged ‚Äì fbLogin().");
26314 |  342 |     await fbLogin(page);
26315 |  343 |     await sleepRandom(2500, 4000);
26316 |  344 |   }
26317 |  345 | 
26318 |  346 |   await ensureLoggedInOnPostOverlay(page);
26319 |  347 |   await acceptCookies(page, "photo");
26320 |  348 | 
26321 |  349 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
26322 |  350 |   if (loggedFinal) await saveCookies(page);
26323 |  351 | }
26324 |  352 | 
26325 |  353 | function parseNumberLikeNode(str) {
26326 |  354 |   if (!str) return null;
26327 |  355 | 
26328 |  356 |   const cleaned = String(str)
26329 |  357 |     .toLowerCase()
26330 |  358 |     .replace(/\u00a0/g, " ")
26331 |  359 |     .replace(/\s+/g, " ")
26332 |  360 |     .trim();
26333 |  361 | 
26334 |  362 |   const plain = cleaned.replace(/[^\d]/g, "");
26335 |  363 |   if (/^\d+$/.test(plain)) {
26336 |  364 |     const n = Number(plain);
26337 |  365 |     return Number.isFinite(n) ? n : null;
26338 |  366 |   }
26339 |  367 | 
26340 |  368 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
26341 |  369 |   if (m) {
26342 |  370 |     const base = Number(m[1].replace(",", "."));
26343 |  371 |     if (Number.isFinite(base)) return Math.round(base * 1000);
26344 |  372 |   }
26345 |  373 | 
26346 |  374 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
26347 |  375 |   if (m2) {
26348 |  376 |     const base = Number(m2[1].replace(",", "."));
26349 |  377 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
26350 |  378 |   }
26351 |  379 | 
26352 |  380 |   return null;
26353 |  381 | }
26354 |  382 | 
26355 |  383 | async function getPhotoUiCountFromChip(page, rootHandle) {
26356 |  384 |   const res = await page
26357 |  385 |     .evaluate((root) => {
26358 |  386 |       const scope = root || document;
26359 |  387 | 
26360 |  388 |       const norm = (s) =>
26361 |  389 |         String(s || "")
26362 |  390 |           .replace(/\u00a0/g, " ")
26363 |  391 |           .replace(/\s+/g, " ")
26364 |  392 |           .trim();
26365 |  393 | 
26366 |  394 |       const parseNum = (s) => {
26367 |  395 |         const t = norm(s);
26368 |  396 |         if (!t) return null;
26369 |  397 | 
26370 |  398 |         const plain = t.replace(/[^\d]/g, "");
26371 |  399 |         if (/^\d+$/.test(plain)) return Number(plain);
26372 |  400 | 
26373 |  401 |         const lower = t.toLowerCase();
26374 |  402 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
26375 |  403 |         if (m) {
26376 |  404 |           const base = Number(m[1].replace(",", "."));
26377 |  405 |           if (Number.isFinite(base)) return Math.round(base * 1000);
26378 |  406 |         }
26379 |  407 | 
26380 |  408 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
26381 |  409 |         if (m2) {
26382 |  410 |           const base = Number(m2[1].replace(",", "."));
26383 |  411 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
26384 |  412 |         }
26385 |  413 | 
26386 |  414 |         return null;
26387 |  415 |       };
26388 |  416 | 
26389 |  417 |       const isVisible = (el) => {
26390 |  418 |         if (!el) return false;
26391 |  419 |         const r = el.getBoundingClientRect();
26392 |  420 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
26393 |  421 |       };
26394 |  422 | 
26395 |  423 |       const commentBtn = Array.from(
26396 |  424 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
26397 |  425 |       ).find((el) => {
26398 |  426 |         const t = norm(el.textContent).toLowerCase();
26399 |  427 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
26400 |  428 |       });
26401 |  429 | 
26402 |  430 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
26403 |  431 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
26404 |  432 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
26405 |  433 | 
26406 |  434 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
26407 |  435 |         .filter(isVisible)
26408 |  436 |         .slice(0, 5000);
26409 |  437 | 
26410 |  438 |       let best = null;
26411 |  439 |       let bestScore = -Infinity;
26412 |  440 | 
26413 |  441 |       for (const el of candidates) {
26414 |  442 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
26415 |  443 |         if (!hasIcon) continue;
26416 |  444 | 
26417 |  445 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
26418 |  446 |         let num = null;
26419 |  447 |         let raw = null;
26420 |  448 | 
26421 |  449 |         for (const sp of spans) {
26422 |  450 |           const t = norm(sp.textContent);
26423 |  451 |           if (!t) continue;
26424 |  452 |           if (t.length > 24) continue;
26425 |  453 | 
26426 |  454 |           const n = parseNum(t);
26427 |  455 |           if (typeof n === "number" && Number.isFinite(n)) {
26428 |  456 |             if (n <= 0 || n > 10000000) continue;
26429 |  457 |             num = n;
26430 |  458 |             raw = t;
26431 |  459 |             break;
26432 |  460 |           }
26433 |  461 |         }
26434 |  462 | 
26435 |  463 |         if (num == null) continue;
26436 |  464 | 
26437 |  465 |         const r = el.getBoundingClientRect();
26438 |  466 |         const cx = r.left + r.width / 2;
26439 |  467 |         const cy = r.top + r.height / 2;
26440 |  468 | 
26441 |  469 |         let score = 0;
26442 |  470 | 
26443 |  471 |         if (anchorCx != null && anchorCy != null) {
26444 |  472 |           const dx = cx - anchorCx;
26445 |  473 |           const dy = cy - anchorCy;
26446 |  474 |           const dist = Math.sqrt(dx * dx + dy * dy);
26447 |  475 |           score -= dist;
26448 |  476 |         }
26449 |  477 | 
26450 |  478 |         const textLen = norm(el.textContent).length;
26451 |  479 |         score -= Math.min(400, textLen);
26452 |  480 | 
26453 |  481 |         score += Math.min(200, Math.log10(num + 1) * 120);
26454 |  482 | 
26455 |  483 |         if (score > bestScore) {
26456 |  484 |           bestScore = score;
26457 |  485 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
26458 |  486 |         }
26459 |  487 |       }
26460 |  488 | 
26461 |  489 |       return best;
26462 |  490 |     }, rootHandle)
26463 |  491 |     .catch(() => null);
26464 |  492 | 
26465 |  493 |   if (!res || typeof res.count !== "number") return null;
26466 |  494 |   return { count: res.count, raw: res.raw, dbg: res };
26467 |  495 | }
26468 |  496 | 
26469 |  497 | export async function getCommentCount(page, url) {
26470 |  498 |   console.log("[FB][ui:photo] getCommentCount‚Ä¶");
26471 |  499 | 
26472 |  500 |   await scrollPost(page, 220);
26473 |  501 |   await sleepRandom(220, 420);
26474 |  502 | 
26475 |  503 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
26476 |  504 |   console.log(`[FB][ui:photo] filter all comments: ${okFilter}`);
26477 |  505 | 
26478 |  506 |   // mikro settle po filtrze (bez mulenia)
26479 |  507 |   await sleepRandom(220, 420);
26480 |  508 | 
26481 |  509 |   const rootHandle = await getCommentsRootHandle(page);
26482 |  510 | 
26483 |  511 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
26484 |  512 |   if (chip?.count != null) {
26485 |  513 |     console.log("[FB][ui:photo] UI count (chip):", chip);
26486 |  514 |   }
26487 |  515 | 
26488 |  516 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
26489 |  517 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
26490 |  518 | 
26491 |  519 |   const loaded = await page
26492 |  520 |     .evaluate((root) => {
26493 |  521 |       const scope = root || document;
26494 |  522 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
26495 |  523 |       const ids = new Set();
26496 |  524 |       for (const a of as) {
26497 |  525 |         const href = a.getAttribute("href") || "";
26498 |  526 |         const m = href.match(/comment_id=([^&]+)/);
26499 |  527 |         if (m && m[1]) ids.add(m[1]);
26500 |  528 |       }
26501 |  529 |       return ids.size || null;
26502 |  530 |     }, rootHandle)
26503 |  531 |     .catch(() => null);
26504 |  532 | 
26505 |  533 |   let total = null;
26506 |  534 |   let source = "none";
26507 |  535 | 
26508 |  536 |   if (chip?.count != null) {
26509 |  537 |     total = chip.count;
26510 |  538 |     source = "ui-photo-chip";
26511 |  539 |   } else if (infoCount != null) {
26512 |  540 |     total = infoCount;
26513 |  541 |     source = uiInfo?.source || "uicommentinfo";
26514 |  542 |   } else if (loaded != null) {
26515 |  543 |     total = loaded;
26516 |  544 |     source = "loaded-comment_id";
26517 |  545 |   }
26518 |  546 | 
26519 |  547 |   console.log("[FB][ui:photo] UI comments:", {
26520 |  548 |     source,
26521 |  549 |     chip: chip?.count ?? null,
26522 |  550 |     uiInfoSource: uiInfo?.source ?? null,
26523 |  551 |     uiInfoRaw: uiInfo?.raw ?? null,
26524 |  552 |     uiInfoCount: infoCount,
26525 |  553 |     loaded,
26526 |  554 |     chosen: total,
26527 |  555 |   });
26528 |  556 | 
26529 |  557 |   try {
26530 |  558 |     await rootHandle.dispose?.();
26531 |  559 |   } catch {}
26532 |  560 | 
26533 |  561 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
26534 |  562 |   await sleepRandom(180, 340);
26535 |  563 | 
26536 |  564 |   return total;
26537 |  565 | }
26538 |  566 | 
26539 |  567 | export async function loadAllComments(page, { expectedTotal } = {}) {
26540 |  568 |   console.log(`[FB][ui:photo] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
26541 |  569 | 
26542 |  570 |   const MAX_STEPS = 900;
26543 |  571 |   const MAX_NO_PROGRESS = 28;
26544 |  572 | 
26545 |  573 |   let noProgress = 0;
26546 |  574 | 
26547 |  575 |   const rootHandle = await getCommentsRootHandle(page);
26548 |  576 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
26549 |  577 | 
26550 |  578 |   const shortBtn = (t) => {
26551 |  579 |     const s = String(t || "").replace(/\s+/g, " ").trim();
26552 |  580 |     if (s.length <= 90) return s;
26553 |  581 |     return s.slice(0, 90) + "‚Ä¶";
26554 |  582 |   };
26555 |  583 | 
26556 |  584 |   async function countAnchors() {
26557 |  585 |     return page.evaluate((root) => {
26558 |  586 |       const scope = root || document;
26559 |  587 | 
26560 |  588 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
26561 |  589 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
26562 |  590 | 
26563 |  591 |       const uniq = (arr, param) => {
26564 |  592 |         const ids = new Set();
26565 |  593 |         for (const a of arr) {
26566 |  594 |           const href = a.getAttribute("href") || "";
26567 |  595 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
26568 |  596 |           if (m && m[1]) ids.add(m[1]);
26569 |  597 |         }
26570 |  598 |         return ids.size;
26571 |  599 |       };
26572 |  600 | 
26573 |  601 |       return {
26574 |  602 |         commentsAnchors: uniq(commentAs, "comment_id"),
26575 |  603 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
26576 |  604 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
26577 |  605 |       };
26578 |  606 |     }, rootHandle);
26579 |  607 |   }
26580 |  608 | 
26581 |  609 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
26582 |  610 |     try {
26583 |  611 |       const info = await page.evaluate((root, scroller, px) => {
26584 |  612 |         const pick =
26585 |  613 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
26586 |  614 | 
26587 |  615 |         const before =
26588 |  616 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
26589 |  617 | 
26590 |  618 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
26591 |  619 |         else window.scrollBy(0, px);
26592 |  620 | 
26593 |  621 |         const after =
26594 |  622 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
26595 |  623 | 
26596 |  624 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
26597 |  625 |       }, rootHandle, scrollHandle, pixels);
26598 |  626 | 
26599 |  627 |       if (!info?.moved) {
26600 |  628 |         console.log(
26601 |  629 |           `[FB][ui:photo][scroll] NO-MOVE tag=${info?.tag} before=${info?.before} after=${info?.after}`
26602 |  630 |         );
26603 |  631 |       }
26604 |  632 |     } catch {
26605 |  633 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
26606 |  634 |     }
26607 |  635 | 
26608 |  636 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
26609 |  637 |   }
26610 |  638 | 
26611 |  639 |   async function getScrollMetrics() {
26612 |  640 |     return page.evaluate((root, scroller) => {
26613 |  641 |       const pick =
26614 |  642 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
26615 |  643 | 
26616 |  644 |       const isEl = pick && typeof pick.scrollHeight === "number";
26617 |  645 | 
26618 |  646 |       if (!isEl) {
26619 |  647 |         const se = document.scrollingElement || document.documentElement || document.body;
26620 |  648 |         return {
26621 |  649 |           tag: "WINDOW",
26622 |  650 |           scrollTop: window.scrollY || 0,
26623 |  651 |           scrollHeight: se?.scrollHeight || 0,
26624 |  652 |           clientHeight: window.innerHeight || 0,
26625 |  653 |         };
26626 |  654 |       }
26627 |  655 | 
26628 |  656 |       return {
26629 |  657 |         tag: pick.tagName || "UNKNOWN",
26630 |  658 |         scrollTop: pick.scrollTop || 0,
26631 |  659 |         scrollHeight: pick.scrollHeight || 0,
26632 |  660 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
26633 |  661 |       };
26634 |  662 |     }, rootHandle, scrollHandle);
26635 |  663 |   }
26636 |  664 | 
26637 |  665 |   async function hasLoadMoreButtons() {
26638 |  666 |     return page.evaluate((root) => {
26639 |  667 |       const scope = root || document;
26640 |  668 | 
26641 |  669 |       const norm = (s) =>
26642 |  670 |         String(s || "")
26643 |  671 |           .replace(/\u00a0/g, " ")
26644 |  672 |           .replace(/\s+/g, " ")
26645 |  673 |           .trim()
26646 |  674 |           .toLowerCase();
26647 |  675 | 
26648 |  676 |       const isVisible = (el) => {
26649 |  677 |         if (!el) return false;
26650 |  678 |         const r = el.getBoundingClientRect();
26651 |  679 |         if (r.width < 2 || r.height < 2) return false;
26652 |  680 |         return r.bottom > 0 && r.top < window.innerHeight;
26653 |  681 |       };
26654 |  682 | 
26655 |  683 |       const nodesBtn = Array.from(
26656 |  684 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
26657 |  685 |       ).filter(isVisible);
26658 |  686 | 
26659 |  687 |       return nodesBtn.some((el) => {
26660 |  688 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
26661 |  689 | 
26662 |  690 |         if (
26663 |  691 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
26664 |  692 |           t.includes("zobacz wiƒôcej komentarzy") ||
26665 |  693 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
26666 |  694 |           t.includes("view more comments") ||
26667 |  695 |           t.includes("view previous comments")
26668 |  696 |         )
26669 |  697 |           return true;
26670 |  698 | 
26671 |  699 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
26672 |  700 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
26673 |  701 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
26674 |  702 |         if (t.includes("view") && t.includes("repl")) return true;
26675 |  703 |         if (t.includes("see") && t.includes("repl")) return true;
26676 |  704 | 
26677 |  705 |         return false;
26678 |  706 |       });
26679 |  707 |     }, rootHandle);
26680 |  708 |   }
26681 |  709 | 
26682 |  710 |   function isHardBottom(m) {
26683 |  711 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
26684 |  712 |     const top = Number(m?.scrollTop || 0);
26685 |  713 |     const ch = Number(m?.clientHeight || 0);
26686 |  714 |     const sh = Number(m?.scrollHeight || 0);
26687 |  715 |     if (!sh || !ch) return false;
26688 |  716 |     return top + ch >= sh - eps;
26689 |  717 |   }
26690 |  718 | 
26691 |  719 |   let bottomStable = 0;
26692 |  720 |   let lastBottomScrollHeight = null;
26693 |  721 | 
26694 |  722 |   async function updateHardBottomStability() {
26695 |  723 |     const m1 = await getScrollMetrics().catch(() => null);
26696 |  724 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
26697 |  725 | 
26698 |  726 |     const atBottom = isHardBottom(m1);
26699 |  727 | 
26700 |  728 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
26701 |  729 | 
26702 |  730 |     const m2 = await getScrollMetrics().catch(() => m1);
26703 |  731 |     const atBottom2 = isHardBottom(m2);
26704 |  732 | 
26705 |  733 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
26706 |  734 | 
26707 |  735 |     const sh = Number(m2?.scrollHeight || 0);
26708 |  736 |     const shStable =
26709 |  737 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
26710 |  738 | 
26711 |  739 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
26712 |  740 |     else bottomStable = 0;
26713 |  741 | 
26714 |  742 |     lastBottomScrollHeight = sh;
26715 |  743 | 
26716 |  744 |     return {
26717 |  745 |       atBottom: atBottom && atBottom2,
26718 |  746 |       stable: bottomStable,
26719 |  747 |       tag: m2?.tag || "UNKNOWN",
26720 |  748 |       anyMore,
26721 |  749 |       scrollTop: m2?.scrollTop,
26722 |  750 |       clientHeight: m2?.clientHeight,
26723 |  751 |       scrollHeight: m2?.scrollHeight,
26724 |  752 |     };
26725 |  753 |   }
26726 |  754 | 
26727 |  755 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
26728 |  756 |   async function waitForEffect(beforeCounts, kind) {
26729 |  757 |     const timeout = PACE_CFG.effectWaitMs;
26730 |  758 | 
26731 |  759 |     const ok = await page
26732 |  760 |       .waitForFunction(
26733 |  761 |         (root, before, kindArg) => {
26734 |  762 |           const scope = root || document;
26735 |  763 | 
26736 |  764 |           const countUniq = (sel, param) => {
26737 |  765 |             const as = Array.from(scope.querySelectorAll(sel));
26738 |  766 |             const ids = new Set();
26739 |  767 |             for (const a of as) {
26740 |  768 |               const href = a.getAttribute("href") || "";
26741 |  769 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
26742 |  770 |               if (m && m[1]) ids.add(m[1]);
26743 |  771 |             }
26744 |  772 |             return ids.size;
26745 |  773 |           };
26746 |  774 | 
26747 |  775 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
26748 |  776 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
26749 |  777 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
26750 |  778 | 
26751 |  779 |           if (
26752 |  780 |             commentsAnchors > (before?.commentsAnchors || 0) ||
26753 |  781 |             replyAnchors > (before?.replyAnchors || 0) ||
26754 |  782 |             nodes > (before?.nodes || 0)
26755 |  783 |           ) {
26756 |  784 |             return true;
26757 |  785 |           }
26758 |  786 | 
26759 |  787 |           const norm = (s) =>
26760 |  788 |             String(s || "")
26761 |  789 |               .replace(/\u00a0/g, " ")
26762 |  790 |               .replace(/\s+/g, " ")
26763 |  791 |               .trim()
26764 |  792 |               .toLowerCase();
26765 |  793 | 
26766 |  794 |           const isVisible = (el) => {
26767 |  795 |             if (!el) return false;
26768 |  796 |             const r = el.getBoundingClientRect();
26769 |  797 |             if (r.width < 2 || r.height < 2) return false;
26770 |  798 |             return r.bottom > 0 && r.top < window.innerHeight;
26771 |  799 |           };
26772 |  800 | 
26773 |  801 |           const nodesBtn = Array.from(
26774 |  802 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
26775 |  803 |           ).filter(isVisible);
26776 |  804 | 
26777 |  805 |           const stillThere =
26778 |  806 |             kindArg === "comments"
26779 |  807 |               ? nodesBtn.some((el) => {
26780 |  808 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
26781 |  809 |                   return (
26782 |  810 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
26783 |  811 |                     t.includes("zobacz wiƒôcej komentarzy") ||
26784 |  812 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
26785 |  813 |                     t.includes("view more comments") ||
26786 |  814 |                     t.includes("view previous comments")
26787 |  815 |                   );
26788 |  816 |                 })
26789 |  817 |               : nodesBtn.some((el) => {
26790 |  818 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
26791 |  819 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
26792 |  820 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
26793 |  821 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
26794 |  822 |                   if (t.includes("view") && t.includes("repl")) return true;
26795 |  823 |                   if (t.includes("see") && t.includes("repl")) return true;
26796 |  824 |                   return false;
26797 |  825 |                 });
26798 |  826 | 
26799 |  827 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
26800 |  828 |           return !stillThere;
26801 |  829 |         },
26802 |  830 |         { timeout, polling: 120 },
26803 |  831 |         rootHandle,
26804 |  832 |         beforeCounts,
26805 |  833 |         kind
26806 |  834 |       )
26807 |  835 |       .then(() => true)
26808 |  836 |       .catch(() => false);
26809 |  837 | 
26810 |  838 |     return ok;
26811 |  839 |   }
26812 |  840 | 
26813 |  841 |   async function bonusClicks(kind, beforeCounts) {
26814 |  842 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
26815 |  843 |     if (!tries) return 0;
26816 |  844 | 
26817 |  845 |     let clicked = 0;
26818 |  846 |     let curBefore = beforeCounts;
26819 |  847 | 
26820 |  848 |     for (let i = 0; i < tries; i++) {
26821 |  849 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
26822 |  850 | 
26823 |  851 |       const res =
26824 |  852 |         kind === "replies"
26825 |  853 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
26826 |  854 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
26827 |  855 | 
26828 |  856 |       if (!res?.clicked) break;
26829 |  857 | 
26830 |  858 |       clicked++;
26831 |  859 | 
26832 |  860 |       // mikro-oddech, potem czekamy na efekt
26833 |  861 |       await sleepRandom(80, 140);
26834 |  862 |       await waitForEffect(curBefore, kind);
26835 |  863 | 
26836 |  864 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
26837 |  865 |       curBefore = await countAnchors().catch(() => curBefore);
26838 |  866 | 
26839 |  867 |       // minimalny settle po do≈Çadowaniu
26840 |  868 |       await sleepRandom(90, 170);
26841 |  869 |     }
26842 |  870 | 
26843 |  871 |     return clicked;
26844 |  872 |   }
26845 |  873 | 
26846 |  874 |     async function clickOneReplyButton() {
26847 |  875 |     const res = await page.evaluate((root) => {
26848 |  876 |       const scope = root || document;
26849 |  877 | 
26850 |  878 |       const norm = (s) =>
26851 |  879 |         String(s || "")
26852 |  880 |           .replace(/\u00a0/g, " ")
26853 |  881 |           .replace(/\s+/g, " ")
26854 |  882 |           .trim()
26855 |  883 |           .toLowerCase();
26856 |  884 | 
26857 |  885 |       const isVisible = (el) => {
26858 |  886 |         if (!el) return false;
26859 |  887 |         try {
26860 |  888 |           const r = el.getBoundingClientRect();
26861 |  889 |           if (r.width < 2 || r.height < 2) return false;
26862 |  890 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
26863 |  891 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
26864 |  892 |         } catch {
26865 |  893 |           return true;
26866 |  894 |         }
26867 |  895 |       };
26868 |  896 | 
26869 |  897 |       const isReplyExpanderText = (t) => {
26870 |  898 |         if (!t) return false;
26871 |  899 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
26872 |  900 |         if (t.length > 220) return false;
26873 |  901 | 
26874 |  902 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
26875 |  903 |         if (t === "odpowiedz" || t === "reply") return false;
26876 |  904 |         if (t.startsWith("odpowiedz ")) return false;
26877 |  905 |         if (t.startsWith("reply ")) return false;
26878 |  906 | 
26879 |  907 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
26880 |  908 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
26881 |  909 | 
26882 |  910 |         // warianty opisowe
26883 |  911 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
26884 |  912 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
26885 |  913 |         if (t.includes("view") && t.includes("repl")) return true;
26886 |  914 |         if (t.includes("see") && t.includes("repl")) return true;
26887 |  915 | 
26888 |  916 |         return false;
26889 |  917 |       };
26890 |  918 | 
26891 |  919 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
26892 |  920 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
26893 |  921 |       const allTextCandidates = Array.from(
26894 |  922 |         scope.querySelectorAll("a,button,div,span")
26895 |  923 |       )
26896 |  924 |         .filter(isVisible)
26897 |  925 |         .slice(0, 35000);
26898 |  926 | 
26899 |  927 |       let best = null;
26900 |  928 |       let bestScore = -Infinity;
26901 |  929 | 
26902 |  930 |       for (const el of allTextCandidates) {
26903 |  931 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
26904 |  932 |         const t = norm(tRaw);
26905 |  933 |         if (!isReplyExpanderText(t)) continue;
26906 |  934 | 
26907 |  935 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
26908 |  936 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
26909 |  937 |         if (t.includes("udost") || t.includes("share")) continue;
26910 |  938 | 
26911 |  939 |         const r = el.getBoundingClientRect();
26912 |  940 |         let score = 0;
26913 |  941 | 
26914 |  942 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
26915 |  943 |         score += Math.max(0, r.top);
26916 |  944 | 
26917 |  945 |         // preferuj te z liczbƒÖ odpowiedzi
26918 |  946 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
26919 |  947 | 
26920 |  948 |         // preferuj ‚Äúwszystkie/all‚Äù
26921 |  949 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
26922 |  950 | 
26923 |  951 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
26924 |  952 |         score -= Math.min(500, t.length * 3);
26925 |  953 | 
26926 |  954 |         if (score > bestScore) {
26927 |  955 |           bestScore = score;
26928 |  956 |           best = el;
26929 |  957 |         }
26930 |  958 |       }
26931 |  959 | 
26932 |  960 |       if (!best) return { clicked: false };
26933 |  961 | 
26934 |  962 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
26935 |  963 |       const clickable =
26936 |  964 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
26937 |  965 | 
26938 |  966 |       try {
26939 |  967 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
26940 |  968 |       } catch {}
26941 |  969 | 
26942 |  970 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
26943 |  971 | 
26944 |  972 |       const hardClick = (node) => {
26945 |  973 |         try {
26946 |  974 |           node.click();
26947 |  975 |           return true;
26948 |  976 |         } catch {}
26949 |  977 |         try {
26950 |  978 |           const r = node.getBoundingClientRect();
26951 |  979 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
26952 |  980 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
26953 |  981 |           const target = document.elementFromPoint(x, y) || node;
26954 |  982 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
26955 |  983 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
26956 |  984 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
26957 |  985 |           return true;
26958 |  986 |         } catch {}
26959 |  987 |         return false;
26960 |  988 |       };
26961 |  989 | 
26962 |  990 |       const ok = hardClick(clickable);
26963 |  991 |       return { clicked: ok, text: txt };
26964 |  992 |     }, rootHandle);
26965 |  993 | 
26966 |  994 |     return res || { clicked: false };
26967 |  995 |   }
26968 |  996 | 
26969 |  997 | 
26970 |  998 |   async function clickMoreCommentsButton() {
26971 |  999 |     const res = await page.evaluate((root) => {
26972 | 1000 |       const scope = root || document;
26973 | 1001 | 
26974 | 1002 |       const norm = (s) =>
26975 | 1003 |         String(s || "")
26976 | 1004 |           .replace(/\u00a0/g, " ")
26977 | 1005 |           .replace(/\s+/g, " ")
26978 | 1006 |           .trim()
26979 | 1007 |           .toLowerCase();
26980 | 1008 | 
26981 | 1009 |       const isVisible = (el) => {
26982 | 1010 |         if (!el) return false;
26983 | 1011 |         const r = el.getBoundingClientRect();
26984 | 1012 |         if (r.width < 2 || r.height < 2) return false;
26985 | 1013 |         return r.bottom > 0 && r.top < window.innerHeight;
26986 | 1014 |       };
26987 | 1015 | 
26988 | 1016 |       const isMore = (t) => {
26989 | 1017 |         if (!t) return false;
26990 | 1018 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
26991 | 1019 |         if (t.length > 140) return false;
26992 | 1020 | 
26993 | 1021 |         return (
26994 | 1022 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
26995 | 1023 |           t.includes("zobacz wiƒôcej komentarzy") ||
26996 | 1024 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
26997 | 1025 |           t.includes("view more comments") ||
26998 | 1026 |           t.includes("view previous comments")
26999 | 1027 |         );
27000 | 1028 |       };
27001 | 1029 | 
27002 | 1030 |       const candidates = Array.from(
27003 | 1031 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
27004 | 1032 |       ).filter(isVisible);
27005 | 1033 | 
27006 | 1034 |       let best = null;
27007 | 1035 |       let bestY = -1;
27008 | 1036 | 
27009 | 1037 |       for (const el of candidates) {
27010 | 1038 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
27011 | 1039 |         if (!isMore(t)) continue;
27012 | 1040 |         const r = el.getBoundingClientRect();
27013 | 1041 |         if (r.top > bestY) {
27014 | 1042 |           bestY = r.top;
27015 | 1043 |           best = el;
27016 | 1044 |         }
27017 | 1045 |       }
27018 | 1046 | 
27019 | 1047 |       if (!best) return { clicked: false };
27020 | 1048 | 
27021 | 1049 |       try {
27022 | 1050 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
27023 | 1051 |       } catch {}
27024 | 1052 | 
27025 | 1053 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
27026 | 1054 | 
27027 | 1055 |       try {
27028 | 1056 |         best.click();
27029 | 1057 |         return { clicked: true, text: txt };
27030 | 1058 |       } catch {
27031 | 1059 |         return { clicked: false, text: txt };
27032 | 1060 |       }
27033 | 1061 |     }, rootHandle);
27034 | 1062 | 
27035 | 1063 |     return res || { clicked: false };
27036 | 1064 |   }
27037 | 1065 | 
27038 | 1066 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
27039 | 1067 | 
27040 | 1068 |   async function hasAnyReplyExpanders(page, rootHandle) {
27041 | 1069 |     return page.evaluate((root) => {
27042 | 1070 |       const scope = root || document;
27043 | 1071 | 
27044 | 1072 |       const norm = (s) =>
27045 | 1073 |         String(s || "")
27046 | 1074 |           .replace(/\u00a0/g, " ")
27047 | 1075 |           .replace(/\s+/g, " ")
27048 | 1076 |           .trim()
27049 | 1077 |           .toLowerCase();
27050 | 1078 | 
27051 | 1079 |       const isVisible = (el) => {
27052 | 1080 |         if (!el) return false;
27053 | 1081 |         try {
27054 | 1082 |           const r = el.getBoundingClientRect();
27055 | 1083 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
27056 | 1084 |         } catch {
27057 | 1085 |           return true;
27058 | 1086 |         }
27059 | 1087 |       };
27060 | 1088 | 
27061 | 1089 |       const isReplyExpanderText = (t) => {
27062 | 1090 |         if (!t) return false;
27063 | 1091 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
27064 | 1092 |         if (t.length > 220) return false;
27065 | 1093 | 
27066 | 1094 |         if (t === "odpowiedz" || t === "reply") return false;
27067 | 1095 |         if (t.startsWith("odpowiedz ")) return false;
27068 | 1096 |         if (t.startsWith("reply ")) return false;
27069 | 1097 | 
27070 | 1098 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
27071 | 1099 | 
27072 | 1100 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
27073 | 1101 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
27074 | 1102 |         if (t.includes("view") && t.includes("repl")) return true;
27075 | 1103 |         if (t.includes("see") && t.includes("repl")) return true;
27076 | 1104 | 
27077 | 1105 |         return false;
27078 | 1106 |       };
27079 | 1107 | 
27080 | 1108 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
27081 | 1109 | 
27082 | 1110 |       for (const el of nodes) {
27083 | 1111 |         if (!isVisible(el)) continue;
27084 | 1112 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
27085 | 1113 |         if (!t) continue;
27086 | 1114 | 
27087 | 1115 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
27088 | 1116 |         if (t.includes("udost") || t.includes("share")) continue;
27089 | 1117 | 
27090 | 1118 |         if (isReplyExpanderText(t)) return true;
27091 | 1119 |       }
27092 | 1120 | 
27093 | 1121 |       return false;
27094 | 1122 |     }, rootHandle);
27095 | 1123 |   }
27096 | 1124 | 
27097 | 1125 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
27098 | 1126 |     const res = await page.evaluate(
27099 | 1127 |       (root, limit) => {
27100 | 1128 |         const scope = root || document;
27101 | 1129 | 
27102 | 1130 |         const norm = (s) =>
27103 | 1131 |           String(s || "")
27104 | 1132 |             .replace(/\u00a0/g, " ")
27105 | 1133 |             .replace(/\s+/g, " ")
27106 | 1134 |             .trim()
27107 | 1135 |             .toLowerCase();
27108 | 1136 | 
27109 | 1137 |         const isVisible = (el) => {
27110 | 1138 |           if (!el) return false;
27111 | 1139 |           try {
27112 | 1140 |             const r = el.getBoundingClientRect();
27113 | 1141 |             if (r.width < 2 || r.height < 2) return false;
27114 | 1142 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
27115 | 1143 |           } catch {
27116 | 1144 |             return true;
27117 | 1145 |           }
27118 | 1146 |         };
27119 | 1147 | 
27120 | 1148 |         const isReplyExpanderText = (t) => {
27121 | 1149 |           if (!t) return false;
27122 | 1150 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
27123 | 1151 |           if (t.length > 220) return false;
27124 | 1152 | 
27125 | 1153 |           if (t === "odpowiedz" || t === "reply") return false;
27126 | 1154 |           if (t.startsWith("odpowiedz ")) return false;
27127 | 1155 |           if (t.startsWith("reply ")) return false;
27128 | 1156 | 
27129 | 1157 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
27130 | 1158 | 
27131 | 1159 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
27132 | 1160 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
27133 | 1161 |           if (t.includes("view") && t.includes("repl")) return true;
27134 | 1162 |           if (t.includes("see") && t.includes("repl")) return true;
27135 | 1163 | 
27136 | 1164 |           return false;
27137 | 1165 |         };
27138 | 1166 | 
27139 | 1167 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
27140 | 1168 |           .filter(isVisible)
27141 | 1169 |           .slice(0, 35000)
27142 | 1170 |           .map((el) => {
27143 | 1171 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
27144 | 1172 |             return { el, t };
27145 | 1173 |           })
27146 | 1174 |           .filter((x) => {
27147 | 1175 |             if (!x.t) return false;
27148 | 1176 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
27149 | 1177 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
27150 | 1178 |             return isReplyExpanderText(x.t);
27151 | 1179 |           });
27152 | 1180 | 
27153 | 1181 |         // preferuj elementy ni≈ºej w widoku
27154 | 1182 |         candidates.sort((a, b) => {
27155 | 1183 |           const ra = a.el.getBoundingClientRect();
27156 | 1184 |           const rb = b.el.getBoundingClientRect();
27157 | 1185 |           return rb.top - ra.top;
27158 | 1186 |         });
27159 | 1187 | 
27160 | 1188 |         const hardClick = (node) => {
27161 | 1189 |           try {
27162 | 1190 |             node.click();
27163 | 1191 |             return true;
27164 | 1192 |           } catch {}
27165 | 1193 |           try {
27166 | 1194 |             const r = node.getBoundingClientRect();
27167 | 1195 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
27168 | 1196 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
27169 | 1197 |             const target = document.elementFromPoint(x, y) || node;
27170 | 1198 |             target.dispatchEvent(
27171 | 1199 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
27172 | 1200 |             );
27173 | 1201 |             target.dispatchEvent(
27174 | 1202 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
27175 | 1203 |             );
27176 | 1204 |             target.dispatchEvent(
27177 | 1205 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
27178 | 1206 |             );
27179 | 1207 |             return true;
27180 | 1208 |           } catch {}
27181 | 1209 |           return false;
27182 | 1210 |         };
27183 | 1211 | 
27184 | 1212 |         let clicked = 0;
27185 | 1213 |         const sample = [];
27186 | 1214 | 
27187 | 1215 |         for (const item of candidates) {
27188 | 1216 |           if (clicked >= limit) break;
27189 | 1217 | 
27190 | 1218 |           const clickable =
27191 | 1219 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
27192 | 1220 | 
27193 | 1221 |           try {
27194 | 1222 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
27195 | 1223 |           } catch {}
27196 | 1224 | 
27197 | 1225 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
27198 | 1226 | 
27199 | 1227 |           const ok = hardClick(clickable);
27200 | 1228 |           if (ok) {
27201 | 1229 |             clicked++;
27202 | 1230 |             if (sample.length < 5) sample.push(txt);
27203 | 1231 |           }
27204 | 1232 |         }
27205 | 1233 | 
27206 | 1234 |         return { clicked, sample };
27207 | 1235 |       },
27208 | 1236 |       rootHandle,
27209 | 1237 |       maxPerPass
27210 | 1238 |     );
27211 | 1239 | 
27212 | 1240 |     return res || { clicked: 0, sample: [] };
27213 | 1241 |   }
27214 | 1242 | 
27215 | 1243 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
27216 | 1244 |     await page.evaluate((root, scroller) => {
27217 | 1245 |       const pick =
27218 | 1246 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
27219 | 1247 | 
27220 | 1248 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
27221 | 1249 |       else window.scrollTo(0, 0);
27222 | 1250 |     }, rootHandle, scrollHandle);
27223 | 1251 |   }
27224 | 1252 | 
27225 | 1253 |   async function sweepRepliesTopDown(
27226 | 1254 |     page,
27227 | 1255 |     rootHandle,
27228 | 1256 |     scrollHandle,
27229 | 1257 |     {
27230 | 1258 |       maxPasses = 3,
27231 | 1259 |       stepsPerPass = 40,
27232 | 1260 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
27233 | 1261 |       maxClicksPerStep = 12,
27234 | 1262 |     } = {}
27235 | 1263 |   ) {
27236 | 1264 |     let totalClicked = 0;
27237 | 1265 | 
27238 | 1266 |     for (let pass = 1; pass <= maxPasses; pass++) {
27239 | 1267 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
27240 | 1268 |       await sleepRandom(140, 240);
27241 | 1269 | 
27242 | 1270 |       let staleSteps = 0;
27243 | 1271 | 
27244 | 1272 |       for (let step = 1; step <= stepsPerPass; step++) {
27245 | 1273 |         const before = await countAnchors().catch(() => null);
27246 | 1274 | 
27247 | 1275 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
27248 | 1276 |           () => ({ clicked: 0, sample: [] })
27249 | 1277 |         );
27250 | 1278 | 
27251 | 1279 |         if (r.clicked > 0) {
27252 | 1280 |           totalClicked += r.clicked;
27253 | 1281 | 
27254 | 1282 |           if (before) {
27255 | 1283 |             await sleepRandom(60, 120);
27256 | 1284 |             await waitForEffect(before, "replies");
27257 | 1285 |           }
27258 | 1286 | 
27259 | 1287 |           await sleepRandom(90, 160);
27260 | 1288 |           staleSteps = 0;
27261 | 1289 |         } else {
27262 | 1290 |           staleSteps++;
27263 | 1291 |         }
27264 | 1292 | 
27265 | 1293 |         const m1 = await getScrollMetrics().catch(() => null);
27266 | 1294 |         await gentleScrollKick(scrollPx);
27267 | 1295 |         const m2 = await getScrollMetrics().catch(() => null);
27268 | 1296 | 
27269 | 1297 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
27270 | 1298 | 
27271 | 1299 |         if (!moved && staleSteps >= 4) break;
27272 | 1300 |         if (staleSteps >= 8) break;
27273 | 1301 |       }
27274 | 1302 | 
27275 | 1303 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
27276 | 1304 |       if (!any) break;
27277 | 1305 |     }
27278 | 1306 | 
27279 | 1307 |     return totalClicked;
27280 | 1308 |   }
27281 | 1309 | 
27282 | 1310 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
27283 | 1311 |   let lastLogAt = 0;
27284 | 1312 |   let lastLogKey = "";
27285 | 1313 |   const LOG_EVERY_N_STEPS = 6;
27286 | 1314 |   const LOG_MIN_MS = 800;
27287 | 1315 |   const shouldLog = (step, key, force = false) => {
27288 | 1316 |     const now = Date.now();
27289 | 1317 |     if (force) {
27290 | 1318 |       lastLogAt = now;
27291 | 1319 |       lastLogKey = key;
27292 | 1320 |       return true;
27293 | 1321 |     }
27294 | 1322 |     if (step % LOG_EVERY_N_STEPS === 0) {
27295 | 1323 |       lastLogAt = now;
27296 | 1324 |       lastLogKey = key;
27297 | 1325 |       return true;
27298 | 1326 |     }
27299 | 1327 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
27300 | 1328 |       lastLogAt = now;
27301 | 1329 |       lastLogKey = key;
27302 | 1330 |       return true;
27303 | 1331 |     }
27304 | 1332 |     return false;
27305 | 1333 |   };
27306 | 1334 | 
27307 | 1335 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
27308 | 1336 |   console.log("[FB][ui:photo] startCounts:", cur);
27309 | 1337 | 
27310 | 1338 |   for (let step = 1; step <= MAX_STEPS; step++) {
27311 | 1339 |     const before = cur;
27312 | 1340 |     let action = "scroll";
27313 | 1341 |     let clickInfo = null;
27314 | 1342 |     let effectOk = false;
27315 | 1343 |     let bonus = 0;
27316 | 1344 | 
27317 | 1345 |     // 1) REPLIES
27318 | 1346 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
27319 | 1347 |     if (r1?.clicked) {
27320 | 1348 |       action = "replies";
27321 | 1349 |       clickInfo = r1;
27322 | 1350 | 
27323 | 1351 |       await sleepRandom(80, 140);
27324 | 1352 |       effectOk = await waitForEffect(before, "replies");
27325 | 1353 |       await sleepRandom(90, 170);
27326 | 1354 | 
27327 | 1355 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
27328 | 1356 |       if (effectOk) {
27329 | 1357 |         bonus = await bonusClicks("replies", before);
27330 | 1358 |       } else {
27331 | 1359 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
27332 | 1360 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
27333 | 1361 |       }
27334 | 1362 |     } else {
27335 | 1363 |       // 2) MORE COMMENTS
27336 | 1364 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
27337 | 1365 |       if (c1?.clicked) {
27338 | 1366 |         action = "comments";
27339 | 1367 |         clickInfo = c1;
27340 | 1368 | 
27341 | 1369 |         await sleepRandom(80, 140);
27342 | 1370 |         effectOk = await waitForEffect(before, "comments");
27343 | 1371 |         await sleepRandom(90, 170);
27344 | 1372 | 
27345 | 1373 |         if (effectOk) {
27346 | 1374 |           bonus = await bonusClicks("comments", before);
27347 | 1375 |         } else {
27348 | 1376 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
27349 | 1377 |         }
27350 | 1378 |       } else {
27351 | 1379 |         // 3) SCROLL
27352 | 1380 |         action = "scroll";
27353 | 1381 |         await gentleScrollKick(PACE_CFG.scrollPx);
27354 | 1382 |       }
27355 | 1383 |     }
27356 | 1384 | 
27357 | 1385 |     cur = await countAnchors().catch(() => before);
27358 | 1386 | 
27359 | 1387 |     const progressed =
27360 | 1388 |       cur.commentsAnchors > before.commentsAnchors ||
27361 | 1389 |       cur.replyAnchors > before.replyAnchors ||
27362 | 1390 |       cur.nodes > before.nodes;
27363 | 1391 | 
27364 | 1392 |     if (!progressed) noProgress++;
27365 | 1393 |     else noProgress = 0;
27366 | 1394 | 
27367 | 1395 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
27368 | 1396 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
27369 | 1397 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
27370 | 1398 |     if (shouldCheckHB) {
27371 | 1399 |       hb = await updateHardBottomStability().catch(() => ({
27372 | 1400 |         atBottom: false,
27373 | 1401 |         stable: bottomStable,
27374 | 1402 |         tag: "NA",
27375 | 1403 |         anyMore: true,
27376 | 1404 |       }));
27377 | 1405 |     }
27378 | 1406 | 
27379 | 1407 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
27380 | 1408 |     const key =
27381 | 1409 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
27382 | 1410 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
27383 | 1411 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
27384 | 1412 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
27385 | 1413 | 
27386 | 1414 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
27387 | 1415 |     if (shouldLog(step, key, forceLog)) {
27388 | 1416 |       console.log(
27389 | 1417 |         `[FB][ui:photo] step=${step} action=${action} eff=${effectOk ? "OK" : "NO"} bonus=${bonus} ` +
27390 | 1418 |           `cA ${before.commentsAnchors}->${cur.commentsAnchors} ` +
27391 | 1419 |           `rA ${before.replyAnchors}->${cur.replyAnchors} ` +
27392 | 1420 |           `nodes ${before.nodes}->${cur.nodes} ` +
27393 | 1421 |           `np=${noProgress}/${MAX_NO_PROGRESS} ` +
27394 | 1422 |           `hb=${hb.atBottom ? "Y" : "N"} stable=${hb.stable}/${PACE_CFG.hardBottomStableNeed} more=${
27395 | 1423 |             hb.anyMore ? "Y" : "N"
27396 | 1424 |           } scroller=${hb.tag}` +
27397 | 1425 |           (clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "")
27398 | 1426 |       );
27399 | 1427 |     }
27400 | 1428 | 
27401 | 1429 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
27402 | 1430 |       console.log("[FB][ui:photo] stop: hard-bottom-stable (true bottom reached)");
27403 | 1431 |       break;
27404 | 1432 |     }
27405 | 1433 | 
27406 | 1434 |     if (noProgress >= MAX_NO_PROGRESS) {
27407 | 1435 |       console.log("[FB][ui:photo] stop: too many no-progress steps (safety)");
27408 | 1436 |       break;
27409 | 1437 |     }
27410 | 1438 | 
27411 | 1439 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
27412 | 1440 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
27413 | 1441 |   }
27414 | 1442 | 
27415 | 1443 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
27416 | 1444 |   let final = await countAnchors().catch(() => cur);
27417 | 1445 |   console.log("[FB][ui:photo] done:", final);
27418 | 1446 | 
27419 | 1447 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
27420 | 1448 |   if (needSweep) {
27421 | 1449 |     console.log("[FB][ui:photo] sweep: wykryto jeszcze reply expanders -> odpalam sweep top-down‚Ä¶");
27422 | 1450 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
27423 | 1451 |     console.log(`[FB][ui:photo] sweep: clicked=${clicked}`);
27424 | 1452 |     final = await countAnchors().catch(() => final);
27425 | 1453 |     console.log("[FB][ui:photo] after sweep:", final);
27426 | 1454 |   } else {
27427 | 1455 |     console.log("[FB][ui:photo] sweep: brak reply expanders -> pomijam.");
27428 | 1456 |   }
27429 | 1457 | 
27430 | 1458 |   try {
27431 | 1459 |     await scrollHandle.dispose?.();
27432 | 1460 |   } catch {}
27433 | 1461 |   try {
27434 | 1462 |     await rootHandle.dispose?.();
27435 | 1463 |   } catch {}
27436 | 1464 | }
27437 | 1465 | 
27438 | 1466 | /* =====================
27439 | 1467 |    Analiza za≈Ço≈ºe≈Ñ
27440 | 1468 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
27441 | 1469 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
27442 | 1470 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
27443 | 1471 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
27444 | 1472 | 
27445 | 1473 |    Co powiedzia≈Çby sceptyk?
27446 | 1474 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
27447 | 1475 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
27448 | 1476 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
27449 | 1477 | 
27450 | 1478 |    ===================== */
27451 | 1479 | 
27452 | ```
27453 | 
27454 | ---
27455 | 
27456 | ### üìÑ ≈öcie≈ºka: `export_chat_context/14__watch.js`
27457 | **Typ:** JavaScript/tekst  
27458 | **Opis:** Plik projektu (kod/konfiguracja).  
27459 | 
27460 | ```js
27461 |   1 | // src/fb/ui/watch.js
27462 |   2 | import { safeGoto } from "../../utils/navigation.js";
27463 |   3 | import { sleepRandom } from "../../utils/sleep.js";
27464 |   4 | import { acceptCookies, saveCookies } from "../cookies.js";
27465 |   5 | import { fbLogin, checkIfLogged } from "../login.js";
27466 |   6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
27467 |   7 | 
27468 |   8 | /** Typ handlera UI */
27469 |   9 | export const type = "watch";
27470 |  10 | 
27471 |  11 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
27472 |  12 | export function matchesUrl(url) {
27473 |  13 |   try {
27474 |  14 |     const u = new URL(url);
27475 |  15 |     return (u.pathname || "").toLowerCase().includes("/watch");
27476 |  16 |   } catch {
27477 |  17 |     return String(url || "").toLowerCase().includes("/watch");
27478 |  18 |   }
27479 |  19 | }
27480 |  20 | 
27481 |  21 | /* ============================================================
27482 |  22 |    ======================= DEBUG HELPERS ======================
27483 |  23 |    ============================================================ */
27484 |  24 | 
27485 |  25 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
27486 |  26 | 
27487 |  27 | async function safeShot(page, path, clip = null) {
27488 |  28 |   if (!DEBUG_WATCH) return;
27489 |  29 |   try {
27490 |  30 |     const opts = clip ? { path, clip } : { path, fullPage: false };
27491 |  31 |     await page.screenshot(opts);
27492 |  32 |     console.log(`[FB][ui:watch][DBG] screenshot -> ${path}`);
27493 |  33 |   } catch (e) {
27494 |  34 |     console.log("[FB][ui:watch][DBG] screenshot failed:", e?.message || e);
27495 |  35 |   }
27496 |  36 | }
27497 |  37 | 
27498 |  38 | async function shotElement(page, handle, path) {
27499 |  39 |   if (!DEBUG_WATCH) return;
27500 |  40 |   try {
27501 |  41 |     if (!handle) return;
27502 |  42 |     const box = await handle.boundingBox().catch(() => null);
27503 |  43 |     if (!box || box.width < 5 || box.height < 5) {
27504 |  44 |       console.log("[FB][ui:watch][DBG] shotElement: no bbox");
27505 |  45 |       return;
27506 |  46 |     }
27507 |  47 |     const clip = {
27508 |  48 |       x: Math.max(0, box.x),
27509 |  49 |       y: Math.max(0, box.y),
27510 |  50 |       width: Math.max(1, Math.min(box.width, 1920)),
27511 |  51 |       height: Math.max(1, Math.min(box.height, 1080)),
27512 |  52 |     };
27513 |  53 |     await safeShot(page, path, clip);
27514 |  54 |   } catch (e) {
27515 |  55 |     console.log("[FB][ui:watch][DBG] shotElement failed:", e?.message || e);
27516 |  56 |   }
27517 |  57 | }
27518 |  58 | 
27519 |  59 | async function debugOuterStats(page, outerHandle) {
27520 |  60 |   if (!DEBUG_WATCH) return null;
27521 |  61 |   if (!outerHandle) return null;
27522 |  62 | 
27523 |  63 |   return page.evaluate((outer) => {
27524 |  64 |     const norm = (s) =>
27525 |  65 |       String(s || "")
27526 |  66 |         .replace(/\u00a0/g, " ")
27527 |  67 |         .replace(/\s+/g, " ")
27528 |  68 |         .trim();
27529 |  69 | 
27530 |  70 |     const r = outer.getBoundingClientRect();
27531 |  71 |     const style = getComputedStyle(outer);
27532 |  72 | 
27533 |  73 |     const anchors = Array.from(
27534 |  74 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
27535 |  75 |     );
27536 |  76 | 
27537 |  77 |     const allText = (outer.innerText || "").toLowerCase();
27538 |  78 |     const moreHits =
27539 |  79 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
27540 |  80 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
27541 |  81 |       (allText.match(/view more comments/g) || []).length +
27542 |  82 |       (allText.match(/see more comments/g) || []).length;
27543 |  83 | 
27544 |  84 |     const labels = [];
27545 |  85 |     const nodes = Array.from(
27546 |  86 |       outer.querySelectorAll(
27547 |  87 |         "button,div[role='button'],span[role='button'],a,abbr,[role='article'],div,span"
27548 |  88 |       )
27549 |  89 |     ).slice(0, 4000);
27550 |  90 | 
27551 |  91 |     for (const el of nodes) {
27552 |  92 |       const a = el.getAttribute?.("aria-label");
27553 |  93 |       const t = norm(a);
27554 |  94 |       if (t) labels.push(t);
27555 |  95 |     }
27556 |  96 | 
27557 |  97 |     const freq = new Map();
27558 |  98 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
27559 |  99 |     const topLabels = Array.from(freq.entries())
27560 | 100 |       .sort((a, b) => b[1] - a[1])
27561 | 101 |       .slice(0, 15)
27562 | 102 |       .map(([k, v]) => ({ label: k, n: v }));
27563 | 103 | 
27564 | 104 |     return {
27565 | 105 |       tag: outer.tagName,
27566 | 106 |       className: outer.className || "",
27567 | 107 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
27568 | 108 |       style: {
27569 | 109 |         overflowY: style.overflowY,
27570 | 110 |         position: style.position,
27571 | 111 |       },
27572 | 112 |       counts: {
27573 | 113 |         anchors: anchors.length,
27574 | 114 |         moreHits,
27575 | 115 |       },
27576 | 116 |       topLabels,
27577 | 117 |     };
27578 | 118 |   }, outerHandle);
27579 | 119 | }
27580 | 120 | 
27581 | 121 | async function debugScrollerStats(page, scrollerHandle) {
27582 | 122 |   if (!DEBUG_WATCH) return null;
27583 | 123 |   if (!scrollerHandle) return null;
27584 | 124 | 
27585 | 125 |   return page.evaluate((s) => {
27586 | 126 |     const r = s.getBoundingClientRect();
27587 | 127 |     const st = getComputedStyle(s);
27588 | 128 |     return {
27589 | 129 |       tag: s.tagName,
27590 | 130 |       className: s.className || "",
27591 | 131 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
27592 | 132 |       style: { overflowY: st.overflowY, overflow: st.overflow },
27593 | 133 |       scroll: {
27594 | 134 |         scrollTop: s.scrollTop,
27595 | 135 |         clientHeight: s.clientHeight,
27596 | 136 |         scrollHeight: s.scrollHeight,
27597 | 137 |       },
27598 | 138 |     };
27599 | 139 |   }, scrollerHandle);
27600 | 140 | }
27601 | 141 | 
27602 | 142 | /* ============================================================
27603 | 143 |    ======================= PARSING COUNT =======================
27604 | 144 |    ============================================================ */
27605 | 145 | 
27606 | 146 | function parseCountFromText(str) {
27607 | 147 |   if (!str) return null;
27608 | 148 | 
27609 | 149 |   const raw = String(str)
27610 | 150 |     .toLowerCase()
27611 | 151 |     .replace(/\u00a0/g, " ")
27612 | 152 |     .replace(/\s+/g, " ")
27613 | 153 |     .trim();
27614 | 154 | 
27615 | 155 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
27616 | 156 |   if (!m) return null;
27617 | 157 | 
27618 | 158 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
27619 | 159 |   const suf = (m[2] || "").trim();
27620 | 160 | 
27621 | 161 |   const hasDecimal = /[.,]\d/.test(numStr);
27622 | 162 |   if (hasDecimal) numStr = numStr.replace(",", ".");
27623 | 163 |   else numStr = numStr.replace(/[.,]/g, "");
27624 | 164 | 
27625 | 165 |   let n = Number(numStr);
27626 | 166 |   if (!Number.isFinite(n)) return null;
27627 | 167 | 
27628 | 168 |   if (suf === "k") n *= 1000;
27629 | 169 |   if (suf === "tys" || suf === "tys.") n *= 1000;
27630 | 170 |   if (suf === "m" || suf === "mln") n *= 1000000;
27631 | 171 | 
27632 | 172 |   n = Math.round(n);
27633 | 173 |   if (n <= 0) return null;
27634 | 174 |   return n;
27635 | 175 | }
27636 | 176 | 
27637 | 177 | function parseBestCommentsCountFromBlob(blobStr) {
27638 | 178 |   if (!blobStr) return null;
27639 | 179 | 
27640 | 180 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
27641 | 181 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
27642 | 182 | 
27643 | 183 |   let best = null;
27644 | 184 |   let match;
27645 | 185 |   while ((match = re.exec(raw)) !== null) {
27646 | 186 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
27647 | 187 |     const n = parseCountFromText(candidate);
27648 | 188 |     if (n && (!best || n > best)) best = n;
27649 | 189 |   }
27650 | 190 |   return best;
27651 | 191 | }
27652 | 192 | 
27653 | 193 | function pickBestCount(candidates) {
27654 | 194 |   const nums = candidates.filter((v) => typeof v === "number" && Number.isFinite(v) && v > 0);
27655 | 195 |   if (!nums.length) return null;
27656 | 196 | 
27657 | 197 |   nums.sort((a, b) => b - a);
27658 | 198 |   const best = nums[0];
27659 | 199 |   const second = nums[1];
27660 | 200 | 
27661 | 201 |   if (second && best >= 2 * second && second < 150) return best;
27662 | 202 | 
27663 | 203 |   return best;
27664 | 204 | }
27665 | 205 | 
27666 | 206 | /* ============================================================
27667 | 207 |    =================== COMMENTS CONTAINER FIND =================
27668 | 208 |    ============================================================ */
27669 | 209 | 
27670 | 210 | /**
27671 | 211 |  * WATCH FIX:
27672 | 212 |  * - NIE polegamy na h2 "Komentarze" (czƒôsto go nie ma w Watch).
27673 | 213 |  * - Szukamy najwiƒôkszego klastra link√≥w comment_id/reply_comment_id na stronie.
27674 | 214 |  */
27675 | 215 | async function findCommentsOuter(page) {
27676 | 216 |   const handle = await page.evaluateHandle(() => {
27677 | 217 |     const nodes = Array.from(document.querySelectorAll("div, section, main, article")).slice(0, 30000);
27678 | 218 | 
27679 | 219 |     const visible = (el) => {
27680 | 220 |       if (!el) return false;
27681 | 221 |       const r = el.getBoundingClientRect?.();
27682 | 222 |       return r && r.width >= 220 && r.height >= 220;
27683 | 223 |     };
27684 | 224 | 
27685 | 225 |     let best = null;
27686 | 226 |     let bestScore = -1;
27687 | 227 | 
27688 | 228 |     for (const el of nodes) {
27689 | 229 |       if (!visible(el)) continue;
27690 | 230 | 
27691 | 231 |       const anchors = el.querySelectorAll?.("a[href*='comment_id'], a[href*='reply_comment_id']");
27692 | 232 |       const aCount = anchors ? anchors.length : 0;
27693 | 233 |       if (aCount < 3) continue;
27694 | 234 | 
27695 | 235 |       const txt = (el.innerText || "").toLowerCase();
27696 | 236 |       const hasWords =
27697 | 237 |         txt.includes("komentarz") || txt.includes("komentarzy") || txt.includes("comments") || txt.includes("comment");
27698 | 238 | 
27699 | 239 |       // score: anchor count + bonus za s≈Çowa ‚Äúkomentarz‚Äù
27700 | 240 |       const score = aCount + (hasWords ? 12 : 0);
27701 | 241 | 
27702 | 242 |       if (score > bestScore) {
27703 | 243 |         bestScore = score;
27704 | 244 |         best = el;
27705 | 245 |       }
27706 | 246 |     }
27707 | 247 | 
27708 | 248 |     return best || null;
27709 | 249 |   });
27710 | 250 | 
27711 | 251 |   const el = handle?.asElement?.() || null;
27712 | 252 |   if (!el) return null;
27713 | 253 | 
27714 | 254 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
27715 | 255 |   return ok ? el : null;
27716 | 256 | }
27717 | 257 | 
27718 | 258 | async function findScrollableInOuter(page, outerHandle) {
27719 | 259 |   if (!outerHandle) return null;
27720 | 260 | 
27721 | 261 |   const scrollerHandle = await page.evaluateHandle((outer) => {
27722 | 262 |     function isVisible(el) {
27723 | 263 |       if (!el) return false;
27724 | 264 |       const r = el.getBoundingClientRect();
27725 | 265 |       return r.width > 2 && r.height > 2;
27726 | 266 |     }
27727 | 267 | 
27728 | 268 |     function canScroll(el) {
27729 | 269 |       try {
27730 | 270 |         if (!el) return false;
27731 | 271 |         const st = getComputedStyle(el);
27732 | 272 |         const oy = (st.overflowY || "").toLowerCase();
27733 | 273 |         if (!(oy === "auto" || oy === "scroll")) return false;
27734 | 274 |         const h = el.clientHeight || 0;
27735 | 275 |         const sh = el.scrollHeight || 0;
27736 | 276 |         return sh > h + 80;
27737 | 277 |       } catch {
27738 | 278 |         return false;
27739 | 279 |       }
27740 | 280 |     }
27741 | 281 | 
27742 | 282 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
27743 | 283 |       .filter(isVisible)
27744 | 284 |       .slice(0, 20000);
27745 | 285 | 
27746 | 286 |     let best = null;
27747 | 287 |     let bestScore = -1;
27748 | 288 | 
27749 | 289 |     for (const el of nodes) {
27750 | 290 |       if (!canScroll(el)) continue;
27751 | 291 | 
27752 | 292 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
27753 | 293 |       const txt = (el.innerText || "").toLowerCase();
27754 | 294 | 
27755 | 295 |       const hasMore =
27756 | 296 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
27757 | 297 |         txt.includes("view more comments") ||
27758 | 298 |         txt.includes("see more comments") ||
27759 | 299 |         txt.includes("zobacz wiƒôcej komentarzy") ||
27760 | 300 |         txt.includes("zobacz wcze≈õniejsze komentarze");
27761 | 301 | 
27762 | 302 |       const score = delta + (hasMore ? 100000 : 0);
27763 | 303 |       if (score > bestScore) {
27764 | 304 |         bestScore = score;
27765 | 305 |         best = el;
27766 | 306 |       }
27767 | 307 |     }
27768 | 308 | 
27769 | 309 |     return best || null;
27770 | 310 |   }, outerHandle);
27771 | 311 | 
27772 | 312 |   const el = scrollerHandle?.asElement?.() || null;
27773 | 313 |   if (!el) return null;
27774 | 314 | 
27775 | 315 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
27776 | 316 |   return ok ? el : null;
27777 | 317 | }
27778 | 318 | 
27779 | 319 | async function clickMoreCommentsIfPresent(page, outerHandle) {
27780 | 320 |   if (!outerHandle) return false;
27781 | 321 | 
27782 | 322 |   const labels = [
27783 | 323 |     "wy≈õwietl wiƒôcej komentarzy",
27784 | 324 |     "zobacz wiƒôcej komentarzy",
27785 | 325 |     "zobacz wcze≈õniejsze komentarze",
27786 | 326 |     "view more comments",
27787 | 327 |     "see more comments",
27788 | 328 |     "show more comments",
27789 | 329 |     "view previous comments",
27790 | 330 |   ];
27791 | 331 | 
27792 | 332 |   const clicked = await page.evaluate(
27793 | 333 |     (outer, labelsArr) => {
27794 | 334 |       const norm = (s) =>
27795 | 335 |         String(s || "")
27796 | 336 |           .replace(/\u00a0/g, " ")
27797 | 337 |           .replace(/\s+/g, " ")
27798 | 338 |           .trim()
27799 | 339 |           .toLowerCase();
27800 | 340 | 
27801 | 341 |       const isVisible = (el) => {
27802 | 342 |         if (!el) return false;
27803 | 343 |         const r = el.getBoundingClientRect();
27804 | 344 |         return r.width > 2 && r.height > 2;
27805 | 345 |       };
27806 | 346 | 
27807 | 347 |       const nodes = Array.from(
27808 | 348 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
27809 | 349 |       ).filter(isVisible);
27810 | 350 | 
27811 | 351 |       for (const el of nodes) {
27812 | 352 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
27813 | 353 |         if (!t) continue;
27814 | 354 |         if (labelsArr.some((x) => t.includes(x))) {
27815 | 355 |           try {
27816 | 356 |             el.scrollIntoView({ block: "center" });
27817 | 357 |           } catch {}
27818 | 358 |           const clickable =
27819 | 359 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
27820 | 360 |           try {
27821 | 361 |             clickable.click();
27822 | 362 |             return true;
27823 | 363 |           } catch {}
27824 | 364 |         }
27825 | 365 |       }
27826 | 366 |       return false;
27827 | 367 |     },
27828 | 368 |     outerHandle,
27829 | 369 |     labels
27830 | 370 |   );
27831 | 371 | 
27832 | 372 |   return !!clicked;
27833 | 373 | }
27834 | 374 | 
27835 | 375 | async function getAnchorsCount(page, outerHandle) {
27836 | 376 |   if (!outerHandle) return 0;
27837 | 377 |   return page
27838 | 378 |     .evaluate((outer) => {
27839 | 379 |       const as = Array.from(
27840 | 380 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
27841 | 381 |       );
27842 | 382 |       const ids = new Set();
27843 | 383 |       for (const a of as) {
27844 | 384 |         try {
27845 | 385 |           const u = new URL(a.href, location.origin);
27846 | 386 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
27847 | 387 |           if (id) ids.add(id);
27848 | 388 |         } catch {}
27849 | 389 |       }
27850 | 390 |       return ids.size;
27851 | 391 |     }, outerHandle)
27852 | 392 |     .catch(() => 0);
27853 | 393 | }
27854 | 394 | 
27855 | 395 | async function getCommentRootsCount(page, outerHandle) {
27856 | 396 |   if (!outerHandle) return 0;
27857 | 397 |   return page
27858 | 398 |     .evaluate((outer) => {
27859 | 399 |       const as = Array.from(
27860 | 400 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
27861 | 401 |       );
27862 | 402 |       const roots = new Set();
27863 | 403 |       for (const a of as) {
27864 | 404 |         const root = a.closest?.("[role='article']") || a.closest?.("div");
27865 | 405 |         if (root) roots.add(root);
27866 | 406 |       }
27867 | 407 |       return roots.size;
27868 | 408 |     }, outerHandle)
27869 | 409 |     .catch(() => 0);
27870 | 410 | }
27871 | 411 | 
27872 | 412 | /* ============================================================
27873 | 413 |    ============================ API ============================
27874 | 414 |    ============================================================ */
27875 | 415 | 
27876 | 416 | export async function prepare(page, url) {
27877 | 417 |   console.log(`[FB][ui:watch] Otwieranie wideo (Watch): ${url}`);
27878 | 418 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
27879 | 419 |   if (!ok) throw new Error("safeGoto-failed");
27880 | 420 | 
27881 | 421 |   await acceptCookies(page, "watch-initial");
27882 | 422 | 
27883 | 423 |   const currentUrl = page.url();
27884 | 424 |   if (currentUrl.includes("/login")) {
27885 | 425 |     console.log("[FB][ui:watch] Wymagane logowanie do Facebook ‚Äì logujƒô...");
27886 | 426 |     await fbLogin(page);
27887 | 427 |     await sleepRandom(3000, 4500);
27888 | 428 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
27889 | 429 |     console.log(
27890 | 430 |       `[FB][ui:watch] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
27891 | 431 |     );
27892 | 432 |     if (loggedAfterLogin) {
27893 | 433 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
27894 | 434 |       await acceptCookies(page, "watch-post-login");
27895 | 435 |     } else {
27896 | 436 |       console.log("[FB][ui:watch] Logowanie nie powiod≈Ço siƒô ‚Äì kontynuujƒô bez sesji.");
27897 | 437 |     }
27898 | 438 |   } else {
27899 | 439 |     const logged = await checkIfLogged(page).catch(() => false);
27900 | 440 |     if (!logged) {
27901 | 441 |       console.log("[FB][ui:watch] Brak sesji ‚Äì fbLogin().");
27902 | 442 |       await fbLogin(page);
27903 | 443 |       await sleepRandom(3000, 4500);
27904 | 444 |       await acceptCookies(page, "watch-after-login");
27905 | 445 |       const logged2 = await checkIfLogged(page).catch(() => false);
27906 | 446 |       console.log(`[FB][ui:watch] Stan sesji po fbLogin: ${logged2 ? "ZALOGOWANY" : "NIEZALOGOWANY"}`);
27907 | 447 |     }
27908 | 448 |   }
27909 | 449 | 
27910 | 450 |   try {
27911 | 451 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
27912 | 452 |     if (loggedFinal) await saveCookies(page);
27913 | 453 |   } catch {}
27914 | 454 | 
27915 | 455 |   await acceptCookies(page, "watch");
27916 | 456 | 
27917 | 457 |   try {
27918 | 458 |     await page.evaluate(() => {
27919 | 459 |       const vids = Array.from(document.querySelectorAll("video"));
27920 | 460 |       for (const v of vids) {
27921 | 461 |         try {
27922 | 462 |           v.autoplay = false;
27923 | 463 |           v.removeAttribute("autoplay");
27924 | 464 |           v.muted = true;
27925 | 465 |           v.pause();
27926 | 466 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
27927 | 467 |         } catch {}
27928 | 468 |       }
27929 | 469 |     });
27930 | 470 |     console.log("[FB][ui:watch] Wideo wstrzymane (pause).");
27931 | 471 |   } catch (e) {
27932 | 472 |     console.log("[FB][ui:watch] B≈ÇƒÖd wstrzymania wideo:", e?.message || e);
27933 | 473 |   }
27934 | 474 | 
27935 | 475 |   if (DEBUG_WATCH) {
27936 | 476 |     await safeShot(page, "watch-prepare.png");
27937 | 477 |   }
27938 | 478 | }
27939 | 479 | 
27940 | 480 | export async function getCommentCount(page, url) {
27941 | 481 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
27942 | 482 | 
27943 | 483 |   const parsedFromUiRaw = uiInfo?.raw ? parseBestCommentsCountFromBlob(uiInfo.raw) : null;
27944 | 484 | 
27945 | 485 |   let parsedFromOuter = null;
27946 | 486 |   const outer = await findCommentsOuter(page).catch(() => null);
27947 | 487 |   if (outer) {
27948 | 488 |     parsedFromOuter = await page
27949 | 489 |       .evaluate((o) => (o.innerText || "").replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim(), outer)
27950 | 490 |       .then((txt) => parseBestCommentsCountFromBlob(txt))
27951 | 491 |       .catch(() => null);
27952 | 492 |   }
27953 | 493 | 
27954 | 494 |   const uiDirect =
27955 | 495 |     uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0 ? uiInfo.comments : null;
27956 | 496 | 
27957 | 497 |   const totalComments = pickBestCount([parsedFromOuter, parsedFromUiRaw, uiDirect]);
27958 | 498 | 
27959 | 499 |   console.log(`[FB][ui:watch][DBG] count sources:`, {
27960 | 500 |     ui_source: uiInfo?.source || null,
27961 | 501 |     ui_viewType: uiInfo?.viewType || null,
27962 | 502 |     ui_comments: uiDirect,
27963 | 503 |     parsedFromUiRaw,
27964 | 504 |     parsedFromOuter,
27965 | 505 |     picked: totalComments,
27966 | 506 |   });
27967 | 507 | 
27968 | 508 |   let final = totalComments;
27969 | 509 | 
27970 | 510 |   console.log(`[FB][ui:watch] Liczba komentarzy wg UI: ${final !== null ? final : "brak danych"}`);
27971 | 511 |   return final;
27972 | 512 | }
27973 | 513 | 
27974 | 514 | export async function loadAllComments(page, { expectedTotal } = {}) {
27975 | 515 |   console.log("[FB][ui:watch] ≈Åadujƒô wszystkie komentarze (Watch)...");
27976 | 516 | 
27977 | 517 |   let maxCycles = 40;
27978 | 518 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
27979 | 519 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
27980 | 520 |   }
27981 | 521 |   console.log(`[FB][ui:watch] Rozpoczynam sekwencyjne ≈Çadowanie komentarzy, maxCycles=${maxCycles}.`);
27982 | 522 | 
27983 | 523 |   const outer = await findCommentsOuter(page);
27984 | 524 |   if (!outer) {
27985 | 525 |     console.log("[FB][ui:watch][DBG] OUTER NOT FOUND -> return");
27986 | 526 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
27987 | 527 |     return;
27988 | 528 |   }
27989 | 529 | 
27990 | 530 |   if (DEBUG_WATCH) {
27991 | 531 |     const stats = await debugOuterStats(page, outer);
27992 | 532 |     console.log("[FB][ui:watch][DBG] OUTER stats:", stats);
27993 | 533 |     await shotElement(page, outer, "watch-outer.png");
27994 | 534 |   }
27995 | 535 | 
27996 | 536 |   const scroller = await findScrollableInOuter(page, outer);
27997 | 537 | 
27998 | 538 |   if (DEBUG_WATCH) {
27999 | 539 |     if (scroller) {
28000 | 540 |       const sstats = await debugScrollerStats(page, scroller);
28001 | 541 |       console.log("[FB][ui:watch][DBG] SCROLLER stats:", sstats);
28002 | 542 |       await shotElement(page, scroller, "watch-scroller.png");
28003 | 543 |     } else {
28004 | 544 |       console.log("[FB][ui:watch][DBG] SCROLLER NOT FOUND -> fallback: window scroll");
28005 | 545 |       await safeShot(page, "watch-no-scroller.png");
28006 | 546 |     }
28007 | 547 |   }
28008 | 548 | 
28009 | 549 |   let prevAnchors = await getAnchorsCount(page, outer);
28010 | 550 |   let prevRoots = await getCommentRootsCount(page, outer);
28011 | 551 |   let noProgress = 0;
28012 | 552 | 
28013 | 553 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
28014 | 554 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
28015 | 555 | 
28016 | 556 |     let wheeled = false;
28017 | 557 |     let beforeST = 0;
28018 | 558 |     let afterST = 0;
28019 | 559 | 
28020 | 560 |     if (scroller) {
28021 | 561 |       try {
28022 | 562 |         beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
28023 | 563 |       } catch {}
28024 | 564 | 
28025 | 565 |       try {
28026 | 566 |         const box = await scroller.boundingBox();
28027 | 567 |         if (box && box.width > 5 && box.height > 5) {
28028 | 568 |           await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
28029 | 569 |           await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
28030 | 570 |           wheeled = true;
28031 | 571 |         }
28032 | 572 |       } catch {}
28033 | 573 | 
28034 | 574 |       await sleepRandom(450, 850);
28035 | 575 | 
28036 | 576 |       try {
28037 | 577 |         afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
28038 | 578 |       } catch {}
28039 | 579 |     } else {
28040 | 580 |       try {
28041 | 581 |         beforeST = await page.evaluate(() => {
28042 | 582 |           const el = document.scrollingElement || document.documentElement;
28043 | 583 |           return el ? el.scrollTop || 0 : 0;
28044 | 584 |         });
28045 | 585 |       } catch {}
28046 | 586 |       try {
28047 | 587 |         await page.mouse.wheel({ deltaY: 900 });
28048 | 588 |         wheeled = true;
28049 | 589 |       } catch {}
28050 | 590 |       await sleepRandom(450, 850);
28051 | 591 |       try {
28052 | 592 |         afterST = await page.evaluate(() => {
28053 | 593 |           const el = document.scrollingElement || document.documentElement;
28054 | 594 |           return el ? el.scrollTop || 0 : 0;
28055 | 595 |         });
28056 | 596 |       } catch {}
28057 | 597 |     }
28058 | 598 | 
28059 | 599 |     const curAnchors = await getAnchorsCount(page, outer);
28060 | 600 |     const curRoots = await getCommentRootsCount(page, outer);
28061 | 601 | 
28062 | 602 |     const progressed = curAnchors > prevAnchors || curRoots > prevRoots;
28063 | 603 | 
28064 | 604 |     if (progressed) {
28065 | 605 |       prevAnchors = curAnchors;
28066 | 606 |       prevRoots = curRoots;
28067 | 607 |       noProgress = 0;
28068 | 608 |     } else {
28069 | 609 |       noProgress++;
28070 | 610 |     }
28071 | 611 | 
28072 | 612 |     console.log(
28073 | 613 |       `[FB][ui:watch][DBG] cycle ${cycle}/${maxCycles}: clickedMore=${clicked}, wheel=${wheeled}, scrollTop ${beforeST} -> ${afterST}, roots=${curRoots}, anchors=${curAnchors}, noProgress=${noProgress}`
28074 | 614 |     );
28075 | 615 | 
28076 | 616 |     if (DEBUG_WATCH && cycle === 5) {
28077 | 617 |       await safeShot(page, "watch-after-5.png");
28078 | 618 |     }
28079 | 619 | 
28080 | 620 |     if (noProgress >= 8) {
28081 | 621 |       console.log("[FB][ui:watch] Brak postƒôpu przez kilka cykli ‚Äì przerywam.");
28082 | 622 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
28083 | 623 |       break;
28084 | 624 |     }
28085 | 625 |   }
28086 | 626 | 
28087 | 627 |   console.log("[FB][ui:watch] Za≈Çadowano wszystkie dostƒôpne komentarze (Watch).");
28088 | 628 | }
28089 | 629 | 
28090 | 630 | export async function extractComments(page, url) {
28091 | 631 |   const outer = await findCommentsOuter(page).catch(() => null);
28092 | 632 |   if (!outer) {
28093 | 633 |     console.log("[FB][ui:watch][DBG] extractComments: OUTER NOT FOUND");
28094 | 634 |     if (DEBUG_WATCH) await safeShot(page, "watch-extract-no-outer.png");
28095 | 635 |     return [];
28096 | 636 |   }
28097 | 637 | 
28098 | 638 |   const comments = await page.evaluate((outerEl) => {
28099 | 639 |     function norm(s) {
28100 | 640 |       return String(s || "")
28101 | 641 |         .replace(/\u00a0/g, " ")
28102 | 642 |         .replace(/\s+/g, " ")
28103 | 643 |         .trim();
28104 | 644 |     }
28105 | 645 | 
28106 | 646 |     function toAbsHref(href) {
28107 | 647 |       if (!href) return null;
28108 | 648 |       if (href.startsWith("http")) return href;
28109 | 649 |       if (href.startsWith("/")) return `${location.origin}${href}`;
28110 | 650 |       return href;
28111 | 651 |     }
28112 | 652 | 
28113 | 653 |     function getCommentId(href) {
28114 | 654 |       try {
28115 | 655 |         const u = new URL(href, location.origin);
28116 | 656 |         return u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
28117 | 657 |       } catch {
28118 | 658 |         return null;
28119 | 659 |       }
28120 | 660 |     }
28121 | 661 | 
28122 | 662 |     function normalizeTime(text) {
28123 | 663 |       if (!text) return null;
28124 | 664 | 
28125 | 665 |       const t = norm(text).toLowerCase();
28126 | 666 |       if (!t) return null;
28127 | 667 | 
28128 | 668 |       if (t.includes("przed chwilƒÖ")) return "0 min";
28129 | 669 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
28130 | 670 |       if (t.includes("wczoraj") || t.includes("yesterday")) return "wczoraj";
28131 | 671 | 
28132 | 672 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
28133 | 673 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô)\b/.test(t)) return t;
28134 | 674 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
28135 | 675 |       if (/^\d+\s*(dzie≈Ñ|dni|d)\b/.test(t)) return t;
28136 | 676 |       if (/^\d+\s*(tyg|tyg\.|week|weeks)\b/.test(t)) return t;
28137 | 677 | 
28138 | 678 |       return null;
28139 | 679 |     }
28140 | 680 | 
28141 | 681 |     function findTimeInRoot(root) {
28142 | 682 |       if (!root) return null;
28143 | 683 | 
28144 | 684 |       const els = Array.from(root.querySelectorAll("abbr, a, span")).slice(0, 250);
28145 | 685 |       for (const el of els) {
28146 | 686 |         const aria = el.getAttribute?.("aria-label");
28147 | 687 |         const t1 = normalizeTime(aria);
28148 | 688 |         if (t1) return t1;
28149 | 689 | 
28150 | 690 |         const title = el.getAttribute?.("title");
28151 | 691 |         const t2 = normalizeTime(title);
28152 | 692 |         if (t2) return t2;
28153 | 693 | 
28154 | 694 |         const txt = el.textContent;
28155 | 695 |         const t3 = normalizeTime(txt);
28156 | 696 |         if (t3) return t3;
28157 | 697 |       }
28158 | 698 |       return null;
28159 | 699 |     }
28160 | 700 | 
28161 | 701 |     const anchors = Array.from(
28162 | 702 |       outerEl.querySelectorAll("a[href*='comment_id='], a[href*='reply_comment_id=']")
28163 | 703 |     );
28164 | 704 | 
28165 | 705 |     const seenRoots = new Set();
28166 | 706 |     const out = [];
28167 | 707 | 
28168 | 708 |     for (const a of anchors) {
28169 | 709 |       const href = a.getAttribute("href") || a.href || null;
28170 | 710 |       const absHref = toAbsHref(href);
28171 | 711 | 
28172 | 712 |       const id = absHref ? getCommentId(absHref) : null;
28173 | 713 |       if (!id) continue;
28174 | 714 | 
28175 | 715 |       const root = a.closest?.("[role='article']") || a.closest?.("div") || null;
28176 | 716 |       if (!root) continue;
28177 | 717 |       if (seenRoots.has(root)) continue;
28178 | 718 |       seenRoots.add(root);
28179 | 719 | 
28180 | 720 |       const author =
28181 | 721 |         norm(root.querySelector("a[role='link'] span")?.textContent) ||
28182 | 722 |         norm(root.querySelector("strong")?.textContent) ||
28183 | 723 |         null;
28184 | 724 | 
28185 | 725 |       const autos = Array.from(root.querySelectorAll("[dir='auto']"))
28186 | 726 |         .map((el) => norm(el.textContent))
28187 | 727 |         .filter(Boolean);
28188 | 728 | 
28189 | 729 |       let text = "";
28190 | 730 |       if (autos.length) text = autos[autos.length - 1];
28191 | 731 | 
28192 | 732 |       const time = findTimeInRoot(root);
28193 | 733 | 
28194 | 734 |       if (!author && !text) continue;
28195 | 735 | 
28196 | 736 |       out.push({
28197 | 737 |         id,
28198 | 738 |         author,
28199 | 739 |         text,
28200 | 740 |         permalink: absHref,
28201 | 741 |         time: time || null,
28202 | 742 |       });
28203 | 743 |     }
28204 | 744 | 
28205 | 745 |     return out;
28206 | 746 |   }, outer);
28207 | 747 | 
28208 | 748 |   console.log(`[FB][ui:watch] Wyekstrahowano komentarzy: ${comments.length}`);
28209 | 749 |   return comments;
28210 | 750 | }
28211 | 751 | 
28212 | 752 | export async function debugSnapshot(page) {
28213 | 753 |   try {
28214 | 754 |     const path = `snapshot-watch.png`;
28215 | 755 |     await page.screenshot({ path });
28216 | 756 |     console.log(`[FB][ui:watch] Zapisano zrzut ekranu: ${path}`);
28217 | 757 |   } catch (e) {
28218 | 758 |     console.error("[FB][ui:watch] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
28219 | 759 |   }
28220 | 760 | }
28221 | 761 | 
28222 | ```
28223 | 
28224 | ---
28225 | 
28226 | ### üìÑ ≈öcie≈ºka: `export_chat_context/15__videos.js`
28227 | **Typ:** JavaScript/tekst  
28228 | **Opis:** Plik projektu (kod/konfiguracja).  
28229 | 
28230 | ```js
28231 |   1 | import { safeGoto } from "../../utils/navigation.js";
28232 |   2 | import { sleepRandom } from "../../utils/sleep.js";
28233 |   3 | import { acceptCookies } from "../cookies.js";
28234 |   4 | import { fbLogin, checkIfLogged } from "../login.js";
28235 |   5 | import { getUiCommentInfo } from "../uiCommentInfo.js";
28236 |   6 | 
28237 |   7 | /** Typ handlera UI */
28238 |   8 | export const type = "videos";
28239 |   9 | 
28240 |  10 | export function matchesUrl(url) {
28241 |  11 |   const lower = (url || "").toLowerCase();
28242 |  12 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
28243 |  13 | }
28244 |  14 | 
28245 |  15 | export async function prepare(page, url) {
28246 |  16 |   console.log(`[FB][ui:videos] Otwieranie posta wideo: ${url}`);
28247 |  17 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
28248 |  18 |   if (!ok) throw new Error("safeGoto-failed");
28249 |  19 | 
28250 |  20 |   const currentUrl = page.url();
28251 |  21 |   if (currentUrl.includes("/login")) {
28252 |  22 |     console.log("[FB][ui:videos] Wymagane logowanie ‚Äì pr√≥bujƒô zalogowaƒá.");
28253 |  23 |     await fbLogin(page);
28254 |  24 |     await sleepRandom(3000, 4500);
28255 |  25 | 
28256 |  26 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
28257 |  27 |     console.log(
28258 |  28 |       `[FB][ui:videos] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
28259 |  29 |     );
28260 |  30 | 
28261 |  31 |     if (loggedAfterLogin) {
28262 |  32 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
28263 |  33 |     } else {
28264 |  34 |       console.log("[FB][ui:videos] Logowanie nieudane ‚Äì kontynuacja bez sesji.");
28265 |  35 |     }
28266 |  36 |   }
28267 |  37 | 
28268 |  38 |   await acceptCookies(page, "videos");
28269 |  39 | 
28270 |  40 |   // stop autoplay
28271 |  41 |   try {
28272 |  42 |     await page.evaluate(() => {
28273 |  43 |       const vids = Array.from(document.querySelectorAll("video"));
28274 |  44 |       for (const v of vids) {
28275 |  45 |         try {
28276 |  46 |           v.autoplay = false;
28277 |  47 |           v.removeAttribute("autoplay");
28278 |  48 |           v.muted = true;
28279 |  49 |           v.pause();
28280 |  50 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
28281 |  51 |         } catch {}
28282 |  52 |       }
28283 |  53 |     });
28284 |  54 |     console.log("[FB][ui:videos] Wideo wstrzymane (autoplay wy≈ÇƒÖczony).");
28285 |  55 |   } catch (e) {
28286 |  56 |     console.log("[FB][ui:videos] B≈ÇƒÖd zatrzymania wideo:", e?.message || e);
28287 |  57 |   }
28288 |  58 | }
28289 |  59 | 
28290 |  60 | export async function getCommentCount(page, url) {
28291 |  61 |   const uiInfo = await getUiCommentInfo(page);
28292 |  62 |   console.log(`[FB][ui:videos][DBG] UI info:`, {
28293 |  63 |     source: uiInfo?.source,
28294 |  64 |     raw: uiInfo?.raw,
28295 |  65 |     viewType: uiInfo?.viewType,
28296 |  66 |     comments: uiInfo?.comments,
28297 |  67 |   });
28298 |  68 | 
28299 |  69 |   let totalComments = null;
28300 |  70 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
28301 |  71 | 
28302 |  72 |   console.log(
28303 |  73 |     `[FB][ui:videos] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`
28304 |  74 |   );
28305 |  75 |   return totalComments;
28306 |  76 | }
28307 |  77 | 
28308 |  78 | /* ==============================
28309 |  79 |    ======= DEBUG HELPERS ========
28310 |  80 |    ============================== */
28311 |  81 | 
28312 |  82 | function shortenHtml(html, max = 220) {
28313 |  83 |   if (!html) return null;
28314 |  84 |   const s = String(html).replace(/\s+/g, " ").trim();
28315 |  85 |   if (s.length <= max) return s;
28316 |  86 |   return s.slice(0, max) + "‚Ä¶";
28317 |  87 | }
28318 |  88 | 
28319 |  89 | async function debugDumpShowAllCandidates(page) {
28320 |  90 |   const out = await page.evaluate(() => {
28321 |  91 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
28322 |  92 |     function pick(el) {
28323 |  93 |       if (!el) return null;
28324 |  94 |       const r = el.getBoundingClientRect();
28325 |  95 |       return {
28326 |  96 |         tag: el.tagName,
28327 |  97 |         role: el.getAttribute("role"),
28328 |  98 |         aria: el.getAttribute("aria-label"),
28329 |  99 |         text: norm(el.textContent),
28330 | 100 |         top: Math.round(r.top),
28331 | 101 |         left: Math.round(r.left),
28332 | 102 |         w: Math.round(r.width),
28333 | 103 |         h: Math.round(r.height),
28334 | 104 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
28335 | 105 |       };
28336 | 106 |     }
28337 | 107 | 
28338 | 108 |     const headers = Array.from(document.querySelectorAll("span"))
28339 | 109 |       .filter((s) => {
28340 | 110 |         const t = norm(s.textContent).toLowerCase();
28341 | 111 |         return t === "komentarze" || t === "comments";
28342 | 112 |       })
28343 | 113 |       .slice(0, 5)
28344 | 114 |       .map(pick);
28345 | 115 | 
28346 | 116 |     const showAll = Array.from(
28347 | 117 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
28348 | 118 |     )
28349 | 119 |       .filter((el) => {
28350 | 120 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
28351 | 121 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
28352 | 122 |       })
28353 | 123 |       .slice(0, 20)
28354 | 124 |       .map(pick);
28355 | 125 | 
28356 | 126 |     return { headers, showAll };
28357 | 127 |   });
28358 | 128 | 
28359 | 129 |   console.log("[FB][ui:videos][DBG] candidates:", JSON.stringify(out, null, 2));
28360 | 130 | }
28361 | 131 | 
28362 | 132 | /* ==========================================
28363 | 133 |    ======= COMMENTS SCOPE / MARKERS =========
28364 | 134 |    ========================================== */
28365 | 135 | 
28366 | 136 | async function markCommentsScope(page) {
28367 | 137 |   return await page.evaluate(() => {
28368 | 138 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
28369 | 139 | 
28370 | 140 |     function isVisible(el) {
28371 | 141 |       if (!el) return false;
28372 | 142 |       const st = getComputedStyle(el);
28373 | 143 |       if (st.display === "none" || st.visibility === "hidden") return false;
28374 | 144 |       const r = el.getBoundingClientRect();
28375 | 145 |       return !!r && r.width > 5 && r.height > 5;
28376 | 146 |     }
28377 | 147 | 
28378 | 148 |     function pick(el) {
28379 | 149 |       if (!el) return null;
28380 | 150 |       const r = el.getBoundingClientRect();
28381 | 151 |       return {
28382 | 152 |         tag: el.tagName,
28383 | 153 |         role: el.getAttribute("role"),
28384 | 154 |         aria: el.getAttribute("aria-label"),
28385 | 155 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
28386 | 156 |         top: Math.round(r.top),
28387 | 157 |         left: Math.round(r.left),
28388 | 158 |         w: Math.round(r.width),
28389 | 159 |         h: Math.round(r.height),
28390 | 160 |       };
28391 | 161 |     }
28392 | 162 | 
28393 | 163 |     // clear markers
28394 | 164 |     try {
28395 | 165 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
28396 | 166 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
28397 | 167 |         n.removeAttribute("data-fbw-comments-header-row")
28398 | 168 |       );
28399 | 169 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
28400 | 170 |         n.removeAttribute("data-fbw-comments-anchor")
28401 | 171 |       );
28402 | 172 |     } catch {}
28403 | 173 | 
28404 | 174 |     // find header
28405 | 175 |     const headerSpans = Array.from(document.querySelectorAll("span"))
28406 | 176 |       .filter(isVisible)
28407 | 177 |       .filter((el) => {
28408 | 178 |         const t = norm(el.textContent);
28409 | 179 |         return t === "komentarze" || t === "comments";
28410 | 180 |       });
28411 | 181 | 
28412 | 182 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
28413 | 183 | 
28414 | 184 |     // pick first visible header and mark a "root" around it
28415 | 185 |     const h = headerSpans[0];
28416 | 186 | 
28417 | 187 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
28418 | 188 |     let row = h.parentElement;
28419 | 189 |     let foundRow = null;
28420 | 190 | 
28421 | 191 |     for (let up = 0; up < 14 && row; up++) {
28422 | 192 |       const btns = Array.from(
28423 | 193 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
28424 | 194 |       ).filter(isVisible);
28425 | 195 | 
28426 | 196 |       const ok = btns.some((b) => {
28427 | 197 |         const al = norm(b.getAttribute("aria-label"));
28428 | 198 |         return (
28429 | 199 |           al === "poka≈º wszystkie" ||
28430 | 200 |           al === "wy≈õwietl wszystkie" ||
28431 | 201 |           al === "show all" ||
28432 | 202 |           al === "view all" ||
28433 | 203 |           al === "ukryj komentarze" ||
28434 | 204 |           al === "hide comments"
28435 | 205 |         );
28436 | 206 |       });
28437 | 207 | 
28438 | 208 |       if (ok) {
28439 | 209 |         foundRow = row;
28440 | 210 |         break;
28441 | 211 |       }
28442 | 212 |       row = row.parentElement;
28443 | 213 |     }
28444 | 214 | 
28445 | 215 |     if (foundRow) {
28446 | 216 |       try {
28447 | 217 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
28448 | 218 |       } catch {}
28449 | 219 |     }
28450 | 220 | 
28451 | 221 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
28452 | 222 |     let root = h.parentElement;
28453 | 223 |     let best = null;
28454 | 224 | 
28455 | 225 |     for (let up = 0; up < 26 && root; up++) {
28456 | 226 |       const txt = norm(root.innerText || "");
28457 | 227 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
28458 | 228 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
28459 | 229 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
28460 | 230 |       const isBigEnough = (root.clientHeight || 0) > 250;
28461 | 231 | 
28462 | 232 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
28463 | 233 |         best = root;
28464 | 234 |         break;
28465 | 235 |       }
28466 | 236 |       root = root.parentElement;
28467 | 237 |     }
28468 | 238 | 
28469 | 239 |     // fallback: use header row parent
28470 | 240 |     if (!best && foundRow) best = foundRow.parentElement;
28471 | 241 |     if (!best) best = document.body;
28472 | 242 | 
28473 | 243 |     try {
28474 | 244 |       best.setAttribute("data-fbw-comments-root", "1");
28475 | 245 |     } catch {}
28476 | 246 | 
28477 | 247 |     // anchor element for scroll targeting: header span itself
28478 | 248 |     try {
28479 | 249 |       h.setAttribute("data-fbw-comments-anchor", "1");
28480 | 250 |     } catch {}
28481 | 251 | 
28482 | 252 |     return {
28483 | 253 |       ok: true,
28484 | 254 |       reason: "marked",
28485 | 255 |       header: pick(h),
28486 | 256 |       row: foundRow ? pick(foundRow) : null,
28487 | 257 |       root: pick(best),
28488 | 258 |     };
28489 | 259 |   });
28490 | 260 | }
28491 | 261 | 
28492 | 262 | async function clickShowAllFromMarkedRow(page) {
28493 | 263 |   const res = await page.evaluate(() => {
28494 | 264 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
28495 | 265 | 
28496 | 266 |     function isVisible(el) {
28497 | 267 |       if (!el) return false;
28498 | 268 |       const st = getComputedStyle(el);
28499 | 269 |       if (st.display === "none" || st.visibility === "hidden") return false;
28500 | 270 |       const r = el.getBoundingClientRect();
28501 | 271 |       return !!r && r.width > 5 && r.height > 5;
28502 | 272 |     }
28503 | 273 | 
28504 | 274 |     function pick(el) {
28505 | 275 |       if (!el) return null;
28506 | 276 |       const r = el.getBoundingClientRect();
28507 | 277 |       return {
28508 | 278 |         tag: el.tagName,
28509 | 279 |         role: el.getAttribute("role"),
28510 | 280 |         aria: el.getAttribute("aria-label"),
28511 | 281 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
28512 | 282 |         top: Math.round(r.top),
28513 | 283 |         left: Math.round(r.left),
28514 | 284 |         w: Math.round(r.width),
28515 | 285 |         h: Math.round(r.height),
28516 | 286 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
28517 | 287 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
28518 | 288 |       };
28519 | 289 |     }
28520 | 290 | 
28521 | 291 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
28522 | 292 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
28523 | 293 | 
28524 | 294 |     const candidates = Array.from(
28525 | 295 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
28526 | 296 |     ).filter(isVisible);
28527 | 297 | 
28528 | 298 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
28529 | 299 |     for (const c of candidates) {
28530 | 300 |       const al = norm(c.getAttribute("aria-label"));
28531 | 301 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
28532 | 302 |         try {
28533 | 303 |           c.scrollIntoView({ block: "center", inline: "nearest" });
28534 | 304 |         } catch {}
28535 | 305 |         try {
28536 | 306 |           c.click();
28537 | 307 |         } catch {}
28538 | 308 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
28539 | 309 |       }
28540 | 310 |     }
28541 | 311 | 
28542 | 312 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
28543 | 313 |   });
28544 | 314 | 
28545 | 315 |   console.log("[FB][ui:videos][DBG] show-all click:", JSON.stringify(res, null, 2));
28546 | 316 |   return !!res?.clicked;
28547 | 317 | }
28548 | 318 | 
28549 | 319 | /* ==========================================
28550 | 320 |    ======= FILTER/SORT (Najtrafniejsze) ======
28551 | 321 |    ========================================== */
28552 | 322 | 
28553 | 323 | async function ensureAllCommentsFilter(page) {
28554 | 324 |   const res = await page.evaluate(() => {
28555 | 325 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
28556 | 326 | 
28557 | 327 |     function isVisible(el) {
28558 | 328 |       if (!el) return false;
28559 | 329 |       const st = getComputedStyle(el);
28560 | 330 |       if (st.display === "none" || st.visibility === "hidden") return false;
28561 | 331 |       const r = el.getBoundingClientRect();
28562 | 332 |       return !!r && r.width > 5 && r.height > 5;
28563 | 333 |     }
28564 | 334 | 
28565 | 335 |     function pick(el) {
28566 | 336 |       if (!el) return null;
28567 | 337 |       const r = el.getBoundingClientRect();
28568 | 338 |       return {
28569 | 339 |         tag: el.tagName,
28570 | 340 |         role: el.getAttribute("role"),
28571 | 341 |         aria: el.getAttribute("aria-label"),
28572 | 342 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
28573 | 343 |         top: Math.round(r.top),
28574 | 344 |         left: Math.round(r.left),
28575 | 345 |         w: Math.round(r.width),
28576 | 346 |         h: Math.round(r.height),
28577 | 347 |       };
28578 | 348 |     }
28579 | 349 | 
28580 | 350 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
28581 | 351 | 
28582 | 352 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
28583 | 353 |     const rootTxt = norm(root.innerText || "");
28584 | 354 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
28585 | 355 |       return { ok: true, action: "already-all", dbg: null };
28586 | 356 |     }
28587 | 357 | 
28588 | 358 |     // find the sort dropdown button in root
28589 | 359 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
28590 | 360 | 
28591 | 361 |     const sortBtn = btns.find((b) => {
28592 | 362 |       const t = norm(b.textContent);
28593 | 363 |       return (
28594 | 364 |         t === "najtrafniejsze" ||
28595 | 365 |         t === "most relevant" ||
28596 | 366 |         t === "top comments" ||
28597 | 367 |         t === "najlepsze" ||
28598 | 368 |         t === "newest" ||
28599 | 369 |         t === "najnowsze"
28600 | 370 |       );
28601 | 371 |     });
28602 | 372 | 
28603 | 373 |     if (!sortBtn) {
28604 | 374 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
28605 | 375 |     }
28606 | 376 | 
28607 | 377 |     try {
28608 | 378 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
28609 | 379 |     } catch {}
28610 | 380 |     try {
28611 | 381 |       sortBtn.click();
28612 | 382 |     } catch {}
28613 | 383 | 
28614 | 384 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
28615 | 385 |   });
28616 | 386 | 
28617 | 387 |   console.log("[FB][ui:videos][DBG] filter step#1:", JSON.stringify(res, null, 2));
28618 | 388 | 
28619 | 389 |   if (!res?.ok || res.action !== "opened-menu") return false;
28620 | 390 | 
28621 | 391 |   await sleepRandom(400, 700);
28622 | 392 | 
28623 | 393 |   const res2 = await page.evaluate(() => {
28624 | 394 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
28625 | 395 | 
28626 | 396 |     function isVisible(el) {
28627 | 397 |       if (!el) return false;
28628 | 398 |       const st = getComputedStyle(el);
28629 | 399 |       if (st.display === "none" || st.visibility === "hidden") return false;
28630 | 400 |       const r = el.getBoundingClientRect();
28631 | 401 |       return !!r && r.width > 5 && r.height > 5;
28632 | 402 |     }
28633 | 403 | 
28634 | 404 |     function pick(el) {
28635 | 405 |       if (!el) return null;
28636 | 406 |       const r = el.getBoundingClientRect();
28637 | 407 |       return {
28638 | 408 |         tag: el.tagName,
28639 | 409 |         role: el.getAttribute("role"),
28640 | 410 |         aria: el.getAttribute("aria-label"),
28641 | 411 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
28642 | 412 |         top: Math.round(r.top),
28643 | 413 |         left: Math.round(r.left),
28644 | 414 |         w: Math.round(r.width),
28645 | 415 |         h: Math.round(r.height),
28646 | 416 |       };
28647 | 417 |     }
28648 | 418 | 
28649 | 419 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
28650 | 420 | 
28651 | 421 |     if (!menu) return { ok: false, action: "no-menu" };
28652 | 422 | 
28653 | 423 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
28654 | 424 |       .filter(isVisible)
28655 | 425 |       .slice(0, 200);
28656 | 426 | 
28657 | 427 |     // Prefer: "Wszystkie komentarze" / "All comments"
28658 | 428 |     let target =
28659 | 429 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
28660 | 430 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
28661 | 431 | 
28662 | 432 |     // Fallback: "Najnowsze" / "Newest"
28663 | 433 |     if (!target) {
28664 | 434 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
28665 | 435 |     }
28666 | 436 | 
28667 | 437 |     if (!target) {
28668 | 438 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
28669 | 439 |     }
28670 | 440 | 
28671 | 441 |     try {
28672 | 442 |       target.scrollIntoView({ block: "center", inline: "nearest" });
28673 | 443 |     } catch {}
28674 | 444 |     try {
28675 | 445 |       target.click();
28676 | 446 |     } catch {}
28677 | 447 | 
28678 | 448 |     // close menu
28679 | 449 |     try {
28680 | 450 |       setTimeout(() => document.body.click(), 40);
28681 | 451 |     } catch {}
28682 | 452 | 
28683 | 453 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
28684 | 454 |   });
28685 | 455 | 
28686 | 456 |   console.log("[FB][ui:videos][DBG] filter step#2:", JSON.stringify(res2, null, 2));
28687 | 457 | 
28688 | 458 |   await sleepRandom(500, 900);
28689 | 459 | 
28690 | 460 |   return !!res2?.ok;
28691 | 461 | }
28692 | 462 | 
28693 | 463 | /* ==========================================
28694 | 464 |    ======= SEQUENTIAL ACTION LOOP ============
28695 | 465 |    ========================================== */
28696 | 466 | 
28697 | 467 | async function oneSequentialAction(page) {
28698 | 468 |   const res = await page.evaluate(() => {
28699 | 469 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
28700 | 470 | 
28701 | 471 |     function isVisible(el) {
28702 | 472 |       if (!el) return false;
28703 | 473 |       const st = getComputedStyle(el);
28704 | 474 |       if (st.display === "none" || st.visibility === "hidden") return false;
28705 | 475 |       const r = el.getBoundingClientRect();
28706 | 476 |       return !!r && r.width > 5 && r.height > 5;
28707 | 477 |     }
28708 | 478 | 
28709 | 479 |     function pick(el) {
28710 | 480 |       if (!el) return null;
28711 | 481 |       const r = el.getBoundingClientRect();
28712 | 482 |       return {
28713 | 483 |         tag: el.tagName,
28714 | 484 |         role: el.getAttribute("role"),
28715 | 485 |         aria: el.getAttribute("aria-label"),
28716 | 486 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
28717 | 487 |         top: Math.round(r.top),
28718 | 488 |         left: Math.round(r.left),
28719 | 489 |         w: Math.round(r.width),
28720 | 490 |         h: Math.round(r.height),
28721 | 491 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
28722 | 492 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
28723 | 493 |       };
28724 | 494 |     }
28725 | 495 | 
28726 | 496 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
28727 | 497 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
28728 | 498 | 
28729 | 499 |     const composer =
28730 | 500 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
28731 | 501 |       root.querySelector("[aria-label^='Write a comment']") ||
28732 | 502 |       root.querySelector("[role='textbox'][contenteditable='true']");
28733 | 503 | 
28734 | 504 |     let scope = root;
28735 | 505 |     if (composer) {
28736 | 506 |       let p = composer.parentElement;
28737 | 507 |       for (let up = 0; up < 14 && p; up++) {
28738 | 508 |         const bigEnough = (p.clientHeight || 0) > 220;
28739 | 509 |         const t = norm(p.innerText || "");
28740 | 510 |         const looksCommenty =
28741 | 511 |           t.includes("najtrafniejsze") ||
28742 | 512 |           t.includes("most relevant") ||
28743 | 513 |           t.includes("wszystkie komentarze") ||
28744 | 514 |           t.includes("all comments") ||
28745 | 515 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
28746 | 516 |           t.includes("view more comments");
28747 | 517 |         if (bigEnough && looksCommenty) {
28748 | 518 |           scope = p;
28749 | 519 |           break;
28750 | 520 |         }
28751 | 521 |         p = p.parentElement;
28752 | 522 |       }
28753 | 523 |     }
28754 | 524 | 
28755 | 525 |     // UWAGA: klikamy TYLKO elementy klikalne
28756 | 526 |     const clickables = Array.from(
28757 | 527 |       scope.querySelectorAll(
28758 | 528 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
28759 | 529 |       )
28760 | 530 |     )
28761 | 531 |       .filter(isVisible)
28762 | 532 |       .slice(0, 12000);
28763 | 533 | 
28764 | 534 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
28765 | 535 | 
28766 | 536 |     const moreCommentNeedles = [
28767 | 537 |       "wy≈õwietl wiƒôcej komentarzy",
28768 | 538 |       "zobacz wiƒôcej komentarzy",
28769 | 539 |       "view more comments",
28770 | 540 |       "view previous comments",
28771 | 541 |       "see more comments",
28772 | 542 |     ];
28773 | 543 | 
28774 | 544 |     // 1) MORE COMMENTS ‚Äì tylko clickables
28775 | 545 |     for (const el of clickables) {
28776 | 546 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
28777 | 547 |       if (!t) continue;
28778 | 548 |       if (bannedExact.has(t)) continue;
28779 | 549 | 
28780 | 550 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
28781 | 551 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
28782 | 552 |         try { el.click(); } catch {}
28783 | 553 |         return { acted: true, action: "more-comments", dbg: pick(el) };
28784 | 554 |       }
28785 | 555 |     }
28786 | 556 | 
28787 | 557 |     // 2) REPLIES ‚Äì tylko clickables
28788 | 558 |     for (const el of clickables) {
28789 | 559 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
28790 | 560 |       if (!t) continue;
28791 | 561 |       if (bannedExact.has(t)) continue;
28792 | 562 | 
28793 | 563 |       const isReply =
28794 | 564 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
28795 | 565 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
28796 | 566 |         t.includes("view more replies") ||
28797 | 567 |         t.includes("see more replies") ||
28798 | 568 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
28799 | 569 | 
28800 | 570 |       if (isReply) {
28801 | 571 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
28802 | 572 |         try { el.click(); } catch {}
28803 | 573 |         return { acted: true, action: "replies", dbg: pick(el) };
28804 | 574 |       }
28805 | 575 |     }
28806 | 576 | 
28807 | 577 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
28808 | 578 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
28809 | 579 | 
28810 | 580 |     const beforeScope = scope.scrollTop || 0;
28811 | 581 |     try {
28812 | 582 |       if (scope && typeof scope.scrollTop === "number") {
28813 | 583 |         scope.scrollTop = beforeScope + step;
28814 | 584 |         const afterScope = scope.scrollTop || beforeScope;
28815 | 585 |         if (afterScope > beforeScope) {
28816 | 586 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
28817 | 587 |         }
28818 | 588 |       }
28819 | 589 |     } catch {}
28820 | 590 | 
28821 | 591 |     const beforeWin = window.scrollY || 0;
28822 | 592 |     window.scrollBy(0, step);
28823 | 593 |     const afterWin = window.scrollY || 0;
28824 | 594 | 
28825 | 595 |     return {
28826 | 596 |       acted: afterWin > beforeWin,
28827 | 597 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
28828 | 598 |       dbg: { beforeWin, afterWin, step },
28829 | 599 |     };
28830 | 600 |   });
28831 | 601 | 
28832 | 602 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
28833 | 603 |   console.log("[FB][ui:videos][DBG] step:", JSON.stringify(res, null, 2));
28834 | 604 |   return res || { acted: false, action: "none", dbg: null };
28835 | 605 | }
28836 | 606 | 
28837 | 607 | 
28838 | 608 | 
28839 | 609 | /**
28840 | 610 |  * Wczytuje wszystkie komentarze dla posta wideo.
28841 | 611 |  */
28842 | 612 | export async function loadAllComments(page, { expectedTotal } = {}) {
28843 | 613 |   console.log("[FB][ui:videos] ≈Åadujƒô wszystkie komentarze (VIDEOS)...");
28844 | 614 | 
28845 | 615 |   await debugDumpShowAllCandidates(page).catch(() => {});
28846 | 616 | 
28847 | 617 |   const mark1 = await markCommentsScope(page).catch(() => null);
28848 | 618 |   console.log("[FB][ui:videos][DBG] mark#1:", JSON.stringify(mark1, null, 2));
28849 | 619 | 
28850 | 620 |   await sleepRandom(250, 500);
28851 | 621 | 
28852 | 622 |   // klik show-all z header-row
28853 | 623 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
28854 | 624 |   if (clickedAll) {
28855 | 625 |     await sleepRandom(900, 1400);
28856 | 626 |     const mark2 = await markCommentsScope(page).catch(() => null);
28857 | 627 |     console.log("[FB][ui:videos][DBG] mark#2:", JSON.stringify(mark2, null, 2));
28858 | 628 |   } else {
28859 | 629 |     console.log("[FB][ui:videos] show-all: nie klikniƒôto (patrz DBG wy≈ºej).");
28860 | 630 |   }
28861 | 631 | 
28862 | 632 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
28863 | 633 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
28864 | 634 |   console.log("[FB][ui:videos] filter ensure:", filterOk);
28865 | 635 | 
28866 | 636 |   // policz cykle dynamicznie
28867 | 637 |   let maxCycles = 180;
28868 | 638 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
28869 | 639 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
28870 | 640 |   }
28871 | 641 | 
28872 | 642 |   let noProgress = 0;
28873 | 643 | 
28874 | 644 |   for (let i = 1; i <= maxCycles; i++) {
28875 | 645 |     // jedna akcja na cykl
28876 | 646 |     const r = await oneSequentialAction(page);
28877 | 647 | 
28878 | 648 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
28879 | 649 |     if (!didProgress) noProgress++;
28880 | 650 |     else noProgress = 0;
28881 | 651 | 
28882 | 652 |     console.log(
28883 | 653 |       `[FB][ui:videos] cycle ${i}/${maxCycles} action=${r?.action} acted=${!!r?.acted} noProgress=${noProgress}`
28884 | 654 |     );
28885 | 655 | 
28886 | 656 |     if (noProgress >= 10) {
28887 | 657 |       console.log("[FB][ui:videos] Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie.");
28888 | 658 |       break;
28889 | 659 |     }
28890 | 660 | 
28891 | 661 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
28892 | 662 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
28893 | 663 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
28894 | 664 |     else await sleepRandom(450, 850);
28895 | 665 |   }
28896 | 666 | 
28897 | 667 |   console.log("[FB][ui:videos] Komentarze wideo za≈Çadowane.");
28898 | 668 | }
28899 | 669 | 
28900 | 670 | /**
28901 | 671 |  * Ekstrahuje komentarze z posta wideo.
28902 | 672 |  */
28903 | 673 | export async function extractComments(page, url) {
28904 | 674 |   const comments = await page.evaluate(() => {
28905 | 675 |     function getCommentId(href) {
28906 | 676 |       try {
28907 | 677 |         const u = new URL(href, location.origin);
28908 | 678 |         const cid = u.searchParams.get("comment_id");
28909 | 679 |         const rid = u.searchParams.get("reply_comment_id");
28910 | 680 |         return rid || cid;
28911 | 681 |       } catch {
28912 | 682 |         return null;
28913 | 683 |       }
28914 | 684 |     }
28915 | 685 | 
28916 | 686 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
28917 | 687 |     const idToTime = {};
28918 | 688 | 
28919 | 689 |     for (let i = 0; i < allLinks.length; i++) {
28920 | 690 |       const id = getCommentId(allLinks[i].href || "");
28921 | 691 |       if (id) {
28922 | 692 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
28923 | 693 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
28924 | 694 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
28925 | 695 |             idToTime[id] = txt;
28926 | 696 |             break;
28927 | 697 |           }
28928 | 698 |         }
28929 | 699 |       }
28930 | 700 |     }
28931 | 701 | 
28932 | 702 |     const commentBlocks = Array.from(
28933 | 703 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
28934 | 704 |     );
28935 | 705 | 
28936 | 706 |     const data = commentBlocks
28937 | 707 |       .map((node) => {
28938 | 708 |         try {
28939 | 709 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
28940 | 710 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
28941 | 711 |           const linkEl = node.querySelector('a[role="link"]');
28942 | 712 |           const href = linkEl?.getAttribute("href");
28943 | 713 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
28944 | 714 |           const id = permalink ? getCommentId(permalink) : null;
28945 | 715 |           const time = id && idToTime[id] ? idToTime[id] : null;
28946 | 716 | 
28947 | 717 |           if (!author && !text) return null;
28948 | 718 |           return { id, author, text, permalink, time };
28949 | 719 |         } catch {
28950 | 720 |           return null;
28951 | 721 |         }
28952 | 722 |       })
28953 | 723 |       .filter(Boolean);
28954 | 724 | 
28955 | 725 |     return data;
28956 | 726 |   });
28957 | 727 | 
28958 | 728 |   console.log(`[FB][ui:videos] Wyekstrahowano komentarzy: ${comments.length}`);
28959 | 729 |   return comments;
28960 | 730 | }
28961 | 731 | 
28962 | 732 | export async function debugSnapshot(page) {
28963 | 733 |   try {
28964 | 734 |     const path = `snapshot-videos.png`;
28965 | 735 |     await page.screenshot({ path });
28966 | 736 |     console.log(`[FB][ui:videos] Zapisano zrzut ekranu: ${path}`);
28967 | 737 |   } catch (e) {
28968 | 738 |     console.error("[FB][ui:videos] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
28969 | 739 |   }
28970 | 740 | }
28971 | 741 | 
28972 | ```
28973 | 
28974 | ---
28975 | 
28976 | ### üìÑ ≈öcie≈ºka: `export_chat_context/16__navigation.js`
28977 | **Typ:** JavaScript/tekst  
28978 | **Opis:** Plik projektu (kod/konfiguracja).  
28979 | 
28980 | ```js
28981 |  1 | // src/utils/navigation.js
28982 |  2 | import { sleepRandom } from "./sleep.js";
28983 |  3 | 
28984 |  4 | /**
28985 |  5 |  * Bezpieczne page.goto z retry.
28986 |  6 |  * - pr√≥buje kilka razy
28987 |  7 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
28988 |  8 |  */
28989 |  9 | export async function safeGoto(page, url, label = "goto", options = {}) {
28990 | 10 |   const MAX_ATTEMPTS = 3;
28991 | 11 | 
28992 | 12 |   const finalOptions = {
28993 | 13 |     waitUntil: "networkidle2",
28994 | 14 |     timeout: 90000, // 90s
28995 | 15 |     ...options,
28996 | 16 |   };
28997 | 17 | 
28998 | 18 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
28999 | 19 |     try {
29000 | 20 |       console.log(
29001 | 21 |         `[NAV] (${label}) pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`
29002 | 22 |       );
29003 | 23 | 
29004 | 24 |   // === FORCE DESKTOP PROFILE (SERVER FIX) ===
29005 | 25 |   await page.setViewport({ width: 1366, height: 768 });
29006 | 26 | // DISABLED UA // === END FORCE DESKTOP PROFILE ===
29007 | 27 | 
29008 | 28 |       await page.goto(url, finalOptions);
29009 | 29 | 
29010 | 30 |       console.log(`[NAV] (${label}) OK na pr√≥bie ${attempt}`);
29011 | 31 |       return true;
29012 | 32 |     } catch (err) {
29013 | 33 |       console.error(
29014 | 34 |         `[NAV] (${label}) b≈ÇƒÖd na pr√≥bie ${attempt}:`,
29015 | 35 |         err.message
29016 | 36 |       );
29017 | 37 | 
29018 | 38 |       if (attempt === MAX_ATTEMPTS) {
29019 | 39 |         // sygna≈Ç dla wy≈ºej: to ju≈º nie jest chwilowy lag
29020 | 40 |         return false;
29021 | 41 |       }
29022 | 42 | 
29023 | 43 |       // chwila przerwy
29024 | 44 |       await sleepRandom(3000, 7000);
29025 | 45 | 
29026 | 46 |       // pr√≥ba ‚Äûprzep≈Çukania‚Äù sesji ‚Äì wej≈õcie na FB
29027 | 47 |       try {
29028 | 48 |         console.log("[NAV] pr√≥ba od≈õwie≈ºenia FB (strona g≈Ç√≥wna)...");
29029 | 49 |         await page
29030 | 50 |           .goto("https://www.facebook.com/", {
29031 | 51 |             waitUntil: "load",
29032 | 52 |             timeout: 45000,
29033 | 53 |           })
29034 | 54 |           .catch(() => {});
29035 | 55 |       } catch (e2) {
29036 | 56 |         console.error(
29037 | 57 |           "[NAV] od≈õwie≈ºenie FB te≈º polecia≈Ço b≈Çƒôdem:",
29038 | 58 |           e2.message
29039 | 59 |         );
29040 | 60 |       }
29041 | 61 |     }
29042 | 62 |   }
29043 | 63 | 
29044 | 64 |   // tu w praktyce nie dojdziemy
29045 | 65 |   return false;
29046 | 66 | }
29047 | 67 | 
29048 | ```
29049 | 
29050 | ---
29051 | 
29052 | ### üìÑ ≈öcie≈ºka: `export_chat_context/17__sleep.js`
29053 | **Typ:** JavaScript/tekst  
29054 | **Opis:** Plik projektu (kod/konfiguracja).  
29055 | 
29056 | ```js
29057 |  1 | function sleep(ms) {
29058 |  2 |   return new Promise((res) => setTimeout(res, ms));
29059 |  3 | }
29060 |  4 | 
29061 |  5 | function sleepRandom(minMs, maxMs) {
29062 |  6 |   const delta = maxMs - minMs;
29063 |  7 |   const extra = Math.random() * delta;
29064 |  8 |   return sleep(minMs + extra);
29065 |  9 | }
29066 | 10 | 
29067 | 11 | export { sleep, sleepRandom };
29068 | 12 | 
29069 | ```
29070 | 
29071 | ---
29072 | 
29073 | ### üìÑ ≈öcie≈ºka: `export_chat_context/18__api.js`
29074 | **Typ:** JavaScript/tekst  
29075 | **Opis:** Plik projektu (kod/konfiguracja).  
29076 | 
29077 | ```js
29078 |   1 | // panel/api.js
29079 |   2 | import http from "http";
29080 |   3 | import { exec } from "child_process";
29081 |   4 | import fs from "fs";
29082 |   5 | import path from "path";
29083 |   6 | import crypto from "crypto";
29084 |   7 | import dotenv from "dotenv";
29085 |   8 | 
29086 |   9 | // ---- BASE DIR (dev vs exe) ----
29087 |  10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
29088 |  11 | 
29089 |  12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
29090 |  13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
29091 |  14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
29092 |  15 | 
29093 |  16 | // UI: dev -> src/panel/ui, exe -> ./ui
29094 |  17 | const UI_DIR = process.pkg
29095 |  18 |   ? path.join(BASE_DIR, "ui")
29096 |  19 |   : path.join(BASE_DIR, "src", "panel", "ui");
29097 |  20 | 
29098 |  21 | const PORT = Number(process.env.PANEL_PORT || 3180);
29099 |  22 | const TOKEN = process.env.PANEL_TOKEN;
29100 |  23 | 
29101 |  24 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
29102 |  25 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
29103 |  26 | 
29104 |  27 | if (!TOKEN) {
29105 |  28 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
29106 |  29 |   process.exit(1);
29107 |  30 | }
29108 |  31 | 
29109 |  32 | function auth(req, res) {
29110 |  33 |   const h = req.headers["authorization"] || "";
29111 |  34 |   if (h !== `Bearer ${TOKEN}`) {
29112 |  35 |     res.writeHead(401);
29113 |  36 |     res.end("Unauthorized");
29114 |  37 |     return false;
29115 |  38 |   }
29116 |  39 |   return true;
29117 |  40 | }
29118 |  41 | 
29119 |  42 | function json(res, obj, code = 200) {
29120 |  43 |   res.writeHead(code, { "Content-Type": "application/json" });
29121 |  44 |   res.end(JSON.stringify(obj, null, 2));
29122 |  45 | }
29123 |  46 | 
29124 |  47 | function sh(cmd) {
29125 |  48 |   return new Promise((resolve) => {
29126 |  49 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
29127 |  50 |       resolve({
29128 |  51 |         ok: !err,
29129 |  52 |         stdout: (stdout || "").trim(),
29130 |  53 |         stderr: (stderr || "").trim(),
29131 |  54 |         code: err?.code ?? 0,
29132 |  55 |       });
29133 |  56 |     });
29134 |  57 |   });
29135 |  58 | }
29136 |  59 | 
29137 |  60 | 
29138 |  61 | async function getProjectDir() {
29139 |  62 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
29140 |  63 | 
29141 |  64 |   const r = await sh(`pm2 describe ${PM2_APP}`);
29142 |  65 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
29143 |  66 |   if (!m)
29144 |  67 |     throw new Error(
29145 |  68 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
29146 |  69 |     );
29147 |  70 |   return m[1].trim();
29148 |  71 | }
29149 |  72 | 
29150 |  73 | function readBody(req) {
29151 |  74 |   return new Promise((resolve) => {
29152 |  75 |     let d = "";
29153 |  76 |     req.on("data", (c) => (d += c));
29154 |  77 |     req.on("end", () => resolve(d));
29155 |  78 |   });
29156 |  79 | }
29157 |  80 | 
29158 |  81 | function safeJsonParse(s) {
29159 |  82 |   try {
29160 |  83 |     return { ok: true, value: JSON.parse(s) };
29161 |  84 |   } catch (e) {
29162 |  85 |     return { ok: false, error: e?.message || "Invalid JSON" };
29163 |  86 |   }
29164 |  87 | }
29165 |  88 | 
29166 |  89 | function ensureDir(p) {
29167 |  90 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
29168 |  91 | }
29169 |  92 | 
29170 |  93 | function atomicWriteFile(filePath, content) {
29171 |  94 |   const dir = path.dirname(filePath);
29172 |  95 |   ensureDir(dir);
29173 |  96 | 
29174 |  97 |   const tmp = path.join(
29175 |  98 |     dir,
29176 |  99 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
29177 | 100 |   );
29178 | 101 |   fs.writeFileSync(tmp, content, "utf8");
29179 | 102 |   fs.renameSync(tmp, filePath);
29180 | 103 | }
29181 | 104 | 
29182 | 105 | function normalizeUrl(u) {
29183 | 106 |   if (!u) return "";
29184 | 107 |   const x = String(u).trim();
29185 | 108 |   if (!/^https?:\/\/.+/i.test(x)) return "";
29186 | 109 |   return x;
29187 | 110 | }
29188 | 111 | 
29189 | 112 | function normalizeOptionalUrl(u) {
29190 | 113 |   if (!u) return "";
29191 | 114 |   const x = String(u).trim();
29192 | 115 |   if (x === "") return "";
29193 | 116 |   if (!/^https?:\/\/.+/i.test(x)) return "";
29194 | 117 |   return x;
29195 | 118 | }
29196 | 119 | 
29197 | 120 | function nowIso() {
29198 | 121 |   return new Date().toISOString();
29199 | 122 | }
29200 | 123 | 
29201 | 124 | function setEnvKey(envText, key, value) {
29202 | 125 |   const re = new RegExp(`^${key}=.*$`, "m");
29203 | 126 |   const line = `${key}=${value}`;
29204 | 127 |   if (re.test(envText)) return envText.replace(re, line);
29205 | 128 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
29206 | 129 | }
29207 | 130 | 
29208 | 131 | function pickPostsFile(projectDir) {
29209 | 132 |   return path.join(projectDir, "data", "posts.json");
29210 | 133 | }
29211 | 134 | 
29212 | 135 | function readPosts(postsPath) {
29213 | 136 |   if (!fs.existsSync(postsPath)) return [];
29214 | 137 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
29215 | 138 |   if (!raw) return [];
29216 | 139 |   const parsed = safeJsonParse(raw);
29217 | 140 |   if (!parsed.ok || !Array.isArray(parsed.value))
29218 | 141 |     throw new Error("posts.json invalid (expected array)");
29219 | 142 |   return parsed.value;
29220 | 143 | }
29221 | 144 | 
29222 | 145 | function writePosts(postsPath, posts) {
29223 | 146 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
29224 | 147 | }
29225 | 148 | 
29226 | 149 | function genId() {
29227 | 150 |   return crypto.randomBytes(8).toString("hex");
29228 | 151 | }
29229 | 152 | 
29230 | 153 | function route(req) {
29231 | 154 |   const url = new URL(req.url, "http://localhost");
29232 | 155 |   const pathname = url.pathname;
29233 | 156 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
29234 | 157 | }
29235 | 158 | 
29236 | 159 | function match(pathname, pattern) {
29237 | 160 |   const a = pathname.split("/").filter(Boolean);
29238 | 161 |   const b = pattern.split("/").filter(Boolean);
29239 | 162 |   if (a.length !== b.length) return null;
29240 | 163 |   const params = {};
29241 | 164 |   for (let i = 0; i < a.length; i++) {
29242 | 165 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
29243 | 166 |     else if (a[i] !== b[i]) return null;
29244 | 167 |   }
29245 | 168 |   return params;
29246 | 169 | }
29247 | 170 | 
29248 | 171 | // ---------- LOGS (dynamic from pm2 describe) ----------
29249 | 172 | function parsePm2LogPaths(pm2DescribeText) {
29250 | 173 |   const out =
29251 | 174 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
29252 | 175 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
29253 | 176 |     "";
29254 | 177 |   const err =
29255 | 178 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
29256 | 179 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
29257 | 180 |     "";
29258 | 181 |   return { out, err };
29259 | 182 | }
29260 | 183 | 
29261 | 184 | async function getPm2LogPaths(appName) {
29262 | 185 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
29263 | 186 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
29264 | 187 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
29265 | 188 | 
29266 | 189 |   const d = await sh(`pm2 describe ${appName}`);
29267 | 190 |   if (!d.ok)
29268 | 191 |     return {
29269 | 192 |       out: "",
29270 | 193 |       err: "",
29271 | 194 |       source: "pm2_error",
29272 | 195 |       pm2: d.stderr || d.stdout || "",
29273 | 196 |     };
29274 | 197 | 
29275 | 198 |   const p = parsePm2LogPaths(d.stdout);
29276 | 199 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
29277 | 200 | }
29278 | 201 | 
29279 | 202 | async function readTailLog(filePath, lines) {
29280 | 203 |   try {
29281 | 204 |     if (!filePath) {
29282 | 205 |       return {
29283 | 206 |         ok: false,
29284 | 207 |         error:
29285 | 208 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
29286 | 209 |         path: filePath,
29287 | 210 |       };
29288 | 211 |     }
29289 | 212 | 
29290 | 213 |     if (!fs.existsSync(filePath)) {
29291 | 214 |       return {
29292 | 215 |         ok: false,
29293 | 216 |         error:
29294 | 217 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
29295 | 218 |         path: filePath,
29296 | 219 |       };
29297 | 220 |     }
29298 | 221 | 
29299 | 222 |     const st = fs.statSync(filePath);
29300 | 223 |     if (!st || !st.isFile()) {
29301 | 224 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
29302 | 225 |     }
29303 | 226 | 
29304 | 227 |     if (st.size === 0) {
29305 | 228 |       return {
29306 | 229 |         ok: false,
29307 | 230 |         error:
29308 | 231 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
29309 | 232 |         path: filePath,
29310 | 233 |       };
29311 | 234 |     }
29312 | 235 | 
29313 | 236 |     
29314 | 237 |     // fallback JS
29315 | 238 |     const raw = fs.readFileSync(filePath, "utf8");
29316 | 239 |     const arr = raw.split(/\r?\n/);
29317 | 240 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
29318 | 241 |     const txt = (slice || "").trim();
29319 | 242 | 
29320 | 243 |     if (!txt) {
29321 | 244 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
29322 | 245 |     }
29323 | 246 | 
29324 | 247 |     return { ok: true, log: slice, path: filePath, via: "js" };
29325 | 248 |   } catch (e) {
29326 | 249 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
29327 | 250 |   }
29328 | 251 | }
29329 | 252 | 
29330 | 253 | http
29331 | 254 |   .createServer(async (req, res) => {
29332 | 255 |     const { pathname, query } = route(req);
29333 | 256 |     if (req.method === "GET" && pathname === "/ping") {
29334 | 257 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
29335 | 258 |   res.end("pong");
29336 | 259 |   return;
29337 | 260 | }
29338 | 261 | 
29339 | 262 | 
29340 | 263 |     // ---------- PUBLIC UI ----------
29341 | 264 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
29342 | 265 |       const p = path.join(UI_DIR, "index.html");
29343 | 266 |       const html = fs.readFileSync(p, "utf8");
29344 | 267 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
29345 | 268 |       res.end(html);
29346 | 269 |       return;
29347 | 270 |     }
29348 | 271 | 
29349 | 272 |     if (req.method === "GET" && pathname === "/app.js") {
29350 | 273 |       const p = path.join(UI_DIR, "app.js");
29351 | 274 |       const js = fs.readFileSync(p, "utf8");
29352 | 275 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
29353 | 276 |       res.end(js);
29354 | 277 |       return;
29355 | 278 |     }
29356 | 279 | 
29357 | 280 |     // ---------- AUTH for API ----------
29358 | 281 |     if (pathname.startsWith("/api/")) {
29359 | 282 |       if (!auth(req, res)) return;
29360 | 283 |     }
29361 | 284 | 
29362 | 285 |     try {
29363 | 286 |       const PROJECT_DIR = await getProjectDir();
29364 | 287 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
29365 | 288 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
29366 | 289 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
29367 | 290 | 
29368 | 291 |       // ===== STATUS =====
29369 | 292 |       if (req.method === "GET" && pathname === "/api/status") {
29370 | 293 |         const node = await sh("node -v");
29371 | 294 |         const pm2v = await sh("pm2 -v");
29372 | 295 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
29373 | 296 |         json(res, {
29374 | 297 |           ok: true,
29375 | 298 |           projectDir: PROJECT_DIR,
29376 | 299 |           envPath: ENV_PATH,
29377 | 300 |           cookiesPath: COOKIES_PATH,
29378 | 301 |           postsPath: POSTS_PATH,
29379 | 302 |           node: node.stdout,
29380 | 303 |           pm2: pm2v.stdout,
29381 | 304 |           pm2Status: pm2s.stdout,
29382 | 305 |           time: nowIso(),
29383 | 306 |         });
29384 | 307 |         return;
29385 | 308 |       }
29386 | 309 | 
29387 | 310 |       // ===== ENV GET (selected keys) =====
29388 | 311 |       if (req.method === "GET" && pathname === "/api/env/get") {
29389 | 312 |         if (!fs.existsSync(ENV_PATH)) {
29390 | 313 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
29391 | 314 |           return;
29392 | 315 |         }
29393 | 316 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
29394 | 317 |         const wanted = [
29395 | 318 |           "FB_EMAIL",
29396 | 319 |           "FB_PASSWORD",
29397 | 320 |           "WEBHOOK_URL",
29398 | 321 |           "CHECK_INTERVAL_MS",
29399 | 322 |           "POSTS_SHEET_URL",
29400 | 323 |           "HEADLESS_BROWSER",
29401 | 324 |           "USE_UI_HANDLERS",
29402 | 325 |           "INCLUDE_REPLIES",
29403 | 326 |         ];
29404 | 327 |         const values = {};
29405 | 328 |         for (const k of wanted) {
29406 | 329 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
29407 | 330 |           values[k] = m ? m[1] : "";
29408 | 331 |         }
29409 | 332 |         json(res, { ok: true, values });
29410 | 333 |         return;
29411 | 334 |       }
29412 | 335 | 
29413 | 336 |       // ===== ENV SET MULTIPLE =====
29414 | 337 |       if (req.method === "POST" && pathname === "/api/env/set") {
29415 | 338 |         const bodyRaw = await readBody(req);
29416 | 339 |         const parsed = safeJsonParse(bodyRaw || "{}");
29417 | 340 |         if (!parsed.ok) {
29418 | 341 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
29419 | 342 |           return;
29420 | 343 |         }
29421 | 344 | 
29422 | 345 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
29423 | 346 |         const restart = Boolean(parsed.value.restart);
29424 | 347 | 
29425 | 348 |         if (!set) {
29426 | 349 |           json(res, { ok: false, error: "Missing set object" }, 400);
29427 | 350 |           return;
29428 | 351 |         }
29429 | 352 |         if (!fs.existsSync(ENV_PATH)) {
29430 | 353 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
29431 | 354 |           return;
29432 | 355 |         }
29433 | 356 | 
29434 | 357 |         let env = fs.readFileSync(ENV_PATH, "utf8");
29435 | 358 |         const updated = [];
29436 | 359 | 
29437 | 360 |         for (const [k, v] of Object.entries(set)) {
29438 | 361 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
29439 | 362 |           env = setEnvKey(env, k, String(v));
29440 | 363 |           updated.push(k);
29441 | 364 |         }
29442 | 365 | 
29443 | 366 |         atomicWriteFile(ENV_PATH, env);
29444 | 367 | 
29445 | 368 |         let pm2Action = null;
29446 | 369 |         if (restart) {
29447 | 370 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
29448 | 371 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
29449 | 372 |         }
29450 | 373 | 
29451 | 374 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
29452 | 375 |         return;
29453 | 376 |       }
29454 | 377 | 
29455 | 378 |       // ===== POSTS: LIST =====
29456 | 379 |       if (req.method === "GET" && pathname === "/api/posts") {
29457 | 380 |         const posts = readPosts(POSTS_PATH);
29458 | 381 | 
29459 | 382 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
29460 | 383 |         const norm = (posts || []).map((p) => ({
29461 | 384 |           id: String(p.id || "").trim(),
29462 | 385 |           url: String(p.url || "").trim(),
29463 | 386 |           active: p.active !== undefined ? Boolean(p.active) : true,
29464 | 387 |           name: String(p.name || "").trim(),
29465 | 388 |           image: String(p.image || "").trim(),
29466 | 389 |           description: String(p.description || "").trim(),
29467 | 390 |           createdAt: p.createdAt || "",
29468 | 391 |           updatedAt: p.updatedAt || "",
29469 | 392 |         }));
29470 | 393 | 
29471 | 394 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
29472 | 395 |         json(res, { ok: true, posts: norm });
29473 | 396 |         return;
29474 | 397 |       }
29475 | 398 | 
29476 | 399 |       // ===== POSTS: ADD =====
29477 | 400 |       if (req.method === "POST" && pathname === "/api/posts") {
29478 | 401 |         const bodyRaw = await readBody(req);
29479 | 402 |         const parsed = safeJsonParse(bodyRaw || "{}");
29480 | 403 |         if (!parsed.ok) {
29481 | 404 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
29482 | 405 |           return;
29483 | 406 |         }
29484 | 407 | 
29485 | 408 |         const url = normalizeUrl(parsed.value.url);
29486 | 409 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
29487 | 410 | 
29488 | 411 |         const name = String(parsed.value.name || "").trim();
29489 | 412 |         const imageRaw = String(parsed.value.image || "").trim();
29490 | 413 |         const image = normalizeOptionalUrl(imageRaw);
29491 | 414 |         const description = String(parsed.value.description || "").trim();
29492 | 415 | 
29493 | 416 |         if (!url) {
29494 | 417 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
29495 | 418 |           return;
29496 | 419 |         }
29497 | 420 |         if (imageRaw !== "" && !image) {
29498 | 421 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
29499 | 422 |           return;
29500 | 423 |         }
29501 | 424 | 
29502 | 425 |         const posts = readPosts(POSTS_PATH);
29503 | 426 |         const existing = posts.find((p) => p.url === url);
29504 | 427 |         if (existing) {
29505 | 428 |           existing.active = active;
29506 | 429 |           existing.name = name;
29507 | 430 |           existing.image = image;
29508 | 431 |           existing.description = description;
29509 | 432 |           existing.updatedAt = nowIso();
29510 | 433 |           writePosts(POSTS_PATH, posts);
29511 | 434 |           json(res, { ok: true, post: existing, deduped: true });
29512 | 435 |           return;
29513 | 436 |         }
29514 | 437 | 
29515 | 438 |         const post = {
29516 | 439 |           id: genId(),
29517 | 440 |           url,
29518 | 441 |           active,
29519 | 442 |           name,
29520 | 443 |           image,
29521 | 444 |           description,
29522 | 445 |           createdAt: nowIso(),
29523 | 446 |           updatedAt: nowIso(),
29524 | 447 |         };
29525 | 448 |         posts.push(post);
29526 | 449 |         writePosts(POSTS_PATH, posts);
29527 | 450 | 
29528 | 451 |         json(res, { ok: true, post });
29529 | 452 |         return;
29530 | 453 |       }
29531 | 454 | 
29532 | 455 |       // ===== POSTS: PATCH =====
29533 | 456 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
29534 | 457 |       if (mPatch) {
29535 | 458 |         const id = mPatch.id;
29536 | 459 |         const bodyRaw = await readBody(req);
29537 | 460 |         const parsed = safeJsonParse(bodyRaw || "{}");
29538 | 461 |         if (!parsed.ok) {
29539 | 462 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
29540 | 463 |           return;
29541 | 464 |         }
29542 | 465 | 
29543 | 466 |         const posts = readPosts(POSTS_PATH);
29544 | 467 |         const post = posts.find((p) => p.id === id);
29545 | 468 |         if (!post) {
29546 | 469 |           json(res, { ok: false, error: "Post not found" }, 404);
29547 | 470 |           return;
29548 | 471 |         }
29549 | 472 | 
29550 | 473 |         if (parsed.value.url !== undefined) {
29551 | 474 |           const nextUrl = normalizeUrl(parsed.value.url);
29552 | 475 |           if (!nextUrl) {
29553 | 476 |             json(res, { ok: false, error: "Invalid url" }, 400);
29554 | 477 |             return;
29555 | 478 |           }
29556 | 479 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
29557 | 480 |           if (dup) {
29558 | 481 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
29559 | 482 |             return;
29560 | 483 |           }
29561 | 484 |           post.url = nextUrl;
29562 | 485 |         }
29563 | 486 | 
29564 | 487 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
29565 | 488 | 
29566 | 489 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
29567 | 490 | 
29568 | 491 |         if (parsed.value.image !== undefined) {
29569 | 492 |           const raw = String(parsed.value.image || "").trim();
29570 | 493 |           const img = normalizeOptionalUrl(raw);
29571 | 494 |           if (raw !== "" && !img) {
29572 | 495 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
29573 | 496 |             return;
29574 | 497 |           }
29575 | 498 |           post.image = img;
29576 | 499 |         }
29577 | 500 | 
29578 | 501 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
29579 | 502 | 
29580 | 503 |         post.updatedAt = nowIso();
29581 | 504 |         writePosts(POSTS_PATH, posts);
29582 | 505 |         json(res, { ok: true, post });
29583 | 506 |         return;
29584 | 507 |       }
29585 | 508 | 
29586 | 509 |       // ===== POSTS: DELETE =====
29587 | 510 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
29588 | 511 |       if (mDel) {
29589 | 512 |         const id = mDel.id;
29590 | 513 |         const posts = readPosts(POSTS_PATH);
29591 | 514 |         const idx = posts.findIndex((p) => p.id === id);
29592 | 515 |         if (idx === -1) {
29593 | 516 |           json(res, { ok: false, error: "Post not found" }, 404);
29594 | 517 |           return;
29595 | 518 |         }
29596 | 519 |         const removed = posts.splice(idx, 1)[0];
29597 | 520 |         writePosts(POSTS_PATH, posts);
29598 | 521 |         json(res, { ok: true, removed });
29599 | 522 |         return;
29600 | 523 |       }
29601 | 524 | 
29602 | 525 |       // ===== COOKIES: CLEAR =====
29603 | 526 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
29604 | 527 |         const bodyRaw = await readBody(req);
29605 | 528 |         const parsed = safeJsonParse(bodyRaw || "{}");
29606 | 529 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
29607 | 530 | 
29608 | 531 |         if (!confirm) {
29609 | 532 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
29610 | 533 |           return;
29611 | 534 |         }
29612 | 535 | 
29613 | 536 |         atomicWriteFile(COOKIES_PATH, "[]\n");
29614 | 537 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
29615 | 538 |         return;
29616 | 539 |       }
29617 | 540 | 
29618 | 541 |       // ===== PM2 =====
29619 | 542 |       function okOrErr(r, fallbackErr = "Command failed") {
29620 | 543 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
29621 | 544 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
29622 | 545 |       }
29623 | 546 |       async function pm2Describe(name) {
29624 | 547 |         return await sh(`pm2 describe ${name}`);
29625 | 548 |       }
29626 | 549 | 
29627 | 550 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
29628 | 551 |       const WATCH_NAME = PM2_APP || "fbwatcher";
29629 | 552 | 
29630 | 553 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
29631 | 554 |         const d = await pm2Describe(WATCH_NAME);
29632 | 555 |         if (d.ok) {
29633 | 556 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
29634 | 557 |           json(res, okOrErr(r, "PM2 start failed"));
29635 | 558 |           return;
29636 | 559 |         }
29637 | 560 | 
29638 | 561 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
29639 | 562 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
29640 | 563 |         return;
29641 | 564 |       }
29642 | 565 | 
29643 | 566 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
29644 | 567 |         const d = await pm2Describe(WATCH_NAME);
29645 | 568 |         if (!d.ok) {
29646 | 569 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
29647 | 570 |           return;
29648 | 571 |         }
29649 | 572 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
29650 | 573 |         json(res, okOrErr(r, "PM2 restart failed"));
29651 | 574 |         return;
29652 | 575 |       }
29653 | 576 | 
29654 | 577 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
29655 | 578 |         const d = await pm2Describe(WATCH_NAME);
29656 | 579 |         if (!d.ok) {
29657 | 580 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
29658 | 581 |           return;
29659 | 582 |         }
29660 | 583 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
29661 | 584 |         json(res, okOrErr(r, "PM2 stop failed"));
29662 | 585 |         return;
29663 | 586 |       }
29664 | 587 | 
29665 | 588 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
29666 | 589 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
29667 | 590 |         json(res, okOrErr(r, "PM2 status failed"));
29668 | 591 |         return;
29669 | 592 |       }
29670 | 593 | 
29671 | 594 |       // ===== LOGS INFO (debug) =====
29672 | 595 |       if (req.method === "GET" && pathname === "/api/logs/info") {
29673 | 596 |         const paths = await getPm2LogPaths(PM2_APP);
29674 | 597 |         json(res, { ok: true, app: PM2_APP, ...paths });
29675 | 598 |         return;
29676 | 599 |       }
29677 | 600 | 
29678 | 601 |       // ===== LOGS =====
29679 | 602 |       if (req.method === "GET" && pathname === "/api/logs/out") {
29680 | 603 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
29681 | 604 |         const paths = await getPm2LogPaths(PM2_APP);
29682 | 605 |         const payload = await readTailLog(paths.out, lines);
29683 | 606 |         json(res, { ...payload, source: paths.source });
29684 | 607 |         return;
29685 | 608 |       }
29686 | 609 | 
29687 | 610 |       if (req.method === "GET" && pathname === "/api/logs/err") {
29688 | 611 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
29689 | 612 |         const paths = await getPm2LogPaths(PM2_APP);
29690 | 613 |         const payload = await readTailLog(paths.err, lines);
29691 | 614 |         json(res, { ...payload, source: paths.source });
29692 | 615 |         return;
29693 | 616 |       }
29694 | 617 | 
29695 | 618 |       json(res, { ok: false, error: "Not found" }, 404);
29696 | 619 |     } catch (e) {
29697 | 620 |       json(res, { ok: false, error: e.message }, 500);
29698 | 621 |     }
29699 | 622 |   })
29700 | 623 |   .listen(PORT, "0.0.0.0", () => {
29701 | 624 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
29702 | 625 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
29703 | 626 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
29704 | 627 |   });
29705 | 628 | 
29706 | ```
29707 | 
29708 | ---
29709 | 
29710 | ### üìÑ ≈öcie≈ºka: `export_chat_context/19__index.html`
29711 | **Typ:** HTML  
29712 | **Opis:** Plik projektu (kod/konfiguracja).  
29713 | 
29714 | ```html
29715 |   1 | <!doctype html>
29716 |   2 | <html lang="pl">
29717 |   3 | <head>
29718 |   4 |   <meta charset="utf-8" />
29719 |   5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
29720 |   6 |   <title>Panel FB Watcher</title>
29721 |   7 | 
29722 |   8 |   <style>
29723 |   9 |     :root{
29724 |  10 |       --bg:#0b0f14;
29725 |  11 |       --card:#121926;
29726 |  12 |       --card2:#0b1220;
29727 |  13 |       --border:#223047;
29728 |  14 |       --border2:#2a3a55;
29729 |  15 |       --text:#e7eef7;
29730 |  16 |       --muted:rgba(231,238,247,.75);
29731 |  17 |       --primary:#2563eb;
29732 |  18 |       --danger:#b91c1c;
29733 |  19 |       --ok:#34d399;
29734 |  20 |       --err:#f87171;
29735 |  21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
29736 |  22 |       --radius:14px;
29737 |  23 |     }
29738 |  24 | 
29739 |  25 |     * { box-sizing:border-box; }
29740 |  26 |     body {
29741 |  27 |       font-family: system-ui, Arial;
29742 |  28 |       margin: 16px;
29743 |  29 |       background: var(--bg);
29744 |  30 |       color: var(--text);
29745 |  31 |     }
29746 |  32 | 
29747 |  33 |     h2 { margin: 6px 0 6px; }
29748 |  34 |     h3 { margin: 6px 0 12px; }
29749 |  35 | 
29750 |  36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
29751 |  37 |     .card {
29752 |  38 |       background: var(--card);
29753 |  39 |       border:1px solid var(--border);
29754 |  40 |       border-radius: var(--radius);
29755 |  41 |       padding:14px;
29756 |  42 |       margin:12px 0;
29757 |  43 |       box-shadow: var(--shadow);
29758 |  44 |     }
29759 |  45 | 
29760 |  46 |     input, textarea, button, select {
29761 |  47 |       font: inherit;
29762 |  48 |       border-radius:12px;
29763 |  49 |       border:1px solid var(--border2);
29764 |  50 |       background: var(--card2);
29765 |  51 |       color: var(--text);
29766 |  52 |       padding:10px 12px;
29767 |  53 |       outline: none;
29768 |  54 |     }
29769 |  55 |     input:focus, textarea:focus, select:focus {
29770 |  56 |       border-color: rgba(37, 99, 235, .75);
29771 |  57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
29772 |  58 |     }
29773 |  59 | 
29774 |  60 |     input, textarea { width: 100%; }
29775 |  61 |     textarea { resize: vertical; min-height: 90px; }
29776 |  62 | 
29777 |  63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
29778 |  64 |     button:active { transform: translateY(1px); }
29779 |  65 |     button.primary { background: var(--primary); border-color: var(--primary); }
29780 |  66 |     button.danger { background: var(--danger); border-color: var(--danger); }
29781 |  67 |     button.ghost { background: transparent; }
29782 |  68 |     button.small { padding:8px 10px; border-radius: 10px; }
29783 |  69 | 
29784 |  70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
29785 |  71 | 
29786 |  72 |     .muted { opacity:0.78; font-size:12px; }
29787 |  73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
29788 |  74 | 
29789 |  75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
29790 |  76 | 
29791 |  77 |     .thumb {
29792 |  78 |       width:64px; height:40px;
29793 |  79 |       object-fit:cover;
29794 |  80 |       border-radius:10px;
29795 |  81 |       border:1px solid var(--border);
29796 |  82 |       background: var(--card2);
29797 |  83 |     }
29798 |  84 | 
29799 |  85 |     /* ===== tabela ===== */
29800 |  86 |     .tableWrap {
29801 |  87 |       width: 100%;
29802 |  88 |       /* by≈Ço: overflow-x; teraz robimy pe≈Çny scroll + limit wysoko≈õci */
29803 |  89 |       max-height: calc(100vh - 260px);
29804 |  90 |       overflow: auto;
29805 |  91 | 
29806 |  92 |       border-radius: 12px;
29807 |  93 |       border: 1px solid rgba(34,48,71,.45);
29808 |  94 |       background: rgba(11,18,32,.25);
29809 |  95 |     }
29810 |  96 | 
29811 |  97 |     /* opcjonalnie: ≈Çadniejsze scrollbary */
29812 |  98 |     .tableWrap::-webkit-scrollbar { height: 10px; width: 10px; }
29813 |  99 |     .tableWrap::-webkit-scrollbar-thumb { background: rgba(42,58,85,.9); border-radius: 999px; }
29814 | 100 |     .tableWrap::-webkit-scrollbar-track { background: rgba(11,18,32,.35); border-radius: 999px; }
29815 | 101 | 
29816 | 102 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
29817 | 103 |     th, td {
29818 | 104 |       border-bottom:1px solid rgba(34,48,71,.7);
29819 | 105 |       padding:10px;
29820 | 106 |       text-align:left;
29821 | 107 |       vertical-align:top;
29822 | 108 |       overflow-wrap:anywhere;
29823 | 109 |       word-break:break-word;
29824 | 110 |     }
29825 | 111 | 
29826 | 112 |     /* sticky head */
29827 | 113 |     th {
29828 | 114 |       font-size: 12px;
29829 | 115 |       opacity:.9;
29830 | 116 |       position: sticky;
29831 | 117 |       top: 0;
29832 | 118 |       z-index: 5;
29833 | 119 |       background: rgba(18,25,38,.96);
29834 | 120 |       backdrop-filter: blur(8px);
29835 | 121 |     }
29836 | 122 | 
29837 | 123 |     /* delikatny hover, ≈ºeby to "oddycha≈Ço" */
29838 | 124 |     tbody tr:hover td {
29839 | 125 |       background: rgba(37,99,235,.06);
29840 | 126 |     }
29841 | 127 | 
29842 | 128 |     /* kolumny */
29843 | 129 |     th.col-id,  td.col-id  { width: 170px; }
29844 | 130 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
29845 | 131 |     th.col-name,td.col-name{ width: 170px; }
29846 | 132 |     th.col-img, td.col-img { width: 120px; }
29847 | 133 |     th.col-desc,td.col-desc{ width: 260px; }
29848 | 134 |     th.col-act, td.col-act { width: 110px; text-align:center; }
29849 | 135 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
29850 | 136 | 
29851 | 137 |     /* URL: kolor */
29852 | 138 |     td.col-url a{
29853 | 139 |       color: #93c5fd;
29854 | 140 |       text-decoration: underline;
29855 | 141 |     }
29856 | 142 | 
29857 | 143 |     /* wrapper dla linka + ikonki kopiuj */
29858 | 144 |     .urlWrap{
29859 | 145 |       display:flex;
29860 | 146 |       align-items:flex-start;
29861 | 147 |       gap:10px;
29862 | 148 |     }
29863 | 149 | 
29864 | 150 |     /* KLUCZ: niech link nie robi ≈õciany (max 2 linie) */
29865 | 151 | .urlWrap a{
29866 | 152 |   flex: 1;
29867 | 153 |   min-width: 0;
29868 | 154 | 
29869 | 155 |   /* clamp (Chromium/WebKit) */
29870 | 156 |   display: -webkit-box;
29871 | 157 |   -webkit-box-orient: vertical;
29872 | 158 |   -webkit-line-clamp: 2;
29873 | 159 | 
29874 | 160 |   /* clamp (standard / future) */
29875 | 161 |   line-clamp: 2;
29876 | 162 | 
29877 | 163 |   overflow: hidden;
29878 | 164 | 
29879 | 165 |   word-break: break-word;
29880 | 166 |   overflow-wrap: anywhere;
29881 | 167 |   line-height: 1.25;
29882 | 168 | 
29883 | 169 |   /* fallback gdy clamp nie dzia≈Ça */
29884 | 170 |   max-height: 2.5em;
29885 | 171 | }
29886 | 172 | 
29887 | 173 | 
29888 | 174 | 
29889 | 175 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
29890 | 176 |     .iconBtn{
29891 | 177 |       width: 28px;
29892 | 178 |       height: 28px;
29893 | 179 |       padding: 0;
29894 | 180 |       display:inline-flex;
29895 | 181 |       align-items:center;
29896 | 182 |       justify-content:center;
29897 | 183 |       border-radius: 10px;
29898 | 184 |       background: transparent;
29899 | 185 |       border: 1px solid rgba(42,58,85,.9);
29900 | 186 |       opacity: .9;
29901 | 187 |       flex: 0 0 auto;
29902 | 188 |     }
29903 | 189 |     .iconBtn:hover{
29904 | 190 |       opacity: 1;
29905 | 191 |       background: rgba(37,99,235,.15);
29906 | 192 |     }
29907 | 193 |     .iconBtn:active{
29908 | 194 |       transform: translateY(1px);
29909 | 195 |     }
29910 | 196 |     .iconBtn svg{
29911 | 197 |       width: 16px;
29912 | 198 |       height: 16px;
29913 | 199 |       fill: none;
29914 | 200 |       stroke: rgba(231,238,247,.95);
29915 | 201 |       stroke-width: 2;
29916 | 202 |       stroke-linecap: round;
29917 | 203 |       stroke-linejoin: round;
29918 | 204 |     }
29919 | 205 | 
29920 | 206 |     /* akcje w tabeli */
29921 | 207 |     .actionsWrap{
29922 | 208 |       display:flex;
29923 | 209 |       gap:10px;
29924 | 210 |       align-items:center;
29925 | 211 |       justify-content:flex-start;
29926 | 212 |       flex-wrap:nowrap;
29927 | 213 |     }
29928 | 214 | 
29929 | 215 |     /* ===== status ===== */
29930 | 216 |     .hint { margin-top:10px; }
29931 | 217 |     .hint.ok { color: #a7f3d0; }
29932 | 218 |     .hint.err { color: #fca5a5; }
29933 | 219 | 
29934 | 220 |     /* ===== logi: proporcje ===== */
29935 | 221 |     .logsBox {
29936 | 222 |       display:flex;
29937 | 223 |       flex-direction: column;
29938 | 224 |       gap:10px;
29939 | 225 |     }
29940 | 226 |     #logs {
29941 | 227 |       height: 200px;
29942 | 228 |       min-height: 160px;
29943 | 229 |       max-height: 520px;
29944 | 230 |     }
29945 | 231 |     .logsExpanded #logs { height: 420px; }
29946 | 232 | 
29947 | 233 |     /* ===== modal ===== */
29948 | 234 |     .modalOverlay{
29949 | 235 |       position: fixed;
29950 | 236 |       inset: 0;
29951 | 237 |       background: rgba(0,0,0,.55);
29952 | 238 |       display:none;
29953 | 239 |       align-items:center;
29954 | 240 |       justify-content:center;
29955 | 241 |       padding: 18px;
29956 | 242 |       z-index: 9999;
29957 | 243 |     }
29958 | 244 |     .modalOverlay.show{ display:flex; }
29959 | 245 |     .modal{
29960 | 246 |       width: min(640px, 100%);
29961 | 247 |       border-radius: 16px;
29962 | 248 |       border: 1px solid rgba(34,48,71,.9);
29963 | 249 |       background: rgba(18,25,38,.98);
29964 | 250 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
29965 | 251 |       padding: 16px;
29966 | 252 |     }
29967 | 253 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
29968 | 254 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
29969 | 255 |     .modal .modalActions{
29970 | 256 |       display:flex;
29971 | 257 |       justify-content:flex-end;
29972 | 258 |       gap:10px;
29973 | 259 |       margin-top: 14px;
29974 | 260 |     }
29975 | 261 |     .kbd{
29976 | 262 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
29977 | 263 |       font-size: 12px;
29978 | 264 |       opacity:.9;
29979 | 265 |       padding: 2px 6px;
29980 | 266 |       border:1px solid rgba(42,58,85,.9);
29981 | 267 |       border-radius: 8px;
29982 | 268 |       background: rgba(11,18,32,.55);
29983 | 269 |     }
29984 | 270 | 
29985 | 271 |     @media (max-width: 860px){
29986 | 272 |       table { min-width: 980px; }
29987 | 273 |       .tableWrap { max-height: calc(100vh - 220px); }
29988 | 274 |     }
29989 | 275 |   </style>
29990 | 276 | </head>
29991 | 277 | 
29992 | 278 | <body>
29993 | 279 |   <h2>FB Watcher ‚Äî Panel</h2>
29994 | 280 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
29995 | 281 | 
29996 | 282 |   <div class="card">
29997 | 283 |     <div class="row">
29998 | 284 |       <div style="flex:1; min-width:260px;">
29999 | 285 |         <label>Token panelu</label>
30000 | 286 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
30001 | 287 |       </div>
30002 | 288 |       <div style="display:flex; gap:10px; align-items:flex-end;">
30003 | 289 |         <button class="primary" id="saveToken">Zapisz token</button>
30004 | 290 |         <button id="refresh">Od≈õwie≈º</button>
30005 | 291 |       </div>
30006 | 292 |     </div>
30007 | 293 | 
30008 | 294 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
30009 | 295 |   </div>
30010 | 296 | 
30011 | 297 |   <div class="card">
30012 | 298 |     <h3>Ustawienia (.env)</h3>
30013 | 299 | 
30014 | 300 |     <div class="row">
30015 | 301 |       <div style="flex:1; min-width:260px;">
30016 | 302 |         <label>E-mail Facebook</label>
30017 | 303 |         <input id="FB_EMAIL" />
30018 | 304 |       </div>
30019 | 305 |       <div style="flex:1; min-width:260px;">
30020 | 306 |         <label>Has≈Ço Facebook</label>
30021 | 307 |         <input id="FB_PASSWORD" type="password" />
30022 | 308 |       </div>
30023 | 309 |     </div>
30024 | 310 | 
30025 | 311 |     <label>Webhook (URL)</label>
30026 | 312 |     <input id="WEBHOOK_URL" />
30027 | 313 | 
30028 | 314 |     <div class="row">
30029 | 315 |       <div style="flex:1; min-width:220px;">
30030 | 316 |         <label>Interwa≈Ç sprawdzania (ms)</label>
30031 | 317 |         <input id="CHECK_INTERVAL_MS" />
30032 | 318 |       </div>
30033 | 319 |       <div style="flex:2; min-width:260px;">
30034 | 320 |         <label>Arkusz z postami (CSV export)</label>
30035 | 321 |         <input id="POSTS_SHEET_URL" />
30036 | 322 |       </div>
30037 | 323 |     </div>
30038 | 324 | 
30039 | 325 |     <div class="row">
30040 | 326 |       <div style="flex:1; min-width:220px;">
30041 | 327 |         <label>Tryb bez okna (headless)</label>
30042 | 328 |         <select id="HEADLESS_BROWSER">
30043 | 329 |           <option value="true">true</option>
30044 | 330 |           <option value="false">false</option>
30045 | 331 |         </select>
30046 | 332 |       </div>
30047 | 333 |       <div style="flex:1; min-width:220px;">
30048 | 334 |         <label>Obs≈Çuga UI (handlery)</label>
30049 | 335 |         <select id="USE_UI_HANDLERS">
30050 | 336 |           <option value="true">true</option>
30051 | 337 |           <option value="false">false</option>
30052 | 338 |         </select>
30053 | 339 |       </div>
30054 | 340 |       <div style="flex:1; min-width:220px;">
30055 | 341 |         <label>Uwzglƒôdniaj odpowiedzi</label>
30056 | 342 |         <select id="INCLUDE_REPLIES">
30057 | 343 |           <option value="true">true</option>
30058 | 344 |           <option value="false">false</option>
30059 | 345 |         </select>
30060 | 346 |       </div>
30061 | 347 |     </div>
30062 | 348 | 
30063 | 349 |     <div class="row" style="margin-top:10px;">
30064 | 350 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
30065 | 351 |       <button id="pm2Start">Start watchera</button>
30066 | 352 |       <button id="pm2Stop">Stop watchera</button>
30067 | 353 |       <button id="pm2Restart">Restart watchera</button>
30068 | 354 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
30069 | 355 |     </div>
30070 | 356 | 
30071 | 357 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
30072 | 358 |   </div>
30073 | 359 | 
30074 | 360 |   <div class="card">
30075 | 361 |     <h3>Posty (data/posts.json)</h3>
30076 | 362 | 
30077 | 363 |     <div class="row">
30078 | 364 |       <div style="flex:2; min-width:260px;">
30079 | 365 |         <label>Nowy URL posta</label>
30080 | 366 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
30081 | 367 |       </div>
30082 | 368 | 
30083 | 369 |       <div style="flex:1; min-width:220px;">
30084 | 370 |         <label>Nazwa</label>
30085 | 371 |         <input id="newPostName" placeholder="np. A1" />
30086 | 372 |       </div>
30087 | 373 | 
30088 | 374 |       <div style="flex:1; min-width:260px;">
30089 | 375 |         <label>URL zdjƒôcia</label>
30090 | 376 |         <input id="newPostImage" placeholder="https://...jpg" />
30091 | 377 |       </div>
30092 | 378 |     </div>
30093 | 379 | 
30094 | 380 |     <label>Opis</label>
30095 | 381 |     <textarea id="newPostDescription" placeholder="Kr√≥tki opis..."></textarea>
30096 | 382 | 
30097 | 383 |     <div class="row" style="margin-top:10px;">
30098 | 384 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
30099 | 385 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
30100 | 386 |           <input type="checkbox" id="newPostActive" checked /> aktywny
30101 | 387 |         </label>
30102 | 388 |         <button class="primary" id="addPost">Dodaj</button>
30103 | 389 |       </div>
30104 | 390 |     </div>
30105 | 391 | 
30106 | 392 |     <div style="margin-top:12px;" class="tableWrap">
30107 | 393 |       <table>
30108 | 394 |         <thead>
30109 | 395 |           <tr>
30110 | 396 |             <th class="col-id">ID</th>
30111 | 397 |             <th class="col-url">Link</th>
30112 | 398 |             <th class="col-name">Nazwa</th>
30113 | 399 |             <th class="col-img">Zdjƒôcie</th>
30114 | 400 |             <th class="col-desc">Opis</th>
30115 | 401 |             <th class="col-act">Aktywny</th>
30116 | 402 |             <th class="col-btn">Akcje</th>
30117 | 403 |           </tr>
30118 | 404 |         </thead>
30119 | 405 |         <tbody id="posts"></tbody>
30120 | 406 |       </table>
30121 | 407 |     </div>
30122 | 408 |   </div>
30123 | 409 | 
30124 | 410 |   <div class="card" id="logsCard">
30125 | 411 |     <div class="row" style="justify-content:space-between; align-items:center;">
30126 | 412 |       <h3 style="margin:0;">Logi</h3>
30127 | 413 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
30128 | 414 |         Rozwi≈Ñ
30129 | 415 |       </button>
30130 | 416 |     </div>
30131 | 417 | 
30132 | 418 |     <div class="logsBox">
30133 | 419 |       <div class="row">
30134 | 420 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
30135 | 421 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
30136 | 422 | 
30137 | 423 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
30138 | 424 | 
30139 | 425 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
30140 | 426 |           <option value="0">auto: wy≈Ç.</option>
30141 | 427 |           <option value="1000">co 1 s</option>
30142 | 428 |           <option value="2000" selected>co 2 s</option>
30143 | 429 |           <option value="5000">co 5 s</option>
30144 | 430 |           <option value="10000">co 10 s</option>
30145 | 431 |         </select>
30146 | 432 | 
30147 | 433 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
30148 | 434 | 
30149 | 435 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
30150 | 436 |           <input type="checkbox" id="logAutoScroll" checked />
30151 | 437 |           auto-scroll
30152 | 438 |         </label>
30153 | 439 |       </div>
30154 | 440 | 
30155 | 441 |       <div class="sep"></div>
30156 | 442 | 
30157 | 443 |       <textarea
30158 | 444 |         id="logs"
30159 | 445 |         class="mono"
30160 | 446 |         readonly
30161 | 447 |         spellcheck="false"
30162 | 448 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
30163 | 449 | 
30164 | 450 |       <div id="logHint" class="muted hint"></div>
30165 | 451 |     </div>
30166 | 452 |   </div>
30167 | 453 | 
30168 | 454 |   <!-- modal -->
30169 | 455 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
30170 | 456 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
30171 | 457 |       <h4 id="modalTitle">Potwierdzenie</h4>
30172 | 458 |       <div class="modalBody" id="modalBody"></div>
30173 | 459 |       <div class="modalActions">
30174 | 460 |         <button id="modalCancel">Anuluj</button>
30175 | 461 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
30176 | 462 |       </div>
30177 | 463 |       <div class="muted" style="margin-top:10px;">
30178 | 464 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
30179 | 465 |       </div>
30180 | 466 |     </div>
30181 | 467 |   </div>
30182 | 468 | 
30183 | 469 |   <script src="/app.js"></script>
30184 | 470 | </body>
30185 | 471 | </html>
30186 | 472 | 
30187 | ```
30188 | 
30189 | ---
30190 | 
30191 | ### üìÑ ≈öcie≈ºka: `export_chat_context/20__app.js`
30192 | **Typ:** JavaScript/tekst  
30193 | **Opis:** Plik projektu (kod/konfiguracja).  
30194 | 
30195 | ```js
30196 |   1 | (() => {
30197 |   2 |   const $ = (id) => document.getElementById(id);
30198 |   3 | 
30199 |   4 |   // ---------- state ----------
30200 |   5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
30201 |   6 |   let logAutoTimer = null;
30202 |   7 |   let lastLogMode = "out"; // 'out' | 'err'
30203 |   8 |   let logsExpanded = false;
30204 |   9 | 
30205 |  10 |   // modal state
30206 |  11 |   let modalResolve = null;
30207 |  12 | 
30208 |  13 |   // edit modal state
30209 |  14 |   let editResolve = null;
30210 |  15 | 
30211 |  16 |   // ---------- ui refs ----------
30212 |  17 |   const elToken = $("token");
30213 |  18 |   const btnSaveToken = $("saveToken");
30214 |  19 |   const btnRefresh = $("refresh");
30215 |  20 |   const elStatus = $("status");
30216 |  21 | 
30217 |  22 |   const btnSaveEnv = $("saveEnv");
30218 |  23 |   const btnPm2Start = $("pm2Start");
30219 |  24 |   const btnPm2Stop = $("pm2Stop");
30220 |  25 |   const btnPm2Restart = $("pm2Restart");
30221 |  26 |   const btnClearCookies = $("clearCookies");
30222 |  27 |   const elEnvMsg = $("envMsg");
30223 |  28 | 
30224 |  29 |   const elNewPostUrl = $("newPostUrl");
30225 |  30 |   const elNewPostName = $("newPostName");
30226 |  31 |   const elNewPostImage = $("newPostImage");
30227 |  32 |   const elNewPostDescription = $("newPostDescription");
30228 |  33 |   const elNewPostActive = $("newPostActive");
30229 |  34 |   const btnAddPost = $("addPost");
30230 |  35 |   const elPostsTbody = $("posts");
30231 |  36 | 
30232 |  37 |   const btnLoadOut = $("loadOut");
30233 |  38 |   const btnLoadErr = $("loadErr");
30234 |  39 |   const elLogLines = $("logLines");
30235 |  40 |   const elLogAutoEvery = $("logAutoEvery");
30236 |  41 |   const btnLogAutoToggle = $("logAutoToggle");
30237 |  42 |   const elLogAutoScroll = $("logAutoScroll");
30238 |  43 |   const elLogs = $("logs");
30239 |  44 |   const elLogHint = $("logHint");
30240 |  45 | 
30241 |  46 |   const logsCard = $("logsCard");
30242 |  47 |   const btnToggleLogsSize = $("toggleLogsSize");
30243 |  48 | 
30244 |  49 |   // modal refs (delete + generic)
30245 |  50 |   const modalOverlay = $("modalOverlay");
30246 |  51 |   const modalBody = $("modalBody");
30247 |  52 |   const modalCancel = $("modalCancel");
30248 |  53 |   const modalOk = $("modalOk");
30249 |  54 | 
30250 |  55 |   // env fields
30251 |  56 |   const ENV_FIELDS = [
30252 |  57 |     "FB_EMAIL",
30253 |  58 |     "FB_PASSWORD",
30254 |  59 |     "WEBHOOK_URL",
30255 |  60 |     "CHECK_INTERVAL_MS",
30256 |  61 |     "POSTS_SHEET_URL",
30257 |  62 |     "HEADLESS_BROWSER",
30258 |  63 |     "USE_UI_HANDLERS",
30259 |  64 |     "INCLUDE_REPLIES",
30260 |  65 |   ];
30261 |  66 | 
30262 |  67 |   function setHint(el, msg, ok = true) {
30263 |  68 |     if (!el) return;
30264 |  69 |     el.textContent = msg || "";
30265 |  70 |     el.classList.remove("ok", "err");
30266 |  71 |     el.classList.add(ok ? "ok" : "err");
30267 |  72 |   }
30268 |  73 | 
30269 |  74 |   function fmtTime() {
30270 |  75 |     try {
30271 |  76 |       return new Date().toLocaleString();
30272 |  77 |     } catch {
30273 |  78 |       return "";
30274 |  79 |     }
30275 |  80 |   }
30276 |  81 | 
30277 |  82 |   function getAuthHeaders() {
30278 |  83 |     const t = (token || "").trim();
30279 |  84 |     return t ? { Authorization: `Bearer ${t}` } : {};
30280 |  85 |   }
30281 |  86 | 
30282 |  87 |   async function api(path, opts = {}) {
30283 |  88 |     const headers = {
30284 |  89 |       ...(opts.headers || {}),
30285 |  90 |       ...getAuthHeaders(),
30286 |  91 |     };
30287 |  92 | 
30288 |  93 |     let body = opts.body;
30289 |  94 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
30290 |  95 |       headers["Content-Type"] = "application/json";
30291 |  96 |       body = JSON.stringify(body);
30292 |  97 |     }
30293 |  98 | 
30294 |  99 |     const res = await fetch(path, {
30295 | 100 |       method: opts.method || "GET",
30296 | 101 |       headers,
30297 | 102 |       body,
30298 | 103 |     });
30299 | 104 | 
30300 | 105 |     const text = await res.text();
30301 | 106 |     let data = null;
30302 | 107 |     try {
30303 | 108 |       data = JSON.parse(text);
30304 | 109 |     } catch {
30305 | 110 |       data = { ok: false, error: text || `HTTP ${res.status}` };
30306 | 111 |     }
30307 | 112 | 
30308 | 113 |     if (!res.ok) {
30309 | 114 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
30310 | 115 |     }
30311 | 116 |     return data;
30312 | 117 |   }
30313 | 118 | 
30314 | 119 |   // ---------- modal ----------
30315 | 120 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
30316 | 121 |     return new Promise((resolve) => {
30317 | 122 |       modalResolve = resolve;
30318 | 123 | 
30319 | 124 |       $("modalTitle").textContent = title;
30320 | 125 |       modalBody.innerHTML = body;
30321 | 126 | 
30322 | 127 |       modalOk.textContent = okText;
30323 | 128 |       modalOk.classList.toggle("danger", !!danger);
30324 | 129 | 
30325 | 130 |       modalOverlay.classList.add("show");
30326 | 131 |       modalOverlay.setAttribute("aria-hidden", "false");
30327 | 132 | 
30328 | 133 |       setTimeout(() => {
30329 | 134 |         (danger ? modalOk : modalCancel).focus();
30330 | 135 |       }, 0);
30331 | 136 |     });
30332 | 137 |   }
30333 | 138 | 
30334 | 139 |   function closeModal(result) {
30335 | 140 |     modalOverlay.classList.remove("show");
30336 | 141 |     modalOverlay.setAttribute("aria-hidden", "true");
30337 | 142 |     const r = modalResolve;
30338 | 143 |     modalResolve = null;
30339 | 144 |     if (typeof r === "function") r(result);
30340 | 145 |   }
30341 | 146 | 
30342 | 147 |   modalCancel.addEventListener("click", () => closeModal(false));
30343 | 148 |   modalOk.addEventListener("click", () => closeModal(true));
30344 | 149 |   modalOverlay.addEventListener("click", (e) => {
30345 | 150 |     if (e.target === modalOverlay) closeModal(false);
30346 | 151 |   });
30347 | 152 |   window.addEventListener("keydown", (e) => {
30348 | 153 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
30349 | 154 |   });
30350 | 155 | 
30351 | 156 |   // ---------- core actions ----------
30352 | 157 |   async function loadStatus() {
30353 | 158 |     setHint(elStatus, "≈Åadowanie statusu...", true);
30354 | 159 | 
30355 | 160 |     const r = await api("/api/status");
30356 | 161 |     if (!r.ok) {
30357 | 162 |       setHint(
30358 | 163 |         elStatus,
30359 | 164 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
30360 | 165 |         false
30361 | 166 |       );
30362 | 167 |       return null;
30363 | 168 |     }
30364 | 169 | 
30365 | 170 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
30366 | 171 |     return r;
30367 | 172 |   }
30368 | 173 | 
30369 | 174 |   async function loadEnv() {
30370 | 175 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
30371 | 176 |     const r = await api("/api/env/get");
30372 | 177 |     if (!r.ok) {
30373 | 178 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
30374 | 179 |       return;
30375 | 180 |     }
30376 | 181 |     const v = r.values || {};
30377 | 182 |     for (const k of ENV_FIELDS) {
30378 | 183 |       const el = $(k);
30379 | 184 |       if (!el) continue;
30380 | 185 |       el.value = (v[k] ?? "").toString();
30381 | 186 |     }
30382 | 187 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
30383 | 188 |   }
30384 | 189 | 
30385 | 190 |   async function saveEnv(restart = false) {
30386 | 191 |     const set = {};
30387 | 192 |     for (const k of ENV_FIELDS) {
30388 | 193 |       const el = $(k);
30389 | 194 |       if (!el) continue;
30390 | 195 |       set[k] = (el.value ?? "").toString();
30391 | 196 |     }
30392 | 197 | 
30393 | 198 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
30394 | 199 | 
30395 | 200 |     const r = await api("/api/env/set", {
30396 | 201 |       method: "POST",
30397 | 202 |       body: { set, restart },
30398 | 203 |     });
30399 | 204 | 
30400 | 205 |     if (!r.ok) {
30401 | 206 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
30402 | 207 |       return;
30403 | 208 |     }
30404 | 209 | 
30405 | 210 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
30406 | 211 |   }
30407 | 212 | 
30408 | 213 |   function copyIconSvg() {
30409 | 214 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
30410 | 215 |     return `
30411 | 216 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
30412 | 217 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
30413 | 218 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
30414 | 219 |       </svg>
30415 | 220 |     `;
30416 | 221 |   }
30417 | 222 | 
30418 | 223 |   async function loadPosts() {
30419 | 224 |     const r = await api("/api/posts");
30420 | 225 |     if (!r.ok) {
30421 | 226 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
30422 | 227 |       return;
30423 | 228 |     }
30424 | 229 | 
30425 | 230 |     const posts = Array.isArray(r.posts) ? r.posts : [];
30426 | 231 |     elPostsTbody.innerHTML = "";
30427 | 232 | 
30428 | 233 |     for (const p of posts) {
30429 | 234 |       const tr = document.createElement("tr");
30430 | 235 | 
30431 | 236 |       const tdId = document.createElement("td");
30432 | 237 |       tdId.className = "mono col-id";
30433 | 238 |       tdId.textContent = p.id || "";
30434 | 239 |       tr.appendChild(tdId);
30435 | 240 | 
30436 | 241 |       // LINK + IKONKA KOPIUJ PRZY LINKU
30437 | 242 |       const tdUrl = document.createElement("td");
30438 | 243 |       tdUrl.className = "col-url";
30439 | 244 | 
30440 | 245 |       if (p.url) {
30441 | 246 |         const wrap = document.createElement("div");
30442 | 247 |         wrap.className = "urlWrap";
30443 | 248 | 
30444 | 249 |         const a = document.createElement("a");
30445 | 250 |         a.href = p.url;
30446 | 251 |         a.target = "_blank";
30447 | 252 |         a.rel = "noopener noreferrer";
30448 | 253 |         a.textContent = p.url;
30449 | 254 | 
30450 | 255 |         const btnCopyIcon = document.createElement("button");
30451 | 256 |         btnCopyIcon.className = "iconBtn";
30452 | 257 |         btnCopyIcon.type = "button";
30453 | 258 |         btnCopyIcon.title = "Kopiuj link";
30454 | 259 |         btnCopyIcon.innerHTML = copyIconSvg();
30455 | 260 | 
30456 | 261 |         btnCopyIcon.addEventListener("click", async (e) => {
30457 | 262 |           e.preventDefault();
30458 | 263 |           e.stopPropagation();
30459 | 264 | 
30460 | 265 |           const ok = await copyToClipboard(p.url);
30461 | 266 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
30462 | 267 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
30463 | 268 |         });
30464 | 269 | 
30465 | 270 |         wrap.appendChild(a);
30466 | 271 |         wrap.appendChild(btnCopyIcon);
30467 | 272 |         tdUrl.appendChild(wrap);
30468 | 273 |       }
30469 | 274 | 
30470 | 275 |       tr.appendChild(tdUrl);
30471 | 276 | 
30472 | 277 |       const tdName = document.createElement("td");
30473 | 278 |       tdName.className = "col-name";
30474 | 279 |       tdName.textContent = p.name || "";
30475 | 280 |       tr.appendChild(tdName);
30476 | 281 | 
30477 | 282 |       const tdImg = document.createElement("td");
30478 | 283 |       tdImg.className = "col-img";
30479 | 284 |       if (p.image) {
30480 | 285 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
30481 | 286 |       } else {
30482 | 287 |         tdImg.textContent = "";
30483 | 288 |       }
30484 | 289 |       tr.appendChild(tdImg);
30485 | 290 | 
30486 | 291 |       const tdDesc = document.createElement("td");
30487 | 292 |       tdDesc.className = "col-desc";
30488 | 293 |       tdDesc.textContent = p.description || "";
30489 | 294 |       tr.appendChild(tdDesc);
30490 | 295 | 
30491 | 296 |       const tdActive = document.createElement("td");
30492 | 297 |       tdActive.className = "col-act";
30493 | 298 |       const chk = document.createElement("input");
30494 | 299 |       chk.type = "checkbox";
30495 | 300 |       chk.checked = !!p.active;
30496 | 301 |       chk.addEventListener("change", async () => {
30497 | 302 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
30498 | 303 |           method: "PATCH",
30499 | 304 |           body: { active: chk.checked },
30500 | 305 |         });
30501 | 306 |         await loadPosts();
30502 | 307 |       });
30503 | 308 |       tdActive.appendChild(chk);
30504 | 309 |       tr.appendChild(tdActive);
30505 | 310 | 
30506 | 311 |       // AKCJE: EDYTUJ + USU≈É
30507 | 312 |       const tdActions = document.createElement("td");
30508 | 313 |       tdActions.className = "col-btn";
30509 | 314 | 
30510 | 315 |       const actions = document.createElement("div");
30511 | 316 |       actions.className = "actionsWrap";
30512 | 317 | 
30513 | 318 |       const btnEdit = document.createElement("button");
30514 | 319 |       btnEdit.className = "small";
30515 | 320 |       btnEdit.type = "button";
30516 | 321 |       btnEdit.textContent = "Edytuj";
30517 | 322 |       btnEdit.addEventListener("click", async () => {
30518 | 323 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
30519 | 324 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
30520 | 325 |         const ok = await showModal({
30521 | 326 |           title: "Edytuj post",
30522 | 327 |           body:
30523 | 328 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
30524 | 329 |             `<div style="margin-top:10px">
30525 | 330 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
30526 | 331 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
30527 | 332 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
30528 | 333 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
30529 | 334 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
30530 | 335 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
30531 | 336 |               <label class="muted" style="display:block;margin:8px 0 6px;">Opis</label>
30532 | 337 |               <textarea id="edit_desc" style="height:90px;">${escapeHtml(p.description || "")}</textarea>
30533 | 338 |             </div>`,
30534 | 339 |           okText: "Zapisz",
30535 | 340 |           danger: false,
30536 | 341 |         });
30537 | 342 | 
30538 | 343 |         if (!ok) return;
30539 | 344 | 
30540 | 345 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
30541 | 346 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
30542 | 347 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
30543 | 348 |         const newDesc = (document.getElementById("edit_desc")?.value || "").trim();
30544 | 349 | 
30545 | 350 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
30546 | 351 |           method: "PATCH",
30547 | 352 |           body: { url: newUrl, name: newName, image: newImg, description: newDesc },
30548 | 353 |         });
30549 | 354 | 
30550 | 355 |         if (!rr.ok) {
30551 | 356 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
30552 | 357 |           return;
30553 | 358 |         }
30554 | 359 | 
30555 | 360 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
30556 | 361 |         await loadPosts();
30557 | 362 |       });
30558 | 363 | 
30559 | 364 |       const btnDel = document.createElement("button");
30560 | 365 |       btnDel.className = "danger";
30561 | 366 |       btnDel.type = "button";
30562 | 367 |       btnDel.textContent = "Usu≈Ñ";
30563 | 368 |       btnDel.addEventListener("click", async () => {
30564 | 369 |         const ok = await showModal({
30565 | 370 |           title: "UsunƒÖƒá post?",
30566 | 371 |           body:
30567 | 372 |             `<div>Ta operacja jest nieodwracalna.</div>` +
30568 | 373 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
30569 | 374 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
30570 | 375 |           okText: "Usu≈Ñ",
30571 | 376 |           danger: true,
30572 | 377 |         });
30573 | 378 |         if (!ok) return;
30574 | 379 | 
30575 | 380 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
30576 | 381 |         if (!rr.ok) {
30577 | 382 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
30578 | 383 |           return;
30579 | 384 |         }
30580 | 385 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
30581 | 386 |         await loadPosts();
30582 | 387 |       });
30583 | 388 | 
30584 | 389 |       actions.appendChild(btnEdit);
30585 | 390 |       actions.appendChild(btnDel);
30586 | 391 | 
30587 | 392 |       tdActions.appendChild(actions);
30588 | 393 |       tr.appendChild(tdActions);
30589 | 394 | 
30590 | 395 |       elPostsTbody.appendChild(tr);
30591 | 396 |     }
30592 | 397 |   }
30593 | 398 | 
30594 | 399 |   async function addPost() {
30595 | 400 |     const url = (elNewPostUrl.value || "").trim();
30596 | 401 |     const name = (elNewPostName.value || "").trim();
30597 | 402 |     const image = (elNewPostImage.value || "").trim();
30598 | 403 |     const description = (elNewPostDescription.value || "").trim();
30599 | 404 |     const active = !!elNewPostActive.checked;
30600 | 405 | 
30601 | 406 |     const r = await api("/api/posts", {
30602 | 407 |       method: "POST",
30603 | 408 |       body: { url, name, image, description, active },
30604 | 409 |     });
30605 | 410 | 
30606 | 411 |     if (!r.ok) {
30607 | 412 |       await showModal({
30608 | 413 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
30609 | 414 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
30610 | 415 |         okText: "OK",
30611 | 416 |         danger: false,
30612 | 417 |       });
30613 | 418 |       return;
30614 | 419 |     }
30615 | 420 | 
30616 | 421 |     elNewPostUrl.value = "";
30617 | 422 |     elNewPostName.value = "";
30618 | 423 |     elNewPostImage.value = "";
30619 | 424 |     elNewPostDescription.value = "";
30620 | 425 |     elNewPostActive.checked = true;
30621 | 426 | 
30622 | 427 |     setHint(elEnvMsg, "Dodano post.", true);
30623 | 428 |     await loadPosts();
30624 | 429 |   }
30625 | 430 | 
30626 | 431 |   async function pm2Call(which) {
30627 | 432 |     const map = {
30628 | 433 |       start: "/api/pm2/start",
30629 | 434 |       stop: "/api/pm2/stop",
30630 | 435 |       restart: "/api/pm2/restart",
30631 | 436 |       status: "/api/pm2/status",
30632 | 437 |     };
30633 | 438 |     const path = map[which];
30634 | 439 |     if (!path) return;
30635 | 440 | 
30636 | 441 |     const label =
30637 | 442 |       which === "start" ? "Startujƒô watchera..."
30638 | 443 |         : which === "stop" ? "Zatrzymujƒô watchera..."
30639 | 444 |           : which === "restart" ? "Restartujƒô watchera..."
30640 | 445 |             : "Sprawdzam status...";
30641 | 446 | 
30642 | 447 |     setHint(elEnvMsg, label, true);
30643 | 448 | 
30644 | 449 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
30645 | 450 |     if (!r.ok) {
30646 | 451 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
30647 | 452 |       return;
30648 | 453 |     }
30649 | 454 | 
30650 | 455 |     const okMsg =
30651 | 456 |       which === "start" ? "Watcher uruchomiony."
30652 | 457 |         : which === "stop" ? "Watcher zatrzymany."
30653 | 458 |           : which === "restart" ? "Watcher zrestartowany."
30654 | 459 |             : "Status pobrany.";
30655 | 460 | 
30656 | 461 |     setHint(elEnvMsg, okMsg, true);
30657 | 462 | 
30658 | 463 |     if (which !== "status") await loadStatus();
30659 | 464 |   }
30660 | 465 | 
30661 | 466 |   async function clearCookies() {
30662 | 467 |     const ok = await showModal({
30663 | 468 |       title: "Wyczy≈õciƒá cookies?",
30664 | 469 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
30665 | 470 |       okText: "Wyczy≈õƒá",
30666 | 471 |       danger: true,
30667 | 472 |     });
30668 | 473 |     if (!ok) return;
30669 | 474 | 
30670 | 475 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
30671 | 476 | 
30672 | 477 |     const r = await api("/api/cookies/clear", {
30673 | 478 |       method: "POST",
30674 | 479 |       body: { confirm: true },
30675 | 480 |     });
30676 | 481 | 
30677 | 482 |     if (!r.ok) {
30678 | 483 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
30679 | 484 |       return;
30680 | 485 |     }
30681 | 486 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
30682 | 487 |   }
30683 | 488 | 
30684 | 489 |   // ---------- logs ----------
30685 | 490 |   function getLines() {
30686 | 491 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
30687 | 492 |     if (!isFinite(n)) return 200;
30688 | 493 |     return Math.max(20, Math.min(2000, n));
30689 | 494 |   }
30690 | 495 | 
30691 | 496 |   async function loadLogs(mode) {
30692 | 497 |     lastLogMode = mode;
30693 | 498 |     const lines = getLines();
30694 | 499 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
30695 | 500 | 
30696 | 501 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
30697 | 502 |     if (!r.ok) {
30698 | 503 |       elLogs.value = "";
30699 | 504 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
30700 | 505 |       return;
30701 | 506 |     }
30702 | 507 | 
30703 | 508 |     elLogs.value = (r.log || "").toString();
30704 | 509 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
30705 | 510 | 
30706 | 511 |     if (elLogAutoScroll.checked) {
30707 | 512 |       elLogs.scrollTop = elLogs.scrollHeight;
30708 | 513 |     }
30709 | 514 |   }
30710 | 515 | 
30711 | 516 |   function stopAutoLogs() {
30712 | 517 |     if (logAutoTimer) {
30713 | 518 |       clearInterval(logAutoTimer);
30714 | 519 |       logAutoTimer = null;
30715 | 520 |     }
30716 | 521 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
30717 | 522 |     btnLogAutoToggle.classList.remove("primary");
30718 | 523 |   }
30719 | 524 | 
30720 | 525 |   function startAutoLogs() {
30721 | 526 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
30722 | 527 |     if (every <= 0) {
30723 | 528 |       stopAutoLogs();
30724 | 529 |       return;
30725 | 530 |     }
30726 | 531 | 
30727 | 532 |     stopAutoLogs();
30728 | 533 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
30729 | 534 |     btnLogAutoToggle.classList.add("primary");
30730 | 535 | 
30731 | 536 |     logAutoTimer = setInterval(() => {
30732 | 537 |       loadLogs(lastLogMode).catch(() => {});
30733 | 538 |     }, every);
30734 | 539 |   }
30735 | 540 | 
30736 | 541 |   function toggleLogsSize() {
30737 | 542 |     logsExpanded = !logsExpanded;
30738 | 543 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
30739 | 544 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
30740 | 545 |   }
30741 | 546 | 
30742 | 547 |   // ---------- utils ----------
30743 | 548 |   async function copyToClipboard(text) {
30744 | 549 |     try {
30745 | 550 |       await navigator.clipboard.writeText(text);
30746 | 551 |       return true;
30747 | 552 |     } catch (e) {
30748 | 553 |       const ta = document.createElement("textarea");
30749 | 554 |       ta.value = text;
30750 | 555 |       ta.style.position = "fixed";
30751 | 556 |       ta.style.opacity = "0";
30752 | 557 |       document.body.appendChild(ta);
30753 | 558 |       ta.select();
30754 | 559 |       try {
30755 | 560 |         document.execCommand("copy");
30756 | 561 |         document.body.removeChild(ta);
30757 | 562 |         return true;
30758 | 563 |       } catch {
30759 | 564 |         document.body.removeChild(ta);
30760 | 565 |         return false;
30761 | 566 |       }
30762 | 567 |     }
30763 | 568 |   }
30764 | 569 | 
30765 | 570 |   function escapeHtml(s) {
30766 | 571 |     return String(s || "")
30767 | 572 |       .replaceAll("&", "&amp;")
30768 | 573 |       .replaceAll("<", "&lt;")
30769 | 574 |       .replaceAll(">", "&gt;")
30770 | 575 |       .replaceAll('"', "&quot;")
30771 | 576 |       .replaceAll("'", "&#039;");
30772 | 577 |   }
30773 | 578 | 
30774 | 579 |   // ---------- wire events ----------
30775 | 580 |   function wire() {
30776 | 581 |     elToken.value = token;
30777 | 582 | 
30778 | 583 |     btnSaveToken.addEventListener("click", async () => {
30779 | 584 |       token = (elToken.value || "").trim();
30780 | 585 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
30781 | 586 |       await hardRefresh();
30782 | 587 |     });
30783 | 588 | 
30784 | 589 |     btnRefresh.addEventListener("click", async () => {
30785 | 590 |       await hardRefresh();
30786 | 591 |     });
30787 | 592 | 
30788 | 593 |     btnSaveEnv.addEventListener("click", async () => {
30789 | 594 |       await saveEnv(false);
30790 | 595 |     });
30791 | 596 | 
30792 | 597 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
30793 | 598 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
30794 | 599 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
30795 | 600 | 
30796 | 601 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
30797 | 602 | 
30798 | 603 |     btnAddPost.addEventListener("click", async () => await addPost());
30799 | 604 | 
30800 | 605 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
30801 | 606 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
30802 | 607 | 
30803 | 608 |     btnLogAutoToggle.addEventListener("click", () => {
30804 | 609 |       if (logAutoTimer) stopAutoLogs();
30805 | 610 |       else startAutoLogs();
30806 | 611 |     });
30807 | 612 | 
30808 | 613 |     elLogAutoEvery.addEventListener("change", () => {
30809 | 614 |       if (logAutoTimer) startAutoLogs();
30810 | 615 |     });
30811 | 616 | 
30812 | 617 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
30813 | 618 |   }
30814 | 619 | 
30815 | 620 |   async function hardRefresh() {
30816 | 621 |     await loadStatus();
30817 | 622 |     await loadEnv();
30818 | 623 |     await loadPosts();
30819 | 624 | 
30820 | 625 |     if (elLogs.value && elLogs.value.trim().length > 0) {
30821 | 626 |       await loadLogs(lastLogMode);
30822 | 627 |     }
30823 | 628 |   }
30824 | 629 | 
30825 | 630 |   // ---------- init ----------
30826 | 631 |   wire();
30827 | 632 |   hardRefresh().catch(() => {
30828 | 633 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
30829 | 634 |   });
30830 | 635 | })();
30831 | 636 | 
30832 | ```
30833 | 
30834 | ---
30835 | 
30836 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/.env`
30837 | **Typ:** JavaScript/tekst  
30838 | **Opis:** Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.  
30839 | 
30840 | ```dotenv
30841 |  1 | >FB_EMAIL=enzosmaigpt@gmail.com
30842 |  2 | FB_PASSWORD=Supersmart97!
30843 |  3 | WEBHOOK_URL=https://hook.eu2.make.com/kodlqbvg6j1wmmbmoc621ewbza1ppxoz  # tutaj sw√≥j webhook z Make
30844 |  4 | CHECK_INTERVAL_MS=60000                         # co ile ms sprawdzaƒá (np. 60000 = 1 min)
30845 |  5 | POSTS_SHEET_URL=https://docs.google.com/spreadsheets/d/155wpBEbem6h6JylZb3uWvF9jCkKLk2NsbxkWqHnUFN8/export?format=csv
30846 |  6 | COOKIES_READ_ONLY=false
30847 |  7 | HEADLESS_BROWSER=false
30848 |  8 | USE_UI_HANDLERS=false
30849 |  9 | INCLUDE_REPLIES=true
30850 | 10 | 
30851 | ```
30852 | 
30853 | ---
30854 | 
30855 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/api.js`
30856 | **Typ:** JavaScript/tekst  
30857 | **Opis:** Plik projektu (kod/konfiguracja).  
30858 | 
30859 | ```js
30860 |   1 | // panel/api.js
30861 |   2 | import http from "http";
30862 |   3 | import { exec } from "child_process";
30863 |   4 | import fs from "fs";
30864 |   5 | import path from "path";
30865 |   6 | import crypto from "crypto";
30866 |   7 | import dotenv from "dotenv";
30867 |   8 | 
30868 |   9 | // ---- BASE DIR (dev vs exe) ----
30869 |  10 | const BASE_DIR = process.pkg ? path.dirname(process.execPath) : process.cwd();
30870 |  11 | 
30871 |  12 | // .env: najpierw dev (cwd), potem exe (BASE_DIR)
30872 |  13 | dotenv.config({ path: path.join(process.cwd(), ".env") });
30873 |  14 | dotenv.config({ path: path.join(BASE_DIR, ".env") });
30874 |  15 | 
30875 |  16 | // UI: dev -> src/panel/ui, exe -> ./ui
30876 |  17 | const UI_DIR = process.pkg
30877 |  18 |   ? path.join(BASE_DIR, "ui")
30878 |  19 |   : path.join(BASE_DIR, "src", "panel", "ui");
30879 |  20 | 
30880 |  21 | const PORT = Number(process.env.PANEL_PORT || 3180);
30881 |  22 | const TOKEN = process.env.PANEL_TOKEN;
30882 |  23 | 
30883 |  24 | const PM2_APP = process.env.PM2_APP || "fbwatcher";
30884 |  25 | const DEV_PROJECT_DIR = process.env.PROJECT_DIR || ""; // local override
30885 |  26 | 
30886 |  27 | if (!TOKEN) {
30887 |  28 |   console.error("[PANEL] PANEL_TOKEN is required (set it in .env or env vars)");
30888 |  29 |   process.exit(1);
30889 |  30 | }
30890 |  31 | 
30891 |  32 | function auth(req, res) {
30892 |  33 |   const h = req.headers["authorization"] || "";
30893 |  34 |   if (h !== `Bearer ${TOKEN}`) {
30894 |  35 |     res.writeHead(401);
30895 |  36 |     res.end("Unauthorized");
30896 |  37 |     return false;
30897 |  38 |   }
30898 |  39 |   return true;
30899 |  40 | }
30900 |  41 | 
30901 |  42 | function json(res, obj, code = 200) {
30902 |  43 |   res.writeHead(code, { "Content-Type": "application/json" });
30903 |  44 |   res.end(JSON.stringify(obj, null, 2));
30904 |  45 | }
30905 |  46 | 
30906 |  47 | function sh(cmd) {
30907 |  48 |   return new Promise((resolve) => {
30908 |  49 |     exec(cmd, { maxBuffer: 1024 * 1024 }, (err, stdout, stderr) => {
30909 |  50 |       resolve({
30910 |  51 |         ok: !err,
30911 |  52 |         stdout: (stdout || "").trim(),
30912 |  53 |         stderr: (stderr || "").trim(),
30913 |  54 |         code: err?.code ?? 0,
30914 |  55 |       });
30915 |  56 |     });
30916 |  57 |   });
30917 |  58 | }
30918 |  59 | 
30919 |  60 | 
30920 |  61 | async function getProjectDir() {
30921 |  62 |   if (DEV_PROJECT_DIR) return DEV_PROJECT_DIR;
30922 |  63 | 
30923 |  64 |   const r = await sh(`pm2 describe ${PM2_APP}`);
30924 |  65 |   const m = r.stdout.match(/exec cwd\s+([^\n]+)/);
30925 |  66 |   if (!m)
30926 |  67 |     throw new Error(
30927 |  68 |       `Cannot detect PROJECT_DIR from pm2 (set PROJECT_DIR in .env for local tests)`
30928 |  69 |     );
30929 |  70 |   return m[1].trim();
30930 |  71 | }
30931 |  72 | 
30932 |  73 | function readBody(req) {
30933 |  74 |   return new Promise((resolve) => {
30934 |  75 |     let d = "";
30935 |  76 |     req.on("data", (c) => (d += c));
30936 |  77 |     req.on("end", () => resolve(d));
30937 |  78 |   });
30938 |  79 | }
30939 |  80 | 
30940 |  81 | function safeJsonParse(s) {
30941 |  82 |   try {
30942 |  83 |     return { ok: true, value: JSON.parse(s) };
30943 |  84 |   } catch (e) {
30944 |  85 |     return { ok: false, error: e?.message || "Invalid JSON" };
30945 |  86 |   }
30946 |  87 | }
30947 |  88 | 
30948 |  89 | function ensureDir(p) {
30949 |  90 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
30950 |  91 | }
30951 |  92 | 
30952 |  93 | function atomicWriteFile(filePath, content) {
30953 |  94 |   const dir = path.dirname(filePath);
30954 |  95 |   ensureDir(dir);
30955 |  96 | 
30956 |  97 |   const tmp = path.join(
30957 |  98 |     dir,
30958 |  99 |     `.${path.basename(filePath)}.${crypto.randomBytes(6).toString("hex")}.tmp`
30959 | 100 |   );
30960 | 101 |   fs.writeFileSync(tmp, content, "utf8");
30961 | 102 |   fs.renameSync(tmp, filePath);
30962 | 103 | }
30963 | 104 | 
30964 | 105 | function normalizeUrl(u) {
30965 | 106 |   if (!u) return "";
30966 | 107 |   const x = String(u).trim();
30967 | 108 |   if (!/^https?:\/\/.+/i.test(x)) return "";
30968 | 109 |   return x;
30969 | 110 | }
30970 | 111 | 
30971 | 112 | function normalizeOptionalUrl(u) {
30972 | 113 |   if (!u) return "";
30973 | 114 |   const x = String(u).trim();
30974 | 115 |   if (x === "") return "";
30975 | 116 |   if (!/^https?:\/\/.+/i.test(x)) return "";
30976 | 117 |   return x;
30977 | 118 | }
30978 | 119 | 
30979 | 120 | function nowIso() {
30980 | 121 |   return new Date().toISOString();
30981 | 122 | }
30982 | 123 | 
30983 | 124 | function setEnvKey(envText, key, value) {
30984 | 125 |   const re = new RegExp(`^${key}=.*$`, "m");
30985 | 126 |   const line = `${key}=${value}`;
30986 | 127 |   if (re.test(envText)) return envText.replace(re, line);
30987 | 128 |   return envText.replace(/\s*$/, "") + `\n${line}\n`;
30988 | 129 | }
30989 | 130 | 
30990 | 131 | function pickPostsFile(projectDir) {
30991 | 132 |   return path.join(projectDir, "data", "posts.json");
30992 | 133 | }
30993 | 134 | 
30994 | 135 | function readPosts(postsPath) {
30995 | 136 |   if (!fs.existsSync(postsPath)) return [];
30996 | 137 |   const raw = fs.readFileSync(postsPath, "utf8").trim();
30997 | 138 |   if (!raw) return [];
30998 | 139 |   const parsed = safeJsonParse(raw);
30999 | 140 |   if (!parsed.ok || !Array.isArray(parsed.value))
31000 | 141 |     throw new Error("posts.json invalid (expected array)");
31001 | 142 |   return parsed.value;
31002 | 143 | }
31003 | 144 | 
31004 | 145 | function writePosts(postsPath, posts) {
31005 | 146 |   atomicWriteFile(postsPath, JSON.stringify(posts, null, 2) + "\n");
31006 | 147 | }
31007 | 148 | 
31008 | 149 | function genId() {
31009 | 150 |   return crypto.randomBytes(8).toString("hex");
31010 | 151 | }
31011 | 152 | 
31012 | 153 | function route(req) {
31013 | 154 |   const url = new URL(req.url, "http://localhost");
31014 | 155 |   const pathname = url.pathname;
31015 | 156 |   return { pathname, query: Object.fromEntries(url.searchParams.entries()) };
31016 | 157 | }
31017 | 158 | 
31018 | 159 | function match(pathname, pattern) {
31019 | 160 |   const a = pathname.split("/").filter(Boolean);
31020 | 161 |   const b = pattern.split("/").filter(Boolean);
31021 | 162 |   if (a.length !== b.length) return null;
31022 | 163 |   const params = {};
31023 | 164 |   for (let i = 0; i < a.length; i++) {
31024 | 165 |     if (b[i].startsWith(":")) params[b[i].slice(1)] = a[i];
31025 | 166 |     else if (a[i] !== b[i]) return null;
31026 | 167 |   }
31027 | 168 |   return params;
31028 | 169 | }
31029 | 170 | 
31030 | 171 | // ---------- LOGS (dynamic from pm2 describe) ----------
31031 | 172 | function parsePm2LogPaths(pm2DescribeText) {
31032 | 173 |   const out =
31033 | 174 |     pm2DescribeText.match(/Out log path:\s*(.+)$/m)?.[1]?.trim() ||
31034 | 175 |     pm2DescribeText.match(/out log path:\s*(.+)$/mi)?.[1]?.trim() ||
31035 | 176 |     "";
31036 | 177 |   const err =
31037 | 178 |     pm2DescribeText.match(/Error log path:\s*(.+)$/m)?.[1]?.trim() ||
31038 | 179 |     pm2DescribeText.match(/error log path:\s*(.+)$/mi)?.[1]?.trim() ||
31039 | 180 |     "";
31040 | 181 |   return { out, err };
31041 | 182 | }
31042 | 183 | 
31043 | 184 | async function getPm2LogPaths(appName) {
31044 | 185 |   const envOut = (process.env.PM2_LOG_OUT || "").trim();
31045 | 186 |   const envErr = (process.env.PM2_LOG_ERR || "").trim();
31046 | 187 |   if (envOut || envErr) return { out: envOut, err: envErr, source: "env" };
31047 | 188 | 
31048 | 189 |   const d = await sh(`pm2 describe ${appName}`);
31049 | 190 |   if (!d.ok)
31050 | 191 |     return {
31051 | 192 |       out: "",
31052 | 193 |       err: "",
31053 | 194 |       source: "pm2_error",
31054 | 195 |       pm2: d.stderr || d.stdout || "",
31055 | 196 |     };
31056 | 197 | 
31057 | 198 |   const p = parsePm2LogPaths(d.stdout);
31058 | 199 |   return { out: p.out || "", err: p.err || "", source: "pm2_describe" };
31059 | 200 | }
31060 | 201 | 
31061 | 202 | async function readTailLog(filePath, lines) {
31062 | 203 |   try {
31063 | 204 |     if (!filePath) {
31064 | 205 |       return {
31065 | 206 |         ok: false,
31066 | 207 |         error:
31067 | 208 |           "Nie wykryto ≈õcie≈ºki log√≥w (pm2 describe nie zwr√≥ci≈Ço Out/Error log path).",
31068 | 209 |         path: filePath,
31069 | 210 |       };
31070 | 211 |     }
31071 | 212 | 
31072 | 213 |     if (!fs.existsSync(filePath)) {
31073 | 214 |       return {
31074 | 215 |         ok: false,
31075 | 216 |         error:
31076 | 217 |           "Plik log√≥w nie istnieje w tej ≈õcie≈ºce. To zwykle znaczy, ≈ºe PM2 loguje gdzie indziej albo proces jeszcze nic nie wypisa≈Ç.",
31077 | 218 |         path: filePath,
31078 | 219 |       };
31079 | 220 |     }
31080 | 221 | 
31081 | 222 |     const st = fs.statSync(filePath);
31082 | 223 |     if (!st || !st.isFile()) {
31083 | 224 |       return { ok: false, error: "≈öcie≈ºka log√≥w nie wskazuje na plik.", path: filePath };
31084 | 225 |     }
31085 | 226 | 
31086 | 227 |     if (st.size === 0) {
31087 | 228 |       return {
31088 | 229 |         ok: false,
31089 | 230 |         error:
31090 | 231 |           "Plik log√≥w jest pusty (0 bajt√≥w). Uruchom watcher / poczekaj a≈º co≈õ wypisze.",
31091 | 232 |         path: filePath,
31092 | 233 |       };
31093 | 234 |     }
31094 | 235 | 
31095 | 236 |     
31096 | 237 |     // fallback JS
31097 | 238 |     const raw = fs.readFileSync(filePath, "utf8");
31098 | 239 |     const arr = raw.split(/\r?\n/);
31099 | 240 |     const slice = arr.slice(Math.max(0, arr.length - lines)).join("\n");
31100 | 241 |     const txt = (slice || "").trim();
31101 | 242 | 
31102 | 243 |     if (!txt) {
31103 | 244 |       return { ok: false, error: `Brak danych w ostatnich ${lines} liniach.`, path: filePath, via: "js" };
31104 | 245 |     }
31105 | 246 | 
31106 | 247 |     return { ok: true, log: slice, path: filePath, via: "js" };
31107 | 248 |   } catch (e) {
31108 | 249 |     return { ok: false, error: e?.message || "B≈ÇƒÖd odczytu log√≥w.", path: filePath };
31109 | 250 |   }
31110 | 251 | }
31111 | 252 | 
31112 | 253 | http
31113 | 254 |   .createServer(async (req, res) => {
31114 | 255 |     const { pathname, query } = route(req);
31115 | 256 |     if (req.method === "GET" && pathname === "/ping") {
31116 | 257 |   res.writeHead(200, { "Content-Type": "text/plain; charset=utf-8" });
31117 | 258 |   res.end("pong");
31118 | 259 |   return;
31119 | 260 | }
31120 | 261 | 
31121 | 262 | 
31122 | 263 |     // ---------- PUBLIC UI ----------
31123 | 264 |     if (req.method === "GET" && (pathname === "/" || pathname === "/index.html")) {
31124 | 265 |       const p = path.join(UI_DIR, "index.html");
31125 | 266 |       const html = fs.readFileSync(p, "utf8");
31126 | 267 |       res.writeHead(200, { "Content-Type": "text/html; charset=utf-8" });
31127 | 268 |       res.end(html);
31128 | 269 |       return;
31129 | 270 |     }
31130 | 271 | 
31131 | 272 |     if (req.method === "GET" && pathname === "/app.js") {
31132 | 273 |       const p = path.join(UI_DIR, "app.js");
31133 | 274 |       const js = fs.readFileSync(p, "utf8");
31134 | 275 |       res.writeHead(200, { "Content-Type": "application/javascript; charset=utf-8" });
31135 | 276 |       res.end(js);
31136 | 277 |       return;
31137 | 278 |     }
31138 | 279 | 
31139 | 280 |     // ---------- AUTH for API ----------
31140 | 281 |     if (pathname.startsWith("/api/")) {
31141 | 282 |       if (!auth(req, res)) return;
31142 | 283 |     }
31143 | 284 | 
31144 | 285 |     try {
31145 | 286 |       const PROJECT_DIR = await getProjectDir();
31146 | 287 |       const ENV_PATH = path.join(PROJECT_DIR, ".env");
31147 | 288 |       const COOKIES_PATH = path.join(PROJECT_DIR, "cookies.json");
31148 | 289 |       const POSTS_PATH = pickPostsFile(PROJECT_DIR);
31149 | 290 | 
31150 | 291 |       // ===== STATUS =====
31151 | 292 |       if (req.method === "GET" && pathname === "/api/status") {
31152 | 293 |         const node = await sh("node -v");
31153 | 294 |         const pm2v = await sh("pm2 -v");
31154 | 295 |         const pm2s = await sh(`pm2 status ${PM2_APP}`);
31155 | 296 |         json(res, {
31156 | 297 |           ok: true,
31157 | 298 |           projectDir: PROJECT_DIR,
31158 | 299 |           envPath: ENV_PATH,
31159 | 300 |           cookiesPath: COOKIES_PATH,
31160 | 301 |           postsPath: POSTS_PATH,
31161 | 302 |           node: node.stdout,
31162 | 303 |           pm2: pm2v.stdout,
31163 | 304 |           pm2Status: pm2s.stdout,
31164 | 305 |           time: nowIso(),
31165 | 306 |         });
31166 | 307 |         return;
31167 | 308 |       }
31168 | 309 | 
31169 | 310 |       // ===== ENV GET (selected keys) =====
31170 | 311 |       if (req.method === "GET" && pathname === "/api/env/get") {
31171 | 312 |         if (!fs.existsSync(ENV_PATH)) {
31172 | 313 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
31173 | 314 |           return;
31174 | 315 |         }
31175 | 316 |         const raw = fs.readFileSync(ENV_PATH, "utf8");
31176 | 317 |         const wanted = [
31177 | 318 |           "FB_EMAIL",
31178 | 319 |           "FB_PASSWORD",
31179 | 320 |           "WEBHOOK_URL",
31180 | 321 |           "CHECK_INTERVAL_MS",
31181 | 322 |           "POSTS_SHEET_URL",
31182 | 323 |           "HEADLESS_BROWSER",
31183 | 324 |           "USE_UI_HANDLERS",
31184 | 325 |           "INCLUDE_REPLIES",
31185 | 326 |         ];
31186 | 327 |         const values = {};
31187 | 328 |         for (const k of wanted) {
31188 | 329 |           const m = raw.match(new RegExp(`^${k}=(.*)$`, "m"));
31189 | 330 |           values[k] = m ? m[1] : "";
31190 | 331 |         }
31191 | 332 |         json(res, { ok: true, values });
31192 | 333 |         return;
31193 | 334 |       }
31194 | 335 | 
31195 | 336 |       // ===== ENV SET MULTIPLE =====
31196 | 337 |       if (req.method === "POST" && pathname === "/api/env/set") {
31197 | 338 |         const bodyRaw = await readBody(req);
31198 | 339 |         const parsed = safeJsonParse(bodyRaw || "{}");
31199 | 340 |         if (!parsed.ok) {
31200 | 341 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
31201 | 342 |           return;
31202 | 343 |         }
31203 | 344 | 
31204 | 345 |         const set = parsed.value.set && typeof parsed.value.set === "object" ? parsed.value.set : null;
31205 | 346 |         const restart = Boolean(parsed.value.restart);
31206 | 347 | 
31207 | 348 |         if (!set) {
31208 | 349 |           json(res, { ok: false, error: "Missing set object" }, 400);
31209 | 350 |           return;
31210 | 351 |         }
31211 | 352 |         if (!fs.existsSync(ENV_PATH)) {
31212 | 353 |           json(res, { ok: false, error: `.env not found at ${ENV_PATH}` }, 400);
31213 | 354 |           return;
31214 | 355 |         }
31215 | 356 | 
31216 | 357 |         let env = fs.readFileSync(ENV_PATH, "utf8");
31217 | 358 |         const updated = [];
31218 | 359 | 
31219 | 360 |         for (const [k, v] of Object.entries(set)) {
31220 | 361 |           if (!/^[A-Z0-9_]+$/.test(k)) continue;
31221 | 362 |           env = setEnvKey(env, k, String(v));
31222 | 363 |           updated.push(k);
31223 | 364 |         }
31224 | 365 | 
31225 | 366 |         atomicWriteFile(ENV_PATH, env);
31226 | 367 | 
31227 | 368 |         let pm2Action = null;
31228 | 369 |         if (restart) {
31229 | 370 |           const r = await sh(`pm2 restart ${PM2_APP} --update-env`);
31230 | 371 |           pm2Action = { ok: r.ok, out: r.stdout || r.stderr };
31231 | 372 |         }
31232 | 373 | 
31233 | 374 |         json(res, { ok: true, updated, restarted: restart, pm2: pm2Action });
31234 | 375 |         return;
31235 | 376 |       }
31236 | 377 | 
31237 | 378 |       // ===== POSTS: LIST =====
31238 | 379 |       if (req.method === "GET" && pathname === "/api/posts") {
31239 | 380 |         const posts = readPosts(POSTS_PATH);
31240 | 381 | 
31241 | 382 |         // normalizacja (≈ºeby stary posts.json bez p√≥l te≈º dzia≈Ça≈Ç)
31242 | 383 |         const norm = (posts || []).map((p) => ({
31243 | 384 |           id: String(p.id || "").trim(),
31244 | 385 |           url: String(p.url || "").trim(),
31245 | 386 |           active: p.active !== undefined ? Boolean(p.active) : true,
31246 | 387 |           name: String(p.name || "").trim(),
31247 | 388 |           image: String(p.image || "").trim(),
31248 | 389 |           description: String(p.description || "").trim(),
31249 | 390 |           createdAt: p.createdAt || "",
31250 | 391 |           updatedAt: p.updatedAt || "",
31251 | 392 |         }));
31252 | 393 | 
31253 | 394 |         norm.sort((x, y) => String(y.createdAt || "").localeCompare(String(x.createdAt || "")));
31254 | 395 |         json(res, { ok: true, posts: norm });
31255 | 396 |         return;
31256 | 397 |       }
31257 | 398 | 
31258 | 399 |       // ===== POSTS: ADD =====
31259 | 400 |       if (req.method === "POST" && pathname === "/api/posts") {
31260 | 401 |         const bodyRaw = await readBody(req);
31261 | 402 |         const parsed = safeJsonParse(bodyRaw || "{}");
31262 | 403 |         if (!parsed.ok) {
31263 | 404 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
31264 | 405 |           return;
31265 | 406 |         }
31266 | 407 | 
31267 | 408 |         const url = normalizeUrl(parsed.value.url);
31268 | 409 |         const active = parsed.value.active !== undefined ? Boolean(parsed.value.active) : true;
31269 | 410 | 
31270 | 411 |         const name = String(parsed.value.name || "").trim();
31271 | 412 |         const imageRaw = String(parsed.value.image || "").trim();
31272 | 413 |         const image = normalizeOptionalUrl(imageRaw);
31273 | 414 |         const description = String(parsed.value.description || "").trim();
31274 | 415 | 
31275 | 416 |         if (!url) {
31276 | 417 |           json(res, { ok: false, error: "Invalid url (must start with http/https)" }, 400);
31277 | 418 |           return;
31278 | 419 |         }
31279 | 420 |         if (imageRaw !== "" && !image) {
31280 | 421 |           json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
31281 | 422 |           return;
31282 | 423 |         }
31283 | 424 | 
31284 | 425 |         const posts = readPosts(POSTS_PATH);
31285 | 426 |         const existing = posts.find((p) => p.url === url);
31286 | 427 |         if (existing) {
31287 | 428 |           existing.active = active;
31288 | 429 |           existing.name = name;
31289 | 430 |           existing.image = image;
31290 | 431 |           existing.description = description;
31291 | 432 |           existing.updatedAt = nowIso();
31292 | 433 |           writePosts(POSTS_PATH, posts);
31293 | 434 |           json(res, { ok: true, post: existing, deduped: true });
31294 | 435 |           return;
31295 | 436 |         }
31296 | 437 | 
31297 | 438 |         const post = {
31298 | 439 |           id: genId(),
31299 | 440 |           url,
31300 | 441 |           active,
31301 | 442 |           name,
31302 | 443 |           image,
31303 | 444 |           description,
31304 | 445 |           createdAt: nowIso(),
31305 | 446 |           updatedAt: nowIso(),
31306 | 447 |         };
31307 | 448 |         posts.push(post);
31308 | 449 |         writePosts(POSTS_PATH, posts);
31309 | 450 | 
31310 | 451 |         json(res, { ok: true, post });
31311 | 452 |         return;
31312 | 453 |       }
31313 | 454 | 
31314 | 455 |       // ===== POSTS: PATCH =====
31315 | 456 |       const mPatch = req.method === "PATCH" ? match(pathname, "/api/posts/:id") : null;
31316 | 457 |       if (mPatch) {
31317 | 458 |         const id = mPatch.id;
31318 | 459 |         const bodyRaw = await readBody(req);
31319 | 460 |         const parsed = safeJsonParse(bodyRaw || "{}");
31320 | 461 |         if (!parsed.ok) {
31321 | 462 |           json(res, { ok: false, error: "Invalid JSON body" }, 400);
31322 | 463 |           return;
31323 | 464 |         }
31324 | 465 | 
31325 | 466 |         const posts = readPosts(POSTS_PATH);
31326 | 467 |         const post = posts.find((p) => p.id === id);
31327 | 468 |         if (!post) {
31328 | 469 |           json(res, { ok: false, error: "Post not found" }, 404);
31329 | 470 |           return;
31330 | 471 |         }
31331 | 472 | 
31332 | 473 |         if (parsed.value.url !== undefined) {
31333 | 474 |           const nextUrl = normalizeUrl(parsed.value.url);
31334 | 475 |           if (!nextUrl) {
31335 | 476 |             json(res, { ok: false, error: "Invalid url" }, 400);
31336 | 477 |             return;
31337 | 478 |           }
31338 | 479 |           const dup = posts.find((p) => p.url === nextUrl && p.id !== id);
31339 | 480 |           if (dup) {
31340 | 481 |             json(res, { ok: false, error: "Another post with this url already exists" }, 409);
31341 | 482 |             return;
31342 | 483 |           }
31343 | 484 |           post.url = nextUrl;
31344 | 485 |         }
31345 | 486 | 
31346 | 487 |         if (parsed.value.active !== undefined) post.active = Boolean(parsed.value.active);
31347 | 488 | 
31348 | 489 |         if (parsed.value.name !== undefined) post.name = String(parsed.value.name || "").trim();
31349 | 490 | 
31350 | 491 |         if (parsed.value.image !== undefined) {
31351 | 492 |           const raw = String(parsed.value.image || "").trim();
31352 | 493 |           const img = normalizeOptionalUrl(raw);
31353 | 494 |           if (raw !== "" && !img) {
31354 | 495 |             json(res, { ok: false, error: "Invalid image url (must start with http/https or be empty)" }, 400);
31355 | 496 |             return;
31356 | 497 |           }
31357 | 498 |           post.image = img;
31358 | 499 |         }
31359 | 500 | 
31360 | 501 |         if (parsed.value.description !== undefined) post.description = String(parsed.value.description || "").trim();
31361 | 502 | 
31362 | 503 |         post.updatedAt = nowIso();
31363 | 504 |         writePosts(POSTS_PATH, posts);
31364 | 505 |         json(res, { ok: true, post });
31365 | 506 |         return;
31366 | 507 |       }
31367 | 508 | 
31368 | 509 |       // ===== POSTS: DELETE =====
31369 | 510 |       const mDel = req.method === "DELETE" ? match(pathname, "/api/posts/:id") : null;
31370 | 511 |       if (mDel) {
31371 | 512 |         const id = mDel.id;
31372 | 513 |         const posts = readPosts(POSTS_PATH);
31373 | 514 |         const idx = posts.findIndex((p) => p.id === id);
31374 | 515 |         if (idx === -1) {
31375 | 516 |           json(res, { ok: false, error: "Post not found" }, 404);
31376 | 517 |           return;
31377 | 518 |         }
31378 | 519 |         const removed = posts.splice(idx, 1)[0];
31379 | 520 |         writePosts(POSTS_PATH, posts);
31380 | 521 |         json(res, { ok: true, removed });
31381 | 522 |         return;
31382 | 523 |       }
31383 | 524 | 
31384 | 525 |       // ===== COOKIES: CLEAR =====
31385 | 526 |       if (req.method === "POST" && pathname === "/api/cookies/clear") {
31386 | 527 |         const bodyRaw = await readBody(req);
31387 | 528 |         const parsed = safeJsonParse(bodyRaw || "{}");
31388 | 529 |         const confirm = parsed.ok ? Boolean(parsed.value.confirm) : false;
31389 | 530 | 
31390 | 531 |         if (!confirm) {
31391 | 532 |           json(res, { ok: false, error: "Set {confirm:true} to clear cookies" }, 400);
31392 | 533 |           return;
31393 | 534 |         }
31394 | 535 | 
31395 | 536 |         atomicWriteFile(COOKIES_PATH, "[]\n");
31396 | 537 |         json(res, { ok: true, cookiesPath: COOKIES_PATH });
31397 | 538 |         return;
31398 | 539 |       }
31399 | 540 | 
31400 | 541 |       // ===== PM2 =====
31401 | 542 |       function okOrErr(r, fallbackErr = "Command failed") {
31402 | 543 |         if (r.ok) return { ok: true, output: r.stdout || r.stderr || "" };
31403 | 544 |         return { ok: false, error: r.stderr || r.stdout || fallbackErr };
31404 | 545 |       }
31405 | 546 |       async function pm2Describe(name) {
31406 | 547 |         return await sh(`pm2 describe ${name}`);
31407 | 548 |       }
31408 | 549 | 
31409 | 550 |       const WATCH_ENTRY = path.join(PROJECT_DIR, "src", "index.js");
31410 | 551 |       const WATCH_NAME = PM2_APP || "fbwatcher";
31411 | 552 | 
31412 | 553 |       if (req.method === "POST" && pathname === "/api/pm2/start") {
31413 | 554 |         const d = await pm2Describe(WATCH_NAME);
31414 | 555 |         if (d.ok) {
31415 | 556 |           const r = await sh(`pm2 start ${WATCH_NAME}`);
31416 | 557 |           json(res, okOrErr(r, "PM2 start failed"));
31417 | 558 |           return;
31418 | 559 |         }
31419 | 560 | 
31420 | 561 |         const r = await sh(`pm2 start "${WATCH_ENTRY}" --name "${WATCH_NAME}"`);
31421 | 562 |         json(res, okOrErr(r, `Cannot create PM2 process for ${WATCH_NAME}`));
31422 | 563 |         return;
31423 | 564 |       }
31424 | 565 | 
31425 | 566 |       if (req.method === "POST" && pathname === "/api/pm2/restart") {
31426 | 567 |         const d = await pm2Describe(WATCH_NAME);
31427 | 568 |         if (!d.ok) {
31428 | 569 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found. Click PM2 Start first.` });
31429 | 570 |           return;
31430 | 571 |         }
31431 | 572 |         const r = await sh(`pm2 restart ${WATCH_NAME} --update-env`);
31432 | 573 |         json(res, okOrErr(r, "PM2 restart failed"));
31433 | 574 |         return;
31434 | 575 |       }
31435 | 576 | 
31436 | 577 |       if (req.method === "POST" && pathname === "/api/pm2/stop") {
31437 | 578 |         const d = await pm2Describe(WATCH_NAME);
31438 | 579 |         if (!d.ok) {
31439 | 580 |           json(res, { ok: false, error: `Process ${WATCH_NAME} not found.` });
31440 | 581 |           return;
31441 | 582 |         }
31442 | 583 |         const r = await sh(`pm2 stop ${WATCH_NAME}`);
31443 | 584 |         json(res, okOrErr(r, "PM2 stop failed"));
31444 | 585 |         return;
31445 | 586 |       }
31446 | 587 | 
31447 | 588 |       if (req.method === "GET" && pathname === "/api/pm2/status") {
31448 | 589 |         const r = await sh(`pm2 status ${WATCH_NAME}`);
31449 | 590 |         json(res, okOrErr(r, "PM2 status failed"));
31450 | 591 |         return;
31451 | 592 |       }
31452 | 593 | 
31453 | 594 |       // ===== LOGS INFO (debug) =====
31454 | 595 |       if (req.method === "GET" && pathname === "/api/logs/info") {
31455 | 596 |         const paths = await getPm2LogPaths(PM2_APP);
31456 | 597 |         json(res, { ok: true, app: PM2_APP, ...paths });
31457 | 598 |         return;
31458 | 599 |       }
31459 | 600 | 
31460 | 601 |       // ===== LOGS =====
31461 | 602 |       if (req.method === "GET" && pathname === "/api/logs/out") {
31462 | 603 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
31463 | 604 |         const paths = await getPm2LogPaths(PM2_APP);
31464 | 605 |         const payload = await readTailLog(paths.out, lines);
31465 | 606 |         json(res, { ...payload, source: paths.source });
31466 | 607 |         return;
31467 | 608 |       }
31468 | 609 | 
31469 | 610 |       if (req.method === "GET" && pathname === "/api/logs/err") {
31470 | 611 |         const lines = Math.min(Math.max(parseInt(query.lines || "200", 10) || 200, 20), 2000);
31471 | 612 |         const paths = await getPm2LogPaths(PM2_APP);
31472 | 613 |         const payload = await readTailLog(paths.err, lines);
31473 | 614 |         json(res, { ...payload, source: paths.source });
31474 | 615 |         return;
31475 | 616 |       }
31476 | 617 | 
31477 | 618 |       json(res, { ok: false, error: "Not found" }, 404);
31478 | 619 |     } catch (e) {
31479 | 620 |       json(res, { ok: false, error: e.message }, 500);
31480 | 621 |     }
31481 | 622 |   })
31482 | 623 |   .listen(PORT, "127.0.0.1", () => {
31483 | 624 |     console.log(`[PANEL] listening on http://127.0.0.1:${PORT} (PM2_APP=${PM2_APP})`);
31484 | 625 |     console.log(`[PANEL] UI_DIR=${UI_DIR}`);
31485 | 626 |     console.log(`[PANEL] BASE_DIR=${BASE_DIR}`);
31486 | 627 |   });
31487 | 628 | 
31488 | ```
31489 | 
31490 | ---
31491 | 
31492 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/app.js`
31493 | **Typ:** JavaScript/tekst  
31494 | **Opis:** Plik projektu (kod/konfiguracja).  
31495 | 
31496 | ```js
31497 |   1 | (() => {
31498 |   2 |   const $ = (id) => document.getElementById(id);
31499 |   3 | 
31500 |   4 |   // ---------- state ----------
31501 |   5 |   let token = localStorage.getItem("FBW_PANEL_TOKEN") || "";
31502 |   6 |   let logAutoTimer = null;
31503 |   7 |   let lastLogMode = "out"; // 'out' | 'err'
31504 |   8 |   let logsExpanded = false;
31505 |   9 | 
31506 |  10 |   // modal state
31507 |  11 |   let modalResolve = null;
31508 |  12 | 
31509 |  13 |   // edit modal state
31510 |  14 |   let editResolve = null;
31511 |  15 | 
31512 |  16 |   // ---------- ui refs ----------
31513 |  17 |   const elToken = $("token");
31514 |  18 |   const btnSaveToken = $("saveToken");
31515 |  19 |   const btnRefresh = $("refresh");
31516 |  20 |   const elStatus = $("status");
31517 |  21 | 
31518 |  22 |   const btnSaveEnv = $("saveEnv");
31519 |  23 |   const btnPm2Start = $("pm2Start");
31520 |  24 |   const btnPm2Stop = $("pm2Stop");
31521 |  25 |   const btnPm2Restart = $("pm2Restart");
31522 |  26 |   const btnClearCookies = $("clearCookies");
31523 |  27 |   const elEnvMsg = $("envMsg");
31524 |  28 | 
31525 |  29 |   const elNewPostUrl = $("newPostUrl");
31526 |  30 |   const elNewPostName = $("newPostName");
31527 |  31 |   const elNewPostImage = $("newPostImage");
31528 |  32 |   const elNewPostDescription = $("newPostDescription");
31529 |  33 |   const elNewPostActive = $("newPostActive");
31530 |  34 |   const btnAddPost = $("addPost");
31531 |  35 |   const elPostsTbody = $("posts");
31532 |  36 | 
31533 |  37 |   const btnLoadOut = $("loadOut");
31534 |  38 |   const btnLoadErr = $("loadErr");
31535 |  39 |   const elLogLines = $("logLines");
31536 |  40 |   const elLogAutoEvery = $("logAutoEvery");
31537 |  41 |   const btnLogAutoToggle = $("logAutoToggle");
31538 |  42 |   const elLogAutoScroll = $("logAutoScroll");
31539 |  43 |   const elLogs = $("logs");
31540 |  44 |   const elLogHint = $("logHint");
31541 |  45 | 
31542 |  46 |   const logsCard = $("logsCard");
31543 |  47 |   const btnToggleLogsSize = $("toggleLogsSize");
31544 |  48 | 
31545 |  49 |   // modal refs (delete + generic)
31546 |  50 |   const modalOverlay = $("modalOverlay");
31547 |  51 |   const modalBody = $("modalBody");
31548 |  52 |   const modalCancel = $("modalCancel");
31549 |  53 |   const modalOk = $("modalOk");
31550 |  54 | 
31551 |  55 |   // env fields
31552 |  56 |   const ENV_FIELDS = [
31553 |  57 |     "FB_EMAIL",
31554 |  58 |     "FB_PASSWORD",
31555 |  59 |     "WEBHOOK_URL",
31556 |  60 |     "CHECK_INTERVAL_MS",
31557 |  61 |     "POSTS_SHEET_URL",
31558 |  62 |     "HEADLESS_BROWSER",
31559 |  63 |     "USE_UI_HANDLERS",
31560 |  64 |     "INCLUDE_REPLIES",
31561 |  65 |   ];
31562 |  66 | 
31563 |  67 |   function setHint(el, msg, ok = true) {
31564 |  68 |     if (!el) return;
31565 |  69 |     el.textContent = msg || "";
31566 |  70 |     el.classList.remove("ok", "err");
31567 |  71 |     el.classList.add(ok ? "ok" : "err");
31568 |  72 |   }
31569 |  73 | 
31570 |  74 |   function fmtTime() {
31571 |  75 |     try {
31572 |  76 |       return new Date().toLocaleString();
31573 |  77 |     } catch {
31574 |  78 |       return "";
31575 |  79 |     }
31576 |  80 |   }
31577 |  81 | 
31578 |  82 |   function getAuthHeaders() {
31579 |  83 |     const t = (token || "").trim();
31580 |  84 |     return t ? { Authorization: `Bearer ${t}` } : {};
31581 |  85 |   }
31582 |  86 | 
31583 |  87 |   async function api(path, opts = {}) {
31584 |  88 |     const headers = {
31585 |  89 |       ...(opts.headers || {}),
31586 |  90 |       ...getAuthHeaders(),
31587 |  91 |     };
31588 |  92 | 
31589 |  93 |     let body = opts.body;
31590 |  94 |     if (body && typeof body === "object" && !(body instanceof FormData)) {
31591 |  95 |       headers["Content-Type"] = "application/json";
31592 |  96 |       body = JSON.stringify(body);
31593 |  97 |     }
31594 |  98 | 
31595 |  99 |     const res = await fetch(path, {
31596 | 100 |       method: opts.method || "GET",
31597 | 101 |       headers,
31598 | 102 |       body,
31599 | 103 |     });
31600 | 104 | 
31601 | 105 |     const text = await res.text();
31602 | 106 |     let data = null;
31603 | 107 |     try {
31604 | 108 |       data = JSON.parse(text);
31605 | 109 |     } catch {
31606 | 110 |       data = { ok: false, error: text || `HTTP ${res.status}` };
31607 | 111 |     }
31608 | 112 | 
31609 | 113 |     if (!res.ok) {
31610 | 114 |       return { ok: false, error: data?.error || `HTTP ${res.status}`, status: res.status, data };
31611 | 115 |     }
31612 | 116 |     return data;
31613 | 117 |   }
31614 | 118 | 
31615 | 119 |   // ---------- modal ----------
31616 | 120 |   function showModal({ title = "Potwierdzenie", body = "", okText = "OK", danger = false } = {}) {
31617 | 121 |     return new Promise((resolve) => {
31618 | 122 |       modalResolve = resolve;
31619 | 123 | 
31620 | 124 |       $("modalTitle").textContent = title;
31621 | 125 |       modalBody.innerHTML = body;
31622 | 126 | 
31623 | 127 |       modalOk.textContent = okText;
31624 | 128 |       modalOk.classList.toggle("danger", !!danger);
31625 | 129 | 
31626 | 130 |       modalOverlay.classList.add("show");
31627 | 131 |       modalOverlay.setAttribute("aria-hidden", "false");
31628 | 132 | 
31629 | 133 |       setTimeout(() => {
31630 | 134 |         (danger ? modalOk : modalCancel).focus();
31631 | 135 |       }, 0);
31632 | 136 |     });
31633 | 137 |   }
31634 | 138 | 
31635 | 139 |   function closeModal(result) {
31636 | 140 |     modalOverlay.classList.remove("show");
31637 | 141 |     modalOverlay.setAttribute("aria-hidden", "true");
31638 | 142 |     const r = modalResolve;
31639 | 143 |     modalResolve = null;
31640 | 144 |     if (typeof r === "function") r(result);
31641 | 145 |   }
31642 | 146 | 
31643 | 147 |   modalCancel.addEventListener("click", () => closeModal(false));
31644 | 148 |   modalOk.addEventListener("click", () => closeModal(true));
31645 | 149 |   modalOverlay.addEventListener("click", (e) => {
31646 | 150 |     if (e.target === modalOverlay) closeModal(false);
31647 | 151 |   });
31648 | 152 |   window.addEventListener("keydown", (e) => {
31649 | 153 |     if (e.key === "Escape" && modalOverlay.classList.contains("show")) closeModal(false);
31650 | 154 |   });
31651 | 155 | 
31652 | 156 |   // ---------- core actions ----------
31653 | 157 |   async function loadStatus() {
31654 | 158 |     setHint(elStatus, "≈Åadowanie statusu...", true);
31655 | 159 | 
31656 | 160 |     const r = await api("/api/status");
31657 | 161 |     if (!r.ok) {
31658 | 162 |       setHint(
31659 | 163 |         elStatus,
31660 | 164 |         `Brak dostƒôpu do API. Wpisz token i kliknij ‚ÄûZapisz token‚Äù. (${r.error || "b≈ÇƒÖd"})`,
31661 | 165 |         false
31662 | 166 |       );
31663 | 167 |       return null;
31664 | 168 |     }
31665 | 169 | 
31666 | 170 |     setHint(elStatus, `Po≈ÇƒÖczono ‚Ä¢ ${fmtTime()}`, true);
31667 | 171 |     return r;
31668 | 172 |   }
31669 | 173 | 
31670 | 174 |   async function loadEnv() {
31671 | 175 |     setHint(elEnvMsg, "Wczytujƒô ustawienia...", true);
31672 | 176 |     const r = await api("/api/env/get");
31673 | 177 |     if (!r.ok) {
31674 | 178 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá .env (${r.error || "b≈ÇƒÖd"})`, false);
31675 | 179 |       return;
31676 | 180 |     }
31677 | 181 |     const v = r.values || {};
31678 | 182 |     for (const k of ENV_FIELDS) {
31679 | 183 |       const el = $(k);
31680 | 184 |       if (!el) continue;
31681 | 185 |       el.value = (v[k] ?? "").toString();
31682 | 186 |     }
31683 | 187 |     setHint(elEnvMsg, `Ustawienia wczytane.`, true);
31684 | 188 |   }
31685 | 189 | 
31686 | 190 |   async function saveEnv(restart = false) {
31687 | 191 |     const set = {};
31688 | 192 |     for (const k of ENV_FIELDS) {
31689 | 193 |       const el = $(k);
31690 | 194 |       if (!el) continue;
31691 | 195 |       set[k] = (el.value ?? "").toString();
31692 | 196 |     }
31693 | 197 | 
31694 | 198 |     setHint(elEnvMsg, restart ? "Zapisujƒô i restartujƒô..." : "Zapisujƒô...", true);
31695 | 199 | 
31696 | 200 |     const r = await api("/api/env/set", {
31697 | 201 |       method: "POST",
31698 | 202 |       body: { set, restart },
31699 | 203 |     });
31700 | 204 | 
31701 | 205 |     if (!r.ok) {
31702 | 206 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá ustawie≈Ñ (${r.error || "b≈ÇƒÖd"})`, false);
31703 | 207 |       return;
31704 | 208 |     }
31705 | 209 | 
31706 | 210 |     setHint(elEnvMsg, restart ? "Zapisano i zrestartowano watchera." : "Zapisano ustawienia.", true);
31707 | 211 |   }
31708 | 212 | 
31709 | 213 |   function copyIconSvg() {
31710 | 214 |     // klasyczna ikonka "kopiuj" (dwa arkusze)
31711 | 215 |     return `
31712 | 216 |       <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
31713 | 217 |         <rect x="9" y="9" width="10" height="10" rx="2"></rect>
31714 | 218 |         <path d="M7 15H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v1"></path>
31715 | 219 |       </svg>
31716 | 220 |     `;
31717 | 221 |   }
31718 | 222 | 
31719 | 223 |   async function loadPosts() {
31720 | 224 |     const r = await api("/api/posts");
31721 | 225 |     if (!r.ok) {
31722 | 226 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wczytaƒá post√≥w (${r.error || "b≈ÇƒÖd"})`, false);
31723 | 227 |       return;
31724 | 228 |     }
31725 | 229 | 
31726 | 230 |     const posts = Array.isArray(r.posts) ? r.posts : [];
31727 | 231 |     elPostsTbody.innerHTML = "";
31728 | 232 | 
31729 | 233 |     for (const p of posts) {
31730 | 234 |       const tr = document.createElement("tr");
31731 | 235 | 
31732 | 236 |       const tdId = document.createElement("td");
31733 | 237 |       tdId.className = "mono col-id";
31734 | 238 |       tdId.textContent = p.id || "";
31735 | 239 |       tr.appendChild(tdId);
31736 | 240 | 
31737 | 241 |       // LINK + IKONKA KOPIUJ PRZY LINKU
31738 | 242 |       const tdUrl = document.createElement("td");
31739 | 243 |       tdUrl.className = "col-url";
31740 | 244 | 
31741 | 245 |       if (p.url) {
31742 | 246 |         const wrap = document.createElement("div");
31743 | 247 |         wrap.className = "urlWrap";
31744 | 248 | 
31745 | 249 |         const a = document.createElement("a");
31746 | 250 |         a.href = p.url;
31747 | 251 |         a.target = "_blank";
31748 | 252 |         a.rel = "noopener noreferrer";
31749 | 253 |         a.textContent = p.url;
31750 | 254 | 
31751 | 255 |         const btnCopyIcon = document.createElement("button");
31752 | 256 |         btnCopyIcon.className = "iconBtn";
31753 | 257 |         btnCopyIcon.type = "button";
31754 | 258 |         btnCopyIcon.title = "Kopiuj link";
31755 | 259 |         btnCopyIcon.innerHTML = copyIconSvg();
31756 | 260 | 
31757 | 261 |         btnCopyIcon.addEventListener("click", async (e) => {
31758 | 262 |           e.preventDefault();
31759 | 263 |           e.stopPropagation();
31760 | 264 | 
31761 | 265 |           const ok = await copyToClipboard(p.url);
31762 | 266 |           if (ok) setHint(elEnvMsg, "Link skopiowany do schowka.", true);
31763 | 267 |           else setHint(elEnvMsg, "Nie uda≈Ço siƒô skopiowaƒá linku.", false);
31764 | 268 |         });
31765 | 269 | 
31766 | 270 |         wrap.appendChild(a);
31767 | 271 |         wrap.appendChild(btnCopyIcon);
31768 | 272 |         tdUrl.appendChild(wrap);
31769 | 273 |       }
31770 | 274 | 
31771 | 275 |       tr.appendChild(tdUrl);
31772 | 276 | 
31773 | 277 |       const tdName = document.createElement("td");
31774 | 278 |       tdName.className = "col-name";
31775 | 279 |       tdName.textContent = p.name || "";
31776 | 280 |       tr.appendChild(tdName);
31777 | 281 | 
31778 | 282 |       const tdImg = document.createElement("td");
31779 | 283 |       tdImg.className = "col-img";
31780 | 284 |       if (p.image) {
31781 | 285 |         tdImg.innerHTML = `<img class="thumb" src="${escapeHtml(p.image)}" alt="miniatura" />`;
31782 | 286 |       } else {
31783 | 287 |         tdImg.textContent = "";
31784 | 288 |       }
31785 | 289 |       tr.appendChild(tdImg);
31786 | 290 | 
31787 | 291 |       const tdDesc = document.createElement("td");
31788 | 292 |       tdDesc.className = "col-desc";
31789 | 293 |       tdDesc.textContent = p.description || "";
31790 | 294 |       tr.appendChild(tdDesc);
31791 | 295 | 
31792 | 296 |       const tdActive = document.createElement("td");
31793 | 297 |       tdActive.className = "col-act";
31794 | 298 |       const chk = document.createElement("input");
31795 | 299 |       chk.type = "checkbox";
31796 | 300 |       chk.checked = !!p.active;
31797 | 301 |       chk.addEventListener("change", async () => {
31798 | 302 |         await api(`/api/posts/${encodeURIComponent(p.id)}`, {
31799 | 303 |           method: "PATCH",
31800 | 304 |           body: { active: chk.checked },
31801 | 305 |         });
31802 | 306 |         await loadPosts();
31803 | 307 |       });
31804 | 308 |       tdActive.appendChild(chk);
31805 | 309 |       tr.appendChild(tdActive);
31806 | 310 | 
31807 | 311 |       // AKCJE: EDYTUJ + USU≈É
31808 | 312 |       const tdActions = document.createElement("td");
31809 | 313 |       tdActions.className = "col-btn";
31810 | 314 | 
31811 | 315 |       const actions = document.createElement("div");
31812 | 316 |       actions.className = "actionsWrap";
31813 | 317 | 
31814 | 318 |       const btnEdit = document.createElement("button");
31815 | 319 |       btnEdit.className = "small";
31816 | 320 |       btnEdit.type = "button";
31817 | 321 |       btnEdit.textContent = "Edytuj";
31818 | 322 |       btnEdit.addEventListener("click", async () => {
31819 | 323 |         // minimalny edytor: szybkie wpisanie warto≈õci przez modal (prosto i bez dorabiania HTML-a)
31820 | 324 |         // je≈õli chcesz ‚Äú≈Çadny formularz‚Äù w modalu ‚Äì zrobimy w nastƒôpnym kroku
31821 | 325 |         const ok = await showModal({
31822 | 326 |           title: "Edytuj post",
31823 | 327 |           body:
31824 | 328 |             `<div class="muted">Na szybko: skopiuj/wklej warto≈õci i zapisz.</div>` +
31825 | 329 |             `<div style="margin-top:10px">
31826 | 330 |               <label class="muted" style="display:block;margin:8px 0 6px;">Link</label>
31827 | 331 |               <input id="edit_url" value="${escapeHtml(p.url || "")}" />
31828 | 332 |               <label class="muted" style="display:block;margin:8px 0 6px;">Nazwa</label>
31829 | 333 |               <input id="edit_name" value="${escapeHtml(p.name || "")}" />
31830 | 334 |               <label class="muted" style="display:block;margin:8px 0 6px;">URL zdjƒôcia</label>
31831 | 335 |               <input id="edit_img" value="${escapeHtml(p.image || "")}" />
31832 | 336 |               <label class="muted" style="display:block;margin:8px 0 6px;">Opis</label>
31833 | 337 |               <textarea id="edit_desc" style="height:90px;">${escapeHtml(p.description || "")}</textarea>
31834 | 338 |             </div>`,
31835 | 339 |           okText: "Zapisz",
31836 | 340 |           danger: false,
31837 | 341 |         });
31838 | 342 | 
31839 | 343 |         if (!ok) return;
31840 | 344 | 
31841 | 345 |         const newUrl = (document.getElementById("edit_url")?.value || "").trim();
31842 | 346 |         const newName = (document.getElementById("edit_name")?.value || "").trim();
31843 | 347 |         const newImg = (document.getElementById("edit_img")?.value || "").trim();
31844 | 348 |         const newDesc = (document.getElementById("edit_desc")?.value || "").trim();
31845 | 349 | 
31846 | 350 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, {
31847 | 351 |           method: "PATCH",
31848 | 352 |           body: { url: newUrl, name: newName, image: newImg, description: newDesc },
31849 | 353 |         });
31850 | 354 | 
31851 | 355 |         if (!rr.ok) {
31852 | 356 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô zapisaƒá zmian (${rr.error || "b≈ÇƒÖd"})`, false);
31853 | 357 |           return;
31854 | 358 |         }
31855 | 359 | 
31856 | 360 |         setHint(elEnvMsg, "Zapisano zmiany posta.", true);
31857 | 361 |         await loadPosts();
31858 | 362 |       });
31859 | 363 | 
31860 | 364 |       const btnDel = document.createElement("button");
31861 | 365 |       btnDel.className = "danger";
31862 | 366 |       btnDel.type = "button";
31863 | 367 |       btnDel.textContent = "Usu≈Ñ";
31864 | 368 |       btnDel.addEventListener("click", async () => {
31865 | 369 |         const ok = await showModal({
31866 | 370 |           title: "UsunƒÖƒá post?",
31867 | 371 |           body:
31868 | 372 |             `<div>Ta operacja jest nieodwracalna.</div>` +
31869 | 373 |             `<div style="margin-top:10px" class="mono">${escapeHtml(p.name || "")}</div>` +
31870 | 374 |             `<div style="margin-top:8px; opacity:.85; font-size:12px; overflow-wrap:anywhere;">${escapeHtml(p.url || "")}</div>`,
31871 | 375 |           okText: "Usu≈Ñ",
31872 | 376 |           danger: true,
31873 | 377 |         });
31874 | 378 |         if (!ok) return;
31875 | 379 | 
31876 | 380 |         const rr = await api(`/api/posts/${encodeURIComponent(p.id)}`, { method: "DELETE" });
31877 | 381 |         if (!rr.ok) {
31878 | 382 |           setHint(elEnvMsg, `Nie uda≈Ço siƒô usunƒÖƒá posta (${rr.error || "b≈ÇƒÖd"})`, false);
31879 | 383 |           return;
31880 | 384 |         }
31881 | 385 |         setHint(elEnvMsg, "Post usuniƒôty.", true);
31882 | 386 |         await loadPosts();
31883 | 387 |       });
31884 | 388 | 
31885 | 389 |       actions.appendChild(btnEdit);
31886 | 390 |       actions.appendChild(btnDel);
31887 | 391 | 
31888 | 392 |       tdActions.appendChild(actions);
31889 | 393 |       tr.appendChild(tdActions);
31890 | 394 | 
31891 | 395 |       elPostsTbody.appendChild(tr);
31892 | 396 |     }
31893 | 397 |   }
31894 | 398 | 
31895 | 399 |   async function addPost() {
31896 | 400 |     const url = (elNewPostUrl.value || "").trim();
31897 | 401 |     const name = (elNewPostName.value || "").trim();
31898 | 402 |     const image = (elNewPostImage.value || "").trim();
31899 | 403 |     const description = (elNewPostDescription.value || "").trim();
31900 | 404 |     const active = !!elNewPostActive.checked;
31901 | 405 | 
31902 | 406 |     const r = await api("/api/posts", {
31903 | 407 |       method: "POST",
31904 | 408 |       body: { url, name, image, description, active },
31905 | 409 |     });
31906 | 410 | 
31907 | 411 |     if (!r.ok) {
31908 | 412 |       await showModal({
31909 | 413 |         title: "Nie uda≈Ço siƒô dodaƒá posta",
31910 | 414 |         body: `<div>${escapeHtml(r.error || "B≈ÇƒÖd")}</div>`,
31911 | 415 |         okText: "OK",
31912 | 416 |         danger: false,
31913 | 417 |       });
31914 | 418 |       return;
31915 | 419 |     }
31916 | 420 | 
31917 | 421 |     elNewPostUrl.value = "";
31918 | 422 |     elNewPostName.value = "";
31919 | 423 |     elNewPostImage.value = "";
31920 | 424 |     elNewPostDescription.value = "";
31921 | 425 |     elNewPostActive.checked = true;
31922 | 426 | 
31923 | 427 |     setHint(elEnvMsg, "Dodano post.", true);
31924 | 428 |     await loadPosts();
31925 | 429 |   }
31926 | 430 | 
31927 | 431 |   async function pm2Call(which) {
31928 | 432 |     const map = {
31929 | 433 |       start: "/api/pm2/start",
31930 | 434 |       stop: "/api/pm2/stop",
31931 | 435 |       restart: "/api/pm2/restart",
31932 | 436 |       status: "/api/pm2/status",
31933 | 437 |     };
31934 | 438 |     const path = map[which];
31935 | 439 |     if (!path) return;
31936 | 440 | 
31937 | 441 |     const label =
31938 | 442 |       which === "start" ? "Startujƒô watchera..."
31939 | 443 |         : which === "stop" ? "Zatrzymujƒô watchera..."
31940 | 444 |           : which === "restart" ? "Restartujƒô watchera..."
31941 | 445 |             : "Sprawdzam status...";
31942 | 446 | 
31943 | 447 |     setHint(elEnvMsg, label, true);
31944 | 448 | 
31945 | 449 |     const r = await api(path, { method: which === "status" ? "GET" : "POST" });
31946 | 450 |     if (!r.ok) {
31947 | 451 |       setHint(elEnvMsg, `Operacja PM2 nieudana (${r.error || "b≈ÇƒÖd"})`, false);
31948 | 452 |       return;
31949 | 453 |     }
31950 | 454 | 
31951 | 455 |     const okMsg =
31952 | 456 |       which === "start" ? "Watcher uruchomiony."
31953 | 457 |         : which === "stop" ? "Watcher zatrzymany."
31954 | 458 |           : which === "restart" ? "Watcher zrestartowany."
31955 | 459 |             : "Status pobrany.";
31956 | 460 | 
31957 | 461 |     setHint(elEnvMsg, okMsg, true);
31958 | 462 | 
31959 | 463 |     if (which !== "status") await loadStatus();
31960 | 464 |   }
31961 | 465 | 
31962 | 466 |   async function clearCookies() {
31963 | 467 |     const ok = await showModal({
31964 | 468 |       title: "Wyczy≈õciƒá cookies?",
31965 | 469 |       body: `<div>To wymusi ponowne logowanie do Facebooka przy kolejnym uruchomieniu.</div>`,
31966 | 470 |       okText: "Wyczy≈õƒá",
31967 | 471 |       danger: true,
31968 | 472 |     });
31969 | 473 |     if (!ok) return;
31970 | 474 | 
31971 | 475 |     setHint(elEnvMsg, "Czyszczƒô cookies...", true);
31972 | 476 | 
31973 | 477 |     const r = await api("/api/cookies/clear", {
31974 | 478 |       method: "POST",
31975 | 479 |       body: { confirm: true },
31976 | 480 |     });
31977 | 481 | 
31978 | 482 |     if (!r.ok) {
31979 | 483 |       setHint(elEnvMsg, `Nie uda≈Ço siƒô wyczy≈õciƒá cookies (${r.error || "b≈ÇƒÖd"})`, false);
31980 | 484 |       return;
31981 | 485 |     }
31982 | 486 |     setHint(elEnvMsg, "Cookies wyczyszczone.", true);
31983 | 487 |   }
31984 | 488 | 
31985 | 489 |   // ---------- logs ----------
31986 | 490 |   function getLines() {
31987 | 491 |     const n = parseInt((elLogLines.value || "200").toString(), 10);
31988 | 492 |     if (!isFinite(n)) return 200;
31989 | 493 |     return Math.max(20, Math.min(2000, n));
31990 | 494 |   }
31991 | 495 | 
31992 | 496 |   async function loadLogs(mode) {
31993 | 497 |     lastLogMode = mode;
31994 | 498 |     const lines = getLines();
31995 | 499 |     setHint(elLogHint, `Wczytujƒô logi...`, true);
31996 | 500 | 
31997 | 501 |     const r = await api(`/api/logs/${mode}?lines=${lines}`);
31998 | 502 |     if (!r.ok) {
31999 | 503 |       elLogs.value = "";
32000 | 504 |       setHint(elLogHint, `Nie uda≈Ço siƒô wczytaƒá log√≥w (${r.error || "b≈ÇƒÖd"})`, false);
32001 | 505 |       return;
32002 | 506 |     }
32003 | 507 | 
32004 | 508 |     elLogs.value = (r.log || "").toString();
32005 | 509 |     setHint(elLogHint, `Wczytano: ${mode.toUpperCase()} ‚Ä¢ ${fmtTime()} ‚Ä¢ ${lines} linii`, true);
32006 | 510 | 
32007 | 511 |     if (elLogAutoScroll.checked) {
32008 | 512 |       elLogs.scrollTop = elLogs.scrollHeight;
32009 | 513 |     }
32010 | 514 |   }
32011 | 515 | 
32012 | 516 |   function stopAutoLogs() {
32013 | 517 |     if (logAutoTimer) {
32014 | 518 |       clearInterval(logAutoTimer);
32015 | 519 |       logAutoTimer = null;
32016 | 520 |     }
32017 | 521 |     btnLogAutoToggle.textContent = "Auto: WY≈Å";
32018 | 522 |     btnLogAutoToggle.classList.remove("primary");
32019 | 523 |   }
32020 | 524 | 
32021 | 525 |   function startAutoLogs() {
32022 | 526 |     const every = parseInt((elLogAutoEvery.value || "0").toString(), 10) || 0;
32023 | 527 |     if (every <= 0) {
32024 | 528 |       stopAutoLogs();
32025 | 529 |       return;
32026 | 530 |     }
32027 | 531 | 
32028 | 532 |     stopAutoLogs();
32029 | 533 |     btnLogAutoToggle.textContent = "Auto: W≈Å";
32030 | 534 |     btnLogAutoToggle.classList.add("primary");
32031 | 535 | 
32032 | 536 |     logAutoTimer = setInterval(() => {
32033 | 537 |       loadLogs(lastLogMode).catch(() => {});
32034 | 538 |     }, every);
32035 | 539 |   }
32036 | 540 | 
32037 | 541 |   function toggleLogsSize() {
32038 | 542 |     logsExpanded = !logsExpanded;
32039 | 543 |     logsCard.classList.toggle("logsExpanded", logsExpanded);
32040 | 544 |     btnToggleLogsSize.textContent = logsExpanded ? "Zwi≈Ñ" : "Rozwi≈Ñ";
32041 | 545 |   }
32042 | 546 | 
32043 | 547 |   // ---------- utils ----------
32044 | 548 |   async function copyToClipboard(text) {
32045 | 549 |     try {
32046 | 550 |       await navigator.clipboard.writeText(text);
32047 | 551 |       return true;
32048 | 552 |     } catch (e) {
32049 | 553 |       const ta = document.createElement("textarea");
32050 | 554 |       ta.value = text;
32051 | 555 |       ta.style.position = "fixed";
32052 | 556 |       ta.style.opacity = "0";
32053 | 557 |       document.body.appendChild(ta);
32054 | 558 |       ta.select();
32055 | 559 |       try {
32056 | 560 |         document.execCommand("copy");
32057 | 561 |         document.body.removeChild(ta);
32058 | 562 |         return true;
32059 | 563 |       } catch {
32060 | 564 |         document.body.removeChild(ta);
32061 | 565 |         return false;
32062 | 566 |       }
32063 | 567 |     }
32064 | 568 |   }
32065 | 569 | 
32066 | 570 |   function escapeHtml(s) {
32067 | 571 |     return String(s || "")
32068 | 572 |       .replaceAll("&", "&amp;")
32069 | 573 |       .replaceAll("<", "&lt;")
32070 | 574 |       .replaceAll(">", "&gt;")
32071 | 575 |       .replaceAll('"', "&quot;")
32072 | 576 |       .replaceAll("'", "&#039;");
32073 | 577 |   }
32074 | 578 | 
32075 | 579 |   // ---------- wire events ----------
32076 | 580 |   function wire() {
32077 | 581 |     elToken.value = token;
32078 | 582 | 
32079 | 583 |     btnSaveToken.addEventListener("click", async () => {
32080 | 584 |       token = (elToken.value || "").trim();
32081 | 585 |       localStorage.setItem("FBW_PANEL_TOKEN", token);
32082 | 586 |       await hardRefresh();
32083 | 587 |     });
32084 | 588 | 
32085 | 589 |     btnRefresh.addEventListener("click", async () => {
32086 | 590 |       await hardRefresh();
32087 | 591 |     });
32088 | 592 | 
32089 | 593 |     btnSaveEnv.addEventListener("click", async () => {
32090 | 594 |       await saveEnv(false);
32091 | 595 |     });
32092 | 596 | 
32093 | 597 |     btnPm2Start.addEventListener("click", async () => await pm2Call("start"));
32094 | 598 |     btnPm2Stop.addEventListener("click", async () => await pm2Call("stop"));
32095 | 599 |     btnPm2Restart.addEventListener("click", async () => await pm2Call("restart"));
32096 | 600 | 
32097 | 601 |     btnClearCookies.addEventListener("click", async () => await clearCookies());
32098 | 602 | 
32099 | 603 |     btnAddPost.addEventListener("click", async () => await addPost());
32100 | 604 | 
32101 | 605 |     btnLoadOut.addEventListener("click", async () => await loadLogs("out"));
32102 | 606 |     btnLoadErr.addEventListener("click", async () => await loadLogs("err"));
32103 | 607 | 
32104 | 608 |     btnLogAutoToggle.addEventListener("click", () => {
32105 | 609 |       if (logAutoTimer) stopAutoLogs();
32106 | 610 |       else startAutoLogs();
32107 | 611 |     });
32108 | 612 | 
32109 | 613 |     elLogAutoEvery.addEventListener("change", () => {
32110 | 614 |       if (logAutoTimer) startAutoLogs();
32111 | 615 |     });
32112 | 616 | 
32113 | 617 |     btnToggleLogsSize.addEventListener("click", () => toggleLogsSize());
32114 | 618 |   }
32115 | 619 | 
32116 | 620 |   async function hardRefresh() {
32117 | 621 |     await loadStatus();
32118 | 622 |     await loadEnv();
32119 | 623 |     await loadPosts();
32120 | 624 | 
32121 | 625 |     if (elLogs.value && elLogs.value.trim().length > 0) {
32122 | 626 |       await loadLogs(lastLogMode);
32123 | 627 |     }
32124 | 628 |   }
32125 | 629 | 
32126 | 630 |   // ---------- init ----------
32127 | 631 |   wire();
32128 | 632 |   hardRefresh().catch(() => {
32129 | 633 |     setHint(elStatus, "Nie uda≈Ço siƒô od≈õwie≈ºyƒá panelu (token / backend).", false);
32130 | 634 |   });
32131 | 635 | })();
32132 | 636 | 
32133 | ```
32134 | 
32135 | ---
32136 | 
32137 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/cache.js`
32138 | **Typ:** JavaScript/tekst  
32139 | **Opis:** Plik projektu (kod/konfiguracja).  
32140 | 
32141 | ```js
32142 |  1 | // src/db/cache.js
32143 |  2 | import fs from "fs";
32144 |  3 | import path from "path";
32145 |  4 | 
32146 |  5 | const FILE = "./data/comments-cache.json";
32147 |  6 | 
32148 |  7 | /**
32149 |  8 |  * Upewnia siƒô, ≈ºe istnieje katalog ./data
32150 |  9 |  */
32151 | 10 | function ensureDir() {
32152 | 11 |   const dir = path.dirname(FILE);
32153 | 12 |   if (!fs.existsSync(dir)) {
32154 | 13 |     fs.mkdirSync(dir, { recursive: true });
32155 | 14 |   }
32156 | 15 | }
32157 | 16 | 
32158 | 17 | export function loadCache() {
32159 | 18 |   try {
32160 | 19 |     ensureDir();
32161 | 20 |     if (!fs.existsSync(FILE)) return {};
32162 | 21 |     const raw = fs.readFileSync(FILE, "utf8");
32163 | 22 |     if (!raw.trim()) return {};
32164 | 23 |     return JSON.parse(raw);
32165 | 24 |   } catch (e) {
32166 | 25 |     console.error("[Cache] B≈ÇƒÖd ≈Çadowania:", e.message);
32167 | 26 |     return {};
32168 | 27 |   }
32169 | 28 | }
32170 | 29 | 
32171 | 30 | export function saveCache(cache) {
32172 | 31 |   try {
32173 | 32 |     ensureDir();
32174 | 33 |     fs.writeFileSync(FILE, JSON.stringify(cache, null, 2), "utf8");
32175 | 34 |   } catch (e) {
32176 | 35 |     console.error("[Cache] B≈ÇƒÖd zapisu:", e.message);
32177 | 36 |   }
32178 | 37 | }
32179 | 38 | 
32180 | ```
32181 | 
32182 | ---
32183 | 
32184 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments-cache.json`
32185 | **Typ:** JSON  
32186 | **Opis:** Plik projektu (kod/konfiguracja).  
32187 | 
32188 | ```json
32189 |    1 | {
32190 |    2 |   "https://facebook.com/link1": {
32191 |    3 |     "lastCount": 29,
32192 |    4 |     "knownIds": [
32193 |    5 |       "123",
32194 |    6 |       "456"
32195 |    7 |     ]
32196 |    8 |   },
32197 |    9 |   "https://facebook.com/link2": {
32198 |   10 |     "lastCount": 57,
32199 |   11 |     "knownIds": [
32200 |   12 |       "abc",
32201 |   13 |       "def"
32202 |   14 |     ]
32203 |   15 |   },
32204 |   16 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid079NeZjZknqqgvVLHDt5vpJgYqcX7UvssfEST6NiitVe3onh4qYokNA85DnZK1BhPl&id=100090694156429&__cft__[0]=AZWmzrfj9TrX5809IiholJ6RkBsezJVNuGQJNMH52aluQjQSwydq4YraJ8rlkQorKEpIh1N7abUBI-efeoMG2uMQfkzu1usqipQ_WKHQUVfq33KA6HpnZOuStLznHFvipBOGUQpnnjdL3oI5_4ZaCo6wXBYwnLzyiykZlimAEuBJsQ&__tn__=%2CO%2CP-R-R": {
32205 |   17 |     "lastCount": 104,
32206 |   18 |     "knownIds": [
32207 |   19 |       "1484858249285495",
32208 |   20 |       "813389271325163",
32209 |   21 |       "1554947679035357",
32210 |   22 |       "2064706784353621",
32211 |   23 |       "1400229968337586",
32212 |   24 |       "3146745832165404",
32213 |   25 |       "864901412623837",
32214 |   26 |       "1334534481217980",
32215 |   27 |       "1216871160254967",
32216 |   28 |       "835691398836304",
32217 |   29 |       "1765746040745680",
32218 |   30 |       "1484095092670708",
32219 |   31 |       "2142426246288280",
32220 |   32 |       "1354810826103677",
32221 |   33 |       "3231812590299517",
32222 |   34 |       "1787108076024772",
32223 |   35 |       "2037082873729847",
32224 |   36 |       "810095718578035",
32225 |   37 |       "1496580228290704",
32226 |   38 |       "1285300293282784",
32227 |   39 |       "885834407309298",
32228 |   40 |       "2010918516356987",
32229 |   41 |       "1145766607762431",
32230 |   42 |       "1384920606355138",
32231 |   43 |       "1099282025432920",
32232 |   44 |       "782259838102706",
32233 |   45 |       "1630651867913592",
32234 |   46 |       "1551288445886787",
32235 |   47 |       "1107523747914378",
32236 |   48 |       "1891179351488048",
32237 |   49 |       "837432745336470",
32238 |   50 |       "1306699774561125",
32239 |   51 |       "849083654308399",
32240 |   52 |       "1159662906331762",
32241 |   53 |       "1503740687509347",
32242 |   54 |       "1167731508198719",
32243 |   55 |       "631812859921567",
32244 |   56 |       "832530796255974",
32245 |   57 |       "25044316688560452",
32246 |   58 |       "1836420183740368",
32247 |   59 |       "1869539913655384",
32248 |   60 |       "1925478198312702",
32249 |   61 |       "790410607328297",
32250 |   62 |       "1499721354445851",
32251 |   63 |       "2215897285600409",
32252 |   64 |       "1785285768710210",
32253 |   65 |       "689438657224839",
32254 |   66 |       "814192041462836",
32255 |   67 |       "1339557404321088",
32256 |   68 |       "819227754057961",
32257 |   69 |       "853366920378300",
32258 |   70 |       "690043700835679",
32259 |   71 |       "1161513736091920",
32260 |   72 |       "1402865434541124",
32261 |   73 |       "1378640030285785",
32262 |   74 |       "4287827091539742",
32263 |   75 |       "2260484717754151",
32264 |   76 |       "4278060919181347",
32265 |   77 |       "1146617930935835",
32266 |   78 |       "2925190721008415",
32267 |   79 |       "3424769301006561",
32268 |   80 |       "1387548826218225",
32269 |   81 |       "1560722205371869",
32270 |   82 |       "2285358328556761",
32271 |   83 |       "1338022761205508",
32272 |   84 |       "1616803799202675",
32273 |   85 |       "1380319883472469",
32274 |   86 |       "25053704220950267",
32275 |   87 |       "699216616574439",
32276 |   88 |       "1200160261543254",
32277 |   89 |       "817272907772287",
32278 |   90 |       "1528135821848453",
32279 |   91 |       "813912798071240",
32280 |   92 |       "1514009586484637",
32281 |   93 |       "809421785317123",
32282 |   94 |       "1199323368711290",
32283 |   95 |       "1585261986244190",
32284 |   96 |       "636284516218701",
32285 |   97 |       "1493955611830762",
32286 |   98 |       "843308691393626",
32287 |   99 |       "672678829055747",
32288 |  100 |       "1491665861892549",
32289 |  101 |       "819224034469759",
32290 |  102 |       "1204107861783559",
32291 |  103 |       "2691413441208886",
32292 |  104 |       "1143829177957375",
32293 |  105 |       "2964604867059729",
32294 |  106 |       "1255315996355719",
32295 |  107 |       "735547182905880",
32296 |  108 |       "1186687466677656",
32297 |  109 |       "1227664472885150",
32298 |  110 |       "1504779077395595",
32299 |  111 |       "612236685246014",
32300 |  112 |       "4155440434772171",
32301 |  113 |       "887782953686064",
32302 |  114 |       "1192562142800829",
32303 |  115 |       "1566836271123858",
32304 |  116 |       "1334713168343936",
32305 |  117 |       "1597761001219562",
32306 |  118 |       "1348060153661921",
32307 |  119 |       "25228605600124856",
32308 |  120 |       "1108603637806170",
32309 |  121 |       "846070368354758",
32310 |  122 |       "2238614166617625"
32311 |  123 |     ]
32312 |  124 |   },
32313 |  125 |   "https://www.facebook.com/blachostal.nowoczesne.garaze/posts/pfbid035cuqZ8Ryx9RyGvXLtnLgmhpn1U6g7ATf7jPz5PCERqXVLAX1K4EcYWyCFtpV4eKdl?__cft__[0]=AZUpQP-0LIjNhIOd4-WavmmTf-1EIzmuVzXqt3rBbeemot7QoTS0K6WPNiYhYO7OJHC11Q6tzK7hCnE9m4Z7gi7TzO-7HKXXkLY_w9xlW_IeUL8OtBEabhmc0l6dtUX-Ymh3MbcoeBSVz_xpNu__MHueNjtJJiqVlW0XjtA_wZmFoA&__tn__=%2CO%2CP-R": {
32314 |  126 |     "lastCount": 57,
32315 |  127 |     "knownIds": [
32316 |  128 |       "837086052064961",
32317 |  129 |       "739384599166756",
32318 |  130 |       "1338324470611610",
32319 |  131 |       "1170589628261159",
32320 |  132 |       "1958112638098026",
32321 |  133 |       "835834932432887",
32322 |  134 |       "800492942752214",
32323 |  135 |       "1161016129562915",
32324 |  136 |       "1336721634828423",
32325 |  137 |       "865545639316414",
32326 |  138 |       "636140609435489",
32327 |  139 |       "1694692387894376",
32328 |  140 |       "1207837304699525",
32329 |  141 |       "877011254648738",
32330 |  142 |       "1915547985673759",
32331 |  143 |       "1769454663771678",
32332 |  144 |       "1379026987086490",
32333 |  145 |       "1317369222903353",
32334 |  146 |       "1158866746216284",
32335 |  147 |       "1186495090203276",
32336 |  148 |       "1879599489623012",
32337 |  149 |       "1970131387085863",
32338 |  150 |       "1365957888504043",
32339 |  151 |       "841299492182407",
32340 |  152 |       "2123442388479251",
32341 |  153 |       "1303547907750484",
32342 |  154 |       "1152933336198413",
32343 |  155 |       "757831063921521",
32344 |  156 |       "788077300493101",
32345 |  157 |       "1334471641547577",
32346 |  158 |       "818180254496310",
32347 |  159 |       "4030832773895572",
32348 |  160 |       "655115834137470",
32349 |  161 |       "1240686021150283",
32350 |  162 |       "1566836444424818",
32351 |  163 |       "1668416530798344",
32352 |  164 |       "2808509649339736",
32353 |  165 |       "2264210650659328",
32354 |  166 |       "1148371167275090",
32355 |  167 |       "1533245467824618",
32356 |  168 |       "1192562142800829",
32357 |  169 |       "1566836271123858",
32358 |  170 |       "1334713168343936",
32359 |  171 |       "1533084681472944",
32360 |  172 |       "3756537031316420",
32361 |  173 |       "1822548139145637",
32362 |  174 |       "808914925383512",
32363 |  175 |       "1133937601502415",
32364 |  176 |       "4108962026025143",
32365 |  177 |       "2230109340791092",
32366 |  178 |       "796845636852589",
32367 |  179 |       "1360812648547437",
32368 |  180 |       "779905761538818",
32369 |  181 |       "1103960681528297",
32370 |  182 |       "2228148440988296",
32371 |  183 |       "1100544302065673",
32372 |  184 |       "2238614166617625"
32373 |  185 |     ]
32374 |  186 |   },
32375 |  187 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid022BUAUcJmmCcnK3Q72F4CvKTJ1TN8EPWci4jeC7nFALZzMRVchreV4C4bUZ4x9e3bl&id=100064116006584": {
32376 |  188 |     "lastCount": 73,
32377 |  189 |     "knownIds": [
32378 |  190 |       "1749611885694430",
32379 |  191 |       "1330391901482980",
32380 |  192 |       "1148543403259376",
32381 |  193 |       "1174352560850592",
32382 |  194 |       "1464617361315828",
32383 |  195 |       "3673815659417730",
32384 |  196 |       "4132488383686483",
32385 |  197 |       "2535772406797096",
32386 |  198 |       "703942479431556",
32387 |  199 |       "2671866479814432",
32388 |  200 |       "2208707316297998",
32389 |  201 |       "1333529047893602",
32390 |  202 |       "1882383499328551",
32391 |  203 |       "3922670094622150",
32392 |  204 |       "1038495614892417",
32393 |  205 |       "1393258995787290",
32394 |  206 |       "808416805428093",
32395 |  207 |       "1841676156425478",
32396 |  208 |       "2627661040959901",
32397 |  209 |       "1318862856385985",
32398 |  210 |       "2454636844932679",
32399 |  211 |       "1125272642419471",
32400 |  212 |       "1154909593218875",
32401 |  213 |       "1324142002771144",
32402 |  214 |       "1893966948108194",
32403 |  215 |       "9662769650439208",
32404 |  216 |       "1123269052946986",
32405 |  217 |       "1164627985875534",
32406 |  218 |       "3088947611278670",
32407 |  219 |       "1389127985680999",
32408 |  220 |       "2757266117997737",
32409 |  221 |       "1833299830734373",
32410 |  222 |       "680500117659289",
32411 |  223 |       "641182325550151",
32412 |  224 |       "1033012642023795",
32413 |  225 |       "660078953387192",
32414 |  226 |       "1828985121209354",
32415 |  227 |       "703695865366600",
32416 |  228 |       "9952510204804510",
32417 |  229 |       "4016734478615313",
32418 |  230 |       "1696870044301105",
32419 |  231 |       "2129744274182064",
32420 |  232 |       "1658045408197468",
32421 |  233 |       "796346829484183",
32422 |  234 |       "1863978071017302",
32423 |  235 |       "1315407846218314",
32424 |  236 |       "1113102554327952",
32425 |  237 |       "1978854649620670",
32426 |  238 |       "1313416067452535",
32427 |  239 |       "1982134975861425",
32428 |  240 |       "1286011706903122",
32429 |  241 |       "1126742986296906",
32430 |  242 |       "999820972175816",
32431 |  243 |       "1150598243794985",
32432 |  244 |       "9432829300172607",
32433 |  245 |       "1174256631476979",
32434 |  246 |       "2039749086867789",
32435 |  247 |       "2706825462837018",
32436 |  248 |       "657118717418423",
32437 |  249 |       "9264119667046076",
32438 |  250 |       "1872924636990353",
32439 |  251 |       "1192562142800829",
32440 |  252 |       "1566836271123858",
32441 |  253 |       "1334713168343936",
32442 |  254 |       "1873518990225811",
32443 |  255 |       "834703568989661",
32444 |  256 |       "1891200018479913",
32445 |  257 |       "699194213204568",
32446 |  258 |       "694484656653829",
32447 |  259 |       "1545484699792456",
32448 |  260 |       "842516725028237",
32449 |  261 |       "2238614166617625",
32450 |  262 |       "1336694961258543"
32451 |  263 |     ]
32452 |  264 |   },
32453 |  265 |   "https://www.facebook.com/photo/?fbid=1261396812687012&set=a.629604755866224": {
32454 |  266 |     "lastCount": 171,
32455 |  267 |     "knownIds": [
32456 |  268 |       "2091351504939519",
32457 |  269 |       "1884747355812159",
32458 |  270 |       "1375814240653458",
32459 |  271 |       "1386466736342431",
32460 |  272 |       "2913525755520216",
32461 |  273 |       "914825275043397",
32462 |  274 |       "1192562142800829",
32463 |  275 |       "1182339083868514",
32464 |  276 |       "884682243989592",
32465 |  277 |       "878016028062528",
32466 |  278 |       "3990260714555932",
32467 |  279 |       "1395049695660201",
32468 |  280 |       "1400007592135635",
32469 |  281 |       "25383836781271270",
32470 |  282 |       "2464158020678682",
32471 |  283 |       "25380261558251901",
32472 |  284 |       "889910733363126",
32473 |  285 |       "1542448540123823",
32474 |  286 |       "1288191046408027",
32475 |  287 |       "828934086590504",
32476 |  288 |       "1559321618526036",
32477 |  289 |       "3338738306278939",
32478 |  290 |       "1401010148404114",
32479 |  291 |       "825179916952017",
32480 |  292 |       "1190699832394619",
32481 |  293 |       "835043512861815",
32482 |  294 |       "741030128390667",
32483 |  295 |       "3183933031793355",
32484 |  296 |       "2652169795120256",
32485 |  297 |       "829289853422315",
32486 |  298 |       "794397296986489",
32487 |  299 |       "1186035596331903",
32488 |  300 |       "872151695709683",
32489 |  301 |       "1168445255485970",
32490 |  302 |       "840748091906335",
32491 |  303 |       "1416435073160346",
32492 |  304 |       "1210178124339059",
32493 |  305 |       "868656982201643",
32494 |  306 |       "1161092656141133",
32495 |  307 |       "1557690708748766",
32496 |  308 |       "2321446244935364",
32497 |  309 |       "1293998722769377",
32498 |  310 |       "738828288661567",
32499 |  311 |       "862078689805684",
32500 |  312 |       "1345758703952318",
32501 |  313 |       "1752196685433084",
32502 |  314 |       "1384199336385255",
32503 |  315 |       "880252451247618",
32504 |  316 |       "887617090465269",
32505 |  317 |       "889586553580023",
32506 |  318 |       "881248257908478",
32507 |  319 |       "25184700861158963",
32508 |  320 |       "1788769208444222",
32509 |  321 |       "2023978775123360",
32510 |  322 |       "790072490734904",
32511 |  323 |       "1366031925320244",
32512 |  324 |       "2422165638242886",
32513 |  325 |       "1873234940224413",
32514 |  326 |       "1188813365965756",
32515 |  327 |       "1573818770516512",
32516 |  328 |       "1005206625155946",
32517 |  329 |       "1162845742665115",
32518 |  330 |       "1178746437126776",
32519 |  331 |       "1565070374622312",
32520 |  332 |       "1613790206669359",
32521 |  333 |       "835230942645797",
32522 |  334 |       "1411481383824753",
32523 |  335 |       "1537167007430654",
32524 |  336 |       "1769386407102433",
32525 |  337 |       "1387315283050136",
32526 |  338 |       "858534963666507",
32527 |  339 |       "857641136968017",
32528 |  340 |       "1755210908491116",
32529 |  341 |       "1419871056593296",
32530 |  342 |       "4298595940379216",
32531 |  343 |       "848905577516580",
32532 |  344 |       "2895125147350502",
32533 |  345 |       "1503806647551165",
32534 |  346 |       "885909654017036",
32535 |  347 |       "780452878339522",
32536 |  348 |       "1426932012381076",
32537 |  349 |       "892456339973962",
32538 |  350 |       "1184352506627848",
32539 |  351 |       "881319174424157",
32540 |  352 |       "1205273138185990",
32541 |  353 |       "827167420092033",
32542 |  354 |       "807497485649488",
32543 |  355 |       "2508198259576746",
32544 |  356 |       "853919757233092",
32545 |  357 |       "1904985440052869",
32546 |  358 |       "4277996195782352",
32547 |  359 |       "855114936990882",
32548 |  360 |       "864261956003488",
32549 |  361 |       "875432355170220",
32550 |  362 |       "711412321631856",
32551 |  363 |       "2356779018098813",
32552 |  364 |       "1512873466670468",
32553 |  365 |       "809319638773964",
32554 |  366 |       "1873157936893990",
32555 |  367 |       "24546345048373206",
32556 |  368 |       "836164595848285",
32557 |  369 |       "1193774995419478",
32558 |  370 |       "4065448630421517",
32559 |  371 |       "3347211812097106",
32560 |  372 |       "2711019595902901",
32561 |  373 |       "25288616604081912",
32562 |  374 |       "3488548011284811",
32563 |  375 |       "2115063869305678",
32564 |  376 |       "25195142240180496",
32565 |  377 |       "748066968322684",
32566 |  378 |       "1346616433378423",
32567 |  379 |       "876910218199240",
32568 |  380 |       "1206011641448351",
32569 |  381 |       "784442221315015",
32570 |  382 |       "1116285873732562",
32571 |  383 |       "1196575319097608",
32572 |  384 |       "786967771040505",
32573 |  385 |       "836897525861851",
32574 |  386 |       "1210808507640106",
32575 |  387 |       "1336882541077354",
32576 |  388 |       "1296651692501039",
32577 |  389 |       "874604001583153",
32578 |  390 |       "725090780157624",
32579 |  391 |       "1027324389551469",
32580 |  392 |       "854580610329547",
32581 |  393 |       "2179223112487256",
32582 |  394 |       "25112636721761691",
32583 |  395 |       "1213667170614746",
32584 |  396 |       "1246630423997635",
32585 |  397 |       "4288373401410200",
32586 |  398 |       "1176663654591895",
32587 |  399 |       "1856622578557519",
32588 |  400 |       "662447050281327",
32589 |  401 |       "1916944149172020",
32590 |  402 |       "2099479680800232",
32591 |  403 |       "4319827551671876",
32592 |  404 |       "1131714269154246",
32593 |  405 |       "2081759715929691",
32594 |  406 |       "848609507928587",
32595 |  407 |       "1161996186127820",
32596 |  408 |       "1376111390773710",
32597 |  409 |       "3907427189550696",
32598 |  410 |       "1206314870843698",
32599 |  411 |       "1486343152426071",
32600 |  412 |       "1235908888378023",
32601 |  413 |       "1597671841430090",
32602 |  414 |       "896662692816720",
32603 |  415 |       "25182931644709006",
32604 |  416 |       "805856392445115",
32605 |  417 |       "1535435530837453",
32606 |  418 |       "1555316578849891",
32607 |  419 |       "874602815531394",
32608 |  420 |       "1180837327489586",
32609 |  421 |       "4243395015986914",
32610 |  422 |       "2016617425849497",
32611 |  423 |       "842162171860315",
32612 |  424 |       "1398656838277110",
32613 |  425 |       "849696054094330",
32614 |  426 |       "1566836271123858",
32615 |  427 |       "1334713168343936",
32616 |  428 |       "1893305694607056",
32617 |  429 |       "1379851033923470",
32618 |  430 |       "869806365490831",
32619 |  431 |       "25246629424946112",
32620 |  432 |       "1778244582865308",
32621 |  433 |       "1221952383139083",
32622 |  434 |       "1383300383497013",
32623 |  435 |       "1378487037020809",
32624 |  436 |       "1180772130245894"
32625 |  437 |     ]
32626 |  438 |   },
32627 |  439 |   "https://www.facebook.com/watch?v=1546039723188424": {
32628 |  440 |     "lastCount": 667,
32629 |  441 |     "knownIds": [
32630 |  442 |       "1034829085496923",
32631 |  443 |       "873279545368406",
32632 |  444 |       "1157937886525659",
32633 |  445 |       "1217102703640704",
32634 |  446 |       "676074752102804",
32635 |  447 |       "1850621605626373",
32636 |  448 |       "814757514891721",
32637 |  449 |       "2690947364599539",
32638 |  450 |       "866218982562606",
32639 |  451 |       "797586103275496",
32640 |  452 |       "1200108822074875",
32641 |  453 |       "739892525798237",
32642 |  454 |       "1528177094970396",
32643 |  455 |       "3136486936525783",
32644 |  456 |       "3384251621723953",
32645 |  457 |       "1351140720045390",
32646 |  458 |       "847775191230725",
32647 |  459 |       "1391665129291704",
32648 |  460 |       "1147976430739464",
32649 |  461 |       "1370610761211656",
32650 |  462 |       "1536916187346419",
32651 |  463 |       "1338022657618581",
32652 |  464 |       "835227862814169",
32653 |  465 |       "2789288267945650",
32654 |  466 |       "1356734035908376",
32655 |  467 |       "3530644377074573",
32656 |  468 |       "1817009098951314",
32657 |  469 |       "1274075071163081",
32658 |  470 |       "815875647943360",
32659 |  471 |       "1387337559498686",
32660 |  472 |       "2079040016247175",
32661 |  473 |       "1980037552540559",
32662 |  474 |       "1554283373382984",
32663 |  475 |       "1483655376039555",
32664 |  476 |       "1437302024626602",
32665 |  477 |       "1989797221592305",
32666 |  478 |       "1400768578154773",
32667 |  479 |       "3188707454634158",
32668 |  480 |       "4318381861735402",
32669 |  481 |       "1229234325739478",
32670 |  482 |       "820324120869151",
32671 |  483 |       "858682013561724",
32672 |  484 |       "1410167497120999",
32673 |  485 |       "2031332694319611",
32674 |  486 |       "1854370808519239",
32675 |  487 |       "1381435747018306",
32676 |  488 |       "1216217753742556",
32677 |  489 |       "1350047526313914",
32678 |  490 |       "902801388745893",
32679 |  491 |       "1932403151033451",
32680 |  492 |       "1414307940113741",
32681 |  493 |       "1542514287026670",
32682 |  494 |       "1587036489390772",
32683 |  495 |       "1798918124121190",
32684 |  496 |       "1572615540843915",
32685 |  497 |       "1279578837262812",
32686 |  498 |       "2104194069984523",
32687 |  499 |       "840156885326687",
32688 |  500 |       "1353472306279850",
32689 |  501 |       "1414407773447758",
32690 |  502 |       "834222002828895",
32691 |  503 |       "1359696375151200",
32692 |  504 |       "32562186280096617",
32693 |  505 |       "874871655430503",
32694 |  506 |       "876677201463749",
32695 |  507 |       "1176938817433772",
32696 |  508 |       "2319594431887963",
32697 |  509 |       "1150705436843993",
32698 |  510 |       "1359028538929393",
32699 |  511 |       "842046068695533",
32700 |  512 |       "1512987039956409",
32701 |  513 |       "1192562142800829",
32702 |  514 |       "1566836271123858",
32703 |  515 |       "1334713168343936",
32704 |  516 |       "1815331212473698",
32705 |  517 |       "1639103264165336",
32706 |  518 |       "2027206161403312",
32707 |  519 |       "1175923591297419",
32708 |  520 |       "2331178203988335",
32709 |  521 |       "732165593268210",
32710 |  522 |       "1606395597391252",
32711 |  523 |       "1378487037020809",
32712 |  524 |       "1180772130245894",
32713 |  525 |       "3538623532959776",
32714 |  526 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3MzI3OTU0NTM2ODQwNg==",
32715 |  527 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEwMzQ4MjkwODU0OTY5MjM=",
32716 |  528 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNTc5Mzc4ODY1MjU2NTk=",
32717 |  529 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzI3ODkyODgyNjc5NDU2NTA=",
32718 |  530 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgxNTg3NTY0Nzk0MzM2MA==",
32719 |  531 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE5ODAwMzc1NTI1NDA1NTk=",
32720 |  532 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTAxNjc0OTcxMjA5OTk=",
32721 |  533 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwNzkwNDAwMTYyNDcxNzU=",
32722 |  534 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg1ODY4MjAxMzU2MTcyNA==",
32723 |  535 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTQzMDc5NDAxMTM3NDE=",
32724 |  536 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMjkyMzQzMjU3Mzk0Nzg=",
32725 |  537 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzcyNTkyMDMxNjczNzkzNA==",
32726 |  538 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMTYyMTc3NTM3NDI1NTY=",
32727 |  539 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgzNzUyNTcwNTcwMDM0OQ==",
32728 |  540 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1NDI1MTQyODcwMjY2NzA=",
32729 |  541 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIxMDQxOTQwNjk5ODQ1MjM=",
32730 |  542 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyNzk1Nzg4MzcyNjI4MTI=",
32731 |  543 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgzNDIyMjAwMjgyODg5NQ==",
32732 |  544 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTM0NzIzMDYyNzk4NTA=",
32733 |  545 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTk2OTYzNzUxNTEyMDA=",
32734 |  546 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE0MTQ0MDc3NzM0NDc3NTg=",
32735 |  547 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0MDE1Njg4NTMyNjY4Nw==",
32736 |  548 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMyNTYyMTg2MjgwMDk2NjE3",
32737 |  549 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3NDg3MTY1NTQzMDUwMw==",
32738 |  550 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNzY5Mzg4MTc0MzM3NzI=",
32739 |  551 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNTA3MDU0MzY4NDM5OTM=",
32740 |  552 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTkwMjg1Mzg5MjkzOTM=",
32741 |  553 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzM1Mzg2MjM1MzI5NTk3NzY=",
32742 |  554 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE2MzkxMDMyNjQxNjUzMzY=",
32743 |  555 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMyOTE0MTE3NzMxNTY2Nzg4",
32744 |  556 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzExNzU5MjM1OTEyOTc0MTk=",
32745 |  557 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1MjgxNzcwOTQ5NzAzOTY=",
32746 |  558 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1NzI2MTU1NDA4NDM5MTU=",
32747 |  559 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE2MDYzOTU1OTczOTEyNTI=",
32748 |  560 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE3OTg5MTgxMjQxMjExOTA=",
32749 |  561 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1ODcwMzY0ODkzOTA3NzI=",
32750 |  562 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIzMTk1OTQ0MzE4ODc5NjM=",
32751 |  563 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzODczMzc1NTk0OTg2ODY=",
32752 |  564 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE5NTY5MzgyMjQ4NjQ4NDA=",
32753 |  565 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg3NjY3NzIwMTQ2Mzc0OQ==",
32754 |  566 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwMjcyMDYxNjE0MDMzMTI=",
32755 |  567 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMTcxMDI3MDM2NDA3MDQ=",
32756 |  568 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE4NTA2MjE2MDU2MjYzNzM=",
32757 |  569 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgxNDc1NzUxNDg5MTcyMQ==",
32758 |  570 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzc5NzU4NjEwMzI3NTQ5Ng==",
32759 |  571 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyMDAxMDg4MjIwNzQ4NzU=",
32760 |  572 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzczOTg5MjUyNTc5ODIzNw==",
32761 |  573 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzczMjE2NTU5MzI2ODIxMA==",
32762 |  574 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzMxMzY0ODY5MzY1MjU3ODM=",
32763 |  575 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0Nzc3NTE5MTIzMDcyNQ==",
32764 |  576 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzOTE2NjUxMjkyOTE3MDQ=",
32765 |  577 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTY3MzQwMzU5MDgzNzY=",
32766 |  578 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzM1MzA2NDQzNzcwNzQ1NzM=",
32767 |  579 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE4MTcwMDkwOTg5NTEzMTQ=",
32768 |  580 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEyNzQwNzUwNzExNjMwODE=",
32769 |  581 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzIwMzEzMzI2OTQzMTk2MTE=",
32770 |  582 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzgyMDMyNDEyMDg2OTE1MQ==",
32771 |  583 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzEzNTAwNDc1MjYzMTM5MTQ=",
32772 |  584 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0Xzg0MjA0NjA2ODY5NTUzMw==",
32773 |  585 |       "Y29tbWVudDoxMjkzNTI1NDIyODEyMDQ0XzE1OTY4MDU0MTE1MDYwNTA="
32774 |  586 |     ]
32775 |  587 |   },
32776 |  588 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02JxENQPAgXLfvSfdPzPRhgDmj1zqRFG2PGgCzduiY5LYZjkseBLWvuhDpt34DerN5l&id=61584520760919&__cft__[0]=AZXJAJKSlXAiajIjlB-6ckGQ63AZIss4k7yPNV5xlLRfJeEBt2jRUUAfnoxqPfHyR0N4CIbHCZ50-sHRWaH3XVpJlN5UqJBZA3SeMhDOdmQoTWGQgVoxiZRwOAuovy_VPVw0d006Qr8Iy_0GBJLmVnL5&__tn__=%2CO%2CP-R": {
32777 |  589 |     "lastCount": 72,
32778 |  590 |     "knownIds": [
32779 |  591 |       "1387048646140084",
32780 |  592 |       "4029936247259749",
32781 |  593 |       "2660328750978691",
32782 |  594 |       "1334713168343936",
32783 |  595 |       "1308776751017890",
32784 |  596 |       "860633059666540",
32785 |  597 |       "1162914796039786",
32786 |  598 |       "707446865381225",
32787 |  599 |       "1332922231472322",
32788 |  600 |       "32631282399850242",
32789 |  601 |       "1659956864728691",
32790 |  602 |       "2009452379840879",
32791 |  603 |       "1397998685092575",
32792 |  604 |       "731542136047939",
32793 |  605 |       "2195100867683396",
32794 |  606 |       "1352140803044491",
32795 |  607 |       "1582048652803221",
32796 |  608 |       "3213235995511395",
32797 |  609 |       "713851081769506",
32798 |  610 |       "1751614108794244",
32799 |  611 |       "1455003568933656",
32800 |  612 |       "954678057719951",
32801 |  613 |       "4265160300476831",
32802 |  614 |       "863798326084470",
32803 |  615 |       "1368214498653334",
32804 |  616 |       "2271294380058475",
32805 |  617 |       "1914780959411823",
32806 |  618 |       "4342023332710628",
32807 |  619 |       "25610648951903072",
32808 |  620 |       "1961217241125600",
32809 |  621 |       "2059570238136530",
32810 |  622 |       "1359374301769672",
32811 |  623 |       "1386298086274612",
32812 |  624 |       "1187415322720164",
32813 |  625 |       "1195488835863790",
32814 |  626 |       "843794491735616",
32815 |  627 |       "708983228922331",
32816 |  628 |       "1020099650299656",
32817 |  629 |       "1309353301236675",
32818 |  630 |       "1375348427384280",
32819 |  631 |       "1837383113815193",
32820 |  632 |       "1861441061169345",
32821 |  633 |       "1523263618748823",
32822 |  634 |       "836093312396374",
32823 |  635 |       "834220359478702",
32824 |  636 |       "1545544119923126",
32825 |  637 |       "1556567885685420",
32826 |  638 |       "1343080830898918",
32827 |  639 |       "1103236938390764",
32828 |  640 |       "859649783143680",
32829 |  641 |       "1499835097914532",
32830 |  642 |       "727778929827248",
32831 |  643 |       "2366730120438641",
32832 |  644 |       "1931144420799614",
32833 |  645 |       "856913427204800",
32834 |  646 |       "1190384626410068",
32835 |  647 |       "817196824521583",
32836 |  648 |       "3895894027369306",
32837 |  649 |       "25370985949201334",
32838 |  650 |       "4283846458525963",
32839 |  651 |       "3226169730892248",
32840 |  652 |       "1804234623581441",
32841 |  653 |       "1565106078066742",
32842 |  654 |       "1566836271123858",
32843 |  655 |       "1378487037020809",
32844 |  656 |       "1180772130245894",
32845 |  657 |       "1220933543289726",
32846 |  658 |       "695065753431906",
32847 |  659 |       "2410182332773265",
32848 |  660 |       "1224551999488388",
32849 |  661 |       "1399917991714636",
32850 |  662 |       "1432091554999171"
32851 |  663 |     ]
32852 |  664 |   },
32853 |  665 |   "https://www.facebook.com/photo/?fbid=122094212247150692&set=a.122094201615150692": {
32854 |  666 |     "lastCount": 59,
32855 |  667 |     "knownIds": [
32856 |  668 |       "1169334382002952",
32857 |  669 |       "863106073038155",
32858 |  670 |       "1566375511189660",
32859 |  671 |       "2037974683629442",
32860 |  672 |       "1542866486933334",
32861 |  673 |       "1665264284450867",
32862 |  674 |       "711382065374373",
32863 |  675 |       "1467630091745966",
32864 |  676 |       "3122601214616860",
32865 |  677 |       "812865358241500",
32866 |  678 |       "2139753380172429",
32867 |  679 |       "846184221228551",
32868 |  680 |       "4106518426267211",
32869 |  681 |       "1624997921820642",
32870 |  682 |       "1984837538742860",
32871 |  683 |       "885251587616725",
32872 |  684 |       "1571528797174773",
32873 |  685 |       "33078682511745755",
32874 |  686 |       "2991949180990526",
32875 |  687 |       "879570997756128",
32876 |  688 |       "1202215825092490",
32877 |  689 |       "658039723942725",
32878 |  690 |       "1180772130245894",
32879 |  691 |       "1641872540127188",
32880 |  692 |       "774470002313371",
32881 |  693 |       "846169851470673",
32882 |  694 |       "2222423831587657",
32883 |  695 |       "823002400530889",
32884 |  696 |       "1220388709956707",
32885 |  697 |       "4051903231728363",
32886 |  698 |       "1903855931014636",
32887 |  699 |       "2081042142667648",
32888 |  700 |       "1364286302043929",
32889 |  701 |       "4346243682326124",
32890 |  702 |       "1219553130030174",
32891 |  703 |       "2558857481162263",
32892 |  704 |       "1966354757557104",
32893 |  705 |       "1031025025853926",
32894 |  706 |       "744866855291492",
32895 |  707 |       "1353775642401360",
32896 |  708 |       "874640861779581",
32897 |  709 |       "844895071281433",
32898 |  710 |       "2818259021703353",
32899 |  711 |       "887072213991851",
32900 |  712 |       "715618478251297",
32901 |  713 |       "1027959339511906",
32902 |  714 |       "1399917991714636",
32903 |  715 |       "1432091554999171",
32904 |  716 |       "25296652460004948",
32905 |  717 |       "1378487037020809",
32906 |  718 |       "674278005622004",
32907 |  719 |       "1364869044560158",
32908 |  720 |       "786209294477791",
32909 |  721 |       "1893315601272988",
32910 |  722 |       "2005747403318365",
32911 |  723 |       "1220933543289726",
32912 |  724 |       "710638258395186",
32913 |  725 |       "771571385942297",
32914 |  726 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTE2OTMzNDM4MjAwMjk1Mg==",
32915 |  727 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzExMzgyMDY1Mzc0Mzcz",
32916 |  728 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODEyODY1MzU4MjQxNTAw",
32917 |  729 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjEzOTc1MzM4MDE3MjQyOQ==",
32918 |  730 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ2MTg0MjIxMjI4NTUx",
32919 |  731 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDEwNjUxODQyNjI2NzIxMQ==",
32920 |  732 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTYyNDk5NzkyMTgyMDY0Mg==",
32921 |  733 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTk4NDgzNzUzODc0Mjg2MA==",
32922 |  734 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODg1MjUxNTg3NjE2NzI1",
32923 |  735 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU3MTUyODc5NzE3NDc3Mw==",
32924 |  736 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMzMwNzg2ODI1MTE3NDU3NTU=",
32925 |  737 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjk5MTk0OTE4MDk5MDUyNg==",
32926 |  738 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODc5NTcwOTk3NzU2MTI4",
32927 |  739 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzg2MjA5Mjk0NDc3Nzkx",
32928 |  740 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIwMjIxNTgyNTA5MjQ5MA==",
32929 |  741 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNjU4MDM5NzIzOTQyNzI1",
32930 |  742 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTE4MDc3MjEzMDI0NTg5NA==",
32931 |  743 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTY0MTg3MjU0MDEyNzE4OA==",
32932 |  744 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzc0NDcwMDAyMzEzMzcx",
32933 |  745 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ2MTY5ODUxNDcwNjcz",
32934 |  746 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjIyMjQyMzgzMTU4NzY1Nw==",
32935 |  747 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODIzMDAyNDAwNTMwODg5",
32936 |  748 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIyMDM4ODcwOTk1NjcwNw==",
32937 |  749 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDA1MTkwMzIzMTcyODM2Mw==",
32938 |  750 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTkwMzg1NTkzMTAxNDYzNg==",
32939 |  751 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA4MTA0MjE0MjY2NzY0OA==",
32940 |  752 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM2NDI4NjMwMjA0MzkyOQ==",
32941 |  753 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNDM0NjI0MzY4MjMyNjEyNA==",
32942 |  754 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIxOTU1MzEzMDAzMDE3NA==",
32943 |  755 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjU1ODg1NzQ4MTE2MjI2Mw==",
32944 |  756 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTk2NjM1NDc1NzU1NzEwNA==",
32945 |  757 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTAzMTAyNTAyNTg1MzkyNg==",
32946 |  758 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzQ0ODY2ODU1MjkxNDky",
32947 |  759 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM1Mzc3NTY0MjQwMTM2MA==",
32948 |  760 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODc0NjQwODYxNzc5NTgx",
32949 |  761 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODQ0ODk1MDcxMjgxNDMz",
32950 |  762 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjgxODI1OTAyMTcwMzM1Mw==",
32951 |  763 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODg3MDcyMjEzOTkxODUx",
32952 |  764 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzE1NjE4NDc4MjUxMjk3",
32953 |  765 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTAyNzk1OTMzOTUxMTkwNg==",
32954 |  766 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM5OTkxNzk5MTcxNDYzNg==",
32955 |  767 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTQzMjA5MTU1NDk5OTE3MQ==",
32956 |  768 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjUyOTY2NTI0NjAwMDQ5NDg=",
32957 |  769 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM3ODQ4NzAzNzAyMDgwOQ==",
32958 |  770 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNjc0Mjc4MDA1NjIyMDA0",
32959 |  771 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTM2NDg2OTA0NDU2MDE1OA==",
32960 |  772 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzEwNjM4MjU4Mzk1MTg2",
32961 |  773 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfNzcxNTcxMzg1OTQyMjk3",
32962 |  774 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODYyNDQ1NTQyOTkzNTQ1",
32963 |  775 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjI0NzcxNzg2ODk4ODg3MA==",
32964 |  776 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfODYzMTA2MDczMDM4MTU1",
32965 |  777 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU2NjM3NTUxMTE4OTY2MA==",
32966 |  778 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjAzNzk3NDY4MzYyOTQ0Mg==",
32967 |  779 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTU0Mjg2NjQ4NjkzMzMzNA==",
32968 |  780 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTY2NTI2NDI4NDQ1MDg2Nw==",
32969 |  781 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTQ2NzYzMDA5MTc0NTk2Ng==",
32970 |  782 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMzEyMjYwMTIxNDYxNjg2MA==",
32971 |  783 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
32972 |  784 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA1MzUxNzM2MjExNDE1Mw=="
32973 |  785 |     ]
32974 |  786 |   },
32975 |  787 |   "https://www.facebook.com/watch?v=1747017129293695": {
32976 |  788 |     "lastCount": 47,
32977 |  789 |     "knownIds": [
32978 |  790 |       "1418703679590774",
32979 |  791 |       "1241367197833798",
32980 |  792 |       "1309276017905401",
32981 |  793 |       "25793567626914911",
32982 |  794 |       "724928260680561",
32983 |  795 |       "1096804382383041",
32984 |  796 |       "25202925069357291",
32985 |  797 |       "841785541563927",
32986 |  798 |       "867017875854415",
32987 |  799 |       "854931910451517",
32988 |  800 |       "684653267842600",
32989 |  801 |       "831670253122745",
32990 |  802 |       "1368632978005981",
32991 |  803 |       "860225270291994",
32992 |  804 |       "4263223717254760",
32993 |  805 |       "1166898958452725",
32994 |  806 |       "727407229861963",
32995 |  807 |       "1374879277637474",
32996 |  808 |       "1178997877656809",
32997 |  809 |       "1901642503725329",
32998 |  810 |       "827290810101566",
32999 |  811 |       "1185991473630041",
33000 |  812 |       "853482857087660",
33001 |  813 |       "1481115546516836",
33002 |  814 |       "1382703660048206",
33003 |  815 |       "834576799283137",
33004 |  816 |       "2596555094062101",
33005 |  817 |       "816880584589546",
33006 |  818 |       "1903241780592717",
33007 |  819 |       "878506131377275",
33008 |  820 |       "1273023674590635",
33009 |  821 |       "2300220227070942",
33010 |  822 |       "720324560662891",
33011 |  823 |       "1933859273839066",
33012 |  824 |       "834537405631346",
33013 |  825 |       "1284526736694577",
33014 |  826 |       "1897678497773700",
33015 |  827 |       "1364869044560158",
33016 |  828 |       "1180772130245894",
33017 |  829 |       "3122601214616860",
33018 |  830 |       "1467768004333384",
33019 |  831 |       "753075217807130",
33020 |  832 |       "1596784824815673",
33021 |  833 |       "1122239806390192",
33022 |  834 |       "1109640851017363",
33023 |  835 |       "2688908578229084",
33024 |  836 |       "1360530128869154"
33025 |  837 |     ]
33026 |  838 |   },
33027 |  839 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02kXCMp7deNZJTc7JidwqGsjwY2dS3mWwAU83LYBJyrSDtjh45QxaQVh6aEEJE5VjXl&id=100091331246314&__cft__[0]=AZUjZ-UzQbZGoBWF7hBt_usoibO4vkZvwqOU5CUPhYQ61TIrpq3Riv_KlOiY9QUvNCOuHUSaHak6qTWzZJr7JD_yfUWHDyPruKP-tUhQAgisHc2EDlpm8qPGFP6UBGV7SV7uuFe63QeaRvjtPZIqXnJ3OniAICMNa__SEkZpj6ZPLg&__tn__=%2CO%2CP-R-R": {
33028 |  840 |     "lastCount": 38,
33029 |  841 |     "knownIds": [
33030 |  842 |       "4612275575768952",
33031 |  843 |       "863490763296586",
33032 |  844 |       "1360338219212140",
33033 |  845 |       "1338968061297670",
33034 |  846 |       "1154900446816263",
33035 |  847 |       "1117194126968745",
33036 |  848 |       "727101979916496",
33037 |  849 |       "1470304077365038",
33038 |  850 |       "608200102356103",
33039 |  851 |       "746670951803384",
33040 |  852 |       "1714850583235964",
33041 |  853 |       "1843296863226977",
33042 |  854 |       "4073829472880410",
33043 |  855 |       "1159712666288389",
33044 |  856 |       "1644632413610052",
33045 |  857 |       "858309986590509",
33046 |  858 |       "1366045154884211",
33047 |  859 |       "1340624584210280",
33048 |  860 |       "1145536310893602",
33049 |  861 |       "4394012717590835",
33050 |  862 |       "2113096706180083",
33051 |  863 |       "2657786187890234",
33052 |  864 |       "1414087970316708",
33053 |  865 |       "1214583947385185",
33054 |  866 |       "1479995833058699",
33055 |  867 |       "25133525979631543",
33056 |  868 |       "1613143033185067",
33057 |  869 |       "1189145460014871",
33058 |  870 |       "1139075151759139",
33059 |  871 |       "823333920486786",
33060 |  872 |       "24925046737116211",
33061 |  873 |       "2582213132132102",
33062 |  874 |       "837202788892444",
33063 |  875 |       "842359905054242",
33064 |  876 |       "1518657456053815",
33065 |  877 |       "1361048705561471",
33066 |  878 |       "1396138751967453",
33067 |  879 |       "2722027871485275",
33068 |  880 |       "1475148573596866",
33069 |  881 |       "1174977574073678",
33070 |  882 |       "2114940926003258",
33071 |  883 |       "1277131887792553",
33072 |  884 |       "765602586485873",
33073 |  885 |       "1373502007518092",
33074 |  886 |       "1506882210374158",
33075 |  887 |       "871892968745045",
33076 |  888 |       "1413690186852109",
33077 |  889 |       "696162543569582",
33078 |  890 |       "2045630056205678",
33079 |  891 |       "872717195152262",
33080 |  892 |       "843443721502601",
33081 |  893 |       "1157107909873874",
33082 |  894 |       "1496140238155905",
33083 |  895 |       "1489153539052385",
33084 |  896 |       "836062149391615",
33085 |  897 |       "871363288913690",
33086 |  898 |       "1388050096309972",
33087 |  899 |       "1084941183587751",
33088 |  900 |       "2316732332172277",
33089 |  901 |       "2014873149277102",
33090 |  902 |       "1641072606872503",
33091 |  903 |       "1576485500012904",
33092 |  904 |       "768049532957370",
33093 |  905 |       "1163915825906950",
33094 |  906 |       "25705749892425137",
33095 |  907 |       "1357776346134991",
33096 |  908 |       "1155290522946127",
33097 |  909 |       "1180715860351971",
33098 |  910 |       "1836243433744983",
33099 |  911 |       "1492639025296126",
33100 |  912 |       "2387222021696823",
33101 |  913 |       "1807553916565736",
33102 |  914 |       "868979565671714",
33103 |  915 |       "25849881801270432",
33104 |  916 |       "1730002768404124",
33105 |  917 |       "1221666770021346",
33106 |  918 |       "1353115676540006",
33107 |  919 |       "1761857647829506",
33108 |  920 |       "1936095640453930",
33109 |  921 |       "1486910209043353",
33110 |  922 |       "1682057306101909",
33111 |  923 |       "1417475586467162",
33112 |  924 |       "710626598495722",
33113 |  925 |       "1394665231995802",
33114 |  926 |       "752814524512853",
33115 |  927 |       "1984043662156010",
33116 |  928 |       "838851478954595",
33117 |  929 |       "838951908846312",
33118 |  930 |       "2163263157413358",
33119 |  931 |       "1358562942659258",
33120 |  932 |       "1701108984197674",
33121 |  933 |       "1957062724870577",
33122 |  934 |       "1383920783513739",
33123 |  935 |       "1372656587867854",
33124 |  936 |       "1179050510995713",
33125 |  937 |       "1209173161068840",
33126 |  938 |       "1191801159197515",
33127 |  939 |       "869826455729920",
33128 |  940 |       "700819386010250",
33129 |  941 |       "1336100817711136",
33130 |  942 |       "1961843504547442",
33131 |  943 |       "841223478619468",
33132 |  944 |       "845052431266562",
33133 |  945 |       "1252631383556573",
33134 |  946 |       "878629608161627",
33135 |  947 |       "824320927176060",
33136 |  948 |       "811323951907371",
33137 |  949 |       "866017626046573",
33138 |  950 |       "1745796472785148",
33139 |  951 |       "1573999687287614",
33140 |  952 |       "709749508447354",
33141 |  953 |       "696525893535421",
33142 |  954 |       "891821463373037",
33143 |  955 |       "774173708988258",
33144 |  956 |       "1192379798889692",
33145 |  957 |       "869432538984678",
33146 |  958 |       "1492893031795206",
33147 |  959 |       "25099761356357709",
33148 |  960 |       "844860108267167",
33149 |  961 |       "1195219262554251",
33150 |  962 |       "2135715656959834",
33151 |  963 |       "1223232519729073",
33152 |  964 |       "1355414616123145",
33153 |  965 |       "816970137909621",
33154 |  966 |       "846627378287079"
33155 |  967 |     ]
33156 |  968 |   },
33157 |  969 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid063V3tEVCLYTLCN14sfxE3mRT6HYbF4bNJbC5eUZwseJJ5FUiNZWT3mTdDSAFerZhl&id=61584544438252&comment_id=1419086153162158&__cft__[0]=AZWm3oo-dN99-UYzeKtjkEHgHjYIX4YW4JnFChW_Cx6F4TB37u6rNrYAbBU51fDQjj7d_yXuelDLQiJheVhWvnjPhMulL_3J1sStEw1nqPN3c1OU6iIK4s61-wUWnAtzSLU&__tn__=R]-R": {
33158 |  970 |     "lastCount": 32,
33159 |  971 |     "knownIds": []
33160 |  972 |   },
33161 |  973 |   "https://www.facebook.com/BomstalPL/videos/783071247466062/": {
33162 |  974 |     "lastCount": 132,
33163 |  975 |     "knownIds": [
33164 |  976 |       "1893315601272988",
33165 |  977 |       "2247717868988870",
33166 |  978 |       "2005747403318365",
33167 |  979 |       "1220933543289726",
33168 |  980 |       "719374621195615",
33169 |  981 |       "1544018156624974",
33170 |  982 |       "4247878415527757",
33171 |  983 |       "1640251893631368",
33172 |  984 |       "2806506346354734",
33173 |  985 |       "1052807816952086",
33174 |  986 |       "25430006279927262",
33175 |  987 |       "1141697814572107",
33176 |  988 |       "811134138442597",
33177 |  989 |       "1726544788013486",
33178 |  990 |       "840550231766865",
33179 |  991 |       "623478780718696",
33180 |  992 |       "2427128127688980",
33181 |  993 |       "4128477230631067",
33182 |  994 |       "1834795843805713",
33183 |  995 |       "822504117141851",
33184 |  996 |       "1339450881003183",
33185 |  997 |       "1647835896599979",
33186 |  998 |       "776708588494114",
33187 |  999 |       "1049915130480912",
33188 | 1000 |       "1558482942267271",
33189 | 1001 |       "1384867746306333",
33190 | 1002 |       "1165286899073108",
33191 | 1003 |       "1759929938028561",
33192 | 1004 |       "4252577001685395",
33193 | 1005 |       "1972171566914165",
33194 | 1006 |       "3961083067477147",
33195 | 1007 |       "1113379921005263",
33196 | 1008 |       "1000928565457626",
33197 | 1009 |       "3839818619654976",
33198 | 1010 |       "1506631200474272",
33199 | 1011 |       "1139427624830680",
33200 | 1012 |       "24546220008407533",
33201 | 1013 |       "25831638156439916",
33202 | 1014 |       "1366891205003574",
33203 | 1015 |       "708395945028827",
33204 | 1016 |       "1339333207296370",
33205 | 1017 |       "769083696161334",
33206 | 1018 |       "1902096047053318",
33207 | 1019 |       "1458196751907748",
33208 | 1020 |       "825227187115497",
33209 | 1021 |       "1445596376556015",
33210 | 1022 |       "1257634676391629",
33211 | 1023 |       "2281604608934592",
33212 | 1024 |       "819613120720105",
33213 | 1025 |       "859477753137839",
33214 | 1026 |       "2080110199465235",
33215 | 1027 |       "846775507864079",
33216 | 1028 |       "820481787407395",
33217 | 1029 |       "1539291064077596",
33218 | 1030 |       "2084851718951026",
33219 | 1031 |       "1135791425189896",
33220 | 1032 |       "1819115498690038",
33221 | 1033 |       "687675160555530",
33222 | 1034 |       "1529325341544660",
33223 | 1035 |       "793097830397288",
33224 | 1036 |       "824187610371685",
33225 | 1037 |       "1171770334904936",
33226 | 1038 |       "734713902986986",
33227 | 1039 |       "1388988616361861",
33228 | 1040 |       "1537344817690788",
33229 | 1041 |       "1154855742774015",
33230 | 1042 |       "3898928450408025",
33231 | 1043 |       "1956898454906212",
33232 | 1044 |       "1106409598055657",
33233 | 1045 |       "1901549407412060",
33234 | 1046 |       "4270309346586665",
33235 | 1047 |       "835817858930600",
33236 | 1048 |       "1806455579976415",
33237 | 1049 |       "1151331006489662",
33238 | 1050 |       "1775630366410292",
33239 | 1051 |       "795564262849155",
33240 | 1052 |       "1324834109282472",
33241 | 1053 |       "1176867533812766",
33242 | 1054 |       "4282609995389611",
33243 | 1055 |       "1880599495867393",
33244 | 1056 |       "821112693840718",
33245 | 1057 |       "1449150746363603",
33246 | 1058 |       "1869531137105699",
33247 | 1059 |       "1343985646831626",
33248 | 1060 |       "1022263589976782",
33249 | 1061 |       "2025178901651918",
33250 | 1062 |       "666737399508325",
33251 | 1063 |       "1918321695650984",
33252 | 1064 |       "1370355787795719",
33253 | 1065 |       "847524547935024",
33254 | 1066 |       "1929845371078707",
33255 | 1067 |       "773485702411851",
33256 | 1068 |       "1406104364344225",
33257 | 1069 |       "25162471200106012",
33258 | 1070 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcxOTM3NDYyMTE5NTYxNQ==",
33259 | 1071 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NDQwMTgxNTY2MjQ5NzQ=",
33260 | 1072 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNDc4Nzg0MTU1Mjc3NTc=",
33261 | 1073 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE2NDAyNTE4OTM2MzEzNjg=",
33262 | 1074 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwMjIyNjM1ODk5NzY3ODI=",
33263 | 1075 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwMjUxNzg5MDE2NTE5MTg=",
33264 | 1076 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY2NjczNzM5OTUwODMyNQ==",
33265 | 1077 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MTgzMjE2OTU2NTA5ODQ=",
33266 | 1078 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNzAzNTU3ODc3OTU3MTk=",
33267 | 1079 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0NzUyNDU0NzkzNTAyNA==",
33268 | 1080 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5Mjk4NDUzNzEwNzg3MDc=",
33269 | 1081 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3MzQ4NTcwMjQxMTg1MQ==",
33270 | 1082 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0MDYxMDQzNjQzNDQyMjU=",
33271 | 1083 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1MTYyNDcxMjAwMTA2MDEy",
33272 | 1084 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI4MDY1MDYzNDYzNTQ3MzQ=",
33273 | 1085 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1NDMwMDA2Mjc5OTI3MjYy",
33274 | 1086 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDE2OTc4MTQ1NzIxMDc=",
33275 | 1087 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxMTEzNDEzODQ0MjU5Nw==",
33276 | 1088 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0MDU1MDIzMTc2Njg2NQ==",
33277 | 1089 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzYyMzQ3ODc4MDcxODY5Ng==",
33278 | 1090 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0MjcxMjgxMjc2ODg5ODA=",
33279 | 1091 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQxMjg0NzcyMzA2MzEwNjc=",
33280 | 1092 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MzQ3OTU4NDM4MDU3MTM=",
33281 | 1093 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMjUwNDExNzE0MTg1MQ==",
33282 | 1094 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMzk0NTA4ODEwMDMxODM=",
33283 | 1095 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE2NDc4MzU4OTY1OTk5Nzk=",
33284 | 1096 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3NjcwODU4ODQ5NDExNA==",
33285 | 1097 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNTY1Nzg4MzU5NTA2NDc=",
33286 | 1098 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwNDk5MTUxMzA0ODA5MTI=",
33287 | 1099 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NTg0ODI5NDIyNjcyNzE=",
33288 | 1100 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODQ4Njc3NDYzMDYzMzM=",
33289 | 1101 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNjUyODY4OTkwNzMxMDg=",
33290 | 1102 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3NTk5Mjk5MzgwMjg1NjE=",
33291 | 1103 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNTI1NzcwMDE2ODUzOTU=",
33292 | 1104 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5NzIxNzE1NjY5MTQxNjU=",
33293 | 1105 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM5NjEwODMwNjc0NzcxNDc=",
33294 | 1106 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMTMzNzk5MjEwMDUyNjM=",
33295 | 1107 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwMDA5Mjg1NjU0NTc2MjY=",
33296 | 1108 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM4Mzk4MTg2MTk2NTQ5NzY=",
33297 | 1109 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MDY2MzEyMDA0NzQyNzI=",
33298 | 1110 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzk0Mjc2MjQ4MzA2ODA=",
33299 | 1111 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0NTQ2MjIwMDA4NDA3NTMz",
33300 | 1112 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI1ODMxNjM4MTU2NDM5OTE2",
33301 | 1113 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNjY4OTEyMDUwMDM1NzQ=",
33302 | 1114 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMzkzMzMyMDcyOTYzNzA=",
33303 | 1115 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODk0OTQxMzkxOTI2ODA=",
33304 | 1116 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc2OTA4MzY5NjE2MTMzNA==",
33305 | 1117 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNTcwNjY1MDI5MjcyNDA=",
33306 | 1118 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MDIwOTYwNDcwNTMzMTg=",
33307 | 1119 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NTgxOTY3NTE5MDc3NDg=",
33308 | 1120 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyNTIyNzE4NzExNTQ5Nw==",
33309 | 1121 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDU1OTYzNzY1NTYwMTU=",
33310 | 1122 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNTc2MzQ2NzYzOTE2Mjk=",
33311 | 1123 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIyODE2MDQ2MDg5MzQ1OTI=",
33312 | 1124 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxOTYxMzEyMDcyMDEwNQ==",
33313 | 1125 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1OTQ3Nzc1MzEzNzgzOQ==",
33314 | 1126 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwODAxMTAxOTk0NjUyMzU=",
33315 | 1127 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0Njc3NTUwNzg2NDA3OQ==",
33316 | 1128 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMDQ4MTc4NzQwNzM5NQ==",
33317 | 1129 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MzkyOTEwNjQwNzc1OTY=",
33318 | 1130 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcwODM5NTk0NTAyODgyNw==",
33319 | 1131 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwODQ4NTE3MTg5NTEwMjY=",
33320 | 1132 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEwNTI4MDc4MTY5NTIwODY=",
33321 | 1133 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3MjY1NDQ3ODgwMTM0ODY=",
33322 | 1134 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzU3OTE0MjUxODk4OTY=",
33323 | 1135 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MTkxMTU0OTg2OTAwMzg=",
33324 | 1136 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY4NzY3NTE2MDU1NTUzMA==",
33325 | 1137 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MjkzMjUzNDE1NDQ2NjA=",
33326 | 1138 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5MzA5NzgzMDM5NzI4OA==",
33327 | 1139 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyNDE4NzYxMDM3MTY4NQ==",
33328 | 1140 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzczNDcxMzkwMjk4Njk4Ng==",
33329 | 1141 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzODg5ODg2MTYzNjE4NjE=",
33330 | 1142 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1MzczNDQ4MTc2OTA3ODg=",
33331 | 1143 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNTQ4NTU3NDI3NzQwMTU=",
33332 | 1144 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzM4OTg5Mjg0NTA0MDgwMjU=",
33333 | 1145 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5NTY4OTg0NTQ5MDYyMTI=",
33334 | 1146 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMDY0MDk1OTgwNTU2NTc=",
33335 | 1147 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE5MDE1NDk0MDc0MTIwNjA=",
33336 | 1148 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyNzAzMDkzNDY1ODY2NjU=",
33337 | 1149 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgzNTgxNzg1ODkzMDYwMA==",
33338 | 1150 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MDY0NTU1Nzk5NzY0MTU=",
33339 | 1151 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNTEzMzEwMDY0ODk2NjI=",
33340 | 1152 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNzE3NzAzMzQ5MDQ5MzY=",
33341 | 1153 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgzODg1NjgzNTU3MTU1Mg==",
33342 | 1154 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMDk5ODMzMDc1NDk2Nw==",
33343 | 1155 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE3NzU2MzAzNjY0MTAyOTI=",
33344 | 1156 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5NTU2NDI2Mjg0OTE1NQ==",
33345 | 1157 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMjQ4MzQxMDkyODI0NzI=",
33346 | 1158 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzQyODI2MDk5OTUzODk2MTE=",
33347 | 1159 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4ODA1OTk0OTU4NjczOTM=",
33348 | 1160 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgyMTExMjY5Mzg0MDcxOA==",
33349 | 1161 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDkxNTA3NDYzNjM2MDM=",
33350 | 1162 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4Njk1MzExMzcxMDU2OTk=",
33351 | 1163 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzNDM5ODU2NDY4MzE2MjY=",
33352 | 1164 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1NjExODQ0MzQ2MTU2MQ==",
33353 | 1165 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNjQyNDE0Njg2NjE0NzY=",
33354 | 1166 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4MzM2OTM3OTM5MDYxMDA=",
33355 | 1167 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcwMDAxMTc1NTkzNjE1NA==",
33356 | 1168 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg1MDQyMDI5NDIwMDAyOQ==",
33357 | 1169 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzI0NzgxNjkzNDQxNTI2NDQ4",
33358 | 1170 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzgxMzM4MDAzODE2NTU1Mg==",
33359 | 1171 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE4NzE4NDY4MDQyMTAzNzA=",
33360 | 1172 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDAyMzI0NTgxNzAzNTk=",
33361 | 1173 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc3NzY4NTE4MTU1NzEyNw==",
33362 | 1174 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5MjUxMDUxMzQwMjUzOQ==",
33363 | 1175 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEzMTc1MjMzNzY0NDEyNDM=",
33364 | 1176 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyNzMxMTAyMzEyMzMzMTA=",
33365 | 1177 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMjYwMTc3MTYyNzMxNjU=",
33366 | 1178 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc1MTg5Mzg4Nzc1MjUyMw==",
33367 | 1179 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NjA2MzkyNDE4MDk0MjE=",
33368 | 1180 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNDM3MjYxNzA5NzcxOTY=",
33369 | 1181 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzY0MDczNDcwMjExMjI1MA==",
33370 | 1182 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NDQ4MTk0NzAxNDk3OTU=",
33371 | 1183 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzc5ODM3NTg0OTc3NzE5OQ==",
33372 | 1184 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzcxNjY5NjIxNzc0NjM5Mg==",
33373 | 1185 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExNzY4Njc1MzM4MTI3NjY=",
33374 | 1186 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1Njk1NDg0MTczODYzNzY=",
33375 | 1187 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzEyMTM4MDk4NDQxNDY0Nzc=",
33376 | 1188 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzIwNzk0NDUzNDYxNDA4MTY=",
33377 | 1189 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzExMzU2MDM0NTg3NTk4Nzk=",
33378 | 1190 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE1NjM4NzMzNjE2NDM3MDc=",
33379 | 1191 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzg0Njc4Njg1Nzc5Njg0Ng==",
33380 | 1192 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0NjQ1MTgwOTQ2NTI3Mjc=",
33381 | 1193 |       "Y29tbWVudDoxMTQ5MTE3NzIzOTMzMTEyXzE0OTA2OTc3MDg3MjE5MjA="
33382 | 1194 |     ]
33383 | 1195 |   },
33384 | 1196 |   "https://www.facebook.com/reel/1546039723188424": {
33385 | 1197 |     "lastCount": 0,
33386 | 1198 |     "knownIds": []
33387 | 1199 |   },
33388 | 1200 |   "https://www.facebook.com/photo/?fbid=2351440198621066&set=gm.3153703288136627&idorvanity=1751513541688949": {
33389 | 1201 |     "lastCount": 37,
33390 | 1202 |     "knownIds": [
33391 | 1203 |       "3153836981456591",
33392 | 1204 |       "3153817881458501",
33393 | 1205 |       "3153750958131860",
33394 | 1206 |       "3153753768131579",
33395 | 1207 |       "3153788818128074",
33396 | 1208 |       "3153768804796742",
33397 | 1209 |       "3153738294799793",
33398 | 1210 |       "3153752964798326",
33399 | 1211 |       "3153860804787542",
33400 | 1212 |       "3153788374794785",
33401 | 1213 |       "3153759971464292",
33402 | 1214 |       "3153759054797717",
33403 | 1215 |       "3153752751465014",
33404 | 1216 |       "1893315601272988",
33405 | 1217 |       "2247717868988870",
33406 | 1218 |       "2005747403318365",
33407 | 1219 |       "1220933543289726",
33408 | 1220 |       "3153748931465396",
33409 | 1221 |       "3153747031465586",
33410 | 1222 |       "3153735721466717",
33411 | 1223 |       "3153717901468499",
33412 | 1224 |       "3153711098135846",
33413 | 1225 |       "3153705458136410",
33414 | 1226 |       "3154673998039556",
33415 | 1227 |       "3154217458085210",
33416 | 1228 |       "3154187304754892",
33417 | 1229 |       "3154210174752605",
33418 | 1230 |       "3154124964761126",
33419 | 1231 |       "3154064401433849",
33420 | 1232 |       "3154059831434306",
33421 | 1233 |       "3153890731451216",
33422 | 1234 |       "3154504031389886",
33423 | 1235 |       "3153925784781044",
33424 | 1236 |       "3153865034787119",
33425 | 1237 |       "3154064964767126",
33426 | 1238 |       "3154104928096463",
33427 | 1239 |       "3154065551433734",
33428 | 1240 |       "3155242934649329",
33429 | 1241 |       "2075246729890539"
33430 | 1242 |     ]
33431 | 1243 |   },
33432 | 1244 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid02K5stNkCQhxne1PLsnjB7LdnwVSCCxqSipPWxgpHQRR9YxzJA9QjqcrcPHx7HsjKDl&id=61584520760919": {
33433 | 1245 |     "lastCount": 87,
33434 | 1246 |     "knownIds": [
33435 | 1247 |       "1387048646140084",
33436 | 1248 |       "4029936247259749",
33437 | 1249 |       "2660328750978691",
33438 | 1250 |       "1334713168343936",
33439 | 1251 |       "1308776751017890",
33440 | 1252 |       "860633059666540",
33441 | 1253 |       "1162914796039786",
33442 | 1254 |       "707446865381225",
33443 | 1255 |       "1332922231472322",
33444 | 1256 |       "32631282399850242",
33445 | 1257 |       "1659956864728691",
33446 | 1258 |       "2009452379840879",
33447 | 1259 |       "1397998685092575",
33448 | 1260 |       "731542136047939",
33449 | 1261 |       "2195100867683396",
33450 | 1262 |       "1352140803044491",
33451 | 1263 |       "1582048652803221",
33452 | 1264 |       "3213235995511395",
33453 | 1265 |       "713851081769506",
33454 | 1266 |       "1751614108794244",
33455 | 1267 |       "1220933543289726",
33456 | 1268 |       "1455003568933656",
33457 | 1269 |       "954678057719951",
33458 | 1270 |       "4265160300476831",
33459 | 1271 |       "863798326084470",
33460 | 1272 |       "1368214498653334",
33461 | 1273 |       "2271294380058475",
33462 | 1274 |       "1914780959411823",
33463 | 1275 |       "4342023332710628",
33464 | 1276 |       "25610648951903072",
33465 | 1277 |       "1961217241125600",
33466 | 1278 |       "2059570238136530",
33467 | 1279 |       "695065753431906",
33468 | 1280 |       "1359374301769672",
33469 | 1281 |       "1386298086274612",
33470 | 1282 |       "1187415322720164",
33471 | 1283 |       "1195488835863790",
33472 | 1284 |       "843794491735616",
33473 | 1285 |       "708983228922331",
33474 | 1286 |       "1020099650299656",
33475 | 1287 |       "1309353301236675",
33476 | 1288 |       "1375348427384280",
33477 | 1289 |       "1837383113815193",
33478 | 1290 |       "1861441061169345",
33479 | 1291 |       "1523263618748823",
33480 | 1292 |       "836093312396374",
33481 | 1293 |       "834220359478702",
33482 | 1294 |       "1545544119923126",
33483 | 1295 |       "1556567885685420",
33484 | 1296 |       "1343080830898918",
33485 | 1297 |       "1103236938390764",
33486 | 1298 |       "859649783143680",
33487 | 1299 |       "1499835097914532",
33488 | 1300 |       "727778929827248",
33489 | 1301 |       "2366730120438641",
33490 | 1302 |       "1931144420799614",
33491 | 1303 |       "856913427204800",
33492 | 1304 |       "1190384626410068",
33493 | 1305 |       "817196824521583",
33494 | 1306 |       "3895894027369306",
33495 | 1307 |       "25370985949201334",
33496 | 1308 |       "4283846458525963",
33497 | 1309 |       "3226169730892248",
33498 | 1310 |       "1804234623581441",
33499 | 1311 |       "1565106078066742",
33500 | 1312 |       "1566836271123858",
33501 | 1313 |       "2410182332773265",
33502 | 1314 |       "1224551999488388",
33503 | 1315 |       "2005747403318365",
33504 | 1316 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjI0NzcxNzg2ODk4ODg3MA==",
33505 | 1317 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM4NzA0ODY0NjE0MDA4NA==",
33506 | 1318 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDAyOTkzNjI0NzI1OTc0OQ==",
33507 | 1319 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjY2MDMyODc1MDk3ODY5MQ==",
33508 | 1320 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMwODc3Njc1MTAxNzg5MA==",
33509 | 1321 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODYwNjMzMDU5NjY2NTQw",
33510 | 1322 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE2MjkxNDc5NjAzOTc4Ng==",
33511 | 1323 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzA3NDQ2ODY1MzgxMjI1",
33512 | 1324 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMzMjkyMjIzMTQ3MjMyMg==",
33513 | 1325 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzI2MzEyODIzOTk4NTAyNDI=",
33514 | 1326 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTY1OTk1Njg2NDcyODY5MQ==",
33515 | 1327 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAwOTQ1MjM3OTg0MDg3OQ==",
33516 | 1328 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM5Nzk5ODY4NTA5MjU3NQ==",
33517 | 1329 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjE5NTEwMDg2NzY4MzM5Ng==",
33518 | 1330 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM1MjE0MDgwMzA0NDQ5MQ==",
33519 | 1331 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU4MjA0ODY1MjgwMzIyMQ==",
33520 | 1332 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzIxMzIzNTk5NTUxMTM5NQ==",
33521 | 1333 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzEzODUxMDgxNzY5NTA2",
33522 | 1334 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTIyMDkzMzU0MzI4OTcyNg==",
33523 | 1335 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ1NTAwMzU2ODkzMzY1Ng==",
33524 | 1336 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfOTU0Njc4MDU3NzE5OTUx",
33525 | 1337 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDI2NTE2MDMwMDQ3NjgzMQ==",
33526 | 1338 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODYzNzk4MzI2MDg0NDcw",
33527 | 1339 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM2ODIxNDQ5ODY1MzMzNA==",
33528 | 1340 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjI3MTI5NDM4MDA1ODQ3NQ==",
33529 | 1341 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTkxNDc4MDk1OTQxMTgyMw==",
33530 | 1342 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDM0MjAyMzMzMjcxMDYyOA==",
33531 | 1343 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjU2MTA2NDg5NTE5MDMwNzI=",
33532 | 1344 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTk2MTIxNzI0MTEyNTYwMA==",
33533 | 1345 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjA1OTU3MDIzODEzNjUzMA==",
33534 | 1346 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNjk1MDY1NzUzNDMxOTA2",
33535 | 1347 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM1OTM3NDMwMTc2OTY3Mg==",
33536 | 1348 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM4NjI5ODA4NjI3NDYxMg==",
33537 | 1349 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE4NzQxNTMyMjcyMDE2NA==",
33538 | 1350 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5NTQ4ODgzNTg2Mzc5MA==",
33539 | 1351 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQzNzk0NDkxNzM1NjE2",
33540 | 1352 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzA4OTgzMjI4OTIyMzMx",
33541 | 1353 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTAyMDA5OTY1MDI5OTY1Ng==",
33542 | 1354 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMwOTM1MzMwMTIzNjY3NQ==",
33543 | 1355 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM3NTM0ODQyNzM4NDI4MA==",
33544 | 1356 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTgzNzM4MzExMzgxNTE5Mw==",
33545 | 1357 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTg2MTQ0MTA2MTE2OTM0NQ==",
33546 | 1358 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTUyMzI2MzYxODc0ODgyMw==",
33547 | 1359 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM2MDkzMzEyMzk2Mzc0",
33548 | 1360 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM0MjIwMzU5NDc4NzAy",
33549 | 1361 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU0NTU0NDExOTkyMzEyNg==",
33550 | 1362 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU1NjU2Nzg4NTY4NTQyMA==",
33551 | 1363 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTM0MzA4MDgzMDg5ODkxOA==",
33552 | 1364 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTEwMzIzNjkzODM5MDc2NA==",
33553 | 1365 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODU5NjQ5NzgzMTQzNjgw",
33554 | 1366 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ5OTgzNTA5NzkxNDUzMg==",
33555 | 1367 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzI3Nzc4OTI5ODI3MjQ4",
33556 | 1368 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjM2NjczMDEyMDQzODY0MQ==",
33557 | 1369 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTkzMTE0NDQyMDc5OTYxNA==",
33558 | 1370 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODU2OTEzNDI3MjA0ODAw",
33559 | 1371 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MDM4NDYyNjQxMDA2OA==",
33560 | 1372 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODE3MTk2ODI0NTIxNTgz",
33561 | 1373 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzg5NTg5NDAyNzM2OTMwNg==",
33562 | 1374 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjUzNzA5ODU5NDkyMDEzMzQ=",
33563 | 1375 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNDI4Mzg0NjQ1ODUyNTk2Mw==",
33564 | 1376 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzIyNjE2OTczMDg5MjI0OA==",
33565 | 1377 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTgwNDIzNDYyMzU4MTQ0MQ==",
33566 | 1378 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjQxMDE4MjMzMjc3MzI2NQ==",
33567 | 1379 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTIyNDU1MTk5OTQ4ODM4OA==",
33568 | 1380 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAwNTc0NzQwMzMxODM2NQ==",
33569 | 1381 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjA3NTI0NjcyOTg5MDUzOQ==",
33570 | 1382 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQzMzY3ODQzNDk5MzAzOA==",
33571 | 1383 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTQ2MzQyOTUyOTExNzM3MA==",
33572 | 1384 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjAzNzkxMTEzMDM4MDE5Ng==",
33573 | 1385 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTMzNDcxMzE2ODM0MzkzNg==",
33574 | 1386 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTc1MTYxNDEwODc5NDI0NA==",
33575 | 1387 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU2NTEwNjA3ODA2Njc0Mg==",
33576 | 1388 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU2NjgzNjI3MTEyMzg1OA==",
33577 | 1389 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODM5OTE2MDI1MzE5NzUz",
33578 | 1390 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMjYwMjQwNTEwMzQ2NzU4NA==",
33579 | 1391 |       "1520049082604093",
33580 | 1392 |       "Y29tbWVudDoxMjIwOTQyMDU3NTUxNTA2OTJfMTUyMDA0OTA4MjYwNDA5Mw==",
33581 | 1393 |       "715410431602862",
33582 | 1394 |       "Y29tbWVudDoxMjIwOTQyMDE2MjExNTA2OTJfNzE1NDEwNDMxNjAyODYy",
33583 | 1395 |       "2247717868988870",
33584 | 1396 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMzk0OTI1MDI2MTk2NDA4NA==",
33585 | 1397 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MjE1MzcxMjI5NDA0OA==",
33586 | 1398 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE1Njk4OTUwOTkyNDc0MA==",
33587 | 1399 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQ1Mjk0NTk1MDQ0MTk3",
33588 | 1400 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODc4NDE0NDc0NTIyNDQy",
33589 | 1401 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODY5MTg4ODE4OTU0OTA1",
33590 | 1402 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTU1ODYyNjUyNTMwNTk2Mg==",
33591 | 1403 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODQwNjg1MzEyMDMyMTU5",
33592 | 1404 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfNzIwODQ0NDMxMDc2MDM3",
33593 | 1405 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfMTE5MzgwNzM5MjA4MzQyMQ==",
33594 | 1406 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODIzNjQ4NTA3MTc2MzA2",
33595 | 1407 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
33596 | 1408 |       "Y29tbWVudDoxMjIwOTQyMDEwMjcxNTA2OTJfODc3NjkyMDA4NTQxMTg2"
33597 | 1409 |     ]
33598 | 1410 |   },
33599 | 1411 |   "https://www.facebook.com/watch?v=1007690551560515": {
33600 | 1412 |     "lastCount": 95,
33601 | 1413 |     "knownIds": [
33602 | 1414 |       "24724695490539165",
33603 | 1415 |       "1004761021865101",
33604 | 1416 |       "1374128397566877",
33605 | 1417 |       "1222276019745872",
33606 | 1418 |       "1893315601272988",
33607 | 1419 |       "2247717868988870",
33608 | 1420 |       "2005747403318365",
33609 | 1421 |       "1220933543289726",
33610 | 1422 |       "2907372662986782",
33611 | 1423 |       "1478452229883974",
33612 | 1424 |       "2075246729890539",
33613 | 1425 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMjQ3MjQ2OTU0OTA1MzkxNjU=",
33614 | 1426 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTAwNDc2MTAyMTg2NTEwMQ==",
33615 | 1427 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTM3NDEyODM5NzU2Njg3Nw==",
33616 | 1428 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTIyMjI3NjAxOTc0NTg3Mg==",
33617 | 1429 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMjkwNzM3MjY2Mjk4Njc4Mg==",
33618 | 1430 |       "Y29tbWVudDoxMjIyMDQ3MjE5MzgyODYwODlfMTQ3ODQ1MjIyOTg4Mzk3NA=="
33619 | 1431 |     ]
33620 | 1432 |   },
33621 | 1433 |   "https://www.facebook.com/photo/?fbid=1261877999299746&set=a.642315474589338": {
33622 | 1434 |     "lastCount": 453,
33623 | 1435 |     "knownIds": [
33624 | 1436 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDQzMDIwODc0MDM1NzE=",
33625 | 1437 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4Njk5NTU0NDM5MDI5Mw==",
33626 | 1438 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzMjc4NjEyMjEwNTA0MjI=",
33627 | 1439 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzcyNTE0MzQwMjgxNjY=",
33628 | 1440 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDIxNTE5NDM5OTc5NTM=",
33629 | 1441 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjUzMDYxMTE4MDMyOTI=",
33630 | 1442 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQyNjU2MTcxNDM0NzU=",
33631 | 1443 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjY1Nzk1MjE5ODA1NTM=",
33632 | 1444 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTQ2MDkzMTQ0ODY0NDk=",
33633 | 1445 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTYxODA1MjY5NzU5ODQ=",
33634 | 1446 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNjQ2NTg0ODQwNjUyMTQ=",
33635 | 1447 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzgyMjE1NDc3NzI0NTA=",
33636 | 1448 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTU2MzI0ODY3ODg0MQ==",
33637 | 1449 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjM1MDg3NzE0MzIzNDk=",
33638 | 1450 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyOTk2MjEzOTgxMTM0MA==",
33639 | 1451 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjgzMzMzODgzOTUzOTg=",
33640 | 1452 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDgxODM4NzExOTY4OTk=",
33641 | 1453 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkyNTE5MTIyMDY3NzA1Nw==",
33642 | 1454 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NDU5NjU0MzIyODY5NA==",
33643 | 1455 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjkwNjI2MjQ3MTIwODI=",
33644 | 1456 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTEyODAyNzc5NTc2Nzk=",
33645 | 1457 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTc5ODIwOTE1NTk4ODk=",
33646 | 1458 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTg2NDUyMTg4NTI1MA==",
33647 | 1459 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTkyOTI2NjkxNTIyNTU=",
33648 | 1460 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjI3OTU4ODg2NjYyMTM=",
33649 | 1461 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MDA5NzExMjA5OTUwNzQ=",
33650 | 1462 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzA4MDgyODcyNzk0Njg=",
33651 | 1463 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzg3NTI1NDAzMjUyNjc=",
33652 | 1464 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NzQxNjczMTQ2MzIwMg==",
33653 | 1465 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI3MTEzMDY3MDU4Njk2NzU=",
33654 | 1466 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzgxNDQ3MDk4NzY4NTE=",
33655 | 1467 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY5ODI0ODk0NjQ0NjQ5MQ==",
33656 | 1468 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODkzMjM1NzU3MTM4Mjg=",
33657 | 1469 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjQ0MjU1NDUzNjU1MDI=",
33658 | 1470 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQwNjk0MjM2OTE5NzE=",
33659 | 1471 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NDQ0Mjc2NjY5NjYxMzM=",
33660 | 1472 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NzE4MDU0MjUyODM5Mw==",
33661 | 1473 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MTIxMDE2NzgwNTA4OA==",
33662 | 1474 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MjcwODcyNDM1MjYwOQ==",
33663 | 1475 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM3MTI4NTA1ODMyODE=",
33664 | 1476 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwODIwMjY2NTM1NTYxNA==",
33665 | 1477 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Njc2NDIyMzM0NTM5NA==",
33666 | 1478 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM5MzQ1MjA1MzgzODM=",
33667 | 1479 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDU1MDgzMjgyMTAwMjk=",
33668 | 1480 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyMTI2NTc2ODkyMjQ4Mzk=",
33669 | 1481 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODgxOTg5MjYzMzQzMzg=",
33670 | 1482 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5Mzg5NTUyNjcwMDQzMDg=",
33671 | 1483 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTYyMzQzNzg1OTk3MzA=",
33672 | 1484 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTIxNDMyMzQzMTE2NzY=",
33673 | 1485 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODk1Nzc0ODI1NzkxODU=",
33674 | 1486 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODkwNzg3NzU5NTkyMjA=",
33675 | 1487 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNTM2MDU2ODgyNDI3OTI=",
33676 | 1488 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTc4NDgwNjE0ODc4Mjc=",
33677 | 1489 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxODUwMjUzNDY0MzU5MQ==",
33678 | 1490 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczMDIyMTAyMjk2NjgwNQ==",
33679 | 1491 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMzNzcwNjc3NDU1ODY0Njcy",
33680 | 1492 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTMwMTg2MDU1NjU0NTQ=",
33681 | 1493 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NDM5MjYxNzU5MDczMzc0",
33682 | 1494 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODExMzgwMjA4ODk2ODk=",
33683 | 1495 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NjQ5MDYwMzA1MTU0NA==",
33684 | 1496 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5NDIwODIyMzAzNDUyMg==",
33685 | 1497 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTQ5Nzg1NjIzMjMxODc=",
33686 | 1498 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDkxMzgwNTYzODA3NDU=",
33687 | 1499 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQxMDQwNjI4NDk4NjEwMTU=",
33688 | 1500 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNTg5NzYxNjIyMjI1Nw==",
33689 | 1501 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzAzMzc1MTgzMTIxNg==",
33690 | 1502 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDk1MjIyODcyMDQ3NjM=",
33691 | 1503 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTU5NTk4ODYwMjQ3MzQ=",
33692 | 1504 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDQ4ODM2OTI5MTcwOQ==",
33693 | 1505 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMDM1NTA5NjUzMDQwNA==",
33694 | 1506 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzgxMDgwOTE3Mzc5Mjc=",
33695 | 1507 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwNDgwOTYwOTA3MzQwOQ==",
33696 | 1508 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTM1NjUyMzY1MzgxMDE=",
33697 | 1509 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTE5MTE0NTg0NjgyMDU=",
33698 | 1510 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTA3MjU1OTY4NjM2Mzg=",
33699 | 1511 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1OTk3ODc1OTc3NzEyMQ==",
33700 | 1512 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MDk5ODk3MTIyMzc4NQ==",
33701 | 1513 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MTkzNTE0MTIyNzIwNTY=",
33702 | 1514 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk0MzIzNzU2OTczODY=",
33703 | 1515 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzOTUwNzYzODk3NTYxNw==",
33704 | 1516 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODc4MzAzMzMwMzY0MzY=",
33705 | 1517 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MDExNjg0MTE1MTk5Njc5",
33706 | 1518 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MjY5MDQ1MTIxMTcwMzU=",
33707 | 1519 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NTYzNjYyMzgzMjI5MjY2",
33708 | 1520 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODI2MjQ2OTY2MzczMzQ=",
33709 | 1521 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjE0NDM0ODM0NjM0Mzc=",
33710 | 1522 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4Njk3NTAwMzY5NTY5ODU=",
33711 | 1523 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2ODAzMDQ3NTY5OTgzNQ==",
33712 | 1524 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTY0NTk0MjI4OTM2NjY=",
33713 | 1525 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjQyMzQ4MTUwMDUwODk=",
33714 | 1526 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Njc3MDg1MzM1MTM5NQ==",
33715 | 1527 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDAzNDk5Njg3MTc1MDM=",
33716 | 1528 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNzM0MzA3MjEyNTkzNzI=",
33717 | 1529 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MjExMDM1NTExOTA5MQ==",
33718 | 1530 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNDc1NjI4NjA2OTUwMzY=",
33719 | 1531 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjg4NjQyOTQ3NTE4OTU=",
33720 | 1532 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjc5NjgzMzg0NzE2ODM=",
33721 | 1533 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI4NTIxOTI1MjgzMDg1MjU=",
33722 | 1534 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NDA1MTQ3MTgxMTAyNw==",
33723 | 1535 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkzMTMxMTE1MzAyMjA3OQ==",
33724 | 1536 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY3ODU0MTE4NTE4OTcyMQ==",
33725 | 1537 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NDAxOTA3NTk5MzY2NzE=",
33726 | 1538 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MDY2MTk5NTM4NzMxOA==",
33727 | 1539 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM1ODM4NjYxMjUwODY4MzQ=",
33728 | 1540 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDM3MDAzMjc1NTQ0OTY=",
33729 | 1541 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNzY5MjYzMDY0Mzc2NjU=",
33730 | 1542 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDgyODE1NTMwNDk3MTg=",
33731 | 1543 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NzMxMzM2MDY2OTY2MjU=",
33732 | 1544 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzU4ODk4NjEwMzMxNjE=",
33733 | 1545 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MTU5NjkxNjU0NDA4NTY=",
33734 | 1546 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNzYwMjQ2NTk1OTQxOTI=",
33735 | 1547 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNzg3Njg0NTc2MjExNTk=",
33736 | 1548 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwODg5NDg3ODUyNzk5Nzg=",
33737 | 1549 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1NjgxNDYwMzM2OTUxOQ==",
33738 | 1550 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTU2NTQzNzU2ODg1MjY=",
33739 | 1551 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MDUxMjE0ODE2ODAzNQ==",
33740 | 1552 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MDEzNTAyMzM5MTA0NzI=",
33741 | 1553 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQwMzQ4NjEwNzU2MTI=",
33742 | 1554 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDc4MDU4NDQyMjg4OTI=",
33743 | 1555 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzMjIzNDg5MDQ4NzM3NTg=",
33744 | 1556 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNzMxNTI3MDA3MjA1OA==",
33745 | 1557 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODQwOTA5MTYzNDQ3MTA=",
33746 | 1558 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNjE2NDI5MTk0MDY3NzM=",
33747 | 1559 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTMwNTQ2NDM5MTA0NjU=",
33748 | 1560 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDg4NzE3Nzk2ODk4Mzk=",
33749 | 1561 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODcwMDQ0MDY1NDIyODM=",
33750 | 1562 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MTA5MDgwMzQ5MjIzMA==",
33751 | 1563 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTAzODg3Mjg5ODU4OTU=",
33752 | 1564 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTE0OTI2Njg0MjQyMzM=",
33753 | 1565 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDE5NDAxNTY0OTc0NDA=",
33754 | 1566 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNjI1MjQyMTA5OTEwODE=",
33755 | 1567 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNzU3ODQ5NTQ1Mzk1OA==",
33756 | 1568 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzY0MjAwNDc0NDUyNTM=",
33757 | 1569 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTI1Mzc5MjExODEwOTY=",
33758 | 1570 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxNDc4MjUxMTM3OTIwNg==",
33759 | 1571 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0NDc3ODU3NTY3MTA5Mzc=",
33760 | 1572 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NTQ0NzIwODU0NzgzNDc=",
33761 | 1573 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODcyMzk1MjI4Mzc2NzI=",
33762 | 1574 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0NjIxNDA3Mzg2MDg5MjE=",
33763 | 1575 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTk5NDYwODI3ODc4OTM=",
33764 | 1576 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNDUxMTQwMTk1Nzg0MDM=",
33765 | 1577 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMxMzIzNjEzNzY5NDM4ODI=",
33766 | 1578 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODQ5MzQ3NTYwMTQzNzc=",
33767 | 1579 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTU2OTc3MzUyNzc0MjA=",
33768 | 1580 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMzkxNDk1NjA3OTM5OA==",
33769 | 1581 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4Njc3NzA3MTA4MDIyMQ==",
33770 | 1582 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNTM4NDEyMDI5MDA2Mg==",
33771 | 1583 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDMzODczODA4NzEyNTE=",
33772 | 1584 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MjMwMzMwMzUwMjI2NzE=",
33773 | 1585 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyODkyNTA4MTE1NDg5MTg=",
33774 | 1586 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTE3MDA2MTU5NDM5NzM=",
33775 | 1587 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyMDQyNTg1Nzk5ODI4ODU=",
33776 | 1588 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDE0NDM3MTc2ODM0NzM=",
33777 | 1589 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTY3NzAxMjUzNTMzMzE=",
33778 | 1590 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjExMjc0ODIwMDc4MDE=",
33779 | 1591 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzA2NTczMDU4MTE0NTY=",
33780 | 1592 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjQxMTg4OTEzMzcyMzI=",
33781 | 1593 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzODI5NzY5OTU1MTkwNjk=",
33782 | 1594 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyOTU5ODM2NjQ5OTcwMQ==",
33783 | 1595 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTEyMTcyMDI2MTM0Mzc=",
33784 | 1596 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDIyMTEwMzA2MjQ2NzM=",
33785 | 1597 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODYxNjU5MjQwMzEyMw==",
33786 | 1598 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxMTc2NTAwMTY1OTg1NQ==",
33787 | 1599 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1Nzg2MDMyNDk4Mjg2Njg=",
33788 | 1600 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyOTkwMjI2NjgyODA3OQ==",
33789 | 1601 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc5NDk1MTQwNjkwODcyNw==",
33790 | 1602 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNTIzMTkzMDcwNTQwNjM=",
33791 | 1603 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTE2MjUwMjk1OTc4MDc=",
33792 | 1604 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNjIxNjI5MDA2ODczNDM=",
33793 | 1605 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwNDUxMDM1MTkwODMxNg==",
33794 | 1606 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTA0NDI1MjkwOTY2NTA=",
33795 | 1607 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDYwMTM2MDM0MDUxMzQ=",
33796 | 1608 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjg1MTY2NzUyMjUzOTM=",
33797 | 1609 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyODg2NzIxODY2MTkwMDU=",
33798 | 1610 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MDA4Mjc4MDEyMjAwNQ==",
33799 | 1611 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4ODY5NzQ5Njg2MDQwNTQ=",
33800 | 1612 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwOTM4NzA4NzI3MjA3MDc=",
33801 | 1613 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMwNTk3ODYxNjA4NjA4MTI=",
33802 | 1614 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MTE1MTA3ODM4MTc5Mjk=",
33803 | 1615 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NzM4OTU4NTI5MDU0MjA3",
33804 | 1616 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzA0NjE2MTQ3NTI5NTc=",
33805 | 1617 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NzI4Njc4Njg0NjQxOA==",
33806 | 1618 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0ODEyOTIzNzk5MzI3MQ==",
33807 | 1619 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDA5MTI1NDE5ODc4MjY=",
33808 | 1620 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMzcwNTI3MzgxNjUxNTE=",
33809 | 1621 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTk2OTIzMTQyNjUxNjA=",
33810 | 1622 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM4ODQ3NTcyNjE2NTYyODA=",
33811 | 1623 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTM1OTIyMjgzNzMxMTk=",
33812 | 1624 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODUyMTg5ODM3NTIyNTE=",
33813 | 1625 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczMjM5MTQxMjcyMjY0Ng==",
33814 | 1626 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk2MTU2MzIzOTk5NzI=",
33815 | 1627 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQxNjA3MDA5NTA4ODgzNDg=",
33816 | 1628 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc5MDQ5NTY1NDAzODIxMw==",
33817 | 1629 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4OTg0Mjg2NTEwNDgxMzE=",
33818 | 1630 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NDI3NjE2Mjk5OTA3NTU=",
33819 | 1631 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDI2NTAwMjQ1MDA1MDU=",
33820 | 1632 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3OTM1NTE2NTI2OTM3OQ==",
33821 | 1633 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODE5NzUyMzY4MDE1OTU=",
33822 | 1634 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI5MzA3MjExNjM4MDM1ODU=",
33823 | 1635 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODkwMDAxNTkzMzg1ODA=",
33824 | 1636 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODQ3NDUzODMwMDM5NDc=",
33825 | 1637 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MzE1Nzk3Mjc3MjAzNDE=",
33826 | 1638 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyNzYxOTg4NjcwNDY3Ng==",
33827 | 1639 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2OTUwMzI4NzE0NzY1OTg=",
33828 | 1640 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNDMyMTU4NzM4NzgyNw==",
33829 | 1641 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODAxODAxOTAwNDk5MQ==",
33830 | 1642 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MzI5MDE3MTA0NTA2NQ==",
33831 | 1643 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MTA3NTE4NjM3MTIzNzI=",
33832 | 1644 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NTgwMTUxOTQ2ODg0MA==",
33833 | 1645 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDQ2ODM1NzAwNjQ5ODM=",
33834 | 1646 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDE1NzgzOTMxODAzNjI=",
33835 | 1647 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NjA2Mjc4MzY4MjcyOA==",
33836 | 1648 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNjgyNDY3MjQ3NzM2Ng==",
33837 | 1649 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjUxNTY4MjU0MTQwNDg=",
33838 | 1650 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI5ODg5Mjk2MjQ2Mzg2OTI=",
33839 | 1651 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzgyMTMzMzc3Njc5Mzc=",
33840 | 1652 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MDU5MTIyNDM4NDMxNDg=",
33841 | 1653 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjU4OTYwODE3NDYyNTE=",
33842 | 1654 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0MDM1NDEzNTE2MDU0Ng==",
33843 | 1655 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzczNTk5MjczNTYxNjU4OQ==",
33844 | 1656 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM3NzIyNjUzMjk1NzQyNDE=",
33845 | 1657 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzEzMzUzNDE0NTY5NDk=",
33846 | 1658 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyODMxMDIxNjUyMzY2ODk=",
33847 | 1659 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxNjg4MTQ0NDcxMzk2NA==",
33848 | 1660 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2Mjc3NjE5MDg1ODUzMDM=",
33849 | 1661 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTExOTQ0ODA5MDgwNzQ=",
33850 | 1662 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzOTc1MzgwMzQ4ODI3MTM2",
33851 | 1663 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgyMjc4NTMyMDU5NjY5Mw==",
33852 | 1664 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NDQ4Mzk2MDAxNTIwNTM2",
33853 | 1665 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMjU2NjM1MjY0OTQwOA==",
33854 | 1666 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjY3MjE1NDIwNTgyODk=",
33855 | 1667 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI2NzY5ODgzMjI2NTI1OTU=",
33856 | 1668 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzc1NTgyOTc4NTIwMDc=",
33857 | 1669 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNzI4NTM5MjMyODY3MTA=",
33858 | 1670 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4OTE4NDg4MzUzNDgyNg==",
33859 | 1671 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4MDI4MDI3MjM3MDA4NzI=",
33860 | 1672 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTUxNjM0Mjg1MDE0ODM=",
33861 | 1673 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzY2ODQwNDM2ODk0NzY=",
33862 | 1674 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0ODkxOTc0NDM5MzIwNg==",
33863 | 1675 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwOTA5ODUxNzk2NzgxNzQ=",
33864 | 1676 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NDIyNzkwNzM5ODc0Nw==",
33865 | 1677 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzU1MDU2NTcxNDI2MDc=",
33866 | 1678 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNzY5NDU4MDM3Nzk3Mg==",
33867 | 1679 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODg3OTMzMzE2ODIxNg==",
33868 | 1680 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMzUxNjU4NjE1NzM3OA==",
33869 | 1681 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODkyNDkwNTg4OTg2NjQ=",
33870 | 1682 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NDkyMTU3NzI5NTc1MA==",
33871 | 1683 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODczOTE1Mjk3NTY0OTk=",
33872 | 1684 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMDMxOTk1MjY5MTgxODI=",
33873 | 1685 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTM5MTAyOTk4OTY0NTM=",
33874 | 1686 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1OTgwNTg4NDQ2NzYyNzg=",
33875 | 1687 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzc1NDAwNTQwNzMxMjI=",
33876 | 1688 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyNzAyNDY3ODY0Njg0OTk=",
33877 | 1689 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NTkyNzEyNTkxMDA1Nw==",
33878 | 1690 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTMyMDIzMzUzNjUwNDc=",
33879 | 1691 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMzgyOTY3MDgxMjA5MTI=",
33880 | 1692 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjM2MTkzNjQ4MjM5OTI=",
33881 | 1693 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTA3NjU1MjUzMzg5Njg=",
33882 | 1694 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMjQxMjgzOTYwOTEyMg==",
33883 | 1695 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDA4Mzc4MjM2MzA3NTg=",
33884 | 1696 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMTk3NzkwOTU1MzY0NDg=",
33885 | 1697 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODU2NjEyMTU4NTU4NjA=",
33886 | 1698 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4ODcyMjM5MzcxMzY5OQ==",
33887 | 1699 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDUxNDYxNDM0ODYzMTY=",
33888 | 1700 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1Mzg5MTg0NzAwMDUzMA==",
33889 | 1701 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTA4ODY5MzExMDE1NzA=",
33890 | 1702 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDE4MDg5OTMyOTcyOQ==",
33891 | 1703 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODQ2ODgwMTU5NDk2MjY=",
33892 | 1704 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNzM0NDMxNjgxNDQ5NDg=",
33893 | 1705 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NzU4NDk3NjM4MzU4MjI=",
33894 | 1706 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3OTE0NzEwNzk2Mzc4MQ==",
33895 | 1707 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1Njc4MjM5NDc1NjQ2Mzg=",
33896 | 1708 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzU5MjI0ODQ0MjIwMg==",
33897 | 1709 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzY0OTA2MDI0NDg2Njk5OA==",
33898 | 1710 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxNzkyNTgzNjYxOTIxODI=",
33899 | 1711 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NjIxMzA2MjE4NTkzNTQ=",
33900 | 1712 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2MzcyMDg1MjcwMDg0OA==",
33901 | 1713 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4MjU5Njg1NDgwMzEwOA==",
33902 | 1714 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0ODcyMTY2MDkyMzkwMg==",
33903 | 1715 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNTg1MjY4MTI3NTg3ODk=",
33904 | 1716 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1MzYzMjU1MDM2MzUzOA==",
33905 | 1717 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwNDE3MTc5MTkzMzgyOA==",
33906 | 1718 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNzU0OTgwMDQzNzg4Mzg=",
33907 | 1719 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzg4MDQ0Mzc2ODk5Nzg=",
33908 | 1720 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzIyNDA0OTQ2MTY0ODI=",
33909 | 1721 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyNzAyODg1Mjg2MDI2NDU2",
33910 | 1722 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODQ5MTI5MzY1MjIwMTc=",
33911 | 1723 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzEzMjM5MTgzNzU1Ng==",
33912 | 1724 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTgxMjAyODY3MzYwOA==",
33913 | 1725 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MDU3MTI4MDQwNTU2MTA=",
33914 | 1726 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTY1NzcwNDIxMzM4NDc=",
33915 | 1727 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTM2MTQwNzU1NTgwMjg=",
33916 | 1728 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIxMjMxNjI0MDE1NDkxMDM=",
33917 | 1729 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODgyNzczNzk0MTk2MTA=",
33918 | 1730 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MzI4NDA4ODUwMjQ0ODg=",
33919 | 1731 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxMjc4NDU3NDg2NTY4Nw==",
33920 | 1732 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MjM2MjkyNTgyMjA3MzU=",
33921 | 1733 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDc1ODYzOTMyMTk2NDk=",
33922 | 1734 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NDc0NTA3Mzk0OTA0NQ==",
33923 | 1735 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2NDM0MDE2NjE0Nzg5OA==",
33924 | 1736 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTc5MzYzMzU2MTIzNDI=",
33925 | 1737 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzcxMDQ2NjAzMzg3MjA=",
33926 | 1738 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjgwNzExMDQzODg5MTQ=",
33927 | 1739 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNjc1NTk5NTE4MzQ0MDc=",
33928 | 1740 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNDM2OTIxNzc1NTQ5OTU=",
33929 | 1741 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MDM5OTE2MTI4NjU4Ng==",
33930 | 1742 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIzNjk0OTM4NzM0OTU4MzU=",
33931 | 1743 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNDMyOTQ5NjA4ODkxNQ==",
33932 | 1744 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTQ5ODA2MzczNjQxMzg=",
33933 | 1745 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTcwNDIxNTcxNTY2OTE=",
33934 | 1746 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNDkzODY2Mjg0OTM2Mw==",
33935 | 1747 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzMyOTcxODA3MDQ5MTMzNTUz",
33936 | 1748 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzgxODY4ODQyMzQ1Nw==",
33937 | 1749 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1NzExNTQzMDM4NTk4MA==",
33938 | 1750 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQ0MTMyNDc5NjIyNTI2Njg=",
33939 | 1751 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExMzYyNjAwMDgzMTM4ODQ=",
33940 | 1752 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODc3MjI3ODU4ODg4MTU=",
33941 | 1753 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI0NzE4MjIwMjU0NTIyMzYx",
33942 | 1754 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc1NDg4MzE5MTAyMzgyNQ==",
33943 | 1755 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0OTEyMzg1NzE5NjI1NTg=",
33944 | 1756 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDQxMzIzNTAyNjI3OTI=",
33945 | 1757 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0MDg1MzY1OTc1MTE4OTA=",
33946 | 1758 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNTY4ODAzMDI1OTcxMDA=",
33947 | 1759 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MDAwNzUyOTQ2MjY1Nzc2",
33948 | 1760 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMTAyOTQ3NTQ0OTYzNzM=",
33949 | 1761 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzczMjMwMzMyNDQ3MzM=",
33950 | 1762 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MTc1OTc5MDU5MTY0MjA=",
33951 | 1763 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MzAzOTkwODM2ODUzNA==",
33952 | 1764 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQwMjU0ODIyODc1OTUyMTQ=",
33953 | 1765 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MjkxNTI5OTAzODM4MzY1",
33954 | 1766 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzU3MTY2OTkyMjcwODAyNw==",
33955 | 1767 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyMTQ3NjM0NDIxMzAzNjM=",
33956 | 1768 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODY1ODI5NTYwMjg2MDI=",
33957 | 1769 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQ4MzUyNTEwNjQ3Nzk=",
33958 | 1770 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDk0NjYwMjM1OTAzODU=",
33959 | 1771 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyMzE1NDU3MTA0MzE2MDM=",
33960 | 1772 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDk0MDY4OTk3NTYzNjA=",
33961 | 1773 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwODU3NTAyMjMxOTc0Ng==",
33962 | 1774 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNjIyMTcyNDYwNjcxNzQ=",
33963 | 1775 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQzNjU2MTY3MzM2NTk1NDM=",
33964 | 1776 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3MTc0MzE1Njk2NjEyNjk=",
33965 | 1777 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1MjA4MzM0Mzg1NTI1MDc2",
33966 | 1778 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NDA0NDY2NTA0MDIzNzM=",
33967 | 1779 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNTU0NDEzODAwNDE4NzQ=",
33968 | 1780 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjg2OTc0OTI0ODAxMjY=",
33969 | 1781 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIyNDk4NDkyOTg4NzMyNjg=",
33970 | 1782 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM0MzMwMzMyMjM1MjEwMDI=",
33971 | 1783 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5MTQwMTgxMzMxNDAxNg==",
33972 | 1784 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc0NjgwODY0NzgxMzY2NA==",
33973 | 1785 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODk4MTAzMzY1NzQ4OQ==",
33974 | 1786 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjE5MjE2NzkyOTAzNTk=",
33975 | 1787 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwNDQ1NjczMzYzOTQxODM=",
33976 | 1788 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg5OTcyOTE1MjQ4NDUzNw==",
33977 | 1789 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkwMzgxODczNTY0MzUwNQ==",
33978 | 1790 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODU5NTM2Mjk4NTQ1MDI=",
33979 | 1791 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4NzU3NjgwNDMzNzA2OQ==",
33980 | 1792 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODk4MDAyNjkyODY5NTI=",
33981 | 1793 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjY2OTg5MzE0NDEzNzY=",
33982 | 1794 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM0MDA4Njc2Mjk4NzMxNjM1",
33983 | 1795 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NDI1MjgxNDMwNDY1Mzc=",
33984 | 1796 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI3MTkyOTQyOTE3NTU4MDE=",
33985 | 1797 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTg5MTYzMTIxMjE0OTg=",
33986 | 1798 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNjk2ODAwODgzMjc1MDA=",
33987 | 1799 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2Nzg3Mzk1OTQ0NDQ5Mw==",
33988 | 1800 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzQxNDgyMDc5MTc2OTM=",
33989 | 1801 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2MTc5OTQ1OTI4OTE3MjU=",
33990 | 1802 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMDY5MjQ1MzQ1MjU3NTg=",
33991 | 1803 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NzM0MjIyODI4MzAwOQ==",
33992 | 1804 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4MzAxNDk3NzUwMzg5MQ==",
33993 | 1805 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkxOTkzMTU3NDUzMjc4MQ==",
33994 | 1806 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMDgyODg1OTQzMTcyMDI=",
33995 | 1807 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNzc1NzkwODg2ODI3MA==",
33996 | 1808 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyOTI5MTY2Mzk1MTg2MjA=",
33997 | 1809 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNjU5NzE5MDAzMDIzNQ==",
33998 | 1810 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzNjY0MjQzMjQ5MzIxMg==",
33999 | 1811 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNjc5NDEzMDIxMjIxODY=",
34000 | 1812 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNDM0NzgwNzI1NzUyNzI=",
34001 | 1813 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExOTU0MzU4NTkxODg5Mjg=",
34002 | 1814 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5Mjg2OTMwNDQ2OTg4ODE=",
34003 | 1815 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNDkzMDI2MjczNDAyNTM=",
34004 | 1816 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3OTkzODMwOTA3MzczODY=",
34005 | 1817 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzcyODM2OTQzODI1MTY=",
34006 | 1818 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMDkyODkxMDQ3MjAyNDQ=",
34007 | 1819 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgxMjI2MTE1MTgxNzMwMQ==",
34008 | 1820 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEwNjcxMTU1MTg4MjQwMzQ=",
34009 | 1821 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzMzM0OTIxNjE3NTc5Nw==",
34010 | 1822 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzMTQ0ODY1MTM2OTU2NzI=",
34011 | 1823 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzIwMjE5NjYwODg1ODg2OTA=",
34012 | 1824 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzOTE4ODk2MTg5NTIyNTU=",
34013 | 1825 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTAxODcxMDYyMjI5OTk=",
34014 | 1826 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNzQ1NjIzNDE0OTAxODk=",
34015 | 1827 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzM2OTg4NzU4MzAyNDUzMzg=",
34016 | 1828 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQzMDA2MDk4OTY4NTA5Mzg=",
34017 | 1829 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcwMjUxMjU3NTk4ODEzOQ==",
34018 | 1830 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcxNTM2NjM3MTIxODExOQ==",
34019 | 1831 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NjI4MjQ1NDUxMzcxOTQ=",
34020 | 1832 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NDg2MjIzMDMyMTM3OTY=",
34021 | 1833 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1ODc5NjUzMzUyMjkyMw==",
34022 | 1834 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NzYyMjEzMTk3MjE3NTE=",
34023 | 1835 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI4MTg5MDUzMjg1MDA1ODc=",
34024 | 1836 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzgzODI1NzAwNTY4MDU5Mg==",
34025 | 1837 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODcyNTYwMzU5NTYxNDM=",
34026 | 1838 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExNTk3OTg0ODI5Nzc4NTU=",
34027 | 1839 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzc4NjUwMzE1Nzc3NjUwNQ==",
34028 | 1840 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTQzMDA5MjU2NDg0Mzk=",
34029 | 1841 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyOTQ3NTU0NzU3NTM4MDA=",
34030 | 1842 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE3NTQ5OTUwMDg3OTM2NDg=",
34031 | 1843 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyOTU1OTE1Njg2MzUwNA==",
34032 | 1844 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDQwMTkzMTA1MDA2OTk=",
34033 | 1845 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMzY3ODU3OTE2MDExMDk=",
34034 | 1846 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4Njg4ODExNjA2NTQ4OTQ=",
34035 | 1847 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MTA2MjA3OTY5MDMzNzY=",
34036 | 1848 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NzQ0NzM0OTg1MTMwMTMx",
34037 | 1849 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg1MjU4NTU4NDIzNTg3Mg==",
34038 | 1850 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MjE4NzU0NTkxMDgyNTQ=",
34039 | 1851 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2ODU5ODQ5OTU3MDkzNjc=",
34040 | 1852 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzcyNTUxNDY2MDU5ODM1Nw==",
34041 | 1853 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3NjI0OTMwODM3MTE3OQ==",
34042 | 1854 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3ODQwNjI5NDYzNzAzNg==",
34043 | 1855 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE0ODUwOTI3MzI1ODc0Nzg=",
34044 | 1856 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODM3NDg2NjU5NzY2ODQ=",
34045 | 1857 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4ODI1NDU0Njk5NzE0NQ==",
34046 | 1858 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NTg0NDg1NzE4NjI2NTE=",
34047 | 1859 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE2NzQwODE4NzA2NDI4NjA=",
34048 | 1860 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1OTE0NDIxNjYxNTA4NjE4",
34049 | 1861 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODEzMDE0MTQxMDg0MTk=",
34050 | 1862 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NzM4NDg1NzAxNzMxNzE=",
34051 | 1863 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5MDA1OTEwOTM4NjIwNTE=",
34052 | 1864 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg4NjkzMDUzMzc4OTI0OQ==",
34053 | 1865 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzODQ2MTA0Nzk3MTQ1NTQ=",
34054 | 1866 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1ODIxNzI5MDMyMDYwNDM=",
34055 | 1867 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4ODIzNDUxMDU2ODkxNzU=",
34056 | 1868 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MTYxNzQ3MjAxMTkyMw==",
34057 | 1869 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg2MTUyODQxNjI2OTkyMw==",
34058 | 1870 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzQyNDc1NTkwOTIxNzI4MDc=",
34059 | 1871 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0NjI1ODQ1ODMzMDc0OA==",
34060 | 1872 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyNTEwMjYwMjM1MTMzNzE=",
34061 | 1873 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE4NTQwOTc0ODE4NjIwNTE=",
34062 | 1874 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzkyODQ5MDUxOTkzMzcyNA==",
34063 | 1875 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg3MzExODE4ODcwNTA2NQ==",
34064 | 1876 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODM0MTc5OTA0MjE2NDM=",
34065 | 1877 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE5NzM3MDU3MDY4MTk0MDQ=",
34066 | 1878 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1MzUxNzU0OTQxOTQyMjE=",
34067 | 1879 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzI1NTQyNDQ3NDY4NjgzMzEy",
34068 | 1880 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzg0MDc2Njg0MjQ2MzQ4OA==",
34069 | 1881 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEyMjk1NDg1MzYwMjQ1OTg=",
34070 | 1882 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzE1NDc5MjY3NDMwNDE5MDU=",
34071 | 1883 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzEzNDkzOTc3OTYzNjM5MDM=",
34072 | 1884 |       "Y29tbWVudDoxMjYxODc4MDM5Mjk5NzQyXzExODAwODgxMDcwNjI2NzU="
34073 | 1885 |     ]
34074 | 1886 |   },
34075 | 1887 |   "https://www.facebook.com/stylowegaraze/posts/pfbid05vq8oLbrfBwqnN8EjEcae1ZE5MdfHip3QxCwJ3htMPDYPfBeEJivQ8qT9Yz22uyUl": {
34076 | 1888 |     "lastCount": 188,
34077 | 1889 |     "knownIds": [
34078 | 1890 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMTIzNDE3ODg5MjA5NzEwOQ==",
34079 | 1891 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxMTc5MTI2OTU2Mjk1MDg=",
34080 | 1892 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg3NDI4MjM4MTkyMjA4Ng==",
34081 | 1893 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0OTQ2ODg1NDUwOTA1NzM=",
34082 | 1894 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgwOTU5MDc1NTM5MTc1MA==",
34083 | 1895 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzNzExODkzOTAwMTUwNTY=",
34084 | 1896 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg2NjkyNzU5OTI1MjAyOA==",
34085 | 1897 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMTY5MTMzNjcyMDYzNjg=",
34086 | 1898 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMzc1MjEwNzE1NTA1NTk=",
34087 | 1899 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg1NjYyMzA2NzI1OTc3OQ==",
34088 | 1900 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExODgwMzE4NTI3OTkyNjQ=",
34089 | 1901 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MzU4MjE1NDc2MjQ1NTU=",
34090 | 1902 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgzMTQ0MzUyNjMxOTk5Nw==",
34091 | 1903 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNTg3MTkyNDkyODI3NzY=",
34092 | 1904 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NjE0MTYxNDUwMTM4ODE=",
34093 | 1905 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1OTI5Mzk4ODU0MTAxNDE=",
34094 | 1906 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzOTk1NDcxOTQ5NDg2NTk=",
34095 | 1907 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExODA3Mjg4MTM5OTY3ODY=",
34096 | 1908 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNzIxODM4NzQ4MjIyMTM=",
34097 | 1909 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMzc0MDIyMjcwOTIxMTk=",
34098 | 1910 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5NDgyMTIzMzI0MDczNTU=",
34099 | 1911 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0OTMyMDgzMzUzMTI5Njc0",
34100 | 1912 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg4OTgxMTQwMDM3MDg1MA==",
34101 | 1913 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzg1OTEyNDYxMDA2Njc3Ng==",
34102 | 1914 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNzMwODI2NTc4NzQwMzY=",
34103 | 1915 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDcxNjgzNzM4NjQwNzk=",
34104 | 1916 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgxNjMyOTI1NzkxNTA5Ng==",
34105 | 1917 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MzQ0NTczOTQxNjYyNzg=",
34106 | 1918 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1MDU2NzAwNTcwNjQ4NzE2",
34107 | 1919 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY4NDg0OTUxNDQxOTc0OQ==",
34108 | 1920 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgxMjQxMjQ4ODI3MTEzOQ==",
34109 | 1921 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQzNzIzODc4OTI5NzkwODY=",
34110 | 1922 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMjk4Mjc2NzQxNzg0ODc=",
34111 | 1923 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQyNDIxODM2MDI3MDUwMjc=",
34112 | 1924 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5OTQwNzU3NjMyMjg3MA==",
34113 | 1925 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQxNzgyOTcyNTkxNTIyMDM=",
34114 | 1926 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMjQyMjEwODE2ODkxNzE=",
34115 | 1927 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc1OTIwMTczMDQ2NDQ3Ng==",
34116 | 1928 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5OTEyOTI5Mjk3MzUzMg==",
34117 | 1929 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzUwNTQ3MTA0NTk5NDkzMg==",
34118 | 1930 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4Njg3ODE2MDc0MDUzNDI=",
34119 | 1931 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4NTUzMTcxMzg2NzYzODA=",
34120 | 1932 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NjIxNzU3MjUxOTU0Mjg=",
34121 | 1933 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY4NzQzNTk2NzE1NTg2NQ==",
34122 | 1934 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NTc1ODQ1MTc5MTk2MQ==",
34123 | 1935 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExOTUwMTIyNzkxMzAxODI=",
34124 | 1936 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE3NTg3MTc1OTQ3ODk1NTU=",
34125 | 1937 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1MzI2NjI0Mjc2OTIxNTg2",
34126 | 1938 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTgyMjEzMTYzNjY5OTI=",
34127 | 1939 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMDE5NDgyMjUyNTQyODk=",
34128 | 1940 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTYwOTE5OTMwODI0MzY=",
34129 | 1941 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMTI0NDc0MTAzODAyOTA=",
34130 | 1942 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MDU4NDYxMTM2NTg4MTU=",
34131 | 1943 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0OTAyOTg1ODE2MjE3Nw==",
34132 | 1944 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQzNjE4NzAxMTA4MDI2MDU=",
34133 | 1945 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDA4MzgyNjc4NTI3ODI=",
34134 | 1946 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMzg0MzQ2MjgyODM2NTk=",
34135 | 1947 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY1NzMzMDcyNDEwMjY3OA==",
34136 | 1948 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDMzMzMxNTM2MzUxMzA=",
34137 | 1949 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzgyOTQxOTA1OTczNjUyNA==",
34138 | 1950 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3OTg1ODczNzk5MTAyMQ==",
34139 | 1951 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMTA5Mzk2NjI3MTYwNTA=",
34140 | 1952 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5NDcyOTkxOTk0NzAyNg==",
34141 | 1953 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwOTMxMjY0MDk1NzMyNzM=",
34142 | 1954 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMzU4NzA1OTcxNzQ0Mjg=",
34143 | 1955 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MTUyMDg3MTU3NjQxMTE=",
34144 | 1956 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0NzMxNDQ1Mjk5ODA4NDE4",
34145 | 1957 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxNDkwOTE0NDg5MTc4ODE=",
34146 | 1958 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzE3MTIyOTIyNjM2NzI=",
34147 | 1959 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3NTQxNjEwMTk0NTQxNw==",
34148 | 1960 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjkwMjIwMDgzMTQ5MjU=",
34149 | 1961 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NjI1NzIxODgzNzU3NTU=",
34150 | 1962 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzY1MjM1MDc5MDg4ODE=",
34151 | 1963 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMzEzMTMzNzE5MzAyNzE=",
34152 | 1964 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI1OTIyNTM1Nzc3Nzg2ODc=",
34153 | 1965 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzNTk5MTQwMDIyMjI2MTM=",
34154 | 1966 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzYxODEzMzg0ODYyNzY=",
34155 | 1967 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODI4Mzk5ODQwMTkwMDU=",
34156 | 1968 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMjkwMTgyMjI0OTI3NjY=",
34157 | 1969 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1MDU1NzA3OTA0NTI3Nzc=",
34158 | 1970 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MzE1NDAwMTc3NTkyMTA=",
34159 | 1971 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3NjYxODgyODE3Mzk2Mw==",
34160 | 1972 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTc2NDcyMDIwOTkyNjM=",
34161 | 1973 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY1NTg3MzA4MzQ1Mzc3OA==",
34162 | 1974 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1ODIxMzMwNTI3NDczMTk=",
34163 | 1975 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyODAwNzYzMjA0Mjc1MjU=",
34164 | 1976 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwMjMzNDA2MjQ2NjI5NDI=",
34165 | 1977 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3ODA4MjI3NDU0OTUyNw==",
34166 | 1978 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMjk1MTcwNjI1MDM2MDY=",
34167 | 1979 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2OTE5NDk0MjIzMjQyOA==",
34168 | 1980 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYzMjA4Nzc4MzI0MzMxNg==",
34169 | 1981 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0ODc3MDIyMDIyNDY1Mzk=",
34170 | 1982 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIxNDc5MTQwMjIzNzE2MTI=",
34171 | 1983 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcyNjUzNjk2MzM0MDIwMA==",
34172 | 1984 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTUyNjk5NzIzMTY3ODQ=",
34173 | 1985 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0NTYzOTIxNDcxODEyMQ==",
34174 | 1986 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIwMjgxMzUxODQ2MjMwNTg=",
34175 | 1987 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NzIxMDg5MjA0Mjc1Ng==",
34176 | 1988 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MjQyNzE3MTQ4MTA0OTM=",
34177 | 1989 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczNDYyMjg5NjE2NDA0Mg==",
34178 | 1990 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1ODc4Njg4OTkyNjYzNDQ=",
34179 | 1991 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MzUxNDE3MzQxMDQyNzY=",
34180 | 1992 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MTM2MTE1Mjk4OTQ4NzI=",
34181 | 1993 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxMjYxNDI5MTY0MjY0Mw==",
34182 | 1994 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3MDAxNjIzMjE4NTc3MA==",
34183 | 1995 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjY2NTU5MzEzNjk3MTM=",
34184 | 1996 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMTI4MjQ2MTczNTk1Nzg=",
34185 | 1997 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwOTA3MjM3Nzk2NjA4MzE=",
34186 | 1998 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNjYwMjY5MzQ5MDUzNjY=",
34187 | 1999 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2NTYxNDQ0NzgzOTExMzE=",
34188 | 2000 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzMyOTY4MTc4MDc5MzU=",
34189 | 2001 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MzkxNTc1MTY5MDMwNjI=",
34190 | 2002 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNjk2ODc0OTUyMjk1ODU=",
34191 | 2003 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNDYzMjk1NzQwNTQyNTc=",
34192 | 2004 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MjgyNTEyNTE2MTQ2MTg=",
34193 | 2005 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIyMDA0Mjc5NDAzOTg5MDk=",
34194 | 2006 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI3MzExODQ2MjM3NDA3NTk=",
34195 | 2007 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxODMyNTY5MTE2OTM2Ng==",
34196 | 2008 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc5MTAwNzE2MDEzMTU4Mg==",
34197 | 2009 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3MDkyODQ1NTUzMjAxNQ==",
34198 | 2010 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDkxNzU1MjcyMjkyNTY=",
34199 | 2011 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc3ODc0ODc1Nzk5MjI2Ng==",
34200 | 2012 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MDM4MzQ4NDA0ODQzNjU=",
34201 | 2013 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1NTE1NDg5MDI0OTc2NjM=",
34202 | 2014 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDA2MDIxMTQ3ODA2NjE=",
34203 | 2015 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NzU4NDQ2ODY2NzUwMg==",
34204 | 2016 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyOTMxMDc2NTg4NTAwNzc=",
34205 | 2017 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2NTkzMzk0NDgwNjY4NTY=",
34206 | 2018 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NzQ3MzI4MzcwMTg4OTQ=",
34207 | 2019 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwOTM1MjU1NDgyNzU2NTAx",
34208 | 2020 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYxNTIwMDI3MTE3NDc3NA==",
34209 | 2021 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzczMDkxNDQwMDk3MzA=",
34210 | 2022 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczMTMyMTAwOTY4MjA1Mw==",
34211 | 2023 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM3MTM1MTE0MTU2MDc5NjE=",
34212 | 2024 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzU5NjA5ODM3MzU2OTk5OA==",
34213 | 2025 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MjU0MzM4MzgyNTc0NzA=",
34214 | 2026 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM4OTYwOTEwMDM5ODU3NDY=",
34215 | 2027 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0MTEyNjkyMjM1MDQ2NTI2",
34216 | 2028 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODAzNDk2NjA3MDYyNjc=",
34217 | 2029 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwMDI3OTQ2MzMyMzUzOTA=",
34218 | 2030 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY3NjM0NzQ0NTQzNDkzOQ==",
34219 | 2031 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0MDUxODM0OTc0MTk5Nzg=",
34220 | 2032 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwMDk1MzA5MTEzODU2Mjk5",
34221 | 2033 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMzUxMTE4NzE5Njk5NjM=",
34222 | 2034 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0NzE1MDQ2NzcwODM4MQ==",
34223 | 2035 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM3OTM3MDQ5MTQyNjY5MjE=",
34224 | 2036 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNjM0NzExNTI1ODgxMDI=",
34225 | 2037 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyMzc4NDEyNTc3OTgwMjg=",
34226 | 2038 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwNTE1OTk2NzcxNzQyNzc=",
34227 | 2039 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0OTI3NzM5OTIxMDA3NTc=",
34228 | 2040 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzYwNzkwMjUwODYwMDgyOA==",
34229 | 2041 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzUzMzM2MjEyNjUyNjg4MA==",
34230 | 2042 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcxNjA1NzU1NDYyMzU1Nw==",
34231 | 2043 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE3Mzk2OTEyNzMzMzQ1MzA=",
34232 | 2044 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDkyNjYzNTA3MjE5ODI=",
34233 | 2045 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE1Mzc2MzMyMzQzMTA2MDg=",
34234 | 2046 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2OTEwNTQ0OTE1OTM3NQ==",
34235 | 2047 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE2MjM2MjAxOTE2NDQyNTk=",
34236 | 2048 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzY2ODg1Mjk0OTQ5MzA5MQ==",
34237 | 2049 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzI0NDI5MzIyNjk0MDk1MzM=",
34238 | 2050 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExMDA2NzY4NjUyNjMxODA=",
34239 | 2051 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzcwMjI0OTg5NTk2NzE2MA==",
34240 | 2052 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMwOTEwOTI1Mjc3MDcxMTU=",
34241 | 2053 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwODAyNjQ5NTIyMTcxNDE=",
34242 | 2054 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NTcxMDgwNDU3MDU1NzY=",
34243 | 2055 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzOTY3NDMwMzE0NDQ5NTM=",
34244 | 2056 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0ODQ4NDc0Nzg1NTU4OA==",
34245 | 2057 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEzMDg1NTYzMTA3NTYyMDM=",
34246 | 2058 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzM5OTMyNzgzNDQzMTgwMTM=",
34247 | 2059 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDEwMDA3NzA1ODcwMTE=",
34248 | 2060 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDY4NjQ1NDAxMDA2OTg=",
34249 | 2061 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzOTI5MTMzNzczNDEzNjM3",
34250 | 2062 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzczMTExMTc5MzE4ODk0Mw==",
34251 | 2063 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzMzODc3MjM1MTEzNjkyODQ=",
34252 | 2064 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNTA3NDk1OTY5MDg3NDM=",
34253 | 2065 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzIzMDA0MzQwNjcxMjk2OTY=",
34254 | 2066 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE4MjMyNzE5NTQ5MjExMDA=",
34255 | 2067 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzQwNTM4NTEwMjE1OTcyMjA=",
34256 | 2068 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc0OTY1MzAzMDg1NjY4OA==",
34257 | 2069 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NDA0MzMwMDM4NjM4MDQ=",
34258 | 2070 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE5MTM4MTE3ODI3OTcxNzQ=",
34259 | 2071 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzc2NDcxNjcwOTY0NTE4MA==",
34260 | 2072 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEyNzgxMDE5ODcyNDc2ODY=",
34261 | 2073 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzE0NTIzNTIwMzk2NjM2MDE=",
34262 | 2074 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzEwODgyMjYyNjY3NTM0NjA=",
34263 | 2075 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzU1MzE1ODU1NDU0NTA2Mw==",
34264 | 2076 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzExNzA3NzU5NzE1Nzc5Nzk=",
34265 | 2077 |       "Y29tbWVudDoxNDA4ODk2ODE3NTYxOTcxXzkwMTY5NzM3NTY5ODY0OQ=="
34266 | 2078 |     ]
34267 | 2079 |   },
34268 | 2080 |   "https://www.facebook.com/permalink.php?story_fbid=pfbid07QEU9poceJ3Awgq8MowtLEituw7ogQs6QZzwzNpi6KmfPn4Eom7QqPA5AquxumVFl&id=100050638022594": {
34269 | 2081 |     "lastCount": 412,
34270 | 2082 |     "knownIds": [
34271 | 2083 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1OTE0NDk4NjE0ODA4OTI4",
34272 | 2084 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjY4MjUyOTc4NjAwNzY=",
34273 | 2085 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzYxNDI4MDEzNTA5NzI4Mw==",
34274 | 2086 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NjI1MjU2NjQzNDkyNTU=",
34275 | 2087 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIwMDA1MzM1MzkwMDM=",
34276 | 2088 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNjg5OTQyNTgxNjY0Nw==",
34277 | 2089 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjMwOTk5NDg1NTg4MTE=",
34278 | 2090 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NjIxMzQ5OTI4MzY3Mg==",
34279 | 2091 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTIxNjc1Njg5OTkyNzc=",
34280 | 2092 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODgxOTU2NTI4NTczNjI=",
34281 | 2093 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzEzMTE5OTgxMzUzMTA=",
34282 | 2094 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY5OTQ1OTA0OTY3OTgxNA==",
34283 | 2095 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTM5NDE2MTg2OTE5NzY=",
34284 | 2096 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTM0NTM2NDY1ODA2MzA=",
34285 | 2097 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MzI5MzczNjcwNjM4MDk=",
34286 | 2098 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1NjcxOTAzNzA3NTA5NA==",
34287 | 2099 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0ODY3MTg0NzU3MjIzNzA=",
34288 | 2100 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NTQ4OTg3NTg1MjgwMjI=",
34289 | 2101 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NzQyNjI2NTM0NzIwNDU=",
34290 | 2102 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjYyOTc1MzQ1NjA3NTI=",
34291 | 2103 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODAyNzc0NzI4NzY5MTc=",
34292 | 2104 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNjMxNDA2NzQ1MjUyNTE=",
34293 | 2105 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NDUwODk4MTU0OTY4OQ==",
34294 | 2106 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDk1OTY5NDUyNzQyNg==",
34295 | 2107 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NTY4MDgyOTUxNjk4NQ==",
34296 | 2108 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzMDI3Nzk0NDMzNDIyNjY=",
34297 | 2109 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODAxMzUwOTQzMTU1NjY=",
34298 | 2110 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4Mjk4MjMyMDc1MzM5MQ==",
34299 | 2111 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjYzNDAzNzk1NTc2Mjg=",
34300 | 2112 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzAwMDMxOTQ2MTAzODA=",
34301 | 2113 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzIxODczMTc3MjQzMjE=",
34302 | 2114 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjA2NjYxNDY2NzE3MjM=",
34303 | 2115 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjY5MzEyOTgyNjc3MTE=",
34304 | 2116 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTY5Nzg0MTgwNDU5OTc=",
34305 | 2117 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDE3NzExNzc0ODE5Nw==",
34306 | 2118 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTk1OTIzNzg3NjY1NTk=",
34307 | 2119 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzM2NTQyNjE2MDA0NjU3",
34308 | 2120 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQxNzA0NTY3Mzk4Mzc0MTA=",
34309 | 2121 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MTAzMTMwNzM0NzQ0Mjg=",
34310 | 2122 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzUxMzUxMjM5ODY4NjY=",
34311 | 2123 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNTE0MzIzMTY2NzY1MA==",
34312 | 2124 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMTk0NTE1MDMyNjcxODA=",
34313 | 2125 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5ODk4MjY2MzMwOTUwNQ==",
34314 | 2126 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4MjE3MDk5NTg0Nzg0NjM=",
34315 | 2127 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODQ4NzcxMTMzNDc3OTU=",
34316 | 2128 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNzk4MzU1MzQ5NzYzOTg2",
34317 | 2129 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODU0NTY4NzY0NDk2MzI=",
34318 | 2130 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjI0NTQyNDIxNjU3OTc=",
34319 | 2131 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2Mjg5MDM4MTE4MTY2NTA=",
34320 | 2132 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5ODM2MjA4Njg4NDc3OTg=",
34321 | 2133 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MzU0ODM4NDMwNjkxNw==",
34322 | 2134 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczNzg0ODQ1OTMzNTQ0Ng==",
34323 | 2135 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMxMzc4ODE1Nzk3MjU1NTI=",
34324 | 2136 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNjk4MjkwMTM0NTU2MDQ=",
34325 | 2137 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjczMDc5OTE0NDYzNDA=",
34326 | 2138 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3NDE4NjU4OTU5NTgwNTM=",
34327 | 2139 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIxNjExMjM1MTI4NTA=",
34328 | 2140 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTk2NzY5NDk3MzA3NTU=",
34329 | 2141 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTkyNDYyMDQ4MjM2MDk=",
34330 | 2142 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTk3NDQ3MDkwNDE2ODg=",
34331 | 2143 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNjUzMTUxNDcwMzI0NDA=",
34332 | 2144 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MTYzNTE2NjI2MjU4OTk=",
34333 | 2145 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTI4NzI1ODIzNDg4ODg1",
34334 | 2146 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTM3NzgzMTI4OTQ5MTI=",
34335 | 2147 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTMxMzcyNDA0MzA1ODY=",
34336 | 2148 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNTIyNzE1ODMzMzYwNDc=",
34337 | 2149 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2ODEyMzk1OTAyMzYyMw==",
34338 | 2150 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDg4MjUzNTAzNjM1NQ==",
34339 | 2151 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjA3MzUxOTI3NTEzMDY=",
34340 | 2152 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDMwMzk1ODQ2Mzc0OQ==",
34341 | 2153 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Nzc4ODYwMDk4Nzk0NzA=",
34342 | 2154 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTYwODE4NDIyMDk0MjI=",
34343 | 2155 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4NDc3MTk5NzkxNDg1OQ==",
34344 | 2156 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMDU4NzA0MDY3NDczMA==",
34345 | 2157 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NDMxMTM1OTk5NjE1MDk=",
34346 | 2158 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI0Mzg4ODE2NTMyMzI4NDI=",
34347 | 2159 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMTExNTgwMDYwNjc2Njc=",
34348 | 2160 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjU3MDE1NjQ5NDkyMDk=",
34349 | 2161 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMyOTA1MDE2NDE1NzgwMTk4",
34350 | 2162 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjQwNTMyMjU4ODY5MTY=",
34351 | 2163 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3ODk4NTIzMTczMDg3Ng==",
34352 | 2164 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTA3NjA3OTk1MzgwMDY=",
34353 | 2165 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NjA5NjYwNDQ1MzE5NTE=",
34354 | 2166 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4Njg1NTcxNzEzNTQ5NA==",
34355 | 2167 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4ODE4NjU0MDMxMTU1Nw==",
34356 | 2168 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMzU4ODIzMzUwMDQ2NDQ=",
34357 | 2169 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNzY3MjQ2NTc0NTY5NA==",
34358 | 2170 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTE4NDcxMjA4NTIyMzU=",
34359 | 2171 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2Nzk3NDQ2NjE3MzExNw==",
34360 | 2172 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0NTg2MDc2NTIwODM1OQ==",
34361 | 2173 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzMjIzNTg4MzEzODc1Mw==",
34362 | 2174 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1OTEwOTM3NzA1MjEyMw==",
34363 | 2175 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxNjk5NDkwNDY2MjUwMw==",
34364 | 2176 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDYyNzk1NDAwMDU4NA==",
34365 | 2177 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyOTc4MzExODczNjAyOTI=",
34366 | 2178 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDcwMjE0NDQ0NTAzODM=",
34367 | 2179 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNDQ2OTM4MDY0NDIzOQ==",
34368 | 2180 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODY1NjcyODg2NDY0NzU=",
34369 | 2181 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxNTAzOTEyMTU4NDEwMg==",
34370 | 2182 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NDg2NDcyMzI0NzEyMTE=",
34371 | 2183 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjQ3ODE0ODI0MzMxMjc=",
34372 | 2184 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4MjQ2MzcwMDk3OTI4NA==",
34373 | 2185 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMjU4NDA0MDgyMjQ4NDk=",
34374 | 2186 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjIwOTY3ODY3MjM4NTM=",
34375 | 2187 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzIyMTY2MTk0MTE0ODg1",
34376 | 2188 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NDI1Nzc5MzM2MTA0OTc=",
34377 | 2189 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTkwMTQ4MjY3MjQ1Mg==",
34378 | 2190 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMDE1MDE0ODA2NjMxNTA=",
34379 | 2191 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2NDgzOTg1ODk2NTE5MjM=",
34380 | 2192 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MzAwODk0ODU4NzUwNA==",
34381 | 2193 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTQ1MzYwMTcxMzI5OA==",
34382 | 2194 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTY5MDQwNzg0NTU2ODQ=",
34383 | 2195 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTcwNzQ0MTIyNjg0OA==",
34384 | 2196 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Njc5ODc0Nzc5NjM2OTI=",
34385 | 2197 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODgxODkxNTYwNDUyODg=",
34386 | 2198 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjcxNTUxMDc3MTk3NjE=",
34387 | 2199 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4OTY3OTk1MzQyODg5NA==",
34388 | 2200 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyOTQ4NTU2MDE5NDA1NA==",
34389 | 2201 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMTc2NzY1OTY5MjY4Mzc=",
34390 | 2202 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzMDU5MjY0MzEyODk2Nzg=",
34391 | 2203 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTc4MTQ4OTc5Njc3NTk=",
34392 | 2204 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3MTk3MjAyMjU2NTIzMTY=",
34393 | 2205 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyODczMTkxNDgzNjIzOTg=",
34394 | 2206 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNTU5OTg0ODMzMzQyMjg=",
34395 | 2207 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTc0NDIwNTIzMzM5MjY=",
34396 | 2208 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3NDUyMTQ3ODgyODAzOQ==",
34397 | 2209 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Mzc4NzA4OTc1MTcyNDQ=",
34398 | 2210 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMDE3NjA4MzcxMTQ1MDE=",
34399 | 2211 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MzM1MjQ3ODQ4NDE2NA==",
34400 | 2212 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0NzEzNzc1MTczMzgyOA==",
34401 | 2213 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MTIyOTI0NTY1OTY3Mjg=",
34402 | 2214 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNzQyMjg2MzkzOTM4MTQ=",
34403 | 2215 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwOTQ2MDA0MTg5NjYxNQ==",
34404 | 2216 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NTk0MjAxNTQ2Njc4NDg=",
34405 | 2217 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjc5Mjc2Nzg0NDkyMTI=",
34406 | 2218 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NjAyNDc0MDQ2NDkwOTQ=",
34407 | 2219 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MTI4NjM5NzYwMTAwOQ==",
34408 | 2220 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc5MTAxOTc5MDYxMjM4OQ==",
34409 | 2221 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczMzE1NDIxOTg0NDU3MQ==",
34410 | 2222 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzM1MDQxODQ5MjQ3NTI=",
34411 | 2223 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNTY3MDEwODI3MjU5MA==",
34412 | 2224 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNzQ1ODU4MDA5NjYxOA==",
34413 | 2225 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzQ2ODMxNzc2Nzg0NTA=",
34414 | 2226 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MzY0NjI2NDc1MTkwMDg=",
34415 | 2227 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NjM1NDkyNjM5NjQ4Nw==",
34416 | 2228 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MDkwNTAwNTQwNTUzMTk1",
34417 | 2229 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODEzNzQ4MjA4MzcxMjc=",
34418 | 2230 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMjczNDg4NjYxMzgxNjI=",
34419 | 2231 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjExODIxNjk0Mzk0MzM=",
34420 | 2232 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc1MTQwNDc2NDYzOTkyNg==",
34421 | 2233 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTM3NTg4NzYwNTkwOTk=",
34422 | 2234 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNzU5NzQyMDI2MzA0Mg==",
34423 | 2235 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQxNzQ0MTAzOTk0NDY5MjM=",
34424 | 2236 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTk2NzI3NzE0OTc4MjA=",
34425 | 2237 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTQxMzk3OTU0MTA0NTE=",
34426 | 2238 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjUwMTE4NjkwNzkxNjE=",
34427 | 2239 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjk1NTg0MDkwMzU2NjQ=",
34428 | 2240 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMDQyNzgzNzc5ODU4MA==",
34429 | 2241 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4MTIyMTQzODI3NjM1NzU=",
34430 | 2242 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDAzMDUxODE0ODI2MDU=",
34431 | 2243 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5OTA3ODE1NjAxNzg1OQ==",
34432 | 2244 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjk5MjI5Mjg5ODU4ODI=",
34433 | 2245 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4MTE2MjI2MDkyMTY1Nw==",
34434 | 2246 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2NjE3NzE4OTEyOTgxNQ==",
34435 | 2247 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjQ0OTkwMDUzMTAzMDc=",
34436 | 2248 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjczNTMzODE3NTI0OTI=",
34437 | 2249 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNDUxMjU0NjkwOTMzNzQ=",
34438 | 2250 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTY2OTg3MTY2NjE1NjI=",
34439 | 2251 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDYzMDA3NTY3ODc3NzE=",
34440 | 2252 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTUwMDYzNzg3NTMzNjk=",
34441 | 2253 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODg0MjA5MzkyNjU1MTk=",
34442 | 2254 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDE1MTY1MTEzNDkwNDc=",
34443 | 2255 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTkyODg5NDM0MzIxMTk=",
34444 | 2256 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzMzMDY4ODQzMzMwMDE=",
34445 | 2257 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNDU4NzQxNTAzNzE2MQ==",
34446 | 2258 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3NDEzMzExMTI2Njg3NTk=",
34447 | 2259 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODY5MDMwMTYwODc4NTg=",
34448 | 2260 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwNDU5NjIxMjQ0NTc5MQ==",
34449 | 2261 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2Mzc2MzA5NTM4ODY1NDY=",
34450 | 2262 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTM4ODgxOTIwMjU5NTM=",
34451 | 2263 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5ODEwMTA4MTkxMTA2Mzg=",
34452 | 2264 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NjU2NzQ0NTE3ODk1ODQ=",
34453 | 2265 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NjA4NzE0NDgyNDE2Nw==",
34454 | 2266 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTIzMDk0MTU3OTEyNjU=",
34455 | 2267 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MjcwNjM3NDU5MTkzMzg0",
34456 | 2268 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzQzOTk3MTA5NDgzMzg=",
34457 | 2269 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NTYzNzA0MzUwNDU1Mjg=",
34458 | 2270 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNjYzMzc4Mzg5MzkzMTA=",
34459 | 2271 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMzcxMDUyNDAzNjIyNzM=",
34460 | 2272 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NzU1NDI0NjY3MTc5OTU=",
34461 | 2273 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NDY2NzUxNTI2Mjk3MzQ3",
34462 | 2274 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDEwNDU1NDEzNTYyNDc=",
34463 | 2275 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5MTgwMjM5Njg3ODMxMA==",
34464 | 2276 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjA5MDU2NzQ5NDQ5OTI=",
34465 | 2277 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzYyNjExMzM4MzIxMjk=",
34466 | 2278 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjA5Mjg4ODg2OTg3MTY=",
34467 | 2279 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwMDk0MzQ5MjE0MDUyNDU=",
34468 | 2280 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyMjUxODEwNzI3Njk1OA==",
34469 | 2281 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyNjI3MTIwNDU2MTYyNTE=",
34470 | 2282 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2ODE1ODExODk4OTAyOTU=",
34471 | 2283 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkwOTYwOTc0NDk3MzA1OA==",
34472 | 2284 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODUyNDU0MjkwNDg2MjI=",
34473 | 2285 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMjU5ODgwNzExNzIxNTI=",
34474 | 2286 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTUyMTU2MjQ0MjE4OQ==",
34475 | 2287 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwOTg4NzI0NDg5MjI0NTU=",
34476 | 2288 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY3OTY0OTE1NTA4MTYzMQ==",
34477 | 2289 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTkxMDAxMzI2ODM0NjE=",
34478 | 2290 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzg3MjI3MDY5ODEwMDc=",
34479 | 2291 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MjcyMTE1MDgzOTcwMTA=",
34480 | 2292 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMzYzNzk2MjM1MDI0NzY=",
34481 | 2293 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NDEyNDA3ODUxNjM0Mw==",
34482 | 2294 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgwNDA4MTY4MjY0Nzc0NQ==",
34483 | 2295 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjM1NDg4NTg2MDg1NTU=",
34484 | 2296 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MzM5ODQ5Mjc1ODMxNQ==",
34485 | 2297 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyODUzMDM4NzE5NDg5NTM=",
34486 | 2298 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTYzODY0MTYyODEwOTI=",
34487 | 2299 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODczODAyMTk4MjIzMjI=",
34488 | 2300 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMjQ5NDAyMTQ2MzM5NDE=",
34489 | 2301 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjUxNTgzNDExODQ4MzA=",
34490 | 2302 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NzcwODg5OTY3MTcxODE=",
34491 | 2303 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NDM1OTM5NjU4MjM4MA==",
34492 | 2304 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Nzg2OTEzMDM0NDY0OTY=",
34493 | 2305 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NzQyOTkxMjM3NTkzOTg=",
34494 | 2306 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MjU5MTc0NDgzMTc3OTI=",
34495 | 2307 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjUyNzQ0NzE2NDU3MDY=",
34496 | 2308 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMzQzMzA4NTAzMjIxMzg=",
34497 | 2309 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDc5MTk4NzQ0MDkxNQ==",
34498 | 2310 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjM0MDA2MTU0ODA2NTc=",
34499 | 2311 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzcyMDgyOTc5MjkzMTc=",
34500 | 2312 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MjUxNDg4MDg3MjI1Njc=",
34501 | 2313 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Mzg4OTAyNDQwMTM5MDU=",
34502 | 2314 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MTU1NDg5NDIxMzY2NjU=",
34503 | 2315 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMzQwNTk4MDU0Njk1MjM=",
34504 | 2316 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNDgyNjg5MDc0MzM1NzQ=",
34505 | 2317 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDUzMjQwNzA3NjIzMjA=",
34506 | 2318 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTA5MzkzMjI5MjIyOTI=",
34507 | 2319 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzk0NzM0NTQwMTI4NjM0Ng==",
34508 | 2320 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg4NDkxNTE0NDE4MTk2NA==",
34509 | 2321 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDQ3OTAxODY5MjI3NzA=",
34510 | 2322 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyNjI2NzQ1NzIzNTQ1ODI=",
34511 | 2323 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyNTMwNzA1MzE4ODA2NDg=",
34512 | 2324 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0MzMzMDQ4NTY4OTEwNjE=",
34513 | 2325 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTIwMzI4MjYyMzMyMzI=",
34514 | 2326 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTg1MzM0MTc4Nzg2NDI=",
34515 | 2327 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NTY2NzM3Njk2NDU1NA==",
34516 | 2328 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjU5NjQ3MzkwODAwMTU=",
34517 | 2329 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMjQ1OTM3ODE3MjM0NjE=",
34518 | 2330 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzODQyMjk5NTQ1NTI0MA==",
34519 | 2331 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNzk5NTk3ODkxMDc5NDY=",
34520 | 2332 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDM3MTYzNDE3MDYzODk=",
34521 | 2333 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3ODIzODcxMjU4MTIxMDU=",
34522 | 2334 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3Nzc1OTU3MjYyMjI3NDg=",
34523 | 2335 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkzMzc0MjAxNTk5MTA4OA==",
34524 | 2336 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NjMwNzM4Nzc5ODgzMzk3",
34525 | 2337 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MTk4Nzk2MzU1OTU0OTc=",
34526 | 2338 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2ODU0Nzg2OTAwNDgwNw==",
34527 | 2339 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQwNzQ5NjY0NjI3NTI4MDc=",
34528 | 2340 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDQ5MDc1ODEyNjczNjM=",
34529 | 2341 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzE3Mzk2MDQ3MDA1NTM=",
34530 | 2342 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjEyNTEzNTIzNDYwMg==",
34531 | 2343 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcyMjY2Nzg4MDQ2MzYwOA==",
34532 | 2344 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4OTE4NjM4MDgwNjMxOA==",
34533 | 2345 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NTM4NDYwNDk0MzI5MTI=",
34534 | 2346 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMzNjI5NjU5MzA1MzI5MDA=",
34535 | 2347 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTMyNjg3Mjk0ODE0NDM=",
34536 | 2348 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTkwMTQ4Mjk4NDUxOTQ=",
34537 | 2349 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxNDA2MTg5MzAwNzY1MjQ=",
34538 | 2350 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDI1MDE3NTQ3NjE2MTY=",
34539 | 2351 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MjU3MjI1NTIwMDEwNg==",
34540 | 2352 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTM1NzM3MDY5NDU5NzI3",
34541 | 2353 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5NDc3MDAzOTc3OTI1Mw==",
34542 | 2354 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgyNDc5MTM4MzczMTgyMg==",
34543 | 2355 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzODMzOTY5MTAxOTU0NTc=",
34544 | 2356 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMTg5OTYyMzg2MTUwNzM=",
34545 | 2357 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDcwNTE4NTc1NjU4ODk=",
34546 | 2358 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzNzIzMjYxODk2NjM3MzU=",
34547 | 2359 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NTE0MzU2NzU4ODkyMzk=",
34548 | 2360 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTUzNzI4NzQ4ODExMTg=",
34549 | 2361 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MTgzOTA1NTQ0NjEzNjYy",
34550 | 2362 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyMDU4MzQ3MDk5NDM5MjI=",
34551 | 2363 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzczMzQ3NDExMzEyNzY1Mw==",
34552 | 2364 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTQzNDg4NTcyNDcwNTc=",
34553 | 2365 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4OTUyODg5MDgwNDcyNjk=",
34554 | 2366 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0ODcyMzU3ODA3OTI5Mw==",
34555 | 2367 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzNzgzNzEzNDkzNDQ4OTM=",
34556 | 2368 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxMTM1MTM5NTAyNzE3NA==",
34557 | 2369 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0Mzk4NTY3NTEwNDczNjk=",
34558 | 2370 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzM2MzMwMDc3NTgwMTY=",
34559 | 2371 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MTIxOTQ5Nzk4ODk2MjU=",
34560 | 2372 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMjM1MDE1MjcwMzQ2Nw==",
34561 | 2373 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNDgwNjgwNjM5ODM5Nzk=",
34562 | 2374 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzODU5NDc4MTgzMTUzNDI=",
34563 | 2375 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkwNDYyMzgxNTYyOTk3OQ==",
34564 | 2376 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDEyMDEwNTg2MzEyMDM=",
34565 | 2377 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzY2Nzk5MTM5NjEzNDc=",
34566 | 2378 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNDcwNjg2ODcyMTc0OTg=",
34567 | 2379 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgzNTQzNDM2OTQwNDcyMw==",
34568 | 2380 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQyMDY3MjIxNjI5Nzg4NDU=",
34569 | 2381 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDAxNzA0NTgyMTY4ODc=",
34570 | 2382 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MzI1OTI3NjQ1MTgzOTg=",
34571 | 2383 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzkxNDI5NTUwNTA5OTI5MA==",
34572 | 2384 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDg1NjkyODcwMTU2MjM=",
34573 | 2385 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODk1NDY5MzkyOTE3NTE=",
34574 | 2386 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MTE0NTIyNjI4NTkzMg==",
34575 | 2387 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODEyNTU1MjA2ODk5MDg=",
34576 | 2388 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTYzNjMxMTcwODQ0ODc=",
34577 | 2389 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcxNzA1NjA1MTQ0OTY4OQ==",
34578 | 2390 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MDEyNjgxNTE3MjUwODk=",
34579 | 2391 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDkyNTU4Njc4Mzc3MzQ=",
34580 | 2392 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzMDUzMzA2ODY2NDY0OTg=",
34581 | 2393 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzI4OTMxMDc5NTM5NDU=",
34582 | 2394 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjkzMjE1NTY5MzQyNw==",
34583 | 2395 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1ODY0MDU0OTI1MDIyODY=",
34584 | 2396 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzODE1MDAyMjIxMzAwODQ=",
34585 | 2397 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTc1ODM1NzE0MDczMzg=",
34586 | 2398 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MjUzMjg3NzUxMTYxMjg=",
34587 | 2399 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjM1NTgwNzYzMDIyMjg=",
34588 | 2400 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg5MjgzMjM0NjUyNzE0Ng==",
34589 | 2401 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMzQ1MjI3NTkwMTM3MA==",
34590 | 2402 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NDMyMjAwMzMyNzE1MDI=",
34591 | 2403 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjM5NjIyOTI5NjAzMDY=",
34592 | 2404 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMTQxMzM1MzczMDk2OTc=",
34593 | 2405 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNTMyMjE3OTIxNzk2NTQ=",
34594 | 2406 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDA0NTc5NDQ1NzQ4ODU=",
34595 | 2407 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMjI2NzI0NDY0ODM1MTM=",
34596 | 2408 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzcwMTkyNjQ0NjA2MDM4Mg==",
34597 | 2409 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTA1OTY3NTkyNDMwMjM=",
34598 | 2410 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MzY3NTg4MDc4NjgyNzQ=",
34599 | 2411 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MjkxNjczODIxNDM3NTY=",
34600 | 2412 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1NDcxOTY3NjM1ODAzNzk2",
34601 | 2413 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwMzgzMjgxMjM2ODM5Mzc=",
34602 | 2414 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2OTIxNjM4NTgwODA0NQ==",
34603 | 2415 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwMjg4NTM2NDI3NDgzMTM=",
34604 | 2416 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExMjUwMDQ2MTk1MjE4NjU=",
34605 | 2417 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4Mzg0NTU0MTM0MDM0OQ==",
34606 | 2418 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzMyMjg1MTY0MzA2NTg4NDU=",
34607 | 2419 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTMyMzQ3NjI0NDU0Mjg=",
34608 | 2420 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIxMDI2MDk3MDA1NTMxNDE=",
34609 | 2421 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzgxMDAyMjkwMjAzMTY0MQ==",
34610 | 2422 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjgyNDcyMDgzMzY1MDY=",
34611 | 2423 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ1NzcxNTYzNzI1NjMzODQ=",
34612 | 2424 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTI1MDQzNjk5NDQxODk=",
34613 | 2425 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzYzODY5Mzc1NDcwMTg=",
34614 | 2426 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI0MjI2NzY0NzE1MjAwODk=",
34615 | 2427 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2MjM2NTMzODg5OTQ5OTU=",
34616 | 2428 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI4NDEyNTU1MjkzOTA4NDI=",
34617 | 2429 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMDAzMTYyNTU1MzE3NTE=",
34618 | 2430 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0NTg2NjQzNTA4NzQ2OQ==",
34619 | 2431 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjg5OTE5MDE1NTE0ODU=",
34620 | 2432 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExOTUxOTM5MDkyMjU0MzE=",
34621 | 2433 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NjkyNDA3OTM3MTkyOTY=",
34622 | 2434 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3NzEyNjM3MDM1NzIxMDQ=",
34623 | 2435 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM0NTg1MzkwMjc2Mjk2NTM=",
34624 | 2436 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyMTAzMzEyNzc2NDY3OTA=",
34625 | 2437 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE2NTE4ODY5ODI0NTYzNjg=",
34626 | 2438 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg3MjQ4MDEyMjE3MzgzMw==",
34627 | 2439 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0OTYwMDE2OTE2OTEzMDE=",
34628 | 2440 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExODIwODA2NzQxMTE5NjE=",
34629 | 2441 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIyMDgxNjgwMTMwMzk3NDY=",
34630 | 2442 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1OTIzMDQ4Nzc3MjgxNjQ3",
34631 | 2443 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5MDg4NTU1MzAwNjAzOTQ=",
34632 | 2444 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNTE0ODUxNDI4NzUwNTM=",
34633 | 2445 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc0MTczNzY5ODk1NTY0Mg==",
34634 | 2446 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQyODQ2NTQxNTUxMjYyNTk=",
34635 | 2447 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTY1NDMyNzgyODkxODA=",
34636 | 2448 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1MDE3ODg4MzQyNjgxNjE=",
34637 | 2449 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyODE1OTMzNTAzOTkyNTU=",
34638 | 2450 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNjAyNzExNzg0NDkxMTU=",
34639 | 2451 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MDAyNDczMzYzMDUzMg==",
34640 | 2452 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDUzMzk3NzcyMzUzNA==",
34641 | 2453 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzExNzM3NjQxOTE0OTMwMjk=",
34642 | 2454 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwODQ2Mzc1MzIyNzIxODc=",
34643 | 2455 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyOTA2ODAxNzYxNTY3MDM=",
34644 | 2456 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzM4MzAzODA3ODYwMTg=",
34645 | 2457 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzM3MTU1MTU0NDg1OTE3MDI=",
34646 | 2458 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4ODk1NTQxNjQ5ODYxOTM=",
34647 | 2459 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEyOTk4Mzc0NzIxNjQzMzQ=",
34648 | 2460 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNDI5MDY4NDM3OTgxNjk=",
34649 | 2461 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzY1MDQyODU1MTM5NzQ1Nw==",
34650 | 2462 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1ODA5NjYxNjU4NDAwMQ==",
34651 | 2463 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE3ODc0NjAwMDg2MjMyOTg=",
34652 | 2464 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg1MDgzMzQwMDkyMzk5OQ==",
34653 | 2465 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0NDU4MDEwODU2NDE5NDE=",
34654 | 2466 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQ0Njg3NjY0NTMzNjg2MzQ=",
34655 | 2467 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzQzMTY5NjE4NjE5MDk4OTY=",
34656 | 2468 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MjEzMDQ2ODQ1NjI3Nw==",
34657 | 2469 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MTg3Mzc0MzI0MjcxNQ==",
34658 | 2470 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE4NzgxMzAxMTM1ODY3MjQ=",
34659 | 2471 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzNzQxNjg5NDEwODIzNjE=",
34660 | 2472 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5OTY3OTgzNDQ0MzMwMDI=",
34661 | 2473 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTA2NjkyOTQxODUyMDM=",
34662 | 2474 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE5NjAxNTU0MDc4ODM2NDY=",
34663 | 2475 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0NzQ2OTU4NzEzMjcwMjg=",
34664 | 2476 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI1MzA2NzE0MjAyMzE3NjQw",
34665 | 2477 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEwNzk0MjkyNzA4ODkxNzY=",
34666 | 2478 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg2MDAzNjc3MzYyODUxNQ==",
34667 | 2479 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzODExNTQzNzU2NzY5NDE=",
34668 | 2480 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE0MTc4MDg3OTY2NDgyMTM=",
34669 | 2481 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2MjkwMjM4NTQxNDA5MzA=",
34670 | 2482 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1NjUxMjQ0NDc4NDMwNjU=",
34671 | 2483 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzE1Njc3NjQ1MTc4NzQxMDE=",
34672 | 2484 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzc4MzE1NTI0NDc3ODAxMQ==",
34673 | 2485 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzEzOTA4OTAyMzkyNDI4MDM=",
34674 | 2486 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1Xzg0MzMzNzQxMTc4ODE1OA==",
34675 | 2487 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzI2NzMyMzkzMjMzMDE3OTQz",
34676 | 2488 |       "Y29tbWVudDoxMjIwOTQyMTIzNjcxNTA2OTJfMjA1MzUxNzM2MjExNDE1Mw==",
34677 | 2489 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIzOTc4ODE4MjA2MzAxMDc=",
34678 | 2490 |       "Y29tbWVudDoxNDIxNTY3ODkyODc0NDY1XzIwNjg2NjY2NjcyMDM0NTc="
34679 | 2491 |     ]
34680 | 2492 |   },
34681 | 2493 |   "https://fb.watch/E7JKv3fqd4/": {
34682 | 2494 |     "lastCount": 3531,
34683 | 2495 |     "knownIds": [
34684 | 2496 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExOTY2MzY3Mzg5Nzk4MjI=",
34685 | 2497 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1ODc4MTgyMDkwNTMwOTA=",
34686 | 2498 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI2NjI5NDk1NjQwMzkxODg=",
34687 | 2499 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExNjM1ODE5ODE5MzQxNjE=",
34688 | 2500 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMzU1MjA0Mjk3MDc3NQ==",
34689 | 2501 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzQyMzE2Nzg0MzcxNTIxMjk=",
34690 | 2502 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzM4OTYwOTA2MTQwMjM2Mjg=",
34691 | 2503 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI1MTIxMzgxNzk3NTQ4NzEx",
34692 | 2504 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1MTY5NjA5MjI3NTc3MzA=",
34693 | 2505 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3MjkyMzc1NTQ0MTU5MjM=",
34694 | 2506 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzc3NTk5MTE0ODczNDg0NA==",
34695 | 2507 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIwMzM4ODAxMTA3MTIwMDA=",
34696 | 2508 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI1MzgxMDE2MzQ4MjA2MDQ3",
34697 | 2509 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5MTQ0NDA0OTI4MTUwNzU=",
34698 | 2510 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEzMzkyNjY2ODA0MTUxNjY=",
34699 | 2511 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExMjA3OTQ0NjMxNTMyOTA=",
34700 | 2512 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzQ0NTk1MTg4ODA5NDYzMDM=",
34701 | 2513 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3MzQ1MjgyNTA1NzY5NTk=",
34702 | 2514 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzg0NTgxNTk2ODAyNDIxNA==",
34703 | 2515 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgyODE1MTU5OTkxNTE1NA==",
34704 | 2516 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIxODYyMjg1NTUxOTk2NzY=",
34705 | 2517 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzMyMDc1MDY3OTk0MTQxMDc=",
34706 | 2518 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzc3MDE5ODI2MjcyMjUyOA==",
34707 | 2519 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMTg1NDUxMzEwNzM0Nw==",
34708 | 2520 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzg0OTcwNzc4NDI2MjQwMA==",
34709 | 2521 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExMzcwMzUzODg2Mzc0NDc=",
34710 | 2522 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1MzA1NjYwNDQ2NTYzMTI=",
34711 | 2523 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0MzI4MTM3NDE1NTAyOTc=",
34712 | 2524 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE3NjE5MjM4MDQ1MDQ2Mjc=",
34713 | 2525 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzM0NDg4NDI0NjE5NDE0OTk=",
34714 | 2526 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE4OTAzNjMzNjUyNDM0MjU=",
34715 | 2527 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzY3NDUyODM5NTQ1MjA5NQ==",
34716 | 2528 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgzMjg2NzQ3OTMyMzIzOA==",
34717 | 2529 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgxMzQzMzAwODE0OTM3Ng==",
34718 | 2530 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5NDY5NzQwODI1MzczNjY=",
34719 | 2531 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1Xzk4ODQ2MzA2NjgwOTMyMg==",
34720 | 2532 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEyMjQ3MzMxMTk1NjI3ODk=",
34721 | 2533 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzEzMjE0NTY3NTYzNDYwNTE=",
34722 | 2534 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1OTc0OTA0OTc4OTgxODE=",
34723 | 2535 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzcwOTcyOTY2NDk0NDY2MQ==",
34724 | 2536 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzIwNzkyNDU4MDk1MTI1ODM=",
34725 | 2537 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzMzNDQyNjAyNzIzODc4NTA=",
34726 | 2538 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzExOTI5MzU0NTI3MjEzNjM=",
34727 | 2539 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzgxNDM5MjAxNzg5Mjg3NQ==",
34728 | 2540 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE5MjE3NjI0MDE3MDYxNzk=",
34729 | 2541 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE1NzQzOTYyODA2Mzk3MzM=",
34730 | 2542 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0OTEwMTA0Nzg4MDEzMzY=",
34731 | 2543 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzI2MTgxMDIxMjc0ODI0MDQ0",
34732 | 2544 |       "Y29tbWVudDoxMjQ1NjMyMDg0MjYzMTc1XzE0NjQyODQzNzg1OTIyNDQ="
34733 | 2545 |     ]
34734 | 2546 |   },
34735 | 2547 |   "https://www.facebook.com/watch?v=1339546710688438": {
34736 | 2548 |     "lastCount": 19,
34737 | 2549 |     "knownIds": [
34738 | 2550 |       "Y29tbWVudDoxMjcwMTgwMDU4NDc1MDQ0XzcwMjIxNTk1NTk1MzU1Mw==",
34739 | 2551 |       "Y29tbWVudDoxMjcwMTgwMDU4NDc1MDQ0XzE0OTQ2NzA1MDQ5NjkzODg="
34740 | 2552 |     ]
34741 | 2553 |   },
34742 | 2554 |   "https://www.facebook.com/watch?v=1193982469334393": {
34743 | 2555 |     "lastCount": 5,
34744 | 2556 |     "knownIds": [
34745 | 2557 |       "Y29tbWVudDoxMjk4NzI0NTg1NjMwOTM5Xzc5OTAzMjI0NjUwMDQzNQ==",
34746 | 2558 |       "Y29tbWVudDoxMjk4NzI0NTg1NjMwOTM5Xzg5MDAyNjgyMDM3MTY2Nw=="
34747 | 2559 |     ]
34748 | 2560 |   }
34749 | 2561 | }
34750 | ```
34751 | 
34752 | ---
34753 | 
34754 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments.js`
34755 | **Typ:** JavaScript/tekst  
34756 | **Opis:** Plik projektu (kod/konfiguracja).  
34757 | 
34758 | ```js
34759 |   1 | // src/fb/comments.js
34760 |   2 | import { EXPAND_COMMENTS } from "../config.js";
34761 |   3 | import { sleepRandom } from "../utils/sleep.js";
34762 |   4 | import { scrollPost } from "./scroll.js";
34763 |   5 | import { acceptCookies, saveCookies } from "./cookies.js";
34764 |   6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "./login.js";
34765 |   7 | import { clickOneExpandButton } from "./expandButtons.js";
34766 |   8 | import { safeGoto } from "../utils/navigation.js";
34767 |   9 | import { getUiCommentInfo } from "./uiCommentInfo.js";
34768 |  10 | 
34769 |  11 | import * as uiPhoto from "./ui/photo.js";
34770 |  12 | import * as uiPost from "./ui/post.js";
34771 |  13 | import * as uiVideos from "./ui/videos.js";
34772 |  14 | import * as uiWatch from "./ui/watch.js";
34773 |  15 | 
34774 |  16 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
34775 |  17 |   ? Number(process.env.NAV_TIMEOUT_MS)
34776 |  18 |   : 90000;
34777 |  19 | 
34778 |  20 | /* ============================================================
34779 |  21 |    ===================== UI ROUTER ============================
34780 |  22 |    ============================================================ */
34781 |  23 | 
34782 |  24 | function pickUiHandler(url) {
34783 |  25 |   // kolejno≈õƒá ma znaczenie: najpierw najbardziej specyficzne
34784 |  26 |   if (uiWatch?.matchesUrl?.(url)) return uiWatch;
34785 |  27 |   if (uiVideos?.matchesUrl?.(url)) return uiVideos;
34786 |  28 |   if (uiPhoto?.matchesUrl?.(url)) return uiPhoto;
34787 |  29 |   if (uiPost?.matchesUrl?.(url)) return uiPost;
34788 |  30 |   return null;
34789 |  31 | }
34790 |  32 | 
34791 |  33 | 
34792 |  34 | /* ============================================================
34793 |  35 |    =======  PRZE≈ÅƒÑCZANIE FILTRA / SORTOWANIA KOMENTARZY  =======
34794 |  36 |    ============================================================ */
34795 |  37 | 
34796 |  38 | async function openCommentsMenu(page) {
34797 |  39 |   const r = await page.evaluate(() => {
34798 |  40 |     const norm = (s) =>
34799 |  41 |       String(s || "")
34800 |  42 |         .replace(/\u00a0/g, " ")
34801 |  43 |         .replace(/\s+/g, " ")
34802 |  44 |         .trim()
34803 |  45 |         .toLowerCase();
34804 |  46 | 
34805 |  47 |     function getLabel(el) {
34806 |  48 |       return el.getAttribute?.("aria-label") || el.textContent || "";
34807 |  49 |     }
34808 |  50 | 
34809 |  51 |     if (document.querySelector("div[role='menu']"))
34810 |  52 |       return { ok: true, state: "menu-already-open" };
34811 |  53 | 
34812 |  54 |     const els = Array.from(
34813 |  55 |       document.querySelectorAll(
34814 |  56 |         "button,div[role='button'],span[role='button'],a[role='button']"
34815 |  57 |       )
34816 |  58 |     );
34817 |  59 | 
34818 |  60 |     // Trigger to taki przycisk, kt√≥ry aktualnie pokazuje stan (Najtrafniejsze/Wszystkie/Najnowsze itd.)
34819 |  61 |     // Mo≈ºemy kliknƒÖƒá go, ≈ºeby otworzyƒá menu ‚Äì ALE p√≥≈∫niej wybieramy TYLKO "Wszystkie komentarze".
34820 |  62 |     const btn = els.find((el) => {
34821 |  63 |       const t = norm(getLabel(el));
34822 |  64 |       return (
34823 |  65 |         t === "najtrafniejsze" ||
34824 |  66 |         t === "most relevant" ||
34825 |  67 |         t === "wszystkie komentarze" ||
34826 |  68 |         t === "all comments" ||
34827 |  69 |         t === "najnowsze" ||
34828 |  70 |         t === "newest" ||
34829 |  71 |         t === "poka≈º wszystkie" ||
34830 |  72 |         t === "show all" ||
34831 |  73 |         t === "wy≈õwietl wszystkie" ||
34832 |  74 |         t === "view all"
34833 |  75 |       );
34834 |  76 |     });
34835 |  77 | 
34836 |  78 |     if (!btn) return { ok: false, reason: "no-trigger" };
34837 |  79 | 
34838 |  80 |     try {
34839 |  81 |       btn.scrollIntoView?.({ block: "center", inline: "nearest" });
34840 |  82 |     } catch {}
34841 |  83 | 
34842 |  84 |     try {
34843 |  85 |       btn.click();
34844 |  86 |       return { ok: true, state: "clicked-trigger" };
34845 |  87 |     } catch {
34846 |  88 |       return { ok: false, reason: "click-failed" };
34847 |  89 |     }
34848 |  90 |   });
34849 |  91 | 
34850 |  92 |   return r?.ok === true;
34851 |  93 | }
34852 |  94 | 
34853 |  95 | async function clickMenuOptionByPrefix(page, prefixes) {
34854 |  96 |   return page.evaluate(
34855 |  97 |     (prefixes) => {
34856 |  98 |       const norm = (s) =>
34857 |  99 |         String(s || "")
34858 | 100 |           .replace(/\u00a0/g, " ")
34859 | 101 |           .replace(/\s+/g, " ")
34860 | 102 |           .trim()
34861 | 103 |           .toLowerCase();
34862 | 104 | 
34863 | 105 |       const menu =
34864 | 106 |         document.querySelector("div[role='menu']") ||
34865 | 107 |         document.querySelector("div[role='dialog']");
34866 | 108 |       if (!menu) return { ok: false, reason: "no-menu" };
34867 | 109 | 
34868 | 110 |       const items = Array.from(
34869 | 111 |         menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
34870 | 112 |       );
34871 | 113 | 
34872 | 114 |       const opt = items.find((el) => {
34873 | 115 |         const t = norm(el.textContent);
34874 | 116 |         return prefixes.some((p) => t.startsWith(p));
34875 | 117 |       });
34876 | 118 | 
34877 | 119 |       if (!opt) return { ok: false, reason: "no-opt" };
34878 | 120 | 
34879 | 121 |       try {
34880 | 122 |         opt.scrollIntoView?.({ block: "center", inline: "nearest" });
34881 | 123 |       } catch {}
34882 | 124 | 
34883 | 125 |       try {
34884 | 126 |         opt.click();
34885 | 127 |         return { ok: true };
34886 | 128 |       } catch {
34887 | 129 |         return { ok: false, reason: "click-failed" };
34888 | 130 |       }
34889 | 131 |     },
34890 | 132 |     prefixes
34891 | 133 |   );
34892 | 134 | }
34893 | 135 | 
34894 | 136 | async function switchCommentsFilterToAllLegacy(page) {
34895 | 137 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy na: 'Wszystkie komentarze'‚Ä¶");
34896 | 138 | 
34897 | 139 |   if (!(await page.evaluate(() => !!document.querySelector("div[role='menu']")))) {
34898 | 140 |     const opened = await openCommentsMenu(page);
34899 | 141 |     if (opened) await sleepRandom(250, 450);
34900 | 142 |   }
34901 | 143 | 
34902 | 144 |   const picked = await clickMenuOptionByPrefix(page, [
34903 | 145 |     "wszystkie komentarze",
34904 | 146 |     "all comments",
34905 | 147 |     "poka≈º wszystkie",
34906 | 148 |     "show all",
34907 | 149 |     "wy≈õwietl wszystkie",
34908 | 150 |     "view all",
34909 | 151 |   ]);
34910 | 152 | 
34911 | 153 |   if (picked?.ok) {
34912 | 154 |     await sleepRandom(250, 450);
34913 | 155 |     await page
34914 | 156 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
34915 | 157 |         timeout: 2500,
34916 | 158 |       })
34917 | 159 |       .catch(() => {});
34918 | 160 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
34919 | 161 |     return true;
34920 | 162 |   }
34921 | 163 | 
34922 | 164 |   console.log("[FB][filter] Nie uda≈Ço siƒô ustawiƒá 'Wszystkie komentarze' (best-effort).");
34923 | 165 |   return false;
34924 | 166 | }
34925 | 167 | 
34926 | 168 | /* ============================================================
34927 | 169 |    ===================  EXPAND (LEGACY)  =======================
34928 | 170 |    ============================================================ */
34929 | 171 | 
34930 | 172 | export async function expandAllComments(page) {
34931 | 173 |   if (!EXPAND_COMMENTS) return 0;
34932 | 174 | 
34933 | 175 |   let clicks = 0;
34934 | 176 |   for (let i = 0; i < 30; i++) {
34935 | 177 |     const didClick = await clickOneExpandButton(page);
34936 | 178 |     if (!didClick) break;
34937 | 179 |     clicks++;
34938 | 180 |     await sleepRandom(450, 900);
34939 | 181 |   }
34940 | 182 |   return clicks;
34941 | 183 | }
34942 | 184 | 
34943 | 185 | /* ============================================================
34944 | 186 |    ===================  LICZNIK KOMENTARZY  ====================
34945 | 187 |    ============================================================ */
34946 | 188 | 
34947 | 189 | async function getCommentCountLegacy(page) {
34948 | 190 |   const ui = await getUiCommentInfo(page).catch(() => null);
34949 | 191 | 
34950 | 192 |   const uiCandidates = [
34951 | 193 |     ui?.comments,
34952 | 194 |     ui?.count,
34953 | 195 |     ui?.commentCount,
34954 | 196 |     ui?.commentsCount,
34955 | 197 |     ui?.totalComments,
34956 | 198 |   ].filter((v) => typeof v === "number" && Number.isFinite(v) && v >= 0);
34957 | 199 | 
34958 | 200 |   if (uiCandidates.length) {
34959 | 201 |     const best = Math.max(...uiCandidates);
34960 | 202 |     console.log("[FB][count] UI:", {
34961 | 203 |       best,
34962 | 204 |       candidates: uiCandidates,
34963 | 205 |       source: ui?.source || "ui",
34964 | 206 |       raw: ui?.raw || null,
34965 | 207 |       viewType: ui?.viewType || null,
34966 | 208 |     });
34967 | 209 |     return best;
34968 | 210 |   }
34969 | 211 | 
34970 | 212 |   const uiLoose = await page
34971 | 213 |     .evaluate(() => {
34972 | 214 |       const texts = [];
34973 | 215 |       const pushText = (t) => {
34974 | 216 |         if (!t) return;
34975 | 217 |         const s = String(t).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
34976 | 218 |         if (s) texts.push(s);
34977 | 219 |       };
34978 | 220 | 
34979 | 221 |       const els = Array.from(
34980 | 222 |         document.querySelectorAll("a,button,div[role='button'],span[role='button']")
34981 | 223 |       );
34982 | 224 |       for (const el of els) {
34983 | 225 |         pushText(el.getAttribute?.("aria-label"));
34984 | 226 |         pushText(el.textContent);
34985 | 227 |       }
34986 | 228 | 
34987 | 229 |       const nums = [];
34988 | 230 |       for (const t of texts) {
34989 | 231 |         const low = t.toLowerCase();
34990 | 232 |         let m = low.match(/\b(\d{1,6})\s*(komentarz|komentarze|komentarzy)\b/);
34991 | 233 |         if (m) nums.push(Number(m[1]));
34992 | 234 |         m = low.match(/\b(\d{1,6})\s*(comment|comments)\b/);
34993 | 235 |         if (m) nums.push(Number(m[1]));
34994 | 236 |       }
34995 | 237 | 
34996 | 238 |       if (!nums.length) return { count: null, sample: texts.slice(0, 25) };
34997 | 239 |       return { count: Math.max(...nums), sample: texts.slice(0, 25) };
34998 | 240 |     })
34999 | 241 |     .catch(() => ({ count: null, sample: [] }));
35000 | 242 | 
35001 | 243 |   if (typeof uiLoose?.count === "number" && Number.isFinite(uiLoose.count)) {
35002 | 244 |     console.log("[FB][count] UI-loose:", uiLoose.count);
35003 | 245 |     return uiLoose.count;
35004 | 246 |   }
35005 | 247 | 
35006 | 248 |   if (ui) {
35007 | 249 |     console.log("[FB][count] UI object (no number):", { keys: Object.keys(ui), ui });
35008 | 250 |   } else {
35009 | 251 |     console.log("[FB][count] UI object: null (getUiCommentInfo failed or returned null)");
35010 | 252 |   }
35011 | 253 | 
35012 | 254 |   const anchors = await page.evaluate(() => {
35013 | 255 |     const as = Array.from(
35014 | 256 |       document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
35015 | 257 |     );
35016 | 258 |     const ids = new Set();
35017 | 259 |     for (const a of as) {
35018 | 260 |       try {
35019 | 261 |         const u = new URL(a.href);
35020 | 262 |         const raw = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
35021 | 263 |         if (raw) ids.add(raw);
35022 | 264 |       } catch {}
35023 | 265 |     }
35024 | 266 |     return ids.size;
35025 | 267 |   });
35026 | 268 | 
35027 | 269 |   if (anchors > 0) console.log("[FB][count] anchors-fallback:", anchors);
35028 | 270 |   return anchors > 0 ? anchors : null;
35029 | 271 | }
35030 | 272 | 
35031 | 273 | /* ============================================================
35032 | 274 |    ===================  EKSTRAKCJA KOMENTARZY  =================
35033 | 275 |    ============================================================ */
35034 | 276 | 
35035 | 277 | async function extractCommentsFromDOM(page) {
35036 | 278 |   const data = await page.evaluate(() => {
35037 | 279 |     function extractCommentIdRaw(url) {
35038 | 280 |       const m = url?.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
35039 | 281 |       return m ? decodeURIComponent(m[1]) : null;
35040 | 282 |     }
35041 | 283 | 
35042 | 284 |     function safeAtob(input) {
35043 | 285 |       try {
35044 | 286 |         let s = String(input || "");
35045 | 287 |         s = s.replace(/-/g, "+").replace(/_/g, "/");
35046 | 288 |         while (s.length % 4) s += "=";
35047 | 289 |         return atob(s);
35048 | 290 |       } catch {
35049 | 291 |         return null;
35050 | 292 |       }
35051 | 293 |     }
35052 | 294 | 
35053 | 295 |     function idNumFromRaw(idRaw) {
35054 | 296 |       if (!idRaw) return null;
35055 | 297 |       const s = String(idRaw).trim();
35056 | 298 |       if (/^\d+$/.test(s)) return s;
35057 | 299 | 
35058 | 300 |       const dec = safeAtob(s);
35059 | 301 |       if (dec) {
35060 | 302 |         const m = String(dec).match(/(\d{6,})\s*$/);
35061 | 303 |         if (m) return m[1];
35062 | 304 |       }
35063 | 305 |       const m2 = s.match(/_(\d+)\b/);
35064 | 306 |       return m2 ? m2[1] : null;
35065 | 307 |     }
35066 | 308 | 
35067 | 309 |     function normalizeTime(text) {
35068 | 310 |       if (!text) return null;
35069 | 311 | 
35070 | 312 |       const t = String(text)
35071 | 313 |         .toLowerCase()
35072 | 314 |         .replace(/\u00a0/g, " ")
35073 | 315 |         .replace(/\s+/g, " ")
35074 | 316 |         .trim();
35075 | 317 | 
35076 | 318 |       if (t === "w≈Ça≈õnie teraz" || t === "teraz" || t === "now" || t === "just now") return "0 min";
35077 | 319 |       if (/^\d+\s*(min|min\.|m|minut|minuty|minutƒô|min temu)\b/.test(t)) return t;
35078 | 320 |       if (/^\d+\s*(godz|godz\.|h|hr|hour|hours)\b/.test(t)) return t;
35079 | 321 |       if (/^\d+\s*(sek|sek\.|s|sec|secs|second|seconds)\b/.test(t)) return t;
35080 | 322 |       if (/^\d+\s*(dzie≈Ñ|dni|d|tyg|tyg\.|week|weeks)\b/.test(t)) return t;
35081 | 323 |       if (t.includes("wczoraj") || t.includes("yesterday")) return t;
35082 | 324 | 
35083 | 325 |       return null;
35084 | 326 |     }
35085 | 327 | 
35086 | 328 |     function findTimeAround(linkEl, fallbackNode) {
35087 | 329 |       const root =
35088 | 330 |         linkEl?.closest?.("div[role='article']") ||
35089 | 331 |         linkEl?.closest?.("div[aria-label]") ||
35090 | 332 |         linkEl?.closest?.("div") ||
35091 | 333 |         fallbackNode;
35092 | 334 | 
35093 | 335 |       if (!root) return null;
35094 | 336 | 
35095 | 337 |       const els = root.querySelectorAll("a, abbr, span");
35096 | 338 |       for (const el of els) {
35097 | 339 |         const aria = el.getAttribute?.("aria-label");
35098 | 340 |         const t1 = normalizeTime(aria);
35099 | 341 |         if (t1) return t1;
35100 | 342 | 
35101 | 343 |         const txt = el.textContent?.trim();
35102 | 344 |         const t2 = normalizeTime(txt);
35103 | 345 |         if (t2) return t2;
35104 | 346 |       }
35105 | 347 |       return null;
35106 | 348 |     }
35107 | 349 | 
35108 | 350 |     const nodes = Array.from(
35109 | 351 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
35110 | 352 |     );
35111 | 353 | 
35112 | 354 |     const extracted = nodes
35113 | 355 |       .map((node, idx) => {
35114 | 356 |         const author =
35115 | 357 |           node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
35116 | 358 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
35117 | 359 | 
35118 | 360 |         const linkEl =
35119 | 361 |           node.querySelector("a[href*='reply_comment_id']") ||
35120 | 362 |           node.querySelector("a[href*='comment_id']") ||
35121 | 363 |           node.querySelector('a[role="link"]');
35122 | 364 | 
35123 | 365 |         const href = linkEl?.getAttribute("href") || null;
35124 | 366 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
35125 | 367 | 
35126 | 368 |         const id_raw = permalink ? extractCommentIdRaw(permalink) : null;
35127 | 369 | 
35128 | 370 |         const id = id_raw ? String(id_raw).trim() : null;
35129 | 371 |         const id_num = id_raw ? idNumFromRaw(id_raw) : null;
35130 | 372 | 
35131 | 373 |         const time = findTimeAround(linkEl, node);
35132 | 374 | 
35133 | 375 |         if (!author || !text) return null;
35134 | 376 | 
35135 | 377 |         return { id, id_raw, id_num, author, text, time, permalink, pos: idx + 1 };
35136 | 378 |       })
35137 | 379 |       .filter(Boolean);
35138 | 380 | 
35139 | 381 |     return extracted;
35140 | 382 |   });
35141 | 383 | 
35142 | 384 |   return Array.isArray(data) ? data : [];
35143 | 385 | }
35144 | 386 | 
35145 | 387 | /* ============================================================
35146 | 388 |    ===================  PREPARE / LOAD (LEGACY)  ===============
35147 | 389 |    ============================================================ */
35148 | 390 | 
35149 | 391 | async function prepareLegacy(page, url) {
35150 | 392 |   const ok = await safeGoto(page, url, "comments", {
35151 | 393 |     waitUntil: "networkidle2",
35152 | 394 |     timeout: NAV_TIMEOUT_MS,
35153 | 395 |   });
35154 | 396 | 
35155 | 397 |   if (!ok) throw new Error("safeGoto-failed");
35156 | 398 | 
35157 | 399 |   const currentUrl = page.url();
35158 | 400 |   if (currentUrl.includes("/login")) {
35159 | 401 |     console.log("[FB] /login redirect ‚Üí fbLogin() and back");
35160 | 402 |     await fbLogin(page);
35161 | 403 |     await sleepRandom(3000, 4500);
35162 | 404 | 
35163 | 405 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
35164 | 406 |     console.log("[FB] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
35165 | 407 | 
35166 | 408 |     if (loggedAfterLogin) {
35167 | 409 |       await safeGoto(page, url, "comments", {
35168 | 410 |         waitUntil: "networkidle2",
35169 | 411 |         timeout: NAV_TIMEOUT_MS,
35170 | 412 |       });
35171 | 413 |     }
35172 | 414 |   }
35173 | 415 | 
35174 | 416 |   await acceptCookies(page, "post-initial");
35175 | 417 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
35176 | 418 |   await sleepRandom(900, 1400);
35177 | 419 |   await acceptCookies(page, "post");
35178 | 420 | 
35179 | 421 |   try {
35180 | 422 |     const logged = await checkIfLogged(page).catch(() => false);
35181 | 423 |     if (logged) await saveCookies(page);
35182 | 424 |   } catch {}
35183 | 425 | 
35184 | 426 |   await scrollPost(page, 140).catch(() => {});
35185 | 427 |   await sleepRandom(500, 800);
35186 | 428 | 
35187 | 429 |   // ‚úÖ TYLKO "Wszystkie komentarze / Poka≈º wszystkie"
35188 | 430 |   // ‚ùå NIE DOTYKAMY sortowania ("Najnowsze") w og√≥le
35189 | 431 |   await switchCommentsFilterToAllLegacy(page).catch(() => false);
35190 | 432 |   await sleepRandom(250, 450);
35191 | 433 | }
35192 | 434 | 
35193 | 435 | async function loadAllCommentsLegacy(page, opts = {}) {
35194 | 436 |   if (!EXPAND_COMMENTS) return;
35195 | 437 | 
35196 | 438 |   const expected = Number.isFinite(opts.expectedTotal) ? Number(opts.expectedTotal) : null;
35197 | 439 | 
35198 | 440 |   const MAX_ROUNDS = opts.maxRounds ?? 35;
35199 | 441 |   const STABLE_ROUNDS = opts.stableRounds ?? 4;
35200 | 442 |   const MAX_NO_PROGRESS = opts.maxNoProgress ?? 10;
35201 | 443 |   const CLICKS_PER_ROUND = opts.clicksPerRound ?? 10;
35202 | 444 | 
35203 | 445 |   console.log("[FB][load] start", { expected });
35204 | 446 | 
35205 | 447 |   function uniqAnchorCountEval() {
35206 | 448 |     return page.evaluate(() => {
35207 | 449 |       const as = Array.from(
35208 | 450 |         document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
35209 | 451 |       );
35210 | 452 |       const ids = new Set();
35211 | 453 |       for (const a of as) {
35212 | 454 |         const href = a.getAttribute("href") || "";
35213 | 455 |         const m = href.match(/(?:comment_id|reply_comment_id)=([^&]+)/);
35214 | 456 |         if (m && m[1]) ids.add(m[1]);
35215 | 457 |       }
35216 | 458 |       return ids.size;
35217 | 459 |     });
35218 | 460 |   }
35219 | 461 | 
35220 | 462 |   function commentNodesCountEval() {
35221 | 463 |     return page.evaluate(() => {
35222 | 464 |       const nodes = document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k");
35223 | 465 |       return nodes ? nodes.length : 0;
35224 | 466 |     });
35225 | 467 |   }
35226 | 468 | 
35227 | 469 |   function hasMoreButtonsEval() {
35228 | 470 |     return page.evaluate(() => {
35229 | 471 |       const norm = (s) =>
35230 | 472 |         String(s || "")
35231 | 473 |           .replace(/\u00a0/g, " ")
35232 | 474 |           .replace(/\s+/g, " ")
35233 | 475 |           .trim()
35234 | 476 |           .toLowerCase();
35235 | 477 | 
35236 | 478 |       const btns = Array.from(
35237 | 479 |         document.querySelectorAll("div[role='button'], button, span[role='button']")
35238 | 480 |       );
35239 | 481 |       return btns.some((b) => {
35240 | 482 |         const t = norm(b.getAttribute("aria-label") || b.textContent);
35241 | 483 |         return (
35242 | 484 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
35243 | 485 |           t.includes("zobacz wiƒôcej komentarzy") ||
35244 | 486 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
35245 | 487 |           t.includes("more comments") ||
35246 | 488 |           t.includes("view more comments") ||
35247 | 489 |           t.includes("view previous comments") ||
35248 | 490 |           t.includes("zobacz wiƒôcej odpowiedzi") ||
35249 | 491 |           t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
35250 | 492 |           t.includes("more replies") ||
35251 | 493 |           t.includes("view more replies")
35252 | 494 |         );
35253 | 495 |       });
35254 | 496 |     });
35255 | 497 |   }
35256 | 498 | 
35257 | 499 |   let anchors = await uniqAnchorCountEval().catch(() => 0);
35258 | 500 |   let nodes = await commentNodesCountEval().catch(() => 0);
35259 | 501 | 
35260 | 502 |   let stable = 0;
35261 | 503 |   let noProgress = 0;
35262 | 504 | 
35263 | 505 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
35264 | 506 |     let clicks = 0;
35265 | 507 |     for (let i = 0; i < CLICKS_PER_ROUND; i++) {
35266 | 508 |       const did = await clickOneExpandButton(page).catch(() => false);
35267 | 509 |       if (!did) break;
35268 | 510 |       clicks++;
35269 | 511 |       await sleepRandom(250, 450);
35270 | 512 |     }
35271 | 513 | 
35272 | 514 |     await scrollPost(page, 220).catch(() => {});
35273 | 515 |     await sleepRandom(400, 700);
35274 | 516 | 
35275 | 517 |     const nextAnchors = await uniqAnchorCountEval().catch(() => anchors);
35276 | 518 |     const nextNodes = await commentNodesCountEval().catch(() => nodes);
35277 | 519 |     const moreBtns = await hasMoreButtonsEval().catch(() => false);
35278 | 520 | 
35279 | 521 |     const progressed = nextAnchors > anchors || nextNodes > nodes || clicks > 0;
35280 | 522 | 
35281 | 523 |     if (progressed) {
35282 | 524 |       anchors = nextAnchors;
35283 | 525 |       nodes = nextNodes;
35284 | 526 |       stable = 0;
35285 | 527 |       noProgress = 0;
35286 | 528 |     } else {
35287 | 529 |       stable++;
35288 | 530 |       noProgress++;
35289 | 531 |     }
35290 | 532 | 
35291 | 533 |     console.log(
35292 | 534 |       `[FB][load] round ${round}: anchors ${anchors} -> ${nextAnchors}, nodes ${nodes} -> ${nextNodes}, clicks=${clicks}, stable=${stable}/${STABLE_ROUNDS}, moreBtns=${moreBtns}, noProgress=${noProgress}/${MAX_NO_PROGRESS}`
35293 | 535 |     );
35294 | 536 | 
35295 | 537 |     const stableEnough = stable >= STABLE_ROUNDS;
35296 | 538 | 
35297 | 539 |     if (!moreBtns && stableEnough) {
35298 | 540 |       console.log("[FB][load] stop: no more buttons + stable");
35299 | 541 |       break;
35300 | 542 |     }
35301 | 543 | 
35302 | 544 |     const reachedExpected =
35303 | 545 |       expected != null && Number.isFinite(expected) && expected >= 0 && nextNodes >= expected;
35304 | 546 |     if (reachedExpected && stableEnough && !moreBtns) {
35305 | 547 |       console.log("[FB][load] stop: expected reached (by nodes) + stable + no more buttons");
35306 | 548 |       break;
35307 | 549 |     }
35308 | 550 | 
35309 | 551 |     if (stableEnough && moreBtns) {
35310 | 552 |       console.log("[FB][load] rescue: stable but still buttons -> deep scroll + wait");
35311 | 553 |       await scrollPost(page, 520).catch(() => {});
35312 | 554 |       await sleepRandom(1000, 1600);
35313 | 555 |       stable = 0;
35314 | 556 |       continue;
35315 | 557 |     }
35316 | 558 | 
35317 | 559 |     if (noProgress >= MAX_NO_PROGRESS) {
35318 | 560 |       if (moreBtns) {
35319 | 561 |         console.log("[FB][load] last-rescue: no-progress but still buttons -> deep scroll + wait");
35320 | 562 |         await scrollPost(page, 650).catch(() => {});
35321 | 563 |         await sleepRandom(1400, 1900);
35322 | 564 |         stable = 0;
35323 | 565 |         noProgress = 0;
35324 | 566 |         continue;
35325 | 567 |       }
35326 | 568 | 
35327 | 569 |       console.log("[FB][load] stop: too many no-progress rounds");
35328 | 570 |       break;
35329 | 571 |     }
35330 | 572 | 
35331 | 573 |     anchors = nextAnchors;
35332 | 574 |     nodes = nextNodes;
35333 | 575 |   }
35334 | 576 | 
35335 | 577 |   const finalAnchors = await uniqAnchorCountEval().catch(() => anchors);
35336 | 578 |   const finalNodes = await commentNodesCountEval().catch(() => nodes);
35337 | 579 |   console.log("[FB][load] done:", { anchors: finalAnchors, nodes: finalNodes });
35338 | 580 | }
35339 | 581 | 
35340 | 582 | /* ============================================================
35341 | 583 |    ===================  PUBLIC API (ROUTED)  ===================
35342 | 584 |    ============================================================ */
35343 | 585 | 
35344 | 586 | export async function prepare(page, url) {
35345 | 587 |   const ui = pickUiHandler(url);
35346 | 588 |   if (ui?.prepare) {
35347 | 589 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} prepare`);
35348 | 590 |     return ui.prepare(page, url);
35349 | 591 |   }
35350 | 592 |   console.log("[FB][router] UI -> legacy prepare");
35351 | 593 |   return prepareLegacy(page, url);
35352 | 594 | }
35353 | 595 | 
35354 | 596 | export async function getCommentCount(page, url) {
35355 | 597 |   const ui = pickUiHandler(url || page.url());
35356 | 598 |   if (ui?.getCommentCount) {
35357 | 599 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} getCommentCount`);
35358 | 600 |     return ui.getCommentCount(page, url);
35359 | 601 |   }
35360 | 602 |   console.log("[FB][router] UI -> legacy getCommentCount");
35361 | 603 |   return getCommentCountLegacy(page);
35362 | 604 | }
35363 | 605 | 
35364 | 606 | export async function loadAllComments(page, opts = {}, url = null) {
35365 | 607 |   if (!EXPAND_COMMENTS) return;
35366 | 608 | 
35367 | 609 |   const finalUrl = url || page.url();
35368 | 610 |   const ui = pickUiHandler(finalUrl);
35369 | 611 | 
35370 | 612 |   if (ui?.loadAllComments) {
35371 | 613 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} loadAllComments`);
35372 | 614 |     return ui.loadAllComments(page, { expectedTotal: opts.expectedTotal });
35373 | 615 |   }
35374 | 616 | 
35375 | 617 |   console.log("[FB][router] UI -> legacy loadAllComments");
35376 | 618 |   return loadAllCommentsLegacy(page, opts);
35377 | 619 | }
35378 | 620 | 
35379 | 621 | export async function extractCommentsData(page, url = null) {
35380 | 622 |   const finalUrl = url || page.url();
35381 | 623 |   const ui = pickUiHandler(finalUrl);
35382 | 624 | 
35383 | 625 |   if (ui?.extractComments) {
35384 | 626 |     console.log(`[FB][router] UI -> ${ui.type || "unknown"} extractComments`);
35385 | 627 |     const out = await ui.extractComments(page, finalUrl);
35386 | 628 |     return Array.isArray(out) ? out : [];
35387 | 629 |   }
35388 | 630 | 
35389 | 631 |   const out = await extractCommentsFromDOM(page);
35390 | 632 |   return Array.isArray(out) ? out : [];
35391 | 633 | }
35392 | 634 | 
35393 | ```
35394 | 
35395 | ---
35396 | 
35397 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/comments.legacy.js`
35398 | **Typ:** JavaScript/tekst  
35399 | **Opis:** Plik projektu (kod/konfiguracja).  
35400 | 
35401 | ```js
35402 |    1 | // src/fb/comments.js
35403 |    2 | // src/fb/legacy/comments.legacy.js
35404 |    3 | import { EXPAND_COMMENTS } from "../../config.js";
35405 |    4 | import { sleepRandom } from "../../utils/sleep.js";
35406 |    5 | import { safeGoto } from "../../utils/navigation.js";
35407 |    6 | 
35408 |    7 | import { scrollPost } from "../scroll.js";
35409 |    8 | import { acceptCookies, saveCookies } from "../cookies.js";
35410 |    9 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
35411 |   10 | import { clickOneExpandButton } from "../expandButtons.js";
35412 |   11 | import { getUiCommentInfo } from "../uiCommentInfo.js";
35413 |   12 | 
35414 |   13 | 
35415 |   14 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS
35416 |   15 |   ? Number(process.env.NAV_TIMEOUT_MS)
35417 |   16 |   : 90000; // by≈Ço 60000, podbijamy do 90s
35418 |   17 | 
35419 |   18 | let firstPostPauseDone = false;
35420 |   19 | /* ============================================================
35421 |   20 |    =======  PRZE≈ÅƒÑCZANIE FILTRA ‚ÄûWSZYSTKIE KOMENTARZE‚Äù  ========
35422 |   21 |    ============================================================ */
35423 |   22 | 
35424 |   23 | async function switchCommentsFilterToAll(page) {
35425 |   24 |   console.log("[FB][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
35426 |   25 | 
35427 |   26 |   // 1) je≈õli menu ju≈º jest otwarte ‚Äì nie klikamy ponownie, tylko pr√≥bujemy wybraƒá opcjƒô "Wszystkie komentarze" z istniejƒÖcego menu
35428 |   27 |   const menuAlreadyOpen = await page.evaluate(() => {
35429 |   28 |     return !!document.querySelector("div[role='menu']");
35430 |   29 |   });
35431 |   30 | 
35432 |   31 |   if (menuAlreadyOpen) {
35433 |   32 |     console.log("[FB][filter] Menu filtra ju≈º otwarte ‚Äì pr√≥bujƒô wybraƒá opcjƒô.");
35434 |   33 | 
35435 |   34 |     const menuResult = await clickAllCommentsInMenu(page);
35436 |   35 |     if (menuResult.clicked) {
35437 |   36 |       console.log("[FB][filter] Wybrano 'Wszystkie komentarze' z otwartego menu.");
35438 |   37 |       return true;
35439 |   38 |     }
35440 |   39 |     console.log("[FB][filter] Menu otwarte, ale nie ma opcji 'Wszystkie komentarze'.");
35441 |   40 |     return false;
35442 |   41 |   }
35443 |   42 | 
35444 |   43 |   // 2) spr√≥buj znale≈∫ƒá bie≈ºƒÖcy przycisk filtra i sprawdziƒá, co jest ustawione
35445 |   44 |   const pre = await page.evaluate(() => {
35446 |   45 |     const els = Array.from(
35447 |   46 |       document.querySelectorAll("div[role='button'], span[role='button']")
35448 |   47 |     );
35449 |   48 |     let filterEl = null;
35450 |   49 |     let labelText = "";
35451 |   50 |     for (const el of els) {
35452 |   51 |       const t = (el.textContent || "").trim();
35453 |   52 |       if (!t) continue;
35454 |   53 |       const low = t.toLowerCase();
35455 |   54 |       if (
35456 |   55 |         low === "najtrafniejsze" ||
35457 |   56 |         low === "most relevant" ||
35458 |   57 |         low === "wszystkie komentarze" ||
35459 |   58 |         low === "all comments"
35460 |   59 |       ) {
35461 |   60 |         filterEl = el;
35462 |   61 |         labelText = low;
35463 |   62 |         break;
35464 |   63 |       }
35465 |   64 |     }
35466 |   65 |     if (!filterEl) {
35467 |   66 |       return { state: "not-found" };
35468 |   67 |     }
35469 |   68 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
35470 |   69 |       return { state: "already-all" };
35471 |   70 |     }
35472 |   71 |     filterEl.click();
35473 |   72 |     return { state: "clicked-filter" };
35474 |   73 |   });
35475 |   74 | 
35476 |   75 |   if (pre.state === "not-found") {
35477 |   76 |     console.log("[FB][filter] Nie znaleziono przycisku filtra komentarzy.");
35478 |   77 |     return false;
35479 |   78 |   }
35480 |   79 |   if (pre.state === "already-all") {
35481 |   80 |     console.log("[FB][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' ‚Äì pomijam.");
35482 |   81 |     return true;
35483 |   82 |   }
35484 |   83 |   if (pre.state === "clicked-filter") {
35485 |   84 |     await sleepRandom(400, 800);
35486 |   85 |     const menuResult = await clickAllCommentsInMenu(page);
35487 |   86 |     if (!menuResult.clicked && menuResult.noMenu) {
35488 |   87 |       // fallback: mo≈ºe filtr prze≈ÇƒÖcza siƒô bez menu ‚Äì sprawdzamy label jeszcze raz
35489 |   88 |       const afterLabelIsAll = await page.evaluate(() => {
35490 |   89 |         const els = Array.from(
35491 |   90 |           document.querySelectorAll("div[role='button'], span[role='button']")
35492 |   91 |         );
35493 |   92 |         const btn = els.find((el) => {
35494 |   93 |           const t = (el.textContent || "").trim().toLowerCase();
35495 |   94 |           return t === "wszystkie komentarze" || t === "all comments";
35496 |   95 |         });
35497 |   96 |         return !!btn;
35498 |   97 |       });
35499 |   98 |       if (afterLabelIsAll) {
35500 |   99 |         console.log(
35501 |  100 |           "[FB][filter] Po klikniƒôciu filtr prze≈ÇƒÖczy≈Ç siƒô bez menu na 'Wszystkie komentarze'."
35502 |  101 |         );
35503 |  102 |         return true;
35504 |  103 |       }
35505 |  104 |       console.log(
35506 |  105 |         "[FB][filter] Klikniƒôto filtr, ale nie pojawi≈Ço siƒô menu i label nie jest 'Wszystkie komentarze'."
35507 |  106 |       );
35508 |  107 |       return false;
35509 |  108 |     }
35510 |  109 |     if (!menuResult.clicked && !menuResult.noMenu) {
35511 |  110 |       console.log("[FB][filter] Menu filtra jest, ale brak opcji 'Wszystkie komentarze'.");
35512 |  111 |       return false;
35513 |  112 |     }
35514 |  113 |     console.log("[FB][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze'.");
35515 |  114 |     return true;
35516 |  115 |   }
35517 |  116 |   console.log("[FB][filter] Nieoczekiwany stan w switchCommentsFilterToAll:", pre);
35518 |  117 |   return false;
35519 |  118 | }
35520 |  119 | 
35521 |  120 | async function clickShowAllCommentsIfPresent(page) {
35522 |  121 |   console.log("[FB][show-all] Pr√≥ba klikniƒôcia 'Poka≈º wszystkie' (aria-label)‚Ä¶");
35523 |  122 | 
35524 |  123 |   try {
35525 |  124 |     const clicked = await page.evaluate(() => {
35526 |  125 |       // Je≈õli filtr ju≈º jest, to znaczy ≈ºe "Poka≈º wszystkie" zosta≈Ço klikniƒôte / niepotrzebne
35527 |  126 |       const bodyText = (document.body.innerText || "").toLowerCase();
35528 |  127 |       if (
35529 |  128 |         bodyText.includes("najtrafniejsze") ||
35530 |  129 |         bodyText.includes("najnowsze") ||
35531 |  130 |         bodyText.includes("wszystkie komentarze") ||
35532 |  131 |         bodyText.includes("all comments") ||
35533 |  132 |         bodyText.includes("ukryj komentarze") ||
35534 |  133 |         bodyText.includes("hide comments")
35535 |  134 |       ) {
35536 |  135 |         return false;
35537 |  136 |       }
35538 |  137 |       const selectors = [
35539 |  138 |         "div[aria-label='Poka≈º wszystkie'][role='button']",
35540 |  139 |         "div[aria-label='Wy≈õwietl wszystkie'][role='button']",
35541 |  140 |         "div[aria-label='Show all'][role='button']",
35542 |  141 |         "div[aria-label='View all'][role='button']",
35543 |  142 |       ];
35544 |  143 |       let el = null;
35545 |  144 |       for (const sel of selectors) {
35546 |  145 |         el = document.querySelector(sel);
35547 |  146 |         if (el) break;
35548 |  147 |       }
35549 |  148 |       if (!el) return false;
35550 |  149 |       try {
35551 |  150 |         el.scrollIntoView({ block: "center", inline: "nearest" });
35552 |  151 |       } catch (e) {
35553 |  152 |         // scrollIntoView nie musi siƒô udaƒá
35554 |  153 |       }
35555 |  154 |       if (typeof el.click === "function") {
35556 |  155 |         el.click();
35557 |  156 |         return true;
35558 |  157 |       }
35559 |  158 |       return false;
35560 |  159 |     });
35561 |  160 |     if (!clicked) {
35562 |  161 |       console.log(
35563 |  162 |         "[FB][show-all] Nie znaleziono aria-label='Poka≈º wszystkie' albo filtr ju≈º widoczny ‚Äì pomijam."
35564 |  163 |       );
35565 |  164 |       return false;
35566 |  165 |     }
35567 |  166 |     console.log("[FB][show-all] Klikniƒôto 'Poka≈º wszystkie' (aria-label).");
35568 |  167 |     await sleepRandom(900, 1600);
35569 |  168 |     return true;
35570 |  169 |   } catch (err) {
35571 |  170 |     console.log(
35572 |  171 |       "[FB][show-all] B≈ÇƒÖd podczas klikania 'Poka≈º wszystkie':",
35573 |  172 |       err?.message || err
35574 |  173 |     );
35575 |  174 |     return false;
35576 |  175 |   }
35577 |  176 | }
35578 |  177 | import fs from 'fs';
35579 |  178 | 
35580 |  179 | async function extractCommentsFromDOM(page) {
35581 |  180 |   const data = await page.evaluate(() => {
35582 |  181 |     function extractCommentId(url) {
35583 |  182 |       const match = url?.match(/comment_id=([^&]+)/);
35584 |  183 |       return match ? decodeURIComponent(match[1]) : null;
35585 |  184 |     }
35586 |  185 | 
35587 |  186 |     // Mapa commentId -> time
35588 |  187 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
35589 |  188 |     const idToTimeMap = {};
35590 |  189 | 
35591 |  190 |     for (let i = 0; i < allLinks.length; i++) {
35592 |  191 |       const link = allLinks[i];
35593 |  192 |       const href = link.getAttribute('href') || '';
35594 |  193 |       const id = extractCommentId(href);
35595 |  194 | 
35596 |  195 |       if (id) {
35597 |  196 |         // Szukamy nastƒôpnego linka z tekstem typu "1 godz.", "2 dni" itd.
35598 |  197 |         for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
35599 |  198 |           const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
35600 |  199 |           if (timeText && /^\d+\s?(min|godz|sek|dni|tyg)/.test(timeText)) {
35601 |  200 |             idToTimeMap[id] = timeText;
35602 |  201 |             break;
35603 |  202 |           }
35604 |  203 |         }
35605 |  204 |       }
35606 |  205 |     }
35607 |  206 | 
35608 |  207 |     const commentNodes = Array.from(
35609 |  208 |       document.querySelectorAll('div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k')
35610 |  209 |     );
35611 |  210 | 
35612 |  211 |     const extracted = commentNodes.map((node) => {
35613 |  212 |       try {
35614 |  213 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim();
35615 |  214 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim();
35616 |  215 |         const linkEl = node.querySelector('a[role="link"]');
35617 |  216 |         const href = linkEl?.getAttribute('href');
35618 |  217 |         const permalink = href?.startsWith('http') ? href : `https://www.facebook.com${href}`;
35619 |  218 |         const id = extractCommentId(permalink) || null;
35620 |  219 | 
35621 |  220 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
35622 |  221 | 
35623 |  222 |         if (!author || !text) return null;
35624 |  223 | 
35625 |  224 |         return { id, author, text, permalink, time };
35626 |  225 |       } catch (err) {
35627 |  226 |         return null;
35628 |  227 |       }
35629 |  228 |     }).filter(Boolean);
35630 |  229 | 
35631 |  230 |     return extracted;
35632 |  231 |   });
35633 |  232 | 
35634 |  233 |   console.log('[FB] extractCommentsFromDOM ‚Äì wyciƒÖgniƒôto komentarzy:', data.length);
35635 |  234 |   console.log('[DBG] Komentarze:', JSON.stringify(data, null, 2));
35636 |  235 | 
35637 |  236 |   return data;
35638 |  237 | }
35639 |  238 | 
35640 |  239 | 
35641 |  240 | 
35642 |  241 | 
35643 |  242 | /* ============================================================
35644 |  243 |    =========== POST ROOT (DIALOG / MAIN / FALLBACK) ============
35645 |  244 |    ============================================================ */
35646 |  245 | 
35647 |  246 | async function clickAllCommentsInMenu(page) {
35648 |  247 |   const result = await page.evaluate(() => {
35649 |  248 |     const menu =
35650 |  249 |       document.querySelector("div[role='menu']") ||
35651 |  250 |       document.querySelector("div[role='dialog']");
35652 |  251 |     if (!menu) {
35653 |  252 |       return { clicked: false, noMenu: true };
35654 |  253 |     }
35655 |  254 |     const items = Array.from(
35656 |  255 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
35657 |  256 |     );
35658 |  257 |     const opt = items.find((el) => {
35659 |  258 |       const t = (el.textContent || "").trim().toLowerCase();
35660 |  259 |       return (
35661 |  260 |         t.startsWith("wszystkie komentarze") ||
35662 |  261 |         t.startsWith("all comments")
35663 |  262 |       );
35664 |  263 |     });
35665 |  264 |     if (!opt) {
35666 |  265 |       return { clicked: false, noMenu: false };
35667 |  266 |     }
35668 |  267 |     opt.click();
35669 |  268 |     setTimeout(() => {
35670 |  269 |       try {
35671 |  270 |         document.body.click();
35672 |  271 |       } catch {}
35673 |  272 |     }, 50);
35674 |  273 |     return { clicked: true, noMenu: false };
35675 |  274 |   });
35676 |  275 |   if (result.clicked) {
35677 |  276 |     await sleepRandom(300, 600);
35678 |  277 |     await page
35679 |  278 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), {
35680 |  279 |         timeout: 2000,
35681 |  280 |       })
35682 |  281 |       .catch(() => {});
35683 |  282 |   }
35684 |  283 |   return result;
35685 |  284 | }
35686 |  285 | 
35687 |  286 | /* ============================================================
35688 |  287 |    ===== POMOCNICZE: LICZENIE ID KOMENTARZY ====================
35689 |  288 |    ============================================================ */
35690 |  289 | 
35691 |  290 | function postRootScript() {
35692 |  291 |   return `
35693 |  292 |     function getPostRoot() {
35694 |  293 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
35695 |  294 |       const postDialog = dialogs.find((dlg) => {
35696 |  295 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
35697 |  296 |         if (!text) return false;
35698 |  297 |         const hasCommentWord =
35699 |  298 |           text.includes("komentarz") || text.includes("comment");
35700 |  299 |         const hasActions =
35701 |  300 |           text.includes("lubiƒô to") ||
35702 |  301 |           text.includes("komentarz") ||
35703 |  302 |           text.includes("udostƒôpnij") ||
35704 |  303 |           text.includes("napisz komentarz") ||
35705 |  304 |           text.includes("comment");
35706 |  305 |         const looksLikeNotifications =
35707 |  306 |           text.startsWith("powiadomienia") &&
35708 |  307 |           text.includes("wszystkie") &&
35709 |  308 |           text.includes("nieprzeczytane");
35710 |  309 |         return !looksLikeNotifications && hasCommentWord && hasActions;
35711 |  310 |       });
35712 |  311 |       if (postDialog) return postDialog;
35713 |  312 |       const main = document.querySelector("div[role='main']");
35714 |  313 |       if (main) {
35715 |  314 |         const article = main.querySelector("article");
35716 |  315 |         return article || main;
35717 |  316 |       }
35718 |  317 |       return document.body;
35719 |  318 |     }
35720 |  319 |   `;
35721 |  320 | }
35722 |  321 | 
35723 |  322 | async function getCurrentCommentAnchorCount(page) {
35724 |  323 |   const count = await page.evaluate(() => {
35725 |  324 |     const anchors = Array.from(
35726 |  325 |       document.querySelectorAll(
35727 |  326 |         "a[href*='comment_id'], a[href*='reply_comment_id']"
35728 |  327 |       )
35729 |  328 |     );
35730 |  329 |     const ids = new Set();
35731 |  330 |     for (const a of anchors) {
35732 |  331 |       try {
35733 |  332 |         const url = new URL(a.href);
35734 |  333 |         const cid = url.searchParams.get("comment_id");
35735 |  334 |         const rid = url.searchParams.get("reply_comment_id");
35736 |  335 |         let raw = rid || cid;
35737 |  336 |         if (!raw) continue;
35738 |  337 |         if (!/^\d+$/.test(raw)) {
35739 |  338 |           try {
35740 |  339 |             const dec = atob(raw);
35741 |  340 |             const m = dec.match(/:(\d+)_([0-9]+)/);
35742 |  341 |             if (m) raw = m[2];
35743 |  342 |           } catch {}
35744 |  343 |         }
35745 |  344 |         if (raw) ids.add(raw);
35746 |  345 |       } catch {}
35747 |  346 |     }
35748 |  347 |     return ids.size;
35749 |  348 |   });
35750 |  349 |   return count || 0;
35751 |  350 | }
35752 |  351 | 
35753 |  352 | /* ============================================================
35754 |  353 |    ======= SCROLL W OBRƒòBIE POSTA (DIALOG/MAIN/FALLBACK) =======
35755 |  354 |    ============================================================ */
35756 |  355 | 
35757 |  356 | async function scrollWithinPost(page, label, factor = 0.3) {
35758 |  357 |   const info = await page.evaluate(
35759 |  358 |     (factorArg, labelArg, postRootCode) => {
35760 |  359 |       const href = location.href;
35761 |  360 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
35762 |  361 |         href
35763 |  362 |       );
35764 |  363 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
35765 |  364 |       // wstrzykujemy funkcjƒô getPostRoot
35766 |  365 |       // eslint-disable-next-line no-eval
35767 |  366 |       eval(postRootCode);
35768 |  367 |       // @ts-ignore
35769 |  368 |       const rootFn =
35770 |  369 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
35771 |  370 |       function pushIfScrollable(list, el, labelName) {
35772 |  371 |         if (!el) return;
35773 |  372 |         const style = window.getComputedStyle(el);
35774 |  373 |         if (!style) return;
35775 |  374 |         const oy = style.overflowY;
35776 |  375 |         const clientH = el.clientHeight || 0;
35777 |  376 |         const scrollH = el.scrollHeight || 0;
35778 |  377 |         const delta = scrollH - clientH;
35779 |  378 |         if (
35780 |  379 |           clientH > 0 &&
35781 |  380 |           delta > 10 &&
35782 |  381 |           (oy === "auto" ||
35783 |  382 |             oy === "scroll" ||
35784 |  383 |             oy === "overlay" ||
35785 |  384 |             oy === "hidden")
35786 |  385 |         ) {
35787 |  386 |           list.push({ el, label: labelName, delta });
35788 |  387 |         }
35789 |  388 |       }
35790 |  389 |       let container = null;
35791 |  390 |       let containerType = null;
35792 |  391 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
35793 |  392 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
35794 |  393 |       if (cached) {
35795 |  394 |         container = cached;
35796 |  395 |         containerType = "cached-comments";
35797 |  396 |       }
35798 |  397 |       // ===== PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy "oficjalny" panel komentarzy =====
35799 |  398 |       if (!container && (isPhotoView || isVideoView)) {
35800 |  399 |         const moreCommentsBtn = Array.from(
35801 |  400 |           document.querySelectorAll(
35802 |  401 |             "button, div[role='button'], span[role='button']"
35803 |  402 |           )
35804 |  403 |         ).find((el) => {
35805 |  404 |           const t = (el.textContent || "").toLowerCase();
35806 |  405 |           return (
35807 |  406 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
35808 |  407 |             t.includes("zobacz wiƒôcej komentarzy") ||
35809 |  408 |             t.includes("view more comments") ||
35810 |  409 |             t.includes("view previous comments")
35811 |  410 |           );
35812 |  411 |         });
35813 |  412 |         if (moreCommentsBtn) {
35814 |  413 |           let p = moreCommentsBtn.parentElement;
35815 |  414 |           while (p && p !== document.body && p !== document.documentElement) {
35816 |  415 |             const style = window.getComputedStyle(p);
35817 |  416 |             const oy = style.overflowY;
35818 |  417 |             const ch = p.clientHeight || 0;
35819 |  418 |             const sh = p.scrollHeight || 0;
35820 |  419 |             const delta = sh - ch;
35821 |  420 |             if (
35822 |  421 |               ch > 0 &&
35823 |  422 |               delta > 10 &&
35824 |  423 |               (oy === "auto" ||
35825 |  424 |                 oy === "scroll" ||
35826 |  425 |                 oy === "overlay" ||
35827 |  426 |                 oy === "hidden")
35828 |  427 |             ) {
35829 |  428 |               container = p;
35830 |  429 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
35831 |  430 |               break;
35832 |  431 |             }
35833 |  432 |             p = p.parentElement;
35834 |  433 |           }
35835 |  434 |         }
35836 |  435 |         // VIDEO ‚Äì dodatkowa pr√≥ba: po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
35837 |  436 |         if (!container && isVideoView) {
35838 |  437 |           const commentsHeader = Array.from(
35839 |  438 |             document.querySelectorAll("div, span")
35840 |  439 |           ).find((el) => {
35841 |  440 |             const t = (el.textContent || "").toLowerCase();
35842 |  441 |             return (
35843 |  442 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
35844 |  443 |               (t.includes("comments") && t.includes("most relevant")) ||
35845 |  444 |               t.trim() === "komentarze" ||
35846 |  445 |               t.trim() === "comments"
35847 |  446 |             );
35848 |  447 |           });
35849 |  448 |           if (commentsHeader) {
35850 |  449 |             let p = commentsHeader.parentElement;
35851 |  450 |             while (p && p !== document.body && p !== document.documentElement) {
35852 |  451 |               const style = window.getComputedStyle(p);
35853 |  452 |               const oy = style.overflowY;
35854 |  453 |               const ch = p.clientHeight || 0;
35855 |  454 |               const sh = p.scrollHeight || 0;
35856 |  455 |               const delta = sh - ch;
35857 |  456 |               if (
35858 |  457 |                 ch > 0 &&
35859 |  458 |                 delta > 10 &&
35860 |  459 |                 (oy === "auto" ||
35861 |  460 |                   oy === "scroll" ||
35862 |  461 |                   oy === "overlay" ||
35863 |  462 |                   oy === "hidden")
35864 |  463 |               ) {
35865 |  464 |                 container = p;
35866 |  465 |                 containerType = "video-comments-header";
35867 |  466 |                 break;
35868 |  467 |               }
35869 |  468 |               p = p.parentElement;
35870 |  469 |             }
35871 |  470 |           }
35872 |  471 |         }
35873 |  472 |         // dodatkowy fallback na VIDEO ‚Äì po polu "Napisz komentarz..."
35874 |  473 |         if (!container && isVideoView) {
35875 |  474 |           const commentBox = Array.from(
35876 |  475 |             document.querySelectorAll("div[role='textbox'], textarea")
35877 |  476 |           ).find((el) => {
35878 |  477 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
35879 |  478 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
35880 |  479 |             const txt = (el.textContent || "").toLowerCase();
35881 |  480 |             const needles = [
35882 |  481 |               "napisz komentarz",
35883 |  482 |               "write a comment",
35884 |  483 |               "escribe un comentario",
35885 |  484 |               "schreibe einen kommentar",
35886 |  485 |             ];
35887 |  486 |             return needles.some((n) =>
35888 |  487 |               label.includes(n) || ph.includes(n) || txt.includes(n)
35889 |  488 |             );
35890 |  489 |           });
35891 |  490 |           if (commentBox) {
35892 |  491 |             let p = commentBox.parentElement;
35893 |  492 |             while (p && p !== document.body && p !== document.documentElement) {
35894 |  493 |               const style = window.getComputedStyle(p);
35895 |  494 |               const oy = style.overflowY;
35896 |  495 |               const ch = p.clientHeight || 0;
35897 |  496 |               const sh = p.scrollHeight || 0;
35898 |  497 |               const delta = sh - ch;
35899 |  498 |               if (
35900 |  499 |                 ch > 0 &&
35901 |  500 |                 delta > 10 &&
35902 |  501 |                 (oy === "auto" ||
35903 |  502 |                   oy === "scroll" ||
35904 |  503 |                   oy === "overlay" ||
35905 |  504 |                   oy === "hidden")
35906 |  505 |               ) {
35907 |  506 |                 container = p;
35908 |  507 |                 containerType = "video-comments-textbox";
35909 |  508 |                 break;
35910 |  509 |               }
35911 |  510 |               p = p.parentElement;
35912 |  511 |             }
35913 |  512 |           }
35914 |  513 |         }
35915 |  514 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì nie ruszamy okna
35916 |  515 |         if (isVideoView && !container) {
35917 |  516 |           const cur = window.scrollY || 0;
35918 |  517 |           return {
35919 |  518 |             before: cur,
35920 |  519 |             after: cur,
35921 |  520 |             container: "video-no-scroll",
35922 |  521 |             label: labelArg,
35923 |  522 |           };
35924 |  523 |         }
35925 |  524 |       }
35926 |  525 |       // ===== Standardowa heurystyka (permalink / photo fallback) =====
35927 |  526 |       if (!container) {
35928 |  527 |         const root = rootFn() || document.body;
35929 |  528 |         const candidates = [];
35930 |  529 |         pushIfScrollable(candidates, root, "root");
35931 |  530 |         const dialog =
35932 |  531 |           root.closest("div[role='dialog']") ||
35933 |  532 |           document.querySelector("div[role='dialog']");
35934 |  533 |         if (dialog) {
35935 |  534 |           pushIfScrollable(candidates, dialog, "dialog");
35936 |  535 |         }
35937 |  536 |         const scope = dialog || root;
35938 |  537 |         const blocks = Array.from(
35939 |  538 |           scope.querySelectorAll("div, section, main, article")
35940 |  539 |         );
35941 |  540 |         for (const el of blocks) {
35942 |  541 |           pushIfScrollable(candidates, el, "auto");
35943 |  542 |         }
35944 |  543 |         let best = null;
35945 |  544 |         for (const c of candidates) {
35946 |  545 |           if (!best || c.delta > best.delta) best = c;
35947 |  546 |         }
35948 |  547 |         if (best) {
35949 |  548 |           container = best.el;
35950 |  549 |           containerType = best.label;
35951 |  550 |         } else {
35952 |  551 |           container =
35953 |  552 |             document.scrollingElement ||
35954 |  553 |             document.documentElement ||
35955 |  554 |             document.body;
35956 |  555 |           const delta =
35957 |  556 |             (container.scrollHeight || 0) - (container.clientHeight || 0);
35958 |  557 |           if (delta <= 0) {
35959 |  558 |             const cur = container.scrollTop || window.scrollY || 0;
35960 |  559 |             return {
35961 |  560 |               before: cur,
35962 |  561 |               after: cur,
35963 |  562 |               container: "window-no-scroll",
35964 |  563 |               label: labelArg,
35965 |  564 |             };
35966 |  565 |           }
35967 |  566 |           containerType = "window";
35968 |  567 |         }
35969 |  568 |       }
35970 |  569 |       // Zapamiƒôtujemy kontener komentarzy (≈ºeby kolejne wywo≈Çania go u≈ºy≈Çy)
35971 |  570 |       if (container) {
35972 |  571 |         const isRootContainer =
35973 |  572 |           container === document.body ||
35974 |  573 |           container === document.documentElement ||
35975 |  574 |           container === document.scrollingElement;
35976 |  575 |         if (!isRootContainer) {
35977 |  576 |           try {
35978 |  577 |             container.setAttribute("data-fbwatcher-comments", "1");
35979 |  578 |           } catch {}
35980 |  579 |         }
35981 |  580 |       }
35982 |  581 |       const isWindowContainer =
35983 |  582 |         container === document.body ||
35984 |  583 |         container === document.documentElement ||
35985 |  584 |         container === document.scrollingElement;
35986 |  585 |       // na watch nie scrollujemy okna, tylko panel komentarzy
35987 |  586 |       if (isVideoView && isWindowContainer) {
35988 |  587 |         const cur = window.scrollY || 0;
35989 |  588 |         return {
35990 |  589 |           before: cur,
35991 |  590 |           after: cur,
35992 |  591 |           container: "video-window-blocked",
35993 |  592 |           label: labelArg,
35994 |  593 |         };
35995 |  594 |       }
35996 |  595 |       const before = isWindowContainer
35997 |  596 |         ? window.scrollY || 0
35998 |  597 |         : container.scrollTop || 0;
35999 |  598 |       const maxScroll =
36000 |  599 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
36001 |  600 |       if (maxScroll <= 0) {
36002 |  601 |         return {
36003 |  602 |           before,
36004 |  603 |           after: before,
36005 |  604 |           container: (containerType || "unknown") + "-no-scroll",
36006 |  605 |           label: labelArg,
36007 |  606 |         };
36008 |  607 |       }
36009 |  608 |       const factor = factorArg || 0.3;
36010 |  609 |       const sign = factor < 0 ? -1 : 1;
36011 |  610 |       const magnitude = Math.min(Math.abs(factor), 1);
36012 |  611 |       const baseStep =
36013 |  612 |         (container.clientHeight || window.innerHeight || 600) * magnitude;
36014 |  613 |       // na VIDEO robimy mniejszy krok, ≈ºeby nie przeskakiwaƒá przycisk√≥w
36015 |  614 |       let step = Math.max(30, Math.min(baseStep, isVideoView ? 180 : 220));
36016 |  615 |       let target;
36017 |  616 |       if (sign < 0) {
36018 |  617 |         target = Math.max(0, before - step);
36019 |  618 |       } else {
36020 |  619 |         target = Math.min(maxScroll, before + step);
36021 |  620 |       }
36022 |  621 |       if (isWindowContainer) {
36023 |  622 |         window.scrollTo(0, target);
36024 |  623 |       } else {
36025 |  624 |         container.scrollTop = target;
36026 |  625 |       }
36027 |  626 |       const after = isWindowContainer
36028 |  627 |         ? window.scrollY || 0
36029 |  628 |         : container.scrollTop || 0;
36030 |  629 |       return {
36031 |  630 |         before,
36032 |  631 |         after,
36033 |  632 |         container: containerType || "unknown",
36034 |  633 |         label: labelArg,
36035 |  634 |       };
36036 |  635 |     },
36037 |  636 |     factor,
36038 |  637 |     label,
36039 |  638 |     postRootScript()
36040 |  639 |   );
36041 |  640 |   return info;
36042 |  641 | }
36043 |  642 | 
36044 |  643 | /* ============================================================
36045 |  644 |    ======= DOCIƒÑGNIƒòCIE DO ABSOLUTNEGO DO≈ÅU KOMENTARZY =========
36046 |  645 |    ============================================================ */
36047 |  646 | 
36048 |  647 | async function scrollToAbsoluteBottom(page, label = "bottom") {
36049 |  648 |   const info = await page.evaluate(
36050 |  649 |     (labelArg, postRootCode) => {
36051 |  650 |       const href = location.href;
36052 |  651 |       const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
36053 |  652 |         href
36054 |  653 |       );
36055 |  654 |       const isVideoView = /\/watch\/|\/videos\/|[\?&]v=/i.test(href);
36056 |  655 |       // wstrzykujemy funkcjƒô getPostRoot
36057 |  656 |       // eslint-disable-next-line no-eval
36058 |  657 |       eval(postRootCode);
36059 |  658 |       // @ts-ignore
36060 |  659 |       const rootFn =
36061 |  660 |         typeof getPostRoot === "function" ? getPostRoot : () => document.body;
36062 |  661 |       function pushIfScrollable(list, el, labelName) {
36063 |  662 |         if (!el) return;
36064 |  663 |         const style = window.getComputedStyle(el);
36065 |  664 |         if (!style) return;
36066 |  665 |         const oy = style.overflowY;
36067 |  666 |         const clientH = el.clientHeight || 0;
36068 |  667 |         const scrollH = el.scrollHeight || 0;
36069 |  668 |         const delta = scrollH - clientH;
36070 |  669 |         if (
36071 |  670 |           clientH > 0 &&
36072 |  671 |           delta > 10 &&
36073 |  672 |           (oy === "auto" ||
36074 |  673 |             oy === "scroll" ||
36075 |  674 |             oy === "overlay" ||
36076 |  675 |             oy === "hidden")
36077 |  676 |         ) {
36078 |  677 |           list.push({ el, label: labelName, delta });
36079 |  678 |         }
36080 |  679 |       }
36081 |  680 |       let container = null;
36082 |  681 |       let containerType = null;
36083 |  682 |       // 0) Najpierw spr√≥buj u≈ºyƒá zapamiƒôtanego kontenera komentarzy
36084 |  683 |       const cached = document.querySelector("[data-fbwatcher-comments='1']");
36085 |  684 |       if (cached) {
36086 |  685 |         container = cached;
36087 |  686 |         containerType = "cached-comments";
36088 |  687 |       }
36089 |  688 |       // PHOTO / VIDEO ‚Äì najpierw pr√≥bujemy znale≈∫ƒá panel komentarzy
36090 |  689 |       if (!container && (isPhotoView || isVideoView)) {
36091 |  690 |         const moreCommentsBtn = Array.from(
36092 |  691 |           document.querySelectorAll(
36093 |  692 |             "button, div[role='button'], span[role='button']"
36094 |  693 |           )
36095 |  694 |         ).find((el) => {
36096 |  695 |           const t = (el.textContent || "").toLowerCase();
36097 |  696 |           return (
36098 |  697 |             t.includes("wy≈õwietl wiƒôcej komentarzy") ||
36099 |  698 |             t.includes("zobacz wiƒôcej komentarzy") ||
36100 |  699 |             t.includes("view more comments") ||
36101 |  700 |             t.includes("view previous comments")
36102 |  701 |           );
36103 |  702 |         });
36104 |  703 |         if (moreCommentsBtn) {
36105 |  704 |           let p = moreCommentsBtn.parentElement;
36106 |  705 |           while (p && p !== document.body && p !== document.documentElement) {
36107 |  706 |             const style = window.getComputedStyle(p);
36108 |  707 |             const oy = style.overflowY;
36109 |  708 |             const ch = p.clientHeight || 0;
36110 |  709 |             const sh = p.scrollHeight || 0;
36111 |  710 |             const delta = sh - ch;
36112 |  711 |             if (
36113 |  712 |               ch > 0 &&
36114 |  713 |               delta > 10 &&
36115 |  714 |               (oy === "auto" || oy === "scroll" || oy === "overlay" || oy === "hidden")
36116 |  715 |             ) {
36117 |  716 |               container = p;
36118 |  717 |               containerType = isPhotoView ? "photo-comments" : "video-comments";
36119 |  718 |               break;
36120 |  719 |             }
36121 |  720 |             p = p.parentElement;
36122 |  721 |           }
36123 |  722 |         }
36124 |  723 |         // dodatkowa pr√≥ba po nag≈Ç√≥wku "Komentarze / Najtrafniejsze"
36125 |  724 |         if (!container && isVideoView) {
36126 |  725 |           const commentsHeader = Array.from(
36127 |  726 |             document.querySelectorAll("div, span")
36128 |  727 |           ).find((el) => {
36129 |  728 |             const t = (el.textContent || "").toLowerCase();
36130 |  729 |             return (
36131 |  730 |               (t.includes("komentarze") && t.includes("najtrafniejsze")) ||
36132 |  731 |               (t.includes("comments") && t.includes("most relevant")) ||
36133 |  732 |               t.trim() === "komentarze" ||
36134 |  733 |               t.trim() === "comments"
36135 |  734 |             );
36136 |  735 |           });
36137 |  736 |           if (commentsHeader) {
36138 |  737 |             let p = commentsHeader.parentElement;
36139 |  738 |             while (p && p !== document.body && p !== document.documentElement) {
36140 |  739 |               const style = window.getComputedStyle(p);
36141 |  740 |               const oy = style.overflowY;
36142 |  741 |               const ch = p.clientHeight || 0;
36143 |  742 |               const sh = p.scrollHeight || 0;
36144 |  743 |               const delta = sh - ch;
36145 |  744 |               if (
36146 |  745 |                 ch > 0 &&
36147 |  746 |                 delta > 10 &&
36148 |  747 |                 (oy === "auto" ||
36149 |  748 |                   oy === "scroll" ||
36150 |  749 |                   oy === "overlay" ||
36151 |  750 |                   oy === "hidden")
36152 |  751 |               ) {
36153 |  752 |                 container = p;
36154 |  753 |                 containerType = "video-comments-header";
36155 |  754 |                 break;
36156 |  755 |               }
36157 |  756 |               p = p.parentElement;
36158 |  757 |             }
36159 |  758 |           }
36160 |  759 |         }
36161 |  760 |         // NOWY FALLBACK ‚Äì po polu "Napisz komentarz..."
36162 |  761 |         if (!container) {
36163 |  762 |           const commentBox = Array.from(
36164 |  763 |             document.querySelectorAll("div[role='textbox'], textarea")
36165 |  764 |           ).find((el) => {
36166 |  765 |             const label = (el.getAttribute("aria-label") || "").toLowerCase();
36167 |  766 |             const ph = (el.getAttribute("placeholder") || "").toLowerCase();
36168 |  767 |             const txt = (el.textContent || "").toLowerCase();
36169 |  768 |             const needles = [
36170 |  769 |               "napisz komentarz",
36171 |  770 |               "write a comment",
36172 |  771 |               "escribe un comentario",
36173 |  772 |               "schreibe einen kommentar",
36174 |  773 |             ];
36175 |  774 |             return needles.some((n) =>
36176 |  775 |               label.includes(n) || ph.includes(n) || txt.includes(n)
36177 |  776 |             );
36178 |  777 |           });
36179 |  778 |           if (commentBox) {
36180 |  779 |             let p = commentBox.parentElement;
36181 |  780 |             while (p && p !== document.body && p !== document.documentElement) {
36182 |  781 |               const style = window.getComputedStyle(p);
36183 |  782 |               const oy = style.overflowY;
36184 |  783 |               const ch = p.clientHeight || 0;
36185 |  784 |               const sh = p.scrollHeight || 0;
36186 |  785 |               const delta = sh - ch;
36187 |  786 |               if (
36188 |  787 |                 ch > 0 &&
36189 |  788 |                 delta > 10 &&
36190 |  789 |                 (oy === "auto" ||
36191 |  790 |                   oy === "scroll" ||
36192 |  791 |                   oy === "overlay" ||
36193 |  792 |                   oy === "hidden")
36194 |  793 |               ) {
36195 |  794 |                 container = p;
36196 |  795 |                 containerType = isPhotoView
36197 |  796 |                   ? "photo-comments-textbox"
36198 |  797 |                   : "video-comments-textbox";
36199 |  798 |                 break;
36200 |  799 |               }
36201 |  800 |               p = p.parentElement;
36202 |  801 |             }
36203 |  802 |           }
36204 |  803 |         }
36205 |  804 |         // je≈õli na watch nic sensownego nie znale≈∫li≈õmy ‚Äì dajemy spok√≥j
36206 |  805 |         if (isVideoView && !container) {
36207 |  806 |           const cur = window.scrollY || 0;
36208 |  807 |           return {
36209 |  808 |             label: labelArg,
36210 |  809 |             container: "video-no-scroll",
36211 |  810 |             steps: 0,
36212 |  811 |             final: cur,
36213 |  812 |             maxScroll: 0,
36214 |  813 |             atBottom: true,
36215 |  814 |           };
36216 |  815 |         }
36217 |  816 |       }
36218 |  817 |       // Standardowa heurystyka (permalink / photo fallback)
36219 |  818 |       if (!container) {
36220 |  819 |         const root = rootFn() || document.body;
36221 |  820 |         const candidates = [];
36222 |  821 |         pushIfScrollable(candidates, root, "root");
36223 |  822 |         const dialog =
36224 |  823 |           root.closest("div[role='dialog']") ||
36225 |  824 |           document.querySelector("div[role='dialog']");
36226 |  825 |         if (dialog) {
36227 |  826 |           pushIfScrollable(candidates, dialog, "dialog");
36228 |  827 |         }
36229 |  828 |         const scope = dialog || root;
36230 |  829 |         const blocks = Array.from(
36231 |  830 |           scope.querySelectorAll("div, section, main, article")
36232 |  831 |         );
36233 |  832 |         for (const el of blocks) {
36234 |  833 |           pushIfScrollable(candidates, el, "auto");
36235 |  834 |         }
36236 |  835 |         let best = null;
36237 |  836 |         for (const c of candidates) {
36238 |  837 |           if (!best || c.delta > best.delta) {
36239 |  838 |             best = c;
36240 |  839 |           }
36241 |  840 |         }
36242 |  841 |         if (best) {
36243 |  842 |           container = best.el;
36244 |  843 |           containerType = best.label;
36245 |  844 |         } else {
36246 |  845 |           container =
36247 |  846 |             document.scrollingElement ||
36248 |  847 |             document.documentElement ||
36249 |  848 |             document.body;
36250 |  849 |           containerType = "window";
36251 |  850 |         }
36252 |  851 |       }
36253 |  852 |       // Zapamiƒôtaj kontener komentarzy (je≈õli to nie jest globalne okno)
36254 |  853 |       if (container) {
36255 |  854 |         const isRootContainer =
36256 |  855 |           container === document.body ||
36257 |  856 |           container === document.documentElement ||
36258 |  857 |           container === document.scrollingElement;
36259 |  858 |         if (!isRootContainer) {
36260 |  859 |           try {
36261 |  860 |             container.setAttribute("data-fbwatcher-comments", "1");
36262 |  861 |           } catch {}
36263 |  862 |         }
36264 |  863 |       }
36265 |  864 |       const isWindowContainer =
36266 |  865 |         container === document.body ||
36267 |  866 |         container === document.documentElement ||
36268 |  867 |         container === document.scrollingElement;
36269 |  868 |       // na watch nie ruszamy globalnego scrolla je≈õli nie mamy innego kontenera
36270 |  869 |       if (isVideoView && isWindowContainer) {
36271 |  870 |         const cur = window.scrollY || 0;
36272 |  871 |         return {
36273 |  872 |           label: labelArg,
36274 |  873 |           container: "video-window-blocked",
36275 |  874 |           steps: 0,
36276 |  875 |           final: cur,
36277 |  876 |           maxScroll: 0,
36278 |  877 |           atBottom: true,
36279 |  878 |         };
36280 |  879 |       }
36281 |  880 |       let steps = 0;
36282 |  881 |       const maxSteps = 160;
36283 |  882 |       let lastPos = isWindowContainer
36284 |  883 |         ? window.scrollY || 0
36285 |  884 |         : container.scrollTop || 0;
36286 |  885 |       while (steps < maxSteps) {
36287 |  886 |         steps++;
36288 |  887 |         const maxScroll =
36289 |  888 |           (container.scrollHeight || 0) - (container.clientHeight || 0);
36290 |  889 |         const pos = isWindowContainer
36291 |  890 |           ? window.scrollY || 0
36292 |  891 |           : container.scrollTop || 0;
36293 |  892 |         // ju≈º na dole
36294 |  893 |         if (maxScroll <= 0 || pos >= maxScroll - 2) {
36295 |  894 |           return {
36296 |  895 |             label: labelArg,
36297 |  896 |             container: containerType || "unknown",
36298 |  897 |             steps,
36299 |  898 |             final: pos,
36300 |  899 |             maxScroll,
36301 |  900 |             atBottom: true,
36302 |  901 |           };
36303 |  902 |         }
36304 |  903 |         const baseStep =
36305 |  904 |           (container.clientHeight || window.innerHeight || 600) * 0.9;
36306 |  905 |         const step = Math.max(60, Math.min(baseStep, maxScroll - pos));
36307 |  906 |         if (isWindowContainer) {
36308 |  907 |           window.scrollTo(0, pos + step);
36309 |  908 |         } else {
36310 |  909 |           container.scrollTop = pos + step;
36311 |  910 |         }
36312 |  911 |         const afterPos = isWindowContainer
36313 |  912 |           ? window.scrollY || 0
36314 |  913 |           : container.scrollTop || 0;
36315 |  914 |         // brak ruchu mimo pr√≥by ‚Äì uznajemy ≈ºe jeste≈õmy na dole
36316 |  915 |         if (afterPos === lastPos) {
36317 |  916 |           return {
36318 |  917 |             label: labelArg,
36319 |  918 |             container: containerType || "unknown",
36320 |  919 |             steps,
36321 |  920 |             final: afterPos,
36322 |  921 |             maxScroll,
36323 |  922 |             atBottom: true,
36324 |  923 |           };
36325 |  924 |         }
36326 |  925 |         lastPos = afterPos;
36327 |  926 |       }
36328 |  927 |       const maxScrollFinal =
36329 |  928 |         (container.scrollHeight || 0) - (container.clientHeight || 0);
36330 |  929 |       const finalPos = isWindowContainer
36331 |  930 |         ? window.scrollY || 0
36332 |  931 |         : container.scrollTop || 0;
36333 |  932 |       return {
36334 |  933 |         label: labelArg,
36335 |  934 |         container: containerType || "unknown",
36336 |  935 |         steps,
36337 |  936 |         final: finalPos,
36338 |  937 |         maxScroll: maxScrollFinal,
36339 |  938 |         atBottom: finalPos >= maxScrollFinal - 2,
36340 |  939 |       };
36341 |  940 |     },
36342 |  941 |     label,
36343 |  942 |     postRootScript()
36344 |  943 |   );
36345 |  944 |   return info;
36346 |  945 | }
36347 |  946 | 
36348 |  947 | /* ============================================================
36349 |  948 |    ===================== VIDEO ‚Äì AUTO PAUSE ====================
36350 |  949 |    ============================================================ */
36351 |  950 | 
36352 |  951 | async function pauseVideoIfAny(page) {
36353 |  952 |   try {
36354 |  953 |     await page.evaluate(() => {
36355 |  954 |       const vids = Array.from(document.querySelectorAll("video"));
36356 |  955 |       for (const v of vids) {
36357 |  956 |         try {
36358 |  957 |           v.autoplay = false;
36359 |  958 |           v.removeAttribute("autoplay");
36360 |  959 |           v.muted = true;
36361 |  960 |           v.pause();
36362 |  961 |           if (!isNaN(v.currentTime) && v.currentTime === 0) {
36363 |  962 |             v.currentTime = 0.01;
36364 |  963 |           }
36365 |  964 |         } catch (e) {}
36366 |  965 |       }
36367 |  966 |     });
36368 |  967 |     console.log("[FB] Video pause: zatrzymano wszystkie <video>.");
36369 |  968 |   } catch (e) {
36370 |  969 |     console.log("[FB] Video pause ‚Äì b≈ÇƒÖd:", e?.message || e);
36371 |  970 |   }
36372 |  971 | }
36373 |  972 | 
36374 |  973 | /* ============================================================
36375 |  974 |    ======= BRUTALNA DO≈ªYNKA ‚Äì LOAD MORE NA DOLE ================
36376 |  975 |    ============================================================ */
36377 |  976 | 
36378 |  977 | async function clickAllLoadMoreAtBottom(page, view, maxClicks = 300) {
36379 |  978 |   // Brutalna do≈ºynka na dole ‚Äì bez scrolla, tylko to, co widaƒá
36380 |  979 |   return await page.evaluate(({ isVideo, max }) => {
36381 |  980 |     function normalize(text) {
36382 |  981 |       return (text || "").toLowerCase().replace(/\s+/g, " ").trim();
36383 |  982 |     }
36384 |  983 |     function findCommentsRoot() {
36385 |  984 |       // Dla watch/reel FB czƒôsto siedzi w g≈Ç√≥wnej kolumnie
36386 |  985 |       const main = document.querySelector("div[role='main']");
36387 |  986 |       if (!main) return document.body;
36388 |  987 |       const article = main.querySelector("article");
36389 |  988 |       if (article) return article;
36390 |  989 |       return main;
36391 |  990 |     }
36392 |  991 |     const root = findCommentsRoot();
36393 |  992 |     if (!root) return 0;
36394 |  993 |     let clicks = 0;
36395 |  994 |     for (let i = 0; i < max; i++) {
36396 |  995 |       const candidates = Array.from(
36397 |  996 |         root.querySelectorAll(
36398 |  997 |           "button,div[role='button'],span[role='button'],a[role='button']"
36399 |  998 |         )
36400 |  999 |       );
36401 | 1000 |       const btn = candidates.find((el) => {
36402 | 1001 |         const t = normalize(el.textContent);
36403 | 1002 |         if (!t) return false;
36404 | 1003 |         if (t.startsWith("wy≈õwietl wiƒôcej komentarzy")) return true;
36405 | 1004 |         if (t === "poka≈º wiƒôcej odpowiedzi") return true;
36406 | 1005 |         if (/^wy≈õwietl wszystkie \d+ odpowiedzi$/.test(t)) return true;
36407 | 1006 |         if (t === "wy≈õwietl 1 odpowied≈∫") return true;
36408 | 1007 |         if (/odpowiedzi$/.test(t) && /odpowiedzi/.test(t) && t.includes("odpowiedzia≈Ç")) {
36409 | 1008 |           return true;
36410 | 1009 |         }
36411 | 1010 |         return false;
36412 | 1011 |       });
36413 | 1012 |       if (!btn) break;
36414 | 1013 |       const rect = btn.getBoundingClientRect();
36415 | 1014 |       if (rect.bottom < 0 || rect.top > window.innerHeight) break;
36416 | 1015 |       btn.click();
36417 | 1016 |       clicks++;
36418 | 1017 |     }
36419 | 1018 |     return clicks;
36420 | 1019 |   }, { isVideo: !!view.isVideo, max: maxClicks });
36421 | 1020 | }
36422 | 1021 | 
36423 | 1022 | /* ============================================================
36424 | 1023 |    ======= AGRESYWNE DO≈ÅADOWANIE WSZYSTKICH KOMENTARZY =========
36425 | 1024 |    ============================================================ */
36426 | 1025 | 
36427 | 1026 | async function ensureAllCommentsLoaded(page, expectedTotal = null) {
36428 | 1027 |   // expectedTotal tylko do log√≥w ‚Äì NIE jest twardym warunkiem stopu
36429 | 1028 |   const hasTarget = typeof expectedTotal === "number" && expectedTotal > 0;
36430 | 1029 |   const view = await page.evaluate(() => {
36431 | 1030 |     const href = location.href;
36432 | 1031 |     const isWatch = href.includes("/watch/");
36433 | 1032 |     const isVideo = isWatch || /\/watch\/|\/videos\/|[\?&]v=/i.test(href); // üëà dodane /videos/
36434 | 1033 |     const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
36435 | 1034 |       href
36436 | 1035 |     );
36437 | 1036 |     return { href, isWatch, isVideo, isPhoto };
36438 | 1037 |   });
36439 | 1038 |   console.log(
36440 | 1039 |     "[FB] ensureAllCommentsLoaded ‚Äì start",
36441 | 1040 |     hasTarget ? `(target=${expectedTotal})` : "(bez targetu)",
36442 | 1041 |     "| view:",
36443 | 1042 |     view
36444 | 1043 |   );
36445 | 1044 |   const MAX_ROUNDS = view.isVideo ? 1500 : 2500;
36446 | 1045 |   const MAX_NO_PROGRESS = 10; // ile rund bez progresu zanim uznamy, ≈ºe koniec
36447 | 1046 |   let noProgressRounds = 0;
36448 | 1047 |   let roundsDone = 0;
36449 | 1048 |   let lastAnchors = 0;
36450 | 1049 |   let breakReason = "max-rounds";
36451 | 1050 |   // helper ‚Äì czy na stronie sƒÖ jeszcze przyciski load-more/replies
36452 | 1051 |   async function hasLoadMoreButtons() {
36453 | 1052 |     return await page.evaluate(() => {
36454 | 1053 |       const phrases = [
36455 | 1054 |         "wy≈õwietl wiƒôcej komentarzy",
36456 | 1055 |         "wy≈õwietl wszystkie",
36457 | 1056 |         "wy≈õwietl wszystkie odpowiedzi",
36458 | 1057 |         "wy≈õwietl odpowiedzi",
36459 | 1058 |         "zobacz wiƒôcej komentarzy",
36460 | 1059 |         "view more comments",
36461 | 1060 |         "view more replies",
36462 | 1061 |         "see more comments",
36463 | 1062 |         "see more replies",
36464 | 1063 |       ];
36465 | 1064 |       const btns = Array.from(
36466 | 1065 |         document.querySelectorAll("button, div[role='button'], span[role='button'], a")
36467 | 1066 |       );
36468 | 1067 |       return btns.some((el) => {
36469 | 1068 |         const txt = (el.textContent || "").replace(/\s+/g, " ").trim().toLowerCase();
36470 | 1069 |         if (!txt) return false;
36471 | 1070 |         return phrases.some((p) => txt.includes(p));
36472 | 1071 |       });
36473 | 1072 |     });
36474 | 1073 |   }
36475 | 1074 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
36476 | 1075 |     const beforeAnchors = await getCurrentCommentAnchorCount(page);
36477 | 1076 |     // scrollujemy TYLKO przez scrollWithinPost ‚Äì on ogarnia kontener komentarzy
36478 | 1077 |     const scrollInfo = await scrollWithinPost(
36479 | 1078 |       page,
36480 | 1079 |       `round-${round}`,
36481 | 1080 |       view.isVideo ? 0.18 : 0.25
36482 | 1081 |     );
36483 | 1082 |     const clicks = await expandAllComments(page);
36484 | 1083 |     const afterAnchors = await getCurrentCommentAnchorCount(page);
36485 | 1084 |     const moreButtons = await hasLoadMoreButtons();
36486 | 1085 |     const scrolled = scrollInfo.after !== scrollInfo.before;
36487 | 1086 |     const progressed =
36488 | 1087 |       scrolled || clicks > 0 || afterAnchors > beforeAnchors;
36489 | 1088 |     if (progressed) {
36490 | 1089 |       noProgressRounds = 0;
36491 | 1090 |       lastAnchors = afterAnchors;
36492 | 1091 |     } else {
36493 | 1092 |       noProgressRounds++;
36494 | 1093 |     }
36495 | 1094 |     roundsDone = round;
36496 | 1095 |     if (round === 1 || round % 25 === 0 || round > MAX_ROUNDS - 5) {
36497 | 1096 |       console.log(
36498 | 1097 |         `[FB] ensureAllCommentsLoaded ‚Äì round ${round} ` +
36499 | 1098 |           `container=${scrollInfo.container} ` +
36500 | 1099 |           `scrollTop: ${scrollInfo.before} ‚Üí ${scrollInfo.after} ` +
36501 | 1100 |           `anchors: ${beforeAnchors} ‚Üí ${afterAnchors} ` +
36502 | 1101 |           `clicks=${clicks} noProgress=${noProgressRounds} moreButtons=${moreButtons}`
36503 | 1102 |       );
36504 | 1103 |     }
36505 | 1104 |     if (hasTarget && afterAnchors >= expectedTotal && !moreButtons) {
36506 | 1105 |       breakReason = "target-reached-no-buttons";
36507 | 1106 |       break;
36508 | 1107 |     }
36509 | 1108 |     if (!moreButtons && noProgressRounds >= MAX_NO_PROGRESS) {
36510 | 1109 |       breakReason = "no-buttons-no-progress";
36511 | 1110 |       break;
36512 | 1111 |     }
36513 | 1112 |     if (noProgressRounds >= MAX_NO_PROGRESS * 2) {
36514 | 1113 |       breakReason = "hard-no-progress";
36515 | 1114 |       break;
36516 | 1115 |     }
36517 | 1116 |     await sleepRandom(250, 600);
36518 | 1117 |   }
36519 | 1118 |   console.log(
36520 | 1119 |     "[FB] ensureAllCommentsLoaded ‚Äì g≈Ç√≥wna pƒôtla:",
36521 | 1120 |     `reason=${breakReason}, rounds=${roundsDone}, anchors=${lastAnchors}${
36522 | 1121 |       hasTarget ? `/target=${expectedTotal}` : ""
36523 | 1122 |     }`
36524 | 1123 |   );
36525 | 1124 |   // Runda kontrolna w g√≥rƒô ‚Äì domykamy expandy ‚Äûu g√≥ry‚Äù
36526 | 1125 |   try {
36527 | 1126 |     let ctrlReason = "max-ctrl-rounds";
36528 | 1127 |     for (let i = 1; i <= 200; i++) {
36529 | 1128 |       const up = await scrollWithinPost(page, `ctrl-up-${i}`, -0.55);
36530 | 1129 |       const clicked = await clickOneExpandButton(page);
36531 | 1130 |       await sleepRandom(160, 320);
36532 | 1131 |       if (up.after === 0) {
36533 | 1132 |         ctrlReason = "top-reached";
36534 | 1133 |         break;
36535 | 1134 |       }
36536 | 1135 |       if (up.after === up.before && !clicked) {
36537 | 1136 |         ctrlReason = "no-move-no-click";
36538 | 1137 |         break;
36539 | 1138 |       }
36540 | 1139 |     }
36541 | 1140 |     console.log("[FB] ensureAllCommentsLoaded ‚Äì runda kontrolna:", ctrlReason);
36542 | 1141 |   } catch (e) {
36543 | 1142 |     console.log(
36544 | 1143 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd w rundzie kontrolnej:",
36545 | 1144 |       e?.message || e
36546 | 1145 |     );
36547 | 1146 |   }
36548 | 1147 |   let bottomClicks = 0;
36549 | 1148 |   let lastBottomPos = null;
36550 | 1149 |   let stableRounds = 0;
36551 | 1150 |   try {
36552 | 1151 |     for (let i = 1; i <= 400; i++) {
36553 | 1152 |       const info = await scrollWithinPost(
36554 | 1153 |         page,
36555 | 1154 |         `final-bottom-${i}`,
36556 | 1155 |         view.isVideo ? 0.6 : 0.8
36557 | 1156 |       );
36558 | 1157 |       if (lastBottomPos === info.after) {
36559 | 1158 |         stableRounds++;
36560 | 1159 |       } else {
36561 | 1160 |         stableRounds = 0;
36562 | 1161 |       }
36563 | 1162 |       lastBottomPos = info.after;
36564 | 1163 |       if (i === 1 || i % 50 === 0) {
36565 | 1164 |         console.log(
36566 | 1165 |           `[FB] ensureAllCommentsLoaded ‚Äì final-bottom step ${i}: container=${info.container}, ` +
36567 | 1166 |             `scrollTop: ${info.before} ‚Üí ${info.after}`
36568 | 1167 |         );
36569 | 1168 |       }
36570 | 1169 |       if (stableRounds >= 3) break;
36571 | 1170 |       await sleepRandom(120, 260);
36572 | 1171 |     }
36573 | 1172 |     const bottomExpand = await expandAllComments(page);
36574 | 1173 |     const extraClicks = await clickAllLoadMoreAtBottom(page, view, 300);
36575 | 1174 |     bottomClicks = bottomExpand + extraClicks;
36576 | 1175 |     if (bottomClicks > 0) {
36577 | 1176 |       console.log(
36578 | 1177 |         `[FB] ensureAllCommentsLoaded ‚Äì bottom pass: expand=${bottomExpand}, extra=${extraClicks}, total=${bottomClicks}`
36579 | 1178 |       );
36580 | 1179 |       await sleepRandom(700, 1300);
36581 | 1180 |     }
36582 | 1181 |   } catch (e) {
36583 | 1182 |     console.log(
36584 | 1183 |       "[FB] ensureAllCommentsLoaded ‚Äì b≈ÇƒÖd przy final bottom:",
36585 | 1184 |       e?.message || e
36586 | 1185 |     );
36587 | 1186 |   }
36588 | 1187 |   const finalAnchors = await getCurrentCommentAnchorCount(page);
36589 | 1188 |   console.log(
36590 | 1189 |     "[FB] ensureAllCommentsLoaded ‚Äì koniec. anchors=",
36591 | 1190 |     finalAnchors,
36592 | 1191 |     "bottomClicks=",
36593 | 1192 |     bottomClicks
36594 | 1193 |   );
36595 | 1194 | }
36596 | 1195 | 
36597 | 1196 | /* ============================================================
36598 | 1197 |    ==================== WIƒòCEJ KOMENTARZY (VIDEO) ===============
36599 | 1198 |    ============================================================ */
36600 | 1199 | 
36601 | 1200 | async function clickMoreCommentsButtonsVideo(page, maxLoops = 80) {
36602 | 1201 |   console.log(
36603 | 1202 |     "[FB][more-comments] Start klikania 'Wy≈õwietl wiƒôcej komentarzy / odpowiedzi' (video)‚Ä¶"
36604 | 1203 |   );
36605 | 1204 |   for (let i = 0; i < maxLoops; i++) {
36606 | 1205 |     const result = await page.evaluate(() => {
36607 | 1206 |       const norm = (s) =>
36608 | 1207 |         (s || "")
36609 | 1208 |           .replace(/\s+/g, " ")
36610 | 1209 |           .trim()
36611 | 1210 |           .toLowerCase();
36612 | 1211 |       function getPostRoot() {
36613 | 1212 |         // 1) overlay z postem / video
36614 | 1213 |         const dialogs = Array.from(
36615 | 1214 |           document.querySelectorAll("div[role='dialog']")
36616 | 1215 |         );
36617 | 1216 |         for (const dlg of dialogs) {
36618 | 1217 |           const txt = (dlg.innerText || dlg.textContent || "").toLowerCase();
36619 | 1218 |           if (!txt) continue;
36620 | 1219 |           if (
36621 | 1220 |             txt.includes("komentarz") ||
36622 | 1221 |             txt.includes("comments") ||
36623 | 1222 |             txt.includes("napisz komentarz")
36624 | 1223 |           ) {
36625 | 1224 |             const art = dlg.querySelector("article");
36626 | 1225 |             return art || dlg;
36627 | 1226 |           }
36628 | 1227 |         }
36629 | 1228 |         // 2) strona "Filmy" ‚Äì g≈Ç√≥wny artyku≈Ç
36630 | 1229 |         const main = document.querySelector("main");
36631 | 1230 |         if (main) {
36632 | 1231 |           const art = main.querySelector("article");
36633 | 1232 |           if (art) return art;
36634 | 1233 |           return main;
36635 | 1234 |         }
36636 | 1235 |         // 3) fallback
36637 | 1236 |         return document.body || document;
36638 | 1237 |       }
36639 | 1238 |       const root = getPostRoot();
36640 | 1239 |       const MORE_COMMENTS_LABELS = [
36641 | 1240 |         "wy≈õwietl wiƒôcej komentarzy",
36642 | 1241 |         "zobacz wiƒôcej komentarzy",
36643 | 1242 |         "view more comments",
36644 | 1243 |         "view previous comments",
36645 | 1244 |         "see more comments",
36646 | 1245 |       ];
36647 | 1246 |       const REPLY_LABELS = [
36648 | 1247 |         "wy≈õwietl wiƒôcej odpowiedzi",
36649 | 1248 |         "zobacz wiƒôcej odpowiedzi",
36650 | 1249 |         "view more replies",
36651 | 1250 |         "see more replies",
36652 | 1251 |       ];
36653 | 1252 |       const els = Array.from(
36654 | 1253 |         root.querySelectorAll(
36655 | 1254 |           "button, div[role='button'], span[role='button'], span"
36656 | 1255 |         )
36657 | 1256 |       );
36658 | 1257 |       let target = null;
36659 | 1258 |       let kind = null;
36660 | 1259 |       // 1) priorytet: "Wy≈õwietl wiƒôcej komentarzy"
36661 | 1260 |       for (const el of els) {
36662 | 1261 |         const txt = norm(el.textContent);
36663 | 1262 |         if (!txt) continue;
36664 | 1263 |         if (MORE_COMMENTS_LABELS.includes(txt)) {
36665 | 1264 |           const rect = el.getBoundingClientRect();
36666 | 1265 |           if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
36667 | 1266 |           target = el;
36668 | 1267 |           kind = "comments";
36669 | 1268 |           break;
36670 | 1269 |         }
36671 | 1270 |       }
36672 | 1271 |       // 2) je≈õli nie ma "wiƒôcej komentarzy" ‚Äì szukamy "wiƒôcej/X odpowiedzi"
36673 | 1272 |       if (!target) {
36674 | 1273 |         for (const el of els) {
36675 | 1274 |           const txt = norm(el.textContent);
36676 | 1275 |           if (!txt) continue;
36677 | 1276 |           if (REPLY_LABELS.includes(txt)) {
36678 | 1277 |             const rect = el.getBoundingClientRect();
36679 | 1278 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
36680 | 1279 |             target = el;
36681 | 1280 |             kind = "replies";
36682 | 1281 |             break;
36683 | 1282 |           }
36684 | 1283 |           if (
36685 | 1284 |             /(^|\s)\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(txt) ||
36686 | 1285 |             (txt.includes(" replies") && /\d+/.test(txt))
36687 | 1286 |           ) {
36688 | 1287 |             const rect = el.getBoundingClientRect();
36689 | 1288 |             if (rect.bottom < 0 || rect.top > window.innerHeight) continue;
36690 | 1289 |             target = el;
36691 | 1290 |             kind = "replies";
36692 | 1291 |             break;
36693 | 1292 |           }
36694 | 1293 |         }
36695 | 1294 |       }
36696 | 1295 |       if (!target) {
36697 | 1296 |         return { clicked: false, kind: null };
36698 | 1297 |       }
36699 | 1298 |       try {
36700 | 1299 |         target.scrollIntoView({ block: "center", inline: "nearest" });
36701 | 1300 |       } catch (e) {
36702 | 1301 |         // ignorujemy
36703 | 1302 |       }
36704 | 1303 |       if (typeof target.click === "function") {
36705 | 1304 |         target.click();
36706 | 1305 |         return { clicked: true, kind };
36707 | 1306 |       }
36708 | 1307 |       return { clicked: false, kind: null };
36709 | 1308 |     });
36710 | 1309 |     if (!result || !result.clicked) {
36711 | 1310 |       if (i === 0) {
36712 | 1311 |         console.log(
36713 | 1312 |           "[FB][more-comments] Brak przycisk√≥w 'wiƒôcej komentarzy/odpowiedzi' ‚Äì nic nie klikam."
36714 | 1313 |         );
36715 | 1314 |       } else {
36716 | 1315 |         console.log(
36717 | 1316 |           `[FB][more-comments] Brak kolejnych przycisk√≥w ‚Äì zako≈Ñczono po ${i} klikniƒôciach.`
36718 | 1317 |         );
36719 | 1318 |       }
36720 | 1319 |       break;
36721 | 1320 |     }
36722 | 1321 |     const what =
36723 | 1322 |       result.kind === "replies"
36724 | 1323 |         ? "wiƒôcej odpowiedzi / X odpowiedzi"
36725 | 1324 |         : "wiƒôcej komentarzy";
36726 | 1325 |     console.log(
36727 | 1326 |       `[FB][more-comments] Klikniƒôto '${what}' (iteracja ${i + 1}/${maxLoops}).`
36728 | 1327 |     );
36729 | 1328 |     await sleepRandom(900, 1600);
36730 | 1329 |     try {
36731 | 1330 |       await scrollWithinPost(page, `video-more-${i + 1}`, 0.18);
36732 | 1331 |     } catch (e) {
36733 | 1332 |       console.log(
36734 | 1333 |         "[FB][more-comments] scrollWithinPost(video) ‚Äì b≈ÇƒÖd:",
36735 | 1334 |         e?.message || e
36736 | 1335 |       );
36737 | 1336 |     }
36738 | 1337 |     await sleepRandom(800, 1400);
36739 | 1338 |   }
36740 | 1339 |   console.log(
36741 | 1340 |     `[FB][more-comments] Zako≈Ñczono sekwencjƒô video (maxLoops=${maxLoops}).`
36742 | 1341 |   );
36743 | 1342 | }
36744 | 1343 | 
36745 | 1344 | /* ============================================================
36746 | 1345 |    ================= SEKWENCYJNY SPACER (VIDEO) =================
36747 | 1346 |    ============================================================ */
36748 | 1347 | 
36749 | 1348 | async function walkVideoCommentsSequential(page, maxCycles = 40) {
36750 | 1349 |   console.log("[FB][video-walk] start ‚Äì sekwencyjny spacer po komentarzach (VIDEO)‚Ä¶");
36751 | 1350 | 
36752 | 1351 |   let noProgressStreak = 0;
36753 | 1352 | 
36754 | 1353 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
36755 | 1354 |     const result = await page.evaluate(() => {
36756 | 1355 |       const norm = (s) =>
36757 | 1356 |         String(s || "")
36758 | 1357 |           .replace(/\u00a0/g, " ")
36759 | 1358 |           .replace(/\s+/g, " ")
36760 | 1359 |           .trim()
36761 | 1360 |           .toLowerCase();
36762 | 1361 | 
36763 | 1362 |       const isVisible = (el) => {
36764 | 1363 |         if (!el) return false;
36765 | 1364 |         const st = window.getComputedStyle(el);
36766 | 1365 |         if (!st) return true;
36767 | 1366 |         if (st.display === "none" || st.visibility === "hidden") return false;
36768 | 1367 |         return true;
36769 | 1368 |       };
36770 | 1369 | 
36771 | 1370 |       function getLabel(el) {
36772 | 1371 |         if (!el) return "";
36773 | 1372 |         const a = el.getAttribute?.("aria-label");
36774 | 1373 |         if (a) return a;
36775 | 1374 |         return el.textContent || "";
36776 | 1375 |       }
36777 | 1376 | 
36778 | 1377 |       function findClickable(el, maxUp = 8) {
36779 | 1378 |         let cur = el;
36780 | 1379 |         for (let i = 0; i < maxUp && cur; i++) {
36781 | 1380 |           const role = cur.getAttribute?.("role");
36782 | 1381 |           const tag = (cur.tagName || "").toLowerCase();
36783 | 1382 |           if (tag === "button" || tag === "a" || role === "button") return cur;
36784 | 1383 |           cur = cur.parentElement;
36785 | 1384 |         }
36786 | 1385 |         return el; // fallback
36787 | 1386 |       }
36788 | 1387 | 
36789 | 1388 |       function getPostRoot() {
36790 | 1389 |         // 1) dialog / overlay (czƒôste przy video)
36791 | 1390 |         const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
36792 | 1391 |         for (const dlg of dialogs) {
36793 | 1392 |           const txt = norm(dlg.innerText || dlg.textContent);
36794 | 1393 |           if (!txt) continue;
36795 | 1394 |           if (txt.includes("komentarz") || txt.includes("comments") || txt.includes("napisz komentarz")) {
36796 | 1395 |             const art = dlg.querySelector("article");
36797 | 1396 |             return art || dlg;
36798 | 1397 |           }
36799 | 1398 |         }
36800 | 1399 | 
36801 | 1400 |         // 2) klasyczny main
36802 | 1401 |         const main = document.querySelector("main, div[role='main']");
36803 | 1402 |         if (main) {
36804 | 1403 |           const art = main.querySelector("article");
36805 | 1404 |           return art || main;
36806 | 1405 |         }
36807 | 1406 | 
36808 | 1407 |         return document.body || document.documentElement;
36809 | 1408 |       }
36810 | 1409 | 
36811 | 1410 |       // REALNY test scrollowalno≈õci: pr√≥bujemy ruszyƒá scrollTop i sprawdzamy czy siƒô zmieni≈Ç.
36812 | 1411 |       function canScrollByTest(el) {
36813 | 1412 |         try {
36814 | 1413 |           if (!el) return false;
36815 | 1414 |           const h = el.clientHeight || 0;
36816 | 1415 |           const sh = el.scrollHeight || 0;
36817 | 1416 |           if (sh <= h + 40) return false;
36818 | 1417 | 
36819 | 1418 |           const before = el.scrollTop ?? 0;
36820 | 1419 |           el.scrollTop = before + 50;
36821 | 1420 |           const after = el.scrollTop ?? before;
36822 | 1421 | 
36823 | 1422 |           // przywr√≥ƒá (≈ºeby nie rozje≈ºd≈ºaƒá)
36824 | 1423 |           el.scrollTop = before;
36825 | 1424 | 
36826 | 1425 |           return after !== before;
36827 | 1426 |         } catch (e) {
36828 | 1427 |           return false;
36829 | 1428 |         }
36830 | 1429 |       }
36831 | 1430 | 
36832 | 1431 |       function getCommentsContainerSmart(root) {
36833 | 1432 |   // cache kontenera miƒôdzy cyklami (FB czƒôsto rerenderuje, ale referencja zwykle ≈ºyje chwilƒô)
36834 | 1433 |   function isInDom(el) {
36835 | 1434 |     try {
36836 | 1435 |       return !!el && document.contains(el);
36837 | 1436 |     } catch (e) {
36838 | 1437 |       return false;
36839 | 1438 |     }
36840 | 1439 |   }
36841 | 1440 | 
36842 | 1441 |   function canScrollByTest(el) {
36843 | 1442 |     try {
36844 | 1443 |       if (!el) return false;
36845 | 1444 |       const h = el.clientHeight || 0;
36846 | 1445 |       const sh = el.scrollHeight || 0;
36847 | 1446 |       if (sh <= h + 40) return false;
36848 | 1447 | 
36849 | 1448 |       const before = el.scrollTop ?? 0;
36850 | 1449 |       el.scrollTop = before + 50;
36851 | 1450 |       const after = el.scrollTop ?? before;
36852 | 1451 |       el.scrollTop = before;
36853 | 1452 | 
36854 | 1453 |       return after !== before;
36855 | 1454 |     } catch (e) {
36856 | 1455 |       return false;
36857 | 1456 |     }
36858 | 1457 |   }
36859 | 1458 | 
36860 | 1459 |   // 0) spr√≥buj u≈ºyƒá ostatniego dobrego kontenera
36861 | 1460 |   const cached = window.__FBW_VIDEO_COMMENTS_CONTAINER;
36862 | 1461 |   if (isInDom(cached) && canScrollByTest(cached)) {
36863 | 1462 |     return cached;
36864 | 1463 |   }
36865 | 1464 | 
36866 | 1465 |   // 1) normalne szukanie
36867 | 1466 |   const scopes = [root, document.body, document.documentElement].filter(Boolean);
36868 | 1467 | 
36869 | 1468 |   let best = null;
36870 | 1469 |   let bestScore = -1;
36871 | 1470 | 
36872 | 1471 |   for (const scope of scopes) {
36873 | 1472 |     const divs = Array.from(scope.querySelectorAll("div"))
36874 | 1473 |       .filter(isVisible)
36875 | 1474 |       .slice(0, 16000);
36876 | 1475 | 
36877 | 1476 |     for (const el of divs) {
36878 | 1477 |       if (!canScrollByTest(el)) continue;
36879 | 1478 | 
36880 | 1479 |       const h = el.clientHeight || 0;
36881 | 1480 |       const sh = el.scrollHeight || 0;
36882 | 1481 |       const delta = sh - h;
36883 | 1482 | 
36884 | 1483 |       const t = norm(el.innerText || "");
36885 | 1484 |       const hasCommentWords =
36886 | 1485 |         t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
36887 | 1486 | 
36888 | 1487 |       const score = delta + (hasCommentWords ? 9000 : 0);
36889 | 1488 | 
36890 | 1489 |       if (score > bestScore) {
36891 | 1490 |         bestScore = score;
36892 | 1491 |         best = el;
36893 | 1492 |       }
36894 | 1493 |     }
36895 | 1494 | 
36896 | 1495 |     if (best) break;
36897 | 1496 |   }
36898 | 1497 | 
36899 | 1498 |   // 2) cache
36900 | 1499 |   if (best) {
36901 | 1500 |     window.__FBW_VIDEO_COMMENTS_CONTAINER = best;
36902 | 1501 |     return best;
36903 | 1502 |   }
36904 | 1503 | 
36905 | 1504 |   return document.scrollingElement || document.documentElement || root;
36906 | 1505 | }
36907 | 1506 | 
36908 | 1507 | 
36909 | 1508 |       function clickMoreCommentsOnce(scope) {
36910 | 1509 |         const LABELS = [
36911 | 1510 |           "wy≈õwietl wiƒôcej komentarzy",
36912 | 1511 |           "zobacz wiƒôcej komentarzy",
36913 | 1512 |           "view more comments",
36914 | 1513 |           "see more comments",
36915 | 1514 |           "show more comments",
36916 | 1515 |         ];
36917 | 1516 | 
36918 | 1517 |         const nodes = Array.from(
36919 | 1518 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
36920 | 1519 |         )
36921 | 1520 |           .filter(isVisible)
36922 | 1521 |           .slice(0, 30000);
36923 | 1522 | 
36924 | 1523 |         for (const el of nodes) {
36925 | 1524 |           const txt = norm(getLabel(el));
36926 | 1525 |           if (!txt) continue;
36927 | 1526 | 
36928 | 1527 |           const hit = LABELS.some((w) => txt.includes(w));
36929 | 1528 |           if (!hit) continue;
36930 | 1529 | 
36931 | 1530 |           const btn = findClickable(el);
36932 | 1531 | 
36933 | 1532 |           try {
36934 | 1533 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
36935 | 1534 |           } catch (e) {}
36936 | 1535 | 
36937 | 1536 |           try {
36938 | 1537 |             btn.click();
36939 | 1538 |             return true;
36940 | 1539 |           } catch (e) {}
36941 | 1540 |         }
36942 | 1541 |         return false;
36943 | 1542 |       }
36944 | 1543 | 
36945 | 1544 |       function expandReplies(scope, limit = 35) {
36946 | 1545 |         const nodes = Array.from(
36947 | 1546 |           scope.querySelectorAll("button, div[role='button'], span[role='button'], a, span, div")
36948 | 1547 |         )
36949 | 1548 |           .filter(isVisible)
36950 | 1549 |           .slice(0, 40000);
36951 | 1550 | 
36952 | 1551 |         let clicked = 0;
36953 | 1552 | 
36954 | 1553 |         for (const el of nodes) {
36955 | 1554 |           const txt = norm(getLabel(el));
36956 | 1555 |           if (!txt) continue;
36957 | 1556 | 
36958 | 1557 |           const isMoreReplies =
36959 | 1558 |             txt.includes("wiƒôcej odpowiedzi") ||
36960 | 1559 |             txt.includes("more replies") ||
36961 | 1560 |             txt.includes("view previous replies") ||
36962 | 1561 |             txt.includes("zobacz odpowiedzi") ||
36963 | 1562 |             txt.includes("show replies");
36964 | 1563 | 
36965 | 1564 |           // ≈Çapie ‚Äú12 odpowiedzi‚Äù, ale te≈º warianty z dodatkami
36966 | 1565 |           const isCountReplies = /\b\d+\s+(odpowied≈∫|odpowiedzi|repl(y|ies))\b/.test(txt);
36967 | 1566 | 
36968 | 1567 |           if (!isMoreReplies && !isCountReplies) continue;
36969 | 1568 | 
36970 | 1569 |           const btn = findClickable(el);
36971 | 1570 | 
36972 | 1571 |           try {
36973 | 1572 |             btn.scrollIntoView({ block: "center", inline: "nearest" });
36974 | 1573 |           } catch (e) {}
36975 | 1574 | 
36976 | 1575 |           try {
36977 | 1576 |             btn.click();
36978 | 1577 |             clicked++;
36979 | 1578 |             if (clicked >= limit) break;
36980 | 1579 |           } catch (e) {}
36981 | 1580 |         }
36982 | 1581 | 
36983 | 1582 |         return clicked;
36984 | 1583 |       }
36985 | 1584 | 
36986 | 1585 |       function scrollSomewhere(container) {
36987 | 1586 |         const beforeC = container?.scrollTop ?? 0;
36988 | 1587 |         const beforeW = window.scrollY ?? 0;
36989 | 1588 | 
36990 | 1589 |         const step = Math.max(300, (container?.clientHeight || 0) * 0.8, 700);
36991 | 1590 | 
36992 | 1591 |         // 1) pr√≥buj na kontenerze
36993 | 1592 |         try {
36994 | 1593 |           if (container && typeof container.scrollTop === "number") {
36995 | 1594 |             container.scrollTop = Math.min(beforeC + step, container.scrollHeight || beforeC + step);
36996 | 1595 |           }
36997 | 1596 |         } catch (e) {}
36998 | 1597 | 
36999 | 1598 |         const afterC = container?.scrollTop ?? beforeC;
37000 | 1599 | 
37001 | 1600 |         // 2) jak nie ruszy≈Ço ‚Äì pr√≥buj window
37002 | 1601 |         if (afterC === beforeC) {
37003 | 1602 |           try {
37004 | 1603 |             window.scrollBy(0, step);
37005 | 1604 |           } catch (e) {}
37006 | 1605 |         }
37007 | 1606 | 
37008 | 1607 |         const afterW = window.scrollY ?? beforeW;
37009 | 1608 | 
37010 | 1609 |         return {
37011 | 1610 |           beforeC,
37012 | 1611 |           afterC,
37013 | 1612 |           beforeW,
37014 | 1613 |           afterW,
37015 | 1614 |           scrolled: afterC !== beforeC || afterW !== beforeW,
37016 | 1615 |         };
37017 | 1616 |       }
37018 | 1617 | 
37019 | 1618 |       const root = getPostRoot();
37020 | 1619 |       const container = getCommentsContainerSmart(root);
37021 | 1620 | 
37022 | 1621 |       // WA≈ªNE: na video czƒôsto ‚Äúwiƒôcej komentarzy‚Äù jest poza root ‚Üí szukamy i w body
37023 | 1622 |       let clickedMore = clickMoreCommentsOnce(root);
37024 | 1623 |       if (!clickedMore) clickedMore = clickMoreCommentsOnce(document.body);
37025 | 1624 | 
37026 | 1625 |       // ‚Äú12 odpowiedzi‚Äù te≈º potrafi byƒá poza root
37027 | 1626 |       const repliesClickedRoot = expandReplies(root, 35);
37028 | 1627 |       const repliesClickedBody = expandReplies(document.body, Math.max(0, 35 - repliesClickedRoot));
37029 | 1628 |       const repliesClicked = repliesClickedRoot + repliesClickedBody;
37030 | 1629 | 
37031 | 1630 |       const scrollRes = scrollSomewhere(container);
37032 | 1631 | 
37033 | 1632 |       const hasButtons = clickedMore || repliesClicked > 0;
37034 | 1633 | 
37035 | 1634 |       return {
37036 | 1635 |         clickedMore,
37037 | 1636 |         repliesClicked,
37038 | 1637 |         scrolled: scrollRes.scrolled,
37039 | 1638 |         hasButtons,
37040 | 1639 |         dbg: {
37041 | 1640 |           beforeC: scrollRes.beforeC,
37042 | 1641 |           afterC: scrollRes.afterC,
37043 | 1642 |           beforeW: scrollRes.beforeW,
37044 | 1643 |           afterW: scrollRes.afterW,
37045 | 1644 |           containerTag: container?.tagName || null,
37046 | 1645 |         },
37047 | 1646 |       };
37048 | 1647 |     });
37049 | 1648 | 
37050 | 1649 |     console.log(
37051 | 1650 |       `[FB][video-walk] cycle ${cycle}: more=${result.clickedMore}, replies=${result.repliesClicked}, scrolled=${result.scrolled} | dbg=${JSON.stringify(result.dbg)}`
37052 | 1651 |     );
37053 | 1652 | 
37054 | 1653 |     // Stop dopiero po 3 pustych cyklach (FB czƒôsto ≈Çaduje leniwie)
37055 | 1654 |     if (!result.hasButtons && !result.scrolled) {
37056 | 1655 |       noProgressStreak++;
37057 | 1656 |       console.log(`[FB][video-walk] no-progress streak = ${noProgressStreak}/3`);
37058 | 1657 |       if (noProgressStreak >= 3) {
37059 | 1658 |         console.log("[FB][video-walk] stop ‚Äì 3x brak przycisk√≥w i brak scrolla.");
37060 | 1659 |         break;
37061 | 1660 |       }
37062 | 1661 |     } else {
37063 | 1662 |       noProgressStreak = 0;
37064 | 1663 |     }
37065 | 1664 | 
37066 | 1665 |     await sleepRandom(1200, 2000);
37067 | 1666 |   }
37068 | 1667 | 
37069 | 1668 |   console.log("[FB][video-walk] koniec spaceru po komentarzach VIDEO.");
37070 | 1669 | }
37071 | 1670 | 
37072 | 1671 | 
37073 | 1672 | 
37074 | 1673 | /* ============================================================
37075 | 1674 |    ==================== LICZBA KOMENTARZY ======================
37076 | 1675 |    ============================================================ */
37077 | 1676 | 
37078 | 1677 | async function getCommentCount(page, postUrl) {
37079 | 1678 |   console.log(`[FB] Otwieranie posta: ${postUrl}`);
37080 | 1679 |   const ok = await safeGoto(page, postUrl, "post", {
37081 | 1680 |     waitUntil: "networkidle2",
37082 | 1681 |     timeout: NAV_TIMEOUT_MS,
37083 | 1682 |   });
37084 | 1683 |   if (!ok) {
37085 | 1684 |     throw new Error("safeGoto-failed");
37086 | 1685 |   }
37087 | 1686 |   let currentUrl = page.url();
37088 | 1687 |   if (currentUrl.includes("/login")) {
37089 | 1688 |     console.log(
37090 | 1689 |       "[FB] Zamiast posta wylƒÖdowa≈Çem na /login?next=... ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
37091 | 1690 |     );
37092 | 1691 |     await fbLogin(page);
37093 | 1692 |     await sleepRandom(3000, 4500);
37094 | 1693 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
37095 | 1694 |     console.log(
37096 | 1695 |       "[FB] Stan sesji po fbLogin() z /login:",
37097 | 1696 |       loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
37098 | 1697 |     );
37099 | 1698 |     if (loggedAfterLogin) {
37100 | 1699 |       await safeGoto(page, postUrl, "post", {
37101 | 1700 |         waitUntil: "networkidle2",
37102 | 1701 |         timeout: NAV_TIMEOUT_MS,
37103 | 1702 |       });
37104 | 1703 |     } else {
37105 | 1704 |       console.log(
37106 | 1705 |         "[FB] Po fbLogin() z /login nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
37107 | 1706 |       );
37108 | 1707 |     }
37109 | 1708 |   }
37110 | 1709 |   await acceptCookies(page, "post-initial");
37111 | 1710 |   let loggedOnPost = false;
37112 | 1711 |   try {
37113 | 1712 |     loggedOnPost = await checkIfLogged(page);
37114 | 1713 |   } catch (e) {
37115 | 1714 |     console.log(
37116 | 1715 |       "[FB] checkIfLogged na widoku posta ‚Äì b≈ÇƒÖd:",
37117 | 1716 |       e?.message || e
37118 | 1717 |     );
37119 | 1718 |   }
37120 | 1719 |   if (!loggedOnPost) {
37121 | 1720 |     console.log(
37122 | 1721 |       "[FB] Na widoku posta brak aktywnej sesji (np. pasek 'Zaloguj siƒô') ‚Äì pr√≥bujƒô fbLogin() i wracam na posta."
37123 | 1722 |     );
37124 | 1723 |     await fbLogin(page);
37125 | 1724 |     await sleepRandom(3000, 4500);
37126 | 1725 |     const loggedAfterFbLogin = await checkIfLogged(page).catch(() => false);
37127 | 1726 |     console.log(
37128 | 1727 |       "[FB] Stan sesji po fbLogin() z widoku posta:",
37129 | 1728 |       loggedAfterFbLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"
37130 | 1729 |     );
37131 | 1730 |     if (loggedAfterFbLogin) {
37132 | 1731 |       console.log(
37133 | 1732 |         "[FB] Po fbLogin() wykryto zalogowanego u≈ºytkownika ‚Äì ponownie otwieram posta."
37134 | 1733 |       );
37135 | 1734 |       await safeGoto(page, postUrl, "post", {
37136 | 1735 |         waitUntil: "networkidle2",
37137 | 1736 |         timeout: NAV_TIMEOUT_MS,
37138 | 1737 |       });
37139 | 1738 |       await acceptCookies(page, "post-initial");
37140 | 1739 |     } else {
37141 | 1740 |       console.log(
37142 | 1741 |         "[FB] Po fbLogin() nadal wyglƒÖdamy na niezalogowanych (prawdopodobnie 2FA) ‚Äì kontynuujƒô jako go≈õƒá."
37143 | 1742 |       );
37144 | 1743 |     }
37145 | 1744 |   }
37146 | 1745 |   await ensureLoggedInOnPostOverlay(page);
37147 | 1746 |   await sleepRandom(3000, 4500);
37148 | 1747 |   await acceptCookies(page, "post");
37149 | 1748 |   try {
37150 | 1749 |     const loggedAfterPostOverlay = await checkIfLogged(page);
37151 | 1750 |     if (loggedAfterPostOverlay) {
37152 | 1751 |       console.log(
37153 | 1752 |         "[FB] Po wej≈õciu na posta jeste≈õmy zalogowani ‚Äì zapisujƒô cookies do cookies.json."
37154 | 1753 |       );
37155 | 1754 |       await saveCookies(page);
37156 | 1755 |     } else {
37157 | 1756 |       console.log(
37158 | 1757 |         "[FB] Po wej≈õciu na posta nadal wyglƒÖdamy na niezalogowanych ‚Äì cookies nie bƒôdƒÖ zapisane."
37159 | 1758 |       );
37160 | 1759 |     }
37161 | 1760 |   } catch (e) {
37162 | 1761 |     console.log(
37163 | 1762 |       "[FB] B≈ÇƒÖd podczas sprawdzania/zapisu cookies po wej≈õciu na posta:",
37164 | 1763 |       e?.message || e
37165 | 1764 |     );
37166 | 1765 |   }
37167 | 1766 |   await sleepRandom(1500, 2500);
37168 | 1767 |   const isWatchView = postUrl.includes("/watch/");
37169 | 1768 |   const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(postUrl);
37170 | 1769 |   const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(postUrl);
37171 | 1770 |   console.log(
37172 | 1771 |     "[FB] getCommentCount ‚Äì view type:",
37173 | 1772 |     isWatchView ? "WATCH" : isVideoView ? "VIDEO" : isPhotoView ? "PHOTO" : "POST"
37174 | 1773 |   );
37175 | 1774 |   if (isVideoView) {
37176 | 1775 |     await pauseVideoIfAny(page);
37177 | 1776 |     await clickShowAllCommentsIfPresent(page);
37178 | 1777 |   }
37179 | 1778 |   if (!isVideoView) {
37180 | 1779 |     await scrollPost(page, 200);
37181 | 1780 |     await sleepRandom(800, 1200);
37182 | 1781 |   }
37183 | 1782 |   try {
37184 | 1783 |     const okFilter = await switchCommentsFilterToAll(page);
37185 | 1784 |     console.log(
37186 | 1785 |       "[FB] Pierwsza pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
37187 | 1786 |       okFilter
37188 | 1787 |     );
37189 | 1788 |     if (okFilter) await sleepRandom(1200, 2000);
37190 | 1789 |   } catch (e) {
37191 | 1790 |     console.log(
37192 | 1791 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (pierwsza pr√≥ba):",
37193 | 1792 |       e.message
37194 | 1793 |     );
37195 | 1794 |   }
37196 | 1795 |   if (isVideoView) {
37197 | 1796 |     await pauseVideoIfAny(page);
37198 | 1797 |   }
37199 | 1798 |   const uiInfo = await getUiCommentInfo(page);
37200 | 1799 |   console.log("[DBG] Comments debug (skr√≥cone):", {
37201 | 1800 |     source: uiInfo?.source,
37202 | 1801 |     raw: uiInfo?.raw,
37203 | 1802 |     viewType: uiInfo?.viewType,
37204 | 1803 |     comments: uiInfo?.comments,
37205 | 1804 |   });
37206 | 1805 |   let expectedTotal = null;
37207 | 1806 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
37208 | 1807 |     expectedTotal = uiInfo.comments;
37209 | 1808 |   }
37210 | 1809 |   if (isVideoView) {
37211 | 1810 |     await clickMoreCommentsButtonsVideo(page);
37212 | 1811 |   }
37213 | 1812 |   if (isVideoView) {
37214 | 1813 |     await walkVideoCommentsSequential(page, expectedTotal || null);
37215 | 1814 |   } else {
37216 | 1815 |     await ensureAllCommentsLoaded(page, expectedTotal);
37217 | 1816 |   }
37218 | 1817 |   try {
37219 | 1818 |     const ok2 = await switchCommentsFilterToAll(page);
37220 | 1819 |     console.log(
37221 | 1820 |       "[FB] Druga pr√≥ba ustawienia filtra na 'Wszystkie komentarze':",
37222 | 1821 |       ok2
37223 | 1822 |     );
37224 | 1823 |     if (ok2) await sleepRandom(800, 1500);
37225 | 1824 |   } catch (e) {
37226 | 1825 |     console.log(
37227 | 1826 |       "[FB] B≈ÇƒÖd switchCommentsFilterToAll (druga pr√≥ba):",
37228 | 1827 |       e.message
37229 | 1828 |     );
37230 | 1829 |   }
37231 | 1830 |   const fallback = await page.evaluate(() => {
37232 | 1831 |     const root = document;
37233 | 1832 |     const anchors = Array.from(
37234 | 1833 |       root.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
37235 | 1834 |     );
37236 | 1835 |     const ids = new Set();
37237 | 1836 |     for (const a of anchors) {
37238 | 1837 |       try {
37239 | 1838 |         const url = new URL(a.href);
37240 | 1839 |         const cid = url.searchParams.get("comment_id");
37241 | 1840 |         const rid = url.searchParams.get("reply_comment_id");
37242 | 1841 |         let raw = rid || cid;
37243 | 1842 |         if (!raw) continue;
37244 | 1843 |         if (!/^\d+$/.test(raw)) {
37245 | 1844 |           try {
37246 | 1845 |             const dec = atob(raw);
37247 | 1846 |             const m = dec.match(/:(\d+)_([0-9]+)/);
37248 | 1847 |             if (m) raw = m[2];
37249 | 1848 |           } catch {}
37250 | 1849 |         }
37251 | 1850 |         if (raw) ids.add(raw);
37252 | 1851 |       } catch {}
37253 | 1852 |     }
37254 | 1853 |     return { count: ids.size };
37255 | 1854 |   });
37256 | 1855 |   console.log("[FB] Fallback ‚Äì anchor IDs:", fallback.count);
37257 | 1856 |   let finalNum = uiInfo?.comments ?? null;
37258 | 1857 |   if (fallback.count > 0) {
37259 | 1858 |     if (finalNum == null || finalNum === 0) {
37260 | 1859 |       finalNum = fallback.count;
37261 | 1860 |       console.log(
37262 | 1861 |         "[FB] UI puste/0 ‚Äì u≈ºywam anchor√≥w jako ≈∫r√≥d≈Ça.",
37263 | 1862 |         `anchor=${fallback.count}`
37264 | 1863 |       );
37265 | 1864 |     } else {
37266 | 1865 |       const diff = finalNum - fallback.count;
37267 | 1866 |       if (diff > 5) {
37268 | 1867 |         console.log(
37269 | 1868 |           "[FB] UI >> anchory ‚Äì czƒô≈õƒá komentarzy niedostƒôpna, u≈ºywam anchor√≥w.",
37270 | 1869 |           `ui=${finalNum}, anchor=${fallback.count}`
37271 | 1870 |         );
37272 | 1871 |         finalNum = fallback.count;
37273 | 1872 |       } else if (fallback.count > finalNum) {
37274 | 1873 |         console.log(
37275 | 1874 |           "[FB] Anchory > UI ‚Äì u≈ºywam anchor√≥w jako bazowej liczby.",
37276 | 1875 |           `ui=${finalNum}, anchor=${fallback.count}`
37277 | 1876 |         );
37278 | 1877 |         finalNum = fallback.count;
37279 | 1878 |       } else {
37280 | 1879 |         console.log(
37281 | 1880 |           "[FB] UI ~= anchory ‚Äì zostawiam UI jako ≈∫r√≥d≈Ço.",
37282 | 1881 |           `ui=${finalNum}, anchor=${fallback.count}`
37283 | 1882 |         );
37284 | 1883 |       }
37285 | 1884 |     }
37286 | 1885 |   } else {
37287 | 1886 |     console.log("[FB] Anchory=0 ‚Äì opieram siƒô wy≈ÇƒÖcznie na UI:", finalNum);
37288 | 1887 |   }
37289 | 1888 |   if (finalNum != null) {
37290 | 1889 |     console.log("[FB] Liczba komentarzy (final):", finalNum);
37291 | 1890 |     return finalNum;
37292 | 1891 |   }
37293 | 1892 |   console.log("[FB] Brak liczby komentarzy w UI i brak anchor√≥w, zwracam 0.");
37294 | 1893 |   return 0;
37295 | 1894 | }
37296 | 1895 | 
37297 | 1896 | /* ============================================================
37298 | 1897 |    ================= ROZWIJANIE KOMENTARZY ====================
37299 | 1898 |    ============================================================ */
37300 | 1899 | 
37301 | 1900 | async function expandAllComments(page) {
37302 | 1901 |   if (!EXPAND_COMMENTS) {
37303 | 1902 |     console.log("[FB] EXPAND_COMMENTS=false ‚Üí pomijam rozwijanie.");
37304 | 1903 |     return 0;
37305 | 1904 |   }
37306 | 1905 |   let clicks = 0;
37307 | 1906 |   for (let i = 0; i < 30; i++) {
37308 | 1907 |     const didClick = await clickOneExpandButton(page);
37309 | 1908 |     if (!didClick) break;
37310 | 1909 |     clicks++;
37311 | 1910 |     await sleepRandom(900, 1600);
37312 | 1911 |   }
37313 | 1912 |   return clicks;
37314 | 1913 | }
37315 | 1914 | 
37316 | 1915 | export async function extractCommentsData(page) {
37317 | 1916 |   try {
37318 | 1917 |     const comments = await extractCommentsFromDOM(page);
37319 | 1918 |     return comments;
37320 | 1919 |   } catch (err) {
37321 | 1920 |     console.error('[FB] extractCommentsData ‚Äì b≈ÇƒÖd:', err.message);
37322 | 1921 |     return [];
37323 | 1922 |   }
37324 | 1923 | }
37325 | 1924 | 
37326 | 1925 | export { getCommentCount, expandAllComments,  };
37327 | 1926 | 
37328 | ```
37329 | 
37330 | ---
37331 | 
37332 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/cookies.js`
37333 | **Typ:** JavaScript/tekst  
37334 | **Opis:** Plik projektu (kod/konfiguracja).  
37335 | 
37336 | ```js
37337 |   1 | // src/fb/cookies.js
37338 |   2 | 
37339 |   3 | import fs from "fs/promises";
37340 |   4 | import { sleepRandom } from "../utils/sleep.js";
37341 |   5 | 
37342 |   6 | 
37343 |   7 | 
37344 |   8 | // üîß POPRAWNA interpretacja COOKIES_READ_ONLY z .env
37345 |   9 | const COOKIES_READ_ONLY =
37346 |  10 |   String(process.env.COOKIES_READ_ONLY || "")
37347 |  11 |     .trim()
37348 |  12 |     .toLowerCase() === "true";
37349 |  13 | 
37350 |  14 | console.log(
37351 |  15 |   "[FB][cookies] COOKIES_READ_ONLY =",
37352 |  16 |   COOKIES_READ_ONLY,
37353 |  17 |   "(raw:",
37354 |  18 |   process.env.COOKIES_READ_ONLY,
37355 |  19 |   ")"
37356 |  20 | );
37357 |  21 | 
37358 |  22 | 
37359 |  23 | /**
37360 |  24 |  * ≈Åadowanie cookies z pliku cookies.json i wstrzykniƒôcie do strony.
37361 |  25 |  */
37362 |  26 | async function loadCookies(page) {
37363 |  27 |   try {
37364 |  28 |     const raw = await fs.readFile("cookies.json", "utf8");
37365 |  29 |     const cookies = JSON.parse(raw);
37366 |  30 | 
37367 |  31 |     if (Array.isArray(cookies) && cookies.length) {
37368 |  32 |       await page.setCookie(...cookies);
37369 |  33 |       console.log("[FB][cookies] Za≈Çadowano zapisane cookies (cookies.json).");
37370 |  34 |     } else {
37371 |  35 |       console.log(
37372 |  36 |         "[FB][cookies] cookies.json istnieje, ale nie zawiera poprawnej tablicy cookies."
37373 |  37 |       );
37374 |  38 |     }
37375 |  39 |   } catch (err) {
37376 |  40 |     console.log(
37377 |  41 |       "[FB][cookies] Brak zapisanych cookies lub b≈ÇƒÖd odczytu ‚Äì logowanie od zera.",
37378 |  42 |       err?.message || err
37379 |  43 |     );
37380 |  44 |   }
37381 |  45 | }
37382 |  46 | 
37383 |  47 | /**
37384 |  48 |  * Zapisuje aktualne cookies z przeglƒÖdarki do pliku cookies.json
37385 |  49 |  * w katalogu roboczym procesu (tam, skƒÖd odpalasz node).
37386 |  50 |  */
37387 |  51 | async function saveCookies(page) {
37388 |  52 |   if (COOKIES_READ_ONLY) {
37389 |  53 |     console.log(
37390 |  54 |       "[FB][cookies] COOKIES_READ_ONLY=true ‚Äì pomijam zapis cookies.json (tylko odczyt z pliku)."
37391 |  55 |     );
37392 |  56 |     return;
37393 |  57 |   }
37394 |  58 | 
37395 |  59 |   try {
37396 |  60 |     const cookies = await page.cookies();
37397 |  61 | 
37398 |  62 |     await fs.writeFile(
37399 |  63 |       "cookies.json",
37400 |  64 |       JSON.stringify(cookies, null, 2),
37401 |  65 |       "utf8"
37402 |  66 |     );
37403 |  67 | 
37404 |  68 |     console.log(
37405 |  69 |       `[FB][cookies] Zapisano cookies.json (liczba cookies: ${cookies.length}).`
37406 |  70 |     );
37407 |  71 |   } catch (e) {
37408 |  72 |     console.log(
37409 |  73 |       "[FB][cookies] B≈ÇƒÖd przy zapisie cookies.json:",
37410 |  74 |       e?.message || e
37411 |  75 |     );
37412 |  76 |   }
37413 |  77 | }
37414 |  78 | 
37415 |  79 | 
37416 |  80 | 
37417 |  81 | /**
37418 |  82 |  * Og√≥lne akceptowanie popupu cookies na FB (np. na postach).
37419 |  83 |  * label ‚Äì tylko do log√≥w (np. 'post', 'post-initial', 'login', itd.).
37420 |  84 |  */
37421 |  85 | async function acceptCookies(page, label = "global") {
37422 |  86 |   try {
37423 |  87 |     // chwila na pojawienie siƒô popupu
37424 |  88 |     await sleepRandom(800, 1500);
37425 |  89 | 
37426 |  90 |     const result = await page.evaluate(() => {
37427 |  91 |       const wanted = [
37428 |  92 |         "zezw√≥l na wszystkie pliki cookie",
37429 |  93 |         "zezw√≥l na wszystkie pliki",
37430 |  94 |         "akceptuj wszystkie pliki cookie",
37431 |  95 |         "akceptuj wszystkie",
37432 |  96 |         "allow all cookies",
37433 |  97 |         "accept all cookies",
37434 |  98 |         "accept essential and optional cookies",
37435 |  99 |         "tylko niezbƒôdne pliki cookie",
37436 | 100 |         "odrzuƒá opcjonalne pliki cookie",
37437 | 101 |       ].map((t) => t.toLowerCase());
37438 | 102 | 
37439 | 103 |       const buttons = Array.from(
37440 | 104 |         document.querySelectorAll("button, [role='button']")
37441 | 105 |       );
37442 | 106 | 
37443 | 107 |       let clicked = false;
37444 | 108 |       const texts = [];
37445 | 109 | 
37446 | 110 |       for (const btn of buttons) {
37447 | 111 |         const txt = (btn.innerText || btn.textContent || "").trim();
37448 | 112 |         if (!txt) continue;
37449 | 113 | 
37450 | 114 |         const low = txt.toLowerCase();
37451 | 115 |         texts.push(txt);
37452 | 116 | 
37453 | 117 |         if (wanted.some((w) => low.includes(w))) {
37454 | 118 |           btn.click();
37455 | 119 |           clicked = true;
37456 | 120 |           break;
37457 | 121 |         }
37458 | 122 |       }
37459 | 123 | 
37460 | 124 |       return { clicked, texts };
37461 | 125 |     });
37462 | 126 | 
37463 | 127 |     if (result.clicked) {
37464 | 128 |       console.log(
37465 | 129 |         `[FB][cookies-${label}] Klikniƒôto przycisk akceptacji cookies.`
37466 | 130 |       );
37467 | 131 |       await sleepRandom(1500, 2500);
37468 | 132 |     } else {
37469 | 133 |       console.log(
37470 | 134 |         `[FB][cookies-${label}] Nie znaleziono przycisku cookies. Teksty na przyciskach:`,
37471 | 135 |         result.texts
37472 | 136 |       );
37473 | 137 |     }
37474 | 138 |   } catch (err) {
37475 | 139 |     console.log(
37476 | 140 |       `[FB][cookies-${label}] B≈ÇƒÖd przy obs≈Çudze popupu cookies:`,
37477 | 141 |       err?.message || err
37478 | 142 |     );
37479 | 143 |   }
37480 | 144 | }
37481 | 145 | 
37482 | 146 | export { loadCookies, saveCookies, acceptCookies };
37483 | 147 | 
37484 | ```
37485 | 
37486 | ---
37487 | 
37488 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/cookies.json`
37489 | **Typ:** JSON  
37490 | **Opis:** Plik projektu (kod/konfiguracja).  
37491 | 
37492 | ```json
37493 |   1 | [
37494 |   2 |   {
37495 |   3 |     "name": "presence",
37496 |   4 |     "value": "C%7B%22t3%22%3A%5B%5D%2C%22utc3%22%3A1766424712903%2C%22v%22%3A1%7D",
37497 |   5 |     "domain": ".facebook.com",
37498 |   6 |     "path": "/",
37499 |   7 |     "expires": -1,
37500 |   8 |     "size": 75,
37501 |   9 |     "httpOnly": false,
37502 |  10 |     "secure": true,
37503 |  11 |     "session": true,
37504 |  12 |     "priority": "Medium",
37505 |  13 |     "sameParty": false,
37506 |  14 |     "sourceScheme": "Secure"
37507 |  15 |   },
37508 |  16 |   {
37509 |  17 |     "name": "oo",
37510 |  18 |     "value": "v1%7C3%3A1765999179",
37511 |  19 |     "domain": ".facebook.com",
37512 |  20 |     "path": "/",
37513 |  21 |     "expires": 1800559178.663726,
37514 |  22 |     "size": 21,
37515 |  23 |     "httpOnly": true,
37516 |  24 |     "secure": true,
37517 |  25 |     "session": false,
37518 |  26 |     "sameSite": "None",
37519 |  27 |     "priority": "Medium",
37520 |  28 |     "sameParty": false,
37521 |  29 |     "sourceScheme": "Secure"
37522 |  30 |   },
37523 |  31 |   {
37524 |  32 |     "name": "xs",
37525 |  33 |     "value": "47%3Ayi9zwhrdzuBVIw%3A2%3A1765999177%3A-1%3A-1%3A%3AAcyzLWUa4RYsYSWGVaAWF-8v_BXKW8MzXVn3OBRYLQ",
37526 |  34 |     "domain": ".facebook.com",
37527 |  35 |     "path": "/",
37528 |  36 |     "expires": 1797960539.317587,
37529 |  37 |     "size": 96,
37530 |  38 |     "httpOnly": true,
37531 |  39 |     "secure": true,
37532 |  40 |     "session": false,
37533 |  41 |     "sameSite": "None",
37534 |  42 |     "priority": "Medium",
37535 |  43 |     "sameParty": false,
37536 |  44 |     "sourceScheme": "Secure"
37537 |  45 |   },
37538 |  46 |   {
37539 |  47 |     "name": "wd",
37540 |  48 |     "value": "1366x768",
37541 |  49 |     "domain": ".facebook.com",
37542 |  50 |     "path": "/",
37543 |  51 |     "expires": 1767029512,
37544 |  52 |     "size": 10,
37545 |  53 |     "httpOnly": false,
37546 |  54 |     "secure": true,
37547 |  55 |     "session": false,
37548 |  56 |     "sameSite": "Lax",
37549 |  57 |     "priority": "Medium",
37550 |  58 |     "sameParty": false,
37551 |  59 |     "sourceScheme": "Secure"
37552 |  60 |   },
37553 |  61 |   {
37554 |  62 |     "name": "c_user",
37555 |  63 |     "value": "61584544438252",
37556 |  64 |     "domain": ".facebook.com",
37557 |  65 |     "path": "/",
37558 |  66 |     "expires": 1797960539.317325,
37559 |  67 |     "size": 20,
37560 |  68 |     "httpOnly": false,
37561 |  69 |     "secure": true,
37562 |  70 |     "session": false,
37563 |  71 |     "sameSite": "None",
37564 |  72 |     "priority": "Medium",
37565 |  73 |     "sameParty": false,
37566 |  74 |     "sourceScheme": "Secure"
37567 |  75 |   },
37568 |  76 |   {
37569 |  77 |     "name": "datr",
37570 |  78 |     "value": "LwJDaQvuIWjub0yGJMEnvvMZ",
37571 |  79 |     "domain": ".facebook.com",
37572 |  80 |     "path": "/",
37573 |  81 |     "expires": 1800559152.834742,
37574 |  82 |     "size": 28,
37575 |  83 |     "httpOnly": true,
37576 |  84 |     "secure": true,
37577 |  85 |     "session": false,
37578 |  86 |     "sameSite": "None",
37579 |  87 |     "priority": "Medium",
37580 |  88 |     "sameParty": false,
37581 |  89 |     "sourceScheme": "Secure"
37582 |  90 |   },
37583 |  91 |   {
37584 |  92 |     "name": "sb",
37585 |  93 |     "value": "LwJDaXGRlxl-i7CRj302m_8c",
37586 |  94 |     "domain": ".facebook.com",
37587 |  95 |     "path": "/",
37588 |  96 |     "expires": 1800559178.355148,
37589 |  97 |     "size": 26,
37590 |  98 |     "httpOnly": true,
37591 |  99 |     "secure": true,
37592 | 100 |     "session": false,
37593 | 101 |     "sameSite": "None",
37594 | 102 |     "priority": "Medium",
37595 | 103 |     "sameParty": false,
37596 | 104 |     "sourceScheme": "Secure"
37597 | 105 |   }
37598 | 106 | ]
37599 | ```
37600 | 
37601 | ---
37602 | 
37603 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/expandButtons.js`
37604 | **Typ:** JavaScript/tekst  
37605 | **Opis:** Plik projektu (kod/konfiguracja).  
37606 | 
37607 | ```js
37608 |   1 | // src/fb/expandButtons.js
37609 |   2 | // Centralny ‚Äûbutton classifier‚Äù dla wszystkich przycisk√≥w typu:
37610 |   3 | // - ‚ÄûWy≈õwietl wiƒôcej komentarzy / zobacz wiƒôcej komentarzy / view more comments‚Äù
37611 |   4 | // - ‚ÄûWy≈õwietl wszystkie X odpowiedzi / Wy≈õwietl 1 odpowied≈∫ / X replies‚Äù
37612 |   5 | // - ‚ÄûZobacz wiƒôcej / See more‚Äù (bez ‚ÄûZobacz t≈Çumaczenie‚Äù).
37613 |   6 | // Obs≈Çuga PL + EN + og√≥lne wzorce (comment/reply/more).
37614 |   7 | // Zwraca true, je≈õli CO≈ö zosta≈Ço klikniƒôte.
37615 |   8 | 
37616 |   9 | import { INCLUDE_REPLIES } from "../config.js";
37617 |  10 | 
37618 |  11 | async function clickOneExpandButton(page) {
37619 |  12 |   const res = await page.evaluate((includeReplies) => {
37620 |  13 |     const isPhotoView = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(
37621 |  14 |       location.href
37622 |  15 |     );
37623 |  16 |     const isWatchView = /\/watch\//i.test(location.href);
37624 |  17 |     const isVideoView = isWatchView || /\/videos\/|[\?&]v=/i.test(location.href); // üëà dodane /videos/
37625 |  18 | 
37626 |  19 |     function getPostRoot() {
37627 |  20 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
37628 |  21 |       const postDialog = dialogs.find((dlg) => {
37629 |  22 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
37630 |  23 |         if (!text) return false;
37631 |  24 |         const hasCommentWord =
37632 |  25 |           text.includes("komentarz") || text.includes("comment");
37633 |  26 |         const hasActions =
37634 |  27 |           text.includes("lubiƒô to") ||
37635 |  28 |           text.includes("komentarz") ||
37636 |  29 |           text.includes("udostƒôpnij") ||
37637 |  30 |           text.includes("napisz komentarz") ||
37638 |  31 |           text.includes("comment");
37639 |  32 |         const looksLikeNotifications =
37640 |  33 |           text.startsWith("powiadomienia") &&
37641 |  34 |           text.includes("wszystkie") &&
37642 |  35 |           text.includes("nieprzeczytane");
37643 |  36 |         return !looksLikeNotifications && hasCommentWord && hasActions;
37644 |  37 |       });
37645 |  38 |       if (postDialog) return postDialog;
37646 |  39 |       const main = document.querySelector("div[role='main']");
37647 |  40 |       if (main) {
37648 |  41 |         const article = main.querySelector("article");
37649 |  42 |         return article || main;
37650 |  43 |       }
37651 |  44 |       return document.body;
37652 |  45 |     }
37653 |  46 | 
37654 |  47 |     function isVisible(el) {
37655 |  48 |       if (!el) return false;
37656 |  49 |       const style = window.getComputedStyle(el);
37657 |  50 |       if (!style) return false;
37658 |  51 |       if (style.display === "none" || style.visibility === "hidden") return false;
37659 |  52 |       if (style.opacity && parseFloat(style.opacity) < 0.05) return false;
37660 |  53 |       if (style.pointerEvents === "none") return false;
37661 |  54 |       const rect = el.getBoundingClientRect();
37662 |  55 |       if (!rect || rect.width <= 0 || rect.height <= 0) return false;
37663 |  56 |       if (rect.bottom < 0 || rect.top > window.innerHeight) return false;
37664 |  57 |       return true;
37665 |  58 |     }
37666 |  59 | 
37667 |  60 |     // scope ‚Äì ca≈Çy dokument dla PHOTO/VIDEO, inaczej root posta
37668 |  61 |     const root =
37669 |  62 |       isPhotoView || isVideoView ? document : getPostRoot() || document;
37670 |  63 |     // (widok /watch/ jest traktowany jak video)
37671 |  64 | 
37672 |  65 |     const buttons = Array.from(
37673 |  66 |       root.querySelectorAll(
37674 |  67 |         "button, a, div[role='button'], span[role='button']"
37675 |  68 |       )
37676 |  69 |     );
37677 |  70 | 
37678 |  71 |     function classifyButton(raw) {
37679 |  72 |       const text = raw.toLowerCase();
37680 |  73 |       const hasCommentWord =
37681 |  74 |         text.includes("komentarz") ||
37682 |  75 |         text.includes("comments") ||
37683 |  76 |         text.includes("comment");
37684 |  77 |       const hasReplyWord =
37685 |  78 |         /odpowied≈∫|odpowiedz|odpowiedzi|odpowiedzia/.test(text) ||
37686 |  79 |         text.includes("reply") ||
37687 |  80 |         text.includes("replies") ||
37688 |  81 |         text.includes("repl");
37689 |  82 |       const hasMoreWord =
37690 |  83 |         text.includes("wy≈õwietl") ||
37691 |  84 |         text.includes("zobacz") ||
37692 |  85 |         text.includes("poka≈º") ||
37693 |  86 |         text.includes("view") ||
37694 |  87 |         text.includes("show") ||
37695 |  88 |         text.includes("see") ||
37696 |  89 |         text.includes("wszystkie") ||
37697 |  90 |         text.includes("all") ||
37698 |  91 |         text.includes("previous");
37699 |  92 |       const hasTranslationWord =
37700 |  93 |         text.includes("t≈Çumaczenie") || text.includes("translation");
37701 |  94 |       if (hasTranslationWord) return null;
37702 |  95 |       if (
37703 |  96 |         text === "komentarz" ||
37704 |  97 |         text === "comment" ||
37705 |  98 |         text === "lubiƒô to" ||
37706 |  99 |         text === "lubiƒô to!" ||
37707 | 100 |         text === "like" ||
37708 | 101 |         text === "odpowiedz" ||
37709 | 102 |         text === "reply"
37710 | 103 |       ) {
37711 | 104 |         return null;
37712 | 105 |       }
37713 | 106 |       if (
37714 | 107 |         hasCommentWord &&
37715 | 108 |         hasMoreWord &&
37716 | 109 |         (text.includes("wiƒôcej") ||
37717 | 110 |           text.includes("more") ||
37718 | 111 |           text.includes("poprzednie") ||
37719 | 112 |           text.includes("previous"))
37720 | 113 |       ) {
37721 | 114 |         return { kind: "more-comments", priority: 3 };
37722 | 115 |       }
37723 | 116 | 
37724 | 117 |       // ‚úÖ ON/OFF odpowiedzi
37725 | 118 |       if (includeReplies && hasReplyWord && (hasMoreWord || /\d/.test(text))) {
37726 | 119 |         return { kind: "more-replies", priority: 2 };
37727 | 120 |       }
37728 | 121 | 
37729 | 122 |       if (
37730 | 123 |         text === "zobacz wiƒôcej" ||
37731 | 124 |         text === "see more" ||
37732 | 125 |         text.startsWith("zobacz wiƒôcej ") ||
37733 | 126 |         text.startsWith("see more ")
37734 | 127 |       ) {
37735 | 128 |         return { kind: "see-more-text", priority: 1 };
37736 | 129 |       }
37737 | 130 |       return null;
37738 | 131 |     }
37739 | 132 | 
37740 | 133 |     const candidates = [];
37741 | 134 | 
37742 | 135 |     for (const el of buttons) {
37743 | 136 |       if (!isVisible(el)) continue;
37744 | 137 |       const raw = (el.textContent || "").replace(/\s+/g, " ").trim();
37745 | 138 |       if (!raw) continue;
37746 | 139 |       const cls = classifyButton(raw);
37747 | 140 |       if (!cls) continue;
37748 | 141 |       const rect = el.getBoundingClientRect();
37749 | 142 |       candidates.push({
37750 | 143 |         el,
37751 | 144 |         kind: cls.kind,
37752 | 145 |         priority: cls.priority,
37753 | 146 |         top: rect.top,
37754 | 147 |         text: raw,
37755 | 148 |       });
37756 | 149 |     }
37757 | 150 | 
37758 | 151 |     if (!candidates.length) {
37759 | 152 |       return { clicked: false };
37760 | 153 |     }
37761 | 154 | 
37762 | 155 |     candidates.sort((a, b) => {
37763 | 156 |       if (a.priority !== b.priority) return b.priority - a.priority;
37764 | 157 |       return a.top - b.top;
37765 | 158 |     });
37766 | 159 | 
37767 | 160 |     const chosen = candidates[0];
37768 | 161 |     try {
37769 | 162 |       chosen.el.click();
37770 | 163 |       return {
37771 | 164 |         clicked: true,
37772 | 165 |         kind: chosen.kind,
37773 | 166 |         text: chosen.text,
37774 | 167 |       };
37775 | 168 |     } catch (e) {
37776 | 169 |       return { clicked: false };
37777 | 170 |     }
37778 | 171 |   }, INCLUDE_REPLIES);
37779 | 172 | 
37780 | 173 |   if (res && res.clicked) {
37781 | 174 |     console.log(
37782 | 175 |       `[FB] -> klik expand '${res.text}' (kind=${res.kind})`
37783 | 176 |     );
37784 | 177 |   }
37785 | 178 |   return !!(res && res.clicked);
37786 | 179 | }
37787 | 180 | 
37788 | 181 | export { clickOneExpandButton };
37789 | 182 | 
37790 | ```
37791 | 
37792 | ---
37793 | 
37794 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/export_files.js`
37795 | **Typ:** JavaScript/tekst  
37796 | **Opis:** Plik projektu (kod/konfiguracja).  
37797 | 
37798 | ```js
37799 |  1 | // export_files.js
37800 |  2 | import fs from "fs";
37801 |  3 | import path from "path";
37802 |  4 | 
37803 |  5 | const FILES = [
37804 |  6 |   // ===== ROOT =====
37805 |  7 |   ".env",
37806 |  8 |   ".gitignore",
37807 |  9 |   "package.json",
37808 | 10 |   "package-lock.json",
37809 | 11 |   "cookies.json",
37810 | 12 | 
37811 | 13 |   // ===== CONFIG / DATA =====
37812 | 14 |   "config/links.js",
37813 | 15 |   "config/links.json",
37814 | 16 | 
37815 | 17 |   "data/comments-cache.json",
37816 | 18 | 
37817 | 19 |   // ===== SRC ‚Äì CORE =====
37818 | 20 |   "src/index.js",
37819 | 21 |   "src/config.js",
37820 | 22 |   "src/watcher.js",
37821 | 23 |   "src/webhook.js",
37822 | 24 | 
37823 | 25 |   // ===== SRC ‚Äì DB =====
37824 | 26 |   "src/db/cache.js",
37825 | 27 | 
37826 | 28 |   // ===== SRC ‚Äì UTILS =====
37827 | 29 |   "src/utils/navigation.js",
37828 | 30 |   "src/utils/sleep.js",
37829 | 31 | 
37830 | 32 |   // ===== SRC ‚Äì FB CORE =====
37831 | 33 |   "src/fb/comments.js",
37832 | 34 |   "src/fb/scroll.js",
37833 | 35 |   "src/fb/cookies.js",
37834 | 36 |   "src/fb/login.js",
37835 | 37 |   "src/fb/expandButtons.js",
37836 | 38 |   "src/fb/uiCommentInfo.js",
37837 | 39 | 
37838 | 40 |   // ===== SRC ‚Äì FB UI ROUTER =====
37839 | 41 |   "src/fb/ui/index.js",
37840 | 42 | 
37841 | 43 |   // ===== SRC ‚Äì FB UI HANDLERS =====
37842 | 44 |   "src/fb/ui/post.js",
37843 | 45 |   "src/fb/ui/photo.js",
37844 | 46 |   "src/fb/ui/videos.js",
37845 | 47 |   "src/fb/ui/watch.js",
37846 | 48 | 
37847 | 49 |   // ===== SRC ‚Äì FB LEGACY (BACKUP) =====
37848 | 50 |   "src/fb/legacy/comments.legacy.js",
37849 | 51 | 
37850 | 52 |   // ===== EXPORT / TOOLS =====
37851 | 53 |   "export_files.js"
37852 | 54 | ];
37853 | 55 | 
37854 | 56 | // folder docelowy
37855 | 57 | const EXPORT_DIR = path.join(process.cwd(), "export_fb_watcher");
37856 | 58 | 
37857 | 59 | // tworzymy folder, je≈õli nie istnieje
37858 | 60 | if (!fs.existsSync(EXPORT_DIR)) {
37859 | 61 |   fs.mkdirSync(EXPORT_DIR, { recursive: true });
37860 | 62 | }
37861 | 63 | 
37862 | 64 | FILES.forEach((file) => {
37863 | 65 |   const srcPath = path.join(process.cwd(), file);
37864 | 66 |   const dstPath = path.join(EXPORT_DIR, path.basename(file));
37865 | 67 | 
37866 | 68 |   if (fs.existsSync(srcPath)) {
37867 | 69 |     fs.copyFileSync(srcPath, dstPath);
37868 | 70 |     console.log(`‚úì Wyeksportowano: ${file}`);
37869 | 71 |   } else {
37870 | 72 |     console.log(`‚ö†Ô∏è Nie znaleziono pliku: ${file}`);
37871 | 73 |   }
37872 | 74 | });
37873 | 75 | 
37874 | 76 | console.log("\n=== EKSPORT ZAKO≈ÉCZONY ===");
37875 | 77 | console.log(`Pliki znajdziesz tu: ${EXPORT_DIR}`);
37876 | 78 | 
37877 | ```
37878 | 
37879 | ---
37880 | 
37881 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/index.html`
37882 | **Typ:** HTML  
37883 | **Opis:** Plik projektu (kod/konfiguracja).  
37884 | 
37885 | ```html
37886 |   1 | <!doctype html>
37887 |   2 | <html lang="pl">
37888 |   3 | <head>
37889 |   4 |   <meta charset="utf-8" />
37890 |   5 |   <meta name="viewport" content="width=device-width,initial-scale=1" />
37891 |   6 |   <title>Panel FB Watcher</title>
37892 |   7 | 
37893 |   8 |   <style>
37894 |   9 |     :root{
37895 |  10 |       --bg:#0b0f14;
37896 |  11 |       --card:#121926;
37897 |  12 |       --card2:#0b1220;
37898 |  13 |       --border:#223047;
37899 |  14 |       --border2:#2a3a55;
37900 |  15 |       --text:#e7eef7;
37901 |  16 |       --muted:rgba(231,238,247,.75);
37902 |  17 |       --primary:#2563eb;
37903 |  18 |       --danger:#b91c1c;
37904 |  19 |       --ok:#34d399;
37905 |  20 |       --err:#f87171;
37906 |  21 |       --shadow: 0 10px 30px rgba(0,0,0,.35);
37907 |  22 |       --radius:14px;
37908 |  23 |     }
37909 |  24 | 
37910 |  25 |     * { box-sizing:border-box; }
37911 |  26 |     body {
37912 |  27 |       font-family: system-ui, Arial;
37913 |  28 |       margin: 16px;
37914 |  29 |       background: var(--bg);
37915 |  30 |       color: var(--text);
37916 |  31 |     }
37917 |  32 | 
37918 |  33 |     h2 { margin: 6px 0 6px; }
37919 |  34 |     h3 { margin: 6px 0 12px; }
37920 |  35 | 
37921 |  36 |     .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
37922 |  37 |     .card {
37923 |  38 |       background: var(--card);
37924 |  39 |       border:1px solid var(--border);
37925 |  40 |       border-radius: var(--radius);
37926 |  41 |       padding:14px;
37927 |  42 |       margin:12px 0;
37928 |  43 |       box-shadow: var(--shadow);
37929 |  44 |     }
37930 |  45 | 
37931 |  46 |     input, textarea, button, select {
37932 |  47 |       font: inherit;
37933 |  48 |       border-radius:12px;
37934 |  49 |       border:1px solid var(--border2);
37935 |  50 |       background: var(--card2);
37936 |  51 |       color: var(--text);
37937 |  52 |       padding:10px 12px;
37938 |  53 |       outline: none;
37939 |  54 |     }
37940 |  55 |     input:focus, textarea:focus, select:focus {
37941 |  56 |       border-color: rgba(37, 99, 235, .75);
37942 |  57 |       box-shadow: 0 0 0 4px rgba(37, 99, 235, .18);
37943 |  58 |     }
37944 |  59 | 
37945 |  60 |     input, textarea { width: 100%; }
37946 |  61 |     textarea { resize: vertical; min-height: 90px; }
37947 |  62 | 
37948 |  63 |     button { cursor:pointer; transition: transform .04s ease, opacity .2s ease, background .2s ease; }
37949 |  64 |     button:active { transform: translateY(1px); }
37950 |  65 |     button.primary { background: var(--primary); border-color: var(--primary); }
37951 |  66 |     button.danger { background: var(--danger); border-color: var(--danger); }
37952 |  67 |     button.ghost { background: transparent; }
37953 |  68 |     button.small { padding:8px 10px; border-radius: 10px; }
37954 |  69 | 
37955 |  70 |     label { font-size:12px; opacity:0.85; display:block; margin:8px 0 6px; }
37956 |  71 | 
37957 |  72 |     .muted { opacity:0.78; font-size:12px; }
37958 |  73 |     .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
37959 |  74 | 
37960 |  75 |     .sep { height:1px; background: var(--border); margin:10px 0; opacity:0.8; }
37961 |  76 | 
37962 |  77 |     .thumb {
37963 |  78 |       width:64px; height:40px;
37964 |  79 |       object-fit:cover;
37965 |  80 |       border-radius:10px;
37966 |  81 |       border:1px solid var(--border);
37967 |  82 |       background: var(--card2);
37968 |  83 |     }
37969 |  84 | 
37970 |  85 |     /* ===== tabela ===== */
37971 |  86 |     .tableWrap {
37972 |  87 |       width: 100%;
37973 |  88 |       overflow-x: auto;
37974 |  89 |       border-radius: 12px;
37975 |  90 |       border: 1px solid rgba(34,48,71,.45);
37976 |  91 |       background: rgba(11,18,32,.25);
37977 |  92 |     }
37978 |  93 | 
37979 |  94 |     table { width:100%; border-collapse: collapse; table-layout: fixed; min-width: 980px; }
37980 |  95 |     th, td {
37981 |  96 |       border-bottom:1px solid rgba(34,48,71,.7);
37982 |  97 |       padding:10px;
37983 |  98 |       text-align:left;
37984 |  99 |       vertical-align:top;
37985 | 100 |       overflow-wrap:anywhere;
37986 | 101 |       word-break:break-word;
37987 | 102 |     }
37988 | 103 |     th { font-size: 12px; opacity:.9; position: sticky; top: 0; background: rgba(18,25,38,.96); backdrop-filter: blur(8px); }
37989 | 104 | 
37990 | 105 |     /* kolumny */
37991 | 106 |     th.col-id,  td.col-id  { width: 170px; }
37992 | 107 |     th.col-url, td.col-url { width: 620px; } /* szersza kolumna link */
37993 | 108 |     th.col-name,td.col-name{ width: 170px; }
37994 | 109 |     th.col-img, td.col-img { width: 120px; }
37995 | 110 |     th.col-desc,td.col-desc{ width: 260px; }
37996 | 111 |     th.col-act, td.col-act { width: 110px; text-align:center; }
37997 | 112 |     th.col-btn, td.col-btn { width: 210px; } /* miejsce na Edytuj + Usu≈Ñ */
37998 | 113 | 
37999 | 114 |     /* URL: pe≈Çny, zawijany */
38000 | 115 |     td.col-url a{
38001 | 116 |       color: #93c5fd;
38002 | 117 |       text-decoration: underline;
38003 | 118 |       white-space: normal;
38004 | 119 |       overflow-wrap:anywhere;
38005 | 120 |       word-break:break-word;
38006 | 121 |       display:inline;
38007 | 122 |     }
38008 | 123 | 
38009 | 124 |     /* wrapper dla linka + ikonki kopiuj */
38010 | 125 |     .urlWrap{
38011 | 126 |       display:flex;
38012 | 127 |       align-items:flex-start;
38013 | 128 |       gap:10px;
38014 | 129 |     }
38015 | 130 |     .urlWrap a{
38016 | 131 |       flex: 1;
38017 | 132 |       min-width: 0;
38018 | 133 |     }
38019 | 134 | 
38020 | 135 |     /* ikonka kopiuj ‚Äì ma≈Ça, jak w necie */
38021 | 136 |     .iconBtn{
38022 | 137 |       width: 28px;
38023 | 138 |       height: 28px;
38024 | 139 |       padding: 0;
38025 | 140 |       display:inline-flex;
38026 | 141 |       align-items:center;
38027 | 142 |       justify-content:center;
38028 | 143 |       border-radius: 10px;
38029 | 144 |       background: transparent;
38030 | 145 |       border: 1px solid rgba(42,58,85,.9);
38031 | 146 |       opacity: .9;
38032 | 147 |       flex: 0 0 auto;
38033 | 148 |     }
38034 | 149 |     .iconBtn:hover{
38035 | 150 |       opacity: 1;
38036 | 151 |       background: rgba(37,99,235,.15);
38037 | 152 |     }
38038 | 153 |     .iconBtn:active{
38039 | 154 |       transform: translateY(1px);
38040 | 155 |     }
38041 | 156 |     .iconBtn svg{
38042 | 157 |       width: 16px;
38043 | 158 |       height: 16px;
38044 | 159 |       fill: none;
38045 | 160 |       stroke: rgba(231,238,247,.95);
38046 | 161 |       stroke-width: 2;
38047 | 162 |       stroke-linecap: round;
38048 | 163 |       stroke-linejoin: round;
38049 | 164 |     }
38050 | 165 | 
38051 | 166 |     /* akcje w tabeli */
38052 | 167 |     .actionsWrap{
38053 | 168 |       display:flex;
38054 | 169 |       gap:10px;
38055 | 170 |       align-items:center;
38056 | 171 |       justify-content:flex-start;
38057 | 172 |       flex-wrap:nowrap;
38058 | 173 |     }
38059 | 174 | 
38060 | 175 |     /* ===== status ===== */
38061 | 176 |     .hint { margin-top:10px; }
38062 | 177 |     .hint.ok { color: #a7f3d0; }
38063 | 178 |     .hint.err { color: #fca5a5; }
38064 | 179 | 
38065 | 180 |     /* ===== logi: proporcje ===== */
38066 | 181 |     .logsBox {
38067 | 182 |       display:flex;
38068 | 183 |       flex-direction: column;
38069 | 184 |       gap:10px;
38070 | 185 |     }
38071 | 186 |     #logs {
38072 | 187 |       height: 200px;
38073 | 188 |       min-height: 160px;
38074 | 189 |       max-height: 520px;
38075 | 190 |     }
38076 | 191 |     .logsExpanded #logs { height: 420px; }
38077 | 192 | 
38078 | 193 |     /* ===== modal ===== */
38079 | 194 |     .modalOverlay{
38080 | 195 |       position: fixed;
38081 | 196 |       inset: 0;
38082 | 197 |       background: rgba(0,0,0,.55);
38083 | 198 |       display:none;
38084 | 199 |       align-items:center;
38085 | 200 |       justify-content:center;
38086 | 201 |       padding: 18px;
38087 | 202 |       z-index: 9999;
38088 | 203 |     }
38089 | 204 |     .modalOverlay.show{ display:flex; }
38090 | 205 |     .modal{
38091 | 206 |       width: min(640px, 100%);
38092 | 207 |       border-radius: 16px;
38093 | 208 |       border: 1px solid rgba(34,48,71,.9);
38094 | 209 |       background: rgba(18,25,38,.98);
38095 | 210 |       box-shadow: 0 20px 60px rgba(0,0,0,.55);
38096 | 211 |       padding: 16px;
38097 | 212 |     }
38098 | 213 |     .modal h4{ margin:0 0 8px; font-size: 16px; }
38099 | 214 |     .modal .modalBody{ color: rgba(231,238,247,.85); font-size: 13px; line-height: 1.45; }
38100 | 215 |     .modal .modalActions{
38101 | 216 |       display:flex;
38102 | 217 |       justify-content:flex-end;
38103 | 218 |       gap:10px;
38104 | 219 |       margin-top: 14px;
38105 | 220 |     }
38106 | 221 |     .kbd{
38107 | 222 |       font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
38108 | 223 |       font-size: 12px;
38109 | 224 |       opacity:.9;
38110 | 225 |       padding: 2px 6px;
38111 | 226 |       border:1px solid rgba(42,58,85,.9);
38112 | 227 |       border-radius: 8px;
38113 | 228 |       background: rgba(11,18,32,.55);
38114 | 229 |     }
38115 | 230 | 
38116 | 231 |     @media (max-width: 860px){
38117 | 232 |       table { min-width: 980px; }
38118 | 233 |     }
38119 | 234 |   </style>
38120 | 235 | </head>
38121 | 236 | 
38122 | 237 | <body>
38123 | 238 |   <h2>FB Watcher ‚Äî Panel</h2>
38124 | 239 |   <div class="muted">Panel dzia≈Ça lokalnie. Token jest wymagany do akcji.</div>
38125 | 240 | 
38126 | 241 |   <div class="card">
38127 | 242 |     <div class="row">
38128 | 243 |       <div style="flex:1; min-width:260px;">
38129 | 244 |         <label>Token panelu</label>
38130 | 245 |         <input id="token" placeholder="PANEL_TOKEN z .env" />
38131 | 246 |       </div>
38132 | 247 |       <div style="display:flex; gap:10px; align-items:flex-end;">
38133 | 248 |         <button class="primary" id="saveToken">Zapisz token</button>
38134 | 249 |         <button id="refresh">Od≈õwie≈º</button>
38135 | 250 |       </div>
38136 | 251 |     </div>
38137 | 252 | 
38138 | 253 |     <div id="status" class="muted hint" style="margin-top:10px;"></div>
38139 | 254 |   </div>
38140 | 255 | 
38141 | 256 |   <div class="card">
38142 | 257 |     <h3>Ustawienia (.env)</h3>
38143 | 258 | 
38144 | 259 |     <div class="row">
38145 | 260 |       <div style="flex:1; min-width:260px;">
38146 | 261 |         <label>E-mail Facebook</label>
38147 | 262 |         <input id="FB_EMAIL" />
38148 | 263 |       </div>
38149 | 264 |       <div style="flex:1; min-width:260px;">
38150 | 265 |         <label>Has≈Ço Facebook</label>
38151 | 266 |         <input id="FB_PASSWORD" type="password" />
38152 | 267 |       </div>
38153 | 268 |     </div>
38154 | 269 | 
38155 | 270 |     <label>Webhook (URL)</label>
38156 | 271 |     <input id="WEBHOOK_URL" />
38157 | 272 | 
38158 | 273 |     <div class="row">
38159 | 274 |       <div style="flex:1; min-width:220px;">
38160 | 275 |         <label>Interwa≈Ç sprawdzania (ms)</label>
38161 | 276 |         <input id="CHECK_INTERVAL_MS" />
38162 | 277 |       </div>
38163 | 278 |       <div style="flex:2; min-width:260px;">
38164 | 279 |         <label>Arkusz z postami (CSV export)</label>
38165 | 280 |         <input id="POSTS_SHEET_URL" />
38166 | 281 |       </div>
38167 | 282 |     </div>
38168 | 283 | 
38169 | 284 |     <div class="row">
38170 | 285 |       <div style="flex:1; min-width:220px;">
38171 | 286 |         <label>Tryb bez okna (headless)</label>
38172 | 287 |         <select id="HEADLESS_BROWSER">
38173 | 288 |           <option value="true">true</option>
38174 | 289 |           <option value="false">false</option>
38175 | 290 |         </select>
38176 | 291 |       </div>
38177 | 292 |       <div style="flex:1; min-width:220px;">
38178 | 293 |         <label>Obs≈Çuga UI (handlery)</label>
38179 | 294 |         <select id="USE_UI_HANDLERS">
38180 | 295 |           <option value="true">true</option>
38181 | 296 |           <option value="false">false</option>
38182 | 297 |         </select>
38183 | 298 |       </div>
38184 | 299 |       <div style="flex:1; min-width:220px;">
38185 | 300 |         <label>Uwzglƒôdniaj odpowiedzi</label>
38186 | 301 |         <select id="INCLUDE_REPLIES">
38187 | 302 |           <option value="true">true</option>
38188 | 303 |           <option value="false">false</option>
38189 | 304 |         </select>
38190 | 305 |       </div>
38191 | 306 |     </div>
38192 | 307 | 
38193 | 308 |     <div class="row" style="margin-top:10px;">
38194 | 309 |       <button class="primary" id="saveEnv">Zapisz ustawienia</button>
38195 | 310 |       <button id="pm2Start">Start watchera</button>
38196 | 311 |       <button id="pm2Stop">Stop watchera</button>
38197 | 312 |       <button id="pm2Restart">Restart watchera</button>
38198 | 313 |       <button class="danger" id="clearCookies">Wyczy≈õƒá cookies</button>
38199 | 314 |     </div>
38200 | 315 | 
38201 | 316 |     <div id="envMsg" class="muted hint" style="margin-top:10px;"></div>
38202 | 317 |   </div>
38203 | 318 | 
38204 | 319 |   <div class="card">
38205 | 320 |     <h3>Posty (data/posts.json)</h3>
38206 | 321 | 
38207 | 322 |     <div class="row">
38208 | 323 |       <div style="flex:2; min-width:260px;">
38209 | 324 |         <label>Nowy URL posta</label>
38210 | 325 |         <input id="newPostUrl" placeholder="https://www.facebook.com/..." />
38211 | 326 |       </div>
38212 | 327 | 
38213 | 328 |       <div style="flex:1; min-width:220px;">
38214 | 329 |         <label>Nazwa</label>
38215 | 330 |         <input id="newPostName" placeholder="np. A1" />
38216 | 331 |       </div>
38217 | 332 | 
38218 | 333 |       <div style="flex:1; min-width:260px;">
38219 | 334 |         <label>URL zdjƒôcia</label>
38220 | 335 |         <input id="newPostImage" placeholder="https://...jpg" />
38221 | 336 |       </div>
38222 | 337 |     </div>
38223 | 338 | 
38224 | 339 |     <label>Opis</label>
38225 | 340 |     <textarea id="newPostDescription" placeholder="Kr√≥tki opis..."></textarea>
38226 | 341 | 
38227 | 342 |     <div class="row" style="margin-top:10px;">
38228 | 343 |       <div style="min-width:220px; display:flex; align-items:center; gap:10px;">
38229 | 344 |         <label style="margin:0; display:flex; align-items:center; gap:10px;">
38230 | 345 |           <input type="checkbox" id="newPostActive" checked /> aktywny
38231 | 346 |         </label>
38232 | 347 |         <button class="primary" id="addPost">Dodaj</button>
38233 | 348 |       </div>
38234 | 349 |     </div>
38235 | 350 | 
38236 | 351 |     <div style="margin-top:12px;" class="tableWrap">
38237 | 352 |       <table>
38238 | 353 |         <thead>
38239 | 354 |           <tr>
38240 | 355 |             <th class="col-id">ID</th>
38241 | 356 |             <th class="col-url">Link</th>
38242 | 357 |             <th class="col-name">Nazwa</th>
38243 | 358 |             <th class="col-img">Zdjƒôcie</th>
38244 | 359 |             <th class="col-desc">Opis</th>
38245 | 360 |             <th class="col-act">Aktywny</th>
38246 | 361 |             <th class="col-btn">Akcje</th>
38247 | 362 |           </tr>
38248 | 363 |         </thead>
38249 | 364 |         <tbody id="posts"></tbody>
38250 | 365 |       </table>
38251 | 366 |     </div>
38252 | 367 |   </div>
38253 | 368 | 
38254 | 369 |   <div class="card" id="logsCard">
38255 | 370 |     <div class="row" style="justify-content:space-between; align-items:center;">
38256 | 371 |       <h3 style="margin:0;">Logi</h3>
38257 | 372 |       <button class="small ghost" id="toggleLogsSize" title="Rozwi≈Ñ / zwin logi">
38258 | 373 |         Rozwi≈Ñ
38259 | 374 |       </button>
38260 | 375 |     </div>
38261 | 376 | 
38262 | 377 |     <div class="logsBox">
38263 | 378 |       <div class="row">
38264 | 379 |         <button id="loadOut">Wyj≈õcie (OUT)</button>
38265 | 380 |         <button id="loadErr">B≈Çƒôdy (ERR)</button>
38266 | 381 | 
38267 | 382 |         <input id="logLines" style="width:120px;" value="200" title="Ile linii wczytaƒá" />
38268 | 383 | 
38269 | 384 |         <select id="logAutoEvery" style="width:160px;" title="Jak czƒôsto od≈õwie≈ºaƒá">
38270 | 385 |           <option value="0">auto: wy≈Ç.</option>
38271 | 386 |           <option value="1000">co 1 s</option>
38272 | 387 |           <option value="2000" selected>co 2 s</option>
38273 | 388 |           <option value="5000">co 5 s</option>
38274 | 389 |           <option value="10000">co 10 s</option>
38275 | 390 |         </select>
38276 | 391 | 
38277 | 392 |         <button class="primary" id="logAutoToggle">Auto: WY≈Å</button>
38278 | 393 | 
38279 | 394 |         <label style="margin:0; display:flex; align-items:center; gap:8px;" class="muted">
38280 | 395 |           <input type="checkbox" id="logAutoScroll" checked />
38281 | 396 |           auto-scroll
38282 | 397 |         </label>
38283 | 398 |       </div>
38284 | 399 | 
38285 | 400 |       <div class="sep"></div>
38286 | 401 | 
38287 | 402 |       <textarea
38288 | 403 |         id="logs"
38289 | 404 |         class="mono"
38290 | 405 |         readonly
38291 | 406 |         spellcheck="false"
38292 | 407 |         placeholder="Kliknij ‚ÄûWyj≈õcie (OUT)‚Äù albo ‚ÄûB≈Çƒôdy (ERR)‚Äù, ≈ºeby wczytaƒá logi..."></textarea>
38293 | 408 | 
38294 | 409 |       <div id="logHint" class="muted hint"></div>
38295 | 410 |     </div>
38296 | 411 |   </div>
38297 | 412 | 
38298 | 413 |   <!-- modal -->
38299 | 414 |   <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
38300 | 415 |     <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
38301 | 416 |       <h4 id="modalTitle">Potwierdzenie</h4>
38302 | 417 |       <div class="modalBody" id="modalBody"></div>
38303 | 418 |       <div class="modalActions">
38304 | 419 |         <button id="modalCancel">Anuluj</button>
38305 | 420 |         <button class="danger" id="modalOk">Usu≈Ñ</button>
38306 | 421 |       </div>
38307 | 422 |       <div class="muted" style="margin-top:10px;">
38308 | 423 |         Skr√≥t: <span class="kbd">Esc</span> zamyka okno.
38309 | 424 |       </div>
38310 | 425 |     </div>
38311 | 426 |   </div>
38312 | 427 | 
38313 | 428 |   <script src="/app.js"></script>
38314 | 429 | </body>
38315 | 430 | </html>
38316 | 431 | 
38317 | ```
38318 | 
38319 | ---
38320 | 
38321 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/index.js`
38322 | **Typ:** JavaScript/tekst  
38323 | **Opis:** Plik projektu (kod/konfiguracja).  
38324 | 
38325 | ```js
38326 |  1 | // src/fb/ui/index.js
38327 |  2 | import * as PostUI from "./post.js";
38328 |  3 | import * as PhotoUI from "./photo.js";
38329 |  4 | import * as WatchUI from "./watch.js";
38330 |  5 | import * as VideosUI from "./videos.js";
38331 |  6 | 
38332 |  7 | const HANDLERS = [WatchUI, VideosUI, PhotoUI, PostUI];
38333 |  8 | 
38334 |  9 | export function pickUiHandler(url) {
38335 | 10 |   const u = String(url || "");
38336 | 11 |   for (const h of HANDLERS) {
38337 | 12 |     try {
38338 | 13 |       if (h.matchesUrl(u)) return h;
38339 | 14 |     } catch {}
38340 | 15 |   }
38341 | 16 |   return PostUI;
38342 | 17 | }
38343 | 18 | 
38344 | ```
38345 | 
38346 | ---
38347 | 
38348 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/links.js`
38349 | **Typ:** JavaScript/tekst  
38350 | **Opis:** Plik projektu (kod/konfiguracja).  
38351 | 
38352 | ```js
38353 |   1 | // src/config/links.js
38354 |   2 | import fs from "fs";
38355 |   3 | import path from "path";
38356 |   4 | 
38357 |   5 | // Je≈õli masz Node <18, odkomentuj te dwie linijki:
38358 |   6 | // import fetch from "node-fetch";
38359 |   7 | // global.fetch = fetch;
38360 |   8 | 
38361 |   9 | const LINKS_SHEET_URL = process.env.LINKS_SHEET_URL;
38362 |  10 | const LOCAL_FILE = path.join(process.cwd(), "config", "links.json");
38363 |  11 | 
38364 |  12 | let linksCache = [];
38365 |  13 | let lastHash = null;
38366 |  14 | 
38367 |  15 | /* ============================================
38368 |  16 |    Prost y "hash" listy link√≥w
38369 |  17 |    ============================================ */
38370 |  18 | function calcHash(urls) {
38371 |  19 |   return urls.join("|");
38372 |  20 | }
38373 |  21 | 
38374 |  22 | /* ============================================
38375 |  23 |    Wczytanie lokalnego pliku JSON
38376 |  24 |    ============================================ */
38377 |  25 | function loadLinksFromLocalFile() {
38378 |  26 |   try {
38379 |  27 |     const raw = fs.readFileSync(LOCAL_FILE, "utf8");
38380 |  28 |     const data = JSON.parse(raw);
38381 |  29 | 
38382 |  30 |     if (Array.isArray(data.links)) {
38383 |  31 |       const cleaned = data.links
38384 |  32 |         .filter((u) => typeof u === "string")
38385 |  33 |         .map((u) => u.trim())
38386 |  34 |         .filter((u) => u.startsWith("http"));
38387 |  35 | 
38388 |  36 |       console.log("[CFG] Za≈Çadowane linki z lokalnego pliku:", cleaned);
38389 |  37 |       return cleaned;
38390 |  38 |     }
38391 |  39 | 
38392 |  40 |     console.warn("[CFG] Lokalny links.json nie zawiera poprawnego pola 'links'");
38393 |  41 |     return [];
38394 |  42 |   } catch (err) {
38395 |  43 |     console.warn("[CFG] Brak / b≈ÇƒÖd wczytywania links.json:", err.message);
38396 |  44 |     return [];
38397 |  45 |   }
38398 |  46 | }
38399 |  47 | 
38400 |  48 | /* ============================================
38401 |  49 |    Parser CSV z Sheetsa
38402 |  50 |    ============================================ */
38403 |  51 | function parseCsv(text) {
38404 |  52 |   const hasSemicolon = text.includes(";");
38405 |  53 |   const delimiter = hasSemicolon ? ";" : ",";
38406 |  54 | 
38407 |  55 |   const lines = text
38408 |  56 |     .split(/\r?\n/)
38409 |  57 |     .map((l) => l.trim())
38410 |  58 |     .filter(Boolean);
38411 |  59 | 
38412 |  60 |   if (!lines.length) {
38413 |  61 |     return [];
38414 |  62 |   }
38415 |  63 | 
38416 |  64 |   const header = lines[0].split(delimiter).map((h) => h.trim().toLowerCase());
38417 |  65 | 
38418 |  66 |   const idxActive = header.indexOf("active");
38419 |  67 |   const idxUrl = header.indexOf("url");
38420 |  68 | 
38421 |  69 |   if (idxUrl === -1) {
38422 |  70 |     console.warn("[CFG] W CSV nie znaleziono kolumny 'url'");
38423 |  71 |     return [];
38424 |  72 |   }
38425 |  73 | 
38426 |  74 |   const rows = [];
38427 |  75 | 
38428 |  76 |   for (let i = 1; i < lines.length; i++) {
38429 |  77 |     const cols = lines[i].split(delimiter).map((c) => c.trim());
38430 |  78 | 
38431 |  79 |     const url = cols[idxUrl] || "";
38432 |  80 |     if (!url || !url.startsWith("http")) continue;
38433 |  81 | 
38434 |  82 |     let active = true;
38435 |  83 | 
38436 |  84 |     if (idxActive !== -1) {
38437 |  85 |       const val = (cols[idxActive] || "").toLowerCase();
38438 |  86 |       active = val === "true" || val === "1" || val === "yes" || val === "y";
38439 |  87 |     }
38440 |  88 | 
38441 |  89 |     if (!active) continue;
38442 |  90 | 
38443 |  91 |     rows.push(url);
38444 |  92 |   }
38445 |  93 | 
38446 |  94 |   return rows;
38447 |  95 | }
38448 |  96 | 
38449 |  97 | /* ============================================
38450 |  98 |    Pobranie link√≥w z Sheeta lub lokalnie
38451 |  99 |    ============================================ */
38452 | 100 | async function fetchLinks() {
38453 | 101 |   if (!LINKS_SHEET_URL) {
38454 | 102 |     console.warn("[CFG] Brak LINKS_SHEET_URL w .env ‚Äì u≈ºywam lokalnego pliku");
38455 | 103 |     return loadLinksFromLocalFile();
38456 | 104 |   }
38457 | 105 | 
38458 | 106 |   try {
38459 | 107 |     console.log("[CFG] Pobieram linki z Google Sheeta...");
38460 | 108 |     const res = await fetch(LINKS_SHEET_URL);
38461 | 109 | 
38462 | 110 |     if (!res.ok) {
38463 | 111 |       console.warn("[CFG] B≈ÇƒÖd HTTP przy pobieraniu CSV:", res.status, res.statusText);
38464 | 112 |       return loadLinksFromLocalFile();
38465 | 113 |     }
38466 | 114 | 
38467 | 115 |     const text = await res.text();
38468 | 116 |     const urls = parseCsv(text);
38469 | 117 |     const unique = [...new Set(urls)];
38470 | 118 | 
38471 | 119 |     // backup
38472 | 120 |     const payload = { links: unique };
38473 | 121 |     fs.mkdirSync(path.dirname(LOCAL_FILE), { recursive: true });
38474 | 122 |     fs.writeFileSync(LOCAL_FILE, JSON.stringify(payload, null, 2), "utf8");
38475 | 123 |     console.log("[CFG] Zapisano backup do links.json");
38476 | 124 | 
38477 | 125 |     return unique;
38478 | 126 |   } catch (err) {
38479 | 127 |     console.error("[CFG] B≈ÇƒÖd przy pobieraniu link√≥w z Sheeta:", err.message);
38480 | 128 |     console.warn("[CFG] Pr√≥ba u≈ºycia lokalnego links.json jako fallback");
38481 | 129 |     return loadLinksFromLocalFile();
38482 | 130 |   }
38483 | 131 | }
38484 | 132 | 
38485 | 133 | /* ============================================
38486 | 134 |    Reload z por√≥wnaniem hashy
38487 | 135 |    ============================================ */
38488 | 136 | async function reloadLinks() {
38489 | 137 |   const urls = await fetchLinks();
38490 | 138 |   const hash = calcHash(urls);
38491 | 139 | 
38492 | 140 |   if (hash === lastHash) {
38493 | 141 |     console.log("[CFG] Linki bez zmian (hash taki sam)");
38494 | 142 |     return;
38495 | 143 |   }
38496 | 144 | 
38497 | 145 |   lastHash = hash;
38498 | 146 |   linksCache = urls;
38499 | 147 | 
38500 | 148 |   console.log("[CFG] Zaktualizowane linki:", linksCache);
38501 | 149 | }
38502 | 150 | 
38503 | 151 | /* ============================================
38504 | 152 |    API eksportowane dla reszty programu
38505 | 153 |    ============================================ */
38506 | 154 | export async function initLinks(autoRefreshMs = 0) {
38507 | 155 |   await reloadLinks(); // pierwszy load
38508 | 156 | 
38509 | 157 |   if (autoRefreshMs > 0) {
38510 | 158 |     console.log(
38511 | 159 |       `[CFG] Auto-refresh link√≥w co ${Math.round(autoRefreshMs / 1000)}s`
38512 | 160 |     );
38513 | 161 | 
38514 | 162 |     setInterval(() => {
38515 | 163 |       reloadLinks().catch((err) =>
38516 | 164 |         console.error("[CFG] B≈ÇƒÖd przy auto-refresh link√≥w:", err.message)
38517 | 165 |       );
38518 | 166 |     }, autoRefreshMs);
38519 | 167 |   }
38520 | 168 | }
38521 | 169 | 
38522 | 170 | export function getLinks() {
38523 | 171 |   return linksCache;
38524 | 172 | }
38525 | 173 | 
38526 | ```
38527 | 
38528 | ---
38529 | 
38530 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/links.json`
38531 | **Typ:** JSON  
38532 | **Opis:** Plik projektu (kod/konfiguracja).  
38533 | 
38534 | ```json
38535 | 1 | {
38536 | 2 |   "links": [
38537 | 3 |     "https://www.facebook.com/post1",
38538 | 4 |     "https://www.facebook.com/post2"
38539 | 5 |   ]
38540 | 6 | }
38541 | 7 | 
38542 | ```
38543 | 
38544 | ---
38545 | 
38546 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/login.js`
38547 | **Typ:** JavaScript/tekst  
38548 | **Opis:** Plik projektu (kod/konfiguracja).  
38549 | 
38550 | ```js
38551 |   1 | // src/fb/login.js
38552 |   2 | import { sleepRandom } from "../utils/sleep.js";
38553 |   3 | 
38554 |   4 | /**
38555 |   5 |  * Akceptuje popup cookies na stronie logowania FB.
38556 |   6 |  * Szuka przycisku po tek≈õcie, oznacza go data-atrybutem i klika z poziomu Puppeteera.
38557 |   7 |  */
38558 |   8 | async function acceptLoginCookies(page) {
38559 |   9 |   try {
38560 |  10 |     console.log("[FB][login-cookies] Szukam popupu cookies...");
38561 |  11 | 
38562 |  12 |     // chwila na pojawienie siƒô popupu
38563 |  13 |     await sleepRandom(800, 1300);
38564 |  14 | 
38565 |  15 |     const found = await page.evaluate(() => {
38566 |  16 |       const wanted = [
38567 |  17 |         "Zezw√≥l na wszystkie pliki cookie",
38568 |  18 |         "Zezw√≥l na wszystkie pliki",
38569 |  19 |         "Allow all cookies",
38570 |  20 |         "Odrzuƒá opcjonalne pliki cookie",
38571 |  21 |         "Odrzuc opcjonalne pliki cookie",
38572 |  22 |       ].map((t) => t.toLowerCase());
38573 |  23 | 
38574 |  24 |       const buttons = Array.from(
38575 |  25 |         document.querySelectorAll("button, [role='button']")
38576 |  26 |       );
38577 |  27 | 
38578 |  28 |       let marked = false;
38579 |  29 | 
38580 |  30 |       for (const btn of buttons) {
38581 |  31 |         const txt = (btn.innerText || btn.textContent || "").trim();
38582 |  32 |         if (!txt) continue;
38583 |  33 |         const low = txt.toLowerCase();
38584 |  34 | 
38585 |  35 |         if (wanted.some((w) => low.includes(w))) {
38586 |  36 |           btn.setAttribute("data-fb-cookie-btn", "1");
38587 |  37 |           marked = true;
38588 |  38 |           break;
38589 |  39 |         }
38590 |  40 |       }
38591 |  41 | 
38592 |  42 |       return marked;
38593 |  43 |     });
38594 |  44 | 
38595 |  45 |     if (!found) {
38596 |  46 |       console.log(
38597 |  47 |         "[FB][login-cookies] Nie znaleziono przycisku cookies (po tek≈õcie)."
38598 |  48 |       );
38599 |  49 |       return false;
38600 |  50 |     }
38601 |  51 | 
38602 |  52 |     await page.click('[data-fb-cookie-btn="1"]');
38603 |  53 |     console.log(
38604 |  54 |       '[FB][login-cookies] Klikniƒôto przycisk cookies przez Puppeteera (data-fb-cookie-btn="1").'
38605 |  55 |     );
38606 |  56 | 
38607 |  57 |     await sleepRandom(1200, 2000);
38608 |  58 |     return true;
38609 |  59 |   } catch (err) {
38610 |  60 |     console.log("[FB][login-cookies] B≈ÇƒÖd:", err.message);
38611 |  61 |     return false;
38612 |  62 |   }
38613 |  63 | }
38614 |  64 | 
38615 |  65 | /**
38616 |  66 |  * Pr pr√≥ba zalogowania siƒô na **dowolnym widocznym formularzu logowania**:
38617 |  67 |  * - pasek u g√≥ry,
38618 |  68 |  * - pe≈Çna strona logowania,
38619 |  69 |  * - popup "Wy≈õwietl wiƒôcej na Facebooku".
38620 |  70 |  */
38621 |  71 | async function loginViaVisibleForm(page, context = "visible-form") {
38622 |  72 |   try {
38623 |  73 |     console.log(`[FB][login-form] Szukam formularza logowania (${context})...`);
38624 |  74 | 
38625 |  75 |     // Spr√≥buj ogarnƒÖƒá ewentualne cookies na logowaniu
38626 |  76 |     await acceptLoginCookies(page).catch(() => {});
38627 |  77 | 
38628 |  78 |     const emailSelector = [
38629 |  79 |       "input#email",
38630 |  80 |       "input[name='email']",
38631 |  81 |       "input[name='email_or_phone']",
38632 |  82 |       "input[aria-label*='Adres e-mail']",
38633 |  83 |       "input[placeholder*='Adres e-mail']",
38634 |  84 |       "input[placeholder*='adres e-mail']",
38635 |  85 |       "input[placeholder*='Email']",
38636 |  86 |       "input[placeholder*='email']",
38637 |  87 |     ].join(",");
38638 |  88 | 
38639 |  89 |     const passSelector = [
38640 |  90 |       "input#pass",
38641 |  91 |       "input[name='pass']",
38642 |  92 |       "input[aria-label*='Has≈Ço']",
38643 |  93 |       "input[placeholder*='Has≈Ço']",
38644 |  94 |       "input[placeholder*='has≈Ço']",
38645 |  95 |       "input[placeholder*='Password']",
38646 |  96 |       "input[placeholder*='password']",
38647 |  97 |     ].join(",");
38648 |  98 | 
38649 |  99 |     const emailInput = await page.$(emailSelector);
38650 | 100 |     const passInput = await page.$(passSelector);
38651 | 101 | 
38652 | 102 |     if (!emailInput || !passInput) {
38653 | 103 |       console.log(
38654 | 104 |         "[FB][login-form] Brak pe≈Çnego formularza (email + has≈Ço) na stronie."
38655 | 105 |       );
38656 | 106 |       return false;
38657 | 107 |     }
38658 | 108 | 
38659 | 109 |     const email = process.env.FB_EMAIL || "";
38660 | 110 |     const password = process.env.FB_PASSWORD || "";
38661 | 111 | 
38662 | 112 |     if (!email || !password) {
38663 | 113 |       console.error(
38664 | 114 |         "[FB][login-form] Brak FB_EMAIL / FB_PASSWORD w zmiennych ≈õrodowiskowych."
38665 | 115 |       );
38666 | 116 |       return false;
38667 | 117 |     }
38668 | 118 | 
38669 | 119 |     console.log("[FB][login-form] Wype≈Çniam email/has≈Ço...");
38670 | 120 | 
38671 | 121 |     // wyczy≈õƒá i wpisz email
38672 | 122 |     await emailInput.click({ clickCount: 3 });
38673 | 123 |     await page.keyboard.press("Backspace");
38674 | 124 |     await emailInput.type(email, { delay: 50 });
38675 | 125 | 
38676 | 126 |     // wyczy≈õƒá i wpisz has≈Ço
38677 | 127 |     await passInput.click({ clickCount: 3 });
38678 | 128 |     await page.keyboard.press("Backspace");
38679 | 129 |     await passInput.type(password, { delay: 50 });
38680 | 130 | 
38681 | 131 |     const loginButton =
38682 | 132 |       (await page.$("button[name='login']")) ||
38683 | 133 |       (await page.$("button[type='submit']"));
38684 | 134 | 
38685 | 135 |     if (!loginButton) {
38686 | 136 |       console.log("[FB][login-form] Nie znalaz≈Çem przycisku logowania.");
38687 | 137 |       return false;
38688 | 138 |     }
38689 | 139 | 
38690 | 140 |     console.log("[FB][login-form] Klikam Zaloguj siƒô‚Ä¶");
38691 | 141 | 
38692 | 142 |     await Promise.all([
38693 | 143 |       loginButton.click(),
38694 | 144 |       page
38695 | 145 |         .waitForNavigation({
38696 | 146 |           waitUntil: "networkidle2",
38697 | 147 |           timeout: 60000,
38698 | 148 |         })
38699 | 149 |         .catch(() => {}),
38700 | 150 |     ]);
38701 | 151 | 
38702 | 152 |     await sleepRandom(1500, 2500);
38703 | 153 |     console.log("[FB][login-form] Formularz logowania wys≈Çany.");
38704 | 154 |     return true;
38705 | 155 |   } catch (err) {
38706 | 156 |     console.error("[FB][login-form] B≈ÇƒÖd:", err.message);
38707 | 157 |     return false;
38708 | 158 |   }
38709 | 159 | }
38710 | 160 | 
38711 | 161 | /**
38712 | 162 |  * G≈Ç√≥wne logowanie na FB ‚Äì klasyczne /login.
38713 | 163 |  */
38714 | 164 | async function fbLogin(page) {
38715 | 165 |   console.log("[FB][login] Start logowania‚Ä¶");
38716 | 166 | 
38717 | 167 |   await page.goto("https://www.facebook.com/login", {
38718 | 168 |     waitUntil: "networkidle2",
38719 | 169 |     timeout: 60000,
38720 | 170 |   });
38721 | 171 | 
38722 | 172 |   // popup cookies ‚Äì pr√≥bujemy go zamknƒÖƒá zanim dotkniemy input√≥w
38723 | 173 |   await acceptLoginCookies(page);
38724 | 174 | 
38725 | 175 |   console.log("[FB][login] Czekam na input email/pass...");
38726 | 176 | 
38727 | 177 |   await page.waitForSelector("#email", { timeout: 60000 });
38728 | 178 |   await page.waitForSelector("#pass", { timeout: 60000 });
38729 | 179 | 
38730 | 180 |   // jeszcze raz sprawd≈∫, czy cookies nie wyskoczy≈Çy ponownie
38731 | 181 |   await acceptLoginCookies(page);
38732 | 182 | 
38733 | 183 |   console.log("[FB][login] Wpisujƒô email...");
38734 | 184 |   await page.type("#email", process.env.FB_EMAIL || "", { delay: 60 });
38735 | 185 | 
38736 | 186 |   console.log("[FB][login] Wpisujƒô has≈Ço...");
38737 | 187 |   await page.type("#pass", process.env.FB_PASSWORD || "", { delay: 60 });
38738 | 188 | 
38739 | 189 |   console.log("[FB][login] Klikam Zaloguj siƒô‚Ä¶");
38740 | 190 | 
38741 | 191 |   await Promise.all([
38742 | 192 |     page.click('button[name="login"]'),
38743 | 193 |     page
38744 | 194 |       .waitForNavigation({
38745 | 195 |         waitUntil: "networkidle2",
38746 | 196 |         timeout: 60000,
38747 | 197 |       })
38748 | 198 |       .catch(() => {}),
38749 | 199 |   ]);
38750 | 200 | 
38751 | 201 |   console.log("[FB] Po logowaniu:", page.url());
38752 | 202 | }
38753 | 203 | 
38754 | 204 | /**
38755 | 205 |  * Szybki check, czy jeste≈õmy zalogowani.
38756 | 206 |  */
38757 | 207 | async function checkIfLogged(page) {
38758 | 208 |   return page.evaluate(() => {
38759 | 209 |     const selectors = [
38760 | 210 |       'input[aria-label*="Szukaj"]',
38761 | 211 |       'input[placeholder*="Szukaj"]',
38762 | 212 |       'a[aria-label*="Profil"]',
38763 | 213 |       'div[aria-label*="Konto"]',
38764 | 214 |     ];
38765 | 215 |     return selectors.some((sel) => document.querySelector(sel));
38766 | 216 |   });
38767 | 217 | }
38768 | 218 | 
38769 | 219 | /**
38770 | 220 |  * Klikniƒôcie elementu (button / link) po dok≈Çadnym tek≈õcie ‚Äì po stronie DOM.
38771 | 221 |  * U≈ºywane np. w nak≈Çadce ‚ÄûWy≈õwietl wiƒôcej na Facebooku‚Äù.
38772 | 222 |  */
38773 | 223 | async function clickByText(page, text) {
38774 | 224 |   const res = await page.evaluate((label) => {
38775 | 225 |     const els = Array.from(
38776 | 226 |       document.querySelectorAll("button, a, div[role='button']")
38777 | 227 |     );
38778 | 228 |     const lowLabel = label.toLowerCase();
38779 | 229 |     for (const el of els) {
38780 | 230 |       const t = (el.innerText || el.textContent || "").trim().toLowerCase();
38781 | 231 |       if (!t) continue;
38782 | 232 |       if (t === lowLabel) {
38783 | 233 |         el.click();
38784 | 234 |         return true;
38785 | 235 |       }
38786 | 236 |     }
38787 | 237 |     return false;
38788 | 238 |   }, text);
38789 | 239 |   return res;
38790 | 240 | }
38791 | 241 | 
38792 | 242 | /**
38793 | 243 |  * Je≈ºeli na po≈õcie pojawi siƒô nak≈Çadka z przyciskiem ‚ÄûZaloguj siƒô / Log In‚Äù
38794 | 244 |  * ‚Äì pr√≥bujemy zalogowaƒá siƒô **na miejscu**.
38795 | 245 |  */
38796 | 246 | async function ensureLoggedInOnPostOverlay(page) {
38797 | 247 |   const overlayDetected = await page.evaluate(() => {
38798 | 248 |     const texts = Array.from(
38799 | 249 |       document.querySelectorAll("div, span, h1, h2, h3, button, a")
38800 | 250 |     )
38801 | 251 |       .map((el) => (el.textContent || "").trim())
38802 | 252 |       .filter(Boolean);
38803 | 253 | 
38804 | 254 |     return texts.some((t) => {
38805 | 255 |       const low = t.toLowerCase();
38806 | 256 |       return (
38807 | 257 |         low.includes("wy≈õwietl wiƒôcej na facebooku") ||
38808 | 258 |         low.includes("zobacz wiƒôcej na facebooku") ||
38809 | 259 |         low.includes("see more on facebook")
38810 | 260 |       );
38811 | 261 |     });
38812 | 262 |   });
38813 | 263 | 
38814 | 264 |   if (!overlayDetected) return;
38815 | 265 | 
38816 | 266 |   console.log(
38817 | 267 |     "[FB] Wykryto nak≈Çadkƒô / okno logowania na po≈õcie ‚Äì pr√≥ba zalogowania."
38818 | 268 |   );
38819 | 269 | 
38820 | 270 |   // 1) Najpierw spr√≥buj po prostu zalogowaƒá siƒô na widocznym formularzu
38821 | 271 |   const usedInline = await loginViaVisibleForm(page, "post-overlay-inline");
38822 | 272 |   if (usedInline) {
38823 | 273 |     const logged = await checkIfLogged(page);
38824 | 274 |     if (logged) {
38825 | 275 |       console.log(
38826 | 276 |         "[FB] Uda≈Ço siƒô zalogowaƒá z poziomu nak≈Çadki posta (inline formularz)."
38827 | 277 |       );
38828 | 278 |       return;
38829 | 279 |     }
38830 | 280 |   }
38831 | 281 | 
38832 | 282 |   // 2) Fallback ‚Äì klikamy "Zaloguj siƒô" / "Log In", je≈õli jest osobny przycisk
38833 | 283 |   let clicked = await clickByText(page, "Zaloguj siƒô");
38834 | 284 |   if (!clicked) {
38835 | 285 |     clicked = await clickByText(page, "Log In");
38836 | 286 |   }
38837 | 287 | 
38838 | 288 |   if (clicked) {
38839 | 289 |     console.log(
38840 | 290 |       "[FB] Klikniƒôto przycisk logowania w nak≈Çadce posta. Czekam na prze≈Çadowanie..."
38841 | 291 |     );
38842 | 292 |     await sleepRandom(4000, 6000);
38843 | 293 | 
38844 | 294 |     // Po prze≈Çadowaniu znowu spr√≥buj formularza, tym razem ju≈º na pe≈Çnej stronie logowania
38845 | 295 |     const used = await loginViaVisibleForm(page, "post-overlay-after-click");
38846 | 296 |     if (used) {
38847 | 297 |       const logged = await checkIfLogged(page);
38848 | 298 |       if (logged) {
38849 | 299 |         console.log("[FB] Zalogowano po klikniƒôciu przycisku w nak≈Çadce.");
38850 | 300 |       } else {
38851 | 301 |         console.log(
38852 | 302 |           "[FB] Formularz po nak≈Çadce wys≈Çany, ale nadal nie widaƒá zalogowanej sesji."
38853 | 303 |         );
38854 | 304 |       }
38855 | 305 |     } else {
38856 | 306 |       console.log(
38857 | 307 |         "[FB] Po klikniƒôciu przycisku w nak≈Çadce nie znalaz≈Çem formularza logowania."
38858 | 308 |       );
38859 | 309 |     }
38860 | 310 |   } else {
38861 | 311 |     console.log(
38862 | 312 |       "[FB] Nie uda≈Ço siƒô znale≈∫ƒá przycisku logowania w nak≈Çadce posta."
38863 | 313 |     );
38864 | 314 |   }
38865 | 315 | }
38866 | 316 | 
38867 | 317 | export {
38868 | 318 |   fbLogin,
38869 | 319 |   checkIfLogged,
38870 | 320 |   ensureLoggedInOnPostOverlay,
38871 | 321 |   clickByText,
38872 | 322 |   acceptLoginCookies,
38873 | 323 |   loginViaVisibleForm,
38874 | 324 | };
38875 | 325 | 
38876 | ```
38877 | 
38878 | ---
38879 | 
38880 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/navigation.js`
38881 | **Typ:** JavaScript/tekst  
38882 | **Opis:** Plik projektu (kod/konfiguracja).  
38883 | 
38884 | ```js
38885 |  1 | // src/utils/navigation.js
38886 |  2 | import { sleepRandom } from "./sleep.js";
38887 |  3 | 
38888 |  4 | /**
38889 |  5 |  * Bezpieczne page.goto z retry.
38890 |  6 |  * - pr√≥buje kilka razy
38891 |  7 |  * - po b≈Çƒôdzie robi ma≈Çy reset FB
38892 |  8 |  */
38893 |  9 | export async function safeGoto(page, url, label = "goto", options = {}) {
38894 | 10 |   const MAX_ATTEMPTS = 3;
38895 | 11 | 
38896 | 12 |   const finalOptions = {
38897 | 13 |     waitUntil: "networkidle2",
38898 | 14 |     timeout: 90000, // 90s
38899 | 15 |     ...options,
38900 | 16 |   };
38901 | 17 | 
38902 | 18 |   for (let attempt = 1; attempt <= MAX_ATTEMPTS; attempt++) {
38903 | 19 |     try {
38904 | 20 |       console.log(
38905 | 21 |         `[NAV] (${label}) pr√≥ba ${attempt}/${MAX_ATTEMPTS}: ${url}`
38906 | 22 |       );
38907 | 23 | 
38908 | 24 |   // === FORCE DESKTOP PROFILE (SERVER FIX) ===
38909 | 25 |   await page.setViewport({ width: 1366, height: 768 });
38910 | 26 | // DISABLED UA // === END FORCE DESKTOP PROFILE ===
38911 | 27 | 
38912 | 28 |       await page.goto(url, finalOptions);
38913 | 29 | 
38914 | 30 |       console.log(`[NAV] (${label}) OK na pr√≥bie ${attempt}`);
38915 | 31 |       return true;
38916 | 32 |     } catch (err) {
38917 | 33 |       console.error(
38918 | 34 |         `[NAV] (${label}) b≈ÇƒÖd na pr√≥bie ${attempt}:`,
38919 | 35 |         err.message
38920 | 36 |       );
38921 | 37 | 
38922 | 38 |       if (attempt === MAX_ATTEMPTS) {
38923 | 39 |         // sygna≈Ç dla wy≈ºej: to ju≈º nie jest chwilowy lag
38924 | 40 |         return false;
38925 | 41 |       }
38926 | 42 | 
38927 | 43 |       // chwila przerwy
38928 | 44 |       await sleepRandom(3000, 7000);
38929 | 45 | 
38930 | 46 |       // pr√≥ba ‚Äûprzep≈Çukania‚Äù sesji ‚Äì wej≈õcie na FB
38931 | 47 |       try {
38932 | 48 |         console.log("[NAV] pr√≥ba od≈õwie≈ºenia FB (strona g≈Ç√≥wna)...");
38933 | 49 |         await page
38934 | 50 |           .goto("https://www.facebook.com/", {
38935 | 51 |             waitUntil: "load",
38936 | 52 |             timeout: 45000,
38937 | 53 |           })
38938 | 54 |           .catch(() => {});
38939 | 55 |       } catch (e2) {
38940 | 56 |         console.error(
38941 | 57 |           "[NAV] od≈õwie≈ºenie FB te≈º polecia≈Ço b≈Çƒôdem:",
38942 | 58 |           e2.message
38943 | 59 |         );
38944 | 60 |       }
38945 | 61 |     }
38946 | 62 |   }
38947 | 63 | 
38948 | 64 |   // tu w praktyce nie dojdziemy
38949 | 65 |   return false;
38950 | 66 | }
38951 | 67 | 
38952 | ```
38953 | 
38954 | ---
38955 | 
38956 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/package.json`
38957 | **Typ:** JSON  
38958 | **Opis:** Metadane projektu i zale≈ºno≈õci (npm).  
38959 | 
38960 | ```json
38961 |  1 | 
38962 |  2 | {
38963 |  3 |   "name": "fb_puppeteer",
38964 |  4 |   "version": "1.0.0",
38965 |  5 |   "description": "Watcher komentarzy FB + webhook do Make",
38966 |  6 |   "main": "src/index.js",
38967 |  7 |   "type": "module",
38968 |  8 |   "scripts": {
38969 |  9 |     "start": "node src/index.js"
38970 | 10 |   },
38971 | 11 |   "keywords": [],
38972 | 12 |   "author": "",
38973 | 13 |   "license": "ISC",
38974 | 14 |   "dependencies": {
38975 | 15 |     "axios": "^1.13.2",
38976 | 16 |     "dotenv": "^17.2.3",
38977 | 17 |     "puppeteer": "^24.31.0"
38978 | 18 |   }
38979 | 19 | }
38980 | 20 | 
38981 | ```
38982 | 
38983 | ---
38984 | 
38985 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/photo.js`
38986 | **Typ:** JavaScript/tekst  
38987 | **Opis:** Plik projektu (kod/konfiguracja).  
38988 | 
38989 | ```js
38990 |    1 | // src/fb/ui/photo.js
38991 |    2 | import { safeGoto } from "../../utils/navigation.js";
38992 |    3 | import { sleepRandom } from "../../utils/sleep.js";
38993 |    4 | import { scrollPost } from "../scroll.js";
38994 |    5 | import { acceptCookies, saveCookies } from "../cookies.js";
38995 |    6 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
38996 |    7 | import { getUiCommentInfo } from "../uiCommentInfo.js";
38997 |    8 | 
38998 |    9 | export const type = "photo";
38999 |   10 | 
39000 |   11 | const PACE = (process.env.FB_PACE || "local").toLowerCase();
39001 |   12 | 
39002 |   13 | /**
39003 |   14 |  * WA≈ªNE:
39004 |   15 |  * - Synchronizacja = waitForFunction / waitForEffect (DOM-driven), nie ‚Äú≈õlepe sleep‚Äù.
39005 |   16 |  * - Zostawiamy minimalne mikrodelaie (80‚Äì260ms) jako ‚Äúoddech‚Äù po re-renderze.
39006 |   17 |  * - Hard-bottom liczymy rzadziej (tylko gdy trzeba), bo to potrafi zjadaƒá czas.
39007 |   18 |  */
39008 |   19 | const PACE_CFG =
39009 |   20 |   PACE === "server"
39010 |   21 |     ? {
39011 |   22 |         // delikatnie wolniej na serwerze (render/CPU)
39012 |   23 |         stepJitterMinMs: 140,
39013 |   24 |         stepJitterMaxMs: 260,
39014 |   25 | 
39015 |   26 |         afterScrollMinMs: 260,
39016 |   27 |         afterScrollMaxMs: 520,
39017 |   28 | 
39018 |   29 |         // max czas na efekt po klikniƒôciu (FB do≈Çadowuje async)
39019 |   30 |         effectWaitMs: 5200,
39020 |   31 | 
39021 |   32 |         scrollPx: 140,
39022 |   33 | 
39023 |   34 |         // bonusowe kliki, ale event-driven
39024 |   35 |         bonusClickTries: 2,
39025 |   36 |         bonusClickDelayMinMs: 120,
39026 |   37 |         bonusClickDelayMaxMs: 220,
39027 |   38 | 
39028 |   39 |         // HARD BOTTOM (sprawdzane rzadko)
39029 |   40 |         hardBottomEpsPx: 10,
39030 |   41 |         hardBottomStableNeed: 4,
39031 |   42 |         hardBottomStableDelayMinMs: 320,
39032 |   43 |         hardBottomStableDelayMaxMs: 560,
39033 |   44 |       }
39034 |   45 |     : {
39035 |   46 |         // lokalnie szybciej
39036 |   47 |         stepJitterMinMs: 90,
39037 |   48 |         stepJitterMaxMs: 190,
39038 |   49 | 
39039 |   50 |         afterScrollMinMs: 180,
39040 |   51 |         afterScrollMaxMs: 420,
39041 |   52 | 
39042 |   53 |         effectWaitMs: 4200,
39043 |   54 | 
39044 |   55 |         scrollPx: 160,
39045 |   56 | 
39046 |   57 |         bonusClickTries: 2,
39047 |   58 |         bonusClickDelayMinMs: 90,
39048 |   59 |         bonusClickDelayMaxMs: 180,
39049 |   60 | 
39050 |   61 |         hardBottomEpsPx: 10,
39051 |   62 |         hardBottomStableNeed: 4,
39052 |   63 |         hardBottomStableDelayMinMs: 240,
39053 |   64 |         hardBottomStableDelayMaxMs: 420,
39054 |   65 |       };
39055 |   66 | 
39056 |   67 | export function matchesUrl(url) {
39057 |   68 |   try {
39058 |   69 |     const u = new URL(url);
39059 |   70 |     const path = (u.pathname || "").toLowerCase();
39060 |   71 | 
39061 |   72 |     if (path.includes("photo.php")) return true;
39062 |   73 |     if (path.startsWith("/photo") || path.includes("/photo/")) return true;
39063 |   74 |     if (u.searchParams.has("fbid")) return true;
39064 |   75 | 
39065 |   76 |     return false;
39066 |   77 |   } catch {
39067 |   78 |     const lower = (url || "").toLowerCase();
39068 |   79 |     if (lower.includes("photo.php")) return true;
39069 |   80 |     if (lower.includes("/photo/") || lower.includes("/photo?")) return true;
39070 |   81 |     if (/(?:\?|&)fbid=/.test(lower)) return true;
39071 |   82 |     return false;
39072 |   83 |   }
39073 |   84 | }
39074 |   85 | 
39075 |   86 | /* ===================== FILTER: ALL COMMENTS (LOKALNIE) ===================== */
39076 |   87 | 
39077 |   88 | async function clickAllCommentsInMenu(page) {
39078 |   89 |   const result = await page.evaluate(() => {
39079 |   90 |     const menu =
39080 |   91 |       document.querySelector("div[role='menu']") ||
39081 |   92 |       document.querySelector("div[role='dialog']");
39082 |   93 | 
39083 |   94 |     if (!menu) return { clicked: false, noMenu: true };
39084 |   95 | 
39085 |   96 |     const items = Array.from(
39086 |   97 |       menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']")
39087 |   98 |     );
39088 |   99 | 
39089 |  100 |     const opt = items.find((el) => {
39090 |  101 |       const t = (el.textContent || "").trim().toLowerCase();
39091 |  102 |       return t.startsWith("wszystkie komentarze") || t.startsWith("all comments");
39092 |  103 |     });
39093 |  104 | 
39094 |  105 |     if (!opt) return { clicked: false, noMenu: false };
39095 |  106 | 
39096 |  107 |     opt.click();
39097 |  108 |     setTimeout(() => {
39098 |  109 |       try {
39099 |  110 |         document.body.click();
39100 |  111 |       } catch {}
39101 |  112 |     }, 50);
39102 |  113 | 
39103 |  114 |     return { clicked: true, noMenu: false };
39104 |  115 |   });
39105 |  116 | 
39106 |  117 |   if (result.clicked) {
39107 |  118 |     await sleepRandom(180, 320);
39108 |  119 |     await page
39109 |  120 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2000 })
39110 |  121 |       .catch(() => {});
39111 |  122 |   }
39112 |  123 | 
39113 |  124 |   return result;
39114 |  125 | }
39115 |  126 | 
39116 |  127 | async function switchCommentsFilterToAll(page) {
39117 |  128 |   console.log("[FB][ui:photo][filter] switch -> all comments");
39118 |  129 | 
39119 |  130 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
39120 |  131 |   if (menuAlreadyOpen) {
39121 |  132 |     const r = await clickAllCommentsInMenu(page);
39122 |  133 |     return !!r.clicked;
39123 |  134 |   }
39124 |  135 | 
39125 |  136 |   const pre = await page.evaluate(() => {
39126 |  137 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
39127 |  138 |     let filterEl = null;
39128 |  139 |     let labelText = "";
39129 |  140 | 
39130 |  141 |     for (const el of els) {
39131 |  142 |       const t = (el.textContent || "").trim();
39132 |  143 |       if (!t) continue;
39133 |  144 |       const low = t.toLowerCase();
39134 |  145 |       if (
39135 |  146 |         low === "najtrafniejsze" ||
39136 |  147 |         low === "most relevant" ||
39137 |  148 |         low === "wszystkie komentarze" ||
39138 |  149 |         low === "all comments"
39139 |  150 |       ) {
39140 |  151 |         filterEl = el;
39141 |  152 |         labelText = low;
39142 |  153 |         break;
39143 |  154 |       }
39144 |  155 |     }
39145 |  156 | 
39146 |  157 |     if (!filterEl) return { state: "not-found" };
39147 |  158 |     if (labelText === "wszystkie komentarze" || labelText === "all comments") {
39148 |  159 |       return { state: "already-all" };
39149 |  160 |     }
39150 |  161 | 
39151 |  162 |     filterEl.click();
39152 |  163 |     return { state: "clicked-filter" };
39153 |  164 |   });
39154 |  165 | 
39155 |  166 |   if (pre.state === "not-found") return false;
39156 |  167 |   if (pre.state === "already-all") return true;
39157 |  168 | 
39158 |  169 |   await sleepRandom(120, 220);
39159 |  170 |   const r = await clickAllCommentsInMenu(page);
39160 |  171 |   if (r.clicked) return true;
39161 |  172 | 
39162 |  173 |   const afterLabelIsAll = await page.evaluate(() => {
39163 |  174 |     const els = Array.from(document.querySelectorAll("div[role='button'], span[role='button']"));
39164 |  175 |     return els.some((el) => {
39165 |  176 |       const t = (el.textContent || "").trim().toLowerCase();
39166 |  177 |       return t === "wszystkie komentarze" || t === "all comments";
39167 |  178 |     });
39168 |  179 |   });
39169 |  180 | 
39170 |  181 |   return afterLabelIsAll;
39171 |  182 | }
39172 |  183 | 
39173 |  184 | /* ===================== COMMENTS ROOT (KLUCZ) ===================== */
39174 |  185 | 
39175 |  186 | async function getCommentsRootHandle(page) {
39176 |  187 |   const handle = await page.evaluateHandle(() => {
39177 |  188 |     const norm = (s) =>
39178 |  189 |       String(s || "")
39179 |  190 |         .replace(/\u00a0/g, " ")
39180 |  191 |         .replace(/\s+/g, " ")
39181 |  192 |         .trim()
39182 |  193 |         .toLowerCase();
39183 |  194 | 
39184 |  195 |     const isVisible = (el) => {
39185 |  196 |       if (!el) return false;
39186 |  197 |       try {
39187 |  198 |         const r = el.getBoundingClientRect();
39188 |  199 |         return r.width > 2 && r.height > 2;
39189 |  200 |       } catch {
39190 |  201 |         return true;
39191 |  202 |       }
39192 |  203 |     };
39193 |  204 | 
39194 |  205 |     const isMoreCommentsBtn = (el) => {
39195 |  206 |       const t = norm(el.getAttribute?.("aria-label") || el.textContent);
39196 |  207 |       if (!t) return false;
39197 |  208 |       return (
39198 |  209 |         t.includes("wy≈õwietl wiƒôcej komentarzy") ||
39199 |  210 |         t.includes("zobacz wiƒôcej komentarzy") ||
39200 |  211 |         t.includes("zobacz wcze≈õniejsze komentarze") ||
39201 |  212 |         t.includes("view more comments") ||
39202 |  213 |         t.includes("view previous comments")
39203 |  214 |       );
39204 |  215 |     };
39205 |  216 | 
39206 |  217 |     const btns = Array.from(document.querySelectorAll("button,a,div,span,[role='button']")).filter(
39207 |  218 |       isVisible
39208 |  219 |     );
39209 |  220 |     const keyBtn = btns.find(isMoreCommentsBtn);
39210 |  221 | 
39211 |  222 |     if (keyBtn) {
39212 |  223 |       const dlg = keyBtn.closest?.("div[role='dialog']");
39213 |  224 |       if (dlg) return dlg;
39214 |  225 | 
39215 |  226 |       let cur = keyBtn.parentElement;
39216 |  227 |       for (let i = 0; i < 20 && cur; i++) {
39217 |  228 |         if (cur.matches?.("article,main,section,div")) return cur;
39218 |  229 |         cur = cur.parentElement;
39219 |  230 |       }
39220 |  231 |     }
39221 |  232 | 
39222 |  233 |     const dialogs = Array.from(document.querySelectorAll("div[role='dialog']")).filter(isVisible);
39223 |  234 |     const dlg2 = dialogs.find((d) => {
39224 |  235 |       const t = norm(d.innerText || d.textContent);
39225 |  236 |       if (!t) return false;
39226 |  237 |       if (t.includes("powiadomienia")) return false;
39227 |  238 |       if (t.includes("szukaj znajomych")) return false;
39228 |  239 |       return (
39229 |  240 |         t.includes("najtrafniejsze") ||
39230 |  241 |         t.includes("most relevant") ||
39231 |  242 |         t.includes("komentarz") ||
39232 |  243 |         t.includes("comment")
39233 |  244 |       );
39234 |  245 |     });
39235 |  246 |     if (dlg2) return dlg2;
39236 |  247 | 
39237 |  248 |     return document.body;
39238 |  249 |   });
39239 |  250 | 
39240 |  251 |   return handle;
39241 |  252 | }
39242 |  253 | 
39243 |  254 | async function getCommentsScrollHandle(page, rootHandle) {
39244 |  255 |   const handle = await page.evaluateHandle((root) => {
39245 |  256 |     const isVisible = (el) => {
39246 |  257 |       if (!el) return false;
39247 |  258 |       try {
39248 |  259 |         const r = el.getBoundingClientRect();
39249 |  260 |         return r.width > 2 && r.height > 2;
39250 |  261 |       } catch {
39251 |  262 |         return true;
39252 |  263 |       }
39253 |  264 |     };
39254 |  265 | 
39255 |  266 |     const canScrollByTest = (el) => {
39256 |  267 |       try {
39257 |  268 |         if (!el) return false;
39258 |  269 |         const h = el.clientHeight || 0;
39259 |  270 |         const sh = el.scrollHeight || 0;
39260 |  271 |         if (sh <= h + 40) return false;
39261 |  272 | 
39262 |  273 |         const before = el.scrollTop ?? 0;
39263 |  274 |         el.scrollTop = before + 80;
39264 |  275 |         const after = el.scrollTop ?? before;
39265 |  276 |         el.scrollTop = before;
39266 |  277 | 
39267 |  278 |         return after !== before;
39268 |  279 |       } catch {
39269 |  280 |         return false;
39270 |  281 |       }
39271 |  282 |     };
39272 |  283 | 
39273 |  284 |     const closestScrollable = (start) => {
39274 |  285 |       let cur = start;
39275 |  286 |       for (let i = 0; i < 28 && cur; i++) {
39276 |  287 |         if (canScrollByTest(cur)) return cur;
39277 |  288 |         cur = cur.parentElement;
39278 |  289 |       }
39279 |  290 |       return null;
39280 |  291 |     };
39281 |  292 | 
39282 |  293 |     const scope = root || document;
39283 |  294 | 
39284 |  295 |     const outer = document.querySelector("div[data-visualcompletion='ignore'][data-thumb='1']");
39285 |  296 |     if (outer) {
39286 |  297 |       const sc = closestScrollable(outer);
39287 |  298 |       if (sc) return sc;
39288 |  299 |     }
39289 |  300 | 
39290 |  301 |     const candidates = Array.from(scope.querySelectorAll("div,section,main,article"))
39291 |  302 |       .filter(isVisible)
39292 |  303 |       .slice(0, 25000);
39293 |  304 | 
39294 |  305 |     let best = null;
39295 |  306 |     let bestDelta = -1;
39296 |  307 |     for (const el of candidates) {
39297 |  308 |       if (!canScrollByTest(el)) continue;
39298 |  309 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
39299 |  310 |       if (delta > bestDelta) {
39300 |  311 |         bestDelta = delta;
39301 |  312 |         best = el;
39302 |  313 |       }
39303 |  314 |     }
39304 |  315 | 
39305 |  316 |     return best || null;
39306 |  317 |   }, rootHandle);
39307 |  318 | 
39308 |  319 |   return handle;
39309 |  320 | }
39310 |  321 | 
39311 |  322 | /* ======================================================================== */
39312 |  323 | 
39313 |  324 | export async function prepare(page, url) {
39314 |  325 |   console.log(`[FB][ui:photo] prepare: ${url}`);
39315 |  326 | 
39316 |  327 |   const ok = await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
39317 |  328 |   if (!ok) throw new Error("safeGoto-failed");
39318 |  329 | 
39319 |  330 |   if (page.url().includes("/login")) {
39320 |  331 |     console.log("[FB][ui:photo] /login ‚Äì fbLogin + re-enter.");
39321 |  332 |     await fbLogin(page);
39322 |  333 |     await sleepRandom(2500, 4000);
39323 |  334 |     await safeGoto(page, url, "photo", { waitUntil: "networkidle2", timeout: 90000 });
39324 |  335 |   }
39325 |  336 | 
39326 |  337 |   await acceptCookies(page, "photo-initial");
39327 |  338 | 
39328 |  339 |   const logged = await checkIfLogged(page).catch(() => false);
39329 |  340 |   if (!logged) {
39330 |  341 |     console.log("[FB][ui:photo] not logged ‚Äì fbLogin().");
39331 |  342 |     await fbLogin(page);
39332 |  343 |     await sleepRandom(2500, 4000);
39333 |  344 |   }
39334 |  345 | 
39335 |  346 |   await ensureLoggedInOnPostOverlay(page);
39336 |  347 |   await acceptCookies(page, "photo");
39337 |  348 | 
39338 |  349 |   const loggedFinal = await checkIfLogged(page).catch(() => false);
39339 |  350 |   if (loggedFinal) await saveCookies(page);
39340 |  351 | }
39341 |  352 | 
39342 |  353 | function parseNumberLikeNode(str) {
39343 |  354 |   if (!str) return null;
39344 |  355 | 
39345 |  356 |   const cleaned = String(str)
39346 |  357 |     .toLowerCase()
39347 |  358 |     .replace(/\u00a0/g, " ")
39348 |  359 |     .replace(/\s+/g, " ")
39349 |  360 |     .trim();
39350 |  361 | 
39351 |  362 |   const plain = cleaned.replace(/[^\d]/g, "");
39352 |  363 |   if (/^\d+$/.test(plain)) {
39353 |  364 |     const n = Number(plain);
39354 |  365 |     return Number.isFinite(n) ? n : null;
39355 |  366 |   }
39356 |  367 | 
39357 |  368 |   const m = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
39358 |  369 |   if (m) {
39359 |  370 |     const base = Number(m[1].replace(",", "."));
39360 |  371 |     if (Number.isFinite(base)) return Math.round(base * 1000);
39361 |  372 |   }
39362 |  373 | 
39363 |  374 |   const m2 = cleaned.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
39364 |  375 |   if (m2) {
39365 |  376 |     const base = Number(m2[1].replace(",", "."));
39366 |  377 |     if (Number.isFinite(base)) return Math.round(base * 1000000);
39367 |  378 |   }
39368 |  379 | 
39369 |  380 |   return null;
39370 |  381 | }
39371 |  382 | 
39372 |  383 | async function getPhotoUiCountFromChip(page, rootHandle) {
39373 |  384 |   const res = await page
39374 |  385 |     .evaluate((root) => {
39375 |  386 |       const scope = root || document;
39376 |  387 | 
39377 |  388 |       const norm = (s) =>
39378 |  389 |         String(s || "")
39379 |  390 |           .replace(/\u00a0/g, " ")
39380 |  391 |           .replace(/\s+/g, " ")
39381 |  392 |           .trim();
39382 |  393 | 
39383 |  394 |       const parseNum = (s) => {
39384 |  395 |         const t = norm(s);
39385 |  396 |         if (!t) return null;
39386 |  397 | 
39387 |  398 |         const plain = t.replace(/[^\d]/g, "");
39388 |  399 |         if (/^\d+$/.test(plain)) return Number(plain);
39389 |  400 | 
39390 |  401 |         const lower = t.toLowerCase();
39391 |  402 |         const m = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(k|tys|ty≈õ|thousand)\b/);
39392 |  403 |         if (m) {
39393 |  404 |           const base = Number(m[1].replace(",", "."));
39394 |  405 |           if (Number.isFinite(base)) return Math.round(base * 1000);
39395 |  406 |         }
39396 |  407 | 
39397 |  408 |         const m2 = lower.match(/(\d+(?:[.,]\d+)?)[ ]*(m|mln|million)\b/);
39398 |  409 |         if (m2) {
39399 |  410 |           const base = Number(m2[1].replace(",", "."));
39400 |  411 |           if (Number.isFinite(base)) return Math.round(base * 1000000);
39401 |  412 |         }
39402 |  413 | 
39403 |  414 |         return null;
39404 |  415 |       };
39405 |  416 | 
39406 |  417 |       const isVisible = (el) => {
39407 |  418 |         if (!el) return false;
39408 |  419 |         const r = el.getBoundingClientRect();
39409 |  420 |         return r.width > 2 && r.height > 2 && r.bottom > 0 && r.top < window.innerHeight;
39410 |  421 |       };
39411 |  422 | 
39412 |  423 |       const commentBtn = Array.from(
39413 |  424 |         document.querySelectorAll("div[role='button'],span[role='button'],a[role='button'],button")
39414 |  425 |       ).find((el) => {
39415 |  426 |         const t = norm(el.textContent).toLowerCase();
39416 |  427 |         return t === "komentarz" || t === "comment" || t.startsWith("komentarz");
39417 |  428 |       });
39418 |  429 | 
39419 |  430 |       const anchorRect = commentBtn?.getBoundingClientRect?.() || null;
39420 |  431 |       const anchorCx = anchorRect ? anchorRect.left + anchorRect.width / 2 : null;
39421 |  432 |       const anchorCy = anchorRect ? anchorRect.top + anchorRect.height / 2 : null;
39422 |  433 | 
39423 |  434 |       const candidates = Array.from(scope.querySelectorAll("div[role='button'],span[role='button']"))
39424 |  435 |         .filter(isVisible)
39425 |  436 |         .slice(0, 5000);
39426 |  437 | 
39427 |  438 |       let best = null;
39428 |  439 |       let bestScore = -Infinity;
39429 |  440 | 
39430 |  441 |       for (const el of candidates) {
39431 |  442 |         const hasIcon = !!el.querySelector("i[data-visualcompletion='css-img']");
39432 |  443 |         if (!hasIcon) continue;
39433 |  444 | 
39434 |  445 |         const spans = Array.from(el.querySelectorAll("span")).slice(0, 50);
39435 |  446 |         let num = null;
39436 |  447 |         let raw = null;
39437 |  448 | 
39438 |  449 |         for (const sp of spans) {
39439 |  450 |           const t = norm(sp.textContent);
39440 |  451 |           if (!t) continue;
39441 |  452 |           if (t.length > 24) continue;
39442 |  453 | 
39443 |  454 |           const n = parseNum(t);
39444 |  455 |           if (typeof n === "number" && Number.isFinite(n)) {
39445 |  456 |             if (n <= 0 || n > 10000000) continue;
39446 |  457 |             num = n;
39447 |  458 |             raw = t;
39448 |  459 |             break;
39449 |  460 |           }
39450 |  461 |         }
39451 |  462 | 
39452 |  463 |         if (num == null) continue;
39453 |  464 | 
39454 |  465 |         const r = el.getBoundingClientRect();
39455 |  466 |         const cx = r.left + r.width / 2;
39456 |  467 |         const cy = r.top + r.height / 2;
39457 |  468 | 
39458 |  469 |         let score = 0;
39459 |  470 | 
39460 |  471 |         if (anchorCx != null && anchorCy != null) {
39461 |  472 |           const dx = cx - anchorCx;
39462 |  473 |           const dy = cy - anchorCy;
39463 |  474 |           const dist = Math.sqrt(dx * dx + dy * dy);
39464 |  475 |           score -= dist;
39465 |  476 |         }
39466 |  477 | 
39467 |  478 |         const textLen = norm(el.textContent).length;
39468 |  479 |         score -= Math.min(400, textLen);
39469 |  480 | 
39470 |  481 |         score += Math.min(200, Math.log10(num + 1) * 120);
39471 |  482 | 
39472 |  483 |         if (score > bestScore) {
39473 |  484 |           bestScore = score;
39474 |  485 |           best = { count: num, raw, score, text: norm(el.textContent).slice(0, 80) };
39475 |  486 |         }
39476 |  487 |       }
39477 |  488 | 
39478 |  489 |       return best;
39479 |  490 |     }, rootHandle)
39480 |  491 |     .catch(() => null);
39481 |  492 | 
39482 |  493 |   if (!res || typeof res.count !== "number") return null;
39483 |  494 |   return { count: res.count, raw: res.raw, dbg: res };
39484 |  495 | }
39485 |  496 | 
39486 |  497 | export async function getCommentCount(page, url) {
39487 |  498 |   console.log("[FB][ui:photo] getCommentCount‚Ä¶");
39488 |  499 | 
39489 |  500 |   await scrollPost(page, 220);
39490 |  501 |   await sleepRandom(220, 420);
39491 |  502 | 
39492 |  503 |   const okFilter = await switchCommentsFilterToAll(page).catch(() => false);
39493 |  504 |   console.log(`[FB][ui:photo] filter all comments: ${okFilter}`);
39494 |  505 | 
39495 |  506 |   // mikro settle po filtrze (bez mulenia)
39496 |  507 |   await sleepRandom(220, 420);
39497 |  508 | 
39498 |  509 |   const rootHandle = await getCommentsRootHandle(page);
39499 |  510 | 
39500 |  511 |   const chip = await getPhotoUiCountFromChip(page, rootHandle).catch(() => null);
39501 |  512 |   if (chip?.count != null) {
39502 |  513 |     console.log("[FB][ui:photo] UI count (chip):", chip);
39503 |  514 |   }
39504 |  515 | 
39505 |  516 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
39506 |  517 |   const infoCount = uiInfo && typeof uiInfo.comments === "number" ? uiInfo.comments : null;
39507 |  518 | 
39508 |  519 |   const loaded = await page
39509 |  520 |     .evaluate((root) => {
39510 |  521 |       const scope = root || document;
39511 |  522 |       const as = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
39512 |  523 |       const ids = new Set();
39513 |  524 |       for (const a of as) {
39514 |  525 |         const href = a.getAttribute("href") || "";
39515 |  526 |         const m = href.match(/comment_id=([^&]+)/);
39516 |  527 |         if (m && m[1]) ids.add(m[1]);
39517 |  528 |       }
39518 |  529 |       return ids.size || null;
39519 |  530 |     }, rootHandle)
39520 |  531 |     .catch(() => null);
39521 |  532 | 
39522 |  533 |   let total = null;
39523 |  534 |   let source = "none";
39524 |  535 | 
39525 |  536 |   if (chip?.count != null) {
39526 |  537 |     total = chip.count;
39527 |  538 |     source = "ui-photo-chip";
39528 |  539 |   } else if (infoCount != null) {
39529 |  540 |     total = infoCount;
39530 |  541 |     source = uiInfo?.source || "uicommentinfo";
39531 |  542 |   } else if (loaded != null) {
39532 |  543 |     total = loaded;
39533 |  544 |     source = "loaded-comment_id";
39534 |  545 |   }
39535 |  546 | 
39536 |  547 |   console.log("[FB][ui:photo] UI comments:", {
39537 |  548 |     source,
39538 |  549 |     chip: chip?.count ?? null,
39539 |  550 |     uiInfoSource: uiInfo?.source ?? null,
39540 |  551 |     uiInfoRaw: uiInfo?.raw ?? null,
39541 |  552 |     uiInfoCount: infoCount,
39542 |  553 |     loaded,
39543 |  554 |     chosen: total,
39544 |  555 |   });
39545 |  556 | 
39546 |  557 |   try {
39547 |  558 |     await rootHandle.dispose?.();
39548 |  559 |   } catch {}
39549 |  560 | 
39550 |  561 |   // kr√≥tki oddech przed loadAllComments (≈ºeby nie wej≈õƒá w trakcie re-renderu)
39551 |  562 |   await sleepRandom(180, 340);
39552 |  563 | 
39553 |  564 |   return total;
39554 |  565 | }
39555 |  566 | 
39556 |  567 | export async function loadAllComments(page, { expectedTotal } = {}) {
39557 |  568 |   console.log(`[FB][ui:photo] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"} pace=${PACE}`);
39558 |  569 | 
39559 |  570 |   const MAX_STEPS = 900;
39560 |  571 |   const MAX_NO_PROGRESS = 28;
39561 |  572 | 
39562 |  573 |   let noProgress = 0;
39563 |  574 | 
39564 |  575 |   const rootHandle = await getCommentsRootHandle(page);
39565 |  576 |   const scrollHandle = await getCommentsScrollHandle(page, rootHandle);
39566 |  577 | 
39567 |  578 |   const shortBtn = (t) => {
39568 |  579 |     const s = String(t || "").replace(/\s+/g, " ").trim();
39569 |  580 |     if (s.length <= 90) return s;
39570 |  581 |     return s.slice(0, 90) + "‚Ä¶";
39571 |  582 |   };
39572 |  583 | 
39573 |  584 |   async function countAnchors() {
39574 |  585 |     return page.evaluate((root) => {
39575 |  586 |       const scope = root || document;
39576 |  587 | 
39577 |  588 |       const commentAs = Array.from(scope.querySelectorAll("a[href*='comment_id']"));
39578 |  589 |       const replyAs = Array.from(scope.querySelectorAll("a[href*='reply_comment_id']"));
39579 |  590 | 
39580 |  591 |       const uniq = (arr, param) => {
39581 |  592 |         const ids = new Set();
39582 |  593 |         for (const a of arr) {
39583 |  594 |           const href = a.getAttribute("href") || "";
39584 |  595 |           const m = href.match(new RegExp(`${param}=([^&]+)`));
39585 |  596 |           if (m && m[1]) ids.add(m[1]);
39586 |  597 |         }
39587 |  598 |         return ids.size;
39588 |  599 |       };
39589 |  600 | 
39590 |  601 |       return {
39591 |  602 |         commentsAnchors: uniq(commentAs, "comment_id"),
39592 |  603 |         replyAnchors: uniq(replyAs, "reply_comment_id"),
39593 |  604 |         nodes: scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0,
39594 |  605 |       };
39595 |  606 |     }, rootHandle);
39596 |  607 |   }
39597 |  608 | 
39598 |  609 |   async function gentleScrollKick(pixels = PACE_CFG.scrollPx) {
39599 |  610 |     try {
39600 |  611 |       const info = await page.evaluate((root, scroller, px) => {
39601 |  612 |         const pick =
39602 |  613 |           scroller || root || document.scrollingElement || document.documentElement || document.body;
39603 |  614 | 
39604 |  615 |         const before =
39605 |  616 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
39606 |  617 | 
39607 |  618 |         if (pick && typeof pick.scrollTop === "number") pick.scrollTop = pick.scrollTop + px;
39608 |  619 |         else window.scrollBy(0, px);
39609 |  620 | 
39610 |  621 |         const after =
39611 |  622 |           pick && typeof pick.scrollTop === "number" ? pick.scrollTop : window.scrollY || 0;
39612 |  623 | 
39613 |  624 |         return { moved: before !== after, tag: pick?.tagName || "UNKNOWN", before, after };
39614 |  625 |       }, rootHandle, scrollHandle, pixels);
39615 |  626 | 
39616 |  627 |       if (!info?.moved) {
39617 |  628 |         console.log(
39618 |  629 |           `[FB][ui:photo][scroll] NO-MOVE tag=${info?.tag} before=${info?.before} after=${info?.after}`
39619 |  630 |         );
39620 |  631 |       }
39621 |  632 |     } catch {
39622 |  633 |       await page.evaluate((px) => window.scrollBy(0, px), pixels).catch(() => {});
39623 |  634 |     }
39624 |  635 | 
39625 |  636 |     await sleepRandom(PACE_CFG.afterScrollMinMs, PACE_CFG.afterScrollMaxMs);
39626 |  637 |   }
39627 |  638 | 
39628 |  639 |   async function getScrollMetrics() {
39629 |  640 |     return page.evaluate((root, scroller) => {
39630 |  641 |       const pick =
39631 |  642 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
39632 |  643 | 
39633 |  644 |       const isEl = pick && typeof pick.scrollHeight === "number";
39634 |  645 | 
39635 |  646 |       if (!isEl) {
39636 |  647 |         const se = document.scrollingElement || document.documentElement || document.body;
39637 |  648 |         return {
39638 |  649 |           tag: "WINDOW",
39639 |  650 |           scrollTop: window.scrollY || 0,
39640 |  651 |           scrollHeight: se?.scrollHeight || 0,
39641 |  652 |           clientHeight: window.innerHeight || 0,
39642 |  653 |         };
39643 |  654 |       }
39644 |  655 | 
39645 |  656 |       return {
39646 |  657 |         tag: pick.tagName || "UNKNOWN",
39647 |  658 |         scrollTop: pick.scrollTop || 0,
39648 |  659 |         scrollHeight: pick.scrollHeight || 0,
39649 |  660 |         clientHeight: pick.clientHeight || window.innerHeight || 0,
39650 |  661 |       };
39651 |  662 |     }, rootHandle, scrollHandle);
39652 |  663 |   }
39653 |  664 | 
39654 |  665 |   async function hasLoadMoreButtons() {
39655 |  666 |     return page.evaluate((root) => {
39656 |  667 |       const scope = root || document;
39657 |  668 | 
39658 |  669 |       const norm = (s) =>
39659 |  670 |         String(s || "")
39660 |  671 |           .replace(/\u00a0/g, " ")
39661 |  672 |           .replace(/\s+/g, " ")
39662 |  673 |           .trim()
39663 |  674 |           .toLowerCase();
39664 |  675 | 
39665 |  676 |       const isVisible = (el) => {
39666 |  677 |         if (!el) return false;
39667 |  678 |         const r = el.getBoundingClientRect();
39668 |  679 |         if (r.width < 2 || r.height < 2) return false;
39669 |  680 |         return r.bottom > 0 && r.top < window.innerHeight;
39670 |  681 |       };
39671 |  682 | 
39672 |  683 |       const nodesBtn = Array.from(
39673 |  684 |         scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
39674 |  685 |       ).filter(isVisible);
39675 |  686 | 
39676 |  687 |       return nodesBtn.some((el) => {
39677 |  688 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
39678 |  689 | 
39679 |  690 |         if (
39680 |  691 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
39681 |  692 |           t.includes("zobacz wiƒôcej komentarzy") ||
39682 |  693 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
39683 |  694 |           t.includes("view more comments") ||
39684 |  695 |           t.includes("view previous comments")
39685 |  696 |         )
39686 |  697 |           return true;
39687 |  698 | 
39688 |  699 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
39689 |  700 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
39690 |  701 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
39691 |  702 |         if (t.includes("view") && t.includes("repl")) return true;
39692 |  703 |         if (t.includes("see") && t.includes("repl")) return true;
39693 |  704 | 
39694 |  705 |         return false;
39695 |  706 |       });
39696 |  707 |     }, rootHandle);
39697 |  708 |   }
39698 |  709 | 
39699 |  710 |   function isHardBottom(m) {
39700 |  711 |     const eps = Math.max(2, Number(PACE_CFG.hardBottomEpsPx || 10));
39701 |  712 |     const top = Number(m?.scrollTop || 0);
39702 |  713 |     const ch = Number(m?.clientHeight || 0);
39703 |  714 |     const sh = Number(m?.scrollHeight || 0);
39704 |  715 |     if (!sh || !ch) return false;
39705 |  716 |     return top + ch >= sh - eps;
39706 |  717 |   }
39707 |  718 | 
39708 |  719 |   let bottomStable = 0;
39709 |  720 |   let lastBottomScrollHeight = null;
39710 |  721 | 
39711 |  722 |   async function updateHardBottomStability() {
39712 |  723 |     const m1 = await getScrollMetrics().catch(() => null);
39713 |  724 |     if (!m1) return { atBottom: false, stable: bottomStable, tag: "NA", anyMore: true };
39714 |  725 | 
39715 |  726 |     const atBottom = isHardBottom(m1);
39716 |  727 | 
39717 |  728 |     await sleepRandom(PACE_CFG.hardBottomStableDelayMinMs, PACE_CFG.hardBottomStableDelayMaxMs);
39718 |  729 | 
39719 |  730 |     const m2 = await getScrollMetrics().catch(() => m1);
39720 |  731 |     const atBottom2 = isHardBottom(m2);
39721 |  732 | 
39722 |  733 |     const anyMore = await hasLoadMoreButtons().catch(() => true);
39723 |  734 | 
39724 |  735 |     const sh = Number(m2?.scrollHeight || 0);
39725 |  736 |     const shStable =
39726 |  737 |       lastBottomScrollHeight == null ? true : Math.abs(sh - lastBottomScrollHeight) <= 2;
39727 |  738 | 
39728 |  739 |     if (atBottom && atBottom2 && !anyMore && shStable) bottomStable++;
39729 |  740 |     else bottomStable = 0;
39730 |  741 | 
39731 |  742 |     lastBottomScrollHeight = sh;
39732 |  743 | 
39733 |  744 |     return {
39734 |  745 |       atBottom: atBottom && atBottom2,
39735 |  746 |       stable: bottomStable,
39736 |  747 |       tag: m2?.tag || "UNKNOWN",
39737 |  748 |       anyMore,
39738 |  749 |       scrollTop: m2?.scrollTop,
39739 |  750 |       clientHeight: m2?.clientHeight,
39740 |  751 |       scrollHeight: m2?.scrollHeight,
39741 |  752 |     };
39742 |  753 |   }
39743 |  754 | 
39744 |  755 |   // DOM-driven synchronizacja po klikach (bez ciƒô≈ºkich sleep√≥w)
39745 |  756 |   async function waitForEffect(beforeCounts, kind) {
39746 |  757 |     const timeout = PACE_CFG.effectWaitMs;
39747 |  758 | 
39748 |  759 |     const ok = await page
39749 |  760 |       .waitForFunction(
39750 |  761 |         (root, before, kindArg) => {
39751 |  762 |           const scope = root || document;
39752 |  763 | 
39753 |  764 |           const countUniq = (sel, param) => {
39754 |  765 |             const as = Array.from(scope.querySelectorAll(sel));
39755 |  766 |             const ids = new Set();
39756 |  767 |             for (const a of as) {
39757 |  768 |               const href = a.getAttribute("href") || "";
39758 |  769 |               const m = href.match(new RegExp(`${param}=([^&]+)`));
39759 |  770 |               if (m && m[1]) ids.add(m[1]);
39760 |  771 |             }
39761 |  772 |             return ids.size;
39762 |  773 |           };
39763 |  774 | 
39764 |  775 |           const commentsAnchors = countUniq("a[href*='comment_id']", "comment_id");
39765 |  776 |           const replyAnchors = countUniq("a[href*='reply_comment_id']", "reply_comment_id");
39766 |  777 |           const nodes = scope.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k").length || 0;
39767 |  778 | 
39768 |  779 |           if (
39769 |  780 |             commentsAnchors > (before?.commentsAnchors || 0) ||
39770 |  781 |             replyAnchors > (before?.replyAnchors || 0) ||
39771 |  782 |             nodes > (before?.nodes || 0)
39772 |  783 |           ) {
39773 |  784 |             return true;
39774 |  785 |           }
39775 |  786 | 
39776 |  787 |           const norm = (s) =>
39777 |  788 |             String(s || "")
39778 |  789 |               .replace(/\u00a0/g, " ")
39779 |  790 |               .replace(/\s+/g, " ")
39780 |  791 |               .trim()
39781 |  792 |               .toLowerCase();
39782 |  793 | 
39783 |  794 |           const isVisible = (el) => {
39784 |  795 |             if (!el) return false;
39785 |  796 |             const r = el.getBoundingClientRect();
39786 |  797 |             if (r.width < 2 || r.height < 2) return false;
39787 |  798 |             return r.bottom > 0 && r.top < window.innerHeight;
39788 |  799 |           };
39789 |  800 | 
39790 |  801 |           const nodesBtn = Array.from(
39791 |  802 |             scope.querySelectorAll("button,a,div[role='button'],span[role='button']")
39792 |  803 |           ).filter(isVisible);
39793 |  804 | 
39794 |  805 |           const stillThere =
39795 |  806 |             kindArg === "comments"
39796 |  807 |               ? nodesBtn.some((el) => {
39797 |  808 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
39798 |  809 |                   return (
39799 |  810 |                     t.includes("wy≈õwietl wiƒôcej komentarzy") ||
39800 |  811 |                     t.includes("zobacz wiƒôcej komentarzy") ||
39801 |  812 |                     t.includes("zobacz wcze≈õniejsze komentarze") ||
39802 |  813 |                     t.includes("view more comments") ||
39803 |  814 |                     t.includes("view previous comments")
39804 |  815 |                   );
39805 |  816 |                 })
39806 |  817 |               : nodesBtn.some((el) => {
39807 |  818 |                   const t = norm(el.getAttribute?.("aria-label") || el.textContent);
39808 |  819 |                   if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
39809 |  820 |                   if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
39810 |  821 |                   if (t.includes("zobacz") && t.includes("odpowied")) return true;
39811 |  822 |                   if (t.includes("view") && t.includes("repl")) return true;
39812 |  823 |                   if (t.includes("see") && t.includes("repl")) return true;
39813 |  824 |                   return false;
39814 |  825 |                 });
39815 |  826 | 
39816 |  827 |           // je≈õli klikniƒôty typ przycisku zniknƒÖ≈Ç -> te≈º traktujemy jako ‚Äúefekt‚Äù
39817 |  828 |           return !stillThere;
39818 |  829 |         },
39819 |  830 |         { timeout, polling: 120 },
39820 |  831 |         rootHandle,
39821 |  832 |         beforeCounts,
39822 |  833 |         kind
39823 |  834 |       )
39824 |  835 |       .then(() => true)
39825 |  836 |       .catch(() => false);
39826 |  837 | 
39827 |  838 |     return ok;
39828 |  839 |   }
39829 |  840 | 
39830 |  841 |   async function bonusClicks(kind, beforeCounts) {
39831 |  842 |     const tries = Math.max(0, Number(PACE_CFG.bonusClickTries || 0));
39832 |  843 |     if (!tries) return 0;
39833 |  844 | 
39834 |  845 |     let clicked = 0;
39835 |  846 |     let curBefore = beforeCounts;
39836 |  847 | 
39837 |  848 |     for (let i = 0; i < tries; i++) {
39838 |  849 |       await sleepRandom(PACE_CFG.bonusClickDelayMinMs, PACE_CFG.bonusClickDelayMaxMs);
39839 |  850 | 
39840 |  851 |       const res =
39841 |  852 |         kind === "replies"
39842 |  853 |           ? await clickOneReplyButton().catch(() => ({ clicked: false }))
39843 |  854 |           : await clickMoreCommentsButton().catch(() => ({ clicked: false }));
39844 |  855 | 
39845 |  856 |       if (!res?.clicked) break;
39846 |  857 | 
39847 |  858 |       clicked++;
39848 |  859 | 
39849 |  860 |       // mikro-oddech, potem czekamy na efekt
39850 |  861 |       await sleepRandom(80, 140);
39851 |  862 |       await waitForEffect(curBefore, kind);
39852 |  863 | 
39853 |  864 |       // aktualizujemy bazƒô do kolejnego bonus-kliku
39854 |  865 |       curBefore = await countAnchors().catch(() => curBefore);
39855 |  866 | 
39856 |  867 |       // minimalny settle po do≈Çadowaniu
39857 |  868 |       await sleepRandom(90, 170);
39858 |  869 |     }
39859 |  870 | 
39860 |  871 |     return clicked;
39861 |  872 |   }
39862 |  873 | 
39863 |  874 |     async function clickOneReplyButton() {
39864 |  875 |     const res = await page.evaluate((root) => {
39865 |  876 |       const scope = root || document;
39866 |  877 | 
39867 |  878 |       const norm = (s) =>
39868 |  879 |         String(s || "")
39869 |  880 |           .replace(/\u00a0/g, " ")
39870 |  881 |           .replace(/\s+/g, " ")
39871 |  882 |           .trim()
39872 |  883 |           .toLowerCase();
39873 |  884 | 
39874 |  885 |       const isVisible = (el) => {
39875 |  886 |         if (!el) return false;
39876 |  887 |         try {
39877 |  888 |           const r = el.getBoundingClientRect();
39878 |  889 |           if (r.width < 2 || r.height < 2) return false;
39879 |  890 |           // Dopuszczamy te≈º elementy trochƒô ‚Äúpod‚Äù viewportem ‚Äì FB lubi lazy render
39880 |  891 |           return r.bottom > -60 && r.top < window.innerHeight + 120;
39881 |  892 |         } catch {
39882 |  893 |           return true;
39883 |  894 |         }
39884 |  895 |       };
39885 |  896 | 
39886 |  897 |       const isReplyExpanderText = (t) => {
39887 |  898 |         if (!t) return false;
39888 |  899 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
39889 |  900 |         if (t.length > 220) return false;
39890 |  901 | 
39891 |  902 |         // WYKLUCZ: zwyk≈Çe ‚ÄúOdpowiedz/Reply‚Äù
39892 |  903 |         if (t === "odpowiedz" || t === "reply") return false;
39893 |  904 |         if (t.startsWith("odpowiedz ")) return false;
39894 |  905 |         if (t.startsWith("reply ")) return false;
39895 |  906 | 
39896 |  907 |         // KLUCZ: ‚Äú5 odpowiedzi‚Äù, ‚Äú2 replies‚Äù, oraz ‚Äú... odpowiedzia≈Ç ¬∑ 5 odpowiedzi‚Äù
39897 |  908 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
39898 |  909 | 
39899 |  910 |         // warianty opisowe
39900 |  911 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
39901 |  912 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
39902 |  913 |         if (t.includes("view") && t.includes("repl")) return true;
39903 |  914 |         if (t.includes("see") && t.includes("repl")) return true;
39904 |  915 | 
39905 |  916 |         return false;
39906 |  917 |       };
39907 |  918 | 
39908 |  919 |       // 1) Szukamy NAJSZERZEJ: ka≈ºdy element z tekstem pasujƒÖcym do expandera
39909 |  920 |       // (FB czƒôsto ma to jako zwyk≈Çy div/span bez role/button)
39910 |  921 |       const allTextCandidates = Array.from(
39911 |  922 |         scope.querySelectorAll("a,button,div,span")
39912 |  923 |       )
39913 |  924 |         .filter(isVisible)
39914 |  925 |         .slice(0, 35000);
39915 |  926 | 
39916 |  927 |       let best = null;
39917 |  928 |       let bestScore = -Infinity;
39918 |  929 | 
39919 |  930 |       for (const el of allTextCandidates) {
39920 |  931 |         const tRaw = el.getAttribute?.("aria-label") || el.textContent || "";
39921 |  932 |         const t = norm(tRaw);
39922 |  933 |         if (!isReplyExpanderText(t)) continue;
39923 |  934 | 
39924 |  935 |         // Wyklucz elementy, kt√≥re sƒÖ ‚Äúprzyciskami reakcji‚Äù itp.
39925 |  936 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
39926 |  937 |         if (t.includes("udost") || t.includes("share")) continue;
39927 |  938 | 
39928 |  939 |         const r = el.getBoundingClientRect();
39929 |  940 |         let score = 0;
39930 |  941 | 
39931 |  942 |         // preferuj elementy ni≈ºej (zwykle wƒÖtki sƒÖ pod komentarzem)
39932 |  943 |         score += Math.max(0, r.top);
39933 |  944 | 
39934 |  945 |         // preferuj te z liczbƒÖ odpowiedzi
39935 |  946 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) score += 900;
39936 |  947 | 
39937 |  948 |         // preferuj ‚Äúwszystkie/all‚Äù
39938 |  949 |         if (t.includes("wszystkie") || t.includes("all")) score += 300;
39939 |  950 | 
39940 |  951 |         // preferuj kr√≥tsze, ‚Äúczystsze‚Äù teksty (mniej ≈õmieci)
39941 |  952 |         score -= Math.min(500, t.length * 3);
39942 |  953 | 
39943 |  954 |         if (score > bestScore) {
39944 |  955 |           bestScore = score;
39945 |  956 |           best = el;
39946 |  957 |         }
39947 |  958 |       }
39948 |  959 | 
39949 |  960 |       if (!best) return { clicked: false };
39950 |  961 | 
39951 |  962 |       // 2) Klikamy NAJBLI≈ªSZY ‚Äúklikany‚Äù wrapper, a je≈õli go nie ma ‚Äì klikamy sam tekst
39952 |  963 |       const clickable =
39953 |  964 |         best.closest?.("a,button,div[role='button'],span[role='button']") || best;
39954 |  965 | 
39955 |  966 |       try {
39956 |  967 |         clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
39957 |  968 |       } catch {}
39958 |  969 | 
39959 |  970 |       const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
39960 |  971 | 
39961 |  972 |       const hardClick = (node) => {
39962 |  973 |         try {
39963 |  974 |           node.click();
39964 |  975 |           return true;
39965 |  976 |         } catch {}
39966 |  977 |         try {
39967 |  978 |           const r = node.getBoundingClientRect();
39968 |  979 |           const x = Math.floor(r.left + Math.min(10, r.width / 2));
39969 |  980 |           const y = Math.floor(r.top + Math.min(10, r.height / 2));
39970 |  981 |           const target = document.elementFromPoint(x, y) || node;
39971 |  982 |           target.dispatchEvent(new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window }));
39972 |  983 |           target.dispatchEvent(new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window }));
39973 |  984 |           target.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
39974 |  985 |           return true;
39975 |  986 |         } catch {}
39976 |  987 |         return false;
39977 |  988 |       };
39978 |  989 | 
39979 |  990 |       const ok = hardClick(clickable);
39980 |  991 |       return { clicked: ok, text: txt };
39981 |  992 |     }, rootHandle);
39982 |  993 | 
39983 |  994 |     return res || { clicked: false };
39984 |  995 |   }
39985 |  996 | 
39986 |  997 | 
39987 |  998 |   async function clickMoreCommentsButton() {
39988 |  999 |     const res = await page.evaluate((root) => {
39989 | 1000 |       const scope = root || document;
39990 | 1001 | 
39991 | 1002 |       const norm = (s) =>
39992 | 1003 |         String(s || "")
39993 | 1004 |           .replace(/\u00a0/g, " ")
39994 | 1005 |           .replace(/\s+/g, " ")
39995 | 1006 |           .trim()
39996 | 1007 |           .toLowerCase();
39997 | 1008 | 
39998 | 1009 |       const isVisible = (el) => {
39999 | 1010 |         if (!el) return false;
40000 | 1011 |         const r = el.getBoundingClientRect();
40001 | 1012 |         if (r.width < 2 || r.height < 2) return false;
40002 | 1013 |         return r.bottom > 0 && r.top < window.innerHeight;
40003 | 1014 |       };
40004 | 1015 | 
40005 | 1016 |       const isMore = (t) => {
40006 | 1017 |         if (!t) return false;
40007 | 1018 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
40008 | 1019 |         if (t.length > 140) return false;
40009 | 1020 | 
40010 | 1021 |         return (
40011 | 1022 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
40012 | 1023 |           t.includes("zobacz wiƒôcej komentarzy") ||
40013 | 1024 |           t.includes("zobacz wcze≈õniejsze komentarze") ||
40014 | 1025 |           t.includes("view more comments") ||
40015 | 1026 |           t.includes("view previous comments")
40016 | 1027 |         );
40017 | 1028 |       };
40018 | 1029 | 
40019 | 1030 |       const candidates = Array.from(
40020 | 1031 |         scope.querySelectorAll("a,button,div[role='button'],span[role='button']")
40021 | 1032 |       ).filter(isVisible);
40022 | 1033 | 
40023 | 1034 |       let best = null;
40024 | 1035 |       let bestY = -1;
40025 | 1036 | 
40026 | 1037 |       for (const el of candidates) {
40027 | 1038 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
40028 | 1039 |         if (!isMore(t)) continue;
40029 | 1040 |         const r = el.getBoundingClientRect();
40030 | 1041 |         if (r.top > bestY) {
40031 | 1042 |           bestY = r.top;
40032 | 1043 |           best = el;
40033 | 1044 |         }
40034 | 1045 |       }
40035 | 1046 | 
40036 | 1047 |       if (!best) return { clicked: false };
40037 | 1048 | 
40038 | 1049 |       try {
40039 | 1050 |         best.scrollIntoView?.({ block: "center", inline: "nearest" });
40040 | 1051 |       } catch {}
40041 | 1052 | 
40042 | 1053 |       const txt = (best.getAttribute?.("aria-label") || best.textContent || "").trim();
40043 | 1054 | 
40044 | 1055 |       try {
40045 | 1056 |         best.click();
40046 | 1057 |         return { clicked: true, text: txt };
40047 | 1058 |       } catch {
40048 | 1059 |         return { clicked: false, text: txt };
40049 | 1060 |       }
40050 | 1061 |     }, rootHandle);
40051 | 1062 | 
40052 | 1063 |     return res || { clicked: false };
40053 | 1064 |   }
40054 | 1065 | 
40055 | 1066 |   /* ===================== SWEEP: REPLY EXPANDERS (TOP -> DOWN) ===================== */
40056 | 1067 | 
40057 | 1068 |   async function hasAnyReplyExpanders(page, rootHandle) {
40058 | 1069 |     return page.evaluate((root) => {
40059 | 1070 |       const scope = root || document;
40060 | 1071 | 
40061 | 1072 |       const norm = (s) =>
40062 | 1073 |         String(s || "")
40063 | 1074 |           .replace(/\u00a0/g, " ")
40064 | 1075 |           .replace(/\s+/g, " ")
40065 | 1076 |           .trim()
40066 | 1077 |           .toLowerCase();
40067 | 1078 | 
40068 | 1079 |       const isVisible = (el) => {
40069 | 1080 |         if (!el) return false;
40070 | 1081 |         try {
40071 | 1082 |           const r = el.getBoundingClientRect();
40072 | 1083 |           return r.width > 2 && r.height > 2 && r.bottom > -60 && r.top < window.innerHeight + 120;
40073 | 1084 |         } catch {
40074 | 1085 |           return true;
40075 | 1086 |         }
40076 | 1087 |       };
40077 | 1088 | 
40078 | 1089 |       const isReplyExpanderText = (t) => {
40079 | 1090 |         if (!t) return false;
40080 | 1091 |         if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
40081 | 1092 |         if (t.length > 220) return false;
40082 | 1093 | 
40083 | 1094 |         if (t === "odpowiedz" || t === "reply") return false;
40084 | 1095 |         if (t.startsWith("odpowiedz ")) return false;
40085 | 1096 |         if (t.startsWith("reply ")) return false;
40086 | 1097 | 
40087 | 1098 |         if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
40088 | 1099 | 
40089 | 1100 |         if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
40090 | 1101 |         if (t.includes("zobacz") && t.includes("odpowied")) return true;
40091 | 1102 |         if (t.includes("view") && t.includes("repl")) return true;
40092 | 1103 |         if (t.includes("see") && t.includes("repl")) return true;
40093 | 1104 | 
40094 | 1105 |         return false;
40095 | 1106 |       };
40096 | 1107 | 
40097 | 1108 |       const nodes = Array.from(scope.querySelectorAll("a,button,div,span")).slice(0, 35000);
40098 | 1109 | 
40099 | 1110 |       for (const el of nodes) {
40100 | 1111 |         if (!isVisible(el)) continue;
40101 | 1112 |         const t = norm(el.getAttribute?.("aria-label") || el.textContent);
40102 | 1113 |         if (!t) continue;
40103 | 1114 | 
40104 | 1115 |         if (t.includes("lubiƒô") || t.includes("like")) continue;
40105 | 1116 |         if (t.includes("udost") || t.includes("share")) continue;
40106 | 1117 | 
40107 | 1118 |         if (isReplyExpanderText(t)) return true;
40108 | 1119 |       }
40109 | 1120 | 
40110 | 1121 |       return false;
40111 | 1122 |     }, rootHandle);
40112 | 1123 |   }
40113 | 1124 | 
40114 | 1125 |   async function clickAllVisibleReplyExpanders(page, rootHandle, maxPerPass = 12) {
40115 | 1126 |     const res = await page.evaluate(
40116 | 1127 |       (root, limit) => {
40117 | 1128 |         const scope = root || document;
40118 | 1129 | 
40119 | 1130 |         const norm = (s) =>
40120 | 1131 |           String(s || "")
40121 | 1132 |             .replace(/\u00a0/g, " ")
40122 | 1133 |             .replace(/\s+/g, " ")
40123 | 1134 |             .trim()
40124 | 1135 |             .toLowerCase();
40125 | 1136 | 
40126 | 1137 |         const isVisible = (el) => {
40127 | 1138 |           if (!el) return false;
40128 | 1139 |           try {
40129 | 1140 |             const r = el.getBoundingClientRect();
40130 | 1141 |             if (r.width < 2 || r.height < 2) return false;
40131 | 1142 |             return r.bottom > -60 && r.top < window.innerHeight + 120;
40132 | 1143 |           } catch {
40133 | 1144 |             return true;
40134 | 1145 |           }
40135 | 1146 |         };
40136 | 1147 | 
40137 | 1148 |         const isReplyExpanderText = (t) => {
40138 | 1149 |           if (!t) return false;
40139 | 1150 |           if (t.includes("powiadomienia") || t.includes("szukaj znajomych")) return false;
40140 | 1151 |           if (t.length > 220) return false;
40141 | 1152 | 
40142 | 1153 |           if (t === "odpowiedz" || t === "reply") return false;
40143 | 1154 |           if (t.startsWith("odpowiedz ")) return false;
40144 | 1155 |           if (t.startsWith("reply ")) return false;
40145 | 1156 | 
40146 | 1157 |           if (/\b\d+\s*(odpowiedzi|replies)\b/.test(t)) return true;
40147 | 1158 | 
40148 | 1159 |           if (t.includes("wy≈õwietl") && t.includes("odpowied")) return true;
40149 | 1160 |           if (t.includes("zobacz") && t.includes("odpowied")) return true;
40150 | 1161 |           if (t.includes("view") && t.includes("repl")) return true;
40151 | 1162 |           if (t.includes("see") && t.includes("repl")) return true;
40152 | 1163 | 
40153 | 1164 |           return false;
40154 | 1165 |         };
40155 | 1166 | 
40156 | 1167 |         const candidates = Array.from(scope.querySelectorAll("a,button,div,span"))
40157 | 1168 |           .filter(isVisible)
40158 | 1169 |           .slice(0, 35000)
40159 | 1170 |           .map((el) => {
40160 | 1171 |             const t = norm(el.getAttribute?.("aria-label") || el.textContent);
40161 | 1172 |             return { el, t };
40162 | 1173 |           })
40163 | 1174 |           .filter((x) => {
40164 | 1175 |             if (!x.t) return false;
40165 | 1176 |             if (x.t.includes("lubiƒô") || x.t.includes("like")) return false;
40166 | 1177 |             if (x.t.includes("udost") || x.t.includes("share")) return false;
40167 | 1178 |             return isReplyExpanderText(x.t);
40168 | 1179 |           });
40169 | 1180 | 
40170 | 1181 |         // preferuj elementy ni≈ºej w widoku
40171 | 1182 |         candidates.sort((a, b) => {
40172 | 1183 |           const ra = a.el.getBoundingClientRect();
40173 | 1184 |           const rb = b.el.getBoundingClientRect();
40174 | 1185 |           return rb.top - ra.top;
40175 | 1186 |         });
40176 | 1187 | 
40177 | 1188 |         const hardClick = (node) => {
40178 | 1189 |           try {
40179 | 1190 |             node.click();
40180 | 1191 |             return true;
40181 | 1192 |           } catch {}
40182 | 1193 |           try {
40183 | 1194 |             const r = node.getBoundingClientRect();
40184 | 1195 |             const x = Math.floor(r.left + Math.min(10, r.width / 2));
40185 | 1196 |             const y = Math.floor(r.top + Math.min(10, r.height / 2));
40186 | 1197 |             const target = document.elementFromPoint(x, y) || node;
40187 | 1198 |             target.dispatchEvent(
40188 | 1199 |               new MouseEvent("mousedown", { bubbles: true, cancelable: true, view: window })
40189 | 1200 |             );
40190 | 1201 |             target.dispatchEvent(
40191 | 1202 |               new MouseEvent("mouseup", { bubbles: true, cancelable: true, view: window })
40192 | 1203 |             );
40193 | 1204 |             target.dispatchEvent(
40194 | 1205 |               new MouseEvent("click", { bubbles: true, cancelable: true, view: window })
40195 | 1206 |             );
40196 | 1207 |             return true;
40197 | 1208 |           } catch {}
40198 | 1209 |           return false;
40199 | 1210 |         };
40200 | 1211 | 
40201 | 1212 |         let clicked = 0;
40202 | 1213 |         const sample = [];
40203 | 1214 | 
40204 | 1215 |         for (const item of candidates) {
40205 | 1216 |           if (clicked >= limit) break;
40206 | 1217 | 
40207 | 1218 |           const clickable =
40208 | 1219 |             item.el.closest?.("a,button,div[role='button'],span[role='button']") || item.el;
40209 | 1220 | 
40210 | 1221 |           try {
40211 | 1222 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
40212 | 1223 |           } catch {}
40213 | 1224 | 
40214 | 1225 |           const txt = (clickable.getAttribute?.("aria-label") || clickable.textContent || "").trim();
40215 | 1226 | 
40216 | 1227 |           const ok = hardClick(clickable);
40217 | 1228 |           if (ok) {
40218 | 1229 |             clicked++;
40219 | 1230 |             if (sample.length < 5) sample.push(txt);
40220 | 1231 |           }
40221 | 1232 |         }
40222 | 1233 | 
40223 | 1234 |         return { clicked, sample };
40224 | 1235 |       },
40225 | 1236 |       rootHandle,
40226 | 1237 |       maxPerPass
40227 | 1238 |     );
40228 | 1239 | 
40229 | 1240 |     return res || { clicked: 0, sample: [] };
40230 | 1241 |   }
40231 | 1242 | 
40232 | 1243 |   async function scrollCommentsToTop(page, rootHandle, scrollHandle) {
40233 | 1244 |     await page.evaluate((root, scroller) => {
40234 | 1245 |       const pick =
40235 | 1246 |         scroller || root || document.scrollingElement || document.documentElement || document.body;
40236 | 1247 | 
40237 | 1248 |       if (pick && typeof pick.scrollTop === "number") pick.scrollTop = 0;
40238 | 1249 |       else window.scrollTo(0, 0);
40239 | 1250 |     }, rootHandle, scrollHandle);
40240 | 1251 |   }
40241 | 1252 | 
40242 | 1253 |   async function sweepRepliesTopDown(
40243 | 1254 |     page,
40244 | 1255 |     rootHandle,
40245 | 1256 |     scrollHandle,
40246 | 1257 |     {
40247 | 1258 |       maxPasses = 3,
40248 | 1259 |       stepsPerPass = 40,
40249 | 1260 |       scrollPx = Math.max(180, Math.floor(Number(PACE_CFG.scrollPx || 160) * 1.2)),
40250 | 1261 |       maxClicksPerStep = 12,
40251 | 1262 |     } = {}
40252 | 1263 |   ) {
40253 | 1264 |     let totalClicked = 0;
40254 | 1265 | 
40255 | 1266 |     for (let pass = 1; pass <= maxPasses; pass++) {
40256 | 1267 |       await scrollCommentsToTop(page, rootHandle, scrollHandle);
40257 | 1268 |       await sleepRandom(140, 240);
40258 | 1269 | 
40259 | 1270 |       let staleSteps = 0;
40260 | 1271 | 
40261 | 1272 |       for (let step = 1; step <= stepsPerPass; step++) {
40262 | 1273 |         const before = await countAnchors().catch(() => null);
40263 | 1274 | 
40264 | 1275 |         const r = await clickAllVisibleReplyExpanders(page, rootHandle, maxClicksPerStep).catch(
40265 | 1276 |           () => ({ clicked: 0, sample: [] })
40266 | 1277 |         );
40267 | 1278 | 
40268 | 1279 |         if (r.clicked > 0) {
40269 | 1280 |           totalClicked += r.clicked;
40270 | 1281 | 
40271 | 1282 |           if (before) {
40272 | 1283 |             await sleepRandom(60, 120);
40273 | 1284 |             await waitForEffect(before, "replies");
40274 | 1285 |           }
40275 | 1286 | 
40276 | 1287 |           await sleepRandom(90, 160);
40277 | 1288 |           staleSteps = 0;
40278 | 1289 |         } else {
40279 | 1290 |           staleSteps++;
40280 | 1291 |         }
40281 | 1292 | 
40282 | 1293 |         const m1 = await getScrollMetrics().catch(() => null);
40283 | 1294 |         await gentleScrollKick(scrollPx);
40284 | 1295 |         const m2 = await getScrollMetrics().catch(() => null);
40285 | 1296 | 
40286 | 1297 |         const moved = !!(m1 && m2 && m2.scrollTop !== m1.scrollTop);
40287 | 1298 | 
40288 | 1299 |         if (!moved && staleSteps >= 4) break;
40289 | 1300 |         if (staleSteps >= 8) break;
40290 | 1301 |       }
40291 | 1302 | 
40292 | 1303 |       const any = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
40293 | 1304 |       if (!any) break;
40294 | 1305 |     }
40295 | 1306 | 
40296 | 1307 |     return totalClicked;
40297 | 1308 |   }
40298 | 1309 | 
40299 | 1310 |   /* ------------------ LOG throttling (bez spamu) ------------------ */
40300 | 1311 |   let lastLogAt = 0;
40301 | 1312 |   let lastLogKey = "";
40302 | 1313 |   const LOG_EVERY_N_STEPS = 6;
40303 | 1314 |   const LOG_MIN_MS = 800;
40304 | 1315 |   const shouldLog = (step, key, force = false) => {
40305 | 1316 |     const now = Date.now();
40306 | 1317 |     if (force) {
40307 | 1318 |       lastLogAt = now;
40308 | 1319 |       lastLogKey = key;
40309 | 1320 |       return true;
40310 | 1321 |     }
40311 | 1322 |     if (step % LOG_EVERY_N_STEPS === 0) {
40312 | 1323 |       lastLogAt = now;
40313 | 1324 |       lastLogKey = key;
40314 | 1325 |       return true;
40315 | 1326 |     }
40316 | 1327 |     if (now - lastLogAt >= LOG_MIN_MS && key !== lastLogKey) {
40317 | 1328 |       lastLogAt = now;
40318 | 1329 |       lastLogKey = key;
40319 | 1330 |       return true;
40320 | 1331 |     }
40321 | 1332 |     return false;
40322 | 1333 |   };
40323 | 1334 | 
40324 | 1335 |   let cur = await countAnchors().catch(() => ({ commentsAnchors: 0, replyAnchors: 0, nodes: 0 }));
40325 | 1336 |   console.log("[FB][ui:photo] startCounts:", cur);
40326 | 1337 | 
40327 | 1338 |   for (let step = 1; step <= MAX_STEPS; step++) {
40328 | 1339 |     const before = cur;
40329 | 1340 |     let action = "scroll";
40330 | 1341 |     let clickInfo = null;
40331 | 1342 |     let effectOk = false;
40332 | 1343 |     let bonus = 0;
40333 | 1344 | 
40334 | 1345 |     // 1) REPLIES
40335 | 1346 |     const r1 = await clickOneReplyButton().catch(() => ({ clicked: false }));
40336 | 1347 |     if (r1?.clicked) {
40337 | 1348 |       action = "replies";
40338 | 1349 |       clickInfo = r1;
40339 | 1350 | 
40340 | 1351 |       await sleepRandom(80, 140);
40341 | 1352 |       effectOk = await waitForEffect(before, "replies");
40342 | 1353 |       await sleepRandom(90, 170);
40343 | 1354 | 
40344 | 1355 |       // bonus klik√≥w tylko je≈õli by≈Ç efekt (≈ºeby nie mieliƒá)
40345 | 1356 |       if (effectOk) {
40346 | 1357 |         bonus = await bonusClicks("replies", before);
40347 | 1358 |       } else {
40348 | 1359 |         // brak efektu -> delikatny scroll, czƒôsto przycisk jest pod overlay / wirtualizacja
40349 | 1360 |         await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
40350 | 1361 |       }
40351 | 1362 |     } else {
40352 | 1363 |       // 2) MORE COMMENTS
40353 | 1364 |       const c1 = await clickMoreCommentsButton().catch(() => ({ clicked: false }));
40354 | 1365 |       if (c1?.clicked) {
40355 | 1366 |         action = "comments";
40356 | 1367 |         clickInfo = c1;
40357 | 1368 | 
40358 | 1369 |         await sleepRandom(80, 140);
40359 | 1370 |         effectOk = await waitForEffect(before, "comments");
40360 | 1371 |         await sleepRandom(90, 170);
40361 | 1372 | 
40362 | 1373 |         if (effectOk) {
40363 | 1374 |           bonus = await bonusClicks("comments", before);
40364 | 1375 |         } else {
40365 | 1376 |           await gentleScrollKick(Math.floor(PACE_CFG.scrollPx * 0.6));
40366 | 1377 |         }
40367 | 1378 |       } else {
40368 | 1379 |         // 3) SCROLL
40369 | 1380 |         action = "scroll";
40370 | 1381 |         await gentleScrollKick(PACE_CFG.scrollPx);
40371 | 1382 |       }
40372 | 1383 |     }
40373 | 1384 | 
40374 | 1385 |     cur = await countAnchors().catch(() => before);
40375 | 1386 | 
40376 | 1387 |     const progressed =
40377 | 1388 |       cur.commentsAnchors > before.commentsAnchors ||
40378 | 1389 |       cur.replyAnchors > before.replyAnchors ||
40379 | 1390 |       cur.nodes > before.nodes;
40380 | 1391 | 
40381 | 1392 |     if (!progressed) noProgress++;
40382 | 1393 |     else noProgress = 0;
40383 | 1394 | 
40384 | 1395 |     // Hard-bottom sprawdzamy tylko wtedy, gdy realnie utknƒôli≈õmy albo scrollujemy
40385 | 1396 |     let hb = { atBottom: false, stable: 0, tag: "NA", anyMore: true };
40386 | 1397 |     const shouldCheckHB = action === "scroll" || noProgress >= 3;
40387 | 1398 |     if (shouldCheckHB) {
40388 | 1399 |       hb = await updateHardBottomStability().catch(() => ({
40389 | 1400 |         atBottom: false,
40390 | 1401 |         stable: bottomStable,
40391 | 1402 |         tag: "NA",
40392 | 1403 |         anyMore: true,
40393 | 1404 |       }));
40394 | 1405 |     }
40395 | 1406 | 
40396 | 1407 |     const btnTxt = clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "";
40397 | 1408 |     const key =
40398 | 1409 |       `${action}|cA:${before.commentsAnchors}->${cur.commentsAnchors}` +
40399 | 1410 |       `|rA:${before.replyAnchors}->${cur.replyAnchors}` +
40400 | 1411 |       `|n:${before.nodes}->${cur.nodes}|np:${noProgress}|eff:${effectOk}|bonus:${bonus}` +
40401 | 1412 |       `|hb:${hb.atBottom ? 1 : 0}/${hb.stable} more:${hb.anyMore ? 1 : 0} tag:${hb.tag}${btnTxt}`;
40402 | 1413 | 
40403 | 1414 |     const forceLog = progressed || clickInfo?.clicked || noProgress >= 10 || hb.stable >= 2;
40404 | 1415 |     if (shouldLog(step, key, forceLog)) {
40405 | 1416 |       console.log(
40406 | 1417 |         `[FB][ui:photo] step=${step} action=${action} eff=${effectOk ? "OK" : "NO"} bonus=${bonus} ` +
40407 | 1418 |           `cA ${before.commentsAnchors}->${cur.commentsAnchors} ` +
40408 | 1419 |           `rA ${before.replyAnchors}->${cur.replyAnchors} ` +
40409 | 1420 |           `nodes ${before.nodes}->${cur.nodes} ` +
40410 | 1421 |           `np=${noProgress}/${MAX_NO_PROGRESS} ` +
40411 | 1422 |           `hb=${hb.atBottom ? "Y" : "N"} stable=${hb.stable}/${PACE_CFG.hardBottomStableNeed} more=${
40412 | 1423 |             hb.anyMore ? "Y" : "N"
40413 | 1424 |           } scroller=${hb.tag}` +
40414 | 1425 |           (clickInfo?.clicked ? ` btn="${shortBtn(clickInfo.text)}"` : "")
40415 | 1426 |       );
40416 | 1427 |     }
40417 | 1428 | 
40418 | 1429 |     if (hb.stable >= Number(PACE_CFG.hardBottomStableNeed || 4)) {
40419 | 1430 |       console.log("[FB][ui:photo] stop: hard-bottom-stable (true bottom reached)");
40420 | 1431 |       break;
40421 | 1432 |     }
40422 | 1433 | 
40423 | 1434 |     if (noProgress >= MAX_NO_PROGRESS) {
40424 | 1435 |       console.log("[FB][ui:photo] stop: too many no-progress steps (safety)");
40425 | 1436 |       break;
40426 | 1437 |     }
40427 | 1438 | 
40428 | 1439 |     // mikrojitter na ko≈Ñcu kroku (≈ºeby FB nie dosta≈Ç ‚Äúkarabinu‚Äù)
40429 | 1440 |     await sleepRandom(PACE_CFG.stepJitterMinMs, PACE_CFG.stepJitterMaxMs);
40430 | 1441 |   }
40431 | 1442 | 
40432 | 1443 |   // FINAL + SWEEP (tylko je≈õli co≈õ jeszcze zosta≈Ço do klikniƒôcia)
40433 | 1444 |   let final = await countAnchors().catch(() => cur);
40434 | 1445 |   console.log("[FB][ui:photo] done:", final);
40435 | 1446 | 
40436 | 1447 |   const needSweep = await hasAnyReplyExpanders(page, rootHandle).catch(() => false);
40437 | 1448 |   if (needSweep) {
40438 | 1449 |     console.log("[FB][ui:photo] sweep: wykryto jeszcze reply expanders -> odpalam sweep top-down‚Ä¶");
40439 | 1450 |     const clicked = await sweepRepliesTopDown(page, rootHandle, scrollHandle).catch(() => 0);
40440 | 1451 |     console.log(`[FB][ui:photo] sweep: clicked=${clicked}`);
40441 | 1452 |     final = await countAnchors().catch(() => final);
40442 | 1453 |     console.log("[FB][ui:photo] after sweep:", final);
40443 | 1454 |   } else {
40444 | 1455 |     console.log("[FB][ui:photo] sweep: brak reply expanders -> pomijam.");
40445 | 1456 |   }
40446 | 1457 | 
40447 | 1458 |   try {
40448 | 1459 |     await scrollHandle.dispose?.();
40449 | 1460 |   } catch {}
40450 | 1461 |   try {
40451 | 1462 |     await rootHandle.dispose?.();
40452 | 1463 |   } catch {}
40453 | 1464 | }
40454 | 1465 | 
40455 | 1466 | /* =====================
40456 | 1467 |    Analiza za≈Ço≈ºe≈Ñ
40457 | 1468 |    1) Zak≈Çadanie sta≈Çych sleep√≥w po klikach rozje≈ºd≈ºa siƒô z async-renderem FB.
40458 | 1469 |       Tu wiƒôkszo≈õƒá synchronizacji jest DOM-driven (waitForEffect) + mikro settle.
40459 | 1470 |    2) ‚Äúreply‚Äù i ‚ÄúX odpowiedzi‚Äù bywajƒÖ r√≥≈ºnymi wrapperami ‚Äî klikamy closest() i filtrujemy tekstem.
40460 | 1471 |    3) Hard-bottom jest kosztowny czasowo, wiƒôc liczymy go tylko gdy utknƒôli≈õmy/scrollujemy.
40461 | 1472 | 
40462 | 1473 |    Co powiedzia≈Çby sceptyk?
40463 | 1474 |    - Je≈õli FB wirtualizuje wƒÖtek, ‚Äúdone‚Äù nie zawsze znaczy ‚Äúwszystko wczytane‚Äù.
40464 | 1475 |    - ‚ÄúLoaded‚Äù (comment_id) nigdy nie jest ‚Äútotal‚Äù, tylko ‚Äúile ju≈º zobaczy≈Çe≈õ‚Äù.
40465 | 1476 |    - UI warianty potrafiƒÖ zmieniaƒá nazwy/role ‚Äî logi i fallbacki sƒÖ konieczne.
40466 | 1477 | 
40467 | 1478 |    ===================== */
40468 | 1479 | 
40469 | ```
40470 | 
40471 | ---
40472 | 
40473 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/post.js`
40474 | **Typ:** JavaScript/tekst  
40475 | **Opis:** Plik projektu (kod/konfiguracja).  
40476 | 
40477 | ```js
40478 |   1 | // src/fb/ui/post.js
40479 |   2 | import { EXPAND_COMMENTS } from "../../config.js";
40480 |   3 | import { sleepRandom } from "../../utils/sleep.js";
40481 |   4 | import { safeGoto } from "../../utils/navigation.js";
40482 |   5 | 
40483 |   6 | import { scrollPost } from "../scroll.js";
40484 |   7 | import { acceptCookies, saveCookies } from "../cookies.js";
40485 |   8 | import { ensureLoggedInOnPostOverlay, fbLogin, checkIfLogged } from "../login.js";
40486 |   9 | import { clickOneExpandButton } from "../expandButtons.js";
40487 |  10 | 
40488 |  11 | const NAV_TIMEOUT_MS = process.env.NAV_TIMEOUT_MS ? Number(process.env.NAV_TIMEOUT_MS) : 90000;
40489 |  12 | 
40490 |  13 | export const type = "post";
40491 |  14 | 
40492 |  15 | export function matchesUrl(url) {
40493 |  16 |   if (!url) return false;
40494 |  17 |   const u = String(url);
40495 |  18 |   if (u.includes("/watch")) return false;
40496 |  19 |   if (u.includes("/videos/")) return false;
40497 |  20 |   if (u.includes("/photo")) return false;
40498 |  21 |   if (u.includes("photo.php")) return false;
40499 |  22 | 
40500 |  23 |   return (
40501 |  24 |     u.includes("/posts/") ||
40502 |  25 |     u.includes("permalink.php") ||
40503 |  26 |     u.includes("/story.php") ||
40504 |  27 |     /facebook\.com\/[^/]+\/posts\//i.test(u)
40505 |  28 |   );
40506 |  29 | }
40507 |  30 | 
40508 |  31 | /* ============================================================
40509 |  32 |    =============== POST ROOT (DIALOG / MAIN) ===================
40510 |  33 |    ============================================================ */
40511 |  34 | 
40512 |  35 | function postRootScript() {
40513 |  36 |   return `
40514 |  37 |     function getPostRoot() {
40515 |  38 |       const dialogs = Array.from(document.querySelectorAll("div[role='dialog']"));
40516 |  39 | 
40517 |  40 |       const postDialog = dialogs.find((dlg) => {
40518 |  41 |         const text = (dlg.innerText || dlg.textContent || "").toLowerCase();
40519 |  42 |         if (!text) return false;
40520 |  43 | 
40521 |  44 |         const hasCommentWord = text.includes("komentarz") || text.includes("comment");
40522 |  45 |         const hasActions =
40523 |  46 |           text.includes("lubiƒô to") ||
40524 |  47 |           text.includes("komentarz") ||
40525 |  48 |           text.includes("udostƒôpnij") ||
40526 |  49 |           text.includes("write a comment") ||
40527 |  50 |           text.includes("comment");
40528 |  51 | 
40529 |  52 |         const looksLikeNotifications =
40530 |  53 |           text.startsWith("powiadomienia") &&
40531 |  54 |           text.includes("wszystkie") &&
40532 |  55 |           text.includes("nieprzeczytane");
40533 |  56 | 
40534 |  57 |         return !looksLikeNotifications && hasCommentWord && hasActions;
40535 |  58 |       });
40536 |  59 | 
40537 |  60 |       if (postDialog) {
40538 |  61 |         const art = postDialog.querySelector("article");
40539 |  62 |         return art || postDialog;
40540 |  63 |       }
40541 |  64 | 
40542 |  65 |       const main = document.querySelector("div[role='main'], main");
40543 |  66 |       if (main) {
40544 |  67 |         const article = main.querySelector("article");
40545 |  68 |         return article || main;
40546 |  69 |       }
40547 |  70 | 
40548 |  71 |       return document.body;
40549 |  72 |     }
40550 |  73 |   `;
40551 |  74 | }
40552 |  75 | 
40553 |  76 | async function getPostScopeSelector(page) {
40554 |  77 |   const scope = await page.evaluate((code) => {
40555 |  78 |     // eslint-disable-next-line no-eval
40556 |  79 |     eval(code);
40557 |  80 |     // @ts-ignore
40558 |  81 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
40559 |  82 |     if (!root) return "document";
40560 |  83 | 
40561 |  84 |     const dlg = root.closest("div[role='dialog']");
40562 |  85 |     if (dlg) return "div[role='dialog']";
40563 |  86 | 
40564 |  87 |     const main = document.querySelector("div[role='main'], main");
40565 |  88 |     if (main) return "div[role='main']";
40566 |  89 | 
40567 |  90 |     return "document";
40568 |  91 |   }, postRootScript());
40569 |  92 | 
40570 |  93 |   return scope || "document";
40571 |  94 | }
40572 |  95 | 
40573 |  96 | /* ============================================================
40574 |  97 |    =========== PRZE≈ÅƒÑCZANIE FILTRA: ALL COMMENTS ===============
40575 |  98 |    ============================================================ */
40576 |  99 | 
40577 | 100 | async function clickAllCommentsInMenu(page) {
40578 | 101 |   const result = await page.evaluate(() => {
40579 | 102 |     const norm = (s) =>
40580 | 103 |       String(s || "")
40581 | 104 |         .replace(/\u00a0/g, " ")
40582 | 105 |         .replace(/\s+/g, " ")
40583 | 106 |         .trim()
40584 | 107 |         .toLowerCase();
40585 | 108 | 
40586 | 109 |     const menu = document.querySelector("div[role='menu']");
40587 | 110 |     if (!menu) return { clicked: false, noMenu: true };
40588 | 111 | 
40589 | 112 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio']"));
40590 | 113 | 
40591 | 114 |     const opt = items.find((el) => {
40592 | 115 |       const t = norm(el.textContent);
40593 | 116 |       return (
40594 | 117 |         t.startsWith("wszystkie komentarze") ||
40595 | 118 |         t.startsWith("all comments") ||
40596 | 119 |         t.startsWith("poka≈º wszystkie") ||
40597 | 120 |         t.startsWith("pokaz wszystkie") ||
40598 | 121 |         t.startsWith("show all")
40599 | 122 |       );
40600 | 123 |     });
40601 | 124 | 
40602 | 125 |     if (!opt) return { clicked: false, noMenu: false };
40603 | 126 | 
40604 | 127 |     try {
40605 | 128 |       opt.scrollIntoView?.({ block: "center", inline: "nearest" });
40606 | 129 |     } catch {}
40607 | 130 | 
40608 | 131 |     try {
40609 | 132 |       opt.click();
40610 | 133 |       return { clicked: true, noMenu: false };
40611 | 134 |     } catch {
40612 | 135 |       return { clicked: false, noMenu: false };
40613 | 136 |     }
40614 | 137 |   });
40615 | 138 | 
40616 | 139 |   if (result.clicked) {
40617 | 140 |     await sleepRandom(250, 450);
40618 | 141 |     await page
40619 | 142 |       .waitForFunction(() => !document.querySelector("div[role='menu']"), { timeout: 2500 })
40620 | 143 |       .catch(() => {});
40621 | 144 |   }
40622 | 145 | 
40623 | 146 |   return result;
40624 | 147 | }
40625 | 148 | 
40626 | 149 | async function switchCommentsFilterToAllScoped(page, scopeSel = "document") {
40627 | 150 |   console.log("[FB][ui:post][filter] Pr√≥ba prze≈ÇƒÖczenia filtra komentarzy‚Ä¶");
40628 | 151 |   console.log("[FB][ui:post][filter] scope=", scopeSel);
40629 | 152 | 
40630 | 153 |   // 0) Je≈õli menu ju≈º otwarte -> wybierz "Wszystkie komentarze" / "Poka≈º wszystkie"
40631 | 154 |   const menuAlreadyOpen = await page.evaluate(() => !!document.querySelector("div[role='menu']"));
40632 | 155 |   if (menuAlreadyOpen) {
40633 | 156 |     console.log("[FB][ui:post][filter] Menu ju≈º otwarte ‚Äì wybieram opcjƒô.");
40634 | 157 |     const r = await clickAllCommentsInMenu(page);
40635 | 158 |     if (r?.clicked)
40636 | 159 |       console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
40637 | 160 |     return !!r?.clicked;
40638 | 161 |   }
40639 | 162 | 
40640 | 163 |   // 1) Kliknij przycisk filtra (Najtrafniejsze/Most relevant) ‚Äì BEZ wymogu, ≈ºe jest w viewport
40641 | 164 |   const pre = await page.evaluate(
40642 | 165 |     (scopeSel, code) => {
40643 | 166 |       const norm = (s) =>
40644 | 167 |         String(s || "")
40645 | 168 |           .replace(/\u00a0/g, " ")
40646 | 169 |           .replace(/\s+/g, " ")
40647 | 170 |           .trim()
40648 | 171 |           .toLowerCase();
40649 | 172 | 
40650 | 173 |       // eslint-disable-next-line no-eval
40651 | 174 |       eval(code);
40652 | 175 |       // @ts-ignore
40653 | 176 |       const root = typeof getPostRoot === "function" ? getPostRoot() : null;
40654 | 177 | 
40655 | 178 |       function getLabel(el) {
40656 | 179 |         if (!el) return "";
40657 | 180 |         const aria = el.getAttribute?.("aria-label");
40658 | 181 |         if (aria) return aria;
40659 | 182 |         return el.textContent || "";
40660 | 183 |       }
40661 | 184 | 
40662 | 185 |       function isVisibleEnough(el) {
40663 | 186 |         try {
40664 | 187 |           if (!el) return false;
40665 | 188 |           const st = window.getComputedStyle(el);
40666 | 189 |           if (!st) return true;
40667 | 190 |           if (st.display === "none" || st.visibility === "hidden") return false;
40668 | 191 |           const r = el.getBoundingClientRect();
40669 | 192 |           if (!r || r.width < 8 || r.height < 8) return false;
40670 | 193 |           return true;
40671 | 194 |         } catch {
40672 | 195 |           return true;
40673 | 196 |         }
40674 | 197 |       }
40675 | 198 | 
40676 | 199 |       function findClickableAncestor(start) {
40677 | 200 |         let el = start;
40678 | 201 |         for (let i = 0; i < 10 && el; i++) {
40679 | 202 |           const role = el.getAttribute?.("role");
40680 | 203 |           const tag = (el.tagName || "").toLowerCase();
40681 | 204 |           if (
40682 | 205 |             tag === "button" ||
40683 | 206 |             role === "button" ||
40684 | 207 |             role === "menuitem" ||
40685 | 208 |             role === "menuitemradio" ||
40686 | 209 |             role === "link"
40687 | 210 |           ) {
40688 | 211 |             return el;
40689 | 212 |           }
40690 | 213 |           el = el.parentElement;
40691 | 214 |         }
40692 | 215 |         return null;
40693 | 216 |       }
40694 | 217 | 
40695 | 218 |       // 1A) je≈õli ju≈º jest "All comments" / "Poka≈º wszystkie"
40696 | 219 |       const btnsAll = Array.from(
40697 | 220 |         document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
40698 | 221 |       );
40699 | 222 |       for (const el of btnsAll) {
40700 | 223 |         const t = norm(getLabel(el));
40701 | 224 |         if (
40702 | 225 |           t === "wszystkie komentarze" ||
40703 | 226 |           t === "all comments" ||
40704 | 227 |           t === "poka≈º wszystkie" ||
40705 | 228 |           t === "pokaz wszystkie" ||
40706 | 229 |           t === "show all"
40707 | 230 |         ) {
40708 | 231 |           return { ok: true, state: "already-all", where: "document" };
40709 | 232 |         }
40710 | 233 |       }
40711 | 234 | 
40712 | 235 |       const scopeEl = scopeSel === "document" ? document : document.querySelector(scopeSel);
40713 | 236 |       const scopes = [scopeEl, root, document].filter(Boolean);
40714 | 237 | 
40715 | 238 |       // 1B) g≈Ç√≥wna ≈õcie≈ºka: szukamy "Najtrafniejsze/Most relevant" w klikalnych elementach,
40716 | 239 |       //     ale NIE wymagamy, ≈ºeby by≈Ç w viewport ‚Äì scrollIntoView go dociƒÖgnie.
40717 | 240 |       for (const sc of scopes) {
40718 | 241 |         const clickables = Array.from(
40719 | 242 |           sc.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
40720 | 243 |         );
40721 | 244 | 
40722 | 245 |         const candidates = [];
40723 | 246 |         for (const el of clickables) {
40724 | 247 |           const t = norm(getLabel(el));
40725 | 248 |           if (!(t.startsWith("najtrafniejsze") || t.startsWith("most relevant"))) continue;
40726 | 249 |           if (!isVisibleEnough(el)) continue;
40727 | 250 | 
40728 | 251 |           let dist = 999999;
40729 | 252 |           try {
40730 | 253 |             const r = el.getBoundingClientRect();
40731 | 254 |             // preferuj elementy bli≈ºej ≈õrodka ekranu (mniejszy ‚Äúdoskok‚Äù)
40732 | 255 |             dist = Math.abs(r.top - window.innerHeight / 2);
40733 | 256 |           } catch {}
40734 | 257 | 
40735 | 258 |           candidates.push({ el, dist });
40736 | 259 |         }
40737 | 260 | 
40738 | 261 |         if (candidates.length) {
40739 | 262 |           candidates.sort((a, b) => a.dist - b.dist);
40740 | 263 |           const picked = candidates[0].el;
40741 | 264 | 
40742 | 265 |           try {
40743 | 266 |             picked.scrollIntoView?.({ block: "center", inline: "nearest" });
40744 | 267 |           } catch {}
40745 | 268 | 
40746 | 269 |           try {
40747 | 270 |             picked.click();
40748 | 271 |             return { ok: true, state: "clicked-filter", where: sc === document ? "document" : "scope" };
40749 | 272 |           } catch {
40750 | 273 |             // nic
40751 | 274 |           }
40752 | 275 |         }
40753 | 276 |       }
40754 | 277 | 
40755 | 278 |       // 1C) fallback: znajd≈∫ sam TEKST "Najtrafniejsze/Most relevant" gdziekolwiek (span/div),
40756 | 279 |       //     potem kliknij najbli≈ºszego klikalnego parenta.
40757 | 280 |       for (const sc of scopes) {
40758 | 281 |         const nodes = Array.from(sc.querySelectorAll("span,div,a,button"))
40759 | 282 |           .filter(isVisibleEnough)
40760 | 283 |           .slice(0, 20000);
40761 | 284 | 
40762 | 285 |         for (const n of nodes) {
40763 | 286 |           const t = norm(n.textContent);
40764 | 287 |           if (!(t === "najtrafniejsze" || t === "most relevant" || t.startsWith("najtrafniejsze"))) continue;
40765 | 288 | 
40766 | 289 |           const clickable = findClickableAncestor(n) || (n.tagName?.toLowerCase() === "button" ? n : null);
40767 | 290 |           if (!clickable) continue;
40768 | 291 | 
40769 | 292 |           try {
40770 | 293 |             clickable.scrollIntoView?.({ block: "center", inline: "nearest" });
40771 | 294 |           } catch {}
40772 | 295 | 
40773 | 296 |           try {
40774 | 297 |             clickable.click();
40775 | 298 |             return { ok: true, state: "clicked-filter-fallback", where: sc === document ? "document" : "scope" };
40776 | 299 |           } catch {
40777 | 300 |             // nic
40778 | 301 |           }
40779 | 302 |         }
40780 | 303 |       }
40781 | 304 | 
40782 | 305 |       return { ok: false, state: "not-found" };
40783 | 306 |     },
40784 | 307 |     scopeSel,
40785 | 308 |     postRootScript()
40786 | 309 |   );
40787 | 310 | 
40788 | 311 |   if (!pre?.ok) {
40789 | 312 |     console.log("[FB][ui:post][filter] Nie znaleziono przycisku filtra komentarzy.");
40790 | 313 |     return false;
40791 | 314 |   }
40792 | 315 | 
40793 | 316 |   if (pre.state === "already-all") {
40794 | 317 |     console.log("[FB][ui:post][filter] Filtr ju≈º ustawiony na 'Wszystkie komentarze' / 'Poka≈º wszystkie' ‚Äì pomijam.");
40795 | 318 |     return true;
40796 | 319 |   }
40797 | 320 | 
40798 | 321 |   console.log("[FB][ui:post][filter] Klikniƒôto filtr:", pre);
40799 | 322 | 
40800 | 323 |   // WA≈ªNE: po klikniƒôciu filtra daj chwilƒô na render menu
40801 | 324 |   await sleepRandom(350, 650);
40802 | 325 | 
40803 | 326 |   // 2) Menu -> "Wszystkie komentarze" / "Poka≈º wszystkie"
40804 | 327 |   const menuResult = await clickAllCommentsInMenu(page);
40805 | 328 | 
40806 | 329 |   if (menuResult?.clicked) {
40807 | 330 |     console.log("[FB][ui:post][filter] Filtr komentarzy ustawiony na: 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
40808 | 331 |     return true;
40809 | 332 |   }
40810 | 333 | 
40811 | 334 |   // 3) Fallback: czasem FB prze≈ÇƒÖcza bez menu ‚Äî sprawd≈∫ label
40812 | 335 |   const afterLabelIsAll = await page.evaluate(() => {
40813 | 336 |     const norm = (s) =>
40814 | 337 |       String(s || "")
40815 | 338 |         .replace(/\u00a0/g, " ")
40816 | 339 |         .replace(/\s+/g, " ")
40817 | 340 |         .trim()
40818 | 341 |         .toLowerCase();
40819 | 342 | 
40820 | 343 |     const els = Array.from(
40821 | 344 |       document.querySelectorAll("button,div[role='button'],span[role='button'],a[role='button']")
40822 | 345 |     );
40823 | 346 | 
40824 | 347 |     function getLabel(el) {
40825 | 348 |       const aria = el.getAttribute?.("aria-label");
40826 | 349 |       if (aria) return aria;
40827 | 350 |       return el.textContent || "";
40828 | 351 |     }
40829 | 352 | 
40830 | 353 |     return els.some((el) => {
40831 | 354 |       const t = norm(getLabel(el));
40832 | 355 |       return (
40833 | 356 |         t === "wszystkie komentarze" ||
40834 | 357 |         t === "all comments" ||
40835 | 358 |         t === "poka≈º wszystkie" ||
40836 | 359 |         t === "pokaz wszystkie" ||
40837 | 360 |         t === "show all"
40838 | 361 |       );
40839 | 362 |     });
40840 | 363 |   });
40841 | 364 | 
40842 | 365 |   if (afterLabelIsAll) {
40843 | 366 |     console.log("[FB][ui:post][filter] Prze≈ÇƒÖczy≈Ço siƒô bez menu na 'Wszystkie komentarze' / 'Poka≈º wszystkie'.");
40844 | 367 |     return true;
40845 | 368 |   }
40846 | 369 | 
40847 | 370 |   console.log(
40848 | 371 |     "[FB][ui:post][filter] Nie uda≈Ço siƒô ustawiƒá filtra na 'Wszystkie komentarze' / 'Poka≈º wszystkie'. menuResult=",
40849 | 372 |     menuResult
40850 | 373 |   );
40851 | 374 |   return false;
40852 | 375 | }
40853 | 376 | 
40854 | 377 | 
40855 | 378 | /* ============================================================
40856 | 379 |    =================== LICZENIE Z UI (POST) ====================
40857 | 380 |    ============================================================ */
40858 | 381 | 
40859 | 382 | /**
40860 | 383 |  * Kluczowa poprawka:
40861 | 384 |  * - NIE licz po samym scopeSel (bo dialog mo≈ºe zawieraƒá inny overlay / powiadomienia).
40862 | 385 |  * - Licz wewnƒÖtrz getPostRoot() (czyli ‚Äúprawdziwy post‚Äù).
40863 | 386 |  */
40864 | 387 | async function getCommentCountFromUiPostRoot(page) {
40865 | 388 |   const res = await page.evaluate((code) => {
40866 | 389 |     // eslint-disable-next-line no-eval
40867 | 390 |     eval(code);
40868 | 391 | 
40869 | 392 |     const norm = (s) =>
40870 | 393 |       String(s || "")
40871 | 394 |         .replace(/\u00a0/g, " ")
40872 | 395 |         .replace(/\s+/g, " ")
40873 | 396 |         .trim();
40874 | 397 | 
40875 | 398 |     const lower = (s) => norm(s).toLowerCase();
40876 | 399 | 
40877 | 400 |     function parsePlEnCount(text) {
40878 | 401 |       const t = lower(text);
40879 | 402 |       if (!t) return null;
40880 | 403 | 
40881 | 404 |       if (!(t.includes("komentarz") || t.includes("comment"))) return null;
40882 | 405 | 
40883 | 406 |       let x = t
40884 | 407 |         .replace(/komentarz(?:e|y|√≥w)?/g, "")
40885 | 408 |         .replace(/comments?/g, "")
40886 | 409 |         .replace(/[():]/g, " ")
40887 | 410 |         .replace(/\s+/g, " ")
40888 | 411 |         .trim();
40889 | 412 | 
40890 | 413 |       let mult = 1;
40891 | 414 |       if (/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/.test(x)) {
40892 | 415 |         mult = 1000;
40893 | 416 |         x = x.replace(/\btys\b|\bty≈õ\b|\btysi[ƒÖa]c\b/g, "").trim();
40894 | 417 |       }
40895 | 418 |       if (/\bmln\b|\bmillion\b/.test(x)) {
40896 | 419 |         mult = 1000000;
40897 | 420 |         x = x.replace(/\bmln\b|\bmillion\b/g, "").trim();
40898 | 421 |       }
40899 | 422 | 
40900 | 423 |       x = x.replace(/\s+/g, "");
40901 | 424 |       if (x.includes(",") && !x.includes(".")) x = x.replace(/,/g, ".");
40902 | 425 |       x = x.replace(/[^0-9.]/g, "");
40903 | 426 |       if (!x) return null;
40904 | 427 | 
40905 | 428 |       const n = Number(x);
40906 | 429 |       if (!Number.isFinite(n)) return null;
40907 | 430 | 
40908 | 431 |       return Math.round(n * mult);
40909 | 432 |     }
40910 | 433 | 
40911 | 434 |     // @ts-ignore
40912 | 435 |     const root = typeof getPostRoot === "function" ? getPostRoot() : null;
40913 | 436 |     const scope = root || document;
40914 | 437 | 
40915 | 438 |     // anty-≈õmieci: wytnij kawa≈Çki typowe dla powiadomie≈Ñ / headera
40916 | 439 |     const badBlock = (txt) => {
40917 | 440 |       const t = lower(txt);
40918 | 441 |       if (!t) return false;
40919 | 442 |       if (t.includes("powiadomienia") && (t.includes("nieprzeczytane") || t.includes("wszystkie"))) return true;
40920 | 443 |       if (t === "wszystkie" || t === "nieprzeczytane") return true;
40921 | 444 |       return false;
40922 | 445 |     };
40923 | 446 | 
40924 | 447 |     // 1) Najpewniejsze: span z tekstem "72 komentarze"
40925 | 448 |     const spans = Array.from(scope.querySelectorAll("span"));
40926 | 449 |     let best = null;
40927 | 450 | 
40928 | 451 |     for (const el of spans) {
40929 | 452 |       const raw = norm(el.textContent);
40930 | 453 |       if (!raw) continue;
40931 | 454 |       if (badBlock(raw)) continue;
40932 | 455 | 
40933 | 456 |       const val = parsePlEnCount(raw);
40934 | 457 |       if (val == null) continue;
40935 | 458 | 
40936 | 459 |       let score = 0;
40937 | 460 |       score += Math.max(0, 40 - raw.length);
40938 | 461 | 
40939 | 462 |       try {
40940 | 463 |         const r = el.getBoundingClientRect();
40941 | 464 |         if (r.width > 10 && r.height > 10) score += 10;
40942 | 465 |         if (r.top >= -50 && r.top <= window.innerHeight + 50) score += 10;
40943 | 466 |       } catch {}
40944 | 467 | 
40945 | 468 |       if (!best || score > best.score) best = { raw, val, score };
40946 | 469 |     }
40947 | 470 | 
40948 | 471 |     if (best) return { ok: true, source: "post-root-span", raw: best.raw, comments: best.val };
40949 | 472 | 
40950 | 473 |     // 2) Fallback: czasem licznik siedzi w klikalnym elemencie
40951 | 474 |     const nodes = Array.from(
40952 | 475 |       scope.querySelectorAll("div[role='button'], span[role='button'], button, a[role='link'], a")
40953 | 476 |     );
40954 | 477 | 
40955 | 478 |     for (const el of nodes) {
40956 | 479 |       const raw = norm(el.textContent);
40957 | 480 |       if (!raw) continue;
40958 | 481 |       if (badBlock(raw)) continue;
40959 | 482 | 
40960 | 483 |       const val = parsePlEnCount(raw);
40961 | 484 |       if (val != null) return { ok: true, source: "post-root-clickable", raw, comments: val };
40962 | 485 |     }
40963 | 486 | 
40964 | 487 |     // 3) Ostatecznie: regex po tek≈õcie root
40965 | 488 |     const blob = norm(scope.innerText || "");
40966 | 489 |     const m = blob.match(/(\d[\d\s.,]*)\s*(komentarz(?:e|y|√≥w)?|comments?)/i);
40967 | 490 |     if (m) {
40968 | 491 |       const raw = norm(`${m[1]} ${m[2]}`);
40969 | 492 |       const val = parsePlEnCount(raw);
40970 | 493 |       if (val != null) return { ok: true, source: "post-root-regex", raw, comments: val };
40971 | 494 |     }
40972 | 495 | 
40973 | 496 |     return { ok: false, reason: "not-found" };
40974 | 497 |   }, postRootScript());
40975 | 498 | 
40976 | 499 |   return res?.ok ? res : null;
40977 | 500 | }
40978 | 501 | 
40979 | 502 | /* ============================================================
40980 | 503 |    =================== LICZENIE ANCHOR√ìW =======================
40981 | 504 |    ============================================================ */
40982 | 505 | 
40983 | 506 | async function getCurrentCommentAnchorCount(page) {
40984 | 507 |   const count = await page.evaluate(() => {
40985 | 508 |     const anchors = Array.from(document.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']"));
40986 | 509 |     const ids = new Set();
40987 | 510 | 
40988 | 511 |     for (const a of anchors) {
40989 | 512 |       try {
40990 | 513 |         const url = new URL(a.href);
40991 | 514 |         const cid = url.searchParams.get("comment_id");
40992 | 515 |         const rid = url.searchParams.get("reply_comment_id");
40993 | 516 |         let raw = rid || cid;
40994 | 517 |         if (!raw) continue;
40995 | 518 | 
40996 | 519 |         if (!/^\d+$/.test(raw)) {
40997 | 520 |           try {
40998 | 521 |             const dec = atob(raw);
40999 | 522 |             const m = dec.match(/:(\d+)_([0-9]+)/);
41000 | 523 |             if (m) raw = m[2];
41001 | 524 |           } catch {}
41002 | 525 |         }
41003 | 526 | 
41004 | 527 |         if (raw) ids.add(raw);
41005 | 528 |       } catch {}
41006 | 529 |     }
41007 | 530 | 
41008 | 531 |     return ids.size;
41009 | 532 |   });
41010 | 533 | 
41011 | 534 |   return count || 0;
41012 | 535 | }
41013 | 536 | 
41014 | 537 | /* ============================================================
41015 | 538 |    =================== SCROLL TYLKO W PO≈öCIE ===================
41016 | 539 |    ============================================================ */
41017 | 540 | 
41018 | 541 | async function scrollWithinPost(page, label, factor = 0.25) {
41019 | 542 |   const info = await page.evaluate(
41020 | 543 |     (factorArg, labelArg, code) => {
41021 | 544 |       // eslint-disable-next-line no-eval
41022 | 545 |       eval(code);
41023 | 546 |       // @ts-ignore
41024 | 547 |       const root = typeof getPostRoot === "function" ? getPostRoot() : document.body;
41025 | 548 | 
41026 | 549 |       const norm = (s) =>
41027 | 550 |         String(s || "")
41028 | 551 |           .replace(/\u00a0/g, " ")
41029 | 552 |           .replace(/\s+/g, " ")
41030 | 553 |           .trim()
41031 | 554 |           .toLowerCase();
41032 | 555 | 
41033 | 556 |       function canScrollByTest(el) {
41034 | 557 |         try {
41035 | 558 |           if (!el) return false;
41036 | 559 |           const ch = el.clientHeight || 0;
41037 | 560 |           const sh = el.scrollHeight || 0;
41038 | 561 |           if (ch <= 0) return false;
41039 | 562 |           if (sh <= ch + 30) return false;
41040 | 563 | 
41041 | 564 |           const before = el.scrollTop ?? 0;
41042 | 565 |           el.scrollTop = before + 80;
41043 | 566 |           const after = el.scrollTop ?? before;
41044 | 567 |           el.scrollTop = before;
41045 | 568 |           return after !== before;
41046 | 569 |         } catch {
41047 | 570 |           return false;
41048 | 571 |         }
41049 | 572 |       }
41050 | 573 | 
41051 | 574 |       function isVisible(el) {
41052 | 575 |         if (!el) return false;
41053 | 576 |         const st = window.getComputedStyle(el);
41054 | 577 |         if (!st) return true;
41055 | 578 |         if (st.display === "none" || st.visibility === "hidden") return false;
41056 | 579 |         const r = el.getBoundingClientRect();
41057 | 580 |         if (!r || r.width < 5 || r.height < 5) return false;
41058 | 581 |         return true;
41059 | 582 |       }
41060 | 583 | 
41061 | 584 |       function pickContainerSmart() {
41062 | 585 |         // 0) cache z poprzednich rund (tylko je≈õli nadal dzia≈Ça)
41063 | 586 |         const cached = window.__FBW_POST_COMMENTS_CONTAINER;
41064 | 587 |         if (cached && document.contains(cached) && canScrollByTest(cached)) return { el: cached, label: "cached" };
41065 | 588 | 
41066 | 589 |         const scope = root?.closest?.("div[role='dialog']") || root || document.body;
41067 | 590 |         const scopes = [scope, root, document.querySelector("div[role='main'], main"), document.body].filter(Boolean);
41068 | 591 | 
41069 | 592 |         // 1) preferuj kontenery blisko rejonu komentarzy (textbox / ‚ÄûNapisz komentarz‚Äù)
41070 | 593 |         let anchor = null;
41071 | 594 |         const needles = ["napisz komentarz", "write a comment", "komentarze", "comments"];
41072 | 595 |         const candAnchor = Array.from(document.querySelectorAll("div[role='textbox'], textarea, span, div"))
41073 | 596 |           .filter(isVisible)
41074 | 597 |           .find((el) => needles.some((n) => norm(el.getAttribute?.("aria-label") || el.textContent).includes(n)));
41075 | 598 | 
41076 | 599 |         if (candAnchor) anchor = candAnchor;
41077 | 600 | 
41078 | 601 |         function score(el) {
41079 | 602 |           const ch = el.clientHeight || 0;
41080 | 603 |           const sh = el.scrollHeight || 0;
41081 | 604 |           const delta = sh - ch;
41082 | 605 | 
41083 | 606 |           // premia je≈õli w ≈õrodku widaƒá s≈Çowa komentarzy
41084 | 607 |           const t = norm(el.innerText || "");
41085 | 608 |           const hasCommentWords = t.includes("komentarz") || t.includes("comment") || t.includes("napisz komentarz");
41086 | 609 |           let s = delta + (hasCommentWords ? 12000 : 0);
41087 | 610 | 
41088 | 611 |           // premia je≈õli blisko anchora
41089 | 612 |           if (anchor) {
41090 | 613 |             const ar = anchor.getBoundingClientRect();
41091 | 614 |             const er = el.getBoundingClientRect();
41092 | 615 |             const dist = Math.abs(er.top - ar.top);
41093 | 616 |             s += Math.max(0, 4000 - dist);
41094 | 617 |           }
41095 | 618 | 
41096 | 619 |           return s;
41097 | 620 |         }
41098 | 621 | 
41099 | 622 |         let best = null;
41100 | 623 |         let bestScore = -1;
41101 | 624 | 
41102 | 625 |         for (const sc of scopes) {
41103 | 626 |           const divs = Array.from(sc.querySelectorAll("div, section, main, article"))
41104 | 627 |             .filter(isVisible)
41105 | 628 |             .slice(0, 18000);
41106 | 629 | 
41107 | 630 |           for (const el of divs) {
41108 | 631 |             if (!canScrollByTest(el)) continue;
41109 | 632 |             const s = score(el);
41110 | 633 |             if (s > bestScore) {
41111 | 634 |               bestScore = s;
41112 | 635 |               best = el;
41113 | 636 |             }
41114 | 637 |           }
41115 | 638 |           if (best) break;
41116 | 639 |         }
41117 | 640 | 
41118 | 641 |         if (best) {
41119 | 642 |           window.__FBW_POST_COMMENTS_CONTAINER = best;
41120 | 643 |           return { el: best, label: "smart" };
41121 | 644 |         }
41122 | 645 | 
41123 | 646 |         // 2) ostateczny fallback: window scroll (czasem w post view dzia≈Ça)
41124 | 647 |         return {
41125 | 648 |           el: document.scrollingElement || document.documentElement || document.body,
41126 | 649 |           label: "window",
41127 | 650 |         };
41128 | 651 |       }
41129 | 652 | 
41130 | 653 |       const picked = pickContainerSmart();
41131 | 654 |       const container = picked.el;
41132 | 655 |       const containerType = picked.label;
41133 | 656 | 
41134 | 657 |       const isWindowContainer =
41135 | 658 |         container === document.body || container === document.documentElement || container === document.scrollingElement;
41136 | 659 | 
41137 | 660 |       const before = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
41138 | 661 |       const maxScroll = (container.scrollHeight || 0) - (container.clientHeight || 0);
41139 | 662 | 
41140 | 663 |       if (maxScroll <= 0) {
41141 | 664 |         return { before, after: before, container: `${containerType}-no-scroll`, label: labelArg };
41142 | 665 |       }
41143 | 666 | 
41144 | 667 |       const f = factorArg || 0.25;
41145 | 668 |       const sign = f < 0 ? -1 : 1;
41146 | 669 |       const magnitude = Math.min(Math.abs(f), 1);
41147 | 670 | 
41148 | 671 |       // wiƒôkszy krok ni≈º wcze≈õniej, bo FB ≈Çaduje porcjami i ma throttling
41149 | 672 |       const baseStep = (container.clientHeight || window.innerHeight || 600) * magnitude;
41150 | 673 |       const step = Math.max(120, Math.min(baseStep, 520));
41151 | 674 | 
41152 | 675 |       const target = sign < 0 ? Math.max(0, before - step) : Math.min(maxScroll, before + step);
41153 | 676 | 
41154 | 677 |       if (isWindowContainer) window.scrollTo(0, target);
41155 | 678 |       else container.scrollTop = target;
41156 | 679 | 
41157 | 680 |       const after = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
41158 | 681 | 
41159 | 682 |       // je≈õli nie drgnƒô≈Ço, spr√≥buj fallback: window scrollBy (FB czasem blokuje scrollTop)
41160 | 683 |       if (after === before) {
41161 | 684 |         try {
41162 | 685 |           window.scrollBy(0, sign * step);
41163 | 686 |         } catch {}
41164 | 687 |       }
41165 | 688 | 
41166 | 689 |       const after2 = isWindowContainer ? window.scrollY || 0 : container.scrollTop || 0;
41167 | 690 | 
41168 | 691 |       return { before, after: after2, container: containerType, label: labelArg };
41169 | 692 |     },
41170 | 693 |     factor,
41171 | 694 |     label,
41172 | 695 |     postRootScript()
41173 | 696 |   );
41174 | 697 | 
41175 | 698 |   return info;
41176 | 699 | }
41177 | 700 | 
41178 | 701 | /* ============================================================
41179 | 702 |    =================== EXPAND (LEGACY) =========================
41180 | 703 |    ============================================================ */
41181 | 704 | 
41182 | 705 | async function expandAllComments(page) {
41183 | 706 |   if (!EXPAND_COMMENTS) return 0;
41184 | 707 | 
41185 | 708 |   let clicks = 0;
41186 | 709 |   for (let i = 0; i < 30; i++) {
41187 | 710 |     const didClick = await clickOneExpandButton(page);
41188 | 711 |     if (!didClick) break;
41189 | 712 |     clicks++;
41190 | 713 |     await sleepRandom(900, 1600);
41191 | 714 |   }
41192 | 715 |   return clicks;
41193 | 716 | }
41194 | 717 | 
41195 | 718 | /* ============================================================
41196 | 719 |    =================== HANDLER API =============================
41197 | 720 |    ============================================================ */
41198 | 721 | 
41199 | 722 | export async function prepare(page, url) {
41200 | 723 |   console.log(`[FB][ui:post] prepare: ${url}`);
41201 | 724 | 
41202 | 725 |   const ok = await safeGoto(page, url, "post", {
41203 | 726 |     waitUntil: "networkidle2",
41204 | 727 |     timeout: NAV_TIMEOUT_MS,
41205 | 728 |   });
41206 | 729 | 
41207 | 730 |   if (!ok) throw new Error("safeGoto-failed");
41208 | 731 | 
41209 | 732 |   const currentUrl = page.url();
41210 | 733 |   if (currentUrl.includes("/login")) {
41211 | 734 |     console.log("[FB][ui:post] /login redirect ‚Üí fbLogin() and back");
41212 | 735 |     await fbLogin(page);
41213 | 736 |     await sleepRandom(3000, 4500);
41214 | 737 | 
41215 | 738 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
41216 | 739 |     console.log("[FB][ui:post] session after fbLogin:", loggedAfterLogin ? "OK" : "NO");
41217 | 740 | 
41218 | 741 |     if (loggedAfterLogin) {
41219 | 742 |       await safeGoto(page, url, "post", {
41220 | 743 |         waitUntil: "networkidle2",
41221 | 744 |         timeout: NAV_TIMEOUT_MS,
41222 | 745 |       });
41223 | 746 |     }
41224 | 747 |   }
41225 | 748 | 
41226 | 749 |   await acceptCookies(page, "post-initial");
41227 | 750 | 
41228 | 751 |   await ensureLoggedInOnPostOverlay(page).catch(() => {});
41229 | 752 |   await sleepRandom(1200, 1800);
41230 | 753 |   await acceptCookies(page, "post");
41231 | 754 | 
41232 | 755 |   try {
41233 | 756 |     const logged = await checkIfLogged(page).catch(() => false);
41234 | 757 |     if (logged) await saveCookies(page);
41235 | 758 |   } catch {}
41236 | 759 | 
41237 | 760 |   // tu zostawiamy (minimalna ingerencja), ale getCommentCount i tak czeka na uspokojenie scrolla
41238 | 761 |   await scrollPost(page, 120).catch(() => {});
41239 | 762 |   await sleepRandom(600, 900);
41240 | 763 | }
41241 | 764 | 
41242 | 765 | async function waitForScrollStop(page, { timeoutMs = 2000, stableMs = 250 } = {}) {
41243 | 766 |   try {
41244 | 767 |     await page.waitForFunction(
41245 | 768 |       ({ stableMs }) => {
41246 | 769 |         const now = performance.now();
41247 | 770 |         const y = window.scrollY || 0;
41248 | 771 | 
41249 | 772 |         if (!window.__fbScrollStop) {
41250 | 773 |           window.__fbScrollStop = { lastY: y, lastChange: now };
41251 | 774 |           return false;
41252 | 775 |         }
41253 | 776 | 
41254 | 777 |         const st = window.__fbScrollStop;
41255 | 778 | 
41256 | 779 |         if (Math.abs(y - st.lastY) > 0) {
41257 | 780 |           st.lastY = y;
41258 | 781 |           st.lastChange = now;
41259 | 782 |           return false;
41260 | 783 |         }
41261 | 784 | 
41262 | 785 |         return now - st.lastChange >= stableMs;
41263 | 786 |       },
41264 | 787 |       { timeout: timeoutMs },
41265 | 788 |       { stableMs }
41266 | 789 |     );
41267 | 790 |     return true;
41268 | 791 |   } catch {
41269 | 792 |     return false;
41270 | 793 |   }
41271 | 794 | }
41272 | 795 | 
41273 | 796 | export async function getCommentCount(page, url) {
41274 | 797 |   console.log("[FB][ui:post] getCommentCount‚Ä¶");
41275 | 798 | 
41276 | 799 |   // FB czƒôsto robi auto-scroll / reflow tu≈º po wej≈õciu ‚Äì nie klikamy filtra w trakcie ruchu
41277 | 800 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
41278 | 801 | 
41279 | 802 |   const scopeSel = await getPostScopeSelector(page);
41280 | 803 | 
41281 | 804 |   const okFilter = await switchCommentsFilterToAllScoped(page, scopeSel).catch(() => false);
41282 | 805 |   console.log("[FB][ui:post] filter all comments:", okFilter);
41283 | 806 | 
41284 | 807 |   // po filtrze DOM lubi siƒô przebudowaƒá; nie scrollujemy ‚Äî tylko chwila stabilizacji
41285 | 808 |   if (okFilter) {
41286 | 809 |     await sleepRandom(250, 450);
41287 | 810 |     await waitForScrollStop(page, { timeoutMs: 1200, stableMs: 220 });
41288 | 811 |   }
41289 | 812 | 
41290 | 813 |   // KLUCZ: licz UI po root posta, nie po scope dialogu
41291 | 814 |   const ui = await getCommentCountFromUiPostRoot(page).catch(() => null);
41292 | 815 | 
41293 | 816 |   console.log("[FB][ui:post] UI comments:", {
41294 | 817 |     source: ui?.source || "none",
41295 | 818 |     raw: ui?.raw || null,
41296 | 819 |     comments: ui?.comments ?? null,
41297 | 820 |   });
41298 | 821 | 
41299 | 822 |   if (ui && typeof ui.comments === "number" && ui.comments > 0) {
41300 | 823 |     return ui.comments;
41301 | 824 |   }
41302 | 825 | 
41303 | 826 |   const anchors = await getCurrentCommentAnchorCount(page);
41304 | 827 |   console.log("[FB][ui:post] Fallback anchor count =", anchors);
41305 | 828 | 
41306 | 829 |   return anchors > 0 ? anchors : null;
41307 | 830 | }
41308 | 831 | 
41309 | 832 | export async function loadAllComments(page, { expectedTotal } = {}) {
41310 | 833 |   console.log(`[FB][ui:post] loadAllComments‚Ä¶ expectedTotal=${expectedTotal ?? "n/a"}`);
41311 | 834 | 
41312 | 835 |   await waitForScrollStop(page, { timeoutMs: 2400, stableMs: 320 });
41313 | 836 | 
41314 | 837 |   const MAX_ROUNDS = 600;
41315 | 838 |   const MAX_NO_PROGRESS = 60;
41316 | 839 | 
41317 | 840 |   let noProgress = 0;
41318 | 841 |   let lastAnchors = await getCurrentCommentAnchorCount(page);
41319 | 842 | 
41320 | 843 |   for (let round = 1; round <= MAX_ROUNDS; round++) {
41321 | 844 |     const before = lastAnchors;
41322 | 845 | 
41323 | 846 |     const scrollInfo = await scrollWithinPost(page, `round-${round}`, 0.25);
41324 | 847 |     const clicks = await expandAllComments(page);
41325 | 848 |     await sleepRandom(220, 420);
41326 | 849 | 
41327 | 850 |     const after = await getCurrentCommentAnchorCount(page);
41328 | 851 | 
41329 | 852 |     const progressed = scrollInfo.after !== scrollInfo.before || clicks > 0;
41330 | 853 | 
41331 | 854 |     if (progressed) noProgress = 0;
41332 | 855 |     else noProgress++;
41333 | 856 | 
41334 | 857 |     lastAnchors = after;
41335 | 858 | 
41336 | 859 |     if (round === 1 || round % 25 === 0) {
41337 | 860 |       console.log(
41338 | 861 |         `[FB][ui:post] round=${round} container=${scrollInfo.container} scrollTop: ${scrollInfo.before}‚Üí${scrollInfo.after} anchors: ${before}‚Üí${after} clicks=${clicks} noProgress=${noProgress}`
41339 | 862 |       );
41340 | 863 |     }
41341 | 864 | 
41342 | 865 |     if (typeof expectedTotal === "number" && expectedTotal > 0) {
41343 | 866 |       if (after >= expectedTotal && noProgress >= 2) {
41344 | 867 |         console.log("[FB][ui:post] stop reason=target-reached");
41345 | 868 |         break;
41346 | 869 |       }
41347 | 870 |     }
41348 | 871 | 
41349 | 872 |     if (noProgress >= MAX_NO_PROGRESS) {
41350 | 873 |       console.log("[FB][ui:post] stop reason=no-progress");
41351 | 874 |       break;
41352 | 875 |     }
41353 | 876 |   }
41354 | 877 | }
41355 | 878 | 
41356 | 879 | export async function extractComments(page, url) {
41357 | 880 |   const data = await page.evaluate(() => {
41358 | 881 |     function extractCommentId(u) {
41359 | 882 |       const m = u?.match(/comment_id=([^&]+)/);
41360 | 883 |       return m ? decodeURIComponent(m[1]) : null;
41361 | 884 |     }
41362 | 885 | 
41363 | 886 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
41364 | 887 |     const idToTimeMap = {};
41365 | 888 | 
41366 | 889 |     for (let i = 0; i < allLinks.length; i++) {
41367 | 890 |       const link = allLinks[i];
41368 | 891 |       const href = link.getAttribute("href") || "";
41369 | 892 |       const id = extractCommentId(href);
41370 | 893 |       if (!id) continue;
41371 | 894 | 
41372 | 895 |       for (let j = i + 1; j < Math.min(allLinks.length, i + 5); j++) {
41373 | 896 |         const timeText = allLinks[j]?.textContent?.trim()?.toLowerCase();
41374 | 897 |         if (timeText && /^\d+\s?(min|godz|sek|dni|tyg|h|d|m)\b/.test(timeText)) {
41375 | 898 |           idToTimeMap[id] = timeText;
41376 | 899 |           break;
41377 | 900 |         }
41378 | 901 |       }
41379 | 902 |     }
41380 | 903 | 
41381 | 904 |     const nodes = Array.from(document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k"));
41382 | 905 | 
41383 | 906 |     const extracted = nodes
41384 | 907 |       .map((node, idx) => {
41385 | 908 |         const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
41386 | 909 |         const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || null;
41387 | 910 | 
41388 | 911 |         const linkEl = node.querySelector('a[role="link"]');
41389 | 912 |         const href = linkEl?.getAttribute("href") || null;
41390 | 913 |         const permalink = href ? (href.startsWith("http") ? href : `https://www.facebook.com${href}`) : null;
41391 | 914 | 
41392 | 915 |         const id = permalink ? extractCommentId(permalink) : null;
41393 | 916 |         const time = id && idToTimeMap[id] ? idToTimeMap[id] : null;
41394 | 917 | 
41395 | 918 |         if (!author || !text) return null;
41396 | 919 | 
41397 | 920 |         return { id, author, text, time, permalink, pos: idx };
41398 | 921 |       })
41399 | 922 |       .filter(Boolean);
41400 | 923 | 
41401 | 924 |     return extracted;
41402 | 925 |   });
41403 | 926 | 
41404 | 927 |   console.log("[FB][ui:post] extractComments: count =", data?.length || 0);
41405 | 928 |   return Array.isArray(data) ? data : [];
41406 | 929 | }
41407 | 930 | 
41408 | 931 | export async function debugSnapshot(page) {
41409 | 932 |   const scopeSel = await getPostScopeSelector(page);
41410 | 933 |   const anchors = await getCurrentCommentAnchorCount(page).catch(() => 0);
41411 | 934 | 
41412 | 935 |   return {
41413 | 936 |     scopeSel,
41414 | 937 |     anchors,
41415 | 938 |     url: page.url(),
41416 | 939 |   };
41417 | 940 | }
41418 | 941 | 
41419 | ```
41420 | 
41421 | ---
41422 | 
41423 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/scroll.js`
41424 | **Typ:** JavaScript/tekst  
41425 | **Opis:** Plik projektu (kod/konfiguracja).  
41426 | 
41427 | ```js
41428 |  1 | /**
41429 |  2 |  * Scrollowanie posta:
41430 |  3 |  * - znajdujemy scrollowalny kontener pod ≈õrodkiem ekranu
41431 |  4 |  * - je≈õli siƒô nie uda ‚Üí dialog ‚Üí dokument
41432 |  5 |  */
41433 |  6 | async function scrollPost(page, amount = 450) {
41434 |  7 |   await page.evaluate((dy) => {
41435 |  8 |     function findScrollableAncestor(start) {
41436 |  9 |       let el = start;
41437 | 10 |       while (el) {
41438 | 11 |         const style = window.getComputedStyle(el);
41439 | 12 |         const canScrollY =
41440 | 13 |           style.overflowY === "auto" || style.overflowY === "scroll";
41441 | 14 |         if (canScrollY && el.scrollHeight - el.clientHeight > 50) {
41442 | 15 |           return el;
41443 | 16 |         }
41444 | 17 |         el = el.parentElement;
41445 | 18 |       }
41446 | 19 |       return null;
41447 | 20 |     }
41448 | 21 | 
41449 | 22 |     // element pod ≈õrodkiem ekranu (tam gdzie normalnie krƒôcisz k√≥≈Çkiem)
41450 | 23 |     const centerEl = document.elementFromPoint(
41451 | 24 |       window.innerWidth / 2,
41452 | 25 |       window.innerHeight / 2
41453 | 26 |     );
41454 | 27 | 
41455 | 28 |     let target = centerEl ? findScrollableAncestor(centerEl) : null;
41456 | 29 | 
41457 | 30 |     // fallback: dialog
41458 | 31 |     if (!target) {
41459 | 32 |       const dialog = document.querySelector("div[role='dialog']");
41460 | 33 |       if (dialog && dialog.scrollHeight - dialog.clientHeight > 50) {
41461 | 34 |         target = dialog;
41462 | 35 |       }
41463 | 36 |     }
41464 | 37 | 
41465 | 38 |     // ostateczny fallback: dokument
41466 | 39 |     if (!target) {
41467 | 40 |       target =
41468 | 41 |         document.scrollingElement || document.documentElement || document.body;
41469 | 42 |     }
41470 | 43 | 
41471 | 44 |     if (
41472 | 45 |       target === document.body ||
41473 | 46 |       target === document.documentElement ||
41474 | 47 |       target === document.scrollingElement
41475 | 48 |     ) {
41476 | 49 |       const before = window.scrollY;
41477 | 50 |       window.scrollTo(0, before + dy);
41478 | 51 |     } else {
41479 | 52 |       target.scrollTop += dy;
41480 | 53 |     }
41481 | 54 |   }, amount);
41482 | 55 | }
41483 | 56 | 
41484 | 57 | export { scrollPost };
41485 | 58 | 
41486 | ```
41487 | 
41488 | ---
41489 | 
41490 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/sleep.js`
41491 | **Typ:** JavaScript/tekst  
41492 | **Opis:** Plik projektu (kod/konfiguracja).  
41493 | 
41494 | ```js
41495 |  1 | function sleep(ms) {
41496 |  2 |   return new Promise((res) => setTimeout(res, ms));
41497 |  3 | }
41498 |  4 | 
41499 |  5 | function sleepRandom(minMs, maxMs) {
41500 |  6 |   const delta = maxMs - minMs;
41501 |  7 |   const extra = Math.random() * delta;
41502 |  8 |   return sleep(minMs + extra);
41503 |  9 | }
41504 | 10 | 
41505 | 11 | export { sleep, sleepRandom };
41506 | 12 | 
41507 | ```
41508 | 
41509 | ---
41510 | 
41511 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/uicommentinfo.js`
41512 | **Typ:** JavaScript/tekst  
41513 | **Opis:** Plik projektu (kod/konfiguracja).  
41514 | 
41515 | ```js
41516 |   1 | // src/fb/uiCommentInfo.js
41517 |   2 | // UI: wykrywanie typu widoku + wyciƒÖganie liczby komentarzy z meta-linii (reakcje | komentarze | udostƒôpnienia)
41518 |   3 | // FIX: photo view -> meta row + filtr sklejonych liczb typu "287368".
41519 |   4 | // VIDEO/WATCH: komentarze czƒôsto sƒÖ jako: [LICZBA] + [IKONKA], bez tekstu "Komentarz" -> bierzemy z button√≥w z ikonkƒÖ.
41520 |   5 | 
41521 |   6 | export async function getUiCommentInfo(page) {
41522 |   7 |   return page.evaluate(() => {
41523 |   8 |     function norm(str) {
41524 |   9 |       if (!str) return "";
41525 |  10 |       return String(str).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
41526 |  11 |     }
41527 |  12 | 
41528 |  13 |     function detectViewType() {
41529 |  14 |       const href = location.href || "";
41530 |  15 |       const isWatch = href.includes("/watch");
41531 |  16 |       const isVideo = isWatch || /\/videos\/|[?&]v=/i.test(href);
41532 |  17 |       const isPhoto = /[?&]fbid=|\/photo\.php|\/photo\?fbid=|\/photo\/\d/i.test(href);
41533 |  18 | 
41534 |  19 |       if (isWatch) return "watch";
41535 |  20 |       if (isVideo) return "video";
41536 |  21 |       if (isPhoto) return "photo";
41537 |  22 |       return "permalink";
41538 |  23 |     }
41539 |  24 | 
41540 |  25 |     function isVisibleRough(el) {
41541 |  26 |       if (!el) return false;
41542 |  27 |       const st = window.getComputedStyle(el);
41543 |  28 |       if (!st) return true;
41544 |  29 |       if (st.display === "none" || st.visibility === "hidden") return false;
41545 |  30 |       return true;
41546 |  31 |     }
41547 |  32 | 
41548 |  33 |     // pojedynczy token liczbowy (np. "286", "7,8 tys.") ‚Äì odrzuca wieloliczbowe i "x z y"
41549 |  34 |     function parseSingleCount(str) {
41550 |  35 |       const s = norm(str).toLowerCase();
41551 |  36 |       if (!s) return null;
41552 |  37 | 
41553 |  38 |       // odrzuƒá "x z y"
41554 |  39 |       if (/\b\d+\s*z\s*\d+\b/i.test(s)) return null;
41555 |  40 | 
41556 |  41 |       // je≈õli sƒÖ >=2 grupy cyfr -> odrzucamy (ubija "7,8", "286 368", "1 234")
41557 |  42 |       const groups = s.match(/\d+/g);
41558 |  43 |       if (groups && groups.length > 1) return null;
41559 |  44 | 
41560 |  45 |       const m = s.match(/^(\d[\d.,]*)\s*(k|tys|ty≈õ|mln|m)?$/i);
41561 |  46 |       if (!m) return null;
41562 |  47 | 
41563 |  48 |       const raw = m[1];
41564 |  49 |       const suf = (m[2] || "").toLowerCase();
41565 |  50 | 
41566 |  51 |       let value = parseInt(raw.replace(/[^\d]/g, ""), 10);
41567 |  52 |       if (!Number.isFinite(value)) return null;
41568 |  53 | 
41569 |  54 |       if (suf === "k" || suf === "tys" || suf === "ty≈õ") value *= 1000;
41570 |  55 |       else if (suf === "mln" || suf === "m") value *= 1000000;
41571 |  56 | 
41572 |  57 |       return Math.round(value);
41573 |  58 |     }
41574 |  59 | 
41575 |  60 |     function findActionBarRoot() {
41576 |  61 |       const candidates = Array.from(document.querySelectorAll("div, section, footer"))
41577 |  62 |         .filter(isVisibleRough)
41578 |  63 |         .slice(0, 12000);
41579 |  64 | 
41580 |  65 |       for (const el of candidates) {
41581 |  66 |         const t = norm(el.innerText).toLowerCase();
41582 |  67 |         if (!t) continue;
41583 |  68 | 
41584 |  69 |         const hasLike = t.includes("lubiƒô to") || t.includes("like");
41585 |  70 |         const hasComment = t.includes("komentarz") || t.includes("comment");
41586 |  71 |         const hasShare = t.includes("udostƒôpnij") || t.includes("share");
41587 |  72 | 
41588 |  73 |         if (hasLike && hasComment && hasShare) {
41589 |  74 |           if (t.length > 2200) continue;
41590 |  75 |           return el;
41591 |  76 |         }
41592 |  77 |       }
41593 |  78 |       return null;
41594 |  79 |     }
41595 |  80 | 
41596 |  81 |     // usuwa tokeny typu "287368", je≈õli w tym samym zbiorze istniejƒÖ "287" i "368"
41597 |  82 |     function dropConcatenations(list) {
41598 |  83 |       const strSet = new Set(list.map((x) => String(x.v)));
41599 |  84 | 
41600 |  85 |       function isConcatOfTwoExisting(vStr) {
41601 |  86 |         if (vStr.length < 5) return false;
41602 |  87 |         for (let i = 1; i < vStr.length; i++) {
41603 |  88 |           const left = vStr.slice(0, i);
41604 |  89 |           const right = vStr.slice(i);
41605 |  90 |           if (left.length < 2 || right.length < 2) continue;
41606 |  91 |           if (strSet.has(left) && strSet.has(right)) return true;
41607 |  92 |         }
41608 |  93 |         return false;
41609 |  94 |       }
41610 |  95 | 
41611 |  96 |       const out = [];
41612 |  97 |       for (const x of list) {
41613 |  98 |         const vStr = String(x.v);
41614 |  99 |         if (isConcatOfTwoExisting(vStr)) continue;
41615 | 100 |         out.push(x);
41616 | 101 |       }
41617 | 102 |       return out;
41618 | 103 |     }
41619 | 104 | 
41620 | 105 |     function extractFromMetaRow(actionRoot) {
41621 | 106 |       if (!actionRoot) return { comments: null, shares: null, raw: null };
41622 | 107 | 
41623 | 108 |       const badWords = [
41624 | 109 |         "odpowiedz",
41625 | 110 |         "wy≈õwietl",
41626 | 111 |         "zobacz",
41627 | 112 |         "najtrafniejsze",
41628 | 113 |         "najnowsze",
41629 | 114 |         "lider",
41630 | 115 |         "edytowano",
41631 | 116 |       ];
41632 | 117 | 
41633 | 118 |       const divs = Array.from(actionRoot.querySelectorAll("div"))
41634 | 119 |         .filter(isVisibleRough)
41635 | 120 |         .slice(0, 6000);
41636 | 121 | 
41637 | 122 |       const scored = [];
41638 | 123 | 
41639 | 124 |       for (const d of divs) {
41640 | 125 |         const text = norm(d.innerText);
41641 | 126 |         if (!text) continue;
41642 | 127 | 
41643 | 128 |         const low = text.toLowerCase();
41644 | 129 |         const hasReactions = low.includes("wszystkie reakcje") || low.includes("all reactions");
41645 | 130 |         if (!hasReactions) continue;
41646 | 131 | 
41647 | 132 |         if (low.length > 260) continue;
41648 | 133 |         if (badWords.some((w) => low.includes(w))) continue;
41649 | 134 | 
41650 | 135 |         const atoms = Array.from(d.querySelectorAll("span, a, div"))
41651 | 136 |           .filter(isVisibleRough)
41652 | 137 |           .map((el) => norm(el.textContent))
41653 | 138 |           .filter((s) => s && s.length <= 20);
41654 | 139 | 
41655 | 140 |         let nums = [];
41656 | 141 |         for (const s of atoms) {
41657 | 142 |           const v = parseSingleCount(s);
41658 | 143 |           if (v == null) continue;
41659 | 144 |           nums.push({ v, s });
41660 | 145 |         }
41661 | 146 | 
41662 | 147 |         const seen = new Set();
41663 | 148 |         let uniq = [];
41664 | 149 |         for (const n of nums) {
41665 | 150 |           const key = `${n.v}:${n.s}`;
41666 | 151 |           if (seen.has(key)) continue;
41667 | 152 |           seen.add(key);
41668 | 153 |           uniq.push(n);
41669 | 154 |         }
41670 | 155 | 
41671 | 156 |         uniq = dropConcatenations(uniq);
41672 | 157 | 
41673 | 158 |         if (uniq.length < 2) continue;
41674 | 159 | 
41675 | 160 |         let score = 0;
41676 | 161 |         score += uniq.length === 2 ? 300 : 0;
41677 | 162 |         score += Math.max(0, 260 - low.length);
41678 | 163 | 
41679 | 164 |         scored.push({ uniq, score, lowLen: low.length });
41680 | 165 |       }
41681 | 166 | 
41682 | 167 |       scored.sort((a, b) => b.score - a.score);
41683 | 168 |       const best = scored[0];
41684 | 169 |       if (!best) return { comments: null, shares: null, raw: null };
41685 | 170 | 
41686 | 171 |       const comments = best.uniq[0]?.v ?? null;
41687 | 172 |       const shares = best.uniq[1]?.v ?? null;
41688 | 173 | 
41689 | 174 |       const raw = `metaRow len=${best.lowLen} nums=${best.uniq
41690 | 175 |         .map((x) => `${x.v}:${x.s}`)
41691 | 176 |         .join(" | ")} -> comments=${comments} shares=${shares}`;
41692 | 177 | 
41693 | 178 |       return { comments, shares, raw };
41694 | 179 |     }
41695 | 180 | 
41696 | 181 |     // VIDEO/WATCH: wyciƒÖgnij komentarze z przycisku "liczba + ikonka"
41697 | 182 |     function extractVideoCommentsFromIconButtons() {
41698 | 183 |       const btns = Array.from(document.querySelectorAll('[role="button"][tabindex="0"]'))
41699 | 184 |         .filter(isVisibleRough)
41700 | 185 |         .slice(0, 12000);
41701 | 186 | 
41702 | 187 |       function hasSuffixToken(t) {
41703 | 188 |         const s = norm(t).toLowerCase();
41704 | 189 |         return /\b(tys|ty≈õ|k|mln|m)\b/.test(s);
41705 | 190 |       }
41706 | 191 | 
41707 | 192 |       const candidates = [];
41708 | 193 | 
41709 | 194 |       for (const b of btns) {
41710 | 195 |         // wariant 1: ikona jako <i data-visualcompletion="css-img">
41711 | 196 |         const iconI = b.querySelector('i[data-visualcompletion="css-img"]');
41712 | 197 |         // wariant 2 (na przysz≈Ço≈õƒá): ikona jako svg
41713 | 198 |         const iconSvg = b.querySelector("svg");
41714 | 199 | 
41715 | 200 |         if (!iconI && !iconSvg) continue;
41716 | 201 | 
41717 | 202 |         const toks = Array.from(b.querySelectorAll("span, a, div"))
41718 | 203 |           .filter(isVisibleRough)
41719 | 204 |           .map((el) => norm(el.textContent))
41720 | 205 |           .filter((t) => t && t.length <= 20);
41721 | 206 | 
41722 | 207 |         if (!toks.length) continue;
41723 | 208 | 
41724 | 209 |         // odetnij tys/mln (np. 496 tys.)
41725 | 210 |         if (toks.some(hasSuffixToken)) continue;
41726 | 211 | 
41727 | 212 |         // szukamy czystej liczby (np. 127)
41728 | 213 |         let value = null;
41729 | 214 |         let rawToken = null;
41730 | 215 | 
41731 | 216 |         for (const t of toks) {
41732 | 217 |           if (!/^\d[\d.,]*$/.test(t)) continue;
41733 | 218 |           const v = parseSingleCount(t);
41734 | 219 |           if (v == null) continue;
41735 | 220 |           value = v;
41736 | 221 |           rawToken = t;
41737 | 222 |           break;
41738 | 223 |         }
41739 | 224 | 
41740 | 225 |         if (value == null) continue;
41741 | 226 | 
41742 | 227 |         const aria =
41743 | 228 |           norm(b.getAttribute("aria-label")) +
41744 | 229 |           " " +
41745 | 230 |           norm((iconI && iconI.getAttribute && iconI.getAttribute("aria-label")) || "");
41746 | 231 | 
41747 | 232 |         const lowAria = aria.toLowerCase();
41748 | 233 | 
41749 | 234 |         let score = 0;
41750 | 235 | 
41751 | 236 |         // je≈õli gdziekolwiek pada "komentarz/comment" -> z≈Çoto
41752 | 237 |         if (/\b(comment|comments|komentarz|komentarze)\b/.test(lowAria)) score += 120;
41753 | 238 | 
41754 | 239 |         // komentarze raczej nie sƒÖ mikro (1..9) w takim przycisku
41755 | 240 |         if (value <= 9) score -= 60;
41756 | 241 | 
41757 | 242 |         // komentarze czƒôsto sƒÖ 10..5000+ -> lekka premia
41758 | 243 |         if (value >= 10 && value <= 500000) score += 20;
41759 | 244 | 
41760 | 245 |         candidates.push({
41761 | 246 |           value,
41762 | 247 |           score,
41763 | 248 |           raw: `iconBtn token=${rawToken} toks=${toks.join(" | ")} aria=${aria}`.slice(0, 500),
41764 | 249 |         });
41765 | 250 |       }
41766 | 251 | 
41767 | 252 |       if (!candidates.length) {
41768 | 253 |         return { comments: null, raw: "videoIconButtons: not-found" };
41769 | 254 |       }
41770 | 255 | 
41771 | 256 |       candidates.sort((a, b) => b.score - a.score || b.value - a.value);
41772 | 257 |       const best = candidates[0];
41773 | 258 | 
41774 | 259 |       return {
41775 | 260 |         comments: best.value,
41776 | 261 |         raw: `videoIconButtons best=${best.value} score=${best.score} ${best.raw}`,
41777 | 262 |       };
41778 | 263 |     }
41779 | 264 | 
41780 | 265 |     // VIDEO/WATCH: fallback ‚Äì pr√≥ba klasycznego "near labels" (u Ciebie)
41781 | 266 |     function extractNearLabels(actionRoot) {
41782 | 267 |       const LIKE_WORDS = ["lubiƒô to", "like"];
41783 | 268 |       const COMMENT_WORDS = ["komentarz", "comment"];
41784 | 269 |       const SHARE_WORDS = ["udostƒôpnij", "share"];
41785 | 270 | 
41786 | 271 |       function hasAny(low, arr) {
41787 | 272 |         return arr.some((w) => low.includes(w));
41788 | 273 |       }
41789 | 274 | 
41790 | 275 |       function getNodeLabel(el) {
41791 | 276 |         if (!el) return "";
41792 | 277 |         const a = norm(el.getAttribute?.("aria-label"));
41793 | 278 |         if (a) return a;
41794 | 279 |         return norm(el.textContent);
41795 | 280 |       }
41796 | 281 | 
41797 | 282 |       function findActionRowContainer(startEl) {
41798 | 283 |         let cur = startEl;
41799 | 284 |         for (let up = 0; up < 8 && cur; up++) {
41800 | 285 |           const t = norm(cur.innerText).toLowerCase();
41801 | 286 |           if (
41802 | 287 |             t &&
41803 | 288 |             hasAny(t, LIKE_WORDS) &&
41804 | 289 |             hasAny(t, COMMENT_WORDS) &&
41805 | 290 |             hasAny(t, SHARE_WORDS)
41806 | 291 |           ) {
41807 | 292 |             return cur;
41808 | 293 |           }
41809 | 294 |           cur = cur.parentElement;
41810 | 295 |         }
41811 | 296 |         return null;
41812 | 297 |       }
41813 | 298 | 
41814 | 299 |       const scope = document.body;
41815 | 300 | 
41816 | 301 |       const clickable = Array.from(scope.querySelectorAll('[role="button"], a, span, div'))
41817 | 302 |         .filter(isVisibleRough)
41818 | 303 |         .slice(0, 20000);
41819 | 304 | 
41820 | 305 |       const commentNodes = [];
41821 | 306 |       for (const el of clickable) {
41822 | 307 |         const low = getNodeLabel(el).toLowerCase();
41823 | 308 |         if (!low) continue;
41824 | 309 |         if (hasAny(low, COMMENT_WORDS)) commentNodes.push(el);
41825 | 310 |       }
41826 | 311 | 
41827 | 312 |       const scored = [];
41828 | 313 |       for (const cn of commentNodes) {
41829 | 314 |         const row = findActionRowContainer(cn);
41830 | 315 |         if (!row) continue;
41831 | 316 | 
41832 | 317 |         const rowText = norm(row.innerText).toLowerCase();
41833 | 318 |         if (!rowText) continue;
41834 | 319 | 
41835 | 320 |         if (rowText.includes("wszystkie reakcje") || rowText.includes("all reactions")) continue;
41836 | 321 | 
41837 | 322 |         const parts = Array.from(row.querySelectorAll("span, a, div, [role='button']"))
41838 | 323 |           .filter(isVisibleRough)
41839 | 324 |           .map((n) => getNodeLabel(n))
41840 | 325 |           .map((s) => norm(s))
41841 | 326 |           .filter((s) => s && s.length <= 40);
41842 | 327 | 
41843 | 328 |         const anyNum = parts.some((s) => parseSingleCount(s) != null);
41844 | 329 |         if (!anyNum) continue;
41845 | 330 | 
41846 | 331 |         let score = 0;
41847 | 332 |         score += Math.max(0, 600 - rowText.length);
41848 | 333 |         score += Math.max(0, 120 - parts.length);
41849 | 334 | 
41850 | 335 |         scored.push({ row, parts, rowLen: rowText.length, score });
41851 | 336 |       }
41852 | 337 | 
41853 | 338 |       scored.sort((a, b) => b.score - a.score);
41854 | 339 |       const best = scored[0];
41855 | 340 | 
41856 | 341 |       if (!best) {
41857 | 342 |         return { comments: null, shares: null, raw: "nearLabels: no-action-row-found" };
41858 | 343 |       }
41859 | 344 | 
41860 | 345 |       const tokensLow = best.parts.map((s) => s.toLowerCase());
41861 | 346 | 
41862 | 347 |       const idxLike = tokensLow.findIndex((t) => hasAny(t, LIKE_WORDS));
41863 | 348 |       const idxComment = tokensLow.findIndex((t) => hasAny(t, COMMENT_WORDS));
41864 | 349 |       const idxShare = tokensLow.findIndex((t) => hasAny(t, SHARE_WORDS));
41865 | 350 | 
41866 | 351 |       function scanLeftForNumber(fromIdx) {
41867 | 352 |         if (fromIdx == null || fromIdx < 0) return null;
41868 | 353 |         for (let i = fromIdx - 1; i >= 0 && i >= fromIdx - 14; i--) {
41869 | 354 |           const v = parseSingleCount(best.parts[i]);
41870 | 355 |           if (v != null) return { v, at: i, token: best.parts[i] };
41871 | 356 |         }
41872 | 357 |         return null;
41873 | 358 |       }
41874 | 359 | 
41875 | 360 |       let cPick = scanLeftForNumber(idxComment);
41876 | 361 |       if (!cPick) cPick = scanLeftForNumber(idxLike);
41877 | 362 | 
41878 | 363 |       let sPick = scanLeftForNumber(idxShare);
41879 | 364 |       if (cPick && sPick && sPick.v === cPick.v) sPick = null;
41880 | 365 | 
41881 | 366 |       const raw = `nearLabels[actionRow] len=${best.rowLen} tokens=${best.parts.join(
41882 | 367 |         " | "
41883 | 368 |       )} -> idxLike=${idxLike} idxComment=${idxComment} idxShare=${idxShare} | comments=${
41884 | 369 |         cPick ? `${cPick.v}(${cPick.token})@${cPick.at}` : "null"
41885 | 370 |       } | shares=${sPick ? `${sPick.v}(${sPick.token})@${sPick.at}` : "null"}`;
41886 | 371 | 
41887 | 372 |       return {
41888 | 373 |         comments: cPick ? cPick.v : null,
41889 | 374 |         shares: sPick ? sPick.v : null,
41890 | 375 |         raw,
41891 | 376 |       };
41892 | 377 |     }
41893 | 378 | 
41894 | 379 |     const viewType = detectViewType();
41895 | 380 |     const actionRoot = findActionBarRoot();
41896 | 381 | 
41897 | 382 |     let meta;
41898 | 383 | 
41899 | 384 |     if (viewType === "video" || viewType === "watch") {
41900 | 385 |       // 1) pr√≥buj najpierw ikonki (to jest Tw√≥j przypadek z 127 / 496 tys.)
41901 | 386 |       meta = extractVideoCommentsFromIconButtons();
41902 | 387 | 
41903 | 388 |       // 2) fallback: near labels (jak w Twoim kodzie)
41904 | 389 |       if (meta.comments == null) {
41905 | 390 |         const near = extractNearLabels(actionRoot);
41906 | 391 |         meta = { comments: near.comments, raw: near.raw };
41907 | 392 |       }
41908 | 393 |     } else {
41909 | 394 |       // photo/permalink stabilne -> nie ruszamy
41910 | 395 |       meta = extractFromMetaRow(actionRoot);
41911 | 396 |     }
41912 | 397 | 
41913 | 398 |     return {
41914 | 399 |       source: `ui-${viewType}`,
41915 | 400 |       viewType,
41916 | 401 |       comments: meta.comments,
41917 | 402 |       raw: meta.raw,
41918 | 403 |     };
41919 | 404 |   });
41920 | 405 | }
41921 | 406 | 
41922 | ```
41923 | 
41924 | ---
41925 | 
41926 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/videos.js`
41927 | **Typ:** JavaScript/tekst  
41928 | **Opis:** Plik projektu (kod/konfiguracja).  
41929 | 
41930 | ```js
41931 |   1 | import { safeGoto } from "../../utils/navigation.js";
41932 |   2 | import { sleepRandom } from "../../utils/sleep.js";
41933 |   3 | import { acceptCookies } from "../cookies.js";
41934 |   4 | import { fbLogin, checkIfLogged } from "../login.js";
41935 |   5 | import { getUiCommentInfo } from "../uiCommentInfo.js";
41936 |   6 | 
41937 |   7 | /** Typ handlera UI */
41938 |   8 | export const type = "videos";
41939 |   9 | 
41940 |  10 | export function matchesUrl(url) {
41941 |  11 |   const lower = (url || "").toLowerCase();
41942 |  12 |   return lower.includes("/videos/") || (lower.includes("?v=") && !lower.includes("/watch"));
41943 |  13 | }
41944 |  14 | 
41945 |  15 | export async function prepare(page, url) {
41946 |  16 |   console.log(`[FB][ui:videos] Otwieranie posta wideo: ${url}`);
41947 |  17 |   const ok = await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
41948 |  18 |   if (!ok) throw new Error("safeGoto-failed");
41949 |  19 | 
41950 |  20 |   const currentUrl = page.url();
41951 |  21 |   if (currentUrl.includes("/login")) {
41952 |  22 |     console.log("[FB][ui:videos] Wymagane logowanie ‚Äì pr√≥bujƒô zalogowaƒá.");
41953 |  23 |     await fbLogin(page);
41954 |  24 |     await sleepRandom(3000, 4500);
41955 |  25 | 
41956 |  26 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
41957 |  27 |     console.log(
41958 |  28 |       `[FB][ui:videos] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
41959 |  29 |     );
41960 |  30 | 
41961 |  31 |     if (loggedAfterLogin) {
41962 |  32 |       await safeGoto(page, url, "videos", { waitUntil: "networkidle2", timeout: 90000 });
41963 |  33 |     } else {
41964 |  34 |       console.log("[FB][ui:videos] Logowanie nieudane ‚Äì kontynuacja bez sesji.");
41965 |  35 |     }
41966 |  36 |   }
41967 |  37 | 
41968 |  38 |   await acceptCookies(page, "videos");
41969 |  39 | 
41970 |  40 |   // stop autoplay
41971 |  41 |   try {
41972 |  42 |     await page.evaluate(() => {
41973 |  43 |       const vids = Array.from(document.querySelectorAll("video"));
41974 |  44 |       for (const v of vids) {
41975 |  45 |         try {
41976 |  46 |           v.autoplay = false;
41977 |  47 |           v.removeAttribute("autoplay");
41978 |  48 |           v.muted = true;
41979 |  49 |           v.pause();
41980 |  50 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
41981 |  51 |         } catch {}
41982 |  52 |       }
41983 |  53 |     });
41984 |  54 |     console.log("[FB][ui:videos] Wideo wstrzymane (autoplay wy≈ÇƒÖczony).");
41985 |  55 |   } catch (e) {
41986 |  56 |     console.log("[FB][ui:videos] B≈ÇƒÖd zatrzymania wideo:", e?.message || e);
41987 |  57 |   }
41988 |  58 | }
41989 |  59 | 
41990 |  60 | export async function getCommentCount(page, url) {
41991 |  61 |   const uiInfo = await getUiCommentInfo(page);
41992 |  62 |   console.log(`[FB][ui:videos][DBG] UI info:`, {
41993 |  63 |     source: uiInfo?.source,
41994 |  64 |     raw: uiInfo?.raw,
41995 |  65 |     viewType: uiInfo?.viewType,
41996 |  66 |     comments: uiInfo?.comments,
41997 |  67 |   });
41998 |  68 | 
41999 |  69 |   let totalComments = null;
42000 |  70 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) totalComments = uiInfo.comments;
42001 |  71 | 
42002 |  72 |   console.log(
42003 |  73 |     `[FB][ui:videos] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`
42004 |  74 |   );
42005 |  75 |   return totalComments;
42006 |  76 | }
42007 |  77 | 
42008 |  78 | /* ==============================
42009 |  79 |    ======= DEBUG HELPERS ========
42010 |  80 |    ============================== */
42011 |  81 | 
42012 |  82 | function shortenHtml(html, max = 220) {
42013 |  83 |   if (!html) return null;
42014 |  84 |   const s = String(html).replace(/\s+/g, " ").trim();
42015 |  85 |   if (s.length <= max) return s;
42016 |  86 |   return s.slice(0, max) + "‚Ä¶";
42017 |  87 | }
42018 |  88 | 
42019 |  89 | async function debugDumpShowAllCandidates(page) {
42020 |  90 |   const out = await page.evaluate(() => {
42021 |  91 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
42022 |  92 |     function pick(el) {
42023 |  93 |       if (!el) return null;
42024 |  94 |       const r = el.getBoundingClientRect();
42025 |  95 |       return {
42026 |  96 |         tag: el.tagName,
42027 |  97 |         role: el.getAttribute("role"),
42028 |  98 |         aria: el.getAttribute("aria-label"),
42029 |  99 |         text: norm(el.textContent),
42030 | 100 |         top: Math.round(r.top),
42031 | 101 |         left: Math.round(r.left),
42032 | 102 |         w: Math.round(r.width),
42033 | 103 |         h: Math.round(r.height),
42034 | 104 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
42035 | 105 |       };
42036 | 106 |     }
42037 | 107 | 
42038 | 108 |     const headers = Array.from(document.querySelectorAll("span"))
42039 | 109 |       .filter((s) => {
42040 | 110 |         const t = norm(s.textContent).toLowerCase();
42041 | 111 |         return t === "komentarze" || t === "comments";
42042 | 112 |       })
42043 | 113 |       .slice(0, 5)
42044 | 114 |       .map(pick);
42045 | 115 | 
42046 | 116 |     const showAll = Array.from(
42047 | 117 |       document.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
42048 | 118 |     )
42049 | 119 |       .filter((el) => {
42050 | 120 |         const al = (el.getAttribute("aria-label") || "").toLowerCase().trim();
42051 | 121 |         return al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all";
42052 | 122 |       })
42053 | 123 |       .slice(0, 20)
42054 | 124 |       .map(pick);
42055 | 125 | 
42056 | 126 |     return { headers, showAll };
42057 | 127 |   });
42058 | 128 | 
42059 | 129 |   console.log("[FB][ui:videos][DBG] candidates:", JSON.stringify(out, null, 2));
42060 | 130 | }
42061 | 131 | 
42062 | 132 | /* ==========================================
42063 | 133 |    ======= COMMENTS SCOPE / MARKERS =========
42064 | 134 |    ========================================== */
42065 | 135 | 
42066 | 136 | async function markCommentsScope(page) {
42067 | 137 |   return await page.evaluate(() => {
42068 | 138 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
42069 | 139 | 
42070 | 140 |     function isVisible(el) {
42071 | 141 |       if (!el) return false;
42072 | 142 |       const st = getComputedStyle(el);
42073 | 143 |       if (st.display === "none" || st.visibility === "hidden") return false;
42074 | 144 |       const r = el.getBoundingClientRect();
42075 | 145 |       return !!r && r.width > 5 && r.height > 5;
42076 | 146 |     }
42077 | 147 | 
42078 | 148 |     function pick(el) {
42079 | 149 |       if (!el) return null;
42080 | 150 |       const r = el.getBoundingClientRect();
42081 | 151 |       return {
42082 | 152 |         tag: el.tagName,
42083 | 153 |         role: el.getAttribute("role"),
42084 | 154 |         aria: el.getAttribute("aria-label"),
42085 | 155 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
42086 | 156 |         top: Math.round(r.top),
42087 | 157 |         left: Math.round(r.left),
42088 | 158 |         w: Math.round(r.width),
42089 | 159 |         h: Math.round(r.height),
42090 | 160 |       };
42091 | 161 |     }
42092 | 162 | 
42093 | 163 |     // clear markers
42094 | 164 |     try {
42095 | 165 |       document.querySelectorAll("[data-fbw-comments-root='1']").forEach((n) => n.removeAttribute("data-fbw-comments-root"));
42096 | 166 |       document.querySelectorAll("[data-fbw-comments-header-row='1']").forEach((n) =>
42097 | 167 |         n.removeAttribute("data-fbw-comments-header-row")
42098 | 168 |       );
42099 | 169 |       document.querySelectorAll("[data-fbw-comments-anchor='1']").forEach((n) =>
42100 | 170 |         n.removeAttribute("data-fbw-comments-anchor")
42101 | 171 |       );
42102 | 172 |     } catch {}
42103 | 173 | 
42104 | 174 |     // find header
42105 | 175 |     const headerSpans = Array.from(document.querySelectorAll("span"))
42106 | 176 |       .filter(isVisible)
42107 | 177 |       .filter((el) => {
42108 | 178 |         const t = norm(el.textContent);
42109 | 179 |         return t === "komentarze" || t === "comments";
42110 | 180 |       });
42111 | 181 | 
42112 | 182 |     if (!headerSpans.length) return { ok: false, reason: "no-header" };
42113 | 183 | 
42114 | 184 |     // pick first visible header and mark a "root" around it
42115 | 185 |     const h = headerSpans[0];
42116 | 186 | 
42117 | 187 |     // header row: climb until it contains "Poka≈º wszystkie" OR "Ukryj komentarze"
42118 | 188 |     let row = h.parentElement;
42119 | 189 |     let foundRow = null;
42120 | 190 | 
42121 | 191 |     for (let up = 0; up < 14 && row; up++) {
42122 | 192 |       const btns = Array.from(
42123 | 193 |         row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
42124 | 194 |       ).filter(isVisible);
42125 | 195 | 
42126 | 196 |       const ok = btns.some((b) => {
42127 | 197 |         const al = norm(b.getAttribute("aria-label"));
42128 | 198 |         return (
42129 | 199 |           al === "poka≈º wszystkie" ||
42130 | 200 |           al === "wy≈õwietl wszystkie" ||
42131 | 201 |           al === "show all" ||
42132 | 202 |           al === "view all" ||
42133 | 203 |           al === "ukryj komentarze" ||
42134 | 204 |           al === "hide comments"
42135 | 205 |         );
42136 | 206 |       });
42137 | 207 | 
42138 | 208 |       if (ok) {
42139 | 209 |         foundRow = row;
42140 | 210 |         break;
42141 | 211 |       }
42142 | 212 |       row = row.parentElement;
42143 | 213 |     }
42144 | 214 | 
42145 | 215 |     if (foundRow) {
42146 | 216 |       try {
42147 | 217 |         foundRow.setAttribute("data-fbw-comments-header-row", "1");
42148 | 218 |       } catch {}
42149 | 219 |     }
42150 | 220 | 
42151 | 221 |     // comments root: climb from header span to a big block that contains comment box or "Najtrafniejsze"
42152 | 222 |     let root = h.parentElement;
42153 | 223 |     let best = null;
42154 | 224 | 
42155 | 225 |     for (let up = 0; up < 26 && root; up++) {
42156 | 226 |       const txt = norm(root.innerText || "");
42157 | 227 |       const hasCommentBox = txt.includes("napisz komentarz") || txt.includes("write a comment");
42158 | 228 |       const hasSort = txt.includes("najtrafniejsze") || txt.includes("most relevant") || txt.includes("top comments");
42159 | 229 |       const hasRepliesWord = txt.includes("odpowied") || txt.includes("repl");
42160 | 230 |       const isBigEnough = (root.clientHeight || 0) > 250;
42161 | 231 | 
42162 | 232 |       if ((hasCommentBox || hasSort || hasRepliesWord) && isBigEnough) {
42163 | 233 |         best = root;
42164 | 234 |         break;
42165 | 235 |       }
42166 | 236 |       root = root.parentElement;
42167 | 237 |     }
42168 | 238 | 
42169 | 239 |     // fallback: use header row parent
42170 | 240 |     if (!best && foundRow) best = foundRow.parentElement;
42171 | 241 |     if (!best) best = document.body;
42172 | 242 | 
42173 | 243 |     try {
42174 | 244 |       best.setAttribute("data-fbw-comments-root", "1");
42175 | 245 |     } catch {}
42176 | 246 | 
42177 | 247 |     // anchor element for scroll targeting: header span itself
42178 | 248 |     try {
42179 | 249 |       h.setAttribute("data-fbw-comments-anchor", "1");
42180 | 250 |     } catch {}
42181 | 251 | 
42182 | 252 |     return {
42183 | 253 |       ok: true,
42184 | 254 |       reason: "marked",
42185 | 255 |       header: pick(h),
42186 | 256 |       row: foundRow ? pick(foundRow) : null,
42187 | 257 |       root: pick(best),
42188 | 258 |     };
42189 | 259 |   });
42190 | 260 | }
42191 | 261 | 
42192 | 262 | async function clickShowAllFromMarkedRow(page) {
42193 | 263 |   const res = await page.evaluate(() => {
42194 | 264 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
42195 | 265 | 
42196 | 266 |     function isVisible(el) {
42197 | 267 |       if (!el) return false;
42198 | 268 |       const st = getComputedStyle(el);
42199 | 269 |       if (st.display === "none" || st.visibility === "hidden") return false;
42200 | 270 |       const r = el.getBoundingClientRect();
42201 | 271 |       return !!r && r.width > 5 && r.height > 5;
42202 | 272 |     }
42203 | 273 | 
42204 | 274 |     function pick(el) {
42205 | 275 |       if (!el) return null;
42206 | 276 |       const r = el.getBoundingClientRect();
42207 | 277 |       return {
42208 | 278 |         tag: el.tagName,
42209 | 279 |         role: el.getAttribute("role"),
42210 | 280 |         aria: el.getAttribute("aria-label"),
42211 | 281 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
42212 | 282 |         top: Math.round(r.top),
42213 | 283 |         left: Math.round(r.left),
42214 | 284 |         w: Math.round(r.width),
42215 | 285 |         h: Math.round(r.height),
42216 | 286 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
42217 | 287 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
42218 | 288 |       };
42219 | 289 |     }
42220 | 290 | 
42221 | 291 |     const row = document.querySelector("[data-fbw-comments-header-row='1']");
42222 | 292 |     if (!row) return { clicked: false, reason: "no-row", dbg: null };
42223 | 293 | 
42224 | 294 |     const candidates = Array.from(
42225 | 295 |       row.querySelectorAll("div[role='button'][aria-label],button[aria-label],a[aria-label]")
42226 | 296 |     ).filter(isVisible);
42227 | 297 | 
42228 | 298 |     // Prefer "Poka≈º wszystkie" only (not "Ukryj komentarze")
42229 | 299 |     for (const c of candidates) {
42230 | 300 |       const al = norm(c.getAttribute("aria-label"));
42231 | 301 |       if (al === "poka≈º wszystkie" || al === "wy≈õwietl wszystkie" || al === "show all" || al === "view all") {
42232 | 302 |         try {
42233 | 303 |           c.scrollIntoView({ block: "center", inline: "nearest" });
42234 | 304 |         } catch {}
42235 | 305 |         try {
42236 | 306 |           c.click();
42237 | 307 |         } catch {}
42238 | 308 |         return { clicked: true, reason: "clicked", dbg: pick(c) };
42239 | 309 |       }
42240 | 310 |     }
42241 | 311 | 
42242 | 312 |     return { clicked: false, reason: "no-showall-in-row", dbg: candidates.slice(0, 4).map(pick) };
42243 | 313 |   });
42244 | 314 | 
42245 | 315 |   console.log("[FB][ui:videos][DBG] show-all click:", JSON.stringify(res, null, 2));
42246 | 316 |   return !!res?.clicked;
42247 | 317 | }
42248 | 318 | 
42249 | 319 | /* ==========================================
42250 | 320 |    ======= FILTER/SORT (Najtrafniejsze) ======
42251 | 321 |    ========================================== */
42252 | 322 | 
42253 | 323 | async function ensureAllCommentsFilter(page) {
42254 | 324 |   const res = await page.evaluate(() => {
42255 | 325 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
42256 | 326 | 
42257 | 327 |     function isVisible(el) {
42258 | 328 |       if (!el) return false;
42259 | 329 |       const st = getComputedStyle(el);
42260 | 330 |       if (st.display === "none" || st.visibility === "hidden") return false;
42261 | 331 |       const r = el.getBoundingClientRect();
42262 | 332 |       return !!r && r.width > 5 && r.height > 5;
42263 | 333 |     }
42264 | 334 | 
42265 | 335 |     function pick(el) {
42266 | 336 |       if (!el) return null;
42267 | 337 |       const r = el.getBoundingClientRect();
42268 | 338 |       return {
42269 | 339 |         tag: el.tagName,
42270 | 340 |         role: el.getAttribute("role"),
42271 | 341 |         aria: el.getAttribute("aria-label"),
42272 | 342 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
42273 | 343 |         top: Math.round(r.top),
42274 | 344 |         left: Math.round(r.left),
42275 | 345 |         w: Math.round(r.width),
42276 | 346 |         h: Math.round(r.height),
42277 | 347 |       };
42278 | 348 |     }
42279 | 349 | 
42280 | 350 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
42281 | 351 | 
42282 | 352 |     // If already shows "Wszystkie komentarze" / "All comments" / "Najnowsze" etc, do nothing
42283 | 353 |     const rootTxt = norm(root.innerText || "");
42284 | 354 |     if (rootTxt.includes("wszystkie komentarze") || rootTxt.includes("all comments")) {
42285 | 355 |       return { ok: true, action: "already-all", dbg: null };
42286 | 356 |     }
42287 | 357 | 
42288 | 358 |     // find the sort dropdown button in root
42289 | 359 |     const btns = Array.from(root.querySelectorAll("div[role='button'],span[role='button'],button")).filter(isVisible);
42290 | 360 | 
42291 | 361 |     const sortBtn = btns.find((b) => {
42292 | 362 |       const t = norm(b.textContent);
42293 | 363 |       return (
42294 | 364 |         t === "najtrafniejsze" ||
42295 | 365 |         t === "most relevant" ||
42296 | 366 |         t === "top comments" ||
42297 | 367 |         t === "najlepsze" ||
42298 | 368 |         t === "newest" ||
42299 | 369 |         t === "najnowsze"
42300 | 370 |       );
42301 | 371 |     });
42302 | 372 | 
42303 | 373 |     if (!sortBtn) {
42304 | 374 |       return { ok: false, action: "no-sortbtn", dbg: { sample: btns.slice(0, 8).map(pick) } };
42305 | 375 |     }
42306 | 376 | 
42307 | 377 |     try {
42308 | 378 |       sortBtn.scrollIntoView({ block: "center", inline: "nearest" });
42309 | 379 |     } catch {}
42310 | 380 |     try {
42311 | 381 |       sortBtn.click();
42312 | 382 |     } catch {}
42313 | 383 | 
42314 | 384 |     return { ok: true, action: "opened-menu", dbg: pick(sortBtn) };
42315 | 385 |   });
42316 | 386 | 
42317 | 387 |   console.log("[FB][ui:videos][DBG] filter step#1:", JSON.stringify(res, null, 2));
42318 | 388 | 
42319 | 389 |   if (!res?.ok || res.action !== "opened-menu") return false;
42320 | 390 | 
42321 | 391 |   await sleepRandom(400, 700);
42322 | 392 | 
42323 | 393 |   const res2 = await page.evaluate(() => {
42324 | 394 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
42325 | 395 | 
42326 | 396 |     function isVisible(el) {
42327 | 397 |       if (!el) return false;
42328 | 398 |       const st = getComputedStyle(el);
42329 | 399 |       if (st.display === "none" || st.visibility === "hidden") return false;
42330 | 400 |       const r = el.getBoundingClientRect();
42331 | 401 |       return !!r && r.width > 5 && r.height > 5;
42332 | 402 |     }
42333 | 403 | 
42334 | 404 |     function pick(el) {
42335 | 405 |       if (!el) return null;
42336 | 406 |       const r = el.getBoundingClientRect();
42337 | 407 |       return {
42338 | 408 |         tag: el.tagName,
42339 | 409 |         role: el.getAttribute("role"),
42340 | 410 |         aria: el.getAttribute("aria-label"),
42341 | 411 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
42342 | 412 |         top: Math.round(r.top),
42343 | 413 |         left: Math.round(r.left),
42344 | 414 |         w: Math.round(r.width),
42345 | 415 |         h: Math.round(r.height),
42346 | 416 |       };
42347 | 417 |     }
42348 | 418 | 
42349 | 419 |     const menu = document.querySelector("div[role='menu']") || document.querySelector("div[role='dialog']");
42350 | 420 | 
42351 | 421 |     if (!menu) return { ok: false, action: "no-menu" };
42352 | 422 | 
42353 | 423 |     const items = Array.from(menu.querySelectorAll("div[role='menuitem'], div[role='menuitemradio'], div[role='button']"))
42354 | 424 |       .filter(isVisible)
42355 | 425 |       .slice(0, 200);
42356 | 426 | 
42357 | 427 |     // Prefer: "Wszystkie komentarze" / "All comments"
42358 | 428 |     let target =
42359 | 429 |       items.find((el) => norm(el.textContent).startsWith("wszystkie komentarze")) ||
42360 | 430 |       items.find((el) => norm(el.textContent).startsWith("all comments"));
42361 | 431 | 
42362 | 432 |     // Fallback: "Najnowsze" / "Newest"
42363 | 433 |     if (!target) {
42364 | 434 |       target = items.find((el) => norm(el.textContent).startsWith("najnowsze")) || items.find((el) => norm(el.textContent).startsWith("newest"));
42365 | 435 |     }
42366 | 436 | 
42367 | 437 |     if (!target) {
42368 | 438 |       return { ok: false, action: "no-target", dbg: { items: items.slice(0, 12).map(pick) } };
42369 | 439 |     }
42370 | 440 | 
42371 | 441 |     try {
42372 | 442 |       target.scrollIntoView({ block: "center", inline: "nearest" });
42373 | 443 |     } catch {}
42374 | 444 |     try {
42375 | 445 |       target.click();
42376 | 446 |     } catch {}
42377 | 447 | 
42378 | 448 |     // close menu
42379 | 449 |     try {
42380 | 450 |       setTimeout(() => document.body.click(), 40);
42381 | 451 |     } catch {}
42382 | 452 | 
42383 | 453 |     return { ok: true, action: "clicked-target", dbg: pick(target) };
42384 | 454 |   });
42385 | 455 | 
42386 | 456 |   console.log("[FB][ui:videos][DBG] filter step#2:", JSON.stringify(res2, null, 2));
42387 | 457 | 
42388 | 458 |   await sleepRandom(500, 900);
42389 | 459 | 
42390 | 460 |   return !!res2?.ok;
42391 | 461 | }
42392 | 462 | 
42393 | 463 | /* ==========================================
42394 | 464 |    ======= SEQUENTIAL ACTION LOOP ============
42395 | 465 |    ========================================== */
42396 | 466 | 
42397 | 467 | async function oneSequentialAction(page) {
42398 | 468 |   const res = await page.evaluate(() => {
42399 | 469 |     const norm = (s) => (s || "").replace(/\s+/g, " ").trim().toLowerCase();
42400 | 470 | 
42401 | 471 |     function isVisible(el) {
42402 | 472 |       if (!el) return false;
42403 | 473 |       const st = getComputedStyle(el);
42404 | 474 |       if (st.display === "none" || st.visibility === "hidden") return false;
42405 | 475 |       const r = el.getBoundingClientRect();
42406 | 476 |       return !!r && r.width > 5 && r.height > 5;
42407 | 477 |     }
42408 | 478 | 
42409 | 479 |     function pick(el) {
42410 | 480 |       if (!el) return null;
42411 | 481 |       const r = el.getBoundingClientRect();
42412 | 482 |       return {
42413 | 483 |         tag: el.tagName,
42414 | 484 |         role: el.getAttribute("role"),
42415 | 485 |         aria: el.getAttribute("aria-label"),
42416 | 486 |         text: (el.textContent || "").replace(/\s+/g, " ").trim(),
42417 | 487 |         top: Math.round(r.top),
42418 | 488 |         left: Math.round(r.left),
42419 | 489 |         w: Math.round(r.width),
42420 | 490 |         h: Math.round(r.height),
42421 | 491 |         inViewport: r.bottom > 0 && r.top < window.innerHeight,
42422 | 492 |         html: el.outerHTML ? el.outerHTML.slice(0, 260) : null,
42423 | 493 |       };
42424 | 494 |     }
42425 | 495 | 
42426 | 496 |     // scope: root (jak masz) + lekka pr√≥ba zej≈õcia do panelu komentarzy przy composerze
42427 | 497 |     const root = document.querySelector("[data-fbw-comments-root='1']") || document.body;
42428 | 498 | 
42429 | 499 |     const composer =
42430 | 500 |       root.querySelector("[aria-label^='Napisz komentarz']") ||
42431 | 501 |       root.querySelector("[aria-label^='Write a comment']") ||
42432 | 502 |       root.querySelector("[role='textbox'][contenteditable='true']");
42433 | 503 | 
42434 | 504 |     let scope = root;
42435 | 505 |     if (composer) {
42436 | 506 |       let p = composer.parentElement;
42437 | 507 |       for (let up = 0; up < 14 && p; up++) {
42438 | 508 |         const bigEnough = (p.clientHeight || 0) > 220;
42439 | 509 |         const t = norm(p.innerText || "");
42440 | 510 |         const looksCommenty =
42441 | 511 |           t.includes("najtrafniejsze") ||
42442 | 512 |           t.includes("most relevant") ||
42443 | 513 |           t.includes("wszystkie komentarze") ||
42444 | 514 |           t.includes("all comments") ||
42445 | 515 |           t.includes("wy≈õwietl wiƒôcej komentarzy") ||
42446 | 516 |           t.includes("view more comments");
42447 | 517 |         if (bigEnough && looksCommenty) {
42448 | 518 |           scope = p;
42449 | 519 |           break;
42450 | 520 |         }
42451 | 521 |         p = p.parentElement;
42452 | 522 |       }
42453 | 523 |     }
42454 | 524 | 
42455 | 525 |     // UWAGA: klikamy TYLKO elementy klikalne
42456 | 526 |     const clickables = Array.from(
42457 | 527 |       scope.querySelectorAll(
42458 | 528 |         "div[role='button'], button, a[role='button'], a[aria-label], div[tabindex='0'], span[role='button']"
42459 | 529 |       )
42460 | 530 |     )
42461 | 531 |       .filter(isVisible)
42462 | 532 |       .slice(0, 12000);
42463 | 533 | 
42464 | 534 |     const bannedExact = new Set(["zobacz wiƒôcej", "see more", "poka≈º wiƒôcej", "show more"]);
42465 | 535 | 
42466 | 536 |     const moreCommentNeedles = [
42467 | 537 |       "wy≈õwietl wiƒôcej komentarzy",
42468 | 538 |       "zobacz wiƒôcej komentarzy",
42469 | 539 |       "view more comments",
42470 | 540 |       "view previous comments",
42471 | 541 |       "see more comments",
42472 | 542 |     ];
42473 | 543 | 
42474 | 544 |     // 1) MORE COMMENTS ‚Äì tylko clickables
42475 | 545 |     for (const el of clickables) {
42476 | 546 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
42477 | 547 |       if (!t) continue;
42478 | 548 |       if (bannedExact.has(t)) continue;
42479 | 549 | 
42480 | 550 |       if (moreCommentNeedles.some((n) => t.includes(n))) {
42481 | 551 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
42482 | 552 |         try { el.click(); } catch {}
42483 | 553 |         return { acted: true, action: "more-comments", dbg: pick(el) };
42484 | 554 |       }
42485 | 555 |     }
42486 | 556 | 
42487 | 557 |     // 2) REPLIES ‚Äì tylko clickables
42488 | 558 |     for (const el of clickables) {
42489 | 559 |       const t = norm(el.getAttribute("aria-label") || el.textContent);
42490 | 560 |       if (!t) continue;
42491 | 561 |       if (bannedExact.has(t)) continue;
42492 | 562 | 
42493 | 563 |       const isReply =
42494 | 564 |         t.includes("wy≈õwietl wiƒôcej odpowiedzi") ||
42495 | 565 |         t.includes("zobacz wiƒôcej odpowiedzi") ||
42496 | 566 |         t.includes("view more replies") ||
42497 | 567 |         t.includes("see more replies") ||
42498 | 568 |         /\b\d+\s+(odpowied≈∫|odpowiedzi|replies)\b/.test(t);
42499 | 569 | 
42500 | 570 |       if (isReply) {
42501 | 571 |         try { el.scrollIntoView({ block: "center", inline: "nearest" }); } catch {}
42502 | 572 |         try { el.click(); } catch {}
42503 | 573 |         return { acted: true, action: "replies", dbg: pick(el) };
42504 | 574 |       }
42505 | 575 |     }
42506 | 576 | 
42507 | 577 |     // 3) SCROLL ‚Äì pr√≥buj scope, potem window
42508 | 578 |     const step = Math.max(260, Math.min(520, Math.floor(window.innerHeight * 0.45)));
42509 | 579 | 
42510 | 580 |     const beforeScope = scope.scrollTop || 0;
42511 | 581 |     try {
42512 | 582 |       if (scope && typeof scope.scrollTop === "number") {
42513 | 583 |         scope.scrollTop = beforeScope + step;
42514 | 584 |         const afterScope = scope.scrollTop || beforeScope;
42515 | 585 |         if (afterScope > beforeScope) {
42516 | 586 |           return { acted: true, action: "scroll-scope", dbg: { beforeScope, afterScope, step } };
42517 | 587 |         }
42518 | 588 |       }
42519 | 589 |     } catch {}
42520 | 590 | 
42521 | 591 |     const beforeWin = window.scrollY || 0;
42522 | 592 |     window.scrollBy(0, step);
42523 | 593 |     const afterWin = window.scrollY || 0;
42524 | 594 | 
42525 | 595 |     return {
42526 | 596 |       acted: afterWin > beforeWin,
42527 | 597 |       action: afterWin > beforeWin ? "scroll-window" : "no-scroll",
42528 | 598 |       dbg: { beforeWin, afterWin, step },
42529 | 599 |     };
42530 | 600 |   });
42531 | 601 | 
42532 | 602 |   if (res?.dbg?.html) res.dbg.html = shortenHtml(res.dbg.html, 220);
42533 | 603 |   console.log("[FB][ui:videos][DBG] step:", JSON.stringify(res, null, 2));
42534 | 604 |   return res || { acted: false, action: "none", dbg: null };
42535 | 605 | }
42536 | 606 | 
42537 | 607 | 
42538 | 608 | 
42539 | 609 | /**
42540 | 610 |  * Wczytuje wszystkie komentarze dla posta wideo.
42541 | 611 |  */
42542 | 612 | export async function loadAllComments(page, { expectedTotal } = {}) {
42543 | 613 |   console.log("[FB][ui:videos] ≈Åadujƒô wszystkie komentarze (VIDEOS)...");
42544 | 614 | 
42545 | 615 |   await debugDumpShowAllCandidates(page).catch(() => {});
42546 | 616 | 
42547 | 617 |   const mark1 = await markCommentsScope(page).catch(() => null);
42548 | 618 |   console.log("[FB][ui:videos][DBG] mark#1:", JSON.stringify(mark1, null, 2));
42549 | 619 | 
42550 | 620 |   await sleepRandom(250, 500);
42551 | 621 | 
42552 | 622 |   // klik show-all z header-row
42553 | 623 |   const clickedAll = await clickShowAllFromMarkedRow(page).catch(() => false);
42554 | 624 |   if (clickedAll) {
42555 | 625 |     await sleepRandom(900, 1400);
42556 | 626 |     const mark2 = await markCommentsScope(page).catch(() => null);
42557 | 627 |     console.log("[FB][ui:videos][DBG] mark#2:", JSON.stringify(mark2, null, 2));
42558 | 628 |   } else {
42559 | 629 |     console.log("[FB][ui:videos] show-all: nie klikniƒôto (patrz DBG wy≈ºej).");
42560 | 630 |   }
42561 | 631 | 
42562 | 632 |   // po show-all spr√≥buj ustawiƒá "Wszystkie komentarze" / "Najnowsze"
42563 | 633 |   const filterOk = await ensureAllCommentsFilter(page).catch(() => false);
42564 | 634 |   console.log("[FB][ui:videos] filter ensure:", filterOk);
42565 | 635 | 
42566 | 636 |   // policz cykle dynamicznie
42567 | 637 |   let maxCycles = 180;
42568 | 638 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
42569 | 639 |     maxCycles = Math.min(Math.max(90, Math.ceil(expectedTotal / 3)), 420);
42570 | 640 |   }
42571 | 641 | 
42572 | 642 |   let noProgress = 0;
42573 | 643 | 
42574 | 644 |   for (let i = 1; i <= maxCycles; i++) {
42575 | 645 |     // jedna akcja na cykl
42576 | 646 |     const r = await oneSequentialAction(page);
42577 | 647 | 
42578 | 648 |     const didProgress = !!r?.acted && r.action !== "banned-see-more-in-comments-root";
42579 | 649 |     if (!didProgress) noProgress++;
42580 | 650 |     else noProgress = 0;
42581 | 651 | 
42582 | 652 |     console.log(
42583 | 653 |       `[FB][ui:videos] cycle ${i}/${maxCycles} action=${r?.action} acted=${!!r?.acted} noProgress=${noProgress}`
42584 | 654 |     );
42585 | 655 | 
42586 | 656 |     if (noProgress >= 10) {
42587 | 657 |       console.log("[FB][ui:videos] Brak postƒôpu ‚Äì ko≈Ñczƒô ≈Çadowanie.");
42588 | 658 |       break;
42589 | 659 |     }
42590 | 660 | 
42591 | 661 |     // delikatne, ale r√≥≈ºne op√≥≈∫nienia (≈ºeby nie spamowaƒá)
42592 | 662 |     if (r?.action === "more-comments") await sleepRandom(900, 1400);
42593 | 663 |     else if (r?.action === "replies") await sleepRandom(700, 1100);
42594 | 664 |     else await sleepRandom(450, 850);
42595 | 665 |   }
42596 | 666 | 
42597 | 667 |   console.log("[FB][ui:videos] Komentarze wideo za≈Çadowane.");
42598 | 668 | }
42599 | 669 | 
42600 | 670 | /**
42601 | 671 |  * Ekstrahuje komentarze z posta wideo.
42602 | 672 |  */
42603 | 673 | export async function extractComments(page, url) {
42604 | 674 |   const comments = await page.evaluate(() => {
42605 | 675 |     function getCommentId(href) {
42606 | 676 |       try {
42607 | 677 |         const u = new URL(href, location.origin);
42608 | 678 |         const cid = u.searchParams.get("comment_id");
42609 | 679 |         const rid = u.searchParams.get("reply_comment_id");
42610 | 680 |         return rid || cid;
42611 | 681 |       } catch {
42612 | 682 |         return null;
42613 | 683 |       }
42614 | 684 |     }
42615 | 685 | 
42616 | 686 |     const allLinks = Array.from(document.querySelectorAll('a[role="link"]'));
42617 | 687 |     const idToTime = {};
42618 | 688 | 
42619 | 689 |     for (let i = 0; i < allLinks.length; i++) {
42620 | 690 |       const id = getCommentId(allLinks[i].href || "");
42621 | 691 |       if (id) {
42622 | 692 |         for (let j = i + 1; j < i + 5 && j < allLinks.length; j++) {
42623 | 693 |           const txt = allLinks[j]?.textContent?.trim()?.toLowerCase();
42624 | 694 |           if (txt && /^\d+\s*(min|sek|godz|dni|tyg)/.test(txt)) {
42625 | 695 |             idToTime[id] = txt;
42626 | 696 |             break;
42627 | 697 |           }
42628 | 698 |         }
42629 | 699 |       }
42630 | 700 |     }
42631 | 701 | 
42632 | 702 |     const commentBlocks = Array.from(
42633 | 703 |       document.querySelectorAll("div.xwib8y2.xpdmqnj.x1g0dm76.x1y1aw1k")
42634 | 704 |     );
42635 | 705 | 
42636 | 706 |     const data = commentBlocks
42637 | 707 |       .map((node) => {
42638 | 708 |         try {
42639 | 709 |           const author = node.querySelector('a[role="link"] span span')?.textContent?.trim() || null;
42640 | 710 |           const text = node.querySelector('div[dir="auto"]')?.textContent?.trim() || "";
42641 | 711 |           const linkEl = node.querySelector('a[role="link"]');
42642 | 712 |           const href = linkEl?.getAttribute("href");
42643 | 713 |           const permalink = href && !href.startsWith("http") ? `https://www.facebook.com${href}` : href;
42644 | 714 |           const id = permalink ? getCommentId(permalink) : null;
42645 | 715 |           const time = id && idToTime[id] ? idToTime[id] : null;
42646 | 716 | 
42647 | 717 |           if (!author && !text) return null;
42648 | 718 |           return { id, author, text, permalink, time };
42649 | 719 |         } catch {
42650 | 720 |           return null;
42651 | 721 |         }
42652 | 722 |       })
42653 | 723 |       .filter(Boolean);
42654 | 724 | 
42655 | 725 |     return data;
42656 | 726 |   });
42657 | 727 | 
42658 | 728 |   console.log(`[FB][ui:videos] Wyekstrahowano komentarzy: ${comments.length}`);
42659 | 729 |   return comments;
42660 | 730 | }
42661 | 731 | 
42662 | 732 | export async function debugSnapshot(page) {
42663 | 733 |   try {
42664 | 734 |     const path = `snapshot-videos.png`;
42665 | 735 |     await page.screenshot({ path });
42666 | 736 |     console.log(`[FB][ui:videos] Zapisano zrzut ekranu: ${path}`);
42667 | 737 |   } catch (e) {
42668 | 738 |     console.error("[FB][ui:videos] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
42669 | 739 |   }
42670 | 740 | }
42671 | 741 | 
42672 | ```
42673 | 
42674 | ---
42675 | 
42676 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/watch.js`
42677 | **Typ:** JavaScript/tekst  
42678 | **Opis:** Plik projektu (kod/konfiguracja).  
42679 | 
42680 | ```js
42681 |   1 | // src/fb/ui/watch.js
42682 |   2 | import { safeGoto } from "../../utils/navigation.js";
42683 |   3 | import { sleepRandom } from "../../utils/sleep.js";
42684 |   4 | import { acceptCookies, saveCookies } from "../cookies.js";
42685 |   5 | import { fbLogin, checkIfLogged } from "../login.js";
42686 |   6 | import { getUiCommentInfo } from "../uiCommentInfo.js";
42687 |   7 | 
42688 |   8 | /** Typ handlera UI */
42689 |   9 | export const type = "watch";
42690 |  10 | 
42691 |  11 | /** Dopasowanie URL ‚Äì czy jest to link wideo z Facebook Watch. */
42692 |  12 | export function matchesUrl(url) {
42693 |  13 |   try {
42694 |  14 |     const u = new URL(url);
42695 |  15 |     return (u.pathname || "").toLowerCase().includes("/watch");
42696 |  16 |   } catch {
42697 |  17 |     return String(url || "").toLowerCase().includes("/watch");
42698 |  18 |   }
42699 |  19 | }
42700 |  20 | 
42701 |  21 | /* ============================================================
42702 |  22 |    ======================= DEBUG HELPERS ======================
42703 |  23 |    ============================================================ */
42704 |  24 | 
42705 |  25 | const DEBUG_WATCH = String(process.env.DEBUG_WATCH || "true").toLowerCase() !== "false";
42706 |  26 | 
42707 |  27 | async function safeShot(page, path, clip = null) {
42708 |  28 |   if (!DEBUG_WATCH) return;
42709 |  29 |   try {
42710 |  30 |     const opts = clip ? { path, clip } : { path, fullPage: false };
42711 |  31 |     await page.screenshot(opts);
42712 |  32 |     console.log(`[FB][ui:watch][DBG] screenshot -> ${path}`);
42713 |  33 |   } catch (e) {
42714 |  34 |     console.log("[FB][ui:watch][DBG] screenshot failed:", e?.message || e);
42715 |  35 |   }
42716 |  36 | }
42717 |  37 | 
42718 |  38 | async function shotElement(page, handle, path) {
42719 |  39 |   if (!DEBUG_WATCH) return;
42720 |  40 |   try {
42721 |  41 |     if (!handle) return;
42722 |  42 |     const box = await handle.boundingBox().catch(() => null);
42723 |  43 |     if (!box || box.width < 5 || box.height < 5) {
42724 |  44 |       console.log("[FB][ui:watch][DBG] shotElement: no bbox");
42725 |  45 |       return;
42726 |  46 |     }
42727 |  47 |     const clip = {
42728 |  48 |       x: Math.max(0, box.x),
42729 |  49 |       y: Math.max(0, box.y),
42730 |  50 |       width: Math.max(1, Math.min(box.width, 1920)),
42731 |  51 |       height: Math.max(1, Math.min(box.height, 1080)),
42732 |  52 |     };
42733 |  53 |     await safeShot(page, path, clip);
42734 |  54 |   } catch (e) {
42735 |  55 |     console.log("[FB][ui:watch][DBG] shotElement failed:", e?.message || e);
42736 |  56 |   }
42737 |  57 | }
42738 |  58 | 
42739 |  59 | async function debugOuterStats(page, outerHandle) {
42740 |  60 |   if (!DEBUG_WATCH) return null;
42741 |  61 |   if (!outerHandle) return null;
42742 |  62 | 
42743 |  63 |   return page.evaluate((outer) => {
42744 |  64 |     const norm = (s) =>
42745 |  65 |       String(s || "")
42746 |  66 |         .replace(/\u00a0/g, " ")
42747 |  67 |         .replace(/\s+/g, " ")
42748 |  68 |         .trim();
42749 |  69 | 
42750 |  70 |     const r = outer.getBoundingClientRect();
42751 |  71 |     const style = getComputedStyle(outer);
42752 |  72 | 
42753 |  73 |     const articles = Array.from(outer.querySelectorAll("[role='article']"));
42754 |  74 |     const articlesComment = articles.filter((a) => {
42755 |  75 |       const aria = (a.getAttribute("aria-label") || "").toLowerCase();
42756 |  76 |       return aria.includes("komentarz") || aria.includes("comment");
42757 |  77 |     });
42758 |  78 | 
42759 |  79 |     const anchors = Array.from(
42760 |  80 |       outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
42761 |  81 |     );
42762 |  82 | 
42763 |  83 |     const allText = (outer.innerText || "").toLowerCase();
42764 |  84 |     const moreHits =
42765 |  85 |       (allText.match(/wy≈õwietl wiƒôcej komentarzy/g) || []).length +
42766 |  86 |       (allText.match(/zobacz wiƒôcej komentarzy/g) || []).length +
42767 |  87 |       (allText.match(/view more comments/g) || []).length +
42768 |  88 |       (allText.match(/see more comments/g) || []).length;
42769 |  89 | 
42770 |  90 |     // TOP aria-labels (czƒôsto w outer widaƒá czy to powiadomienia / sidebar / komentarze)
42771 |  91 |     const labels = [];
42772 |  92 |     const nodes = Array.from(
42773 |  93 |       outer.querySelectorAll("button,div[role='button'],span[role='button'],a,abbr,[role='article']")
42774 |  94 |     ).slice(0, 4000);
42775 |  95 | 
42776 |  96 |     for (const el of nodes) {
42777 |  97 |       const a = el.getAttribute?.("aria-label");
42778 |  98 |       const t = norm(a);
42779 |  99 |       if (t) labels.push(t);
42780 | 100 |     }
42781 | 101 | 
42782 | 102 |     const freq = new Map();
42783 | 103 |     for (const l of labels) freq.set(l, (freq.get(l) || 0) + 1);
42784 | 104 |     const topLabels = Array.from(freq.entries())
42785 | 105 |       .sort((a, b) => b[1] - a[1])
42786 | 106 |       .slice(0, 15)
42787 | 107 |       .map(([k, v]) => ({ label: k, n: v }));
42788 | 108 | 
42789 | 109 |     return {
42790 | 110 |       tag: outer.tagName,
42791 | 111 |       className: outer.className || "",
42792 | 112 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
42793 | 113 |       style: {
42794 | 114 |         overflowY: style.overflowY,
42795 | 115 |         position: style.position,
42796 | 116 |       },
42797 | 117 |       counts: {
42798 | 118 |         roleArticle: articles.length,
42799 | 119 |         roleArticleComment: articlesComment.length,
42800 | 120 |         anchors: anchors.length,
42801 | 121 |         moreHits,
42802 | 122 |       },
42803 | 123 |       topLabels,
42804 | 124 |     };
42805 | 125 |   }, outerHandle);
42806 | 126 | }
42807 | 127 | 
42808 | 128 | async function debugScrollerStats(page, scrollerHandle) {
42809 | 129 |   if (!DEBUG_WATCH) return null;
42810 | 130 |   if (!scrollerHandle) return null;
42811 | 131 | 
42812 | 132 |   return page.evaluate((s) => {
42813 | 133 |     const r = s.getBoundingClientRect();
42814 | 134 |     const st = getComputedStyle(s);
42815 | 135 |     return {
42816 | 136 |       tag: s.tagName,
42817 | 137 |       className: s.className || "",
42818 | 138 |       rect: { x: r.x, y: r.y, w: r.width, h: r.height },
42819 | 139 |       style: { overflowY: st.overflowY, overflow: st.overflow },
42820 | 140 |       scroll: {
42821 | 141 |         scrollTop: s.scrollTop,
42822 | 142 |         clientHeight: s.clientHeight,
42823 | 143 |         scrollHeight: s.scrollHeight,
42824 | 144 |       },
42825 | 145 |     };
42826 | 146 |   }, scrollerHandle);
42827 | 147 | }
42828 | 148 | 
42829 | 149 | /* ============================================================
42830 | 150 |    ======================= PARSING COUNT =======================
42831 | 151 |    ============================================================ */
42832 | 152 | 
42833 | 153 | function parseCountFromText(str) {
42834 | 154 |   if (!str) return null;
42835 | 155 | 
42836 | 156 |   const raw = String(str)
42837 | 157 |     .toLowerCase()
42838 | 158 |     .replace(/\u00a0/g, " ")
42839 | 159 |     .replace(/\s+/g, " ")
42840 | 160 |     .trim();
42841 | 161 | 
42842 | 162 |   const m = raw.match(/(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/);
42843 | 163 |   if (!m) return null;
42844 | 164 | 
42845 | 165 |   let numStr = (m[1] || "").trim().replace(/\s+/g, "");
42846 | 166 |   const suf = (m[2] || "").trim();
42847 | 167 | 
42848 | 168 |   const hasDecimal = /[.,]\d/.test(numStr);
42849 | 169 |   if (hasDecimal) numStr = numStr.replace(",", ".");
42850 | 170 |   else numStr = numStr.replace(/[.,]/g, "");
42851 | 171 | 
42852 | 172 |   let n = Number(numStr);
42853 | 173 |   if (!Number.isFinite(n)) return null;
42854 | 174 | 
42855 | 175 |   if (suf === "k") n *= 1000;
42856 | 176 |   if (suf === "tys" || suf === "tys.") n *= 1000;
42857 | 177 |   if (suf === "m" || suf === "mln") n *= 1000000;
42858 | 178 | 
42859 | 179 |   n = Math.round(n);
42860 | 180 |   if (n <= 0) return null;
42861 | 181 |   return n;
42862 | 182 | }
42863 | 183 | 
42864 | 184 | function parseBestCommentsCountFromBlob(blobStr) {
42865 | 185 |   if (!blobStr) return null;
42866 | 186 | 
42867 | 187 |   const raw = String(blobStr).replace(/\u00a0/g, " ").replace(/\s+/g, " ").trim();
42868 | 188 |   const re = /(\d[\d\s.,]*)(\s*(tys\.?|k|m|mln)?)\s*(komentarz|komentarzy|comments)\b/gi;
42869 | 189 | 
42870 | 190 |   let best = null;
42871 | 191 |   let match;
42872 | 192 |   while ((match = re.exec(raw)) !== null) {
42873 | 193 |     const candidate = `${match[1]} ${match[2] || ""} ${match[4] || ""}`;
42874 | 194 |     const n = parseCountFromText(candidate);
42875 | 195 |     if (n && (!best || n > best)) best = n;
42876 | 196 |   }
42877 | 197 |   return best;
42878 | 198 | }
42879 | 199 | 
42880 | 200 | /* ============================================================
42881 | 201 |    =================== COMMENTS CONTAINER FIND =================
42882 | 202 |    ============================================================ */
42883 | 203 | 
42884 | 204 | async function findCommentsOuter(page) {
42885 | 205 |   // h2 "Komentarze" / "Comments" -> parent
42886 | 206 |   const h2 = await page
42887 | 207 |     .$x("//h2[normalize-space()='Komentarze' or normalize-space()='Comments']")
42888 | 208 |     .then((arr) => arr?.[0] || null);
42889 | 209 | 
42890 | 210 |   if (!h2) return null;
42891 | 211 | 
42892 | 212 |   const outer = await page.evaluateHandle((node) => {
42893 | 213 |     const isEl = (x) => x && x.nodeType === 1;
42894 | 214 |     let cur = node;
42895 | 215 |     for (let i = 0; i < 10; i++) {
42896 | 216 |       if (!isEl(cur)) break;
42897 | 217 |       const el = cur;
42898 | 218 |       if (el.classList && el.classList.contains("x1jx94hy")) return el;
42899 | 219 |       cur = el.parentElement;
42900 | 220 |     }
42901 | 221 |     return node.parentElement || null;
42902 | 222 |   }, h2);
42903 | 223 | 
42904 | 224 |   const el = outer?.asElement?.() || null;
42905 | 225 |   if (!el) return null;
42906 | 226 | 
42907 | 227 |   const ok = await page.evaluate((o) => o && document.contains(o), el).catch(() => false);
42908 | 228 |   return ok ? el : null;
42909 | 229 | }
42910 | 230 | 
42911 | 231 | async function findScrollableInOuter(page, outerHandle) {
42912 | 232 |   if (!outerHandle) return null;
42913 | 233 | 
42914 | 234 |   const scrollerHandle = await page.evaluateHandle((outer) => {
42915 | 235 |     function isVisible(el) {
42916 | 236 |       if (!el) return false;
42917 | 237 |       const r = el.getBoundingClientRect();
42918 | 238 |       return r.width > 2 && r.height > 2;
42919 | 239 |     }
42920 | 240 | 
42921 | 241 |     function canScroll(el) {
42922 | 242 |       try {
42923 | 243 |         if (!el) return false;
42924 | 244 |         const st = getComputedStyle(el);
42925 | 245 |         const oy = (st.overflowY || "").toLowerCase();
42926 | 246 |         if (!(oy === "auto" || oy === "scroll")) return false;
42927 | 247 |         const h = el.clientHeight || 0;
42928 | 248 |         const sh = el.scrollHeight || 0;
42929 | 249 |         return sh > h + 80;
42930 | 250 |       } catch {
42931 | 251 |         return false;
42932 | 252 |       }
42933 | 253 |     }
42934 | 254 | 
42935 | 255 |     const nodes = Array.from(outer.querySelectorAll("div,section,main,article"))
42936 | 256 |       .filter(isVisible)
42937 | 257 |       .slice(0, 15000);
42938 | 258 | 
42939 | 259 |     let best = null;
42940 | 260 |     let bestScore = -1;
42941 | 261 | 
42942 | 262 |     for (const el of nodes) {
42943 | 263 |       if (!canScroll(el)) continue;
42944 | 264 | 
42945 | 265 |       const delta = (el.scrollHeight || 0) - (el.clientHeight || 0);
42946 | 266 |       const txt = (el.innerText || "").toLowerCase();
42947 | 267 | 
42948 | 268 |       const hasMore =
42949 | 269 |         txt.includes("wy≈õwietl wiƒôcej komentarzy") ||
42950 | 270 |         txt.includes("view more comments") ||
42951 | 271 |         txt.includes("see more comments") ||
42952 | 272 |         txt.includes("zobacz wiƒôcej komentarzy");
42953 | 273 | 
42954 | 274 |       const score = delta + (hasMore ? 100000 : 0);
42955 | 275 |       if (score > bestScore) {
42956 | 276 |         bestScore = score;
42957 | 277 |         best = el;
42958 | 278 |       }
42959 | 279 |     }
42960 | 280 | 
42961 | 281 |     return best || null;
42962 | 282 |   }, outerHandle);
42963 | 283 | 
42964 | 284 |   const el = scrollerHandle?.asElement?.() || null;
42965 | 285 |   if (!el) return null;
42966 | 286 | 
42967 | 287 |   const ok = await page.evaluate((s) => s && document.contains(s), el).catch(() => false);
42968 | 288 |   return ok ? el : null;
42969 | 289 | }
42970 | 290 | 
42971 | 291 | async function clickMoreCommentsIfPresent(page, outerHandle) {
42972 | 292 |   if (!outerHandle) return false;
42973 | 293 | 
42974 | 294 |   const labels = [
42975 | 295 |     "wy≈õwietl wiƒôcej komentarzy",
42976 | 296 |     "zobacz wiƒôcej komentarzy",
42977 | 297 |     "zobacz wcze≈õniejsze komentarze",
42978 | 298 |     "view more comments",
42979 | 299 |     "see more comments",
42980 | 300 |     "show more comments",
42981 | 301 |     "view previous comments",
42982 | 302 |   ];
42983 | 303 | 
42984 | 304 |   const clicked = await page.evaluate(
42985 | 305 |     (outer, labelsArr) => {
42986 | 306 |       const norm = (s) =>
42987 | 307 |         String(s || "")
42988 | 308 |           .replace(/\u00a0/g, " ")
42989 | 309 |           .replace(/\s+/g, " ")
42990 | 310 |           .trim()
42991 | 311 |           .toLowerCase();
42992 | 312 | 
42993 | 313 |       const isVisible = (el) => {
42994 | 314 |         if (!el) return false;
42995 | 315 |         const r = el.getBoundingClientRect();
42996 | 316 |         return r.width > 2 && r.height > 2;
42997 | 317 |       };
42998 | 318 | 
42999 | 319 |       const nodes = Array.from(
43000 | 320 |         outer.querySelectorAll("button, div[role='button'], span[role='button'], a, span")
43001 | 321 |       ).filter(isVisible);
43002 | 322 | 
43003 | 323 |       for (const el of nodes) {
43004 | 324 |         const t = norm(el.getAttribute("aria-label") || el.textContent || "");
43005 | 325 |         if (!t) continue;
43006 | 326 |         if (labelsArr.some((x) => t.includes(x))) {
43007 | 327 |           try {
43008 | 328 |             el.scrollIntoView({ block: "center" });
43009 | 329 |           } catch {}
43010 | 330 |           const clickable =
43011 | 331 |             el.closest?.("button,a,div[role='button'],span[role='button']") || el;
43012 | 332 |           try {
43013 | 333 |             clickable.click();
43014 | 334 |             return true;
43015 | 335 |           } catch {}
43016 | 336 |         }
43017 | 337 |       }
43018 | 338 |       return false;
43019 | 339 |     },
43020 | 340 |     outerHandle,
43021 | 341 |     labels
43022 | 342 |   );
43023 | 343 | 
43024 | 344 |   return !!clicked;
43025 | 345 | }
43026 | 346 | 
43027 | 347 | async function getVisibleCommentCount(page, outerHandle) {
43028 | 348 |   if (!outerHandle) return 0;
43029 | 349 |   return page
43030 | 350 |     .evaluate((outer) => {
43031 | 351 |       const articles = Array.from(outer.querySelectorAll("[role='article']"));
43032 | 352 |       let count = 0;
43033 | 353 |       for (const a of articles) {
43034 | 354 |         const aria = (a.getAttribute("aria-label") || "").toLowerCase();
43035 | 355 |         if (aria.includes("komentarz") || aria.includes("comment")) count++;
43036 | 356 |       }
43037 | 357 |       return count;
43038 | 358 |     }, outerHandle)
43039 | 359 |     .catch(() => 0);
43040 | 360 | }
43041 | 361 | 
43042 | 362 | async function getAnchorsCount(page, outerHandle) {
43043 | 363 |   if (!outerHandle) return 0;
43044 | 364 |   return page
43045 | 365 |     .evaluate((outer) => {
43046 | 366 |       const as = Array.from(
43047 | 367 |         outer.querySelectorAll("a[href*='comment_id'], a[href*='reply_comment_id']")
43048 | 368 |       );
43049 | 369 |       const ids = new Set();
43050 | 370 |       for (const a of as) {
43051 | 371 |         try {
43052 | 372 |           const u = new URL(a.href, location.origin);
43053 | 373 |           const id = u.searchParams.get("reply_comment_id") || u.searchParams.get("comment_id");
43054 | 374 |           if (id) ids.add(id);
43055 | 375 |         } catch {}
43056 | 376 |       }
43057 | 377 |       return ids.size;
43058 | 378 |     }, outerHandle)
43059 | 379 |     .catch(() => 0);
43060 | 380 | }
43061 | 381 | 
43062 | 382 | /* ============================================================
43063 | 383 |    ============================ API ============================
43064 | 384 |    ============================================================ */
43065 | 385 | 
43066 | 386 | /**
43067 | 387 |  * Przygotowanie strony dla wideo w Watch.
43068 | 388 |  * ZASADA: nic nie klikamy poza UI Watch.
43069 | 389 |  */
43070 | 390 | export async function prepare(page, url) {
43071 | 391 |   console.log(`[FB][ui:watch] Otwieranie wideo (Watch): ${url}`);
43072 | 392 |   const ok = await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
43073 | 393 |   if (!ok) throw new Error("safeGoto-failed");
43074 | 394 | 
43075 | 395 |   await acceptCookies(page, "watch-initial");
43076 | 396 | 
43077 | 397 |   const currentUrl = page.url();
43078 | 398 |   if (currentUrl.includes("/login")) {
43079 | 399 |     console.log("[FB][ui:watch] Wymagane logowanie do Facebook ‚Äì logujƒô...");
43080 | 400 |     await fbLogin(page);
43081 | 401 |     await sleepRandom(3000, 4500);
43082 | 402 |     const loggedAfterLogin = await checkIfLogged(page).catch(() => false);
43083 | 403 |     console.log(
43084 | 404 |       `[FB][ui:watch] Stan sesji po fbLogin: ${loggedAfterLogin ? "ZALOGOWANY" : "NIEZALOGOWANY"}`
43085 | 405 |     );
43086 | 406 |     if (loggedAfterLogin) {
43087 | 407 |       await safeGoto(page, url, "watch", { waitUntil: "networkidle2", timeout: 90000 });
43088 | 408 |       await acceptCookies(page, "watch-post-login");
43089 | 409 |     } else {
43090 | 410 |       console.log("[FB][ui:watch] Logowanie nie powiod≈Ço siƒô ‚Äì kontynuujƒô bez sesji.");
43091 | 411 |     }
43092 | 412 |   } else {
43093 | 413 |     const logged = await checkIfLogged(page).catch(() => false);
43094 | 414 |     if (!logged) {
43095 | 415 |       console.log("[FB][ui:watch] Brak sesji ‚Äì fbLogin().");
43096 | 416 |       await fbLogin(page);
43097 | 417 |       await sleepRandom(3000, 4500);
43098 | 418 |       await acceptCookies(page, "watch-after-login");
43099 | 419 |       const logged2 = await checkIfLogged(page).catch(() => false);
43100 | 420 |       console.log(`[FB][ui:watch] Stan sesji po fbLogin: ${logged2 ? "ZALOGOWANY" : "NIEZALOGOWANY"}`);
43101 | 421 |     }
43102 | 422 |   }
43103 | 423 | 
43104 | 424 |   try {
43105 | 425 |     const loggedFinal = await checkIfLogged(page).catch(() => false);
43106 | 426 |     if (loggedFinal) await saveCookies(page);
43107 | 427 |   } catch {}
43108 | 428 | 
43109 | 429 |   await acceptCookies(page, "watch");
43110 | 430 | 
43111 | 431 |   // pauza wideo (bez klikania UI)
43112 | 432 |   try {
43113 | 433 |     await page.evaluate(() => {
43114 | 434 |       const vids = Array.from(document.querySelectorAll("video"));
43115 | 435 |       for (const v of vids) {
43116 | 436 |         try {
43117 | 437 |           v.autoplay = false;
43118 | 438 |           v.removeAttribute("autoplay");
43119 | 439 |           v.muted = true;
43120 | 440 |           v.pause();
43121 | 441 |           if (!isNaN(v.currentTime) && v.currentTime === 0) v.currentTime = 0.01;
43122 | 442 |         } catch {}
43123 | 443 |       }
43124 | 444 |     });
43125 | 445 |     console.log("[FB][ui:watch] Wideo wstrzymane (pause).");
43126 | 446 |   } catch (e) {
43127 | 447 |     console.log("[FB][ui:watch] B≈ÇƒÖd wstrzymania wideo:", e?.message || e);
43128 | 448 |   }
43129 | 449 | 
43130 | 450 |   if (DEBUG_WATCH) {
43131 | 451 |     await safeShot(page, "watch-prepare.png");
43132 | 452 |   }
43133 | 453 | }
43134 | 454 | 
43135 | 455 | /**
43136 | 456 |  * Pobiera liczbƒô komentarzy dla wideo (Watch).
43137 | 457 |  */
43138 | 458 | export async function getCommentCount(page, url) {
43139 | 459 |   const uiInfo = await getUiCommentInfo(page).catch(() => null);
43140 | 460 |   console.log(`[FB][ui:watch][DBG] UI info:`, {
43141 | 461 |     source: uiInfo?.source,
43142 | 462 |     raw: uiInfo?.raw ? String(uiInfo.raw).slice(0, 250) + "..." : null,
43143 | 463 |     viewType: uiInfo?.viewType,
43144 | 464 |     comments: uiInfo?.comments,
43145 | 465 |   });
43146 | 466 | 
43147 | 467 |   let totalComments = null;
43148 | 468 | 
43149 | 469 |   if (uiInfo && typeof uiInfo.comments === "number" && uiInfo.comments > 0) {
43150 | 470 |     totalComments = uiInfo.comments;
43151 | 471 |   } else if (uiInfo?.raw) {
43152 | 472 |     const parsed = parseBestCommentsCountFromBlob(uiInfo.raw);
43153 | 473 |     if (parsed) {
43154 | 474 |       totalComments = parsed;
43155 | 475 |       console.log(`[FB][ui:watch][DBG] Parsed from uiInfo.raw => ${parsed}`);
43156 | 476 |     }
43157 | 477 |   }
43158 | 478 | 
43159 | 479 |   console.log(`[FB][ui:watch] Liczba komentarzy wg UI: ${totalComments !== null ? totalComments : "brak danych"}`);
43160 | 480 |   return totalComments;
43161 | 481 | }
43162 | 482 | 
43163 | 483 | /**
43164 | 484 |  * Wczytuje wszystkie komentarze w trybie Watch.
43165 | 485 |  * -> jedyne kliki: "Wy≈õwietl wiƒôcej komentarzy"
43166 | 486 |  * -> scroll: wheel na kontenerze komentarzy
43167 | 487 |  */
43168 | 488 | export async function loadAllComments(page, { expectedTotal } = {}) {
43169 | 489 |   console.log("[FB][ui:watch] ≈Åadujƒô wszystkie komentarze (Watch)...");
43170 | 490 | 
43171 | 491 |   let maxCycles = 40;
43172 | 492 |   if (typeof expectedTotal === "number" && expectedTotal > 0) {
43173 | 493 |     maxCycles = Math.min(Math.max(30, Math.ceil(expectedTotal / 6)), 140);
43174 | 494 |   }
43175 | 495 |   console.log(`[FB][ui:watch] Rozpoczynam sekwencyjne ≈Çadowanie komentarzy, maxCycles=${maxCycles}.`);
43176 | 496 | 
43177 | 497 |   const outer = await findCommentsOuter(page);
43178 | 498 |   if (!outer) {
43179 | 499 |     console.log("[FB][ui:watch][DBG] OUTER NOT FOUND -> return");
43180 | 500 |     if (DEBUG_WATCH) await safeShot(page, "watch-no-outer.png");
43181 | 501 |     return;
43182 | 502 |   }
43183 | 503 | 
43184 | 504 |   if (DEBUG_WATCH) {
43185 | 505 |     const stats = await debugOuterStats(page, outer);
43186 | 506 |     console.log("[FB][ui:watch][DBG] OUTER stats:", stats);
43187 | 507 |     await shotElement(page, outer, "watch-outer.png");
43188 | 508 |   }
43189 | 509 | 
43190 | 510 |   const scroller = await findScrollableInOuter(page, outer);
43191 | 511 |   if (!scroller) {
43192 | 512 |     console.log("[FB][ui:watch][DBG] SCROLLER NOT FOUND -> return");
43193 | 513 |     if (DEBUG_WATCH) {
43194 | 514 |       const stats = await debugOuterStats(page, outer);
43195 | 515 |       console.log("[FB][ui:watch][DBG] OUTER stats (no scroller):", stats);
43196 | 516 |       await safeShot(page, "watch-no-scroller.png");
43197 | 517 |     }
43198 | 518 |     return;
43199 | 519 |   }
43200 | 520 | 
43201 | 521 |   if (DEBUG_WATCH) {
43202 | 522 |     const sstats = await debugScrollerStats(page, scroller);
43203 | 523 |     console.log("[FB][ui:watch][DBG] SCROLLER stats:", sstats);
43204 | 524 |     await shotElement(page, scroller, "watch-scroller.png");
43205 | 525 |   }
43206 | 526 | 
43207 | 527 |   let prevArticles = await getVisibleCommentCount(page, outer);
43208 | 528 |   let prevAnchors = await getAnchorsCount(page, outer);
43209 | 529 |   let noProgress = 0;
43210 | 530 | 
43211 | 531 |   for (let cycle = 1; cycle <= maxCycles; cycle++) {
43212 | 532 |     const clicked = await clickMoreCommentsIfPresent(page, outer);
43213 | 533 | 
43214 | 534 |     // scrollTop before/after
43215 | 535 |     let beforeST = 0;
43216 | 536 |     let afterST = 0;
43217 | 537 |     try {
43218 | 538 |       beforeST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
43219 | 539 |     } catch {}
43220 | 540 | 
43221 | 541 |     let wheeled = false;
43222 | 542 |     try {
43223 | 543 |       const box = await scroller.boundingBox();
43224 | 544 |       if (box && box.width > 5 && box.height > 5) {
43225 | 545 |         await page.mouse.move(box.x + box.width / 2, box.y + Math.min(80, box.height / 2));
43226 | 546 |         await page.mouse.wheel({ deltaY: Math.max(500, Math.floor(box.height * 0.9)) });
43227 | 547 |         wheeled = true;
43228 | 548 |       }
43229 | 549 |     } catch {}
43230 | 550 | 
43231 | 551 |     await sleepRandom(450, 850);
43232 | 552 | 
43233 | 553 |     try {
43234 | 554 |       afterST = await page.evaluate((s) => s.scrollTop || 0, scroller).catch(() => 0);
43235 | 555 |     } catch {}
43236 | 556 | 
43237 | 557 |     const curArticles = await getVisibleCommentCount(page, outer);
43238 | 558 |     const curAnchors = await getAnchorsCount(page, outer);
43239 | 559 | 
43240 | 560 |     const progressed = curArticles > prevArticles || curAnchors > prevAnchors;
43241 | 561 | 
43242 | 562 |     if (progressed) {
43243 | 563 |       prevArticles = curArticles;
43244 | 564 |       prevAnchors = curAnchors;
43245 | 565 |       noProgress = 0;
43246 | 566 |     } else {
43247 | 567 |       noProgress++;
43248 | 568 |     }
43249 | 569 | 
43250 | 570 |     console.log(
43251 | 571 |       `[FB][ui:watch][DBG] cycle ${cycle}/${maxCycles}: clickedMore=${clicked}, wheel=${wheeled}, scrollTop ${beforeST} -> ${afterST}, articles=${curArticles}, anchors=${curAnchors}, noProgress=${noProgress}`
43252 | 572 |     );
43253 | 573 | 
43254 | 574 |     if (DEBUG_WATCH && cycle === 5) {
43255 | 575 |       await safeShot(page, "watch-after-5.png");
43256 | 576 |     }
43257 | 577 | 
43258 | 578 |     if (noProgress >= 6) {
43259 | 579 |       console.log("[FB][ui:watch] Brak postƒôpu przez kilka cykli ‚Äì przerywam.");
43260 | 580 |       if (DEBUG_WATCH) await safeShot(page, "watch-stuck.png");
43261 | 581 |       break;
43262 | 582 |     }
43263 | 583 |   }
43264 | 584 | 
43265 | 585 |   console.log("[FB][ui:watch] Za≈Çadowano wszystkie dostƒôpne komentarze (Watch).");
43266 | 586 | }
43267 | 587 | 
43268 | 588 | /**
43269 | 589 |  * Ekstrahuje komentarze spod wideo (Watch).
43270 | 590 |  * (szerszy selektor: role=article + aria-label)
43271 | 591 |  */
43272 | 592 | export async function extractComments(page, url) {
43273 | 593 |   const comments = await page.evaluate(() => {
43274 | 594 |     function getCommentId(href) {
43275 | 595 |       try {
43276 | 596 |         const u = new URL(href, location.origin);
43277 | 597 |         const cid = u.searchParams.get("comment_id");
43278 | 598 |         const rid = u.searchParams.get("reply_comment_id");
43279 | 599 |         return rid || cid;
43280 | 600 |       } catch {
43281 | 601 |         return null;
43282 | 602 |       }
43283 | 603 |     }
43284 | 604 | 
43285 | 605 |     function pickText(el) {
43286 | 606 |       if (!el) return "";
43287 | 607 |       return (el.textContent || "")
43288 | 608 |         .replace(/\u00a0/g, " ")
43289 | 609 |         .replace(/\s+/g, " ")
43290 | 610 |         .trim();
43291 | 611 |     }
43292 | 612 | 
43293 | 613 |     const articles = Array.from(document.querySelectorAll("[role='article']")).filter((a) => {
43294 | 614 |       const aria = (a.getAttribute("aria-label") || "").toLowerCase();
43295 | 615 |       return aria.includes("komentarz") || aria.includes("comment");
43296 | 616 |     });
43297 | 617 | 
43298 | 618 |     const out = [];
43299 | 619 | 
43300 | 620 |     for (const art of articles) {
43301 | 621 |       try {
43302 | 622 |         const linkEl = art.querySelector("a[href*='comment_id='], a[href*='reply_comment_id=']");
43303 | 623 |         const href = linkEl?.href || null;
43304 | 624 |         const id = href ? getCommentId(href) : null;
43305 | 625 | 
43306 | 626 |         const author =
43307 | 627 |           pickText(art.querySelector("a[role='link'] span")) ||
43308 | 628 |           pickText(art.querySelector("strong")) ||
43309 | 629 |           null;
43310 | 630 | 
43311 | 631 |         let text = "";
43312 | 632 |         const autos = Array.from(art.querySelectorAll("[dir='auto']")).map(pickText).filter(Boolean);
43313 | 633 |         if (autos.length) {
43314 | 634 |           text = autos.length >= 2 ? autos[autos.length - 1] : autos[0];
43315 | 635 |         }
43316 | 636 | 
43317 | 637 |         const permalink = href || null;
43318 | 638 |         if (!author && !text) continue;
43319 | 639 | 
43320 | 640 |         out.push({ id, author, text, permalink, time: null });
43321 | 641 |       } catch {}
43322 | 642 |     }
43323 | 643 | 
43324 | 644 |     return out;
43325 | 645 |   });
43326 | 646 | 
43327 | 647 |   console.log(`[FB][ui:watch] Wyekstrahowano komentarzy: ${comments.length}`);
43328 | 648 |   return comments;
43329 | 649 | }
43330 | 650 | 
43331 | 651 | export async function debugSnapshot(page) {
43332 | 652 |   try {
43333 | 653 |     const path = `snapshot-watch.png`;
43334 | 654 |     await page.screenshot({ path });
43335 | 655 |     console.log(`[FB][ui:watch] Zapisano zrzut ekranu: ${path}`);
43336 | 656 |   } catch (e) {
43337 | 657 |     console.error("[FB][ui:watch] B≈ÇƒÖd zapisu zrzutu ekranu:", e);
43338 | 658 |   }
43339 | 659 | }
43340 | 660 | 
43341 | ```
43342 | 
43343 | ---
43344 | 
43345 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/watcher.js`
43346 | **Typ:** JavaScript/tekst  
43347 | **Opis:** G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.  
43348 | 
43349 | ```js
43350 |   1 | // src/watcher.js
43351 |   2 | import puppeteer from "puppeteer";
43352 |   3 | import fs from "fs";
43353 |   4 | import path from "path";
43354 |   5 | import {
43355 |   6 |   EXPAND_COMMENTS,
43356 |   7 |   CHECK_INTERVAL_MS,
43357 |   8 |   POSTS_SHEET_URL,
43358 |   9 |   POSTS_REFRESH_MS,
43359 |  10 | } from "./config.js";
43360 |  11 | 
43361 |  12 | import {
43362 |  13 |   prepare,
43363 |  14 |   getCommentCount,
43364 |  15 |   loadAllComments,
43365 |  16 |   extractCommentsData,
43366 |  17 | } from "./fb/comments.js";
43367 |  18 | 
43368 |  19 | import { loadCookies, saveCookies } from "./fb/cookies.js";
43369 |  20 | import { checkIfLogged, fbLogin } from "./fb/login.js";
43370 |  21 | import { sendWebhook } from "./webhook.js";
43371 |  22 | import { loadCache, saveCache } from "./db/cache.js";
43372 |  23 | 
43373 |  24 | /**
43374 |  25 |  * ≈πR√ìD≈ÅO POST√ìW (PRIMARY): panel => data/posts.json
43375 |  26 |  * Fallback: Google Sheets CSV (POSTS_SHEET_URL)
43376 |  27 |  *
43377 |  28 |  * Mo≈ºesz nadpisaƒá ≈õcie≈ºkƒô:
43378 |  29 |  * POSTS_FILE=C:\Projekty vs\FB_Watcher\data\posts.json
43379 |  30 |  */
43380 |  31 | const POSTS_FILE =
43381 |  32 |   process.env.POSTS_FILE ||
43382 |  33 |   path.join(process.cwd(), "data", "posts.json");
43383 |  34 | 
43384 |  35 | /**
43385 |  36 |  * CACHE DYSKOWY:
43386 |  37 |  * {
43387 |  38 |  *   "<url>": { lastCount: 29, knownIds: ["123","456"] }
43388 |  39 |  * }
43389 |  40 |  */
43390 |  41 | const commentsCache = loadCache();
43391 |  42 | const lastCounts = new Map(); // url -> lastCount
43392 |  43 | const knownCommentsPerPost = new Map(); // url -> Set(knownIds)
43393 |  44 | 
43394 |  45 | for (const [url, entry] of Object.entries(commentsCache)) {
43395 |  46 |   if (typeof entry?.lastCount === "number") lastCounts.set(url, entry.lastCount);
43396 |  47 |   if (Array.isArray(entry?.knownIds))
43397 |  48 |     knownCommentsPerPost.set(url, new Set(entry.knownIds));
43398 |  49 | }
43399 |  50 | 
43400 |  51 | let currentPosts = [];
43401 |  52 | let lastRefreshAny = 0; // wsp√≥lny zegar od≈õwie≈ºania ≈∫r√≥de≈Ç
43402 |  53 | 
43403 |  54 | let navErrorCount = 0;
43404 |  55 | const MAX_NAV_ERRORS = 5;
43405 |  56 | 
43406 |  57 | function isNavigationError(err) {
43407 |  58 |   if (!err) return false;
43408 |  59 |   const msg = String(err.message || err).toLowerCase();
43409 |  60 |   return (
43410 |  61 |     msg.includes("safegoto-failed") ||
43411 |  62 |     msg.includes("navigation timeout") ||
43412 |  63 |     msg.includes("net::err_connection_timed_out") ||
43413 |  64 |     msg.includes("net::err_timed_out")
43414 |  65 |   );
43415 |  66 | }
43416 |  67 | 
43417 |  68 | /* ============================================================
43418 |  69 |    ===============   STEALTH / UKRYWANIE BOTA   ===============
43419 |  70 |    ============================================================ */
43420 |  71 | 
43421 |  72 | async function applyStealth(page) {
43422 |  73 |   await page.evaluateOnNewDocument(() => {
43423 |  74 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
43424 |  75 |     // @ts-ignore
43425 |  76 |     window.chrome = window.chrome || { runtime: {} };
43426 |  77 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
43427 |  78 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
43428 |  79 | 
43429 |  80 |     const permissions = window.navigator.permissions;
43430 |  81 |     if (permissions && permissions.query) {
43431 |  82 |       const originalQuery = permissions.query.bind(permissions);
43432 |  83 |       permissions.query = (parameters) => {
43433 |  84 |         if (
43434 |  85 |           parameters &&
43435 |  86 |           parameters.name === "notifications" &&
43436 |  87 |           window.Notification
43437 |  88 |         ) {
43438 |  89 |           return Promise.resolve({ state: window.Notification.permission });
43439 |  90 |         }
43440 |  91 |         return originalQuery(parameters);
43441 |  92 |       };
43442 |  93 |     }
43443 |  94 |   });
43444 |  95 | }
43445 |  96 | 
43446 |  97 | /* ============================================================
43447 |  98 |    ===============   PANEL POSTS (data/posts.json)   ===========
43448 |  99 |    ============================================================ */
43449 | 100 | 
43450 | 101 | function safeJsonParse(s) {
43451 | 102 |   try {
43452 | 103 |     return { ok: true, value: JSON.parse(s) };
43453 | 104 |   } catch (e) {
43454 | 105 |     return { ok: false, error: e?.message || "Invalid JSON" };
43455 | 106 |   }
43456 | 107 | }
43457 | 108 | 
43458 | 109 | function normalizeUrl(u) {
43459 | 110 |   if (!u) return "";
43460 | 111 |   const x = String(u).trim();
43461 | 112 |   if (!/^https?:\/\/.+/i.test(x)) return "";
43462 | 113 |   return x;
43463 | 114 | }
43464 | 115 | 
43465 | 116 | function readPanelPosts() {
43466 | 117 |   try {
43467 | 118 |     if (!fs.existsSync(POSTS_FILE)) {
43468 | 119 |       return { ok: false, error: "posts.json nie istnieje", posts: [], path: POSTS_FILE };
43469 | 120 |     }
43470 | 121 |     const raw = fs.readFileSync(POSTS_FILE, "utf8").trim();
43471 | 122 |     if (!raw) {
43472 | 123 |       return { ok: false, error: "posts.json jest pusty", posts: [], path: POSTS_FILE };
43473 | 124 |     }
43474 | 125 |     const parsed = safeJsonParse(raw);
43475 | 126 |     if (!parsed.ok || !Array.isArray(parsed.value)) {
43476 | 127 |       return { ok: false, error: "posts.json ma z≈Çy format (expected array)", posts: [], path: POSTS_FILE };
43477 | 128 |     }
43478 | 129 | 
43479 | 130 |     const posts = parsed.value
43480 | 131 |       .map((p) => {
43481 | 132 |         const url = normalizeUrl(p?.url);
43482 | 133 |         const active = Boolean(p?.active);
43483 | 134 |         if (!url) return null;
43484 | 135 |         return {
43485 | 136 |           id: String(p?.id || url),
43486 | 137 |           url,
43487 | 138 |           active,
43488 | 139 |           name: p?.name ? String(p.name) : "",
43489 | 140 |           image: p?.image ? String(p.image) : "",
43490 | 141 |           description: p?.description ? String(p.description) : "",
43491 | 142 |         };
43492 | 143 |       })
43493 | 144 |       .filter(Boolean);
43494 | 145 | 
43495 | 146 |     const activePosts = posts.filter((p) => p.active);
43496 | 147 |     return { ok: true, posts: activePosts, total: posts.length, path: POSTS_FILE };
43497 | 148 |   } catch (e) {
43498 | 149 |     return { ok: false, error: e?.message || "B≈ÇƒÖd czytania posts.json", posts: [], path: POSTS_FILE };
43499 | 150 |   }
43500 | 151 | }
43501 | 152 | 
43502 | 153 | /* ============================================================
43503 | 154 |    ===============   GOOGLE SHEETS ‚Äì PARSOWANIE   =============
43504 | 155 |    ============================================================ */
43505 | 156 | 
43506 | 157 | function parseSheetCsv(text) {
43507 | 158 |   const lines = text
43508 | 159 |     .split(/\r?\n/)
43509 | 160 |     .map((l) => l.trim())
43510 | 161 |     .filter((l) => l.length > 0);
43511 | 162 | 
43512 | 163 |   if (!lines.length) {
43513 | 164 |     console.warn("[Sheet] Pusty CSV z arkusza.");
43514 | 165 |     return [];
43515 | 166 |   }
43516 | 167 | 
43517 | 168 |   const header = lines[0].split(",").map((h) => h.trim().toLowerCase());
43518 | 169 | 
43519 | 170 |   const idxUrl = header.findIndex((h) => h === "url");
43520 | 171 |   const idxActive = header.findIndex((h) => h === "active");
43521 | 172 | 
43522 | 173 |   // nowe kolumny od klienta
43523 | 174 |   const idxName = header.findIndex((h) => h === "name" || h === "nazwa");
43524 | 175 |   const idxImage = header.findIndex((h) => h === "image" || h === "img" || h === "photo" || h === "zdjecie");
43525 | 176 |   const idxDesc = header.findIndex((h) => h === "description" || h === "desc" || h === "opis");
43526 | 177 | 
43527 | 178 |   if (idxUrl === -1) {
43528 | 179 |     console.error('[Sheet] Brak kolumny "url" w arkuszu.');
43529 | 180 |     return [];
43530 | 181 |   }
43531 | 182 | 
43532 | 183 |   const posts = [];
43533 | 184 | 
43534 | 185 |   for (let i = 1; i < lines.length; i++) {
43535 | 186 |     const row = lines[i].split(",");
43536 | 187 |     const rawUrl = (row[idxUrl] || "").trim();
43537 | 188 |     if (!rawUrl) continue;
43538 | 189 | 
43539 | 190 |     const activeRaw = idxActive !== -1 ? (row[idxActive] || "").trim() : "";
43540 | 191 |     const activeNorm = activeRaw.toLowerCase();
43541 | 192 |     const isActive =
43542 | 193 |       idxActive === -1 ? true : ["true", "1", "yes", "tak", "y"].includes(activeNorm);
43543 | 194 | 
43544 | 195 |     if (!isActive) continue;
43545 | 196 | 
43546 | 197 |     const name = idxName !== -1 ? (row[idxName] || "").trim() : "";
43547 | 198 |     const image = idxImage !== -1 ? (row[idxImage] || "").trim() : "";
43548 | 199 |     const description = idxDesc !== -1 ? (row[idxDesc] || "").trim() : "";
43549 | 200 | 
43550 | 201 |     posts.push({
43551 | 202 |       id: `sheet-${i}`,
43552 | 203 |       url: rawUrl,
43553 | 204 |       name,
43554 | 205 |       image,
43555 | 206 |       description,
43556 | 207 |     });
43557 | 208 |   }
43558 | 209 | 
43559 | 210 |   return posts;
43560 | 211 | }
43561 | 212 | 
43562 | 213 | /* ============================================================
43563 | 214 |    ===============   POSTS REFRESH (PANEL -> SHEETS)   =========
43564 | 215 |    ============================================================ */
43565 | 216 | 
43566 | 217 | async function refreshPostsIfNeeded(force = false) {
43567 | 218 |   const now = Date.now();
43568 | 219 |   if (!force && now - lastRefreshAny < POSTS_REFRESH_MS) return;
43569 | 220 |   lastRefreshAny = now;
43570 | 221 | 
43571 | 222 |   // 1) PRIMARY: panel posts.json
43572 | 223 |   const panel = readPanelPosts();
43573 | 224 |   if (panel.ok && panel.posts.length > 0) {
43574 | 225 |     const newPosts = panel.posts;
43575 | 226 | 
43576 | 227 |     const oldJson = JSON.stringify(currentPosts);
43577 | 228 |     const newJson = JSON.stringify(newPosts);
43578 | 229 | 
43579 | 230 |     if (oldJson !== newJson) {
43580 | 231 |       console.log(
43581 | 232 |         `[Posts] ≈πr√≥d≈Ço: PANEL (${panel.path}) ‚Üí aktywne: ${newPosts.length} (≈ÇƒÖcznie w pliku: ${panel.total})`
43582 | 233 |       );
43583 | 234 |       currentPosts = newPosts;
43584 | 235 |     } else {
43585 | 236 |       console.log(`[Posts] PANEL bez zmian (${newPosts.length} aktywnych).`);
43586 | 237 |     }
43587 | 238 |     return;
43588 | 239 |   }
43589 | 240 | 
43590 | 241 |   console.log(
43591 | 242 |     `[Posts] PANEL nie da≈Ç aktywnych post√≥w (${panel.path}) ‚Üí fallback: Sheets`
43592 | 243 |   );
43593 | 244 | 
43594 | 245 |   // 2) FALLBACK: Sheets
43595 | 246 |   if (!POSTS_SHEET_URL) {
43596 | 247 |     console.warn(
43597 | 248 |       "[Sheet] POSTS_SHEET_URL nie ustawiony ‚Äì brak ≈∫r√≥d≈Ça post√≥w z arkusza."
43598 | 249 |     );
43599 | 250 |     currentPosts = [];
43600 | 251 |     return;
43601 | 252 |   }
43602 | 253 | 
43603 | 254 |   console.log("[Sheet] Od≈õwie≈ºam listƒô post√≥w z Google Sheets...");
43604 | 255 | 
43605 | 256 |   try {
43606 | 257 |     const res = await fetch(POSTS_SHEET_URL);
43607 | 258 |     if (!res.ok) {
43608 | 259 |       console.error(
43609 | 260 |         "[Sheet] B≈ÇƒÖd HTTP przy pobieraniu CSV:",
43610 | 261 |         res.status,
43611 | 262 |         res.statusText
43612 | 263 |       );
43613 | 264 |       currentPosts = [];
43614 | 265 |       return;
43615 | 266 |     }
43616 | 267 | 
43617 | 268 |     const csvText = await res.text();
43618 | 269 |     const newPosts = parseSheetCsv(csvText);
43619 | 270 | 
43620 | 271 |     if (!newPosts.length) {
43621 | 272 |       console.warn(
43622 | 273 |         "[Sheet] Arkusz nie zwr√≥ci≈Ç ≈ºadnych AKTYWNYCH post√≥w (sprawd≈∫ active / TRUE)."
43623 | 274 |       );
43624 | 275 |       currentPosts = [];
43625 | 276 |       return;
43626 | 277 |     }
43627 | 278 | 
43628 | 279 |     const oldJson = JSON.stringify(currentPosts);
43629 | 280 |     const newJson = JSON.stringify(newPosts);
43630 | 281 | 
43631 | 282 |     if (oldJson !== newJson) {
43632 | 283 |       console.log(
43633 | 284 |         `[Sheet] Lista post√≥w zmieniona ‚Äì by≈Ço ${currentPosts.length}, teraz ${newPosts.length}.`
43634 | 285 |       );
43635 | 286 |       currentPosts = newPosts;
43636 | 287 |     } else {
43637 | 288 |       console.log("[Sheet] Lista post√≥w bez zmian.");
43638 | 289 |     }
43639 | 290 |   } catch (err) {
43640 | 291 |     console.error(
43641 | 292 |       "[Sheet] B≈ÇƒÖd przy pobieraniu/parsowaniu CSV:",
43642 | 293 |       err.message
43643 | 294 |     );
43644 | 295 |     currentPosts = [];
43645 | 296 |   }
43646 | 297 | }
43647 | 298 | 
43648 | 299 | /* ============================================================
43649 | 300 |    =====================   CACHE HELPERS   =====================
43650 | 301 |    ============================================================ */
43651 | 302 | 
43652 | 303 | function getCacheKey(post) {
43653 | 304 |   return post.url;
43654 | 305 | }
43655 | 306 | 
43656 | 307 | function getKnownSetForPost(cacheKey) {
43657 | 308 |   let set = knownCommentsPerPost.get(cacheKey);
43658 | 309 |   if (!set) {
43659 | 310 |     const entry = commentsCache[cacheKey];
43660 | 311 |     set =
43661 | 312 |       entry && Array.isArray(entry.knownIds) ? new Set(entry.knownIds) : new Set();
43662 | 313 |     knownCommentsPerPost.set(cacheKey, set);
43663 | 314 |   }
43664 | 315 |   return set;
43665 | 316 | }
43666 | 317 | 
43667 | 318 | function flushCacheToDisk() {
43668 | 319 |   const out = { ...commentsCache };
43669 | 320 | 
43670 | 321 |   for (const [cacheKey, count] of lastCounts.entries()) {
43671 | 322 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
43672 | 323 |     out[cacheKey].lastCount = count;
43673 | 324 |   }
43674 | 325 | 
43675 | 326 |   for (const [cacheKey, set] of knownCommentsPerPost.entries()) {
43676 | 327 |     if (!out[cacheKey]) out[cacheKey] = { lastCount: 0, knownIds: [] };
43677 | 328 |     out[cacheKey].knownIds = Array.from(set);
43678 | 329 |   }
43679 | 330 | 
43680 | 331 |   Object.keys(commentsCache).forEach((k) => delete commentsCache[k]);
43681 | 332 |   Object.assign(commentsCache, out);
43682 | 333 |   saveCache(out);
43683 | 334 | }
43684 | 335 | 
43685 | 336 | /* ============================================================
43686 | 337 |    =====================   G≈Å√ìWNY WATCHER   ===================
43687 | 338 |    ============================================================ */
43688 | 339 | 
43689 | 340 | const isDev = process.env.NODE_ENV !== "production";
43690 | 341 | 
43691 | 342 | async function startWatcher() {
43692 | 343 |   console.log(
43693 | 344 |     "[Watcher] Monitoring startuje. Sprawdzanie co",
43694 | 345 |     Math.round(CHECK_INTERVAL_MS / 1000),
43695 | 346 |     "sekund."
43696 | 347 |   );
43697 | 348 | 
43698 | 349 |   const loop = async () => {
43699 | 350 |     let browser = null;
43700 | 351 |     let page = null;
43701 | 352 |     let hadNavErrorThisRound = false;
43702 | 353 | 
43703 | 354 |     try {
43704 | 355 |       console.log(
43705 | 356 |         "[Watcher] ==== Nowy cykl watchera ‚Äì startujƒô ≈õwie≈ºƒÖ przeglƒÖdarkƒô ===="
43706 | 357 |       );
43707 | 358 | 
43708 | 359 |       browser = await puppeteer.launch({
43709 | 360 |         headless: isDev ? true : "new",
43710 | 361 |         defaultViewport: null,
43711 | 362 |         args: [
43712 | 363 |           "--no-sandbox",
43713 | 364 |           "--disable-setuid-sandbox",
43714 | 365 |           "--disable-dev-shm-usage",
43715 | 366 |           "--disable-notifications",
43716 | 367 |           "--disable-blink-features=AutomationControlled",
43717 | 368 |         ],
43718 | 369 |         ignoreDefaultArgs: ["--enable-automation"],
43719 | 370 |       });
43720 | 371 | 
43721 | 372 |       page = await browser.newPage();
43722 | 373 |       await applyStealth(page);
43723 | 374 | 
43724 | 375 |       page.setDefaultNavigationTimeout(90000);
43725 | 376 |       page.setDefaultTimeout(90000);
43726 | 377 | 
43727 | 378 |       await page.setViewport({ width: 1280, height: 720 });
43728 | 379 | 
43729 | 380 |       // cookies + login
43730 | 381 |       await loadCookies(page);
43731 | 382 |       await page
43732 | 383 |         .goto("https://www.facebook.com/", { waitUntil: "load", timeout: 60000 })
43733 | 384 |         .catch(() => {});
43734 | 385 | 
43735 | 386 |       let loggedIn = await checkIfLogged(page);
43736 | 387 |       if (!loggedIn) {
43737 | 388 |         console.log("[FB] Brak aktywnej sesji ‚Äì logowanie...");
43738 | 389 |         await fbLogin(page);
43739 | 390 |         loggedIn = await checkIfLogged(page);
43740 | 391 | 
43741 | 392 |         if (loggedIn) {
43742 | 393 |           console.log("[FB] Logowanie udane ‚Äì zapisujƒô cookies.");
43743 | 394 |           await saveCookies(page);
43744 | 395 |         } else {
43745 | 396 |           console.error(
43746 | 397 |             "[FB] Logowanie NIEUDANE ‚Äì nie zapisujƒô cookies (prawdopodobnie 2FA nieuko≈Ñczone)."
43747 | 398 |           );
43748 | 399 |         }
43749 | 400 |       } else {
43750 | 401 |         console.log("[FB] U≈ºyto istniejƒÖcej sesji FB (cookies).");
43751 | 402 |       }
43752 | 403 | 
43753 | 404 |       // posts
43754 | 405 |       await refreshPostsIfNeeded(true);
43755 | 406 | 
43756 | 407 |       if (!currentPosts.length) {
43757 | 408 |         console.log("[Watcher] Brak aktywnych post√≥w do monitorowania.");
43758 | 409 |       } else {
43759 | 410 |         for (const post of currentPosts) {
43760 | 411 |           const cacheKey = getCacheKey(post);
43761 | 412 | 
43762 | 413 |           try {
43763 | 414 |             // zawsze prepare przed liczeniem/scrollowaniem/ekstrakcjƒÖ
43764 | 415 |             await prepare(page, post.url);
43765 | 416 | 
43766 | 417 |             const count = await getCommentCount(page, post.url);
43767 | 418 |             const hasCount = typeof count === "number" && Number.isFinite(count);
43768 | 419 | 
43769 | 420 |             if (!hasCount) {
43770 | 421 |               console.log(
43771 | 422 |                 `[Watcher] Post ${post.id}: Nie uda≈Ço siƒô odczytaƒá licznika -> tryb awaryjny (jadƒô po ID).`
43772 | 423 |               );
43773 | 424 |             }
43774 | 425 | 
43775 | 426 |             const prev = lastCounts.has(cacheKey) ? lastCounts.get(cacheKey) : null;
43776 | 427 |             const knownSet = getKnownSetForPost(cacheKey);
43777 | 428 | 
43778 | 429 |             // pierwsze wej≈õcie: zapamiƒôtaj stan, nie wysy≈Çaj
43779 | 430 |             if (prev === null) {
43780 | 431 |               const initialCount = hasCount ? count : 0;
43781 | 432 |               lastCounts.set(cacheKey, initialCount);
43782 | 433 | 
43783 | 434 |               console.log(
43784 | 435 |                 hasCount
43785 | 436 |                   ? `[Watcher] Post ${post.id}: Startowa liczba komentarzy = ${initialCount}`
43786 | 437 |                   : `[Watcher] Post ${post.id}: Start (bez licznika) -> initialCount=0, zapamiƒôtujƒô ID istniejƒÖcych.`
43787 | 438 |               );
43788 | 439 | 
43789 | 440 |               if (EXPAND_COMMENTS) {
43790 | 441 |                 await loadAllComments(
43791 | 442 |                   page,
43792 | 443 |                   { expectedTotal: hasCount ? count : undefined },
43793 | 444 |                   post.url
43794 | 445 |                 ).catch(() => {});
43795 | 446 | 
43796 | 447 |                 const snap = await extractCommentsData(page, post.url).catch(() => []);
43797 | 448 |                 for (const c of snap) if (c?.id) knownSet.add(c.id);
43798 | 449 |                 console.log(
43799 | 450 |                   `[Watcher] Post ${post.id}: Zapamiƒôtano ${snap.length} istniejƒÖcych komentarzy.`
43800 | 451 |                 );
43801 | 452 |               } else {
43802 | 453 |                 console.log(
43803 | 454 |                   `[Watcher] Post ${post.id}: EXPAND_COMMENTS=false ‚Äì pomijam ekstrakcjƒô.`
43804 | 455 |                 );
43805 | 456 |               }
43806 | 457 | 
43807 | 458 |               continue;
43808 | 459 |             }
43809 | 460 | 
43810 | 461 |             // licznik: aktualizuj tylko je≈õli mamy twarde dane
43811 | 462 |             if (hasCount) {
43812 | 463 |               if (count !== prev) {
43813 | 464 |                 console.log(
43814 | 465 |                   `[Watcher] Post ${post.id}: Zmiana liczby komentarzy ${prev} -> ${count}`
43815 | 466 |                 );
43816 | 467 |                 lastCounts.set(cacheKey, count);
43817 | 468 |               } else {
43818 | 469 |                 console.log(`[Watcher] Post ${post.id}: Bez zmian (${count} komentarzy).`);
43819 | 470 |               }
43820 | 471 |             } else {
43821 | 472 |               console.log(
43822 | 473 |                 `[Watcher] Post ${post.id}: Brak licznika -> pomijam por√≥wnanie count, lecƒô po ID.`
43823 | 474 |               );
43824 | 475 |             }
43825 | 476 | 
43826 | 477 |             if (!EXPAND_COMMENTS) continue;
43827 | 478 | 
43828 | 479 |             await loadAllComments(page, { expectedTotal: hasCount ? count : undefined }).catch(
43829 | 480 |               () => {}
43830 | 481 |             );
43831 | 482 | 
43832 | 483 |             let snapshot = await extractCommentsData(page, post.url).catch(() => []);
43833 | 484 | 
43834 | 485 |             // nowe ID
43835 | 486 |             const newComments = [];
43836 | 487 |             for (const c of snapshot) {
43837 | 488 |               if (!c?.id) continue;
43838 | 489 |               if (!knownSet.has(c.id)) {
43839 | 490 |                 knownSet.add(c.id);
43840 | 491 |                 newComments.push(c);
43841 | 492 |               }
43842 | 493 |             }
43843 | 494 | 
43844 | 495 |             // fallback "tail" tylko je≈õli mamy wiarygodny licznik i wzrost
43845 | 496 |             if (hasCount && newComments.length === 0 && count > prev) {
43846 | 497 |               const diff = Math.max(1, count - prev);
43847 | 498 |               const tail = snapshot.slice(-diff);
43848 | 499 |               for (const c of tail) if (c?.id) knownSet.add(c.id);
43849 | 500 | 
43850 | 501 |               console.log(
43851 | 502 |                 `[Watcher] Post ${post.id}: Fallback ‚Äî brak nowych ID, biorƒô ostatnie ${diff} jako nowe.`
43852 | 503 |               );
43853 | 504 |               await sendWebhook(post, tail, count, prev);
43854 | 505 |               continue;
43855 | 506 |             }
43856 | 507 | 
43857 | 508 |             if (newComments.length > 0) {
43858 | 509 |               console.log(
43859 | 510 |                 `[Watcher] Post ${post.id}: Znaleziono ${newComments.length} NOWYCH komentarzy.`
43860 | 511 |               );
43861 | 512 |               await sendWebhook(
43862 | 513 |                 post,
43863 | 514 |                 newComments,
43864 | 515 |                 hasCount ? count : null,
43865 | 516 |                 hasCount ? prev : null
43866 | 517 |               );
43867 | 518 |             } else {
43868 | 519 |               console.log(
43869 | 520 |                 `[Watcher] Post ${post.id}: Brak nowych komentarzy (po ID i fallbacku).`
43870 | 521 |               );
43871 | 522 |             }
43872 | 523 |           } catch (err) {
43873 | 524 |             console.error(
43874 | 525 |               `[Watcher] B≈ÇƒÖd przy sprawdzaniu ${post.id}:`,
43875 | 526 |               err?.message || err
43876 | 527 |             );
43877 | 528 |             if (err?.stack) console.error("[Watcher] Stack:", err.stack);
43878 | 529 | 
43879 | 530 |             if (isNavigationError(err)) {
43880 | 531 |               hadNavErrorThisRound = true;
43881 | 532 |               navErrorCount++;
43882 | 533 |               console.log(
43883 | 534 |                 `[Watcher] Kolejny b≈ÇƒÖd nawigacji: ${navErrorCount}/${MAX_NAV_ERRORS}`
43884 | 535 |               );
43885 | 536 |             }
43886 | 537 |           }
43887 | 538 |         }
43888 | 539 |       }
43889 | 540 |     } catch (err) {
43890 | 541 |       console.error("[Watcher] B≈ÇƒÖd w cyklu watchera:", err);
43891 | 542 |     } finally {
43892 | 543 |       flushCacheToDisk();
43893 | 544 | 
43894 | 545 |       if (!hadNavErrorThisRound && navErrorCount > 0) {
43895 | 546 |         console.log(
43896 | 547 |           `[Watcher] Runda bez b≈Çƒôd√≥w nawigacji ‚Äì reset licznika (by≈Ço ${navErrorCount}).`
43897 | 548 |         );
43898 | 549 |         navErrorCount = 0;
43899 | 550 |       }
43900 | 551 | 
43901 | 552 |       if (browser) {
43902 | 553 |         try {
43903 | 554 |           await browser.close();
43904 | 555 |           console.log("[Watcher] Zamkniƒôto przeglƒÖdarkƒô po zako≈Ñczeniu cyklu.");
43905 | 556 |         } catch (e) {
43906 | 557 |           console.log("[Watcher] B≈ÇƒÖd zamykania przeglƒÖdarki:", e?.message || e);
43907 | 558 |         }
43908 | 559 |       }
43909 | 560 | 
43910 | 561 |       if (navErrorCount >= MAX_NAV_ERRORS) {
43911 | 562 |         console.error("[Watcher] Za du≈ºo b≈Çƒôd√≥w nawigacji z rzƒôdu ‚Äì ko≈Ñczƒô proces.");
43912 | 563 |         process.exit(1);
43913 | 564 |       }
43914 | 565 | 
43915 | 566 |       const jitter = Math.floor(Math.random() * 5000);
43916 | 567 |       const delay = CHECK_INTERVAL_MS + jitter;
43917 | 568 |       console.log(
43918 | 569 |         `[Watcher] Kolejny cykl za oko≈Ço ${Math.round(delay / 1000)} sekund.`
43919 | 570 |       );
43920 | 571 |       setTimeout(loop, delay);
43921 | 572 |     }
43922 | 573 |   };
43923 | 574 | 
43924 | 575 |   loop();
43925 | 576 | }
43926 | 577 | 
43927 | 578 | export { startWatcher };
43928 | 579 | 
43929 | ```
43930 | 
43931 | ---
43932 | 
43933 | ### üìÑ ≈öcie≈ºka: `export_fb_watcher/webhook.js`
43934 | **Typ:** JavaScript/tekst  
43935 | **Opis:** Plik projektu (kod/konfiguracja).  
43936 | 
43937 | ```js
43938 |   1 | // src/webhook.js
43939 |   2 | import axios from "axios";
43940 |   3 | import { POST_LABELS } from "./config.js";
43941 |   4 | 
43942 |   5 | /* ============================================================
43943 |   6 |    PARSER CZASU FB ‚Üí ISO
43944 |   7 |    ============================================================ */
43945 |   8 | 
43946 |   9 | function parseFbRelativeTime(raw) {
43947 |  10 |   if (!raw) return null;
43948 |  11 | 
43949 |  12 |   const t = raw.toLowerCase().trim();
43950 |  13 |   const now = new Date();
43951 |  14 | 
43952 |  15 |   if (t.includes("przed chwilƒÖ")) return now;
43953 |  16 | 
43954 |  17 |   if (t.includes("wczoraj") || t.includes("yesterday")) {
43955 |  18 |     const d = new Date(now);
43956 |  19 |     d.setDate(d.getDate() - 1);
43957 |  20 |     return d;
43958 |  21 |   }
43959 |  22 | 
43960 |  23 |   const m = t.match(/(\d+)\s*(sek|min|minut|godz|h|dni|tyg)/);
43961 |  24 |   if (!m) return null;
43962 |  25 | 
43963 |  26 |   const value = parseInt(m[1], 10);
43964 |  27 |   if (!Number.isFinite(value)) return null;
43965 |  28 | 
43966 |  29 |   const unit = m[2];
43967 |  30 |   const d = new Date(now);
43968 |  31 | 
43969 |  32 |   if (unit.startsWith("sek")) d.setSeconds(d.getSeconds() - value);
43970 |  33 |   else if (unit.startsWith("min")) d.setMinutes(d.getMinutes() - value);
43971 |  34 |   else if (unit.startsWith("godz") || unit === "h") d.setHours(d.getHours() - value);
43972 |  35 |   else if (unit.startsWith("dni")) d.setDate(d.getDate() - value);
43973 |  36 |   else if (unit.startsWith("tyg")) d.setDate(d.getDate() - 7 * value);
43974 |  37 | 
43975 |  38 |   return d;
43976 |  39 | }
43977 |  40 | 
43978 |  41 | /* ============================================================
43979 |  42 |    FILTR WIEKU KOMENTARZA ‚Äì NIE WYSY≈ÅAMY STARYCH
43980 |  43 |    ============================================================ */
43981 |  44 | 
43982 |  45 | // mo≈ºesz nadpisaƒá w .env: WEBHOOK_MAX_AGE_MIN=60
43983 |  46 | const MAX_AGE_MIN = Number(process.env.WEBHOOK_MAX_AGE_MIN || 60);
43984 |  47 | 
43985 |  48 | function filterByAge(comments) {
43986 |  49 |   const now = Date.now();
43987 |  50 | 
43988 |  51 |   return comments.filter((c) => {
43989 |  52 |     if (!c.time || c.time.trim() === "") return false;
43990 |  53 | 
43991 |  54 |     const abs = parseFbRelativeTime(c.time);
43992 |  55 |     if (!abs) return false;
43993 |  56 | 
43994 |  57 |     const ageMinutes = (now - abs.getTime()) / 60000;
43995 |  58 |     return ageMinutes <= MAX_AGE_MIN;
43996 |  59 |   });
43997 |  60 | }
43998 |  61 | 
43999 |  62 | /* ============================================================
44000 |  63 |    G≈Å√ìWNA FUNKCJA WEBHOOKA
44001 |  64 |    ============================================================ */
44002 |  65 | 
44003 |  66 | async function sendWebhook(post, newComments, newCount, oldCount) {
44004 |  67 |   const url = process.env.WEBHOOK_URL;
44005 |  68 |   if (!url) {
44006 |  69 |     console.warn("[Webhook] Brak WEBHOOK_URL ‚Äì pomijam wysy≈Çkƒô.");
44007 |  70 |     return;
44008 |  71 |   }
44009 |  72 | 
44010 |  73 |   // meta posta (panel/sheets/env fallback)
44011 |  74 |   const postName =
44012 |  75 |     (post?.name && String(post.name).trim()) ||
44013 |  76 |     POST_LABELS[post?.id] ||
44014 |  77 |     post?.id ||
44015 |  78 |     "post";
44016 |  79 | 
44017 |  80 |   const postImage =
44018 |  81 |     (post?.image && String(post.image).trim()) || null;
44019 |  82 | 
44020 |  83 |   const postDescription =
44021 |  84 |     (post?.description && String(post.description).trim()) || null;
44022 |  85 | 
44023 |  86 |   /* --------------------------------------------
44024 |  87 |        1) Normalizacja czasu i dodanie p√≥l ISO
44025 |  88 |      -------------------------------------------- */
44026 |  89 | 
44027 |  90 |   const normalized = newComments.map((c) => {
44028 |  91 |     const iso = parseFbRelativeTime(c.time);
44029 |  92 |     return {
44030 |  93 |       ...c,
44031 |  94 |       fb_time_raw: c.time || null,
44032 |  95 |       fb_time_iso: iso ? iso.toISOString() : null,
44033 |  96 |     };
44034 |  97 |   });
44035 |  98 | 
44036 |  99 |   /* --------------------------------------------
44037 | 100 |        2) Filtrowanie komentarzy po wieku
44038 | 101 |      -------------------------------------------- */
44039 | 102 | 
44040 | 103 |   const freshOnly = filterByAge(normalized);
44041 | 104 | 
44042 | 105 |   console.log("[Webhook] Filtr wieku komentarzy:", {
44043 | 106 |     before: normalized.length,
44044 | 107 |     after: freshOnly.length,
44045 | 108 |     maxAgeMin: MAX_AGE_MIN,
44046 | 109 |   });
44047 | 110 | 
44048 | 111 |   if (freshOnly.length === 0) {
44049 | 112 |     console.log("[Webhook] ≈ªaden komentarz nie spe≈Çnia limitu wieku ‚Äì nic nie wysy≈Çam.");
44050 | 113 |     return;
44051 | 114 |   }
44052 | 115 | 
44053 | 116 |   /* --------------------------------------------
44054 | 117 |        3) Payload do webhooka
44055 | 118 |      -------------------------------------------- */
44056 | 119 | 
44057 | 120 |   const payload = {
44058 | 121 |     post: {
44059 | 122 |       id: post?.id || null,
44060 | 123 |       url: post?.url || null,
44061 | 124 |       name: postName,
44062 | 125 |       image: postImage,
44063 | 126 |       description: postDescription,
44064 | 127 |     },
44065 | 128 |     commentCount: newCount,
44066 | 129 |     previousCommentCount: oldCount,
44067 | 130 |     newComments: freshOnly,
44068 | 131 |     timestamp: new Date().toISOString(),
44069 | 132 |   };
44070 | 133 | 
44071 | 134 |   console.log("[Webhook] Wysy≈Çanie danych o nowych komentarzach:", payload);
44072 | 135 | 
44073 | 136 |   /* --------------------------------------------
44074 | 137 |        4) Wysy≈Çka do Make / webhooka
44075 | 138 |      -------------------------------------------- */
44076 | 139 | 
44077 | 140 |   try {
44078 | 141 |     await axios.post(url, payload, { timeout: 10000 });
44079 | 142 |     console.log("[Webhook] Wys≈Çano nowe komentarze do webhooka.");
44080 | 143 |   } catch (err) {
44081 | 144 |     console.error("[Webhook] B≈ÇƒÖd wysy≈Çania:", err.message);
44082 | 145 |   }
44083 | 146 | }
44084 | 147 | 
44085 | 148 | export { sendWebhook };
44086 | 149 | 
44087 | ```
44088 | 
44089 | ---
44090 | 
44091 | ### üìÑ ≈öcie≈ºka: `export_files.js`
44092 | **Typ:** JavaScript/tekst  
44093 | **Opis:** Plik projektu (kod/konfiguracja).  
44094 | 
44095 | ```js
44096 |  1 | // export_files.js
44097 |  2 | import fs from "fs";
44098 |  3 | import path from "path";
44099 |  4 | 
44100 |  5 | const ROOT = process.cwd();
44101 |  6 | const EXPORT_DIR = path.join(ROOT, "export_chat_context");
44102 |  7 | 
44103 |  8 | // MAKS 18 PLIK√ìW ‚Äî FULL KONTEKST DO PRACY
44104 |  9 | const FILES = [
44105 | 10 |   // 1‚Äì3: start i cykl ≈ºycia
44106 | 11 |   "src/index.js",
44107 | 12 |   "src/watcher.js",
44108 | 13 |   "src/config.js",
44109 | 14 | 
44110 | 15 |   // 4‚Äì5: wyj≈õcia / integracje
44111 | 16 |   "src/telegram.js",
44112 | 17 |   "src/webhook.js",
44113 | 18 | 
44114 | 19 |   // 6‚Äì10: FB core (komentarze + scroll + login)
44115 | 20 |   "src/fb/comments.js",
44116 | 21 |   "src/fb/scroll.js",
44117 | 22 |   "src/fb/login.js",
44118 | 23 |   "src/fb/cookies.js",
44119 | 24 |   "src/fb/expandButtons.js",
44120 | 25 | 
44121 | 26 |   // 11‚Äì15: router + kluczowe UI layouty
44122 | 27 |   "src/fb/ui/index.js",
44123 | 28 |   "src/fb/ui/post.js",
44124 | 29 |   "src/fb/ui/photo.js",
44125 | 30 |   "src/fb/ui/watch.js",
44126 | 31 |   "src/fb/ui/videos.js",
44127 | 32 | 
44128 | 33 |   // 16‚Äì17: stabilno≈õƒá
44129 | 34 |   "src/utils/navigation.js",
44130 | 35 |   "src/utils/sleep.js",
44131 | 36 | 
44132 | 37 |   // 18: PANEL API (≈ºeby wiedzieƒá jak panel steruje backendem)
44133 | 38 |   "src/panel/api.js",
44134 | 39 |   "src/panel/ui/index.html",
44135 | 40 |   "src/panel/ui/app.js",
44136 | 41 | ];
44137 | 42 | 
44138 | 43 | function ensureDir(p) {
44139 | 44 |   if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
44140 | 45 | }
44141 | 46 | 
44142 | 47 | console.log("=== EXPORT CHAT CONTEXT (MAX 18 FILES) ===");
44143 | 48 | 
44144 | 49 | if (fs.existsSync(EXPORT_DIR)) {
44145 | 50 |   fs.rmSync(EXPORT_DIR, { recursive: true, force: true });
44146 | 51 | }
44147 | 52 | ensureDir(EXPORT_DIR);
44148 | 53 | 
44149 | 54 | FILES.forEach((file, idx) => {
44150 | 55 |   const src = path.join(ROOT, file);
44151 | 56 |   if (!fs.existsSync(src)) {
44152 | 57 |     console.log(`‚ö†Ô∏è  Brak: ${file}`);
44153 | 58 |     return;
44154 | 59 |   }
44155 | 60 | 
44156 | 61 |   const num = String(idx + 1).padStart(2, "0");
44157 | 62 |   const dst = path.join(EXPORT_DIR, `${num}__${path.basename(file)}`);
44158 | 63 | 
44159 | 64 |   fs.copyFileSync(src, dst);
44160 | 65 |   console.log(`‚úì ${num} ${file}`);
44161 | 66 | });
44162 | 67 | 
44163 | 68 | console.log("\n=== GOTOWE ===");
44164 | 69 | console.log(`‚û°Ô∏è Wklej tutaj pliki z folderu: ${EXPORT_DIR}`);
44165 | 70 | 
44166 | ```
44167 | 
44168 | ---
44169 | 
44170 | ### üìÑ ≈öcie≈ºka: `Rozwoj.md`
44171 | **Typ:** Markdown  
44172 | **Opis:** Plik projektu (kod/konfiguracja).  
44173 | 
44174 | ```md
44175 |   1 | # FB Watcher ‚Äî koncepcja dzia≈Çania panelu (pod integracjƒô backendu)
44176 |   2 | 
44177 |   3 | Ten dokument opisuje **jak ma dzia≈Çaƒá panel administratora** dla systemu FB Watcher.
44178 |   4 | Panel jest **centrum sterowania**, backend (scrapery / workerzy) bƒôdzie dopinany etapami.
44179 |   5 | 
44180 |   6 | Panel:
44181 |   7 | - przechowuje konfiguracjƒô,
44182 |   8 | - zbiera wykrycia (discoveries),
44183 |   9 | - umo≈ºliwia zatwierdzanie,
44184 |  10 | - zarzƒÖdza obserwacjƒÖ i akcjami (alerty, autoposting).
44185 |  11 | 
44186 |  12 | ---
44187 |  13 | 
44188 |  14 | ## Wsp√≥lny schemat dzia≈Çania
44189 |  15 | 
44190 |  16 | ≈πR√ìD≈ÅO ‚Üí WYKRYCIE (DISCOVERY) ‚Üí ZATWIERDZENIE ‚Üí OBSERWACJA / AKCJA
44191 |  17 | 
44192 |  18 | Panel **nie scrapuje** ‚Äî panel **zarzƒÖdza i decyduje**.
44193 |  19 | 
44194 |  20 | ---
44195 |  21 | 
44196 |  22 | ## 1. PrzeglƒÖdanie g≈Ç√≥wnej strony Facebooka (Home / Feed)
44197 |  23 | 
44198 |  24 | ### Cel
44199 |  25 | Automatyczne wykrywanie post√≥w z **g≈Ç√≥wnej tablicy Facebooka** (Home / Feed),
44200 |  26 | czyli tego, co realnie pojawia siƒô u≈ºytkownikowi po zalogowaniu:
44201 |  27 | - posty stron,
44202 |  28 | - posty publiczne,
44203 |  29 | - posty sponsorowane,
44204 |  30 | - tre≈õci powiƒÖzane z zainteresowaniami.
44205 |  31 | 
44206 |  32 | ### Jak to dzia≈Ça
44207 |  33 | 1. W panelu konfigurowane sƒÖ:
44208 |  34 |    - tryb skanowania **g≈Ç√≥wnej strony Facebooka**,
44209 |  35 |    - zestawy s≈Ç√≥w kluczowych.
44210 |  36 | 2. Backend cyklicznie przeglƒÖda g≈Ç√≥wny feed Facebooka.
44211 |  37 | 3. Ka≈ºdy post dopasowany do s≈Ç√≥w kluczowych trafia do panelu jako **Wykrycie (Discovery)**.
44212 |  38 | 4. Operator w panelu:
44213 |  39 |    - **Zatwierdza** ‚Üí post zostaje dodany do listy obserwowanych (Watcher),
44214 |  40 |    - **Odrzuca** ‚Üí wykrycie jest ignorowane.
44215 |  41 | 
44216 |  42 | ### Panel musi posiadaƒá
44217 |  43 | - konfiguracjƒô skanowania strony g≈Ç√≥wnej Facebooka,
44218 |  44 | - listƒô wykryƒá z typu `home_feed`,
44219 |  45 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
44220 |  46 | 
44221 |  47 | ---
44222 |  48 | 
44223 |  49 | ## 2. Scrapping grup Facebooka
44224 |  50 | 
44225 |  51 | ### Cel
44226 |  52 | Wychwytywanie zapyta≈Ñ i lead√≥w z grup bran≈ºowych.
44227 |  53 | 
44228 |  54 | ### Jak to dzia≈Ça
44229 |  55 | 1. W panelu dodawane sƒÖ:
44230 |  56 |    - grupy Facebook,
44231 |  57 |    - przypisane zestawy s≈Ç√≥w kluczowych.
44232 |  58 | 2. Backend skanuje nowe posty w grupach.
44233 |  59 | 3. Dopasowania trafiajƒÖ do **Wykryƒá (Discovery)** z typem `group_post`.
44234 |  60 | 4. Operator:
44235 |  61 |    - zatwierdza ‚Üí (opcjonalnie) dodaje post do obserwowanych,
44236 |  62 |    - odrzuca ‚Üí ignor.
44237 |  63 | 
44238 |  64 | ### Panel musi posiadaƒá
44239 |  65 | - listƒô grup,
44240 |  66 | - przypisywanie keyword√≥w,
44241 |  67 | - decyzjƒô na wykryciu: `dodaj do obserwowanych` / `tylko alert`.
44242 |  68 | 
44243 |  69 | ---
44244 |  70 | 
44245 |  71 | ## 3. Meta Ads (reklamy konkurencji)
44246 |  72 | 
44247 |  73 | ### Cel
44248 |  74 | Monitoring reklam konkurencji i wyciƒÖganie konkretnych reklam/post√≥w do dalszej obserwacji.
44249 |  75 | 
44250 |  76 | ### Jak to dzia≈Ça
44251 |  77 | 1. W panelu definiowane sƒÖ:
44252 |  78 |    - konkurencja (opcjonalnie),
44253 |  79 |    - s≈Çowa kluczowe.
44254 |  80 | 2. Backend skanuje Meta Ads Library.
44255 |  81 | 3. Znalezione reklamy trafiajƒÖ do **Wykryƒá (Discovery)**:
44256 |  82 |    - link do reklamy,
44257 |  83 |    - reklamodawca,
44258 |  84 |    - typ (grafika / wideo),
44259 |  85 |    - opis.
44260 |  86 | 4. Panel posiada wyszukiwarkƒô wykryƒá.
44261 |  87 | 5. Po **zatwierdzeniu**:
44262 |  88 |    - je≈õli reklama ma publiczny link/post ‚Üí trafia do obserwowanych link√≥w watchera,
44263 |  89 |    - reklama zostaje przypisana do istniejƒÖcych obserwacji.
44264 |  90 | 
44265 |  91 | ### Panel musi posiadaƒá
44266 |  92 | - listƒô monitor√≥w Meta Ads,
44267 |  93 | - listƒô wykryƒá reklam,
44268 |  94 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
44269 |  95 | 
44270 |  96 | ---
44271 |  97 | 
44272 |  98 | ## 4. Automatyczne dodawanie og≈Çosze≈Ñ (Marketplace)
44273 |  99 | 
44274 | 100 | ### Cel
44275 | 101 | Autoposting og≈Çosze≈Ñ z puli tre≈õci, z rotacjƒÖ i obs≈ÇugƒÖ wielu kont.
44276 | 102 | 
44277 | 103 | ### Jak to dzia≈Ça
44278 | 104 | 1. W panelu tworzone sƒÖ:
44279 | 105 |    - pule og≈Çosze≈Ñ (szablony),
44280 | 106 |    - kampanie publikacji.
44281 | 107 | 2. Kampania:
44282 | 108 |    - wybiera konto FB,
44283 | 109 |    - ustala harmonogram,
44284 | 110 |    - rotuje tre≈õci.
44285 | 111 | 3. Backend publikuje og≈Çoszenia.
44286 | 112 | 4. Przy b≈Çƒôdzie lub blokadzie:
44287 | 113 |    - kampania zostaje zatrzymana,
44288 | 114 |    - panel pokazuje status i mo≈ºliwo≈õƒá wznowienia.
44289 | 115 | 
44290 | 116 | ### Panel musi posiadaƒá
44291 | 117 | - pulƒô og≈Çosze≈Ñ,
44292 | 118 | - kampanie publikacji,
44293 | 119 | - statusy: ACTIVE / PAUSED / ERROR,
44294 | 120 | - przyciski STOP / WZN√ìW.
44295 | 121 | 
44296 | 122 | ---
44297 | 123 | 
44298 | 124 | ## Kluczowe byty w panelu (minimalny zestaw)
44299 | 125 | 
44300 | 126 | - **Sources** ‚Äì g≈Ç√≥wna strona FB, grupy, meta ads
44301 | 127 | - **Discoveries** ‚Äì wszystkie wykrycia (jedno wsp√≥lne miejsce)
44302 | 128 | - **Watched** ‚Äì obserwowane linki/posty (dla watchera)
44303 | 129 | - **Campaigns** ‚Äì autoposting / marketplace
44304 | 130 | 
44305 | 131 | Ka≈ºdy typ wykrycia przechodzi przez:
44306 | 132 | `Discoveries ‚Üí Zatwierd≈∫ ‚Üí Watched / Campaign`
44307 | 133 | 
44308 | 134 | ---
44309 | 135 | 
44310 | 136 | ## Za≈Ço≈ºenia architektoniczne
44311 | 137 | 
44312 | 138 | - Panel = ≈∫r√≥d≈Ço prawdy
44313 | 139 | - Backend = wykonawca (worker)
44314 | 140 | - G≈Ç√≥wna strona FB, grupy i Meta Ads to **r√≥≈ºne ≈∫r√≥d≈Ça**, ale **ten sam proces zatwierdzania**
44315 | 141 | - Ka≈ºda funkcja backendu mo≈ºe byƒá dodana p√≥≈∫niej bez zmiany panelu
44316 | 142 | 
44317 | 143 | ---
44318 | 144 | 
44319 | 145 | ## Uwaga projektowa
44320 | 146 | 
44321 | 147 | Panel musi byƒá gotowy na:
44322 | 148 | - wiele kont Facebook,
44323 | 149 | - blokady i zatrzymania,
44324 | 150 | - r√≥≈ºne typy ≈∫r√≥de≈Ç (Home / Group / Ads),
44325 | 151 | - dalszƒÖ rozbudowƒô bez refaktoru UI.
44326 | 152 | 
44327 | 153 | 
44328 | ```
44329 | 
44330 | ---
44331 | 
44332 | ### üìÑ ≈öcie≈ºka: `scripts/generate-cookies.js`
44333 | **Typ:** JavaScript/tekst  
44334 | **Opis:** Plik projektu (kod/konfiguracja).  
44335 | 
44336 | ```js
44337 |   1 | #!/usr/bin/env node
44338 |   2 | /**
44339 |   3 |  * scripts/generate-cookies.js
44340 |   4 |  *
44341 |   5 |  * Skrypt pomocniczy do generowania cookies Facebook z rotacjƒÖ.
44342 |   6 |  * Otwiera przeglƒÖdarkƒô w trybie widocznym, czeka na manualne logowanie (z 2FA),
44343 |   7 |  * a nastƒôpnie zapisuje cookies do plik√≥w z numeracjƒÖ.
44344 |   8 |  *
44345 |   9 |  * U≈ºycie:
44346 |  10 |  *   node scripts/generate-cookies.js [--index=N] [--upload] [--list]
44347 |  11 |  *
44348 |  12 |  * Opcje:
44349 |  13 |  *   --index=N  - zapisz jako cookies_N.json (domy≈õlnie: nastƒôpny wolny numer)
44350 |  14 |  *   --upload   - po zapisaniu, wy≈õlij cookies przez SCP na serwer
44351 |  15 |  *   --list     - tylko poka≈º listƒô istniejƒÖcych plik√≥w cookies
44352 |  16 |  *
44353 |  17 |  * Przyk≈Çady:
44354 |  18 |  *   node scripts/generate-cookies.js                    # zapisz jako cookies_1.json (lub nastƒôpny)
44355 |  19 |  *   node scripts/generate-cookies.js --index=2          # zapisz jako cookies_2.json
44356 |  20 |  *   node scripts/generate-cookies.js --index=1 --upload # zapisz i wy≈õlij na serwer
44357 |  21 |  *   node scripts/generate-cookies.js --list             # poka≈º istniejƒÖce pliki
44358 |  22 |  */
44359 |  23 | 
44360 |  24 | import "dotenv/config";
44361 |  25 | import puppeteer from "puppeteer";
44362 |  26 | import fs from "fs/promises";
44363 |  27 | import fsSync from "fs";
44364 |  28 | import path from "path";
44365 |  29 | import { execSync } from "child_process";
44366 |  30 | import readline from "readline";
44367 |  31 | 
44368 |  32 | // Konfiguracja
44369 |  33 | const MAIN_COOKIES_FILE = "cookies.json";
44370 |  34 | const BACKUP_COOKIES_DIR = process.env.BACKUP_COOKIES_DIR || "./data/backup_cookies";
44371 |  35 | const SCP_COOKIES_TARGET = (process.env.SCP_COOKIES_TARGET || "").trim();
44372 |  36 | 
44373 |  37 | // Kolory konsoli
44374 |  38 | const colors = {
44375 |  39 |   reset: "\x1b[0m",
44376 |  40 |   bright: "\x1b[1m",
44377 |  41 |   green: "\x1b[32m",
44378 |  42 |   yellow: "\x1b[33m",
44379 |  43 |   blue: "\x1b[34m",
44380 |  44 |   cyan: "\x1b[36m",
44381 |  45 |   red: "\x1b[31m",
44382 |  46 |   dim: "\x1b[2m",
44383 |  47 | };
44384 |  48 | 
44385 |  49 | function log(msg, color = "reset") {
44386 |  50 |   console.log(`${colors[color]}${msg}${colors.reset}`);
44387 |  51 | }
44388 |  52 | 
44389 |  53 | function logBox(lines) {
44390 |  54 |   const maxLen = Math.max(...lines.map((l) => l.length));
44391 |  55 |   const border = "‚ïê".repeat(maxLen + 2);
44392 |  56 | 
44393 |  57 |   console.log(`\n${colors.cyan}‚ïî${border}‚ïó${colors.reset}`);
44394 |  58 |   for (const line of lines) {
44395 |  59 |     const padding = " ".repeat(maxLen - line.length);
44396 |  60 |     console.log(`${colors.cyan}‚ïë${colors.reset} ${line}${padding} ${colors.cyan}‚ïë${colors.reset}`);
44397 |  61 |   }
44398 |  62 |   console.log(`${colors.cyan}‚ïö${border}‚ïù${colors.reset}\n`);
44399 |  63 | }
44400 |  64 | 
44401 |  65 | /**
44402 |  66 |  * Pobiera listƒô istniejƒÖcych plik√≥w cookies_N.json
44403 |  67 |  */
44404 |  68 | function getExistingCookiesFiles() {
44405 |  69 |   try {
44406 |  70 |     const backupDir = path.resolve(BACKUP_COOKIES_DIR);
44407 |  71 |     if (!fsSync.existsSync(backupDir)) return [];
44408 |  72 | 
44409 |  73 |     const files = fsSync.readdirSync(backupDir);
44410 |  74 |     const cookieFiles = [];
44411 |  75 | 
44412 |  76 |     for (const file of files) {
44413 |  77 |       const match = file.match(/^cookies_(\d+)\.json$/);
44414 |  78 |       if (match) {
44415 |  79 |         const index = parseInt(match[1], 10);
44416 |  80 |         const filePath = path.join(backupDir, file);
44417 |  81 |         const stats = fsSync.statSync(filePath);
44418 |  82 |         const ageHours = Math.round((Date.now() - stats.mtimeMs) / (1000 * 60 * 60));
44419 |  83 | 
44420 |  84 |         cookieFiles.push({ index, filename: file, path: filePath, ageHours });
44421 |  85 |       }
44422 |  86 |     }
44423 |  87 | 
44424 |  88 |     return cookieFiles.sort((a, b) => a.index - b.index);
44425 |  89 |   } catch {
44426 |  90 |     return [];
44427 |  91 |   }
44428 |  92 | }
44429 |  93 | 
44430 |  94 | /**
44431 |  95 |  * Znajduje nastƒôpny wolny numer
44432 |  96 |  */
44433 |  97 | function getNextFreeIndex() {
44434 |  98 |   const existing = getExistingCookiesFiles();
44435 |  99 |   if (existing.length === 0) return 1;
44436 | 100 |   return Math.max(...existing.map((f) => f.index)) + 1;
44437 | 101 | }
44438 | 102 | 
44439 | 103 | /**
44440 | 104 |  * Parsuje argumenty CLI
44441 | 105 |  */
44442 | 106 | function parseArgs() {
44443 | 107 |   const args = process.argv.slice(2);
44444 | 108 |   const result = {
44445 | 109 |     index: null,
44446 | 110 |     upload: false,
44447 | 111 |     list: false,
44448 | 112 |   };
44449 | 113 | 
44450 | 114 |   for (const arg of args) {
44451 | 115 |     if (arg === "--upload") {
44452 | 116 |       result.upload = true;
44453 | 117 |     } else if (arg === "--list") {
44454 | 118 |       result.list = true;
44455 | 119 |     } else if (arg.startsWith("--index=")) {
44456 | 120 |       const val = arg.split("=")[1];
44457 | 121 |       result.index = parseInt(val, 10);
44458 | 122 |       if (isNaN(result.index) || result.index < 1) {
44459 | 123 |         log(`B≈ÇƒÖd: --index musi byƒá liczbƒÖ >= 1`, "red");
44460 | 124 |         process.exit(1);
44461 | 125 |       }
44462 | 126 |     }
44463 | 127 |   }
44464 | 128 | 
44465 | 129 |   return result;
44466 | 130 | }
44467 | 131 | 
44468 | 132 | async function waitForEnter() {
44469 | 133 |   const rl = readline.createInterface({
44470 | 134 |     input: process.stdin,
44471 | 135 |     output: process.stdout,
44472 | 136 |   });
44473 | 137 | 
44474 | 138 |   return new Promise((resolve) => {
44475 | 139 |     rl.question(`${colors.yellow}>>> Naci≈õnij ENTER gdy sko≈Ñczysz logowanie...${colors.reset}`, () => {
44476 | 140 |       rl.close();
44477 | 141 |       resolve();
44478 | 142 |     });
44479 | 143 |   });
44480 | 144 | }
44481 | 145 | 
44482 | 146 | async function checkIfLogged(page) {
44483 | 147 |   try {
44484 | 148 |     return await page.evaluate(() => {
44485 | 149 |       const hasSearch = !!(
44486 | 150 |         document.querySelector('input[aria-label*="Szukaj"]') ||
44487 | 151 |         document.querySelector('input[placeholder*="Szukaj"]') ||
44488 | 152 |         document.querySelector('input[placeholder*="Search"]')
44489 | 153 |       );
44490 | 154 |       const hasProfile = !!(
44491 | 155 |         document.querySelector('a[aria-label*="Profil"]') ||
44492 | 156 |         document.querySelector('a[aria-label*="Profile"]')
44493 | 157 |       );
44494 | 158 |       const hasAccount = !!(
44495 | 159 |         document.querySelector('div[aria-label*="Konto"]') ||
44496 | 160 |         document.querySelector('div[aria-label*="Account"]')
44497 | 161 |       );
44498 | 162 |       const hasFeed = !!document.querySelector('[role="feed"]');
44499 | 163 | 
44500 | 164 |       return hasSearch || hasProfile || hasAccount || hasFeed;
44501 | 165 |     });
44502 | 166 |   } catch {
44503 | 167 |     return false;
44504 | 168 |   }
44505 | 169 | }
44506 | 170 | 
44507 | 171 | async function ensureDir(dir) {
44508 | 172 |   try {
44509 | 173 |     await fs.mkdir(dir, { recursive: true });
44510 | 174 |   } catch {
44511 | 175 |     // ignoruj
44512 | 176 |   }
44513 | 177 | }
44514 | 178 | 
44515 | 179 | async function saveCookiesToFile(cookies, filePath) {
44516 | 180 |   await ensureDir(path.dirname(filePath));
44517 | 181 |   await fs.writeFile(filePath, JSON.stringify(cookies, null, 2), "utf8");
44518 | 182 | }
44519 | 183 | 
44520 | 184 | function uploadViaScp(localPath, target) {
44521 | 185 |   if (!target) {
44522 | 186 |     log("Brak SCP_COOKIES_TARGET w .env - pomijam upload", "yellow");
44523 | 187 |     return false;
44524 | 188 |   }
44525 | 189 | 
44526 | 190 |   try {
44527 | 191 |     log(`Wysy≈Çam przez SCP: ${path.basename(localPath)} ‚Üí ${target}`, "blue");
44528 | 192 |     execSync(`scp "${localPath}" "${target}"`, { stdio: "inherit" });
44529 | 193 |     log("Upload zako≈Ñczony!", "green");
44530 | 194 |     return true;
44531 | 195 |   } catch (err) {
44532 | 196 |     log(`B≈ÇƒÖd SCP: ${err.message}`, "red");
44533 | 197 |     return false;
44534 | 198 |   }
44535 | 199 | }
44536 | 200 | 
44537 | 201 | function showList() {
44538 | 202 |   const files = getExistingCookiesFiles();
44539 | 203 | 
44540 | 204 |   logBox([
44541 | 205 |     "Lista plik√≥w backup cookies",
44542 | 206 |     `Folder: ${BACKUP_COOKIES_DIR}`,
44543 | 207 |   ]);
44544 | 208 | 
44545 | 209 |   if (files.length === 0) {
44546 | 210 |     log("  (brak plik√≥w)", "dim");
44547 | 211 |   } else {
44548 | 212 |     for (const f of files) {
44549 | 213 |       const ageStr = f.ageHours < 24 ? `${f.ageHours}h` : `${Math.round(f.ageHours / 24)}d`;
44550 | 214 |       log(`  ${colors.cyan}${f.filename}${colors.reset} - wiek: ${ageStr}`);
44551 | 215 |     }
44552 | 216 |   }
44553 | 217 | 
44554 | 218 |   console.log();
44555 | 219 |   log(`Nastƒôpny wolny numer: ${getNextFreeIndex()}`, "dim");
44556 | 220 | }
44557 | 221 | 
44558 | 222 | async function main() {
44559 | 223 |   const args = parseArgs();
44560 | 224 | 
44561 | 225 |   // Tryb --list
44562 | 226 |   if (args.list) {
44563 | 227 |     showList();
44564 | 228 |     process.exit(0);
44565 | 229 |   }
44566 | 230 | 
44567 | 231 |   // Ustal numer pliku
44568 | 232 |   const targetIndex = args.index ?? getNextFreeIndex();
44569 | 233 |   const targetFilename = `cookies_${targetIndex}.json`;
44570 | 234 |   const targetPath = path.join(path.resolve(BACKUP_COOKIES_DIR), targetFilename);
44571 | 235 | 
44572 | 236 |   // Sprawd≈∫ czy plik ju≈º istnieje
44573 | 237 |   const existing = getExistingCookiesFiles();
44574 | 238 |   const existsAlready = existing.some((f) => f.index === targetIndex);
44575 | 239 | 
44576 | 240 |   logBox([
44577 | 241 |     "FB Cookie Generator (z rotacjƒÖ)",
44578 | 242 |     "",
44579 | 243 |     `Zapisze jako: ${targetFilename}`,
44580 | 244 |     existsAlready ? `(UWAGA: nadpisze istniejƒÖcy plik!)` : `(nowy plik)`,
44581 | 245 |     "",
44582 | 246 |     "Otworzy przeglƒÖdarkƒô - zaloguj siƒô rƒôcznie.",
44583 | 247 |   ]);
44584 | 248 | 
44585 | 249 |   // Poka≈º istniejƒÖce pliki
44586 | 250 |   if (existing.length > 0) {
44587 | 251 |     log("IstniejƒÖce pliki backup:", "dim");
44588 | 252 |     for (const f of existing) {
44589 | 253 |       const marker = f.index === targetIndex ? " ‚Üê nadpisany" : "";
44590 | 254 |       log(`  ${f.filename}${marker}`, "dim");
44591 | 255 |     }
44592 | 256 |     console.log();
44593 | 257 |   }
44594 | 258 | 
44595 | 259 |   log("Uruchamiam przeglƒÖdarkƒô...", "blue");
44596 | 260 | 
44597 | 261 |   const browser = await puppeteer.launch({
44598 | 262 |     headless: false,
44599 | 263 |     defaultViewport: null,
44600 | 264 |     args: [
44601 | 265 |       "--start-maximized",
44602 | 266 |       "--disable-notifications",
44603 | 267 |       "--disable-blink-features=AutomationControlled",
44604 | 268 |     ],
44605 | 269 |     ignoreDefaultArgs: ["--enable-automation"],
44606 | 270 |   });
44607 | 271 | 
44608 | 272 |   const page = await browser.newPage();
44609 | 273 | 
44610 | 274 |   // Stealth
44611 | 275 |   await page.evaluateOnNewDocument(() => {
44612 | 276 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
44613 | 277 |     window.chrome = window.chrome || { runtime: {} };
44614 | 278 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
44615 | 279 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
44616 | 280 |   });
44617 | 281 | 
44618 | 282 |   log("Nawigujƒô do Facebook...", "blue");
44619 | 283 |   await page.goto("https://www.facebook.com/login.php", { waitUntil: "networkidle2" });
44620 | 284 | 
44621 | 285 |   logBox([
44622 | 286 |     "INSTRUKCJA",
44623 | 287 |     "",
44624 | 288 |     "1. Zaloguj siƒô na swoje konto Facebook",
44625 | 289 |     "2. Je≈õli FB poprosi o 2FA - wprowad≈∫ kod",
44626 | 290 |     "3. Poczekaj a≈º zobaczysz stronƒô g≈Ç√≥wnƒÖ",
44627 | 291 |     "4. Wr√≥ƒá tutaj i naci≈õnij ENTER",
44628 | 292 |   ]);
44629 | 293 | 
44630 | 294 |   await waitForEnter();
44631 | 295 | 
44632 | 296 |   log("Sprawdzam status logowania...", "blue");
44633 | 297 |   let isLogged = await checkIfLogged(page);
44634 | 298 | 
44635 | 299 |   if (!isLogged) {
44636 | 300 |     log("Nie wykryto sesji. Spr√≥buj ponownie.", "yellow");
44637 | 301 | 
44638 | 302 |     const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
44639 | 303 |     const retry = await new Promise((resolve) => {
44640 | 304 |       rl.question("Czy chcesz spr√≥bowaƒá ponownie? (t/n): ", (answer) => {
44641 | 305 |         rl.close();
44642 | 306 |         resolve(answer.toLowerCase() === "t" || answer.toLowerCase() === "y");
44643 | 307 |       });
44644 | 308 |     });
44645 | 309 | 
44646 | 310 |     if (retry) {
44647 | 311 |       await waitForEnter();
44648 | 312 |       isLogged = await checkIfLogged(page);
44649 | 313 |     }
44650 | 314 | 
44651 | 315 |     if (!isLogged) {
44652 | 316 |       log("Nie wykryto sesji. Zamykam.", "red");
44653 | 317 |       await browser.close();
44654 | 318 |       process.exit(1);
44655 | 319 |     }
44656 | 320 |   }
44657 | 321 | 
44658 | 322 |   log("Sesja wykryta! Pobieram cookies...", "green");
44659 | 323 | 
44660 | 324 |   const cookies = await page.cookies();
44661 | 325 |   log(`Pobrano ${cookies.length} cookies`, "cyan");
44662 | 326 | 
44663 | 327 |   // Zapisz do g≈Ç√≥wnego pliku
44664 | 328 |   const mainPath = path.resolve(MAIN_COOKIES_FILE);
44665 | 329 |   await saveCookiesToFile(cookies, mainPath);
44666 | 330 |   log(`Zapisano: ${mainPath}`, "green");
44667 | 331 | 
44668 | 332 |   // Zapisz jako backup z numerem
44669 | 333 |   await saveCookiesToFile(cookies, targetPath);
44670 | 334 |   log(`Zapisano backup: ${targetPath}`, "green");
44671 | 335 | 
44672 | 336 |   // Opcjonalnie: upload SCP
44673 | 337 |   if (args.upload) {
44674 | 338 |     uploadViaScp(targetPath, SCP_COOKIES_TARGET);
44675 | 339 |   }
44676 | 340 | 
44677 | 341 |   await browser.close();
44678 | 342 | 
44679 | 343 |   logBox([
44680 | 344 |     "SUKCES!",
44681 | 345 |     "",
44682 | 346 |     `Cookies zapisane jako: ${targetFilename}`,
44683 | 347 |     "",
44684 | 348 |     "Aby wygenerowaƒá kolejny zestaw:",
44685 | 349 |     `  node scripts/generate-cookies.js --index=${targetIndex + 1}`,
44686 | 350 |     "",
44687 | 351 |     args.upload && SCP_COOKIES_TARGET
44688 | 352 |       ? `Upload: ${SCP_COOKIES_TARGET}`
44689 | 353 |       : "Skopiuj pliki na serwer rƒôcznie lub u≈ºyj --upload",
44690 | 354 |   ].filter(Boolean));
44691 | 355 | 
44692 | 356 |   process.exit(0);
44693 | 357 | }
44694 | 358 | 
44695 | 359 | main().catch((err) => {
44696 | 360 |   console.error("B≈ÇƒÖd:", err);
44697 | 361 |   process.exit(1);
44698 | 362 | });
44699 | 363 | 
44700 | ```
44701 | 
44702 | ---
44703 | 
44704 | ### üìÑ ≈öcie≈ºka: `test-telegram.mjs`
44705 | **Typ:** JavaScript/tekst  
44706 | **Opis:** Plik projektu (kod/konfiguracja).  
44707 | 
44708 | ```js
44709 |  1 | import "dotenv/config";
44710 |  2 | import { sendTelegramLeads } from "./src/telegram.js";
44711 |  3 | 
44712 |  4 | await sendTelegramLeads(
44713 |  5 |   { name: "TEST", description: "test", url: "https://facebook.com", image: "" },
44714 |  6 |   [{ author: "Tester", text: "To jest test", fb_time_raw: "1 min", id: "test-1" }]
44715 |  7 | );
44716 |  8 | 
44717 |  9 | console.log("TEST DONE");
44718 | 10 | 
44719 | ```
44720 | 
44721 | ---
44722 | 
44723 | ### üìÑ ≈öcie≈ºka: `tools/export-project-to-md.js`
44724 | **Typ:** JavaScript/tekst  
44725 | **Opis:** Plik projektu (kod/konfiguracja).  
44726 | 
44727 | ```js
44728 |   1 | #!/usr/bin/env node
44729 |   2 | /**
44730 |   3 |  * Export ca≈Çego projektu do jednego pliku Markdown z:
44731 |   4 |  * - spisem tre≈õci
44732 |   5 |  * - per-plik sekcjami
44733 |   6 |  * - numerami linii
44734 |   7 |  *
44735 |   8 |  * Uruchom:
44736 |   9 |  *   node tools/export-project-to-md.js
44737 |  10 |  *
44738 |  11 |  * Opcje (ENV):
44739 |  12 |  *   EXPORT_OUT=EXPORT_PROJEKTU.md
44740 |  13 |  *   EXPORT_ROOT=.           (domy≈õlnie katalog, w kt√≥rym uruchamiasz)
44741 |  14 |  *   EXPORT_MAX_BYTES=2000000 (max rozmiar pojedynczego pliku w bajtach; domy≈õlnie 2 MB)
44742 |  15 |  */
44743 |  16 | 
44744 |  17 | import fs from "fs";
44745 |  18 | import path from "path";
44746 |  19 | 
44747 |  20 | const ROOT = path.resolve(process.env.EXPORT_ROOT || process.cwd());
44748 |  21 | const OUT_FILE = path.resolve(process.env.EXPORT_OUT || path.join(ROOT, "EXPORT_PROJEKTU.md"));
44749 |  22 | const MAX_BYTES = Number(process.env.EXPORT_MAX_BYTES || 2_000_000);
44750 |  23 | 
44751 |  24 | const IGNORE_DIRS = new Set([
44752 |  25 |   "node_modules",
44753 |  26 |   ".git",
44754 |  27 |   "dist",
44755 |  28 |   "build",
44756 |  29 |   "out",
44757 |  30 |   ".next",
44758 |  31 |   ".turbo",
44759 |  32 |   ".cache",
44760 |  33 |   "coverage",
44761 |  34 |   ".pnpm-store",
44762 |  35 |   ".yarn",
44763 |  36 |   ".vscode",
44764 |  37 |   ".idea",
44765 |  38 | ]);
44766 |  39 | 
44767 |  40 | const IGNORE_FILES = new Set([
44768 |  41 |   "package-lock.json", // mo≈ºesz odkomentowaƒá, je≈õli chcesz go mieƒá: usu≈Ñ z listy
44769 |  42 |   // "yarn.lock",
44770 |  43 |   // "pnpm-lock.yaml",
44771 |  44 | ]);
44772 |  45 | 
44773 |  46 | const ALLOWED_EXT = new Set([
44774 |  47 |   ".js",
44775 |  48 |   ".mjs",
44776 |  49 |   ".cjs",
44777 |  50 |   ".ts",
44778 |  51 |   ".tsx",
44779 |  52 |   ".jsx",
44780 |  53 |   ".json",
44781 |  54 |   ".env",
44782 |  55 |   ".env.local",
44783 |  56 |   ".env.production",
44784 |  57 |   ".env.development",
44785 |  58 |   ".html",
44786 |  59 |   ".css",
44787 |  60 |   ".md",
44788 |  61 |   ".yml",
44789 |  62 |   ".yaml",
44790 |  63 |   ".txt",
44791 |  64 | ]);
44792 |  65 | 
44793 |  66 | // Typowe binarki / ≈õmieci
44794 |  67 | const BINARY_EXT = new Set([
44795 |  68 |   ".png",
44796 |  69 |   ".jpg",
44797 |  70 |   ".jpeg",
44798 |  71 |   ".webp",
44799 |  72 |   ".gif",
44800 |  73 |   ".ico",
44801 |  74 |   ".pdf",
44802 |  75 |   ".zip",
44803 |  76 |   ".rar",
44804 |  77 |   ".7z",
44805 |  78 |   ".tar",
44806 |  79 |   ".gz",
44807 |  80 |   ".exe",
44808 |  81 |   ".dll",
44809 |  82 |   ".so",
44810 |  83 |   ".dylib",
44811 |  84 |   ".bin",
44812 |  85 |   ".woff",
44813 |  86 |   ".woff2",
44814 |  87 |   ".ttf",
44815 |  88 |   ".otf",
44816 |  89 |   ".mp4",
44817 |  90 |   ".mov",
44818 |  91 |   ".avi",
44819 |  92 |   ".mkv",
44820 |  93 |   ".mp3",
44821 |  94 |   ".wav",
44822 |  95 | ]);
44823 |  96 | 
44824 |  97 | function isHiddenName(name) {
44825 |  98 |   return name.startsWith(".") && name !== ".env" && !name.startsWith(".env.");
44826 |  99 | }
44827 | 100 | 
44828 | 101 | function normalizeRel(p) {
44829 | 102 |   const rel = path.relative(ROOT, p);
44830 | 103 |   return rel.split(path.sep).join("/");
44831 | 104 | }
44832 | 105 | 
44833 | 106 | function detectLangByExt(filePath) {
44834 | 107 |   const base = path.basename(filePath);
44835 | 108 |   const ext = path.extname(filePath).toLowerCase();
44836 | 109 | 
44837 | 110 |   if (base === ".env" || base.startsWith(".env.")) return "dotenv";
44838 | 111 |   if (ext === ".js" || ext === ".mjs" || ext === ".cjs") return "js";
44839 | 112 |   if (ext === ".ts") return "ts";
44840 | 113 |   if (ext === ".tsx") return "tsx";
44841 | 114 |   if (ext === ".jsx") return "jsx";
44842 | 115 |   if (ext === ".json") return "json";
44843 | 116 |   if (ext === ".html") return "html";
44844 | 117 |   if (ext === ".css") return "css";
44845 | 118 |   if (ext === ".yml" || ext === ".yaml") return "yaml";
44846 | 119 |   if (ext === ".md") return "md";
44847 | 120 |   return "";
44848 | 121 | }
44849 | 122 | 
44850 | 123 | function looksBinaryByExt(filePath) {
44851 | 124 |   const ext = path.extname(filePath).toLowerCase();
44852 | 125 |   return BINARY_EXT.has(ext);
44853 | 126 | }
44854 | 127 | 
44855 | 128 | function isAllowedFile(filePath) {
44856 | 129 |   const name = path.basename(filePath);
44857 | 130 |   if (IGNORE_FILES.has(name)) return false;
44858 | 131 | 
44859 | 132 |   const ext = path.extname(name).toLowerCase();
44860 | 133 |   if (looksBinaryByExt(filePath)) return false;
44861 | 134 | 
44862 | 135 |   // specjalnie traktujemy .env bez rozszerzenia
44863 | 136 |   if (name === ".env" || name.startsWith(".env.")) return true;
44864 | 137 | 
44865 | 138 |   if (!ext) return false;
44866 | 139 |   return ALLOWED_EXT.has(ext);
44867 | 140 | }
44868 | 141 | 
44869 | 142 | function stripWeirdControlChars(s) {
44870 | 143 |   // usu≈Ñ NUL i inne kontrolne, kt√≥re potrafiƒÖ rozwaliƒá MD
44871 | 144 |   return s.replace(/\u0000/g, "");
44872 | 145 | }
44873 | 146 | 
44874 | 147 | function safeReadText(filePath) {
44875 | 148 |   const st = fs.statSync(filePath);
44876 | 149 |   if (st.size > MAX_BYTES) {
44877 | 150 |     return {
44878 | 151 |       ok: false,
44879 | 152 |       reason: `Plik wiƒôkszy ni≈º limit (${st.size} B > ${MAX_BYTES} B)`,
44880 | 153 |       text: null,
44881 | 154 |       size: st.size,
44882 | 155 |     };
44883 | 156 |   }
44884 | 157 | 
44885 | 158 |   // szybka detekcja binarki po pierwszych bajtach (NUL)
44886 | 159 |   const buf = fs.readFileSync(filePath);
44887 | 160 |   for (let i = 0; i < Math.min(buf.length, 4096); i++) {
44888 | 161 |     if (buf[i] === 0) {
44889 | 162 |       return { ok: false, reason: "Wykryto binarkƒô (NUL byte)", text: null, size: st.size };
44890 | 163 |     }
44891 | 164 |   }
44892 | 165 | 
44893 | 166 |   const text = stripWeirdControlChars(buf.toString("utf8"));
44894 | 167 |   return { ok: true, reason: null, text, size: st.size };
44895 | 168 | }
44896 | 169 | 
44897 | 170 | function padLeft(n, width) {
44898 | 171 |   const s = String(n);
44899 | 172 |   return s.length >= width ? s : " ".repeat(width - s.length) + s;
44900 | 173 | }
44901 | 174 | 
44902 | 175 | function addLineNumbers(text) {
44903 | 176 |   const lines = text.split(/\r?\n/);
44904 | 177 |   const width = String(lines.length).length;
44905 | 178 |   return lines
44906 | 179 |     .map((line, idx) => `${padLeft(idx + 1, width)} | ${line}`)
44907 | 180 |     .join("\n");
44908 | 181 | }
44909 | 182 | 
44910 | 183 | function mdEscapeHeadingAnchor(s) {
44911 | 184 |   // GitHub-like anchor (uproszczony i stabilny)
44912 | 185 |   // "src/fb/comments.js" -> "srcfbcommentsjs"
44913 | 186 |   return s
44914 | 187 |     .toLowerCase()
44915 | 188 |     .replace(/[`]/g, "")
44916 | 189 |     .replace(/[^\p{L}\p{N}\s/-]+/gu, "") // usu≈Ñ znaki inne ni≈º litery/cyfry/spacje/-/
44917 | 190 |     .replace(/\s+/g, "-")
44918 | 191 |     .replace(/[\/]/g, "-")
44919 | 192 |     .replace(/-+/g, "-")
44920 | 193 |     .replace(/^-|-$/g, "");
44921 | 194 | }
44922 | 195 | 
44923 | 196 | function guessDescription(relPath) {
44924 | 197 |   const p = relPath.toLowerCase();
44925 | 198 |   if (p.includes("/fb/")) return "Logika Facebook/Puppeteer (nawigacja, UI, komentarze, logowanie).";
44926 | 199 |   if (p.includes("/panel/")) return "Panel (frontend/backend) do zarzƒÖdzania postami i us≈ÇugƒÖ.";
44927 | 200 |   if (p.includes("/utils/")) return "Utility helpers (sleep, nawigacja, parsowanie, itp.).";
44928 | 201 |   if (p.endsWith("watcher.js")) return "G≈Ç√≥wna pƒôtla watchera: uruchomienie Puppeteera, cykle, cache, webhook/telegram.";
44929 | 202 |   if (p.endsWith("config.js") || p.endsWith(".env") || p.includes(".env")) return "Konfiguracja ≈õrodowiska / sta≈Çe / ustawienia.";
44930 | 203 |   if (p.endsWith("package.json")) return "Metadane projektu i zale≈ºno≈õci (npm).";
44931 | 204 |   return "Plik projektu (kod/konfiguracja).";
44932 | 205 | }
44933 | 206 | 
44934 | 207 | function walk(dir, outFiles) {
44935 | 208 |   const entries = fs.readdirSync(dir, { withFileTypes: true });
44936 | 209 | 
44937 | 210 |   for (const ent of entries) {
44938 | 211 |     const full = path.join(dir, ent.name);
44939 | 212 | 
44940 | 213 |     if (ent.isDirectory()) {
44941 | 214 |       if (IGNORE_DIRS.has(ent.name)) continue;
44942 | 215 |       if (isHiddenName(ent.name)) continue;
44943 | 216 |       walk(full, outFiles);
44944 | 217 |       continue;
44945 | 218 |     }
44946 | 219 | 
44947 | 220 |     if (!ent.isFile()) continue;
44948 | 221 | 
44949 | 222 |     // ukryte pliki: dopuszczamy .env* i .github? -> tu domy≈õlnie pomijamy ukryte poza .env*
44950 | 223 |     if (isHiddenName(ent.name) && !(ent.name === ".env" || ent.name.startsWith(".env."))) continue;
44951 | 224 | 
44952 | 225 |     if (!isAllowedFile(full)) continue;
44953 | 226 | 
44954 | 227 |     outFiles.push(full);
44955 | 228 |   }
44956 | 229 | }
44957 | 230 | 
44958 | 231 | function sortFiles(files) {
44959 | 232 |   // 1) configy i root files na g√≥rze
44960 | 233 |   // 2) src/ potem reszta
44961 | 234 |   // 3) alfabetycznie
44962 | 235 |   const rel = (f) => normalizeRel(f);
44963 | 236 | 
44964 | 237 |   const score = (r) => {
44965 | 238 |     const low = r.toLowerCase();
44966 | 239 |     if (low === "package.json") return 0;
44967 | 240 |     if (low.startsWith(".env")) return 1;
44968 | 241 |     if (low.includes("config")) return 2;
44969 | 242 |     if (low.startsWith("src/")) return 10;
44970 | 243 |     if (low.includes("panel")) return 20;
44971 | 244 |     return 30;
44972 | 245 |   };
44973 | 246 | 
44974 | 247 |   return [...files].sort((a, b) => {
44975 | 248 |     const ra = rel(a);
44976 | 249 |     const rb = rel(b);
44977 | 250 |     const sa = score(ra);
44978 | 251 |     const sb = score(rb);
44979 | 252 |     if (sa !== sb) return sa - sb;
44980 | 253 |     return ra.localeCompare(rb);
44981 | 254 |   });
44982 | 255 | }
44983 | 256 | 
44984 | 257 | function main() {
44985 | 258 |   const files = [];
44986 | 259 |   walk(ROOT, files);
44987 | 260 | 
44988 | 261 |   const sorted = sortFiles(files);
44989 | 262 | 
44990 | 263 |   const projectName = path.basename(ROOT);
44991 | 264 |   const nowIso = new Date().toISOString();
44992 | 265 | 
44993 | 266 |   let md = "";
44994 | 267 |   md += `# üì¶ EXPORT PROJEKTU: ${projectName}\n\n`;
44995 | 268 |   md += `**Root:** \`${ROOT}\`  \n`;
44996 | 269 |   md += `**Wygenerowano:** \`${nowIso}\`  \n`;
44997 | 270 |   md += `**Liczba plik√≥w:** \`${sorted.length}\`  \n`;
44998 | 271 |   md += `**Max rozmiar pliku:** \`${MAX_BYTES} B\`  \n\n`;
44999 | 272 | 
45000 | 273 |   md += `## üß≠ Spis tre≈õci\n`;
45001 | 274 |   for (const f of sorted) {
45002 | 275 |     const r = normalizeRel(f);
45003 | 276 |     const anchor = mdEscapeHeadingAnchor(`≈õcie≈ºka-${r}`);
45004 | 277 |     md += `- [${r}](#${anchor})\n`;
45005 | 278 |   }
45006 | 279 |   md += `\n---\n\n`;
45007 | 280 | 
45008 | 281 |   for (const f of sorted) {
45009 | 282 |     const r = normalizeRel(f);
45010 | 283 |     const lang = detectLangByExt(f);
45011 | 284 |     const ext = path.extname(f).toLowerCase();
45012 | 285 |     const type =
45013 | 286 |       r.endsWith(".md") ? "Markdown" :
45014 | 287 |       r.endsWith(".json") ? "JSON" :
45015 | 288 |       (r === ".env" || r.startsWith(".env.")) ? "ENV" :
45016 | 289 |       (ext === ".html") ? "HTML" :
45017 | 290 |       (ext === ".css") ? "CSS" :
45018 | 291 |       (ext === ".yml" || ext === ".yaml") ? "YAML" :
45019 | 292 |       (ext === ".ts" || ext === ".tsx") ? "TypeScript" :
45020 | 293 |       "JavaScript/tekst";
45021 | 294 | 
45022 | 295 |     const desc = guessDescription(r);
45023 | 296 | 
45024 | 297 |     const read = safeReadText(f);
45025 | 298 |     md += `### üìÑ ≈öcie≈ºka: \`${r}\`\n`;
45026 | 299 |     md += `**Typ:** ${type}  \n`;
45027 | 300 |     md += `**Opis:** ${desc}  \n`;
45028 | 301 | 
45029 | 302 |     if (!read.ok) {
45030 | 303 |       md += `**UWAGA:** pominiƒôto tre≈õƒá ‚Üí ${read.reason}  \n\n`;
45031 | 304 |       md += `---\n\n`;
45032 | 305 |       continue;
45033 | 306 |     }
45034 | 307 | 
45035 | 308 |     const numbered = addLineNumbers(read.text);
45036 | 309 | 
45037 | 310 |     md += `\n\`\`\`${lang}\n`;
45038 | 311 |     md += `${numbered}\n`;
45039 | 312 |     md += `\`\`\`\n\n`;
45040 | 313 |     md += `---\n\n`;
45041 | 314 |   }
45042 | 315 | 
45043 | 316 |   fs.writeFileSync(OUT_FILE, md, "utf8");
45044 | 317 |   console.log(`[EXPORT] OK -> ${OUT_FILE}`);
45045 | 318 |   console.log(`[EXPORT] Plik√≥w: ${sorted.length}`);
45046 | 319 | }
45047 | 320 | 
45048 | 321 | try {
45049 | 322 |   main();
45050 | 323 | } catch (e) {
45051 | 324 |   console.error("[EXPORT] ERROR:", e?.stack || e?.message || String(e));
45052 | 325 |   process.exit(1);
45053 | 326 | }
45054 | 327 | 
45055 | ```
45056 | 
45057 | ---
45058 | 
45059 | 
```

---

### üìÑ ≈öcie≈ºka: `package-lock.json`
**Typ:** JSON  
**Opis:** Plik projektu (kod/konfiguracja).  

```json
   1 | {
   2 |   "name": "fb_puppeteer",
   3 |   "version": "1.0.0",
   4 |   "lockfileVersion": 3,
   5 |   "requires": true,
   6 |   "packages": {
   7 |     "": {
   8 |       "name": "fb_puppeteer",
   9 |       "version": "1.0.0",
  10 |       "license": "ISC",
  11 |       "dependencies": {
  12 |         "axios": "^1.13.2",
  13 |         "dotenv": "^17.2.3",
  14 |         "puppeteer": "^24.31.0",
  15 |         "puppeteer-extra": "^3.3.6",
  16 |         "puppeteer-extra-plugin-recaptcha": "^3.6.8",
  17 |         "puppeteer-extra-plugin-stealth": "^2.11.2"
  18 |       },
  19 |       "devDependencies": {
  20 |         "@yao-pkg/pkg": "^6.11.0",
  21 |         "esbuild": "^0.27.2",
  22 |         "nexe": "^5.0.0-beta.4",
  23 |         "pkg": "^5.8.1"
  24 |       }
  25 |     },
  26 |     "node_modules/@babel/code-frame": {
  27 |       "version": "7.27.1",
  28 |       "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
  29 |       "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
  30 |       "license": "MIT",
  31 |       "dependencies": {
  32 |         "@babel/helper-validator-identifier": "^7.27.1",
  33 |         "js-tokens": "^4.0.0",
  34 |         "picocolors": "^1.1.1"
  35 |       },
  36 |       "engines": {
  37 |         "node": ">=6.9.0"
  38 |       }
  39 |     },
  40 |     "node_modules/@babel/generator": {
  41 |       "version": "7.18.2",
  42 |       "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.18.2.tgz",
  43 |       "integrity": "sha512-W1lG5vUwFvfMd8HVXqdfbuG7RuaSrTCCD8cl8fP8wOivdbtbIg2Db3IWUcgvfxKbbn6ZBGYRW/Zk1MIwK49mgw==",
  44 |       "dev": true,
  45 |       "license": "MIT",
  46 |       "dependencies": {
  47 |         "@babel/types": "^7.18.2",
  48 |         "@jridgewell/gen-mapping": "^0.3.0",
  49 |         "jsesc": "^2.5.1"
  50 |       },
  51 |       "engines": {
  52 |         "node": ">=6.9.0"
  53 |       }
  54 |     },
  55 |     "node_modules/@babel/helper-string-parser": {
  56 |       "version": "7.27.1",
  57 |       "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
  58 |       "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
  59 |       "dev": true,
  60 |       "license": "MIT",
  61 |       "engines": {
  62 |         "node": ">=6.9.0"
  63 |       }
  64 |     },
  65 |     "node_modules/@babel/helper-validator-identifier": {
  66 |       "version": "7.28.5",
  67 |       "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
  68 |       "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
  69 |       "license": "MIT",
  70 |       "engines": {
  71 |         "node": ">=6.9.0"
  72 |       }
  73 |     },
  74 |     "node_modules/@babel/parser": {
  75 |       "version": "7.18.4",
  76 |       "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.18.4.tgz",
  77 |       "integrity": "sha512-FDge0dFazETFcxGw/EXzOkN8uJp0PC7Qbm+Pe9T+av2zlBpOgunFHkQPPn+eRuClU73JF+98D531UgayY89tow==",
  78 |       "dev": true,
  79 |       "license": "MIT",
  80 |       "bin": {
  81 |         "parser": "bin/babel-parser.js"
  82 |       },
  83 |       "engines": {
  84 |         "node": ">=6.0.0"
  85 |       }
  86 |     },
  87 |     "node_modules/@babel/types": {
  88 |       "version": "7.19.0",
  89 |       "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.19.0.tgz",
  90 |       "integrity": "sha512-YuGopBq3ke25BVSiS6fgF49Ul9gH1x70Bcr6bqRLjWCkcX8Hre1/5+z+IiWOIerRMSSEfGZVB9z9kyq7wVs9YA==",
  91 |       "dev": true,
  92 |       "license": "MIT",
  93 |       "dependencies": {
  94 |         "@babel/helper-string-parser": "^7.18.10",
  95 |         "@babel/helper-validator-identifier": "^7.18.6",
  96 |         "to-fast-properties": "^2.0.0"
  97 |       },
  98 |       "engines": {
  99 |         "node": ">=6.9.0"
 100 |       }
 101 |     },
 102 |     "node_modules/@calebboyd/semaphore": {
 103 |       "version": "1.3.1",
 104 |       "resolved": "https://registry.npmjs.org/@calebboyd/semaphore/-/semaphore-1.3.1.tgz",
 105 |       "integrity": "sha512-17z9me12RgAEcMhIgR7f+BiXKbzwF9p1VraI69OxrUUSWGuSMOyOTEHQNVtMKuVrkEDVD0/Av5uiGZPBMYZljw==",
 106 |       "dev": true,
 107 |       "license": "MIT"
 108 |     },
 109 |     "node_modules/@discoveryjs/json-ext": {
 110 |       "version": "0.6.3",
 111 |       "resolved": "https://registry.npmjs.org/@discoveryjs/json-ext/-/json-ext-0.6.3.tgz",
 112 |       "integrity": "sha512-4B4OijXeVNOPZlYA2oEwWOTkzyltLao+xbotHQeqN++Rv27Y6s818+n2Qkp8q+Fxhn0t/5lA5X1Mxktud8eayQ==",
 113 |       "dev": true,
 114 |       "license": "MIT",
 115 |       "engines": {
 116 |         "node": ">=14.17.0"
 117 |       }
 118 |     },
 119 |     "node_modules/@esbuild/aix-ppc64": {
 120 |       "version": "0.27.2",
 121 |       "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.27.2.tgz",
 122 |       "integrity": "sha512-GZMB+a0mOMZs4MpDbj8RJp4cw+w1WV5NYD6xzgvzUJ5Ek2jerwfO2eADyI6ExDSUED+1X8aMbegahsJi+8mgpw==",
 123 |       "cpu": [
 124 |         "ppc64"
 125 |       ],
 126 |       "dev": true,
 127 |       "license": "MIT",
 128 |       "optional": true,
 129 |       "os": [
 130 |         "aix"
 131 |       ],
 132 |       "engines": {
 133 |         "node": ">=18"
 134 |       }
 135 |     },
 136 |     "node_modules/@esbuild/android-arm": {
 137 |       "version": "0.27.2",
 138 |       "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.27.2.tgz",
 139 |       "integrity": "sha512-DVNI8jlPa7Ujbr1yjU2PfUSRtAUZPG9I1RwW4F4xFB1Imiu2on0ADiI/c3td+KmDtVKNbi+nffGDQMfcIMkwIA==",
 140 |       "cpu": [
 141 |         "arm"
 142 |       ],
 143 |       "dev": true,
 144 |       "license": "MIT",
 145 |       "optional": true,
 146 |       "os": [
 147 |         "android"
 148 |       ],
 149 |       "engines": {
 150 |         "node": ">=18"
 151 |       }
 152 |     },
 153 |     "node_modules/@esbuild/android-arm64": {
 154 |       "version": "0.27.2",
 155 |       "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.27.2.tgz",
 156 |       "integrity": "sha512-pvz8ZZ7ot/RBphf8fv60ljmaoydPU12VuXHImtAs0XhLLw+EXBi2BLe3OYSBslR4rryHvweW5gmkKFwTiFy6KA==",
 157 |       "cpu": [
 158 |         "arm64"
 159 |       ],
 160 |       "dev": true,
 161 |       "license": "MIT",
 162 |       "optional": true,
 163 |       "os": [
 164 |         "android"
 165 |       ],
 166 |       "engines": {
 167 |         "node": ">=18"
 168 |       }
 169 |     },
 170 |     "node_modules/@esbuild/android-x64": {
 171 |       "version": "0.27.2",
 172 |       "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.27.2.tgz",
 173 |       "integrity": "sha512-z8Ank4Byh4TJJOh4wpz8g2vDy75zFL0TlZlkUkEwYXuPSgX8yzep596n6mT7905kA9uHZsf/o2OJZubl2l3M7A==",
 174 |       "cpu": [
 175 |         "x64"
 176 |       ],
 177 |       "dev": true,
 178 |       "license": "MIT",
 179 |       "optional": true,
 180 |       "os": [
 181 |         "android"
 182 |       ],
 183 |       "engines": {
 184 |         "node": ">=18"
 185 |       }
 186 |     },
 187 |     "node_modules/@esbuild/darwin-arm64": {
 188 |       "version": "0.27.2",
 189 |       "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.27.2.tgz",
 190 |       "integrity": "sha512-davCD2Zc80nzDVRwXTcQP/28fiJbcOwvdolL0sOiOsbwBa72kegmVU0Wrh1MYrbuCL98Omp5dVhQFWRKR2ZAlg==",
 191 |       "cpu": [
 192 |         "arm64"
 193 |       ],
 194 |       "dev": true,
 195 |       "license": "MIT",
 196 |       "optional": true,
 197 |       "os": [
 198 |         "darwin"
 199 |       ],
 200 |       "engines": {
 201 |         "node": ">=18"
 202 |       }
 203 |     },
 204 |     "node_modules/@esbuild/darwin-x64": {
 205 |       "version": "0.27.2",
 206 |       "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.27.2.tgz",
 207 |       "integrity": "sha512-ZxtijOmlQCBWGwbVmwOF/UCzuGIbUkqB1faQRf5akQmxRJ1ujusWsb3CVfk/9iZKr2L5SMU5wPBi1UWbvL+VQA==",
 208 |       "cpu": [
 209 |         "x64"
 210 |       ],
 211 |       "dev": true,
 212 |       "license": "MIT",
 213 |       "optional": true,
 214 |       "os": [
 215 |         "darwin"
 216 |       ],
 217 |       "engines": {
 218 |         "node": ">=18"
 219 |       }
 220 |     },
 221 |     "node_modules/@esbuild/freebsd-arm64": {
 222 |       "version": "0.27.2",
 223 |       "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.27.2.tgz",
 224 |       "integrity": "sha512-lS/9CN+rgqQ9czogxlMcBMGd+l8Q3Nj1MFQwBZJyoEKI50XGxwuzznYdwcav6lpOGv5BqaZXqvBSiB/kJ5op+g==",
 225 |       "cpu": [
 226 |         "arm64"
 227 |       ],
 228 |       "dev": true,
 229 |       "license": "MIT",
 230 |       "optional": true,
 231 |       "os": [
 232 |         "freebsd"
 233 |       ],
 234 |       "engines": {
 235 |         "node": ">=18"
 236 |       }
 237 |     },
 238 |     "node_modules/@esbuild/freebsd-x64": {
 239 |       "version": "0.27.2",
 240 |       "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.27.2.tgz",
 241 |       "integrity": "sha512-tAfqtNYb4YgPnJlEFu4c212HYjQWSO/w/h/lQaBK7RbwGIkBOuNKQI9tqWzx7Wtp7bTPaGC6MJvWI608P3wXYA==",
 242 |       "cpu": [
 243 |         "x64"
 244 |       ],
 245 |       "dev": true,
 246 |       "license": "MIT",
 247 |       "optional": true,
 248 |       "os": [
 249 |         "freebsd"
 250 |       ],
 251 |       "engines": {
 252 |         "node": ">=18"
 253 |       }
 254 |     },
 255 |     "node_modules/@esbuild/linux-arm": {
 256 |       "version": "0.27.2",
 257 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.27.2.tgz",
 258 |       "integrity": "sha512-vWfq4GaIMP9AIe4yj1ZUW18RDhx6EPQKjwe7n8BbIecFtCQG4CfHGaHuh7fdfq+y3LIA2vGS/o9ZBGVxIDi9hw==",
 259 |       "cpu": [
 260 |         "arm"
 261 |       ],
 262 |       "dev": true,
 263 |       "license": "MIT",
 264 |       "optional": true,
 265 |       "os": [
 266 |         "linux"
 267 |       ],
 268 |       "engines": {
 269 |         "node": ">=18"
 270 |       }
 271 |     },
 272 |     "node_modules/@esbuild/linux-arm64": {
 273 |       "version": "0.27.2",
 274 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.27.2.tgz",
 275 |       "integrity": "sha512-hYxN8pr66NsCCiRFkHUAsxylNOcAQaxSSkHMMjcpx0si13t1LHFphxJZUiGwojB1a/Hd5OiPIqDdXONia6bhTw==",
 276 |       "cpu": [
 277 |         "arm64"
 278 |       ],
 279 |       "dev": true,
 280 |       "license": "MIT",
 281 |       "optional": true,
 282 |       "os": [
 283 |         "linux"
 284 |       ],
 285 |       "engines": {
 286 |         "node": ">=18"
 287 |       }
 288 |     },
 289 |     "node_modules/@esbuild/linux-ia32": {
 290 |       "version": "0.27.2",
 291 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.27.2.tgz",
 292 |       "integrity": "sha512-MJt5BRRSScPDwG2hLelYhAAKh9imjHK5+NE/tvnRLbIqUWa+0E9N4WNMjmp/kXXPHZGqPLxggwVhz7QP8CTR8w==",
 293 |       "cpu": [
 294 |         "ia32"
 295 |       ],
 296 |       "dev": true,
 297 |       "license": "MIT",
 298 |       "optional": true,
 299 |       "os": [
 300 |         "linux"
 301 |       ],
 302 |       "engines": {
 303 |         "node": ">=18"
 304 |       }
 305 |     },
 306 |     "node_modules/@esbuild/linux-loong64": {
 307 |       "version": "0.27.2",
 308 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.27.2.tgz",
 309 |       "integrity": "sha512-lugyF1atnAT463aO6KPshVCJK5NgRnU4yb3FUumyVz+cGvZbontBgzeGFO1nF+dPueHD367a2ZXe1NtUkAjOtg==",
 310 |       "cpu": [
 311 |         "loong64"
 312 |       ],
 313 |       "dev": true,
 314 |       "license": "MIT",
 315 |       "optional": true,
 316 |       "os": [
 317 |         "linux"
 318 |       ],
 319 |       "engines": {
 320 |         "node": ">=18"
 321 |       }
 322 |     },
 323 |     "node_modules/@esbuild/linux-mips64el": {
 324 |       "version": "0.27.2",
 325 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.27.2.tgz",
 326 |       "integrity": "sha512-nlP2I6ArEBewvJ2gjrrkESEZkB5mIoaTswuqNFRv/WYd+ATtUpe9Y09RnJvgvdag7he0OWgEZWhviS1OTOKixw==",
 327 |       "cpu": [
 328 |         "mips64el"
 329 |       ],
 330 |       "dev": true,
 331 |       "license": "MIT",
 332 |       "optional": true,
 333 |       "os": [
 334 |         "linux"
 335 |       ],
 336 |       "engines": {
 337 |         "node": ">=18"
 338 |       }
 339 |     },
 340 |     "node_modules/@esbuild/linux-ppc64": {
 341 |       "version": "0.27.2",
 342 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.27.2.tgz",
 343 |       "integrity": "sha512-C92gnpey7tUQONqg1n6dKVbx3vphKtTHJaNG2Ok9lGwbZil6DrfyecMsp9CrmXGQJmZ7iiVXvvZH6Ml5hL6XdQ==",
 344 |       "cpu": [
 345 |         "ppc64"
 346 |       ],
 347 |       "dev": true,
 348 |       "license": "MIT",
 349 |       "optional": true,
 350 |       "os": [
 351 |         "linux"
 352 |       ],
 353 |       "engines": {
 354 |         "node": ">=18"
 355 |       }
 356 |     },
 357 |     "node_modules/@esbuild/linux-riscv64": {
 358 |       "version": "0.27.2",
 359 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.27.2.tgz",
 360 |       "integrity": "sha512-B5BOmojNtUyN8AXlK0QJyvjEZkWwy/FKvakkTDCziX95AowLZKR6aCDhG7LeF7uMCXEJqwa8Bejz5LTPYm8AvA==",
 361 |       "cpu": [
 362 |         "riscv64"
 363 |       ],
 364 |       "dev": true,
 365 |       "license": "MIT",
 366 |       "optional": true,
 367 |       "os": [
 368 |         "linux"
 369 |       ],
 370 |       "engines": {
 371 |         "node": ">=18"
 372 |       }
 373 |     },
 374 |     "node_modules/@esbuild/linux-s390x": {
 375 |       "version": "0.27.2",
 376 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.27.2.tgz",
 377 |       "integrity": "sha512-p4bm9+wsPwup5Z8f4EpfN63qNagQ47Ua2znaqGH6bqLlmJ4bx97Y9JdqxgGZ6Y8xVTixUnEkoKSHcpRlDnNr5w==",
 378 |       "cpu": [
 379 |         "s390x"
 380 |       ],
 381 |       "dev": true,
 382 |       "license": "MIT",
 383 |       "optional": true,
 384 |       "os": [
 385 |         "linux"
 386 |       ],
 387 |       "engines": {
 388 |         "node": ">=18"
 389 |       }
 390 |     },
 391 |     "node_modules/@esbuild/linux-x64": {
 392 |       "version": "0.27.2",
 393 |       "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.27.2.tgz",
 394 |       "integrity": "sha512-uwp2Tip5aPmH+NRUwTcfLb+W32WXjpFejTIOWZFw/v7/KnpCDKG66u4DLcurQpiYTiYwQ9B7KOeMJvLCu/OvbA==",
 395 |       "cpu": [
 396 |         "x64"
 397 |       ],
 398 |       "dev": true,
 399 |       "license": "MIT",
 400 |       "optional": true,
 401 |       "os": [
 402 |         "linux"
 403 |       ],
 404 |       "engines": {
 405 |         "node": ">=18"
 406 |       }
 407 |     },
 408 |     "node_modules/@esbuild/netbsd-arm64": {
 409 |       "version": "0.27.2",
 410 |       "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.27.2.tgz",
 411 |       "integrity": "sha512-Kj6DiBlwXrPsCRDeRvGAUb/LNrBASrfqAIok+xB0LxK8CHqxZ037viF13ugfsIpePH93mX7xfJp97cyDuTZ3cw==",
 412 |       "cpu": [
 413 |         "arm64"
 414 |       ],
 415 |       "dev": true,
 416 |       "license": "MIT",
 417 |       "optional": true,
 418 |       "os": [
 419 |         "netbsd"
 420 |       ],
 421 |       "engines": {
 422 |         "node": ">=18"
 423 |       }
 424 |     },
 425 |     "node_modules/@esbuild/netbsd-x64": {
 426 |       "version": "0.27.2",
 427 |       "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.27.2.tgz",
 428 |       "integrity": "sha512-HwGDZ0VLVBY3Y+Nw0JexZy9o/nUAWq9MlV7cahpaXKW6TOzfVno3y3/M8Ga8u8Yr7GldLOov27xiCnqRZf0tCA==",
 429 |       "cpu": [
 430 |         "x64"
 431 |       ],
 432 |       "dev": true,
 433 |       "license": "MIT",
 434 |       "optional": true,
 435 |       "os": [
 436 |         "netbsd"
 437 |       ],
 438 |       "engines": {
 439 |         "node": ">=18"
 440 |       }
 441 |     },
 442 |     "node_modules/@esbuild/openbsd-arm64": {
 443 |       "version": "0.27.2",
 444 |       "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.27.2.tgz",
 445 |       "integrity": "sha512-DNIHH2BPQ5551A7oSHD0CKbwIA/Ox7+78/AWkbS5QoRzaqlev2uFayfSxq68EkonB+IKjiuxBFoV8ESJy8bOHA==",
 446 |       "cpu": [
 447 |         "arm64"
 448 |       ],
 449 |       "dev": true,
 450 |       "license": "MIT",
 451 |       "optional": true,
 452 |       "os": [
 453 |         "openbsd"
 454 |       ],
 455 |       "engines": {
 456 |         "node": ">=18"
 457 |       }
 458 |     },
 459 |     "node_modules/@esbuild/openbsd-x64": {
 460 |       "version": "0.27.2",
 461 |       "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.27.2.tgz",
 462 |       "integrity": "sha512-/it7w9Nb7+0KFIzjalNJVR5bOzA9Vay+yIPLVHfIQYG/j+j9VTH84aNB8ExGKPU4AzfaEvN9/V4HV+F+vo8OEg==",
 463 |       "cpu": [
 464 |         "x64"
 465 |       ],
 466 |       "dev": true,
 467 |       "license": "MIT",
 468 |       "optional": true,
 469 |       "os": [
 470 |         "openbsd"
 471 |       ],
 472 |       "engines": {
 473 |         "node": ">=18"
 474 |       }
 475 |     },
 476 |     "node_modules/@esbuild/openharmony-arm64": {
 477 |       "version": "0.27.2",
 478 |       "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.27.2.tgz",
 479 |       "integrity": "sha512-LRBbCmiU51IXfeXk59csuX/aSaToeG7w48nMwA6049Y4J4+VbWALAuXcs+qcD04rHDuSCSRKdmY63sruDS5qag==",
 480 |       "cpu": [
 481 |         "arm64"
 482 |       ],
 483 |       "dev": true,
 484 |       "license": "MIT",
 485 |       "optional": true,
 486 |       "os": [
 487 |         "openharmony"
 488 |       ],
 489 |       "engines": {
 490 |         "node": ">=18"
 491 |       }
 492 |     },
 493 |     "node_modules/@esbuild/sunos-x64": {
 494 |       "version": "0.27.2",
 495 |       "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.27.2.tgz",
 496 |       "integrity": "sha512-kMtx1yqJHTmqaqHPAzKCAkDaKsffmXkPHThSfRwZGyuqyIeBvf08KSsYXl+abf5HDAPMJIPnbBfXvP2ZC2TfHg==",
 497 |       "cpu": [
 498 |         "x64"
 499 |       ],
 500 |       "dev": true,
 501 |       "license": "MIT",
 502 |       "optional": true,
 503 |       "os": [
 504 |         "sunos"
 505 |       ],
 506 |       "engines": {
 507 |         "node": ">=18"
 508 |       }
 509 |     },
 510 |     "node_modules/@esbuild/win32-arm64": {
 511 |       "version": "0.27.2",
 512 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.27.2.tgz",
 513 |       "integrity": "sha512-Yaf78O/B3Kkh+nKABUF++bvJv5Ijoy9AN1ww904rOXZFLWVc5OLOfL56W+C8F9xn5JQZa3UX6m+IktJnIb1Jjg==",
 514 |       "cpu": [
 515 |         "arm64"
 516 |       ],
 517 |       "dev": true,
 518 |       "license": "MIT",
 519 |       "optional": true,
 520 |       "os": [
 521 |         "win32"
 522 |       ],
 523 |       "engines": {
 524 |         "node": ">=18"
 525 |       }
 526 |     },
 527 |     "node_modules/@esbuild/win32-ia32": {
 528 |       "version": "0.27.2",
 529 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.27.2.tgz",
 530 |       "integrity": "sha512-Iuws0kxo4yusk7sw70Xa2E2imZU5HoixzxfGCdxwBdhiDgt9vX9VUCBhqcwY7/uh//78A1hMkkROMJq9l27oLQ==",
 531 |       "cpu": [
 532 |         "ia32"
 533 |       ],
 534 |       "dev": true,
 535 |       "license": "MIT",
 536 |       "optional": true,
 537 |       "os": [
 538 |         "win32"
 539 |       ],
 540 |       "engines": {
 541 |         "node": ">=18"
 542 |       }
 543 |     },
 544 |     "node_modules/@esbuild/win32-x64": {
 545 |       "version": "0.27.2",
 546 |       "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.27.2.tgz",
 547 |       "integrity": "sha512-sRdU18mcKf7F+YgheI/zGf5alZatMUTKj/jNS6l744f9u3WFu4v7twcUI9vu4mknF4Y9aDlblIie0IM+5xxaqQ==",
 548 |       "cpu": [
 549 |         "x64"
 550 |       ],
 551 |       "dev": true,
 552 |       "license": "MIT",
 553 |       "optional": true,
 554 |       "os": [
 555 |         "win32"
 556 |       ],
 557 |       "engines": {
 558 |         "node": ">=18"
 559 |       }
 560 |     },
 561 |     "node_modules/@isaacs/fs-minipass": {
 562 |       "version": "4.0.1",
 563 |       "resolved": "https://registry.npmjs.org/@isaacs/fs-minipass/-/fs-minipass-4.0.1.tgz",
 564 |       "integrity": "sha512-wgm9Ehl2jpeqP3zw/7mo3kRHFp5MEDhqAdwy1fTGkHAwnkGOVsgpvQhL8B5n1qlb01jV3n/bI0ZfZp5lWA1k4w==",
 565 |       "dev": true,
 566 |       "license": "ISC",
 567 |       "dependencies": {
 568 |         "minipass": "^7.0.4"
 569 |       },
 570 |       "engines": {
 571 |         "node": ">=18.0.0"
 572 |       }
 573 |     },
 574 |     "node_modules/@jridgewell/gen-mapping": {
 575 |       "version": "0.3.13",
 576 |       "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
 577 |       "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
 578 |       "dev": true,
 579 |       "license": "MIT",
 580 |       "dependencies": {
 581 |         "@jridgewell/sourcemap-codec": "^1.5.0",
 582 |         "@jridgewell/trace-mapping": "^0.3.24"
 583 |       }
 584 |     },
 585 |     "node_modules/@jridgewell/resolve-uri": {
 586 |       "version": "3.1.2",
 587 |       "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
 588 |       "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
 589 |       "dev": true,
 590 |       "license": "MIT",
 591 |       "engines": {
 592 |         "node": ">=6.0.0"
 593 |       }
 594 |     },
 595 |     "node_modules/@jridgewell/source-map": {
 596 |       "version": "0.3.11",
 597 |       "resolved": "https://registry.npmjs.org/@jridgewell/source-map/-/source-map-0.3.11.tgz",
 598 |       "integrity": "sha512-ZMp1V8ZFcPG5dIWnQLr3NSI1MiCU7UETdS/A0G8V/XWHvJv3ZsFqutJn1Y5RPmAPX6F3BiE397OqveU/9NCuIA==",
 599 |       "dev": true,
 600 |       "license": "MIT",
 601 |       "dependencies": {
 602 |         "@jridgewell/gen-mapping": "^0.3.5",
 603 |         "@jridgewell/trace-mapping": "^0.3.25"
 604 |       }
 605 |     },
 606 |     "node_modules/@jridgewell/sourcemap-codec": {
 607 |       "version": "1.5.5",
 608 |       "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
 609 |       "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
 610 |       "dev": true,
 611 |       "license": "MIT"
 612 |     },
 613 |     "node_modules/@jridgewell/trace-mapping": {
 614 |       "version": "0.3.31",
 615 |       "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
 616 |       "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
 617 |       "dev": true,
 618 |       "license": "MIT",
 619 |       "dependencies": {
 620 |         "@jridgewell/resolve-uri": "^3.1.0",
 621 |         "@jridgewell/sourcemap-codec": "^1.4.14"
 622 |       }
 623 |     },
 624 |     "node_modules/@nodelib/fs.scandir": {
 625 |       "version": "2.1.5",
 626 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
 627 |       "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
 628 |       "dev": true,
 629 |       "license": "MIT",
 630 |       "dependencies": {
 631 |         "@nodelib/fs.stat": "2.0.5",
 632 |         "run-parallel": "^1.1.9"
 633 |       },
 634 |       "engines": {
 635 |         "node": ">= 8"
 636 |       }
 637 |     },
 638 |     "node_modules/@nodelib/fs.stat": {
 639 |       "version": "2.0.5",
 640 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
 641 |       "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
 642 |       "dev": true,
 643 |       "license": "MIT",
 644 |       "engines": {
 645 |         "node": ">= 8"
 646 |       }
 647 |     },
 648 |     "node_modules/@nodelib/fs.walk": {
 649 |       "version": "1.2.8",
 650 |       "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
 651 |       "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
 652 |       "dev": true,
 653 |       "license": "MIT",
 654 |       "dependencies": {
 655 |         "@nodelib/fs.scandir": "2.1.5",
 656 |         "fastq": "^1.6.0"
 657 |       },
 658 |       "engines": {
 659 |         "node": ">= 8"
 660 |       }
 661 |     },
 662 |     "node_modules/@puppeteer/browsers": {
 663 |       "version": "2.10.13",
 664 |       "resolved": "https://registry.npmjs.org/@puppeteer/browsers/-/browsers-2.10.13.tgz",
 665 |       "integrity": "sha512-a9Ruw3j3qlnB5a/zHRTkruppynxqaeE4H9WNj5eYGRWqw0ZauZ23f4W2ARf3hghF5doozyD+CRtt7XSYuYRI/Q==",
 666 |       "license": "Apache-2.0",
 667 |       "dependencies": {
 668 |         "debug": "^4.4.3",
 669 |         "extract-zip": "^2.0.1",
 670 |         "progress": "^2.0.3",
 671 |         "proxy-agent": "^6.5.0",
 672 |         "semver": "^7.7.3",
 673 |         "tar-fs": "^3.1.1",
 674 |         "yargs": "^17.7.2"
 675 |       },
 676 |       "bin": {
 677 |         "browsers": "lib/cjs/main-cli.js"
 678 |       },
 679 |       "engines": {
 680 |         "node": ">=18"
 681 |       }
 682 |     },
 683 |     "node_modules/@sindresorhus/is": {
 684 |       "version": "5.6.0",
 685 |       "resolved": "https://registry.npmjs.org/@sindresorhus/is/-/is-5.6.0.tgz",
 686 |       "integrity": "sha512-TV7t8GKYaJWsn00tFDqBw8+Uqmr8A0fRU1tvTQhyZzGv0sJCGRQL3JGMI3ucuKo3XIZdUP+Lx7/gh2t3lewy7g==",
 687 |       "dev": true,
 688 |       "license": "MIT",
 689 |       "engines": {
 690 |         "node": ">=14.16"
 691 |       },
 692 |       "funding": {
 693 |         "url": "https://github.com/sindresorhus/is?sponsor=1"
 694 |       }
 695 |     },
 696 |     "node_modules/@szmarczak/http-timer": {
 697 |       "version": "5.0.1",
 698 |       "resolved": "https://registry.npmjs.org/@szmarczak/http-timer/-/http-timer-5.0.1.tgz",
 699 |       "integrity": "sha512-+PmQX0PiAYPMeVYe237LJAYvOMYW1j2rH5YROyS3b4CTVJum34HfRvKvAzozHAQG0TnHNdUfY9nCeUyRAs//cw==",
 700 |       "dev": true,
 701 |       "license": "MIT",
 702 |       "dependencies": {
 703 |         "defer-to-connect": "^2.0.1"
 704 |       },
 705 |       "engines": {
 706 |         "node": ">=14.16"
 707 |       }
 708 |     },
 709 |     "node_modules/@tootallnate/quickjs-emscripten": {
 710 |       "version": "0.23.0",
 711 |       "resolved": "https://registry.npmjs.org/@tootallnate/quickjs-emscripten/-/quickjs-emscripten-0.23.0.tgz",
 712 |       "integrity": "sha512-C5Mc6rdnsaJDjO3UpGW/CQTHtCKaYlScZTly4JIu97Jxo/odCiH0ITnDXSJPTOrEKk/ycSZ0AOgTmkDtkOsvIA==",
 713 |       "license": "MIT"
 714 |     },
 715 |     "node_modules/@types/debug": {
 716 |       "version": "4.1.12",
 717 |       "resolved": "https://registry.npmjs.org/@types/debug/-/debug-4.1.12.tgz",
 718 |       "integrity": "sha512-vIChWdVG3LG1SMxEvI/AK+FWJthlrqlTu7fbrlywTkkaONwk/UAGaULXRlf8vkzFBLVm0zkMdCquhL5aOjhXPQ==",
 719 |       "license": "MIT",
 720 |       "dependencies": {
 721 |         "@types/ms": "*"
 722 |       }
 723 |     },
 724 |     "node_modules/@types/emscripten": {
 725 |       "version": "1.41.5",
 726 |       "resolved": "https://registry.npmjs.org/@types/emscripten/-/emscripten-1.41.5.tgz",
 727 |       "integrity": "sha512-cMQm7pxu6BxtHyqJ7mQZ2kXWV5SLmugybFdHCBbJ5eHzOo6VhBckEgAT3//rP5FwPHNPeEiq4SmQ5ucBwsOo4Q==",
 728 |       "dev": true,
 729 |       "license": "MIT"
 730 |     },
 731 |     "node_modules/@types/eslint": {
 732 |       "version": "9.6.1",
 733 |       "resolved": "https://registry.npmjs.org/@types/eslint/-/eslint-9.6.1.tgz",
 734 |       "integrity": "sha512-FXx2pKgId/WyYo2jXw63kk7/+TY7u7AziEJxJAnSFzHlqTAS3Ync6SvgYAN/k4/PQpnnVuzoMuVnByKK2qp0ag==",
 735 |       "dev": true,
 736 |       "license": "MIT",
 737 |       "dependencies": {
 738 |         "@types/estree": "*",
 739 |         "@types/json-schema": "*"
 740 |       }
 741 |     },
 742 |     "node_modules/@types/eslint-scope": {
 743 |       "version": "3.7.7",
 744 |       "resolved": "https://registry.npmjs.org/@types/eslint-scope/-/eslint-scope-3.7.7.tgz",
 745 |       "integrity": "sha512-MzMFlSLBqNF2gcHWO0G1vP/YQyfvrxZ0bF+u7mzUdZ1/xK4A4sru+nraZz5i3iEIk1l1uyicaDVTB4QbbEkAYg==",
 746 |       "dev": true,
 747 |       "license": "MIT",
 748 |       "dependencies": {
 749 |         "@types/eslint": "*",
 750 |         "@types/estree": "*"
 751 |       }
 752 |     },
 753 |     "node_modules/@types/estree": {
 754 |       "version": "1.0.8",
 755 |       "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
 756 |       "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
 757 |       "dev": true,
 758 |       "license": "MIT"
 759 |     },
 760 |     "node_modules/@types/http-cache-semantics": {
 761 |       "version": "4.0.4",
 762 |       "resolved": "https://registry.npmjs.org/@types/http-cache-semantics/-/http-cache-semantics-4.0.4.tgz",
 763 |       "integrity": "sha512-1m0bIFVc7eJWyve9S0RnuRgcQqF/Xd5QsUZAZeQFr1Q3/p9JWoQQEqmVy+DPTNpGXwhgIetAoYF8JSc33q29QA==",
 764 |       "dev": true,
 765 |       "license": "MIT"
 766 |     },
 767 |     "node_modules/@types/json-schema": {
 768 |       "version": "7.0.15",
 769 |       "resolved": "https://registry.npmjs.org/@types/json-schema/-/json-schema-7.0.15.tgz",
 770 |       "integrity": "sha512-5+fP8P8MFNC+AyZCDxrB2pkZFPGzqQWUzpSeuuVLvm8VMcorNYavBqoFcxK8bQz4Qsbn4oUEEem4wDLfcysGHA==",
 771 |       "dev": true,
 772 |       "license": "MIT"
 773 |     },
 774 |     "node_modules/@types/ms": {
 775 |       "version": "2.1.0",
 776 |       "resolved": "https://registry.npmjs.org/@types/ms/-/ms-2.1.0.tgz",
 777 |       "integrity": "sha512-GsCCIZDE/p3i96vtEqx+7dBUGXrc7zeSK3wwPHIaRThS+9OhWIXRqzs4d6k1SVU8g91DrNRWxWUGhp5KXQb2VA==",
 778 |       "license": "MIT"
 779 |     },
 780 |     "node_modules/@types/node": {
 781 |       "version": "24.10.1",
 782 |       "resolved": "https://registry.npmjs.org/@types/node/-/node-24.10.1.tgz",
 783 |       "integrity": "sha512-GNWcUTRBgIRJD5zj+Tq0fKOJ5XZajIiBroOF0yvj2bSU1WvNdYS/dn9UxwsujGW4JX06dnHyjV2y9rRaybH0iQ==",
 784 |       "devOptional": true,
 785 |       "license": "MIT",
 786 |       "dependencies": {
 787 |         "undici-types": "~7.16.0"
 788 |       }
 789 |     },
 790 |     "node_modules/@types/source-list-map": {
 791 |       "version": "0.1.6",
 792 |       "resolved": "https://registry.npmjs.org/@types/source-list-map/-/source-list-map-0.1.6.tgz",
 793 |       "integrity": "sha512-5JcVt1u5HDmlXkwOD2nslZVllBBc7HDuOICfiZah2Z0is8M8g+ddAEawbmd3VjedfDHBzxCaXLs07QEmb7y54g==",
 794 |       "dev": true,
 795 |       "license": "MIT"
 796 |     },
 797 |     "node_modules/@types/tapable": {
 798 |       "version": "1.0.12",
 799 |       "resolved": "https://registry.npmjs.org/@types/tapable/-/tapable-1.0.12.tgz",
 800 |       "integrity": "sha512-bTHG8fcxEqv1M9+TD14P8ok8hjxoOCkfKc8XXLaaD05kI7ohpeI956jtDOD3XHKBQrlyPughUtzm1jtVhHpA5Q==",
 801 |       "dev": true,
 802 |       "license": "MIT"
 803 |     },
 804 |     "node_modules/@types/uglify-js": {
 805 |       "version": "3.17.5",
 806 |       "resolved": "https://registry.npmjs.org/@types/uglify-js/-/uglify-js-3.17.5.tgz",
 807 |       "integrity": "sha512-TU+fZFBTBcXj/GpDpDaBmgWk/gn96kMZ+uocaFUlV2f8a6WdMzzI44QBCmGcCiYR0Y6ZlNRiyUyKKt5nl/lbzQ==",
 808 |       "dev": true,
 809 |       "license": "MIT",
 810 |       "dependencies": {
 811 |         "source-map": "^0.6.1"
 812 |       }
 813 |     },
 814 |     "node_modules/@types/webpack": {
 815 |       "version": "4.41.40",
 816 |       "resolved": "https://registry.npmjs.org/@types/webpack/-/webpack-4.41.40.tgz",
 817 |       "integrity": "sha512-u6kMFSBM9HcoTpUXnL6mt2HSzftqb3JgYV6oxIgL2dl6sX6aCa5k6SOkzv5DuZjBTPUE/dJltKtwwuqrkZHpfw==",
 818 |       "dev": true,
 819 |       "license": "MIT",
 820 |       "dependencies": {
 821 |         "@types/node": "*",
 822 |         "@types/tapable": "^1",
 823 |         "@types/uglify-js": "*",
 824 |         "@types/webpack-sources": "*",
 825 |         "anymatch": "^3.0.0",
 826 |         "source-map": "^0.6.0"
 827 |       }
 828 |     },
 829 |     "node_modules/@types/webpack-sources": {
 830 |       "version": "3.2.3",
 831 |       "resolved": "https://registry.npmjs.org/@types/webpack-sources/-/webpack-sources-3.2.3.tgz",
 832 |       "integrity": "sha512-4nZOdMwSPHZ4pTEZzSp0AsTM4K7Qmu40UKW4tJDiOVs20UzYF9l+qUe4s0ftfN0pin06n+5cWWDJXH+sbhAiDw==",
 833 |       "dev": true,
 834 |       "license": "MIT",
 835 |       "dependencies": {
 836 |         "@types/node": "*",
 837 |         "@types/source-list-map": "*",
 838 |         "source-map": "^0.7.3"
 839 |       }
 840 |     },
 841 |     "node_modules/@types/webpack-sources/node_modules/source-map": {
 842 |       "version": "0.7.6",
 843 |       "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.7.6.tgz",
 844 |       "integrity": "sha512-i5uvt8C3ikiWeNZSVZNWcfZPItFQOsYTUAOkcUPGd8DqDy1uOUikjt5dG+uRlwyvR108Fb9DOd4GvXfT0N2/uQ==",
 845 |       "dev": true,
 846 |       "license": "BSD-3-Clause",
 847 |       "engines": {
 848 |         "node": ">= 12"
 849 |       }
 850 |     },
 851 |     "node_modules/@types/yauzl": {
 852 |       "version": "2.10.3",
 853 |       "resolved": "https://registry.npmjs.org/@types/yauzl/-/yauzl-2.10.3.tgz",
 854 |       "integrity": "sha512-oJoftv0LSuaDZE3Le4DbKX+KS9G36NzOeSap90UIK0yMA/NhKJhqlSGtNDORNRaIbQfzjXDrQa0ytJ6mNRGz/Q==",
 855 |       "license": "MIT",
 856 |       "optional": true,
 857 |       "dependencies": {
 858 |         "@types/node": "*"
 859 |       }
 860 |     },
 861 |     "node_modules/@webassemblyjs/ast": {
 862 |       "version": "1.14.1",
 863 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/ast/-/ast-1.14.1.tgz",
 864 |       "integrity": "sha512-nuBEDgQfm1ccRp/8bCQrx1frohyufl4JlbMMZ4P1wpeOfDhF6FQkxZJ1b/e+PLwr6X1Nhw6OLme5usuBWYBvuQ==",
 865 |       "dev": true,
 866 |       "license": "MIT",
 867 |       "dependencies": {
 868 |         "@webassemblyjs/helper-numbers": "1.13.2",
 869 |         "@webassemblyjs/helper-wasm-bytecode": "1.13.2"
 870 |       }
 871 |     },
 872 |     "node_modules/@webassemblyjs/floating-point-hex-parser": {
 873 |       "version": "1.13.2",
 874 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/floating-point-hex-parser/-/floating-point-hex-parser-1.13.2.tgz",
 875 |       "integrity": "sha512-6oXyTOzbKxGH4steLbLNOu71Oj+C8Lg34n6CqRvqfS2O71BxY6ByfMDRhBytzknj9yGUPVJ1qIKhRlAwO1AovA==",
 876 |       "dev": true,
 877 |       "license": "MIT"
 878 |     },
 879 |     "node_modules/@webassemblyjs/helper-api-error": {
 880 |       "version": "1.13.2",
 881 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/helper-api-error/-/helper-api-error-1.13.2.tgz",
 882 |       "integrity": "sha512-U56GMYxy4ZQCbDZd6JuvvNV/WFildOjsaWD3Tzzvmw/mas3cXzRJPMjP83JqEsgSbyrmaGjBfDtV7KDXV9UzFQ==",
 883 |       "dev": true,
 884 |       "license": "MIT"
 885 |     },
 886 |     "node_modules/@webassemblyjs/helper-buffer": {
 887 |       "version": "1.14.1",
 888 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/helper-buffer/-/helper-buffer-1.14.1.tgz",
 889 |       "integrity": "sha512-jyH7wtcHiKssDtFPRB+iQdxlDf96m0E39yb0k5uJVhFGleZFoNw1c4aeIcVUPPbXUVJ94wwnMOAqUHyzoEPVMA==",
 890 |       "dev": true,
 891 |       "license": "MIT"
 892 |     },
 893 |     "node_modules/@webassemblyjs/helper-numbers": {
 894 |       "version": "1.13.2",
 895 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/helper-numbers/-/helper-numbers-1.13.2.tgz",
 896 |       "integrity": "sha512-FE8aCmS5Q6eQYcV3gI35O4J789wlQA+7JrqTTpJqn5emA4U2hvwJmvFRC0HODS+3Ye6WioDklgd6scJ3+PLnEA==",
 897 |       "dev": true,
 898 |       "license": "MIT",
 899 |       "dependencies": {
 900 |         "@webassemblyjs/floating-point-hex-parser": "1.13.2",
 901 |         "@webassemblyjs/helper-api-error": "1.13.2",
 902 |         "@xtuc/long": "4.2.2"
 903 |       }
 904 |     },
 905 |     "node_modules/@webassemblyjs/helper-wasm-bytecode": {
 906 |       "version": "1.13.2",
 907 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/helper-wasm-bytecode/-/helper-wasm-bytecode-1.13.2.tgz",
 908 |       "integrity": "sha512-3QbLKy93F0EAIXLh0ogEVR6rOubA9AoZ+WRYhNbFyuB70j3dRdwH9g+qXhLAO0kiYGlg3TxDV+I4rQTr/YNXkA==",
 909 |       "dev": true,
 910 |       "license": "MIT"
 911 |     },
 912 |     "node_modules/@webassemblyjs/helper-wasm-section": {
 913 |       "version": "1.14.1",
 914 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/helper-wasm-section/-/helper-wasm-section-1.14.1.tgz",
 915 |       "integrity": "sha512-ds5mXEqTJ6oxRoqjhWDU83OgzAYjwsCV8Lo/N+oRsNDmx/ZDpqalmrtgOMkHwxsG0iI//3BwWAErYRHtgn0dZw==",
 916 |       "dev": true,
 917 |       "license": "MIT",
 918 |       "dependencies": {
 919 |         "@webassemblyjs/ast": "1.14.1",
 920 |         "@webassemblyjs/helper-buffer": "1.14.1",
 921 |         "@webassemblyjs/helper-wasm-bytecode": "1.13.2",
 922 |         "@webassemblyjs/wasm-gen": "1.14.1"
 923 |       }
 924 |     },
 925 |     "node_modules/@webassemblyjs/ieee754": {
 926 |       "version": "1.13.2",
 927 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/ieee754/-/ieee754-1.13.2.tgz",
 928 |       "integrity": "sha512-4LtOzh58S/5lX4ITKxnAK2USuNEvpdVV9AlgGQb8rJDHaLeHciwG4zlGr0j/SNWlr7x3vO1lDEsuePvtcDNCkw==",
 929 |       "dev": true,
 930 |       "license": "MIT",
 931 |       "dependencies": {
 932 |         "@xtuc/ieee754": "^1.2.0"
 933 |       }
 934 |     },
 935 |     "node_modules/@webassemblyjs/leb128": {
 936 |       "version": "1.13.2",
 937 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/leb128/-/leb128-1.13.2.tgz",
 938 |       "integrity": "sha512-Lde1oNoIdzVzdkNEAWZ1dZ5orIbff80YPdHx20mrHwHrVNNTjNr8E3xz9BdpcGqRQbAEa+fkrCb+fRFTl/6sQw==",
 939 |       "dev": true,
 940 |       "license": "Apache-2.0",
 941 |       "dependencies": {
 942 |         "@xtuc/long": "4.2.2"
 943 |       }
 944 |     },
 945 |     "node_modules/@webassemblyjs/utf8": {
 946 |       "version": "1.13.2",
 947 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/utf8/-/utf8-1.13.2.tgz",
 948 |       "integrity": "sha512-3NQWGjKTASY1xV5m7Hr0iPeXD9+RDobLll3T9d2AO+g3my8xy5peVyjSag4I50mR1bBSN/Ct12lo+R9tJk0NZQ==",
 949 |       "dev": true,
 950 |       "license": "MIT"
 951 |     },
 952 |     "node_modules/@webassemblyjs/wasm-edit": {
 953 |       "version": "1.14.1",
 954 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/wasm-edit/-/wasm-edit-1.14.1.tgz",
 955 |       "integrity": "sha512-RNJUIQH/J8iA/1NzlE4N7KtyZNHi3w7at7hDjvRNm5rcUXa00z1vRz3glZoULfJ5mpvYhLybmVcwcjGrC1pRrQ==",
 956 |       "dev": true,
 957 |       "license": "MIT",
 958 |       "dependencies": {
 959 |         "@webassemblyjs/ast": "1.14.1",
 960 |         "@webassemblyjs/helper-buffer": "1.14.1",
 961 |         "@webassemblyjs/helper-wasm-bytecode": "1.13.2",
 962 |         "@webassemblyjs/helper-wasm-section": "1.14.1",
 963 |         "@webassemblyjs/wasm-gen": "1.14.1",
 964 |         "@webassemblyjs/wasm-opt": "1.14.1",
 965 |         "@webassemblyjs/wasm-parser": "1.14.1",
 966 |         "@webassemblyjs/wast-printer": "1.14.1"
 967 |       }
 968 |     },
 969 |     "node_modules/@webassemblyjs/wasm-gen": {
 970 |       "version": "1.14.1",
 971 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/wasm-gen/-/wasm-gen-1.14.1.tgz",
 972 |       "integrity": "sha512-AmomSIjP8ZbfGQhumkNvgC33AY7qtMCXnN6bL2u2Js4gVCg8fp735aEiMSBbDR7UQIj90n4wKAFUSEd0QN2Ukg==",
 973 |       "dev": true,
 974 |       "license": "MIT",
 975 |       "dependencies": {
 976 |         "@webassemblyjs/ast": "1.14.1",
 977 |         "@webassemblyjs/helper-wasm-bytecode": "1.13.2",
 978 |         "@webassemblyjs/ieee754": "1.13.2",
 979 |         "@webassemblyjs/leb128": "1.13.2",
 980 |         "@webassemblyjs/utf8": "1.13.2"
 981 |       }
 982 |     },
 983 |     "node_modules/@webassemblyjs/wasm-opt": {
 984 |       "version": "1.14.1",
 985 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/wasm-opt/-/wasm-opt-1.14.1.tgz",
 986 |       "integrity": "sha512-PTcKLUNvBqnY2U6E5bdOQcSM+oVP/PmrDY9NzowJjislEjwP/C4an2303MCVS2Mg9d3AJpIGdUFIQQWbPds0Sw==",
 987 |       "dev": true,
 988 |       "license": "MIT",
 989 |       "dependencies": {
 990 |         "@webassemblyjs/ast": "1.14.1",
 991 |         "@webassemblyjs/helper-buffer": "1.14.1",
 992 |         "@webassemblyjs/wasm-gen": "1.14.1",
 993 |         "@webassemblyjs/wasm-parser": "1.14.1"
 994 |       }
 995 |     },
 996 |     "node_modules/@webassemblyjs/wasm-parser": {
 997 |       "version": "1.14.1",
 998 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/wasm-parser/-/wasm-parser-1.14.1.tgz",
 999 |       "integrity": "sha512-JLBl+KZ0R5qB7mCnud/yyX08jWFw5MsoalJ1pQ4EdFlgj9VdXKGuENGsiCIjegI1W7p91rUlcB/LB5yRJKNTcQ==",
1000 |       "dev": true,
1001 |       "license": "MIT",
1002 |       "dependencies": {
1003 |         "@webassemblyjs/ast": "1.14.1",
1004 |         "@webassemblyjs/helper-api-error": "1.13.2",
1005 |         "@webassemblyjs/helper-wasm-bytecode": "1.13.2",
1006 |         "@webassemblyjs/ieee754": "1.13.2",
1007 |         "@webassemblyjs/leb128": "1.13.2",
1008 |         "@webassemblyjs/utf8": "1.13.2"
1009 |       }
1010 |     },
1011 |     "node_modules/@webassemblyjs/wast-printer": {
1012 |       "version": "1.14.1",
1013 |       "resolved": "https://registry.npmjs.org/@webassemblyjs/wast-printer/-/wast-printer-1.14.1.tgz",
1014 |       "integrity": "sha512-kPSSXE6De1XOR820C90RIo2ogvZG+c3KiHzqUoO/F34Y2shGzesfqv7o57xrxovZJH/MetF5UjroJ/R/3isoiw==",
1015 |       "dev": true,
1016 |       "license": "MIT",
1017 |       "dependencies": {
1018 |         "@webassemblyjs/ast": "1.14.1",
1019 |         "@xtuc/long": "4.2.2"
1020 |       }
1021 |     },
1022 |     "node_modules/@webpack-cli/configtest": {
1023 |       "version": "3.0.1",
1024 |       "resolved": "https://registry.npmjs.org/@webpack-cli/configtest/-/configtest-3.0.1.tgz",
1025 |       "integrity": "sha512-u8d0pJ5YFgneF/GuvEiDA61Tf1VDomHHYMjv/wc9XzYj7nopltpG96nXN5dJRstxZhcNpV1g+nT6CydO7pHbjA==",
1026 |       "dev": true,
1027 |       "license": "MIT",
1028 |       "engines": {
1029 |         "node": ">=18.12.0"
1030 |       },
1031 |       "peerDependencies": {
1032 |         "webpack": "^5.82.0",
1033 |         "webpack-cli": "6.x.x"
1034 |       }
1035 |     },
1036 |     "node_modules/@webpack-cli/info": {
1037 |       "version": "3.0.1",
1038 |       "resolved": "https://registry.npmjs.org/@webpack-cli/info/-/info-3.0.1.tgz",
1039 |       "integrity": "sha512-coEmDzc2u/ffMvuW9aCjoRzNSPDl/XLuhPdlFRpT9tZHmJ/039az33CE7uH+8s0uL1j5ZNtfdv0HkfaKRBGJsQ==",
1040 |       "dev": true,
1041 |       "license": "MIT",
1042 |       "engines": {
1043 |         "node": ">=18.12.0"
1044 |       },
1045 |       "peerDependencies": {
1046 |         "webpack": "^5.82.0",
1047 |         "webpack-cli": "6.x.x"
1048 |       }
1049 |     },
1050 |     "node_modules/@webpack-cli/serve": {
1051 |       "version": "3.0.1",
1052 |       "resolved": "https://registry.npmjs.org/@webpack-cli/serve/-/serve-3.0.1.tgz",
1053 |       "integrity": "sha512-sbgw03xQaCLiT6gcY/6u3qBDn01CWw/nbaXl3gTdTFuJJ75Gffv3E3DBpgvY2fkkrdS1fpjaXNOmJlnbtKauKg==",
1054 |       "dev": true,
1055 |       "license": "MIT",
1056 |       "engines": {
1057 |         "node": ">=18.12.0"
1058 |       },
1059 |       "peerDependencies": {
1060 |         "webpack": "^5.82.0",
1061 |         "webpack-cli": "6.x.x"
1062 |       },
1063 |       "peerDependenciesMeta": {
1064 |         "webpack-dev-server": {
1065 |           "optional": true
1066 |         }
1067 |       }
1068 |     },
1069 |     "node_modules/@xtuc/ieee754": {
1070 |       "version": "1.2.0",
1071 |       "resolved": "https://registry.npmjs.org/@xtuc/ieee754/-/ieee754-1.2.0.tgz",
1072 |       "integrity": "sha512-DX8nKgqcGwsc0eJSqYt5lwP4DH5FlHnmuWWBRy7X0NcaGR0ZtuyeESgMwTYVEtxmsNGY+qit4QYT/MIYTOTPeA==",
1073 |       "dev": true,
1074 |       "license": "BSD-3-Clause"
1075 |     },
1076 |     "node_modules/@xtuc/long": {
1077 |       "version": "4.2.2",
1078 |       "resolved": "https://registry.npmjs.org/@xtuc/long/-/long-4.2.2.tgz",
1079 |       "integrity": "sha512-NuHqBY1PB/D8xU6s/thBgOAiAP7HOYDQ32+BFZILJ8ivkUkAHQnWfn6WhL79Owj1qmUnoN/YPhktdIoucipkAQ==",
1080 |       "dev": true,
1081 |       "license": "Apache-2.0"
1082 |     },
1083 |     "node_modules/@yao-pkg/pkg": {
1084 |       "version": "6.11.0",
1085 |       "resolved": "https://registry.npmjs.org/@yao-pkg/pkg/-/pkg-6.11.0.tgz",
1086 |       "integrity": "sha512-cofhWpH8ifhastwvbSe0Xnh1leq9oT0VmGbxa8fqH1hc4PtrO1dz6B3M5uQ4xTjOeGd9R9Gx8rT6bB2/ZERaTA==",
1087 |       "dev": true,
1088 |       "license": "MIT",
1089 |       "dependencies": {
1090 |         "@babel/generator": "^7.23.0",
1091 |         "@babel/parser": "^7.23.0",
1092 |         "@babel/types": "^7.23.0",
1093 |         "@yao-pkg/pkg-fetch": "3.5.31",
1094 |         "into-stream": "^6.0.0",
1095 |         "minimist": "^1.2.6",
1096 |         "multistream": "^4.1.0",
1097 |         "picocolors": "^1.1.0",
1098 |         "picomatch": "^4.0.2",
1099 |         "prebuild-install": "^7.1.1",
1100 |         "resolve": "^1.22.10",
1101 |         "stream-meter": "^1.0.4",
1102 |         "tar": "^7.4.3",
1103 |         "tinyglobby": "^0.2.11",
1104 |         "unzipper": "^0.12.3"
1105 |       },
1106 |       "bin": {
1107 |         "pkg": "lib-es5/bin.js"
1108 |       },
1109 |       "engines": {
1110 |         "node": ">=18.0.0"
1111 |       }
1112 |     },
1113 |     "node_modules/@yao-pkg/pkg-fetch": {
1114 |       "version": "3.5.31",
1115 |       "resolved": "https://registry.npmjs.org/@yao-pkg/pkg-fetch/-/pkg-fetch-3.5.31.tgz",
1116 |       "integrity": "sha512-qBLFfCXJECsxMlvwamhdWR65LWI7Cnb40dmI+1NIr1Nfk8Ddc8luZIJsRRZER9UrY13X1NJZSRORsqIPYDsJbw==",
1117 |       "dev": true,
1118 |       "license": "MIT",
1119 |       "dependencies": {
1120 |         "https-proxy-agent": "^5.0.0",
1121 |         "node-fetch": "^2.6.6",
1122 |         "picocolors": "^1.1.0",
1123 |         "progress": "^2.0.3",
1124 |         "semver": "^7.3.5",
1125 |         "tar-fs": "^3.1.1",
1126 |         "yargs": "^16.2.0"
1127 |       },
1128 |       "bin": {
1129 |         "pkg-fetch": "lib-es5/bin.js"
1130 |       }
1131 |     },
1132 |     "node_modules/@yao-pkg/pkg-fetch/node_modules/agent-base": {
1133 |       "version": "6.0.2",
1134 |       "resolved": "https://registry.npmjs.org/agent-base/-/agent-base-6.0.2.tgz",
1135 |       "integrity": "sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==",
1136 |       "dev": true,
1137 |       "license": "MIT",
1138 |       "dependencies": {
1139 |         "debug": "4"
1140 |       },
1141 |       "engines": {
1142 |         "node": ">= 6.0.0"
1143 |       }
1144 |     },
1145 |     "node_modules/@yao-pkg/pkg-fetch/node_modules/cliui": {
1146 |       "version": "7.0.4",
1147 |       "resolved": "https://registry.npmjs.org/cliui/-/cliui-7.0.4.tgz",
1148 |       "integrity": "sha512-OcRE68cOsVMXp1Yvonl/fzkQOyjLSu/8bhPDfQt0e0/Eb283TKP20Fs2MqoPsr9SwA595rRCA+QMzYc9nBP+JQ==",
1149 |       "dev": true,
1150 |       "license": "ISC",
1151 |       "dependencies": {
1152 |         "string-width": "^4.2.0",
1153 |         "strip-ansi": "^6.0.0",
1154 |         "wrap-ansi": "^7.0.0"
1155 |       }
1156 |     },
1157 |     "node_modules/@yao-pkg/pkg-fetch/node_modules/https-proxy-agent": {
1158 |       "version": "5.0.1",
1159 |       "resolved": "https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-5.0.1.tgz",
1160 |       "integrity": "sha512-dFcAjpTQFgoLMzC2VwU+C/CbS7uRL0lWmxDITmqm7C+7F0Odmj6s9l6alZc6AELXhrnggM2CeWSXHGOdX2YtwA==",
1161 |       "dev": true,
1162 |       "license": "MIT",
1163 |       "dependencies": {
1164 |         "agent-base": "6",
1165 |         "debug": "4"
1166 |       },
1167 |       "engines": {
1168 |         "node": ">= 6"
1169 |       }
1170 |     },
1171 |     "node_modules/@yao-pkg/pkg-fetch/node_modules/yargs": {
1172 |       "version": "16.2.0",
1173 |       "resolved": "https://registry.npmjs.org/yargs/-/yargs-16.2.0.tgz",
1174 |       "integrity": "sha512-D1mvvtDG0L5ft/jGWkLpG1+m0eQxOfaBvTNELraWj22wSVUMWxZUvYgJYcKh6jGGIkJFhH4IZPQhR4TKpc8mBw==",
1175 |       "dev": true,
1176 |       "license": "MIT",
1177 |       "dependencies": {
1178 |         "cliui": "^7.0.2",
1179 |         "escalade": "^3.1.1",
1180 |         "get-caller-file": "^2.0.5",
1181 |         "require-directory": "^2.1.1",
1182 |         "string-width": "^4.2.0",
1183 |         "y18n": "^5.0.5",
1184 |         "yargs-parser": "^20.2.2"
1185 |       },
1186 |       "engines": {
1187 |         "node": ">=10"
1188 |       }
1189 |     },
1190 |     "node_modules/@yao-pkg/pkg-fetch/node_modules/yargs-parser": {
1191 |       "version": "20.2.9",
1192 |       "resolved": "https://registry.npmjs.org/yargs-parser/-/yargs-parser-20.2.9.tgz",
1193 |       "integrity": "sha512-y11nGElTIV+CT3Zv9t7VKl+Q3hTQoT9a1Qzezhhl6Rp21gJ/IVTW7Z3y9EWXhuUBC2Shnf+DX0antecpAwSP8w==",
1194 |       "dev": true,
1195 |       "license": "ISC",
1196 |       "engines": {
1197 |         "node": ">=10"
1198 |       }
1199 |     },
1200 |     "node_modules/@yao-pkg/pkg/node_modules/@babel/generator": {
1201 |       "version": "7.28.5",
1202 |       "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
1203 |       "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
1204 |       "dev": true,
1205 |       "license": "MIT",
1206 |       "dependencies": {
1207 |         "@babel/parser": "^7.28.5",
1208 |         "@babel/types": "^7.28.5",
1209 |         "@jridgewell/gen-mapping": "^0.3.12",
1210 |         "@jridgewell/trace-mapping": "^0.3.28",
1211 |         "jsesc": "^3.0.2"
1212 |       },
1213 |       "engines": {
1214 |         "node": ">=6.9.0"
1215 |       }
1216 |     },
1217 |     "node_modules/@yao-pkg/pkg/node_modules/@babel/parser": {
1218 |       "version": "7.28.5",
1219 |       "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
1220 |       "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
1221 |       "dev": true,
1222 |       "license": "MIT",
1223 |       "dependencies": {
1224 |         "@babel/types": "^7.28.5"
1225 |       },
1226 |       "bin": {
1227 |         "parser": "bin/babel-parser.js"
1228 |       },
1229 |       "engines": {
1230 |         "node": ">=6.0.0"
1231 |       }
1232 |     },
1233 |     "node_modules/@yao-pkg/pkg/node_modules/@babel/types": {
1234 |       "version": "7.28.5",
1235 |       "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.5.tgz",
1236 |       "integrity": "sha512-qQ5m48eI/MFLQ5PxQj4PFaprjyCTLI37ElWMmNs0K8Lk3dVeOdNpB3ks8jc7yM5CDmVC73eMVk/trk3fgmrUpA==",
1237 |       "dev": true,
1238 |       "license": "MIT",
1239 |       "dependencies": {
1240 |         "@babel/helper-string-parser": "^7.27.1",
1241 |         "@babel/helper-validator-identifier": "^7.28.5"
1242 |       },
1243 |       "engines": {
1244 |         "node": ">=6.9.0"
1245 |       }
1246 |     },
1247 |     "node_modules/@yao-pkg/pkg/node_modules/jsesc": {
1248 |       "version": "3.1.0",
1249 |       "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
1250 |       "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
1251 |       "dev": true,
1252 |       "license": "MIT",
1253 |       "bin": {
1254 |         "jsesc": "bin/jsesc"
1255 |       },
1256 |       "engines": {
1257 |         "node": ">=6"
1258 |       }
1259 |     },
1260 |     "node_modules/@yao-pkg/pkg/node_modules/picomatch": {
1261 |       "version": "4.0.3",
1262 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
1263 |       "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
1264 |       "dev": true,
1265 |       "license": "MIT",
1266 |       "engines": {
1267 |         "node": ">=12"
1268 |       },
1269 |       "funding": {
1270 |         "url": "https://github.com/sponsors/jonschlinkert"
1271 |       }
1272 |     },
1273 |     "node_modules/@yarnpkg/fslib": {
1274 |       "version": "3.1.4",
1275 |       "resolved": "https://registry.npmjs.org/@yarnpkg/fslib/-/fslib-3.1.4.tgz",
1276 |       "integrity": "sha512-Yyguw5RM+xI1Bv0RFbs1ZF5HwU+9/He4YT7yeT722yAlLfkz9IzZHO6a5yStEshxiliPn9Fdj4H54a785xpK/g==",
1277 |       "dev": true,
1278 |       "license": "BSD-2-Clause",
1279 |       "dependencies": {
1280 |         "tslib": "^2.4.0"
1281 |       },
1282 |       "engines": {
1283 |         "node": ">=18.12.0"
1284 |       }
1285 |     },
1286 |     "node_modules/@yarnpkg/libzip": {
1287 |       "version": "3.2.2",
1288 |       "resolved": "https://registry.npmjs.org/@yarnpkg/libzip/-/libzip-3.2.2.tgz",
1289 |       "integrity": "sha512-Kqxgjfy6SwwC4tTGQYToIWtUhIORTpkowqgd9kkMiBixor0eourHZZAggt/7N4WQKt9iCyPSkO3Xvr44vXUBAw==",
1290 |       "dev": true,
1291 |       "license": "BSD-2-Clause",
1292 |       "dependencies": {
1293 |         "@types/emscripten": "^1.39.6",
1294 |         "@yarnpkg/fslib": "^3.1.3",
1295 |         "tslib": "^2.4.0"
1296 |       },
1297 |       "engines": {
1298 |         "node": ">=18.12.0"
1299 |       },
1300 |       "peerDependencies": {
1301 |         "@yarnpkg/fslib": "^3.1.3"
1302 |       }
1303 |     },
1304 |     "node_modules/acorn": {
1305 |       "version": "8.15.0",
1306 |       "resolved": "https://registry.npmjs.org/acorn/-/acorn-8.15.0.tgz",
1307 |       "integrity": "sha512-NZyJarBfL7nWwIq+FDL6Zp/yHEhePMNnnJ0y3qfieCrmNvYct8uvtiV41UvlSe6apAfk0fY1FbWx+NwfmpvtTg==",
1308 |       "dev": true,
1309 |       "license": "MIT",
1310 |       "peer": true,
1311 |       "bin": {
1312 |         "acorn": "bin/acorn"
1313 |       },
1314 |       "engines": {
1315 |         "node": ">=0.4.0"
1316 |       }
1317 |     },
1318 |     "node_modules/acorn-import-phases": {
1319 |       "version": "1.0.4",
1320 |       "resolved": "https://registry.npmjs.org/acorn-import-phases/-/acorn-import-phases-1.0.4.tgz",
1321 |       "integrity": "sha512-wKmbr/DDiIXzEOiWrTTUcDm24kQ2vGfZQvM2fwg2vXqR5uW6aapr7ObPtj1th32b9u90/Pf4AItvdTh42fBmVQ==",
1322 |       "dev": true,
1323 |       "license": "MIT",
1324 |       "engines": {
1325 |         "node": ">=10.13.0"
1326 |       },
1327 |       "peerDependencies": {
1328 |         "acorn": "^8.14.0"
1329 |       }
1330 |     },
1331 |     "node_modules/agent-base": {
1332 |       "version": "7.1.4",
1333 |       "resolved": "https://registry.npmjs.org/agent-base/-/agent-base-7.1.4.tgz",
1334 |       "integrity": "sha512-MnA+YT8fwfJPgBx3m60MNqakm30XOkyIoH1y6huTQvC0PwZG7ki8NacLBcrPbNoo8vEZy7Jpuk7+jMO+CUovTQ==",
1335 |       "license": "MIT",
1336 |       "engines": {
1337 |         "node": ">= 14"
1338 |       }
1339 |     },
1340 |     "node_modules/ajv": {
1341 |       "version": "8.17.1",
1342 |       "resolved": "https://registry.npmjs.org/ajv/-/ajv-8.17.1.tgz",
1343 |       "integrity": "sha512-B/gBuNg5SiMTrPkC+A2+cW0RszwxYmn6VYxB/inlBStS5nx6xHIt/ehKRhIMhqusl7a8LjQoZnjCs5vhwxOQ1g==",
1344 |       "dev": true,
1345 |       "license": "MIT",
1346 |       "peer": true,
1347 |       "dependencies": {
1348 |         "fast-deep-equal": "^3.1.3",
1349 |         "fast-uri": "^3.0.1",
1350 |         "json-schema-traverse": "^1.0.0",
1351 |         "require-from-string": "^2.0.2"
1352 |       },
1353 |       "funding": {
1354 |         "type": "github",
1355 |         "url": "https://github.com/sponsors/epoberezkin"
1356 |       }
1357 |     },
1358 |     "node_modules/ajv-formats": {
1359 |       "version": "2.1.1",
1360 |       "resolved": "https://registry.npmjs.org/ajv-formats/-/ajv-formats-2.1.1.tgz",
1361 |       "integrity": "sha512-Wx0Kx52hxE7C18hkMEggYlEifqWZtYaRgouJor+WMdPnQyEK13vgEWyVNup7SoeeoLMsr4kf5h6dOW11I15MUA==",
1362 |       "dev": true,
1363 |       "license": "MIT",
1364 |       "dependencies": {
1365 |         "ajv": "^8.0.0"
1366 |       },
1367 |       "peerDependencies": {
1368 |         "ajv": "^8.0.0"
1369 |       },
1370 |       "peerDependenciesMeta": {
1371 |         "ajv": {
1372 |           "optional": true
1373 |         }
1374 |       }
1375 |     },
1376 |     "node_modules/ajv-keywords": {
1377 |       "version": "5.1.0",
1378 |       "resolved": "https://registry.npmjs.org/ajv-keywords/-/ajv-keywords-5.1.0.tgz",
1379 |       "integrity": "sha512-YCS/JNFAUyr5vAuhk1DWm1CBxRHW9LbJ2ozWeemrIqpbsqKjHVxYPyi5GC0rjZIT5JxJ3virVTS8wk4i/Z+krw==",
1380 |       "dev": true,
1381 |       "license": "MIT",
1382 |       "dependencies": {
1383 |         "fast-deep-equal": "^3.1.3"
1384 |       },
1385 |       "peerDependencies": {
1386 |         "ajv": "^8.8.2"
1387 |       }
1388 |     },
1389 |     "node_modules/ansi-regex": {
1390 |       "version": "5.0.1",
1391 |       "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
1392 |       "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
1393 |       "license": "MIT",
1394 |       "engines": {
1395 |         "node": ">=8"
1396 |       }
1397 |     },
1398 |     "node_modules/ansi-styles": {
1399 |       "version": "4.3.0",
1400 |       "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
1401 |       "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
1402 |       "license": "MIT",
1403 |       "dependencies": {
1404 |         "color-convert": "^2.0.1"
1405 |       },
1406 |       "engines": {
1407 |         "node": ">=8"
1408 |       },
1409 |       "funding": {
1410 |         "url": "https://github.com/chalk/ansi-styles?sponsor=1"
1411 |       }
1412 |     },
1413 |     "node_modules/anymatch": {
1414 |       "version": "3.1.3",
1415 |       "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
1416 |       "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
1417 |       "dev": true,
1418 |       "license": "ISC",
1419 |       "dependencies": {
1420 |         "normalize-path": "^3.0.0",
1421 |         "picomatch": "^2.0.4"
1422 |       },
1423 |       "engines": {
1424 |         "node": ">= 8"
1425 |       }
1426 |     },
1427 |     "node_modules/app-builder": {
1428 |       "version": "7.0.4",
1429 |       "resolved": "https://registry.npmjs.org/app-builder/-/app-builder-7.0.4.tgz",
1430 |       "integrity": "sha512-QCmWZnoNN2uItlRV+gj4J6OONaFcJPyFoIuP1RkoILcuq19MlkynYB+wtH8uGv/umyynMWHI1HxnH1jGa1hNKQ==",
1431 |       "dev": true,
1432 |       "license": "MIT"
1433 |     },
1434 |     "node_modules/archive-type": {
1435 |       "version": "4.0.0",
1436 |       "resolved": "https://registry.npmjs.org/archive-type/-/archive-type-4.0.0.tgz",
1437 |       "integrity": "sha512-zV4Ky0v1F8dBrdYElwTvQhweQ0P7Kwc1aluqJsYtOBP01jXcWCyW2IEfI1YiqsG+Iy7ZR+o5LF1N+PGECBxHWA==",
1438 |       "dev": true,
1439 |       "license": "MIT",
1440 |       "dependencies": {
1441 |         "file-type": "^4.2.0"
1442 |       },
1443 |       "engines": {
1444 |         "node": ">=4"
1445 |       }
1446 |     },
1447 |     "node_modules/archive-type/node_modules/file-type": {
1448 |       "version": "4.4.0",
1449 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-4.4.0.tgz",
1450 |       "integrity": "sha512-f2UbFQEk7LXgWpi5ntcO86OeA/cC80fuDDDaX/fZ2ZGel+AF7leRQqBBW1eJNiiQkrZlAoM6P+VYP5P6bOlDEQ==",
1451 |       "dev": true,
1452 |       "license": "MIT",
1453 |       "engines": {
1454 |         "node": ">=4"
1455 |       }
1456 |     },
1457 |     "node_modules/archiver": {
1458 |       "version": "5.3.2",
1459 |       "resolved": "https://registry.npmjs.org/archiver/-/archiver-5.3.2.tgz",
1460 |       "integrity": "sha512-+25nxyyznAXF7Nef3y0EbBeqmGZgeN/BxHX29Rs39djAfaFalmQ89SE6CWyDCHzGL0yt/ycBtNOmGTW0FyGWNw==",
1461 |       "dev": true,
1462 |       "license": "MIT",
1463 |       "dependencies": {
1464 |         "archiver-utils": "^2.1.0",
1465 |         "async": "^3.2.4",
1466 |         "buffer-crc32": "^0.2.1",
1467 |         "readable-stream": "^3.6.0",
1468 |         "readdir-glob": "^1.1.2",
1469 |         "tar-stream": "^2.2.0",
1470 |         "zip-stream": "^4.1.0"
1471 |       },
1472 |       "engines": {
1473 |         "node": ">= 10"
1474 |       }
1475 |     },
1476 |     "node_modules/archiver-utils": {
1477 |       "version": "2.1.0",
1478 |       "resolved": "https://registry.npmjs.org/archiver-utils/-/archiver-utils-2.1.0.tgz",
1479 |       "integrity": "sha512-bEL/yUb/fNNiNTuUz979Z0Yg5L+LzLxGJz8x79lYmR54fmTIb6ob/hNQgkQnIUDWIFjZVQwl9Xs356I6BAMHfw==",
1480 |       "dev": true,
1481 |       "license": "MIT",
1482 |       "dependencies": {
1483 |         "glob": "^7.1.4",
1484 |         "graceful-fs": "^4.2.0",
1485 |         "lazystream": "^1.0.0",
1486 |         "lodash.defaults": "^4.2.0",
1487 |         "lodash.difference": "^4.5.0",
1488 |         "lodash.flatten": "^4.4.0",
1489 |         "lodash.isplainobject": "^4.0.6",
1490 |         "lodash.union": "^4.6.0",
1491 |         "normalize-path": "^3.0.0",
1492 |         "readable-stream": "^2.0.0"
1493 |       },
1494 |       "engines": {
1495 |         "node": ">= 6"
1496 |       }
1497 |     },
1498 |     "node_modules/archiver/node_modules/readable-stream": {
1499 |       "version": "3.6.2",
1500 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
1501 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
1502 |       "dev": true,
1503 |       "license": "MIT",
1504 |       "dependencies": {
1505 |         "inherits": "^2.0.3",
1506 |         "string_decoder": "^1.1.1",
1507 |         "util-deprecate": "^1.0.1"
1508 |       },
1509 |       "engines": {
1510 |         "node": ">= 6"
1511 |       }
1512 |     },
1513 |     "node_modules/archiver/node_modules/tar-stream": {
1514 |       "version": "2.2.0",
1515 |       "resolved": "https://registry.npmjs.org/tar-stream/-/tar-stream-2.2.0.tgz",
1516 |       "integrity": "sha512-ujeqbceABgwMZxEJnk2HDY2DlnUZ+9oEcb1KzTVfYHio0UE6dG71n60d8D2I4qNvleWrrXpmjpt7vZeF1LnMZQ==",
1517 |       "dev": true,
1518 |       "license": "MIT",
1519 |       "dependencies": {
1520 |         "bl": "^4.0.3",
1521 |         "end-of-stream": "^1.4.1",
1522 |         "fs-constants": "^1.0.0",
1523 |         "inherits": "^2.0.3",
1524 |         "readable-stream": "^3.1.1"
1525 |       },
1526 |       "engines": {
1527 |         "node": ">=6"
1528 |       }
1529 |     },
1530 |     "node_modules/argparse": {
1531 |       "version": "2.0.1",
1532 |       "resolved": "https://registry.npmjs.org/argparse/-/argparse-2.0.1.tgz",
1533 |       "integrity": "sha512-8+9WqebbFzpX9OR+Wa6O29asIogeRMzcGtAINdpMHHyAg10f05aSFVBbcEqGf/PXw1EjAZ+q2/bEBg3DvurK3Q==",
1534 |       "license": "Python-2.0"
1535 |     },
1536 |     "node_modules/arr-union": {
1537 |       "version": "3.1.0",
1538 |       "resolved": "https://registry.npmjs.org/arr-union/-/arr-union-3.1.0.tgz",
1539 |       "integrity": "sha512-sKpyeERZ02v1FeCZT8lrfJq5u6goHCtpTAzPwJYe7c8SPFOboNjNg1vz2L4VTn9T4PQxEx13TbXLmYUcS6Ug7Q==",
1540 |       "license": "MIT",
1541 |       "engines": {
1542 |         "node": ">=0.10.0"
1543 |       }
1544 |     },
1545 |     "node_modules/array-union": {
1546 |       "version": "2.1.0",
1547 |       "resolved": "https://registry.npmjs.org/array-union/-/array-union-2.1.0.tgz",
1548 |       "integrity": "sha512-HGyxoOTYUyCM6stUe6EJgnd4EoewAI7zMdfqO+kGjnlZmBDz/cR5pf8r/cR4Wq60sL/p0IkcjUEEPwS3GFrIyw==",
1549 |       "dev": true,
1550 |       "license": "MIT",
1551 |       "engines": {
1552 |         "node": ">=8"
1553 |       }
1554 |     },
1555 |     "node_modules/ast-types": {
1556 |       "version": "0.13.4",
1557 |       "resolved": "https://registry.npmjs.org/ast-types/-/ast-types-0.13.4.tgz",
1558 |       "integrity": "sha512-x1FCFnFifvYDDzTaLII71vG5uvDwgtmDTEVWAxrgeiR8VjMONcCXJx7E+USjDtHlwFmt9MysbqgF9b9Vjr6w+w==",
1559 |       "license": "MIT",
1560 |       "dependencies": {
1561 |         "tslib": "^2.0.1"
1562 |       },
1563 |       "engines": {
1564 |         "node": ">=4"
1565 |       }
1566 |     },
1567 |     "node_modules/async": {
1568 |       "version": "3.2.6",
1569 |       "resolved": "https://registry.npmjs.org/async/-/async-3.2.6.tgz",
1570 |       "integrity": "sha512-htCUDlxyyCLMgaM3xXg0C0LW2xqfuQ6p05pCEIsXuyQ+a1koYKTuBMzRNwmybfLgvJDMd0r1LTn4+E0Ti6C2AA==",
1571 |       "dev": true,
1572 |       "license": "MIT"
1573 |     },
1574 |     "node_modules/asynckit": {
1575 |       "version": "0.4.0",
1576 |       "resolved": "https://registry.npmjs.org/asynckit/-/asynckit-0.4.0.tgz",
1577 |       "integrity": "sha512-Oei9OH4tRh0YqU3GxhX79dM/mwVgvbZJaSNaRk+bshkj0S5cfHcgYakreBjrHwatXKbz+IoIdYLxrKim2MjW0Q==",
1578 |       "license": "MIT"
1579 |     },
1580 |     "node_modules/at-least-node": {
1581 |       "version": "1.0.0",
1582 |       "resolved": "https://registry.npmjs.org/at-least-node/-/at-least-node-1.0.0.tgz",
1583 |       "integrity": "sha512-+q/t7Ekv1EDY2l6Gda6LLiX14rU9TV20Wa3ofeQmwPFZbOMo9DXrLbOjFaaclkXKWidIaopwAObQDqwWtGUjqg==",
1584 |       "dev": true,
1585 |       "license": "ISC",
1586 |       "engines": {
1587 |         "node": ">= 4.0.0"
1588 |       }
1589 |     },
1590 |     "node_modules/available-typed-arrays": {
1591 |       "version": "1.0.7",
1592 |       "resolved": "https://registry.npmjs.org/available-typed-arrays/-/available-typed-arrays-1.0.7.tgz",
1593 |       "integrity": "sha512-wvUjBtSGN7+7SjNpq/9M2Tg350UZD3q62IFZLbRAR1bSMlCo1ZaeW+BJ+D090e4hIIZLBcTDWe4Mh4jvUDajzQ==",
1594 |       "dev": true,
1595 |       "license": "MIT",
1596 |       "dependencies": {
1597 |         "possible-typed-array-names": "^1.0.0"
1598 |       },
1599 |       "engines": {
1600 |         "node": ">= 0.4"
1601 |       },
1602 |       "funding": {
1603 |         "url": "https://github.com/sponsors/ljharb"
1604 |       }
1605 |     },
1606 |     "node_modules/axios": {
1607 |       "version": "1.13.2",
1608 |       "resolved": "https://registry.npmjs.org/axios/-/axios-1.13.2.tgz",
1609 |       "integrity": "sha512-VPk9ebNqPcy5lRGuSlKx752IlDatOjT9paPlm8A7yOuW2Fbvp4X3JznJtT4f0GzGLLiWE9W8onz51SqLYwzGaA==",
1610 |       "license": "MIT",
1611 |       "dependencies": {
1612 |         "follow-redirects": "^1.15.6",
1613 |         "form-data": "^4.0.4",
1614 |         "proxy-from-env": "^1.1.0"
1615 |       }
1616 |     },
1617 |     "node_modules/b4a": {
1618 |       "version": "1.7.3",
1619 |       "resolved": "https://registry.npmjs.org/b4a/-/b4a-1.7.3.tgz",
1620 |       "integrity": "sha512-5Q2mfq2WfGuFp3uS//0s6baOJLMoVduPYVeNmDYxu5OUA1/cBfvr2RIS7vi62LdNj/urk1hfmj867I3qt6uZ7Q==",
1621 |       "license": "Apache-2.0",
1622 |       "peerDependencies": {
1623 |         "react-native-b4a": "*"
1624 |       },
1625 |       "peerDependenciesMeta": {
1626 |         "react-native-b4a": {
1627 |           "optional": true
1628 |         }
1629 |       }
1630 |     },
1631 |     "node_modules/balanced-match": {
1632 |       "version": "1.0.2",
1633 |       "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
1634 |       "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
1635 |       "license": "MIT"
1636 |     },
1637 |     "node_modules/bare-events": {
1638 |       "version": "2.8.2",
1639 |       "resolved": "https://registry.npmjs.org/bare-events/-/bare-events-2.8.2.tgz",
1640 |       "integrity": "sha512-riJjyv1/mHLIPX4RwiK+oW9/4c3TEUeORHKefKAKnZ5kyslbN+HXowtbaVEqt4IMUB7OXlfixcs6gsFeo/jhiQ==",
1641 |       "license": "Apache-2.0",
1642 |       "peerDependencies": {
1643 |         "bare-abort-controller": "*"
1644 |       },
1645 |       "peerDependenciesMeta": {
1646 |         "bare-abort-controller": {
1647 |           "optional": true
1648 |         }
1649 |       }
1650 |     },
1651 |     "node_modules/bare-fs": {
1652 |       "version": "4.5.1",
1653 |       "resolved": "https://registry.npmjs.org/bare-fs/-/bare-fs-4.5.1.tgz",
1654 |       "integrity": "sha512-zGUCsm3yv/ePt2PHNbVxjjn0nNB1MkIaR4wOCxJ2ig5pCf5cCVAYJXVhQg/3OhhJV6DB1ts7Hv0oUaElc2TPQg==",
1655 |       "license": "Apache-2.0",
1656 |       "optional": true,
1657 |       "dependencies": {
1658 |         "bare-events": "^2.5.4",
1659 |         "bare-path": "^3.0.0",
1660 |         "bare-stream": "^2.6.4",
1661 |         "bare-url": "^2.2.2",
1662 |         "fast-fifo": "^1.3.2"
1663 |       },
1664 |       "engines": {
1665 |         "bare": ">=1.16.0"
1666 |       },
1667 |       "peerDependencies": {
1668 |         "bare-buffer": "*"
1669 |       },
1670 |       "peerDependenciesMeta": {
1671 |         "bare-buffer": {
1672 |           "optional": true
1673 |         }
1674 |       }
1675 |     },
1676 |     "node_modules/bare-os": {
1677 |       "version": "3.6.2",
1678 |       "resolved": "https://registry.npmjs.org/bare-os/-/bare-os-3.6.2.tgz",
1679 |       "integrity": "sha512-T+V1+1srU2qYNBmJCXZkUY5vQ0B4FSlL3QDROnKQYOqeiQR8UbjNHlPa+TIbM4cuidiN9GaTaOZgSEgsvPbh5A==",
1680 |       "license": "Apache-2.0",
1681 |       "optional": true,
1682 |       "engines": {
1683 |         "bare": ">=1.14.0"
1684 |       }
1685 |     },
1686 |     "node_modules/bare-path": {
1687 |       "version": "3.0.0",
1688 |       "resolved": "https://registry.npmjs.org/bare-path/-/bare-path-3.0.0.tgz",
1689 |       "integrity": "sha512-tyfW2cQcB5NN8Saijrhqn0Zh7AnFNsnczRcuWODH0eYAXBsJ5gVxAUuNr7tsHSC6IZ77cA0SitzT+s47kot8Mw==",
1690 |       "license": "Apache-2.0",
1691 |       "optional": true,
1692 |       "dependencies": {
1693 |         "bare-os": "^3.0.1"
1694 |       }
1695 |     },
1696 |     "node_modules/bare-stream": {
1697 |       "version": "2.7.0",
1698 |       "resolved": "https://registry.npmjs.org/bare-stream/-/bare-stream-2.7.0.tgz",
1699 |       "integrity": "sha512-oyXQNicV1y8nc2aKffH+BUHFRXmx6VrPzlnaEvMhram0nPBrKcEdcyBg5r08D0i8VxngHFAiVyn1QKXpSG0B8A==",
1700 |       "license": "Apache-2.0",
1701 |       "optional": true,
1702 |       "dependencies": {
1703 |         "streamx": "^2.21.0"
1704 |       },
1705 |       "peerDependencies": {
1706 |         "bare-buffer": "*",
1707 |         "bare-events": "*"
1708 |       },
1709 |       "peerDependenciesMeta": {
1710 |         "bare-buffer": {
1711 |           "optional": true
1712 |         },
1713 |         "bare-events": {
1714 |           "optional": true
1715 |         }
1716 |       }
1717 |     },
1718 |     "node_modules/bare-url": {
1719 |       "version": "2.3.2",
1720 |       "resolved": "https://registry.npmjs.org/bare-url/-/bare-url-2.3.2.tgz",
1721 |       "integrity": "sha512-ZMq4gd9ngV5aTMa5p9+UfY0b3skwhHELaDkhEHetMdX0LRkW9kzaym4oo/Eh+Ghm0CCDuMTsRIGM/ytUc1ZYmw==",
1722 |       "license": "Apache-2.0",
1723 |       "optional": true,
1724 |       "dependencies": {
1725 |         "bare-path": "^3.0.0"
1726 |       }
1727 |     },
1728 |     "node_modules/base64-js": {
1729 |       "version": "1.5.1",
1730 |       "resolved": "https://registry.npmjs.org/base64-js/-/base64-js-1.5.1.tgz",
1731 |       "integrity": "sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==",
1732 |       "dev": true,
1733 |       "funding": [
1734 |         {
1735 |           "type": "github",
1736 |           "url": "https://github.com/sponsors/feross"
1737 |         },
1738 |         {
1739 |           "type": "patreon",
1740 |           "url": "https://www.patreon.com/feross"
1741 |         },
1742 |         {
1743 |           "type": "consulting",
1744 |           "url": "https://feross.org/support"
1745 |         }
1746 |       ],
1747 |       "license": "MIT"
1748 |     },
1749 |     "node_modules/baseline-browser-mapping": {
1750 |       "version": "2.9.13",
1751 |       "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.9.13.tgz",
1752 |       "integrity": "sha512-WhtvB2NG2wjr04+h77sg3klAIwrgOqnjS49GGudnUPGFFgg7G17y7Qecqp+2Dr5kUDxNRBca0SK7cG8JwzkWDQ==",
1753 |       "dev": true,
1754 |       "license": "Apache-2.0",
1755 |       "bin": {
1756 |         "baseline-browser-mapping": "dist/cli.js"
1757 |       }
1758 |     },
1759 |     "node_modules/basic-ftp": {
1760 |       "version": "5.0.5",
1761 |       "resolved": "https://registry.npmjs.org/basic-ftp/-/basic-ftp-5.0.5.tgz",
1762 |       "integrity": "sha512-4Bcg1P8xhUuqcii/S0Z9wiHIrQVPMermM1any+MX5GeGD7faD3/msQUDGLol9wOcz4/jbg/WJnGqoJF6LiBdtg==",
1763 |       "license": "MIT",
1764 |       "engines": {
1765 |         "node": ">=10.0.0"
1766 |       }
1767 |     },
1768 |     "node_modules/bl": {
1769 |       "version": "4.1.0",
1770 |       "resolved": "https://registry.npmjs.org/bl/-/bl-4.1.0.tgz",
1771 |       "integrity": "sha512-1W07cM9gS6DcLperZfFSj+bWLtaPGSOHWhPiGzXmvVJbRLdG82sH/Kn8EtW1VqWVA54AKf2h5k5BbnIbwF3h6w==",
1772 |       "dev": true,
1773 |       "license": "MIT",
1774 |       "dependencies": {
1775 |         "buffer": "^5.5.0",
1776 |         "inherits": "^2.0.4",
1777 |         "readable-stream": "^3.4.0"
1778 |       }
1779 |     },
1780 |     "node_modules/bl/node_modules/readable-stream": {
1781 |       "version": "3.6.2",
1782 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
1783 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
1784 |       "dev": true,
1785 |       "license": "MIT",
1786 |       "dependencies": {
1787 |         "inherits": "^2.0.3",
1788 |         "string_decoder": "^1.1.1",
1789 |         "util-deprecate": "^1.0.1"
1790 |       },
1791 |       "engines": {
1792 |         "node": ">= 6"
1793 |       }
1794 |     },
1795 |     "node_modules/bluebird": {
1796 |       "version": "3.7.2",
1797 |       "resolved": "https://registry.npmjs.org/bluebird/-/bluebird-3.7.2.tgz",
1798 |       "integrity": "sha512-XpNj6GDQzdfW+r2Wnn7xiSAd7TM3jzkxGXBGTtWKuSXv1xUV+azxAm8jdWZN06QTQk+2N2XB9jRDkvbmQmcRtg==",
1799 |       "dev": true,
1800 |       "license": "MIT"
1801 |     },
1802 |     "node_modules/brace-expansion": {
1803 |       "version": "1.1.12",
1804 |       "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.12.tgz",
1805 |       "integrity": "sha512-9T9UjW3r0UW5c1Q7GTwllptXwhvYmEzFhzMfZ9H7FQWt+uZePjZPjBP/W1ZEyZ1twGWom5/56TF4lPcqjnDHcg==",
1806 |       "license": "MIT",
1807 |       "dependencies": {
1808 |         "balanced-match": "^1.0.0",
1809 |         "concat-map": "0.0.1"
1810 |       }
1811 |     },
1812 |     "node_modules/braces": {
1813 |       "version": "3.0.3",
1814 |       "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
1815 |       "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
1816 |       "dev": true,
1817 |       "license": "MIT",
1818 |       "dependencies": {
1819 |         "fill-range": "^7.1.1"
1820 |       },
1821 |       "engines": {
1822 |         "node": ">=8"
1823 |       }
1824 |     },
1825 |     "node_modules/browserslist": {
1826 |       "version": "4.28.1",
1827 |       "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.1.tgz",
1828 |       "integrity": "sha512-ZC5Bd0LgJXgwGqUknZY/vkUQ04r8NXnJZ3yYi4vDmSiZmC/pdSN0NbNRPxZpbtO4uAfDUAFffO8IZoM3Gj8IkA==",
1829 |       "dev": true,
1830 |       "funding": [
1831 |         {
1832 |           "type": "opencollective",
1833 |           "url": "https://opencollective.com/browserslist"
1834 |         },
1835 |         {
1836 |           "type": "tidelift",
1837 |           "url": "https://tidelift.com/funding/github/npm/browserslist"
1838 |         },
1839 |         {
1840 |           "type": "github",
1841 |           "url": "https://github.com/sponsors/ai"
1842 |         }
1843 |       ],
1844 |       "license": "MIT",
1845 |       "peer": true,
1846 |       "dependencies": {
1847 |         "baseline-browser-mapping": "^2.9.0",
1848 |         "caniuse-lite": "^1.0.30001759",
1849 |         "electron-to-chromium": "^1.5.263",
1850 |         "node-releases": "^2.0.27",
1851 |         "update-browserslist-db": "^1.2.0"
1852 |       },
1853 |       "bin": {
1854 |         "browserslist": "cli.js"
1855 |       },
1856 |       "engines": {
1857 |         "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
1858 |       }
1859 |     },
1860 |     "node_modules/buffer": {
1861 |       "version": "5.7.1",
1862 |       "resolved": "https://registry.npmjs.org/buffer/-/buffer-5.7.1.tgz",
1863 |       "integrity": "sha512-EHcyIPBQ4BSGlvjB16k5KgAJ27CIsHY/2JBmCRReo48y9rQ3MaUzWX3KVlBa4U7MyX02HdVj0K7C3WaB3ju7FQ==",
1864 |       "dev": true,
1865 |       "funding": [
1866 |         {
1867 |           "type": "github",
1868 |           "url": "https://github.com/sponsors/feross"
1869 |         },
1870 |         {
1871 |           "type": "patreon",
1872 |           "url": "https://www.patreon.com/feross"
1873 |         },
1874 |         {
1875 |           "type": "consulting",
1876 |           "url": "https://feross.org/support"
1877 |         }
1878 |       ],
1879 |       "license": "MIT",
1880 |       "dependencies": {
1881 |         "base64-js": "^1.3.1",
1882 |         "ieee754": "^1.1.13"
1883 |       }
1884 |     },
1885 |     "node_modules/buffer-alloc": {
1886 |       "version": "1.2.0",
1887 |       "resolved": "https://registry.npmjs.org/buffer-alloc/-/buffer-alloc-1.2.0.tgz",
1888 |       "integrity": "sha512-CFsHQgjtW1UChdXgbyJGtnm+O/uLQeZdtbDo8mfUgYXCHSM1wgrVxXm6bSyrUuErEb+4sYVGCzASBRot7zyrow==",
1889 |       "dev": true,
1890 |       "license": "MIT",
1891 |       "dependencies": {
1892 |         "buffer-alloc-unsafe": "^1.1.0",
1893 |         "buffer-fill": "^1.0.0"
1894 |       }
1895 |     },
1896 |     "node_modules/buffer-alloc-unsafe": {
1897 |       "version": "1.1.0",
1898 |       "resolved": "https://registry.npmjs.org/buffer-alloc-unsafe/-/buffer-alloc-unsafe-1.1.0.tgz",
1899 |       "integrity": "sha512-TEM2iMIEQdJ2yjPJoSIsldnleVaAk1oW3DBVUykyOLsEsFmEc9kn+SFFPz+gl54KQNxlDnAwCXosOS9Okx2xAg==",
1900 |       "dev": true,
1901 |       "license": "MIT"
1902 |     },
1903 |     "node_modules/buffer-crc32": {
1904 |       "version": "0.2.13",
1905 |       "resolved": "https://registry.npmjs.org/buffer-crc32/-/buffer-crc32-0.2.13.tgz",
1906 |       "integrity": "sha512-VO9Ht/+p3SN7SKWqcrgEzjGbRSJYTx+Q1pTQC0wrWqHx0vpJraQ6GtHx8tvcg1rlK1byhU5gccxgOgj7B0TDkQ==",
1907 |       "license": "MIT",
1908 |       "engines": {
1909 |         "node": "*"
1910 |       }
1911 |     },
1912 |     "node_modules/buffer-fill": {
1913 |       "version": "1.0.0",
1914 |       "resolved": "https://registry.npmjs.org/buffer-fill/-/buffer-fill-1.0.0.tgz",
1915 |       "integrity": "sha512-T7zexNBwiiaCOGDg9xNX9PBmjrubblRkENuptryuI64URkXDFum9il/JGL8Lm8wYfAXpredVXXZz7eMHilimiQ==",
1916 |       "dev": true,
1917 |       "license": "MIT"
1918 |     },
1919 |     "node_modules/buffer-from": {
1920 |       "version": "1.1.2",
1921 |       "resolved": "https://registry.npmjs.org/buffer-from/-/buffer-from-1.1.2.tgz",
1922 |       "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
1923 |       "dev": true,
1924 |       "license": "MIT"
1925 |     },
1926 |     "node_modules/cacheable-lookup": {
1927 |       "version": "7.0.0",
1928 |       "resolved": "https://registry.npmjs.org/cacheable-lookup/-/cacheable-lookup-7.0.0.tgz",
1929 |       "integrity": "sha512-+qJyx4xiKra8mZrcwhjMRMUhD5NR1R8esPkzIYxX96JiecFoxAXFuz/GpR3+ev4PE1WamHip78wV0vcmPQtp8w==",
1930 |       "dev": true,
1931 |       "license": "MIT",
1932 |       "engines": {
1933 |         "node": ">=14.16"
1934 |       }
1935 |     },
1936 |     "node_modules/cacheable-request": {
1937 |       "version": "10.2.14",
1938 |       "resolved": "https://registry.npmjs.org/cacheable-request/-/cacheable-request-10.2.14.tgz",
1939 |       "integrity": "sha512-zkDT5WAF4hSSoUgyfg5tFIxz8XQK+25W/TLVojJTMKBaxevLBBtLxgqguAuVQB8PVW79FVjHcU+GJ9tVbDZ9mQ==",
1940 |       "dev": true,
1941 |       "license": "MIT",
1942 |       "dependencies": {
1943 |         "@types/http-cache-semantics": "^4.0.2",
1944 |         "get-stream": "^6.0.1",
1945 |         "http-cache-semantics": "^4.1.1",
1946 |         "keyv": "^4.5.3",
1947 |         "mimic-response": "^4.0.0",
1948 |         "normalize-url": "^8.0.0",
1949 |         "responselike": "^3.0.0"
1950 |       },
1951 |       "engines": {
1952 |         "node": ">=14.16"
1953 |       }
1954 |     },
1955 |     "node_modules/cacheable-request/node_modules/get-stream": {
1956 |       "version": "6.0.1",
1957 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-6.0.1.tgz",
1958 |       "integrity": "sha512-ts6Wi+2j3jQjqi70w5AlN8DFnkSwC+MqmxEzdEALB2qXZYV3X/b1CTfgPLGJNMeAWxdPfU8FO1ms3NUfaHCPYg==",
1959 |       "dev": true,
1960 |       "license": "MIT",
1961 |       "engines": {
1962 |         "node": ">=10"
1963 |       },
1964 |       "funding": {
1965 |         "url": "https://github.com/sponsors/sindresorhus"
1966 |       }
1967 |     },
1968 |     "node_modules/cacheable-request/node_modules/mimic-response": {
1969 |       "version": "4.0.0",
1970 |       "resolved": "https://registry.npmjs.org/mimic-response/-/mimic-response-4.0.0.tgz",
1971 |       "integrity": "sha512-e5ISH9xMYU0DzrT+jl8q2ze9D6eWBto+I8CNpe+VI+K2J/F/k3PdkdTdz4wvGVH4NTpo+NRYTVIuMQEMMcsLqg==",
1972 |       "dev": true,
1973 |       "license": "MIT",
1974 |       "engines": {
1975 |         "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
1976 |       },
1977 |       "funding": {
1978 |         "url": "https://github.com/sponsors/sindresorhus"
1979 |       }
1980 |     },
1981 |     "node_modules/call-bind": {
1982 |       "version": "1.0.8",
1983 |       "resolved": "https://registry.npmjs.org/call-bind/-/call-bind-1.0.8.tgz",
1984 |       "integrity": "sha512-oKlSFMcMwpUg2ednkhQ454wfWiU/ul3CkJe/PEHcTKuiX6RpbehUiFMXu13HalGZxfUwCQzZG747YXBn1im9ww==",
1985 |       "dev": true,
1986 |       "license": "MIT",
1987 |       "dependencies": {
1988 |         "call-bind-apply-helpers": "^1.0.0",
1989 |         "es-define-property": "^1.0.0",
1990 |         "get-intrinsic": "^1.2.4",
1991 |         "set-function-length": "^1.2.2"
1992 |       },
1993 |       "engines": {
1994 |         "node": ">= 0.4"
1995 |       },
1996 |       "funding": {
1997 |         "url": "https://github.com/sponsors/ljharb"
1998 |       }
1999 |     },
2000 |     "node_modules/call-bind-apply-helpers": {
2001 |       "version": "1.0.2",
2002 |       "resolved": "https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
2003 |       "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
2004 |       "license": "MIT",
2005 |       "dependencies": {
2006 |         "es-errors": "^1.3.0",
2007 |         "function-bind": "^1.1.2"
2008 |       },
2009 |       "engines": {
2010 |         "node": ">= 0.4"
2011 |       }
2012 |     },
2013 |     "node_modules/call-bound": {
2014 |       "version": "1.0.4",
2015 |       "resolved": "https://registry.npmjs.org/call-bound/-/call-bound-1.0.4.tgz",
2016 |       "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
2017 |       "dev": true,
2018 |       "license": "MIT",
2019 |       "dependencies": {
2020 |         "call-bind-apply-helpers": "^1.0.2",
2021 |         "get-intrinsic": "^1.3.0"
2022 |       },
2023 |       "engines": {
2024 |         "node": ">= 0.4"
2025 |       },
2026 |       "funding": {
2027 |         "url": "https://github.com/sponsors/ljharb"
2028 |       }
2029 |     },
2030 |     "node_modules/callsites": {
2031 |       "version": "3.1.0",
2032 |       "resolved": "https://registry.npmjs.org/callsites/-/callsites-3.1.0.tgz",
2033 |       "integrity": "sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==",
2034 |       "license": "MIT",
2035 |       "engines": {
2036 |         "node": ">=6"
2037 |       }
2038 |     },
2039 |     "node_modules/caniuse-lite": {
2040 |       "version": "1.0.30001763",
2041 |       "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001763.tgz",
2042 |       "integrity": "sha512-mh/dGtq56uN98LlNX9qdbKnzINhX0QzhiWBFEkFfsFO4QyCvL8YegrJAazCwXIeqkIob8BlZPGM3xdnY+sgmvQ==",
2043 |       "dev": true,
2044 |       "funding": [
2045 |         {
2046 |           "type": "opencollective",
2047 |           "url": "https://opencollective.com/browserslist"
2048 |         },
2049 |         {
2050 |           "type": "tidelift",
2051 |           "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
2052 |         },
2053 |         {
2054 |           "type": "github",
2055 |           "url": "https://github.com/sponsors/ai"
2056 |         }
2057 |       ],
2058 |       "license": "CC-BY-4.0"
2059 |     },
2060 |     "node_modules/caw": {
2061 |       "version": "2.0.1",
2062 |       "resolved": "https://registry.npmjs.org/caw/-/caw-2.0.1.tgz",
2063 |       "integrity": "sha512-Cg8/ZSBEa8ZVY9HspcGUYaK63d/bN7rqS3CYCzEGUxuYv6UlmcjzDUz2fCFFHyTvUW5Pk0I+3hkA3iXlIj6guA==",
2064 |       "dev": true,
2065 |       "license": "MIT",
2066 |       "dependencies": {
2067 |         "get-proxy": "^2.0.0",
2068 |         "isurl": "^1.0.0-alpha5",
2069 |         "tunnel-agent": "^0.6.0",
2070 |         "url-to-options": "^1.0.1"
2071 |       },
2072 |       "engines": {
2073 |         "node": ">=4"
2074 |       }
2075 |     },
2076 |     "node_modules/chalk": {
2077 |       "version": "4.1.2",
2078 |       "resolved": "https://registry.npmjs.org/chalk/-/chalk-4.1.2.tgz",
2079 |       "integrity": "sha512-oKnbhFyRIXpUuez8iBMmyEa4nbj4IOQyuhc/wy9kY7/WVPcwIO9VA668Pu8RkO7+0G76SLROeyw9CpQ061i4mA==",
2080 |       "dev": true,
2081 |       "license": "MIT",
2082 |       "dependencies": {
2083 |         "ansi-styles": "^4.1.0",
2084 |         "supports-color": "^7.1.0"
2085 |       },
2086 |       "engines": {
2087 |         "node": ">=10"
2088 |       },
2089 |       "funding": {
2090 |         "url": "https://github.com/chalk/chalk?sponsor=1"
2091 |       }
2092 |     },
2093 |     "node_modules/chownr": {
2094 |       "version": "1.1.4",
2095 |       "resolved": "https://registry.npmjs.org/chownr/-/chownr-1.1.4.tgz",
2096 |       "integrity": "sha512-jJ0bqzaylmJtVnNgzTeSOs8DPavpbYgEr/b0YL8/2GO3xJEhInFmhKMUnEJQjZumK7KXGFhUy89PrsJWlakBVg==",
2097 |       "dev": true,
2098 |       "license": "ISC"
2099 |     },
2100 |     "node_modules/chrome-trace-event": {
2101 |       "version": "1.0.4",
2102 |       "resolved": "https://registry.npmjs.org/chrome-trace-event/-/chrome-trace-event-1.0.4.tgz",
2103 |       "integrity": "sha512-rNjApaLzuwaOTjCiT8lSDdGN1APCiqkChLMJxJPWLunPAt5fy8xgU9/jNOchV84wfIxrA0lRQB7oCT8jrn/wrQ==",
2104 |       "dev": true,
2105 |       "license": "MIT",
2106 |       "engines": {
2107 |         "node": ">=6.0"
2108 |       }
2109 |     },
2110 |     "node_modules/chromium-bidi": {
2111 |       "version": "11.0.0",
2112 |       "resolved": "https://registry.npmjs.org/chromium-bidi/-/chromium-bidi-11.0.0.tgz",
2113 |       "integrity": "sha512-cM3DI+OOb89T3wO8cpPSro80Q9eKYJ7hGVXoGS3GkDPxnYSqiv+6xwpIf6XERyJ9Tdsl09hmNmY94BkgZdVekw==",
2114 |       "license": "Apache-2.0",
2115 |       "dependencies": {
2116 |         "mitt": "^3.0.1",
2117 |         "zod": "^3.24.1"
2118 |       },
2119 |       "peerDependencies": {
2120 |         "devtools-protocol": "*"
2121 |       }
2122 |     },
2123 |     "node_modules/cli-cursor": {
2124 |       "version": "2.1.0",
2125 |       "resolved": "https://registry.npmjs.org/cli-cursor/-/cli-cursor-2.1.0.tgz",
2126 |       "integrity": "sha512-8lgKz8LmCRYZZQDpRyT2m5rKJ08TnU4tR9FFFW2rxpxR1FzWi4PQ/NfyODchAatHaUgnSPVcx/R5w6NuTBzFiw==",
2127 |       "dev": true,
2128 |       "license": "MIT",
2129 |       "dependencies": {
2130 |         "restore-cursor": "^2.0.0"
2131 |       },
2132 |       "engines": {
2133 |         "node": ">=4"
2134 |       }
2135 |     },
2136 |     "node_modules/cli-spinners": {
2137 |       "version": "2.9.2",
2138 |       "resolved": "https://registry.npmjs.org/cli-spinners/-/cli-spinners-2.9.2.tgz",
2139 |       "integrity": "sha512-ywqV+5MmyL4E7ybXgKys4DugZbX0FC6LnwrhjuykIjnK9k8OQacQ7axGKnjDXWNhns0xot3bZI5h55H8yo9cJg==",
2140 |       "dev": true,
2141 |       "license": "MIT",
2142 |       "engines": {
2143 |         "node": ">=6"
2144 |       },
2145 |       "funding": {
2146 |         "url": "https://github.com/sponsors/sindresorhus"
2147 |       }
2148 |     },
2149 |     "node_modules/cliui": {
2150 |       "version": "8.0.1",
2151 |       "resolved": "https://registry.npmjs.org/cliui/-/cliui-8.0.1.tgz",
2152 |       "integrity": "sha512-BSeNnyus75C4//NQ9gQt1/csTXyo/8Sb+afLAkzAptFuMsod9HFokGNudZpi/oQV73hnVK+sR+5PVRMd+Dr7YQ==",
2153 |       "license": "ISC",
2154 |       "dependencies": {
2155 |         "string-width": "^4.2.0",
2156 |         "strip-ansi": "^6.0.1",
2157 |         "wrap-ansi": "^7.0.0"
2158 |       },
2159 |       "engines": {
2160 |         "node": ">=12"
2161 |       }
2162 |     },
2163 |     "node_modules/clone": {
2164 |       "version": "1.0.4",
2165 |       "resolved": "https://registry.npmjs.org/clone/-/clone-1.0.4.tgz",
2166 |       "integrity": "sha512-JQHZ2QMW6l3aH/j6xCqQThY/9OH4D/9ls34cgkUBiEeocRTU04tHfKPBsUK1PqZCUQM7GiA0IIXJSuXHI64Kbg==",
2167 |       "dev": true,
2168 |       "license": "MIT",
2169 |       "engines": {
2170 |         "node": ">=0.8"
2171 |       }
2172 |     },
2173 |     "node_modules/clone-deep": {
2174 |       "version": "4.0.1",
2175 |       "resolved": "https://registry.npmjs.org/clone-deep/-/clone-deep-4.0.1.tgz",
2176 |       "integrity": "sha512-neHB9xuzh/wk0dIHweyAXv2aPGZIVk3pLMe+/RNzINf17fe0OG96QroktYAUm7SM1PBnzTabaLboqqxDyMU+SQ==",
2177 |       "dev": true,
2178 |       "license": "MIT",
2179 |       "dependencies": {
2180 |         "is-plain-object": "^2.0.4",
2181 |         "kind-of": "^6.0.2",
2182 |         "shallow-clone": "^3.0.0"
2183 |       },
2184 |       "engines": {
2185 |         "node": ">=6"
2186 |       }
2187 |     },
2188 |     "node_modules/clone-response": {
2189 |       "version": "1.0.2",
2190 |       "resolved": "https://registry.npmjs.org/clone-response/-/clone-response-1.0.2.tgz",
2191 |       "integrity": "sha512-yjLXh88P599UOyPTFX0POsd7WxnbsVsGohcwzHOLspIhhpalPw1BcqED8NblyZLKcGrL8dTgMlcaZxV2jAD41Q==",
2192 |       "dev": true,
2193 |       "license": "MIT",
2194 |       "dependencies": {
2195 |         "mimic-response": "^1.0.0"
2196 |       }
2197 |     },
2198 |     "node_modules/clone-response/node_modules/mimic-response": {
2199 |       "version": "1.0.1",
2200 |       "resolved": "https://registry.npmjs.org/mimic-response/-/mimic-response-1.0.1.tgz",
2201 |       "integrity": "sha512-j5EctnkH7amfV/q5Hgmoal1g2QHFJRraOtmx0JpIqkxhBhI/lJSl1nMpQ45hVarwNETOoWEimndZ4QK0RHxuxQ==",
2202 |       "dev": true,
2203 |       "license": "MIT",
2204 |       "engines": {
2205 |         "node": ">=4"
2206 |       }
2207 |     },
2208 |     "node_modules/color-convert": {
2209 |       "version": "2.0.1",
2210 |       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
2211 |       "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
2212 |       "license": "MIT",
2213 |       "dependencies": {
2214 |         "color-name": "~1.1.4"
2215 |       },
2216 |       "engines": {
2217 |         "node": ">=7.0.0"
2218 |       }
2219 |     },
2220 |     "node_modules/color-name": {
2221 |       "version": "1.1.4",
2222 |       "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
2223 |       "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
2224 |       "license": "MIT"
2225 |     },
2226 |     "node_modules/colorette": {
2227 |       "version": "2.0.20",
2228 |       "resolved": "https://registry.npmjs.org/colorette/-/colorette-2.0.20.tgz",
2229 |       "integrity": "sha512-IfEDxwoWIjkeXL1eXcDiow4UbKjhLdq6/EuSVR9GMN7KVH3r9gQ83e73hsz1Nd1T3ijd5xv1wcWRYO+D6kCI2w==",
2230 |       "dev": true,
2231 |       "license": "MIT"
2232 |     },
2233 |     "node_modules/combined-stream": {
2234 |       "version": "1.0.8",
2235 |       "resolved": "https://registry.npmjs.org/combined-stream/-/combined-stream-1.0.8.tgz",
2236 |       "integrity": "sha512-FQN4MRfuJeHf7cBbBMJFXhKSDq+2kAArBlmRBvcvFE5BB1HZKXtSFASDhdlz9zOYwxh8lDdnvmMOe/+5cdoEdg==",
2237 |       "license": "MIT",
2238 |       "dependencies": {
2239 |         "delayed-stream": "~1.0.0"
2240 |       },
2241 |       "engines": {
2242 |         "node": ">= 0.8"
2243 |       }
2244 |     },
2245 |     "node_modules/commander": {
2246 |       "version": "2.20.3",
2247 |       "resolved": "https://registry.npmjs.org/commander/-/commander-2.20.3.tgz",
2248 |       "integrity": "sha512-GpVkmM8vF2vQUkj2LvZmD35JxeJOLCwJ9cUkugyk2nuhbv3+mJvpLYYt+0+USMxE+oj+ey/lJEnhZw75x/OMcQ==",
2249 |       "dev": true,
2250 |       "license": "MIT"
2251 |     },
2252 |     "node_modules/compress-commons": {
2253 |       "version": "4.1.2",
2254 |       "resolved": "https://registry.npmjs.org/compress-commons/-/compress-commons-4.1.2.tgz",
2255 |       "integrity": "sha512-D3uMHtGc/fcO1Gt1/L7i1e33VOvD4A9hfQLP+6ewd+BvG/gQ84Yh4oftEhAdjSMgBgwGL+jsppT7JYNpo6MHHg==",
2256 |       "dev": true,
2257 |       "license": "MIT",
2258 |       "dependencies": {
2259 |         "buffer-crc32": "^0.2.13",
2260 |         "crc32-stream": "^4.0.2",
2261 |         "normalize-path": "^3.0.0",
2262 |         "readable-stream": "^3.6.0"
2263 |       },
2264 |       "engines": {
2265 |         "node": ">= 10"
2266 |       }
2267 |     },
2268 |     "node_modules/compress-commons/node_modules/readable-stream": {
2269 |       "version": "3.6.2",
2270 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
2271 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
2272 |       "dev": true,
2273 |       "license": "MIT",
2274 |       "dependencies": {
2275 |         "inherits": "^2.0.3",
2276 |         "string_decoder": "^1.1.1",
2277 |         "util-deprecate": "^1.0.1"
2278 |       },
2279 |       "engines": {
2280 |         "node": ">= 6"
2281 |       }
2282 |     },
2283 |     "node_modules/concat-map": {
2284 |       "version": "0.0.1",
2285 |       "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
2286 |       "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
2287 |       "license": "MIT"
2288 |     },
2289 |     "node_modules/config-chain": {
2290 |       "version": "1.1.13",
2291 |       "resolved": "https://registry.npmjs.org/config-chain/-/config-chain-1.1.13.tgz",
2292 |       "integrity": "sha512-qj+f8APARXHrM0hraqXYb2/bOVSV4PvJQlNZ/DVj0QrmNM2q2euizkeuVckQ57J+W0mRH6Hvi+k50M4Jul2VRQ==",
2293 |       "dev": true,
2294 |       "license": "MIT",
2295 |       "dependencies": {
2296 |         "ini": "^1.3.4",
2297 |         "proto-list": "~1.2.1"
2298 |       }
2299 |     },
2300 |     "node_modules/content-disposition": {
2301 |       "version": "0.5.4",
2302 |       "resolved": "https://registry.npmjs.org/content-disposition/-/content-disposition-0.5.4.tgz",
2303 |       "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
2304 |       "dev": true,
2305 |       "license": "MIT",
2306 |       "dependencies": {
2307 |         "safe-buffer": "5.2.1"
2308 |       },
2309 |       "engines": {
2310 |         "node": ">= 0.6"
2311 |       }
2312 |     },
2313 |     "node_modules/content-disposition/node_modules/safe-buffer": {
2314 |       "version": "5.2.1",
2315 |       "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
2316 |       "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
2317 |       "dev": true,
2318 |       "funding": [
2319 |         {
2320 |           "type": "github",
2321 |           "url": "https://github.com/sponsors/feross"
2322 |         },
2323 |         {
2324 |           "type": "patreon",
2325 |           "url": "https://www.patreon.com/feross"
2326 |         },
2327 |         {
2328 |           "type": "consulting",
2329 |           "url": "https://feross.org/support"
2330 |         }
2331 |       ],
2332 |       "license": "MIT"
2333 |     },
2334 |     "node_modules/core-util-is": {
2335 |       "version": "1.0.3",
2336 |       "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.3.tgz",
2337 |       "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==",
2338 |       "dev": true,
2339 |       "license": "MIT"
2340 |     },
2341 |     "node_modules/cosmiconfig": {
2342 |       "version": "9.0.0",
2343 |       "resolved": "https://registry.npmjs.org/cosmiconfig/-/cosmiconfig-9.0.0.tgz",
2344 |       "integrity": "sha512-itvL5h8RETACmOTFc4UfIyB2RfEHi71Ax6E/PivVxq9NseKbOWpeyHEOIbmAw1rs8Ak0VursQNww7lf7YtUwzg==",
2345 |       "license": "MIT",
2346 |       "dependencies": {
2347 |         "env-paths": "^2.2.1",
2348 |         "import-fresh": "^3.3.0",
2349 |         "js-yaml": "^4.1.0",
2350 |         "parse-json": "^5.2.0"
2351 |       },
2352 |       "engines": {
2353 |         "node": ">=14"
2354 |       },
2355 |       "funding": {
2356 |         "url": "https://github.com/sponsors/d-fischer"
2357 |       },
2358 |       "peerDependencies": {
2359 |         "typescript": ">=4.9.5"
2360 |       },
2361 |       "peerDependenciesMeta": {
2362 |         "typescript": {
2363 |           "optional": true
2364 |         }
2365 |       }
2366 |     },
2367 |     "node_modules/crc-32": {
2368 |       "version": "1.2.2",
2369 |       "resolved": "https://registry.npmjs.org/crc-32/-/crc-32-1.2.2.tgz",
2370 |       "integrity": "sha512-ROmzCKrTnOwybPcJApAA6WBWij23HVfGVNKqqrZpuyZOHqK2CwHSvpGuyt/UNNvaIjEd8X5IFGp4Mh+Ie1IHJQ==",
2371 |       "dev": true,
2372 |       "license": "Apache-2.0",
2373 |       "bin": {
2374 |         "crc32": "bin/crc32.njs"
2375 |       },
2376 |       "engines": {
2377 |         "node": ">=0.8"
2378 |       }
2379 |     },
2380 |     "node_modules/crc32-stream": {
2381 |       "version": "4.0.3",
2382 |       "resolved": "https://registry.npmjs.org/crc32-stream/-/crc32-stream-4.0.3.tgz",
2383 |       "integrity": "sha512-NT7w2JVU7DFroFdYkeq8cywxrgjPHWkdX1wjpRQXPX5Asews3tA+Ght6lddQO5Mkumffp3X7GEqku3epj2toIw==",
2384 |       "dev": true,
2385 |       "license": "MIT",
2386 |       "dependencies": {
2387 |         "crc-32": "^1.2.0",
2388 |         "readable-stream": "^3.4.0"
2389 |       },
2390 |       "engines": {
2391 |         "node": ">= 10"
2392 |       }
2393 |     },
2394 |     "node_modules/crc32-stream/node_modules/readable-stream": {
2395 |       "version": "3.6.2",
2396 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
2397 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
2398 |       "dev": true,
2399 |       "license": "MIT",
2400 |       "dependencies": {
2401 |         "inherits": "^2.0.3",
2402 |         "string_decoder": "^1.1.1",
2403 |         "util-deprecate": "^1.0.1"
2404 |       },
2405 |       "engines": {
2406 |         "node": ">= 6"
2407 |       }
2408 |     },
2409 |     "node_modules/cross-spawn": {
2410 |       "version": "7.0.6",
2411 |       "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.6.tgz",
2412 |       "integrity": "sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==",
2413 |       "dev": true,
2414 |       "license": "MIT",
2415 |       "dependencies": {
2416 |         "path-key": "^3.1.0",
2417 |         "shebang-command": "^2.0.0",
2418 |         "which": "^2.0.1"
2419 |       },
2420 |       "engines": {
2421 |         "node": ">= 8"
2422 |       }
2423 |     },
2424 |     "node_modules/data-uri-to-buffer": {
2425 |       "version": "6.0.2",
2426 |       "resolved": "https://registry.npmjs.org/data-uri-to-buffer/-/data-uri-to-buffer-6.0.2.tgz",
2427 |       "integrity": "sha512-7hvf7/GW8e86rW0ptuwS3OcBGDjIi6SZva7hCyWC0yYry2cOPmLIjXAUHI6DK2HsnwJd9ifmt57i8eV2n4YNpw==",
2428 |       "license": "MIT",
2429 |       "engines": {
2430 |         "node": ">= 14"
2431 |       }
2432 |     },
2433 |     "node_modules/debug": {
2434 |       "version": "4.4.3",
2435 |       "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
2436 |       "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
2437 |       "license": "MIT",
2438 |       "dependencies": {
2439 |         "ms": "^2.1.3"
2440 |       },
2441 |       "engines": {
2442 |         "node": ">=6.0"
2443 |       },
2444 |       "peerDependenciesMeta": {
2445 |         "supports-color": {
2446 |           "optional": true
2447 |         }
2448 |       }
2449 |     },
2450 |     "node_modules/decode-uri-component": {
2451 |       "version": "0.2.2",
2452 |       "resolved": "https://registry.npmjs.org/decode-uri-component/-/decode-uri-component-0.2.2.tgz",
2453 |       "integrity": "sha512-FqUYQ+8o158GyGTrMFJms9qh3CqTKvAqgqsTnkLI8sKu0028orqBhxNMFkFen0zGyg6epACD32pjVk58ngIErQ==",
2454 |       "dev": true,
2455 |       "license": "MIT",
2456 |       "engines": {
2457 |         "node": ">=0.10"
2458 |       }
2459 |     },
2460 |     "node_modules/decompress": {
2461 |       "version": "4.2.1",
2462 |       "resolved": "https://registry.npmjs.org/decompress/-/decompress-4.2.1.tgz",
2463 |       "integrity": "sha512-e48kc2IjU+2Zw8cTb6VZcJQ3lgVbS4uuB1TfCHbiZIP/haNXm+SVyhu+87jts5/3ROpd82GSVCoNs/z8l4ZOaQ==",
2464 |       "dev": true,
2465 |       "license": "MIT",
2466 |       "dependencies": {
2467 |         "decompress-tar": "^4.0.0",
2468 |         "decompress-tarbz2": "^4.0.0",
2469 |         "decompress-targz": "^4.0.0",
2470 |         "decompress-unzip": "^4.0.1",
2471 |         "graceful-fs": "^4.1.10",
2472 |         "make-dir": "^1.0.0",
2473 |         "pify": "^2.3.0",
2474 |         "strip-dirs": "^2.0.0"
2475 |       },
2476 |       "engines": {
2477 |         "node": ">=4"
2478 |       }
2479 |     },
2480 |     "node_modules/decompress-response": {
2481 |       "version": "6.0.0",
2482 |       "resolved": "https://registry.npmjs.org/decompress-response/-/decompress-response-6.0.0.tgz",
2483 |       "integrity": "sha512-aW35yZM6Bb/4oJlZncMH2LCoZtJXTRxES17vE3hoRiowU2kWHaJKFkSBDnDR+cm9J+9QhXmREyIfv0pji9ejCQ==",
2484 |       "dev": true,
2485 |       "license": "MIT",
2486 |       "dependencies": {
2487 |         "mimic-response": "^3.1.0"
2488 |       },
2489 |       "engines": {
2490 |         "node": ">=10"
2491 |       },
2492 |       "funding": {
2493 |         "url": "https://github.com/sponsors/sindresorhus"
2494 |       }
2495 |     },
2496 |     "node_modules/decompress-tar": {
2497 |       "version": "4.1.1",
2498 |       "resolved": "https://registry.npmjs.org/decompress-tar/-/decompress-tar-4.1.1.tgz",
2499 |       "integrity": "sha512-JdJMaCrGpB5fESVyxwpCx4Jdj2AagLmv3y58Qy4GE6HMVjWz1FeVQk1Ct4Kye7PftcdOo/7U7UKzYBJgqnGeUQ==",
2500 |       "dev": true,
2501 |       "license": "MIT",
2502 |       "dependencies": {
2503 |         "file-type": "^5.2.0",
2504 |         "is-stream": "^1.1.0",
2505 |         "tar-stream": "^1.5.2"
2506 |       },
2507 |       "engines": {
2508 |         "node": ">=4"
2509 |       }
2510 |     },
2511 |     "node_modules/decompress-tar/node_modules/bl": {
2512 |       "version": "1.2.3",
2513 |       "resolved": "https://registry.npmjs.org/bl/-/bl-1.2.3.tgz",
2514 |       "integrity": "sha512-pvcNpa0UU69UT341rO6AYy4FVAIkUHuZXRIWbq+zHnsVcRzDDjIAhGuuYoi0d//cwIwtt4pkpKycWEfjdV+vww==",
2515 |       "dev": true,
2516 |       "license": "MIT",
2517 |       "dependencies": {
2518 |         "readable-stream": "^2.3.5",
2519 |         "safe-buffer": "^5.1.1"
2520 |       }
2521 |     },
2522 |     "node_modules/decompress-tar/node_modules/file-type": {
2523 |       "version": "5.2.0",
2524 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-5.2.0.tgz",
2525 |       "integrity": "sha512-Iq1nJ6D2+yIO4c8HHg4fyVb8mAJieo1Oloy1mLLaB2PvezNedhBVm+QU7g0qM42aiMbRXTxKKwGD17rjKNJYVQ==",
2526 |       "dev": true,
2527 |       "license": "MIT",
2528 |       "engines": {
2529 |         "node": ">=4"
2530 |       }
2531 |     },
2532 |     "node_modules/decompress-tar/node_modules/tar-stream": {
2533 |       "version": "1.6.2",
2534 |       "resolved": "https://registry.npmjs.org/tar-stream/-/tar-stream-1.6.2.tgz",
2535 |       "integrity": "sha512-rzS0heiNf8Xn7/mpdSVVSMAWAoy9bfb1WOTYC78Z0UQKeKa/CWS8FOq0lKGNa8DWKAn9gxjCvMLYc5PGXYlK2A==",
2536 |       "dev": true,
2537 |       "license": "MIT",
2538 |       "dependencies": {
2539 |         "bl": "^1.0.0",
2540 |         "buffer-alloc": "^1.2.0",
2541 |         "end-of-stream": "^1.0.0",
2542 |         "fs-constants": "^1.0.0",
2543 |         "readable-stream": "^2.3.0",
2544 |         "to-buffer": "^1.1.1",
2545 |         "xtend": "^4.0.0"
2546 |       },
2547 |       "engines": {
2548 |         "node": ">= 0.8.0"
2549 |       }
2550 |     },
2551 |     "node_modules/decompress-tarbz2": {
2552 |       "version": "4.1.1",
2553 |       "resolved": "https://registry.npmjs.org/decompress-tarbz2/-/decompress-tarbz2-4.1.1.tgz",
2554 |       "integrity": "sha512-s88xLzf1r81ICXLAVQVzaN6ZmX4A6U4z2nMbOwobxkLoIIfjVMBg7TeguTUXkKeXni795B6y5rnvDw7rxhAq9A==",
2555 |       "dev": true,
2556 |       "license": "MIT",
2557 |       "dependencies": {
2558 |         "decompress-tar": "^4.1.0",
2559 |         "file-type": "^6.1.0",
2560 |         "is-stream": "^1.1.0",
2561 |         "seek-bzip": "^1.0.5",
2562 |         "unbzip2-stream": "^1.0.9"
2563 |       },
2564 |       "engines": {
2565 |         "node": ">=4"
2566 |       }
2567 |     },
2568 |     "node_modules/decompress-tarbz2/node_modules/file-type": {
2569 |       "version": "6.2.0",
2570 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-6.2.0.tgz",
2571 |       "integrity": "sha512-YPcTBDV+2Tm0VqjybVd32MHdlEGAtuxS3VAYsumFokDSMG+ROT5wawGlnHDoz7bfMcMDt9hxuXvXwoKUx2fkOg==",
2572 |       "dev": true,
2573 |       "license": "MIT",
2574 |       "engines": {
2575 |         "node": ">=4"
2576 |       }
2577 |     },
2578 |     "node_modules/decompress-targz": {
2579 |       "version": "4.1.1",
2580 |       "resolved": "https://registry.npmjs.org/decompress-targz/-/decompress-targz-4.1.1.tgz",
2581 |       "integrity": "sha512-4z81Znfr6chWnRDNfFNqLwPvm4db3WuZkqV+UgXQzSngG3CEKdBkw5jrv3axjjL96glyiiKjsxJG3X6WBZwX3w==",
2582 |       "dev": true,
2583 |       "license": "MIT",
2584 |       "dependencies": {
2585 |         "decompress-tar": "^4.1.1",
2586 |         "file-type": "^5.2.0",
2587 |         "is-stream": "^1.1.0"
2588 |       },
2589 |       "engines": {
2590 |         "node": ">=4"
2591 |       }
2592 |     },
2593 |     "node_modules/decompress-targz/node_modules/file-type": {
2594 |       "version": "5.2.0",
2595 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-5.2.0.tgz",
2596 |       "integrity": "sha512-Iq1nJ6D2+yIO4c8HHg4fyVb8mAJieo1Oloy1mLLaB2PvezNedhBVm+QU7g0qM42aiMbRXTxKKwGD17rjKNJYVQ==",
2597 |       "dev": true,
2598 |       "license": "MIT",
2599 |       "engines": {
2600 |         "node": ">=4"
2601 |       }
2602 |     },
2603 |     "node_modules/decompress-unzip": {
2604 |       "version": "4.0.1",
2605 |       "resolved": "https://registry.npmjs.org/decompress-unzip/-/decompress-unzip-4.0.1.tgz",
2606 |       "integrity": "sha512-1fqeluvxgnn86MOh66u8FjbtJpAFv5wgCT9Iw8rcBqQcCo5tO8eiJw7NNTrvt9n4CRBVq7CstiS922oPgyGLrw==",
2607 |       "dev": true,
2608 |       "license": "MIT",
2609 |       "dependencies": {
2610 |         "file-type": "^3.8.0",
2611 |         "get-stream": "^2.2.0",
2612 |         "pify": "^2.3.0",
2613 |         "yauzl": "^2.4.2"
2614 |       },
2615 |       "engines": {
2616 |         "node": ">=4"
2617 |       }
2618 |     },
2619 |     "node_modules/decompress-unzip/node_modules/file-type": {
2620 |       "version": "3.9.0",
2621 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-3.9.0.tgz",
2622 |       "integrity": "sha512-RLoqTXE8/vPmMuTI88DAzhMYC99I8BWv7zYP4A1puo5HIjEJ5EX48ighy4ZyKMG9EDXxBgW6e++cn7d1xuFghA==",
2623 |       "dev": true,
2624 |       "license": "MIT",
2625 |       "engines": {
2626 |         "node": ">=0.10.0"
2627 |       }
2628 |     },
2629 |     "node_modules/decompress-unzip/node_modules/get-stream": {
2630 |       "version": "2.3.1",
2631 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-2.3.1.tgz",
2632 |       "integrity": "sha512-AUGhbbemXxrZJRD5cDvKtQxLuYaIbNtDTK8YqupCI393Q2KSTreEsLUN3ZxAWFGiKTzL6nKuzfcIvieflUX9qA==",
2633 |       "dev": true,
2634 |       "license": "MIT",
2635 |       "dependencies": {
2636 |         "object-assign": "^4.0.1",
2637 |         "pinkie-promise": "^2.0.0"
2638 |       },
2639 |       "engines": {
2640 |         "node": ">=0.10.0"
2641 |       }
2642 |     },
2643 |     "node_modules/decompress-unzip/node_modules/pify": {
2644 |       "version": "2.3.0",
2645 |       "resolved": "https://registry.npmjs.org/pify/-/pify-2.3.0.tgz",
2646 |       "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
2647 |       "dev": true,
2648 |       "license": "MIT",
2649 |       "engines": {
2650 |         "node": ">=0.10.0"
2651 |       }
2652 |     },
2653 |     "node_modules/decompress/node_modules/make-dir": {
2654 |       "version": "1.3.0",
2655 |       "resolved": "https://registry.npmjs.org/make-dir/-/make-dir-1.3.0.tgz",
2656 |       "integrity": "sha512-2w31R7SJtieJJnQtGc7RVL2StM2vGYVfqUOvUDxH6bC6aJTxPxTF0GnIgCyu7tjockiUWAYQRbxa7vKn34s5sQ==",
2657 |       "dev": true,
2658 |       "license": "MIT",
2659 |       "dependencies": {
2660 |         "pify": "^3.0.0"
2661 |       },
2662 |       "engines": {
2663 |         "node": ">=4"
2664 |       }
2665 |     },
2666 |     "node_modules/decompress/node_modules/make-dir/node_modules/pify": {
2667 |       "version": "3.0.0",
2668 |       "resolved": "https://registry.npmjs.org/pify/-/pify-3.0.0.tgz",
2669 |       "integrity": "sha512-C3FsVNH1udSEX48gGX1xfvwTWfsYWj5U+8/uK15BGzIGrKoUpghX8hWZwa/OFnakBiiVNmBvemTJR5mcy7iPcg==",
2670 |       "dev": true,
2671 |       "license": "MIT",
2672 |       "engines": {
2673 |         "node": ">=4"
2674 |       }
2675 |     },
2676 |     "node_modules/decompress/node_modules/pify": {
2677 |       "version": "2.3.0",
2678 |       "resolved": "https://registry.npmjs.org/pify/-/pify-2.3.0.tgz",
2679 |       "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
2680 |       "dev": true,
2681 |       "license": "MIT",
2682 |       "engines": {
2683 |         "node": ">=0.10.0"
2684 |       }
2685 |     },
2686 |     "node_modules/deep-extend": {
2687 |       "version": "0.6.0",
2688 |       "resolved": "https://registry.npmjs.org/deep-extend/-/deep-extend-0.6.0.tgz",
2689 |       "integrity": "sha512-LOHxIOaPYdHlJRtCQfDIVZtfw/ufM8+rVj649RIHzcm/vGwQRXFt6OPqIFWsm2XEMrNIEtWR64sY1LEKD2vAOA==",
2690 |       "dev": true,
2691 |       "license": "MIT",
2692 |       "engines": {
2693 |         "node": ">=4.0.0"
2694 |       }
2695 |     },
2696 |     "node_modules/deepmerge": {
2697 |       "version": "4.3.1",
2698 |       "resolved": "https://registry.npmjs.org/deepmerge/-/deepmerge-4.3.1.tgz",
2699 |       "integrity": "sha512-3sUqbMEc77XqpdNO7FRyRog+eW3ph+GYCbj+rK+uYyRMuwsVy0rMiVtPn+QJlKFvWP/1PYpapqYn0Me2knFn+A==",
2700 |       "license": "MIT",
2701 |       "engines": {
2702 |         "node": ">=0.10.0"
2703 |       }
2704 |     },
2705 |     "node_modules/defaults": {
2706 |       "version": "1.0.4",
2707 |       "resolved": "https://registry.npmjs.org/defaults/-/defaults-1.0.4.tgz",
2708 |       "integrity": "sha512-eFuaLoy/Rxalv2kr+lqMlUnrDWV+3j4pljOIJgLIhI058IQfWJ7vXhyEIHu+HtC738klGALYxOKDO0bQP3tg8A==",
2709 |       "dev": true,
2710 |       "license": "MIT",
2711 |       "dependencies": {
2712 |         "clone": "^1.0.2"
2713 |       },
2714 |       "funding": {
2715 |         "url": "https://github.com/sponsors/sindresorhus"
2716 |       }
2717 |     },
2718 |     "node_modules/defer-to-connect": {
2719 |       "version": "2.0.1",
2720 |       "resolved": "https://registry.npmjs.org/defer-to-connect/-/defer-to-connect-2.0.1.tgz",
2721 |       "integrity": "sha512-4tvttepXG1VaYGrRibk5EwJd1t4udunSOVMdLSAL6mId1ix438oPwPZMALY41FCijukO1L0twNcGsdzS7dHgDg==",
2722 |       "dev": true,
2723 |       "license": "MIT",
2724 |       "engines": {
2725 |         "node": ">=10"
2726 |       }
2727 |     },
2728 |     "node_modules/define-data-property": {
2729 |       "version": "1.1.4",
2730 |       "resolved": "https://registry.npmjs.org/define-data-property/-/define-data-property-1.1.4.tgz",
2731 |       "integrity": "sha512-rBMvIzlpA8v6E+SJZoo++HAYqsLrkg7MSfIinMPFhmkorw7X+dOXVJQs+QT69zGkzMyfDnIMN2Wid1+NbL3T+A==",
2732 |       "dev": true,
2733 |       "license": "MIT",
2734 |       "dependencies": {
2735 |         "es-define-property": "^1.0.0",
2736 |         "es-errors": "^1.3.0",
2737 |         "gopd": "^1.0.1"
2738 |       },
2739 |       "engines": {
2740 |         "node": ">= 0.4"
2741 |       },
2742 |       "funding": {
2743 |         "url": "https://github.com/sponsors/ljharb"
2744 |       }
2745 |     },
2746 |     "node_modules/degenerator": {
2747 |       "version": "5.0.1",
2748 |       "resolved": "https://registry.npmjs.org/degenerator/-/degenerator-5.0.1.tgz",
2749 |       "integrity": "sha512-TllpMR/t0M5sqCXfj85i4XaAzxmS5tVA16dqvdkMwGmzI+dXLXnw3J+3Vdv7VKw+ThlTMboK6i9rnZ6Nntj5CQ==",
2750 |       "license": "MIT",
2751 |       "dependencies": {
2752 |         "ast-types": "^0.13.4",
2753 |         "escodegen": "^2.1.0",
2754 |         "esprima": "^4.0.1"
2755 |       },
2756 |       "engines": {
2757 |         "node": ">= 14"
2758 |       }
2759 |     },
2760 |     "node_modules/delayed-stream": {
2761 |       "version": "1.0.0",
2762 |       "resolved": "https://registry.npmjs.org/delayed-stream/-/delayed-stream-1.0.0.tgz",
2763 |       "integrity": "sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==",
2764 |       "license": "MIT",
2765 |       "engines": {
2766 |         "node": ">=0.4.0"
2767 |       }
2768 |     },
2769 |     "node_modules/detect-libc": {
2770 |       "version": "2.1.2",
2771 |       "resolved": "https://registry.npmjs.org/detect-libc/-/detect-libc-2.1.2.tgz",
2772 |       "integrity": "sha512-Btj2BOOO83o3WyH59e8MgXsxEQVcarkUOpEYrubB0urwnN10yQ364rsiByU11nZlqWYZm05i/of7io4mzihBtQ==",
2773 |       "dev": true,
2774 |       "license": "Apache-2.0",
2775 |       "engines": {
2776 |         "node": ">=8"
2777 |       }
2778 |     },
2779 |     "node_modules/devtools-protocol": {
2780 |       "version": "0.0.1521046",
2781 |       "resolved": "https://registry.npmjs.org/devtools-protocol/-/devtools-protocol-0.0.1521046.tgz",
2782 |       "integrity": "sha512-vhE6eymDQSKWUXwwA37NtTTVEzjtGVfDr3pRbsWEQ5onH/Snp2c+2xZHWJJawG/0hCCJLRGt4xVtEVUVILol4w==",
2783 |       "license": "BSD-3-Clause",
2784 |       "peer": true
2785 |     },
2786 |     "node_modules/dir-glob": {
2787 |       "version": "3.0.1",
2788 |       "resolved": "https://registry.npmjs.org/dir-glob/-/dir-glob-3.0.1.tgz",
2789 |       "integrity": "sha512-WkrWp9GR4KXfKGYzOLmTuGVi1UWFfws377n9cc55/tb6DuqyF6pcQ5AbiHEshaDpY9v6oaSr2XCDidGmMwdzIA==",
2790 |       "dev": true,
2791 |       "license": "MIT",
2792 |       "dependencies": {
2793 |         "path-type": "^4.0.0"
2794 |       },
2795 |       "engines": {
2796 |         "node": ">=8"
2797 |       }
2798 |     },
2799 |     "node_modules/dotenv": {
2800 |       "version": "17.2.3",
2801 |       "resolved": "https://registry.npmjs.org/dotenv/-/dotenv-17.2.3.tgz",
2802 |       "integrity": "sha512-JVUnt+DUIzu87TABbhPmNfVdBDt18BLOWjMUFJMSi/Qqg7NTYtabbvSNJGOJ7afbRuv9D/lngizHtP7QyLQ+9w==",
2803 |       "license": "BSD-2-Clause",
2804 |       "engines": {
2805 |         "node": ">=12"
2806 |       },
2807 |       "funding": {
2808 |         "url": "https://dotenvx.com"
2809 |       }
2810 |     },
2811 |     "node_modules/download": {
2812 |       "version": "8.0.0",
2813 |       "resolved": "https://registry.npmjs.org/download/-/download-8.0.0.tgz",
2814 |       "integrity": "sha512-ASRY5QhDk7FK+XrQtQyvhpDKanLluEEQtWl/J7Lxuf/b+i8RYh997QeXvL85xitrmRKVlx9c7eTrcRdq2GS4eA==",
2815 |       "dev": true,
2816 |       "license": "MIT",
2817 |       "dependencies": {
2818 |         "archive-type": "^4.0.0",
2819 |         "content-disposition": "^0.5.2",
2820 |         "decompress": "^4.2.1",
2821 |         "ext-name": "^5.0.0",
2822 |         "file-type": "^11.1.0",
2823 |         "filenamify": "^3.0.0",
2824 |         "get-stream": "^4.1.0",
2825 |         "got": "^8.3.1",
2826 |         "make-dir": "^2.1.0",
2827 |         "p-event": "^2.1.0",
2828 |         "pify": "^4.0.1"
2829 |       },
2830 |       "engines": {
2831 |         "node": ">=10"
2832 |       }
2833 |     },
2834 |     "node_modules/download/node_modules/@sindresorhus/is": {
2835 |       "version": "0.7.0",
2836 |       "resolved": "https://registry.npmjs.org/@sindresorhus/is/-/is-0.7.0.tgz",
2837 |       "integrity": "sha512-ONhaKPIufzzrlNbqtWFFd+jlnemX6lJAgq9ZeiZtS7I1PIf/la7CW4m83rTXRnVnsMbW2k56pGYu7AUFJD9Pow==",
2838 |       "dev": true,
2839 |       "license": "MIT",
2840 |       "engines": {
2841 |         "node": ">=4"
2842 |       }
2843 |     },
2844 |     "node_modules/download/node_modules/cacheable-request": {
2845 |       "version": "2.1.4",
2846 |       "resolved": "https://registry.npmjs.org/cacheable-request/-/cacheable-request-2.1.4.tgz",
2847 |       "integrity": "sha512-vag0O2LKZ/najSoUwDbVlnlCFvhBE/7mGTY2B5FgCBDcRD+oVV1HYTOwM6JZfMg/hIcM6IwnTZ1uQQL5/X3xIQ==",
2848 |       "dev": true,
2849 |       "license": "MIT",
2850 |       "dependencies": {
2851 |         "clone-response": "1.0.2",
2852 |         "get-stream": "3.0.0",
2853 |         "http-cache-semantics": "3.8.1",
2854 |         "keyv": "3.0.0",
2855 |         "lowercase-keys": "1.0.0",
2856 |         "normalize-url": "2.0.1",
2857 |         "responselike": "1.0.2"
2858 |       }
2859 |     },
2860 |     "node_modules/download/node_modules/cacheable-request/node_modules/get-stream": {
2861 |       "version": "3.0.0",
2862 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-3.0.0.tgz",
2863 |       "integrity": "sha512-GlhdIUuVakc8SJ6kK0zAFbiGzRFzNnY4jUuEbV9UROo4Y+0Ny4fjvcZFVTeDA4odpFyOQzaw6hXukJSq/f28sQ==",
2864 |       "dev": true,
2865 |       "license": "MIT",
2866 |       "engines": {
2867 |         "node": ">=4"
2868 |       }
2869 |     },
2870 |     "node_modules/download/node_modules/cacheable-request/node_modules/lowercase-keys": {
2871 |       "version": "1.0.0",
2872 |       "resolved": "https://registry.npmjs.org/lowercase-keys/-/lowercase-keys-1.0.0.tgz",
2873 |       "integrity": "sha512-RPlX0+PHuvxVDZ7xX+EBVAp4RsVxP/TdDSN2mJYdiq1Lc4Hz7EUSjUI7RZrKKlmrIzVhf6Jo2stj7++gVarS0A==",
2874 |       "dev": true,
2875 |       "license": "MIT",
2876 |       "engines": {
2877 |         "node": ">=0.10.0"
2878 |       }
2879 |     },
2880 |     "node_modules/download/node_modules/decompress-response": {
2881 |       "version": "3.3.0",
2882 |       "resolved": "https://registry.npmjs.org/decompress-response/-/decompress-response-3.3.0.tgz",
2883 |       "integrity": "sha512-BzRPQuY1ip+qDonAOz42gRm/pg9F768C+npV/4JOsxRC2sq+Rlk+Q4ZCAsOhnIaMrgarILY+RMUIvMmmX1qAEA==",
2884 |       "dev": true,
2885 |       "license": "MIT",
2886 |       "dependencies": {
2887 |         "mimic-response": "^1.0.0"
2888 |       },
2889 |       "engines": {
2890 |         "node": ">=4"
2891 |       }
2892 |     },
2893 |     "node_modules/download/node_modules/get-stream": {
2894 |       "version": "4.1.0",
2895 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-4.1.0.tgz",
2896 |       "integrity": "sha512-GMat4EJ5161kIy2HevLlr4luNjBgvmj413KaQA7jt4V8B4RDsfpHk7WQ9GVqfYyyx8OS/L66Kox+rJRNklLK7w==",
2897 |       "dev": true,
2898 |       "license": "MIT",
2899 |       "dependencies": {
2900 |         "pump": "^3.0.0"
2901 |       },
2902 |       "engines": {
2903 |         "node": ">=6"
2904 |       }
2905 |     },
2906 |     "node_modules/download/node_modules/got": {
2907 |       "version": "8.3.2",
2908 |       "resolved": "https://registry.npmjs.org/got/-/got-8.3.2.tgz",
2909 |       "integrity": "sha512-qjUJ5U/hawxosMryILofZCkm3C84PLJS/0grRIpjAwu+Lkxxj5cxeCU25BG0/3mDSpXKTyZr8oh8wIgLaH0QCw==",
2910 |       "dev": true,
2911 |       "license": "MIT",
2912 |       "dependencies": {
2913 |         "@sindresorhus/is": "^0.7.0",
2914 |         "cacheable-request": "^2.1.1",
2915 |         "decompress-response": "^3.3.0",
2916 |         "duplexer3": "^0.1.4",
2917 |         "get-stream": "^3.0.0",
2918 |         "into-stream": "^3.1.0",
2919 |         "is-retry-allowed": "^1.1.0",
2920 |         "isurl": "^1.0.0-alpha5",
2921 |         "lowercase-keys": "^1.0.0",
2922 |         "mimic-response": "^1.0.0",
2923 |         "p-cancelable": "^0.4.0",
2924 |         "p-timeout": "^2.0.1",
2925 |         "pify": "^3.0.0",
2926 |         "safe-buffer": "^5.1.1",
2927 |         "timed-out": "^4.0.1",
2928 |         "url-parse-lax": "^3.0.0",
2929 |         "url-to-options": "^1.0.1"
2930 |       },
2931 |       "engines": {
2932 |         "node": ">=4"
2933 |       }
2934 |     },
2935 |     "node_modules/download/node_modules/got/node_modules/get-stream": {
2936 |       "version": "3.0.0",
2937 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-3.0.0.tgz",
2938 |       "integrity": "sha512-GlhdIUuVakc8SJ6kK0zAFbiGzRFzNnY4jUuEbV9UROo4Y+0Ny4fjvcZFVTeDA4odpFyOQzaw6hXukJSq/f28sQ==",
2939 |       "dev": true,
2940 |       "license": "MIT",
2941 |       "engines": {
2942 |         "node": ">=4"
2943 |       }
2944 |     },
2945 |     "node_modules/download/node_modules/got/node_modules/pify": {
2946 |       "version": "3.0.0",
2947 |       "resolved": "https://registry.npmjs.org/pify/-/pify-3.0.0.tgz",
2948 |       "integrity": "sha512-C3FsVNH1udSEX48gGX1xfvwTWfsYWj5U+8/uK15BGzIGrKoUpghX8hWZwa/OFnakBiiVNmBvemTJR5mcy7iPcg==",
2949 |       "dev": true,
2950 |       "license": "MIT",
2951 |       "engines": {
2952 |         "node": ">=4"
2953 |       }
2954 |     },
2955 |     "node_modules/download/node_modules/http-cache-semantics": {
2956 |       "version": "3.8.1",
2957 |       "resolved": "https://registry.npmjs.org/http-cache-semantics/-/http-cache-semantics-3.8.1.tgz",
2958 |       "integrity": "sha512-5ai2iksyV8ZXmnZhHH4rWPoxxistEexSi5936zIQ1bnNTW5VnA85B6P/VpXiRM017IgRvb2kKo1a//y+0wSp3w==",
2959 |       "dev": true,
2960 |       "license": "BSD-2-Clause"
2961 |     },
2962 |     "node_modules/download/node_modules/into-stream": {
2963 |       "version": "3.1.0",
2964 |       "resolved": "https://registry.npmjs.org/into-stream/-/into-stream-3.1.0.tgz",
2965 |       "integrity": "sha512-TcdjPibTksa1NQximqep2r17ISRiNE9fwlfbg3F8ANdvP5/yrFTew86VcO//jk4QTaMlbjypPBq76HN2zaKfZQ==",
2966 |       "dev": true,
2967 |       "license": "MIT",
2968 |       "dependencies": {
2969 |         "from2": "^2.1.1",
2970 |         "p-is-promise": "^1.1.0"
2971 |       },
2972 |       "engines": {
2973 |         "node": ">=4"
2974 |       }
2975 |     },
2976 |     "node_modules/download/node_modules/json-buffer": {
2977 |       "version": "3.0.0",
2978 |       "resolved": "https://registry.npmjs.org/json-buffer/-/json-buffer-3.0.0.tgz",
2979 |       "integrity": "sha512-CuUqjv0FUZIdXkHPI8MezCnFCdaTAacej1TZYulLoAg1h/PhwkdXFN4V/gzY4g+fMBCOV2xF+rp7t2XD2ns/NQ==",
2980 |       "dev": true,
2981 |       "license": "MIT"
2982 |     },
2983 |     "node_modules/download/node_modules/keyv": {
2984 |       "version": "3.0.0",
2985 |       "resolved": "https://registry.npmjs.org/keyv/-/keyv-3.0.0.tgz",
2986 |       "integrity": "sha512-eguHnq22OE3uVoSYG0LVWNP+4ppamWr9+zWBe1bsNcovIMy6huUJFPgy4mGwCd/rnl3vOLGW1MTlu4c57CT1xA==",
2987 |       "dev": true,
2988 |       "license": "MIT",
2989 |       "dependencies": {
2990 |         "json-buffer": "3.0.0"
2991 |       }
2992 |     },
2993 |     "node_modules/download/node_modules/lowercase-keys": {
2994 |       "version": "1.0.1",
2995 |       "resolved": "https://registry.npmjs.org/lowercase-keys/-/lowercase-keys-1.0.1.tgz",
2996 |       "integrity": "sha512-G2Lj61tXDnVFFOi8VZds+SoQjtQC3dgokKdDG2mTm1tx4m50NUHBOZSBwQQHyy0V12A0JTG4icfZQH+xPyh8VA==",
2997 |       "dev": true,
2998 |       "license": "MIT",
2999 |       "engines": {
3000 |         "node": ">=0.10.0"
3001 |       }
3002 |     },
3003 |     "node_modules/download/node_modules/mimic-response": {
3004 |       "version": "1.0.1",
3005 |       "resolved": "https://registry.npmjs.org/mimic-response/-/mimic-response-1.0.1.tgz",
3006 |       "integrity": "sha512-j5EctnkH7amfV/q5Hgmoal1g2QHFJRraOtmx0JpIqkxhBhI/lJSl1nMpQ45hVarwNETOoWEimndZ4QK0RHxuxQ==",
3007 |       "dev": true,
3008 |       "license": "MIT",
3009 |       "engines": {
3010 |         "node": ">=4"
3011 |       }
3012 |     },
3013 |     "node_modules/download/node_modules/normalize-url": {
3014 |       "version": "2.0.1",
3015 |       "resolved": "https://registry.npmjs.org/normalize-url/-/normalize-url-2.0.1.tgz",
3016 |       "integrity": "sha512-D6MUW4K/VzoJ4rJ01JFKxDrtY1v9wrgzCX5f2qj/lzH1m/lW6MhUZFKerVsnyjOhOsYzI9Kqqak+10l4LvLpMw==",
3017 |       "dev": true,
3018 |       "license": "MIT",
3019 |       "dependencies": {
3020 |         "prepend-http": "^2.0.0",
3021 |         "query-string": "^5.0.1",
3022 |         "sort-keys": "^2.0.0"
3023 |       },
3024 |       "engines": {
3025 |         "node": ">=4"
3026 |       }
3027 |     },
3028 |     "node_modules/download/node_modules/p-cancelable": {
3029 |       "version": "0.4.1",
3030 |       "resolved": "https://registry.npmjs.org/p-cancelable/-/p-cancelable-0.4.1.tgz",
3031 |       "integrity": "sha512-HNa1A8LvB1kie7cERyy21VNeHb2CWJJYqyyC2o3klWFfMGlFmWv2Z7sFgZH8ZiaYL95ydToKTFVXgMV/Os0bBQ==",
3032 |       "dev": true,
3033 |       "license": "MIT",
3034 |       "engines": {
3035 |         "node": ">=4"
3036 |       }
3037 |     },
3038 |     "node_modules/download/node_modules/p-is-promise": {
3039 |       "version": "1.1.0",
3040 |       "resolved": "https://registry.npmjs.org/p-is-promise/-/p-is-promise-1.1.0.tgz",
3041 |       "integrity": "sha512-zL7VE4JVS2IFSkR2GQKDSPEVxkoH43/p7oEnwpdCndKYJO0HVeRB7fA8TJwuLOTBREtK0ea8eHaxdwcpob5dmg==",
3042 |       "dev": true,
3043 |       "license": "MIT",
3044 |       "engines": {
3045 |         "node": ">=4"
3046 |       }
3047 |     },
3048 |     "node_modules/download/node_modules/responselike": {
3049 |       "version": "1.0.2",
3050 |       "resolved": "https://registry.npmjs.org/responselike/-/responselike-1.0.2.tgz",
3051 |       "integrity": "sha512-/Fpe5guzJk1gPqdJLJR5u7eG/gNY4nImjbRDaVWVMRhne55TCmj2i9Q+54PBRfatRC8v/rIiv9BN0pMd9OV5EQ==",
3052 |       "dev": true,
3053 |       "license": "MIT",
3054 |       "dependencies": {
3055 |         "lowercase-keys": "^1.0.0"
3056 |       }
3057 |     },
3058 |     "node_modules/download/node_modules/sort-keys": {
3059 |       "version": "2.0.0",
3060 |       "resolved": "https://registry.npmjs.org/sort-keys/-/sort-keys-2.0.0.tgz",
3061 |       "integrity": "sha512-/dPCrG1s3ePpWm6yBbxZq5Be1dXGLyLn9Z791chDC3NFrpkVbWGzkBwPN1knaciexFXgRJ7hzdnwZ4stHSDmjg==",
3062 |       "dev": true,
3063 |       "license": "MIT",
3064 |       "dependencies": {
3065 |         "is-plain-obj": "^1.0.0"
3066 |       },
3067 |       "engines": {
3068 |         "node": ">=4"
3069 |       }
3070 |     },
3071 |     "node_modules/dunder-proto": {
3072 |       "version": "1.0.1",
3073 |       "resolved": "https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz",
3074 |       "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
3075 |       "license": "MIT",
3076 |       "dependencies": {
3077 |         "call-bind-apply-helpers": "^1.0.1",
3078 |         "es-errors": "^1.3.0",
3079 |         "gopd": "^1.2.0"
3080 |       },
3081 |       "engines": {
3082 |         "node": ">= 0.4"
3083 |       }
3084 |     },
3085 |     "node_modules/duplexer2": {
3086 |       "version": "0.1.4",
3087 |       "resolved": "https://registry.npmjs.org/duplexer2/-/duplexer2-0.1.4.tgz",
3088 |       "integrity": "sha512-asLFVfWWtJ90ZyOUHMqk7/S2w2guQKxUI2itj3d92ADHhxUSbCMGi1f1cBcJ7xM1To+pE/Khbwo1yuNbMEPKeA==",
3089 |       "dev": true,
3090 |       "license": "BSD-3-Clause",
3091 |       "dependencies": {
3092 |         "readable-stream": "^2.0.2"
3093 |       }
3094 |     },
3095 |     "node_modules/duplexer3": {
3096 |       "version": "0.1.5",
3097 |       "resolved": "https://registry.npmjs.org/duplexer3/-/duplexer3-0.1.5.tgz",
3098 |       "integrity": "sha512-1A8za6ws41LQgv9HrE/66jyC5yuSjQ3L/KOpFtoBilsAK2iA2wuS5rTt1OCzIvtS2V7nVmedsUU+DGRcjBmOYA==",
3099 |       "dev": true,
3100 |       "license": "BSD-3-Clause"
3101 |     },
3102 |     "node_modules/electron-to-chromium": {
3103 |       "version": "1.5.267",
3104 |       "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.267.tgz",
3105 |       "integrity": "sha512-0Drusm6MVRXSOJpGbaSVgcQsuB4hEkMpHXaVstcPmhu5LIedxs1xNK/nIxmQIU/RPC0+1/o0AVZfBTkTNJOdUw==",
3106 |       "dev": true,
3107 |       "license": "ISC"
3108 |     },
3109 |     "node_modules/emoji-regex": {
3110 |       "version": "8.0.0",
3111 |       "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
3112 |       "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
3113 |       "license": "MIT"
3114 |     },
3115 |     "node_modules/end-of-stream": {
3116 |       "version": "1.4.5",
3117 |       "resolved": "https://registry.npmjs.org/end-of-stream/-/end-of-stream-1.4.5.tgz",
3118 |       "integrity": "sha512-ooEGc6HP26xXq/N+GCGOT0JKCLDGrq2bQUZrQ7gyrJiZANJ/8YDTxTpQBXGMn+WbIQXNVpyWymm7KYVICQnyOg==",
3119 |       "license": "MIT",
3120 |       "dependencies": {
3121 |         "once": "^1.4.0"
3122 |       }
3123 |     },
3124 |     "node_modules/enhanced-resolve": {
3125 |       "version": "5.18.4",
3126 |       "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.18.4.tgz",
3127 |       "integrity": "sha512-LgQMM4WXU3QI+SYgEc2liRgznaD5ojbmY3sb8LxyguVkIg5FxdpTkvk72te2R38/TGKxH634oLxXRGY6d7AP+Q==",
3128 |       "dev": true,
3129 |       "license": "MIT",
3130 |       "dependencies": {
3131 |         "graceful-fs": "^4.2.4",
3132 |         "tapable": "^2.2.0"
3133 |       },
3134 |       "engines": {
3135 |         "node": ">=10.13.0"
3136 |       }
3137 |     },
3138 |     "node_modules/env-paths": {
3139 |       "version": "2.2.1",
3140 |       "resolved": "https://registry.npmjs.org/env-paths/-/env-paths-2.2.1.tgz",
3141 |       "integrity": "sha512-+h1lkLKhZMTYjog1VEpJNG7NZJWcuc2DDk/qsqSTRRCOXiLjeQ1d1/udrUGhqMxUgAlwKNZ0cf2uqan5GLuS2A==",
3142 |       "license": "MIT",
3143 |       "engines": {
3144 |         "node": ">=6"
3145 |       }
3146 |     },
3147 |     "node_modules/envinfo": {
3148 |       "version": "7.21.0",
3149 |       "resolved": "https://registry.npmjs.org/envinfo/-/envinfo-7.21.0.tgz",
3150 |       "integrity": "sha512-Lw7I8Zp5YKHFCXL7+Dz95g4CcbMEpgvqZNNq3AmlT5XAV6CgAAk6gyAMqn2zjw08K9BHfcNuKrMiCPLByGafow==",
3151 |       "dev": true,
3152 |       "license": "MIT",
3153 |       "bin": {
3154 |         "envinfo": "dist/cli.js"
3155 |       },
3156 |       "engines": {
3157 |         "node": ">=4"
3158 |       }
3159 |     },
3160 |     "node_modules/error-ex": {
3161 |       "version": "1.3.4",
3162 |       "resolved": "https://registry.npmjs.org/error-ex/-/error-ex-1.3.4.tgz",
3163 |       "integrity": "sha512-sqQamAnR14VgCr1A618A3sGrygcpK+HEbenA/HiEAkkUwcZIIB/tgWqHFxWgOyDh4nB4JCRimh79dR5Ywc9MDQ==",
3164 |       "license": "MIT",
3165 |       "dependencies": {
3166 |         "is-arrayish": "^0.2.1"
3167 |       }
3168 |     },
3169 |     "node_modules/es-define-property": {
3170 |       "version": "1.0.1",
3171 |       "resolved": "https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz",
3172 |       "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
3173 |       "license": "MIT",
3174 |       "engines": {
3175 |         "node": ">= 0.4"
3176 |       }
3177 |     },
3178 |     "node_modules/es-errors": {
3179 |       "version": "1.3.0",
3180 |       "resolved": "https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz",
3181 |       "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
3182 |       "license": "MIT",
3183 |       "engines": {
3184 |         "node": ">= 0.4"
3185 |       }
3186 |     },
3187 |     "node_modules/es-module-lexer": {
3188 |       "version": "2.0.0",
3189 |       "resolved": "https://registry.npmjs.org/es-module-lexer/-/es-module-lexer-2.0.0.tgz",
3190 |       "integrity": "sha512-5POEcUuZybH7IdmGsD8wlf0AI55wMecM9rVBTI/qEAy2c1kTOm3DjFYjrBdI2K3BaJjJYfYFeRtM0t9ssnRuxw==",
3191 |       "dev": true,
3192 |       "license": "MIT"
3193 |     },
3194 |     "node_modules/es-object-atoms": {
3195 |       "version": "1.1.1",
3196 |       "resolved": "https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
3197 |       "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
3198 |       "license": "MIT",
3199 |       "dependencies": {
3200 |         "es-errors": "^1.3.0"
3201 |       },
3202 |       "engines": {
3203 |         "node": ">= 0.4"
3204 |       }
3205 |     },
3206 |     "node_modules/es-set-tostringtag": {
3207 |       "version": "2.1.0",
3208 |       "resolved": "https://registry.npmjs.org/es-set-tostringtag/-/es-set-tostringtag-2.1.0.tgz",
3209 |       "integrity": "sha512-j6vWzfrGVfyXxge+O0x5sh6cvxAog0a/4Rdd2K36zCMV5eJ+/+tOAngRO8cODMNWbVRdVlmGZQL2YS3yR8bIUA==",
3210 |       "license": "MIT",
3211 |       "dependencies": {
3212 |         "es-errors": "^1.3.0",
3213 |         "get-intrinsic": "^1.2.6",
3214 |         "has-tostringtag": "^1.0.2",
3215 |         "hasown": "^2.0.2"
3216 |       },
3217 |       "engines": {
3218 |         "node": ">= 0.4"
3219 |       }
3220 |     },
3221 |     "node_modules/esbuild": {
3222 |       "version": "0.27.2",
3223 |       "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.27.2.tgz",
3224 |       "integrity": "sha512-HyNQImnsOC7X9PMNaCIeAm4ISCQXs5a5YasTXVliKv4uuBo1dKrG0A+uQS8M5eXjVMnLg3WgXaKvprHlFJQffw==",
3225 |       "dev": true,
3226 |       "hasInstallScript": true,
3227 |       "license": "MIT",
3228 |       "bin": {
3229 |         "esbuild": "bin/esbuild"
3230 |       },
3231 |       "engines": {
3232 |         "node": ">=18"
3233 |       },
3234 |       "optionalDependencies": {
3235 |         "@esbuild/aix-ppc64": "0.27.2",
3236 |         "@esbuild/android-arm": "0.27.2",
3237 |         "@esbuild/android-arm64": "0.27.2",
3238 |         "@esbuild/android-x64": "0.27.2",
3239 |         "@esbuild/darwin-arm64": "0.27.2",
3240 |         "@esbuild/darwin-x64": "0.27.2",
3241 |         "@esbuild/freebsd-arm64": "0.27.2",
3242 |         "@esbuild/freebsd-x64": "0.27.2",
3243 |         "@esbuild/linux-arm": "0.27.2",
3244 |         "@esbuild/linux-arm64": "0.27.2",
3245 |         "@esbuild/linux-ia32": "0.27.2",
3246 |         "@esbuild/linux-loong64": "0.27.2",
3247 |         "@esbuild/linux-mips64el": "0.27.2",
3248 |         "@esbuild/linux-ppc64": "0.27.2",
3249 |         "@esbuild/linux-riscv64": "0.27.2",
3250 |         "@esbuild/linux-s390x": "0.27.2",
3251 |         "@esbuild/linux-x64": "0.27.2",
3252 |         "@esbuild/netbsd-arm64": "0.27.2",
3253 |         "@esbuild/netbsd-x64": "0.27.2",
3254 |         "@esbuild/openbsd-arm64": "0.27.2",
3255 |         "@esbuild/openbsd-x64": "0.27.2",
3256 |         "@esbuild/openharmony-arm64": "0.27.2",
3257 |         "@esbuild/sunos-x64": "0.27.2",
3258 |         "@esbuild/win32-arm64": "0.27.2",
3259 |         "@esbuild/win32-ia32": "0.27.2",
3260 |         "@esbuild/win32-x64": "0.27.2"
3261 |       }
3262 |     },
3263 |     "node_modules/escalade": {
3264 |       "version": "3.2.0",
3265 |       "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
3266 |       "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
3267 |       "license": "MIT",
3268 |       "engines": {
3269 |         "node": ">=6"
3270 |       }
3271 |     },
3272 |     "node_modules/escape-string-regexp": {
3273 |       "version": "1.0.5",
3274 |       "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-1.0.5.tgz",
3275 |       "integrity": "sha512-vbRorB5FUQWvla16U8R/qgaFIya2qGzwDrNmCZuYKrbdSUMG6I1ZCGQRefkRVhuOkIGVne7BQ35DSfo1qvJqFg==",
3276 |       "dev": true,
3277 |       "license": "MIT",
3278 |       "engines": {
3279 |         "node": ">=0.8.0"
3280 |       }
3281 |     },
3282 |     "node_modules/escodegen": {
3283 |       "version": "2.1.0",
3284 |       "resolved": "https://registry.npmjs.org/escodegen/-/escodegen-2.1.0.tgz",
3285 |       "integrity": "sha512-2NlIDTwUWJN0mRPQOdtQBzbUHvdGY2P1VXSyU83Q3xKxM7WHX2Ql8dKq782Q9TgQUNOLEzEYu9bzLNj1q88I5w==",
3286 |       "license": "BSD-2-Clause",
3287 |       "dependencies": {
3288 |         "esprima": "^4.0.1",
3289 |         "estraverse": "^5.2.0",
3290 |         "esutils": "^2.0.2"
3291 |       },
3292 |       "bin": {
3293 |         "escodegen": "bin/escodegen.js",
3294 |         "esgenerate": "bin/esgenerate.js"
3295 |       },
3296 |       "engines": {
3297 |         "node": ">=6.0"
3298 |       },
3299 |       "optionalDependencies": {
3300 |         "source-map": "~0.6.1"
3301 |       }
3302 |     },
3303 |     "node_modules/eslint-scope": {
3304 |       "version": "5.1.1",
3305 |       "resolved": "https://registry.npmjs.org/eslint-scope/-/eslint-scope-5.1.1.tgz",
3306 |       "integrity": "sha512-2NxwbF/hZ0KpepYN0cNbo+FN6XoK7GaHlQhgx/hIZl6Va0bF45RQOOwhLIy8lQDbuCiadSLCBnH2CFYquit5bw==",
3307 |       "dev": true,
3308 |       "license": "BSD-2-Clause",
3309 |       "dependencies": {
3310 |         "esrecurse": "^4.3.0",
3311 |         "estraverse": "^4.1.1"
3312 |       },
3313 |       "engines": {
3314 |         "node": ">=8.0.0"
3315 |       }
3316 |     },
3317 |     "node_modules/eslint-scope/node_modules/estraverse": {
3318 |       "version": "4.3.0",
3319 |       "resolved": "https://registry.npmjs.org/estraverse/-/estraverse-4.3.0.tgz",
3320 |       "integrity": "sha512-39nnKffWz8xN1BU/2c79n9nB9HDzo0niYUqx6xyqUnyoAnQyyWpOTdZEeiCch8BBu515t4wp9ZmgVfVhn9EBpw==",
3321 |       "dev": true,
3322 |       "license": "BSD-2-Clause",
3323 |       "engines": {
3324 |         "node": ">=4.0"
3325 |       }
3326 |     },
3327 |     "node_modules/esprima": {
3328 |       "version": "4.0.1",
3329 |       "resolved": "https://registry.npmjs.org/esprima/-/esprima-4.0.1.tgz",
3330 |       "integrity": "sha512-eGuFFw7Upda+g4p+QHvnW0RyTX/SVeJBDM/gCtMARO0cLuT2HcEKnTPvhjV6aGeqrCB/sbNop0Kszm0jsaWU4A==",
3331 |       "license": "BSD-2-Clause",
3332 |       "bin": {
3333 |         "esparse": "bin/esparse.js",
3334 |         "esvalidate": "bin/esvalidate.js"
3335 |       },
3336 |       "engines": {
3337 |         "node": ">=4"
3338 |       }
3339 |     },
3340 |     "node_modules/esrecurse": {
3341 |       "version": "4.3.0",
3342 |       "resolved": "https://registry.npmjs.org/esrecurse/-/esrecurse-4.3.0.tgz",
3343 |       "integrity": "sha512-KmfKL3b6G+RXvP8N1vr3Tq1kL/oCFgn2NYXEtqP8/L3pKapUA4G8cFVaoF3SU323CD4XypR/ffioHmkti6/Tag==",
3344 |       "dev": true,
3345 |       "license": "BSD-2-Clause",
3346 |       "dependencies": {
3347 |         "estraverse": "^5.2.0"
3348 |       },
3349 |       "engines": {
3350 |         "node": ">=4.0"
3351 |       }
3352 |     },
3353 |     "node_modules/estraverse": {
3354 |       "version": "5.3.0",
3355 |       "resolved": "https://registry.npmjs.org/estraverse/-/estraverse-5.3.0.tgz",
3356 |       "integrity": "sha512-MMdARuVEQziNTeJD8DgMqmhwR11BRQ/cBP+pLtYdSTnf3MIO8fFeiINEbX36ZdNlfU/7A9f3gUw49B3oQsvwBA==",
3357 |       "license": "BSD-2-Clause",
3358 |       "engines": {
3359 |         "node": ">=4.0"
3360 |       }
3361 |     },
3362 |     "node_modules/esutils": {
3363 |       "version": "2.0.3",
3364 |       "resolved": "https://registry.npmjs.org/esutils/-/esutils-2.0.3.tgz",
3365 |       "integrity": "sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==",
3366 |       "license": "BSD-2-Clause",
3367 |       "engines": {
3368 |         "node": ">=0.10.0"
3369 |       }
3370 |     },
3371 |     "node_modules/events": {
3372 |       "version": "3.3.0",
3373 |       "resolved": "https://registry.npmjs.org/events/-/events-3.3.0.tgz",
3374 |       "integrity": "sha512-mQw+2fkQbALzQ7V0MY0IqdnXNOeTtP4r0lN9z7AAawCXgqea7bDii20AYrIBrFd/Hx0M2Ocz6S111CaFkUcb0Q==",
3375 |       "dev": true,
3376 |       "license": "MIT",
3377 |       "engines": {
3378 |         "node": ">=0.8.x"
3379 |       }
3380 |     },
3381 |     "node_modules/events-universal": {
3382 |       "version": "1.0.1",
3383 |       "resolved": "https://registry.npmjs.org/events-universal/-/events-universal-1.0.1.tgz",
3384 |       "integrity": "sha512-LUd5euvbMLpwOF8m6ivPCbhQeSiYVNb8Vs0fQ8QjXo0JTkEHpz8pxdQf0gStltaPpw0Cca8b39KxvK9cfKRiAw==",
3385 |       "license": "Apache-2.0",
3386 |       "dependencies": {
3387 |         "bare-events": "^2.7.0"
3388 |       }
3389 |     },
3390 |     "node_modules/expand-template": {
3391 |       "version": "2.0.3",
3392 |       "resolved": "https://registry.npmjs.org/expand-template/-/expand-template-2.0.3.tgz",
3393 |       "integrity": "sha512-XYfuKMvj4O35f/pOXLObndIRvyQ+/+6AhODh+OKWj9S9498pHHn/IMszH+gt0fBCRWMNfk1ZSp5x3AifmnI2vg==",
3394 |       "dev": true,
3395 |       "license": "(MIT OR WTFPL)",
3396 |       "engines": {
3397 |         "node": ">=6"
3398 |       }
3399 |     },
3400 |     "node_modules/ext-list": {
3401 |       "version": "2.2.2",
3402 |       "resolved": "https://registry.npmjs.org/ext-list/-/ext-list-2.2.2.tgz",
3403 |       "integrity": "sha512-u+SQgsubraE6zItfVA0tBuCBhfU9ogSRnsvygI7wht9TS510oLkBRXBsqopeUG/GBOIQyKZO9wjTqIu/sf5zFA==",
3404 |       "dev": true,
3405 |       "license": "MIT",
3406 |       "dependencies": {
3407 |         "mime-db": "^1.28.0"
3408 |       },
3409 |       "engines": {
3410 |         "node": ">=0.10.0"
3411 |       }
3412 |     },
3413 |     "node_modules/ext-name": {
3414 |       "version": "5.0.0",
3415 |       "resolved": "https://registry.npmjs.org/ext-name/-/ext-name-5.0.0.tgz",
3416 |       "integrity": "sha512-yblEwXAbGv1VQDmow7s38W77hzAgJAO50ztBLMcUyUBfxv1HC+LGwtiEN+Co6LtlqT/5uwVOxsD4TNIilWhwdQ==",
3417 |       "dev": true,
3418 |       "license": "MIT",
3419 |       "dependencies": {
3420 |         "ext-list": "^2.0.0",
3421 |         "sort-keys-length": "^1.0.0"
3422 |       },
3423 |       "engines": {
3424 |         "node": ">=4"
3425 |       }
3426 |     },
3427 |     "node_modules/extract-zip": {
3428 |       "version": "2.0.1",
3429 |       "resolved": "https://registry.npmjs.org/extract-zip/-/extract-zip-2.0.1.tgz",
3430 |       "integrity": "sha512-GDhU9ntwuKyGXdZBUgTIe+vXnWj0fppUEtMDL0+idd5Sta8TGpHssn/eusA9mrPr9qNDym6SxAYZjNvCn/9RBg==",
3431 |       "license": "BSD-2-Clause",
3432 |       "dependencies": {
3433 |         "debug": "^4.1.1",
3434 |         "get-stream": "^5.1.0",
3435 |         "yauzl": "^2.10.0"
3436 |       },
3437 |       "bin": {
3438 |         "extract-zip": "cli.js"
3439 |       },
3440 |       "engines": {
3441 |         "node": ">= 10.17.0"
3442 |       },
3443 |       "optionalDependencies": {
3444 |         "@types/yauzl": "^2.9.1"
3445 |       }
3446 |     },
3447 |     "node_modules/fast-deep-equal": {
3448 |       "version": "3.1.3",
3449 |       "resolved": "https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz",
3450 |       "integrity": "sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==",
3451 |       "dev": true,
3452 |       "license": "MIT"
3453 |     },
3454 |     "node_modules/fast-fifo": {
3455 |       "version": "1.3.2",
3456 |       "resolved": "https://registry.npmjs.org/fast-fifo/-/fast-fifo-1.3.2.tgz",
3457 |       "integrity": "sha512-/d9sfos4yxzpwkDkuN7k2SqFKtYNmCTzgfEpz82x34IM9/zc8KGxQoXg1liNC/izpRM/MBdt44Nmx41ZWqk+FQ==",
3458 |       "license": "MIT"
3459 |     },
3460 |     "node_modules/fast-glob": {
3461 |       "version": "3.3.3",
3462 |       "resolved": "https://registry.npmjs.org/fast-glob/-/fast-glob-3.3.3.tgz",
3463 |       "integrity": "sha512-7MptL8U0cqcFdzIzwOTHoilX9x5BrNqye7Z/LuC7kCMRio1EMSyqRK3BEAUD7sXRq4iT4AzTVuZdhgQ2TCvYLg==",
3464 |       "dev": true,
3465 |       "license": "MIT",
3466 |       "dependencies": {
3467 |         "@nodelib/fs.stat": "^2.0.2",
3468 |         "@nodelib/fs.walk": "^1.2.3",
3469 |         "glob-parent": "^5.1.2",
3470 |         "merge2": "^1.3.0",
3471 |         "micromatch": "^4.0.8"
3472 |       },
3473 |       "engines": {
3474 |         "node": ">=8.6.0"
3475 |       }
3476 |     },
3477 |     "node_modules/fast-uri": {
3478 |       "version": "3.1.0",
3479 |       "resolved": "https://registry.npmjs.org/fast-uri/-/fast-uri-3.1.0.tgz",
3480 |       "integrity": "sha512-iPeeDKJSWf4IEOasVVrknXpaBV0IApz/gp7S2bb7Z4Lljbl2MGJRqInZiUrQwV16cpzw/D3S5j5Julj/gT52AA==",
3481 |       "dev": true,
3482 |       "funding": [
3483 |         {
3484 |           "type": "github",
3485 |           "url": "https://github.com/sponsors/fastify"
3486 |         },
3487 |         {
3488 |           "type": "opencollective",
3489 |           "url": "https://opencollective.com/fastify"
3490 |         }
3491 |       ],
3492 |       "license": "BSD-3-Clause"
3493 |     },
3494 |     "node_modules/fastest-levenshtein": {
3495 |       "version": "1.0.16",
3496 |       "resolved": "https://registry.npmjs.org/fastest-levenshtein/-/fastest-levenshtein-1.0.16.tgz",
3497 |       "integrity": "sha512-eRnCtTTtGZFpQCwhJiUOuxPQWRXVKYDn0b2PeHfXL6/Zi53SLAzAHfVhVWK2AryC/WH05kGfxhFIPvTF0SXQzg==",
3498 |       "dev": true,
3499 |       "license": "MIT",
3500 |       "engines": {
3501 |         "node": ">= 4.9.1"
3502 |       }
3503 |     },
3504 |     "node_modules/fastq": {
3505 |       "version": "1.20.1",
3506 |       "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.20.1.tgz",
3507 |       "integrity": "sha512-GGToxJ/w1x32s/D2EKND7kTil4n8OVk/9mycTc4VDza13lOvpUZTGX3mFSCtV9ksdGBVzvsyAVLM6mHFThxXxw==",
3508 |       "dev": true,
3509 |       "license": "ISC",
3510 |       "dependencies": {
3511 |         "reusify": "^1.0.4"
3512 |       }
3513 |     },
3514 |     "node_modules/fd-slicer": {
3515 |       "version": "1.1.0",
3516 |       "resolved": "https://registry.npmjs.org/fd-slicer/-/fd-slicer-1.1.0.tgz",
3517 |       "integrity": "sha512-cE1qsB/VwyQozZ+q1dGxR8LBYNZeofhEdUNGSMbQD3Gw2lAzX9Zb3uIU6Ebc/Fmyjo9AWWfnn0AUCHqtevs/8g==",
3518 |       "license": "MIT",
3519 |       "dependencies": {
3520 |         "pend": "~1.2.0"
3521 |       }
3522 |     },
3523 |     "node_modules/file-type": {
3524 |       "version": "11.1.0",
3525 |       "resolved": "https://registry.npmjs.org/file-type/-/file-type-11.1.0.tgz",
3526 |       "integrity": "sha512-rM0UO7Qm9K7TWTtA6AShI/t7H5BPjDeGVDaNyg9BjHAj3PysKy7+8C8D137R88jnR3rFJZQB/tFgydl5sN5m7g==",
3527 |       "dev": true,
3528 |       "license": "MIT",
3529 |       "engines": {
3530 |         "node": ">=6"
3531 |       }
3532 |     },
3533 |     "node_modules/filename-reserved-regex": {
3534 |       "version": "2.0.0",
3535 |       "resolved": "https://registry.npmjs.org/filename-reserved-regex/-/filename-reserved-regex-2.0.0.tgz",
3536 |       "integrity": "sha512-lc1bnsSr4L4Bdif8Xb/qrtokGbq5zlsms/CYH8PP+WtCkGNF65DPiQY8vG3SakEdRn8Dlnm+gW/qWKKjS5sZzQ==",
3537 |       "dev": true,
3538 |       "license": "MIT",
3539 |       "engines": {
3540 |         "node": ">=4"
3541 |       }
3542 |     },
3543 |     "node_modules/filenamify": {
3544 |       "version": "3.0.0",
3545 |       "resolved": "https://registry.npmjs.org/filenamify/-/filenamify-3.0.0.tgz",
3546 |       "integrity": "sha512-5EFZ//MsvJgXjBAFJ+Bh2YaCTRF/VP1YOmGrgt+KJ4SFRLjI87EIdwLLuT6wQX0I4F9W41xutobzczjsOKlI/g==",
3547 |       "dev": true,
3548 |       "license": "MIT",
3549 |       "dependencies": {
3550 |         "filename-reserved-regex": "^2.0.0",
3551 |         "strip-outer": "^1.0.0",
3552 |         "trim-repeated": "^1.0.0"
3553 |       },
3554 |       "engines": {
3555 |         "node": ">=6"
3556 |       }
3557 |     },
3558 |     "node_modules/fill-range": {
3559 |       "version": "7.1.1",
3560 |       "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
3561 |       "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
3562 |       "dev": true,
3563 |       "license": "MIT",
3564 |       "dependencies": {
3565 |         "to-regex-range": "^5.0.1"
3566 |       },
3567 |       "engines": {
3568 |         "node": ">=8"
3569 |       }
3570 |     },
3571 |     "node_modules/find-up": {
3572 |       "version": "4.1.0",
3573 |       "resolved": "https://registry.npmjs.org/find-up/-/find-up-4.1.0.tgz",
3574 |       "integrity": "sha512-PpOwAdQ/YlXQ2vj8a3h8IipDuYRi3wceVQQGYWxNINccq40Anw7BlsEXCMbt1Zt+OLA6Fq9suIpIWD0OsnISlw==",
3575 |       "dev": true,
3576 |       "license": "MIT",
3577 |       "dependencies": {
3578 |         "locate-path": "^5.0.0",
3579 |         "path-exists": "^4.0.0"
3580 |       },
3581 |       "engines": {
3582 |         "node": ">=8"
3583 |       }
3584 |     },
3585 |     "node_modules/flat": {
3586 |       "version": "5.0.2",
3587 |       "resolved": "https://registry.npmjs.org/flat/-/flat-5.0.2.tgz",
3588 |       "integrity": "sha512-b6suED+5/3rTpUBdG1gupIl8MPFCAMA0QXwmljLhvCUKcUvdE4gWky9zpuGCcXHOsz4J9wPGNWq6OKpmIzz3hQ==",
3589 |       "dev": true,
3590 |       "license": "BSD-3-Clause",
3591 |       "bin": {
3592 |         "flat": "cli.js"
3593 |       }
3594 |     },
3595 |     "node_modules/follow-redirects": {
3596 |       "version": "1.15.11",
3597 |       "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.11.tgz",
3598 |       "integrity": "sha512-deG2P0JfjrTxl50XGCDyfI97ZGVCxIpfKYmfyrQ54n5FO/0gfIES8C/Psl6kWVDolizcaaxZJnTS0QSMxvnsBQ==",
3599 |       "funding": [
3600 |         {
3601 |           "type": "individual",
3602 |           "url": "https://github.com/sponsors/RubenVerborgh"
3603 |         }
3604 |       ],
3605 |       "license": "MIT",
3606 |       "engines": {
3607 |         "node": ">=4.0"
3608 |       },
3609 |       "peerDependenciesMeta": {
3610 |         "debug": {
3611 |           "optional": true
3612 |         }
3613 |       }
3614 |     },
3615 |     "node_modules/for-each": {
3616 |       "version": "0.3.5",
3617 |       "resolved": "https://registry.npmjs.org/for-each/-/for-each-0.3.5.tgz",
3618 |       "integrity": "sha512-dKx12eRCVIzqCxFGplyFKJMPvLEWgmNtUrpTiJIR5u97zEhRG8ySrtboPHZXx7daLxQVrl643cTzbab2tkQjxg==",
3619 |       "dev": true,
3620 |       "license": "MIT",
3621 |       "dependencies": {
3622 |         "is-callable": "^1.2.7"
3623 |       },
3624 |       "engines": {
3625 |         "node": ">= 0.4"
3626 |       },
3627 |       "funding": {
3628 |         "url": "https://github.com/sponsors/ljharb"
3629 |       }
3630 |     },
3631 |     "node_modules/for-in": {
3632 |       "version": "1.0.2",
3633 |       "resolved": "https://registry.npmjs.org/for-in/-/for-in-1.0.2.tgz",
3634 |       "integrity": "sha512-7EwmXrOjyL+ChxMhmG5lnW9MPt1aIeZEwKhQzoBUdTV0N3zuwWDZYVJatDvZ2OyzPUvdIAZDsCetk3coyMfcnQ==",
3635 |       "license": "MIT",
3636 |       "engines": {
3637 |         "node": ">=0.10.0"
3638 |       }
3639 |     },
3640 |     "node_modules/for-own": {
3641 |       "version": "0.1.5",
3642 |       "resolved": "https://registry.npmjs.org/for-own/-/for-own-0.1.5.tgz",
3643 |       "integrity": "sha512-SKmowqGTJoPzLO1T0BBJpkfp3EMacCMOuH40hOUbrbzElVktk4DioXVM99QkLCyKoiuOmyjgcWMpVz2xjE7LZw==",
3644 |       "license": "MIT",
3645 |       "dependencies": {
3646 |         "for-in": "^1.0.1"
3647 |       },
3648 |       "engines": {
3649 |         "node": ">=0.10.0"
3650 |       }
3651 |     },
3652 |     "node_modules/form-data": {
3653 |       "version": "4.0.5",
3654 |       "resolved": "https://registry.npmjs.org/form-data/-/form-data-4.0.5.tgz",
3655 |       "integrity": "sha512-8RipRLol37bNs2bhoV67fiTEvdTrbMUYcFTiy3+wuuOnUog2QBHCZWXDRijWQfAkhBj2Uf5UnVaiWwA5vdd82w==",
3656 |       "license": "MIT",
3657 |       "dependencies": {
3658 |         "asynckit": "^0.4.0",
3659 |         "combined-stream": "^1.0.8",
3660 |         "es-set-tostringtag": "^2.1.0",
3661 |         "hasown": "^2.0.2",
3662 |         "mime-types": "^2.1.12"
3663 |       },
3664 |       "engines": {
3665 |         "node": ">= 6"
3666 |       }
3667 |     },
3668 |     "node_modules/form-data-encoder": {
3669 |       "version": "2.1.4",
3670 |       "resolved": "https://registry.npmjs.org/form-data-encoder/-/form-data-encoder-2.1.4.tgz",
3671 |       "integrity": "sha512-yDYSgNMraqvnxiEXO4hi88+YZxaHC6QKzb5N84iRCTDeRO7ZALpir/lVmf/uXUhnwUr2O4HU8s/n6x+yNjQkHw==",
3672 |       "dev": true,
3673 |       "license": "MIT",
3674 |       "engines": {
3675 |         "node": ">= 14.17"
3676 |       }
3677 |     },
3678 |     "node_modules/from2": {
3679 |       "version": "2.3.0",
3680 |       "resolved": "https://registry.npmjs.org/from2/-/from2-2.3.0.tgz",
3681 |       "integrity": "sha512-OMcX/4IC/uqEPVgGeyfN22LJk6AZrMkRZHxcHBMBvHScDGgwTm2GT2Wkgtocyd3JfZffjj2kYUDXXII0Fk9W0g==",
3682 |       "dev": true,
3683 |       "license": "MIT",
3684 |       "dependencies": {
3685 |         "inherits": "^2.0.1",
3686 |         "readable-stream": "^2.0.0"
3687 |       }
3688 |     },
3689 |     "node_modules/fs-constants": {
3690 |       "version": "1.0.0",
3691 |       "resolved": "https://registry.npmjs.org/fs-constants/-/fs-constants-1.0.0.tgz",
3692 |       "integrity": "sha512-y6OAwoSIf7FyjMIv94u+b5rdheZEjzR63GTyZJm5qh4Bi+2YgwLCcI/fPFZkL5PSixOt6ZNKm+w+Hfp/Bciwow==",
3693 |       "dev": true,
3694 |       "license": "MIT"
3695 |     },
3696 |     "node_modules/fs-extra": {
3697 |       "version": "9.1.0",
3698 |       "resolved": "https://registry.npmjs.org/fs-extra/-/fs-extra-9.1.0.tgz",
3699 |       "integrity": "sha512-hcg3ZmepS30/7BSFqRvoo3DOMQu7IjqxO5nCDt+zM9XWjb33Wg7ziNT+Qvqbuc3+gWpzO02JubVyk2G4Zvo1OQ==",
3700 |       "dev": true,
3701 |       "license": "MIT",
3702 |       "dependencies": {
3703 |         "at-least-node": "^1.0.0",
3704 |         "graceful-fs": "^4.2.0",
3705 |         "jsonfile": "^6.0.1",
3706 |         "universalify": "^2.0.0"
3707 |       },
3708 |       "engines": {
3709 |         "node": ">=10"
3710 |       }
3711 |     },
3712 |     "node_modules/fs.realpath": {
3713 |       "version": "1.0.0",
3714 |       "resolved": "https://registry.npmjs.org/fs.realpath/-/fs.realpath-1.0.0.tgz",
3715 |       "integrity": "sha512-OO0pH2lK6a0hZnAdau5ItzHPI6pUlvI7jMVnxUQRtw4owF2wk8lOSabtGDCTP4Ggrg2MbGnWO9X8K1t4+fGMDw==",
3716 |       "license": "ISC"
3717 |     },
3718 |     "node_modules/function-bind": {
3719 |       "version": "1.1.2",
3720 |       "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
3721 |       "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
3722 |       "license": "MIT",
3723 |       "funding": {
3724 |         "url": "https://github.com/sponsors/ljharb"
3725 |       }
3726 |     },
3727 |     "node_modules/get-caller-file": {
3728 |       "version": "2.0.5",
3729 |       "resolved": "https://registry.npmjs.org/get-caller-file/-/get-caller-file-2.0.5.tgz",
3730 |       "integrity": "sha512-DyFP3BM/3YHTQOCUL/w0OZHR0lpKeGrxotcHWcqNEdnltqFwXVfhEBQ94eIo34AfQpo0rGki4cyIiftY06h2Fg==",
3731 |       "license": "ISC",
3732 |       "engines": {
3733 |         "node": "6.* || 8.* || >= 10.*"
3734 |       }
3735 |     },
3736 |     "node_modules/get-intrinsic": {
3737 |       "version": "1.3.0",
3738 |       "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
3739 |       "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
3740 |       "license": "MIT",
3741 |       "dependencies": {
3742 |         "call-bind-apply-helpers": "^1.0.2",
3743 |         "es-define-property": "^1.0.1",
3744 |         "es-errors": "^1.3.0",
3745 |         "es-object-atoms": "^1.1.1",
3746 |         "function-bind": "^1.1.2",
3747 |         "get-proto": "^1.0.1",
3748 |         "gopd": "^1.2.0",
3749 |         "has-symbols": "^1.1.0",
3750 |         "hasown": "^2.0.2",
3751 |         "math-intrinsics": "^1.1.0"
3752 |       },
3753 |       "engines": {
3754 |         "node": ">= 0.4"
3755 |       },
3756 |       "funding": {
3757 |         "url": "https://github.com/sponsors/ljharb"
3758 |       }
3759 |     },
3760 |     "node_modules/get-proto": {
3761 |       "version": "1.0.1",
3762 |       "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
3763 |       "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
3764 |       "license": "MIT",
3765 |       "dependencies": {
3766 |         "dunder-proto": "^1.0.1",
3767 |         "es-object-atoms": "^1.0.0"
3768 |       },
3769 |       "engines": {
3770 |         "node": ">= 0.4"
3771 |       }
3772 |     },
3773 |     "node_modules/get-proxy": {
3774 |       "version": "2.1.0",
3775 |       "resolved": "https://registry.npmjs.org/get-proxy/-/get-proxy-2.1.0.tgz",
3776 |       "integrity": "sha512-zmZIaQTWnNQb4R4fJUEp/FC51eZsc6EkErspy3xtIYStaq8EB/hDIWipxsal+E8rz0qD7f2sL/NA9Xee4RInJw==",
3777 |       "dev": true,
3778 |       "license": "MIT",
3779 |       "dependencies": {
3780 |         "npm-conf": "^1.1.0"
3781 |       },
3782 |       "engines": {
3783 |         "node": ">=4"
3784 |       }
3785 |     },
3786 |     "node_modules/get-stream": {
3787 |       "version": "5.2.0",
3788 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-5.2.0.tgz",
3789 |       "integrity": "sha512-nBF+F1rAZVCu/p7rjzgA+Yb4lfYXrpl7a6VmJrU8wF9I1CKvP/QwPNZHnOlwbTkY6dvtFIzFMSyQXbLoTQPRpA==",
3790 |       "license": "MIT",
3791 |       "dependencies": {
3792 |         "pump": "^3.0.0"
3793 |       },
3794 |       "engines": {
3795 |         "node": ">=8"
3796 |       },
3797 |       "funding": {
3798 |         "url": "https://github.com/sponsors/sindresorhus"
3799 |       }
3800 |     },
3801 |     "node_modules/get-uri": {
3802 |       "version": "6.0.5",
3803 |       "resolved": "https://registry.npmjs.org/get-uri/-/get-uri-6.0.5.tgz",
3804 |       "integrity": "sha512-b1O07XYq8eRuVzBNgJLstU6FYc1tS6wnMtF1I1D9lE8LxZSOGZ7LhxN54yPP6mGw5f2CkXY2BQUL9Fx41qvcIg==",
3805 |       "license": "MIT",
3806 |       "dependencies": {
3807 |         "basic-ftp": "^5.0.2",
3808 |         "data-uri-to-buffer": "^6.0.2",
3809 |         "debug": "^4.3.4"
3810 |       },
3811 |       "engines": {
3812 |         "node": ">= 14"
3813 |       }
3814 |     },
3815 |     "node_modules/github-from-package": {
3816 |       "version": "0.0.0",
3817 |       "resolved": "https://registry.npmjs.org/github-from-package/-/github-from-package-0.0.0.tgz",
3818 |       "integrity": "sha512-SyHy3T1v2NUXn29OsWdxmK6RwHD+vkj3v8en8AOBZ1wBQ/hCAQ5bAQTD02kW4W9tUp/3Qh6J8r9EvntiyCmOOw==",
3819 |       "dev": true,
3820 |       "license": "MIT"
3821 |     },
3822 |     "node_modules/glob": {
3823 |       "version": "7.2.3",
3824 |       "resolved": "https://registry.npmjs.org/glob/-/glob-7.2.3.tgz",
3825 |       "integrity": "sha512-nFR0zLpU2YCaRxwoCJvL6UvCH2JFyFVIvwTLsIf21AuHlMskA1hhTdk+LlYJtOlYt9v6dvszD2BGRqBL+iQK9Q==",
3826 |       "deprecated": "Glob versions prior to v9 are no longer supported",
3827 |       "license": "ISC",
3828 |       "dependencies": {
3829 |         "fs.realpath": "^1.0.0",
3830 |         "inflight": "^1.0.4",
3831 |         "inherits": "2",
3832 |         "minimatch": "^3.1.1",
3833 |         "once": "^1.3.0",
3834 |         "path-is-absolute": "^1.0.0"
3835 |       },
3836 |       "engines": {
3837 |         "node": "*"
3838 |       },
3839 |       "funding": {
3840 |         "url": "https://github.com/sponsors/isaacs"
3841 |       }
3842 |     },
3843 |     "node_modules/glob-parent": {
3844 |       "version": "5.1.2",
3845 |       "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
3846 |       "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
3847 |       "dev": true,
3848 |       "license": "ISC",
3849 |       "dependencies": {
3850 |         "is-glob": "^4.0.1"
3851 |       },
3852 |       "engines": {
3853 |         "node": ">= 6"
3854 |       }
3855 |     },
3856 |     "node_modules/glob-to-regexp": {
3857 |       "version": "0.4.1",
3858 |       "resolved": "https://registry.npmjs.org/glob-to-regexp/-/glob-to-regexp-0.4.1.tgz",
3859 |       "integrity": "sha512-lkX1HJXwyMcprw/5YUZc2s7DrpAiHB21/V+E1rHUrVNokkvB6bqMzT0VfV6/86ZNabt1k14YOIaT7nDvOX3Iiw==",
3860 |       "dev": true,
3861 |       "license": "BSD-2-Clause"
3862 |     },
3863 |     "node_modules/globby": {
3864 |       "version": "11.1.0",
3865 |       "resolved": "https://registry.npmjs.org/globby/-/globby-11.1.0.tgz",
3866 |       "integrity": "sha512-jhIXaOzy1sb8IyocaruWSn1TjmnBVs8Ayhcy83rmxNJ8q2uWKCAj3CnJY+KpGSXCueAPc0i05kVvVKtP1t9S3g==",
3867 |       "dev": true,
3868 |       "license": "MIT",
3869 |       "dependencies": {
3870 |         "array-union": "^2.1.0",
3871 |         "dir-glob": "^3.0.1",
3872 |         "fast-glob": "^3.2.9",
3873 |         "ignore": "^5.2.0",
3874 |         "merge2": "^1.4.1",
3875 |         "slash": "^3.0.0"
3876 |       },
3877 |       "engines": {
3878 |         "node": ">=10"
3879 |       },
3880 |       "funding": {
3881 |         "url": "https://github.com/sponsors/sindresorhus"
3882 |       }
3883 |     },
3884 |     "node_modules/gopd": {
3885 |       "version": "1.2.0",
3886 |       "resolved": "https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz",
3887 |       "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
3888 |       "license": "MIT",
3889 |       "engines": {
3890 |         "node": ">= 0.4"
3891 |       },
3892 |       "funding": {
3893 |         "url": "https://github.com/sponsors/ljharb"
3894 |       }
3895 |     },
3896 |     "node_modules/got": {
3897 |       "version": "12.6.1",
3898 |       "resolved": "https://registry.npmjs.org/got/-/got-12.6.1.tgz",
3899 |       "integrity": "sha512-mThBblvlAF1d4O5oqyvN+ZxLAYwIJK7bpMxgYqPD9okW0C3qm5FFn7k811QrcuEBwaogR3ngOFoCfs6mRv7teQ==",
3900 |       "dev": true,
3901 |       "license": "MIT",
3902 |       "dependencies": {
3903 |         "@sindresorhus/is": "^5.2.0",
3904 |         "@szmarczak/http-timer": "^5.0.1",
3905 |         "cacheable-lookup": "^7.0.0",
3906 |         "cacheable-request": "^10.2.8",
3907 |         "decompress-response": "^6.0.0",
3908 |         "form-data-encoder": "^2.1.2",
3909 |         "get-stream": "^6.0.1",
3910 |         "http2-wrapper": "^2.1.10",
3911 |         "lowercase-keys": "^3.0.0",
3912 |         "p-cancelable": "^3.0.0",
3913 |         "responselike": "^3.0.0"
3914 |       },
3915 |       "engines": {
3916 |         "node": ">=14.16"
3917 |       },
3918 |       "funding": {
3919 |         "url": "https://github.com/sindresorhus/got?sponsor=1"
3920 |       }
3921 |     },
3922 |     "node_modules/got/node_modules/get-stream": {
3923 |       "version": "6.0.1",
3924 |       "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-6.0.1.tgz",
3925 |       "integrity": "sha512-ts6Wi+2j3jQjqi70w5AlN8DFnkSwC+MqmxEzdEALB2qXZYV3X/b1CTfgPLGJNMeAWxdPfU8FO1ms3NUfaHCPYg==",
3926 |       "dev": true,
3927 |       "license": "MIT",
3928 |       "engines": {
3929 |         "node": ">=10"
3930 |       },
3931 |       "funding": {
3932 |         "url": "https://github.com/sponsors/sindresorhus"
3933 |       }
3934 |     },
3935 |     "node_modules/graceful-fs": {
3936 |       "version": "4.2.11",
3937 |       "resolved": "https://registry.npmjs.org/graceful-fs/-/graceful-fs-4.2.11.tgz",
3938 |       "integrity": "sha512-RbJ5/jmFcNNCcDV5o9eTnBLJ/HszWV0P73bc+Ff4nS/rJj+YaS6IGyiOL0VoBYX+l1Wrl3k63h/KrH+nhJ0XvQ==",
3939 |       "license": "ISC"
3940 |     },
3941 |     "node_modules/has": {
3942 |       "version": "1.0.4",
3943 |       "resolved": "https://registry.npmjs.org/has/-/has-1.0.4.tgz",
3944 |       "integrity": "sha512-qdSAmqLF6209RFj4VVItywPMbm3vWylknmB3nvNiUIs72xAimcM8nVYxYr7ncvZq5qzk9MKIZR8ijqD/1QuYjQ==",
3945 |       "dev": true,
3946 |       "license": "MIT",
3947 |       "engines": {
3948 |         "node": ">= 0.4.0"
3949 |       }
3950 |     },
3951 |     "node_modules/has-flag": {
3952 |       "version": "4.0.0",
3953 |       "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-4.0.0.tgz",
3954 |       "integrity": "sha512-EykJT/Q1KjTWctppgIAgfSO0tKVuZUjhgMr17kqTumMl6Afv3EISleU7qZUzoXDFTAHTDC4NOoG/ZxU3EvlMPQ==",
3955 |       "dev": true,
3956 |       "license": "MIT",
3957 |       "engines": {
3958 |         "node": ">=8"
3959 |       }
3960 |     },
3961 |     "node_modules/has-property-descriptors": {
3962 |       "version": "1.0.2",
3963 |       "resolved": "https://registry.npmjs.org/has-property-descriptors/-/has-property-descriptors-1.0.2.tgz",
3964 |       "integrity": "sha512-55JNKuIW+vq4Ke1BjOTjM2YctQIvCT7GFzHwmfZPGo5wnrgkid0YQtnAleFSqumZm4az3n2BS+erby5ipJdgrg==",
3965 |       "dev": true,
3966 |       "license": "MIT",
3967 |       "dependencies": {
3968 |         "es-define-property": "^1.0.0"
3969 |       },
3970 |       "funding": {
3971 |         "url": "https://github.com/sponsors/ljharb"
3972 |       }
3973 |     },
3974 |     "node_modules/has-symbol-support-x": {
3975 |       "version": "1.4.2",
3976 |       "resolved": "https://registry.npmjs.org/has-symbol-support-x/-/has-symbol-support-x-1.4.2.tgz",
3977 |       "integrity": "sha512-3ToOva++HaW+eCpgqZrCfN51IPB+7bJNVT6CUATzueB5Heb8o6Nam0V3HG5dlDvZU1Gn5QLcbahiKw/XVk5JJw==",
3978 |       "dev": true,
3979 |       "license": "MIT",
3980 |       "engines": {
3981 |         "node": "*"
3982 |       }
3983 |     },
3984 |     "node_modules/has-symbols": {
3985 |       "version": "1.1.0",
3986 |       "resolved": "https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz",
3987 |       "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
3988 |       "license": "MIT",
3989 |       "engines": {
3990 |         "node": ">= 0.4"
3991 |       },
3992 |       "funding": {
3993 |         "url": "https://github.com/sponsors/ljharb"
3994 |       }
3995 |     },
3996 |     "node_modules/has-to-string-tag-x": {
3997 |       "version": "1.4.1",
3998 |       "resolved": "https://registry.npmjs.org/has-to-string-tag-x/-/has-to-string-tag-x-1.4.1.tgz",
3999 |       "integrity": "sha512-vdbKfmw+3LoOYVr+mtxHaX5a96+0f3DljYd8JOqvOLsf5mw2Otda2qCDT9qRqLAhrjyQ0h7ual5nOiASpsGNFw==",
4000 |       "dev": true,
4001 |       "license": "MIT",
4002 |       "dependencies": {
4003 |         "has-symbol-support-x": "^1.4.1"
4004 |       },
4005 |       "engines": {
4006 |         "node": "*"
4007 |       }
4008 |     },
4009 |     "node_modules/has-tostringtag": {
4010 |       "version": "1.0.2",
4011 |       "resolved": "https://registry.npmjs.org/has-tostringtag/-/has-tostringtag-1.0.2.tgz",
4012 |       "integrity": "sha512-NqADB8VjPFLM2V0VvHUewwwsw0ZWBaIdgo+ieHtK3hasLz4qeCRjYcqfB6AQrBggRKppKF8L52/VqdVsO47Dlw==",
4013 |       "license": "MIT",
4014 |       "dependencies": {
4015 |         "has-symbols": "^1.0.3"
4016 |       },
4017 |       "engines": {
4018 |         "node": ">= 0.4"
4019 |       },
4020 |       "funding": {
4021 |         "url": "https://github.com/sponsors/ljharb"
4022 |       }
4023 |     },
4024 |     "node_modules/hasown": {
4025 |       "version": "2.0.2",
4026 |       "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
4027 |       "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
4028 |       "license": "MIT",
4029 |       "dependencies": {
4030 |         "function-bind": "^1.1.2"
4031 |       },
4032 |       "engines": {
4033 |         "node": ">= 0.4"
4034 |       }
4035 |     },
4036 |     "node_modules/http-cache-semantics": {
4037 |       "version": "4.2.0",
4038 |       "resolved": "https://registry.npmjs.org/http-cache-semantics/-/http-cache-semantics-4.2.0.tgz",
4039 |       "integrity": "sha512-dTxcvPXqPvXBQpq5dUr6mEMJX4oIEFv6bwom3FDwKRDsuIjjJGANqhBuoAn9c1RQJIdAKav33ED65E2ys+87QQ==",
4040 |       "dev": true,
4041 |       "license": "BSD-2-Clause"
4042 |     },
4043 |     "node_modules/http-proxy-agent": {
4044 |       "version": "7.0.2",
4045 |       "resolved": "https://registry.npmjs.org/http-proxy-agent/-/http-proxy-agent-7.0.2.tgz",
4046 |       "integrity": "sha512-T1gkAiYYDWYx3V5Bmyu7HcfcvL7mUrTWiM6yOfa3PIphViJ/gFPbvidQ+veqSOHci/PxBcDabeUNCzpOODJZig==",
4047 |       "license": "MIT",
4048 |       "dependencies": {
4049 |         "agent-base": "^7.1.0",
4050 |         "debug": "^4.3.4"
4051 |       },
4052 |       "engines": {
4053 |         "node": ">= 14"
4054 |       }
4055 |     },
4056 |     "node_modules/http2-wrapper": {
4057 |       "version": "2.2.1",
4058 |       "resolved": "https://registry.npmjs.org/http2-wrapper/-/http2-wrapper-2.2.1.tgz",
4059 |       "integrity": "sha512-V5nVw1PAOgfI3Lmeaj2Exmeg7fenjhRUgz1lPSezy1CuhPYbgQtbQj4jZfEAEMlaL+vupsvhjqCyjzob0yxsmQ==",
4060 |       "dev": true,
4061 |       "license": "MIT",
4062 |       "dependencies": {
4063 |         "quick-lru": "^5.1.1",
4064 |         "resolve-alpn": "^1.2.0"
4065 |       },
4066 |       "engines": {
4067 |         "node": ">=10.19.0"
4068 |       }
4069 |     },
4070 |     "node_modules/https-proxy-agent": {
4071 |       "version": "7.0.6",
4072 |       "resolved": "https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-7.0.6.tgz",
4073 |       "integrity": "sha512-vK9P5/iUfdl95AI+JVyUuIcVtd4ofvtrOr3HNtM2yxC9bnMbEdp3x01OhQNnjb8IJYi38VlTE3mBXwcfvywuSw==",
4074 |       "license": "MIT",
4075 |       "dependencies": {
4076 |         "agent-base": "^7.1.2",
4077 |         "debug": "4"
4078 |       },
4079 |       "engines": {
4080 |         "node": ">= 14"
4081 |       }
4082 |     },
4083 |     "node_modules/iconv-lite": {
4084 |       "version": "0.6.3",
4085 |       "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.6.3.tgz",
4086 |       "integrity": "sha512-4fCk79wshMdzMp2rH06qWrJE4iolqLhCUH+OiuIgU++RB0+94NlDL81atO7GX55uUKueo0txHNtvEyI6D7WdMw==",
4087 |       "dev": true,
4088 |       "license": "MIT",
4089 |       "dependencies": {
4090 |         "safer-buffer": ">= 2.1.2 < 3.0.0"
4091 |       },
4092 |       "engines": {
4093 |         "node": ">=0.10.0"
4094 |       }
4095 |     },
4096 |     "node_modules/ieee754": {
4097 |       "version": "1.2.1",
4098 |       "resolved": "https://registry.npmjs.org/ieee754/-/ieee754-1.2.1.tgz",
4099 |       "integrity": "sha512-dcyqhDvX1C46lXZcVqCpK+FtMRQVdIMN6/Df5js2zouUsqG7I6sFxitIC+7KYK29KdXOLHdu9zL4sFnoVQnqaA==",
4100 |       "dev": true,
4101 |       "funding": [
4102 |         {
4103 |           "type": "github",
4104 |           "url": "https://github.com/sponsors/feross"
4105 |         },
4106 |         {
4107 |           "type": "patreon",
4108 |           "url": "https://www.patreon.com/feross"
4109 |         },
4110 |         {
4111 |           "type": "consulting",
4112 |           "url": "https://feross.org/support"
4113 |         }
4114 |       ],
4115 |       "license": "BSD-3-Clause"
4116 |     },
4117 |     "node_modules/ignore": {
4118 |       "version": "5.3.2",
4119 |       "resolved": "https://registry.npmjs.org/ignore/-/ignore-5.3.2.tgz",
4120 |       "integrity": "sha512-hsBTNUqQTDwkWtcdYI2i06Y/nUBEsNEDJKjWdigLvegy8kDuJAS8uRlpkkcQpyEXL0Z/pjDy5HBmMjRCJ2gq+g==",
4121 |       "dev": true,
4122 |       "license": "MIT",
4123 |       "engines": {
4124 |         "node": ">= 4"
4125 |       }
4126 |     },
4127 |     "node_modules/import-fresh": {
4128 |       "version": "3.3.1",
4129 |       "resolved": "https://registry.npmjs.org/import-fresh/-/import-fresh-3.3.1.tgz",
4130 |       "integrity": "sha512-TR3KfrTZTYLPB6jUjfx6MF9WcWrHL9su5TObK4ZkYgBdWKPOFoSoQIdEuTuR82pmtxH2spWG9h6etwfr1pLBqQ==",
4131 |       "license": "MIT",
4132 |       "dependencies": {
4133 |         "parent-module": "^1.0.0",
4134 |         "resolve-from": "^4.0.0"
4135 |       },
4136 |       "engines": {
4137 |         "node": ">=6"
4138 |       },
4139 |       "funding": {
4140 |         "url": "https://github.com/sponsors/sindresorhus"
4141 |       }
4142 |     },
4143 |     "node_modules/import-local": {
4144 |       "version": "3.2.0",
4145 |       "resolved": "https://registry.npmjs.org/import-local/-/import-local-3.2.0.tgz",
4146 |       "integrity": "sha512-2SPlun1JUPWoM6t3F0dw0FkCF/jWY8kttcY4f599GLTSjh2OCuuhdTkJQsEcZzBqbXZGKMK2OqW1oZsjtf/gQA==",
4147 |       "dev": true,
4148 |       "license": "MIT",
4149 |       "dependencies": {
4150 |         "pkg-dir": "^4.2.0",
4151 |         "resolve-cwd": "^3.0.0"
4152 |       },
4153 |       "bin": {
4154 |         "import-local-fixture": "fixtures/cli.js"
4155 |       },
4156 |       "engines": {
4157 |         "node": ">=8"
4158 |       },
4159 |       "funding": {
4160 |         "url": "https://github.com/sponsors/sindresorhus"
4161 |       }
4162 |     },
4163 |     "node_modules/inflight": {
4164 |       "version": "1.0.6",
4165 |       "resolved": "https://registry.npmjs.org/inflight/-/inflight-1.0.6.tgz",
4166 |       "integrity": "sha512-k92I/b08q4wvFscXCLvqfsHCrjrF7yiXsQuIVvVE7N82W3+aqpzuUdBbfhWcy/FZR3/4IgflMgKLOsvPDrGCJA==",
4167 |       "deprecated": "This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.",
4168 |       "license": "ISC",
4169 |       "dependencies": {
4170 |         "once": "^1.3.0",
4171 |         "wrappy": "1"
4172 |       }
4173 |     },
4174 |     "node_modules/inherits": {
4175 |       "version": "2.0.4",
4176 |       "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
4177 |       "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
4178 |       "license": "ISC"
4179 |     },
4180 |     "node_modules/ini": {
4181 |       "version": "1.3.8",
4182 |       "resolved": "https://registry.npmjs.org/ini/-/ini-1.3.8.tgz",
4183 |       "integrity": "sha512-JV/yugV2uzW5iMRSiZAyDtQd+nxtUnjeLt0acNdw98kKLrvuRVyB80tsREOE7yvGVgalhZ6RNXCmEHkUKBKxew==",
4184 |       "dev": true,
4185 |       "license": "ISC"
4186 |     },
4187 |     "node_modules/interpret": {
4188 |       "version": "3.1.1",
4189 |       "resolved": "https://registry.npmjs.org/interpret/-/interpret-3.1.1.tgz",
4190 |       "integrity": "sha512-6xwYfHbajpoF0xLW+iwLkhwgvLoZDfjYfoFNu8ftMoXINzwuymNLd9u/KmwtdT2GbR+/Cz66otEGEVVUHX9QLQ==",
4191 |       "dev": true,
4192 |       "license": "MIT",
4193 |       "engines": {
4194 |         "node": ">=10.13.0"
4195 |       }
4196 |     },
4197 |     "node_modules/into-stream": {
4198 |       "version": "6.0.0",
4199 |       "resolved": "https://registry.npmjs.org/into-stream/-/into-stream-6.0.0.tgz",
4200 |       "integrity": "sha512-XHbaOAvP+uFKUFsOgoNPRjLkwB+I22JFPFe5OjTkQ0nwgj6+pSjb4NmB6VMxaPshLiOf+zcpOCBQuLwC1KHhZA==",
4201 |       "dev": true,
4202 |       "license": "MIT",
4203 |       "dependencies": {
4204 |         "from2": "^2.3.0",
4205 |         "p-is-promise": "^3.0.0"
4206 |       },
4207 |       "engines": {
4208 |         "node": ">=10"
4209 |       },
4210 |       "funding": {
4211 |         "url": "https://github.com/sponsors/sindresorhus"
4212 |       }
4213 |     },
4214 |     "node_modules/ip-address": {
4215 |       "version": "10.1.0",
4216 |       "resolved": "https://registry.npmjs.org/ip-address/-/ip-address-10.1.0.tgz",
4217 |       "integrity": "sha512-XXADHxXmvT9+CRxhXg56LJovE+bmWnEWB78LB83VZTprKTmaC5QfruXocxzTZ2Kl0DNwKuBdlIhjL8LeY8Sf8Q==",
4218 |       "license": "MIT",
4219 |       "engines": {
4220 |         "node": ">= 12"
4221 |       }
4222 |     },
4223 |     "node_modules/is-arrayish": {
4224 |       "version": "0.2.1",
4225 |       "resolved": "https://registry.npmjs.org/is-arrayish/-/is-arrayish-0.2.1.tgz",
4226 |       "integrity": "sha512-zz06S8t0ozoDXMG+ube26zeCTNXcKIPJZJi8hBrF4idCLms4CG9QtK7qBl1boi5ODzFpjswb5JPmHCbMpjaYzg==",
4227 |       "license": "MIT"
4228 |     },
4229 |     "node_modules/is-buffer": {
4230 |       "version": "1.1.6",
4231 |       "resolved": "https://registry.npmjs.org/is-buffer/-/is-buffer-1.1.6.tgz",
4232 |       "integrity": "sha512-NcdALwpXkTm5Zvvbk7owOUSvVvBKDgKP5/ewfXEznmQFfs4ZRmanOeKBTjRVjka3QFoN6XJ+9F3USqfHqTaU5w==",
4233 |       "license": "MIT"
4234 |     },
4235 |     "node_modules/is-callable": {
4236 |       "version": "1.2.7",
4237 |       "resolved": "https://registry.npmjs.org/is-callable/-/is-callable-1.2.7.tgz",
4238 |       "integrity": "sha512-1BC0BVFhS/p0qtw6enp8e+8OD0UrK0oFLztSjNzhcKA3WDuJxxAPXzPuPtKkjEY9UUoEWlX/8fgKeu2S8i9JTA==",
4239 |       "dev": true,
4240 |       "license": "MIT",
4241 |       "engines": {
4242 |         "node": ">= 0.4"
4243 |       },
4244 |       "funding": {
4245 |         "url": "https://github.com/sponsors/ljharb"
4246 |       }
4247 |     },
4248 |     "node_modules/is-core-module": {
4249 |       "version": "2.9.0",
4250 |       "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.9.0.tgz",
4251 |       "integrity": "sha512-+5FPy5PnwmO3lvfMb0AsoPaBG+5KHUI0wYFXOtYPnVVVspTFUuMZNfNaNVRt3FZadstu2c8x23vykRW/NBoU6A==",
4252 |       "dev": true,
4253 |       "license": "MIT",
4254 |       "dependencies": {
4255 |         "has": "^1.0.3"
4256 |       },
4257 |       "funding": {
4258 |         "url": "https://github.com/sponsors/ljharb"
4259 |       }
4260 |     },
4261 |     "node_modules/is-extendable": {
4262 |       "version": "0.1.1",
4263 |       "resolved": "https://registry.npmjs.org/is-extendable/-/is-extendable-0.1.1.tgz",
4264 |       "integrity": "sha512-5BMULNob1vgFX6EjQw5izWDxrecWK9AM72rugNr0TFldMOi0fj6Jk+zeKIt0xGj4cEfQIJth4w3OKWOJ4f+AFw==",
4265 |       "license": "MIT",
4266 |       "engines": {
4267 |         "node": ">=0.10.0"
4268 |       }
4269 |     },
4270 |     "node_modules/is-extglob": {
4271 |       "version": "2.1.1",
4272 |       "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
4273 |       "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
4274 |       "dev": true,
4275 |       "license": "MIT",
4276 |       "engines": {
4277 |         "node": ">=0.10.0"
4278 |       }
4279 |     },
4280 |     "node_modules/is-fullwidth-code-point": {
4281 |       "version": "3.0.0",
4282 |       "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
4283 |       "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
4284 |       "license": "MIT",
4285 |       "engines": {
4286 |         "node": ">=8"
4287 |       }
4288 |     },
4289 |     "node_modules/is-glob": {
4290 |       "version": "4.0.3",
4291 |       "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
4292 |       "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
4293 |       "dev": true,
4294 |       "license": "MIT",
4295 |       "dependencies": {
4296 |         "is-extglob": "^2.1.1"
4297 |       },
4298 |       "engines": {
4299 |         "node": ">=0.10.0"
4300 |       }
4301 |     },
4302 |     "node_modules/is-natural-number": {
4303 |       "version": "4.0.1",
4304 |       "resolved": "https://registry.npmjs.org/is-natural-number/-/is-natural-number-4.0.1.tgz",
4305 |       "integrity": "sha512-Y4LTamMe0DDQIIAlaer9eKebAlDSV6huy+TWhJVPlzZh2o4tRP5SQWFlLn5N0To4mDD22/qdOq+veo1cSISLgQ==",
4306 |       "dev": true,
4307 |       "license": "MIT"
4308 |     },
4309 |     "node_modules/is-number": {
4310 |       "version": "7.0.0",
4311 |       "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
4312 |       "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
4313 |       "dev": true,
4314 |       "license": "MIT",
4315 |       "engines": {
4316 |         "node": ">=0.12.0"
4317 |       }
4318 |     },
4319 |     "node_modules/is-object": {
4320 |       "version": "1.0.2",
4321 |       "resolved": "https://registry.npmjs.org/is-object/-/is-object-1.0.2.tgz",
4322 |       "integrity": "sha512-2rRIahhZr2UWb45fIOuvZGpFtz0TyOZLf32KxBbSoUCeZR495zCKlWUKKUByk3geS2eAs7ZAABt0Y/Rx0GiQGA==",
4323 |       "dev": true,
4324 |       "license": "MIT",
4325 |       "funding": {
4326 |         "url": "https://github.com/sponsors/ljharb"
4327 |       }
4328 |     },
4329 |     "node_modules/is-plain-obj": {
4330 |       "version": "1.1.0",
4331 |       "resolved": "https://registry.npmjs.org/is-plain-obj/-/is-plain-obj-1.1.0.tgz",
4332 |       "integrity": "sha512-yvkRyxmFKEOQ4pNXCmJG5AEQNlXJS5LaONXo5/cLdTZdWvsZ1ioJEonLGAosKlMWE8lwUy/bJzMjcw8az73+Fg==",
4333 |       "dev": true,
4334 |       "license": "MIT",
4335 |       "engines": {
4336 |         "node": ">=0.10.0"
4337 |       }
4338 |     },
4339 |     "node_modules/is-plain-object": {
4340 |       "version": "2.0.4",
4341 |       "resolved": "https://registry.npmjs.org/is-plain-object/-/is-plain-object-2.0.4.tgz",
4342 |       "integrity": "sha512-h5PpgXkWitc38BBMYawTYMWJHFZJVnBquFE57xFpjB8pJFiF6gZ+bU+WyI/yqXiFR5mdLsgYNaPe8uao6Uv9Og==",
4343 |       "license": "MIT",
4344 |       "dependencies": {
4345 |         "isobject": "^3.0.1"
4346 |       },
4347 |       "engines": {
4348 |         "node": ">=0.10.0"
4349 |       }
4350 |     },
4351 |     "node_modules/is-retry-allowed": {
4352 |       "version": "1.2.0",
4353 |       "resolved": "https://registry.npmjs.org/is-retry-allowed/-/is-retry-allowed-1.2.0.tgz",
4354 |       "integrity": "sha512-RUbUeKwvm3XG2VYamhJL1xFktgjvPzL0Hq8C+6yrWIswDy3BIXGqCxhxkc30N9jqK311gVU137K8Ei55/zVJRg==",
4355 |       "dev": true,
4356 |       "license": "MIT",
4357 |       "engines": {
4358 |         "node": ">=0.10.0"
4359 |       }
4360 |     },
4361 |     "node_modules/is-stream": {
4362 |       "version": "1.1.0",
4363 |       "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-1.1.0.tgz",
4364 |       "integrity": "sha512-uQPm8kcs47jx38atAcWTVxyltQYoPT68y9aWYdV6yWXSyW8mzSat0TL6CiWdZeCdF3KrAvpVtnHbTv4RN+rqdQ==",
4365 |       "dev": true,
4366 |       "license": "MIT",
4367 |       "engines": {
4368 |         "node": ">=0.10.0"
4369 |       }
4370 |     },
4371 |     "node_modules/is-typed-array": {
4372 |       "version": "1.1.15",
4373 |       "resolved": "https://registry.npmjs.org/is-typed-array/-/is-typed-array-1.1.15.tgz",
4374 |       "integrity": "sha512-p3EcsicXjit7SaskXHs1hA91QxgTw46Fv6EFKKGS5DRFLD8yKnohjF3hxoju94b/OcMZoQukzpPpBE9uLVKzgQ==",
4375 |       "dev": true,
4376 |       "license": "MIT",
4377 |       "dependencies": {
4378 |         "which-typed-array": "^1.1.16"
4379 |       },
4380 |       "engines": {
4381 |         "node": ">= 0.4"
4382 |       },
4383 |       "funding": {
4384 |         "url": "https://github.com/sponsors/ljharb"
4385 |       }
4386 |     },
4387 |     "node_modules/isarray": {
4388 |       "version": "1.0.0",
4389 |       "resolved": "https://registry.npmjs.org/isarray/-/isarray-1.0.0.tgz",
4390 |       "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==",
4391 |       "dev": true,
4392 |       "license": "MIT"
4393 |     },
4394 |     "node_modules/isexe": {
4395 |       "version": "2.0.0",
4396 |       "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
4397 |       "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
4398 |       "dev": true,
4399 |       "license": "ISC"
4400 |     },
4401 |     "node_modules/isobject": {
4402 |       "version": "3.0.1",
4403 |       "resolved": "https://registry.npmjs.org/isobject/-/isobject-3.0.1.tgz",
4404 |       "integrity": "sha512-WhB9zCku7EGTj/HQQRz5aUQEUeoQZH2bWcltRErOpymJ4boYE6wL9Tbr23krRPSZ+C5zqNSrSw+Cc7sZZ4b7vg==",
4405 |       "license": "MIT",
4406 |       "engines": {
4407 |         "node": ">=0.10.0"
4408 |       }
4409 |     },
4410 |     "node_modules/isurl": {
4411 |       "version": "1.0.0",
4412 |       "resolved": "https://registry.npmjs.org/isurl/-/isurl-1.0.0.tgz",
4413 |       "integrity": "sha512-1P/yWsxPlDtn7QeRD+ULKQPaIaN6yF368GZ2vDfv0AL0NwpStafjWCDDdn0k8wgFMWpVAqG7oJhxHnlud42i9w==",
4414 |       "dev": true,
4415 |       "license": "MIT",
4416 |       "dependencies": {
4417 |         "has-to-string-tag-x": "^1.2.0",
4418 |         "is-object": "^1.0.1"
4419 |       },
4420 |       "engines": {
4421 |         "node": ">= 4"
4422 |       }
4423 |     },
4424 |     "node_modules/jest-worker": {
4425 |       "version": "27.5.1",
4426 |       "resolved": "https://registry.npmjs.org/jest-worker/-/jest-worker-27.5.1.tgz",
4427 |       "integrity": "sha512-7vuh85V5cdDofPyxn58nrPjBktZo0u9x1g8WtjQol+jZDaE+fhN+cIvTj11GndBnMnyfrUOG1sZQxCdjKh+DKg==",
4428 |       "dev": true,
4429 |       "license": "MIT",
4430 |       "dependencies": {
4431 |         "@types/node": "*",
4432 |         "merge-stream": "^2.0.0",
4433 |         "supports-color": "^8.0.0"
4434 |       },
4435 |       "engines": {
4436 |         "node": ">= 10.13.0"
4437 |       }
4438 |     },
4439 |     "node_modules/jest-worker/node_modules/supports-color": {
4440 |       "version": "8.1.1",
4441 |       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-8.1.1.tgz",
4442 |       "integrity": "sha512-MpUEN2OodtUzxvKQl72cUF7RQ5EiHsGvSsVG0ia9c5RbWGL2CI4C7EpPS8UTBIplnlzZiNuV56w+FuNxy3ty2Q==",
4443 |       "dev": true,
4444 |       "license": "MIT",
4445 |       "dependencies": {
4446 |         "has-flag": "^4.0.0"
4447 |       },
4448 |       "engines": {
4449 |         "node": ">=10"
4450 |       },
4451 |       "funding": {
4452 |         "url": "https://github.com/chalk/supports-color?sponsor=1"
4453 |       }
4454 |     },
4455 |     "node_modules/js-tokens": {
4456 |       "version": "4.0.0",
4457 |       "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
4458 |       "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
4459 |       "license": "MIT"
4460 |     },
4461 |     "node_modules/js-yaml": {
4462 |       "version": "4.1.1",
4463 |       "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.1.tgz",
4464 |       "integrity": "sha512-qQKT4zQxXl8lLwBtHMWwaTcGfFOZviOJet3Oy/xmGk2gZH677CJM9EvtfdSkgWcATZhj/55JZ0rmy3myCT5lsA==",
4465 |       "license": "MIT",
4466 |       "dependencies": {
4467 |         "argparse": "^2.0.1"
4468 |       },
4469 |       "bin": {
4470 |         "js-yaml": "bin/js-yaml.js"
4471 |       }
4472 |     },
4473 |     "node_modules/jsesc": {
4474 |       "version": "2.5.2",
4475 |       "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-2.5.2.tgz",
4476 |       "integrity": "sha512-OYu7XEzjkCQ3C5Ps3QIZsQfNpqoJyZZA99wd9aWd05NCtC5pWOkShK2mkL6HXQR6/Cy2lbNdPlZBpuQHXE63gA==",
4477 |       "dev": true,
4478 |       "license": "MIT",
4479 |       "bin": {
4480 |         "jsesc": "bin/jsesc"
4481 |       },
4482 |       "engines": {
4483 |         "node": ">=4"
4484 |       }
4485 |     },
4486 |     "node_modules/json-buffer": {
4487 |       "version": "3.0.1",
4488 |       "resolved": "https://registry.npmjs.org/json-buffer/-/json-buffer-3.0.1.tgz",
4489 |       "integrity": "sha512-4bV5BfR2mqfQTJm+V5tPPdf+ZpuhiIvTuAB5g8kcrXOZpTT/QwwVRWBywX1ozr6lEuPdbHxwaJlm9G6mI2sfSQ==",
4490 |       "dev": true,
4491 |       "license": "MIT"
4492 |     },
4493 |     "node_modules/json-parse-even-better-errors": {
4494 |       "version": "2.3.1",
4495 |       "resolved": "https://registry.npmjs.org/json-parse-even-better-errors/-/json-parse-even-better-errors-2.3.1.tgz",
4496 |       "integrity": "sha512-xyFwyhro/JEof6Ghe2iz2NcXoj2sloNsWr/XsERDK/oiPCfaNhl5ONfp+jQdAZRQQ0IJWNzH9zIZF7li91kh2w==",
4497 |       "license": "MIT"
4498 |     },
4499 |     "node_modules/json-schema-traverse": {
4500 |       "version": "1.0.0",
4501 |       "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-1.0.0.tgz",
4502 |       "integrity": "sha512-NM8/P9n3XjXhIZn1lLhkFaACTOURQXjWhV4BA/RnOv8xvgqtqpAX9IO4mRQxSx1Rlo4tqzeqb0sOlruaOy3dug==",
4503 |       "dev": true,
4504 |       "license": "MIT"
4505 |     },
4506 |     "node_modules/jsonfile": {
4507 |       "version": "6.2.0",
4508 |       "resolved": "https://registry.npmjs.org/jsonfile/-/jsonfile-6.2.0.tgz",
4509 |       "integrity": "sha512-FGuPw30AdOIUTRMC2OMRtQV+jkVj2cfPqSeWXv1NEAJ1qZ5zb1X6z1mFhbfOB/iy3ssJCD+3KuZ8r8C3uVFlAg==",
4510 |       "license": "MIT",
4511 |       "dependencies": {
4512 |         "universalify": "^2.0.0"
4513 |       },
4514 |       "optionalDependencies": {
4515 |         "graceful-fs": "^4.1.6"
4516 |       }
4517 |     },
4518 |     "node_modules/keyv": {
4519 |       "version": "4.5.4",
4520 |       "resolved": "https://registry.npmjs.org/keyv/-/keyv-4.5.4.tgz",
4521 |       "integrity": "sha512-oxVHkHR/EJf2CNXnWxRLW6mg7JyCCUcG0DtEGmL2ctUo1PNTin1PUil+r/+4r5MpVgC/fn1kjsx7mjSujKqIpw==",
4522 |       "dev": true,
4523 |       "license": "MIT",
4524 |       "dependencies": {
4525 |         "json-buffer": "3.0.1"
4526 |       }
4527 |     },
4528 |     "node_modules/kind-of": {
4529 |       "version": "6.0.3",
4530 |       "resolved": "https://registry.npmjs.org/kind-of/-/kind-of-6.0.3.tgz",
4531 |       "integrity": "sha512-dcS1ul+9tmeD95T+x28/ehLgd9mENa3LsvDTtzm3vyBEO7RPptvAD+t44WVXaUjTBRcrpFeFlC8WCruUR456hw==",
4532 |       "dev": true,
4533 |       "license": "MIT",
4534 |       "engines": {
4535 |         "node": ">=0.10.0"
4536 |       }
4537 |     },
4538 |     "node_modules/lazy-cache": {
4539 |       "version": "1.0.4",
4540 |       "resolved": "https://registry.npmjs.org/lazy-cache/-/lazy-cache-1.0.4.tgz",
4541 |       "integrity": "sha512-RE2g0b5VGZsOCFOCgP7omTRYFqydmZkBwl5oNnQ1lDYC57uyO9KqNnNVxT7COSHTxrRCWVcAVOcbjk+tvh/rgQ==",
4542 |       "license": "MIT",
4543 |       "engines": {
4544 |         "node": ">=0.10.0"
4545 |       }
4546 |     },
4547 |     "node_modules/lazystream": {
4548 |       "version": "1.0.1",
4549 |       "resolved": "https://registry.npmjs.org/lazystream/-/lazystream-1.0.1.tgz",
4550 |       "integrity": "sha512-b94GiNHQNy6JNTrt5w6zNyffMrNkXZb3KTkCZJb2V1xaEGCk093vkZ2jk3tpaeP33/OiXC+WvK9AxUebnf5nbw==",
4551 |       "dev": true,
4552 |       "license": "MIT",
4553 |       "dependencies": {
4554 |         "readable-stream": "^2.0.5"
4555 |       },
4556 |       "engines": {
4557 |         "node": ">= 0.6.3"
4558 |       }
4559 |     },
4560 |     "node_modules/lines-and-columns": {
4561 |       "version": "1.2.4",
4562 |       "resolved": "https://registry.npmjs.org/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
4563 |       "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
4564 |       "license": "MIT"
4565 |     },
4566 |     "node_modules/loader-runner": {
4567 |       "version": "4.3.1",
4568 |       "resolved": "https://registry.npmjs.org/loader-runner/-/loader-runner-4.3.1.tgz",
4569 |       "integrity": "sha512-IWqP2SCPhyVFTBtRcgMHdzlf9ul25NwaFx4wCEH/KjAXuuHY4yNjvPXsBokp8jCB936PyWRaPKUNh8NvylLp2Q==",
4570 |       "dev": true,
4571 |       "license": "MIT",
4572 |       "engines": {
4573 |         "node": ">=6.11.5"
4574 |       },
4575 |       "funding": {
4576 |         "type": "opencollective",
4577 |         "url": "https://opencollective.com/webpack"
4578 |       }
4579 |     },
4580 |     "node_modules/locate-path": {
4581 |       "version": "5.0.0",
4582 |       "resolved": "https://registry.npmjs.org/locate-path/-/locate-path-5.0.0.tgz",
4583 |       "integrity": "sha512-t7hw9pI+WvuwNJXwk5zVHpyhIqzg2qTlklJOf0mVxGSbe3Fp2VieZcduNYjaLDoy6p9uGpQEGWG87WpMKlNq8g==",
4584 |       "dev": true,
4585 |       "license": "MIT",
4586 |       "dependencies": {
4587 |         "p-locate": "^4.1.0"
4588 |       },
4589 |       "engines": {
4590 |         "node": ">=8"
4591 |       }
4592 |     },
4593 |     "node_modules/lodash": {
4594 |       "version": "4.17.21",
4595 |       "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
4596 |       "integrity": "sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==",
4597 |       "dev": true,
4598 |       "license": "MIT"
4599 |     },
4600 |     "node_modules/lodash.defaults": {
4601 |       "version": "4.2.0",
4602 |       "resolved": "https://registry.npmjs.org/lodash.defaults/-/lodash.defaults-4.2.0.tgz",
4603 |       "integrity": "sha512-qjxPLHd3r5DnsdGacqOMU6pb/avJzdh9tFX2ymgoZE27BmjXrNy/y4LoaiTeAb+O3gL8AfpJGtqfX/ae2leYYQ==",
4604 |       "dev": true,
4605 |       "license": "MIT"
4606 |     },
4607 |     "node_modules/lodash.difference": {
4608 |       "version": "4.5.0",
4609 |       "resolved": "https://registry.npmjs.org/lodash.difference/-/lodash.difference-4.5.0.tgz",
4610 |       "integrity": "sha512-dS2j+W26TQ7taQBGN8Lbbq04ssV3emRw4NY58WErlTO29pIqS0HmoT5aJ9+TUQ1N3G+JOZSji4eugsWwGp9yPA==",
4611 |       "dev": true,
4612 |       "license": "MIT"
4613 |     },
4614 |     "node_modules/lodash.flatten": {
4615 |       "version": "4.4.0",
4616 |       "resolved": "https://registry.npmjs.org/lodash.flatten/-/lodash.flatten-4.4.0.tgz",
4617 |       "integrity": "sha512-C5N2Z3DgnnKr0LOpv/hKCgKdb7ZZwafIrsesve6lmzvZIRZRGaZ/l6Q8+2W7NaT+ZwO3fFlSCzCzrDCFdJfZ4g==",
4618 |       "dev": true,
4619 |       "license": "MIT"
4620 |     },
4621 |     "node_modules/lodash.isplainobject": {
4622 |       "version": "4.0.6",
4623 |       "resolved": "https://registry.npmjs.org/lodash.isplainobject/-/lodash.isplainobject-4.0.6.tgz",
4624 |       "integrity": "sha512-oSXzaWypCMHkPC3NvBEaPHf0KsA5mvPrOPgQWDsbg8n7orZ290M0BmC/jgRZ4vcJ6DTAhjrsSYgdsW/F+MFOBA==",
4625 |       "dev": true,
4626 |       "license": "MIT"
4627 |     },
4628 |     "node_modules/lodash.union": {
4629 |       "version": "4.6.0",
4630 |       "resolved": "https://registry.npmjs.org/lodash.union/-/lodash.union-4.6.0.tgz",
4631 |       "integrity": "sha512-c4pB2CdGrGdjMKYLA+XiRDO7Y0PRQbm/Gzg8qMj+QH+pFVAoTp5sBpO0odL3FjoPCGjK96p6qsP+yQoiLoOBcw==",
4632 |       "dev": true,
4633 |       "license": "MIT"
4634 |     },
4635 |     "node_modules/log-symbols": {
4636 |       "version": "2.2.0",
4637 |       "resolved": "https://registry.npmjs.org/log-symbols/-/log-symbols-2.2.0.tgz",
4638 |       "integrity": "sha512-VeIAFslyIerEJLXHziedo2basKbMKtTw3vfn5IzG0XTjhAVEJyNHnL2p7vc+wBDSdQuUpNw3M2u6xb9QsAY5Eg==",
4639 |       "dev": true,
4640 |       "license": "MIT",
4641 |       "dependencies": {
4642 |         "chalk": "^2.0.1"
4643 |       },
4644 |       "engines": {
4645 |         "node": ">=4"
4646 |       }
4647 |     },
4648 |     "node_modules/log-symbols/node_modules/ansi-styles": {
4649 |       "version": "3.2.1",
4650 |       "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-3.2.1.tgz",
4651 |       "integrity": "sha512-VT0ZI6kZRdTh8YyJw3SMbYm/u+NqfsAxEpWO0Pf9sq8/e94WxxOpPKx9FR1FlyCtOVDNOQ+8ntlqFxiRc+r5qA==",
4652 |       "dev": true,
4653 |       "license": "MIT",
4654 |       "dependencies": {
4655 |         "color-convert": "^1.9.0"
4656 |       },
4657 |       "engines": {
4658 |         "node": ">=4"
4659 |       }
4660 |     },
4661 |     "node_modules/log-symbols/node_modules/chalk": {
4662 |       "version": "2.4.2",
4663 |       "resolved": "https://registry.npmjs.org/chalk/-/chalk-2.4.2.tgz",
4664 |       "integrity": "sha512-Mti+f9lpJNcwF4tWV8/OrTTtF1gZi+f8FqlyAdouralcFWFQWF2+NgCHShjkCb+IFBLq9buZwE1xckQU4peSuQ==",
4665 |       "dev": true,
4666 |       "license": "MIT",
4667 |       "dependencies": {
4668 |         "ansi-styles": "^3.2.1",
4669 |         "escape-string-regexp": "^1.0.5",
4670 |         "supports-color": "^5.3.0"
4671 |       },
4672 |       "engines": {
4673 |         "node": ">=4"
4674 |       }
4675 |     },
4676 |     "node_modules/log-symbols/node_modules/color-convert": {
4677 |       "version": "1.9.3",
4678 |       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-1.9.3.tgz",
4679 |       "integrity": "sha512-QfAUtd+vFdAtFQcC8CCyYt1fYWxSqAiK2cSD6zDB8N3cpsEBAvRxp9zOGg6G/SHHJYAT88/az/IuDGALsNVbGg==",
4680 |       "dev": true,
4681 |       "license": "MIT",
4682 |       "dependencies": {
4683 |         "color-name": "1.1.3"
4684 |       }
4685 |     },
4686 |     "node_modules/log-symbols/node_modules/color-name": {
4687 |       "version": "1.1.3",
4688 |       "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.3.tgz",
4689 |       "integrity": "sha512-72fSenhMw2HZMTVHeCA9KCmpEIbzWiQsjN+BHcBbS9vr1mtt+vJjPdksIBNUmKAW8TFUDPJK5SUU3QhE9NEXDw==",
4690 |       "dev": true,
4691 |       "license": "MIT"
4692 |     },
4693 |     "node_modules/log-symbols/node_modules/has-flag": {
4694 |       "version": "3.0.0",
4695 |       "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
4696 |       "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
4697 |       "dev": true,
4698 |       "license": "MIT",
4699 |       "engines": {
4700 |         "node": ">=4"
4701 |       }
4702 |     },
4703 |     "node_modules/log-symbols/node_modules/supports-color": {
4704 |       "version": "5.5.0",
4705 |       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
4706 |       "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
4707 |       "dev": true,
4708 |       "license": "MIT",
4709 |       "dependencies": {
4710 |         "has-flag": "^3.0.0"
4711 |       },
4712 |       "engines": {
4713 |         "node": ">=4"
4714 |       }
4715 |     },
4716 |     "node_modules/lowercase-keys": {
4717 |       "version": "3.0.0",
4718 |       "resolved": "https://registry.npmjs.org/lowercase-keys/-/lowercase-keys-3.0.0.tgz",
4719 |       "integrity": "sha512-ozCC6gdQ+glXOQsveKD0YsDy8DSQFjDTz4zyzEHNV5+JP5D62LmfDZ6o1cycFx9ouG940M5dE8C8CTewdj2YWQ==",
4720 |       "dev": true,
4721 |       "license": "MIT",
4722 |       "engines": {
4723 |         "node": "^12.20.0 || ^14.13.1 || >=16.0.0"
4724 |       },
4725 |       "funding": {
4726 |         "url": "https://github.com/sponsors/sindresorhus"
4727 |       }
4728 |     },
4729 |     "node_modules/lru-cache": {
4730 |       "version": "7.18.3",
4731 |       "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-7.18.3.tgz",
4732 |       "integrity": "sha512-jumlc0BIUrS3qJGgIkWZsyfAM7NCWiBcCDhnd+3NNM5KbBmLTgHVfWBcg6W+rLUsIpzpERPsvwUP7CckAQSOoA==",
4733 |       "license": "ISC",
4734 |       "engines": {
4735 |         "node": ">=12"
4736 |       }
4737 |     },
4738 |     "node_modules/make-dir": {
4739 |       "version": "2.1.0",
4740 |       "resolved": "https://registry.npmjs.org/make-dir/-/make-dir-2.1.0.tgz",
4741 |       "integrity": "sha512-LS9X+dc8KLxXCb8dni79fLIIUA5VyZoyjSMCwTluaXA0o27cCK0bhXkpgw+sTXVpPy/lSO57ilRixqk0vDmtRA==",
4742 |       "dev": true,
4743 |       "license": "MIT",
4744 |       "dependencies": {
4745 |         "pify": "^4.0.1",
4746 |         "semver": "^5.6.0"
4747 |       },
4748 |       "engines": {
4749 |         "node": ">=6"
4750 |       }
4751 |     },
4752 |     "node_modules/make-dir/node_modules/semver": {
4753 |       "version": "5.7.2",
4754 |       "resolved": "https://registry.npmjs.org/semver/-/semver-5.7.2.tgz",
4755 |       "integrity": "sha512-cBznnQ9KjJqU67B52RMC65CMarK2600WFnbkcaiwWq3xy/5haFJlshgnpjovMVJ+Hff49d8GEn0b87C5pDQ10g==",
4756 |       "dev": true,
4757 |       "license": "ISC",
4758 |       "bin": {
4759 |         "semver": "bin/semver"
4760 |       }
4761 |     },
4762 |     "node_modules/math-intrinsics": {
4763 |       "version": "1.1.0",
4764 |       "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
4765 |       "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
4766 |       "license": "MIT",
4767 |       "engines": {
4768 |         "node": ">= 0.4"
4769 |       }
4770 |     },
4771 |     "node_modules/merge-deep": {
4772 |       "version": "3.0.3",
4773 |       "resolved": "https://registry.npmjs.org/merge-deep/-/merge-deep-3.0.3.tgz",
4774 |       "integrity": "sha512-qtmzAS6t6grwEkNrunqTBdn0qKwFgNWvlxUbAV8es9M7Ot1EbyApytCnvE0jALPa46ZpKDUo527kKiaWplmlFA==",
4775 |       "license": "MIT",
4776 |       "dependencies": {
4777 |         "arr-union": "^3.1.0",
4778 |         "clone-deep": "^0.2.4",
4779 |         "kind-of": "^3.0.2"
4780 |       },
4781 |       "engines": {
4782 |         "node": ">=0.10.0"
4783 |       }
4784 |     },
4785 |     "node_modules/merge-deep/node_modules/clone-deep": {
4786 |       "version": "0.2.4",
4787 |       "resolved": "https://registry.npmjs.org/clone-deep/-/clone-deep-0.2.4.tgz",
4788 |       "integrity": "sha512-we+NuQo2DHhSl+DP6jlUiAhyAjBQrYnpOk15rN6c6JSPScjiCLh8IbSU+VTcph6YS3o7mASE8a0+gbZ7ChLpgg==",
4789 |       "license": "MIT",
4790 |       "dependencies": {
4791 |         "for-own": "^0.1.3",
4792 |         "is-plain-object": "^2.0.1",
4793 |         "kind-of": "^3.0.2",
4794 |         "lazy-cache": "^1.0.3",
4795 |         "shallow-clone": "^0.1.2"
4796 |       },
4797 |       "engines": {
4798 |         "node": ">=0.10.0"
4799 |       }
4800 |     },
4801 |     "node_modules/merge-deep/node_modules/kind-of": {
4802 |       "version": "3.2.2",
4803 |       "resolved": "https://registry.npmjs.org/kind-of/-/kind-of-3.2.2.tgz",
4804 |       "integrity": "sha512-NOW9QQXMoZGg/oqnVNoNTTIFEIid1627WCffUBJEdMxYApq7mNE7CpzucIPc+ZQg25Phej7IJSmX3hO+oblOtQ==",
4805 |       "license": "MIT",
4806 |       "dependencies": {
4807 |         "is-buffer": "^1.1.5"
4808 |       },
4809 |       "engines": {
4810 |         "node": ">=0.10.0"
4811 |       }
4812 |     },
4813 |     "node_modules/merge-deep/node_modules/shallow-clone": {
4814 |       "version": "0.1.2",
4815 |       "resolved": "https://registry.npmjs.org/shallow-clone/-/shallow-clone-0.1.2.tgz",
4816 |       "integrity": "sha512-J1zdXCky5GmNnuauESROVu31MQSnLoYvlyEn6j2Ztk6Q5EHFIhxkMhYcv6vuDzl2XEzoRr856QwzMgWM/TmZgw==",
4817 |       "license": "MIT",
4818 |       "dependencies": {
4819 |         "is-extendable": "^0.1.1",
4820 |         "kind-of": "^2.0.1",
4821 |         "lazy-cache": "^0.2.3",
4822 |         "mixin-object": "^2.0.1"
4823 |       },
4824 |       "engines": {
4825 |         "node": ">=0.10.0"
4826 |       }
4827 |     },
4828 |     "node_modules/merge-deep/node_modules/shallow-clone/node_modules/kind-of": {
4829 |       "version": "2.0.1",
4830 |       "resolved": "https://registry.npmjs.org/kind-of/-/kind-of-2.0.1.tgz",
4831 |       "integrity": "sha512-0u8i1NZ/mg0b+W3MGGw5I7+6Eib2nx72S/QvXa0hYjEkjTknYmEYQJwGu3mLC0BrhtJjtQafTkyRUQ75Kx0LVg==",
4832 |       "license": "MIT",
4833 |       "dependencies": {
4834 |         "is-buffer": "^1.0.2"
4835 |       },
4836 |       "engines": {
4837 |         "node": ">=0.10.0"
4838 |       }
4839 |     },
4840 |     "node_modules/merge-deep/node_modules/shallow-clone/node_modules/lazy-cache": {
4841 |       "version": "0.2.7",
4842 |       "resolved": "https://registry.npmjs.org/lazy-cache/-/lazy-cache-0.2.7.tgz",
4843 |       "integrity": "sha512-gkX52wvU/R8DVMMt78ATVPFMJqfW8FPz1GZ1sVHBVQHmu/WvhIWE4cE1GBzhJNFicDeYhnwp6Rl35BcAIM3YOQ==",
4844 |       "license": "MIT",
4845 |       "engines": {
4846 |         "node": ">=0.10.0"
4847 |       }
4848 |     },
4849 |     "node_modules/merge-stream": {
4850 |       "version": "2.0.0",
4851 |       "resolved": "https://registry.npmjs.org/merge-stream/-/merge-stream-2.0.0.tgz",
4852 |       "integrity": "sha512-abv/qOcuPfk3URPfDzmZU1LKmuw8kT+0nIHvKrKgFrwifol/doWcdA4ZqsWQ8ENrFKkd67Mfpo/LovbIUsbt3w==",
4853 |       "dev": true,
4854 |       "license": "MIT"
4855 |     },
4856 |     "node_modules/merge2": {
4857 |       "version": "1.4.1",
4858 |       "resolved": "https://registry.npmjs.org/merge2/-/merge2-1.4.1.tgz",
4859 |       "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
4860 |       "dev": true,
4861 |       "license": "MIT",
4862 |       "engines": {
4863 |         "node": ">= 8"
4864 |       }
4865 |     },
4866 |     "node_modules/meriyah": {
4867 |       "version": "4.5.0",
4868 |       "resolved": "https://registry.npmjs.org/meriyah/-/meriyah-4.5.0.tgz",
4869 |       "integrity": "sha512-Rbiu0QPIxTXgOXwiIpRVJfZRQ2FWyfzYrOGBs9SN5RbaXg1CN5ELn/plodwWwluX93yzc4qO/bNIen1ThGFCxw==",
4870 |       "dev": true,
4871 |       "license": "ISC",
4872 |       "engines": {
4873 |         "node": ">=10.4.0"
4874 |       }
4875 |     },
4876 |     "node_modules/micromatch": {
4877 |       "version": "4.0.8",
4878 |       "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
4879 |       "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
4880 |       "dev": true,
4881 |       "license": "MIT",
4882 |       "dependencies": {
4883 |         "braces": "^3.0.3",
4884 |         "picomatch": "^2.3.1"
4885 |       },
4886 |       "engines": {
4887 |         "node": ">=8.6"
4888 |       }
4889 |     },
4890 |     "node_modules/mime-db": {
4891 |       "version": "1.52.0",
4892 |       "resolved": "https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz",
4893 |       "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
4894 |       "license": "MIT",
4895 |       "engines": {
4896 |         "node": ">= 0.6"
4897 |       }
4898 |     },
4899 |     "node_modules/mime-types": {
4900 |       "version": "2.1.35",
4901 |       "resolved": "https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz",
4902 |       "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
4903 |       "license": "MIT",
4904 |       "dependencies": {
4905 |         "mime-db": "1.52.0"
4906 |       },
4907 |       "engines": {
4908 |         "node": ">= 0.6"
4909 |       }
4910 |     },
4911 |     "node_modules/mimic-fn": {
4912 |       "version": "1.2.0",
4913 |       "resolved": "https://registry.npmjs.org/mimic-fn/-/mimic-fn-1.2.0.tgz",
4914 |       "integrity": "sha512-jf84uxzwiuiIVKiOLpfYk7N46TSy8ubTonmneY9vrpHNAnp0QBt2BxWV9dO3/j+BoVAb+a5G6YDPW3M5HOdMWQ==",
4915 |       "dev": true,
4916 |       "license": "MIT",
4917 |       "engines": {
4918 |         "node": ">=4"
4919 |       }
4920 |     },
4921 |     "node_modules/mimic-response": {
4922 |       "version": "3.1.0",
4923 |       "resolved": "https://registry.npmjs.org/mimic-response/-/mimic-response-3.1.0.tgz",
4924 |       "integrity": "sha512-z0yWI+4FDrrweS8Zmt4Ej5HdJmky15+L2e6Wgn3+iK5fWzb6T3fhNFq2+MeTRb064c6Wr4N/wv0DzQTjNzHNGQ==",
4925 |       "dev": true,
4926 |       "license": "MIT",
4927 |       "engines": {
4928 |         "node": ">=10"
4929 |       },
4930 |       "funding": {
4931 |         "url": "https://github.com/sponsors/sindresorhus"
4932 |       }
4933 |     },
4934 |     "node_modules/minimatch": {
4935 |       "version": "3.1.2",
4936 |       "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
4937 |       "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
4938 |       "license": "ISC",
4939 |       "dependencies": {
4940 |         "brace-expansion": "^1.1.7"
4941 |       },
4942 |       "engines": {
4943 |         "node": "*"
4944 |       }
4945 |     },
4946 |     "node_modules/minimist": {
4947 |       "version": "1.2.8",
4948 |       "resolved": "https://registry.npmjs.org/minimist/-/minimist-1.2.8.tgz",
4949 |       "integrity": "sha512-2yyAR8qBkN3YuheJanUpWC5U3bb5osDywNB8RzDVlDwDHbocAJveqqj1u8+SVD7jkWT4yvsHCpWqqWqAxb0zCA==",
4950 |       "dev": true,
4951 |       "license": "MIT",
4952 |       "funding": {
4953 |         "url": "https://github.com/sponsors/ljharb"
4954 |       }
4955 |     },
4956 |     "node_modules/minipass": {
4957 |       "version": "7.1.2",
4958 |       "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
4959 |       "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
4960 |       "dev": true,
4961 |       "license": "ISC",
4962 |       "engines": {
4963 |         "node": ">=16 || 14 >=14.17"
4964 |       }
4965 |     },
4966 |     "node_modules/minizlib": {
4967 |       "version": "3.1.0",
4968 |       "resolved": "https://registry.npmjs.org/minizlib/-/minizlib-3.1.0.tgz",
4969 |       "integrity": "sha512-KZxYo1BUkWD2TVFLr0MQoM8vUUigWD3LlD83a/75BqC+4qE0Hb1Vo5v1FgcfaNXvfXzr+5EhQ6ing/CaBijTlw==",
4970 |       "dev": true,
4971 |       "license": "MIT",
4972 |       "dependencies": {
4973 |         "minipass": "^7.1.2"
4974 |       },
4975 |       "engines": {
4976 |         "node": ">= 18"
4977 |       }
4978 |     },
4979 |     "node_modules/mitt": {
4980 |       "version": "3.0.1",
4981 |       "resolved": "https://registry.npmjs.org/mitt/-/mitt-3.0.1.tgz",
4982 |       "integrity": "sha512-vKivATfr97l2/QBCYAkXYDbrIWPM2IIKEl7YPhjCvKlG3kE2gm+uBo6nEXK3M5/Ffh/FLpKExzOQ3JJoJGFKBw==",
4983 |       "license": "MIT"
4984 |     },
4985 |     "node_modules/mixin-object": {
4986 |       "version": "2.0.1",
4987 |       "resolved": "https://registry.npmjs.org/mixin-object/-/mixin-object-2.0.1.tgz",
4988 |       "integrity": "sha512-ALGF1Jt9ouehcaXaHhn6t1yGWRqGaHkPFndtFVHfZXOvkIZ/yoGaSi0AHVTafb3ZBGg4dr/bDwnaEKqCXzchMA==",
4989 |       "license": "MIT",
4990 |       "dependencies": {
4991 |         "for-in": "^0.1.3",
4992 |         "is-extendable": "^0.1.1"
4993 |       },
4994 |       "engines": {
4995 |         "node": ">=0.10.0"
4996 |       }
4997 |     },
4998 |     "node_modules/mixin-object/node_modules/for-in": {
4999 |       "version": "0.1.8",
5000 |       "resolved": "https://registry.npmjs.org/for-in/-/for-in-0.1.8.tgz",
5001 |       "integrity": "sha512-F0to7vbBSHP8E3l6dCjxNOLuSFAACIxFy3UehTUlG7svlXi37HHsDkyVcHo0Pq8QwrE+pXvWSVX3ZT1T9wAZ9g==",
5002 |       "license": "MIT",
5003 |       "engines": {
5004 |         "node": ">=0.10.0"
5005 |       }
5006 |     },
5007 |     "node_modules/mkdirp": {
5008 |       "version": "1.0.4",
5009 |       "resolved": "https://registry.npmjs.org/mkdirp/-/mkdirp-1.0.4.tgz",
5010 |       "integrity": "sha512-vVqVZQyf3WLx2Shd0qJ9xuvqgAyKPLAiqITEtqW0oIUjzo3PePDd6fW9iFz30ef7Ysp/oiWqbhszeGWW2T6Gzw==",
5011 |       "dev": true,
5012 |       "license": "MIT",
5013 |       "bin": {
5014 |         "mkdirp": "bin/cmd.js"
5015 |       },
5016 |       "engines": {
5017 |         "node": ">=10"
5018 |       }
5019 |     },
5020 |     "node_modules/mkdirp-classic": {
5021 |       "version": "0.5.3",
5022 |       "resolved": "https://registry.npmjs.org/mkdirp-classic/-/mkdirp-classic-0.5.3.tgz",
5023 |       "integrity": "sha512-gKLcREMhtuZRwRAfqP3RFW+TK4JqApVBtOIftVgjuABpAtpxhPGaDcfvbhNvD0B8iD1oUr/txX35NjcaY6Ns/A==",
5024 |       "dev": true,
5025 |       "license": "MIT"
5026 |     },
5027 |     "node_modules/ms": {
5028 |       "version": "2.1.3",
5029 |       "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
5030 |       "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
5031 |       "license": "MIT"
5032 |     },
5033 |     "node_modules/multistream": {
5034 |       "version": "4.1.0",
5035 |       "resolved": "https://registry.npmjs.org/multistream/-/multistream-4.1.0.tgz",
5036 |       "integrity": "sha512-J1XDiAmmNpRCBfIWJv+n0ymC4ABcf/Pl+5YvC5B/D2f/2+8PtHvCNxMPKiQcZyi922Hq69J2YOpb1pTywfifyw==",
5037 |       "dev": true,
5038 |       "funding": [
5039 |         {
5040 |           "type": "github",
5041 |           "url": "https://github.com/sponsors/feross"
5042 |         },
5043 |         {
5044 |           "type": "patreon",
5045 |           "url": "https://www.patreon.com/feross"
5046 |         },
5047 |         {
5048 |           "type": "consulting",
5049 |           "url": "https://feross.org/support"
5050 |         }
5051 |       ],
5052 |       "license": "MIT",
5053 |       "dependencies": {
5054 |         "once": "^1.4.0",
5055 |         "readable-stream": "^3.6.0"
5056 |       }
5057 |     },
5058 |     "node_modules/multistream/node_modules/readable-stream": {
5059 |       "version": "3.6.2",
5060 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
5061 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
5062 |       "dev": true,
5063 |       "license": "MIT",
5064 |       "dependencies": {
5065 |         "inherits": "^2.0.3",
5066 |         "string_decoder": "^1.1.1",
5067 |         "util-deprecate": "^1.0.1"
5068 |       },
5069 |       "engines": {
5070 |         "node": ">= 6"
5071 |       }
5072 |     },
5073 |     "node_modules/napi-build-utils": {
5074 |       "version": "1.0.2",
5075 |       "resolved": "https://registry.npmjs.org/napi-build-utils/-/napi-build-utils-1.0.2.tgz",
5076 |       "integrity": "sha512-ONmRUqK7zj7DWX0D9ADe03wbwOBZxNAfF20PlGfCWQcD3+/MakShIHrMqx9YwPTfxDdF1zLeL+RGZiR9kGMLdg==",
5077 |       "dev": true,
5078 |       "license": "MIT"
5079 |     },
5080 |     "node_modules/neo-async": {
5081 |       "version": "2.6.2",
5082 |       "resolved": "https://registry.npmjs.org/neo-async/-/neo-async-2.6.2.tgz",
5083 |       "integrity": "sha512-Yd3UES5mWCSqR+qNT93S3UoYUkqAZ9lLg8a7g9rimsWmYGK8cVToA4/sF3RrshdyV3sAGMXVUmpMYOw+dLpOuw==",
5084 |       "dev": true,
5085 |       "license": "MIT"
5086 |     },
5087 |     "node_modules/netmask": {
5088 |       "version": "2.0.2",
5089 |       "resolved": "https://registry.npmjs.org/netmask/-/netmask-2.0.2.tgz",
5090 |       "integrity": "sha512-dBpDMdxv9Irdq66304OLfEmQ9tbNRFnFTuZiLo+bD+r332bBmMJ8GBLXklIXXgxd3+v9+KUnZaUR5PJMa75Gsg==",
5091 |       "license": "MIT",
5092 |       "engines": {
5093 |         "node": ">= 0.4.0"
5094 |       }
5095 |     },
5096 |     "node_modules/nexe": {
5097 |       "version": "5.0.0-beta.4",
5098 |       "resolved": "https://registry.npmjs.org/nexe/-/nexe-5.0.0-beta.4.tgz",
5099 |       "integrity": "sha512-FWKmhS5aZBzAF4brSuwrDM08VscAmaHiY/vkJCNRWf+cZ9HpIIdMlLQYw1CzYrengtPlJyFqAzFBb8pUkOaEEw==",
5100 |       "dev": true,
5101 |       "license": "MIT",
5102 |       "dependencies": {
5103 |         "@calebboyd/semaphore": "^1.3.1",
5104 |         "@yarnpkg/fslib": "^3.0.0-rc.43",
5105 |         "@yarnpkg/libzip": "^3.0.0-rc.43",
5106 |         "app-builder": "^7.0.4",
5107 |         "archiver": "^5.3.1",
5108 |         "caw": "^2.0.1",
5109 |         "chalk": "^2.4.2",
5110 |         "download": "^8.0.0",
5111 |         "globby": "^11.0.2",
5112 |         "got": "^12.6.0",
5113 |         "meriyah": "^4.3.5",
5114 |         "minimist": "^1.2.8",
5115 |         "mkdirp": "^1.0.4",
5116 |         "multistream": "^4.1.0",
5117 |         "ora": "^3.4.0",
5118 |         "resolve-dependencies": "^6.0.9",
5119 |         "rimraf": "^3.0.2",
5120 |         "run-script-os": "^1.1.6",
5121 |         "webpack-config-prefabs": "0.0.5"
5122 |       },
5123 |       "bin": {
5124 |         "nexe": "index.js"
5125 |       },
5126 |       "engines": {
5127 |         "node": ">=10"
5128 |       }
5129 |     },
5130 |     "node_modules/nexe/node_modules/ansi-styles": {
5131 |       "version": "3.2.1",
5132 |       "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-3.2.1.tgz",
5133 |       "integrity": "sha512-VT0ZI6kZRdTh8YyJw3SMbYm/u+NqfsAxEpWO0Pf9sq8/e94WxxOpPKx9FR1FlyCtOVDNOQ+8ntlqFxiRc+r5qA==",
5134 |       "dev": true,
5135 |       "license": "MIT",
5136 |       "dependencies": {
5137 |         "color-convert": "^1.9.0"
5138 |       },
5139 |       "engines": {
5140 |         "node": ">=4"
5141 |       }
5142 |     },
5143 |     "node_modules/nexe/node_modules/chalk": {
5144 |       "version": "2.4.2",
5145 |       "resolved": "https://registry.npmjs.org/chalk/-/chalk-2.4.2.tgz",
5146 |       "integrity": "sha512-Mti+f9lpJNcwF4tWV8/OrTTtF1gZi+f8FqlyAdouralcFWFQWF2+NgCHShjkCb+IFBLq9buZwE1xckQU4peSuQ==",
5147 |       "dev": true,
5148 |       "license": "MIT",
5149 |       "dependencies": {
5150 |         "ansi-styles": "^3.2.1",
5151 |         "escape-string-regexp": "^1.0.5",
5152 |         "supports-color": "^5.3.0"
5153 |       },
5154 |       "engines": {
5155 |         "node": ">=4"
5156 |       }
5157 |     },
5158 |     "node_modules/nexe/node_modules/color-convert": {
5159 |       "version": "1.9.3",
5160 |       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-1.9.3.tgz",
5161 |       "integrity": "sha512-QfAUtd+vFdAtFQcC8CCyYt1fYWxSqAiK2cSD6zDB8N3cpsEBAvRxp9zOGg6G/SHHJYAT88/az/IuDGALsNVbGg==",
5162 |       "dev": true,
5163 |       "license": "MIT",
5164 |       "dependencies": {
5165 |         "color-name": "1.1.3"
5166 |       }
5167 |     },
5168 |     "node_modules/nexe/node_modules/color-name": {
5169 |       "version": "1.1.3",
5170 |       "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.3.tgz",
5171 |       "integrity": "sha512-72fSenhMw2HZMTVHeCA9KCmpEIbzWiQsjN+BHcBbS9vr1mtt+vJjPdksIBNUmKAW8TFUDPJK5SUU3QhE9NEXDw==",
5172 |       "dev": true,
5173 |       "license": "MIT"
5174 |     },
5175 |     "node_modules/nexe/node_modules/has-flag": {
5176 |       "version": "3.0.0",
5177 |       "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
5178 |       "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
5179 |       "dev": true,
5180 |       "license": "MIT",
5181 |       "engines": {
5182 |         "node": ">=4"
5183 |       }
5184 |     },
5185 |     "node_modules/nexe/node_modules/supports-color": {
5186 |       "version": "5.5.0",
5187 |       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
5188 |       "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
5189 |       "dev": true,
5190 |       "license": "MIT",
5191 |       "dependencies": {
5192 |         "has-flag": "^3.0.0"
5193 |       },
5194 |       "engines": {
5195 |         "node": ">=4"
5196 |       }
5197 |     },
5198 |     "node_modules/node-abi": {
5199 |       "version": "3.85.0",
5200 |       "resolved": "https://registry.npmjs.org/node-abi/-/node-abi-3.85.0.tgz",
5201 |       "integrity": "sha512-zsFhmbkAzwhTft6nd3VxcG0cvJsT70rL+BIGHWVq5fi6MwGrHwzqKaxXE+Hl2GmnGItnDKPPkO5/LQqjVkIdFg==",
5202 |       "dev": true,
5203 |       "license": "MIT",
5204 |       "dependencies": {
5205 |         "semver": "^7.3.5"
5206 |       },
5207 |       "engines": {
5208 |         "node": ">=10"
5209 |       }
5210 |     },
5211 |     "node_modules/node-fetch": {
5212 |       "version": "2.7.0",
5213 |       "resolved": "https://registry.npmjs.org/node-fetch/-/node-fetch-2.7.0.tgz",
5214 |       "integrity": "sha512-c4FRfUm/dbcWZ7U+1Wq0AwCyFL+3nt2bEw05wfxSz+DWpWsitgmSgYmy2dQdWyKC1694ELPqMs/YzUSNozLt8A==",
5215 |       "dev": true,
5216 |       "license": "MIT",
5217 |       "dependencies": {
5218 |         "whatwg-url": "^5.0.0"
5219 |       },
5220 |       "engines": {
5221 |         "node": "4.x || >=6.0.0"
5222 |       },
5223 |       "peerDependencies": {
5224 |         "encoding": "^0.1.0"
5225 |       },
5226 |       "peerDependenciesMeta": {
5227 |         "encoding": {
5228 |           "optional": true
5229 |         }
5230 |       }
5231 |     },
5232 |     "node_modules/node-int64": {
5233 |       "version": "0.4.0",
5234 |       "resolved": "https://registry.npmjs.org/node-int64/-/node-int64-0.4.0.tgz",
5235 |       "integrity": "sha512-O5lz91xSOeoXP6DulyHfllpq+Eg00MWitZIbtPfoSEvqIHdl5gfcY6hYzDWnj0qD5tz52PI08u9qUvSVeUBeHw==",
5236 |       "dev": true,
5237 |       "license": "MIT"
5238 |     },
5239 |     "node_modules/node-releases": {
5240 |       "version": "2.0.27",
5241 |       "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
5242 |       "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
5243 |       "dev": true,
5244 |       "license": "MIT"
5245 |     },
5246 |     "node_modules/normalize-path": {
5247 |       "version": "3.0.0",
5248 |       "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
5249 |       "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
5250 |       "dev": true,
5251 |       "license": "MIT",
5252 |       "engines": {
5253 |         "node": ">=0.10.0"
5254 |       }
5255 |     },
5256 |     "node_modules/normalize-url": {
5257 |       "version": "8.1.1",
5258 |       "resolved": "https://registry.npmjs.org/normalize-url/-/normalize-url-8.1.1.tgz",
5259 |       "integrity": "sha512-JYc0DPlpGWB40kH5g07gGTrYuMqV653k3uBKY6uITPWds3M0ov3GaWGp9lbE3Bzngx8+XkfzgvASb9vk9JDFXQ==",
5260 |       "dev": true,
5261 |       "license": "MIT",
5262 |       "engines": {
5263 |         "node": ">=14.16"
5264 |       },
5265 |       "funding": {
5266 |         "url": "https://github.com/sponsors/sindresorhus"
5267 |       }
5268 |     },
5269 |     "node_modules/npm-conf": {
5270 |       "version": "1.1.3",
5271 |       "resolved": "https://registry.npmjs.org/npm-conf/-/npm-conf-1.1.3.tgz",
5272 |       "integrity": "sha512-Yic4bZHJOt9RCFbRP3GgpqhScOY4HH3V2P8yBj6CeYq118Qr+BLXqT2JvpJ00mryLESpgOxf5XlFv4ZjXxLScw==",
5273 |       "dev": true,
5274 |       "license": "MIT",
5275 |       "dependencies": {
5276 |         "config-chain": "^1.1.11",
5277 |         "pify": "^3.0.0"
5278 |       },
5279 |       "engines": {
5280 |         "node": ">=4"
5281 |       }
5282 |     },
5283 |     "node_modules/npm-conf/node_modules/pify": {
5284 |       "version": "3.0.0",
5285 |       "resolved": "https://registry.npmjs.org/pify/-/pify-3.0.0.tgz",
5286 |       "integrity": "sha512-C3FsVNH1udSEX48gGX1xfvwTWfsYWj5U+8/uK15BGzIGrKoUpghX8hWZwa/OFnakBiiVNmBvemTJR5mcy7iPcg==",
5287 |       "dev": true,
5288 |       "license": "MIT",
5289 |       "engines": {
5290 |         "node": ">=4"
5291 |       }
5292 |     },
5293 |     "node_modules/object-assign": {
5294 |       "version": "4.1.1",
5295 |       "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
5296 |       "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
5297 |       "dev": true,
5298 |       "license": "MIT",
5299 |       "engines": {
5300 |         "node": ">=0.10.0"
5301 |       }
5302 |     },
5303 |     "node_modules/once": {
5304 |       "version": "1.4.0",
5305 |       "resolved": "https://registry.npmjs.org/once/-/once-1.4.0.tgz",
5306 |       "integrity": "sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==",
5307 |       "license": "ISC",
5308 |       "dependencies": {
5309 |         "wrappy": "1"
5310 |       }
5311 |     },
5312 |     "node_modules/onetime": {
5313 |       "version": "2.0.1",
5314 |       "resolved": "https://registry.npmjs.org/onetime/-/onetime-2.0.1.tgz",
5315 |       "integrity": "sha512-oyyPpiMaKARvvcgip+JV+7zci5L8D1W9RZIz2l1o08AM3pfspitVWnPt3mzHcBPp12oYMTy0pqrFs/C+m3EwsQ==",
5316 |       "dev": true,
5317 |       "license": "MIT",
5318 |       "dependencies": {
5319 |         "mimic-fn": "^1.0.0"
5320 |       },
5321 |       "engines": {
5322 |         "node": ">=4"
5323 |       }
5324 |     },
5325 |     "node_modules/ora": {
5326 |       "version": "3.4.0",
5327 |       "resolved": "https://registry.npmjs.org/ora/-/ora-3.4.0.tgz",
5328 |       "integrity": "sha512-eNwHudNbO1folBP3JsZ19v9azXWtQZjICdr3Q0TDPIaeBQ3mXLrh54wM+er0+hSp+dWKf+Z8KM58CYzEyIYxYg==",
5329 |       "dev": true,
5330 |       "license": "MIT",
5331 |       "dependencies": {
5332 |         "chalk": "^2.4.2",
5333 |         "cli-cursor": "^2.1.0",
5334 |         "cli-spinners": "^2.0.0",
5335 |         "log-symbols": "^2.2.0",
5336 |         "strip-ansi": "^5.2.0",
5337 |         "wcwidth": "^1.0.1"
5338 |       },
5339 |       "engines": {
5340 |         "node": ">=6"
5341 |       }
5342 |     },
5343 |     "node_modules/ora/node_modules/ansi-regex": {
5344 |       "version": "4.1.1",
5345 |       "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-4.1.1.tgz",
5346 |       "integrity": "sha512-ILlv4k/3f6vfQ4OoP2AGvirOktlQ98ZEL1k9FaQjxa3L1abBgbuTDAdPOpvbGncC0BTVQrl+OM8xZGK6tWXt7g==",
5347 |       "dev": true,
5348 |       "license": "MIT",
5349 |       "engines": {
5350 |         "node": ">=6"
5351 |       }
5352 |     },
5353 |     "node_modules/ora/node_modules/ansi-styles": {
5354 |       "version": "3.2.1",
5355 |       "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-3.2.1.tgz",
5356 |       "integrity": "sha512-VT0ZI6kZRdTh8YyJw3SMbYm/u+NqfsAxEpWO0Pf9sq8/e94WxxOpPKx9FR1FlyCtOVDNOQ+8ntlqFxiRc+r5qA==",
5357 |       "dev": true,
5358 |       "license": "MIT",
5359 |       "dependencies": {
5360 |         "color-convert": "^1.9.0"
5361 |       },
5362 |       "engines": {
5363 |         "node": ">=4"
5364 |       }
5365 |     },
5366 |     "node_modules/ora/node_modules/chalk": {
5367 |       "version": "2.4.2",
5368 |       "resolved": "https://registry.npmjs.org/chalk/-/chalk-2.4.2.tgz",
5369 |       "integrity": "sha512-Mti+f9lpJNcwF4tWV8/OrTTtF1gZi+f8FqlyAdouralcFWFQWF2+NgCHShjkCb+IFBLq9buZwE1xckQU4peSuQ==",
5370 |       "dev": true,
5371 |       "license": "MIT",
5372 |       "dependencies": {
5373 |         "ansi-styles": "^3.2.1",
5374 |         "escape-string-regexp": "^1.0.5",
5375 |         "supports-color": "^5.3.0"
5376 |       },
5377 |       "engines": {
5378 |         "node": ">=4"
5379 |       }
5380 |     },
5381 |     "node_modules/ora/node_modules/color-convert": {
5382 |       "version": "1.9.3",
5383 |       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-1.9.3.tgz",
5384 |       "integrity": "sha512-QfAUtd+vFdAtFQcC8CCyYt1fYWxSqAiK2cSD6zDB8N3cpsEBAvRxp9zOGg6G/SHHJYAT88/az/IuDGALsNVbGg==",
5385 |       "dev": true,
5386 |       "license": "MIT",
5387 |       "dependencies": {
5388 |         "color-name": "1.1.3"
5389 |       }
5390 |     },
5391 |     "node_modules/ora/node_modules/color-name": {
5392 |       "version": "1.1.3",
5393 |       "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.3.tgz",
5394 |       "integrity": "sha512-72fSenhMw2HZMTVHeCA9KCmpEIbzWiQsjN+BHcBbS9vr1mtt+vJjPdksIBNUmKAW8TFUDPJK5SUU3QhE9NEXDw==",
5395 |       "dev": true,
5396 |       "license": "MIT"
5397 |     },
5398 |     "node_modules/ora/node_modules/has-flag": {
5399 |       "version": "3.0.0",
5400 |       "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
5401 |       "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
5402 |       "dev": true,
5403 |       "license": "MIT",
5404 |       "engines": {
5405 |         "node": ">=4"
5406 |       }
5407 |     },
5408 |     "node_modules/ora/node_modules/strip-ansi": {
5409 |       "version": "5.2.0",
5410 |       "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-5.2.0.tgz",
5411 |       "integrity": "sha512-DuRs1gKbBqsMKIZlrffwlug8MHkcnpjs5VPmL1PAh+mA30U0DTotfDZ0d2UUsXpPmPmMMJ6W773MaA3J+lbiWA==",
5412 |       "dev": true,
5413 |       "license": "MIT",
5414 |       "dependencies": {
5415 |         "ansi-regex": "^4.1.0"
5416 |       },
5417 |       "engines": {
5418 |         "node": ">=6"
5419 |       }
5420 |     },
5421 |     "node_modules/ora/node_modules/supports-color": {
5422 |       "version": "5.5.0",
5423 |       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
5424 |       "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
5425 |       "dev": true,
5426 |       "license": "MIT",
5427 |       "dependencies": {
5428 |         "has-flag": "^3.0.0"
5429 |       },
5430 |       "engines": {
5431 |         "node": ">=4"
5432 |       }
5433 |     },
5434 |     "node_modules/p-cancelable": {
5435 |       "version": "3.0.0",
5436 |       "resolved": "https://registry.npmjs.org/p-cancelable/-/p-cancelable-3.0.0.tgz",
5437 |       "integrity": "sha512-mlVgR3PGuzlo0MmTdk4cXqXWlwQDLnONTAg6sm62XkMJEiRxN3GL3SffkYvqwonbkJBcrI7Uvv5Zh9yjvn2iUw==",
5438 |       "dev": true,
5439 |       "license": "MIT",
5440 |       "engines": {
5441 |         "node": ">=12.20"
5442 |       }
5443 |     },
5444 |     "node_modules/p-event": {
5445 |       "version": "2.3.1",
5446 |       "resolved": "https://registry.npmjs.org/p-event/-/p-event-2.3.1.tgz",
5447 |       "integrity": "sha512-NQCqOFhbpVTMX4qMe8PF8lbGtzZ+LCiN7pcNrb/413Na7+TRoe1xkKUzuWa/YEJdGQ0FvKtj35EEbDoVPO2kbA==",
5448 |       "dev": true,
5449 |       "license": "MIT",
5450 |       "dependencies": {
5451 |         "p-timeout": "^2.0.1"
5452 |       },
5453 |       "engines": {
5454 |         "node": ">=6"
5455 |       }
5456 |     },
5457 |     "node_modules/p-finally": {
5458 |       "version": "1.0.0",
5459 |       "resolved": "https://registry.npmjs.org/p-finally/-/p-finally-1.0.0.tgz",
5460 |       "integrity": "sha512-LICb2p9CB7FS+0eR1oqWnHhp0FljGLZCWBE9aix0Uye9W8LTQPwMTYVGWQWIw9RdQiDg4+epXQODwIYJtSJaow==",
5461 |       "dev": true,
5462 |       "license": "MIT",
5463 |       "engines": {
5464 |         "node": ">=4"
5465 |       }
5466 |     },
5467 |     "node_modules/p-is-promise": {
5468 |       "version": "3.0.0",
5469 |       "resolved": "https://registry.npmjs.org/p-is-promise/-/p-is-promise-3.0.0.tgz",
5470 |       "integrity": "sha512-Wo8VsW4IRQSKVXsJCn7TomUaVtyfjVDn3nUP7kE967BQk0CwFpdbZs0X0uk5sW9mkBa9eNM7hCMaG93WUAwxYQ==",
5471 |       "dev": true,
5472 |       "license": "MIT",
5473 |       "engines": {
5474 |         "node": ">=8"
5475 |       }
5476 |     },
5477 |     "node_modules/p-limit": {
5478 |       "version": "2.3.0",
5479 |       "resolved": "https://registry.npmjs.org/p-limit/-/p-limit-2.3.0.tgz",
5480 |       "integrity": "sha512-//88mFWSJx8lxCzwdAABTJL2MyWB12+eIY7MDL2SqLmAkeKU9qxRvWuSyTjm3FUmpBEMuFfckAIqEaVGUDxb6w==",
5481 |       "dev": true,
5482 |       "license": "MIT",
5483 |       "dependencies": {
5484 |         "p-try": "^2.0.0"
5485 |       },
5486 |       "engines": {
5487 |         "node": ">=6"
5488 |       },
5489 |       "funding": {
5490 |         "url": "https://github.com/sponsors/sindresorhus"
5491 |       }
5492 |     },
5493 |     "node_modules/p-locate": {
5494 |       "version": "4.1.0",
5495 |       "resolved": "https://registry.npmjs.org/p-locate/-/p-locate-4.1.0.tgz",
5496 |       "integrity": "sha512-R79ZZ/0wAxKGu3oYMlz8jy/kbhsNrS7SKZ7PxEHBgJ5+F2mtFW2fK2cOtBh1cHYkQsbzFV7I+EoRKe6Yt0oK7A==",
5497 |       "dev": true,
5498 |       "license": "MIT",
5499 |       "dependencies": {
5500 |         "p-limit": "^2.2.0"
5501 |       },
5502 |       "engines": {
5503 |         "node": ">=8"
5504 |       }
5505 |     },
5506 |     "node_modules/p-timeout": {
5507 |       "version": "2.0.1",
5508 |       "resolved": "https://registry.npmjs.org/p-timeout/-/p-timeout-2.0.1.tgz",
5509 |       "integrity": "sha512-88em58dDVB/KzPEx1X0N3LwFfYZPyDc4B6eF38M1rk9VTZMbxXXgjugz8mmwpS9Ox4BDZ+t6t3QP5+/gazweIA==",
5510 |       "dev": true,
5511 |       "license": "MIT",
5512 |       "dependencies": {
5513 |         "p-finally": "^1.0.0"
5514 |       },
5515 |       "engines": {
5516 |         "node": ">=4"
5517 |       }
5518 |     },
5519 |     "node_modules/p-try": {
5520 |       "version": "2.2.0",
5521 |       "resolved": "https://registry.npmjs.org/p-try/-/p-try-2.2.0.tgz",
5522 |       "integrity": "sha512-R4nPAVTAU0B9D35/Gk3uJf/7XYbQcyohSKdvAxIRSNghFl4e71hVoGnBNQz9cWaXxO2I10KTC+3jMdvvoKw6dQ==",
5523 |       "dev": true,
5524 |       "license": "MIT",
5525 |       "engines": {
5526 |         "node": ">=6"
5527 |       }
5528 |     },
5529 |     "node_modules/pac-proxy-agent": {
5530 |       "version": "7.2.0",
5531 |       "resolved": "https://registry.npmjs.org/pac-proxy-agent/-/pac-proxy-agent-7.2.0.tgz",
5532 |       "integrity": "sha512-TEB8ESquiLMc0lV8vcd5Ql/JAKAoyzHFXaStwjkzpOpC5Yv+pIzLfHvjTSdf3vpa2bMiUQrg9i6276yn8666aA==",
5533 |       "license": "MIT",
5534 |       "dependencies": {
5535 |         "@tootallnate/quickjs-emscripten": "^0.23.0",
5536 |         "agent-base": "^7.1.2",
5537 |         "debug": "^4.3.4",
5538 |         "get-uri": "^6.0.1",
5539 |         "http-proxy-agent": "^7.0.0",
5540 |         "https-proxy-agent": "^7.0.6",
5541 |         "pac-resolver": "^7.0.1",
5542 |         "socks-proxy-agent": "^8.0.5"
5543 |       },
5544 |       "engines": {
5545 |         "node": ">= 14"
5546 |       }
5547 |     },
5548 |     "node_modules/pac-resolver": {
5549 |       "version": "7.0.1",
5550 |       "resolved": "https://registry.npmjs.org/pac-resolver/-/pac-resolver-7.0.1.tgz",
5551 |       "integrity": "sha512-5NPgf87AT2STgwa2ntRMr45jTKrYBGkVU36yT0ig/n/GMAa3oPqhZfIQ2kMEimReg0+t9kZViDVZ83qfVUlckg==",
5552 |       "license": "MIT",
5553 |       "dependencies": {
5554 |         "degenerator": "^5.0.0",
5555 |         "netmask": "^2.0.2"
5556 |       },
5557 |       "engines": {
5558 |         "node": ">= 14"
5559 |       }
5560 |     },
5561 |     "node_modules/parent-module": {
5562 |       "version": "1.0.1",
5563 |       "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
5564 |       "integrity": "sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==",
5565 |       "license": "MIT",
5566 |       "dependencies": {
5567 |         "callsites": "^3.0.0"
5568 |       },
5569 |       "engines": {
5570 |         "node": ">=6"
5571 |       }
5572 |     },
5573 |     "node_modules/parse-json": {
5574 |       "version": "5.2.0",
5575 |       "resolved": "https://registry.npmjs.org/parse-json/-/parse-json-5.2.0.tgz",
5576 |       "integrity": "sha512-ayCKvm/phCGxOkYRSCM82iDwct8/EonSEgCSxWxD7ve6jHggsFl4fZVQBPRNgQoKiuV/odhFrGzQXZwbifC8Rg==",
5577 |       "license": "MIT",
5578 |       "dependencies": {
5579 |         "@babel/code-frame": "^7.0.0",
5580 |         "error-ex": "^1.3.1",
5581 |         "json-parse-even-better-errors": "^2.3.0",
5582 |         "lines-and-columns": "^1.1.6"
5583 |       },
5584 |       "engines": {
5585 |         "node": ">=8"
5586 |       },
5587 |       "funding": {
5588 |         "url": "https://github.com/sponsors/sindresorhus"
5589 |       }
5590 |     },
5591 |     "node_modules/path-exists": {
5592 |       "version": "4.0.0",
5593 |       "resolved": "https://registry.npmjs.org/path-exists/-/path-exists-4.0.0.tgz",
5594 |       "integrity": "sha512-ak9Qy5Q7jYb2Wwcey5Fpvg2KoAc/ZIhLSLOSBmRmygPsGwkVVt0fZa0qrtMz+m6tJTAHfZQ8FnmB4MG4LWy7/w==",
5595 |       "dev": true,
5596 |       "license": "MIT",
5597 |       "engines": {
5598 |         "node": ">=8"
5599 |       }
5600 |     },
5601 |     "node_modules/path-is-absolute": {
5602 |       "version": "1.0.1",
5603 |       "resolved": "https://registry.npmjs.org/path-is-absolute/-/path-is-absolute-1.0.1.tgz",
5604 |       "integrity": "sha512-AVbw3UJ2e9bq64vSaS9Am0fje1Pa8pbGqTTsmXfaIiMpnr5DlDhfJOuLj9Sf95ZPVDAUerDfEk88MPmPe7UCQg==",
5605 |       "license": "MIT",
5606 |       "engines": {
5607 |         "node": ">=0.10.0"
5608 |       }
5609 |     },
5610 |     "node_modules/path-key": {
5611 |       "version": "3.1.1",
5612 |       "resolved": "https://registry.npmjs.org/path-key/-/path-key-3.1.1.tgz",
5613 |       "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
5614 |       "dev": true,
5615 |       "license": "MIT",
5616 |       "engines": {
5617 |         "node": ">=8"
5618 |       }
5619 |     },
5620 |     "node_modules/path-parse": {
5621 |       "version": "1.0.7",
5622 |       "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
5623 |       "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
5624 |       "dev": true,
5625 |       "license": "MIT"
5626 |     },
5627 |     "node_modules/path-type": {
5628 |       "version": "4.0.0",
5629 |       "resolved": "https://registry.npmjs.org/path-type/-/path-type-4.0.0.tgz",
5630 |       "integrity": "sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==",
5631 |       "dev": true,
5632 |       "license": "MIT",
5633 |       "engines": {
5634 |         "node": ">=8"
5635 |       }
5636 |     },
5637 |     "node_modules/pend": {
5638 |       "version": "1.2.0",
5639 |       "resolved": "https://registry.npmjs.org/pend/-/pend-1.2.0.tgz",
5640 |       "integrity": "sha512-F3asv42UuXchdzt+xXqfW1OGlVBe+mxa2mqI0pg5yAHZPvFmY3Y6drSf/GQ1A86WgWEN9Kzh/WrgKa6iGcHXLg==",
5641 |       "license": "MIT"
5642 |     },
5643 |     "node_modules/picocolors": {
5644 |       "version": "1.1.1",
5645 |       "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
5646 |       "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
5647 |       "license": "ISC"
5648 |     },
5649 |     "node_modules/picomatch": {
5650 |       "version": "2.3.1",
5651 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
5652 |       "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
5653 |       "dev": true,
5654 |       "license": "MIT",
5655 |       "engines": {
5656 |         "node": ">=8.6"
5657 |       },
5658 |       "funding": {
5659 |         "url": "https://github.com/sponsors/jonschlinkert"
5660 |       }
5661 |     },
5662 |     "node_modules/pify": {
5663 |       "version": "4.0.1",
5664 |       "resolved": "https://registry.npmjs.org/pify/-/pify-4.0.1.tgz",
5665 |       "integrity": "sha512-uB80kBFb/tfd68bVleG9T5GGsGPjJrLAUpR5PZIrhBnIaRTQRjqdJSsIKkOP6OAIFbj7GOrcudc5pNjZ+geV2g==",
5666 |       "dev": true,
5667 |       "license": "MIT",
5668 |       "engines": {
5669 |         "node": ">=6"
5670 |       }
5671 |     },
5672 |     "node_modules/pinkie": {
5673 |       "version": "2.0.4",
5674 |       "resolved": "https://registry.npmjs.org/pinkie/-/pinkie-2.0.4.tgz",
5675 |       "integrity": "sha512-MnUuEycAemtSaeFSjXKW/aroV7akBbY+Sv+RkyqFjgAe73F+MR0TBWKBRDkmfWq/HiFmdavfZ1G7h4SPZXaCSg==",
5676 |       "dev": true,
5677 |       "license": "MIT",
5678 |       "engines": {
5679 |         "node": ">=0.10.0"
5680 |       }
5681 |     },
5682 |     "node_modules/pinkie-promise": {
5683 |       "version": "2.0.1",
5684 |       "resolved": "https://registry.npmjs.org/pinkie-promise/-/pinkie-promise-2.0.1.tgz",
5685 |       "integrity": "sha512-0Gni6D4UcLTbv9c57DfxDGdr41XfgUjqWZu492f0cIGr16zDU06BWP/RAEvOuo7CQ0CNjHaLlM59YJJFm3NWlw==",
5686 |       "dev": true,
5687 |       "license": "MIT",
5688 |       "dependencies": {
5689 |         "pinkie": "^2.0.0"
5690 |       },
5691 |       "engines": {
5692 |         "node": ">=0.10.0"
5693 |       }
5694 |     },
5695 |     "node_modules/pkg": {
5696 |       "version": "5.8.1",
5697 |       "resolved": "https://registry.npmjs.org/pkg/-/pkg-5.8.1.tgz",
5698 |       "integrity": "sha512-CjBWtFStCfIiT4Bde9QpJy0KeH19jCfwZRJqHFDFXfhUklCx8JoFmMj3wgnEYIwGmZVNkhsStPHEOnrtrQhEXA==",
5699 |       "dev": true,
5700 |       "license": "MIT",
5701 |       "dependencies": {
5702 |         "@babel/generator": "7.18.2",
5703 |         "@babel/parser": "7.18.4",
5704 |         "@babel/types": "7.19.0",
5705 |         "chalk": "^4.1.2",
5706 |         "fs-extra": "^9.1.0",
5707 |         "globby": "^11.1.0",
5708 |         "into-stream": "^6.0.0",
5709 |         "is-core-module": "2.9.0",
5710 |         "minimist": "^1.2.6",
5711 |         "multistream": "^4.1.0",
5712 |         "pkg-fetch": "3.4.2",
5713 |         "prebuild-install": "7.1.1",
5714 |         "resolve": "^1.22.0",
5715 |         "stream-meter": "^1.0.4"
5716 |       },
5717 |       "bin": {
5718 |         "pkg": "lib-es5/bin.js"
5719 |       },
5720 |       "peerDependencies": {
5721 |         "node-notifier": ">=9.0.1"
5722 |       },
5723 |       "peerDependenciesMeta": {
5724 |         "node-notifier": {
5725 |           "optional": true
5726 |         }
5727 |       }
5728 |     },
5729 |     "node_modules/pkg-dir": {
5730 |       "version": "4.2.0",
5731 |       "resolved": "https://registry.npmjs.org/pkg-dir/-/pkg-dir-4.2.0.tgz",
5732 |       "integrity": "sha512-HRDzbaKjC+AOWVXxAU/x54COGeIv9eb+6CkDSQoNTt4XyWoIJvuPsXizxu/Fr23EiekbtZwmh1IcIG/l/a10GQ==",
5733 |       "dev": true,
5734 |       "license": "MIT",
5735 |       "dependencies": {
5736 |         "find-up": "^4.0.0"
5737 |       },
5738 |       "engines": {
5739 |         "node": ">=8"
5740 |       }
5741 |     },
5742 |     "node_modules/pkg-fetch": {
5743 |       "version": "3.4.2",
5744 |       "resolved": "https://registry.npmjs.org/pkg-fetch/-/pkg-fetch-3.4.2.tgz",
5745 |       "integrity": "sha512-0+uijmzYcnhC0hStDjm/cl2VYdrmVVBpe7Q8k9YBojxmR5tG8mvR9/nooQq3QSXiQqORDVOTY3XqMEqJVIzkHA==",
5746 |       "dev": true,
5747 |       "license": "MIT",
5748 |       "dependencies": {
5749 |         "chalk": "^4.1.2",
5750 |         "fs-extra": "^9.1.0",
5751 |         "https-proxy-agent": "^5.0.0",
5752 |         "node-fetch": "^2.6.6",
5753 |         "progress": "^2.0.3",
5754 |         "semver": "^7.3.5",
5755 |         "tar-fs": "^2.1.1",
5756 |         "yargs": "^16.2.0"
5757 |       },
5758 |       "bin": {
5759 |         "pkg-fetch": "lib-es5/bin.js"
5760 |       }
5761 |     },
5762 |     "node_modules/pkg-fetch/node_modules/agent-base": {
5763 |       "version": "6.0.2",
5764 |       "resolved": "https://registry.npmjs.org/agent-base/-/agent-base-6.0.2.tgz",
5765 |       "integrity": "sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==",
5766 |       "dev": true,
5767 |       "license": "MIT",
5768 |       "dependencies": {
5769 |         "debug": "4"
5770 |       },
5771 |       "engines": {
5772 |         "node": ">= 6.0.0"
5773 |       }
5774 |     },
5775 |     "node_modules/pkg-fetch/node_modules/cliui": {
5776 |       "version": "7.0.4",
5777 |       "resolved": "https://registry.npmjs.org/cliui/-/cliui-7.0.4.tgz",
5778 |       "integrity": "sha512-OcRE68cOsVMXp1Yvonl/fzkQOyjLSu/8bhPDfQt0e0/Eb283TKP20Fs2MqoPsr9SwA595rRCA+QMzYc9nBP+JQ==",
5779 |       "dev": true,
5780 |       "license": "ISC",
5781 |       "dependencies": {
5782 |         "string-width": "^4.2.0",
5783 |         "strip-ansi": "^6.0.0",
5784 |         "wrap-ansi": "^7.0.0"
5785 |       }
5786 |     },
5787 |     "node_modules/pkg-fetch/node_modules/https-proxy-agent": {
5788 |       "version": "5.0.1",
5789 |       "resolved": "https://registry.npmjs.org/https-proxy-agent/-/https-proxy-agent-5.0.1.tgz",
5790 |       "integrity": "sha512-dFcAjpTQFgoLMzC2VwU+C/CbS7uRL0lWmxDITmqm7C+7F0Odmj6s9l6alZc6AELXhrnggM2CeWSXHGOdX2YtwA==",
5791 |       "dev": true,
5792 |       "license": "MIT",
5793 |       "dependencies": {
5794 |         "agent-base": "6",
5795 |         "debug": "4"
5796 |       },
5797 |       "engines": {
5798 |         "node": ">= 6"
5799 |       }
5800 |     },
5801 |     "node_modules/pkg-fetch/node_modules/readable-stream": {
5802 |       "version": "3.6.2",
5803 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
5804 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
5805 |       "dev": true,
5806 |       "license": "MIT",
5807 |       "dependencies": {
5808 |         "inherits": "^2.0.3",
5809 |         "string_decoder": "^1.1.1",
5810 |         "util-deprecate": "^1.0.1"
5811 |       },
5812 |       "engines": {
5813 |         "node": ">= 6"
5814 |       }
5815 |     },
5816 |     "node_modules/pkg-fetch/node_modules/tar-fs": {
5817 |       "version": "2.1.4",
5818 |       "resolved": "https://registry.npmjs.org/tar-fs/-/tar-fs-2.1.4.tgz",
5819 |       "integrity": "sha512-mDAjwmZdh7LTT6pNleZ05Yt65HC3E+NiQzl672vQG38jIrehtJk/J3mNwIg+vShQPcLF/LV7CMnDW6vjj6sfYQ==",
5820 |       "dev": true,
5821 |       "license": "MIT",
5822 |       "dependencies": {
5823 |         "chownr": "^1.1.1",
5824 |         "mkdirp-classic": "^0.5.2",
5825 |         "pump": "^3.0.0",
5826 |         "tar-stream": "^2.1.4"
5827 |       }
5828 |     },
5829 |     "node_modules/pkg-fetch/node_modules/tar-stream": {
5830 |       "version": "2.2.0",
5831 |       "resolved": "https://registry.npmjs.org/tar-stream/-/tar-stream-2.2.0.tgz",
5832 |       "integrity": "sha512-ujeqbceABgwMZxEJnk2HDY2DlnUZ+9oEcb1KzTVfYHio0UE6dG71n60d8D2I4qNvleWrrXpmjpt7vZeF1LnMZQ==",
5833 |       "dev": true,
5834 |       "license": "MIT",
5835 |       "dependencies": {
5836 |         "bl": "^4.0.3",
5837 |         "end-of-stream": "^1.4.1",
5838 |         "fs-constants": "^1.0.0",
5839 |         "inherits": "^2.0.3",
5840 |         "readable-stream": "^3.1.1"
5841 |       },
5842 |       "engines": {
5843 |         "node": ">=6"
5844 |       }
5845 |     },
5846 |     "node_modules/pkg-fetch/node_modules/yargs": {
5847 |       "version": "16.2.0",
5848 |       "resolved": "https://registry.npmjs.org/yargs/-/yargs-16.2.0.tgz",
5849 |       "integrity": "sha512-D1mvvtDG0L5ft/jGWkLpG1+m0eQxOfaBvTNELraWj22wSVUMWxZUvYgJYcKh6jGGIkJFhH4IZPQhR4TKpc8mBw==",
5850 |       "dev": true,
5851 |       "license": "MIT",
5852 |       "dependencies": {
5853 |         "cliui": "^7.0.2",
5854 |         "escalade": "^3.1.1",
5855 |         "get-caller-file": "^2.0.5",
5856 |         "require-directory": "^2.1.1",
5857 |         "string-width": "^4.2.0",
5858 |         "y18n": "^5.0.5",
5859 |         "yargs-parser": "^20.2.2"
5860 |       },
5861 |       "engines": {
5862 |         "node": ">=10"
5863 |       }
5864 |     },
5865 |     "node_modules/pkg-fetch/node_modules/yargs-parser": {
5866 |       "version": "20.2.9",
5867 |       "resolved": "https://registry.npmjs.org/yargs-parser/-/yargs-parser-20.2.9.tgz",
5868 |       "integrity": "sha512-y11nGElTIV+CT3Zv9t7VKl+Q3hTQoT9a1Qzezhhl6Rp21gJ/IVTW7Z3y9EWXhuUBC2Shnf+DX0antecpAwSP8w==",
5869 |       "dev": true,
5870 |       "license": "ISC",
5871 |       "engines": {
5872 |         "node": ">=10"
5873 |       }
5874 |     },
5875 |     "node_modules/possible-typed-array-names": {
5876 |       "version": "1.1.0",
5877 |       "resolved": "https://registry.npmjs.org/possible-typed-array-names/-/possible-typed-array-names-1.1.0.tgz",
5878 |       "integrity": "sha512-/+5VFTchJDoVj3bhoqi6UeymcD00DAwb1nJwamzPvHEszJ4FpF6SNNbUbOS8yI56qHzdV8eK0qEfOSiodkTdxg==",
5879 |       "dev": true,
5880 |       "license": "MIT",
5881 |       "engines": {
5882 |         "node": ">= 0.4"
5883 |       }
5884 |     },
5885 |     "node_modules/prebuild-install": {
5886 |       "version": "7.1.1",
5887 |       "resolved": "https://registry.npmjs.org/prebuild-install/-/prebuild-install-7.1.1.tgz",
5888 |       "integrity": "sha512-jAXscXWMcCK8GgCoHOfIr0ODh5ai8mj63L2nWrjuAgXE6tDyYGnx4/8o/rCgU+B4JSyZBKbeZqzhtwtC3ovxjw==",
5889 |       "dev": true,
5890 |       "license": "MIT",
5891 |       "dependencies": {
5892 |         "detect-libc": "^2.0.0",
5893 |         "expand-template": "^2.0.3",
5894 |         "github-from-package": "0.0.0",
5895 |         "minimist": "^1.2.3",
5896 |         "mkdirp-classic": "^0.5.3",
5897 |         "napi-build-utils": "^1.0.1",
5898 |         "node-abi": "^3.3.0",
5899 |         "pump": "^3.0.0",
5900 |         "rc": "^1.2.7",
5901 |         "simple-get": "^4.0.0",
5902 |         "tar-fs": "^2.0.0",
5903 |         "tunnel-agent": "^0.6.0"
5904 |       },
5905 |       "bin": {
5906 |         "prebuild-install": "bin.js"
5907 |       },
5908 |       "engines": {
5909 |         "node": ">=10"
5910 |       }
5911 |     },
5912 |     "node_modules/prebuild-install/node_modules/readable-stream": {
5913 |       "version": "3.6.2",
5914 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
5915 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
5916 |       "dev": true,
5917 |       "license": "MIT",
5918 |       "dependencies": {
5919 |         "inherits": "^2.0.3",
5920 |         "string_decoder": "^1.1.1",
5921 |         "util-deprecate": "^1.0.1"
5922 |       },
5923 |       "engines": {
5924 |         "node": ">= 6"
5925 |       }
5926 |     },
5927 |     "node_modules/prebuild-install/node_modules/tar-fs": {
5928 |       "version": "2.1.4",
5929 |       "resolved": "https://registry.npmjs.org/tar-fs/-/tar-fs-2.1.4.tgz",
5930 |       "integrity": "sha512-mDAjwmZdh7LTT6pNleZ05Yt65HC3E+NiQzl672vQG38jIrehtJk/J3mNwIg+vShQPcLF/LV7CMnDW6vjj6sfYQ==",
5931 |       "dev": true,
5932 |       "license": "MIT",
5933 |       "dependencies": {
5934 |         "chownr": "^1.1.1",
5935 |         "mkdirp-classic": "^0.5.2",
5936 |         "pump": "^3.0.0",
5937 |         "tar-stream": "^2.1.4"
5938 |       }
5939 |     },
5940 |     "node_modules/prebuild-install/node_modules/tar-stream": {
5941 |       "version": "2.2.0",
5942 |       "resolved": "https://registry.npmjs.org/tar-stream/-/tar-stream-2.2.0.tgz",
5943 |       "integrity": "sha512-ujeqbceABgwMZxEJnk2HDY2DlnUZ+9oEcb1KzTVfYHio0UE6dG71n60d8D2I4qNvleWrrXpmjpt7vZeF1LnMZQ==",
5944 |       "dev": true,
5945 |       "license": "MIT",
5946 |       "dependencies": {
5947 |         "bl": "^4.0.3",
5948 |         "end-of-stream": "^1.4.1",
5949 |         "fs-constants": "^1.0.0",
5950 |         "inherits": "^2.0.3",
5951 |         "readable-stream": "^3.1.1"
5952 |       },
5953 |       "engines": {
5954 |         "node": ">=6"
5955 |       }
5956 |     },
5957 |     "node_modules/prepend-http": {
5958 |       "version": "2.0.0",
5959 |       "resolved": "https://registry.npmjs.org/prepend-http/-/prepend-http-2.0.0.tgz",
5960 |       "integrity": "sha512-ravE6m9Atw9Z/jjttRUZ+clIXogdghyZAuWJ3qEzjT+jI/dL1ifAqhZeC5VHzQp1MSt1+jxKkFNemj/iO7tVUA==",
5961 |       "dev": true,
5962 |       "license": "MIT",
5963 |       "engines": {
5964 |         "node": ">=4"
5965 |       }
5966 |     },
5967 |     "node_modules/process-nextick-args": {
5968 |       "version": "2.0.1",
5969 |       "resolved": "https://registry.npmjs.org/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
5970 |       "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==",
5971 |       "dev": true,
5972 |       "license": "MIT"
5973 |     },
5974 |     "node_modules/progress": {
5975 |       "version": "2.0.3",
5976 |       "resolved": "https://registry.npmjs.org/progress/-/progress-2.0.3.tgz",
5977 |       "integrity": "sha512-7PiHtLll5LdnKIMw100I+8xJXR5gW2QwWYkT6iJva0bXitZKa/XMrSbdmg3r2Xnaidz9Qumd0VPaMrZlF9V9sA==",
5978 |       "license": "MIT",
5979 |       "engines": {
5980 |         "node": ">=0.4.0"
5981 |       }
5982 |     },
5983 |     "node_modules/proto-list": {
5984 |       "version": "1.2.4",
5985 |       "resolved": "https://registry.npmjs.org/proto-list/-/proto-list-1.2.4.tgz",
5986 |       "integrity": "sha512-vtK/94akxsTMhe0/cbfpR+syPuszcuwhqVjJq26CuNDgFGj682oRBXOP5MJpv2r7JtE8MsiepGIqvvOTBwn2vA==",
5987 |       "dev": true,
5988 |       "license": "ISC"
5989 |     },
5990 |     "node_modules/proxy-agent": {
5991 |       "version": "6.5.0",
5992 |       "resolved": "https://registry.npmjs.org/proxy-agent/-/proxy-agent-6.5.0.tgz",
5993 |       "integrity": "sha512-TmatMXdr2KlRiA2CyDu8GqR8EjahTG3aY3nXjdzFyoZbmB8hrBsTyMezhULIXKnC0jpfjlmiZ3+EaCzoInSu/A==",
5994 |       "license": "MIT",
5995 |       "dependencies": {
5996 |         "agent-base": "^7.1.2",
5997 |         "debug": "^4.3.4",
5998 |         "http-proxy-agent": "^7.0.1",
5999 |         "https-proxy-agent": "^7.0.6",
6000 |         "lru-cache": "^7.14.1",
6001 |         "pac-proxy-agent": "^7.1.0",
6002 |         "proxy-from-env": "^1.1.0",
6003 |         "socks-proxy-agent": "^8.0.5"
6004 |       },
6005 |       "engines": {
6006 |         "node": ">= 14"
6007 |       }
6008 |     },
6009 |     "node_modules/proxy-from-env": {
6010 |       "version": "1.1.0",
6011 |       "resolved": "https://registry.npmjs.org/proxy-from-env/-/proxy-from-env-1.1.0.tgz",
6012 |       "integrity": "sha512-D+zkORCbA9f1tdWRK0RaCR3GPv50cMxcrz4X8k5LTSUD1Dkw47mKJEZQNunItRTkWwgtaUSo1RVFRIG9ZXiFYg==",
6013 |       "license": "MIT"
6014 |     },
6015 |     "node_modules/pump": {
6016 |       "version": "3.0.3",
6017 |       "resolved": "https://registry.npmjs.org/pump/-/pump-3.0.3.tgz",
6018 |       "integrity": "sha512-todwxLMY7/heScKmntwQG8CXVkWUOdYxIvY2s0VWAAMh/nd8SoYiRaKjlr7+iCs984f2P8zvrfWcDDYVb73NfA==",
6019 |       "license": "MIT",
6020 |       "dependencies": {
6021 |         "end-of-stream": "^1.1.0",
6022 |         "once": "^1.3.1"
6023 |       }
6024 |     },
6025 |     "node_modules/puppeteer": {
6026 |       "version": "24.31.0",
6027 |       "resolved": "https://registry.npmjs.org/puppeteer/-/puppeteer-24.31.0.tgz",
6028 |       "integrity": "sha512-q8y5yLxLD8xdZdzNWqdOL43NbfvUOp60SYhaLZQwHC9CdKldxQKXOyJAciOr7oUJfyAH/KgB2wKvqT2sFKoVXA==",
6029 |       "hasInstallScript": true,
6030 |       "license": "Apache-2.0",
6031 |       "peer": true,
6032 |       "dependencies": {
6033 |         "@puppeteer/browsers": "2.10.13",
6034 |         "chromium-bidi": "11.0.0",
6035 |         "cosmiconfig": "^9.0.0",
6036 |         "devtools-protocol": "0.0.1521046",
6037 |         "puppeteer-core": "24.31.0",
6038 |         "typed-query-selector": "^2.12.0"
6039 |       },
6040 |       "bin": {
6041 |         "puppeteer": "lib/cjs/puppeteer/node/cli.js"
6042 |       },
6043 |       "engines": {
6044 |         "node": ">=18"
6045 |       }
6046 |     },
6047 |     "node_modules/puppeteer-core": {
6048 |       "version": "24.31.0",
6049 |       "resolved": "https://registry.npmjs.org/puppeteer-core/-/puppeteer-core-24.31.0.tgz",
6050 |       "integrity": "sha512-pnAohhSZipWQoFpXuGV7xCZfaGhqcBR9C4pVrU0QSrcMi7tQMH9J9lDBqBvyMAHQqe8HCARuREqFuVKRQOgTvg==",
6051 |       "license": "Apache-2.0",
6052 |       "dependencies": {
6053 |         "@puppeteer/browsers": "2.10.13",
6054 |         "chromium-bidi": "11.0.0",
6055 |         "debug": "^4.4.3",
6056 |         "devtools-protocol": "0.0.1521046",
6057 |         "typed-query-selector": "^2.12.0",
6058 |         "webdriver-bidi-protocol": "0.3.9",
6059 |         "ws": "^8.18.3"
6060 |       },
6061 |       "engines": {
6062 |         "node": ">=18"
6063 |       }
6064 |     },
6065 |     "node_modules/puppeteer-extra": {
6066 |       "version": "3.3.6",
6067 |       "resolved": "https://registry.npmjs.org/puppeteer-extra/-/puppeteer-extra-3.3.6.tgz",
6068 |       "integrity": "sha512-rsLBE/6mMxAjlLd06LuGacrukP2bqbzKCLzV1vrhHFavqQE/taQ2UXv3H5P0Ls7nsrASa+6x3bDbXHpqMwq+7A==",
6069 |       "license": "MIT",
6070 |       "peer": true,
6071 |       "dependencies": {
6072 |         "@types/debug": "^4.1.0",
6073 |         "debug": "^4.1.1",
6074 |         "deepmerge": "^4.2.2"
6075 |       },
6076 |       "engines": {
6077 |         "node": ">=8"
6078 |       },
6079 |       "peerDependencies": {
6080 |         "@types/puppeteer": "*",
6081 |         "puppeteer": "*",
6082 |         "puppeteer-core": "*"
6083 |       },
6084 |       "peerDependenciesMeta": {
6085 |         "@types/puppeteer": {
6086 |           "optional": true
6087 |         },
6088 |         "puppeteer": {
6089 |           "optional": true
6090 |         },
6091 |         "puppeteer-core": {
6092 |           "optional": true
6093 |         }
6094 |       }
6095 |     },
6096 |     "node_modules/puppeteer-extra-plugin": {
6097 |       "version": "3.2.3",
6098 |       "resolved": "https://registry.npmjs.org/puppeteer-extra-plugin/-/puppeteer-extra-plugin-3.2.3.tgz",
6099 |       "integrity": "sha512-6RNy0e6pH8vaS3akPIKGg28xcryKscczt4wIl0ePciZENGE2yoaQJNd17UiEbdmh5/6WW6dPcfRWT9lxBwCi2Q==",
6100 |       "license": "MIT",
6101 |       "dependencies": {
6102 |         "@types/debug": "^4.1.0",
6103 |         "debug": "^4.1.1",
6104 |         "merge-deep": "^3.0.1"
6105 |       },
6106 |       "engines": {
6107 |         "node": ">=9.11.2"
6108 |       },
6109 |       "peerDependencies": {
6110 |         "playwright-extra": "*",
6111 |         "puppeteer-extra": "*"
6112 |       },
6113 |       "peerDependenciesMeta": {
6114 |         "playwright-extra": {
6115 |           "optional": true
6116 |         },
6117 |         "puppeteer-extra": {
6118 |           "optional": true
6119 |         }
6120 |       }
6121 |     },
6122 |     "node_modules/puppeteer-extra-plugin-recaptcha": {
6123 |       "version": "3.6.8",
6124 |       "resolved": "https://registry.npmjs.org/puppeteer-extra-plugin-recaptcha/-/puppeteer-extra-plugin-recaptcha-3.6.8.tgz",
6125 |       "integrity": "sha512-AY2HG1ZFlSi4xs+Hy84LtRJ95DIfnbjR3Az64dJGVW8gr/hBAGEWRlXTMzea7YOmxO3Nc8Ak3CcUgjgp1gIu1w==",
6126 |       "license": "MIT",
6127 |       "dependencies": {
6128 |         "debug": "^4.1.1",
6129 |         "merge-deep": "^3.0.2",
6130 |         "puppeteer-extra-plugin": "^3.2.3"
6131 |       },
6132 |       "engines": {
6133 |         "node": ">=9.11.2"
6134 |       },
6135 |       "peerDependencies": {
6136 |         "playwright-extra": "*",
6137 |         "puppeteer-extra": "*"
6138 |       },
6139 |       "peerDependenciesMeta": {
6140 |         "playwright-extra": {
6141 |           "optional": true
6142 |         },
6143 |         "puppeteer-extra": {
6144 |           "optional": true
6145 |         }
6146 |       }
6147 |     },
6148 |     "node_modules/puppeteer-extra-plugin-stealth": {
6149 |       "version": "2.11.2",
6150 |       "resolved": "https://registry.npmjs.org/puppeteer-extra-plugin-stealth/-/puppeteer-extra-plugin-stealth-2.11.2.tgz",
6151 |       "integrity": "sha512-bUemM5XmTj9i2ZerBzsk2AN5is0wHMNE6K0hXBzBXOzP5m5G3Wl0RHhiqKeHToe/uIH8AoZiGhc1tCkLZQPKTQ==",
6152 |       "license": "MIT",
6153 |       "dependencies": {
6154 |         "debug": "^4.1.1",
6155 |         "puppeteer-extra-plugin": "^3.2.3",
6156 |         "puppeteer-extra-plugin-user-preferences": "^2.4.1"
6157 |       },
6158 |       "engines": {
6159 |         "node": ">=8"
6160 |       },
6161 |       "peerDependencies": {
6162 |         "playwright-extra": "*",
6163 |         "puppeteer-extra": "*"
6164 |       },
6165 |       "peerDependenciesMeta": {
6166 |         "playwright-extra": {
6167 |           "optional": true
6168 |         },
6169 |         "puppeteer-extra": {
6170 |           "optional": true
6171 |         }
6172 |       }
6173 |     },
6174 |     "node_modules/puppeteer-extra-plugin-user-data-dir": {
6175 |       "version": "2.4.1",
6176 |       "resolved": "https://registry.npmjs.org/puppeteer-extra-plugin-user-data-dir/-/puppeteer-extra-plugin-user-data-dir-2.4.1.tgz",
6177 |       "integrity": "sha512-kH1GnCcqEDoBXO7epAse4TBPJh9tEpVEK/vkedKfjOVOhZAvLkHGc9swMs5ChrJbRnf8Hdpug6TJlEuimXNQ+g==",
6178 |       "license": "MIT",
6179 |       "dependencies": {
6180 |         "debug": "^4.1.1",
6181 |         "fs-extra": "^10.0.0",
6182 |         "puppeteer-extra-plugin": "^3.2.3",
6183 |         "rimraf": "^3.0.2"
6184 |       },
6185 |       "engines": {
6186 |         "node": ">=8"
6187 |       },
6188 |       "peerDependencies": {
6189 |         "playwright-extra": "*",
6190 |         "puppeteer-extra": "*"
6191 |       },
6192 |       "peerDependenciesMeta": {
6193 |         "playwright-extra": {
6194 |           "optional": true
6195 |         },
6196 |         "puppeteer-extra": {
6197 |           "optional": true
6198 |         }
6199 |       }
6200 |     },
6201 |     "node_modules/puppeteer-extra-plugin-user-data-dir/node_modules/fs-extra": {
6202 |       "version": "10.1.0",
6203 |       "resolved": "https://registry.npmjs.org/fs-extra/-/fs-extra-10.1.0.tgz",
6204 |       "integrity": "sha512-oRXApq54ETRj4eMiFzGnHWGy+zo5raudjuxN0b8H7s/RU2oW0Wvsx9O0ACRN/kRq9E8Vu/ReskGB5o3ji+FzHQ==",
6205 |       "license": "MIT",
6206 |       "dependencies": {
6207 |         "graceful-fs": "^4.2.0",
6208 |         "jsonfile": "^6.0.1",
6209 |         "universalify": "^2.0.0"
6210 |       },
6211 |       "engines": {
6212 |         "node": ">=12"
6213 |       }
6214 |     },
6215 |     "node_modules/puppeteer-extra-plugin-user-preferences": {
6216 |       "version": "2.4.1",
6217 |       "resolved": "https://registry.npmjs.org/puppeteer-extra-plugin-user-preferences/-/puppeteer-extra-plugin-user-preferences-2.4.1.tgz",
6218 |       "integrity": "sha512-i1oAZxRbc1bk8MZufKCruCEC3CCafO9RKMkkodZltI4OqibLFXF3tj6HZ4LZ9C5vCXZjYcDWazgtY69mnmrQ9A==",
6219 |       "license": "MIT",
6220 |       "dependencies": {
6221 |         "debug": "^4.1.1",
6222 |         "deepmerge": "^4.2.2",
6223 |         "puppeteer-extra-plugin": "^3.2.3",
6224 |         "puppeteer-extra-plugin-user-data-dir": "^2.4.1"
6225 |       },
6226 |       "engines": {
6227 |         "node": ">=8"
6228 |       },
6229 |       "peerDependencies": {
6230 |         "playwright-extra": "*",
6231 |         "puppeteer-extra": "*"
6232 |       },
6233 |       "peerDependenciesMeta": {
6234 |         "playwright-extra": {
6235 |           "optional": true
6236 |         },
6237 |         "puppeteer-extra": {
6238 |           "optional": true
6239 |         }
6240 |       }
6241 |     },
6242 |     "node_modules/query-string": {
6243 |       "version": "5.1.1",
6244 |       "resolved": "https://registry.npmjs.org/query-string/-/query-string-5.1.1.tgz",
6245 |       "integrity": "sha512-gjWOsm2SoGlgLEdAGt7a6slVOk9mGiXmPFMqrEhLQ68rhQuBnpfs3+EmlvqKyxnCo9/PPlF+9MtY02S1aFg+Jw==",
6246 |       "dev": true,
6247 |       "license": "MIT",
6248 |       "dependencies": {
6249 |         "decode-uri-component": "^0.2.0",
6250 |         "object-assign": "^4.1.0",
6251 |         "strict-uri-encode": "^1.0.0"
6252 |       },
6253 |       "engines": {
6254 |         "node": ">=0.10.0"
6255 |       }
6256 |     },
6257 |     "node_modules/queue-microtask": {
6258 |       "version": "1.2.3",
6259 |       "resolved": "https://registry.npmjs.org/queue-microtask/-/queue-microtask-1.2.3.tgz",
6260 |       "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
6261 |       "dev": true,
6262 |       "funding": [
6263 |         {
6264 |           "type": "github",
6265 |           "url": "https://github.com/sponsors/feross"
6266 |         },
6267 |         {
6268 |           "type": "patreon",
6269 |           "url": "https://www.patreon.com/feross"
6270 |         },
6271 |         {
6272 |           "type": "consulting",
6273 |           "url": "https://feross.org/support"
6274 |         }
6275 |       ],
6276 |       "license": "MIT"
6277 |     },
6278 |     "node_modules/quick-lru": {
6279 |       "version": "5.1.1",
6280 |       "resolved": "https://registry.npmjs.org/quick-lru/-/quick-lru-5.1.1.tgz",
6281 |       "integrity": "sha512-WuyALRjWPDGtt/wzJiadO5AXY+8hZ80hVpe6MyivgraREW751X3SbhRvG3eLKOYN+8VEvqLcf3wdnt44Z4S4SA==",
6282 |       "dev": true,
6283 |       "license": "MIT",
6284 |       "engines": {
6285 |         "node": ">=10"
6286 |       },
6287 |       "funding": {
6288 |         "url": "https://github.com/sponsors/sindresorhus"
6289 |       }
6290 |     },
6291 |     "node_modules/randombytes": {
6292 |       "version": "2.1.0",
6293 |       "resolved": "https://registry.npmjs.org/randombytes/-/randombytes-2.1.0.tgz",
6294 |       "integrity": "sha512-vYl3iOX+4CKUWuxGi9Ukhie6fsqXqS9FE2Zaic4tNFD2N2QQaXOMFbuKK4QmDHC0JO6B1Zp41J0LpT0oR68amQ==",
6295 |       "dev": true,
6296 |       "license": "MIT",
6297 |       "dependencies": {
6298 |         "safe-buffer": "^5.1.0"
6299 |       }
6300 |     },
6301 |     "node_modules/rc": {
6302 |       "version": "1.2.8",
6303 |       "resolved": "https://registry.npmjs.org/rc/-/rc-1.2.8.tgz",
6304 |       "integrity": "sha512-y3bGgqKj3QBdxLbLkomlohkvsA8gdAiUQlSBJnBhfn+BPxg4bc62d8TcBW15wavDfgexCgccckhcZvywyQYPOw==",
6305 |       "dev": true,
6306 |       "license": "(BSD-2-Clause OR MIT OR Apache-2.0)",
6307 |       "dependencies": {
6308 |         "deep-extend": "^0.6.0",
6309 |         "ini": "~1.3.0",
6310 |         "minimist": "^1.2.0",
6311 |         "strip-json-comments": "~2.0.1"
6312 |       },
6313 |       "bin": {
6314 |         "rc": "cli.js"
6315 |       }
6316 |     },
6317 |     "node_modules/readable-stream": {
6318 |       "version": "2.3.8",
6319 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-2.3.8.tgz",
6320 |       "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
6321 |       "dev": true,
6322 |       "license": "MIT",
6323 |       "dependencies": {
6324 |         "core-util-is": "~1.0.0",
6325 |         "inherits": "~2.0.3",
6326 |         "isarray": "~1.0.0",
6327 |         "process-nextick-args": "~2.0.0",
6328 |         "safe-buffer": "~5.1.1",
6329 |         "string_decoder": "~1.1.1",
6330 |         "util-deprecate": "~1.0.1"
6331 |       }
6332 |     },
6333 |     "node_modules/readdir-glob": {
6334 |       "version": "1.1.3",
6335 |       "resolved": "https://registry.npmjs.org/readdir-glob/-/readdir-glob-1.1.3.tgz",
6336 |       "integrity": "sha512-v05I2k7xN8zXvPD9N+z/uhXPaj0sUFCe2rcWZIpBsqxfP7xXFQ0tipAd/wjj1YxWyWtUS5IDJpOG82JKt2EAVA==",
6337 |       "dev": true,
6338 |       "license": "Apache-2.0",
6339 |       "dependencies": {
6340 |         "minimatch": "^5.1.0"
6341 |       }
6342 |     },
6343 |     "node_modules/readdir-glob/node_modules/brace-expansion": {
6344 |       "version": "2.0.2",
6345 |       "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.2.tgz",
6346 |       "integrity": "sha512-Jt0vHyM+jmUBqojB7E1NIYadt0vI0Qxjxd2TErW94wDz+E2LAm5vKMXXwg6ZZBTHPuUlDgQHKXvjGBdfcF1ZDQ==",
6347 |       "dev": true,
6348 |       "license": "MIT",
6349 |       "dependencies": {
6350 |         "balanced-match": "^1.0.0"
6351 |       }
6352 |     },
6353 |     "node_modules/readdir-glob/node_modules/minimatch": {
6354 |       "version": "5.1.6",
6355 |       "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-5.1.6.tgz",
6356 |       "integrity": "sha512-lKwV/1brpG6mBUFHtb7NUmtABCb2WZZmm2wNiOA5hAb8VdCS4B3dtMWyvcoViccwAW/COERjXLt0zP1zXUN26g==",
6357 |       "dev": true,
6358 |       "license": "ISC",
6359 |       "dependencies": {
6360 |         "brace-expansion": "^2.0.1"
6361 |       },
6362 |       "engines": {
6363 |         "node": ">=10"
6364 |       }
6365 |     },
6366 |     "node_modules/rechoir": {
6367 |       "version": "0.8.0",
6368 |       "resolved": "https://registry.npmjs.org/rechoir/-/rechoir-0.8.0.tgz",
6369 |       "integrity": "sha512-/vxpCXddiX8NGfGO/mTafwjq4aFa/71pvamip0++IQk3zG8cbCj0fifNPrjjF1XMXUne91jL9OoxmdykoEtifQ==",
6370 |       "dev": true,
6371 |       "license": "MIT",
6372 |       "dependencies": {
6373 |         "resolve": "^1.20.0"
6374 |       },
6375 |       "engines": {
6376 |         "node": ">= 10.13.0"
6377 |       }
6378 |     },
6379 |     "node_modules/require-directory": {
6380 |       "version": "2.1.1",
6381 |       "resolved": "https://registry.npmjs.org/require-directory/-/require-directory-2.1.1.tgz",
6382 |       "integrity": "sha512-fGxEI7+wsG9xrvdjsrlmL22OMTTiHRwAMroiEeMgq8gzoLC/PQr7RsRDSTLUg/bZAZtF+TVIkHc6/4RIKrui+Q==",
6383 |       "license": "MIT",
6384 |       "engines": {
6385 |         "node": ">=0.10.0"
6386 |       }
6387 |     },
6388 |     "node_modules/require-from-string": {
6389 |       "version": "2.0.2",
6390 |       "resolved": "https://registry.npmjs.org/require-from-string/-/require-from-string-2.0.2.tgz",
6391 |       "integrity": "sha512-Xf0nWe6RseziFMu+Ap9biiUbmplq6S9/p+7w7YXP/JBHhrUDDUhwa+vANyubuqfZWTveU//DYVGsDG7RKL/vEw==",
6392 |       "dev": true,
6393 |       "license": "MIT",
6394 |       "engines": {
6395 |         "node": ">=0.10.0"
6396 |       }
6397 |     },
6398 |     "node_modules/resolve": {
6399 |       "version": "1.22.11",
6400 |       "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.11.tgz",
6401 |       "integrity": "sha512-RfqAvLnMl313r7c9oclB1HhUEAezcpLjz95wFH4LVuhk9JF/r22qmVP9AMmOU4vMX7Q8pN8jwNg/CSpdFnMjTQ==",
6402 |       "dev": true,
6403 |       "license": "MIT",
6404 |       "dependencies": {
6405 |         "is-core-module": "^2.16.1",
6406 |         "path-parse": "^1.0.7",
6407 |         "supports-preserve-symlinks-flag": "^1.0.0"
6408 |       },
6409 |       "bin": {
6410 |         "resolve": "bin/resolve"
6411 |       },
6412 |       "engines": {
6413 |         "node": ">= 0.4"
6414 |       },
6415 |       "funding": {
6416 |         "url": "https://github.com/sponsors/ljharb"
6417 |       }
6418 |     },
6419 |     "node_modules/resolve-alpn": {
6420 |       "version": "1.2.1",
6421 |       "resolved": "https://registry.npmjs.org/resolve-alpn/-/resolve-alpn-1.2.1.tgz",
6422 |       "integrity": "sha512-0a1F4l73/ZFZOakJnQ3FvkJ2+gSTQWz/r2KE5OdDY0TxPm5h4GkqkWWfM47T7HsbnOtcJVEF4epCVy6u7Q3K+g==",
6423 |       "dev": true,
6424 |       "license": "MIT"
6425 |     },
6426 |     "node_modules/resolve-cwd": {
6427 |       "version": "3.0.0",
6428 |       "resolved": "https://registry.npmjs.org/resolve-cwd/-/resolve-cwd-3.0.0.tgz",
6429 |       "integrity": "sha512-OrZaX2Mb+rJCpH/6CpSqt9xFVpN++x01XnN2ie9g6P5/3xelLAkXWVADpdz1IHD/KFfEXyE6V0U01OQ3UO2rEg==",
6430 |       "dev": true,
6431 |       "license": "MIT",
6432 |       "dependencies": {
6433 |         "resolve-from": "^5.0.0"
6434 |       },
6435 |       "engines": {
6436 |         "node": ">=8"
6437 |       }
6438 |     },
6439 |     "node_modules/resolve-cwd/node_modules/resolve-from": {
6440 |       "version": "5.0.0",
6441 |       "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-5.0.0.tgz",
6442 |       "integrity": "sha512-qYg9KP24dD5qka9J47d0aVky0N+b4fTU89LN9iDnjB5waksiC49rvMB0PrUJQGoTmH50XPiqOvAjDfaijGxYZw==",
6443 |       "dev": true,
6444 |       "license": "MIT",
6445 |       "engines": {
6446 |         "node": ">=8"
6447 |       }
6448 |     },
6449 |     "node_modules/resolve-dependencies": {
6450 |       "version": "6.0.9",
6451 |       "resolved": "https://registry.npmjs.org/resolve-dependencies/-/resolve-dependencies-6.0.9.tgz",
6452 |       "integrity": "sha512-1BfxvQZyAjSC3Kkcov3ZhHQiLaXVWX1dhFjWyyrPA5yb9yeW9aSC8GQP6TtkJImM7XvitN7kHrLcQxG+1VU7Gg==",
6453 |       "dev": true,
6454 |       "license": "MIT",
6455 |       "dependencies": {
6456 |         "enhanced-resolve": "^5.12.0",
6457 |         "fast-glob": "^3.2.12",
6458 |         "meriyah": "^4.3.5"
6459 |       }
6460 |     },
6461 |     "node_modules/resolve-from": {
6462 |       "version": "4.0.0",
6463 |       "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
6464 |       "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
6465 |       "license": "MIT",
6466 |       "engines": {
6467 |         "node": ">=4"
6468 |       }
6469 |     },
6470 |     "node_modules/resolve/node_modules/is-core-module": {
6471 |       "version": "2.16.1",
6472 |       "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.16.1.tgz",
6473 |       "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
6474 |       "dev": true,
6475 |       "license": "MIT",
6476 |       "dependencies": {
6477 |         "hasown": "^2.0.2"
6478 |       },
6479 |       "engines": {
6480 |         "node": ">= 0.4"
6481 |       },
6482 |       "funding": {
6483 |         "url": "https://github.com/sponsors/ljharb"
6484 |       }
6485 |     },
6486 |     "node_modules/responselike": {
6487 |       "version": "3.0.0",
6488 |       "resolved": "https://registry.npmjs.org/responselike/-/responselike-3.0.0.tgz",
6489 |       "integrity": "sha512-40yHxbNcl2+rzXvZuVkrYohathsSJlMTXKryG5y8uciHv1+xDLHQpgjG64JUO9nrEq2jGLH6IZ8BcZyw3wrweg==",
6490 |       "dev": true,
6491 |       "license": "MIT",
6492 |       "dependencies": {
6493 |         "lowercase-keys": "^3.0.0"
6494 |       },
6495 |       "engines": {
6496 |         "node": ">=14.16"
6497 |       },
6498 |       "funding": {
6499 |         "url": "https://github.com/sponsors/sindresorhus"
6500 |       }
6501 |     },
6502 |     "node_modules/restore-cursor": {
6503 |       "version": "2.0.0",
6504 |       "resolved": "https://registry.npmjs.org/restore-cursor/-/restore-cursor-2.0.0.tgz",
6505 |       "integrity": "sha512-6IzJLuGi4+R14vwagDHX+JrXmPVtPpn4mffDJ1UdR7/Edm87fl6yi8mMBIVvFtJaNTUvjughmW4hwLhRG7gC1Q==",
6506 |       "dev": true,
6507 |       "license": "MIT",
6508 |       "dependencies": {
6509 |         "onetime": "^2.0.0",
6510 |         "signal-exit": "^3.0.2"
6511 |       },
6512 |       "engines": {
6513 |         "node": ">=4"
6514 |       }
6515 |     },
6516 |     "node_modules/reusify": {
6517 |       "version": "1.1.0",
6518 |       "resolved": "https://registry.npmjs.org/reusify/-/reusify-1.1.0.tgz",
6519 |       "integrity": "sha512-g6QUff04oZpHs0eG5p83rFLhHeV00ug/Yf9nZM6fLeUrPguBTkTQOdpAWWspMh55TZfVQDPaN3NQJfbVRAxdIw==",
6520 |       "dev": true,
6521 |       "license": "MIT",
6522 |       "engines": {
6523 |         "iojs": ">=1.0.0",
6524 |         "node": ">=0.10.0"
6525 |       }
6526 |     },
6527 |     "node_modules/rimraf": {
6528 |       "version": "3.0.2",
6529 |       "resolved": "https://registry.npmjs.org/rimraf/-/rimraf-3.0.2.tgz",
6530 |       "integrity": "sha512-JZkJMZkAGFFPP2YqXZXPbMlMBgsxzE8ILs4lMIX/2o0L9UBw9O/Y3o6wFw/i9YLapcUJWwqbi3kdxIPdC62TIA==",
6531 |       "deprecated": "Rimraf versions prior to v4 are no longer supported",
6532 |       "license": "ISC",
6533 |       "dependencies": {
6534 |         "glob": "^7.1.3"
6535 |       },
6536 |       "bin": {
6537 |         "rimraf": "bin.js"
6538 |       },
6539 |       "funding": {
6540 |         "url": "https://github.com/sponsors/isaacs"
6541 |       }
6542 |     },
6543 |     "node_modules/run-parallel": {
6544 |       "version": "1.2.0",
6545 |       "resolved": "https://registry.npmjs.org/run-parallel/-/run-parallel-1.2.0.tgz",
6546 |       "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
6547 |       "dev": true,
6548 |       "funding": [
6549 |         {
6550 |           "type": "github",
6551 |           "url": "https://github.com/sponsors/feross"
6552 |         },
6553 |         {
6554 |           "type": "patreon",
6555 |           "url": "https://www.patreon.com/feross"
6556 |         },
6557 |         {
6558 |           "type": "consulting",
6559 |           "url": "https://feross.org/support"
6560 |         }
6561 |       ],
6562 |       "license": "MIT",
6563 |       "dependencies": {
6564 |         "queue-microtask": "^1.2.2"
6565 |       }
6566 |     },
6567 |     "node_modules/run-script-os": {
6568 |       "version": "1.1.6",
6569 |       "resolved": "https://registry.npmjs.org/run-script-os/-/run-script-os-1.1.6.tgz",
6570 |       "integrity": "sha512-ql6P2LzhBTTDfzKts+Qo4H94VUKpxKDFz6QxxwaUZN0mwvi7L3lpOI7BqPCq7lgDh3XLl0dpeXwfcVIitlrYrw==",
6571 |       "dev": true,
6572 |       "license": "MIT",
6573 |       "bin": {
6574 |         "run-os": "index.js",
6575 |         "run-script-os": "index.js"
6576 |       }
6577 |     },
6578 |     "node_modules/safe-buffer": {
6579 |       "version": "5.1.2",
6580 |       "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
6581 |       "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
6582 |       "dev": true,
6583 |       "license": "MIT"
6584 |     },
6585 |     "node_modules/safer-buffer": {
6586 |       "version": "2.1.2",
6587 |       "resolved": "https://registry.npmjs.org/safer-buffer/-/safer-buffer-2.1.2.tgz",
6588 |       "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
6589 |       "dev": true,
6590 |       "license": "MIT"
6591 |     },
6592 |     "node_modules/schema-utils": {
6593 |       "version": "4.3.3",
6594 |       "resolved": "https://registry.npmjs.org/schema-utils/-/schema-utils-4.3.3.tgz",
6595 |       "integrity": "sha512-eflK8wEtyOE6+hsaRVPxvUKYCpRgzLqDTb8krvAsRIwOGlHoSgYLgBXoubGgLd2fT41/OUYdb48v4k4WWHQurA==",
6596 |       "dev": true,
6597 |       "license": "MIT",
6598 |       "dependencies": {
6599 |         "@types/json-schema": "^7.0.9",
6600 |         "ajv": "^8.9.0",
6601 |         "ajv-formats": "^2.1.1",
6602 |         "ajv-keywords": "^5.1.0"
6603 |       },
6604 |       "engines": {
6605 |         "node": ">= 10.13.0"
6606 |       },
6607 |       "funding": {
6608 |         "type": "opencollective",
6609 |         "url": "https://opencollective.com/webpack"
6610 |       }
6611 |     },
6612 |     "node_modules/seek-bzip": {
6613 |       "version": "1.0.6",
6614 |       "resolved": "https://registry.npmjs.org/seek-bzip/-/seek-bzip-1.0.6.tgz",
6615 |       "integrity": "sha512-e1QtP3YL5tWww8uKaOCQ18UxIT2laNBXHjV/S2WYCiK4udiv8lkG89KRIoCjUagnAmCBurjF4zEVX2ByBbnCjQ==",
6616 |       "dev": true,
6617 |       "license": "MIT",
6618 |       "dependencies": {
6619 |         "commander": "^2.8.1"
6620 |       },
6621 |       "bin": {
6622 |         "seek-bunzip": "bin/seek-bunzip",
6623 |         "seek-table": "bin/seek-bzip-table"
6624 |       }
6625 |     },
6626 |     "node_modules/semver": {
6627 |       "version": "7.7.3",
6628 |       "resolved": "https://registry.npmjs.org/semver/-/semver-7.7.3.tgz",
6629 |       "integrity": "sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==",
6630 |       "license": "ISC",
6631 |       "bin": {
6632 |         "semver": "bin/semver.js"
6633 |       },
6634 |       "engines": {
6635 |         "node": ">=10"
6636 |       }
6637 |     },
6638 |     "node_modules/serialize-javascript": {
6639 |       "version": "6.0.2",
6640 |       "resolved": "https://registry.npmjs.org/serialize-javascript/-/serialize-javascript-6.0.2.tgz",
6641 |       "integrity": "sha512-Saa1xPByTTq2gdeFZYLLo+RFE35NHZkAbqZeWNd3BpzppeVisAqpDjcp8dyf6uIvEqJRd46jemmyA4iFIeVk8g==",
6642 |       "dev": true,
6643 |       "license": "BSD-3-Clause",
6644 |       "dependencies": {
6645 |         "randombytes": "^2.1.0"
6646 |       }
6647 |     },
6648 |     "node_modules/set-function-length": {
6649 |       "version": "1.2.2",
6650 |       "resolved": "https://registry.npmjs.org/set-function-length/-/set-function-length-1.2.2.tgz",
6651 |       "integrity": "sha512-pgRc4hJ4/sNjWCSS9AmnS40x3bNMDTknHgL5UaMBTMyJnU90EgWh1Rz+MC9eFu4BuN/UwZjKQuY/1v3rM7HMfg==",
6652 |       "dev": true,
6653 |       "license": "MIT",
6654 |       "dependencies": {
6655 |         "define-data-property": "^1.1.4",
6656 |         "es-errors": "^1.3.0",
6657 |         "function-bind": "^1.1.2",
6658 |         "get-intrinsic": "^1.2.4",
6659 |         "gopd": "^1.0.1",
6660 |         "has-property-descriptors": "^1.0.2"
6661 |       },
6662 |       "engines": {
6663 |         "node": ">= 0.4"
6664 |       }
6665 |     },
6666 |     "node_modules/shallow-clone": {
6667 |       "version": "3.0.1",
6668 |       "resolved": "https://registry.npmjs.org/shallow-clone/-/shallow-clone-3.0.1.tgz",
6669 |       "integrity": "sha512-/6KqX+GVUdqPuPPd2LxDDxzX6CAbjJehAAOKlNpqqUpAqPM6HeL8f+o3a+JsyGjn2lv0WY8UsTgUJjU9Ok55NA==",
6670 |       "dev": true,
6671 |       "license": "MIT",
6672 |       "dependencies": {
6673 |         "kind-of": "^6.0.2"
6674 |       },
6675 |       "engines": {
6676 |         "node": ">=8"
6677 |       }
6678 |     },
6679 |     "node_modules/shebang-command": {
6680 |       "version": "2.0.0",
6681 |       "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz",
6682 |       "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
6683 |       "dev": true,
6684 |       "license": "MIT",
6685 |       "dependencies": {
6686 |         "shebang-regex": "^3.0.0"
6687 |       },
6688 |       "engines": {
6689 |         "node": ">=8"
6690 |       }
6691 |     },
6692 |     "node_modules/shebang-regex": {
6693 |       "version": "3.0.0",
6694 |       "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-3.0.0.tgz",
6695 |       "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
6696 |       "dev": true,
6697 |       "license": "MIT",
6698 |       "engines": {
6699 |         "node": ">=8"
6700 |       }
6701 |     },
6702 |     "node_modules/signal-exit": {
6703 |       "version": "3.0.7",
6704 |       "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
6705 |       "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==",
6706 |       "dev": true,
6707 |       "license": "ISC"
6708 |     },
6709 |     "node_modules/simple-concat": {
6710 |       "version": "1.0.1",
6711 |       "resolved": "https://registry.npmjs.org/simple-concat/-/simple-concat-1.0.1.tgz",
6712 |       "integrity": "sha512-cSFtAPtRhljv69IK0hTVZQ+OfE9nePi/rtJmw5UjHeVyVroEqJXP1sFztKUy1qU+xvz3u/sfYJLa947b7nAN2Q==",
6713 |       "dev": true,
6714 |       "funding": [
6715 |         {
6716 |           "type": "github",
6717 |           "url": "https://github.com/sponsors/feross"
6718 |         },
6719 |         {
6720 |           "type": "patreon",
6721 |           "url": "https://www.patreon.com/feross"
6722 |         },
6723 |         {
6724 |           "type": "consulting",
6725 |           "url": "https://feross.org/support"
6726 |         }
6727 |       ],
6728 |       "license": "MIT"
6729 |     },
6730 |     "node_modules/simple-get": {
6731 |       "version": "4.0.1",
6732 |       "resolved": "https://registry.npmjs.org/simple-get/-/simple-get-4.0.1.tgz",
6733 |       "integrity": "sha512-brv7p5WgH0jmQJr1ZDDfKDOSeWWg+OVypG99A/5vYGPqJ6pxiaHLy8nxtFjBA7oMa01ebA9gfh1uMCFqOuXxvA==",
6734 |       "dev": true,
6735 |       "funding": [
6736 |         {
6737 |           "type": "github",
6738 |           "url": "https://github.com/sponsors/feross"
6739 |         },
6740 |         {
6741 |           "type": "patreon",
6742 |           "url": "https://www.patreon.com/feross"
6743 |         },
6744 |         {
6745 |           "type": "consulting",
6746 |           "url": "https://feross.org/support"
6747 |         }
6748 |       ],
6749 |       "license": "MIT",
6750 |       "dependencies": {
6751 |         "decompress-response": "^6.0.0",
6752 |         "once": "^1.3.1",
6753 |         "simple-concat": "^1.0.0"
6754 |       }
6755 |     },
6756 |     "node_modules/slash": {
6757 |       "version": "3.0.0",
6758 |       "resolved": "https://registry.npmjs.org/slash/-/slash-3.0.0.tgz",
6759 |       "integrity": "sha512-g9Q1haeby36OSStwb4ntCGGGaKsaVSjQ68fBxoQcutl5fS1vuY18H3wSt3jFyFtrkx+Kz0V1G85A4MyAdDMi2Q==",
6760 |       "dev": true,
6761 |       "license": "MIT",
6762 |       "engines": {
6763 |         "node": ">=8"
6764 |       }
6765 |     },
6766 |     "node_modules/smart-buffer": {
6767 |       "version": "4.2.0",
6768 |       "resolved": "https://registry.npmjs.org/smart-buffer/-/smart-buffer-4.2.0.tgz",
6769 |       "integrity": "sha512-94hK0Hh8rPqQl2xXc3HsaBoOXKV20MToPkcXvwbISWLEs+64sBq5kFgn2kJDHb1Pry9yrP0dxrCI9RRci7RXKg==",
6770 |       "license": "MIT",
6771 |       "engines": {
6772 |         "node": ">= 6.0.0",
6773 |         "npm": ">= 3.0.0"
6774 |       }
6775 |     },
6776 |     "node_modules/socks": {
6777 |       "version": "2.8.7",
6778 |       "resolved": "https://registry.npmjs.org/socks/-/socks-2.8.7.tgz",
6779 |       "integrity": "sha512-HLpt+uLy/pxB+bum/9DzAgiKS8CX1EvbWxI4zlmgGCExImLdiad2iCwXT5Z4c9c3Eq8rP2318mPW2c+QbtjK8A==",
6780 |       "license": "MIT",
6781 |       "dependencies": {
6782 |         "ip-address": "^10.0.1",
6783 |         "smart-buffer": "^4.2.0"
6784 |       },
6785 |       "engines": {
6786 |         "node": ">= 10.0.0",
6787 |         "npm": ">= 3.0.0"
6788 |       }
6789 |     },
6790 |     "node_modules/socks-proxy-agent": {
6791 |       "version": "8.0.5",
6792 |       "resolved": "https://registry.npmjs.org/socks-proxy-agent/-/socks-proxy-agent-8.0.5.tgz",
6793 |       "integrity": "sha512-HehCEsotFqbPW9sJ8WVYB6UbmIMv7kUUORIF2Nncq4VQvBfNBLibW9YZR5dlYCSUhwcD628pRllm7n+E+YTzJw==",
6794 |       "license": "MIT",
6795 |       "dependencies": {
6796 |         "agent-base": "^7.1.2",
6797 |         "debug": "^4.3.4",
6798 |         "socks": "^2.8.3"
6799 |       },
6800 |       "engines": {
6801 |         "node": ">= 14"
6802 |       }
6803 |     },
6804 |     "node_modules/sort-keys": {
6805 |       "version": "1.1.2",
6806 |       "resolved": "https://registry.npmjs.org/sort-keys/-/sort-keys-1.1.2.tgz",
6807 |       "integrity": "sha512-vzn8aSqKgytVik0iwdBEi+zevbTYZogewTUM6dtpmGwEcdzbub/TX4bCzRhebDCRC3QzXgJsLRKB2V/Oof7HXg==",
6808 |       "dev": true,
6809 |       "license": "MIT",
6810 |       "dependencies": {
6811 |         "is-plain-obj": "^1.0.0"
6812 |       },
6813 |       "engines": {
6814 |         "node": ">=0.10.0"
6815 |       }
6816 |     },
6817 |     "node_modules/sort-keys-length": {
6818 |       "version": "1.0.1",
6819 |       "resolved": "https://registry.npmjs.org/sort-keys-length/-/sort-keys-length-1.0.1.tgz",
6820 |       "integrity": "sha512-GRbEOUqCxemTAk/b32F2xa8wDTs+Z1QHOkbhJDQTvv/6G3ZkbJ+frYWsTcc7cBB3Fu4wy4XlLCuNtJuMn7Gsvw==",
6821 |       "dev": true,
6822 |       "license": "MIT",
6823 |       "dependencies": {
6824 |         "sort-keys": "^1.0.0"
6825 |       },
6826 |       "engines": {
6827 |         "node": ">=0.10.0"
6828 |       }
6829 |     },
6830 |     "node_modules/source-map": {
6831 |       "version": "0.6.1",
6832 |       "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.6.1.tgz",
6833 |       "integrity": "sha512-UjgapumWlbMhkBgzT7Ykc5YXUT46F0iKu8SGXq0bcwP5dz/h0Plj6enJqjz1Zbq2l5WaqYnrVbwWOWMyF3F47g==",
6834 |       "devOptional": true,
6835 |       "license": "BSD-3-Clause",
6836 |       "engines": {
6837 |         "node": ">=0.10.0"
6838 |       }
6839 |     },
6840 |     "node_modules/source-map-js": {
6841 |       "version": "1.2.1",
6842 |       "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
6843 |       "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
6844 |       "dev": true,
6845 |       "license": "BSD-3-Clause",
6846 |       "engines": {
6847 |         "node": ">=0.10.0"
6848 |       }
6849 |     },
6850 |     "node_modules/source-map-loader": {
6851 |       "version": "5.0.0",
6852 |       "resolved": "https://registry.npmjs.org/source-map-loader/-/source-map-loader-5.0.0.tgz",
6853 |       "integrity": "sha512-k2Dur7CbSLcAH73sBcIkV5xjPV4SzqO1NJ7+XaQl8if3VODDUj3FNchNGpqgJSKbvUfJuhVdv8K2Eu8/TNl2eA==",
6854 |       "dev": true,
6855 |       "license": "MIT",
6856 |       "dependencies": {
6857 |         "iconv-lite": "^0.6.3",
6858 |         "source-map-js": "^1.0.2"
6859 |       },
6860 |       "engines": {
6861 |         "node": ">= 18.12.0"
6862 |       },
6863 |       "funding": {
6864 |         "type": "opencollective",
6865 |         "url": "https://opencollective.com/webpack"
6866 |       },
6867 |       "peerDependencies": {
6868 |         "webpack": "^5.72.1"
6869 |       }
6870 |     },
6871 |     "node_modules/source-map-support": {
6872 |       "version": "0.5.21",
6873 |       "resolved": "https://registry.npmjs.org/source-map-support/-/source-map-support-0.5.21.tgz",
6874 |       "integrity": "sha512-uBHU3L3czsIyYXKX88fdrGovxdSCoTGDRZ6SYXtSRxLZUzHg5P/66Ht6uoUlHu9EZod+inXhKo3qQgwXUT/y1w==",
6875 |       "dev": true,
6876 |       "license": "MIT",
6877 |       "dependencies": {
6878 |         "buffer-from": "^1.0.0",
6879 |         "source-map": "^0.6.0"
6880 |       }
6881 |     },
6882 |     "node_modules/stream-meter": {
6883 |       "version": "1.0.4",
6884 |       "resolved": "https://registry.npmjs.org/stream-meter/-/stream-meter-1.0.4.tgz",
6885 |       "integrity": "sha512-4sOEtrbgFotXwnEuzzsQBYEV1elAeFSO8rSGeTwabuX1RRn/kEq9JVH7I0MRBhKVRR0sJkr0M0QCH7yOLf9fhQ==",
6886 |       "dev": true,
6887 |       "license": "MIT",
6888 |       "dependencies": {
6889 |         "readable-stream": "^2.1.4"
6890 |       }
6891 |     },
6892 |     "node_modules/streamx": {
6893 |       "version": "2.23.0",
6894 |       "resolved": "https://registry.npmjs.org/streamx/-/streamx-2.23.0.tgz",
6895 |       "integrity": "sha512-kn+e44esVfn2Fa/O0CPFcex27fjIL6MkVae0Mm6q+E6f0hWv578YCERbv+4m02cjxvDsPKLnmxral/rR6lBMAg==",
6896 |       "license": "MIT",
6897 |       "dependencies": {
6898 |         "events-universal": "^1.0.0",
6899 |         "fast-fifo": "^1.3.2",
6900 |         "text-decoder": "^1.1.0"
6901 |       }
6902 |     },
6903 |     "node_modules/strict-uri-encode": {
6904 |       "version": "1.1.0",
6905 |       "resolved": "https://registry.npmjs.org/strict-uri-encode/-/strict-uri-encode-1.1.0.tgz",
6906 |       "integrity": "sha512-R3f198pcvnB+5IpnBlRkphuE9n46WyVl8I39W/ZUTZLz4nqSP/oLYUrcnJrw462Ds8he4YKMov2efsTIw1BDGQ==",
6907 |       "dev": true,
6908 |       "license": "MIT",
6909 |       "engines": {
6910 |         "node": ">=0.10.0"
6911 |       }
6912 |     },
6913 |     "node_modules/string_decoder": {
6914 |       "version": "1.1.1",
6915 |       "resolved": "https://registry.npmjs.org/string_decoder/-/string_decoder-1.1.1.tgz",
6916 |       "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
6917 |       "dev": true,
6918 |       "license": "MIT",
6919 |       "dependencies": {
6920 |         "safe-buffer": "~5.1.0"
6921 |       }
6922 |     },
6923 |     "node_modules/string-replace-loader": {
6924 |       "version": "3.3.0",
6925 |       "resolved": "https://registry.npmjs.org/string-replace-loader/-/string-replace-loader-3.3.0.tgz",
6926 |       "integrity": "sha512-AZ3y7ktSHhd/Ebipczkp6vdfp01d2kQVwFujCGAgmogTB8t4dRhbsRGDKnyZAYqBbIA9QW7+D/IsACVJOOpcBg==",
6927 |       "dev": true,
6928 |       "license": "MIT",
6929 |       "dependencies": {
6930 |         "schema-utils": "^4"
6931 |       },
6932 |       "engines": {
6933 |         "node": ">=4"
6934 |       },
6935 |       "peerDependencies": {
6936 |         "webpack": "^5"
6937 |       }
6938 |     },
6939 |     "node_modules/string-width": {
6940 |       "version": "4.2.3",
6941 |       "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
6942 |       "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
6943 |       "license": "MIT",
6944 |       "dependencies": {
6945 |         "emoji-regex": "^8.0.0",
6946 |         "is-fullwidth-code-point": "^3.0.0",
6947 |         "strip-ansi": "^6.0.1"
6948 |       },
6949 |       "engines": {
6950 |         "node": ">=8"
6951 |       }
6952 |     },
6953 |     "node_modules/strip-ansi": {
6954 |       "version": "6.0.1",
6955 |       "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
6956 |       "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
6957 |       "license": "MIT",
6958 |       "dependencies": {
6959 |         "ansi-regex": "^5.0.1"
6960 |       },
6961 |       "engines": {
6962 |         "node": ">=8"
6963 |       }
6964 |     },
6965 |     "node_modules/strip-dirs": {
6966 |       "version": "2.1.0",
6967 |       "resolved": "https://registry.npmjs.org/strip-dirs/-/strip-dirs-2.1.0.tgz",
6968 |       "integrity": "sha512-JOCxOeKLm2CAS73y/U4ZeZPTkE+gNVCzKt7Eox84Iej1LT/2pTWYpZKJuxwQpvX1LiZb1xokNR7RLfuBAa7T3g==",
6969 |       "dev": true,
6970 |       "license": "MIT",
6971 |       "dependencies": {
6972 |         "is-natural-number": "^4.0.1"
6973 |       }
6974 |     },
6975 |     "node_modules/strip-json-comments": {
6976 |       "version": "2.0.1",
6977 |       "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-2.0.1.tgz",
6978 |       "integrity": "sha512-4gB8na07fecVVkOI6Rs4e7T6NOTki5EmL7TUduTs6bu3EdnSycntVJ4re8kgZA+wx9IueI2Y11bfbgwtzuE0KQ==",
6979 |       "dev": true,
6980 |       "license": "MIT",
6981 |       "engines": {
6982 |         "node": ">=0.10.0"
6983 |       }
6984 |     },
6985 |     "node_modules/strip-outer": {
6986 |       "version": "1.0.1",
6987 |       "resolved": "https://registry.npmjs.org/strip-outer/-/strip-outer-1.0.1.tgz",
6988 |       "integrity": "sha512-k55yxKHwaXnpYGsOzg4Vl8+tDrWylxDEpknGjhTiZB8dFRU5rTo9CAzeycivxV3s+zlTKwrs6WxMxR95n26kwg==",
6989 |       "dev": true,
6990 |       "license": "MIT",
6991 |       "dependencies": {
6992 |         "escape-string-regexp": "^1.0.2"
6993 |       },
6994 |       "engines": {
6995 |         "node": ">=0.10.0"
6996 |       }
6997 |     },
6998 |     "node_modules/supports-color": {
6999 |       "version": "7.2.0",
7000 |       "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-7.2.0.tgz",
7001 |       "integrity": "sha512-qpCAvRl9stuOHveKsn7HncJRvv501qIacKzQlO/+Lwxc9+0q2wLyv4Dfvt80/DPn2pqOBsJdDiogXGR9+OvwRw==",
7002 |       "dev": true,
7003 |       "license": "MIT",
7004 |       "dependencies": {
7005 |         "has-flag": "^4.0.0"
7006 |       },
7007 |       "engines": {
7008 |         "node": ">=8"
7009 |       }
7010 |     },
7011 |     "node_modules/supports-preserve-symlinks-flag": {
7012 |       "version": "1.0.0",
7013 |       "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
7014 |       "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
7015 |       "dev": true,
7016 |       "license": "MIT",
7017 |       "engines": {
7018 |         "node": ">= 0.4"
7019 |       },
7020 |       "funding": {
7021 |         "url": "https://github.com/sponsors/ljharb"
7022 |       }
7023 |     },
7024 |     "node_modules/tapable": {
7025 |       "version": "2.3.0",
7026 |       "resolved": "https://registry.npmjs.org/tapable/-/tapable-2.3.0.tgz",
7027 |       "integrity": "sha512-g9ljZiwki/LfxmQADO3dEY1CbpmXT5Hm2fJ+QaGKwSXUylMybePR7/67YW7jOrrvjEgL1Fmz5kzyAjWVWLlucg==",
7028 |       "dev": true,
7029 |       "license": "MIT",
7030 |       "engines": {
7031 |         "node": ">=6"
7032 |       },
7033 |       "funding": {
7034 |         "type": "opencollective",
7035 |         "url": "https://opencollective.com/webpack"
7036 |       }
7037 |     },
7038 |     "node_modules/tar": {
7039 |       "version": "7.5.2",
7040 |       "resolved": "https://registry.npmjs.org/tar/-/tar-7.5.2.tgz",
7041 |       "integrity": "sha512-7NyxrTE4Anh8km8iEy7o0QYPs+0JKBTj5ZaqHg6B39erLg0qYXN3BijtShwbsNSvQ+LN75+KV+C4QR/f6Gwnpg==",
7042 |       "dev": true,
7043 |       "license": "BlueOak-1.0.0",
7044 |       "dependencies": {
7045 |         "@isaacs/fs-minipass": "^4.0.0",
7046 |         "chownr": "^3.0.0",
7047 |         "minipass": "^7.1.2",
7048 |         "minizlib": "^3.1.0",
7049 |         "yallist": "^5.0.0"
7050 |       },
7051 |       "engines": {
7052 |         "node": ">=18"
7053 |       }
7054 |     },
7055 |     "node_modules/tar-fs": {
7056 |       "version": "3.1.1",
7057 |       "resolved": "https://registry.npmjs.org/tar-fs/-/tar-fs-3.1.1.tgz",
7058 |       "integrity": "sha512-LZA0oaPOc2fVo82Txf3gw+AkEd38szODlptMYejQUhndHMLQ9M059uXR+AfS7DNo0NpINvSqDsvyaCrBVkptWg==",
7059 |       "license": "MIT",
7060 |       "dependencies": {
7061 |         "pump": "^3.0.0",
7062 |         "tar-stream": "^3.1.5"
7063 |       },
7064 |       "optionalDependencies": {
7065 |         "bare-fs": "^4.0.1",
7066 |         "bare-path": "^3.0.0"
7067 |       }
7068 |     },
7069 |     "node_modules/tar-stream": {
7070 |       "version": "3.1.7",
7071 |       "resolved": "https://registry.npmjs.org/tar-stream/-/tar-stream-3.1.7.tgz",
7072 |       "integrity": "sha512-qJj60CXt7IU1Ffyc3NJMjh6EkuCFej46zUqJ4J7pqYlThyd9bO0XBTmcOIhSzZJVWfsLks0+nle/j538YAW9RQ==",
7073 |       "license": "MIT",
7074 |       "dependencies": {
7075 |         "b4a": "^1.6.4",
7076 |         "fast-fifo": "^1.2.0",
7077 |         "streamx": "^2.15.0"
7078 |       }
7079 |     },
7080 |     "node_modules/tar/node_modules/chownr": {
7081 |       "version": "3.0.0",
7082 |       "resolved": "https://registry.npmjs.org/chownr/-/chownr-3.0.0.tgz",
7083 |       "integrity": "sha512-+IxzY9BZOQd/XuYPRmrvEVjF/nqj5kgT4kEq7VofrDoM1MxoRjEWkrCC3EtLi59TVawxTAn+orJwFQcrqEN1+g==",
7084 |       "dev": true,
7085 |       "license": "BlueOak-1.0.0",
7086 |       "engines": {
7087 |         "node": ">=18"
7088 |       }
7089 |     },
7090 |     "node_modules/terser": {
7091 |       "version": "5.44.1",
7092 |       "resolved": "https://registry.npmjs.org/terser/-/terser-5.44.1.tgz",
7093 |       "integrity": "sha512-t/R3R/n0MSwnnazuPpPNVO60LX0SKL45pyl9YlvxIdkH0Of7D5qM2EVe+yASRIlY5pZ73nclYJfNANGWPwFDZw==",
7094 |       "dev": true,
7095 |       "license": "BSD-2-Clause",
7096 |       "dependencies": {
7097 |         "@jridgewell/source-map": "^0.3.3",
7098 |         "acorn": "^8.15.0",
7099 |         "commander": "^2.20.0",
7100 |         "source-map-support": "~0.5.20"
7101 |       },
7102 |       "bin": {
7103 |         "terser": "bin/terser"
7104 |       },
7105 |       "engines": {
7106 |         "node": ">=10"
7107 |       }
7108 |     },
7109 |     "node_modules/terser-webpack-plugin": {
7110 |       "version": "5.3.16",
7111 |       "resolved": "https://registry.npmjs.org/terser-webpack-plugin/-/terser-webpack-plugin-5.3.16.tgz",
7112 |       "integrity": "sha512-h9oBFCWrq78NyWWVcSwZarJkZ01c2AyGrzs1crmHZO3QUg9D61Wu4NPjBy69n7JqylFF5y+CsUZYmYEIZ3mR+Q==",
7113 |       "dev": true,
7114 |       "license": "MIT",
7115 |       "dependencies": {
7116 |         "@jridgewell/trace-mapping": "^0.3.25",
7117 |         "jest-worker": "^27.4.5",
7118 |         "schema-utils": "^4.3.0",
7119 |         "serialize-javascript": "^6.0.2",
7120 |         "terser": "^5.31.1"
7121 |       },
7122 |       "engines": {
7123 |         "node": ">= 10.13.0"
7124 |       },
7125 |       "funding": {
7126 |         "type": "opencollective",
7127 |         "url": "https://opencollective.com/webpack"
7128 |       },
7129 |       "peerDependencies": {
7130 |         "webpack": "^5.1.0"
7131 |       },
7132 |       "peerDependenciesMeta": {
7133 |         "@swc/core": {
7134 |           "optional": true
7135 |         },
7136 |         "esbuild": {
7137 |           "optional": true
7138 |         },
7139 |         "uglify-js": {
7140 |           "optional": true
7141 |         }
7142 |       }
7143 |     },
7144 |     "node_modules/text-decoder": {
7145 |       "version": "1.2.3",
7146 |       "resolved": "https://registry.npmjs.org/text-decoder/-/text-decoder-1.2.3.tgz",
7147 |       "integrity": "sha512-3/o9z3X0X0fTupwsYvR03pJ/DjWuqqrfwBgTQzdWDiQSm9KitAyz/9WqsT2JQW7KV2m+bC2ol/zqpW37NHxLaA==",
7148 |       "license": "Apache-2.0",
7149 |       "dependencies": {
7150 |         "b4a": "^1.6.4"
7151 |       }
7152 |     },
7153 |     "node_modules/through": {
7154 |       "version": "2.3.8",
7155 |       "resolved": "https://registry.npmjs.org/through/-/through-2.3.8.tgz",
7156 |       "integrity": "sha512-w89qg7PI8wAdvX60bMDP+bFoD5Dvhm9oLheFp5O4a2QF0cSBGsBX4qZmadPMvVqlLJBBci+WqGGOAPvcDeNSVg==",
7157 |       "dev": true,
7158 |       "license": "MIT"
7159 |     },
7160 |     "node_modules/timed-out": {
7161 |       "version": "4.0.1",
7162 |       "resolved": "https://registry.npmjs.org/timed-out/-/timed-out-4.0.1.tgz",
7163 |       "integrity": "sha512-G7r3AhovYtr5YKOWQkta8RKAPb+J9IsO4uVmzjl8AZwfhs8UcUwTiD6gcJYSgOtzyjvQKrKYn41syHbUWMkafA==",
7164 |       "dev": true,
7165 |       "license": "MIT",
7166 |       "engines": {
7167 |         "node": ">=0.10.0"
7168 |       }
7169 |     },
7170 |     "node_modules/tinyglobby": {
7171 |       "version": "0.2.15",
7172 |       "resolved": "https://registry.npmjs.org/tinyglobby/-/tinyglobby-0.2.15.tgz",
7173 |       "integrity": "sha512-j2Zq4NyQYG5XMST4cbs02Ak8iJUdxRM0XI5QyxXuZOzKOINmWurp3smXu3y5wDcJrptwpSjgXHzIQxR0omXljQ==",
7174 |       "dev": true,
7175 |       "license": "MIT",
7176 |       "dependencies": {
7177 |         "fdir": "^6.5.0",
7178 |         "picomatch": "^4.0.3"
7179 |       },
7180 |       "engines": {
7181 |         "node": ">=12.0.0"
7182 |       },
7183 |       "funding": {
7184 |         "url": "https://github.com/sponsors/SuperchupuDev"
7185 |       }
7186 |     },
7187 |     "node_modules/tinyglobby/node_modules/fdir": {
7188 |       "version": "6.5.0",
7189 |       "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
7190 |       "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
7191 |       "dev": true,
7192 |       "license": "MIT",
7193 |       "engines": {
7194 |         "node": ">=12.0.0"
7195 |       },
7196 |       "peerDependencies": {
7197 |         "picomatch": "^3 || ^4"
7198 |       },
7199 |       "peerDependenciesMeta": {
7200 |         "picomatch": {
7201 |           "optional": true
7202 |         }
7203 |       }
7204 |     },
7205 |     "node_modules/tinyglobby/node_modules/picomatch": {
7206 |       "version": "4.0.3",
7207 |       "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
7208 |       "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
7209 |       "dev": true,
7210 |       "license": "MIT",
7211 |       "peer": true,
7212 |       "engines": {
7213 |         "node": ">=12"
7214 |       },
7215 |       "funding": {
7216 |         "url": "https://github.com/sponsors/jonschlinkert"
7217 |       }
7218 |     },
7219 |     "node_modules/to-buffer": {
7220 |       "version": "1.2.2",
7221 |       "resolved": "https://registry.npmjs.org/to-buffer/-/to-buffer-1.2.2.tgz",
7222 |       "integrity": "sha512-db0E3UJjcFhpDhAF4tLo03oli3pwl3dbnzXOUIlRKrp+ldk/VUxzpWYZENsw2SZiuBjHAk7DfB0VU7NKdpb6sw==",
7223 |       "dev": true,
7224 |       "license": "MIT",
7225 |       "dependencies": {
7226 |         "isarray": "^2.0.5",
7227 |         "safe-buffer": "^5.2.1",
7228 |         "typed-array-buffer": "^1.0.3"
7229 |       },
7230 |       "engines": {
7231 |         "node": ">= 0.4"
7232 |       }
7233 |     },
7234 |     "node_modules/to-buffer/node_modules/isarray": {
7235 |       "version": "2.0.5",
7236 |       "resolved": "https://registry.npmjs.org/isarray/-/isarray-2.0.5.tgz",
7237 |       "integrity": "sha512-xHjhDr3cNBK0BzdUJSPXZntQUx/mwMS5Rw4A7lPJ90XGAO6ISP/ePDNuo0vhqOZU+UD5JoodwCAAoZQd3FeAKw==",
7238 |       "dev": true,
7239 |       "license": "MIT"
7240 |     },
7241 |     "node_modules/to-buffer/node_modules/safe-buffer": {
7242 |       "version": "5.2.1",
7243 |       "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
7244 |       "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
7245 |       "dev": true,
7246 |       "funding": [
7247 |         {
7248 |           "type": "github",
7249 |           "url": "https://github.com/sponsors/feross"
7250 |         },
7251 |         {
7252 |           "type": "patreon",
7253 |           "url": "https://www.patreon.com/feross"
7254 |         },
7255 |         {
7256 |           "type": "consulting",
7257 |           "url": "https://feross.org/support"
7258 |         }
7259 |       ],
7260 |       "license": "MIT"
7261 |     },
7262 |     "node_modules/to-fast-properties": {
7263 |       "version": "2.0.0",
7264 |       "resolved": "https://registry.npmjs.org/to-fast-properties/-/to-fast-properties-2.0.0.tgz",
7265 |       "integrity": "sha512-/OaKK0xYrs3DmxRYqL/yDc+FxFUVYhDlXMhRmv3z915w2HF1tnN1omB354j8VUGO/hbRzyD6Y3sA7v7GS/ceog==",
7266 |       "dev": true,
7267 |       "license": "MIT",
7268 |       "engines": {
7269 |         "node": ">=4"
7270 |       }
7271 |     },
7272 |     "node_modules/to-regex-range": {
7273 |       "version": "5.0.1",
7274 |       "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
7275 |       "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
7276 |       "dev": true,
7277 |       "license": "MIT",
7278 |       "dependencies": {
7279 |         "is-number": "^7.0.0"
7280 |       },
7281 |       "engines": {
7282 |         "node": ">=8.0"
7283 |       }
7284 |     },
7285 |     "node_modules/tr46": {
7286 |       "version": "0.0.3",
7287 |       "resolved": "https://registry.npmjs.org/tr46/-/tr46-0.0.3.tgz",
7288 |       "integrity": "sha512-N3WMsuqV66lT30CrXNbEjx4GEwlow3v6rr4mCcv6prnfwhS01rkgyFdjPNBYd9br7LpXV1+Emh01fHnq2Gdgrw==",
7289 |       "dev": true,
7290 |       "license": "MIT"
7291 |     },
7292 |     "node_modules/trim-repeated": {
7293 |       "version": "1.0.0",
7294 |       "resolved": "https://registry.npmjs.org/trim-repeated/-/trim-repeated-1.0.0.tgz",
7295 |       "integrity": "sha512-pkonvlKk8/ZuR0D5tLW8ljt5I8kmxp2XKymhepUeOdCEfKpZaktSArkLHZt76OB1ZvO9bssUsDty4SWhLvZpLg==",
7296 |       "dev": true,
7297 |       "license": "MIT",
7298 |       "dependencies": {
7299 |         "escape-string-regexp": "^1.0.2"
7300 |       },
7301 |       "engines": {
7302 |         "node": ">=0.10.0"
7303 |       }
7304 |     },
7305 |     "node_modules/ts-loader": {
7306 |       "version": "9.5.4",
7307 |       "resolved": "https://registry.npmjs.org/ts-loader/-/ts-loader-9.5.4.tgz",
7308 |       "integrity": "sha512-nCz0rEwunlTZiy6rXFByQU1kVVpCIgUpc/psFiKVrUwrizdnIbRFu8w7bxhUF0X613DYwT4XzrZHpVyMe758hQ==",
7309 |       "dev": true,
7310 |       "license": "MIT",
7311 |       "dependencies": {
7312 |         "chalk": "^4.1.0",
7313 |         "enhanced-resolve": "^5.0.0",
7314 |         "micromatch": "^4.0.0",
7315 |         "semver": "^7.3.4",
7316 |         "source-map": "^0.7.4"
7317 |       },
7318 |       "engines": {
7319 |         "node": ">=12.0.0"
7320 |       },
7321 |       "peerDependencies": {
7322 |         "typescript": "*",
7323 |         "webpack": "^5.0.0"
7324 |       }
7325 |     },
7326 |     "node_modules/ts-loader/node_modules/source-map": {
7327 |       "version": "0.7.6",
7328 |       "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.7.6.tgz",
7329 |       "integrity": "sha512-i5uvt8C3ikiWeNZSVZNWcfZPItFQOsYTUAOkcUPGd8DqDy1uOUikjt5dG+uRlwyvR108Fb9DOd4GvXfT0N2/uQ==",
7330 |       "dev": true,
7331 |       "license": "BSD-3-Clause",
7332 |       "engines": {
7333 |         "node": ">= 12"
7334 |       }
7335 |     },
7336 |     "node_modules/tslib": {
7337 |       "version": "2.8.1",
7338 |       "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.8.1.tgz",
7339 |       "integrity": "sha512-oJFu94HQb+KVduSUQL7wnpmqnfmLsOA/nAh6b6EH0wCEoK0/mPeXU6c3wKDV83MkOuHPRHtSXKKU99IBazS/2w==",
7340 |       "license": "0BSD"
7341 |     },
7342 |     "node_modules/tunnel-agent": {
7343 |       "version": "0.6.0",
7344 |       "resolved": "https://registry.npmjs.org/tunnel-agent/-/tunnel-agent-0.6.0.tgz",
7345 |       "integrity": "sha512-McnNiV1l8RYeY8tBgEpuodCC1mLUdbSN+CYBL7kJsJNInOP8UjDDEwdk6Mw60vdLLrr5NHKZhMAOSrR2NZuQ+w==",
7346 |       "dev": true,
7347 |       "license": "Apache-2.0",
7348 |       "dependencies": {
7349 |         "safe-buffer": "^5.0.1"
7350 |       },
7351 |       "engines": {
7352 |         "node": "*"
7353 |       }
7354 |     },
7355 |     "node_modules/typed-array-buffer": {
7356 |       "version": "1.0.3",
7357 |       "resolved": "https://registry.npmjs.org/typed-array-buffer/-/typed-array-buffer-1.0.3.tgz",
7358 |       "integrity": "sha512-nAYYwfY3qnzX30IkA6AQZjVbtK6duGontcQm1WSG1MD94YLqK0515GNApXkoxKOWMusVssAHWLh9SeaoefYFGw==",
7359 |       "dev": true,
7360 |       "license": "MIT",
7361 |       "dependencies": {
7362 |         "call-bound": "^1.0.3",
7363 |         "es-errors": "^1.3.0",
7364 |         "is-typed-array": "^1.1.14"
7365 |       },
7366 |       "engines": {
7367 |         "node": ">= 0.4"
7368 |       }
7369 |     },
7370 |     "node_modules/typed-query-selector": {
7371 |       "version": "2.12.0",
7372 |       "resolved": "https://registry.npmjs.org/typed-query-selector/-/typed-query-selector-2.12.0.tgz",
7373 |       "integrity": "sha512-SbklCd1F0EiZOyPiW192rrHZzZ5sBijB6xM+cpmrwDqObvdtunOHHIk9fCGsoK5JVIYXoyEp4iEdE3upFH3PAg==",
7374 |       "license": "MIT"
7375 |     },
7376 |     "node_modules/typescript": {
7377 |       "version": "5.9.3",
7378 |       "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.9.3.tgz",
7379 |       "integrity": "sha512-jl1vZzPDinLr9eUt3J/t7V6FgNEw9QjvBPdysz9KfQDD41fQrC2Y4vKQdiaUpFT4bXlb1RHhLpp8wtm6M5TgSw==",
7380 |       "devOptional": true,
7381 |       "license": "Apache-2.0",
7382 |       "peer": true,
7383 |       "bin": {
7384 |         "tsc": "bin/tsc",
7385 |         "tsserver": "bin/tsserver"
7386 |       },
7387 |       "engines": {
7388 |         "node": ">=14.17"
7389 |       }
7390 |     },
7391 |     "node_modules/unbzip2-stream": {
7392 |       "version": "1.4.3",
7393 |       "resolved": "https://registry.npmjs.org/unbzip2-stream/-/unbzip2-stream-1.4.3.tgz",
7394 |       "integrity": "sha512-mlExGW4w71ebDJviH16lQLtZS32VKqsSfk80GCfUlwT/4/hNRFsoscrF/c++9xinkMzECL1uL9DDwXqFWkruPg==",
7395 |       "dev": true,
7396 |       "license": "MIT",
7397 |       "dependencies": {
7398 |         "buffer": "^5.2.1",
7399 |         "through": "^2.3.8"
7400 |       }
7401 |     },
7402 |     "node_modules/undici-types": {
7403 |       "version": "7.16.0",
7404 |       "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-7.16.0.tgz",
7405 |       "integrity": "sha512-Zz+aZWSj8LE6zoxD+xrjh4VfkIG8Ya6LvYkZqtUQGJPZjYl53ypCaUwWqo7eI0x66KBGeRo+mlBEkMSeSZ38Nw==",
7406 |       "devOptional": true,
7407 |       "license": "MIT"
7408 |     },
7409 |     "node_modules/universalify": {
7410 |       "version": "2.0.1",
7411 |       "resolved": "https://registry.npmjs.org/universalify/-/universalify-2.0.1.tgz",
7412 |       "integrity": "sha512-gptHNQghINnc/vTGIk0SOFGFNXw7JVrlRUtConJRlvaw6DuX0wO5Jeko9sWrMBhh+PsYAZ7oXAiOnf/UKogyiw==",
7413 |       "license": "MIT",
7414 |       "engines": {
7415 |         "node": ">= 10.0.0"
7416 |       }
7417 |     },
7418 |     "node_modules/unzipper": {
7419 |       "version": "0.12.3",
7420 |       "resolved": "https://registry.npmjs.org/unzipper/-/unzipper-0.12.3.tgz",
7421 |       "integrity": "sha512-PZ8hTS+AqcGxsaQntl3IRBw65QrBI6lxzqDEL7IAo/XCEqRTKGfOX56Vea5TH9SZczRVxuzk1re04z/YjuYCJA==",
7422 |       "dev": true,
7423 |       "license": "MIT",
7424 |       "dependencies": {
7425 |         "bluebird": "~3.7.2",
7426 |         "duplexer2": "~0.1.4",
7427 |         "fs-extra": "^11.2.0",
7428 |         "graceful-fs": "^4.2.2",
7429 |         "node-int64": "^0.4.0"
7430 |       }
7431 |     },
7432 |     "node_modules/unzipper/node_modules/fs-extra": {
7433 |       "version": "11.3.3",
7434 |       "resolved": "https://registry.npmjs.org/fs-extra/-/fs-extra-11.3.3.tgz",
7435 |       "integrity": "sha512-VWSRii4t0AFm6ixFFmLLx1t7wS1gh+ckoa84aOeapGum0h+EZd1EhEumSB+ZdDLnEPuucsVB9oB7cxJHap6Afg==",
7436 |       "dev": true,
7437 |       "license": "MIT",
7438 |       "dependencies": {
7439 |         "graceful-fs": "^4.2.0",
7440 |         "jsonfile": "^6.0.1",
7441 |         "universalify": "^2.0.0"
7442 |       },
7443 |       "engines": {
7444 |         "node": ">=14.14"
7445 |       }
7446 |     },
7447 |     "node_modules/update-browserslist-db": {
7448 |       "version": "1.2.3",
7449 |       "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.2.3.tgz",
7450 |       "integrity": "sha512-Js0m9cx+qOgDxo0eMiFGEueWztz+d4+M3rGlmKPT+T4IS/jP4ylw3Nwpu6cpTTP8R1MAC1kF4VbdLt3ARf209w==",
7451 |       "dev": true,
7452 |       "funding": [
7453 |         {
7454 |           "type": "opencollective",
7455 |           "url": "https://opencollective.com/browserslist"
7456 |         },
7457 |         {
7458 |           "type": "tidelift",
7459 |           "url": "https://tidelift.com/funding/github/npm/browserslist"
7460 |         },
7461 |         {
7462 |           "type": "github",
7463 |           "url": "https://github.com/sponsors/ai"
7464 |         }
7465 |       ],
7466 |       "license": "MIT",
7467 |       "dependencies": {
7468 |         "escalade": "^3.2.0",
7469 |         "picocolors": "^1.1.1"
7470 |       },
7471 |       "bin": {
7472 |         "update-browserslist-db": "cli.js"
7473 |       },
7474 |       "peerDependencies": {
7475 |         "browserslist": ">= 4.21.0"
7476 |       }
7477 |     },
7478 |     "node_modules/url-parse-lax": {
7479 |       "version": "3.0.0",
7480 |       "resolved": "https://registry.npmjs.org/url-parse-lax/-/url-parse-lax-3.0.0.tgz",
7481 |       "integrity": "sha512-NjFKA0DidqPa5ciFcSrXnAltTtzz84ogy+NebPvfEgAck0+TNg4UJ4IN+fB7zRZfbgUf0syOo9MDxFkDSMuFaQ==",
7482 |       "dev": true,
7483 |       "license": "MIT",
7484 |       "dependencies": {
7485 |         "prepend-http": "^2.0.0"
7486 |       },
7487 |       "engines": {
7488 |         "node": ">=4"
7489 |       }
7490 |     },
7491 |     "node_modules/url-to-options": {
7492 |       "version": "1.0.1",
7493 |       "resolved": "https://registry.npmjs.org/url-to-options/-/url-to-options-1.0.1.tgz",
7494 |       "integrity": "sha512-0kQLIzG4fdk/G5NONku64rSH/x32NOA39LVQqlK8Le6lvTF6GGRJpqaQFGgU+CLwySIqBSMdwYM0sYcW9f6P4A==",
7495 |       "dev": true,
7496 |       "license": "MIT",
7497 |       "engines": {
7498 |         "node": ">= 4"
7499 |       }
7500 |     },
7501 |     "node_modules/util-deprecate": {
7502 |       "version": "1.0.2",
7503 |       "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
7504 |       "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
7505 |       "dev": true,
7506 |       "license": "MIT"
7507 |     },
7508 |     "node_modules/watchpack": {
7509 |       "version": "2.5.0",
7510 |       "resolved": "https://registry.npmjs.org/watchpack/-/watchpack-2.5.0.tgz",
7511 |       "integrity": "sha512-e6vZvY6xboSwLz2GD36c16+O/2Z6fKvIf4pOXptw2rY9MVwE/TXc6RGqxD3I3x0a28lwBY7DE+76uTPSsBrrCA==",
7512 |       "dev": true,
7513 |       "license": "MIT",
7514 |       "dependencies": {
7515 |         "glob-to-regexp": "^0.4.1",
7516 |         "graceful-fs": "^4.1.2"
7517 |       },
7518 |       "engines": {
7519 |         "node": ">=10.13.0"
7520 |       }
7521 |     },
7522 |     "node_modules/wcwidth": {
7523 |       "version": "1.0.1",
7524 |       "resolved": "https://registry.npmjs.org/wcwidth/-/wcwidth-1.0.1.tgz",
7525 |       "integrity": "sha512-XHPEwS0q6TaxcvG85+8EYkbiCux2XtWG2mkc47Ng2A77BQu9+DqIOJldST4HgPkuea7dvKSj5VgX3P1d4rW8Tg==",
7526 |       "dev": true,
7527 |       "license": "MIT",
7528 |       "dependencies": {
7529 |         "defaults": "^1.0.3"
7530 |       }
7531 |     },
7532 |     "node_modules/webdriver-bidi-protocol": {
7533 |       "version": "0.3.9",
7534 |       "resolved": "https://registry.npmjs.org/webdriver-bidi-protocol/-/webdriver-bidi-protocol-0.3.9.tgz",
7535 |       "integrity": "sha512-uIYvlRQ0PwtZR1EzHlTMol1G0lAlmOe6wPykF9a77AK3bkpvZHzIVxRE2ThOx5vjy2zISe0zhwf5rzuUfbo1PQ==",
7536 |       "license": "Apache-2.0"
7537 |     },
7538 |     "node_modules/webidl-conversions": {
7539 |       "version": "3.0.1",
7540 |       "resolved": "https://registry.npmjs.org/webidl-conversions/-/webidl-conversions-3.0.1.tgz",
7541 |       "integrity": "sha512-2JAn3z8AR6rjK8Sm8orRC0h/bcl/DqL7tRPdGZ4I1CjdF+EaMLmYxBHyXuKL849eucPFhvBoxMsflfOb8kxaeQ==",
7542 |       "dev": true,
7543 |       "license": "BSD-2-Clause"
7544 |     },
7545 |     "node_modules/webpack": {
7546 |       "version": "5.104.1",
7547 |       "resolved": "https://registry.npmjs.org/webpack/-/webpack-5.104.1.tgz",
7548 |       "integrity": "sha512-Qphch25abbMNtekmEGJmeRUhLDbe+QfiWTiqpKYkpCOWY64v9eyl+KRRLmqOFA2AvKPpc9DC6+u2n76tQLBoaA==",
7549 |       "dev": true,
7550 |       "license": "MIT",
7551 |       "peer": true,
7552 |       "dependencies": {
7553 |         "@types/eslint-scope": "^3.7.7",
7554 |         "@types/estree": "^1.0.8",
7555 |         "@types/json-schema": "^7.0.15",
7556 |         "@webassemblyjs/ast": "^1.14.1",
7557 |         "@webassemblyjs/wasm-edit": "^1.14.1",
7558 |         "@webassemblyjs/wasm-parser": "^1.14.1",
7559 |         "acorn": "^8.15.0",
7560 |         "acorn-import-phases": "^1.0.3",
7561 |         "browserslist": "^4.28.1",
7562 |         "chrome-trace-event": "^1.0.2",
7563 |         "enhanced-resolve": "^5.17.4",
7564 |         "es-module-lexer": "^2.0.0",
7565 |         "eslint-scope": "5.1.1",
7566 |         "events": "^3.2.0",
7567 |         "glob-to-regexp": "^0.4.1",
7568 |         "graceful-fs": "^4.2.11",
7569 |         "json-parse-even-better-errors": "^2.3.1",
7570 |         "loader-runner": "^4.3.1",
7571 |         "mime-types": "^2.1.27",
7572 |         "neo-async": "^2.6.2",
7573 |         "schema-utils": "^4.3.3",
7574 |         "tapable": "^2.3.0",
7575 |         "terser-webpack-plugin": "^5.3.16",
7576 |         "watchpack": "^2.4.4",
7577 |         "webpack-sources": "^3.3.3"
7578 |       },
7579 |       "bin": {
7580 |         "webpack": "bin/webpack.js"
7581 |       },
7582 |       "engines": {
7583 |         "node": ">=10.13.0"
7584 |       },
7585 |       "funding": {
7586 |         "type": "opencollective",
7587 |         "url": "https://opencollective.com/webpack"
7588 |       },
7589 |       "peerDependenciesMeta": {
7590 |         "webpack-cli": {
7591 |           "optional": true
7592 |         }
7593 |       }
7594 |     },
7595 |     "node_modules/webpack-cli": {
7596 |       "version": "6.0.1",
7597 |       "resolved": "https://registry.npmjs.org/webpack-cli/-/webpack-cli-6.0.1.tgz",
7598 |       "integrity": "sha512-MfwFQ6SfwinsUVi0rNJm7rHZ31GyTcpVE5pgVA3hwFRb7COD4TzjUUwhGWKfO50+xdc2MQPuEBBJoqIMGt3JDw==",
7599 |       "dev": true,
7600 |       "license": "MIT",
7601 |       "peer": true,
7602 |       "dependencies": {
7603 |         "@discoveryjs/json-ext": "^0.6.1",
7604 |         "@webpack-cli/configtest": "^3.0.1",
7605 |         "@webpack-cli/info": "^3.0.1",
7606 |         "@webpack-cli/serve": "^3.0.1",
7607 |         "colorette": "^2.0.14",
7608 |         "commander": "^12.1.0",
7609 |         "cross-spawn": "^7.0.3",
7610 |         "envinfo": "^7.14.0",
7611 |         "fastest-levenshtein": "^1.0.12",
7612 |         "import-local": "^3.0.2",
7613 |         "interpret": "^3.1.1",
7614 |         "rechoir": "^0.8.0",
7615 |         "webpack-merge": "^6.0.1"
7616 |       },
7617 |       "bin": {
7618 |         "webpack-cli": "bin/cli.js"
7619 |       },
7620 |       "engines": {
7621 |         "node": ">=18.12.0"
7622 |       },
7623 |       "funding": {
7624 |         "type": "opencollective",
7625 |         "url": "https://opencollective.com/webpack"
7626 |       },
7627 |       "peerDependencies": {
7628 |         "webpack": "^5.82.0"
7629 |       },
7630 |       "peerDependenciesMeta": {
7631 |         "webpack-bundle-analyzer": {
7632 |           "optional": true
7633 |         },
7634 |         "webpack-dev-server": {
7635 |           "optional": true
7636 |         }
7637 |       }
7638 |     },
7639 |     "node_modules/webpack-cli/node_modules/commander": {
7640 |       "version": "12.1.0",
7641 |       "resolved": "https://registry.npmjs.org/commander/-/commander-12.1.0.tgz",
7642 |       "integrity": "sha512-Vw8qHK3bZM9y/P10u3Vib8o/DdkvA2OtPtZvD871QKjy74Wj1WSKFILMPRPSdUSx5RFK1arlJzEtA4PkFgnbuA==",
7643 |       "dev": true,
7644 |       "license": "MIT",
7645 |       "engines": {
7646 |         "node": ">=18"
7647 |       }
7648 |     },
7649 |     "node_modules/webpack-config-prefabs": {
7650 |       "version": "0.0.5",
7651 |       "resolved": "https://registry.npmjs.org/webpack-config-prefabs/-/webpack-config-prefabs-0.0.5.tgz",
7652 |       "integrity": "sha512-A9F08XY1JkFqui6oTMwwr57xiMD/skKdd+A0MRKoDW26ShpLQnWdEPJbgY9IqS7N2l1rvPdkswlS4b6o0JliGQ==",
7653 |       "dev": true,
7654 |       "license": "MIT",
7655 |       "dependencies": {
7656 |         "@types/webpack": "^4.4.34",
7657 |         "find-up": "^4.1.0",
7658 |         "lodash": "^4.17.11",
7659 |         "source-map-loader": "*",
7660 |         "string-replace-loader": "*",
7661 |         "ts-loader": "*",
7662 |         "tslib": "^2.0.1",
7663 |         "typescript": "*",
7664 |         "webpack": "*",
7665 |         "webpack-cli": "*"
7666 |       }
7667 |     },
7668 |     "node_modules/webpack-merge": {
7669 |       "version": "6.0.1",
7670 |       "resolved": "https://registry.npmjs.org/webpack-merge/-/webpack-merge-6.0.1.tgz",
7671 |       "integrity": "sha512-hXXvrjtx2PLYx4qruKl+kyRSLc52V+cCvMxRjmKwoA+CBbbF5GfIBtR6kCvl0fYGqTUPKB+1ktVmTHqMOzgCBg==",
7672 |       "dev": true,
7673 |       "license": "MIT",
7674 |       "dependencies": {
7675 |         "clone-deep": "^4.0.1",
7676 |         "flat": "^5.0.2",
7677 |         "wildcard": "^2.0.1"
7678 |       },
7679 |       "engines": {
7680 |         "node": ">=18.0.0"
7681 |       }
7682 |     },
7683 |     "node_modules/webpack-sources": {
7684 |       "version": "3.3.3",
7685 |       "resolved": "https://registry.npmjs.org/webpack-sources/-/webpack-sources-3.3.3.tgz",
7686 |       "integrity": "sha512-yd1RBzSGanHkitROoPFd6qsrxt+oFhg/129YzheDGqeustzX0vTZJZsSsQjVQC4yzBQ56K55XU8gaNCtIzOnTg==",
7687 |       "dev": true,
7688 |       "license": "MIT",
7689 |       "engines": {
7690 |         "node": ">=10.13.0"
7691 |       }
7692 |     },
7693 |     "node_modules/whatwg-url": {
7694 |       "version": "5.0.0",
7695 |       "resolved": "https://registry.npmjs.org/whatwg-url/-/whatwg-url-5.0.0.tgz",
7696 |       "integrity": "sha512-saE57nupxk6v3HY35+jzBwYa0rKSy0XR8JSxZPwgLr7ys0IBzhGviA1/TUGJLmSVqs8pb9AnvICXEuOHLprYTw==",
7697 |       "dev": true,
7698 |       "license": "MIT",
7699 |       "dependencies": {
7700 |         "tr46": "~0.0.3",
7701 |         "webidl-conversions": "^3.0.0"
7702 |       }
7703 |     },
7704 |     "node_modules/which": {
7705 |       "version": "2.0.2",
7706 |       "resolved": "https://registry.npmjs.org/which/-/which-2.0.2.tgz",
7707 |       "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
7708 |       "dev": true,
7709 |       "license": "ISC",
7710 |       "dependencies": {
7711 |         "isexe": "^2.0.0"
7712 |       },
7713 |       "bin": {
7714 |         "node-which": "bin/node-which"
7715 |       },
7716 |       "engines": {
7717 |         "node": ">= 8"
7718 |       }
7719 |     },
7720 |     "node_modules/which-typed-array": {
7721 |       "version": "1.1.19",
7722 |       "resolved": "https://registry.npmjs.org/which-typed-array/-/which-typed-array-1.1.19.tgz",
7723 |       "integrity": "sha512-rEvr90Bck4WZt9HHFC4DJMsjvu7x+r6bImz0/BrbWb7A2djJ8hnZMrWnHo9F8ssv0OMErasDhftrfROTyqSDrw==",
7724 |       "dev": true,
7725 |       "license": "MIT",
7726 |       "dependencies": {
7727 |         "available-typed-arrays": "^1.0.7",
7728 |         "call-bind": "^1.0.8",
7729 |         "call-bound": "^1.0.4",
7730 |         "for-each": "^0.3.5",
7731 |         "get-proto": "^1.0.1",
7732 |         "gopd": "^1.2.0",
7733 |         "has-tostringtag": "^1.0.2"
7734 |       },
7735 |       "engines": {
7736 |         "node": ">= 0.4"
7737 |       },
7738 |       "funding": {
7739 |         "url": "https://github.com/sponsors/ljharb"
7740 |       }
7741 |     },
7742 |     "node_modules/wildcard": {
7743 |       "version": "2.0.1",
7744 |       "resolved": "https://registry.npmjs.org/wildcard/-/wildcard-2.0.1.tgz",
7745 |       "integrity": "sha512-CC1bOL87PIWSBhDcTrdeLo6eGT7mCFtrg0uIJtqJUFyK+eJnzl8A1niH56uu7KMa5XFrtiV+AQuHO3n7DsHnLQ==",
7746 |       "dev": true,
7747 |       "license": "MIT"
7748 |     },
7749 |     "node_modules/wrap-ansi": {
7750 |       "version": "7.0.0",
7751 |       "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
7752 |       "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
7753 |       "license": "MIT",
7754 |       "dependencies": {
7755 |         "ansi-styles": "^4.0.0",
7756 |         "string-width": "^4.1.0",
7757 |         "strip-ansi": "^6.0.0"
7758 |       },
7759 |       "engines": {
7760 |         "node": ">=10"
7761 |       },
7762 |       "funding": {
7763 |         "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
7764 |       }
7765 |     },
7766 |     "node_modules/wrappy": {
7767 |       "version": "1.0.2",
7768 |       "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
7769 |       "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==",
7770 |       "license": "ISC"
7771 |     },
7772 |     "node_modules/ws": {
7773 |       "version": "8.18.3",
7774 |       "resolved": "https://registry.npmjs.org/ws/-/ws-8.18.3.tgz",
7775 |       "integrity": "sha512-PEIGCY5tSlUt50cqyMXfCzX+oOPqN0vuGqWzbcJ2xvnkzkq46oOpz7dQaTDBdfICb4N14+GARUDw2XV2N4tvzg==",
7776 |       "license": "MIT",
7777 |       "engines": {
7778 |         "node": ">=10.0.0"
7779 |       },
7780 |       "peerDependencies": {
7781 |         "bufferutil": "^4.0.1",
7782 |         "utf-8-validate": ">=5.0.2"
7783 |       },
7784 |       "peerDependenciesMeta": {
7785 |         "bufferutil": {
7786 |           "optional": true
7787 |         },
7788 |         "utf-8-validate": {
7789 |           "optional": true
7790 |         }
7791 |       }
7792 |     },
7793 |     "node_modules/xtend": {
7794 |       "version": "4.0.2",
7795 |       "resolved": "https://registry.npmjs.org/xtend/-/xtend-4.0.2.tgz",
7796 |       "integrity": "sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==",
7797 |       "dev": true,
7798 |       "license": "MIT",
7799 |       "engines": {
7800 |         "node": ">=0.4"
7801 |       }
7802 |     },
7803 |     "node_modules/y18n": {
7804 |       "version": "5.0.8",
7805 |       "resolved": "https://registry.npmjs.org/y18n/-/y18n-5.0.8.tgz",
7806 |       "integrity": "sha512-0pfFzegeDWJHJIAmTLRP2DwHjdF5s7jo9tuztdQxAhINCdvS+3nGINqPd00AphqJR/0LhANUS6/+7SCb98YOfA==",
7807 |       "license": "ISC",
7808 |       "engines": {
7809 |         "node": ">=10"
7810 |       }
7811 |     },
7812 |     "node_modules/yallist": {
7813 |       "version": "5.0.0",
7814 |       "resolved": "https://registry.npmjs.org/yallist/-/yallist-5.0.0.tgz",
7815 |       "integrity": "sha512-YgvUTfwqyc7UXVMrB+SImsVYSmTS8X/tSrtdNZMImM+n7+QTriRXyXim0mBrTXNeqzVF0KWGgHPeiyViFFrNDw==",
7816 |       "dev": true,
7817 |       "license": "BlueOak-1.0.0",
7818 |       "engines": {
7819 |         "node": ">=18"
7820 |       }
7821 |     },
7822 |     "node_modules/yargs": {
7823 |       "version": "17.7.2",
7824 |       "resolved": "https://registry.npmjs.org/yargs/-/yargs-17.7.2.tgz",
7825 |       "integrity": "sha512-7dSzzRQ++CKnNI/krKnYRV7JKKPUXMEh61soaHKg9mrWEhzFWhFnxPxGl+69cD1Ou63C13NUPCnmIcrvqCuM6w==",
7826 |       "license": "MIT",
7827 |       "dependencies": {
7828 |         "cliui": "^8.0.1",
7829 |         "escalade": "^3.1.1",
7830 |         "get-caller-file": "^2.0.5",
7831 |         "require-directory": "^2.1.1",
7832 |         "string-width": "^4.2.3",
7833 |         "y18n": "^5.0.5",
7834 |         "yargs-parser": "^21.1.1"
7835 |       },
7836 |       "engines": {
7837 |         "node": ">=12"
7838 |       }
7839 |     },
7840 |     "node_modules/yargs-parser": {
7841 |       "version": "21.1.1",
7842 |       "resolved": "https://registry.npmjs.org/yargs-parser/-/yargs-parser-21.1.1.tgz",
7843 |       "integrity": "sha512-tVpsJW7DdjecAiFpbIB1e3qxIQsE6NoPc5/eTdrbbIC4h0LVsWhnoa3g+m2HclBIujHzsxZ4VJVA+GUuc2/LBw==",
7844 |       "license": "ISC",
7845 |       "engines": {
7846 |         "node": ">=12"
7847 |       }
7848 |     },
7849 |     "node_modules/yauzl": {
7850 |       "version": "2.10.0",
7851 |       "resolved": "https://registry.npmjs.org/yauzl/-/yauzl-2.10.0.tgz",
7852 |       "integrity": "sha512-p4a9I6X6nu6IhoGmBqAcbJy1mlC4j27vEPZX9F4L4/vZT3Lyq1VkFHw/V/PUcB9Buo+DG3iHkT0x3Qya58zc3g==",
7853 |       "license": "MIT",
7854 |       "dependencies": {
7855 |         "buffer-crc32": "~0.2.3",
7856 |         "fd-slicer": "~1.1.0"
7857 |       }
7858 |     },
7859 |     "node_modules/zip-stream": {
7860 |       "version": "4.1.1",
7861 |       "resolved": "https://registry.npmjs.org/zip-stream/-/zip-stream-4.1.1.tgz",
7862 |       "integrity": "sha512-9qv4rlDiopXg4E69k+vMHjNN63YFMe9sZMrdlvKnCjlCRWeCBswPPMPUfx+ipsAWq1LXHe70RcbaHdJJpS6hyQ==",
7863 |       "dev": true,
7864 |       "license": "MIT",
7865 |       "dependencies": {
7866 |         "archiver-utils": "^3.0.4",
7867 |         "compress-commons": "^4.1.2",
7868 |         "readable-stream": "^3.6.0"
7869 |       },
7870 |       "engines": {
7871 |         "node": ">= 10"
7872 |       }
7873 |     },
7874 |     "node_modules/zip-stream/node_modules/archiver-utils": {
7875 |       "version": "3.0.4",
7876 |       "resolved": "https://registry.npmjs.org/archiver-utils/-/archiver-utils-3.0.4.tgz",
7877 |       "integrity": "sha512-KVgf4XQVrTjhyWmx6cte4RxonPLR9onExufI1jhvw/MQ4BB6IsZD5gT8Lq+u/+pRkWna/6JoHpiQioaqFP5Rzw==",
7878 |       "dev": true,
7879 |       "license": "MIT",
7880 |       "dependencies": {
7881 |         "glob": "^7.2.3",
7882 |         "graceful-fs": "^4.2.0",
7883 |         "lazystream": "^1.0.0",
7884 |         "lodash.defaults": "^4.2.0",
7885 |         "lodash.difference": "^4.5.0",
7886 |         "lodash.flatten": "^4.4.0",
7887 |         "lodash.isplainobject": "^4.0.6",
7888 |         "lodash.union": "^4.6.0",
7889 |         "normalize-path": "^3.0.0",
7890 |         "readable-stream": "^3.6.0"
7891 |       },
7892 |       "engines": {
7893 |         "node": ">= 10"
7894 |       }
7895 |     },
7896 |     "node_modules/zip-stream/node_modules/readable-stream": {
7897 |       "version": "3.6.2",
7898 |       "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-3.6.2.tgz",
7899 |       "integrity": "sha512-9u/sniCrY3D5WdsERHzHE4G2YCXqoG5FTHUiCC4SIbr6XcLZBY05ya9EKjYek9O5xOAwjGq+1JdGBAS7Q9ScoA==",
7900 |       "dev": true,
7901 |       "license": "MIT",
7902 |       "dependencies": {
7903 |         "inherits": "^2.0.3",
7904 |         "string_decoder": "^1.1.1",
7905 |         "util-deprecate": "^1.0.1"
7906 |       },
7907 |       "engines": {
7908 |         "node": ">= 6"
7909 |       }
7910 |     },
7911 |     "node_modules/zod": {
7912 |       "version": "3.25.76",
7913 |       "resolved": "https://registry.npmjs.org/zod/-/zod-3.25.76.tgz",
7914 |       "integrity": "sha512-gzUt/qt81nXsFGKIFcC3YnfEAx5NkunCfnDlvuBSSFS02bcXu4Lmea0AFIUwbLWxWPx3d9p8S5QoaujKcNQxcQ==",
7915 |       "license": "MIT",
7916 |       "funding": {
7917 |         "url": "https://github.com/sponsors/colinhacks"
7918 |       }
7919 |     }
7920 |   }
7921 | }
7922 | 
```

---

### üìÑ ≈öcie≈ºka: `Rozwoj.md`
**Typ:** Markdown  
**Opis:** Plik projektu (kod/konfiguracja).  

```md
  1 | # FB Watcher ‚Äî koncepcja dzia≈Çania panelu (pod integracjƒô backendu)
  2 | 
  3 | Ten dokument opisuje **jak ma dzia≈Çaƒá panel administratora** dla systemu FB Watcher.
  4 | Panel jest **centrum sterowania**, backend (scrapery / workerzy) bƒôdzie dopinany etapami.
  5 | 
  6 | Panel:
  7 | - przechowuje konfiguracjƒô,
  8 | - zbiera wykrycia (discoveries),
  9 | - umo≈ºliwia zatwierdzanie,
 10 | - zarzƒÖdza obserwacjƒÖ i akcjami (alerty, autoposting).
 11 | 
 12 | ---
 13 | 
 14 | ## Wsp√≥lny schemat dzia≈Çania
 15 | 
 16 | ≈πR√ìD≈ÅO ‚Üí WYKRYCIE (DISCOVERY) ‚Üí ZATWIERDZENIE ‚Üí OBSERWACJA / AKCJA
 17 | 
 18 | Panel **nie scrapuje** ‚Äî panel **zarzƒÖdza i decyduje**.
 19 | 
 20 | ---
 21 | 
 22 | ## 1. PrzeglƒÖdanie g≈Ç√≥wnej strony Facebooka (Home / Feed)
 23 | 
 24 | ### Cel
 25 | Automatyczne wykrywanie post√≥w z **g≈Ç√≥wnej tablicy Facebooka** (Home / Feed),
 26 | czyli tego, co realnie pojawia siƒô u≈ºytkownikowi po zalogowaniu:
 27 | - posty stron,
 28 | - posty publiczne,
 29 | - posty sponsorowane,
 30 | - tre≈õci powiƒÖzane z zainteresowaniami.
 31 | 
 32 | ### Jak to dzia≈Ça
 33 | 1. W panelu konfigurowane sƒÖ:
 34 |    - tryb skanowania **g≈Ç√≥wnej strony Facebooka**,
 35 |    - zestawy s≈Ç√≥w kluczowych.
 36 | 2. Backend cyklicznie przeglƒÖda g≈Ç√≥wny feed Facebooka.
 37 | 3. Ka≈ºdy post dopasowany do s≈Ç√≥w kluczowych trafia do panelu jako **Wykrycie (Discovery)**.
 38 | 4. Operator w panelu:
 39 |    - **Zatwierdza** ‚Üí post zostaje dodany do listy obserwowanych (Watcher),
 40 |    - **Odrzuca** ‚Üí wykrycie jest ignorowane.
 41 | 
 42 | ### Panel musi posiadaƒá
 43 | - konfiguracjƒô skanowania strony g≈Ç√≥wnej Facebooka,
 44 | - listƒô wykryƒá z typu `home_feed`,
 45 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
 46 | 
 47 | ---
 48 | 
 49 | ## 2. Scrapping grup Facebooka
 50 | 
 51 | ### Cel
 52 | Wychwytywanie zapyta≈Ñ i lead√≥w z grup bran≈ºowych.
 53 | 
 54 | ### Jak to dzia≈Ça
 55 | 1. W panelu dodawane sƒÖ:
 56 |    - grupy Facebook,
 57 |    - przypisane zestawy s≈Ç√≥w kluczowych.
 58 | 2. Backend skanuje nowe posty w grupach.
 59 | 3. Dopasowania trafiajƒÖ do **Wykryƒá (Discovery)** z typem `group_post`.
 60 | 4. Operator:
 61 |    - zatwierdza ‚Üí (opcjonalnie) dodaje post do obserwowanych,
 62 |    - odrzuca ‚Üí ignor.
 63 | 
 64 | ### Panel musi posiadaƒá
 65 | - listƒô grup,
 66 | - przypisywanie keyword√≥w,
 67 | - decyzjƒô na wykryciu: `dodaj do obserwowanych` / `tylko alert`.
 68 | 
 69 | ---
 70 | 
 71 | ## 3. Meta Ads (reklamy konkurencji)
 72 | 
 73 | ### Cel
 74 | Monitoring reklam konkurencji i wyciƒÖganie konkretnych reklam/post√≥w do dalszej obserwacji.
 75 | 
 76 | ### Jak to dzia≈Ça
 77 | 1. W panelu definiowane sƒÖ:
 78 |    - konkurencja (opcjonalnie),
 79 |    - s≈Çowa kluczowe.
 80 | 2. Backend skanuje Meta Ads Library.
 81 | 3. Znalezione reklamy trafiajƒÖ do **Wykryƒá (Discovery)**:
 82 |    - link do reklamy,
 83 |    - reklamodawca,
 84 |    - typ (grafika / wideo),
 85 |    - opis.
 86 | 4. Panel posiada wyszukiwarkƒô wykryƒá.
 87 | 5. Po **zatwierdzeniu**:
 88 |    - je≈õli reklama ma publiczny link/post ‚Üí trafia do obserwowanych link√≥w watchera,
 89 |    - reklama zostaje przypisana do istniejƒÖcych obserwacji.
 90 | 
 91 | ### Panel musi posiadaƒá
 92 | - listƒô monitor√≥w Meta Ads,
 93 | - listƒô wykryƒá reklam,
 94 | - akcjƒô: `Zatwierd≈∫ ‚Üí dodaj do obserwowanych`.
 95 | 
 96 | ---
 97 | 
 98 | ## 4. Automatyczne dodawanie og≈Çosze≈Ñ (Marketplace)
 99 | 
100 | ### Cel
101 | Autoposting og≈Çosze≈Ñ z puli tre≈õci, z rotacjƒÖ i obs≈ÇugƒÖ wielu kont.
102 | 
103 | ### Jak to dzia≈Ça
104 | 1. W panelu tworzone sƒÖ:
105 |    - pule og≈Çosze≈Ñ (szablony),
106 |    - kampanie publikacji.
107 | 2. Kampania:
108 |    - wybiera konto FB,
109 |    - ustala harmonogram,
110 |    - rotuje tre≈õci.
111 | 3. Backend publikuje og≈Çoszenia.
112 | 4. Przy b≈Çƒôdzie lub blokadzie:
113 |    - kampania zostaje zatrzymana,
114 |    - panel pokazuje status i mo≈ºliwo≈õƒá wznowienia.
115 | 
116 | ### Panel musi posiadaƒá
117 | - pulƒô og≈Çosze≈Ñ,
118 | - kampanie publikacji,
119 | - statusy: ACTIVE / PAUSED / ERROR,
120 | - przyciski STOP / WZN√ìW.
121 | 
122 | ---
123 | 
124 | ## Kluczowe byty w panelu (minimalny zestaw)
125 | 
126 | - **Sources** ‚Äì g≈Ç√≥wna strona FB, grupy, meta ads
127 | - **Discoveries** ‚Äì wszystkie wykrycia (jedno wsp√≥lne miejsce)
128 | - **Watched** ‚Äì obserwowane linki/posty (dla watchera)
129 | - **Campaigns** ‚Äì autoposting / marketplace
130 | 
131 | Ka≈ºdy typ wykrycia przechodzi przez:
132 | `Discoveries ‚Üí Zatwierd≈∫ ‚Üí Watched / Campaign`
133 | 
134 | ---
135 | 
136 | ## Za≈Ço≈ºenia architektoniczne
137 | 
138 | - Panel = ≈∫r√≥d≈Ço prawdy
139 | - Backend = wykonawca (worker)
140 | - G≈Ç√≥wna strona FB, grupy i Meta Ads to **r√≥≈ºne ≈∫r√≥d≈Ça**, ale **ten sam proces zatwierdzania**
141 | - Ka≈ºda funkcja backendu mo≈ºe byƒá dodana p√≥≈∫niej bez zmiany panelu
142 | 
143 | ---
144 | 
145 | ## Uwaga projektowa
146 | 
147 | Panel musi byƒá gotowy na:
148 | - wiele kont Facebook,
149 | - blokady i zatrzymania,
150 | - r√≥≈ºne typy ≈∫r√≥de≈Ç (Home / Group / Ads),
151 | - dalszƒÖ rozbudowƒô bez refaktoru UI.
152 | 
153 | 
```

---

### üìÑ ≈öcie≈ºka: `scripts/generate-cookies.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | #!/usr/bin/env node
  2 | /**
  3 |  * scripts/generate-cookies.js
  4 |  *
  5 |  * Skrypt pomocniczy do generowania cookies Facebook z rotacjƒÖ.
  6 |  * Otwiera przeglƒÖdarkƒô w trybie widocznym, czeka na manualne logowanie (z 2FA),
  7 |  * a nastƒôpnie zapisuje cookies do plik√≥w z numeracjƒÖ.
  8 |  *
  9 |  * U≈ºycie:
 10 |  *   node scripts/generate-cookies.js [--index=N] [--upload] [--list]
 11 |  *
 12 |  * Opcje:
 13 |  *   --index=N  - zapisz jako cookies_N.json (domy≈õlnie: nastƒôpny wolny numer)
 14 |  *   --upload   - po zapisaniu, wy≈õlij cookies przez SCP na serwer
 15 |  *   --list     - tylko poka≈º listƒô istniejƒÖcych plik√≥w cookies
 16 |  *
 17 |  * Przyk≈Çady:
 18 |  *   node scripts/generate-cookies.js                    # zapisz jako cookies_1.json (lub nastƒôpny)
 19 |  *   node scripts/generate-cookies.js --index=2          # zapisz jako cookies_2.json
 20 |  *   node scripts/generate-cookies.js --index=1 --upload # zapisz i wy≈õlij na serwer
 21 |  *   node scripts/generate-cookies.js --list             # poka≈º istniejƒÖce pliki
 22 |  */
 23 | 
 24 | import "dotenv/config";
 25 | import puppeteer from "puppeteer";
 26 | import fs from "fs/promises";
 27 | import fsSync from "fs";
 28 | import path from "path";
 29 | import { execSync } from "child_process";
 30 | import readline from "readline";
 31 | 
 32 | // Konfiguracja
 33 | const MAIN_COOKIES_FILE = "cookies.json";
 34 | const BACKUP_COOKIES_DIR = process.env.BACKUP_COOKIES_DIR || "./data/backup_cookies";
 35 | const SCP_COOKIES_TARGET = (process.env.SCP_COOKIES_TARGET || "").trim();
 36 | 
 37 | // Kolory konsoli
 38 | const colors = {
 39 |   reset: "\x1b[0m",
 40 |   bright: "\x1b[1m",
 41 |   green: "\x1b[32m",
 42 |   yellow: "\x1b[33m",
 43 |   blue: "\x1b[34m",
 44 |   cyan: "\x1b[36m",
 45 |   red: "\x1b[31m",
 46 |   dim: "\x1b[2m",
 47 | };
 48 | 
 49 | function log(msg, color = "reset") {
 50 |   console.log(`${colors[color]}${msg}${colors.reset}`);
 51 | }
 52 | 
 53 | function logBox(lines) {
 54 |   const maxLen = Math.max(...lines.map((l) => l.length));
 55 |   const border = "‚ïê".repeat(maxLen + 2);
 56 | 
 57 |   console.log(`\n${colors.cyan}‚ïî${border}‚ïó${colors.reset}`);
 58 |   for (const line of lines) {
 59 |     const padding = " ".repeat(maxLen - line.length);
 60 |     console.log(`${colors.cyan}‚ïë${colors.reset} ${line}${padding} ${colors.cyan}‚ïë${colors.reset}`);
 61 |   }
 62 |   console.log(`${colors.cyan}‚ïö${border}‚ïù${colors.reset}\n`);
 63 | }
 64 | 
 65 | /**
 66 |  * Pobiera listƒô istniejƒÖcych plik√≥w cookies_N.json
 67 |  */
 68 | function getExistingCookiesFiles() {
 69 |   try {
 70 |     const backupDir = path.resolve(BACKUP_COOKIES_DIR);
 71 |     if (!fsSync.existsSync(backupDir)) return [];
 72 | 
 73 |     const files = fsSync.readdirSync(backupDir);
 74 |     const cookieFiles = [];
 75 | 
 76 |     for (const file of files) {
 77 |       const match = file.match(/^cookies_(\d+)\.json$/);
 78 |       if (match) {
 79 |         const index = parseInt(match[1], 10);
 80 |         const filePath = path.join(backupDir, file);
 81 |         const stats = fsSync.statSync(filePath);
 82 |         const ageHours = Math.round((Date.now() - stats.mtimeMs) / (1000 * 60 * 60));
 83 | 
 84 |         cookieFiles.push({ index, filename: file, path: filePath, ageHours });
 85 |       }
 86 |     }
 87 | 
 88 |     return cookieFiles.sort((a, b) => a.index - b.index);
 89 |   } catch {
 90 |     return [];
 91 |   }
 92 | }
 93 | 
 94 | /**
 95 |  * Znajduje nastƒôpny wolny numer
 96 |  */
 97 | function getNextFreeIndex() {
 98 |   const existing = getExistingCookiesFiles();
 99 |   if (existing.length === 0) return 1;
100 |   return Math.max(...existing.map((f) => f.index)) + 1;
101 | }
102 | 
103 | /**
104 |  * Parsuje argumenty CLI
105 |  */
106 | function parseArgs() {
107 |   const args = process.argv.slice(2);
108 |   const result = {
109 |     index: null,
110 |     upload: false,
111 |     list: false,
112 |   };
113 | 
114 |   for (const arg of args) {
115 |     if (arg === "--upload") {
116 |       result.upload = true;
117 |     } else if (arg === "--list") {
118 |       result.list = true;
119 |     } else if (arg.startsWith("--index=")) {
120 |       const val = arg.split("=")[1];
121 |       result.index = parseInt(val, 10);
122 |       if (isNaN(result.index) || result.index < 1) {
123 |         log(`B≈ÇƒÖd: --index musi byƒá liczbƒÖ >= 1`, "red");
124 |         process.exit(1);
125 |       }
126 |     }
127 |   }
128 | 
129 |   return result;
130 | }
131 | 
132 | async function waitForEnter() {
133 |   const rl = readline.createInterface({
134 |     input: process.stdin,
135 |     output: process.stdout,
136 |   });
137 | 
138 |   return new Promise((resolve) => {
139 |     rl.question(`${colors.yellow}>>> Naci≈õnij ENTER gdy sko≈Ñczysz logowanie...${colors.reset}`, () => {
140 |       rl.close();
141 |       resolve();
142 |     });
143 |   });
144 | }
145 | 
146 | async function checkIfLogged(page) {
147 |   try {
148 |     return await page.evaluate(() => {
149 |       const hasSearch = !!(
150 |         document.querySelector('input[aria-label*="Szukaj"]') ||
151 |         document.querySelector('input[placeholder*="Szukaj"]') ||
152 |         document.querySelector('input[placeholder*="Search"]')
153 |       );
154 |       const hasProfile = !!(
155 |         document.querySelector('a[aria-label*="Profil"]') ||
156 |         document.querySelector('a[aria-label*="Profile"]')
157 |       );
158 |       const hasAccount = !!(
159 |         document.querySelector('div[aria-label*="Konto"]') ||
160 |         document.querySelector('div[aria-label*="Account"]')
161 |       );
162 |       const hasFeed = !!document.querySelector('[role="feed"]');
163 | 
164 |       return hasSearch || hasProfile || hasAccount || hasFeed;
165 |     });
166 |   } catch {
167 |     return false;
168 |   }
169 | }
170 | 
171 | async function ensureDir(dir) {
172 |   try {
173 |     await fs.mkdir(dir, { recursive: true });
174 |   } catch {
175 |     // ignoruj
176 |   }
177 | }
178 | 
179 | async function saveCookiesToFile(cookies, filePath) {
180 |   await ensureDir(path.dirname(filePath));
181 |   await fs.writeFile(filePath, JSON.stringify(cookies, null, 2), "utf8");
182 | }
183 | 
184 | function uploadViaScp(localPath, target) {
185 |   if (!target) {
186 |     log("Brak SCP_COOKIES_TARGET w .env - pomijam upload", "yellow");
187 |     return false;
188 |   }
189 | 
190 |   try {
191 |     log(`Wysy≈Çam przez SCP: ${path.basename(localPath)} ‚Üí ${target}`, "blue");
192 |     execSync(`scp "${localPath}" "${target}"`, { stdio: "inherit" });
193 |     log("Upload zako≈Ñczony!", "green");
194 |     return true;
195 |   } catch (err) {
196 |     log(`B≈ÇƒÖd SCP: ${err.message}`, "red");
197 |     return false;
198 |   }
199 | }
200 | 
201 | function showList() {
202 |   const files = getExistingCookiesFiles();
203 | 
204 |   logBox([
205 |     "Lista plik√≥w backup cookies",
206 |     `Folder: ${BACKUP_COOKIES_DIR}`,
207 |   ]);
208 | 
209 |   if (files.length === 0) {
210 |     log("  (brak plik√≥w)", "dim");
211 |   } else {
212 |     for (const f of files) {
213 |       const ageStr = f.ageHours < 24 ? `${f.ageHours}h` : `${Math.round(f.ageHours / 24)}d`;
214 |       log(`  ${colors.cyan}${f.filename}${colors.reset} - wiek: ${ageStr}`);
215 |     }
216 |   }
217 | 
218 |   console.log();
219 |   log(`Nastƒôpny wolny numer: ${getNextFreeIndex()}`, "dim");
220 | }
221 | 
222 | async function main() {
223 |   const args = parseArgs();
224 | 
225 |   // Tryb --list
226 |   if (args.list) {
227 |     showList();
228 |     process.exit(0);
229 |   }
230 | 
231 |   // Ustal numer pliku
232 |   const targetIndex = args.index ?? getNextFreeIndex();
233 |   const targetFilename = `cookies_${targetIndex}.json`;
234 |   const targetPath = path.join(path.resolve(BACKUP_COOKIES_DIR), targetFilename);
235 | 
236 |   // Sprawd≈∫ czy plik ju≈º istnieje
237 |   const existing = getExistingCookiesFiles();
238 |   const existsAlready = existing.some((f) => f.index === targetIndex);
239 | 
240 |   logBox([
241 |     "FB Cookie Generator (z rotacjƒÖ)",
242 |     "",
243 |     `Zapisze jako: ${targetFilename}`,
244 |     existsAlready ? `(UWAGA: nadpisze istniejƒÖcy plik!)` : `(nowy plik)`,
245 |     "",
246 |     "Otworzy przeglƒÖdarkƒô - zaloguj siƒô rƒôcznie.",
247 |   ]);
248 | 
249 |   // Poka≈º istniejƒÖce pliki
250 |   if (existing.length > 0) {
251 |     log("IstniejƒÖce pliki backup:", "dim");
252 |     for (const f of existing) {
253 |       const marker = f.index === targetIndex ? " ‚Üê nadpisany" : "";
254 |       log(`  ${f.filename}${marker}`, "dim");
255 |     }
256 |     console.log();
257 |   }
258 | 
259 |   log("Uruchamiam przeglƒÖdarkƒô...", "blue");
260 | 
261 |   const browser = await puppeteer.launch({
262 |     headless: false,
263 |     defaultViewport: null,
264 |     args: [
265 |       "--start-maximized",
266 |       "--disable-notifications",
267 |       "--disable-blink-features=AutomationControlled",
268 |     ],
269 |     ignoreDefaultArgs: ["--enable-automation"],
270 |   });
271 | 
272 |   const page = await browser.newPage();
273 | 
274 |   // Stealth
275 |   await page.evaluateOnNewDocument(() => {
276 |     Object.defineProperty(navigator, "webdriver", { get: () => false });
277 |     window.chrome = window.chrome || { runtime: {} };
278 |     Object.defineProperty(navigator, "plugins", { get: () => [1, 2, 3] });
279 |     Object.defineProperty(navigator, "languages", { get: () => ["pl-PL", "pl"] });
280 |   });
281 | 
282 |   log("Nawigujƒô do Facebook...", "blue");
283 |   await page.goto("https://www.facebook.com/login.php", { waitUntil: "networkidle2" });
284 | 
285 |   logBox([
286 |     "INSTRUKCJA",
287 |     "",
288 |     "1. Zaloguj siƒô na swoje konto Facebook",
289 |     "2. Je≈õli FB poprosi o 2FA - wprowad≈∫ kod",
290 |     "3. Poczekaj a≈º zobaczysz stronƒô g≈Ç√≥wnƒÖ",
291 |     "4. Wr√≥ƒá tutaj i naci≈õnij ENTER",
292 |   ]);
293 | 
294 |   await waitForEnter();
295 | 
296 |   log("Sprawdzam status logowania...", "blue");
297 |   let isLogged = await checkIfLogged(page);
298 | 
299 |   if (!isLogged) {
300 |     log("Nie wykryto sesji. Spr√≥buj ponownie.", "yellow");
301 | 
302 |     const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
303 |     const retry = await new Promise((resolve) => {
304 |       rl.question("Czy chcesz spr√≥bowaƒá ponownie? (t/n): ", (answer) => {
305 |         rl.close();
306 |         resolve(answer.toLowerCase() === "t" || answer.toLowerCase() === "y");
307 |       });
308 |     });
309 | 
310 |     if (retry) {
311 |       await waitForEnter();
312 |       isLogged = await checkIfLogged(page);
313 |     }
314 | 
315 |     if (!isLogged) {
316 |       log("Nie wykryto sesji. Zamykam.", "red");
317 |       await browser.close();
318 |       process.exit(1);
319 |     }
320 |   }
321 | 
322 |   log("Sesja wykryta! Pobieram cookies...", "green");
323 | 
324 |   const cookies = await page.cookies();
325 |   log(`Pobrano ${cookies.length} cookies`, "cyan");
326 | 
327 |   // Zapisz do g≈Ç√≥wnego pliku
328 |   const mainPath = path.resolve(MAIN_COOKIES_FILE);
329 |   await saveCookiesToFile(cookies, mainPath);
330 |   log(`Zapisano: ${mainPath}`, "green");
331 | 
332 |   // Zapisz jako backup z numerem
333 |   await saveCookiesToFile(cookies, targetPath);
334 |   log(`Zapisano backup: ${targetPath}`, "green");
335 | 
336 |   // Opcjonalnie: upload SCP
337 |   if (args.upload) {
338 |     uploadViaScp(targetPath, SCP_COOKIES_TARGET);
339 |   }
340 | 
341 |   await browser.close();
342 | 
343 |   logBox([
344 |     "SUKCES!",
345 |     "",
346 |     `Cookies zapisane jako: ${targetFilename}`,
347 |     "",
348 |     "Aby wygenerowaƒá kolejny zestaw:",
349 |     `  node scripts/generate-cookies.js --index=${targetIndex + 1}`,
350 |     "",
351 |     args.upload && SCP_COOKIES_TARGET
352 |       ? `Upload: ${SCP_COOKIES_TARGET}`
353 |       : "Skopiuj pliki na serwer rƒôcznie lub u≈ºyj --upload",
354 |   ].filter(Boolean));
355 | 
356 |   process.exit(0);
357 | }
358 | 
359 | main().catch((err) => {
360 |   console.error("B≈ÇƒÖd:", err);
361 |   process.exit(1);
362 | });
363 | 
```

---

### üìÑ ≈öcie≈ºka: `test-telegram.mjs`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
 1 | import "dotenv/config";
 2 | import { sendTelegramLeads } from "./src/telegram.js";
 3 | 
 4 | await sendTelegramLeads(
 5 |   { name: "TEST", description: "test", url: "https://facebook.com", image: "" },
 6 |   [{ author: "Tester", text: "To jest test", fb_time_raw: "1 min", id: "test-1" }]
 7 | );
 8 | 
 9 | console.log("TEST DONE");
10 | 
```

---

### üìÑ ≈öcie≈ºka: `tools/export-project-to-md.js`
**Typ:** JavaScript/tekst  
**Opis:** Plik projektu (kod/konfiguracja).  

```js
  1 | #!/usr/bin/env node
  2 | /**
  3 |  * Wypasiony eksport projektu do jednego Markdown:
  4 |  * - Overview (statystyki + mini tree)
  5 |  * - üö™ Entrypoints & Flow (sta≈Ça lista pod FB_Watcher)
  6 |  * - Public API (exports) z liniami
  7 |  * - Function/Class index (mapa funkcji i klas per plik)
  8 |  * - Keyword index (wystƒÖpienia + linie)
  9 |  * - Import graph (lite)
 10 |  * - Pe≈Çny kod wszystkich plik√≥w z numerami linii
 11 |  *
 12 |  * Uruchom:
 13 |  *   node tools/export-project-to-md.js
 14 |  *
 15 |  * ENV:
 16 |  *   EXPORT_OUT=EXPORT_PROJEKTU_PLUS.md
 17 |  *   EXPORT_ROOT=.
 18 |  *   EXPORT_MAX_BYTES=2000000
 19 |  *   EXPORT_TREE_DEPTH=3
 20 |  *   EXPORT_TREE_MAX_LINES=220
 21 |  *   EXPORT_KEYWORDS=FAST_MODE,WEBHOOK_URL,PM2,pm2,watcher,DEDUP,newest,Najnowsze
 22 |  *   EXPORT_KEYWORD_MAX_HITS=60
 23 |  *   EXPORT_REDACT=0|1         (domy≈õlnie 0; 1 zamazuje .env / cookies.json itp.)
 24 |  *   EXPORT_FUNC_INDEX_MAX=220  (max wpis√≥w w function index na plik; domy≈õlnie 220)
 25 |  */
 26 | 
 27 | import fs from "fs";
 28 | import path from "path";
 29 | 
 30 | const ROOT = path.resolve(process.env.EXPORT_ROOT || process.cwd());
 31 | const OUT_FILE = path.resolve(process.env.EXPORT_OUT || path.join(ROOT, "EXPORT_PROJEKTU_PLUS.md"));
 32 | const MAX_BYTES = Number(process.env.EXPORT_MAX_BYTES || 2_000_000);
 33 | const TREE_DEPTH = Number(process.env.EXPORT_TREE_DEPTH || 3);
 34 | const TREE_MAX_LINES = Number(process.env.EXPORT_TREE_MAX_LINES || 220);
 35 | const KEYWORD_MAX_HITS = Number(process.env.EXPORT_KEYWORD_MAX_HITS || 60);
 36 | const REDACT = String(process.env.EXPORT_REDACT || "0") === "1";
 37 | const FUNC_INDEX_MAX = Number(process.env.EXPORT_FUNC_INDEX_MAX || 220);
 38 | 
 39 | const DEFAULT_KEYWORDS = [
 40 |   "FAST_MODE",
 41 |   "FAST_MAX_AGE_MIN",
 42 |   "WEBHOOK_URL",
 43 |   "PANEL_TOKEN",
 44 |   "PM2",
 45 |   "pm2",
 46 |   "watcher",
 47 |   "dedup",
 48 |   "DEDUP",
 49 |   "Najnowsze",
 50 |   "newest",
 51 |   "switchComments",
 52 |   "cookies",
 53 |   "COOKIES",
 54 |   "HEADLESS_BROWSER",
 55 |   "USE_UI_HANDLERS",
 56 | ];
 57 | 
 58 | const KEYWORDS = String(process.env.EXPORT_KEYWORDS || "")
 59 |   .split(",")
 60 |   .map((s) => s.trim())
 61 |   .filter(Boolean);
 62 | 
 63 | const FINAL_KEYWORDS = KEYWORDS.length ? KEYWORDS : DEFAULT_KEYWORDS;
 64 | 
 65 | const IGNORE_DIRS = new Set([
 66 |   "node_modules",
 67 |   ".git",
 68 |   "dist",
 69 |   "build",
 70 |   "out",
 71 |   ".next",
 72 |   ".turbo",
 73 |   ".cache",
 74 |   "coverage",
 75 |   ".pnpm-store",
 76 |   ".yarn",
 77 |   ".vscode",
 78 |   ".idea",
 79 | ]);
 80 | 
 81 | const IGNORE_FILES = new Set([
 82 |   // locki mo≈ºesz dodaƒá je≈õli chcesz
 83 |   // "package-lock.json",
 84 |   // "yarn.lock",
 85 |   // "pnpm-lock.yaml",
 86 | ]);
 87 | 
 88 | const ALLOWED_EXT = new Set([
 89 |   ".js",
 90 |   ".mjs",
 91 |   ".cjs",
 92 |   ".ts",
 93 |   ".tsx",
 94 |   ".jsx",
 95 |   ".json",
 96 |   ".html",
 97 |   ".css",
 98 |   ".md",
 99 |   ".yml",
100 |   ".yaml",
101 |   ".txt",
102 | ]);
103 | 
104 | const BINARY_EXT = new Set([
105 |   ".png",
106 |   ".jpg",
107 |   ".jpeg",
108 |   ".webp",
109 |   ".gif",
110 |   ".ico",
111 |   ".pdf",
112 |   ".zip",
113 |   ".rar",
114 |   ".7z",
115 |   ".tar",
116 |   ".gz",
117 |   ".exe",
118 |   ".dll",
119 |   ".so",
120 |   ".dylib",
121 |   ".bin",
122 |   ".woff",
123 |   ".woff2",
124 |   ".ttf",
125 |   ".otf",
126 |   ".mp4",
127 |   ".mov",
128 |   ".avi",
129 |   ".mkv",
130 |   ".mp3",
131 |   ".wav",
132 | ]);
133 | 
134 | function normalizeRel(p) {
135 |   return path.relative(ROOT, p).split(path.sep).join("/");
136 | }
137 | 
138 | function isHiddenName(name) {
139 |   return name.startsWith(".") && name !== ".env" && !name.startsWith(".env.");
140 | }
141 | 
142 | function looksBinaryByExt(filePath) {
143 |   const ext = path.extname(filePath).toLowerCase();
144 |   return BINARY_EXT.has(ext);
145 | }
146 | 
147 | function isAllowedFile(filePath) {
148 |   const name = path.basename(filePath);
149 |   if (IGNORE_FILES.has(name)) return false;
150 | 
151 |   // .env / .env.*
152 |   if (name === ".env" || name.startsWith(".env.")) return true;
153 | 
154 |   // cookies.json (je≈õli jest w projekcie) ‚Äì dopuszczamy do dumpa
155 |   if (name.toLowerCase() === "cookies.json") return true;
156 | 
157 |   const ext = path.extname(name).toLowerCase();
158 |   if (!ext) return false;
159 |   if (looksBinaryByExt(filePath)) return false;
160 |   return ALLOWED_EXT.has(ext);
161 | }
162 | 
163 | function detectLang(filePath) {
164 |   const name = path.basename(filePath);
165 |   const ext = path.extname(filePath).toLowerCase();
166 |   if (name === ".env" || name.startsWith(".env.")) return "dotenv";
167 |   if (ext === ".js" || ext === ".mjs" || ext === ".cjs") return "js";
168 |   if (ext === ".ts") return "ts";
169 |   if (ext === ".tsx") return "tsx";
170 |   if (ext === ".jsx") return "jsx";
171 |   if (ext === ".json") return "json";
172 |   if (ext === ".html") return "html";
173 |   if (ext === ".css") return "css";
174 |   if (ext === ".yml" || ext === ".yaml") return "yaml";
175 |   if (ext === ".md") return "md";
176 |   return "";
177 | }
178 | 
179 | function typeLabel(filePath) {
180 |   const name = path.basename(filePath);
181 |   const ext = path.extname(filePath).toLowerCase();
182 |   if (name === ".env" || name.startsWith(".env.")) return "ENV";
183 |   if (ext === ".json") return "JSON";
184 |   if (ext === ".md") return "Markdown";
185 |   if (ext === ".html") return "HTML";
186 |   if (ext === ".css") return "CSS";
187 |   if (ext === ".yml" || ext === ".yaml") return "YAML";
188 |   if (ext === ".ts" || ext === ".tsx") return "TypeScript";
189 |   return "JavaScript/tekst";
190 | }
191 | 
192 | function guessDescription(rel) {
193 |   const p = rel.toLowerCase();
194 |   if (p.includes("/fb/")) return "Logika Facebook/Puppeteer (UI, komentarze, logowanie).";
195 |   if (p.includes("/panel/")) return "Panel (frontend/backend) do zarzƒÖdzania watcherem.";
196 |   if (p.includes("/utils/")) return "Utility helpers (sleep, nawigacja, itp.).";
197 |   if (p.endsWith("watcher.js")) return "G≈Ç√≥wna pƒôtla watchera: cykle, cache, webhook/telegram.";
198 |   if (p.includes("config") || p.startsWith(".env")) return "Konfiguracja / sta≈Çe / ustawienia.";
199 |   if (p.endsWith("package.json")) return "Metadane projektu i zale≈ºno≈õci (npm).";
200 |   return "Plik projektu (kod/konfiguracja).";
201 | }
202 | 
203 | function safeReadText(filePath) {
204 |   const st = fs.statSync(filePath);
205 |   if (st.size > MAX_BYTES) {
206 |     return { ok: false, reason: `Za du≈ºy (${st.size} B > ${MAX_BYTES} B)`, text: null, size: st.size };
207 |   }
208 | 
209 |   const buf = fs.readFileSync(filePath);
210 | 
211 |   // detekcja binarki (NUL) w pierwszych 4 KB
212 |   const lim = Math.min(buf.length, 4096);
213 |   for (let i = 0; i < lim; i++) {
214 |     if (buf[i] === 0) {
215 |       return { ok: false, reason: "Wykryto binarkƒô (NUL byte)", text: null, size: st.size };
216 |     }
217 |   }
218 | 
219 |   const text = buf.toString("utf8").replace(/\u0000/g, "");
220 |   return { ok: true, reason: null, text, size: st.size };
221 | }
222 | 
223 | function redactIfNeeded(rel, text) {
224 |   if (!REDACT) return text;
225 | 
226 |   const low = rel.toLowerCase();
227 | 
228 |   if (low.endsWith("cookies.json")) return "[REDACTED: cookies.json]\n";
229 |   if (low === ".env" || low.startsWith(".env.")) return "[REDACTED: .env]\n";
230 | 
231 |   let out = text;
232 | 
233 |   // maskowanie KEY=...
234 |   out = out.replace(/^([A-Z0-9_]{3,})=(.+)$/gm, (m, k) => `${k}=[REDACTED]`);
235 | 
236 |   // maskowanie webhook√≥w Make
237 |   out = out.replace(/https?:\/\/hook\.[^\s"'`]+/g, "[REDACTED_URL]");
238 | 
239 |   // maskowanie bearer token√≥w
240 |   out = out.replace(/Bearer\s+[A-Za-z0-9._-]+/g, "Bearer [REDACTED]");
241 | 
242 |   return out;
243 | }
244 | 
245 | function padLeft(n, width) {
246 |   const s = String(n);
247 |   return s.length >= width ? s : " ".repeat(width - s.length) + s;
248 | }
249 | 
250 | function addLineNumbers(text) {
251 |   const lines = text.split(/\r?\n/);
252 |   const width = String(lines.length).length;
253 |   return lines.map((line, idx) => `${padLeft(idx + 1, width)} | ${line}`).join("\n");
254 | }
255 | 
256 | function makeAnchor(rel) {
257 |   const base = `≈õcie≈ºka-${rel}`;
258 |   return base
259 |     .toLowerCase()
260 |     .replace(/[`]/g, "")
261 |     .replace(/[^\p{L}\p{N}\s/_-]+/gu, "")
262 |     .replace(/[\/_]/g, "-")
263 |     .replace(/\s+/g, "-")
264 |     .replace(/-+/g, "-")
265 |     .replace(/^-|-$/g, "");
266 | }
267 | 
268 | function walk(dir, out) {
269 |   const entries = fs.readdirSync(dir, { withFileTypes: true });
270 | 
271 |   for (const ent of entries) {
272 |     const full = path.join(dir, ent.name);
273 | 
274 |     if (ent.isDirectory()) {
275 |       if (IGNORE_DIRS.has(ent.name)) continue;
276 |       if (isHiddenName(ent.name)) continue;
277 |       walk(full, out);
278 |       continue;
279 |     }
280 | 
281 |     if (!ent.isFile()) continue;
282 | 
283 |     // ukryte pliki: pomi≈Ñ poza .env*
284 |     if (isHiddenName(ent.name) && !(ent.name === ".env" || ent.name.startsWith(".env."))) continue;
285 | 
286 |     if (!isAllowedFile(full)) continue;
287 | 
288 |     out.push(full);
289 |   }
290 | }
291 | 
292 | function sortFiles(files) {
293 |   const rel = (f) => normalizeRel(f);
294 | 
295 |   const score = (r) => {
296 |     const low = r.toLowerCase();
297 |     if (low === "package.json") return 0;
298 |     if (low.startsWith(".env")) return 1;
299 |     if (low.includes("config")) return 2;
300 |     if (low.startsWith("src/")) return 10;
301 |     if (low.includes("panel")) return 20;
302 |     return 30;
303 |   };
304 | 
305 |   return [...files].sort((a, b) => {
306 |     const ra = rel(a);
307 |     const rb = rel(b);
308 |     const sa = score(ra);
309 |     const sb = score(rb);
310 |     if (sa !== sb) return sa - sb;
311 |     return ra.localeCompare(rb);
312 |   });
313 | }
314 | 
315 | function countByExt(files) {
316 |   const map = new Map();
317 |   for (const f of files) {
318 |     const name = path.basename(f);
319 |     let ext = path.extname(name).toLowerCase();
320 |     if (name === ".env" || name.startsWith(".env.")) ext = ".env";
321 |     if (name.toLowerCase() === "cookies.json") ext = ".cookies.json";
322 |     map.set(ext, (map.get(ext) || 0) + 1);
323 |   }
324 |   return [...map.entries()].sort((a, b) => b[1] - a[1]);
325 | }
326 | 
327 | function buildTree(paths, maxDepth, maxLines) {
328 |   const root = { name: "", children: new Map(), isFile: false };
329 | 
330 |   function insert(rel) {
331 |     const parts = rel.split("/");
332 |     let node = root;
333 |     for (let i = 0; i < parts.length; i++) {
334 |       const p = parts[i];
335 |       if (!node.children.has(p)) node.children.set(p, { name: p, children: new Map(), isFile: false });
336 |       node = node.children.get(p);
337 |     }
338 |     node.isFile = true;
339 |   }
340 | 
341 |   for (const rel of paths) insert(rel);
342 | 
343 |   const lines = [];
344 |   let emitted = 0;
345 | 
346 |   function walkNode(node, depth, prefix) {
347 |     if (emitted >= maxLines) return;
348 |     if (depth > maxDepth) return;
349 | 
350 |     const entries = [...node.children.values()].sort((a, b) => {
351 |       const aIsDir = a.children.size > 0 && !a.isFile;
352 |       const bIsDir = b.children.size > 0 && !b.isFile;
353 |       if (aIsDir !== bIsDir) return aIsDir ? -1 : 1;
354 |       return a.name.localeCompare(b.name);
355 |     });
356 | 
357 |     entries.forEach((child, idx) => {
358 |       if (emitted >= maxLines) return;
359 |       const isLast = idx === entries.length - 1;
360 |       const branch = isLast ? "‚îî‚îÄ " : "‚îú‚îÄ ";
361 |       const nextPrefix = prefix + (isLast ? "   " : "‚îÇ  ");
362 |       const label = child.name + (child.children.size > 0 && !child.isFile ? "/" : "");
363 |       lines.push(prefix + branch + label);
364 |       emitted++;
365 | 
366 |       if (child.children.size > 0 && depth + 1 <= maxDepth) {
367 |         walkNode(child, depth + 1, nextPrefix);
368 |       }
369 |     });
370 |   }
371 | 
372 |   walkNode(root, 1, "");
373 |   if (emitted >= maxLines) lines.push("‚Ä¶ (tree truncated)");
374 |   return lines.join("\n");
375 | }
376 | 
377 | /**
378 |  * Ekstrakcja eksport√≥w (Public API)
379 |  * - export function/name/const/class
380 |  * - export { a, b as c }
381 |  * - export default
382 |  * - module.exports
383 |  * - exports.foo =
384 |  */
385 | function extractExports(text) {
386 |   const lines = text.split(/\r?\n/);
387 |   const exports = [];
388 | 
389 |   const push = (kind, name, line) => exports.push({ kind, name, line });
390 | 
391 |   for (let i = 0; i < lines.length; i++) {
392 |     const l = lines[i];
393 | 
394 |     let m = l.match(/^\s*export\s+function\s+([A-Za-z0-9_$]+)/);
395 |     if (m) push("export function", m[1], i + 1);
396 | 
397 |     m = l.match(/^\s*export\s+(?:const|let|var)\s+([A-Za-z0-9_$]+)/);
398 |     if (m) push("export const", m[1], i + 1);
399 | 
400 |     m = l.match(/^\s*export\s+class\s+([A-Za-z0-9_$]+)/);
401 |     if (m) push("export class", m[1], i + 1);
402 | 
403 |     m = l.match(/^\s*export\s*\{\s*([^}]+)\s*\}\s*;?\s*$/);
404 |     if (m) push("export {..}", m[1].trim(), i + 1);
405 | 
406 |     m = l.match(/^\s*export\s+default\b/);
407 |     if (m) push("export default", "(default)", i + 1);
408 | 
409 |     m = l.match(/^\s*module\.exports\s*=\s*(.+)\s*;?\s*$/);
410 |     if (m) push("module.exports", m[1].trim().slice(0, 80), i + 1);
411 | 
412 |     m = l.match(/^\s*exports\.([A-Za-z0-9_$]+)\s*=\s*(.+)\s*;?\s*$/);
413 |     if (m) push("exports.*", `${m[1]} = ${m[2].trim().slice(0, 60)}`, i + 1);
414 |   }
415 | 
416 |   return exports;
417 | }
418 | 
419 | /**
420 |  * Function/Class index:
421 |  * - function foo(
422 |  * - async function foo(
423 |  * - const foo = (...) =>
424 |  * - const foo = async (...) =>
425 |  * - export function foo(
426 |  * - export const foo = (...) =>
427 |  * - class Foo
428 |  * - export class Foo
429 |  *
430 |  * UWAGA: to heurystyka (bez AST), ale w praktyce bardzo skuteczna do nawigacji.
431 |  */
432 | function extractFunctionsAndClasses(text, maxPerFile) {
433 |   const lines = text.split(/\r?\n/);
434 |   const out = [];
435 |   const seen = new Set();
436 | 
437 |   const add = (kind, name, line) => {
438 |     const key = `${kind}:${name}:${line}`;
439 |     if (seen.has(key)) return;
440 |     seen.add(key);
441 |     out.push({ kind, name, line });
442 |   };
443 | 
444 |   for (let i = 0; i < lines.length; i++) {
445 |     if (out.length >= maxPerFile) break;
446 |     const l = lines[i];
447 | 
448 |     // export async function foo(
449 |     let m = l.match(/^\s*export\s+async\s+function\s+([A-Za-z0-9_$]+)\s*\(/);
450 |     if (m) add("export async function", m[1], i + 1);
451 | 
452 |     // export function foo(
453 |     m = l.match(/^\s*export\s+function\s+([A-Za-z0-9_$]+)\s*\(/);
454 |     if (m) add("export function", m[1], i + 1);
455 | 
456 |     // async function foo(
457 |     m = l.match(/^\s*async\s+function\s+([A-Za-z0-9_$]+)\s*\(/);
458 |     if (m) add("async function", m[1], i + 1);
459 | 
460 |     // function foo(
461 |     m = l.match(/^\s*function\s+([A-Za-z0-9_$]+)\s*\(/);
462 |     if (m) add("function", m[1], i + 1);
463 | 
464 |     // export class Foo
465 |     m = l.match(/^\s*export\s+class\s+([A-Za-z0-9_$]+)/);
466 |     if (m) add("export class", m[1], i + 1);
467 | 
468 |     // class Foo
469 |     m = l.match(/^\s*class\s+([A-Za-z0-9_$]+)/);
470 |     if (m) add("class", m[1], i + 1);
471 | 
472 |     // export const foo = async (...) =>
473 |     m = l.match(/^\s*export\s+(?:const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*async\b/);
474 |     if (m) add("export const async", m[1], i + 1);
475 | 
476 |     // export const foo = (...) =>
477 |     m = l.match(/^\s*export\s+(?:const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*(?:\([^)]*\)|[A-Za-z0-9_$]+)\s*=>/);
478 |     if (m) add("export const arrow", m[1], i + 1);
479 | 
480 |     // const foo = async (...) =>
481 |     m = l.match(/^\s*(?:const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*async\b/);
482 |     if (m) add("const async", m[1], i + 1);
483 | 
484 |     // const foo = (...) =>
485 |     m = l.match(/^\s*(?:const|let|var)\s+([A-Za-z0-9_$]+)\s*=\s*(?:\([^)]*\)|[A-Za-z0-9_$]+)\s*=>/);
486 |     if (m) add("const arrow", m[1], i + 1);
487 |   }
488 | 
489 |   // odszumianie: usu≈Ñ super kr√≥tkie "a", "b" itp. (je≈õli z≈Çapie)
490 |   return out.filter((x) => x.name.length >= 2);
491 | }
492 | 
493 | /**
494 |  * Import graph (lite):
495 |  * - import ... from "./x"
496 |  * - import "./x"
497 |  * - require("./x")
498 |  * Tylko lokalne ≈õcie≈ºki zaczynajƒÖce siƒô od "." lub ".."
499 |  */
500 | function extractLocalImports(text) {
501 |   const lines = text.split(/\r?\n/);
502 |   const out = [];
503 |   const seen = new Set();
504 | 
505 |   const add = (spec, line) => {
506 |     if (!spec) return;
507 |     if (!(spec.startsWith("./") || spec.startsWith("../"))) return;
508 |     const key = `${spec}#${line}`;
509 |     if (seen.has(key)) return;
510 |     seen.add(key);
511 |     out.push({ spec, line });
512 |   };
513 | 
514 |   for (let i = 0; i < lines.length; i++) {
515 |     const l = lines[i];
516 | 
517 |     let m = l.match(/^\s*import\s+.*?\s+from\s+["']([^"']+)["']\s*;?\s*$/);
518 |     if (m) add(m[1], i + 1);
519 | 
520 |     m = l.match(/^\s*import\s+["']([^"']+)["']\s*;?\s*$/);
521 |     if (m) add(m[1], i + 1);
522 | 
523 |     m = l.match(/require\s*\(\s*["']([^"']+)["']\s*\)/);
524 |     if (m) add(m[1], i + 1);
525 |   }
526 | 
527 |   return out;
528 | }
529 | 
530 | function keywordHits(rel, text, keywords, maxHitsTotal) {
531 |   const lines = text.split(/\r?\n/);
532 |   const hits = [];
533 |   const lowRel = rel.toLowerCase();
534 | 
535 |   if (lowRel.includes("dist/") || lowRel.includes("build/")) return [];
536 | 
537 |   for (let i = 0; i < lines.length; i++) {
538 |     const lineText = lines[i];
539 |     for (const kw of keywords) {
540 |       if (!kw) continue;
541 |       if (lineText.includes(kw)) {
542 |         hits.push({
543 |           keyword: kw,
544 |           line: i + 1,
545 |           preview: lineText.trim().slice(0, 160),
546 |         });
547 |         if (hits.length >= maxHitsTotal) return hits;
548 |       }
549 |     }
550 |   }
551 |   return hits;
552 | }
553 | 
554 | function main() {
555 |   const files = [];
556 |   walk(ROOT, files);
557 |   const sorted = sortFiles(files);
558 |   const rels = sorted.map(normalizeRel);
559 | 
560 |   const projectName = path.basename(ROOT);
561 |   const nowIso = new Date().toISOString();
562 | 
563 |   // read all files once (dla indeks√≥w)
564 |   const fileCache = new Map(); // rel -> { ok, text, reason, size }
565 |   for (const f of sorted) {
566 |     const rel = normalizeRel(f);
567 |     const read = safeReadText(f);
568 |     if (read.ok) {
569 |       const redacted = redactIfNeeded(rel, read.text);
570 |       fileCache.set(rel, { ...read, text: redacted });
571 |     } else {
572 |       fileCache.set(rel, read);
573 |     }
574 |   }
575 | 
576 |   // indeksy
577 |   const exportIndex = []; // { rel, kind, name, line }
578 |   const fnIndex = new Map(); // rel -> [{kind,name,line}]
579 |   const keywordIndex = new Map(); // kw -> array of { rel, line, preview }
580 |   const importGraph = new Map(); // rel -> imports [{spec,line}]
581 | 
582 |   for (const rel of rels) {
583 |     const entry = fileCache.get(rel);
584 |     if (!entry || !entry.ok) continue;
585 | 
586 |     // exports
587 |     const ex = extractExports(entry.text);
588 |     ex.forEach((e) => exportIndex.push({ rel, ...e }));
589 | 
590 |     // functions/classes
591 |     const fns = extractFunctionsAndClasses(entry.text, FUNC_INDEX_MAX);
592 |     if (fns.length) fnIndex.set(rel, fns);
593 | 
594 |     // keywords
595 |     const hits = keywordHits(rel, entry.text, FINAL_KEYWORDS, KEYWORD_MAX_HITS);
596 |     for (const h of hits) {
597 |       if (!keywordIndex.has(h.keyword)) keywordIndex.set(h.keyword, []);
598 |       keywordIndex.get(h.keyword).push({ rel, line: h.line, preview: h.preview });
599 |     }
600 | 
601 |     // imports
602 |     const im = extractLocalImports(entry.text);
603 |     if (im.length) importGraph.set(rel, im);
604 |   }
605 | 
606 |   // stats
607 |   const extCounts = countByExt(sorted);
608 |   const totalBytes = [...fileCache.values()].reduce((acc, v) => acc + (v?.size || 0), 0);
609 | 
610 |   // tree
611 |   const tree = buildTree(rels, TREE_DEPTH, TREE_MAX_LINES);
612 | 
613 |   // build markdown
614 |   let md = "";
615 |   md += `# üì¶ EXPORT PROJEKTU+: ${projectName}\n\n`;
616 |   md += `**Root:** \`${ROOT}\`  \n`;
617 |   md += `**Wygenerowano:** \`${nowIso}\`  \n`;
618 |   md += `**Liczba plik√≥w:** \`${sorted.length}\`  \n`;
619 |   md += `**≈ÅƒÖczny rozmiar (raw):** \`${totalBytes} B\`  \n`;
620 |   md += `**Max rozmiar pliku:** \`${MAX_BYTES} B\`  \n`;
621 |   md += `**Redaction:** \`${REDACT ? "ON" : "OFF"}\`  \n\n`;
622 | 
623 |   md += `---\n\n`;
624 | 
625 |   md += `## üó∫Ô∏è Overview\n\n`;
626 | 
627 |   // ‚úÖ Sta≈Ça sekcja pod FB_Watcher ‚Äì dok≈Çadnie jak chcia≈Çe≈õ
628 |   md += `## üö™ Entrypoints & Flow\n\n`;
629 |   md += `- src/index.js ‚Üí g≈Ç√≥wny start aplikacji\n`;
630 |   md += `- src/watcher.js ‚Üí g≈Ç√≥wna pƒôtla watchera\n`;
631 |   md += `- src/panel/** ‚Üí backend / frontend panelu\n`;
632 |   md += `- tools/export-project-to-md.js ‚Üí narzƒôdzie eksportu projektu\n\n`;
633 |   md += `---\n\n`;
634 | 
635 |   md += `### üìä Statystyki\n\n`;
636 |   md += `- Top rozszerzenia:\n`;
637 |   extCounts.slice(0, 12).forEach(([ext, n]) => {
638 |     md += `  - \`${ext}\`: **${n}**\n`;
639 |   });
640 |   md += `\n`;
641 | 
642 |   md += `### üå≥ Struktura (depth=${TREE_DEPTH})\n\n`;
643 |   md += "```text\n" + tree + "\n```\n\n";
644 | 
645 |   md += `---\n\n`;
646 | 
647 |   // Public API index
648 |   md += `## üì¶ Public API (exports)\n\n`;
649 |   if (exportIndex.length === 0) {
650 |     md += `_Brak wykrytych eksport√≥w (albo projekt jest w ca≈Ço≈õci w jednym entry i bez export√≥w)._ \n\n`;
651 |   } else {
652 |     const byFile = new Map();
653 |     for (const e of exportIndex) {
654 |       if (!byFile.has(e.rel)) byFile.set(e.rel, []);
655 |       byFile.get(e.rel).push(e);
656 |     }
657 | 
658 |     for (const [rel, list] of [...byFile.entries()].sort((a, b) => a[0].localeCompare(b[0]))) {
659 |       const anchor = makeAnchor(rel);
660 |       md += `### \`${rel}\` ‚Üí [sekcja pliku](#${anchor})\n\n`;
661 |       list.sort((a, b) => a.line - b.line);
662 |       for (const e of list) {
663 |         md += `- L${e.line}: **${e.kind}** \`${e.name}\`\n`;
664 |       }
665 |       md += `\n`;
666 |     }
667 |   }
668 | 
669 |   md += `---\n\n`;
670 | 
671 |   // Function/Class index
672 |   md += `## üß† Function/Class index\n\n`;
673 |   if (fnIndex.size === 0) {
674 |     md += `_Brak wykrytych funkcji/klas (albo nie wykryto wzorc√≥w)._ \n\n`;
675 |   } else {
676 |     for (const [rel, list] of [...fnIndex.entries()].sort((a, b) => a[0].localeCompare(b[0]))) {
677 |       const anchor = makeAnchor(rel);
678 |       md += `### \`${rel}\` ‚Üí [sekcja pliku](#${anchor})\n\n`;
679 |       list.sort((a, b) => a.line - b.line);
680 |       for (const x of list) {
681 |         md += `- L${x.line}: **${x.kind}** \`${x.name}\`\n`;
682 |       }
683 |       md += `\n`;
684 |     }
685 |   }
686 | 
687 |   md += `---\n\n`;
688 | 
689 |   // Keyword index
690 |   md += `## üîé Keyword index\n\n`;
691 |   const kws = [...keywordIndex.entries()].sort((a, b) => b[1].length - a[1].length);
692 |   if (kws.length === 0) {
693 |     md += `_Brak trafie≈Ñ dla keyword√≥w._\n\n`;
694 |   } else {
695 |     for (const [kw, hits] of kws) {
696 |       md += `### \`${kw}\` (hits: ${hits.length})\n\n`;
697 |       hits.slice(0, KEYWORD_MAX_HITS).forEach((h) => {
698 |         md += `- \`${h.rel}\` L${h.line}: \`${h.preview}\`\n`;
699 |       });
700 |       md += `\n`;
701 |     }
702 |   }
703 | 
704 |   md += `---\n\n`;
705 | 
706 |   // Import graph lite
707 |   md += `## üß© Import graph (lite)\n\n`;
708 |   if (importGraph.size === 0) {
709 |     md += `_Brak lokalnych import√≥w (albo nie wykryto wzorc√≥w import/require)._ \n\n`;
710 |   } else {
711 |     for (const [rel, im] of [...importGraph.entries()].sort((a, b) => a[0].localeCompare(b[0]))) {
712 |       md += `### \`${rel}\`\n\n`;
713 |       im.forEach((x) => {
714 |         md += `- L${x.line}: \`${x.spec}\`\n`;
715 |       });
716 |       md += `\n`;
717 |     }
718 |   }
719 | 
720 |   md += `---\n\n`;
721 | 
722 |   // File table of contents
723 |   md += `## üß≠ Spis tre≈õci plik√≥w\n`;
724 |   for (const rel of rels) {
725 |     md += `- [${rel}](#${makeAnchor(rel)})\n`;
726 |   }
727 |   md += `\n---\n\n`;
728 | 
729 |   // Full file contents
730 |   for (const f of sorted) {
731 |     const rel = normalizeRel(f);
732 |     const lang = detectLang(f);
733 |     const typ = typeLabel(f);
734 |     const desc = guessDescription(rel);
735 | 
736 |     md += `### üìÑ ≈öcie≈ºka: \`${rel}\`\n`;
737 |     md += `**Typ:** ${typ}  \n`;
738 |     md += `**Opis:** ${desc}  \n\n`;
739 | 
740 |     const entry = fileCache.get(rel);
741 |     if (!entry || !entry.ok) {
742 |       md += `**UWAGA:** pominiƒôto tre≈õƒá ‚Üí ${entry?.reason || "unknown"}  \n\n---\n\n`;
743 |       continue;
744 |     }
745 | 
746 |     md += `\`\`\`${lang}\n${addLineNumbers(entry.text)}\n\`\`\`\n\n---\n\n`;
747 |   }
748 | 
749 |   fs.writeFileSync(OUT_FILE, md, "utf8");
750 |   console.log(`[EXPORT+] OK -> ${OUT_FILE}`);
751 |   console.log(`[EXPORT+] Plik√≥w: ${sorted.length}`);
752 |   console.log(`[EXPORT+] Exports: ${exportIndex.length}`);
753 |   console.log(`[EXPORT+] Function index: ${fnIndex.size} files`);
754 |   console.log(`[EXPORT+] Keywords: ${kws.length} keys`);
755 |   console.log(`[EXPORT+] Import graph: ${importGraph.size} files`);
756 | }
757 | 
758 | try {
759 |   main();
760 | } catch (e) {
761 |   console.error("[EXPORT+] ERROR:", e?.stack || e?.message || String(e));
762 |   process.exit(1);
763 | }
764 | 
```

---

